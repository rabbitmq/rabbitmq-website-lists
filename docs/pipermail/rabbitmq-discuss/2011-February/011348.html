<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pika reconnection error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pika%20reconnection%20error&In-Reply-To=%3CAANLkTik%2Bk9WAgKJjh%2Bf3rELCbXJaXQpC-R-dHHpXijWM%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011345.html">
   <LINK REL="Next"  HREF="011349.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pika reconnection error</H1>
    <B>Jason J. W. Williams</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pika%20reconnection%20error&In-Reply-To=%3CAANLkTik%2Bk9WAgKJjh%2Bf3rELCbXJaXQpC-R-dHHpXijWM%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Pika reconnection error">jasonjwwilliams at gmail.com
       </A><BR>
    <I>Mon Feb 21 00:04:38 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011345.html">[rabbitmq-discuss] Cluster - Changing Node Types
</A></li>
        <LI>Next message: <A HREF="011349.html">[rabbitmq-discuss] Pika reconnection error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11348">[ date ]</a>
              <a href="thread.html#11348">[ thread ]</a>
              <a href="subject.html#11348">[ subject ]</a>
              <a href="author.html#11348">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Guys,

Having some issues with a test cluster setup. It's a 3-node cluster
with 2-disk and 1-RAM nodes. The RAM node is joined to both disk
nodes.

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Phantome</A> - disk
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_1 at Phantome</A> - disk
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_2 at Phantome</A> - RAM

In front of the cluster is an HAProxy instance listening on port 5670
doing simple round-robin TCP load balancing between the cluster
members.

As long as all the nodes are running I can have my consumer connect
through the load balancer to any node and successfully consume.
Likewise with the producer. However, when I shutdown the node the
consumer is currently connected to and allow Pika to do the
reconnection, I get this error:

error: uncaptured python exception, closing channel
&lt;pika.asyncore_adapter.RabbitDispatcher connected at 0x632350&gt; (&lt;class
'pika.exceptions.ChannelClosed'&gt;:Connection.Close(class_id = 0,
method_id = 0, reply_code = 541, reply_text = 'INTERNAL_ERROR')
[/System/Library/Frameworks/Python.framework/Versions/2.6/lib/python2.6/asyncore.py|read|74]
[/System/Library/Frameworks/Python.framework/Versions/2.6/lib/python2.6/asyncore.py|handle_read_event|413]
[build/bdist.macosx-10.6-universal/egg/pika/asyncore_adapter.py|handle_read|86]
[build/bdist.macosx-10.6-universal/egg/pika/connection.py|on_data_available|268]
[build/bdist.macosx-10.6-universal/egg/pika/connection.py|_login2|375]
[build/bdist.macosx-10.6-universal/egg/pika/connection.py|handle_connection_open|201]
[cluster_test_consumer.py|on_connection_open|53]
[build/bdist.macosx-10.6-universal/egg/pika/spec.py|queue_declare|3003]
[build/bdist.macosx-10.6-universal/egg/pika/channel.py|_rpc|187]
[build/bdist.macosx-10.6-universal/egg/pika/connection.py|_rpc|326]
[build/bdist.macosx-10.6-universal/egg/pika/channel.py|wait_for_reply|125]
[build/bdist.macosx-10.6-universal/egg/pika/channel.py|_ensure|84])

Every few seconds Pika will attempt to reconnect the consumer and the
error repeats. The only unusual error in the Rabbit logs occurs on the
first reconnection: <A HREF="https://gist.github.com/836441">https://gist.github.com/836441</A>

The rest of the time during these errors the logs look like this:
<A HREF="https://gist.github.com/836442">https://gist.github.com/836442</A>

The consumer is disconnecting and reconnecting to HAProxy because the
stats show the connection moving between backend nodes.

The producer continues to operate correctly through the load balancer.

Consumer code is here: <A HREF="https://gist.github.com/836445">https://gist.github.com/836445</A>

Any help/ideas are greatly appreciated.  Thank you in advance.

-J
</PRE>









































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011345.html">[rabbitmq-discuss] Cluster - Changing Node Types
</A></li>
	<LI>Next message: <A HREF="011349.html">[rabbitmq-discuss] Pika reconnection error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11348">[ date ]</a>
              <a href="thread.html#11348">[ thread ]</a>
              <a href="subject.html#11348">[ subject ]</a>
              <a href="author.html#11348">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
