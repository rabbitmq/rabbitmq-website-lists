<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] disk space not released after persistent messages are consumed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20disk%20space%20not%20released%20after%20persistent%0A%20messages%20are%20consumed&In-Reply-To=%3C20110211010714.GC2361%40dakota.doc.ic.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011141.html">
   <LINK REL="Next"  HREF="011252.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] disk space not released after persistent messages are consumed</H1>
    <B>Alexandru Scvor&#355;ov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20disk%20space%20not%20released%20after%20persistent%0A%20messages%20are%20consumed&In-Reply-To=%3C20110211010714.GC2361%40dakota.doc.ic.ac.uk%3E"
       TITLE="[rabbitmq-discuss] disk space not released after persistent messages are consumed">alexandru at rabbitmq.com
       </A><BR>
    <I>Fri Feb 11 01:07:14 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011141.html">[rabbitmq-discuss] disk space not released after persistent	messages are consumed
</A></li>
        <LI>Next message: <A HREF="011252.html">[rabbitmq-discuss] disk space not released after persistent messages are consumed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11204">[ date ]</a>
              <a href="thread.html#11204">[ thread ]</a>
              <a href="subject.html#11204">[ subject ]</a>
              <a href="author.html#11204">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

&gt;<i> After running this code I end up with a 3MB file in the
</I>&gt;<i> msg_store_persistent directory, even though rabbitmqctl list_queues
</I>&gt;<i> shows 0 messages in the queue. After restarting RabbitMQ server that
</I>&gt;<i> file grew by another 800KB. Any advice is greatly appreciated.
</I>
That's more or less expected.

The broker tries to write the messages to disk in files stored in that
directory.  The persister always has at least one file open and it will
append to it any new messages.  Since it only *appends* to the files,
even if the messages get delivered to consumers, they'll still be on
disk.  Normally, the persister will delete files that only contain stale
messages, but it won't do this to the file it's currently writing to.
When the current file exceeds msg_store_file_size_limit, it will start
on a new file.  At that point, if the old file doesn't have any more
messages, it will delete it.  The size limit is about 16 Mb by default,
so it's unsurprising that you have a 3 Mb file lying around.

You can set msg_store_file_size_limit in rabbitmq.config. 

Does this answer your question?

Cheers,
Alex

On Mon, Feb 07, 2011 at 05:27:07PM -0800, Jianing Hu wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> RabbitMQ newbie here so apologies in advance if what I'm doing is
</I>&gt;<i> obviously wrong.
</I>&gt;<i> 
</I>&gt;<i> I'm experimenting with RabbigMQ 2.1.1 and it seems my persistent
</I>&gt;<i> message storage file keeps growing despite of messages being consumed.
</I>&gt;<i> Here's the code I used for testing. I'm using perl with Net::RabbitMQ
</I>&gt;<i> 
</I>&gt;<i>     use Net::RabbitMQ;
</I>&gt;<i>     my $mq = Net::RabbitMQ-&gt;new();
</I>&gt;<i>     $mq-&gt;connect(&quot;localhost&quot;, {
</I>&gt;<i>         user =&gt; 'guest',
</I>&gt;<i>         password =&gt; 'guest'
</I>&gt;<i>     });
</I>&gt;<i>     $mq-&gt;channel_open(1);
</I>&gt;<i>     $mq-&gt;queue_declare(1, 'test', {
</I>&gt;<i>         passive =&gt; 0,
</I>&gt;<i>         durable =&gt; 1,
</I>&gt;<i>         exclusive =&gt; 0,
</I>&gt;<i>         auto_delete =&gt; 0
</I>&gt;<i>     });
</I>&gt;<i> 
</I>&gt;<i>     my $data = 'foobar' x 200;
</I>&gt;<i>     for (1..100000) {
</I>&gt;<i>         $mq-&gt;publish(1, 'test', $data, {}, { delivery_mode =&gt; 2});
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>     $mq-&gt;consume(1, 'test', {
</I>&gt;<i>         no_ack =&gt; 0
</I>&gt;<i>     });
</I>&gt;<i>     for (1..100000) {
</I>&gt;<i>         my $msg = $mq-&gt;recv();
</I>&gt;<i>         $mq-&gt;ack(1, $msg-&gt;{delivery_tag});
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i> After running this code I end up with a 3MB file in the
</I>&gt;<i> msg_store_persistent directory, even though rabbitmqctl list_queues
</I>&gt;<i> shows 0 messages in the queue. After restarting RabbitMQ server that
</I>&gt;<i> file grew by another 800KB. Any advice is greatly appreciated.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> - Jianing
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011141.html">[rabbitmq-discuss] disk space not released after persistent	messages are consumed
</A></li>
	<LI>Next message: <A HREF="011252.html">[rabbitmq-discuss] disk space not released after persistent messages are consumed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11204">[ date ]</a>
              <a href="thread.html#11204">[ thread ]</a>
              <a href="subject.html#11204">[ subject ]</a>
              <a href="author.html#11204">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
