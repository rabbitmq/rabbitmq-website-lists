<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pika reconnection error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pika%20reconnection%20error&In-Reply-To=%3CAANLkTikuArBYAFUeMUx%2B4y2NvE7Q6deY3VG9JWHthMf9%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011349.html">
   <LINK REL="Next"  HREF="011355.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pika reconnection error</H1>
    <B>Gavin M. Roy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pika%20reconnection%20error&In-Reply-To=%3CAANLkTikuArBYAFUeMUx%2B4y2NvE7Q6deY3VG9JWHthMf9%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Pika reconnection error">gmr at myyearbook.com
       </A><BR>
    <I>Mon Feb 21 00:30:25 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011349.html">[rabbitmq-discuss] Pika reconnection error
</A></li>
        <LI>Next message: <A HREF="011355.html">[rabbitmq-discuss] Pika reconnection error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11350">[ date ]</a>
              <a href="thread.html#11350">[ thread ]</a>
              <a href="subject.html#11350">[ subject ]</a>
              <a href="author.html#11350">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'd do a few things:

Since you're using 0.5.2, I'd use the SimpleReconnectionStrategy handler and
instead of extending the class like you are instead create a on_connected
method in your app, utilizing the Connection.addStateChangeHandler() method
to be notified when you are connected, and in this event handler do all of
your setup.

There was a bug report on the 0.5.2 branch with the reconnection handler
system. I did not trace that back, however.

You might be better served to check out the current version, as I have
tested the SRS pretty extensively, including cases where the server goes
away and comes back.  If you use 0.9.3 (or the soon to be released 0.94)
instead of the single callback function with a bool flag in 0.5.2, it has a
callback handler split out for each state:

Connection.add_on_close_callback(callback)
Connection.add_on_open_callback(callback)

In either version, I would suggest that the reconnection strategy class is
not the right place to handle your post-connection setup.

Regards,

Gavin

On Sun, Feb 20, 2011 at 7:13 PM, Jason J. W. Williams &lt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jasonjwwilliams at gmail.com</A>&gt; wrote:

&gt;<i> BTW this problem only seems to occur when <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Phantome</A> is restarted
</I>&gt;<i> while the consumer is connected to it. Reconnections occur properly
</I>&gt;<i> when restarting <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_1 at Phantome</A> and <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_2 at Phantome</A> while the
</I>&gt;<i> consumer is connected.
</I>&gt;<i>
</I>&gt;<i> Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_1 at Phantome</A> ...
</I>&gt;<i> [{running_applications,[{rabbit,&quot;RabbitMQ&quot;,&quot;2.3.0&quot;},
</I>&gt;<i>                        {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.4.16&quot;},
</I>&gt;<i>                        {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.5&quot;},
</I>&gt;<i>                        {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.9.2&quot;},
</I>&gt;<i>                        {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.17.2&quot;},
</I>&gt;<i>                        {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.14.2&quot;}]},
</I>&gt;<i>  {nodes,[{disc,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_1 at Phantome</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at Phantome</A>]},
</I>&gt;<i>         {ram,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_2 at Phantome</A>]}]},
</I>&gt;<i>  {running_nodes,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Phantome</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit_2 at Phantome</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit_1 at Phantome</A>]}]
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i> -J
</I>&gt;<i>
</I>&gt;<i> On Sun, Feb 20, 2011 at 5:04 PM, Jason J. W. Williams
</I>&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jasonjwwilliams at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; Hi Guys,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Having some issues with a test cluster setup. It's a 3-node cluster
</I>&gt;<i> &gt; with 2-disk and 1-RAM nodes. The RAM node is joined to both disk
</I>&gt;<i> &gt; nodes.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Phantome</A> - disk
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_1 at Phantome</A> - disk
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit_2 at Phantome</A> - RAM
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In front of the cluster is an HAProxy instance listening on port 5670
</I>&gt;<i> &gt; doing simple round-robin TCP load balancing between the cluster
</I>&gt;<i> &gt; members.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As long as all the nodes are running I can have my consumer connect
</I>&gt;<i> &gt; through the load balancer to any node and successfully consume.
</I>&gt;<i> &gt; Likewise with the producer. However, when I shutdown the node the
</I>&gt;<i> &gt; consumer is currently connected to and allow Pika to do the
</I>&gt;<i> &gt; reconnection, I get this error:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; error: uncaptured python exception, closing channel
</I>&gt;<i> &gt; &lt;pika.asyncore_adapter.RabbitDispatcher connected at 0x632350&gt; (&lt;class
</I>&gt;<i> &gt; 'pika.exceptions.ChannelClosed'&gt;:Connection.Close(class_id = 0,
</I>&gt;<i> &gt; method_id = 0, reply_code = 541, reply_text = 'INTERNAL_ERROR')
</I>&gt;<i> &gt;
</I>&gt;<i> [/System/Library/Frameworks/Python.framework/Versions/2.6/lib/python2.6/asyncore.py|read|74]
</I>&gt;<i> &gt;
</I>&gt;<i> [/System/Library/Frameworks/Python.framework/Versions/2.6/lib/python2.6/asyncore.py|handle_read_event|413]
</I>&gt;<i> &gt;
</I>&gt;<i> [build/bdist.macosx-10.6-universal/egg/pika/asyncore_adapter.py|handle_read|86]
</I>&gt;<i> &gt;
</I>&gt;<i> [build/bdist.macosx-10.6-universal/egg/pika/connection.py|on_data_available|268]
</I>&gt;<i> &gt; [build/bdist.macosx-10.6-universal/egg/pika/connection.py|_login2|375]
</I>&gt;<i> &gt;
</I>&gt;<i> [build/bdist.macosx-10.6-universal/egg/pika/connection.py|handle_connection_open|201]
</I>&gt;<i> &gt; [cluster_test_consumer.py|on_connection_open|53]
</I>&gt;<i> &gt; [build/bdist.macosx-10.6-universal/egg/pika/spec.py|queue_declare|3003]
</I>&gt;<i> &gt; [build/bdist.macosx-10.6-universal/egg/pika/channel.py|_rpc|187]
</I>&gt;<i> &gt; [build/bdist.macosx-10.6-universal/egg/pika/connection.py|_rpc|326]
</I>&gt;<i> &gt;
</I>&gt;<i> [build/bdist.macosx-10.6-universal/egg/pika/channel.py|wait_for_reply|125]
</I>&gt;<i> &gt; [build/bdist.macosx-10.6-universal/egg/pika/channel.py|_ensure|84])
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Every few seconds Pika will attempt to reconnect the consumer and the
</I>&gt;<i> &gt; error repeats. The only unusual error in the Rabbit logs occurs on the
</I>&gt;<i> &gt; first reconnection: <A HREF="https://gist.github.com/836441">https://gist.github.com/836441</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The rest of the time during these errors the logs look like this:
</I>&gt;<i> &gt; <A HREF="https://gist.github.com/836442">https://gist.github.com/836442</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The consumer is disconnecting and reconnecting to HAProxy because the
</I>&gt;<i> &gt; stats show the connection moving between backend nodes.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The producer continues to operate correctly through the load balancer.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Consumer code is here: <A HREF="https://gist.github.com/836445">https://gist.github.com/836445</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Any help/ideas are greatly appreciated.  Thank you in advance.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -J
</I>&gt;<i> &gt;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110220/3b6643f4/attachment-0001.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110220/3b6643f4/attachment-0001.htm</A>&gt;
</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011349.html">[rabbitmq-discuss] Pika reconnection error
</A></li>
	<LI>Next message: <A HREF="011355.html">[rabbitmq-discuss] Pika reconnection error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11350">[ date ]</a>
              <a href="thread.html#11350">[ thread ]</a>
              <a href="subject.html#11350">[ subject ]</a>
              <a href="author.html#11350">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
