<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Why is RabbitMQ not persisting messages on a durable queue?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Why%20is%20RabbitMQ%20not%20persisting%20messages%20on%20a%0A%20durable%20queue%3F&In-Reply-To=%3C20110218224417.GA2329%40dakota.doc.ic.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011320.html">
   <LINK REL="Next"  HREF="011322.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Why is RabbitMQ not persisting messages on a durable queue?</H1>
    <B>Alexandru Scvor&#355;ov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Why%20is%20RabbitMQ%20not%20persisting%20messages%20on%20a%0A%20durable%20queue%3F&In-Reply-To=%3C20110218224417.GA2329%40dakota.doc.ic.ac.uk%3E"
       TITLE="[rabbitmq-discuss] Why is RabbitMQ not persisting messages on a durable queue?">alexandru at rabbitmq.com
       </A><BR>
    <I>Fri Feb 18 22:44:17 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011320.html">[rabbitmq-discuss] Why is RabbitMQ not persisting messages on a	durable queue?
</A></li>
        <LI>Next message: <A HREF="011322.html">[rabbitmq-discuss] Why is RabbitMQ not persisting messages on a durable queue?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11321">[ date ]</a>
              <a href="thread.html#11321">[ thread ]</a>
              <a href="subject.html#11321">[ subject ]</a>
              <a href="author.html#11321">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

A persistent message is one Rabbit will try to write to disk, but if the
server is killed before it gets the chance to do this, the message will
be lost.

There are a few ways to remedy this, either by using transactions or by
using confirms (see our recent blog posts).  That said, I don't know if
you can get Celery to use any of these mechanisms.

Cheers,
Alex

On Fri, Feb 18, 2011 at 01:49:46PM -0800, hekevintran wrote:
&gt;<i> It looks like the delivery mode is already set to 2:
</I>&gt;<i> 
</I>&gt;<i>     In [1]: from apps.test_app.tasks import add
</I>&gt;<i> 
</I>&gt;<i>     In [2]: add.delivery_mode
</I>&gt;<i>     Out[2]: 2
</I>&gt;<i> 
</I>&gt;<i> This default cannot be changed in celery as far as I know.
</I>&gt;<i> 
</I>&gt;<i> On Feb 18, 1:40&#160;pm, &quot;Gavin M. Roy&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">g... at myyearbook.com</A>&gt; wrote:
</I>&gt;<i> &gt; Not sure of the celery underpinnings for specifying persistent messages,
</I>&gt;<i> &gt; perhaps it's documented, but you need to set the message delivery_mode = 2
</I>&gt;<i> &gt; in the message properties when calling Basic.Publish.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Fri, Feb 18, 2011 at 4:19 PM, hekevintran &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">hekevint... at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; I am using RabbitMQ with Django through Celery. I am using the most
</I>&gt;<i> &gt; &gt; basic setup:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; &#160; &#160;# RabbitMQ connection settings
</I>&gt;<i> &gt; &gt; &#160; &#160;BROKER_HOST = 'localhost'
</I>&gt;<i> &gt; &gt; &#160; &#160;BROKER_PORT = '5672'
</I>&gt;<i> &gt; &gt; &#160; &#160;BROKER_USER = 'guest'
</I>&gt;<i> &gt; &gt; &#160; &#160;BROKER_PASSWORD = 'guest'
</I>&gt;<i> &gt; &gt; &#160; &#160;BROKER_VHOST = '/'
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; I imported a Celery task and queued it to run one year later. From the
</I>&gt;<i> &gt; &gt; iPython shell:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; &#160; &#160;In [1]: from apps.test_app.tasks import add
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; &#160; &#160;In [2]: dt=datetime.datetime(2012, 2, 18, 10, 00)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; &#160; &#160;In [3]: add.apply_async((10, 6), eta=dt)
</I>&gt;<i> &gt; &gt; &#160; &#160;DEBUG:amqplib:Start from server, version: 8.0, properties:
</I>&gt;<i> &gt; &gt; {u'information': 'Licensed under the MPL. &#160;<A HREF="Seehttp://www.rabbitmq.com/',">Seehttp://www.rabbitmq.com/',</A>
</I>&gt;<i> &gt; &gt; u'product': 'RabbitMQ', u'version': '2.2.0', u'copyright': 'Copyright
</I>&gt;<i> &gt; &gt; (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies LLC., and
</I>&gt;<i> &gt; &gt; Rabbit Technologies Ltd.', u'platform': 'Erlang/OTP'}, mechanisms:
</I>&gt;<i> &gt; &gt; ['PLAIN', 'AMQPLAIN'], locales: ['en_US']
</I>&gt;<i> &gt; &gt; &#160; &#160;DEBUG:amqplib:Open OK! known_hosts []
</I>&gt;<i> &gt; &gt; &#160; &#160;DEBUG:amqplib:using channel_id: 1
</I>&gt;<i> &gt; &gt; &#160; &#160;DEBUG:amqplib:Channel open
</I>&gt;<i> &gt; &gt; &#160; &#160;DEBUG:amqplib:Closed channel #1
</I>&gt;<i> &gt; &gt; &#160; &#160;Out[3]: &lt;AsyncResult: cfc507a1-175f-438e-acea-8c989a120ab3&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; RabbitMQ received this message in the celery queue:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; &#160; &#160;$ &#160;rabbitmqctl list_queues name messages durable
</I>&gt;<i> &gt; &gt; &#160; &#160;Listing queues ...
</I>&gt;<i> &gt; &gt; &#160; &#160;KTMacBook.local.celeryd.pidbox &#160; &#160; &#160;0 &#160; &#160; &#160; false
</I>&gt;<i> &gt; &gt; &#160; &#160;celery &#160; &#160; &#160;1 &#160; &#160; &#160; true
</I>&gt;<i> &gt; &gt; &#160; &#160;celeryctl_KTMacBook.local &#160; 0 &#160; &#160; &#160; true
</I>&gt;<i> &gt; &gt; &#160; &#160;...done.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; I then killed RabbitMQ by hitting control-C followed by 'a' to abort.
</I>&gt;<i> &gt; &gt; When I start the server again and check it with rabbitmqctl, it says
</I>&gt;<i> &gt; &gt; that there are no messages in the celery queue:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; &#160; &#160;$ &#160;rabbitmqctl list_queues name messages durable
</I>&gt;<i> &gt; &gt; &#160; &#160;Listing queues ...
</I>&gt;<i> &gt; &gt; &#160; &#160;celery &#160; &#160; &#160;0 &#160; &#160; &#160; true
</I>&gt;<i> &gt; &gt; &#160; &#160;celeryctl_KTMacBook.local &#160; 0 &#160; &#160; &#160; true
</I>&gt;<i> &gt; &gt; &#160; &#160;...done.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; The celery queue was durable. Why were the messages not persisted?
</I>&gt;<i> &gt; &gt; What do I need to do to make the messages persistent?
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; &gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>




































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011320.html">[rabbitmq-discuss] Why is RabbitMQ not persisting messages on a	durable queue?
</A></li>
	<LI>Next message: <A HREF="011322.html">[rabbitmq-discuss] Why is RabbitMQ not persisting messages on a durable queue?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11321">[ date ]</a>
              <a href="thread.html#11321">[ thread ]</a>
              <a href="subject.html#11321">[ subject ]</a>
              <a href="author.html#11321">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
