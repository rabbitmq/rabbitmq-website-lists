<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Blocked connections on rabbitmq 2.2.0
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Blocked%20connections%20on%20rabbitmq%202.2.0&In-Reply-To=%3Ca83097fd-425c-456d-91d4-4e4d8047da2f%40r19g2000prm.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011064.html">
   <LINK REL="Next"  HREF="011067.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Blocked connections on rabbitmq 2.2.0</H1>
    <B>Ivan Sanchez</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Blocked%20connections%20on%20rabbitmq%202.2.0&In-Reply-To=%3Ca83097fd-425c-456d-91d4-4e4d8047da2f%40r19g2000prm.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Blocked connections on rabbitmq 2.2.0">s4nchez at gmail.com
       </A><BR>
    <I>Fri Feb  4 12:42:13 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011064.html">[rabbitmq-discuss] Blocked connections on rabbitmq 2.2.0
</A></li>
        <LI>Next message: <A HREF="011067.html">[rabbitmq-discuss] Blocked connections on rabbitmq 2.2.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11066">[ date ]</a>
              <a href="thread.html#11066">[ thread ]</a>
              <a href="subject.html#11066">[ subject ]</a>
              <a href="author.html#11066">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>  Hi Marek,

  Thank you for your answer. I've got a few of the following alerts:

  =INFO REPORT==== 2-Feb-2011::21:05:38 ===
vm_memory_high_watermark set. Memory used:6611768328 allowed:
3351445504

=INFO REPORT==== 2-Feb-2011::21:05:38 ===
    alarm_handler: {set,{vm_memory_high_watermark,[]}}

  Apart from the cluster setup, the only other setting I have in my
config is ERL_MAX_ETS_TABLES=10000.

  The part that's confusing to me is that only one node had this issue
(even after resetting the whole cluster), and I'm not using persistent
messages. So now I'm not sure what else could be causing the memory
problem.

  Is there anything else I'm missing here?

  Thanks again for your help.

--
Ivan

On Feb 4, 11:53&#160;am, Marek Majkowski &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">maje... at gmail.com</A>&gt; wrote:
&gt;<i> On Thu, Feb 3, 2011 at 20:36, Ivan Sanchez &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">s4nc... at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; &#160;Yesterday I've noticed some very strange behaviour in one of our
</I>&gt;<i> &gt; rabbitmq cluster nodes. Its queues became unresponsive and running
</I>&gt;<i> &gt; &quot;rabbitmqctl list_connections&quot; was returning that all the connections
</I>&gt;<i> &gt; were either &quot;blocking&quot; or &quot;blocked&quot;. The documentation doesn't mention
</I>&gt;<i> &gt; these states. Does anyone know what they mean?
</I>&gt;<i>
</I>&gt;<i> &gt; &#160;To give a bit of context: we noticed this problem when good portion
</I>&gt;<i> &gt; of our clients stopped receiving messages. Looking at all the servers
</I>&gt;<i> &gt; we found one that was using too much CPU and also swapping to disk.
</I>&gt;<i> &gt; This node was the only presenting this behaviour, but it seemed like
</I>&gt;<i> &gt; this problem compromised the whole cluster. We haven't touched these
</I>&gt;<i> &gt; servers for ages (they are dedicated to rabbitmq) and the system load
</I>&gt;<i> &gt; was completely under normal levels. We use simple DNS round-robin for
</I>&gt;<i> &gt; clients to connect to the cluster and none of our messages are
</I>&gt;<i> &gt; persistent, so seeing swapping really scared me.
</I>&gt;<i>
</I>&gt;<i> &gt; &#160;After restarting the whole cluster a few times the problem
</I>&gt;<i> &gt; persisted, always on the same server. We even tried force_reset in all
</I>&gt;<i> &gt; nodes, but that also didn't help. Things just went back to normal
</I>&gt;<i> &gt; after we removed the problematic node from the cluster. Now my task if
</I>&gt;<i> &gt; figure out what can be the problem.
</I>&gt;<i>
</I>&gt;<i> &gt; &#160;Did anyone have experience with this kind of behaviour? I'm even
</I>&gt;<i> &gt; considering hardware problem, but so far didn't find anything
</I>&gt;<i> &gt; indicating that was the case.
</I>&gt;<i>
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> When RabbitMQ is using more memory than it should,
</I>&gt;<i> to avoid crashing, it stops accepting new messages.
</I>&gt;<i>
</I>&gt;<i> In AMQP publishing messages is asynchronous, and
</I>&gt;<i> it's illegal to 'reject' a published message.
</I>&gt;<i>
</I>&gt;<i> Instead, when RabbitMQ is under a memory pressure
</I>&gt;<i> it stops receiving data from tcp connections that try to
</I>&gt;<i> do 'basic_publish'.
</I>&gt;<i>
</I>&gt;<i> That's what the 'blocked' connection state means.
</I>&gt;<i>
</I>&gt;<i> It's perfectly legal to open second connection and
</I>&gt;<i> consume messages using it as long as it doesn't do 'basic_publish'.
</I>&gt;<i>
</I>&gt;<i> Please check for memory alerts in your RabbitMQ logs,
</I>&gt;<i> check if memory watermark is being set properly
</I>&gt;<i> and if you have enough memory for your Rabbit.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> &#160; Marek
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011064.html">[rabbitmq-discuss] Blocked connections on rabbitmq 2.2.0
</A></li>
	<LI>Next message: <A HREF="011067.html">[rabbitmq-discuss] Blocked connections on rabbitmq 2.2.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11066">[ date ]</a>
              <a href="thread.html#11066">[ thread ]</a>
              <a href="subject.html#11066">[ subject ]</a>
              <a href="author.html#11066">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
