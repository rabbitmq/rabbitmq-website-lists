<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Message redelivering doubt with one and with more than one consumers.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Message%20redelivering%20doubt%20with%20one%20and%20with%0A%20more%20than%20one%20consumers.&In-Reply-To=%3CAANLkTikomXB8JX65s6oz_XhOYL8RoXMfRg7W-bg9kNkB%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011246.html">
   <LINK REL="Next"  HREF="011253.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Message redelivering doubt with one and with more than one consumers.</H1>
    <B>Alfonso Pantoja</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Message%20redelivering%20doubt%20with%20one%20and%20with%0A%20more%20than%20one%20consumers.&In-Reply-To=%3CAANLkTikomXB8JX65s6oz_XhOYL8RoXMfRg7W-bg9kNkB%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Message redelivering doubt with one and with more than one consumers.">alfonso.pantoja at gmail.com
       </A><BR>
    <I>Mon Feb 14 22:24:14 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011246.html">[rabbitmq-discuss] Message redelivering doubt with one and with more than one consumers.
</A></li>
        <LI>Next message: <A HREF="011253.html">[rabbitmq-discuss] Message redelivering doubt with one and with more than one consumers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11250">[ date ]</a>
              <a href="thread.html#11250">[ thread ]</a>
              <a href="subject.html#11250">[ subject ]</a>
              <a href="author.html#11250">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Thank for that clear explanation. You really helped me.

In the first approach of my code I didn't ack messages that couldn't
be processed by my business logic (for instance when they couldn't be
stored in the database due to a connection error) so I counted then
un-ack'd messages and when they reach a threshold number I called
basic.recover because as I read on the documentation basic.reject was
not implemented in 1.7.2.
Now using 2.2.0 version (server and API) I replaced basic.recover with
basic.reject which doesn't requeue the whole messages in the queue as
basic.recover did (and the CPU wasn't very 'happy' with it)

The use of basic.reject{requeue=true} implies that there is no need to
un-ack messages thus counting those messages and calling basic.recover
to put them again in the queue is not necessary.
So when receiving messages the only possible actions are basic.ack for
messages OK, basic.reject{requeue=true}  for messages that couldn't be
processed and basic.reject{requeue=false} for discarding the messages
we don't want to process.
In this scenario I think that un-ack'd messages are only possible when
the consumer crashes or it is stopped so basic.recover calls are
totally unnecessary because, as you said, the messages will be requeue
when a consumer is connected again.
An also I suppose it is better to actively response to Rabbit about
the messages (discarding  or requeing using basic.reject) instead of
&quot;not respoding&quot; for un-ack them.

Am I right or am I missing something?


Best regards,


Alfonso










2011/2/14 Alexandru Scvor&#355;ov &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexandru at rabbitmq.com</A>&gt;:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;&gt;<i> In a scenario with one consumer as I saw in my tests, the consumer
</I>&gt;&gt;<i> received messages with the Redelivered=true AMQP header atribute.
</I>&gt;&gt;<i> The consumer was based in the classes provided by the .NET API and as
</I>&gt;&gt;<i> I remember the consumer-tag is random generated by the server.
</I>&gt;<i>
</I>&gt;<i> Sounds good.
</I>&gt;<i>
</I>&gt;&gt;<i> When there is a only one consumer (with a random consumer-tag name)
</I>&gt;&gt;<i> and a message is not acked when the consumer is reconnected (so has
</I>&gt;&gt;<i> another random tag name) that message is redelivered?
</I>&gt;<i>
</I>&gt;<i> Yes, un-ack'd messages will be redelivered to the consumer when it
</I>&gt;<i> reconnects. &#160;Be aware, though, they will be redelivered *after* the
</I>&gt;<i> messages still on the queue (i.e. the undelivered ones) are delivered.
</I>&gt;<i>
</I>&gt;<i> So, if the following messages are published to the queue:
</I>&gt;<i> &#160;1 2 3 4 5 6
</I>&gt;<i>
</I>&gt;<i> And the following are delivered but not ack'd by the consumer:
</I>&gt;<i> &#160;1 2 3
</I>&gt;<i>
</I>&gt;<i> If the consumer crashes and reconnects, the messages delivered in order
</I>&gt;<i> will be:
</I>&gt;<i> &#160;4 5 6 1 2 3
</I>&gt;<i>
</I>&gt;&gt;<i> Based on my experience I think this is true but don't understand that
</I>&gt;&gt;<i> &quot;If that same consumer then reconnects and creates a new subscription
</I>&gt;&gt;<i> to the same queue&quot;...
</I>&gt;<i>
</I>&gt;<i> That's just another way of saying it reconnects and starts consuming
</I>&gt;<i> again.
</I>&gt;<i>
</I>&gt;&gt;<i> By the was my consumer always tries to create the queue and the
</I>&gt;&gt;<i> bindings every time it connects to RabbitMQ.
</I>&gt;<i>
</I>&gt;<i> That's perfect. &#160;You should always do that.
</I>&gt;<i>
</I>&gt;&gt;<i> And also I'm wondering how this behavior acts when there are more than
</I>&gt;&gt;<i> one consumer (same queue and same bindings)...
</I>&gt;<i>
</I>&gt;<i> Messages are delivered one at a time to consumers in round-robin order.
</I>&gt;<i> If a message is delivered and the consumer dies, the message is
</I>&gt;<i> republished to the queue and a consumer will eventually get it (note
</I>&gt;<i> that it may be the same client if it reconnects).
</I>&gt;<i>
</I>&gt;&gt;<i> Under what circumstances an unack message wouldn't be redelivered again?
</I>&gt;<i>
</I>&gt;<i> In none of the circumstances we were talking about. &#160;A client can
</I>&gt;<i> basic.reject{requeue=false} a message, in which case it will not be
</I>&gt;<i> requeued.
</I>&gt;<i>
</I>&gt;<i> Hope this helps.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;<i> On Thu, Feb 10, 2011 at 10:26:53AM +0100, Alfonso Pantoja wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> on the RabbitMQ FAQ page I see the response to
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;Can you explain the cases where a message might be delivered to a
</I>&gt;&gt;<i> consumer more than once?&quot;
</I>&gt;&gt;<i> the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;If a message is delivered to a consumer, and that consumer then dies
</I>&gt;&gt;<i> (or closes the channel which has the subscription to the queue, or
</I>&gt;&gt;<i> closes the connection itself) without acking the message, then
</I>&gt;&gt;<i> RabbitMQ will reinject the message into the queue. If that same
</I>&gt;&gt;<i> consumer then reconnects and creates a new subscription to the same
</I>&gt;&gt;<i> queue, it's possible it'll receive the same message again. This is 'at
</I>&gt;&gt;<i> least once' delivery and is very deliberate design to ensure that
</I>&gt;&gt;<i> messages are not lost in transit.&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So my doubt is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In a scenario with one consumer as I saw in my tests, the consumer
</I>&gt;&gt;<i> received messages with the Redelivered=true AMQP header atribute.
</I>&gt;&gt;<i> The consumer was based in the classes provided by the .NET API and as
</I>&gt;&gt;<i> I remember the consumer-tag is random generated by the server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When there is a only one consumer (with a random consumer-tag name)
</I>&gt;&gt;<i> and a message is not acked when the consumer is reconnected (so has
</I>&gt;&gt;<i> another random tag name) that message is redelivered?
</I>&gt;&gt;<i> Based on my experience I think this is true but don't understand that
</I>&gt;&gt;<i> &quot;If that same consumer then reconnects and creates a new subscription
</I>&gt;&gt;<i> to the same queue&quot;...
</I>&gt;&gt;<i> By the was my consumer always tries to create the queue and the
</I>&gt;&gt;<i> bindings every time it connects to RabbitMQ.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And also I'm wondering how this behavior acts when there are more than
</I>&gt;&gt;<i> one consumer (same queue and same bindings)...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Under what circumstances an unack message wouldn't be redelivered again?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you in advance.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regards,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alfonso
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The consumer can also call basic.recover which tells rabbit to resend
</I>&gt;&gt;<i> all the messages sent to the consumer for which rabbit has not
</I>&gt;&gt;<i> received an ack for. This basically amounts to the consumer saying &quot;I
</I>&gt;&gt;<i> know you sent me some messages, but I've forgotten what they are.
</I>&gt;&gt;<i> Could you resend them all again?&quot;.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I></PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011246.html">[rabbitmq-discuss] Message redelivering doubt with one and with more than one consumers.
</A></li>
	<LI>Next message: <A HREF="011253.html">[rabbitmq-discuss] Message redelivering doubt with one and with more than one consumers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11250">[ date ]</a>
              <a href="thread.html#11250">[ thread ]</a>
              <a href="subject.html#11250">[ subject ]</a>
              <a href="author.html#11250">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
