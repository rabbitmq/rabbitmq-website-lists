<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Limit QueueingConsumer Memory Usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Limit%20QueueingConsumer%20Memory%20Usage&In-Reply-To=8a623f4f-5a36-4ef2-b884-315cc4764fe4%40f33g2000vbm.googlegroups.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004061.html">
   <LINK REL="Next"  HREF="004067.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Limit QueueingConsumer Memory Usage</H1>
    <B>Lars George</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Limit%20QueueingConsumer%20Memory%20Usage&In-Reply-To=8a623f4f-5a36-4ef2-b884-315cc4764fe4%40f33g2000vbm.googlegroups.com"
       TITLE="[rabbitmq-discuss] Limit QueueingConsumer Memory Usage">lars at worldlingo.com
       </A><BR>
    <I>Fri Jul 10 21:36:09 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004061.html">[rabbitmq-discuss] Limit QueueingConsumer Memory Usage
</A></li>
        <LI>Next message: <A HREF="004067.html">[rabbitmq-discuss] Limit QueueingConsumer Memory Usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4063">[ date ]</a>
              <a href="thread.html#4063">[ thread ]</a>
              <a href="subject.html#4063">[ subject ]</a>
              <a href="author.html#4063">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amit,

Thanks for the answer. So this QoS is only in trunk of the Java client. 
I will have to check this out.

Using the DefaultConsumer means extending it anyways, right? As by 
default it does not do anything. Even setting QoS to 1 would mean you 
will have to enforce ack'ing the message or else the async process will 
keep sending the next one. So a simple single local Delivery bean 
instance could hold the current message.

Saves the queue part. But then you also have to lock on that instance 
for the blocking behavior, which the QueueingConsumer has build in.

Am I on the right track here?

Regards,
Lars

amit bhatnagar wrote:
&gt;<i> Having said this, I am wondering if it makes sense to use a
</I>&gt;<i> QueueingConsumer on a channel that has a basicQos of 1? Would I be
</I>&gt;<i> safe to use a DefaultConsumer here instead?
</I>&gt;<i>
</I>&gt;<i> On Jul 10, 8:23 am, amit bhatnagar &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">brownsp... at gmail.com</A>&gt; wrote:
</I>&gt;<i>   
</I>&gt;&gt;<i> Check out Channel.BasicQos() and set a prefetch count.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Have a look here for a good description of the prefetch:<A HREF="http://hopper.squarespace.com/blog/2009/1/26/work-distribution-in-rab...">http://hopper.squarespace.com/blog/2009/1/26/work-distribution-in-rab...</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> fta:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;This command allows a consumer to choose a prefetch window that
</I>&gt;&gt;<i> specifies the amount of unacknowledged messages it is prepared to
</I>&gt;&gt;<i> receive. By setting the prefetch count to a non-zero value, the broker
</I>&gt;&gt;<i> will not deliver any messages to the consumer that would breach that
</I>&gt;&gt;<i> limit. To move the window forwards, the consumer has to acknowledge
</I>&gt;&gt;<i> the receipt of a message (or a group of messages). By acknowledging a
</I>&gt;&gt;<i> message, the consumer gains credit in the broker which makes it
</I>&gt;&gt;<i> eligible to receive more messages. This credit-based flow control
</I>&gt;&gt;<i> allows the broker to distribute work proportional to the individual
</I>&gt;&gt;<i> processing ability of each worker, as opposed to a simple round robin
</I>&gt;&gt;<i> mechanism.&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Jul 10, 4:32 am, Lars George &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">l... at worldlingo.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;&gt;<i> I would like to use a blocking provider, but the QueueingConsumer is
</I>&gt;&gt;&gt;<i> somewhat limiting as it receives whatever the queue sends and caches it
</I>&gt;&gt;&gt;<i> locally, in the app servers memory. If that is a very large number then
</I>&gt;&gt;&gt;<i> you can quickly run out of memory and kill the Java process with an OOME.
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;&gt;<i> Is there a way to implement a Consumer that say only receives N queue
</I>&gt;&gt;&gt;<i> items before it waits until they get processed locally? I mean from the
</I>&gt;&gt;&gt;<i> internal BlockingQueue and using handleDelivery() this is doable but
</I>&gt;&gt;&gt;<i> then you would block the main loop in the AMPQ connection - and miss
</I>&gt;&gt;&gt;<i> heart beats etc.?
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;&gt;<i> Is there a better way with this or do I have to go with a dumb while
</I>&gt;&gt;&gt;<i> (true) { channel.basicGet() } loop. With that you have the issue to
</I>&gt;&gt;&gt;<i> somehow gracefully handle the null delivery and not create a loop that
</I>&gt;&gt;&gt;<i> consumes all CPU cycles with no actual work being done.
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;<i> Lars
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;&gt;<i>  lars.vcf
</I>&gt;&gt;&gt;<i> &lt; 1KViewDownload
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttp</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttp</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;&gt;<i>     
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>   
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: lars.vcf
Type: text/x-vcard
Size: 301 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090710/3ba9de13/attachment.vcf">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090710/3ba9de13/attachment.vcf</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004061.html">[rabbitmq-discuss] Limit QueueingConsumer Memory Usage
</A></li>
	<LI>Next message: <A HREF="004067.html">[rabbitmq-discuss] Limit QueueingConsumer Memory Usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4063">[ date ]</a>
              <a href="thread.html#4063">[ thread ]</a>
              <a href="subject.html#4063">[ subject ]</a>
              <a href="author.html#4063">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
