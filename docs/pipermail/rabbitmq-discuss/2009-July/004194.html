<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] fanout exchange that does not keep messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20fanout%20exchange%20that%20does%20not%20keep%20messages&In-Reply-To=dbd9700a0907210625k7afabafeked2750299779731e%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004193.html">
   <LINK REL="Next"  HREF="004195.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] fanout exchange that does not keep messages</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20fanout%20exchange%20that%20does%20not%20keep%20messages&In-Reply-To=dbd9700a0907210625k7afabafeked2750299779731e%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] fanout exchange that does not keep messages">matthias at lshift.net
       </A><BR>
    <I>Tue Jul 21 14:58:57 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004193.html">[rabbitmq-discuss] fanout exchange that does not keep messages
</A></li>
        <LI>Next message: <A HREF="004195.html">[rabbitmq-discuss] fanout exchange that does not keep messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4194">[ date ]</a>
              <a href="thread.html#4194">[ thread ]</a>
              <a href="subject.html#4194">[ subject ]</a>
              <a href="author.html#4194">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Brian,

Brian Whitman wrote:
&gt;<i> Matthias -- I'm not sure how I'm seeing them in the queue list when
</I>&gt;<i> there are no consumers. And relatedly perhaps, the broker will crash
</I>&gt;<i> after 20 hours or so when it runs out of memory, which confuses me as
</I>&gt;<i> the queue lengths are always 0.
</I>&gt;<i> 
</I>&gt;<i> Here's my steps using the following code:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://notes.variogr.am/post/143623387/broadcasting-your-logs-with-rabbitmq-and-python">http://notes.variogr.am/post/143623387/broadcasting-your-logs-with-rabbitmq-and-python</A>
</I>&gt;<i> 
</I>&gt;<i> 1) Declare a Producer() and start sending messages 
</I>&gt;<i>  - this does a channel access request, declares the fanout exchange w/
</I>&gt;<i> auto_delete=True, then declares the &quot;logger&quot; queue with exclusive False
</I>&gt;<i> and auto_delete as True, then binds the exchange and the queue
</I>&gt;<i> 
</I>&gt;<i> At this point logger shows up in list_queues with 0 messages. There are
</I>&gt;<i> about 8 machines all writing messages to the queue (using immediate=True
</I>&gt;<i> on basic_publish.) There are no consumers at this point but the queue
</I>&gt;<i> &quot;logger&quot; is in the list.
</I>&gt;<i> 
</I>&gt;<i> 2) Declare a few Consumers() 
</I>&gt;<i>  - this does the same channel access request, declare, bind as the
</I>&gt;<i> Producer() -- same auto_delete and etc except the queue name is now
</I>&gt;<i> &quot;logger-randomUUID&quot; per Conusmer
</I>&gt;<i> 
</I>&gt;<i> At this point logger and any logger-randomUUID show up in the
</I>&gt;<i> list_queues. Each has 0 messages, always. Everything works as it
</I>&gt;<i> should... consumers get messages from the Producers, queue size stays 0. 
</I>&gt;<i> 
</I>&gt;<i> But...
</I>&gt;<i> 
</I>&gt;<i> Memory keeps going
</I>&gt;<i> up -- and eventually the broker will crash. Yesterday it lasted about 20 hours. I booted it again this a.m. and am testing with abnormal message loads (sending millions of messages.) Right
</I>&gt;<i> now memory is at 3.9% and increasing after only running 30m.
</I>&gt;<i> 
</I>&gt;<i> I am using a newer version on the server, yes, and I will do a test on
</I>&gt;<i> the release version to see if that behavior changes. But my guess is I
</I>&gt;<i> am doing something else wrong in my queue setup.
</I>
Your setup looks basically ok, except for two things:

1) no consumers ever subscribe to the &quot;logger&quot; queue. That means it
would normally keep accumulating messages. The only reason it doesn't is
because you set immediate=true, but that's generally not the best way to
go about suppressing message storage. Why do you have the logger queue
at all?

2) You are setting immediate=true. I'd advise against that, for reasons
I explained earlier. Setting exclusive or auto_delete on the queues, so
that they disappear when the consumers vanish, should be sufficient.

Neither explains a gradual growth in memory usage. My best guess atm is
that there is a bug in the particular branch of the code you are working
on. So please try the 1.6.0 release. Also, if you still see the problem
then, please post precise instructions on how to reproduce it - a
transcript of a command line session showing how you are invoking the
various producer and consumers scripts would be great.


Regards,

Matthias.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004193.html">[rabbitmq-discuss] fanout exchange that does not keep messages
</A></li>
	<LI>Next message: <A HREF="004195.html">[rabbitmq-discuss] fanout exchange that does not keep messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4194">[ date ]</a>
              <a href="thread.html#4194">[ thread ]</a>
              <a href="subject.html#4194">[ subject ]</a>
              <a href="author.html#4194">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
