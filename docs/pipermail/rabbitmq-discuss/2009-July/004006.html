<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Dropping out messages from a queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Dropping%20out%20messages%20from%20a%20queue&In-Reply-To=167204d20907040253t7237c0bre7b2735594f56de0%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004001.html">
   <LINK REL="Next"  HREF="004020.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Dropping out messages from a queue</H1>
    <B>GAGAN ARORA</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Dropping%20out%20messages%20from%20a%20queue&In-Reply-To=167204d20907040253t7237c0bre7b2735594f56de0%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Dropping out messages from a queue">gaganarora.itm at gmail.com
       </A><BR>
    <I>Sat Jul  4 20:07:08 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004001.html">[rabbitmq-discuss] Dropping out messages from a queue
</A></li>
        <LI>Next message: <A HREF="004020.html">[rabbitmq-discuss] Dropping out messages from a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4006">[ date ]</a>
              <a href="thread.html#4006">[ thread ]</a>
              <a href="subject.html#4006">[ subject ]</a>
              <a href="author.html#4006">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alexis,

Thanks for your wonderful support and solutions.

Firstly answers to your queries:

1. Are you using fanout exchanges for this (if you want one exchange
per user, then the answer should be 'yes').

&gt;&gt;<i> No I am using topic exchanges because there will be three type of
</I>bindings of a queue with an excajnde. One for publishing messages to all
users, another for one to one messaging and third for publishing message to
a set of users.

2. Where is the RabbitMQ server running?  Is it on Server 1 or 2, or
is it on a 3rd server?  It may not be that important but it would be
good to know.

&gt;&gt;<i> RabbitMQ Server is running on 3rd Server.
</I>

Back to original problem.

Actually I thought of the solution provided by you before posting the query
to you. But if I follow this solution I have to perform following steps
whenever a user comes online:
1. Create a queue.
2. Create a binding of newly created queue with all exchanges of other users
for retrieving messages published by other users.
3. Creating a binding with exchange of all users for one to one messaging.
4. Create a binding with exchanges of a set of users.

When user goes offline following operation is to be performed:
1. Delete all the existing bindings of a queue.
2. Deleting the queue.

Actually I want my online and offline processes light weighted. According to
me this solution would have a high impact on performance and will increase
time to come online and offline.

Kindly let me know if this can be achieved in some other manner.

Thanks
Gagan Arora





On Sat, Jul 4, 2009 at 3:23 PM, Alexis Richardson &lt;
<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexis.richardson at gmail.com</A>&gt; wrote:

&gt;<i> Gagan,
</I>&gt;<i>
</I>&gt;<i> Hi - thank-you for sending the diagram and information which was very
</I>&gt;<i> useful.  There are several ways to implement the 'twitter style'
</I>&gt;<i> pattern that you have described.  See below for one way to do it that
</I>&gt;<i> illustrates the AMQP model.  It may not be the most efficient solution
</I>&gt;<i> in terms of performance as I shall point out.
</I>&gt;<i>
</I>&gt;<i> Two quick questions:
</I>&gt;<i>
</I>&gt;<i> 1. Are you using fanout exchanges for this (if you want one exchange
</I>&gt;<i> per user, then the answer should be 'yes').
</I>&gt;<i>
</I>&gt;<i> 2. Where is the RabbitMQ server running?  Is it on Server 1 or 2, or
</I>&gt;<i> is it on a 3rd server?  It may not be that important but it would be
</I>&gt;<i> good to know.
</I>&gt;<i>
</I>&gt;<i> OK - to your cases -
</I>&gt;<i>
</I>&gt;<i> Case1: User B sending his message to UserB Exchange which will route
</I>&gt;<i> message to User A queue but User A is not connected to any of servers.
</I>&gt;<i> At this point of  all messages sent to Queue A should be dropped.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; One way to do this is to identify the lifecycle of Queue A with the
</I>&gt;<i> presence of User A on servers 1 and 2.  In other words, when User A is not
</I>&gt;<i> connected to server 1, and also not connected to server 2, then Queue A does
</I>&gt;<i> not exist.  Note - This is not the only way to achieve what you want but it
</I>&gt;<i> may be the least fiddly :-)
</I>&gt;<i>
</I>&gt;<i> Case2: User A connected to server 1 but UserA consumer is not yet
</I>&gt;<i> subscribed to UserA queue. If UserB sends any message to its exchange
</I>&gt;<i> which is routed to Queue of UserA. At this moment of time I want all
</I>&gt;<i> messages to be stored in queue.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; One way to do this (continuing from the above) is to create Queue A
</I>&gt;<i> immediately after UserA connects to server 1.  This is an action that server
</I>&gt;<i> 1 can initiate on behalf of UserA.  After Queue A has been created, then it
</I>&gt;<i> should be bound to all exchanges from which it will receive messages, such
</I>&gt;<i> as UserB's exchange.  This will then have the stated effect you seek &quot;If
</I>&gt;<i> UserB sends any message to its exchange [it] is routed to Queue of UserA.&quot;.
</I>&gt;<i>  Also, because UserA's consumer has not yet started consuming messages from
</I>&gt;<i> Queue A, the messages will all remain stored in the queue.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; In addition, if instead of proceeding to Case 3, we revert to Case 1,
</I>&gt;<i> for example User A disconnects from Server 1, then Queue A can simply be
</I>&gt;<i> deleted (along with its contents).  (See also Case 5 below)
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; However - while simple, the above is possibly not the most performant
</I>&gt;<i> solution if (a) you are running RabbitMQ in clustered mode and (b) your
</I>&gt;<i> Users generally follow a lot of other Users and (c) they connect and
</I>&gt;<i> disconnect frequently.  This is because the effect of (c) is to frequuently
</I>&gt;<i> update the routing table, possibly with a lot of binding/routing data (b),
</I>&gt;<i> and then replicating it across the cluster (a).
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; Let us know if you want more info about other ways to do this.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Case3: User A is connected to both servers and UserA consumer is
</I>&gt;<i> subscribed to UserA queue. If UserB sends any message to its exchange
</I>&gt;<i> which is routed to Queue of UserA. At this moment of time I want all
</I>&gt;<i> messages stored in queue to be delievered plus any other incoming
</I>&gt;<i> message should also be routed.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; In any case, to achieve this, just start consuming messages from Queue
</I>&gt;<i> A.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; I assume by 'delivered', you mean 'delivered to UserA's consumer'.
</I>&gt;<i>  Where is that running?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Case4: User A is connected to both servers and UserA consumer is
</I>&gt;<i> subscribed to UserA queue. Now User disconnects from Server 2. If
</I>&gt;<i> UserB sends any message to its exchange which is routed to Queue of
</I>&gt;<i> UserA. Again I want to store all messages.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; To achieve this, just stop consuming messages from Queue A.  They will
</I>&gt;<i> be stored in Queue A.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Case5: If user A is disconnected from both servers. Initial state is
</I>&gt;<i> achieved again.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; When User A disconnects from Server 1, then Server 1 can tell RabbitMQ
</I>&gt;<i> to delete Queue A (along with its contents)
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> alexis
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Jul 3, 2009 at 5:05 PM, GAGAN ARORA&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">gaganarora.itm at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt; Hi Alexis
</I>&gt;<i> &gt; Attaching a doc having architecture diagram and cases desired. Hope this
</I>&gt;<i> &gt; would make things more clear to you.
</I>&gt;<i> &gt; Thanks
</I>&gt;<i> &gt; Gagan Arora
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Fri, Jul 3, 2009 at 8:23 PM, Alexis Richardson
</I>&gt;<i> &gt; &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexis.richardson at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Gagan,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I'm a bit confused about what you are trying to do.  I think what you
</I>&gt;<i> &gt;&gt; describe is possible but I am not sure what role is being played by
</I>&gt;<i> &gt;&gt; your two servers.  Is RabbitMQ running on both of them, one of them,
</I>&gt;<i> &gt;&gt; or neither?  You may find it easier to just use one RabbitMQ server.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Can you send a drawing of what your desired configuration is?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; alexis
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On Fri, Jul 3, 2009 at 3:08 PM, GAGAN ARORA&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">gaganarora.itm at gmail.com</A>&gt;
</I>&gt;<i> &gt;&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt; Hi
</I>&gt;<i> &gt;&gt; &gt; I am developing a system in which a user will connect to two servers.
</I>&gt;<i> On
</I>&gt;<i> &gt;&gt; &gt; connecting to first server he will become online and will send his
</I>&gt;<i> &gt;&gt; &gt; presence
</I>&gt;<i> &gt;&gt; &gt; update but he will receive presence updates only once he is connected
</I>&gt;<i> to
</I>&gt;<i> &gt;&gt; &gt; other server as his consumer subscribes to his queue after connecting
</I>&gt;<i> to
</I>&gt;<i> &gt;&gt; &gt; second server.
</I>&gt;<i> &gt;&gt; &gt; I am using one exchange and one queue per user. So if one user comes
</I>&gt;<i> &gt;&gt; &gt; online
</I>&gt;<i> &gt;&gt; &gt; then he will send his presence update to his exchange and users bound
</I>&gt;<i> to
</I>&gt;<i> &gt;&gt; &gt; that will receive updates.
</I>&gt;<i> &gt;&gt; &gt; I need to configure a queue which would hold messages for user who has
</I>&gt;<i> &gt;&gt; &gt; just
</I>&gt;<i> &gt;&gt; &gt; came online until he is connected to other server. After connecting to
</I>&gt;<i> &gt;&gt; &gt; second server all messages will be consumed. All messages sent to
</I>&gt;<i> queue
</I>&gt;<i> &gt;&gt; &gt; will
</I>&gt;<i> &gt;&gt; &gt; be dropped once user goes offline.
</I>&gt;<i> &gt;&gt; &gt; Is it possible?
</I>&gt;<i> &gt;&gt; &gt; Thanks
</I>&gt;<i> &gt;&gt; &gt; Gagan Arora
</I>&gt;<i> &gt;&gt; &gt; _______________________________________________
</I>&gt;<i> &gt;&gt; &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt;&gt; &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;&gt; &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090705/73a317a8/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090705/73a317a8/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004001.html">[rabbitmq-discuss] Dropping out messages from a queue
</A></li>
	<LI>Next message: <A HREF="004020.html">[rabbitmq-discuss] Dropping out messages from a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4006">[ date ]</a>
              <a href="thread.html#4006">[ thread ]</a>
              <a href="subject.html#4006">[ subject ]</a>
              <a href="author.html#4006">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
