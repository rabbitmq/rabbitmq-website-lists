<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 1.6 persistence?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%201.6%20persistence%3F&In-Reply-To=269388e30907151548n7999dbafs1a942879e95e91ba%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004088.html">
   <LINK REL="Next"  HREF="004083.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 1.6 persistence?</H1>
    <B>Chris Wiegand</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%201.6%20persistence%3F&In-Reply-To=269388e30907151548n7999dbafs1a942879e95e91ba%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] RabbitMQ 1.6 persistence?">cwiegand at mobileaccord.com
       </A><BR>
    <I>Thu Jul 16 16:24:39 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004088.html">[rabbitmq-discuss] RabbitMQ 1.6 persistence?
</A></li>
        <LI>Next message: <A HREF="004083.html">[rabbitmq-discuss] Multicast in a transaction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4107">[ date ]</a>
              <a href="thread.html#4107">[ thread ]</a>
              <a href="subject.html#4107">[ subject ]</a>
              <a href="author.html#4107">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yeah, I get a stack trace that essentially says it tried to allocate more memory than allowed. I cut-and-pasted the console response below, if you want I can send over the erl_crash.dmp file (818 kb).

I actually was able to solve the problem using (thanks Wilson Ke!) - I was only declaring the messages persistent, but not the queue itself. Once I declared the queue (and exchange, to be safe) to be durable it started working as expected.

Here's the error I get on the console:

D:\rabbitmq_server-1.6.0&gt;sbin\rabbitmq-server.bat
RabbitMQ 1.6.0 (AMQP 8-0)
Copyright (C) 2007-2009 LShift Ltd., Cohesive Financial Technologies LLC., and Rabbit Technologies Ltd.
Licensed under the MPL.  See <A HREF="http://www.rabbitmq.com/">http://www.rabbitmq.com/</A>

node        : <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Tomato</A>
log         : C:/Documents and Settings/Administrator/Application Data/RabbitMQ/log/rabbit.log
sasl log    : C:/Documents and Settings/Administrator/Application Data/RabbitMQ/log/rabbit-sasl.log
database dir: c:/Documents and Settings/Administrator/Application Data/RabbitMQ/db/rabbit-mnesia

starting database             ...done
starting core processes       ...done
starting recovery             ...done
starting persister            ...done
starting guid generator       ...done
starting builtin applications ...done
starting TCP listeners        ...done

broker running

Crash dump was written to: erl_crash.dump
binary_alloc: Cannot allocate 251777643 bytes of memory (of type &quot;binary&quot;).

This application has requested the Runtime to terminate it in an unusual way.
Please contact the application's support team for more information.

-----Original Message-----
From: Ben Hood [mailto:<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">0x6e6562 at gmail.com</A>] 
Sent: Wednesday, July 15, 2009 4:48 PM
To: Chris Wiegand
Cc: <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Subject: Re: [rabbitmq-discuss] RabbitMQ 1.6 persistence?

Chris,

On Tue, Jul 14, 2009 at 11:59 PM, Chris
Wiegand&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cwiegand at mobileaccord.com</A>&gt; wrote:
&gt;<i> I'm finding that if the erlang session dies
</I>
What do you mean by Erlang session? Do you mean that the Erlang VM process dies?

&gt;<i> (like say if I kill it, or try to pump in 1 million
</I>&gt;<i> messages and it runs out of memory),
</I>
In 1.6.0 every message is resident in memory - solution to this is
being developed ATM.

&gt;<i> and then I re-start the RabbitMQ server
</I>&gt;<i> it takes a rather long time to load the persistence stuff, but then just
</I>&gt;<i> clears out the queues, and the file (rabbit_persister.LOG) just gets
</I>&gt;<i> truncated and the messages were not persisted.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Am I misunderstanding how RabbitMQ implements persistence? I expected that
</I>&gt;<i> if the broker stops, and then gets relaunched that it would reload the last
</I>&gt;<i> saved state for the queues, etc.., but that doesn't seem to be taking place.
</I>&gt;<i> We're running it under Windows, under the most recent version of erlang
</I>&gt;<i> (also just downloaded last week), in case that would affect anything. I'll
</I>&gt;<i> try this under Linux and OpenSolaris here soon, in case that makes a
</I>&gt;<i> difference.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I'm using the .Net bindings, and setting the BasicProperties' DeliveryMode
</I>&gt;<i> to 2 for persistence, is there anything else I have to do to make a queue
</I>&gt;<i> persist?
</I>
OFV and if you have queues bound to your exchanges, what you are
describing should probably not be happening. Can you give us a cut
down version of your code that reproduces this behaviour?

Ben


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004088.html">[rabbitmq-discuss] RabbitMQ 1.6 persistence?
</A></li>
	<LI>Next message: <A HREF="004083.html">[rabbitmq-discuss] Multicast in a transaction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4107">[ date ]</a>
              <a href="thread.html#4107">[ thread ]</a>
              <a href="subject.html#4107">[ subject ]</a>
              <a href="author.html#4107">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
