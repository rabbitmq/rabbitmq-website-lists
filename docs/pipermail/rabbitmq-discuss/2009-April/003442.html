<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consuming a Rollbacked Message
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Consuming%20a%20Rollbacked%20Message&In-Reply-To=455862.37226.qm%40web50609.mail.re2.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003441.html">
   <LINK REL="Next"  HREF="003443.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consuming a Rollbacked Message</H1>
    <B>Tony Garnock-Jones</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Consuming%20a%20Rollbacked%20Message&In-Reply-To=455862.37226.qm%40web50609.mail.re2.yahoo.com"
       TITLE="[rabbitmq-discuss] Consuming a Rollbacked Message">tonyg at lshift.net
       </A><BR>
    <I>Sun Apr 26 13:07:33 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="003441.html">[rabbitmq-discuss] Consuming a Rollbacked Message
</A></li>
        <LI>Next message: <A HREF="003443.html">[rabbitmq-discuss] Consuming a Rollbacked Message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3442">[ date ]</a>
              <a href="thread.html#3442">[ thread ]</a>
              <a href="subject.html#3442">[ subject ]</a>
              <a href="author.html#3442">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amin,

Amin Abbaspour wrote:
&gt;<i> What I can? Is there something wrong with my rollback or ACK
</I>&gt;<i> mechanism? should I do something more than a simple txRollback()?
</I>
TX-class transactions introduce grouping and limited atomicity for 
*publishes* and *acknowledgements*. This means that the scope of a 
transaction is only those basic.publish and basic.ack operations that 
the client has performed within the transaction. In particular, 
basic.delivers are not included in a transaction -- so it would be wrong 
for the server to resend them on a rollback!

A rollback, then, does not release any messages to other consumers, or 
cause them to be redelivered to this one; it is assumed by the server 
that since the client has seen the messages, and has clearly not crashed 
(since the connection is still open and healthy), there is no need to 
resend them. The server can trust the client in this case to continue 
thinking about which messages to acknowledge, and will wait for 
subsequent basic.acks followed by tx.commit.

If the client has forgotten what it has seen, it can use the 
basic.recover operation to get its pending deliveries resent. 
Alternatively, it can close and reopen the channel (though this has 
other consequences).

This is a confusing area of the spec: not only did we initially get our 
implementation wrong, other implementations did too, and in fact the 0-8 
spec does not fully specify the behaviour of rollbacks or basic.recover 
operations. Furthermore, there is a legitimate, if subtle, design 
question here: seen one way, the current behaviour -- transactional acks 
-- is correct; seen another, the alternative -- transactional deliveries 
-- is correct. (If you're interested, the former seems natural in a 
hub-and-spoke design for AMQP, but the latter starts to look oddly 
sensible in a fully peer-to-peer, internet-scale design...)

Regards,
   Tony


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003441.html">[rabbitmq-discuss] Consuming a Rollbacked Message
</A></li>
	<LI>Next message: <A HREF="003443.html">[rabbitmq-discuss] Consuming a Rollbacked Message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3442">[ date ]</a>
              <a href="thread.html#3442">[ thread ]</a>
              <a href="subject.html#3442">[ subject ]</a>
              <a href="author.html#3442">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
