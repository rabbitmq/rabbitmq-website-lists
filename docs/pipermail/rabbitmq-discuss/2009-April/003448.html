<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ broker's death by one cut: robustness	problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20broker%27s%20death%20by%20one%20cut%3A%20robustness%0A%09problem&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003447.html">
   <LINK REL="Next"  HREF="003474.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ broker's death by one cut: robustness	problem</H1>
    <B>Lev Walkin</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20broker%27s%20death%20by%20one%20cut%3A%20robustness%0A%09problem&In-Reply-To="
       TITLE="[rabbitmq-discuss] RabbitMQ broker's death by one cut: robustness	problem">vlm at lionet.info
       </A><BR>
    <I>Mon Apr 27 11:46:19 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="003447.html">[rabbitmq-discuss] Consuming a Rollbacked Message
</A></li>
        <LI>Next message: <A HREF="003474.html">[rabbitmq-discuss] RabbitMQ broker's death by one cut: robustness problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3448">[ date ]</a>
              <a href="thread.html#3448">[ thread ]</a>
              <a href="subject.html#3448">[ subject ]</a>
              <a href="author.html#3448">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
During evaluation period, our RabbitMQ node has crashed at some point, 
killed by OOM killer. Unfortunately, killing corrupted the log files, so 
RabbitMQ restart did not fix the problem. RabbitMQ just would not start:

================
[<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">broker at zamq</A> ~]&gt; /usr/local/bin/rabbitmq-server -kernel check_ip true 
-connect_all false
...
Logging to &quot;/.../rabbitmq/log/rabbit.log&quot;
SASL logging to &quot;/.../rabbitmq/log/rabbit-sasl.log&quot;

starting database             ...done
starting core processes       ...done
starting recovery             ...done
starting persister            ...{&quot;init terminating in 
do_boot&quot;,{{nocatch,{error,{cannot_start_application,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{{badmatch,{error,{{{badmatch,eof},[{rabbit_persister,internal_load_snapshot,2},{rabbit_persister,init,1},{gen_server,init_it,6},{proc_lib,init_p_do_apply,3}]},{child,undefined,rabbit_persister,{rabbit_persister,start_link,[]},transient,100,worker,[rabbit_persister]}}}},[{rabbit,start_child,1},{rabbit,'-start/2-fun-4-',0},{rabbit,'-start/2-fun-0-',1},{lists,foreach,2},{rabbit,start,2},{application_master,start_it_old,4}]}}}}}}},[{init,start_it,1},{init,start_em,1}]}}
init terminating in do_boot ()
[<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">broker at zamq</A> ~]&gt;
=================

It turns out, the broker beam was killed during a persister operation, 
so persister logs were broken:

[<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">broker at zamq</A> ...]&gt; ls -al | grep persister
-rw-r--r--  1 broker  wheel          8 Apr 24 18:48 rabbit_persister.LOG
-rw-r--r--  1 broker  wheel  661677171 Apr 24 18:19 
rabbit_persister.LOG.previous
[<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">broker at zamq</A> ~]&gt; hd rabbit_persister.LOG
00000000  01 02 03 04 63 58 4d 0b                           |....cXM.|
00000008
[<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">broker at zamq</A> ...]&gt;


I believe there is a way to make such error recovery more robust. Is 
there a solution you'd like to introduce for this kind of problem?

-- 
Lev Walkin
<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">vlm at lionet.info</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003447.html">[rabbitmq-discuss] Consuming a Rollbacked Message
</A></li>
	<LI>Next message: <A HREF="003474.html">[rabbitmq-discuss] RabbitMQ broker's death by one cut: robustness problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3448">[ date ]</a>
              <a href="thread.html#3448">[ thread ]</a>
              <a href="subject.html#3448">[ subject ]</a>
              <a href="author.html#3448">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
