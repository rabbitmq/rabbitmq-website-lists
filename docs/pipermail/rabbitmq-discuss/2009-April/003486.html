<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] millions of unack'd messages in a day	--	disk store instead of ram?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20millions%20of%20unack%27d%20messages%20in%20a%20day%0A%09--%09disk%20store%20instead%20of%20ram%3F&In-Reply-To=dbd9700a0904300811j687429fen7e3d7051f26caf95%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003485.html">
   <LINK REL="Next"  HREF="003495.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] millions of unack'd messages in a day	--	disk store instead of ram?</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20millions%20of%20unack%27d%20messages%20in%20a%20day%0A%09--%09disk%20store%20instead%20of%20ram%3F&In-Reply-To=dbd9700a0904300811j687429fen7e3d7051f26caf95%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] millions of unack'd messages in a day	--	disk store instead of ram?">matthew at lshift.net
       </A><BR>
    <I>Thu Apr 30 16:29:30 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="003485.html">[rabbitmq-discuss] millions of unack'd messages in a day --	disk store instead of ram?
</A></li>
        <LI>Next message: <A HREF="003495.html">[rabbitmq-discuss] millions of unack'd messages in a day --	disk store instead of ram?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3486">[ date ]</a>
              <a href="thread.html#3486">[ thread ]</a>
              <a href="subject.html#3486">[ subject ]</a>
              <a href="author.html#3486">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Apr 30, 2009 at 11:11:08AM -0400, Brian Whitman wrote:
&gt;<i> I was able to hammer rabbit with far more messages than I've ever been able
</I>&gt;<i> to store. Once it crossed into swap amazingly write speed only suffered
</I>&gt;<i> slightly (probably because the old messages were swapped out, not the new
</I>&gt;<i> ones), but get speed did suffer. The important part is that the server
</I>&gt;<i> stayed up, even after using 20GB of virtual RAM (millions of large messages)
</I>
Yes, this is broadly inline with my blog post at 
<A HREF="http://www.lshift.net/blog/2009/04/02/cranial-surgery-giving-rabbit-more-memory">http://www.lshift.net/blog/2009/04/02/cranial-surgery-giving-rabbit-more-memory</A>

But the behaviour you're seeing is not typical for a more general purpose
use case. When you're just hammering in messages, the OS can make
reasonably sensible decisions about which pages to evict and in general
all you're asking of the OS is &quot;get me a new empty page which I can fill&quot;.

In the get case however, life is much harder. It's really quite likely
that the next page you're going to want back in as also the next page the
OS is going to choose to evict, so in the case where you're doing
1-in-1-out you could well find performance suffers catastrophically. Even
if you're just doing plain gets, until the GC runs (which on its own could
cause a lot of swap thrashing) and frees up pages, you're now asking a
more complex question of the OS - namely &quot;choose a page to evict and in
its place get me this page which contains the messages I need to deliver&quot;.
This will typically thus be a write and a read.

Also, as I've recently commented on that blog post, we don't really have
enough details about how the Erlang VM is choosing to organise data and so
it may not be as efficient as we would like.

However, it is obviously a &quot;good thing&quot; that you have managed to get this
to work. Beware though that the broker you are using could have internal
messages timeout on it - this was fixed in bug 20546 which is in our
&quot;default&quot; development branch, not the stable &quot;v1_5&quot; branch. As such, you
may see messages coming out of the broker which indicate strange timeouts
occurred. Thus, if you're wishing to be able to use RabbitMQ in this way,
we would recommend you use the head of the &quot;default&quot; branch.

Also, you need the memory alarms turned off otherwise flow control will
kick in when you start to run out of memory.

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003485.html">[rabbitmq-discuss] millions of unack'd messages in a day --	disk store instead of ram?
</A></li>
	<LI>Next message: <A HREF="003495.html">[rabbitmq-discuss] millions of unack'd messages in a day --	disk store instead of ram?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3486">[ date ]</a>
              <a href="thread.html#3486">[ thread ]</a>
              <a href="subject.html#3486">[ subject ]</a>
              <a href="author.html#3486">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
