<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] JAVA client / non daemon threads / shutdown	hook
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20JAVA%20client%20/%20non%20daemon%20threads%20/%20shutdown%0A%09hook&In-Reply-To=%3CCAOYfuERMpLxZXn6BXq35pC4DADzM2Tqr_09hSoySxAB1AOKcPg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020283.html">
   <LINK REL="Next"  HREF="020306.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] JAVA client / non daemon threads / shutdown	hook</H1>
    <B>Bart&#322;omiej Prokop</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20JAVA%20client%20/%20non%20daemon%20threads%20/%20shutdown%0A%09hook&In-Reply-To=%3CCAOYfuERMpLxZXn6BXq35pC4DADzM2Tqr_09hSoySxAB1AOKcPg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] JAVA client / non daemon threads / shutdown	hook">prokop.bart at gmail.com
       </A><BR>
    <I>Thu May 24 10:41:55 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020283.html">[rabbitmq-discuss] JAVA client / non daemon threads / shutdown	hook
</A></li>
        <LI>Next message: <A HREF="020306.html">[rabbitmq-discuss] JAVA client / non daemon threads / shutdown	hook
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20300">[ date ]</a>
              <a href="thread.html#20300">[ thread ]</a>
              <a href="subject.html#20300">[ subject ]</a>
              <a href="author.html#20300">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Steve,

Many thanks for your prompt response. I have two proposals about improving
it, while keeping all parties happy. Here they are:

1. Add a boolean property &quot;daemonBackgroundThreads&quot; in ConnectionFactory.
Based on that property the threads created by client library would be
either daemon or not. The default would be false, what wouldn't occur any
changes in behavior of existing applications.

2. Alternatively the library could be rafactored that way
that connection/publishing stuff be daemon threads, while listener stuff
are non daemon. But as I explain further it is not best solution.

I see this problem in a bit other way, from perspective of developer, who
not always can design clean solutions. Sometimes I have to wire and patch
legacy systems ;). I think it is very common task to rabbitMQ users, who
have to wire it into existing ecosystem. My case here is to allow
some proprietary web server to send some messages during request
processing. So basically I'm restricted to expose a single Java method to
be called from the web script. I can create my own threads, connections,
bookkeeping, connection failover, reconnect etc... but this all is hidden
from the interface (single method &quot;post&quot;) exposed to web scripting. The
most ugly thing is that I have no other way of detecting that WebServer is
going to die than adding shutdown hook to VM. And shutdown hook is fired,
when all normal threads are about to die (along with daemon threads). This
scenario is probably quite common for live integration of RabbitMQ into
existing systems.

In general when dealing with messages we can have 3 basic scenarios:
1. Publisher.
2. Synchronous consumer.
3. Asynchronous consumer (listener on messages).

The idea of writing RabbitMQ clients (implied by costly and limited TCP/IP
sockets) is to share a connection &quot;per application&quot; and write code that
can reconnect in case of RabbitMQ node fail. So as soon as I get
the connection, I keep it globally (shared). Usually it is my
responsibility to clean on shutdown, but there are cases when I'm unable to
do this. The shutdown hooks are handy in those scenarios.

Only the 3rd scenario (asynchronous consumer) may require non daemon
threads. But it is from my experience not a live scenario. You usually do
not write application, relaying on created behind the scene &quot;main loop&quot;.
Why? Because even if all what you do is to listen to messages, you still
have to control the application state. You must start and stop that
application as well as allow user/OS to close it. I personally for such
micro-applications use Apache Daemons and run them as Windows services. On
Linux you have jsvc to control such application. Surely &quot;main loop&quot; hidden
in implementation is bad idea.

On Wed, May 23, 2012 at 5:18 PM, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">steve at rabbitmq.com</A>&gt; wrote:

&gt;<i> Bart&#322;omiej,
</I>&gt;<i>
</I>&gt;<i> What a very good point. It is clear that the MainLoop thread ought to be
</I>&gt;<i> a daemon thread in your circumstances, thank you for pointing this out.
</I>&gt;<i> The only affect of this will be to allow the JVM to terminate if only
</I>&gt;<i> daemon threads are available.
</I>&gt;<i>
</I>&gt;<i> However, we have considered this problem before (internal bug 21110) and
</I>&gt;<i> user apps that create a connection and register some consumers (which do
</I>&gt;<i> all the work) ought to be able to terminate without accidentally killing
</I>&gt;<i> the connection processing.
</I>&gt;<i>
</I>&gt;<i> This means that there are circumstances in which the threads we create
</I>&gt;<i> are required to be non-daemon, and circumstances where you would like
</I>&gt;<i> them to be daemon.
</I>&gt;<i>
</I>&gt;<i> The hook you implemented ought to work correctly even when the MainLoop
</I>&gt;<i> is not a daemon, because closing the connection ought to make the
</I>&gt;<i> MainLoop thread terminate normally. If it doesn't, there is a bug. Where
</I>&gt;<i> at all possible you should attempt to close an open connection as a part
</I>&gt;<i> of your termination processing as there are system resources that could
</I>&gt;<i> be left high-and-dry if you do not.
</I>&gt;<i>
</I>&gt;<i> There are other threads in the Java Client -- the executor worker
</I>&gt;<i> threads used for Consumer callbacks. These are non-daemon, too. The hook
</I>&gt;<i> should still work because shutting down the connection ought to shutdown
</I>&gt;<i> the consumer work service, and in turn the executor (and its worker
</I>&gt;<i> threads).
</I>&gt;<i>
</I>&gt;<i> However, I could make them daemon threads as well, in case the main app
</I>&gt;<i> terminates abruptly and expects to be able to terminate uncleanly as you
</I>&gt;<i> describe.
</I>&gt;<i>
</I>&gt;<i> Thank you for reporting this. I'll report back here on progress.
</I>&gt;<i>
</I>&gt;<i> Steve Powell  (a happy bunny)
</I>&gt;<i> ----------yet more definitions from the SPD----------
</I>&gt;<i> corrugate (n.) T.V. soap scandal.
</I>&gt;<i> olympic (n.) A camp road-digger.
</I>&gt;<i> jamboree (n.) A conserve made from French cheese.
</I>&gt;<i>
</I>&gt;<i> On 18 May 2012, at 16:27, Bart&#322;omiej Prokop wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm using JAVA client for RabbitMQ (com.rabbitmq:amqp-client:2.8.1) to
</I>&gt;<i> write a &quot;jar component&quot; capable of sending messages for some legacy system.
</I>&gt;<i> The idea is to wrap all code that maintain the connection inside my
</I>&gt;<i> component. This way, the client software deals only with very simple
</I>&gt;<i> methods like &quot;post&quot; and is not aware of any connection handling. The
</I>&gt;<i> connect/reconnect code is written and hidden from the legacy system.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The problem I have faced is that Java client creates &quot;behind the scene&quot;
</I>&gt;<i> some threads to manage connection - like:
</I>&gt;<i> &gt;          lines 299-301 of AMQConnection class.
</I>&gt;<i> &gt;         // start the main loop going
</I>&gt;<i> &gt;         new MainLoop(&quot;AMQP Connection &quot; + getHostAddress() + &quot;:&quot; +
</I>&gt;<i> getPort()).start();
</I>&gt;<i> &gt;         // after this point clear-up of MainLoop is triggered by closing
</I>&gt;<i> the frameHandler.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Unfortunatelly, those threads aren't &quot;daemon&quot; threads. So, when main
</I>&gt;<i> application ends and appropriate connection closing not occurs, the VM
</I>&gt;<i> won't terminate. My approach was to add some shutdown hook to close
</I>&gt;<i> RabbitMQ connections if it is live inside my &quot;jar component&quot;. But, due to
</I>&gt;<i> those non-daemon threads, VM is not going ever to be terminated and
</I>&gt;<i> shutdown hooks fired.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It is a question to RabbitMQ driver developers, if the internal threads
</I>&gt;<i> could be fired as daemon threads, could it be done in future releases?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Bart Prokop
tel. +48 509 258 502

This e-mail is intended solely for the addressee(s) and contains
confidential information. Unauthorized distribution, modification or
disclosure of its contents is unlawful. If you have received this e-mail in
error, please notify the sender immediately by return e-mail. Please then
delete the e-mail from your system and do not copy it or disclose its
contents to any person. Email transmission cannot be guaranteed to be
secure or error free as information could be intercepted, corrupted, lost,
destroyed, arrive late or incomplete, or contain viruses. The sender
therefore does not accept liability for any errors or omissions in the
contents of this message which arise as a result of email transmission.
Information, opinions or conclusions contained in this message that do not
relate to the official business of the senders employer or principal will
be understood as neither given nor endorsed by it.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120524/ae8c30e5/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120524/ae8c30e5/attachment.htm</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020283.html">[rabbitmq-discuss] JAVA client / non daemon threads / shutdown	hook
</A></li>
	<LI>Next message: <A HREF="020306.html">[rabbitmq-discuss] JAVA client / non daemon threads / shutdown	hook
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20300">[ date ]</a>
              <a href="thread.html#20300">[ thread ]</a>
              <a href="subject.html#20300">[ subject ]</a>
              <a href="author.html#20300">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
