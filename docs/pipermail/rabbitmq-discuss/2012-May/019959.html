<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Hang on &quot;starting database ....&quot; remains in 2.8.2 cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Hang%20on%20%22starting%20database%20....%22%20remains%20in%0A%202.8.2%20cluster&In-Reply-To=%3C4FAA70AA.6060407%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019952.html">
   <LINK REL="Next"  HREF="019960.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Hang on &quot;starting database ....&quot; remains in 2.8.2 cluster</H1>
    <B>Francesco Mazzoli</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Hang%20on%20%22starting%20database%20....%22%20remains%20in%0A%202.8.2%20cluster&In-Reply-To=%3C4FAA70AA.6060407%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Hang on &quot;starting database ....&quot; remains in 2.8.2 cluster">francesco at rabbitmq.com
       </A><BR>
    <I>Wed May  9 14:27:06 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019952.html">[rabbitmq-discuss] Hang on &quot;starting database ....&quot; remains in 2.8.2 cluster
</A></li>
        <LI>Next message: <A HREF="019960.html">[rabbitmq-discuss] Hang on &quot;starting database ....&quot; remains in 2.8.2 cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19959">[ date ]</a>
              <a href="thread.html#19959">[ thread ]</a>
              <a href="subject.html#19959">[ subject ]</a>
              <a href="author.html#19959">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matt,

I've tried to reproduce your setup locally and I never get hanging 
nodes. I've attached the bash script and the config I'm using, can you 
confirm that that corresponds to what you're doing?

You can use the script like this:
     ./test 10
Where &quot;10&quot; is the number of times the node will be restarted.

Francesco.

On 09/05/12 00:38, Matt Pietrek wrote:
&gt;<i> Hi Francesco,
</I>&gt;<i>
</I>&gt;<i> I run rabbitmq on 3 separate Ubuntu 10.04 64 bit VMs. Clustering is
</I>&gt;<i> enabled via the rabbitmq config file that lists all three hosts (all
</I>&gt;<i> them A, B, and C)
</I>&gt;<i>
</I>&gt;<i> I start up all the VMs concurrently (via Capistrano) and verify that
</I>&gt;<i> the cluster is running as expected. I then go through this sequence:
</I>&gt;<i>
</I>&gt;<i> --------
</I>&gt;<i> # On host A:
</I>&gt;<i> rabbitmqctl -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at A</A> stop
</I>&gt;<i> nohup $RABBITMQ_SCRIPT_DIR/rabbitmq-server&amp;
</I>&gt;<i> rabbitmqctl wait $PIDFILE
</I>&gt;<i>
</I>&gt;<i> # On host B:
</I>&gt;<i> rabbitmqctl -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at B</A> stop
</I>&gt;<i> nohup $RABBITMQ_SCRIPT_DIR/rabbitmq-server&amp;
</I>&gt;<i> rabbitmqctl wait $PIDFILE
</I>&gt;<i>
</I>&gt;<i> # On host C:
</I>&gt;<i> rabbitmqctl -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at C</A> stop
</I>&gt;<i> nohup $RABBITMQ_SCRIPT_DIR/rabbitmq-server&amp;
</I>&gt;<i> rabbitmqctl wait $PIDFILE
</I>&gt;<i> --------
</I>&gt;<i>
</I>&gt;<i> The idea being to bring down one server while still retaining two in
</I>&gt;<i> the cluster.
</I>&gt;<i>
</I>&gt;<i> During one of the start operations (it's not consistent from run to
</I>&gt;<i> run), rabbitmq-server will not finish starting up. The last line in
</I>&gt;<i> that node's nohup.dat file is:
</I>&gt;<i>
</I>&gt;<i> &quot;starting database   .....&quot;
</I>&gt;<i>
</I>&gt;<i> FWIW, it might be helpful to put the shutdown/startup commands in a
</I>&gt;<i> script that you can loop over repeatedly so as to try the whole
</I>&gt;<i> sequence numerous times. We use Capistrano here to execute actions on
</I>&gt;<i> remote machines, but you can probably use SSH to get the same effect
</I>&gt;<i> from a script file.
</I>&gt;<i>
</I>&gt;<i> Let me know if you have other questions about our setup,
</I>&gt;<i>
</I>&gt;<i> Matt
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, May 8, 2012 at 3:52 AM, Francesco Mazzoli
</I>&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">francesco at rabbitmq.com</A>&gt;  wrote:
</I>&gt;&gt;<i> Hi Matt,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Predictably I can't reproduce this. Since you say that it'll happen
</I>&gt;&gt;<i> &quot;inevitably&quot; (while if I understand correctly in your previous messages it
</I>&gt;&gt;<i> was tricky to reproduce), can you send us more information about your setup
</I>&gt;&gt;<i> and the steps on how to trigger the problem?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Francesco.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 04/05/12 23:55, Matt Pietrek wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've written this alias before about this topic, and the problem
</I>&gt;&gt;&gt;<i> remains in 2.8.2. See:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-February/018414.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-February/018414.html</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have a three node cluster running RabbitMQ 2.82/Erlang R13B03 on Ubuntu
</I>&gt;&gt;&gt;<i> 10.04.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Once the cluster is up and running properly (as observed by the Web
</I>&gt;&gt;&gt;<i> UI), I then start/stop individual nodes in the cluster:
</I>&gt;&gt;&gt;<i>      rabbitmqctl stop
</I>&gt;&gt;&gt;<i>      rabbitmq-server
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Inevitably one of the nodes won't come back up, waiting forever on
</I>&gt;&gt;&gt;<i> &quot;starting&quot; the database (no 30 second timeout... Forever.)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The only way to get all three nodes functioning again together is to
</I>&gt;&gt;&gt;<i> forcibly stop the other two nodes, then restart them all again.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The first item below is the console output as captured via nohup,
</I>&gt;&gt;&gt;<i> showing &quot;starting database&quot; as the last item.
</I>&gt;&gt;&gt;<i> The second item below is the last few lines of the rabbit@&lt;node&gt;.log
</I>&gt;&gt;&gt;<i> file, showing the node shutting down, then beginning to start up
</I>&gt;&gt;&gt;<i> again.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is it likely that a newer Erlang version would help out?
</I>&gt;&gt;&gt;<i> What else can I provide to help diagnose this?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Matt
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> --------
</I>&gt;&gt;&gt;<i> node           : <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>
</I>&gt;&gt;&gt;<i> app descriptor :
</I>&gt;&gt;&gt;<i> /usr/lib/rabbitmq/lib/rabbitmq_server-2.8.2/sbin/../ebin/rabbit.app
</I>&gt;&gt;&gt;<i> home dir       : /home/mpietrek
</I>&gt;&gt;&gt;<i> config file(s) : /home/mpietrek/work/var/run/rabbitmq.config
</I>&gt;&gt;&gt;<i> cookie hash    : pR5H9kY3Wra/XdLELT5hgQ==
</I>&gt;&gt;&gt;<i> log            :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> /home/mpietrek/work/logs/util.mpietrek.internal.illumita.com/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util.log</A>
</I>&gt;&gt;&gt;<i> sasl log       :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> /home/mpietrek/work/logs/util.mpietrek.internal.illumita.com/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util-sasl.log</A>
</I>&gt;&gt;&gt;<i> database dir   : /home/mpietrek/work/var/lib/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>
</I>&gt;&gt;&gt;<i> erlang version : 5.7.4
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -- rabbit boot start
</I>&gt;&gt;&gt;<i> starting file handle cache server
</I>&gt;&gt;&gt;<i> ...done
</I>&gt;&gt;&gt;<i> starting worker pool
</I>&gt;&gt;&gt;<i>   ...done
</I>&gt;&gt;&gt;<i> starting database                                                     ...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> --------
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> =INFO REPORT==== 4-May-2012::15:02:14 ===
</I>&gt;&gt;&gt;<i>      application: rabbitmq_management_agent
</I>&gt;&gt;&gt;<i>      exited: stopped
</I>&gt;&gt;&gt;<i>      type: permanent
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> =INFO REPORT==== 4-May-2012::15:02:14 ===
</I>&gt;&gt;&gt;<i> stopped TCP Listener on 0.0.0.0:5672
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> =INFO REPORT==== 4-May-2012::15:02:14 ===
</I>&gt;&gt;&gt;<i>      application: rabbit
</I>&gt;&gt;&gt;<i>      exited: stopped
</I>&gt;&gt;&gt;<i>      type: permanent
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> =INFO REPORT==== 4-May-2012::15:02:14 ===
</I>&gt;&gt;&gt;<i>      application: os_mon
</I>&gt;&gt;&gt;<i>      exited: stopped
</I>&gt;&gt;&gt;<i>      type: permanent
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> =INFO REPORT==== 4-May-2012::15:02:14 ===
</I>&gt;&gt;&gt;<i>      application: mnesia
</I>&gt;&gt;&gt;<i>      exited: stopped
</I>&gt;&gt;&gt;<i>      type: permanent
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> =INFO REPORT==== 4-May-2012::15:02:14 ===
</I>&gt;&gt;&gt;<i> Halting Erlang VM
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> =INFO REPORT==== 4-May-2012::15:02:52 ===
</I>&gt;&gt;&gt;<i> Limiting to approx 924 file handles (829 sockets)
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>
-------------- next part --------------
[
 {rabbit, [{cluster_nodes, [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mcnulty</A>, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">hare at mcnulty</A>, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">franc at mcnulty</A>]}]}
].
-------------- next part --------------
#!/bin/bash

rabbitmq_server=~/src/rabbitmq-umbrella/rabbitmq-server/scripts/rabbitmq-server
rabbitmqctl=~/src/rabbitmq-umbrella/rabbitmq-server/scripts/rabbitmqctl

function start {
    RABBITMQ_NODE_PORT=$2 \
    RABBITMQ_SERVER_START_ARGS=&quot;-rabbitmq_mochiweb listeners [{mgmt,[{port,5&quot;$2&quot;}]}]&quot; \
    RABBITMQ_NODENAME=$1 \
    RABBITMQ_MNESIA_DIR=/tmp/rabbitmq-$1-mnesia \
    RABBITMQ_PLUGINS_EXPAND_DIR=/tmp/rabbitmq-$1-plugins-scratch \
    RABBITMQ_LOG_BASE=/tmp \
    RABBITMQ_CONFIG_FILE=`pwd`/rabbitmq \
    $rabbitmq_server &lt;/dev/null &amp;&gt;/dev/null &amp;

    $rabbitmqctl -n $1 wait /tmp/rabbitmq-$1-mnesia.pid
}

function stop {
    $rabbitmqctl -n $1 stop /tmp/rabbitmq-$1-mnesia.pid
}

function restart {
    stop $1
    start $1 $2
}

# To use the functions on their own
if [ $1 = &quot;start&quot; ]; then
    start $2 $3
elif [ $1 = &quot;stop&quot; ]; then
    stop $2
elif [ $1 = &quot;restart&quot; ]; then
    restart $2 $3
elif [ $1 = &quot;clean&quot; ]; then
    rm -rf /tmp/rabbit*
    rm -rf /tmp/hare*
    rm -rf /tmp/franc*
elif ! [[ $1 =~ ^[0-9]+$ ]] ; then
    name=`basename $0`
    echo &quot;Usage:&quot;
    echo &quot;./$name start nodename port&quot;
    echo &quot;./$name stop nodename&quot;
    echo &quot;./$name restart nodename port&quot;
    echo &quot;./$name n -- n is the number of times the nodes will be restarted&quot;
else
    echo &quot;----------------------------------------------------------&quot;
    echo &quot;---- Starting nodes --------------------------------------&quot;
    echo &quot;----------------------------------------------------------&quot;

    start rabbit 5672
    start hare 5673
    start franc 5674

    for (( i = 1; i &lt;= $1; i++ )); do
        echo &quot;----------------------------------------------------------&quot;
        echo &quot;---- Restarting nodes ------------------------------------&quot;
        echo &quot;----------------------------------------------------------&quot;
        
        restart rabbit 5672
        restart hare 5673
        restart franc 5674
    done
    
    echo &quot;----------------------------------------------------------&quot;
    echo &quot;---- Stopping nodes -------------------------------------&quot;
    echo &quot;----------------------------------------------------------&quot;
    
    stop rabbit 
    stop hare 
    stop franc 
fi

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019952.html">[rabbitmq-discuss] Hang on &quot;starting database ....&quot; remains in 2.8.2 cluster
</A></li>
	<LI>Next message: <A HREF="019960.html">[rabbitmq-discuss] Hang on &quot;starting database ....&quot; remains in 2.8.2 cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19959">[ date ]</a>
              <a href="thread.html#19959">[ thread ]</a>
              <a href="subject.html#19959">[ subject ]</a>
              <a href="author.html#19959">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
