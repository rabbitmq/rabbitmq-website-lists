<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] STOMP adapter lose the last message of a	burst
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20STOMP%20adapter%20lose%20the%20last%20message%20of%20a%0A%09burst&In-Reply-To=%3C4FBA95B2.1000707%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020195.html">
   <LINK REL="Next"  HREF="020226.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] STOMP adapter lose the last message of a	burst</H1>
    <B>Jos&#233; Mic&#243;</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20STOMP%20adapter%20lose%20the%20last%20message%20of%20a%0A%09burst&In-Reply-To=%3C4FBA95B2.1000707%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] STOMP adapter lose the last message of a	burst">jose.mico at gmail.com
       </A><BR>
    <I>Mon May 21 20:21:22 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020195.html">[rabbitmq-discuss] STOMP adapter lose the last message of a	burst
</A></li>
        <LI>Next message: <A HREF="020226.html">[rabbitmq-discuss] STOMP adapter lose the last message of a	burst
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20217">[ date ]</a>
              <a href="thread.html#20217">[ thread ]</a>
              <a href="subject.html#20217">[ subject ]</a>
              <a href="author.html#20217">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/21/2012 08:04 AM, Steve Powell wrote:
&gt;<i> I can reproduce your bug locally with 100 messages, but with 50 messages
</I>&gt;<i> it doesn't seem to happen.
</I>Thanks for reproducing the bug :-)

This does not happens with bursts of few messages. I can reproduce it 
with burst over 100, and almost always fail with bursts of 10000. As I 
stated in a previous mail, this is related to the CPU load of the 
broker: to trigger the bug, the broker must be busy. Is more probably to 
trigger it with 1000 mesages of 1 KB than with 10 messages of 100KB.
&gt;<i> Your testcase isn't clear about which of the
</I>&gt;<i> messages it is losing. I suspect it is one of the first set of 100.
</I>The test case does not show which message is missing. But in other tests 
that I have in my test suite I found that the lost message is always the 
last one, and only the last one.
&gt;<i> So I installed Wireshark (are you familiar with this tool?) and looked
</I>&gt;<i> at the message traffic. As far as I can see the last buffer is NOT sent
</I>&gt;<i> to the broker from the perl app.
</I>I will look at Wireshark, but I am almost sure that the perl app sent 
the data to the kernel. I don't know what the kernel does then.
&gt;<i> Autoflush() appears to make no
</I>&gt;<i> difference, and autoflush(1) in the loop (after the 100 messages) also
</I>&gt;<i> doesn't cure the problem.
</I>&gt;<i>
</I>&gt;<i> I modified your test a little to put in a rolling -123456789, rather
</I>&gt;<i> than all X's, to check what is in the end of the buffer, and I note that
</I>&gt;<i> the last data buffer sent was short.
</I>I've attached a python version of the test script, which shows the same 
symptoms than the perl one.
This time, the body of message contains the message number and and END 
mark to help sniffing.
&gt;<i> If I include a DISCONNECT at the end, this doesn't improve. (Note that
</I>&gt;<i> after the test has run one message is missing.)
</I>&gt;<i>
</I>&gt;<i> There appears to be some glitch in which a buffer/packet is not sent.
</I>&gt;<i>
</I>&gt;<i> I'm accumulating a Wireshark trace of this; but it appears to me that
</I>&gt;<i> this is a Perl client problem.
</I>Python does the same. And if it is a perl problem, why my app works fine 
on Apollo?
&gt;<i> My next questions are as follows: When you tested with Apollo, are you
</I>&gt;<i> using exactly the same perl? and libraries? and testcase?
</I>I've used exactly the same enviroment, code and everything (the beauty 
of interoperability :), only with an instance of Apollo running instead 
of RabbitMQ.
I've just doubled checked it.
&gt;<i> Have you tried
</I>&gt;<i> this test with a different client library (say, Python instead of Perl)?
</I>I've attached a Python version of the test case. Same happens: It send 
1000 messages, sometimes only 999 are queued.
&gt;<i> At the moment I cannot see or detect any STOMP adapter problems which
</I>&gt;<i> might account for this problem.
</I>I don't know if this affects AMQP also. Just happens that I am using the 
STOMP adapter.


Thanks for your time,
Jos&#233;

&gt;<i> Steve Powell  (a happy bunny)
</I>&gt;<i> ----------some more definitions from the SPD----------
</I>&gt;<i> chinchilla (n.) Cooling device for the lower jaw.
</I>&gt;<i> socialcast (n.) Someone to whom everyone is speaking but nobody likes.
</I>&gt;<i> literacy (n.) A textually transmitted disease usually contracted in childhood.
</I>&gt;<i>
</I>&gt;<i> On 19 May 2012, at 22:37, Jos&#233; Mic&#243; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I've just confirmed this bug running my app against another broker (Apollo), on which the app worked perfectly.
</I>&gt;&gt;<i> Do you have any plan to fix this bug? I can test development versions of the plugin, if you want.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regards,
</I>&gt;&gt;<i> Jos&#233;
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: stomp_bug.py
Type: text/x-python
Size: 1299 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120521/2c8e9a64/attachment.py">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120521/2c8e9a64/attachment.py</A>&gt;
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020195.html">[rabbitmq-discuss] STOMP adapter lose the last message of a	burst
</A></li>
	<LI>Next message: <A HREF="020226.html">[rabbitmq-discuss] STOMP adapter lose the last message of a	burst
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20217">[ date ]</a>
              <a href="thread.html#20217">[ thread ]</a>
              <a href="subject.html#20217">[ subject ]</a>
              <a href="author.html#20217">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
