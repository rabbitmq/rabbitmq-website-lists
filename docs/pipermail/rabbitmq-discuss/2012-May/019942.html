<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Missing Durable Queues on Startup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Missing%20Durable%20Queues%20on%20Startup&In-Reply-To=%3CAA028E5E-95B7-41F2-A8C3-E34340E4A3B8%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019916.html">
   <LINK REL="Next"  HREF="019944.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Missing Durable Queues on Startup</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Missing%20Durable%20Queues%20on%20Startup&In-Reply-To=%3CAA028E5E-95B7-41F2-A8C3-E34340E4A3B8%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Missing Durable Queues on Startup">steve at rabbitmq.com
       </A><BR>
    <I>Tue May  8 15:33:01 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019916.html">[rabbitmq-discuss] Missing Durable Queues on Startup
</A></li>
        <LI>Next message: <A HREF="019944.html">[rabbitmq-discuss] Missing Durable Queues on Startup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19942">[ date ]</a>
              <a href="thread.html#19942">[ thread ]</a>
              <a href="subject.html#19942">[ subject ]</a>
              <a href="author.html#19942">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Chris,

I'm no expert on setups like these, but, based upon other
questions and answers in this m/l, I would want to know:

a) are all the nodes in your cluster disk nodes?
b) was the node that you stop/started a disk node or a ram node?
c) when the cluster was restarted did you start all the disk nodes
   first?

When you say:

&gt;<i> We&#8217;re not using HA in rabbit itself, the queues are just
</I>&gt;<i> persistent and durable on each node in the cluster.
</I>
can you be more precise? I assumed that the node you restarted was the
one that held the queues you were missing.

You appear to be running version 2.5.1. Clustering has had some fixes
applied to it since then.

I would recommend upgrading to the latest release.

Steve Powell  (a happy bunny)
----------some more definitions from the SPD----------
chinchilla (n.) Cooling device for the lower jaw.
socialcast (n.) Someone to whom everyone is speaking but nobody likes.
literacy (n.) A textually transmitted disease usually contracted in childhood.

On 8 May 2012, at 01:45, Chris Larsen wrote:

&gt;<i> Hello, we ran into an odd situation today where RabbitMQ seemed to start properly but it didn't load most of the durable queues from the mnesia. Running stop_app, then start_app brought back some of the queues but not all. After we found out that not all queues were restored (after a few hours), running stop_app, then start_app again brought the rest of the queues online. Has anyone run into a similar situation?
</I>&gt;<i>  
</I>&gt;<i> Here are some notes about our setup with a few log entries from the logs below. We have 6 machines in the cluster split into pairs running drbd and pacemaker for failover. A glitchy switch caused one of these pairs to split-brain and both MQ resources wound up on the same physical host. Drbd seemed to be fine and after we resolved the split-brain, that's when we noticed the missing queues. There weren't any errors in the startup_log or startup_err files. We&#8217;re not using HA in rabbit itself, the queues are just persistent and durable on each node in the cluster.
</I>&gt;<i>  
</I>&gt;<i> We had a number of messages in the SASL logs with &#8220;nodedown&#8221; so I wonder if the MQ instances simply didn&#8217;t join the cluster properly the first couple of times but finally did on the last try? I didn&#8217;t check the status of the nodes in the cluster on each node (as suggested elsewhere) in between restarts but I&#8217;ll give that a try if it happens again. Thanks for your help!
</I>&gt;<i>  
</I>&gt;<i> RabbitMQ 2.5.1
</I>&gt;<i> Erlang R13B03
</I>&gt;<i> Ubuntu Server 64bit 2.6.38-10
</I>&gt;<i> drbd 8.3.7
</I>&gt;<i>  
</I>&gt;<i> =ERROR REPORT==== 7-May-2012::10:11:30 ===
</I>&gt;<i> Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit2 at host2</A>'): ** ERROR ** Mnesia on '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit2 at host2</A>' could not connect to node(s) ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit1 at host1</A>']
</I>&gt;<i>  
</I>&gt;<i> =INFO REPORT==== 7-May-2012::10:11:30 ===
</I>&gt;<i> Limiting to approx 32668 file handles (29399 sockets)
</I>&gt;<i>  
</I>&gt;<i> =INFO REPORT==== 7-May-2012::10:12:46 ===
</I>&gt;<i> msg_store_transient: using rabbit_msg_store_ets_index to provide index
</I>&gt;<i>  
</I>&gt;<i> =INFO REPORT==== 7-May-2012::10:12:46 ===
</I>&gt;<i> msg_store_persistent: using rabbit_msg_store_ets_index to provide index
</I>&gt;<i>  
</I>&gt;<i> =WARNING REPORT==== 7-May-2012::10:12:46 ===
</I>&gt;<i> msg_store_persistent: rebuilding indices from scratch
</I>&gt;<i>  
</I>&gt;<i> =INFO REPORT==== 7-May-2012::10:12:46 ===
</I>&gt;<i> started TCP Listener on 192.168.1.1:5672
</I>&gt;<i>  
</I>&gt;<i> =ERROR REPORT==== 7-May-2012::10:13:42 ===
</I>&gt;<i> Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit2 at host2</A>'): ** ERROR ** mnesia_event got {inconsistent_database, starting_partitioned_network, '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit1 at host3</A>'}
</I>&gt;<i>  
</I>&gt;<i> =ERROR REPORT==== 7-May-2012::10:13:42 ===
</I>&gt;<i> Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit2 at host2</A>'): ** ERROR ** mnesia_event got {inconsistent_database, starting_partitioned_network, '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit2 at host4</A>'}
</I>&gt;<i>  
</I>&gt;<i> =SUPERVISOR REPORT==== 7-May-2012::10:13:32 ===
</I>&gt;<i>      Supervisor: {&lt;0.11398.2442&gt;,rabbit_channel_sup}
</I>&gt;<i>      Context:    shutdown
</I>&gt;<i>      Reason:     reached_max_restart_intensity
</I>&gt;<i>      Offender:   [{pid,&lt;0.11400.2442&gt;},
</I>&gt;<i>                   {name,channel},
</I>&gt;<i>                   {mfa,
</I>&gt;<i>                       {rabbit_channel,start_link,
</I>&gt;<i>                           [1,&lt;0.11368.2442&gt;,&lt;0.11399.2442&gt;,&lt;0.11368.2442&gt;,
</I>&gt;<i>                            rabbit_framing_amqp_0_9_1,
</I>&gt;<i>                            {user,&lt;&lt;&quot;my_app&quot;&gt;&gt;,true,
</I>&gt;<i>                                rabbit_auth_backend_internal,
</I>&gt;<i>                                {internal_user,&lt;&lt;&quot;my_app&quot;&gt;&gt;,
</I>&gt;<i>                                    &lt;&lt;199,64,175,52,127,65,248,9,70,171,15,9,5,
</I>&gt;<i>                                      122,73,4,195,147,238,67&gt;&gt;,
</I>&gt;<i>                                    true}},
</I>&gt;<i>                            &lt;&lt;&quot;/my_app&quot;&gt;&gt;,[],&lt;0.11366.2442&gt;,
</I>&gt;<i>                            #Fun&lt;rabbit_channel_sup.0.15412730&gt;]}},
</I>&gt;<i>                   {restart_type,intrinsic},
</I>&gt;<i>                   {shutdown,4294967295},
</I>&gt;<i>                   {child_type,worker}]
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> =CRASH REPORT==== 7-May-2012::10:13:33 ===
</I>&gt;<i>   crasher:
</I>&gt;<i>     initial call: gen:init_it/6
</I>&gt;<i>     pid: &lt;0.25562.2442&gt;
</I>&gt;<i>     registered_name: []
</I>&gt;<i>     exception exit: {{badmatch,
</I>&gt;<i>                          {error,
</I>&gt;<i>                              [{&lt;7748.8396.531&gt;,
</I>&gt;<i>                                {exit,
</I>&gt;<i>                                    {nodedown,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit1 at host1</A>'},
</I>&gt;<i>                                    []}}]}},
</I>&gt;<i>                      [{rabbit_channel,terminate,2},
</I>&gt;<i>                       {gen_server2,terminate,3},
</I>&gt;<i>                       {proc_lib,wake_up,3}]}
</I>&gt;<i>       in function  gen_server2:terminate/3
</I>&gt;<i>     ancestors: [&lt;0.25560.2442&gt;,&lt;0.25544.2442&gt;,&lt;0.25542.2442&gt;,
</I>&gt;<i>                   rabbit_tcp_client_sup,rabbit_sup,&lt;0.124.0&gt;]
</I>&gt;<i>     messages: []
</I>&gt;<i>     links: [&lt;0.25560.2442&gt;]
</I>&gt;<i>     dictionary: [{{exchange_stats,
</I>&gt;<i>                        {resource,&lt;&lt;&quot;/my_app&quot;&gt;&gt;,exchange,
</I>&gt;<i>                            &lt;&lt;&quot;service.exchange&quot;&gt;&gt;}},
</I>&gt;<i>                    [{confirm,6},{publish,6}]},
</I>&gt;<i>                   {{queue_exchange_stats,
</I>&gt;<i>                        {&lt;0.253.0&gt;,
</I>&gt;<i>                         {resource,&lt;&lt;&quot;/my_app&quot;&gt;&gt;,exchange,
</I>&gt;<i>                             &lt;&lt;&quot;data.exchange&quot;&gt;&gt;}}},
</I>&gt;<i>                    [{confirm,6},{publish,6}]},
</I>&gt;<i>                   {delegate,delegate_4},
</I>&gt;<i>                   {{monitoring,&lt;0.253.0&gt;},true},
</I>&gt;<i>                   {{exchange_stats,
</I>&gt;<i>                        {resource,&lt;&lt;&quot;/my_app&quot;&gt;&gt;,exchange,
</I>&gt;<i>                            &lt;&lt;&quot;data.exchange&quot;&gt;&gt;}},
</I>&gt;<i>                    [{confirm,6},{publish,6}]},
</I>&gt;<i>                   {guid,{{11,&lt;0.25562.2442&gt;},11}}]
</I>&gt;<i>     trap_exit: true
</I>&gt;<i>     status: running
</I>&gt;<i>     heap_size: 987
</I>&gt;<i>     stack_size: 24
</I>&gt;<i>     reductions: 11357
</I>&gt;<i>   neighbours:
</I>&gt;<i>  
</I>&gt;<i> =SUPERVISOR REPORT==== 7-May-2012::10:13:33 ===
</I>&gt;<i>      Supervisor: {&lt;0.25560.2442&gt;,rabbit_channel_sup}
</I>&gt;<i>      Context:    child_terminated
</I>&gt;<i>      Reason:     {{badmatch,
</I>&gt;<i>                       {error,
</I>&gt;<i>                           [{&lt;7748.8396.531&gt;,
</I>&gt;<i>                             {exit,{nodedown,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit1 at host1</A>'},[]}}]}},
</I>&gt;<i>                   [{rabbit_channel,terminate,2},
</I>&gt;<i>                    {gen_server2,terminate,3},
</I>&gt;<i>                    {proc_lib,wake_up,3}]}
</I>&gt;<i>      Offender:   [{pid,&lt;0.25562.2442&gt;},
</I>&gt;<i>                   {name,channel},
</I>&gt;<i>                   {mfa,
</I>&gt;<i>                       {rabbit_channel,start_link,
</I>&gt;<i>                           [1,&lt;0.25545.2442&gt;,&lt;0.25561.2442&gt;,&lt;0.25545.2442&gt;,
</I>&gt;<i>                            rabbit_framing_amqp_0_9_1,
</I>&gt;<i>                            {user,&lt;&lt;&quot;my_app&quot;&gt;&gt;,true,
</I>&gt;<i>                                rabbit_auth_backend_internal,
</I>&gt;<i>                                {internal_user,&lt;&lt;&quot;my_app&quot;&gt;&gt;,
</I>&gt;<i>                                    &lt;&lt;199,64,175,52,127,65,248,9,70,171,15,9,5,
</I>&gt;<i>                                      122,73,4,195,147,238,67&gt;&gt;,
</I>&gt;<i>                                    true}},
</I>&gt;<i>                            &lt;&lt;&quot;/my_app&quot;&gt;&gt;,[],&lt;0.25543.2442&gt;,
</I>&gt;<i>                            #Fun&lt;rabbit_channel_sup.0.15412730&gt;]}},
</I>&gt;<i>                   {restart_type,intrinsic},
</I>&gt;<i>                   {shutdown,4294967295},
</I>&gt;<i>                   {child_type,worker}]
</I>&gt;<i>  
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019916.html">[rabbitmq-discuss] Missing Durable Queues on Startup
</A></li>
	<LI>Next message: <A HREF="019944.html">[rabbitmq-discuss] Missing Durable Queues on Startup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19942">[ date ]</a>
              <a href="thread.html#19942">[ thread ]</a>
              <a href="subject.html#19942">[ subject ]</a>
              <a href="author.html#19942">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
