<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Direct vs Topic exchange - Question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Direct%20vs%20Topic%20exchange%20-%20Question&In-Reply-To=%3CD8A04561-EBC4-4248-B050-72EF72675194%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019905.html">
   <LINK REL="Next"  HREF="019909.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Direct vs Topic exchange - Question</H1>
    <B>Konstantin Kalin</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Direct%20vs%20Topic%20exchange%20-%20Question&In-Reply-To=%3CD8A04561-EBC4-4248-B050-72EF72675194%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Direct vs Topic exchange - Question">konstantin.kalin at gmail.com
       </A><BR>
    <I>Tue May  8 04:48:40 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019905.html">[rabbitmq-discuss] Direct vs Topic exchange - Question
</A></li>
        <LI>Next message: <A HREF="019909.html">[rabbitmq-discuss] Direct vs Topic exchange - Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19908">[ date ]</a>
              <a href="thread.html#19908">[ thread ]</a>
              <a href="subject.html#19908">[ subject ]</a>
              <a href="author.html#19908">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, Alvaro.

Thank you for the advise. I had already checked that. Disk IO seems to be fine and VM is slightly loaded. Looks like there is a bottleneck and it's visible surprisingly only when Topic Exchange is used. I will continue digging. If I find an explanation I will let the community know. Initially this strange behavior was totally mystery since I didn't think I could have it because of Virtualization :)

Thank you,
Konstantin.

On May 7, 2012, at 3:29 PM, Alvaro Videla wrote:

&gt;<i> Have you checked Disk I/O performance? 
</I>&gt;<i> 
</I>&gt;<i> A binding on a topic exchange has a bit more entries in Mnesia than the other exchanges.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> 
</I>&gt;<i> Alvaro
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Sent with Sparrow
</I>&gt;<i> 
</I>&gt;<i> On Tuesday, May 8, 2012 at 12:24 AM, Konstantin Kalin wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Hello, Simon.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Finally I found an answer why we had different results with same test code. Something is wrong between KVM virtualization and RabbitMQ when Topic Exchange is used :) At least once I started RabbitMQ on physical server I get understandable results: 90k on Direct Exchange and 75k on Topic exchange. I have checked Network link for RabbitMQ VM and it doesn't look bad. I will continue digging around to find an explanation why it happens. If you can provide any additional advice I will really appreciate it.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thank you,
</I>&gt;&gt;<i> Konstantin.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On May 4, 2012, at 1:51 PM, Konstantin Kalin wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Hello, Simon.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Thank you for your help here. See inline.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On May 4, 2012, at 3:11 AM, Simon MacMullen wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> amqp_channel:cast(Channel, Publish, Msg).
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Since this is pushing messages as fast as possible into the client channel process, you end up filling its mailbox as you can give it messages faster than it can send them out on the wire.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Yes. I know about this and this is why I created rate control on Client side. I thought that amqp_channel:cast(Channel, Publish, Msg) is better way to create a load :) Well, I have changed it to amqp_channel:call. Thank you for the advice.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> direct, 1 producer, 1 consumer: ~25kHz
</I>&gt;&gt;&gt;&gt;<i> topic, 1 producer, 1 consumer: ~14kHz
</I>&gt;&gt;&gt;&gt;<i> direct, 10 producers, 10 consumers: ~25kHz
</I>&gt;&gt;&gt;&gt;<i> (but queues grew since consumers could not keep up)
</I>&gt;&gt;&gt;&gt;<i> topic, 10 producers, 10 consumers: ~16kHz
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> on my workstation. This is very roughly what I would expect - with tiny messages quite a lot of the cost of each message is routing, and topic routing *is* more complex.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Well. It looks much better than I have :) And this is why I have asked to guide me what I'm doing wrong. I believe that RabbitMQ is great product and this is why I spend time on different tests to gain better understanding how it works. Thus I will use RabbitMQ more effectively.
</I>&gt;&gt;&gt;&gt;<i> So I'm afraid I don't really trust the results you got - how were you choosing a rate limit for the client? Too low and you're not driving the broker as hard as you can, and with that cast in place, too high and you'll start to eat all memory and eventually cause RabbitMQ to get swapped out.
</I>&gt;&gt;&gt;<i> Understood. Usually the load test results causes a lot of confusions and questions since people makes load-tests for particular cases.
</I>&gt;&gt;&gt;<i> Please don't treat me wrong. I don't blame RabbitMQ. I rather will blame me for these strange results.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Let me explain my test setup:
</I>&gt;&gt;&gt;<i> I have two physical servers: 16 AuthenticAMD CPU, 16 Gb memory each. I use one physical server to virtualize RabbitMQ using KVM. RabbitMQ has 8 CPU and 4Gb. And there are no other VMs running on this physical server. And I use second physical server to run Consumer/Publisher code that you tried.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I repeated the test with direct and topic exchanges after I modified the code as mentioted above.
</I>&gt;&gt;&gt;<i> 10 consumers and publishers for each type of exchange. I started publishing using following commands:
</I>&gt;&gt;&gt;<i> Test 1 - publisher:start_publish(&lt;&lt;&quot;kkalin_test1&quot;&gt;&gt;, &lt;&lt;&quot;topic&quot;&gt;&gt;, 20000, 20000, 10, 0).
</I>&gt;&gt;&gt;<i> Test 2 - publisher:start_publish(&lt;&lt;&quot;kkalin_test&quot;&gt;&gt;, &lt;&lt;&quot;direct&quot;&gt;&gt;, 20000, 20000, 10, 0).
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I got: ~4k for Topic and ~60k for Direct :) See attached screenshots. I don't understand why. And I think it's hard to blame that publisher_wrk works slow for Topic exchange. There is no dedicated logic in software code that can affect messages rate depending on Exchange type. Same code, same machines and results with big differences. :(
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> May be you can provide a few advices what I can check to understand where is a bottle neck?
</I>&gt;&gt;&gt;<i> According to vmstat and htop, RabbitMQ and Client servers were not loaded in case of Topic Exchange. Looks like that RabbitMQ and Publisher are waiting each other.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Thank you for patience,
</I>&gt;&gt;&gt;<i> Kostya.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> &lt;Screen Shot 2012-05-04 at 12.57.24 PM.png&gt;
</I>&gt;&gt;&gt;<i> &lt;Screen Shot 2012-05-04 at 1.09.10 PM.png&gt;
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120507/125040fc/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120507/125040fc/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019905.html">[rabbitmq-discuss] Direct vs Topic exchange - Question
</A></li>
	<LI>Next message: <A HREF="019909.html">[rabbitmq-discuss] Direct vs Topic exchange - Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19908">[ date ]</a>
              <a href="thread.html#19908">[ thread ]</a>
              <a href="subject.html#19908">[ subject ]</a>
              <a href="author.html#19908">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
