<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Per-Connection Flow Control -- The Case	Against
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Per-Connection%20Flow%20Control%20--%20The%20Case%0A%09Against&In-Reply-To=%3C4FC64EB0.7070304%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020395.html">
   <LINK REL="Next"  HREF="020320.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Per-Connection Flow Control -- The Case	Against</H1>
    <B>Reverend Chip</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Per-Connection%20Flow%20Control%20--%20The%20Case%0A%09Against&In-Reply-To=%3C4FC64EB0.7070304%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Per-Connection Flow Control -- The Case	Against">rev.chip at gmail.com
       </A><BR>
    <I>Wed May 30 17:45:36 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020395.html">[rabbitmq-discuss] Per-Connection Flow Control -- The Case	Against
</A></li>
        <LI>Next message: <A HREF="020320.html">[rabbitmq-discuss]  Example of FIX over AMQP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20404">[ date ]</a>
              <a href="thread.html#20404">[ thread ]</a>
              <a href="subject.html#20404">[ subject ]</a>
              <a href="author.html#20404">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/30/2012 3:56 AM, Simon MacMullen wrote:
&gt;<i> On 30/05/12 06:52, Chip Salzenberg wrote:
</I>&gt;&gt;<i> On Fri, May 25, 2012 at 5:12 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     In the mean time, I wonder whether 500 consumers and prefetch-count
</I>&gt;&gt;<i>     of 2 is what you really want. Normally I would expect a
</I>&gt;&gt;<i>     configuration like that when you expect to take some time to process
</I>&gt;&gt;<i>     each message, but it sounds like you're going fast enough that
</I>&gt;&gt;<i>     either 500 consumers are not needed, or prefetch-count &gt; 2 might
</I>&gt;&gt;<i>     lead to better performance.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I didn't know that a larger prefetch count could reduce broker workload.
</I>&gt;&gt;<i>   Per-message processing in this system is sometimes high (up to 20s),
</I>&gt;&gt;<i> but it averages very low.  It's likely that 500 is overkill, but
</I>&gt;&gt;<i> probably only by 2x or so.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Assuming a constant throughput of about 6K/sec and at least 250 workers,
</I>&gt;&gt;<i> what prefetch seems more helpful, IYO?  10?  20?
</I>&gt;<i>
</I>&gt;<i> Well, there are two different things here that I somewhat conflated:
</I>&gt;<i>
</I>&gt;<i> * Number of consumers using prefetch count
</I>&gt;<i>   - The higher this number, the more bookkeeping work the queue has
</I>&gt;<i>     to do.
</I>&gt;<i>
</I>&gt;<i> * Size of prefetch count
</I>&gt;<i>   - The lower this number, the more likely that any given consumer will
</I>&gt;<i>     stall, and thus the slower consuming goes.
</I>
Ah.  Well, throughput is not our problem, flow control on publish is. 
So the latter issue is off the table.  The former issue should be
negligible; what modern software has trouble tracking 500 queue depths?

Meanwhile, consider this.  In our system, when stalls happened so
uselessly, actually had 2 queues bound to the exchange.  And it was
definitely the flow control kicking in and not the queue becoming
overwhelmed because a) it said &quot;flow&quot; in the ui. b) both queues were
blocked, not just the one that had tons of consumers starting on it. The
flow control is failing worse than I had already described because if
prevents other queues bound to the same exchange from getting any
messages even if they are empty.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020395.html">[rabbitmq-discuss] Per-Connection Flow Control -- The Case	Against
</A></li>
	<LI>Next message: <A HREF="020320.html">[rabbitmq-discuss]  Example of FIX over AMQP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20404">[ date ]</a>
              <a href="thread.html#20404">[ thread ]</a>
              <a href="subject.html#20404">[ subject ]</a>
              <a href="author.html#20404">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
