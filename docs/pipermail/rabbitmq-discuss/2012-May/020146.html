<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] STOMP adapter lose the last message of a	burst
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20STOMP%20adapter%20lose%20the%20last%20message%20of%20a%0A%09burst&In-Reply-To=%3C4FB66324.7030400%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020148.html">
   <LINK REL="Next"  HREF="020149.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] STOMP adapter lose the last message of a	burst</H1>
    <B>Jos&#233; Mic&#243;</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20STOMP%20adapter%20lose%20the%20last%20message%20of%20a%0A%09burst&In-Reply-To=%3C4FB66324.7030400%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] STOMP adapter lose the last message of a	burst">jose.mico at gmail.com
       </A><BR>
    <I>Fri May 18 15:56:36 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020148.html">[rabbitmq-discuss] JAVA client / non daemon threads / shutdown hook
</A></li>
        <LI>Next message: <A HREF="020149.html">[rabbitmq-discuss] JAVA client / non daemon threads / shutdown hook
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20146">[ date ]</a>
              <a href="thread.html#20146">[ thread ]</a>
              <a href="subject.html#20146">[ subject ]</a>
              <a href="author.html#20146">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/18/2012 07:22 AM, Steve Powell wrote:
&gt;<i> This may very well be a bug, but could also be something about flushing
</I>&gt;<i> in the Perl script you are using.
</I>That was my first thought also (a client side buffering issue). I'm 
implementing a messaging framework, and while stress testing it I found 
that it fails consistently to deliver timely the last message sent to a 
topic or queue. Some of my tests fails frequently when the number of 
messages sent doesn't match the number of messages received, or when RPC 
style calls timeout due to the call istself not being sent timely.

Finally I could trace the bug down to RabbitMQ, and to be sure I wrote 
the simplest possible script that replicates the problem. I've attached 
an updated version of it which uses syswrite() calls in order to bypass 
any IO buffering.

I want to clarify that the last message is not actually lost: it remains 
buffered by the adapter, but is not processed until new data arrives 
from the same client.
If I send 100 messages, the queue will get messages #1..#99 (the last 
one being buffered somewhere). Then send another 100 messages, and queue 
will get the message #100, followed by #101..#199. Again, message #200 
remains buffered. And so on.

&gt;<i>
</I>&gt;<i> Please can you tell us which version of RabbitMQ and STOMP you are
</I>&gt;<i> using?
</I>I'm using RabbitMQ 2.8.2 on Erlang R15B with the bundled STOMP adapter.

&gt;<i> Steve Powell
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">steve at rabbitmq.com</A>
</I>&gt;<i> [wrk: +44-2380-111-528] [mob: +44-7815-838-558]
</I>&gt;<i>
</I>&gt;<i> On 18 May 2012, at 06:18, Jos&#233; Mic&#243; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I think I've found a somewhat serious bug in the STOMP adapter: after a burst of incoming messages, the last one remains buffered somewhere indefinitely and is not added to the queue until another message is received from the same connection (same with topics). This cause and excessive delay to deliver the message to consumers, if it is ever delivered. Besides that, that last message is lost if the connection is not properly closed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've attached a simple script which replicates the bug. It sends burst of 100 small messages to a queue every 10 seconds. Using the management console, we can inspect the count of Ready messages. The expected progression is 100 ... 200 ... 300 ... 400 ... 500, but very frequently (not always) we get 99 ... 199 ... 299 ... 399 ... 499, as the last message is not queued.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Could be that the STOMP parser gets confused after an incomplete frame was read from tcp buffer? Any ideas?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regards,
</I>&gt;&gt;<i> Jos&#233;
</I>&gt;&gt;<i> &lt;stomp_bug.pl&gt;_______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: stomp_bug_2.pl
Type: application/x-perl
Size: 1472 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120518/40e977b9/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120518/40e977b9/attachment.bin</A>&gt;
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020148.html">[rabbitmq-discuss] JAVA client / non daemon threads / shutdown hook
</A></li>
	<LI>Next message: <A HREF="020149.html">[rabbitmq-discuss] JAVA client / non daemon threads / shutdown hook
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20146">[ date ]</a>
              <a href="thread.html#20146">[ thread ]</a>
              <a href="subject.html#20146">[ subject ]</a>
              <a href="author.html#20146">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
