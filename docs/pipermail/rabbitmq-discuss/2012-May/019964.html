<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Queues with high memory consumption
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queues%20with%20high%20memory%20consumption&In-Reply-To=%3CCANVSfpJhyUTFQOR%3Ds85SOSnCCBHPxxMyc%2B9M%2Bj-S3Ws3AeacFw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019928.html">
   <LINK REL="Next"  HREF="019969.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Queues with high memory consumption</H1>
    <B>Pablo Molnar</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queues%20with%20high%20memory%20consumption&In-Reply-To=%3CCANVSfpJhyUTFQOR%3Ds85SOSnCCBHPxxMyc%2B9M%2Bj-S3Ws3AeacFw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Queues with high memory consumption">pablomolnar at gmail.com
       </A><BR>
    <I>Wed May  9 23:30:55 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019928.html">[rabbitmq-discuss] Queues with high memory consumption
</A></li>
        <LI>Next message: <A HREF="019969.html">[rabbitmq-discuss] Queues with high memory consumption
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19964">[ date ]</a>
              <a href="thread.html#19964">[ thread ]</a>
              <a href="subject.html#19964">[ subject ]</a>
              <a href="author.html#19964">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Actually is causing me headaches because the memory of the node keeps
rising to beyond the watermark level and that freezes all my rabbitmq
cluster. For instance right node I have a node with 4.3GB used with a
watermark of 4.7GB and all ndoe queues are updated (empties). I've pated
the node status and queue details below.

Any idea how to solve this?

curl .../api/nodes/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-000000ed-wsm</A>
{
   &quot;name&quot;:&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-000000ed-wsm</A>&quot;,
   &quot;type&quot;:&quot;ram&quot;,
   &quot;running&quot;:true,
   &quot;os_pid&quot;:&quot;6451&quot;,
   &quot;mem_ets&quot;:54743192,
   &quot;mem_binary&quot;:206280808,
   &quot;mem_proc&quot;:4284714760,
   &quot;mem_proc_used&quot;:4284698594,
   &quot;mem_atom&quot;:2107665,
   &quot;mem_atom_used&quot;:2076476,
   &quot;mem_code&quot;:15225838,
   &quot;fd_used&quot;:42,
   &quot;fd_total&quot;:131072,
   &quot;sockets_used&quot;:14,
   &quot;sockets_total&quot;:117872,
   &quot;mem_used&quot;:4645571200,
   &quot;mem_limit&quot;:5017685196,
   &quot;mem_alarm&quot;:false,
   &quot;proc_used&quot;:618,
   &quot;proc_total&quot;:32768,
   &quot;statistics_level&quot;:&quot;fine&quot;,
   &quot;erlang_version&quot;:&quot;R15B&quot;,
   &quot;uptime&quot;:2203242331,
   &quot;run_queue&quot;:5,
   &quot;processors&quot;:4,
   &quot;exchange_types&quot;:[
      {
         &quot;name&quot;:&quot;topic&quot;,
         &quot;description&quot;:&quot;AMQP topic exchange, as per the AMQP specification&quot;,
         &quot;enabled&quot;:true
      },
      {
         &quot;name&quot;:&quot;fanout&quot;,
         &quot;description&quot;:&quot;AMQP fanout exchange, as per the AMQP
specification&quot;,
         &quot;enabled&quot;:true
      },
      {
         &quot;name&quot;:&quot;direct&quot;,
         &quot;description&quot;:&quot;AMQP direct exchange, as per the AMQP
specification&quot;,
         &quot;enabled&quot;:true
      },
      {
         &quot;name&quot;:&quot;headers&quot;,
         &quot;description&quot;:&quot;AMQP headers exchange, as per the AMQP
specification&quot;,
         &quot;enabled&quot;:true
      }
   ],
   &quot;auth_mechanisms&quot;:[
      {
         &quot;name&quot;:&quot;PLAIN&quot;,
         &quot;description&quot;:&quot;SASL PLAIN authentication mechanism&quot;,
         &quot;enabled&quot;:true
      },
      {
         &quot;name&quot;:&quot;AMQPLAIN&quot;,
         &quot;description&quot;:&quot;QPid AMQPLAIN mechanism&quot;,
         &quot;enabled&quot;:true
      },
      {
         &quot;name&quot;:&quot;RABBIT-CR-DEMO&quot;,
         &quot;description&quot;:&quot;RabbitMQ Demo challenge-response authentication
mechanism&quot;,
         &quot;enabled&quot;:false
      }
   ],
   &quot;applications&quot;:[
      {
         &quot;name&quot;:&quot;amqp_client&quot;,
         &quot;description&quot;:&quot;RabbitMQ AMQP Client&quot;,
         &quot;version&quot;:&quot;2.7.1&quot;
      },
      {
         &quot;name&quot;:&quot;inets&quot;,
         &quot;description&quot;:&quot;INETS  CXC 138 49&quot;,
         &quot;version&quot;:&quot;5.8&quot;
      },
      {
         &quot;name&quot;:&quot;kernel&quot;,
         &quot;description&quot;:&quot;ERTS  CXC 138 10&quot;,
         &quot;version&quot;:&quot;2.15&quot;
      },
      {
         &quot;name&quot;:&quot;mnesia&quot;,
         &quot;description&quot;:&quot;MNESIA  CXC 138 12&quot;,
         &quot;version&quot;:&quot;4.6&quot;
      },
      {
         &quot;name&quot;:&quot;mochiweb&quot;,
         &quot;description&quot;:&quot;MochiMedia Web Server&quot;,
         &quot;version&quot;:&quot;1.3-rmq2.7.1-git&quot;
      },
      {
         &quot;name&quot;:&quot;os_mon&quot;,
         &quot;description&quot;:&quot;CPO  CXC 138 46&quot;,
         &quot;version&quot;:&quot;2.2.8&quot;
      },
      {
         &quot;name&quot;:&quot;rabbit&quot;,
         &quot;description&quot;:&quot;RabbitMQ&quot;,
         &quot;version&quot;:&quot;2.7.1&quot;
      },
      {
         &quot;name&quot;:&quot;rabbitmq_management&quot;,
         &quot;description&quot;:&quot;RabbitMQ Management Console&quot;,
         &quot;version&quot;:&quot;2.7.1&quot;
      },
      {
         &quot;name&quot;:&quot;rabbitmq_management_agent&quot;,
         &quot;description&quot;:&quot;RabbitMQ Management Agent&quot;,
         &quot;version&quot;:&quot;2.7.1&quot;
      },
      {
         &quot;name&quot;:&quot;rabbitmq_management_visualiser&quot;,
         &quot;description&quot;:&quot;RabbitMQ Visualiser&quot;,
         &quot;version&quot;:&quot;2.7.1&quot;
      },
      {
         &quot;name&quot;:&quot;rabbitmq_mochiweb&quot;,
         &quot;description&quot;:&quot;RabbitMQ Mochiweb Embedding&quot;,
         &quot;version&quot;:&quot;2.7.1&quot;
      },
      {
         &quot;name&quot;:&quot;sasl&quot;,
         &quot;description&quot;:&quot;SASL  CXC 138 11&quot;,
         &quot;version&quot;:&quot;2.2&quot;
      },
      {
         &quot;name&quot;:&quot;stdlib&quot;,
         &quot;description&quot;:&quot;ERTS  CXC 138 10&quot;,
         &quot;version&quot;:&quot;1.18&quot;
      },
      {
         &quot;name&quot;:&quot;webmachine&quot;,
         &quot;description&quot;:&quot;webmachine&quot;,
         &quot;version&quot;:&quot;1.7.0-rmq2.7.1-hg&quot;
      }
   ]
}



rabbitmqctl status
Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000140-csm</A>' ...
[{pid,739},
 {running_applications,
     [{rabbitmq_management_visualiser,&quot;RabbitMQ Visualiser&quot;,&quot;2.7.1&quot;},
      {rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;2.7.1&quot;},
      {rabbitmq_mochiweb,&quot;RabbitMQ Mochiweb Embedding&quot;,&quot;2.7.1&quot;},
      {webmachine,&quot;webmachine&quot;,&quot;1.7.0-rmq2.7.1-hg&quot;},
      {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;2.7.1&quot;},
      {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;2.7.1&quot;},
      {rabbit,&quot;RabbitMQ&quot;,&quot;2.7.1&quot;},
      {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.8&quot;},
      {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.2&quot;},
      {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;1.3-rmq2.7.1-git&quot;},
      {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.8&quot;},
      {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.6&quot;},
      {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.18&quot;},
      {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.15&quot;}]},
 {os,{unix,linux}},
 {erlang_version,
     &quot;Erlang R15B (erts-5.9) [source] [64-bit] [smp:4:4] [async-threads:0]
[hipe] [kernel-poll:false]\n&quot;},
 {memory,
     [{total,4404012432},
      {processes,4148260149},
      {processes_used,4148259728},
      {system,255752283},
      {atom,561761},
      {atom_used,550271},
      {binary,81414464},
      {code,15193946},
      {ets,86119376}]},
 {vm_memory_high_watermark,0.799999999904651},
 {vm_memory_limit,6712184012}]
...done.



Here I'm attaches the queue details. The first two queues consumes 3.5GB
<A HREF="https://gist.github.com/2649372">https://gist.github.com/2649372</A>



On Tue, May 8, 2012 at 8:22 AM, Matthias Radestock &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;wrote:

&gt;<i> Pablo,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 07/05/12 19:28, Pablo Molnar wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I'm trying to figure out why the memory consumption of some queues
</I>&gt;&gt;<i> are  extremely high although there is almost none messages ready to
</I>&gt;&gt;<i> consume.
</I>&gt;&gt;<i> For instance this queue has only 3 messages but consumes 2.4GB of
</I>&gt;&gt;<i> RAM.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That is not necessarily a problem, in particular ...
</I>&gt;<i>
</I>&gt;<i>  {
</I>&gt;&gt;<i>   &quot;exclusive_consumer_tag&quot;:&quot;&quot;,
</I>&gt;&gt;<i>   &quot;messages_ready&quot;:0,
</I>&gt;&gt;<i>   &quot;messages_unacknowledged&quot;:3,
</I>&gt;&gt;<i>   &quot;messages&quot;:3,
</I>&gt;&gt;<i>   &quot;consumers&quot;:25,
</I>&gt;&gt;<i>   &quot;memory&quot;:2586777216,
</I>&gt;&gt;<i>   &quot;slave_nodes&quot;:[
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   ],
</I>&gt;&gt;<i>   &quot;backing_queue_status&quot;:{
</I>&gt;&gt;<i>      &quot;q1&quot;:0,
</I>&gt;&gt;<i>      &quot;q2&quot;:0,
</I>&gt;&gt;<i>      &quot;delta&quot;:[
</I>&gt;&gt;<i>         &quot;delta&quot;,
</I>&gt;&gt;<i>         &quot;undefined&quot;,
</I>&gt;&gt;<i>         0,
</I>&gt;&gt;<i>         &quot;undefined&quot;
</I>&gt;&gt;<i>      ],
</I>&gt;&gt;<i>      &quot;q3&quot;:0,
</I>&gt;&gt;<i>      &quot;q4&quot;:0,
</I>&gt;&gt;<i>      &quot;len&quot;:0,
</I>&gt;&gt;<i>      &quot;pending_acks&quot;:3,
</I>&gt;&gt;<i>      &quot;target_ram_count&quot;:0,
</I>&gt;&gt;<i>      &quot;ram_msg_count&quot;:0,
</I>&gt;&gt;<i>      &quot;ram_ack_count&quot;:0,
</I>&gt;&gt;<i>      &quot;next_seq_id&quot;:72528926,
</I>&gt;&gt;<i>      &quot;persistent_count&quot;:3,
</I>&gt;&gt;<i>      &quot;avg_ingress_rate&quot;:42.**456013780009044,
</I>&gt;&gt;<i>      &quot;avg_egress_rate&quot;:42.**456013780009044,
</I>&gt;&gt;<i>      &quot;avg_ack_ingress_rate&quot;:42.**456013780009044,
</I>&gt;&gt;<i>      &quot;avg_ack_egress_rate&quot;:42.**456013780009044
</I>&gt;&gt;<i>   },  ...
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ...this is a slow-moving, but not idle queue. I suspect what happened is
</I>&gt;<i> that at some point the queue did have lots of messages in it, hence
</I>&gt;<i> requiring lots of memory. Those messages subsequently got drained, but the
</I>&gt;<i> since the queue is slow moving it can take a while for Erlang's gc to
</I>&gt;<i> reclaim memory.
</I>&gt;<i>
</I>&gt;<i> Unless this is causing any other problems I wouldn't worry about it.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  rabbitmqctl status
</I>&gt;&gt;<i> Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000140-csm</A>' ...
</I>&gt;&gt;<i> [{pid,20106},
</I>&gt;&gt;<i>  {running_applications,
</I>&gt;&gt;<i>     [{rabbitmq_management_**visualiser,&quot;RabbitMQ Visualiser&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>      {rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>      {rabbitmq_mochiweb,&quot;RabbitMQ Mochiweb Embedding&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>      {webmachine,&quot;webmachine&quot;,&quot;1.7.**0-rmq2.7.1-hg&quot;},
</I>&gt;&gt;<i>      {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>      {rabbitmq_management_agent,&quot;**RabbitMQ Management Agent&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>      {rabbit,&quot;RabbitMQ&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>      {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.8&quot;},
</I>&gt;&gt;<i>      {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.2&quot;},
</I>&gt;&gt;<i>      {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;1.3-rmq2.7.1-git&quot;},
</I>&gt;&gt;<i>      {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.8&quot;},
</I>&gt;&gt;<i>      {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.6&quot;},
</I>&gt;&gt;<i>      {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.18&quot;},
</I>&gt;&gt;<i>      {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.15&quot;}]},
</I>&gt;&gt;<i>  {os,{unix,linux}},
</I>&gt;&gt;<i>  {erlang_version,
</I>&gt;&gt;<i>     &quot;Erlang R15B (erts-5.9) [source] [64-bit] [smp:4:4] [async-threads:0]
</I>&gt;&gt;<i> [hipe] [kernel-poll:false]\n&quot;},
</I>&gt;&gt;<i>  {memory,
</I>&gt;&gt;<i>     [{total,4736488576},
</I>&gt;&gt;<i>      {processes,3832122172},
</I>&gt;&gt;<i>      {processes_used,3832066481},
</I>&gt;&gt;<i>      {system,904366404},
</I>&gt;&gt;<i>      {atom,561761},
</I>&gt;&gt;<i>      {atom_used,551430},
</I>&gt;&gt;<i>      {binary,98523592},
</I>&gt;&gt;<i>      {code,15193946},
</I>&gt;&gt;<i>      {ets,717445688}]},
</I>&gt;&gt;<i>  {vm_memory_high_watermark,0.**6999999999761628},
</I>&gt;&gt;<i>  {vm_memory_limit,5873161011}]
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You may want to upgrade to the latest Erlang (R15B01) and rabbit (2.8.2),
</I>&gt;<i> though I doubt that will make a difference.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120509/de8c9417/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120509/de8c9417/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019928.html">[rabbitmq-discuss] Queues with high memory consumption
</A></li>
	<LI>Next message: <A HREF="019969.html">[rabbitmq-discuss] Queues with high memory consumption
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19964">[ date ]</a>
              <a href="thread.html#19964">[ thread ]</a>
              <a href="subject.html#19964">[ subject ]</a>
              <a href="author.html#19964">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
