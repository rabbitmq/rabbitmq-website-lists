<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ stopping when trying to delete locked	mnesia files?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20stopping%20when%20trying%20to%20delete%20locked%0A%09mnesia%20files%3F&In-Reply-To=%3C220C32D4-3EB5-4032-A898-2FC2E0551260%40tjervaag.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020401.html">
   <LINK REL="Next"  HREF="020394.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ stopping when trying to delete locked	mnesia files?</H1>
    <B>&#216;yvind Tjervaag</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20stopping%20when%20trying%20to%20delete%20locked%0A%09mnesia%20files%3F&In-Reply-To=%3C220C32D4-3EB5-4032-A898-2FC2E0551260%40tjervaag.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ stopping when trying to delete locked	mnesia files?">oyvind at tjervaag.com
       </A><BR>
    <I>Tue May 29 13:01:48 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020401.html">[rabbitmq-discuss] RabbitMQ on RHEL on top of VMware ESX
</A></li>
        <LI>Next message: <A HREF="020394.html">[rabbitmq-discuss] RabbitMQ stopping when trying to delete locked mnesia files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20371">[ date ]</a>
              <a href="thread.html#20371">[ thread ]</a>
              <a href="subject.html#20371">[ subject ]</a>
              <a href="author.html#20371">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

I've had this problem a couple of times now where it seems, if I'm deciphering the logs correctly, the RabbitMQ crashed when it tries to delete mnesia files that are locked by backup or virus-scanning. I thought I had seen something about this on this list a while back, but I can't seem to find it now.

Sorry about the long logs, but I've snipped what I thought was irrelevant:


=ERROR REPORT==== 24-May-2012::01:20:54 ===
** Generic server &lt;0.195.0&gt; terminating
** Last message in was {'$gen_cast',{delete,8611}}
** When Server state == {state,
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            [],
                            {gc_state,
                                &quot;e:/Mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at machinename-mnesia</A>/msg_store_persistent&quot;,
                                rabbit_msg_store_ets_index,
                                {state,213063,
                                    &quot;e:/Mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at machinename-mnesia</A>/msg_store_persistent&quot;},
                                208966,217160,&lt;0.192.0&gt;}}
** Reason for termination == 
** {{badmatch,{error,eacces}},
    [{rabbit_msg_store,safe_file_delete,3,[]},
     {rabbit_msg_store_gc,'-attempt_action/3-fun-0-',1,[]},
     {lists,'-filter/2-lc$^0/1-0-',2,[{file,&quot;lists.erl&quot;},{line,1220}]},
     {rabbit_msg_store_gc,attempt_action,3,[]},
     {rabbit_msg_store_gc,handle_cast,2,[]},
     {gen_server2,handle_msg,2,[]},
     {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,237}]}]}

=ERROR REPORT==== 24-May-2012::01:20:54 ===
** Generic server msg_store_persistent terminating
** Last message in was {'EXIT',&lt;0.195.0&gt;,
                           {{badmatch,{error,eacces}},
                            [{rabbit_msg_store,safe_file_delete,3,[]},
                             {rabbit_msg_store_gc,'-attempt_action/3-fun-0-',
                                 1,[]},
                             {lists,'-filter/2-lc$^0/1-0-',2,
                                 [{file,&quot;lists.erl&quot;},{line,1220}]},
                             {rabbit_msg_store_gc,attempt_action,3,[]},
                             {rabbit_msg_store_gc,handle_cast,2,[]},
                             {gen_server2,handle_msg,2,[]},
                             {proc_lib,wake_up,3,
                                 [{file,&quot;proc_lib.erl&quot;},{line,237}]}]}}
** When Server state == {msstate,
                            &quot;e:/Mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at machinename-mnesia</A>/msg_store_persistent&quot;,
                            rabbit_msg_store_ets_index,
                            {state,213063,
                                &quot;e:/Mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at machinename-mnesia</A>/msg_store_persistent&quot;},
                            8612,#Ref&lt;0.0.100.15376&gt;,
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            undefined,6556,6556,[],&lt;0.195.0&gt;,217160,208966,
                            221257,225354,
                            {set,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,3,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],
                                  [[&lt;&lt;242,131,46,148,249,165,117,168,89,192,
                                      116,172,97,9,69,105&gt;&gt;|
                                    {&lt;0.201.0&gt;,
                                     #Fun&lt;rabbit_variable_queue.1.12380193&gt;,
                                     #Fun&lt;rabbit_variable_queue.13.91199175&gt;}]],
                                  [],
                                  [[&lt;&lt;93,218,27,224,115,59,29,211,84,246,239,
                                      132,234,163,75,58&gt;&gt;|
                                    {&lt;0.200.0&gt;,
                                     #Fun&lt;rabbit_variable_queue.1.12380193&gt;,
                                     #Fun&lt;rabbit_variable_queue.13.91199175&gt;}]],
                                  [[&lt;&lt;11,218,33,254,192,34,57,180,178,129,31,
                                      72,69,118,184,70&gt;&gt;|
                                    {&lt;0.199.0&gt;,
                                     #Fun&lt;rabbit_variable_queue.1.12380193&gt;,
                                     #Fun&lt;rabbit_variable_queue.13.91199175&gt;}]],
                                  [],[],[],[],[],[],[],[],[],[],[]}}},
                            false,16777216,
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}}}
** Reason for termination == 
** {noproc,{gen_server2,call,[&lt;0.195.0&gt;,stop,infinity]}}
** In 'terminate' callback with reason ==
** {{badmatch,{error,eacces}},
    [{rabbit_msg_store,safe_file_delete,3,[]},
     {rabbit_msg_store_gc,'-attempt_action/3-fun-0-',1,[]},
     {lists,'-filter/2-lc$^0/1-0-',2,[{file,&quot;lists.erl&quot;},{line,1220}]},
     {rabbit_msg_store_gc,attempt_action,3,[]},
     {rabbit_msg_store_gc,handle_cast,2,[]},
     {gen_server2,handle_msg,2,[]},
     {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,237}]}]}

=INFO REPORT==== 24-May-2012::01:20:54 ===
stopped TCP Listener on 0.0.0.0:5672

=INFO REPORT==== 24-May-2012::01:20:54 ===
stopped TCP Listener on [::]:5672

=ERROR REPORT==== 24-May-2012::01:21:01 ===
** Generic server &lt;0.200.0&gt; terminating
** Last message in was {'EXIT',&lt;0.198.0&gt;,shutdown}
** When Server state == {q,
                         {amqqueue,
                          {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;QUEUENAME&quot;&gt;&gt;},
                          true,false,none,[],&lt;0.200.0&gt;,[],undefined},
                         none,true,rabbit_variable_queue,
                         {vqstate,
                          {0,{[],[]}},
                          {0,{[],[]}},
                          {delta,undefined,0,undefined},
                          {0,{[],[]}},
                          {0,{[],[]}},
                          793942,
                          {0,nil},
                          undefined,
                          {0,nil},
                          {qistate,
                           &quot;e:/Mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at machinename-mnesia</A>/queues/CDBIXPAYNE7Z1MBHQJSYJB9T9&quot;,
                           {{dict,4,16,16,8,80,48,
                             {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                             {{[],[],[],[],
                               [[44|
                                 {segment,44,
                                  &quot;e:/Mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at machinename-mnesia</A>/queues/CDBIXPAYNE7Z1MBHQJSYJB9T9/44.idx&quot;,
                                  {array,16384,0,undefined,
                                   {{{{{{{&lt;&lt;177,189,215,156,204,89,5,250,132,
                                            27,178,87,129,157,90,185&gt;&gt;,
                                          {message_properties,undefined,true},
                                          true},
                                         del,ack},
                                        {{&lt;&lt;219,139,40,233,147,201,159,68,150,
                                            79,119,170,23,210,45,19&gt;&gt;,
                                          {message_properties,undefined,true},
                                          true},
                                         del,ack},
&lt;---------- BIG SNIP ------------------&gt;
                            {state,192578,
                             &quot;e:/Mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at machinename-mnesia</A>/msg_store_transient&quot;},
                            rabbit_msg_store_ets_index,
                            &quot;e:/Mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at machinename-mnesia</A>/msg_store_transient&quot;,
                            &lt;0.190.0&gt;,196675,188474,200772,204869}},
                          true,0,#Fun&lt;rabbit_amqqueue_process.5.17325602&gt;,2,2,
                          infinity,2,0,0,0,2,
                          {rates,
                           {{1337,815248,910691},10},
                           {{1337,815248,910691},10},
                           1.4544749345486279,1.4544749345486279,
                           {1337,815253,957691}},
                          {0,nil},
                          {0,nil},
                          {0,nil},
                          {0,nil},
                          0,0,
                          {rates,
                           {{1337,815248,910691},10},
                           {{1337,815248,910691},10},
                           1.4544749345486279,1.4544749345486279,
                           {1337,815253,957691}}},
                         {[],[]},
                         undefined,undefined,#Ref&lt;0.0.100.15371&gt;,undefined,
                         {state,fine,5000,#Ref&lt;0.0.100.15372&gt;},
                         {0,nil},
                         undefined,undefined,
                         {dict,0,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                          {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},
                         1,
                         {{0,nil},{0,nil}},
                         undefined,
                         {dict,0,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                          {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},
                         undefined,undefined}
** Reason for termination == 
** {noproc,
       {gen_server2,call,
           [msg_store_persistent,
            {client_terminate,
                &lt;&lt;242,131,46,148,249,165,117,168,89,192,116,172,97,9,69,105&gt;&gt;},
            infinity]}}
** In 'terminate' callback with reason ==
** shutdown

=INFO REPORT==== 24-May-2012::01:21:43 ===
    application: rabbit
    exited: shutdown
    type: permanent


I'm running RabbitMQ version 2.8.2 and Erlang R15B01 on Windows 2008 R2 (64 bit). Now, I've told the IT-ops-people to stop locking any files in the mnesia folder, but I think RabbitMQ should not fail this badly when it tries deleting a locked file? 

Or am I doing something else wrong here?

thanks,
&#216;yvind
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020401.html">[rabbitmq-discuss] RabbitMQ on RHEL on top of VMware ESX
</A></li>
	<LI>Next message: <A HREF="020394.html">[rabbitmq-discuss] RabbitMQ stopping when trying to delete locked mnesia files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20371">[ date ]</a>
              <a href="thread.html#20371">[ thread ]</a>
              <a href="subject.html#20371">[ subject ]</a>
              <a href="author.html#20371">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
