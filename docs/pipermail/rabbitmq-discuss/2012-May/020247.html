<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ server closing connection every few	minutes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20server%20closing%20connection%20every%20few%0A%09minutes&In-Reply-To=%3CCA%2BO6_Fccoe--GaqCYJuqLWmSjoTiH72F85eFsk5CObmovh%2Bx7g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020236.html">
   <LINK REL="Next"  HREF="020241.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ server closing connection every few	minutes</H1>
    <B>David Tinker</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20server%20closing%20connection%20every%20few%0A%09minutes&In-Reply-To=%3CCA%2BO6_Fccoe--GaqCYJuqLWmSjoTiH72F85eFsk5CObmovh%2Bx7g%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ server closing connection every few	minutes">david.tinker at gmail.com
       </A><BR>
    <I>Tue May 22 11:28:14 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020236.html">[rabbitmq-discuss] RabbitMQ server closing connection every few minutes
</A></li>
        <LI>Next message: <A HREF="020241.html">[rabbitmq-discuss] rabbitmq for HA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20247">[ date ]</a>
              <a href="thread.html#20247">[ thread ]</a>
              <a href="subject.html#20247">[ subject ]</a>
              <a href="author.html#20247">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks a stack for the quick responses. I did find mentions of
heartbeat when Googling this problem but was under the impression that
we were not using it. It turns out we were and disabling it sorted out
our issues.

Thanks again
David

On Tue, May 22, 2012 at 10:25 AM, Tim Watson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>&gt; wrote:
&gt;<i> On 22/05/2012 09:00, Tim Watson wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 22/05/2012 08:48, Tim Watson wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 22/05/2012 07:34, David Tinker wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Hi
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> We have a Java application using RabbitMQ that keeps getting its
</I>&gt;&gt;&gt;&gt;<i> connection closed by the server every few minutes. On the client side
</I>&gt;&gt;&gt;&gt;<i> we see this:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 2012-05-22 05:30:05,337 [AMQP Connection 127.0.0.1:5671] ERROR
</I>&gt;&gt;&gt;&gt;<i> pork.RabbitService - Connection to Rabbit Exchange shutting down:
</I>&gt;&gt;&gt;&gt;<i> com.rabbitmq.client.ShutdownSignalException: connection error; reason:
</I>&gt;&gt;&gt;&gt;<i> java.net.SocketException: Connection reset
</I>&gt;&gt;&gt;&gt;<i> Reason: java.net.SocketException: Connection reset
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On the server side we get this:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> =INFO REPORT==== 22-May-2012::05:25:20 ===
</I>&gt;&gt;&gt;&gt;<i> accepting AMQP connection&lt;0.32660.612&gt; (127.0.0.1:45458 -&gt;
</I>&gt;&gt;&gt;&gt;<i> 127.0.0.1:5671)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> =ERROR REPORT==== 22-May-2012::05:30:05 ===
</I>&gt;&gt;&gt;&gt;<i> closing AMQP connection&lt;0.32660.612&gt; (127.0.0.1:45458 -&gt;
</I>&gt;&gt;&gt;&gt;<i> 127.0.0.1:5671):
</I>&gt;&gt;&gt;&gt;<i> {timeout,running}
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi David. The second error message will appear in the logs when there
</I>&gt;&gt;&gt;<i> has been an un-handled exception in rabbit's 'reader process'. The
</I>&gt;&gt;&gt;<i> '{timeout, running}' state occurs when receiving data from the network
</I>&gt;&gt;&gt;<i> takes too long (which is where the 'timeout' tag originates) but the
</I>&gt;&gt;&gt;<i> AMQP connection state is 'running' - the second tag. When this condition
</I>&gt;&gt;&gt;<i> arises, the broker's reader process shuts down the connection.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So at first glance, it does look like a networking problem to me,
</I>&gt;&gt;&gt;<i> although TBH I'm not sure about the nature of it just yet. I suspect it
</I>&gt;&gt;&gt;<i> could have something to do with &quot;... It can sometimes be several minutes
</I>&gt;&gt;&gt;<i> before a message is acked or nacked ...&quot;.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It happens more frequently when the system is busy (500-1000
</I>&gt;&gt;&gt;&gt;<i> messages/s) than when it is cruising (50 messages/s). The application
</I>&gt;&gt;&gt;&gt;<i> and RabbitMQ are on the same box so I don't think its a
</I>&gt;&gt;&gt;&gt;<i> networking/firewall problem.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The application only uses one connection and one channel. Messages are
</I>&gt;&gt;&gt;&gt;<i> received using Connection.basicConsume(..) and acked or nacked
</I>&gt;&gt;&gt;&gt;<i> sometime later on different threads. It can sometimes be several
</I>&gt;&gt;&gt;&gt;<i> minutes before a message is acked or nacked. We are using
</I>&gt;&gt;&gt;&gt;<i> Connection.basicQos(10000) to limit the number of outstanding messages
</I>&gt;&gt;&gt;&gt;<i> but its not often that reaches 10000 and the error happens anytime.
</I>&gt;&gt;&gt;&gt;<i> There is defensive code to make sure messages are not acked/nacked
</I>&gt;&gt;&gt;&gt;<i> more than once.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Anyone have any ideas? Is there any way to get more information on the
</I>&gt;&gt;&gt;&gt;<i> server or client side regarding the error?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Well the server error seems pretty clear and just to be 100% sure, I can
</I>&gt;&gt;&gt;<i> verify that the error message you're seeing is only generated in one
</I>&gt;&gt;&gt;<i> place in the whole code base:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_reader.erl#L241.">https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_reader.erl#L241.</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Except that this isn't quite as clear as I suggested initially. The
</I>&gt;&gt;<i> networking layer isn't going to send a timeout on a blocking receive
</I>&gt;&gt;<i> like this - the 'timeout' message is being sent to the reader from some
</I>&gt;&gt;<i> other process. I will investigate further! :)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Ok so I think I've identified the source of this behaviour. The 'timeout'
</I>&gt;<i> message is sent to the reader process by the AMQP heartbeat - a separate out
</I>&gt;<i> of band process that is monitoring for 'stale' connections using heartbeat
</I>&gt;<i> frames (see <A HREF="http://www.rabbitmq.com/amqp-0-9-1-reference.html">http://www.rabbitmq.com/amqp-0-9-1-reference.html</A> for details).
</I>&gt;<i>
</I>&gt;<i> What I believe is happening is that as the server comes under load, the
</I>&gt;<i> heartbeat for this connection is de-prioritised at the network layer and
</I>&gt;<i> times out, causing the connection to be closed.
</I>&gt;<i>
</I>&gt;<i> Set your heartbeat to 0 (turning it off) for now and see if it fixes the
</I>&gt;<i> problem? That's a short term investigative step though, obviously.
</I>&gt;<i>
</I>&gt;<i> I'll file a bug for improving the log messages when timeout occurs.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> The code handling the timeout condition is
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_reader.erl#L321,">https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_reader.erl#L321,</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> the call site for which is
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_reader.erl#L284.">https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_reader.erl#L284.</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The origin of this is
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_net.erl#L108">https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_net.erl#L108</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> in rabbit_net - what the code does is make the calling process wait for
</I>&gt;&gt;&gt;<i> a message from the Erlang networking layer. So it is the underlying
</I>&gt;&gt;&gt;<i> TCP/IP layer in Erlang which is noticing a timeout on the connection.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> How this is mediated through the client's behaviour is another matter.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hope this helps us get started figuring out what's wrong!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Cheers,
</I>&gt;&gt;&gt;<i> Tim
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> RabbitMQ 2.8.1 on Gentoo Linux 64bit
</I>&gt;&gt;&gt;&gt;<i> Erlang R15B (erts-5.9) [source] [64-bit]
</I>&gt;&gt;&gt;&gt;<i> amqp-client-2.8.2 (also tried amqp-client-2.7.1)
</I>&gt;&gt;&gt;&gt;<i> java version &quot;1.6.0_31&quot;
</I>&gt;&gt;&gt;&gt;<i> Java(TM) SE Runtime Environment (build 1.6.0_31-b04)
</I>&gt;&gt;&gt;&gt;<i> Java HotSpot(TM) 64-Bit Server VM (build 20.6-b01, mixed mode)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thanks
</I>&gt;&gt;&gt;&gt;<i> David
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>


-- 
<A HREF="http://twoogleplus.com/">http://twoogleplus.com/</A> Online service to cross-post tweets to Google+
<A HREF="http://engage.calibreapps.com/">http://engage.calibreapps.com/</A> Engage - Web based goal setting and
performance management
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020236.html">[rabbitmq-discuss] RabbitMQ server closing connection every few minutes
</A></li>
	<LI>Next message: <A HREF="020241.html">[rabbitmq-discuss] rabbitmq for HA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20247">[ date ]</a>
              <a href="thread.html#20247">[ thread ]</a>
              <a href="subject.html#20247">[ subject ]</a>
              <a href="author.html#20247">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
