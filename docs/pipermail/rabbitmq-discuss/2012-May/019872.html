<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] please help understanding why my pool of	channels are blocking.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20please%20help%20understanding%20why%20my%20pool%20of%0A%09channels%20are%20blocking.&In-Reply-To=%3C6226D9BC-C0D6-472F-B9F0-ECA95B624558%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019839.html">
   <LINK REL="Next"  HREF="019873.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] please help understanding why my pool of	channels are blocking.</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20please%20help%20understanding%20why%20my%20pool%20of%0A%09channels%20are%20blocking.&In-Reply-To=%3C6226D9BC-C0D6-472F-B9F0-ECA95B624558%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] please help understanding why my pool of	channels are blocking.">steve at rabbitmq.com
       </A><BR>
    <I>Fri May  4 12:01:15 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019839.html">[rabbitmq-discuss] please help understanding why my pool of	channels are blocking.
</A></li>
        <LI>Next message: <A HREF="019873.html">[rabbitmq-discuss] please help understanding why my pool of	channels are blocking.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19872">[ date ]</a>
              <a href="thread.html#19872">[ thread ]</a>
              <a href="subject.html#19872">[ subject ]</a>
              <a href="author.html#19872">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Guatam,

At first sight, this looks like it should work -- your (large) number of
tasks, will get gated through the 20 threads, which will use the 50
channels. It ought to be the case that there are always more than enough
channels to be 'in use' at any one time. The thread pool will dispatch
the tasks to threads as they become available....

I'll experiment to see if I can reproduce your experience, and get back
to you next week (after the bank holiday w/e here).

Steve Powell  (a happy bunny)
----------some more definitions from the SPD----------
chinchilla (n.) Cooling device for the lower jaw.
socialcast (n.) Someone to whom everyone is speaking but nobody likes.
literacy (n.) A textually transmitted disease usually contracted in childhood.

On 3 May 2012, at 04:34, Gautam Bakshi wrote:

&gt;<i> Hi Everyone,
</I>&gt;<i> 
</I>&gt;<i> I'm playing around with Rabbitmq(sorry for flooding the list lately) and am having some weird problems in my tests.  I have a multi-threaded application that I was considering using rabbitmq to manage the queue but I'm getting alot of blocking between my channels.  Is there a preferred way to setup pools?
</I>&gt;<i> 
</I>&gt;<i> I'm a bit new to Java so I used to the pools from apache commons but when I profile the channels are all blocking each other.  To test if dedicated connections per thread worked better I made an example of it as well and it does not block when the same program has a single channel per connection.  
</I>&gt;<i> 
</I>&gt;<i> So my question, do channels block each other or am I doing something wrong(using java api wrong or misunderstanding connection/channels)?  Is there a more preferred way? Unrelated to the question, but I was also wondering is there any difference between channels and connections in terms of throughput(i.e. would there be any benefit of using dedicated connections ignoring the overhead in establishing/maintaining the connection)?
</I>&gt;<i> 
</I>&gt;<i> Here's the test code(it simply sends to a thread a bunch of data to write the queue). If it helps I'm using v2.7.1, installed from MacPorts):
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> import org.apache.commons.pool.BasePoolableObjectFactory;
</I>&gt;<i> import org.apache.commons.pool.ObjectPool;
</I>&gt;<i> import org.apache.commons.pool.PoolableObjectFactory;
</I>&gt;<i> import org.apache.commons.pool.impl.GenericObjectPool;
</I>&gt;<i> 
</I>&gt;<i> import java.io.IOException;
</I>&gt;<i> import java.util.NoSuchElementException;
</I>&gt;<i> import java.util.Set;
</I>&gt;<i> import java.util.concurrent.ExecutorService;
</I>&gt;<i> import java.util.concurrent.Executors;
</I>&gt;<i> import java.util.concurrent.LinkedBlockingDeque;
</I>&gt;<i> import java.util.concurrent.ThreadPoolExecutor;
</I>&gt;<i> import java.util.concurrent.TimeUnit;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> import com.rabbitmq.client.ConnectionFactory;
</I>&gt;<i> import com.rabbitmq.client.Connection;
</I>&gt;<i> import com.rabbitmq.client.Channel;
</I>&gt;<i> import com.rabbitmq.client.MessageProperties;
</I>&gt;<i> 
</I>&gt;<i> public class PoolExample {
</I>&gt;<i>     
</I>&gt;<i> 	private static ExecutorService executor_worker;
</I>&gt;<i> 	
</I>&gt;<i> 	static {
</I>&gt;<i>         final int numberOfThreads_ThreadPoolExecutor = 20;
</I>&gt;<i>         executor_worker = Executors.newFixedThreadPool(numberOfThreads_ThreadPoolExecutor);
</I>&gt;<i> 	}
</I>&gt;<i> 	
</I>&gt;<i>     public static void main(String[] args) throws Exception {
</I>&gt;<i>     	System.out.println(&quot;starting..&quot;); 	   		
</I>&gt;<i>     	ObjectPool&lt;Channel&gt; pool =
</I>&gt;<i>                 new GenericObjectPool&lt;Channel&gt;(
</I>&gt;<i>                 new ConnectionPoolableObjectFactory(), 50);
</I>&gt;<i>     	for (int x = 0; x&lt;500000000; x++) {
</I>&gt;<i>     		executor_worker.submit(new MyRunnable(x, pool));
</I>&gt;<i>     	}
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> /*
</I>&gt;<i>  //this is a version that creates its own connection per channel
</I>&gt;<i>  class ConnectionPoolableObjectFactory
</I>&gt;<i>         extends BasePoolableObjectFactory&lt;Channel&gt; {
</I>&gt;<i> 
</I>&gt;<i>     private static final ConnectionFactory factory = newConnectionFactory();
</I>&gt;<i> 
</I>&gt;<i>     private static ConnectionFactory newConnectionFactory() {
</I>&gt;<i>         ConnectionFactory factory = new ConnectionFactory();
</I>&gt;<i>         factory.setHost(&quot;localhost&quot;);
</I>&gt;<i>         return factory;
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>     @Override
</I>&gt;<i>     public Channel makeObject() throws Exception {
</I>&gt;<i>         System.out.println(&quot;new channel&quot;);
</I>&gt;<i>     	return factory.newConnection().createChannel();
</I>&gt;<i>         
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>     @Override
</I>&gt;<i>     public boolean validateObject(Channel channel) {
</I>&gt;<i>         return channel.isOpen();
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>     @Override
</I>&gt;<i>     public void destroyObject(Channel channel) throws Exception {
</I>&gt;<i>     	System.out.println(&quot;closing&quot;);
</I>&gt;<i>         channel.close();
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>     @Override
</I>&gt;<i>     public void passivateObject(Channel channel) throws Exception {
</I>&gt;<i>         //System.out.println(&quot;sent back to queue&quot;);
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i> */
</I>&gt;<i> 
</I>&gt;<i> //this version pools channels 
</I>&gt;<i> class ConnectionPoolableObjectFactory extends BasePoolableObjectFactory&lt;Channel&gt; {
</I>&gt;<i> 
</I>&gt;<i> 	private final Connection connection;
</I>&gt;<i> 
</I>&gt;<i> 	ConnectionPoolableObjectFactory() throws IOException {
</I>&gt;<i> 		ConnectionFactory factory = new ConnectionFactory();
</I>&gt;<i> 		factory.setHost(&quot;localhost&quot;);
</I>&gt;<i> 		connection = factory.newConnection();
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	@Override
</I>&gt;<i> 	public Channel makeObject() throws Exception {
</I>&gt;<i> 		return connection.createChannel();
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	@Override
</I>&gt;<i> 	public boolean validateObject(Channel channel) {
</I>&gt;<i> 		return channel.isOpen();
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	@Override
</I>&gt;<i> 	public void destroyObject(Channel channel) throws Exception {
</I>&gt;<i> 		channel.close();
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	@Override
</I>&gt;<i> 	public void passivateObject(Channel channel) throws Exception {
</I>&gt;<i> 		//do nothing
</I>&gt;<i> 	}
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> class MyRunnable implements Runnable{  
</I>&gt;<i> 	protected int x = 0;
</I>&gt;<i> 	protected ObjectPool&lt;Channel&gt; pool;
</I>&gt;<i> 	
</I>&gt;<i>     public MyRunnable(int x, ObjectPool&lt;Channel&gt; pool) {
</I>&gt;<i> 		// TODO Auto-generated constructor stub
</I>&gt;<i>     	this.x = x;
</I>&gt;<i>     	this.pool = pool;
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	public void run(){
</I>&gt;<i>         try {
</I>&gt;<i>                 Channel channel = pool.borrowObject();
</I>&gt;<i>             	String message = Integer.toString(x);
</I>&gt;<i>             	channel.basicPublish( &quot;&quot;, &quot;task_queue&quot;, 
</I>&gt;<i>                         MessageProperties.PERSISTENT_TEXT_PLAIN,
</I>&gt;<i>                         message.getBytes());
</I>&gt;<i>             	pool.returnObject(channel);
</I>&gt;<i> 		} catch (NoSuchElementException e) {
</I>&gt;<i> 			// TODO Auto-generated catch block
</I>&gt;<i> 			e.printStackTrace();
</I>&gt;<i> 		} catch (IllegalStateException e) {
</I>&gt;<i> 			// TODO Auto-generated catch block
</I>&gt;<i> 			e.printStackTrace();
</I>&gt;<i> 		} catch (Exception e) {
</I>&gt;<i> 			// TODO Auto-generated catch block
</I>&gt;<i> 			e.printStackTrace();
</I>&gt;<i> 		} 
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120504/9a50fcd0/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120504/9a50fcd0/attachment.htm</A>&gt;
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019839.html">[rabbitmq-discuss] please help understanding why my pool of	channels are blocking.
</A></li>
	<LI>Next message: <A HREF="019873.html">[rabbitmq-discuss] please help understanding why my pool of	channels are blocking.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19872">[ date ]</a>
              <a href="thread.html#19872">[ thread ]</a>
              <a href="subject.html#19872">[ subject ]</a>
              <a href="author.html#19872">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
