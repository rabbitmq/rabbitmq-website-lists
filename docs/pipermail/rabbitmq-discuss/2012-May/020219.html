<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Silent crash causes persistent durable message loss
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Silent%20crash%20causes%20persistent%20durable%0A%20message%20loss&In-Reply-To=%3C4FBAAA97.5030808%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020218.html">
   <LINK REL="Next"  HREF="020220.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Silent crash causes persistent durable message loss</H1>
    <B>Francesco Mazzoli</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Silent%20crash%20causes%20persistent%20durable%0A%20message%20loss&In-Reply-To=%3C4FBAAA97.5030808%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Silent crash causes persistent durable message loss">francesco at rabbitmq.com
       </A><BR>
    <I>Mon May 21 21:50:31 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020218.html">[rabbitmq-discuss] Silent crash causes persistent durable message	loss
</A></li>
        <LI>Next message: <A HREF="020220.html">[rabbitmq-discuss] Silent crash causes persistent durable message loss
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20219">[ date ]</a>
              <a href="thread.html#20219">[ thread ]</a>
              <a href="subject.html#20219">[ subject ]</a>
              <a href="author.html#20219">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Will,

I have trouble believing that it is actually dying silently silently 
with no information in the logs. Can you try to reproduce it and post 
the logs here?

In the meantime I'm going to do the obvious and suggest to upgrade to 
2.8.2. We fixed several ugly bugs related to DLX (one of which was 
particularly easy to get) and they might be related to your problem.

Francesco.

On 21/05/12 20:22, Will Koffel wrote:
&gt;<i> How's that for a useless mysterious title? A bit more on what we're seeing:
</I>&gt;<i>
</I>&gt;<i> I'm running 2.8.1, and I have one queue in our setup with a long TTL
</I>&gt;<i> (&quot;expiring-queue&quot;, we'll call it), which then uses dead-letter-exchange
</I>&gt;<i> to reroute to another queue (&quot;action-queue&quot;). The TTL for these expiring
</I>&gt;<i> messages is 7 days. So it looks like this:
</I>&gt;<i>
</I>&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ec2-user at web03</A> current]$ sudo rabbitmqctl list_queues name messages
</I>&gt;<i> arguments durable
</I>&gt;<i> expiring-queue311443[{&quot;x-dead-letter-exchange&quot;,&quot;my-exchange&quot;},{&quot;x-message-ttl&quot;,604800000},{&quot;x-dead-letter-routing-key&quot;,&quot;action-queue&quot;}]true
</I>&gt;<i> action-queue0[]true
</I>&gt;<i>
</I>&gt;<i> (BTW, What I'm doing is using the TTL as a way to keep track of an event
</I>&gt;<i> that expires after one week. Namely, we keep a count of a particular
</I>&gt;<i> event for the last 7 days. So each time the event happens we write to
</I>&gt;<i> the action-queue which increments the value, and to the expiring queue.
</I>&gt;<i> 7 days later, that message gets expired into the action-queue again, and
</I>&gt;<i> we decrement the counter. So we have a real-time, running 7 day counter.)
</I>&gt;<i>
</I>&gt;<i> This for the most part is stable. Except when it's not. We've seen 3 or
</I>&gt;<i> 4 crashes of this system since we set it up 3 weeks ago. I can't find
</I>&gt;<i> any information in the logs to tell me why Rabbit crashed, it just dies
</I>&gt;<i> silently. But more distributing is that when I bring it back up, all the
</I>&gt;<i> messages (typically millions) in the expiring-queue are gone. That's
</I>&gt;<i> death for me, because that's the only record of when those things are
</I>&gt;<i> supposed to expire.
</I>&gt;<i>
</I>&gt;<i> Any leads on where to look for more crash reports or evidence of what's
</I>&gt;<i> happening here? And importantly, in what case would these messages be
</I>&gt;<i> lost (seems like that should never happen!) The queue is durable, and
</I>&gt;<i> I'm using deliveryMode=2 for the messages. I'm pretty sure that
</I>&gt;<i> persistence works in general, because I can stop rabbit and restart it
</I>&gt;<i> and all the messages are still there...they are only lost in the case of
</I>&gt;<i> this odd silent crash. I've also tried doing evil things like kill -9
</I>&gt;<i> various server processes, and haven't been able to reproduce the message
</I>&gt;<i> loss in any controlled environment.
</I>&gt;<i>
</I>&gt;<i> I'm LOVING that this could work in Rabbit with the 2.8 updates, hoping
</I>&gt;<i> to not have to move to another queueing system where I have to build all
</I>&gt;<i> the dead-letter-routing stuff myself, when this is so close to a clean
</I>&gt;<i> solution.
</I>&gt;<i>
</I>&gt;<i> Thanks in advance for any thoughts.
</I>&gt;<i>
</I>&gt;<i> -Will
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ________________
</I>&gt;<i> Will Koffel
</I>&gt;<i> CTO, Thumb&#8482;
</I>&gt;<i> 51 E 12th St., 4th Floor
</I>&gt;<i> New York, NY 10003
</I>&gt;<i> Office: (212) 673-8650
</I>&gt;<i> Mobile: (617) 575-WILL
</I>&gt;<i> @thumb
</I>&gt;<i> www.thumb.it &lt;<A HREF="http://www.thumb.it/">http://www.thumb.it/</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020218.html">[rabbitmq-discuss] Silent crash causes persistent durable message	loss
</A></li>
	<LI>Next message: <A HREF="020220.html">[rabbitmq-discuss] Silent crash causes persistent durable message loss
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20219">[ date ]</a>
              <a href="thread.html#20219">[ thread ]</a>
              <a href="subject.html#20219">[ subject ]</a>
              <a href="author.html#20219">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
