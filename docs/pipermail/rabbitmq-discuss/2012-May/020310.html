<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] stomp+ssl message send works,	receive hangs after around 200-300 messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20stomp%2Bssl%20message%20send%20works%2C%0A%09receive%20hangs%20after%20around%20200-300%20messages&In-Reply-To=%3CF8689F9E-EC1C-403F-8296-5D4D6F15C8ED%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020305.html">
   <LINK REL="Next"  HREF="020294.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] stomp+ssl message send works,	receive hangs after around 200-300 messages</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20stomp%2Bssl%20message%20send%20works%2C%0A%09receive%20hangs%20after%20around%20200-300%20messages&In-Reply-To=%3CF8689F9E-EC1C-403F-8296-5D4D6F15C8ED%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] stomp+ssl message send works,	receive hangs after around 200-300 messages">steve at rabbitmq.com
       </A><BR>
    <I>Thu May 24 17:08:09 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020305.html">[rabbitmq-discuss] stomp+ssl message send works, receive hangs after around 200-300 messages
</A></li>
        <LI>Next message: <A HREF="020294.html">[rabbitmq-discuss] Connections in state &quot;flow&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20310">[ date ]</a>
              <a href="thread.html#20310">[ thread ]</a>
              <a href="subject.html#20310">[ subject ]</a>
              <a href="author.html#20310">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Michael,

Thank you for the further information, this has got us a bit puzzled.

It was a long shot, and my colleagues don't think that ACKs ought to
have been blocked, but I'm glad you at least have a work-around. Are the
SUBSCRIBER STOMP clients SENDing anything (or writing other things) on
the same connection, by any chance? If they are this could explain it,
and the problem ought to be fixed in the next release. The
hanging/jamming problem occurs (apparently) only when sending STOMP
frames that have content and an explicit length header (and other
'high-load' things happen at the same time). But I asked you to try it
anyway.

&gt;<i> Non-SSL connections pass the same tests without problems.
</I>
This may be because an SSL connection has a higher 'loading' on
resources, but I'm not sure why this should be.

&gt;<i> Setting prefetch-count=2 fixed it, many thanks ! Could this also affect
</I>&gt;<i> transactions, where a commit is sent instead of ack frames?
</I>
If it is the problem I think it is, then yes, but your question makes me
wonder if you remember that ACKs are transactional, not the consuming of
the messages, so you should not think of commit as doing an implicit
ACK: it doesn't. In particular, rollback does not re-queue un-acked
messages. Rollback will 'undo' any acknowledgements made in this
transaction (and, in RabbitMQ, any rejects, too). I'm sure you know
this, but your use of the word 'instead' got me worried. :-)

The bug that I know we've fixed is likely to 'hang' a STOMP frame that
occurs at the end of a buffer, after a particular 'throttling' effect
occurs. This ought not to be frame-specific, so whether we are
transactional or not shouldn't be relevant.

However, I know I'm not speaking for all of us, here, and it still may
not be this bug you are experiencing.

Steve Powell  (a happy bunny)
----------yet more definitions from the SPD----------
corrugate (n.) T.V. soap scandal.
olympic (n.) A camp road-digger.
jamboree (n.) A conserve made from French cheese.

On 24 May 2012, at 13:10, Michael Justin wrote:

&gt;<i> Am 23.05.2012 17:52, Steve Powell wrote:
</I>&gt;&gt;<i> Michael,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks for the update. Can you be a little more specific about the
</I>&gt;&gt;<i> set-up that fails?
</I>&gt;<i> 
</I>&gt;<i> Many thanks for your answer and your suggestion, it is working now - with prefetch-count=2.
</I>&gt;<i> 
</I>&gt;<i> Maybe it is helpful, here is some information from my tests and answers to your questions:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> In particular I would like to know:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> -  the version of Erlang you are using, and the (v)hardware you are
</I>&gt;&gt;<i>    running RabbitMQ on (a copy of the startup log would be nice);
</I>&gt;<i> 
</I>&gt;<i> The startup log is at the end, Erlang version is 5.9.1, machine is a Compaq 6820s Laptop (Intel Core 2 Duo T8100 2.1 GHz)
</I>&gt;<i> 
</I>&gt;&gt;<i> -  if the problem is noticed on a non-ssl connection (if you can try
</I>&gt;&gt;<i>    this) -- we haven't seen this particular problem on our tests;
</I>&gt;<i> 
</I>&gt;<i> Non-SSL connections pass the same tests without problems
</I>&gt;<i> 
</I>&gt;&gt;<i> -  are there any messages in the rabbitmq log around the time the
</I>&gt;&gt;<i>    message delivery stops?
</I>&gt;<i> 
</I>&gt;<i> The log is very small, see attached file (after running &gt; 10 tests)
</I>&gt;<i> 
</I>&gt;&gt;<i> -  can you provide more details about the topic subscription --
</I>&gt;&gt;<i>    is this a durable subscription, for example;
</I>&gt;<i> 
</I>&gt;<i> It is a normal queue destination, using persistent messages
</I>&gt;<i> 
</I>&gt;&gt;<i> -  and do the acknowledgements actually get through (you can tell this
</I>&gt;&gt;<i>    if messages you think you have consumed are redelivered on
</I>&gt;&gt;<i>    reconnect)?
</I>&gt;<i> 
</I>&gt;<i> I can see after retrieving around 240 messages (when the client does not longer receive more messages) that about 120 messages are still on the broker, so the acknowledgement of 120 messages did not reach the broker.
</I>&gt;<i> 
</I>&gt;<i> Further debugging showed that the client hangs when sending the acknowledgement frame. Example:
</I>&gt;<i> 
</I>&gt;<i> received:
</I>&gt;<i> MESSAGE
</I>&gt;<i> content-type:text/plain
</I>&gt;<i> subscription:{00AC21DB-D5A3-40C9-97C4-00FCB902634B}
</I>&gt;<i> destination:/queue/ExampleQueue
</I>&gt;<i> message-id:T_{00AC21DB-D5A3-40C9-97C4-00FCB902634B}@@session-ArgQuHJyTPiO2ge46jB
</I>&gt;<i> 4eD@@245
</I>&gt;<i> content-length:255
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Received: Message: 244 sent at: 24.05.2012 13:52:01         ...
</I>&gt;<i> send:
</I>&gt;<i> ACK
</I>&gt;<i> message-id:T_{00AC21DB-D5A3-40C9-97C4-00FCB902634B}@@session-ArgQuHJyTPiO2ge46jB
</I>&gt;<i> 4eD@@245
</I>&gt;<i> subscription:{00AC21DB-D5A3-40C9-97C4-00FCB902634B}
</I>&gt;<i> 
</I>&gt;<i> &lt;-- client frame sent but the socket write operation hangs
</I>&gt;<i> 
</I>&gt;&gt;<i> We have recently discovered (and fixed) a bug in the STOMP client that
</I>&gt;&gt;<i> will stop the broker seeing the last message sent (under load). It is
</I>&gt;&gt;<i> possible that, if pre-fetch is set to 1, this is causing you to jam
</I>&gt;&gt;<i> up -- the STOMP code may not be detecting your last acknowledgement. To
</I>&gt;&gt;<i> confirm this, please try this with a pre-fetch count of zero (or 2 or
</I>&gt;&gt;<i> more) and see if you still get the lock-up.
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Setting prefetch-count=2 fixed it, many thanks ! Could this also affect transactions, where a commit is sent instead of ack frames?
</I>&gt;<i> 
</I>&gt;<i> Regards
</I>&gt;<i> 
</I>&gt;<i> Michael Justin
</I>&gt;<i> 
</I>&gt;<i> ---
</I>&gt;<i> 
</I>&gt;<i> Startup log
</I>&gt;<i> 
</I>&gt;<i> Activating RabbitMQ plugins ...
</I>&gt;<i> 7 plugins activated:
</I>&gt;<i> * amqp_client-2.8.2
</I>&gt;<i> * mochiweb-1.3-rmq2.8.2-git
</I>&gt;<i> * rabbitmq_management-2.8.2
</I>&gt;<i> * rabbitmq_management_agent-2.8.2
</I>&gt;<i> * rabbitmq_mochiweb-2.8.2
</I>&gt;<i> * rabbitmq_stomp-2.8.2
</I>&gt;<i> * webmachine-1.7.0-rmq2.8.2-hg
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> +---+   +---+
</I>&gt;<i> |   |   |   |
</I>&gt;<i> |   |   |   |
</I>&gt;<i> |   |   |   |
</I>&gt;<i> |   +---+   +-------+
</I>&gt;<i> |                   |
</I>&gt;<i> | RabbitMQ  +---+   |
</I>&gt;<i> |           |   |   |
</I>&gt;<i> |   v2.8.2  +---+   |
</I>&gt;<i> |                   |
</I>&gt;<i> +-------------------+
</I>&gt;<i> AMQP 0-9-1 / 0-9 / 0-8
</I>&gt;<i> Copyright (C) 2007-2012 VMware, Inc.
</I>&gt;<i> Licensed under the MPL.  See <A HREF="http://www.rabbitmq.com/">http://www.rabbitmq.com/</A>
</I>&gt;<i> 
</I>&gt;<i> node           : <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MJ-PC</A>
</I>&gt;<i> app descriptor : c:/Java/rabbitmq_server-2.8.2/sbin/../ebin/rabbit.app
</I>&gt;<i> home dir       : C:\Users\mj
</I>&gt;<i> config file(s) : c:/Users/mj/AppData/Roaming/RabbitMQ/rabbitmq.config
</I>&gt;<i> cookie hash    : WjOr7YEHHESuUkR1mMuR+g==
</I>&gt;<i> log            : C:/Users/mj/AppData/Roaming/RabbitMQ/log/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MJ-PC.log</A>
</I>&gt;<i> sasl log       : C:/Users/mj/AppData/Roaming/RabbitMQ/log/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MJ-PC-sasl.log</A>
</I>&gt;<i> database dir   : c:/Users/mj/AppData/Roaming/RabbitMQ/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MJ-PC-mnesia</A>
</I>&gt;<i> erlang version : 5.9.1
</I>&gt;<i> 
</I>&gt;<i> -- rabbit boot start
</I>&gt;<i> starting file handle cache server ...done
</I>&gt;<i> starting worker pool ...done
</I>&gt;<i> starting database ...done
</I>&gt;<i> starting database sync ...done
</I>&gt;<i> starting codec correctness check ...done
</I>&gt;<i> -- external infrastructure ready
</I>&gt;<i> starting plugin registry ...done
</I>&gt;<i> starting auth mechanism cr-demo ...done
</I>&gt;<i> starting auth mechanism amqplain ...done
</I>&gt;<i> starting auth mechanism plain ...done
</I>&gt;<i> starting statistics event manager ...done
</I>&gt;<i> starting logging server ...done
</I>&gt;<i> starting exchange type direct ...done
</I>&gt;<i> starting exchange type fanout ...done
</I>&gt;<i> starting exchange type headers ...done
</I>&gt;<i> starting exchange type topic ...done
</I>&gt;<i> -- kernel ready
</I>&gt;<i> starting alarm handler ...done
</I>&gt;<i> starting node monitor ...done
</I>&gt;<i> starting cluster delegate ...done
</I>&gt;<i> starting guid generator ...done
</I>&gt;<i> starting memory monitor ...done
</I>&gt;<i> -- core initialized
</I>&gt;<i> starting management agent ...done
</I>&gt;<i> starting exchange, queue and binding recovery ...done
</I>&gt;<i> starting configured definitions ...done
</I>&gt;<i> starting empty DB check ...done
</I>&gt;<i> starting mirror queue slave sup ...done
</I>&gt;<i> starting adding mirrors to queues ...done
</I>&gt;<i> -- message delivery logic ready
</I>&gt;<i> starting error log relay ...done
</I>&gt;<i> starting networking ...done
</I>&gt;<i> starting direct client ...done
</I>&gt;<i> starting notify cluster nodes ...done
</I>&gt;<i> 
</I>&gt;<i> broker running
</I>&gt;<i> ** Found 0 name clashes in code paths
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Michael Justin
</I>&gt;<i> habarisoft - Enterprise Messaging Software for Delphi
</I>&gt;<i> <A HREF="http://www.habarisoft.com/">http://www.habarisoft.com/</A>
</I>&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MJ-PC.log</A>&gt;
</I>
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020305.html">[rabbitmq-discuss] stomp+ssl message send works, receive hangs after around 200-300 messages
</A></li>
	<LI>Next message: <A HREF="020294.html">[rabbitmq-discuss] Connections in state &quot;flow&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20310">[ date ]</a>
              <a href="thread.html#20310">[ thread ]</a>
              <a href="subject.html#20310">[ subject ]</a>
              <a href="author.html#20310">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
