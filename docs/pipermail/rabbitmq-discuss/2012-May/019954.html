<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Stale connections when using rabbitmq
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stale%20connections%20when%20using%20rabbitmq&In-Reply-To=%3C9f89e912-8e35-4a86-9bfe-5f07908c6e1a%40e9g2000yqm.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020011.html">
   <LINK REL="Next"  HREF="019956.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Stale connections when using rabbitmq</H1>
    <B>Venkat</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stale%20connections%20when%20using%20rabbitmq&In-Reply-To=%3C9f89e912-8e35-4a86-9bfe-5f07908c6e1a%40e9g2000yqm.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Stale connections when using rabbitmq">s.ramanan.venkata at gmail.com
       </A><BR>
    <I>Wed May  9 07:35:25 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020011.html">[rabbitmq-discuss] Stomp Javascript Client
</A></li>
        <LI>Next message: <A HREF="019956.html">[rabbitmq-discuss] Stale connections when using rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19954">[ date ]</a>
              <a href="thread.html#19954">[ thread ]</a>
              <a href="subject.html#19954">[ subject ]</a>
              <a href="author.html#19954">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have a web server which communicates with my backend using rabbitmq.
The web server receives req at the rate of 3000/sec. I had a rabbitmq
server on 8GB i7 machine. I saw rabbitmq refusing further connections
after a while. When I did rabbitmqctl list_connections, I saw lot of
connections in 'blocked'/'blocking' state. I recently moved from
memcache based queue for want of async nature. Please suggest me ways
to debug this situation.

[Note: I reduced the RAM to 2GB to reproduce it quicker]

Listing connections ...
guest			blocked
guest			blocked
guest	172.16.223.114	51914	blocked
guest	172.16.223.113	33600	blocked
guest	172.16.223.114	46209	blocked
guest	172.16.223.114	53108	blocked
guest	172.16.223.114	52984	blocked
guest	172.16.223.114	52310	blocked
guest	172.16.223.114	51776	blocked
guest			blocked
guest	172.16.223.114	52390	blocked
guest			blocked
guest	172.16.223.114	53374	blocked
guest	172.16.223.114	53252	blocked
guest			blocked
guest	172.16.223.114	39293	blocking
guest	172.16.223.114	52772	blocked
guest	172.16.223.114	52000	blocked
guest			blocked
guest	172.16.223.114	53072	blocked
guest	172.16.223.114	52852	blocked
guest	172.16.223.114	51862	blocked
guest	172.16.223.114	53601	blocked
guest			blocked
guest	172.16.223.114	52258	blocked
guest			blocked
guest			blocked
guest	172.16.223.114	39286	blocked
guest	172.16.223.114	53200	blocked
guest			blocked
guest	172.16.223.114	51746	blocked
guest	172.16.223.114	52940	blocked
guest	172.16.223.114	32803	blocked
guest	172.16.223.114	53020	blocked
guest	172.16.223.114	52346	blocked

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at testmachine3</A>:~/$ sudo rabbitmqctl list_connections | wc -l
830

sudo rabbitmqctl status
Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at testmachine3</A> ...
[{pid,939},
 {running_applications,[{rabbit,&quot;RabbitMQ&quot;,&quot;2.7.1&quot;},
                        {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.4.17&quot;},
                        {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.5&quot;},
                        {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.9.3&quot;},
                        {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.17.3&quot;},
                        {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.14.3&quot;}]},
 {os,{unix,linux}},
 {erlang_version,&quot;Erlang R14B02 (erts-5.8.3) [source] [64-bit] [smp:
2:2] [rq:2] [async-threads:30] [kernel-poll:true]\n&quot;},
 {memory,[{total,1626268744},
          {processes,1296143128},
          {processes_used,1296128032},
          {system,330125616},
          {atom,3600969},
          {atom_used,3573207},
          {binary,6811184},
          {code,11216694},
          {ets,305365584}]},
 {vm_memory_high_watermark,0.4},
 {vm_memory_limit,1593409536}]
...done.

When my web server tries to connect to rabbitmq at this stage it give
me the following exception.

  File &quot;/usr/local/lib/python2.7/dist-packages/msgbroker.py&quot;, line
194, in __init__
    self.connection =
pika.BlockingConnection(pika.ConnectionParameters(host=host_server))

  File &quot;/usr/local/lib/python2.7/dist-packages/pika/adapters/
blocking_connection.py&quot;, line 32, in __init__
    BaseConnection.__init__(self, parameters, None,
reconnection_strategy)

  File &quot;/usr/local/lib/python2.7/dist-packages/pika/adapters/
base_connection.py&quot;, line 50, in __init__
    reconnection_strategy)

  File &quot;/usr/local/lib/python2.7/dist-packages/pika/connection.py&quot;,
line 170, in __init__
    self._connect()

  File &quot;/usr/local/lib/python2.7/dist-packages/pika/connection.py&quot;,
line 228, in _connect
    self.parameters.port or  spec.PORT)

  File &quot;/usr/local/lib/python2.7/dist-packages/pika/adapters/
blocking_connection.py&quot;, line 44, in _adapter_connect
    self._handle_read()

  File &quot;/usr/local/lib/python2.7/dist-packages/pika/adapters/
base_connection.py&quot;, line 151, in _handle_read
    data = self.socket.recv(self._suggested_buffer_size)

timeout: timed out

Thanks,
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020011.html">[rabbitmq-discuss] Stomp Javascript Client
</A></li>
	<LI>Next message: <A HREF="019956.html">[rabbitmq-discuss] Stale connections when using rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19954">[ date ]</a>
              <a href="thread.html#19954">[ thread ]</a>
              <a href="subject.html#19954">[ subject ]</a>
              <a href="author.html#19954">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
