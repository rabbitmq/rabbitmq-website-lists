<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] .NET Client Library Shared Queue Closed Error on	Subscription When No Msgs in Queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20.NET%20Client%20Library%20Shared%20Queue%20Closed%20Error%20on%0A%09Subscription%20When%20No%20Msgs%20in%20Queue&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000625.html">
   <LINK REL="Next"  HREF="000627.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] .NET Client Library Shared Queue Closed Error on	Subscription When No Msgs in Queue</H1>
    <B>BillC</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20.NET%20Client%20Library%20Shared%20Queue%20Closed%20Error%20on%0A%09Subscription%20When%20No%20Msgs%20in%20Queue&In-Reply-To="
       TITLE="[rabbitmq-discuss] .NET Client Library Shared Queue Closed Error on	Subscription When No Msgs in Queue">billc at inworksol.com
       </A><BR>
    <I>Sun Mar 30 10:25:40 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000625.html">[rabbitmq-discuss] Errors using Windows .NET Client Library
</A></li>
        <LI>Next message: <A HREF="000627.html">[rabbitmq-discuss] .NET Client Library Shared Queue Closed Error on	Subscription When No Msgs in Queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#626">[ date ]</a>
              <a href="thread.html#626">[ thread ]</a>
              <a href="subject.html#626">[ subject ]</a>
              <a href="author.html#626">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please can you help me with the following error.  Using the examples that come with the .NET Cllient Library I have written a small program that creates a subscription and reads any published messages in the queue.  The code works and reads any messages in the queue, however when there are no more messages left to read in the Queue or when you run the program without any messages in the queue (i.e. when the queue is empty) the connection simply closes and throws the following EndOfStreamException:

System.IO.EndOfStreamException: SharedQueue closed
   at RabbitMQ.Util.SharedQueue.EnsureIsOpen()
   at RabbitMQ.Util.SharedQueue.Dequeue()
   at ConsoleApplication2.Program.Main(String[] args) in C:\rabbitmqdotnet\testw
indowsapp\ConsoleApplication2\ConsoleApplication2\Program.cs:line 47

Here is a listing of the source code.  Thanks for all your help.

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using RabbitMQ.Client;
using System.IO;
using RabbitMQ.Client.Content;
using RabbitMQ.Client.Events;
using RabbitMQ.Client.MessagePatterns;
using RabbitMQ.Util;


namespace ConsoleApplication2
{
    class Program
    {
        static void Main(string[] args)
        {

            IProtocol protocol = Protocols.FromConfiguration(&quot;my-protocol&quot;);
            string hostName = &quot;10.10.10.25&quot;;
            int portNumber = 5678;
            string exchangeName = &quot;testexchange&quot;;
            string queueName = &quot;testqueue&quot;;
            string routingKey = &quot;routingkey&quot;;
            ConnectionFactory factory = new ConnectionFactory();
            IConnection conn = factory.CreateConnection(protocol, hostName, portNumber);
            IModel channel = conn.CreateModel();
            string realm = &quot;/data&quot;;
            ushort ticket = channel.AccessRequest(realm);
            channel.ExchangeDeclare(ticket, exchangeName, ExchangeType.Direct);
            channel.QueueDeclare(ticket, queueName);
            channel.QueueBind(ticket, queueName, exchangeName, routingKey, false, null);

            QueueingBasicConsumer consumer = new QueueingBasicConsumer(channel);
            channel.BasicConsume(ticket, queueName, null, consumer);
            Console.WriteLine(&quot;Entering Loop .. Please press Control C to exit&quot;);
            while (true)
            {
                try
                {
                    
                    else
                    {
                        RabbitMQ.Client.Events.BasicDeliverEventArgs e2 =
                        (RabbitMQ.Client.Events.BasicDeliverEventArgs)consumer.Queue.Dequeue();
                        IBasicProperties props = e2.BasicProperties;
                        byte[] body = e2.Body;
                        
                        string str = System.Text.Encoding.UTF8.GetString(body);
                        
                        Console.WriteLine(str);
                        channel.BasicAck(e2.DeliveryTag, false);
                    }
                }
                catch (EndOfStreamException ex)
                {
                    // The consumer was removed, either through
                    // channel or connection closure, or through the
                    // action of IModel.BasicCancel().
                    
                    Console.WriteLine(ex.ToString());
                  break;
                }
            }
        }
    }
}






</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000625.html">[rabbitmq-discuss] Errors using Windows .NET Client Library
</A></li>
	<LI>Next message: <A HREF="000627.html">[rabbitmq-discuss] .NET Client Library Shared Queue Closed Error on	Subscription When No Msgs in Queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#626">[ date ]</a>
              <a href="thread.html#626">[ thread ]</a>
              <a href="subject.html#626">[ subject ]</a>
              <a href="author.html#626">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
