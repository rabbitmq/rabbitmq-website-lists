<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ internal error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20internal%20error&In-Reply-To=47C66821.1000104%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000553.html">
   <LINK REL="Next"  HREF="000556.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ internal error</H1>
    <B>Michael Arnoldus</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20internal%20error&In-Reply-To=47C66821.1000104%40lshift.net"
       TITLE="[rabbitmq-discuss] RabbitMQ internal error">chime at mu.dk
       </A><BR>
    <I>Tue Mar  4 11:01:52 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000553.html">[rabbitmq-discuss] py-amqplib add-on: non-blocking sockets
</A></li>
        <LI>Next message: <A HREF="000556.html">[rabbitmq-discuss] RabbitMQ internal error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#555">[ date ]</a>
              <a href="thread.html#555">[ thread ]</a>
              <a href="subject.html#555">[ subject ]</a>
              <a href="author.html#555">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Found the problem.

Among other things we use AMQP/RabbitMQ as a transport for RPC style  
calls. A fast way to implement this was to create a new anonymous  
queue for the expected reply and then send the queue name in the  
'reply to' field. We did and it worked, however we forgot two things:  
1. Destroy the queue after it was used and 2. set the queue to auto- 
delete so if the module actually crashes, the queues gets deleted  
anyway. We have a watch-dog functionality that will ping all our AMQP  
modules, and in case of no reply (over some time) it will kill the  
module and make it restart.

So when we ran out of queues RabbitMQ simply stopped responding,  
causing the watch-dog to kill the AMQP modules, they will restart and  
try again, ....

The result was a heap of clients and a heap of queues.

The fix was 3 things: Set RPC reply queues to auto-delete, destroy  
them actively after use or timeout, modify the watchdog so it wont  
kill anything unless it's actually able to ping itself through AMQP.

Now everything works with a steady queue count.

Thank to Tony for all the help in finding this bug. Your support is  
awesome!!!

Regards,

Michael Arnoldus

On Feb 28, 2008, at 8:52 , Tony Garnock-Jones wrote:

&gt;<i> Hi Michael,
</I>&gt;<i>
</I>&gt;<i> Michael Arnoldus wrote:
</I>&gt;&gt;<i> Yesterday we experienced another problem with RabbitMQ. Possibly  
</I>&gt;&gt;<i> still our own fault, but this time a bit more severe. Suddenly from  
</I>&gt;&gt;<i> out of the blue it was impossible to send a single message through  
</I>&gt;&gt;<i> Rabbit. Even restart of the components connecting to rabbit didn't  
</I>&gt;&gt;<i> help. The erlang process stayed but didn't seem to work. Killing  
</I>&gt;&gt;<i> the beam process helped and everything returned to normal.
</I>&gt;<i>
</I>&gt;<i> This is extremely interesting.
</I>&gt;<i>
</I>&gt;<i> - What architecture are you running on? Is it a Mac?
</I>&gt;<i> - Was the CPU pinned to 100%?
</I>&gt;<i> - Were you able to issue commands at the Erlang prompt in the server?
</I>&gt;<i>
</I>&gt;<i> We are tracking down what we suspect to be a Mac-specific bug in the  
</I>&gt;<i> Erlang runtime that manifests in some corner-cases of socket  
</I>&gt;<i> shutdown - it would be interesting if you have detected the same  
</I>&gt;<i> thing we're chasing. (We are still in the early stages of our  
</I>&gt;<i> investigation - we can't say for sure yet whether it's really a  
</I>&gt;<i> runtime problem.)
</I>&gt;<i>
</I>&gt;&gt;<i> In a log file we had:
</I>&gt;&gt;<i> ERROR    2008-02-26 16:17:32,857   --call got Closed:  
</I>&gt;&gt;<i> Method(name=close, id=60) (541, 'INTERNAL_ERROR', 0, 0) content =  
</I>&gt;&gt;<i> None
</I>&gt;<i>
</I>&gt;<i> If only the other log files hadn't been stomped on by the broker  
</I>&gt;<i> startup! Your message has prompted us to fix this bad behaviour - we  
</I>&gt;<i> have changed the startup scripts to move existing log files out of  
</I>&gt;<i> the way, keeping the most recent few files.
</I>&gt;<i>
</I>&gt;<i> The INTERNAL_ERROR message is very interesting, because it indicates  
</I>&gt;<i> a real bug in the broker. We don't see it in the case of the Mac bug  
</I>&gt;<i> I mentioned earlier, so you might have found something different.
</I>&gt;<i>
</I>&gt;<i> This is probably the code that ran:
</I>&gt;<i>
</I>&gt;<i> lookup_amqp_exception(Other) -&gt;
</I>&gt;<i>    rabbit_log:warning(&quot;Non-AMQP exit reason '~p'~n&quot;, [Other]),
</I>&gt;<i>    {true, ?INTERNAL_ERROR, &lt;&lt;&quot;INTERNAL_ERROR&quot;&gt;&gt;, none}.
</I>&gt;<i>
</I>&gt;<i> ... which produces a &quot;Non-AMQP exit reason&quot; message in the log. I'm  
</I>&gt;<i> afraid without that message, we'll have a tough time diagnosing this  
</I>&gt;<i> one.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>  Tony
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080304/e520f36a/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080304/e520f36a/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000553.html">[rabbitmq-discuss] py-amqplib add-on: non-blocking sockets
</A></li>
	<LI>Next message: <A HREF="000556.html">[rabbitmq-discuss] RabbitMQ internal error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#555">[ date ]</a>
              <a href="thread.html#555">[ thread ]</a>
              <a href="subject.html#555">[ subject ]</a>
              <a href="author.html#555">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
