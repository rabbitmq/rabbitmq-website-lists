<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] SocketException when invoking	model.BasicPublish
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20SocketException%20when%20invoking%0A%09model.BasicPublish&In-Reply-To=%3CCAJGQrQC6ckw1r73H%2BXv7GDDFZ0n5Rt21DwkAEvZTCeXEEuKa_Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036727.html">
   <LINK REL="Next"  HREF="036731.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] SocketException when invoking	model.BasicPublish</H1>
    <B>Scott McFadden</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20SocketException%20when%20invoking%0A%09model.BasicPublish&In-Reply-To=%3CCAJGQrQC6ckw1r73H%2BXv7GDDFZ0n5Rt21DwkAEvZTCeXEEuKa_Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] SocketException when invoking	model.BasicPublish">scott.kendall.mcfadden at gmail.com
       </A><BR>
    <I>Thu Jun 19 04:00:04 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036727.html">[rabbitmq-discuss] SocketException when invoking model.BasicPublish
</A></li>
        <LI>Next message: <A HREF="036731.html">[rabbitmq-discuss] SocketException when invoking model.BasicPublish
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36730">[ date ]</a>
              <a href="thread.html#36730">[ thread ]</a>
              <a href="subject.html#36730">[ subject ]</a>
              <a href="author.html#36730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the suggestion Michael.  I checked at there is no sharing of the
connection across the thread.  The connection is all self contained to this
method and this method is only invoked once on the thread.  The odd thing
is that this same client code used to work.  It quit working when our
rabbit mq server hyper-v image snapshot got rolled back and I had to
re-install reconfigure rabbit mq.  It makes me think I screwed up the
server side configuration when reinstalling.

private void PublishMessage(byte[] message, Type messageType, string
contentType, string messageId)
        {
            var factory = new ConnectionFactory() {VirtualHost =
this.VirtualHost, HostName = this.Host, UserName = this.User, Password =
this.Password };
            using (var connection = factory.CreateConnection())
            using (var channel = connection.CreateModel())
            {
                IBasicProperties props = channel.CreateBasicProperties();
                props.SetPersistent(this.PersistMessages);

                //Mime time
                props.ContentType = contentType;
                props.Type = messageType.FullName;
                props.MessageId = messageId;

                //
<A HREF="http://www.rabbitmq.com/tutorials/tutorial-three-dotnet.html">http://www.rabbitmq.com/tutorials/tutorial-three-dotnet.html</A>

                //Note, may get AlreadyClosedException here if publishing
to a incorrect exchange name
                channel.BasicPublish(this.ExchangeName, this.RoutingKey,
props, message);
            }
        }


On Wed, Jun 18, 2014 at 9:04 PM, Michael Klishin &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mklishin at gopivotal.com</A>&gt;
wrote:

&gt;<i> On 19 June 2014 at 06:02:28, Scott McFadden (
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">scott.kendall.mcfadden at gmail.com</A>) wrote:
</I>&gt;<i> &gt; &gt; =ERROR REPORT==== 18-Jun-2014(
</I>&gt;<i> <A HREF="http://airmail.calendar/2014-06-18%2012:00:00%20GMT+4">http://airmail.calendar/2014-06-18%2012:00:00%20GMT+4</A>)::20:17:08
</I>&gt;<i> &gt; ===
</I>&gt;<i> &gt; AMQP connection &lt;0.473.0&gt; (running), channel 1 - error:
</I>&gt;<i> &gt; {amqp_error,unexpected_frame,
</I>&gt;<i> &gt; &quot;expected content header for class 60, got non content header
</I>&gt;<i> &gt; frame instead&quot;,
</I>&gt;<i> &gt; 'basic.publish'}
</I>&gt;<i>
</I>&gt;<i> This looks like a well known issue you'll run into if you share a channel
</I>&gt;<i> (IModel) between
</I>&gt;<i> threads, in particular threads that publish messages. This is a
</I>&gt;<i> connection-level error,
</I>&gt;<i> so after getting it RabbitMQ closes the connection and your get socket
</I>&gt;<i> errors on any subsequent
</I>&gt;<i> operation in the client.
</I>&gt;<i>
</I>&gt;<i> Can the cross-thread sharing be the case?
</I>&gt;<i> --
</I>&gt;<i> MK
</I>&gt;<i>
</I>&gt;<i> Software Engineer, Pivotal/RabbitMQ
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140618/baa94e21/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140618/baa94e21/attachment.html</A>&gt;
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036727.html">[rabbitmq-discuss] SocketException when invoking model.BasicPublish
</A></li>
	<LI>Next message: <A HREF="036731.html">[rabbitmq-discuss] SocketException when invoking model.BasicPublish
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36730">[ date ]</a>
              <a href="thread.html#36730">[ thread ]</a>
              <a href="subject.html#36730">[ subject ]</a>
              <a href="author.html#36730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
