<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pause%20minority%20cluster%20with%20publisher%0A%20confirms%20losing%20messages&In-Reply-To=%3CCA%2Bb0Eje2Vx%2B9Tqv95GPSLncGcjuvZ-Frk8XfCtQ0mTSa9VnL7A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036444.html">
   <LINK REL="Next"  HREF="036440.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages</H1>
    <B>Miguel Araujo P&#233;rez</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pause%20minority%20cluster%20with%20publisher%0A%20confirms%20losing%20messages&In-Reply-To=%3CCA%2Bb0Eje2Vx%2B9Tqv95GPSLncGcjuvZ-Frk8XfCtQ0mTSa9VnL7A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages">miguel.araujo.perez at gmail.com
       </A><BR>
    <I>Thu Jun  5 11:38:49 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036444.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
        <LI>Next message: <A HREF="036440.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36481">[ date ]</a>
              <a href="thread.html#36481">[ thread ]</a>
              <a href="subject.html#36481">[ subject ]</a>
              <a href="author.html#36481">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thanks, is there a URL I can access to follow bug status?

&gt;<i> Once a node decides to pause, there may be messages &quot;in flight&quot; that were
</I>already
&gt;<i> read from the socket and parsed, and being delivered to queues. These
</I>processes
&gt;<i> (in both general and Erlang sense) can run in parallel on machines with
</I>over 1 core.

My understanding is that for confirming a message, a node in the cluster
must see the other nodes and get confirmation from them. If that is the
case It makes sense it doesn't confirm messages when iptables rules are
applied and that is what happens after some seconds, when it resumes and
starts confirming messages that are then lost. Not sure I follow how
multiple cores make things harder here, I'm probably not seeing some
concurrent issue here.

I'm attaching Erlang log from node3 here. if you look at it you will see
how first thing it detects is node rabbitmq-2 and rabbitmq-1 are not
responding. Then it promotes mirrored queues from slave to master. Cluster
minority status detected comes last thing.

I'm not an expert in RabbitMQ internals, I've been reading the code parts
that control this flow and it feels like confirms could be paused until
being sure things are ok. I mean if node3 knows it's connected to 2 nodes
(node2 and node1), then sees both nodes down, looks like something is going
wrong.

The part that most strikes me is that it takes 1 minute and 3 seconds to
detect minority since we know both nodes are down?

I will send another email with the Erlang trace.

Thanks, cheers
Miguel


2014-06-04 12:57 GMT+02:00 Michael Klishin &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mklishin at gopivotal.com</A>&gt;:

&gt;<i> On 4 June 2014 at 14:55:57, Miguel Araujo P&#233;rez (
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">miguel.araujo.perez at gmail.com</A>) wrote:
</I>&gt;<i> &gt; &gt; While doing all these tests. Once, when flushing iptables in
</I>&gt;<i> &gt; node3 it has core dumped some Erlang trace. All times before it
</I>&gt;<i> &gt; simply detects network and rejoins cluster without issues.
</I>&gt;<i> &gt; is this something i should report? how?
</I>&gt;<i>
</I>&gt;<i> Miguel,
</I>&gt;<i>
</I>&gt;<i> We have filed a bug for the general issue here. Feel free to post the trace
</I>&gt;<i> you see to the list (unless you think it contains sensitive information,
</I>&gt;<i> which
</I>&gt;<i> is probably doesn't).
</I>&gt;<i> --
</I>&gt;<i> MK
</I>&gt;<i>
</I>&gt;<i> Software Engineer, Pivotal/RabbitMQ
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140605/358c8082/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140605/358c8082/attachment.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: node3.log
Type: application/octet-stream
Size: 2782 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140605/358c8082/attachment.obj">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140605/358c8082/attachment.obj</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036444.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
	<LI>Next message: <A HREF="036440.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36481">[ date ]</a>
              <a href="thread.html#36481">[ thread ]</a>
              <a href="subject.html#36481">[ subject ]</a>
              <a href="author.html#36481">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
