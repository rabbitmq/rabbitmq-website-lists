<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Queue data recovery after master failure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20data%20recovery%20after%20master%20failure&In-Reply-To=%3C53A1B34F.60307%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036710.html">
   <LINK REL="Next"  HREF="036715.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Queue data recovery after master failure</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20data%20recovery%20after%20master%20failure&In-Reply-To=%3C53A1B34F.60307%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Queue data recovery after master failure">simon at rabbitmq.com
       </A><BR>
    <I>Wed Jun 18 16:42:07 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036710.html">[rabbitmq-discuss] Queue data recovery after master failure
</A></li>
        <LI>Next message: <A HREF="036715.html">[rabbitmq-discuss] Queue data recovery after master failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36713">[ date ]</a>
              <a href="thread.html#36713">[ thread ]</a>
              <a href="subject.html#36713">[ subject ]</a>
              <a href="author.html#36713">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/06/14 16:21, Andrei D. wrote:
&gt;<i> Thanks for the quick response Simon.
</I>&gt;<i> I assume there's no easy workaround?
</I>
I can't think of an easy one. If I was desperate then I would try the 
following, assuming we start from a completely stopped cluster:

0) Back up Mnesia dirs on all machines, obviously.

1) Start a slave node with RABBITMQ_NODE_ONLY set. Make sure it is set, 
or the slave will start the rabbit app which will clear out the slave's 
persistent storage, and you restore from 0).

2) Run &quot;rabbitmqctl forget_cluster_node --offline &lt;dead-master&gt;&quot;

3) Start the mnesia app on the slave.

4) Update the rabbit_durable_queue records for queues that need 
recovering from this slave, moving the slave pid for the appropriate 
node() from the 'slave_pids' field to the 'pid' field.

5) Start the rabbit app on the slave.

I think that stands a decent chance of working, but obviously the 
usability of such a solution is exceptionally poor. Step 4) in 
particular would require some Erlang programming.

&gt;<i> (such as manually extracting the queue
</I>&gt;<i> data from the slave and copying it to the new master before it rejoins the
</I>&gt;<i> cluster; I'm not familiar with the rabbit queue data storage format so I'm
</I>&gt;<i> not sure if that's feasible - probably not since you haven't mentioned it ;)
</I>
I'm not sure how well that would work, you'd have the problem that you 
need not just the individual queue's index files but also the files 
containing that queue's messages from the message store. I can't see 
that being fun to sort out.

&gt;<i> ps: couldn't access the 26191 in bugzilla, I assume it's private to
</I>&gt;<i> contributors?
</I>
Yes. But you can look out for it in future release notes, and as a 
branch in hg.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036710.html">[rabbitmq-discuss] Queue data recovery after master failure
</A></li>
	<LI>Next message: <A HREF="036715.html">[rabbitmq-discuss] Queue data recovery after master failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36713">[ date ]</a>
              <a href="thread.html#36713">[ thread ]</a>
              <a href="subject.html#36713">[ subject ]</a>
              <a href="author.html#36713">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
