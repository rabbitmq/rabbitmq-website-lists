<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%7CSpam%7C%20Disk%20mirrored%20queues%20deleting%20messages&In-Reply-To=%3C538F396C.9090203%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036446.html">
   <LINK REL="Next"  HREF="036447.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%7CSpam%7C%20Disk%20mirrored%20queues%20deleting%20messages&In-Reply-To=%3C538F396C.9090203%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages">simon at rabbitmq.com
       </A><BR>
    <I>Wed Jun  4 16:21:16 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036446.html">[rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages
</A></li>
        <LI>Next message: <A HREF="036447.html">[rabbitmq-discuss] Autorecovery Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36456">[ date ]</a>
              <a href="thread.html#36456">[ thread ]</a>
              <a href="subject.html#36456">[ subject ]</a>
              <a href="author.html#36456">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>No, it's not.

You can wait for queues to synchronise due to consumers draining 
messages, or you can explicitly synchronise the queue after restarting 
the first node (manually or automatically).

In Mercurial (and thus eventually in 3.4.0 when it is released) RabbitMQ 
will by default shut down a mirrored queue when the master gracefully 
shuts down and there are only unsynchronised slaves to fail over to, 
since people do tend to trip over this.

Cheers, Simon

On 04/06/14 12:27, Dan C wrote:
&gt;<i> OK!
</I>&gt;<i>
</I>&gt;<i> Thanks for the fast answer!
</I>&gt;<i> I was noticing that but I didn't know it &quot;officially&quot;.
</I>&gt;<i>
</I>&gt;<i> Do you know if this behabiour is different in newer rabbitmq versions?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, Jun 4, 2014 at 1:13 PM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     Please read: <A HREF="http://www.rabbitmq.com/ha.__html#unsynchronised-slaves">http://www.rabbitmq.com/ha.__html#unsynchronised-slaves</A>
</I>&gt;<i>     &lt;<A HREF="http://www.rabbitmq.com/ha.html#unsynchronised-slaves">http://www.rabbitmq.com/ha.html#unsynchronised-slaves</A>&gt;
</I>&gt;<i>
</I>&gt;<i>     (and also: there have been quite a few fixes to mirrored queues
</I>&gt;<i>     since 3.1.5, you are strongly advised to upgrade)
</I>&gt;<i>
</I>&gt;<i>     Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     On 04/06/14 12:08, Dan C wrote:
</I>&gt;<i>
</I>&gt;<i>         Hi,
</I>&gt;<i>
</I>&gt;<i>         I'm doing some testing with rabbitmq 3.1.5 .
</I>&gt;<i>         I don't know if I am doing something wrong or it is the normal
</I>&gt;<i>         behabiour, but, when I setup a 2 nodes cluster, both to disk and
</I>&gt;<i>         everytghing persistent, and withe the policy:
</I>&gt;<i>         rabbitmqctl set_policy  ha-all &quot;^ha_&quot; '{&quot;ha-mode&quot;:&quot;all&quot;}'
</I>&gt;<i>
</I>&gt;<i>         The system does something I don't understand.
</I>&gt;<i>         If I create and send messages to a &quot;ha_helloworld&quot; queue those
</I>&gt;<i>         messages
</I>&gt;<i>         are sent to both nodes, and I can see how both nodes save those
</I>&gt;<i>         messages
</I>&gt;<i>         to disc as I can see how the &quot;mnesia&quot; directory grows.
</I>&gt;<i>         If I stop one of the nodes the space of &quot;mnesia&quot; in that node
</I>&gt;<i>         increase
</I>&gt;<i>         (?&#191;), but when I start it again it will just decrease and lose
</I>&gt;<i>         all messages.
</I>&gt;<i>
</I>&gt;<i>         Now, If I were to do the same with the second node, with the
</I>&gt;<i>         first node
</I>&gt;<i>         already restarted, the second node will just loose all messages
</I>&gt;<i>         to, so I
</I>&gt;<i>         will be losing all messages from the cluster.
</I>&gt;<i>
</I>&gt;<i>         I'll show the process at the end of the mail.
</I>&gt;<i>
</I>&gt;<i>         I don't know if this is the normal behabiour. I thougt that it
</I>&gt;<i>         is, as
</I>&gt;<i>         maybe it would be difficult to the server on the restarted node
</I>&gt;<i>         to know
</I>&gt;<i>         which messages has been already consumed while it was down. But
</I>&gt;<i>         if it is
</I>&gt;<i>         the case, why would anyone has a mirrored queue write to disk if all
</I>&gt;<i>         data can be lost anyway?
</I>&gt;<i>
</I>&gt;<i>         I already tryed to find info about this fact but without success...
</I>&gt;<i>
</I>&gt;<i>         Here the process of both nodes:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         ------------------------------__------------------------------__----------------------
</I>&gt;<i>         NODE 1
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# pwd
</I>&gt;<i>         /var/lib/rabbitmq
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.4Merl_crash.dump
</I>&gt;<i>         2.3Mmnesia
</I>&gt;<i>
</I>&gt;<i>         (send some messages)
</I>&gt;<i>
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# rabbitmqctl list_queues
</I>&gt;<i>         Listing queues ...
</I>&gt;<i>         ha_hello10000
</I>&gt;<i>         ...done.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.4Merl_crash.dump
</I>&gt;<i>         4.6Mmnesia
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# /etc/init.d/rabbitmq-server stop
</I>&gt;<i>         Stopping rabbitmq-server: rabbitmq-server.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.4Merl_crash.dump
</I>&gt;<i>         5.2Mmnesia
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# /etc/init.d/rabbitmq-server start
</I>&gt;<i>         Starting rabbitmq-server: SUCCESS
</I>&gt;<i>         rabbitmq-server.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.4Merl_crash.dump
</I>&gt;<i>         2.3Mmnesia
</I>&gt;<i>
</I>&gt;<i>         (restart seccond node)
</I>&gt;<i>
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]#  rabbitmqctl list_queues
</I>&gt;<i>         Listing queues ...
</I>&gt;<i>         ha_hello0
</I>&gt;<i>         ...done.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.4Merl_crash.dump
</I>&gt;<i>         2.3Mmnesia
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         ------------------------------__------------------------------__----------------------
</I>&gt;<i>
</I>&gt;<i>         NODE 2
</I>&gt;<i>
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# pwd
</I>&gt;<i>         /var/lib/rabbitmq
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.2Merl_crash.dump
</I>&gt;<i>         2.3Mmnesia
</I>&gt;<i>
</I>&gt;<i>         (send some messages)
</I>&gt;<i>
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# rabbitmqctl list_queues
</I>&gt;<i>         Listing queues ...
</I>&gt;<i>         ha_hello10000
</I>&gt;<i>         ...done.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.2Merl_crash.dump
</I>&gt;<i>         4.6Mmnesia
</I>&gt;<i>
</I>&gt;<i>         (stop other node)
</I>&gt;<i>
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# rabbitmqctl list_queues
</I>&gt;<i>         Listing queues ...
</I>&gt;<i>         ha_hello10000
</I>&gt;<i>         ...done.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.2Merl_crash.dump
</I>&gt;<i>         4.6Mmnesia
</I>&gt;<i>
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# /etc/init.d/rabbitmq-server stop
</I>&gt;<i>         Stopping rabbitmq-server: rabbitmq-server.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.2Merl_crash.dump
</I>&gt;<i>         5.2Mmnesia
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# /etc/init.d/rabbitmq-server start
</I>&gt;<i>         Starting rabbitmq-server: SUCCESS
</I>&gt;<i>         rabbitmq-server.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# rabbitmqctl list_queues
</I>&gt;<i>         Listing queues ...
</I>&gt;<i>         ha_hello0
</I>&gt;<i>         ...done.
</I>&gt;<i>         [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
</I>&gt;<i>         1.2Merl_crash.dump
</I>&gt;<i>         2.3Mmnesia
</I>&gt;<i>
</I>&gt;<i>         ------------------------------__------------------------------__----------------------
</I>&gt;<i>
</I>&gt;<i>         Thanks!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         _________________________________________________
</I>&gt;<i>         rabbitmq-discuss mailing list
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.__rabbitmq.com</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss">https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss</A>
</I>&gt;<i>         &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     --
</I>&gt;<i>     Simon MacMullen
</I>&gt;<i>     RabbitMQ, Pivotal
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036446.html">[rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages
</A></li>
	<LI>Next message: <A HREF="036447.html">[rabbitmq-discuss] Autorecovery Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36456">[ date ]</a>
              <a href="thread.html#36456">[ thread ]</a>
              <a href="subject.html#36456">[ subject ]</a>
              <a href="author.html#36456">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
