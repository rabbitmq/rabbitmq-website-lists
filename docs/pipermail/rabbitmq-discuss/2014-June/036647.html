<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Race condition when acknowledging messages?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Race%20condition%20when%20acknowledging%20messages%3F&In-Reply-To=%3C539FFACE.7090005%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036636.html">
   <LINK REL="Next"  HREF="036638.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Race condition when acknowledging messages?</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Race%20condition%20when%20acknowledging%20messages%3F&In-Reply-To=%3C539FFACE.7090005%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Race condition when acknowledging messages?">simon at rabbitmq.com
       </A><BR>
    <I>Tue Jun 17 09:22:38 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036636.html">[rabbitmq-discuss] Race condition when acknowledging messages?
</A></li>
        <LI>Next message: <A HREF="036638.html">[rabbitmq-discuss] rabbitmq-c TTL setting not working for me -	please help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36647">[ date ]</a>
              <a href="thread.html#36647">[ thread ]</a>
              <a href="subject.html#36647">[ subject ]</a>
              <a href="author.html#36647">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/06/2014 21:57, Roger Hu wrote:
&gt;<i> We noticed in this code
</I>&gt;<i> (<A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L741-750">https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L741-750</A>)
</I>&gt;<i> that the record of the note being
</I>&gt;<i> sent is handled by the rabbit_writer process.
</I>&gt;<i>
</I>&gt;<i> ok = rabbit_writer:send_command(
</I>&gt;<i> WriterPid,
</I>&gt;<i> #'basic.get_ok'{delivery_tag = DeliveryTag,
</I>&gt;<i> redelivered = Redelivered,
</I>&gt;<i> exchange = ExchangeName#resource.name,
</I>&gt;<i> routing_key = RoutingKey,
</I>&gt;<i> message_count = MessageCount},
</I>&gt;<i> Content),
</I>&gt;<i> State1 = monitor_delivering_queue(NoAck, QPid, QName, State),
</I>&gt;<i> {noreply, record_sent(none, not(NoAck), Msg, State1)};
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   However, the delivery tag information appears to get record later
</I>&gt;<i> in <A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L1380-1384:">https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L1380-1384:</A>
</I>&gt;<i>
</I>&gt;<i> true -&gt; queue:in({DeliveryTag, ConsumerTag, {QPid, MsgId}},
</I>&gt;<i> UAMQ);
</I>
Yes.

&gt;<i> Is it possible there is a race condition in which the delivery tag
</I>&gt;<i> received by the client has yet to be recorded?
</I>
But no. Not in any way that makes any difference, anyway.

The point is that the channel can deliver the message and then record 
the ack, because it won't respond to any further messages from the 
outside world until it has returned from handle_cast(), by which time 
the ack is recorded.

So I suspect that there is an issue in your code I'm afraid.

Cheers, Simon

</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036636.html">[rabbitmq-discuss] Race condition when acknowledging messages?
</A></li>
	<LI>Next message: <A HREF="036638.html">[rabbitmq-discuss] rabbitmq-c TTL setting not working for me -	please help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36647">[ date ]</a>
              <a href="thread.html#36647">[ thread ]</a>
              <a href="subject.html#36647">[ subject ]</a>
              <a href="author.html#36647">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
