<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Race condition when acknowledging messages?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Race%20condition%20when%20acknowledging%20messages%3F&In-Reply-To=%3C1a645ad8-66a8-4bec-91a5-b4ba0d363e40%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036637.html">
   <LINK REL="Next"  HREF="036647.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Race condition when acknowledging messages?</H1>
    <B>Roger Hu</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Race%20condition%20when%20acknowledging%20messages%3F&In-Reply-To=%3C1a645ad8-66a8-4bec-91a5-b4ba0d363e40%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Race condition when acknowledging messages?">rhu at hearsaycorp.com
       </A><BR>
    <I>Mon Jun 16 21:57:33 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036637.html">[rabbitmq-discuss] multicast without cycles?
</A></li>
        <LI>Next message: <A HREF="036647.html">[rabbitmq-discuss] Race condition when acknowledging messages?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36636">[ date ]</a>
              <a href="thread.html#36636">[ thread ]</a>
              <a href="subject.html#36636">[ subject ]</a>
              <a href="author.html#36636">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We are running RabbitMQ v3.3.1 and librabbitmq v1.5.2 and have noticed that 
our client is periodically getting these exceptions:

ChannelError: channel error 406, message: PRECONDITION_FAILED - unknown 
delivery tag 704117

We have a dedicated separate connection and channel setup to receive the 
message and ack it back immediately.     We notice that the delivery tag of 
the same as the one we're
trying to acknowledge back, so this tag ID appears to be consistent and one 
that RMQ should know about.  However, it appears to trigger a 
PRECONDITION_FAILED, making us think
we made a duplicate ACK acknowledgment somewhere.  We have placed logging 
statements to centralize all message acknowledgments and only see one ACK, 
confirming our belief
that it is a single ACK being made.

We noticed in this code 
(<A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L741-750">https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L741-750</A>) 
that the record of the note being
sent is handled by the rabbit_writer process.

            ok = rabbit_writer:send_command(
                   WriterPid,
                   #'basic.get_ok'{delivery_tag  = DeliveryTag,
                                   redelivered   = Redelivered,
                                   exchange      = ExchangeName#resource.name,
                                   routing_key   = RoutingKey,
                                   message_count = MessageCount},
                   Content),
            State1 = monitor_delivering_queue(NoAck, QPid, QName, State),
            {noreply, record_sent(none, not(NoAck), Msg, State1)};


 However, the delivery tag information appears to get record later 
in <A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L1380-1384:">https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L1380-1384:</A>

   true  -&gt; queue:in({DeliveryTag, ConsumerTag, {QPid, MsgId}},
                                  UAMQ);


Our current workaround is to delay acknowledging the message instead of 
trying to ack it right away.  The problem shows up intermittently, possibly 
when there are large queue volumes on the RMQ box and possibly when we 
start to queue up 50-60K unacknowledged messages, which may cause issues 
for the delivery tag to be added to the unacked list (UAMQ).

Is it possible there is a race condition in which the delivery tag received 
by the client has yet to be recorded?    Again, the problem happens 
intermittently but would like to suggest changing the code to record the 
delivery tag (in record_sent() before dispatching rabbit_writer.  

Would appreciate any thoughts about changing the code to add the message 
before responding back to the writer.

Thanks,

Roger
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140616/e2a373e9/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140616/e2a373e9/attachment.html</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036637.html">[rabbitmq-discuss] multicast without cycles?
</A></li>
	<LI>Next message: <A HREF="036647.html">[rabbitmq-discuss] Race condition when acknowledging messages?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36636">[ date ]</a>
              <a href="thread.html#36636">[ thread ]</a>
              <a href="subject.html#36636">[ subject ]</a>
              <a href="author.html#36636">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
