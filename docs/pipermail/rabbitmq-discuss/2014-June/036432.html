<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pause minority cluster with publisher confirms	losing messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pause%20minority%20cluster%20with%20publisher%20confirms%0A%09losing%20messages&In-Reply-To=%3C1b4ee2df-5c26-4f07-b333-3fec610af48a%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036477.html">
   <LINK REL="Next"  HREF="036437.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pause minority cluster with publisher confirms	losing messages</H1>
    <B>Miguel Araujo P&#233;rez</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pause%20minority%20cluster%20with%20publisher%20confirms%0A%09losing%20messages&In-Reply-To=%3C1b4ee2df-5c26-4f07-b333-3fec610af48a%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Pause minority cluster with publisher confirms	losing messages">miguel.araujo.perez at gmail.com
       </A><BR>
    <I>Wed Jun  4 08:40:28 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036477.html">[rabbitmq-discuss] Use of QueueDeclarePassive generates errors in log
</A></li>
        <LI>Next message: <A HREF="036437.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36432">[ date ]</a>
              <a href="thread.html#36432">[ thread ]</a>
              <a href="subject.html#36432">[ subject ]</a>
              <a href="author.html#36432">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

We've setup a RabbitMQ 3.3.1-1 cluster of 3 nodes in pause minority mode. 
We are making some tests to make sure we don't lose any messages when a 
node of the cluster goes down. 

So I've setup a little Python script that uses py-amqp to queue messages, 
It uses publisher confirms for doing so. The queue is durable and mirrored 
through a policy to all nodes. I use the script to push to the 3 different 
nodes in a loop, running 3 separate processes, one message every second, 
each message containing information of the publisher that produced it. Once 
I am publishing to the 3 nodes separated I enter node3 and write iptables 
rules to close connection with the other 2 rabbitmq nodes. It takes the 
cluster around a minute to decide that one node is down and node3 to stop 
Rabbit process. publishers to nodes 1 and 2 keep working without issues, 
however publisher3 blocks right after node3 blocks connections as I would 
expect as node3 cannot confirm the message as it doesn't see the other 2 
nodes. 

The issue is that sometimes after a while publisher3 resumes and continues 
pushing messages and according to the library receiving acks for them, that 
goes for a period of 6-8 seconds until an exception is raised because 
connection is closed (node3 stops Rabbit). Those &quot;acked messages&quot; aren't 
however in the queue when I consume it later to see what's inside. However, 
other times it works as i would expect and doesn't enqueue any other 
message after iptables takes place.

So I thought this could be a library issue, and ported the code to PHP 
using official php-amqplib and exact same thing happens. My theory is that 
sometimes node3 after trying to coordinate with other 2 nodes goes into a 
partition for some seconds, in those seconds it confirms messages and then 
pause minority cluster policy kicks in and stops Rabbit. 

To be honest, I'm open to suggestions on what to try. We cannot afford 
losing messages in any situation. 

Thanks, Cheers
Miguel
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140604/b3781723/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140604/b3781723/attachment.html</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036477.html">[rabbitmq-discuss] Use of QueueDeclarePassive generates errors in log
</A></li>
	<LI>Next message: <A HREF="036437.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36432">[ date ]</a>
              <a href="thread.html#36432">[ thread ]</a>
              <a href="subject.html#36432">[ subject ]</a>
              <a href="author.html#36432">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
