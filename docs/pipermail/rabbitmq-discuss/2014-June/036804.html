<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] can't restart rabbit cluster after power	outage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20can%27t%20restart%20rabbit%20cluster%20after%20power%0A%09outage&In-Reply-To=%3C53A46511.70403%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036803.html">
   <LINK REL="Next"  HREF="036808.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] can't restart rabbit cluster after power	outage</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20can%27t%20restart%20rabbit%20cluster%20after%20power%0A%09outage&In-Reply-To=%3C53A46511.70403%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] can't restart rabbit cluster after power	outage">simon at rabbitmq.com
       </A><BR>
    <I>Fri Jun 20 17:45:05 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036803.html">[rabbitmq-discuss] can't restart rabbit cluster after power outage
</A></li>
        <LI>Next message: <A HREF="036808.html">[rabbitmq-discuss] can't restart rabbit cluster after power	outage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36804">[ date ]</a>
              <a href="thread.html#36804">[ thread ]</a>
              <a href="subject.html#36804">[ subject ]</a>
              <a href="author.html#36804">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/06/14 16:55, Ben Hsu wrote:
&gt;<i> Hello, our rabbitmq cluster suffered a power outage, and we&#8217;re having
</I>&gt;<i> trouble bringing it back up.
</I>&gt;<i>
</I>&gt;<i> our cluster has 2 disk backed nodes (node1 and node2) and 1 ram backed
</I>&gt;<i> node (node3). I first tried to restart the disk backed nodes, and they
</I>&gt;<i> both gave me an error, saying &#8220;timeout_waiting_for_tables&#8221; on the other
</I>&gt;<i> two nodes. Googled around, and it sounded like the ram node was the last
</I>&gt;<i> one to go out.
</I>
Nodes attempt to remember if they were the last to shut down, and try to 
enforce the idea that the last to shut down should be the first back up. 
However, RAM nodes don't count for that, only disc.

If the whole thing suffered a power outage, it's possible that no node 
saw any other node die before it died itself, and so each disc node 
wants to wait for the other.

&gt;<i> So I tried restarting the ram backed node, and it started fine. But when
</I>&gt;<i> I tried to start the disk backed node, it gave me a different error,
</I>&gt;<i> basically saying &#8220;inconsistent_cluster, thinks its clustered with node3,
</I>&gt;<i> but node3 disagrees&#8221;.
</I>
The ram node should have refused to start alone. We had a bug where it 
would start in older versions and then get confused - which RabbitMQ 
version are you running?

&gt;<i> What I would love to do is take one of the disk nodes, start it as the
</I>&gt;<i> master, and tell the other nodes to join its cluster. Is that possible?
</I>&gt;<i> Right now I cannot even run &#8220;rabbitmqctl cluster_status&#8221; because the
</I>&gt;<i> node won&#8217;t start
</I>
What you want is &quot;rabbitmqctl forget_cluster_node --offline&quot;. This will:

1) Allow you to tell node1 or node2 that node3 has left the cluster 
(you'll need to re-add it later).

2) Reset node1 or node2's idea of which nodes were the last to shut 
down, allowing the cluster to start again.

&quot;rabbitmqctl forget_cluster_node --offline&quot; is currently a bit of a pain 
to use, since you have to start an Erlang node without booting RabbitMQ.

You can do this by adding &quot;NODE_ONLY=true&quot; to 
/etc/rabbitmq/rabbitmq-env.conf on node1 or node2. Attempting to start 
RabbitMQ in whatever's the normal way for you will get an Erlang node 
started without RabbitMQ (i.e. as if you'd successfully booted the 
server then invoked &quot;rabbitmqctl stop_app&quot;).

You can now invoke &quot;rabbitmqctl forget_cluster_node --offline node3&quot;

Once you've done that, you can stop your node, remove NODE_ONLY=true and 
it should start correctly. The other disc node should then be able to 
start up and join the cluster without further fiddling.

&gt;<i> meta question: is having a mix of disk and RAM based nodes in the same
</I>&gt;<i> cluster a Bad Idea that needs to be fixed?
</I>
It didn't cause this problem. But overall RAM nodes are quite a special 
thing, they exist to speed up queue / exchange / binding declarations in 
large clusters. Most clusters don't need them.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036803.html">[rabbitmq-discuss] can't restart rabbit cluster after power outage
</A></li>
	<LI>Next message: <A HREF="036808.html">[rabbitmq-discuss] can't restart rabbit cluster after power	outage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36804">[ date ]</a>
              <a href="thread.html#36804">[ thread ]</a>
              <a href="subject.html#36804">[ subject ]</a>
              <a href="author.html#36804">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
