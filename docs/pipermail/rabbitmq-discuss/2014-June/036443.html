<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pause%20minority%20cluster%20with%20publisher%0A%20confirms%20losing%20messages&In-Reply-To=%3CCA%2Bb0Ejf3tmAr5ZXHFOdyM7-DgSyAJ-efPUxXMikcmSEAVYo3mQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036437.html">
   <LINK REL="Next"  HREF="036444.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages</H1>
    <B>Miguel Araujo P&#233;rez</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pause%20minority%20cluster%20with%20publisher%0A%20confirms%20losing%20messages&In-Reply-To=%3CCA%2Bb0Ejf3tmAr5ZXHFOdyM7-DgSyAJ-efPUxXMikcmSEAVYo3mQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages">miguel.araujo.perez at gmail.com
       </A><BR>
    <I>Wed Jun  4 11:04:28 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036437.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
        <LI>Next message: <A HREF="036444.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36443">[ date ]</a>
              <a href="thread.html#36443">[ thread ]</a>
              <a href="subject.html#36443">[ subject ]</a>
              <a href="author.html#36443">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Michael,

Thanks for your fast reply.

To be honest, I don't mind that when a node goes down in a RabbitMQ cluster
it takes a minute or more to decide that the cluster is broken and what to
do. What I don't fully understand is why the node fallen stops confirming
for a while, then suddenly resumes for some seconds (not always, just some
times) and then stops Rabbit process closing the connection and having
confirmed messages lost.

It's my understanding that the node should do something like, I cannot see
nodes 1 and 2 (connection is broken), I'm by myself here so I cannot
confirm your publishes. Then says I've got to stop, because I'm in
minority. However, the fact that is confirming messages for a small lapse
of time feels like something is not completely working. Also this actually
doesn't always happens, sometimes it does it right, so it's not consistent.

To be honest, i like the trick of having a local RabbitMQ, however for us
it would be simpler just a cluster. Having a local RabbitMQ, maintaing some
federation or shoveling would be a little overkill.

While doing all these tests. Once, when flushing iptables in node3 it has
core dumped some Erlang trace. All times before it simply detects network
and rejoins cluster without issues. is this something i should report? how?

Thanks, cheers
Miguel


2014-06-04 10:17 GMT+02:00 Michael Klishin &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mklishin at gopivotal.com</A>&gt;:

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 4 June 2014 at 11:58:41, Miguel Araujo P&#233;rez (
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">miguel.araujo.perez at gmail.com</A>) wrote:
</I>&gt;<i> &gt; &gt; The issue is that sometimes after a while publisher3 resumes
</I>&gt;<i> &gt; and continues pushing messages and according to the library
</I>&gt;<i> &gt; receiving acks for them, that goes for a period of 6-8 seconds
</I>&gt;<i> &gt; until an exception is raised because connection is closed (node3
</I>&gt;<i> &gt; stops Rabbit). Those &quot;acked messages&quot; aren't however in the
</I>&gt;<i> &gt; queue when I consume it later to see what's inside. However, other
</I>&gt;<i> &gt; times it works as i would expect and doesn't enqueue any other
</I>&gt;<i> &gt; message after iptables takes place.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So I thought this could be a library issue, and ported the code
</I>&gt;<i> &gt; to PHP using official php-amqplib and exact same thing happens.
</I>&gt;<i> &gt; My theory is that sometimes node3 after trying to coordinate
</I>&gt;<i> &gt; with other 2 nodes goes into a partition for some seconds, in those
</I>&gt;<i> &gt; seconds it confirms messages and then pause minority cluster
</I>&gt;<i> &gt; policy kicks in and stops Rabbit.
</I>&gt;<i>
</I>&gt;<i> Yes, it takes time for both RabbitMQ and client libraries to detect
</I>&gt;<i> connection failure. This is in part due to how TCP works. You can configure
</I>&gt;<i> the interval of inactivity for RabbitMQ nodes:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://www.rabbitmq.com/nettick.html">https://www.rabbitmq.com/nettick.html</A>
</I>&gt;<i>
</I>&gt;<i> and use a low (say, 1-3 seconds) heartbeat interval for client libraries.
</I>&gt;<i> This should make the exception be thrown much earlier (given that your
</I>&gt;<i> client
</I>&gt;<i> supports it; Pika should) at the cost of having increased network traffic:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/reliability.html">http://www.rabbitmq.com/reliability.html</A>
</I>&gt;<i>
</I>&gt;<i> Beyond that, your apps can publish last N messages (excessively) after a
</I>&gt;<i> network
</I>&gt;<i> failure. If your consumers can de-duplicate them (e.g. every message has
</I>&gt;<i> an id you can set),
</I>&gt;<i> that should work well.
</I>&gt;<i>
</I>&gt;<i> If that's not the case, there is a trick that some companies do: they run
</I>&gt;<i> a RabbitMQ
</I>&gt;<i> node local to machine (which at least greatly reduces the probability of
</I>&gt;<i> RabbitMQ becoming
</I>&gt;<i> unreachable), publish with publisher confirms and a low heartbeat interval
</I>&gt;<i> to the local
</I>&gt;<i> node and use Federation [1] or Shovel [2] to connect that node to other
</I>&gt;<i> nodes.
</I>&gt;<i>
</I>&gt;<i> By the way, there are only two official clients: Java and .NET.
</I>&gt;<i>
</I>&gt;<i> 1. <A HREF="http://www.rabbitmq.com/federation.html">http://www.rabbitmq.com/federation.html</A>
</I>&gt;<i> 2. <A HREF="http://www.rabbitmq.com/shovel.html">http://www.rabbitmq.com/shovel.html</A>
</I>&gt;<i> --
</I>&gt;<i> MK
</I>&gt;<i>
</I>&gt;<i> Software Engineer, Pivotal/RabbitMQ
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140604/40447598/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140604/40447598/attachment.html</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036437.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
	<LI>Next message: <A HREF="036444.html">[rabbitmq-discuss] Pause minority cluster with publisher confirms losing messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36443">[ date ]</a>
              <a href="thread.html#36443">[ thread ]</a>
              <a href="subject.html#36443">[ subject ]</a>
              <a href="author.html#36443">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
