<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%7CSpam%7C%20Disk%20mirrored%20queues%20deleting%20messages&In-Reply-To=%3CCA%2B8%2B0E%2Bh6Bu%3Dbc4ZM9pumx8y4DgxFNrErnWwqOsf6bfG_OrEhA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036439.html">
   <LINK REL="Next"  HREF="036446.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages</H1>
    <B>Dan C</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%7CSpam%7C%20Disk%20mirrored%20queues%20deleting%20messages&In-Reply-To=%3CCA%2B8%2B0E%2Bh6Bu%3Dbc4ZM9pumx8y4DgxFNrErnWwqOsf6bfG_OrEhA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages">dcodix at gmail.com
       </A><BR>
    <I>Wed Jun  4 12:08:10 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036439.html">[rabbitmq-discuss] Rabbitmq Config Flie Ignored on Windows Server 2003R2
</A></li>
        <LI>Next message: <A HREF="036446.html">[rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36445">[ date ]</a>
              <a href="thread.html#36445">[ thread ]</a>
              <a href="subject.html#36445">[ subject ]</a>
              <a href="author.html#36445">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm doing some testing with rabbitmq 3.1.5 .
I don't know if I am doing something wrong or it is the normal behabiour,
but, when I setup a 2 nodes cluster, both to disk and everytghing
persistent, and withe the policy:
rabbitmqctl set_policy  ha-all &quot;^ha_&quot; '{&quot;ha-mode&quot;:&quot;all&quot;}'

The system does something I don't understand.
If I create and send messages to a &quot;ha_helloworld&quot; queue those messages are
sent to both nodes, and I can see how both nodes save those messages to
disc as I can see how the &quot;mnesia&quot; directory grows.
If I stop one of the nodes the space of &quot;mnesia&quot; in that node increase
(?&#191;), but when I start it again it will just decrease and lose all messages.

Now, If I were to do the same with the second node, with the first node
already restarted, the second node will just loose all messages to, so I
will be losing all messages from the cluster.

I'll show the process at the end of the mail.

I don't know if this is the normal behabiour. I thougt that it is, as maybe
it would be difficult to the server on the restarted node to know which
messages has been already consumed while it was down. But if it is the
case, why would anyone has a mirrored queue write to disk if all data can
be lost anyway?

I already tryed to find info about this fact but without success...

Here the process of both nodes:


----------------------------------------------------------------------------------
NODE 1
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# pwd
/var/lib/rabbitmq
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
1.4M erl_crash.dump
2.3M mnesia

(send some messages)

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# rabbitmqctl list_queues
Listing queues ...
ha_hello 10000
...done.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
1.4M erl_crash.dump
4.6M mnesia
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# /etc/init.d/rabbitmq-server stop
Stopping rabbitmq-server: rabbitmq-server.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
1.4M erl_crash.dump
5.2M mnesia
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# /etc/init.d/rabbitmq-server start
Starting rabbitmq-server: SUCCESS
rabbitmq-server.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
1.4M erl_crash.dump
2.3M mnesia

(restart seccond node)

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]#  rabbitmqctl list_queues
Listing queues ...
ha_hello 0
...done.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-11-105</A> rabbitmq]# du -hs *
1.4M erl_crash.dump
2.3M mnesia

----------------------------------------------------------------------------------

NODE 2

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# pwd
/var/lib/rabbitmq
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
1.2M erl_crash.dump
2.3M mnesia

(send some messages)

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# rabbitmqctl list_queues
Listing queues ...
ha_hello 10000
...done.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
1.2M erl_crash.dump
4.6M mnesia

(stop other node)

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# rabbitmqctl list_queues
Listing queues ...
ha_hello 10000
...done.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
1.2M erl_crash.dump
4.6M mnesia

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# /etc/init.d/rabbitmq-server stop
Stopping rabbitmq-server: rabbitmq-server.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
1.2M erl_crash.dump
5.2M mnesia
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# /etc/init.d/rabbitmq-server start
Starting rabbitmq-server: SUCCESS
rabbitmq-server.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# rabbitmqctl list_queues
Listing queues ...
ha_hello 0
...done.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-0-10-175</A> rabbitmq]# du -hs *
1.2M erl_crash.dump
2.3M mnesia

----------------------------------------------------------------------------------

Thanks!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140604/f9d95fb7/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140604/f9d95fb7/attachment.html</A>&gt;
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036439.html">[rabbitmq-discuss] Rabbitmq Config Flie Ignored on Windows Server 2003R2
</A></li>
	<LI>Next message: <A HREF="036446.html">[rabbitmq-discuss] |Spam| Disk mirrored queues deleting messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36445">[ date ]</a>
              <a href="thread.html#36445">[ thread ]</a>
              <a href="subject.html#36445">[ subject ]</a>
              <a href="author.html#36445">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
