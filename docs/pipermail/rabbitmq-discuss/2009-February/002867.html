<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ+STOMP Plugin: Bulk Message	Allocation Behavior?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%2BSTOMP%20Plugin%3A%20Bulk%20Message%0A%09Allocation%20Behavior%3F&In-Reply-To=50c8ffe90902031154t6b73081ekac86146e5a2f23a3%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002866.html">
   <LINK REL="Next"  HREF="002868.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ+STOMP Plugin: Bulk Message	Allocation Behavior?</H1>
    <B>Tony Garnock-Jones</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%2BSTOMP%20Plugin%3A%20Bulk%20Message%0A%09Allocation%20Behavior%3F&In-Reply-To=50c8ffe90902031154t6b73081ekac86146e5a2f23a3%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] RabbitMQ+STOMP Plugin: Bulk Message	Allocation Behavior?">tonyg at lshift.net
       </A><BR>
    <I>Tue Feb  3 20:39:15 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002866.html">[rabbitmq-discuss] RabbitMQ+STOMP Plugin: Bulk Message	Allocation Behavior?
</A></li>
        <LI>Next message: <A HREF="002868.html">[rabbitmq-discuss] RabbitMQ+STOMP Plugin: Bulk Message	Allocation Behavior?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2867">[ date ]</a>
              <a href="thread.html#2867">[ thread ]</a>
              <a href="subject.html#2867">[ subject ]</a>
              <a href="author.html#2867">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've just committed a patch to the STOMP adapter that calls out to 
Basic.Qos. It doesn't work with the Ruby STOMP client at the moment, 
because that client doesn't let you specify custom headers to CONNECT, 
but works with Net::Stomp.

To switch on prefetch-windowing, you have to set &quot;prefetch&quot; to non-zero 
on CONNECT, and &quot;ack&quot; to &quot;client&quot; on SUBSCRIBE. To see what the 
&quot;prefetch&quot; CONNECT header is for, look at the documentation for the 
&quot;prefetch count&quot; field in the Basic.Qos command in the AMQP specification.

Regards,
   Tony

Darien Kindlund wrote:
&gt;<i> Okay, thanks.  If there's a way to reduce the prefetch window to 1
</I>&gt;<i> message via the STOMP adapter, I'd appreciate it.  I'm guessing that
</I>&gt;<i> when you reduce the prefetch window, you also incur an additional
</I>&gt;<i> latency in overall message delivery.  In the long term, I'm thinking
</I>&gt;<i> that having programmatic control over this window size would help me
</I>&gt;<i> determine a realistic value that works for my application.
</I>&gt;<i> 
</I>&gt;<i> -- Darien
</I>&gt;<i> 
</I>&gt;<i> On Tue, Feb 3, 2009 at 2:46 PM, Tony Garnock-Jones &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tonyg at lshift.net</A>&gt; wrote:
</I>&gt;&gt;<i> Hi Darien,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is because acknowledgement and prefetch-windowing are orthogonal
</I>&gt;&gt;<i> issues. RabbitMQ very recently gained prefetch-windowing control in the form
</I>&gt;&gt;<i> of AMQP's &quot;Basic.Qos&quot; method, but there's no support for that in the STOMP
</I>&gt;&gt;<i> adapter yet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'll take a look.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Tony
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Darien Kindlund wrote:
</I>&gt;&gt;&gt;<i> Hi Tony,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Using: RabbitMQ 1.5.0 / Stomp 1.5.0
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Maybe you can shed some light on this.  I have a topic exchange setup
</I>&gt;&gt;&gt;<i> with one (durable) queue bound to the exchange.  All messages sent to
</I>&gt;&gt;&gt;<i> the exchange are using a single Net::Stomp perl process and have the
</I>&gt;&gt;&gt;<i> proper routing key such that all messages get sent to the shared
</I>&gt;&gt;&gt;<i> queue.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I also have about 75 to 100 perl processes all using Net::Stomp which
</I>&gt;&gt;&gt;<i> are subscribed to the same queue, receiving these messages.  Each perl
</I>&gt;&gt;&gt;<i> process receives one message, processes the message, then sends back
</I>&gt;&gt;&gt;<i> an explicit ACK (client =&gt; 'ack') to the queue in order for the
</I>&gt;&gt;&gt;<i> message to be removed from the shared queue.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here are the order of events:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 0) No perl processes are subscribed to the queue.
</I>&gt;&gt;&gt;<i> 1) 50,000 messages are sent to the exchange and are routed to the
</I>&gt;&gt;&gt;<i> queue (which are stored on the queue).
</I>&gt;&gt;&gt;<i> 2) 50 perl processes start up and subscribe to the queue and start
</I>&gt;&gt;&gt;<i> processing the messages.
</I>&gt;&gt;&gt;<i> ... wait 1-2 minutes ...
</I>&gt;&gt;&gt;<i> 3) rabbitmqctl shows that messages_ready=0, BUT
</I>&gt;&gt;&gt;<i> messages_unacknowledged=messages_uncommited=30000
</I>&gt;&gt;&gt;<i> 4) 10 new perl processes start up and subscribe to the queue.  At this
</I>&gt;&gt;&gt;<i> point, these 10 new perl processes NEVER obtain any of the remaining
</I>&gt;&gt;&gt;<i> 30,000 messages
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here's the problem:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I want each perl process to handle ONE and only one message at a time,
</I>&gt;&gt;&gt;<i> yet it seems that RabbitMQ (or the STOMP adapter) pre-allocates more
</I>&gt;&gt;&gt;<i> than one message per STOMP connection.  Bottom line: This means that
</I>&gt;&gt;&gt;<i> one of the perl processes can be overloaded with messages while
</I>&gt;&gt;&gt;<i> another perl process may not have any messages to process.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Could you please confirm that this is, in fact, happening?  Next,
</I>&gt;&gt;&gt;<i> could you provide a recommendation as to how I should resolve this
</I>&gt;&gt;&gt;<i> issue?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks again,
</I>&gt;&gt;&gt;<i> -- Darien
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002866.html">[rabbitmq-discuss] RabbitMQ+STOMP Plugin: Bulk Message	Allocation Behavior?
</A></li>
	<LI>Next message: <A HREF="002868.html">[rabbitmq-discuss] RabbitMQ+STOMP Plugin: Bulk Message	Allocation Behavior?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2867">[ date ]</a>
              <a href="thread.html#2867">[ thread ]</a>
              <a href="subject.html#2867">[ subject ]</a>
              <a href="author.html#2867">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
