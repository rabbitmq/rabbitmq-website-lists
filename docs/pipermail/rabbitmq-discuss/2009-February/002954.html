<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20memory%20usage&In-Reply-To=D890F814-3CCE-4FBE-96C5-5FB5AFA0596C%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002953.html">
   <LINK REL="Next"  HREF="002957.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] memory usage</H1>
    <B>Alexis Richardson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20memory%20usage&In-Reply-To=D890F814-3CCE-4FBE-96C5-5FB5AFA0596C%40gmail.com"
       TITLE="[rabbitmq-discuss] memory usage">alexis.richardson at cohesiveft.com
       </A><BR>
    <I>Tue Feb 10 07:27:10 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002953.html">[rabbitmq-discuss] memory usage
</A></li>
        <LI>Next message: <A HREF="002957.html">[rabbitmq-discuss] memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2954">[ date ]</a>
              <a href="thread.html#2954">[ thread ]</a>
              <a href="subject.html#2954">[ subject ]</a>
              <a href="author.html#2954">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Valentino

One question (not very helpful..)

Is this in your local system?  I recall you mentioned EC2 and would
like to ask whether it is on there.

alexis


On Tue, Feb 10, 2009 at 1:17 AM, Valentino Volonghi &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dialtone at gmail.com</A>&gt; wrote:
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> On Feb 9, 2009, at 3:12 AM, Philip Stubbings wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Matthias, Thank you for your reply.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I used rabbitmqctl to determine the status of my queues and my
</I>&gt;&gt;<i> messages are flagged as persistent.
</I>&gt;&gt;<i> I have run the same test again, but this time I inject/consume a few
</I>&gt;&gt;<i> messages later on, as you suggested.
</I>&gt;&gt;<i> However, the memory footprint remains the same:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I kind of have the same behavior, I'm not sure if this was there with
</I>&gt;<i> rabbitmq 1.5.0 though.
</I>&gt;<i>
</I>&gt;<i> Basically I have this configuration in a single erlang process:
</I>&gt;<i>
</I>&gt;<i> One box
</I>&gt;<i> Outside world
</I>&gt;<i> - --------------------------------------------------
</I>&gt;<i>       geoip lookup                                    |
</I>&gt;<i>      /                                                            |
</I>&gt;<i>  mochiweb  ---&gt; rabbitmq ---&gt; shovel |  ---&gt; central rmq ---&gt; consumers
</I>&gt;<i>            \                                                      |
</I>&gt;<i>               app logic                                   |
</I>&gt;<i> - --------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Basically the system works fine and is sort of resistant to certain
</I>&gt;<i> system failures.
</I>&gt;<i> Under medium/high load though (about 1000 messages per second peak, each
</I>&gt;<i> message about 600-800 bytes) memory usage starts to ramp up and when
</I>&gt;<i> it comes
</I>&gt;<i> down it's only for a couple of seconds.
</I>&gt;<i>
</I>&gt;<i> The interesting thing is that I'm running this behind an haproxy load
</I>&gt;<i> balancer
</I>&gt;<i> and the client that is under the most load shows this behavior while
</I>&gt;<i> the other
</I>&gt;<i> remains more or less constant at around 200MB (still a lot but better
</I>&gt;<i> than 1.8GB).
</I>&gt;<i> Of course when kswapd starts running it takes up 100% of the CPU and
</I>&gt;<i> every
</I>&gt;<i> gen_server call goes timeout and brings the system to its knees. I
</I>&gt;<i> then stop everything
</I>&gt;<i> and restart the server that showed the problems (I also have to stop
</I>&gt;<i> the benchmark).
</I>&gt;<i> Shovel then starts transmitting some logs back and apparently memory
</I>&gt;<i> usage goes
</I>&gt;<i> back to normal (as much as the other instance that didn't show
</I>&gt;<i> problems).
</I>&gt;<i>
</I>&gt;<i> Now... Through haproxy stats interface I can see that 628790 requests
</I>&gt;<i> were
</I>&gt;<i> completed (and about 1500 had an error due to the timeouts and so on
</I>&gt;<i> right during
</I>&gt;<i> the failure). On the other hand when I check the logfiles I received
</I>&gt;<i> from those
</I>&gt;<i> machines I only see 504400 logfiles. 124k of them are missing. If
</I>&gt;<i> every message
</I>&gt;<i> is about 600 bytes that's roughly 74MB of data missing.
</I>&gt;<i>
</I>&gt;<i> If I list the mnesia dir in the server that failed I see the following:
</I>&gt;<i>
</I>&gt;<i> - -rw-r--r-- 1 root root 83M 2009-02-10 00:41 rabbit_persister.LOG
</I>&gt;<i> - -rw-r--r-- 1 root root 79M 2009-02-10 00:38
</I>&gt;<i> rabbit_persister.LOG.previous
</I>&gt;<i>
</I>&gt;<i> So basically those 124k messages are there and not being delivered even
</I>&gt;<i> if shovel is connected and is waiting for messages using basic.cosume.
</I>&gt;<i>
</I>&gt;<i> Instead on the other machine where rabbitmq didn't fail I see this:
</I>&gt;<i>
</I>&gt;<i> - -rw-r--r-- 1 root root 6.9M 2009-02-10 00:36 rabbit_persister.LOG
</I>&gt;<i> - -rw-r--r-- 1 root root  29M 2009-02-10 00:35
</I>&gt;<i> rabbit_persister.LOG.previous
</I>&gt;<i>
</I>&gt;<i> which I suppose means that it delivered everything and its queue is
</I>&gt;<i> empty.
</I>&gt;<i>
</I>&gt;<i> Considering that this seems to be a load issue I take it's because
</I>&gt;<i> shovel
</I>&gt;<i> (or the queue processes) don't get nearly enough cpu time from erlang
</I>&gt;<i> to process the messages. If this is the case even adding a second shovel
</I>&gt;<i> gen_server wouldn't solve anything because rabbitmq doesn't send
</I>&gt;<i> anything.
</I>&gt;<i>
</I>&gt;<i> Unfortunately I can't use rabbitmqctl in this configuration for some
</I>&gt;<i> reason
</I>&gt;<i> that I can't explain, I get the {badrpc,nodedown} and this time it's
</I>&gt;<i> not related
</I>&gt;<i> to the path from where I start rabbitmqctl but I suppose it's related
</I>&gt;<i> to the fact
</I>&gt;<i> that I start everything inside a single erlang process.
</I>&gt;<i>
</I>&gt;<i> Also if the case is actually about not getting enough cpu time I
</I>&gt;<i> suppose that
</I>&gt;<i> having one cpu per 'kind' of process in rabbitmq would help alleviate
</I>&gt;<i> this
</I>&gt;<i> issue. For example a quad core cpu would a cpu for each of queue,
</I>&gt;<i> channel,
</I>&gt;<i> exchange, etc.
</I>&gt;<i>
</I>&gt;<i> - --
</I>&gt;<i> Valentino Volonghi aka Dialtone
</I>&gt;<i> Now running MacOS X 10.5
</I>&gt;<i> Home Page: <A HREF="http://www.twisted.it">http://www.twisted.it</A>
</I>&gt;<i> <A HREF="http://www.adroll.com">http://www.adroll.com</A>
</I>&gt;<i>
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v1.4.9 (Darwin)
</I>&gt;<i>
</I>&gt;<i> iEYEARECAAYFAkmQ1bUACgkQ9Llz28widGWYRACgidhqXDzWNLC5sXU+9rWW+t3O
</I>&gt;<i> uXQAoLVSZW71gXdANRqemfVGmrytCmPf
</I>&gt;<i> =aA6z
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002953.html">[rabbitmq-discuss] memory usage
</A></li>
	<LI>Next message: <A HREF="002957.html">[rabbitmq-discuss] memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2954">[ date ]</a>
              <a href="thread.html#2954">[ thread ]</a>
              <a href="subject.html#2954">[ subject ]</a>
              <a href="author.html#2954">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
