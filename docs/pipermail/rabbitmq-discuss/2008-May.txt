From matthias at lshift.net  Thu May  1 19:22:18 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 01 May 2008 19:22:18 +0100
Subject: [rabbitmq-discuss] odd consumer behaviour
In-Reply-To: <OF9C53C83C.97795367-ON8025743B.005AAA2F-8025743B.005B86F4@Edftrading.com>
References: <OF9C53C83C.97795367-ON8025743B.005AAA2F-8025743B.005B86F4@Edftrading.com>
Message-ID: <481A0A5A.7080508@lshift.net>

David,

David.Corcoran at edftrading.com wrote:
> 1. Run the HelloClient RabbitMQ example modified slightly so that it sends
> 20 messages instead of 1.
> 2. Run the HelloServer example but with a slight change to the code. Add a
> Thread.sleep(10*1000) before the return in handleStringCall().
> 3. Now run a normal HelloServer example, without any sleep.
> What I noticed here is that the normal example doesn't run at full speed.
> It looks like the slow server is slowing down the normal one.
> 5. Kill the slow server (the one with the sleep) and the normal HelloServer
> now runs at full speed and finishes the rest of the messages within the
> second.

How exactly did you modify the HelloClient? Did you just put the original

             System.out.println(service.stringCall(request));

in a 20-iteration loop?

If so, then you are issuing 20 RPCs sequentially, i.e. the client will 
be waiting for the result of the previous call before issuing the next.

Each call will be handled by one of the two HelloServers you are 
running. If a call gets handled by the "slow" server then it will take 
10 seconds to complete. If it happens to get handled by the fast server 
then it will complete nearly instantly. As soon as you stop the slow 
server all remaining requests will get handled by the fast server and 
hence complete quickly.

So the behaviour you are seeing is to be expected.

Were you trying to construct a load balancing test? If so you'd need to 
be issuing RPCs *concurrently*. Also, the RpcServer wasn't designed for 
load balancing - it will actually consume messages from the underlying 
AMQP queue as fast as it can without waiting for them to be processed. 
You'd have to change that.

Regards,

Matthias.



From tonyg at lshift.net  Fri May  2 10:15:54 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Fri, 02 May 2008 10:15:54 +0100
Subject: [rabbitmq-discuss] STOMP adapter updated for RabbitMQ v1.3.0
In-Reply-To: <C43FE575.C096%carl.bourne@intellect.co.uk>
References: <C43FE575.C096%carl.bourne@intellect.co.uk>
Message-ID: <481ADBCA.7090101@lshift.net>

Hi Carl,

Carl Bourne wrote:
> Tested this earlier today works perfectly!

Good news :-) Thanks for the report.

> Just a quick one ? I?ve installed a version RabbitMQ v1.3.0 via the
> Ubuntu/Deb apt repository. I can start and stop this version using:
> Usage: /etc/init.d/rabbitmq-server {start|stop|restart|force-reload}
> Or rabbitmqctl
> Is it possible to configure a version with the STOMP adapter to work in
> this way?

Good question. The short answer is "yes", and the longer answer is that
I'll make up a recipe for doing so and update the repository. I'll post
again when I'm done.

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From David.Corcoran at edftrading.com  Fri May  2 11:51:57 2008
From: David.Corcoran at edftrading.com (David.Corcoran at edftrading.com)
Date: Fri, 2 May 2008 11:51:57 +0100
Subject: [rabbitmq-discuss] odd consumer behaviour
In-Reply-To: <481A0A5A.7080508@lshift.net>
Message-ID: <OFFAF9B3EA.0971E243-ON8025743D.0032BA19-8025743D.003BAE23@Edftrading.com>

Hi Matthias,

That makes perfect sense. Thanks for your help. I think my brain was a
little fried when I was writing the example. I was actually trying to write
a simple piece of code that exhibited a problem I was having and the
example I gave was obviously wrong.

The problem I was actually having I suspect is related to prefetching. I'll
try and explain it and perhaps you can confirm if it sounds likely?

I'm testing rabbitmq as a new messaging system for our job control. So I
write a job to the queue and it gets picked up by a worker and run.
Unfortunately each job can start more jobs, down to a level of about 3
deep. So with one job runner active this would lead to deadlock, as a job
would start a new job and block waiting for it to finish but no other job
runner would pick it up.

The way we work around this is when a parent job starts its own child jobs
and blocks, a new thread is started with a new channel pointing to the same
queue. Then when the parent job finishes the thread it was running in
finishes too. This way we only have 1 thread doing any work at a time.

In our current system for this to work I have to turn off prefetching by
the clients. Otherwise the first thread can start a job with dependencies,
then block, but the dependent jobs are prefetched into its local buffer
which leads to deadlock. With prefetching off another client can pick up
the job and work on it.

I think I've hit a problem with prefetching and RabbitMQ. Do you think this
might be the case?

Thanks for your help,

Dave




                                                                           
             Matthias                                                      
             Radestock                                                     
             <matthias at lshift.                                          To 
             net>                      David.Corcoran at edftrading.com       
                                                                        cc 
             01/05/2008 19:22          rabbitmq-discuss at lists.rabbitmq.com 
                                                                   Subject 
                                       Re: [rabbitmq-discuss] odd consumer 
                                       behaviour                           
                                                                           
                                                                           
                                                                           
                                                                           
                                                                           
                                                                           





David,

David.Corcoran at edftrading.com wrote:
> 1. Run the HelloClient RabbitMQ example modified slightly so that it
sends
> 20 messages instead of 1.
> 2. Run the HelloServer example but with a slight change to the code. Add
a
> Thread.sleep(10*1000) before the return in handleStringCall().
> 3. Now run a normal HelloServer example, without any sleep.
> What I noticed here is that the normal example doesn't run at full speed.
> It looks like the slow server is slowing down the normal one.
> 5. Kill the slow server (the one with the sleep) and the normal
HelloServer
> now runs at full speed and finishes the rest of the messages within the
> second.

How exactly did you modify the HelloClient? Did you just put the original

             System.out.println(service.stringCall(request));

in a 20-iteration loop?

If so, then you are issuing 20 RPCs sequentially, i.e. the client will
be waiting for the result of the previous call before issuing the next.

Each call will be handled by one of the two HelloServers you are
running. If a call gets handled by the "slow" server then it will take
10 seconds to complete. If it happens to get handled by the fast server
then it will complete nearly instantly. As soon as you stop the slow
server all remaining requests will get handled by the fast server and
hence complete quickly.

So the behaviour you are seeing is to be expected.

Were you trying to construct a load balancing test? If so you'd need to
be issuing RPCs *concurrently*. Also, the RpcServer wasn't designed for
load balancing - it will actually consume messages from the underlying
AMQP queue as fast as it can without waiting for them to be processed.
You'd have to change that.

Regards,

Matthias.



*********************************************************************
This communication contains confidential information, some or all of which may be privileged. It is for the intended recipient only and others must not disclose, distribute, copy, print or rely on this communication. If an addressing or transmission error has misdirected this communication, please notify the sender by replying to this e-mail and then delete the e-mail. E-mail sent to EDF Trading may be monitored by the company. Thank you. 
EDF Trading Limited
80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
A Company registered in England No. 4255974. 
Switchboard: 020 7061 4000
EDF Trading Markets Limited is a member of the EDF Trading Limited Group and is authorised and regulated by the Financial Services Authority.
VAT number: GB 735 5479 07
*********************************************************************



From matthias at lshift.net  Fri May  2 12:19:56 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 02 May 2008 12:19:56 +0100
Subject: [rabbitmq-discuss] odd consumer behaviour
In-Reply-To: <OFFAF9B3EA.0971E243-ON8025743D.0032BA19-8025743D.003BAE23@Edftrading.com>
References: <OFFAF9B3EA.0971E243-ON8025743D.0032BA19-8025743D.003BAE23@Edftrading.com>
Message-ID: <481AF8DC.4060300@lshift.net>

David,

David.Corcoran at edftrading.com wrote:
> I think I've hit a problem with prefetching and RabbitMQ. Do you think this
> might be the case?

As I said in my previous email: "the RpcServer [...] will actually 
consume messages from the underlying AMQP queue as fast as it can 
without waiting for them to be processed."

So in effect the RpcServer is doing prefetching.

The easiest way to change that is to switch the way the RpcServer gets 
the messages from a push to a pull model, i.e. using AMQP's basic.get 
rather than basic.consume.


Matthias.



From David.Corcoran at edftrading.com  Fri May  2 14:47:36 2008
From: David.Corcoran at edftrading.com (David.Corcoran at edftrading.com)
Date: Fri, 2 May 2008 14:47:36 +0100
Subject: [rabbitmq-discuss] odd consumer behaviour
In-Reply-To: <481AF8DC.4060300@lshift.net>
Message-ID: <OF98412EB7.B8B07FCE-ON8025743D.004B742E-8025743D.004BC2F1@Edftrading.com>

Hey,

Thanks again Matthias. That sounds perfect. In some other message queue
systems I've come across prefetching happens behind the scenes no matter
what methods you call and I was hoping that didn't happen with RabbitMq.

I'll give basic.get a try.

Regards,

Dave



                                                                           
             Matthias                                                      
             Radestock                                                     
             <matthias at lshift.                                          To 
             net>                      David.Corcoran at edftrading.com       
             Sent by:                                                   cc 
             rabbitmq-discuss-         rabbitmq-discuss at lists.rabbitmq.com 
             bounces at lists.rab                                     Subject 
             bitmq.com                 Re: [rabbitmq-discuss] odd consumer 
                                       behaviour                           
                                                                           
             02/05/2008 12:19                                              
                                                                           
                                                                           
                                                                           
                                                                           





David,

David.Corcoran at edftrading.com wrote:
> I think I've hit a problem with prefetching and RabbitMQ. Do you think
this
> might be the case?

As I said in my previous email: "the RpcServer [...] will actually
consume messages from the underlying AMQP queue as fast as it can
without waiting for them to be processed."

So in effect the RpcServer is doing prefetching.

The easiest way to change that is to switch the way the RpcServer gets
the messages from a push to a pull model, i.e. using AMQP's basic.get
rather than basic.consume.


Matthias.

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss



*********************************************************************
This communication contains confidential information, some or all of which may be privileged. It is for the intended recipient only and others must not disclose, distribute, copy, print or rely on this communication. If an addressing or transmission error has misdirected this communication, please notify the sender by replying to this e-mail and then delete the e-mail. E-mail sent to EDF Trading may be monitored by the company. Thank you. 
EDF Trading Limited
80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
A Company registered in England No. 4255974. 
Switchboard: 020 7061 4000
EDF Trading Markets Limited is a member of the EDF Trading Limited Group and is authorised and regulated by the Financial Services Authority.
VAT number: GB 735 5479 07
*********************************************************************



From David.Corcoran at edftrading.com  Fri May  2 16:55:56 2008
From: David.Corcoran at edftrading.com (David.Corcoran at edftrading.com)
Date: Fri, 2 May 2008 16:55:56 +0100
Subject: [rabbitmq-discuss] odd consumer behaviour
In-Reply-To: <481AF8DC.4060300@lshift.net>
Message-ID: <OF33F6240D.D2DD5FD9-ON8025743D.0053169A-8025743D.005782CC@Edftrading.com>

Hi Matthias,

basic.get works great. The jobs with nested dependencies run with no
problems.

The only problem is that Channel basicGet is a non-blocking operation so to
get my test running I'm polling and sleeping for a short amount of time if
I get null. Is there a blocking, non-prefetching, version of basicGet?

Thanks,

Dave



                                                                           
             Matthias                                                      
             Radestock                                                     
             <matthias at lshift.                                          To 
             net>                      David.Corcoran at edftrading.com       
             Sent by:                                                   cc 
             rabbitmq-discuss-         rabbitmq-discuss at lists.rabbitmq.com 
             bounces at lists.rab                                     Subject 
             bitmq.com                 Re: [rabbitmq-discuss] odd consumer 
                                       behaviour                           
                                                                           
             02/05/2008 12:19                                              
                                                                           
                                                                           
                                                                           
                                                                           





David,

David.Corcoran at edftrading.com wrote:
> I think I've hit a problem with prefetching and RabbitMQ. Do you think
this
> might be the case?

As I said in my previous email: "the RpcServer [...] will actually
consume messages from the underlying AMQP queue as fast as it can
without waiting for them to be processed."

So in effect the RpcServer is doing prefetching.

The easiest way to change that is to switch the way the RpcServer gets
the messages from a push to a pull model, i.e. using AMQP's basic.get
rather than basic.consume.


Matthias.

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss



*********************************************************************
This communication contains confidential information, some or all of which may be privileged. It is for the intended recipient only and others must not disclose, distribute, copy, print or rely on this communication. If an addressing or transmission error has misdirected this communication, please notify the sender by replying to this e-mail and then delete the e-mail. E-mail sent to EDF Trading may be monitored by the company. Thank you. 
EDF Trading Limited
80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
A Company registered in England No. 4255974. 
Switchboard: 020 7061 4000
EDF Trading Markets Limited is a member of the EDF Trading Limited Group and is authorised and regulated by the Financial Services Authority.
VAT number: GB 735 5479 07
*********************************************************************



From matthias at lshift.net  Sat May  3 06:44:28 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Sat, 03 May 2008 06:44:28 +0100
Subject: [rabbitmq-discuss] odd consumer behaviour
In-Reply-To: <OF33F6240D.D2DD5FD9-ON8025743D.0053169A-8025743D.005782CC@Edftrading.com>
References: <OF33F6240D.D2DD5FD9-ON8025743D.0053169A-8025743D.005782CC@Edftrading.com>
Message-ID: <481BFBBC.5030805@lshift.net>

David,

David.Corcoran at edftrading.com wrote:
> basic.get works great. The jobs with nested dependencies run with no
> problems.
> 
> The only problem is that Channel basicGet is a non-blocking operation so to
> get my test running I'm polling and sleeping for a short amount of time if
> I get null. Is there a blocking, non-prefetching, version of basicGet?

There is no blocking basicGet. However, there is a way of controlling 
the prefetch window used by basicConsume, namely AMQP's basicQos method. 
Unfortunately this feature is as yet unimplemented in RabbitMQ. It's on 
our todo list.


Matthias.



From lynton.grice at netweaverguru.com  Sun May  4 10:54:58 2008
From: lynton.grice at netweaverguru.com (Lynton Grice)
Date: Sun, 4 May 2008 11:54:58 +0200
Subject: [rabbitmq-discuss] URGENT: Run-Tests failing...please help
Message-ID: <003001c8adcc$ecc7a660$925419ac@logos>

Hi there,

 

I would REALLY appreciate some help on running the tests against the
broker..

 

Here is my setup:

 

I am running RabbitMQ 1.3.0 (AMQP 8-0)..and the broker is running on
LOCALHOST: 5672 (using 'LOGIN': 'guest', 'PASSWORD': 'guest') - so the
broker is running 100%..

 

I am using PYTHON to connect to the broker and am sending a message to the
broker and receiving a message from it again...all working 100%......

 

I have also installed the QPID library (qpid-1.0-incubating-M2-python-src)
into my site packages in Python (D:\Python24\Lib\site-packages)..and
obviously have run setup.py etc..all seems fine...

 

Then I go to the command line, for example
D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python and
run python run-tests

 

I get many many errors...I also tried different variations of python
run-tests -? to try different SPEC files etc..still errors...here is the
stack trace...

 

File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\testlib.py", line 123, in run

  result = runner.run(self.testSuite())

File "D:\Python24\Lib\unittest.py", line 696, in run

  test(result)

File "D:\Python24\Lib\unittest.py", line 428, in __call__

  return self.run(*args, **kwds)

File "D:\Python24\Lib\unittest.py", line 424, in run

  test(result)

File "D:\Python24\Lib\unittest.py", line 428, in __call__

  return self.run(*args, **kwds)

File "D:\Python24\Lib\unittest.py", line 424, in run

  test(result)

File "D:\Python24\Lib\unittest.py", line 428, in __call__

  return self.run(*args, **kwds)

File "D:\Python24\Lib\unittest.py", line 424, in run

  test(result)

File "D:\Python24\Lib\unittest.py", line 281, in __call__

  return self.run(*args, **kwds)

File "D:\Python24\Lib\unittest.py", line 251, in run

  self.setUp()

File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\testlib.py", line 162, in setUp

  self.client = self.connect()

File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\testlib.py", line 174, in connect

  return testrunner.connect(*args, **keys)

File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\testlib.py", line 139, in connect

  client.start({"LOGIN": user, "PASSWORD": password})

File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\client.py", line 82, in start

  self.wait()

File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\client.py", line 60, in wait

  raise EOFError()

 

I have debugged the run-tests in WingIDE and it seems to CONNECT fine but
then it goes to the testlib.py class and dies on the client.start method.

 

def connect(self, host=None, port=None, spec=None, user=None,
password=None):

        """Connect to the broker, returns a qpid.client.Client"""

        host = host or self.host

        port = port or self.port

        spec = spec or self.spec

        user = user or self.user

        password = password or self.password

        client = qpid.client.Client(host, port, qpid.spec.load(spec))

        client.start({"LOGIN": user, "PASSWORD": password})

        return client

 

Debugging further I can see it goes into the peer.py class and into the
following code:

 

def invoke(self, method, args, content = None):

    if self.closed:

      raise Closed(self.reason)

    frame = Frame(self.id, Method(method, *args))

    self.outgoing.put(frame)

 

    if method.content:

      if content == None:

        content = Content()

      self.write_content(method.klass, content, self.outgoing)

 

    try:

      # here we depend on all nowait fields being named nowait

      f = method.fields.byname["nowait"]

      nowait = args[method.fields.index(f)]

    except KeyError:

      nowait = False

 

It dies on the above code f = method.fields.byname["nowait"]...

 

I am sure this must be with some VERSION problem or something??

 

Can anyone PLEASE give me some advise, I would really appreciate it ;-)

 

Looking forward to hearing back from you!

 

Regards

 

Lynton

 

 

 

 

 

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080504/25add454/attachment.htm 

From matthias at lshift.net  Sun May  4 12:01:17 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Sun, 04 May 2008 12:01:17 +0100
Subject: [rabbitmq-discuss] URGENT: Run-Tests failing...please help
In-Reply-To: <003001c8adcc$ecc7a660$925419ac@logos>
References: <003001c8adcc$ecc7a660$925419ac@logos>
Message-ID: <481D977D.8030501@lshift.net>

Lynton,

Lynton Grice wrote:
> Then I go to the command line, for example 
> D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python 
> and run python run-tests
> 
> I get many many errors??.I also tried different variations of python 
> run-tests -? to try different SPEC files etc??still errors??.here is the 
> stack trace?..

You must tell the tests to use the official amqp0-8.xml from 
https://jira.amqp.org/confluence/display/AMQP/Download, *not* the spec 
that ships with qpid. In our test suite we run the tests with
   python run-tests -v -s <path-to-official-spec> -I rabbit_failing.txt

where rabbit_failing.txt contains a list of exclusions for tests that 
need to skipped because they either depend on a different spec, test 
features not implemented in rabbit, or make assumptions about the 
implementation. Currently these are:

tests.spec.*
tests.codec.*
tests.codec010.*
tests.connection010.*
tests.spec010.*
tests_0-8.basic.BasicTests.test_consume_no_local
tests_0-8.exchange.HeadersExchangeTests.*
tests_0-8.exchange.RecommendedTypesRuleTests.testHeaders
tests_0-8.exchange.RequiredInstancesRuleTests.testAmqMatch
tests_0-8.basic.BasicTests.test_qos_*
tests_0-8.tx.TxTests.test_auto_rollback
tests_0-8.tx.TxTests.test_rollback

>     try:
>       # here we depend on all nowait fields being named nowait
> *_      f = method.fields.byname["nowait"]_*
>       nowait = args[method.fields.index(f)]
>     except KeyError:
>       nowait = False
> 
> It dies on the above code *_f = method.fields.byname["nowait"]?.._*

What error does the above return?


Matthias.



From lynton.grice at netweaverguru.com  Sun May  4 14:14:50 2008
From: lynton.grice at netweaverguru.com (Lynton Grice)
Date: Sun, 4 May 2008 15:14:50 +0200
Subject: [rabbitmq-discuss] URGENT: Run-Tests failing...please help
In-Reply-To: <481D977D.8030501@lshift.net>
Message-ID: <000301c8ade8$d9610050$925419ac@logos>

Hi Matthias,

 

Thanks for the feedback......I tried exactly what you said and it is still
going into error.

 

I downloaded the latest spec - amqp.0-8.xml - and put it into the same
directory at the "run-tests" file....and also copied it into the specs
folder in the standard QPID installation....

 

You can find the command attached....

 

I also added the exclusions like you said to the rabbit_failing.txt ...

 

Any other ideas you can think of that I may be doing wrong?

 

Perhaps tell me what versions you guys are running?

 

Thanks for the help thus far ;-)

 

Lynton

 

 

 

-----Original Message-----
From: Matthias Radestock [mailto:matthias at lshift.net] 
Sent: 04 May 2008 01:01 PM
To: Lynton Grice
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] URGENT: Run-Tests failing...please help

 

Lynton,

 

Lynton Grice wrote:

> Then I go to the command line, for example 

> D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python 

> and run python run-tests

> 

> I get many many errors...I also tried different variations of python 

> run-tests -? to try different SPEC files etc..still errors...here is the 

> stack trace...

 

You must tell the tests to use the official amqp0-8.xml from 

https://jira.amqp.org/confluence/display/AMQP/Download, *not* the spec 

that ships with qpid. In our test suite we run the tests with

   python run-tests -v -s <path-to-official-spec> -I rabbit_failing.txt

 

where rabbit_failing.txt contains a list of exclusions for tests that 

need to skipped because they either depend on a different spec, test 

features not implemented in rabbit, or make assumptions about the 

implementation. Currently these are:

 

tests.spec.*

tests.codec.*

tests.codec010.*

tests.connection010.*

tests.spec010.*

tests_0-8.basic.BasicTests.test_consume_no_local

tests_0-8.exchange.HeadersExchangeTests.*

tests_0-8.exchange.RecommendedTypesRuleTests.testHeaders

tests_0-8.exchange.RequiredInstancesRuleTests.testAmqMatch

tests_0-8.basic.BasicTests.test_qos_*

tests_0-8.tx.TxTests.test_auto_rollback

tests_0-8.tx.TxTests.test_rollback

 

>     try:

>       # here we depend on all nowait fields being named nowait

> *_      f = method.fields.byname["nowait"]_*

>       nowait = args[method.fields.index(f)]

>     except KeyError:

>       nowait = False

> 

> It dies on the above code *_f = method.fields.byname["nowait"]..._*

 

What error does the above return?

 

 

Matthias.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080504/7b70d0ae/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: error.png
Type: image/png
Size: 8285 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080504/7b70d0ae/attachment.png 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: result.png
Type: image/png
Size: 5165 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080504/7b70d0ae/attachment-0001.png 

From lynton.grice at netweaverguru.com  Sun May  4 14:18:47 2008
From: lynton.grice at netweaverguru.com (Lynton Grice)
Date: Sun, 4 May 2008 15:18:47 +0200
Subject: [rabbitmq-discuss] URGENT: Run-Tests failing...please help
In-Reply-To: <481D977D.8030501@lshift.net>
Message-ID: <000901c8ade9$6649b1b0$925419ac@logos>


Hi Matthias,

You asked what error the following returns?

>     try:
>       # here we depend on all nowait fields being named nowait
> *_      f = method.fields.byname["nowait"]_*
>       nowait = args[method.fields.index(f)]
>     except KeyError:
>       nowait = False
> 
> It dies on the above code *_f = method.fields.byname["nowait"]..._*

What error does the above return?

This is the exact stack trace in WingIDE....

Obviously the above raises a KEYERROR ....but here is the trace.....;-)

File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\peer.py", line 102, in worker
  self.dispatch(self.work.get())
File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\peer.py", line 118, in dispatch
  self.delegate.dispatch(channel, message)
File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\delegate.py", line 51, in dispatch
  return handler(channel, message)
File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\client.py", line 97, in connection_start
  locale=self.client.locale)
File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\<str
ing>", line 3, in connection_start_ok
File
"D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python\qpid
\peer.py", line 164, in invoke
  f = method.fields.byname["nowait"]

Thanks again ;-)

Lynton


-----Original Message-----
From: Matthias Radestock [mailto:matthias at lshift.net] 
Sent: 04 May 2008 01:01 PM
To: Lynton Grice
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] URGENT: Run-Tests failing...please help

Lynton,

Lynton Grice wrote:
> Then I go to the command line, for example 
> D:\Python24\Lib\site-packages\qpid-1.0-incubating-M2-python-src\python 
> and run python run-tests
> 
> I get many many errors...I also tried different variations of python 
> run-tests -? to try different SPEC files etc..still errors...here is the 
> stack trace...

You must tell the tests to use the official amqp0-8.xml from 
https://jira.amqp.org/confluence/display/AMQP/Download, *not* the spec 
that ships with qpid. In our test suite we run the tests with
   python run-tests -v -s <path-to-official-spec> -I rabbit_failing.txt

where rabbit_failing.txt contains a list of exclusions for tests that 
need to skipped because they either depend on a different spec, test 
features not implemented in rabbit, or make assumptions about the 
implementation. Currently these are:

tests.spec.*
tests.codec.*
tests.codec010.*
tests.connection010.*
tests.spec010.*
tests_0-8.basic.BasicTests.test_consume_no_local
tests_0-8.exchange.HeadersExchangeTests.*
tests_0-8.exchange.RecommendedTypesRuleTests.testHeaders
tests_0-8.exchange.RequiredInstancesRuleTests.testAmqMatch
tests_0-8.basic.BasicTests.test_qos_*
tests_0-8.tx.TxTests.test_auto_rollback
tests_0-8.tx.TxTests.test_rollback

>     try:
>       # here we depend on all nowait fields being named nowait
> *_      f = method.fields.byname["nowait"]_*
>       nowait = args[method.fields.index(f)]
>     except KeyError:
>       nowait = False
> 
> It dies on the above code *_f = method.fields.byname["nowait"]..._*

What error does the above return?


Matthias.




From matthias at lshift.net  Sun May  4 14:36:57 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Sun, 04 May 2008 14:36:57 +0100
Subject: [rabbitmq-discuss] URGENT: Run-Tests failing...please help
In-Reply-To: <000301c8ade8$d9610050$925419ac@logos>
References: <000301c8ade8$d9610050$925419ac@logos>
Message-ID: <481DBBF9.6050403@lshift.net>

Lynton Grice wrote:

> Perhaps tell me what versions you guys are running?

We are get hold of the qpid test suite like this:

svn co http://svn.apache.org/repos/asf/incubator/qpid/trunk/qpid/python 
qpid_testsuite

(see tests/Makefile in the RabbitMQ source package).


Matthias.



From lynton.grice at netweaverguru.com  Sun May  4 14:43:39 2008
From: lynton.grice at netweaverguru.com (Lynton Grice)
Date: Sun, 4 May 2008 15:43:39 +0200
Subject: [rabbitmq-discuss] URGENT: Run-Tests failing...please help
In-Reply-To: <481DBBF9.6050403@lshift.net>
Message-ID: <001001c8adec$e18472e0$925419ac@logos>

Hi there,

Stupid question (forgive me, I am an SAP / ABAP developer.....I just play
with Python etc in my spare time)...

I run windows.....how can I do what you said: 

svn co http://svn.apache.org/repos/asf/incubator/qpid/trunk/qpid/python 
qpid_testsuite

In windows? Do I need to download the RabbitMQ source package?

Thanks for the help ;-)

Lynton

-----Original Message-----
From: Matthias Radestock [mailto:matthias at lshift.net] 
Sent: 04 May 2008 03:37 PM
To: Lynton Grice
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] URGENT: Run-Tests failing...please help

Lynton Grice wrote:

> Perhaps tell me what versions you guys are running?

We are get hold of the qpid test suite like this:

svn co http://svn.apache.org/repos/asf/incubator/qpid/trunk/qpid/python 
qpid_testsuite

(see tests/Makefile in the RabbitMQ source package).


Matthias.




From matthias at lshift.net  Sun May  4 15:10:51 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Sun, 04 May 2008 15:10:51 +0100
Subject: [rabbitmq-discuss] URGENT: Run-Tests failing...please help
In-Reply-To: <001001c8adec$e18472e0$925419ac@logos>
References: <001001c8adec$e18472e0$925419ac@logos>
Message-ID: <481DC3EB.30900@lshift.net>

Lynton Grice wrote:
> I run windows.....how can I do what you said: 
> 
> svn co http://svn.apache.org/repos/asf/incubator/qpid/trunk/qpid/python 
> qpid_testsuite
> 
> In windows?

You'll need a subversion client. The above checks out the latest qpid 
test suite from qpid's subversion trunk.

Anyway, I found the problem. The test suite that ships with qpid-1.0-M2 
sets the vhost to "localhost" (well, the host name of the broker you are 
connecting to, actually) instead of "/". Just change client.py:46 to read
   self.vhost = "/"
and the tests should run. You will see a few errors due to the fact that 
the M2 test suite does not support exclusion patterns. Other than that 
things work fine.


Matthias.



From lynton.grice at netweaverguru.com  Sun May  4 15:29:57 2008
From: lynton.grice at netweaverguru.com (Lynton Grice)
Date: Sun, 4 May 2008 16:29:57 +0200
Subject: [rabbitmq-discuss] URGENT: Run-Tests failing...please help
In-Reply-To: <481DC3EB.30900@lshift.net>
Message-ID: <000601c8adf3$5ebc5c40$925419ac@logos>

Thanks for the help Matthias....

I ran it now and yes, there are a couple errors but also lots of OK messages
when the tests run...

Thanks again

Lynton

-----Original Message-----
From: Matthias Radestock [mailto:matthias at lshift.net] 
Sent: 04 May 2008 04:11 PM
To: Lynton Grice
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] URGENT: Run-Tests failing...please help

Lynton Grice wrote:
> I run windows.....how can I do what you said: 
> 
> svn co http://svn.apache.org/repos/asf/incubator/qpid/trunk/qpid/python 
> qpid_testsuite
> 
> In windows?

You'll need a subversion client. The above checks out the latest qpid 
test suite from qpid's subversion trunk.

Anyway, I found the problem. The test suite that ships with qpid-1.0-M2 
sets the vhost to "localhost" (well, the host name of the broker you are 
connecting to, actually) instead of "/". Just change client.py:46 to read
   self.vhost = "/"
and the tests should run. You will see a few errors due to the fact that 
the M2 test suite does not support exclusion patterns. Other than that 
things work fine.


Matthias.




From markkicks at gmail.com  Sun May  4 22:44:14 2008
From: markkicks at gmail.com (mark)
Date: Sun, 4 May 2008 14:44:14 -0700
Subject: [rabbitmq-discuss] python hello world
Message-ID: <82fa9e310805041444n6021c167uea90c1e9367bbe70@mail.gmail.com>

Hi
I have rabbitmq-server 1.3 installed and running, and python qpid installed.
Can you give a very basic example how to set and get from a queue? How many
queues does rabbitmq-start?

thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080504/9e8d2b42/attachment.htm 

From lynton.grice at netweaverguru.com  Mon May  5 07:51:02 2008
From: lynton.grice at netweaverguru.com (Lynton Grice)
Date: Mon, 5 May 2008 08:51:02 +0200
Subject: [rabbitmq-discuss] python hello world
In-Reply-To: <82fa9e310805041444n6021c167uea90c1e9367bbe70@mail.gmail.com>
Message-ID: <000001c8ae7c$6777eeb0$5bac9ba8@logos>

Hi Mark,

 

Here is the script I got going the other day ;-)

 

import sys

 

sys.path = sys.path + ['D:\Python24\Lib\site-packages\python-qpid']

 

import qpid

from qpid.client import Client

from qpid.content import Content

 

client = Client("localhost", 5672, spec=qpid.spec.load('amqp0-8.xml'))

client.start({ 'LOGIN': 'guest', 'PASSWORD': 'guest'}) 

 

ch = client.channel(1) 

ch.channel_open() 

ch.queue_declare(queue="testq", exclusive=True)

 

ch.queue_bind(queue="testq", exchange="amq.direct", routing_key="test") 

 

print 'Sending message "ping"...  ', 

ch.basic_publish(routing_key="test",
content=Content("ping"),exchange='amq.direct') 

print 'done' 

 

print 'Receiving message' 

t = ch.basic_consume(queue="testq", no_ack=True) 

q = client.queue(t.consumer_tag) 

msg = q.get(timeout=1) 

print 'Got message:', msg.content.body 

q.close()

client.close()

 

Regards

 

Lynton

  _____  

From: rabbitmq-discuss-bounces at lists.rabbitmq.com
[mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of mark
Sent: 04 May 2008 11:44 PM
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: [rabbitmq-discuss] python hello world

 

Hi
I have rabbitmq-server 1.3 installed and running, and python qpid installed.
Can you give a very basic example how to set and get from a queue? How many
queues does rabbitmq-start?

thanks

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080505/6c7c2328/attachment.htm 

From chime at mu.dk  Mon May  5 10:30:19 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Mon, 5 May 2008 11:30:19 +0200
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>
Message-ID: <591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>

Hi guys, hope you can help me with this.

First - the problem is that we do something new with RabbitMQ that we  
probably shouldn't be doing - we just don't know what yet :-)

And then we get some weird responses.

My guess is we make too many connections or too many channels. Don't  
know which. I have checked for queues but we only use < 50 of those.

Anyway, the result is "too many processes" at some point and then a  
corrupted mnesia to a degree where even a rabbit restart is not  
sufficient (see below).

So is there any way to ask RabbitMQ for the amount of connections?  
Channels?

Will rabbit create a new process for each connection? Channel?

Any other suggestions on whats happening here?

Regards,

Michael


Begin forwarded message:

> From: Philip Bergen <philip at wiinz.com>
> Date: May 5, 2008 9:37:37 GMT+02:00
> To: Arnoldus Michael <chime at wiinz.com>
> Subject: RabbitMQ error
>
> Hi Michael,
> I had some problems with rabbitmq (see logfile about four fifths  
> down), it has an error and then goes on to tell me it has too many  
> db tables. So I restarted rabbit. Now it no longer knows  
> basic.publish. I checked the amqp0-8.xml file. It was fine. Then  
> stopped rabbit, deleted mnesia and restarted rabbit. Now it works  
> again.
>
> The question is: what is the new amqplib I have developed doing  
> wrong to cause this? Or has it got something to do with the patch? I  
> don't know.
>
> /Philip
>
>
>
> --
> "Do first things first and second things not at all" -- Peter Drucker
>
>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080505/b88e6acb/attachment.htm 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: rabbit.log.txt
Url: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080505/b88e6acb/attachment.txt 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080505/b88e6acb/attachment-0001.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080505/b88e6acb/attachment.bin 

From matthias at lshift.net  Mon May  5 14:38:24 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Mon, 05 May 2008 14:38:24 +0100
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
In-Reply-To: <591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>
	<591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>
Message-ID: <481F0DD0.3000104@lshift.net>

Michael,

Michael Arnoldus wrote:
> Anyway, the result is "too many processes".

A brute force way of checking on the currently running processes is

file:write_file("/tmp/processes.erl", io_lib:format("~p", 
[[process_info(P) || P <- processes()]])).

Warning: this may include some message content and security credentials.

> So is there any way to ask RabbitMQ for the amount of connections? 
> Channels? 

Not easily. It's on our todo list.

Connects/disconnects are recorded in rabbit.log, so with some log 
analysis you should be able to get an idea on the current connection 
count. Plus of course there's the 'netstat' OS command.

> Will rabbit create a new process for each connection? Channel?

RabbitMQ creates about half a dozen processes per connection, and four 
processes per channel.

> Any other suggestions on whats happening here?

Connections, channels and queues are the only entities performing 
dynamic process creation, except for the various places that spawn 
short-lived helper processes.

Are you sure that you haven't got stale queues lying around? I am asking 
because of the mnesia errors you are seeing - connection and channel 
creation does not result in mnesia writes, but queue creation does.


Matthias.



From chime at mu.dk  Mon May  5 14:54:39 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Mon, 5 May 2008 15:54:39 +0200
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
In-Reply-To: <481F0DD0.3000104@lshift.net>
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>
	<591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>
	<481F0DD0.3000104@lshift.net>
Message-ID: <9DFD9679-B988-4753-82DE-B0BC14281B87@mu.dk>

Matthias,

On May 5, 2008, at 15:38 , Matthias Radestock wrote:

> A brute force way of checking on the currently running processes is
>
> file:write_file("/tmp/processes.erl", io_lib:format("~p",  
> [[process_info(P) || P <- processes()]])).
>
> Warning: this may include some message content and security  
> credentials.
>
Thanks.

>> cSo is there any way to ask RabbitMQ for the amount of connections?  
>> Channels?
>
> Not easily. It's on our todo list.
>
> Connects/disconnects are recorded in rabbit.log, so with some log  
> analysis you should be able to get an idea on the current connection  
> count. Plus of course there's the 'netstat' OS command.

All I get in the log is

=WARNING REPORT==== 5-May-2008::15:17:40 ===
Attempt by client to use invalid ticket 0

=WARNING REPORT==== 5-May-2008::15:17:40 ===
Lax ticket check mode: fabricating full ticket number 0

since we're using the qpid python client, but nothing else about  
connections or channel open. Do I get the above message for each  
connection or each channel open?

>
>
>> Will rabbit create a new process for each connection? Channel?
>
> RabbitMQ creates about half a dozen processes per connection, and  
> four processes per channel.

Good to know! Thanks!

>
>
>> Any other suggestions on whats happening here?
>
> Connections, channels and queues are the only entities performing  
> dynamic process creation, except for the various places that spawn  
> short-lived helper processes.

Ok.

>
>
> Are you sure that you haven't got stale queues lying around? I am  
> asking because of the mnesia errors you are seeing - connection and  
> channel creation does not result in mnesia writes, but queue  
> creation does.

Not sure - but approx 10 sec before the latest crash I had 12 queues  
which had been there for at least 30 sec - and we have no 'make a lot  
of queues very fast' function that might do something like this, so my  
primary suspicions would go somewhere else. I'll work on it though.

Michael

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080505/6b48ce1e/attachment.bin 

From matthias at lshift.net  Mon May  5 15:08:02 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Mon, 05 May 2008 15:08:02 +0100
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
In-Reply-To: <9DFD9679-B988-4753-82DE-B0BC14281B87@mu.dk>
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>	<591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>	<481F0DD0.3000104@lshift.net>
	<9DFD9679-B988-4753-82DE-B0BC14281B87@mu.dk>
Message-ID: <481F14C2.5030004@lshift.net>

Michael,

Michael Arnoldus wrote:
> On May 5, 2008, at 15:38 , Matthias Radestock wrote:
>> Connects/disconnects are recorded in rabbit.log, so with some log 
>> analysis you should be able to get an idea on the current connection 
>> count. Plus of course there's the 'netstat' OS command.
> 
> All I get in the log is
> 
> =WARNING REPORT==== 5-May-2008::15:17:40 ===
> Attempt by client to use invalid ticket 0
> 
> =WARNING REPORT==== 5-May-2008::15:17:40 ===
> Lax ticket check mode: fabricating full ticket number 0

You should see messages like

=INFO REPORT==== 5-May-2008::08:37:48 ===
accepted TCP connection on 0.0.0.0:5672 from 127.0.0.1:53449

=INFO REPORT==== 5-May-2008::08:37:53 ===
closing TCP connection from 127.0.0.1:49606

for the opening and closing of a connection, respectively. In fact I 
know you do - the above are copy&pasted from the log you sent earlier  :)


Matthias



From matthias at lshift.net  Mon May  5 18:03:40 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Mon, 05 May 2008 18:03:40 +0100
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
In-Reply-To: <481F0DD0.3000104@lshift.net>
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>
	<591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>
	<481F0DD0.3000104@lshift.net>
Message-ID: <481F3DEC.7030806@lshift.net>

Matthias Radestock wrote:
> Michael Arnoldus wrote:
>> So is there any way to ask RabbitMQ for the amount of connections? 
>> Channels? 
> 
> Not easily. It's on our todo list.

Actually, it's not that hard. In the shell define

F = fun (X) -> length([P || P <- processes(), case process_info(P, 
current_function) of {current_function, {X, _, _}} -> true; _ -> false 
end]) end.

and then call it like this:

F(rabbit_reader). %% number of connections
F(rabbit_framing_channel). %% number of channels



Matthias.



From tonyg at lshift.net  Tue May  6 12:30:09 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Tue, 06 May 2008 12:30:09 +0100
Subject: [rabbitmq-discuss] python hello world
In-Reply-To: <82fa9e310805041444n6021c167uea90c1e9367bbe70@mail.gmail.com>
References: <82fa9e310805041444n6021c167uea90c1e9367bbe70@mail.gmail.com>
Message-ID: <48204141.5050601@lshift.net>

Hi Mark,

Lynton's kindly sent his example program. You might also be interested
in exploring Barry Pedersen's Python AMQP client,
http://barryp.org/software/py-amqplib/, which has a few example programs
that come with it, notably

http://hg.barryp.org/py-amqplib/file/tip/demo/demo_receive.py and
http://hg.barryp.org/py-amqplib/file/tip/demo/demo_send.py

With regard to your other question, RabbitMQ by default doesn't ship
with *any* queues preconfigured. You need to create them from your
applications using queueDeclare() - for instance, from Barry's Python
AMQP library documentation,

  ch.queue_declare('queue name')

Barry's written up a nice overview document that's available at
http://hg.barryp.org/py-amqplib/raw-file/tip/docs/overview.txt.

Regards,
  Tony



mark wrote:
> Hi
> I have rabbitmq-server 1.3 installed and running, and python qpid installed.
> Can you give a very basic example how to set and get from a queue? How
> many queues does rabbitmq-start?
> 
> thanks
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From tonyg at lshift.net  Tue May  6 12:38:36 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Tue, 06 May 2008 12:38:36 +0100
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
In-Reply-To: <591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>
	<591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>
Message-ID: <4820433C.2090005@lshift.net>

Michael Arnoldus wrote:
> =ERROR REPORT==== 5-May-2008::08:46:22 ===
> ** Too many db tables **

This, in particular, is extremely weird. We don't create tables at any
time after broker startup. (If nothing else is creating tables, then
it's likely a symptom of some kind of overload that's being misreported.)

Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From chime at mu.dk  Tue May  6 14:44:43 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Tue, 6 May 2008 15:44:43 +0200
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
In-Reply-To: <4820433C.2090005@lshift.net>
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>
	<591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>
	<4820433C.2090005@lshift.net>
Message-ID: <3F0DF806-F925-4763-BE5E-0AAA07B2C713@mu.dk>


On May 6, 2008, at 13:38 , Tony Garnock-Jones wrote:

> Michael Arnoldus wrote:
>> =ERROR REPORT==== 5-May-2008::08:46:22 ===
>> ** Too many db tables **
>
> This, in particular, is extremely weird. We don't create tables at any
> time after broker startup. (If nothing else is creating tables, then
> it's likely a symptom of some kind of overload that's being  
> misreported.)

I see what you're saying - but to add to the weirdness when this error  
happens we have to restart rabbit and it still doesn't work. The only  
way we have found to make it work again is to delete the mnesia  
directory. So it does seem like something is happening with mnesia.  
Also after the restart this is in the logfile

=INFO REPORT==== 5-May-2008::08:50:05 ===
Exception: Channel 5, Reason {amqp,not_found,'basic.publish'}

If it is any help I can try to recreate the problem and send you a set  
of corrupted mnesia files (or a textfile export).

Michael

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080506/a298f0e6/attachment.bin 

From matthias at lshift.net  Wed May  7 06:00:39 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 07 May 2008 06:00:39 +0100
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
In-Reply-To: <3F0DF806-F925-4763-BE5E-0AAA07B2C713@mu.dk>
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>	<591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>	<4820433C.2090005@lshift.net>
	<3F0DF806-F925-4763-BE5E-0AAA07B2C713@mu.dk>
Message-ID: <48213777.9010807@lshift.net>

Michael,

Michael Arnoldus wrote:
>>> =ERROR REPORT==== 5-May-2008::08:46:22 ===
>>> ** Too many db tables **

> to add to the weirdness when this error happens we have to restart
> rabbit and it still doesn't work. The only way we have found to make
> it work again is to delete the mnesia directory. So it does seem like
> something is happening with mnesia.

I suspect that if rabbit ran out of processes before the restart then it 
may have corrupted mnesia.

> Also after the restart this is in the logfile
> =INFO REPORT==== 5-May-2008::08:50:05 ===
> Exception: Channel 5, Reason {amqp,not_found,'basic.publish'}

That just means the server couldn't find the exchange during a 
basic.publish, which isn't surprising if mnesia is playing up.

> If it is any help I can try to recreate the problem and send you a set 
> of corrupted mnesia files (or a textfile export).

The most promising route of investigation is probably to look at what 
processes are running before the system actually runs out of them.


Matthias.



From chime at mu.dk  Wed May  7 06:35:08 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Wed, 7 May 2008 07:35:08 +0200
Subject: [rabbitmq-discuss] Fwd: RabbitMQ error
In-Reply-To: <48213777.9010807@lshift.net>
References: <4C2D10D0-437F-4560-8EF3-FC8D27C7C85F@wiinz.com>	<591B7B30-EE15-4B60-89F9-AED2728430FE@mu.dk>	<4820433C.2090005@lshift.net>
	<3F0DF806-F925-4763-BE5E-0AAA07B2C713@mu.dk>
	<48213777.9010807@lshift.net>
Message-ID: <ED556CD9-B850-4A5B-A115-646572E6CD11@mu.dk>


On May 7, 2008, at 7:00 , Matthias Radestock wrote:
>
> The most promising route of investigation is probably to look at  
> what processes are running before the system actually runs out of  
> them.
>

Ok, will do!

Michael

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080507/007cbf06/attachment.bin 

From David.Corcoran at edftrading.com  Wed May  7 12:31:48 2008
From: David.Corcoran at edftrading.com (David.Corcoran at edftrading.com)
Date: Wed, 7 May 2008 12:31:48 +0100
Subject: [rabbitmq-discuss] TCP timeouts
Message-ID: <OF08E88F09.1ABD4866-ON80257442.003AED0B-80257442.003F53FD@Edftrading.com>


Hi,

I've run into a problem testing RabbitMQ. My Java clients keep
disconnecting when using a lot of CPU and the error in the RabbitMQ logs
is:
=ERROR REPORT==== 7-May-2008::11:41:44 ===
error on TCP connection from 127.0.0.1:37299
{timeout,frame_header}

I'm using channel.basicGet and I think I've narrowed down the problem. When
I get a message I process it, then call basicAck once it's done. So the
code looks like:
GetResponse basicGet = channel.basicGet(ticket, queueName, false);
 if (basicGet != null) {
        process(basicGet);
        channel.basicAck(basicGet.getEnvelope().getDeliveryTag(), false);
}

if process() looks like this:
            long start = System.currentTimeMillis();
            while(true) {
                long now = System.currentTimeMillis();
                if(now - start > 10000) {
                    break;
                }
            }
The client will disconnect. If I add a Thread.sleep(0) into the loop it
will work fine. The sleep 0 just yields. In my real code it doesn't do that
loop but does do a lot of maths that can take up to about 1 minute so it
has the same effect of killing the CPU for a while.

I guess what's happening is that the connection thread isn't getting any
time to send heartbeats and the server is disconnecting it. Is there a work
around for this? Can I change the heartbeat?

A little more information if that helps:
 - Quad core machine, only using 1 cpu during this test
 - 4GB Ram
 - Erlang 5.5.5 (64bit)
 - Ubunut 64
 - Rabbit mq 1.3.0-1

Thanks,

Dave




*********************************************************************
This communication contains confidential information, some or all of which may be privileged. It is for the intended recipient only and others must not disclose, distribute, copy, print or rely on this communication. If an addressing or transmission error has misdirected this communication, please notify the sender by replying to this e-mail and then delete the e-mail. E-mail sent to EDF Trading may be monitored by the company. Thank you. 
EDF Trading Limited
80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
A Company registered in England No. 4255974. 
Switchboard: 020 7061 4000
EDF Trading Markets Limited is a member of the EDF Trading Limited Group and is authorised and regulated by the Financial Services Authority.
VAT number: GB 735 5479 07
*********************************************************************



From rabbitmq-discuss_efine at usa.net  Wed May  7 16:14:48 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Wed, 7 May 2008 11:14:48 -0400
Subject: [rabbitmq-discuss] Controlling over-producers
In-Reply-To: <6c2563b20805070801gb2b6215s646129895a3bd06f@mail.gmail.com>
References: <6c2563b20805070801gb2b6215s646129895a3bd06f@mail.gmail.com>
Message-ID: <6c2563b20805070814v3cf83f04n361497ac332114c3@mail.gmail.com>

Hi all

 I have looked at the FAQs, and the mailing list about this topic. This
 is what I know so far:

 1. I have an Erlang consumer (using the RabbitMQ Erlang client) that
 has registered using a basic.consume.

 2. The consumer often gets flooded with messages from the producer
 when it does some time-based operations. In Erlang, this means that
 the consumer's Erlang message queue grows to a couple hundred
 messages, which is not what I want. I want the producer to stop
 sending messages when the consumer is too busy.

 Messages must not be lost and are marked persistent, so I want them to
 stay on disk until the consumer acknowledges successful processing. Am
 I correct to assume RabbitMQ does this if I have marked the queue as
 persistent and have not replied to the basic.deliver with an ack?

 3. The channel.flow object is not currently implemented in RabbitMQ; I
 think this would be perfect to do this.

 4. IIRC, a suggestion was for the consumer to basic.cancel itself
 until the load reduces, and then re-subscribe (basic.consume) once the
 overflow condition has abated. This seems heavy-handed, and possibly
 resource-intensive, especially since it might happen relatively
 frequently.

 I'd appreciate any suggestions or clarifications.

 Regards,
 Edwin Fine
 Fine Computer Consultants



From tonyg at lshift.net  Wed May  7 17:02:57 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Wed, 07 May 2008 17:02:57 +0100
Subject: [rabbitmq-discuss] Starting the STOMP adapter automatically (was
 Re: STOMP adapter updated for RabbitMQ v1.3.0)
In-Reply-To: <481ADBCA.7090101@lshift.net>
References: <C43FE575.C096%carl.bourne@intellect.co.uk>
	<481ADBCA.7090101@lshift.net>
Message-ID: <4821D2B1.8020506@lshift.net>

Hi Carl,

I've added a README to the rabbitmq-stomp repository, including the
section below. Please let me know if this works for you!


---cut---
Configuring the broker on Debian to start the plugin automatically
---------------------------------------------------------------------------

If you've installed the rabbitmq-server package on debian or ubuntu,
the broker will pick up extra configuration from
/etc/default/rabbitmq. To tell the server to start your plugin, first
make sure it is compiled, and then add the following text to
/etc/default/rabbitmq:

RABBIT_ARGS='
  -pa /path/to/rabbitmq-stomp/ebin
  -rabbit
     stomp_listeners [{"0.0.0.0",61613}]
     extra_startup_steps [{"STOMP-listeners",rabbit_stomp,kickstart,[]}]'

making sure to update the "/path/to/rabbitmq-stomp/ebin" appropriately
for your system. Then restart the broker with

sudo /etc/init.d/rabbitmq-server restart

You should then be able to connect to port 61613 using a STOMP client
of your choice.
---cut---


Regards,
  Tony


Tony Garnock-Jones wrote:
> Hi Carl,
> 
> Carl Bourne wrote:
>> Tested this earlier today works perfectly!
> 
> Good news :-) Thanks for the report.
> 
>> Just a quick one ? I?ve installed a version RabbitMQ v1.3.0 via the
>> Ubuntu/Deb apt repository. I can start and stop this version using:
>> Usage: /etc/init.d/rabbitmq-server {start|stop|restart|force-reload}
>> Or rabbitmqctl
>> Is it possible to configure a version with the STOMP adapter to work in
>> this way?
> 
> Good question. The short answer is "yes", and the longer answer is that
> I'll make up a recipe for doing so and update the repository. I'll post
> again when I'm done.
> 
> Regards,
>   Tony


-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From matthias at lshift.net  Wed May  7 18:18:16 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 07 May 2008 18:18:16 +0100
Subject: [rabbitmq-discuss] TCP timeouts
In-Reply-To: <OF08E88F09.1ABD4866-ON80257442.003AED0B-80257442.003F53FD@Edftrading.com>
References: <OF08E88F09.1ABD4866-ON80257442.003AED0B-80257442.003F53FD@Edftrading.com>
Message-ID: <4821E458.5050503@lshift.net>

David,

David.Corcoran at edftrading.com wrote:
> I've run into a problem testing RabbitMQ. My Java clients keep
> disconnecting when using a lot of CPU and the error in the RabbitMQ logs
> is:
> =ERROR REPORT==== 7-May-2008::11:41:44 ===
> error on TCP connection from 127.0.0.1:37299
> {timeout,frame_header}
> 
> I'm using channel.basicGet and I think I've narrowed down the problem. When
> I get a message I process it, then call basicAck once it's done. So the
> code looks like:
> GetResponse basicGet = channel.basicGet(ticket, queueName, false);
>  if (basicGet != null) {
>         process(basicGet);
>         channel.basicAck(basicGet.getEnvelope().getDeliveryTag(), false);
> }
> 
> if process() looks like this:
>             long start = System.currentTimeMillis();
>             while(true) {
>                 long now = System.currentTimeMillis();
>                 if(now - start > 10000) {
>                     break;
>                 }
>             }
> The client will disconnect. If I add a Thread.sleep(0) into the loop it
> will work fine. The sleep 0 just yields. In my real code it doesn't do that
> loop but does do a lot of maths that can take up to about 1 minute so it
> has the same effect of killing the CPU for a while.
> 
> I guess what's happening is that the connection thread isn't getting any
> time to send heartbeats and the server is disconnecting it. Is there a work
> around for this? Can I change the heartbeat?
> 
> A little more information if that helps:
>  - Quad core machine, only using 1 cpu during this test
>  - 4GB Ram
>  - Erlang 5.5.5 (64bit)
>  - Ubunut 64
>  - Rabbit mq 1.3.0-1

That is weird. The application thread that is calling process(...), and 
the connection thread are separate threads. The workload on the former 
should not prevent the latter from sending heartbeats, certainly not on 
a quad-core machine.

Can you post the complete example? Also, what version of the jvm are you 
running?


Matthias.



From rabbitmq-discuss_efine at usa.net  Wed May  7 18:57:53 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Wed, 7 May 2008 13:57:53 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
Message-ID: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>

Using Rabbit 1.3.0, Erlang client, Ubuntu Linux Feisty, Erlang R12B-2 64-bit

Consumer channel crashes as follows when I do the following:

1. Subscribe (basic.consume)
2. Unsubscribe (basic.cancel)

The channel crashes handling the basic.cancel_ok. I can't figure out
why. The channel is under some load (about 100 - 130 messages/second).
I haven't yet built a standalone test case to try to reproduce this,
but it happens consistently in my code.

The code to subscribe is:

    #'basic.consume_ok'{consumer_tag = ConsumerTag} =
amqp_channel:call(Channel, BasicConsume, self())

and this works fine.

The code to cancel is

    BasicCancel = #'basic.cancel'{consumer_tag = ConsumerTag, nowait = false},
    #'basic.cancel_ok'{consumer_tag = ConsumerTag} =
amqp_channel:call(Channel, BasicCancel).

The problem seems to be

** {function_clause,
       [{gen_server,reply,
            [<<>>,
             {'basic.cancel_ok',<<"XHG.DELIVERY.Q.HTTP031.HC031">>}]},


What am I doing wrong? Any ideas?
Regards,
Edwin Fine
----------------------------------

=ERROR REPORT==== 7-May-2008::13:42:16 ===
** Generic server <0.138.0> terminating
** Last message in was {method,
                           {'basic.cancel_ok',
                               <<"XHG.DELIVERY.Q.HTTP031.HC031">>},
                           none}
** When Server state == {channel_state,1,<0.132.0>,<0.136.0>,<0.139.0>,
                            #Fun<amqp_network_driver.do.2>,
                            #Fun<amqp_network_driver.do.3>,<<>>,<<>>,false,
                            undefined,
                            {dict,48,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],
                                  [[<<"XHG.DELIVERY.Q.HTTP016.HC016">>|
                                    <0.145.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP038.HC038">>|
                                    <0.295.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP009.HC009">>|
                                    <0.358.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP023.HC023">>|
                                    <0.522.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP001.HC001">>|
                                    <0.905.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP030.HC030">>|
                                    <0.1109.0>]],
                                  [],
                                  [[<<"XHG.DELIVERY.Q.HTTP002.HC002">>|
                                    <0.150.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP017.HC017">>|
                                    <0.1014.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP024.HC024">>|
                                    <0.1062.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP031.HC031">>|
                                    <0.1115.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP039.HC039">>|
                                    <0.1170.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP046.HC046">>|
                                    <0.1220.0>]],
                                  [],
                                  [[<<"XHG.DELIVERY.Q.HTTP003.HC003">>|
                                    <0.919.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP010.HC010">>|
                                    <0.967.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP018.HC018">>|
                                    <0.1025.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP025.HC025">>|
                                    <0.1073.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP032.HC032">>|
                                    <0.1118.0>]],
                                  [],
                                  [[<<"XHG.DELIVERY.Q.HTTP019.HC019">>|
                                    <0.154.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP033.HC033">>|
                                    <0.354.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP004.HC004">>|
                                    <0.927.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP011.HC011">>|
                                    <0.970.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP026.HC026">>|
                                    <0.1076.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP040.HC040">>|
                                    <0.1181.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP048.HC048">>|
                                    <0.1233.0>]],
                                  [],
                                  [[<<"XHG.DELIVERY.Q.HTTP049.HC049">>|
                                    <0.365.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP005.HC005">>|
                                    <0.930.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP012.HC012">>|
                                    <0.980.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP027.HC027">>|
                                    <0.1088.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP034.HC034">>|
                                    <0.1130.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP041.HC041">>|
                                    <0.1185.0>]],
                                  [],
                                  [[<<"XHG.DELIVERY.Q.HTTP006.HC006">>|
                                    <0.940.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP013.HC013">>|
                                    <0.988.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP020.HC020">>|
                                    <0.1039.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP028.HC028">>|
                                    <0.1092.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP035.HC035">>|
                                    <0.1147.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP042.HC042">>|
                                    <0.1188.0>]],
                                  [],
                                  [[<<"XHG.DELIVERY.Q.HTTP050.HC050">>|
                                    <0.226.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP007.HC007">>|
                                    <0.299.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP014.HC014">>|
                                    <0.998.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP021.HC021">>|
                                    <0.1042.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP029.HC029">>|
                                    <0.1097.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP036.HC036">>|
                                    <0.1151.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP043.HC043">>|
                                    <0.1202.0>]],
                                  [],
                                  [[<<"XHG.DELIVERY.Q.HTTP008.HC008">>|
                                    <0.953.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP015.HC015">>|
                                    <0.1001.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP022.HC022">>|
                                    <0.1049.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP037.HC037">>|
                                    <0.1153.0>],
                                   [<<"XHG.DELIVERY.Q.HTTP044.HC044">>|
                                    <0.1205.0>]]}}}}
** Reason for termination ==
** {function_clause,
       [{gen_server,reply,
            [<<>>,
             {'basic.cancel_ok',<<"XHG.DELIVERY.Q.HTTP031.HC031">>}]},
        {amqp_channel,rpc_bottom_half,2},
        {gen_server,handle_msg,5},
        {proc_lib,init_p,5}]}



From 0x6e6562 at gmail.com  Wed May  7 21:29:48 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Wed, 7 May 2008 21:29:48 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
Message-ID: <28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>

Edwin,

On 7 May 2008, at 18:57, Edwin Fine wrote:

> Using Rabbit 1.3.0, Erlang client, Ubuntu Linux Feisty, Erlang  
> R12B-2 64-bit
>
> Consumer channel crashes as follows when I do the following:
>
> 1. Subscribe (basic.consume)
> 2. Unsubscribe (basic.cancel)
>
> The channel crashes handling the basic.cancel_ok. I can't figure out
> why. The channel is under some load (about 100 - 130 messages/second).
> I haven't yet built a standalone test case to try to reproduce this,
> but it happens consistently in my code.
>
> The code to subscribe is:
>
>    #'basic.consume_ok'{consumer_tag = ConsumerTag} =
> amqp_channel:call(Channel, BasicConsume, self())
>
> and this works fine.
>
> The code to cancel is
>
>    BasicCancel = #'basic.cancel'{consumer_tag = ConsumerTag, nowait  
> = false},
>    #'basic.cancel_ok'{consumer_tag = ConsumerTag} =
> amqp_channel:call(Channel, BasicCancel).
>
> The problem seems to be
>
> ** {function_clause,
>       [{gen_server,reply,
>            [<<>>,
>             {'basic.cancel_ok',<<"XHG.DELIVERY.Q.HTTP031.HC031">>}]},
>
>
> What am I doing wrong? Any ideas?

What you are seeing is a symptom of an error in the RPC handling.  
Essentially, the channel process is receiving a notification that it  
thinks it has already sent to the invoking process.

It would be really good if you could send some code that might help me  
reproduce this myself.

In the meantime I will look into this and see if I can come up with a  
solution.

HTH,

Ben




From 0x6e6562 at gmail.com  Wed May  7 22:03:20 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Wed, 7 May 2008 22:03:20 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>
	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
Message-ID: <30ADE63E-6441-4580-A705-0BEE8168AADD@gmail.com>

Just quickly before you start doing stuff:

Does it make a difference if you just the direct client rather than  
the TCP client?

Ben

On 7 May 2008, at 21:50, Edwin Fine wrote:

> Thanks for the response, Ben. I will try to create a standalone  
> program that reproduces  the issue. I hope I can do it. The  
> hesitation comes because the circumstances under which this occurred  
> are:
> 50 queues on one <<direct>> exchange
> A producer that is pushing 150 messages/second to the queues, evenly  
> across the queue name
> Each queue is doing a basic.deliver to one of 50 Erlang consumer  
> processes (gen_event). The consumer processes all share the same  
> channel (which may not be a good idea, because when the channel  
> crashed, so did all 50 consumers. I wonder if I should have 1  
> channel for each consumer? Too heavy?).
> Because the channel.flow command is not implemented, I am using  
> unsubscribe to try to do flow control, because I am finding that  
> RabbitMQ is dumping all the basic.deliver messages into the Erlang  
> message queue of each consumer gen_event process. This is totally  
> not what I want - I want the messages to stay persisted in Rabbit- 
> land until I can deliver them and tell Rabbit to release them.
> The reason I need flow control is because I am delivering messages  
> via HTTP/XML to a number of different Web sites. Sometimes a web  
> site may be down, often for hours, and I want to just be able to  
> pause the consumer (and producer) until messages start going through  
> again. Having the Erlang message queues filling up with thousands of  
> messages will eventually crash the VM due to OOM. I know I can poll  
> with basic.get, but the conundrum is that I want high performance  
> while the web sites are accepting input, and shut-off when they are  
> not. Any suggestions?
> So I may have to build a simulated version of the above to get the  
> problem to happen again. That's the hesitation - will it trigger the  
> error?
>
> Anyway, I am probably not doing this the right way, but I have no  
> expertise in AMQP. My knowledge is of MQSeries a few years back.
>
> Regards,
> Edwin Fine
>
> On Wed, May 7, 2008 at 4:29 PM, Ben Hood <0x6e6562 at gmail.com> wrote:
> Edwin,
>
>
> On 7 May 2008, at 18:57, Edwin Fine wrote:
>
> Using Rabbit 1.3.0, Erlang client, Ubuntu Linux Feisty, Erlang  
> R12B-2 64-bit
>
> Consumer channel crashes as follows when I do the following:
>
> 1. Subscribe (basic.consume)
> 2. Unsubscribe (basic.cancel)
>
> The channel crashes handling the basic.cancel_ok. I can't figure out
> why. The channel is under some load (about 100 - 130 messages/second).
> I haven't yet built a standalone test case to try to reproduce this,
> but it happens consistently in my code.
>
> The code to subscribe is:
>
>   #'basic.consume_ok'{consumer_tag = ConsumerTag} =
> amqp_channel:call(Channel, BasicConsume, self())
>
> and this works fine.
>
> The code to cancel is
>
>   BasicCancel = #'basic.cancel'{consumer_tag = ConsumerTag, nowait =  
> false},
>   #'basic.cancel_ok'{consumer_tag = ConsumerTag} =
> amqp_channel:call(Channel, BasicCancel).
>
> The problem seems to be
>
> ** {function_clause,
>      [{gen_server,reply,
>           [<<>>,
>            {'basic.cancel_ok',<<"XHG.DELIVERY.Q.HTTP031.HC031">>}]},
>
>
> What am I doing wrong? Any ideas?
>
> What you are seeing is a symptom of an error in the RPC handling.  
> Essentially, the channel process is receiving a notification that it  
> thinks it has already sent to the invoking process.
>
> It would be really good if you could send some code that might help  
> me reproduce this myself.
>
> In the meantime I will look into this and see if I can come up with  
> a solution.
>
> HTH,
>
> Ben
>
>
>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080507/8be5afe7/attachment.htm 

From 0x6e6562 at gmail.com  Wed May  7 22:28:43 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Wed, 7 May 2008 22:28:43 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>
	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
Message-ID: <1EC6CAF8-641A-4B2C-A6B3-5C0DF4A78648@gmail.com>

BTW Edwin, I reposting this to the list, so it can be followed.

On 7 May 2008, at 21:50, Edwin Fine wrote:

> Thanks for the response, Ben. I will try to create a standalone  
> program that reproduces  the issue. I hope I can do it. The  
> hesitation comes because the circumstances under which this occurred  
> are:
> 50 queues on one <<direct>> exchange
Shouldn't be an issue.

> A producer that is pushing 150 messages/second to the queues, evenly  
> across the queue name

Shouldn't be an issue.
> Each queue is doing a basic.deliver to one of 50 Erlang consumer  
> processes (gen_event). The consumer processes all share the same  
> channel (which may not be a good idea, because when the channel  
> crashed, so did all 50 consumers. I wonder if I should have 1  
> channel for each consumer? Too heavy?).
Good question. The golden answer I guess is not too little, not too  
much ;-) Your mileage will vary.

If there is a bug, however, the channel process will bring all of the  
consumers that are linked to it. So from a *resiliency* perspective,  
you might want to have more than one channel process. Having said  
that, I would prefer to find out what the cause was and identify  
whether there is a bug that needs to fixed.

In terms of the difference this makes on overall throughput, I think  
the answer is that it depends. Using the network client you are  
receiving serially from a single client socket, so it may be 6 of one  
and half a dozen of the other. In the direct case, you may see more  
leverage effect here.

> Because the channel.flow command is not implemented, I am using  
> unsubscribe to try to do flow control, because I am finding that  
> RabbitMQ is dumping all the basic.deliver messages into the Erlang  
> message queue of each consumer gen_event process. This is totally  
> not what I want - I want the messages to stay persisted in Rabbit- 
> land until I can deliver them and tell Rabbit to release them.
At the moment, Rabbit is designed to deliver a message if it can.  
Control flow is more of a server implementation issue. Thoughts anyone?

> The reason I need flow control is because I am delivering messages  
> via HTTP/XML to a number of different Web sites. Sometimes a web  
> site may be down, often for hours, and I want to just be able to  
> pause the consumer (and producer) until messages start going through  
> again. Having the Erlang message queues filling up with thousands of  
> messages will eventually crash the VM due to OOM. I know I can poll  
> with basic.get, but the conundrum is that I want high performance  
> while the web sites are accepting input, and shut-off when they are  
> not. Any suggestions?

One strategy that springs to mind to turn the no_ack flag when sending  
the consume command to the broker. I will have to have a look to see  
what the behaviour of this, because I don't know off the top my head.  
Alternatively if you can detect the failure of a web site, can you  
actively cancel the subscription?


>
> So I may have to build a simulated version of the above to get the  
> problem to happen again. That's the hesitation - will it trigger the  
> error?
>

Let's hope so. If not, and if you feel comfortable with it, you send  
you raw code base.

> Anyway, I am probably not doing this the right way, but I have no  
> expertise in AMQP. My knowledge is of MQSeries a few years back.

I don't think this will be a problem :-) AMQP is not MQ :-)

HTH,

Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080507/c166d442/attachment.htm 

From matthias at lshift.net  Wed May  7 22:39:41 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 07 May 2008 22:39:41 +0100
Subject: [rabbitmq-discuss] Controlling over-producers
In-Reply-To: <6c2563b20805070814v3cf83f04n361497ac332114c3@mail.gmail.com>
References: <6c2563b20805070801gb2b6215s646129895a3bd06f@mail.gmail.com>
	<6c2563b20805070814v3cf83f04n361497ac332114c3@mail.gmail.com>
Message-ID: <4822219D.40504@lshift.net>

Edwin,

Edwin Fine wrote:
>  2. The consumer often gets flooded with messages from the producer
>  when it does some time-based operations. In Erlang, this means that
>  the consumer's Erlang message queue grows to a couple hundred
>  messages, which is not what I want. I want the producer to stop
>  sending messages when the consumer is too busy.

Do you require end-to-end flow control, i.e. you need to throttle the 
publisher of the messages when the consumer cannot keep up, or just flow 
control between the broker and the consumer?

>  Messages must not be lost and are marked persistent, so I want them to
>  stay on disk until the consumer acknowledges successful processing. Am
>  I correct to assume RabbitMQ does this if I have marked the queue as
>  persistent and have not replied to the basic.deliver with an ack?

The messages themselves need to be marked as persistent, and the queue 
needs to be marked as durable.

>  3. The channel.flow object is not currently implemented in RabbitMQ; I
>  think this would be perfect to do this.

channel.flow is rather imperfect :) For starters, it operates on an 
entire channel, whereas it looks like you want it to operate on a 
per-consumer basis.

>  4. IIRC, a suggestion was for the consumer to basic.cancel itself
>  until the load reduces, and then re-subscribe (basic.consume) once the
>  overflow condition has abated. This seems heavy-handed, and possibly
>  resource-intensive, especially since it might happen relatively
>  frequently.

The frequency is unlikely to be an issue - basic.consume/cancel are 
pretty efficient.

The more serious problem may be prefetching. By the time your consumer 
wants to start throttling there may already be a large number of 
messages in flight. The client will still receive these after issuing a 
basic.cancel, or, for that matter, channel.flow.

You can address that by switching to use basic.get, though that is 
non-blocking.


Matthias



From rabbitmq-discuss_efine at usa.net  Wed May  7 23:05:54 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Wed, 7 May 2008 18:05:54 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <30ADE63E-6441-4580-A705-0BEE8168AADD@gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>
	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
	<30ADE63E-6441-4580-A705-0BEE8168AADD@gmail.com>
Message-ID: <6c2563b20805071505q1ef73c25i34fb9fb85e9700b0@mail.gmail.com>

Ben,

Umm, I haven't used the direct client at all because I have a whole complex
application set up and it would have to run on the same Erlang node as
RabbitMQ, if I understand how the direct client works. I would have to
attach to the Rabbit node, set up all the right paths, and then start my
application. I'll try that and if there are not too many complications (e.g.
something silly like something in my application might expect a specific
node name), I will let you know what happens.

Thanks for your attention!

Regards,
Edwin

On Wed, May 7, 2008 at 5:03 PM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Just quickly before you start doing stuff:
> Does it make a difference if you just the direct client rather than the
> TCP client?
>
> Ben
>
> On 7 May 2008, at 21:50, Edwin Fine wrote:
>
> Thanks for the response, Ben. I will try to create a standalone program
> that reproduces  the issue. I hope I can do it. The hesitation comes because
> the circumstances under which this occurred are:
>
>    - 50 queues on one <<direct>> exchange
>    - A producer that is pushing 150 messages/second to the queues,
>    evenly across the queue name
>    - Each queue is doing a basic.deliver to one of 50 Erlang consumer
>    processes (gen_event). The consumer processes all share the same channel
>    (which may not be a good idea, because when the channel crashed, so did all
>    50 consumers. I wonder if I should have 1 channel for each consumer? Too
>    heavy?).
>    - Because the channel.flow command is not implemented, I am using
>    unsubscribe to try to do flow control, because I am finding that RabbitMQ is
>    dumping all the basic.deliver messages into the Erlang message queue of each
>    consumer gen_event process. This is totally not what I want - I want the
>    messages to stay persisted in Rabbit-land until I can deliver them and tell
>    Rabbit to release them.
>    - The reason I need flow control is because I am delivering messages
>    via HTTP/XML to a number of different Web sites. Sometimes a web site may be
>    down, often for hours, and I want to just be able to pause the consumer (and
>    producer) until messages start going through again. Having the Erlang
>    message queues filling up with thousands of messages will eventually crash
>    the VM due to OOM. I know I can poll with basic.get, but the conundrum is
>    that I want high performance while the web sites are accepting input, and
>    shut-off when they are not. Any suggestions?
>
> So I may have to build a simulated version of the above to get the problem
> to happen again. That's the hesitation - will it trigger the error?
>
> Anyway, I am probably not doing this the right way, but I have no
> expertise in AMQP. My knowledge is of MQSeries a few years back.
>
> Regards,
> Edwin Fine
>
> On Wed, May 7, 2008 at 4:29 PM, Ben Hood <0x6e6562 at gmail.com> wrote:
>
> > Edwin,
> >
> > On 7 May 2008, at 18:57, Edwin Fine wrote:
> >
> >  Using Rabbit 1.3.0, Erlang client, Ubuntu Linux Feisty, Erlang R12B-2
> > > 64-bit
> > >
> > > Consumer channel crashes as follows when I do the following:
> > >
> > > 1. Subscribe (basic.consume)
> > > 2. Unsubscribe (basic.cancel)
> > >
> > > The channel crashes handling the basic.cancel_ok. I can't figure out
> > > why. The channel is under some load (about 100 - 130 messages/second).
> > > I haven't yet built a standalone test case to try to reproduce this,
> > > but it happens consistently in my code.
> > >
> > > The code to subscribe is:
> > >
> > >   #'basic.consume_ok'{consumer_tag = ConsumerTag} =
> > > amqp_channel:call(Channel, BasicConsume, self())
> > >
> > > and this works fine.
> > >
> > > The code to cancel is
> > >
> > >   BasicCancel = #'basic.cancel'{consumer_tag = ConsumerTag, nowait =
> > > false},
> > >   #'basic.cancel_ok'{consumer_tag = ConsumerTag} =
> > > amqp_channel:call(Channel, BasicCancel).
> > >
> > > The problem seems to be
> > >
> > > ** {function_clause,
> > >      [{gen_server,reply,
> > >           [<<>>,
> > >            {'basic.cancel_ok',<<"XHG.DELIVERY.Q.HTTP031.HC031">>}]},
> > >
> > >
> > > What am I doing wrong? Any ideas?
> > >
> >
> > What you are seeing is a symptom of an error in the RPC handling.
> > Essentially, the channel process is receiving a notification that it thinks
> > it has already sent to the invoking process.
> >
> > It would be really good if you could send some code that might help me
> > reproduce this myself.
> >
> > In the meantime I will look into this and see if I can come up with a
> > solution.
> >
> > HTH,
> >
> > Ben
> >
> >
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080507/f9763aca/attachment.htm 

From rabbitmq-discuss_efine at usa.net  Wed May  7 23:11:58 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Wed, 7 May 2008 18:11:58 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <1EC6CAF8-641A-4B2C-A6B3-5C0DF4A78648@gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>
	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
	<1EC6CAF8-641A-4B2C-A6B3-5C0DF4A78648@gmail.com>
Message-ID: <6c2563b20805071511t533fa9aeo970b660821606035@mail.gmail.com>

Ben,

<snip>
>


> One strategy that springs to mind to turn the no_ack flag when sending the
> consume command to the broker. I will have to have a look to see what the
> behaviour of this, because I don't know off the top my head. Alternatively
> if you can detect the failure of a web site, can you actively cancel the
> subscription?
>

***** Actually,  I believe I have turned off the no_ack flag and am actively
sending acks when appropriate.:

    BasicConsume = #'basic.consume'{
        ticket = Ticket,
        queue = Qname,
        consumer_tag = Tag,
        no_local = false,
        no_ack = false,     % false -> keep msg in queue until consumer
sends basic.ack ********
        exclusive = true,   % We only want one consumer ever on this queue
        nowait = false      % We want to wait for a response from the server
to this message
    },

However, I must have done something wrong because RMQ continues to send even
if I haven't acked.

As for canceling, that's exactly what I am doing, and that's what's crashing
the channel :)

Ed
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080507/39cc8a98/attachment.htm 

From 0x6e6562 at gmail.com  Wed May  7 23:16:19 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Wed, 7 May 2008 23:16:19 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805071505q1ef73c25i34fb9fb85e9700b0@mail.gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>
	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
	<30ADE63E-6441-4580-A705-0BEE8168AADD@gmail.com>
	<6c2563b20805071505q1ef73c25i34fb9fb85e9700b0@mail.gmail.com>
Message-ID: <15D7A323-2E57-4FF9-B41D-ACCF9F48B561@gmail.com>

Edwin,

On 7 May 2008, at 23:05, Edwin Fine wrote:
> Umm, I haven't used the direct client at all because I have a whole  
> complex application set up and it would have to run on the same  
> Erlang node as RabbitMQ, if I understand how the direct client works.

That's right. It uses native Erlang message passing instead of TCP in  
a way that is transparent to the client. As a direct client you can  
think of Rabbit as being an embedded broker, like the way ActiveMQ is  
often run in the same process and the client.

> I would have to attach to the Rabbit node, set up all the right  
> paths, and then start my application. I'll try that and if there are  
> not too many complications (e.g. something silly like something in  
> my application might expect a specific node name), I will let you  
> know what happens.

You don't necessarily need to attach to a node.  You *should* be able  
to use the direct client in exactly the same way as the TCP client.  
 From the client's prespective the API calls are exactly the same. All  
you need to do is to boot Rabbit in the same VM and the client  
process, which means just adding a few arguments to the Erlang  
runtime, e.g.

erl -pa $PATH_TO_RABBIT_EBIN_DIR $PATH_TO_YOUR_CLIENT_EBIN_DIR -mnesia  
dir $MNESIA_DIR -boot start_sasl -s rabbit

Ben



From rabbitmq-discuss_efine at usa.net  Wed May  7 23:26:00 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Wed, 7 May 2008 18:26:00 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <15D7A323-2E57-4FF9-B41D-ACCF9F48B561@gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>
	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
	<30ADE63E-6441-4580-A705-0BEE8168AADD@gmail.com>
	<6c2563b20805071505q1ef73c25i34fb9fb85e9700b0@mail.gmail.com>
	<15D7A323-2E57-4FF9-B41D-ACCF9F48B561@gmail.com>
Message-ID: <6c2563b20805071526w2eddf971u64842294abd6df44@mail.gmail.com>

>
> You don't necessarily need to attach to a node.  You *should* be able to
> use the direct client in exactly the same way as the TCP client. From the
> client's prespective the API calls are exactly the same. All you need to do
> is to boot Rabbit in the same VM and the client process, which means just
> adding a few arguments to the Erlang runtime, e.g.
>
> erl -pa $PATH_TO_RABBIT_EBIN_DIR $PATH_TO_YOUR_CLIENT_EBIN_DIR -mnesia dir
> $MNESIA_DIR -boot start_sasl -s rabbit


I will try that. I could probably combine the two applications in my pet
development shell script.  Thanks.

>
>
> Ben
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080507/490a4f4c/attachment.htm 

From matthias at lshift.net  Thu May  8 05:22:17 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 08 May 2008 05:22:17 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805071511t533fa9aeo970b660821606035@mail.gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>	<1EC6CAF8-641A-4B2C-A6B3-5C0DF4A78648@gmail.com>
	<6c2563b20805071511t533fa9aeo970b660821606035@mail.gmail.com>
Message-ID: <48227FF9.5000300@lshift.net>

Edwin Fine wrote:
> ***** Actually,  I believe I have turned off the no_ack flag and am 
> actively sending acks when appropriate. [...]
> However, I must have done something wrong because RMQ continues to send 
> even if I haven't acked.

You haven't done anything wrong. The no_ack flag controls whether the 
server expects to see acks from the client, or just auto-acks the 
messages itself. The flag does not affect the flow of messages.


Matthias.



From rabbitmq-discuss_efine at usa.net  Thu May  8 06:15:38 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Thu, 8 May 2008 01:15:38 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <48227FF9.5000300@lshift.net>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>
	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
	<1EC6CAF8-641A-4B2C-A6B3-5C0DF4A78648@gmail.com>
	<6c2563b20805071511t533fa9aeo970b660821606035@mail.gmail.com>
	<48227FF9.5000300@lshift.net>
Message-ID: <6c2563b20805072215l6cc02986k71c380480b500b5f@mail.gmail.com>

That's true. It seems that all that happens is that the messages (which are
persistent in my case) are maintained in the queue and do not get removed
until the acks are received. However, all the messages are still sent. I
assume they would be retransmitted at some point. It's quite interesting :).

Ed

On Thu, May 8, 2008 at 12:22 AM, Matthias Radestock <matthias at lshift.net>
wrote:

> Edwin Fine wrote:
>
> > ***** Actually,  I believe I have turned off the no_ack flag and am
> > actively sending acks when appropriate. [...]
> > However, I must have done something wrong because RMQ continues to send
> > even if I haven't acked.
> >
>
> You haven't done anything wrong. The no_ack flag controls whether the
> server expects to see acks from the client, or just auto-acks the messages
> itself. The flag does not affect the flow of messages.
>
>
> Matthias.
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/d897301a/attachment.htm 

From David.Corcoran at edftrading.com  Thu May  8 09:29:04 2008
From: David.Corcoran at edftrading.com (David.Corcoran at edftrading.com)
Date: Thu, 8 May 2008 09:29:04 +0100
Subject: [rabbitmq-discuss] TCP timeouts
In-Reply-To: <4821E458.5050503@lshift.net>
Message-ID: <OF611AF1FD.0B97C545-ON80257443.002D31B0-80257443.002E9B4F@Edftrading.com>

Hi Matthias,

It looks like you were right about the java version. Running in java
1.5.0.15 doesn't work. Running in java-6-openjdk or java-6 (1.6.0.06) works
fine. I think it's a bug, perhaps related to this:
http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6383015

I've attached the code that displays the problem. Putting back the
Thread.yield() in java 5 makes it work, but obviously isn't a viable
solution.

I guess it's time we upgrade to java 6 ;)

Thanks again for your help,

Dave

(See attached file: TimeoutTest.java)




                                                                           
             Matthias                                                      
             Radestock                                                     
             <matthias at lshift.                                          To 
             net>                      David.Corcoran at edftrading.com       
             Sent by:                                                   cc 
             rabbitmq-discuss-         rabbitmq-discuss at lists.rabbitmq.com 
             bounces at lists.rab                                     Subject 
             bitmq.com                 Re: [rabbitmq-discuss] TCP timeouts 
                                                                           
                                                                           
             07/05/2008 18:18                                              
                                                                           
                                                                           
                                                                           





David,

David.Corcoran at edftrading.com wrote:
> I've run into a problem testing RabbitMQ. My Java clients keep
> disconnecting when using a lot of CPU and the error in the RabbitMQ logs
> is:
> =ERROR REPORT==== 7-May-2008::11:41:44 ===
> error on TCP connection from 127.0.0.1:37299
> {timeout,frame_header}
>
> I'm using channel.basicGet and I think I've narrowed down the problem.
When
> I get a message I process it, then call basicAck once it's done. So the
> code looks like:
> GetResponse basicGet = channel.basicGet(ticket, queueName, false);
>  if (basicGet != null) {
>         process(basicGet);
>         channel.basicAck(basicGet.getEnvelope().getDeliveryTag(), false);
> }
>
> if process() looks like this:
>             long start = System.currentTimeMillis();
>             while(true) {
>                 long now = System.currentTimeMillis();
>                 if(now - start > 10000) {
>                     break;
>                 }
>             }
> The client will disconnect. If I add a Thread.sleep(0) into the loop it
> will work fine. The sleep 0 just yields. In my real code it doesn't do
that
> loop but does do a lot of maths that can take up to about 1 minute so it
> has the same effect of killing the CPU for a while.
>
> I guess what's happening is that the connection thread isn't getting any
> time to send heartbeats and the server is disconnecting it. Is there a
work
> around for this? Can I change the heartbeat?
>
> A little more information if that helps:
>  - Quad core machine, only using 1 cpu during this test
>  - 4GB Ram
>  - Erlang 5.5.5 (64bit)
>  - Ubunut 64
>  - Rabbit mq 1.3.0-1

That is weird. The application thread that is calling process(...), and
the connection thread are separate threads. The workload on the former
should not prevent the latter from sending heartbeats, certainly not on
a quad-core machine.

Can you post the complete example? Also, what version of the jvm are you
running?


Matthias.

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


*********************************************************************
This communication contains confidential information, some or all of which may be privileged. It is for the intended recipient only and others must not disclose, distribute, copy, print or rely on this communication. If an addressing or transmission error has misdirected this communication, please notify the sender by replying to this e-mail and then delete the e-mail. E-mail sent to EDF Trading may be monitored by the company. Thank you. 
EDF Trading Limited
80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
A Company registered in England No. 4255974. 
Switchboard: 020 7061 4000
EDF Trading Markets Limited is a member of the EDF Trading Limited Group and is authorised and regulated by the Financial Services Authority.
VAT number: GB 735 5479 07
*********************************************************************
-------------- next part --------------
A non-text attachment was scrubbed...
Name: TimeoutTest.java
Type: application/octet-stream
Size: 1795 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/2ab8f6ee/attachment.obj 

From 0x6e6562 at gmail.com  Thu May  8 11:07:05 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 8 May 2008 11:07:05 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805072213i60e40d2do3ed0bbbf9f72057a@mail.gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>
	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>
	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>
	<30ADE63E-6441-4580-A705-0BEE8168AADD@gmail.com>
	<6c2563b20805071505q1ef73c25i34fb9fb85e9700b0@mail.gmail.com>
	<15D7A323-2E57-4FF9-B41D-ACCF9F48B561@gmail.com>
	<6c2563b20805072213i60e40d2do3ed0bbbf9f72057a@mail.gmail.com>
Message-ID: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>

Ed,

On 8 May 2008, at 06:13, Edwin Fine wrote:
>
> Well, I have put most of the code I am using into a test program  
> (two modules). This code is not for the mailing list's consumption,  
> if that's ok with you. The problem is, I can't even make the code  
> work for more than 1 consumer and I don't know why. I think I am too  
> tired. In any case, the two modules included are:
> rabbit_chan_crash.erl - The actual test program, which contains most  
> of the Rabbit-related working code;
I've run you code. The problem that that you are executing synchronous  
RPCs on the same channel concurrently, which doesn't work, because the  
protocol flow stipulates that a client performs a blocking receive for  
synchronous commands within a channel.

By doing this though, you have uncovered a bug in the synchronous RPC  
handling code in the client that doesn't protect against this  
properly. So I've fixed this bug and will send it down to the  
repository.

This will not solve your problem, it will just make a clearer  
indication of what went wrong. When designing the client, we  
deliberated whether the client channel module should contain the  
intelligence to queue up pending RPC requests in order to accept  
concurrent requests from user code and essentially serialize their  
dispatch to the server. Initially, we decided against this approach  
because of the complexity it introduces. In general, queue declaration  
and binding is an operation that you don't need to perform  
concurrently per channel. While I think that this view is still valid,  
your use case may provide some food for thought. Thoughts anyone?

To solve your problem, you can do one of a few things:

1. Refactor your code so that synchronous RPCs are not executed in  
parallel (e.g. QueueDeclare, QueueBind, etc) within one channel process;
2. Manage by exception - catch an illegal_pending_rpc error (which is  
the bug fix I just put in) and resend the request;
3. Use more channel processes - this *may* be a bit heavy weight for  
the TCP client, this is better suited to the direct client.

If you want to go down route 2, let me know because we're currently in  
the process of moving the source code from monotone to mercurial.

BTW, I see that you've made a local modification to the  
amqp_connection module to export the start/4 function which allows the  
caller to specify a virtual host. This is probably a good idea and we  
may incorporate this into the API.

> rbmq_admin.erl - An interface to the admin part of Rabbit that I  
> wrote because I wanted to be able to create exchanges, users, etc  
> from within Erlang instead of the command line. Feel free to use  
> this if you think it's of any use, or improve it - feedback welcome.  
> Actually, at some point I want to write a full Web admin interface  
> for Rabbit. Real Soon Now.
Glad you've mentioned this topic. I've done some initial work of doing  
some remote management of Rabbit, if and when you actually want to get  
going, it will probably be a good idea to start a separate discussion  
thread on this one. There are many design issues that would need to be  
discussed, most importantly dependencies that may arise.


> To compile you will need all the usual RabbitMQ paths, and the  
> Erlang client of course. You will also need .erlang.cookie or  
> setcookie with your Rabbit's cookie. I am pretty sure there are no  
> external dependencies other than Rabbit and Erlang.
>
> To run is simple (but please note that the code will try to create a  
> user named emf_test, and an exchange and a bunch of queues). Feel  
> free to hack into shape if you have the time and interest. Tomorrow  
> I will try to run Rabbit and my code co-located.
>
> >rabbit_chan_crash:go(rabbit at mynode, NumConsumers, NumMsgsPerSec).
> >rabbit_chan_crash:stop(). % If you can even read the screen to type  
> this in :)
>
> When I use rabbit_chan_crash:go(rabbit at mynode, 1, 10) it's all good.
> When I use rabbit_chan_crash:go(rabbit at mynode, 2, 10) it's all bad.  
> I don't know what I am doing wrong, but my other code works (each  
> consumer is in its own gen_event server, which is probably why. I  
> think I am getting messages in the wrong message queues due to my  
> lack of Erlang experience. And I am tired, too).
>
> Anyway I have included the "bad" output.
>
> If you have any luck please let me know. Feedback welcome, too.
>
> Regards,
> Ed
>
> (xhg at ender)3> rabbit_chan_crash:go(rabbit at ender,2,10).
> Setting up channel on realm <<"/data">> for connection  
> {<0.60.0>,network}
> Access granted for channel <0.65.0> on realm <<"/data">> for  
> connection {<0.60.0>,
>                                                                          network 
> }
> Declaring exchange <<"emf_test">> using ticket 101
> Declared exchange <<"emf_test">> using ticket 101
> Declaring queue <<"EMF_TEST_Q.1">>
> Declared queue <<"EMF_TEST_Q.1">>, msgc = 0, cons_c = 0
> Declaring queue <<"EMF_TEST_Q.2">>
> Declared queue <<"EMF_TEST_Q.2">>, msgc = 0, cons_c = 0
> Environment setup complete, rmq_state =
> {rmq_state,"guest","guest",
>            {<0.60.0>,network},
>            <0.65.0>,101,<<"emf_test">>,<<"/data">>,<<"/emf_test">>,
>            rabbit at ender,2}
> Consumers started: [<0.69.0>,<0.70.0>]
> [<0.69.0>] Started consumer tag <<"EMF_TEST_Q.1">> for existing  
> channel/ticket/queue <0.65.0>/101/<<"EMF_TEST_Q.1">>
> [<0.70.0>] Started consumer tag <<"EMF_TEST_Q.2">> for existing  
> channel/ticket/queue <0.65.0>/101/<<"EMF_TEST_Q.2">>
> <0.68.0>
> Producer started: <0.71.0>
> Binding queue <<"EMF_TEST_Q.1">>, ticket 101, exchange  
> <<"emf_test">>, routing key <<"EMF_TEST_Q.1">>
> Binding queue <<"EMF_TEST_Q.2">>, ticket 101, exchange  
> <<"emf_test">>, routing key <<"EMF_TEST_Q.2">>
> Bound queue <<"EMF_TEST_Q.2">> to exchange <<"emf_test">>
> Subscribing consumer <<"EMF_TEST_Q.2">> to channel <0.65.0>
> (xhg at ender)4>
> =ERROR REPORT==== 8-May-2008::00:57:23 ===
> ** Generic server <0.65.0> terminating
> ** Last message in was {method,{'basic.consume_ok',<<"EMF_TEST_Q. 
> 2">>},none}
> ** When Server state == {channel_state,1,<0.60.0>,<0.62.0>,<0.66.0>,
>                             #Fun<amqp_network_driver.do.2>,
>                             #Fun<amqp_network_driver.do. 
> 3>,<<>>,<0.70.0>,
>                             false,undefined,
>                             {dict,0,16,16,8,80,48,
>                                 {[],[],[],[],[],[],[],[],[],[],[],[], 
> [],[],[],
>                                  []},
>                                 {{[],[],[],[],[],[],[],[],[],[],[], 
> [],[],[],
>                                   [],[]}}}}
> ** Reason for termination ==
> ** {function_clause,[{gen_server,reply,
>                                  [<<>>,
>                                   {'basic.consume_ok',<<"EMF_TEST_Q. 
> 2">>}]},
>                      {amqp_channel,rpc_bottom_half,2},
>                      {amqp_channel,handle_method,2},
>                      {gen_server,handle_msg,5},
>                      {proc_lib,init_p,5}]}
>
> =ERROR REPORT==== 8-May-2008::00:57:23 ===
> Error in process <0.70.0> on node 'xhg at ender' with exit value:  
> {{badmatch,{'queue.bind_ok'}},[{rabbit_chan_crash,subscribe,2}, 
> {rabbit_chan_crash,consumer,5}]}
> ---------


HTH,

Ben

PS I'm attaching your code to the list for reference.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: chan_crash_test_src.tar.gz
Type: application/x-gzip
Size: 5093 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment.bin 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment-0001.htm 

From rabbitmq-discuss_efine at usa.net  Thu May  8 15:04:52 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Thu, 8 May 2008 10:04:52 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
Message-ID: <6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>

Ben,
Thanks for looking into this. In the "real" code, all the setup is actually
done within a single Erlang process, and the only thing the consumers do is
handle the basic.deliver, as well as any basic.consume_ok  or
basic.cancel_ok messages that may arise. In the test code, I rearranged some
things specifically to be done concurrently, which I now see was a mistake.
However, this is a bug in the test code, not in the production code. I will
change the test code so that there is no concurrent work being done on a
channel other than responding with basic.ack to basic.deliver messages.

I note that there is a special version of amqp_channel:send/3, used only for
a basic.consume method, with the last argument being the pid of the process
subscribing. Am I correct to assume because of this that the basic.consume
method can indeed be sent concurrently by different consumers on the same
channel? But the basic.cancel operation does not have this property
(specifying a PID in the amqp call) , as far as I can see, which means that
a consumer cannot cancel its own subscription without potentially clashing
with other consumers that are canceling.

So I will change the code back so that everything OTHER than basic.consume
and basic.cancel is done within a single process, and take it from there.

I think this has, however, shed some light on what might have happened in
the production code. *I am using the consumer process to unsubscribe itself.
* When there are many consumer processes, this could be a problem because I
think basic.cancel does not allow you to specify a return pid and maybe this
is causing upset in the channel.

    #'basic.consume_ok'{consumer_tag = ConsumerTag} =
amqp_channel:call(Channel, BasicConsume, *self()*), %%% Notice return pid
    #'basic.cancel_ok'{consumer_tag = ConsumerTag} =
amqp_channel:call(Channel, BasicCancel), %%% Notice - no return pid

So maybe this should be added to the handling of basic.cancel? Why shouldn't
a consumer cancel itself? In fact, why can't all client channel calls
specify which PID is calling?

One other source of confusion for me is this: when sending an
amqp_channel:basic.consume call, why is there both a synchronous response to
the call itself and an asynchronous response on the channel?

    #'basic.consume_ok'{consumer_tag = ConsumerTag} =
amqp_channel:call(Channel, BasicConsume, self()),
    receive
        #'basic.consume_ok'{consumer_tag = ConsumerTag} ->
            io:format("[~p] ~p got consume_ok~n", [self(),
BasicConsume#'basic.consume'.consumer_tag])
    end.

Thanks for your help again.

Regards,
Edwin Fine
On Thu, May 8, 2008 at 7:39 AM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Ed,
> You may want to hang on a second with implementing any of the described
> workarounds because I've had thought of how to solve this in the client, but
> I want to run it past the Rabbit dev list first.
>
> HTH,
>
> Ben
>
> Begin forwarded message:
>
> *From: *Ben Hood <0x6e6562 at gmail.com>
> *Date: *8 May 2008 11:07:05 BST
> *To: *rabbitmq-discuss at lists.rabbitmq.com
> *Cc: *Edwin Fine <rabbitmq-discuss_efine at usa.net>
> *Subject: **Re: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.*
>
> Ed,
>
> On 8 May 2008, at 06:13, Edwin Fine wrote:
>
>
> Well, I have put most of the code I am using into a test program (two
> modules). This code is not for the mailing list's consumption, if that's ok
> with you. The problem is, I can't even make the code work for more than 1
> consumer and I don't know why. I think I am too tired. In any case, the two
> modules included are:
>
>    - rabbit_chan_crash.erl - The actual test program, which contains most
>    of the Rabbit-related working code;
>
> I've run you code. The problem that that you are executing synchronous RPCs
> on the same channel concurrently, which doesn't work, because the protocol
> flow stipulates that a client performs a blocking receive for synchronous
> commands within a channel.
>
> By doing this though, you have uncovered a bug in the synchronous RPC
> handling code in the client that doesn't protect against this properly. So
> I've fixed this bug and will send it down to the repository.
>
> This will not solve your problem, it will just make a clearer indication of
> what went wrong. When designing the client, we deliberated whether the
> client channel module should contain the intelligence to queue up pending
> RPC requests in order to accept concurrent requests from user code and
> essentially serialize their dispatch to the server. Initially, we decided
> against this approach because of the complexity it introduces. In general,
> queue declaration and binding is an operation that you don't need to perform
> concurrently per channel. While I think that this view is still valid, your
> use case may provide some food for thought. Thoughts anyone?
>
> To solve your problem, you can do one of a few things:
>
> 1. Refactor your code so that synchronous RPCs are not executed in parallel
> (e.g. QueueDeclare, QueueBind, etc) within one channel process;
> 2. Manage by exception - catch an illegal_pending_rpc error (which is the
> bug fix I just put in) and resend the request;
> 3. Use more channel processes - this *may* be a bit heavy weight for the
> TCP client, this is better suited to the direct client.
>
> If you want to go down route 2, let me know because we're currently in the
> process of moving the source code from monotone to mercurial.
>
> BTW, I see that you've made a local modification to the amqp_connection
> module to export the start/4 function which allows the caller to specify a
> virtual host. This is probably a good idea and we may incorporate this into
> the API.
>
>
>    - rbmq_admin.erl - An interface to the admin part of Rabbit that I
>    wrote because I wanted to be able to create exchanges, users, etc from
>    within Erlang instead of the command line. Feel free to use this if you
>    think it's of any use, or improve it - feedback welcome. Actually, at some
>    point I want to write a full Web admin interface for Rabbit. Real Soon Now.
>
> Glad you've mentioned this topic. I've done some initial work of doing some
> remote management of Rabbit, if and when you actually want to get going, it
> will probably be a good idea to start a separate discussion thread on this
> one. There are many design issues that would need to be discussed, most
> importantly dependencies that may arise.
>
>
> To compile you will need all the usual RabbitMQ paths, and the Erlang
> client of course. You will also need .erlang.cookie or setcookie with your
> Rabbit's cookie. I am pretty sure there are no external dependencies other
> than Rabbit and Erlang.
>
> To run is simple (but please note that the code will try to create a user
> named emf_test, and an exchange and a bunch of queues). Feel free to hack
> into shape if you have the time and interest. Tomorrow I will try to run
> Rabbit and my code co-located.
>
> >rabbit_chan_crash:go(rabbit at mynode, NumConsumers, NumMsgsPerSec).
> >rabbit_chan_crash:stop(). % If you can even read the screen to type this
> in :)
>
> When I use rabbit_chan_crash:go(rabbit at mynode, 1, 10) it's all good.
> When I use rabbit_chan_crash:go(rabbit at mynode, 2, 10) it's all bad. I
> don't know what I am doing wrong, but my other code works (each consumer is
> in its own gen_event server, which is probably why. I think I am getting
> messages in the wrong message queues due to my lack of Erlang experience.
> And I am tired, too).
>
> Anyway I have included the "bad" output.
>
> If you have any luck please let me know. Feedback welcome, too.
>
> Regards,
> Ed
>
> (xhg at ender)3> rabbit_chan_crash:go(rabbit at ender,2,10).
> Setting up channel on realm <<"/data">> for connection {<0.60.0>,network}
> Access granted for channel <0.65.0> on realm <<"/data">> for connection
> {<0.60.0>,
>
> network}
> Declaring exchange <<"emf_test">> using ticket 101
> Declared exchange <<"emf_test">> using ticket 101
> Declaring queue <<"EMF_TEST_Q.1">>
> Declared queue <<"EMF_TEST_Q.1">>, msgc = 0, cons_c = 0
> Declaring queue <<"EMF_TEST_Q.2">>
> Declared queue <<"EMF_TEST_Q.2">>, msgc = 0, cons_c = 0
> Environment setup complete, rmq_state =
> {rmq_state,"guest","guest",
>            {<0.60.0>,network},
>            <0.65.0>,101,<<"emf_test">>,<<"/data">>,<<"/emf_test">>,
>            rabbit at ender,2}
> Consumers started: [<0.69.0>,<0.70.0>]
> [<0.69.0>] Started consumer tag <<"EMF_TEST_Q.1">> for existing
> channel/ticket/queue <0.65.0>/101/<<"EMF_TEST_Q.1">>
> [<0.70.0>] Started consumer tag <<"EMF_TEST_Q.2">> for existing
> channel/ticket/queue <0.65.0>/101/<<"EMF_TEST_Q.2">>
> <0.68.0>
> Producer started: <0.71.0>
> Binding queue <<"EMF_TEST_Q.1">>, ticket 101, exchange <<"emf_test">>,
> routing key <<"EMF_TEST_Q.1">>
> Binding queue <<"EMF_TEST_Q.2">>, ticket 101, exchange <<"emf_test">>,
> routing key <<"EMF_TEST_Q.2">>
> Bound queue <<"EMF_TEST_Q.2">> to exchange <<"emf_test">>
> Subscribing consumer <<"EMF_TEST_Q.2">> to channel <0.65.0>
> (xhg at ender)4>
> =ERROR REPORT==== 8-May-2008::00:57:23 ===
> ** Generic server <0.65.0> terminating
> ** Last message in was
> {method,{'basic.consume_ok',<<"EMF_TEST_Q.2">>},none}
> ** When Server state == {channel_state,1,<0.60.0>,<0.62.0>,<0.66.0>,
>                             #Fun<amqp_network_driver.do.2>,
>                             #Fun<amqp_network_driver.do.3>,<<>>,<0.70.0>,
>                             false,undefined,
>                             {dict,0,16,16,8,80,48,
>
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
>                                  []},
>
> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
>                                   [],[]}}}}
> ** Reason for termination ==
> ** {function_clause,[{gen_server,reply,
>                                  [<<>>,
>
> {'basic.consume_ok',<<"EMF_TEST_Q.2">>}]},
>                      {amqp_channel,rpc_bottom_half,2},
>                      {amqp_channel,handle_method,2},
>                      {gen_server,handle_msg,5},
>                      {proc_lib,init_p,5}]}
>
> =ERROR REPORT==== 8-May-2008::00:57:23 ===
> Error in process <0.70.0> on node 'xhg at ender' with exit value:
> {{badmatch,{'queue.bind_ok'}},[{rabbit_chan_crash,subscribe,2},{rabbit_chan_crash,consumer,5}]}
> ---------
>
>
>
> HTH,
>
> Ben
>
> PS I'm attaching your code to the list for reference.
>
>
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/c7e6ab16/attachment.htm 

From 0x6e6562 at gmail.com  Thu May  8 21:11:13 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 8 May 2008 21:11:13 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
	<6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
Message-ID: <CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>

Ed,

On 8 May 2008, at 15:04, Edwin Fine wrote:

> Ben,
> Thanks for looking into this. In the "real" code, all the setup is  
> actually done within a single Erlang process, and the only thing the  
> consumers do is handle the basic.deliver, as well as any  
> basic.consume_ok  or basic.cancel_ok messages that may arise. In the  
> test code, I rearranged some things specifically to be done  
> concurrently, which I now see was a mistake. However, this is a bug  
> in the test code, not in the production code. I will change the test  
> code so that there is no concurrent work being done on a channel  
> other than responding with basic.ack to basic.deliver messages.

I've begun a discussion on this topic and it looks like we will add  
the intelligence to the amqp_channel module to be able to serialize  
concurrent RPC requests to the channel. I understand that you have a  
workaround anyway, but on reflection, it seems like a good idea to put  
this capability into the client. will let you know when it is done.

> I note that there is a special version of amqp_channel:send/3, used  
> only for a basic.consume method, with the last argument being the  
> pid of the process subscribing. Am I correct to assume because of  
> this that the basic.consume method can indeed be sent concurrently  
> by different consumers on the same channel? But the basic.cancel  
> operation does not have this property (specifying a PID in the amqp  
> call) , as far as I can see, which means that a consumer cannot  
> cancel its own subscription without potentially clashing with other  
> consumers that are canceling.

amqp_channel:send/3? There isn't an exported function of that name. I  
think you mean call/3.

Any which way, the reason behind sending a consume request with a Pid  
to the channel process is to allow the channel to register the  
consumer process against a tag. The channel process and the broker use  
a consumer tag to correlate messages across the wire. The broker does  
not know anything about the consuming process. The process looks like  
this:

1. Subscribe:
				
a) User -----(Consumer Pid, Tag?)-----> Channel Process ----(Tag)----- 
 > Broker
b) User <-----(Tag Ok)----- Channel Process <----(Tag Ok)----- Broker

2. Receive messages:

User <-----(Data)----- Channel Process <----(Tag, Data)----- Broker

3. Unsubscribe:

a) User -----(Tag)-----> Channel Process ----(Tag)-----> Broker
b) User <----(Tag Ok)-----> Channel Process <---(Tag Ok)----- Broker

 From an user perspective, you *could* get away without the acks in  
steps 1b and 3b. However, to be consistent with the Java client API, 3  
different types of messages are sent to a consuming process:

1. ConsumeOk - to acknowledge the registration of a tag or to inform  
the receiver of an auto-generated tag;
2. Delivery - normal message delivery;
3. CancelOk - to let the consuming process know that it's subscription  
has been cancelled.

In step 1, the channel process registers the consuming Pid against a  
tag, so that subsequent messages it receives with that tag can get  
routed to the correct consumer. The fact that the ack is resent to the  
consumer is just a matter of the client side API - it provides a  
consumer with explicit lifecycle events, whether or not they actually  
care about them.

When it comes to cancellation, you don't need a Pid, just a tag. This  
is because the channel process maintains a map between tags and  
consumers, so you only require the tag to kick off the cancellation  
process. So whether you cancel yourself or some other process, all you  
need is the tag.

The upshot of this is that you can't clash on cancelling, because you  
can correlate with the tag. However as indicated above, there is a  
current limitation with concurrent synchronous calls, which I'm hoping  
to remove now. In fact, being able to cancel a subscription is  
something that you might want to kick off from a consuming process,  
which means that forcing application code to serialize this may be a  
drawback.

In essence, I think the current subscribe/unsubscribe model makes  
sense, it just requires the intelligence to serialize synchronous  
client requests.

If you think that passing the consume_ok and cancel_ok acks to the  
consumer is counterintuitive, maybe we could consider parametrizing  
the client side call so that the client can choose whether the  
consumer really cares about these lifecycle events. Which ever way,  
there will only be 2 lifecycle events per consumer, so these could  
*thereotically* just be left in the consumer's mailbox.


> So I will change the code back so that everything OTHER than  
> basic.consume and basic.cancel is done within a single process, and  
> take it from there.
>
> I think this has, however, shed some light on what might have  
> happened in the production code. I am using the consumer process to  
> unsubscribe itself. When there are many consumer processes, this  
> could be a problem because I think basic.cancel does not allow you  
> to specify a return pid and maybe this is causing upset in the  
> channel.
>
>     #'basic.consume_ok'{consumer_tag = ConsumerTag} =  
> amqp_channel:call(Channel, BasicConsume, self()), %%% Notice return  
> pid
>     #'basic.cancel_ok'{consumer_tag = ConsumerTag} =  
> amqp_channel:call(Channel, BasicCancel), %%% Notice - no return pid
>
> So maybe this should be added to the handling of basic.cancel? Why  
> shouldn't a consumer cancel itself? In fact, why can't all client  
> channel calls specify which PID is calling?

As indicated above, you don't need a Pid to cancel a subscription,  
just the tag. So a consumer can cancel itself, if it wants to.

BTW, all channel calls are aware of the calling pid by default because  
the channel uses the gen_server behaviour. So if the channel needs to  
know which Pid invoked what call, it can. In general, it doesn't need  
to.

>
>
> One other source of confusion for me is this: when sending an  
> amqp_channel:basic.consume call, why is there both a synchronous  
> response to the call itself and an asynchronous response on the  
> channel?
>
>     #'basic.consume_ok'{consumer_tag = ConsumerTag} =  
> amqp_channel:call(Channel, BasicConsume, self()),
>     receive
>         #'basic.consume_ok'{consumer_tag = ConsumerTag} ->
>             io:format("[~p] ~p got consume_ok~n", [self(),  
> BasicConsume#'basic.consume'.consumer_tag])
>     end.
>

This question was answered above.

HTH,

Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/97cff685/attachment.htm 

From 0x6e6562 at gmail.com  Thu May  8 22:22:18 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 8 May 2008 22:22:18 +0100
Subject: [rabbitmq-discuss] Fwd: More RabbitMQ Erlang client woes
References: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>
Message-ID: <53D148B9-0402-4E3D-8C3F-6306C34CC458@gmail.com>



Begin forwarded message:

> From: "Edwin Fine" <emofine at gmail.com>
> Date: 8 May 2008 22:12:07 BST
> To: "Ben Hood" <0x6e6562 at gmail.com>
> Subject: More RabbitMQ Erlang client woes
>
> Hi Ben,
>
> Sorry for the long email. Trying to get to the bottom of the  
> problems. I have done a LOT more investigation into the Erlang  
> network client, and I believe there are two related bugs, one in the  
> client, and the other I don't know where, or perhaps I am abusing  
> how AMQP is supposed to work.
>
> Bug #1: rabbit_writer not shut down
>
> The first (and easier) bug, which I have fixed eventually, is that  
> every time you start a channel, the network client creates a  
> rabbit_writer, but never shuts it down. Therefore, each channel that  
> is created leaves behind a rabbit_writer process.
> What happens is that in the handshake, the network driver starts a  
> rabbit_writer on channel 0. I believe this is used for the  
> connection itself. Its pid is stored in writer_pid in the  
> connection_state. This writer gets cleaned up properly when the  
> connection is shut down. There is no problem with this.
> Thereafter, when a channel is opened and  
> amqp_network_driver:open_channel is called, another writer is  
> started (correctly - need one per connection, right?). There is a  
> singleton reader. Anyway, this writer is never terminated. The  
> writer is registered as a peer to the channel, using  
> amqp_channel:register_direct_peer. This causes a bug, because the  
> registered peer is never shut down, probably because the direct peer  
> never should be shut down... but this is the NETWORK peer.
>
> So what I did (and you may have a better way) is to add another  
> function, amqp_channel:register_network_peer. This sets a "direct"  
> flag in the channel_state (which I had to add) to false. Calling  
> register_direct_peer sets the flag to true. When  
> amqp_channel:channel_cleanup() is eventually called (and I had to do  
> something for this, too), it checks to see if direct is false. If  
> so, it stops the writer in writer_pid, otherwise it leaves it alone.
>
> I also had to add a call to channel_cleanup in the close_ok, because  
> the cleanup was never getting called.:
>
> amqp_channel:handle_method(ChannelCloseOk = #'channel.close_ok'{},  
> State) ->
>     {noreply, NewState} = rpc_bottom_half(ChannelCloseOk, State),
>     NewState2 = channel_cleanup(State),
>     {stop, normal, NewState2};
>
> Now this may be major hackery, and you may find a better way. Or,  
> maybe there has been a code change to the client and I have old  
> code. I haven't looked in the past few weeks.
>
>
> Maybe-Bug #2: I believe that multiple concurrent consumers cannot  
> self-register
>
> If all consumers are registered by a single process (which is what I  
> used to do, and it worked), and not by the consumer process itself,  
> all consume_ok methods are returned correctly. However, if you start  
> more than one consumer right after each other, and they try to self- 
> register, things get mixed up. Take a look at this output below. The  
> key is this debug print:
>
>
> However, the basic.consume method was called with the consumer's  
> PID, and my understanding is that providing the pid of the consumer  
> will ensure that the response gets back to the right one. Here is my  
> code, where you can see the self():
>
>     #'basic.consume_ok'{consumer_tag = NewConsumerTag} =  
> amqp_channel:call(Channel, BasicConsume, self()),
>
> And the corresponding output, showing that the responses are mixed  
> together.
>
> [<0.121.0>] Subscribing consumer <<"EMF_TEST_Q.1">> to channel  
> <0.117.0>
> [<0.122.0>] Subscribing consumer <<"EMF_TEST_Q.2">> to channel  
> <0.117.0>
> [<0.122.0>] subscribing: Response from amqp_channel:call  
> consumer_tag = <<"EMF_TEST_Q.1">> from channel <0.117.0>
> [<0.122.0>] received consume_ok: Actual tag: <<"EMF_TEST_Q.1">>  
> Expected Tag: <<"EMF_TEST_Q.2">>
>
> -----------------------------------------------------------------------------
> This is the complete output trace of the test code. I've attached my  
> version of the client (with my debug prints and my mods), and the  
> test source code.
> -----------------------------------------------------------------------------
>
> (xhg at ender)8> rabbit_chan_crash:go(rabbit at ender,2,1).
> start_writer(Sock = #Port<0.141>, Channel = 0)
>   WriterPid = <0.115.0>
> Setting up channel on realm <<"/data">> for connection  
> {<0.112.0>,network}
> start_writer(Sock = #Port<0.141>, Channel = 1)
>   WriterPid = <0.118.0>
> amqp_network_driver:open_channel:: Nothing ever shuts this writer  
> down: <0.118.0> *** I believe I have fixed this bug
> [<0.117.0>] Calling rpc_bottom_half for {'channel.open_ok'}
> [<0.117.0>] Calling rpc_bottom_half for {'access.request_ok',101}
> Access granted for channel <0.117.0> on realm <<"/data">> for  
> connection {<0.112.0>,
>                                                                           network 
> }
> Declaring exchange <<"emf_test">> using ticket 101
> [<0.117.0>] Calling rpc_bottom_half for {'exchange.declare_ok'}
> Declared exchange <<"emf_test">> using ticket 101
> Declaring queue <<"EMF_TEST_Q.1">>
> [<0.117.0>] Calling rpc_bottom_half for {'queue.declare_ok',
>                                          <<"EMF_TEST_Q.1">>,0,0}
> Declared queue <<"EMF_TEST_Q.1">>, msgc = 0, cons_c = 0
> Declaring queue <<"EMF_TEST_Q.2">>
> [<0.117.0>] Calling rpc_bottom_half for {'queue.declare_ok',
>                                          <<"EMF_TEST_Q.2">>,0,0}
> Declared queue <<"EMF_TEST_Q.2">>, msgc = 0, cons_c = 0
> Binding queue <<"EMF_TEST_Q.1">>, ticket 101, exchange  
> <<"emf_test">>, routing key <<"EMF_TEST_Q.1">>
> [<0.117.0>] Calling rpc_bottom_half for {'queue.bind_ok'}
> Bound queue <<"EMF_TEST_Q.1">> to exchange <<"emf_test">>
> Binding queue <<"EMF_TEST_Q.2">>, ticket 101, exchange  
> <<"emf_test">>, routing key <<"EMF_TEST_Q.2">>
> [<0.117.0>] Calling rpc_bottom_half for {'queue.bind_ok'}
> Bound queue <<"EMF_TEST_Q.2">> to exchange <<"emf_test">>
> Environment setup complete, rmq_state =
> {rmq_state,"guest","guest",
>            {<0.112.0>,network},
>            <0.117.0>,101,<<"emf_test">>,<<"/data">>,<<"/emf_test">>,
>            rabbit at ender,2,
>            [<<"EMF_TEST_Q.1">>,<<"EMF_TEST_Q.2">>],
>            undefined,undefined}
> Consumers started: [<0.121.0>,<0.122.0>]
> [<0.121.0>] Started consumer tag <<"EMF_TEST_Q.1">> for existing  
> channel/ticket/queue <0.117.0>/101/<<"EMF_TEST_Q.1">>
> [<0.122.0>] Started consumer tag <<"EMF_TEST_Q.2">> for existing  
> channel/ticket/queue <0.117.0>/101/<<"EMF_TEST_Q.2">>
> Producer started: <0.123.0>
> [<0.121.0>] Subscribing consumer <<"EMF_TEST_Q.1">> to channel  
> <0.117.0>
> [<0.122.0>] Subscribing consumer <<"EMF_TEST_Q.2">> to channel  
> <0.117.0>
> <0.120.0>
> [<0.122.0>] subscribing: Response from amqp_channel:call  
> consumer_tag = <<"EMF_TEST_Q.1">> from channel <0.117.0>
> [<0.122.0>] received consume_ok: Actual tag: <<"EMF_TEST_Q.1">>  
> Expected Tag: <<"EMF_TEST_Q.2">>
> Consumer tag <<"EMF_TEST_Q.2">> pid <0.122.0> unsubscribing
> Unsubscribing consumer <<"EMF_TEST_Q.2">> from channel <0.117.0>
> (xhg at ender)9>
> =ERROR REPORT==== 8-May-2008::16:53:43 ===
> ** Generic server <0.117.0> terminating
> ** Last message in was {method,{'basic.consume_ok',<<"EMF_TEST_Q. 
> 2">>},none}
> ** When Server state == {channel_state, 
> 1,<0.112.0>,<0.114.0>,<0.118.0>,false,
>                             #Fun<amqp_network_driver.do.2>,
>                             #Fun<amqp_network_driver.do. 
> 3>,<<>>,<<>>,false,
>                             undefined,
>                             {dict,1,16,16,8,80,48,
>                                 {[],[],[],[],[],[],[],[],[],[],[],[], 
> [],[],[],
>                                  []},
>                                 {{[],[],[],[],[],[],[],[],
>                                   [[<<"EMF_TEST_Q.1">>|<0.122.0>]],
>                                   [],[],[],[],[],[],[]}}}}
> ** Reason for termination ==
> ** {badarg,[{amqp_channel,handle_method,2},
>             {gen_server,handle_msg,5},
>             {proc_lib,init_p,5}]}
>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/de442ed9/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: erlang-client-src-mod-by-edwin-fine.tar.gz
Type: application/x-gzip
Size: 12850 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/de442ed9/attachment.bin 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/de442ed9/attachment-0001.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: test-src-edwin-fine.tar.gz
Type: application/x-gzip
Size: 5651 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/de442ed9/attachment-0001.bin 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/de442ed9/attachment-0002.htm 

From matthias at lshift.net  Thu May  8 22:42:37 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 08 May 2008 22:42:37 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805072215l6cc02986k71c380480b500b5f@mail.gmail.com>
References: <6c2563b20805071057l7e486da8k660150772397148@mail.gmail.com>	<28D8D63C-C649-422A-9488-8BBB3A7188D8@gmail.com>	<6c2563b20805071350sf8b5ff1mdd04e93f01f4535e@mail.gmail.com>	<1EC6CAF8-641A-4B2C-A6B3-5C0DF4A78648@gmail.com>	<6c2563b20805071511t533fa9aeo970b660821606035@mail.gmail.com>	<48227FF9.5000300@lshift.net>
	<6c2563b20805072215l6cc02986k71c380480b500b5f@mail.gmail.com>
Message-ID: <482373CD.9050309@lshift.net>

Edwin,

Edwin Fine wrote:
> That's true. It seems that all that happens is that the messages (which 
> are persistent in my case) are maintained in the queue and do not get 
> removed until the acks are received. However, all the messages are still 
> sent. I assume they would be retransmitted at some point.

Yep. The unack'ed messages will get retransmitted or requeued after the 
client calls basic.recover, or the channel or connection gets closed.


Matthias.



From matthias at lshift.net  Fri May  9 07:04:48 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 09 May 2008 07:04:48 +0100
Subject: [rabbitmq-discuss] TCP timeouts
In-Reply-To: <OF611AF1FD.0B97C545-ON80257443.002D31B0-80257443.002E9B4F@Edftrading.com>
References: <OF611AF1FD.0B97C545-ON80257443.002D31B0-80257443.002E9B4F@Edftrading.com>
Message-ID: <4823E980.9040205@lshift.net>

David,

David.Corcoran at edftrading.com wrote:
> It looks like you were right about the java version. Running in java
> 1.5.0.15 doesn't work. Running in java-6-openjdk or java-6 (1.6.0.06) works
> fine. I think it's a bug, perhaps related to this:
> http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6383015

Interesting. Yes, that looks like it would explain the behaviour you saw.

> I've attached the code that displays the problem. Putting back the
> Thread.yield() in java 5 makes it work, but obviously isn't a viable
> solution.

In the absence of even the most basic fairness guarantees from the jvm - 
such as no starvation - asking programmers to insert Thread.yield() in 
strategic places is about he best you can do.


Thanks for the analysis. It will save users a lot of time when running 
across the same problem.


Matthias.



From 0x6e6562 at gmail.com  Fri May  9 10:56:51 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 9 May 2008 10:56:51 +0100
Subject: [rabbitmq-discuss] More RabbitMQ Erlang client woes
In-Reply-To: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>
References: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>
Message-ID: <7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>

Ed,

Thanks for taking time to look into this so deeply.

You have indeed found a bug in the network client with the fact that  
it is not shutting the per-channel writer processes down. See below.

On 8 May 2008, at 22:12, Edwin Fine wrote:
>
> Sorry for the long email. Trying to get to the bottom of the  
> problems. I have done a LOT more investigation into the Erlang  
> network client, and I believe there are two related bugs, one in the  
> client, and the other I don't know where, or perhaps I am abusing  
> how AMQP is supposed to work.
>
> Bug #1: rabbit_writer not shut down
>
> The first (and easier) bug, which I have fixed eventually, is that  
> every time you start a channel, the network client creates a  
> rabbit_writer, but never shuts it down. Therefore, each channel that  
> is created leaves behind a rabbit_writer process.
> What happens is that in the handshake, the network driver starts a  
> rabbit_writer on channel 0. I believe this is used for the  
> connection itself. Its pid is stored in writer_pid in the  
> connection_state. This writer gets cleaned up properly when the  
> connection is shut down. There is no problem with this.
> Thereafter, when a channel is opened and  
> amqp_network_driver:open_channel is called, another writer is  
> started (correctly - need one per connection, right?). There is a  
> singleton reader. Anyway, this writer is never terminated. The  
> writer is registered as a peer to the channel, using  
> amqp_channel:register_direct_peer. This causes a bug, because the  
> registered peer is never shut down, probably because the direct peer  
> never should be shut down... but this is the NETWORK peer.
>
> So what I did (and you may have a better way) is to add another  
> function, amqp_channel:register_network_peer. This sets a "direct"  
> flag in the channel_state (which I had to add) to false. Calling  
> register_direct_peer sets the flag to true. When  
> amqp_channel:channel_cleanup() is eventually called (and I had to do  
> something for this, too), it checks to see if direct is false. If  
> so, it stops the writer in writer_pid, otherwise it leaves it alone.
>

I can see what the intention is. The main thing is that you have  
understood how all of the processes hang together which is a little  
tricky in the network case because the client is using a common  
codebase with the server to manage socket IO and AMQP channels. This  
is why it may not be immediately apparent to the naked eye why certain  
things have been done in the way they are.

To achieve this I think the cleanup should be contained within the  
network driver either as a callback to allow the network driver to  
stop the channel writer process or even linking the channel process  
with the writer process so that when the channel exits, the writer  
process receives a signal as well. I think I prefer the latter, but  
this would mean changing the writer module, which is core module of  
the server and we'd need to look at the implications of this.

So watch this space.

> I also had to add a call to channel_cleanup in the close_ok, because  
> the cleanup was never getting called.:
>
> amqp_channel:handle_method(ChannelCloseOk = #'channel.close_ok'{},  
> State) ->
>     {noreply, NewState} = rpc_bottom_half(ChannelCloseOk, State),
>     NewState2 = channel_cleanup(State),
>     {stop, normal, NewState2};
>

That's a good point. I think the cleanup code should go into the  
gen_server terminate callback to keep it one place.

> Maybe-Bug #2: I believe that multiple concurrent consumers cannot  
> self-register
>
> If all consumers are registered by a single process (which is what I  
> used to do, and it worked), and not by the consumer process itself,  
> all consume_ok methods are returned correctly. However, if you start  
> more than one consumer right after each other, and they try to self- 
> register, things get mixed up. Take a look at this output below. The  
> key is this debug print:
>
>
> However, the basic.consume method was called with the consumer's  
> PID, and my understanding is that providing the pid of the consumer  
> will ensure that the response gets back to the right one. Here is my  
> code, where you can see the self():
>
>     #'basic.consume_ok'{consumer_tag = NewConsumerTag} =  
> amqp_channel:call(Channel, BasicConsume, self()),
>
> And the corresponding output, showing that the responses are mixed  
> together.
>
> [<0.121.0>] Subscribing consumer <<"EMF_TEST_Q.1">> to channel  
> <0.117.0>
> [<0.122.0>] Subscribing consumer <<"EMF_TEST_Q.2">> to channel  
> <0.117.0>
> [<0.122.0>] subscribing: Response from amqp_channel:call  
> consumer_tag = <<"EMF_TEST_Q.1">> from channel <0.117.0>
> [<0.122.0>] received consume_ok: Actual tag: <<"EMF_TEST_Q.1">>  
> Expected Tag: <<"EMF_TEST_Q.2">>
>

Yes,  this is a bug. On inspection of the handle_call({basic_consume,  
Method, Consumer}, From, State) function in amqp_channel, there is a  
race condition between concurrently subscribing consumers. I will  
probably address this using the same strategy to serialize all  
synchronous RPC requests. If the client supplies a unique tag to  
correlate on, this could be done concurrently by maintaining a map of  
pending subscriptions rather than just the last pending subscription.

I'll fix this and let you know.

In your patch, you also added an extra method to handle a spurious  
consume_ok message;

%% Edwin Fine bugfix: This is actually being called wrong from  
somewhere,
%% but this will fix it.
handle_method({'basic.consume_ok', ConsumerTag}, State) ->
     io:format("[~p] Got bad handle_method call!~n", [self()]),
     handle_method(#'basic.consume_ok'{consumer_tag = ConsumerTag},  
State);

This method is preceded in the code by the following function:

handle_method(BasicConsumeOk = #'basic.consume_ok'{consumer_tag =  
ConsumerTag},
                         State = #channel_state{pending_consumer =  
Consumer}) ->
     Consumer ! BasicConsumeOk,
     NewState = register_consumer(ConsumerTag, Consumer, State),
     {noreply, NewState2} = rpc_bottom_half(BasicConsumeOk, NewState),
     {noreply, NewState2#channel_state{pending_consumer = <<>>} };

So I not quite sure why that didn't match first because  
#'basic.consume_ok'{consumer_tag = ConsumerTag} should match against  
{'basic.consume_ok', ConsumerTag} and #channel_state{pending_consumer  
= Consumer} should match even if the pending_consumer was not defined.

This will require some more analysis.

HTH,

Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080509/c321541d/attachment.htm 

From matthias at lshift.net  Fri May  9 11:57:18 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 09 May 2008 11:57:18 +0100
Subject: [rabbitmq-discuss] More RabbitMQ Erlang client woes
In-Reply-To: <7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>
References: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>
	<7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>
Message-ID: <48242E0E.1070706@lshift.net>

Ben,

Ben Hood wrote:
> To achieve this I think the cleanup should be contained within the 
> network driver either as a callback to allow the network driver to stop 
> the channel writer process or even linking the channel process with the 
> writer process so that when the channel exits, the writer process 
> receives a signal as well. I think I prefer the latter, but this would 
> mean changing the writer module, which is core module of the server and 
> we'd need to look at the implications of this.

The server is already linking the writer and the channel, though the way 
that is done may not be immediately obvious.


Matthias.



From 0x6e6562 at gmail.com  Fri May  9 12:10:51 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 9 May 2008 12:10:51 +0100
Subject: [rabbitmq-discuss] More RabbitMQ Erlang client woes
In-Reply-To: <48242E0E.1070706@lshift.net>
References: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>
	<7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>
	<48242E0E.1070706@lshift.net>
Message-ID: <2AF20298-863C-4CF3-8A65-57D2B033EE25@gmail.com>

Matthias,

On 9 May 2008, at 11:57, Matthias Radestock wrote:
> Ben Hood wrote:
>> To achieve this I think the cleanup should be contained within the  
>> network driver either as a callback to allow the network driver to  
>> stop the channel writer process or even linking the channel process  
>> with the writer process so that when the channel exits, the writer  
>> process receives a signal as well. I think I prefer the latter, but  
>> this would mean changing the writer module, which is core module of  
>> the server and we'd need to look at the implications of this.
>
> The server is already linking the writer and the channel, though the  
> way that is done may not be immediately obvious.

Are you talking about start_link/4 in rabbit_channel? If I'm not  
mistaken, this is linking the writing and the channel in the direct  
case, but not in the network case.

In the network driver, the writer is started in the start_writer/2  
function on a per channel basis:

start_writer(Sock, Channel) ->
     rabbit_writer:start(Sock, Channel, ?FRAME_MIN_SIZE).

This then starts a new process to translate Erlang messages into AMQP  
frames.

But this loop process is not linked to anything as far as I can see,  
which is the behaviour that Edwin is reporting.

Ben



From matthias at lshift.net  Fri May  9 12:24:43 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 09 May 2008 12:24:43 +0100
Subject: [rabbitmq-discuss] More RabbitMQ Erlang client woes
In-Reply-To: <2AF20298-863C-4CF3-8A65-57D2B033EE25@gmail.com>
References: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>	<7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>	<48242E0E.1070706@lshift.net>
	<2AF20298-863C-4CF3-8A65-57D2B033EE25@gmail.com>
Message-ID: <4824347B.5070208@lshift.net>

Ben Hood wrote:
> On 9 May 2008, at 11:57, Matthias Radestock wrote:
>> The server is already linking the writer and the channel, though the  
>> way that is done may not be immediately obvious.
> 
> Are you talking about start_link/4 in rabbit_channel? If I'm not  
> mistaken, this is linking the writing and the channel in the direct  
> case, but not in the network case.

I was talking about what the server does. Nothing to do with the Erlang 
client, other than they share a code base. You appeared to be saying 
that linking the channel and the writer requires changes to that code 
base. I want to understand why that is the case, given that the server 
is establish precisely these kinds of links using that code base. Or, to 
put it differently, if the server can do it, why can't the Erlang client?


Matthias.



From 0x6e6562 at gmail.com  Fri May  9 12:41:09 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 9 May 2008 12:41:09 +0100
Subject: [rabbitmq-discuss] More RabbitMQ Erlang client woes
In-Reply-To: <4824347B.5070208@lshift.net>
References: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>	<7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>	<48242E0E.1070706@lshift.net>
	<2AF20298-863C-4CF3-8A65-57D2B033EE25@gmail.com>
	<4824347B.5070208@lshift.net>
Message-ID: <52C4F951-A4CD-49C6-859C-0895699143FA@gmail.com>

Matthias,

On 9 May 2008, at 12:24, Matthias Radestock wrote:

> Ben Hood wrote:
>> On 9 May 2008, at 11:57, Matthias Radestock wrote:
>>> The server is already linking the writer and the channel, though  
>>> the  way that is done may not be immediately obvious.
>> Are you talking about start_link/4 in rabbit_channel? If I'm not   
>> mistaken, this is linking the writing and the channel in the  
>> direct  case, but not in the network case.
>
> I was talking about what the server does. Nothing to do with the  
> Erlang client, other than they share a code base. You appeared to be  
> saying that linking the channel and the writer requires changes to  
> that code base. I want to understand why that is the case, given  
> that the server is establish precisely these kinds of links using  
> that code base. Or, to put it differently, if the server can do it,  
> why can't the Erlang client?

That is right, I did actually say it may need a change to the server  
code. But I was thinking aloud rather than proposing something  
definite because I don't want to change anything in the server without  
good reason.

Actually on closer inspection it may reasonably straight forward to  
do. The Pid of the writer process already being registered with the  
channel process, so it would be a case of either linking the two  
processes together or having the channel send the writer a shutdown  
message when the channel exits.

Ben



From holger at wizards.de  Fri May  9 13:07:12 2008
From: holger at wizards.de (=?ISO-8859-1?Q?Holger_Hoffst=E4tte?=)
Date: Fri, 09 May 2008 14:07:12 +0200
Subject: [rabbitmq-discuss] TCP timeouts
In-Reply-To: <4823E980.9040205@lshift.net>
References: <OF611AF1FD.0B97C545-ON80257443.002D31B0-80257443.002E9B4F@Edftrading.com>
	<4823E980.9040205@lshift.net>
Message-ID: <48243E70.6040808@wizards.de>


Non-Erlang-related-Java-is-funny-offtopic warning!

> David.Corcoran at edftrading.com wrote:
>> It looks like you were right about the java version. Running in java
>> 1.5.0.15 doesn't work. Running in java-6-openjdk or java-6 (1.6.0.06) works
>> fine. I think it's a bug, perhaps related to this:
>> http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6383015
> 
> Interesting. Yes, that looks like it would explain the behaviour you saw.

A very interesting anomaly indeed, especially considering that it only 
seems to affect 1.5, not 1.4 or 1.6. However, as far as I can tell this 
behaviour can only occur with one CPU. I bet that David's test will run 
fine when he enables more cores and/or starts running "real" code in the 
process() method - meaning: code that creates garbage and doesn't just 
repeatedly busy-waits on a native method, which accidentally must also 
obey special synchronization rules. David, could you please try this if it 
is not too inconvenient?
Ideally process() should run in a sepate thread anyway so that the 
controlling thread can properly wait for a result or - more importantly - 
cancel the computation if necessary.

> In the absence of even the most basic fairness guarantees from the jvm - 
> such as no starvation - asking programmers to insert Thread.yield() in 
> strategic places is about he best you can do.

Unfortunately this might not have the effect that one expects, as yield() is:

- free to be implemented as no-op; I think that at one point the server VM 
  explicitly optimized it away

- implemented differently in various versions of the JVM, both client and 
server

- dependent on OS- and GC-algorithm: for a fun time, search for "yield" in 
http://openjdk.neojava.org/hotspot/xref/src/share/vm/runtime/globals.hpp

- yielding native threads might not even work according to the general 
expectations of either apps or the JVM: until recently (or since then, 
depending on point of view) Linux didn't really yield() "correctly" 
(according to POSIX), resulting in..yet another magic kernel flag! 
Hilarious discussion in: http://kerneltrap.org/Linux/CFS_and_sched_yield

IMHO sprinkling yield() or sleeps() across a codebase has a definite 
"magic pixie dust" smell, and should be avoided at all costs. The JCIP 
book explains all this in chapter 10.3.1 ("Starvation") and pretty much 
only recommends yields/sleep to create artificial delays when debugging 
(to create races).

Besides, LockSupport.parkNanos() sounds much more advanced anyway. :-)

-h




From rabbitmq-discuss_efine at usa.net  Fri May  9 14:30:35 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Fri, 9 May 2008 09:30:35 -0400
Subject: [rabbitmq-discuss] More RabbitMQ Erlang client woes
In-Reply-To: <7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>
References: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>
	<7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>
Message-ID: <6c2563b20805090630x65480a41qef57e6ac6dfabb5d@mail.gmail.com>

Ben,

>
> In your patch, you also added an extra method to handle a spurious
> consume_ok message;
>
> %% Edwin Fine bugfix: This is actually being called wrong from somewhere,
> %% but this will fix it.
> handle_method({'basic.consume_ok', ConsumerTag}, State) ->
>     io:format("[~p] Got bad handle_method call!~n", [self()]),
>     handle_method(#'basic.consume_ok'{consumer_tag = ConsumerTag}, State);
>
> This method is preceded in the code by the following function:
>
> handle_method(BasicConsumeOk = #'basic.consume_ok'{consumer_tag =
> ConsumerTag},
>                         State = #channel_state{pending_consumer =
> Consumer}) ->
>     Consumer ! BasicConsumeOk,
>     NewState = register_consumer(ConsumerTag, Consumer, State),
>     {noreply, NewState2} = rpc_bottom_half(BasicConsumeOk, NewState),
>     {noreply, NewState2#channel_state{pending_consumer = <<>>} };
>
> So I not quite sure why that didn't match first
> because #'basic.consume_ok'{consumer_tag = ConsumerTag} should match
> against {'basic.consume_ok', ConsumerTag}
> and #channel_state{pending_consumer = Consumer} should match even if the
> pending_consumer was not defined.
>

Actually, I was in the middle of trying to get that right, and it was late,
so I would ignore that comment (and the code) completely. In fact I have
removed it from the most recent code. I was trying to get rid of the error
that I saw in the stack trace of the amqp_channel, namely

** Reason for termination ==
** {badarg,[{amqp_channel,handle_method,2},
            {gen_server,handle_msg,5},
            {proc_lib,init_p,5}]}

Now that I am doing the basic.consume in the process that starts the
consumers, the above issue does not occur.
Thanks for all your help. In the meantime, until you have a more elegant
bugfix (to the rabbit_writer proliferation) than my hack, I will just
continue to use my modified Erlang client.

Ben, you also wrote:

>>> That's a good point. I think the cleanup code should go into the
gen_server terminate callback to keep it one place.

Funny thing, that - I *did* put the cleanup code into the terminate, but it
did not seem to be called. It was only when I put it directly before the
{stop, xxx} returns that it finally got called. Again, this may have just
been late night syndrome, but I had extensive print statements and could
clearly see that it was not happening. At that time all I wanted was to get
it to work. Please understand that all the code I have submitted (other than
amqp_channel) is a pure hack to try to expose and duplicate the errors!

Thanks again.
Regards,
Ed
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080509/0bb836e1/attachment.htm 

From David.Corcoran at edftrading.com  Fri May  9 16:03:32 2008
From: David.Corcoran at edftrading.com (David.Corcoran at edftrading.com)
Date: Fri, 9 May 2008 16:03:32 +0100
Subject: [rabbitmq-discuss] TCP timeouts
In-Reply-To: <48243E70.6040808@wizards.de>
Message-ID: <OF3015D544.409EB47A-ON80257444.004D9970-80257444.0052B8B9@Edftrading.com>

Hey Holger,

Thanks for the response. I've answered some of your queries below.

>
> A very interesting anomaly indeed, especially considering that it only
> seems to affect 1.5, not 1.4 or 1.6. However, as far as I can tell this
> behaviour can only occur with one CPU. I bet that David's test will run
> fine when he enables more cores and/or starts running "real" code in the
> process() method - meaning: code that creates garbage and doesn't just
> repeatedly busy-waits on a native method, which accidentally must also
> obey special synchronization rules. David, could you please try this if
it
> is not too inconvenient?

Unfortunately this happens in the real world too. The code with the while
loop was just to have a simple example that exhibited the same problem I
was having. Most of our cpu intensive code is manipulating matrices of
doubles so it uses full cpu and there is little or no garbage collection.
We use Colt (http://acs.lbl.gov/~hoschek/colt/) for most of it and it's so
optimised I'd be surprised if it had slow bits where other threads might
get a look in.

Also my machine is a quad core 3Ghz Xeon and this happens when just running
1 cpu intensive task.

> Ideally process() should run in a separate thread anyway so that the
> controlling thread can properly wait for a result or - more importantly -

> cancel the computation if necessary.
>

Process doing the calculations inline makes things conceptually a little
easier and each computation takes less than 30 (usually) so there's no need
to cancel them. Also even if it ran in a separate thread the heartbeat
thread wouldn't be scheduled because the computation thread would still be
too busy.

>
> Unfortunately this might not have the effect that one expects, as yield()
is:
>

I agree, yield is a complicated beast and I would never rely on it as a
solution. It was more just a way to illustrate the problem.

If RabbitMQ has configurable heartbeat timeouts this problem might
disappear. For example if you could up the disconnect timeout to 5 seconds
or more it's probably more likely the heartbeat thread would have had a
time slice by then. Still, the only real solution is to use Java6. :)

Regards,

Dave


*********************************************************************
This communication contains confidential information, some or all of which may be privileged. It is for the intended recipient only and others must not disclose, distribute, copy, print or rely on this communication. If an addressing or transmission error has misdirected this communication, please notify the sender by replying to this e-mail and then delete the e-mail. E-mail sent to EDF Trading may be monitored by the company. Thank you. 
EDF Trading Limited
80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
A Company registered in England No. 4255974. 
Switchboard: 020 7061 4000
EDF Trading Markets Limited is a member of the EDF Trading Limited Group and is authorised and regulated by the Financial Services Authority.
VAT number: GB 735 5479 07
*********************************************************************



From rabbitmq-discuss_efine at usa.net  Fri May  9 16:05:06 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Fri, 9 May 2008 11:05:06 -0400
Subject: [rabbitmq-discuss] More RabbitMQ Erlang client woes
In-Reply-To: <6c2563b20805090630x65480a41qef57e6ac6dfabb5d@mail.gmail.com>
References: <6c2563b20805081412i446536e3k77ab309513e3ae57@mail.gmail.com>
	<7CB45FB5-957C-42D9-8FC8-0136CD3648DB@gmail.com>
	<6c2563b20805090630x65480a41qef57e6ac6dfabb5d@mail.gmail.com>
Message-ID: <6c2563b20805090805g7d66556w17b1a437b87b1f6@mail.gmail.com>

I wrote:

"Please understand that all the code I have submitted (other than
amqp_channel) is a pure hack to try to expose and duplicate the errors!".

That should have read, "other than rbmq_admin.erl" - the module that I wrote
to do admin tasks, which is only a semi-hack ;-)

Ed

On Fri, May 9, 2008 at 9:30 AM, Edwin Fine <rabbitmq-discuss_efine at usa.net>
wrote:

> Ben,
>
>>
>> In your patch, you also added an extra method to handle a spurious
>> consume_ok message;
>>
>> %% Edwin Fine bugfix: This is actually being called wrong from somewhere,
>> %% but this will fix it.
>> handle_method({'basic.consume_ok', ConsumerTag}, State) ->
>>     io:format("[~p] Got bad handle_method call!~n", [self()]),
>>     handle_method(#'basic.consume_ok'{consumer_tag = ConsumerTag}, State);
>>
>> This method is preceded in the code by the following function:
>>
>> handle_method(BasicConsumeOk = #'basic.consume_ok'{consumer_tag =
>> ConsumerTag},
>>                         State = #channel_state{pending_consumer =
>> Consumer}) ->
>>     Consumer ! BasicConsumeOk,
>>     NewState = register_consumer(ConsumerTag, Consumer, State),
>>     {noreply, NewState2} = rpc_bottom_half(BasicConsumeOk, NewState),
>>     {noreply, NewState2#channel_state{pending_consumer = <<>>} };
>>
>> So I not quite sure why that didn't match first
>> because #'basic.consume_ok'{consumer_tag = ConsumerTag} should match
>> against {'basic.consume_ok', ConsumerTag}
>> and #channel_state{pending_consumer = Consumer} should match even if the
>> pending_consumer was not defined.
>>
>
> Actually, I was in the middle of trying to get that right, and it was late,
> so I would ignore that comment (and the code) completely. In fact I have
> removed it from the most recent code. I was trying to get rid of the error
> that I saw in the stack trace of the amqp_channel, namely
>
> ** Reason for termination ==
> ** {badarg,[{amqp_channel,handle_method,2},
>             {gen_server,handle_msg,5},
>             {proc_lib,init_p,5}]}
>
> Now that I am doing the basic.consume in the process that starts the
> consumers, the above issue does not occur.
> Thanks for all your help. In the meantime, until you have a more elegant
> bugfix (to the rabbit_writer proliferation) than my hack, I will just
> continue to use my modified Erlang client.
>
> Ben, you also wrote:
>
> >>> That's a good point. I think the cleanup code should go into the
> gen_server terminate callback to keep it one place.
>
> Funny thing, that - I *did* put the cleanup code into the terminate, but it
> did not seem to be called. It was only when I put it directly before the
> {stop, xxx} returns that it finally got called. Again, this may have just
> been late night syndrome, but I had extensive print statements and could
> clearly see that it was not happening. At that time all I wanted was to get
> it to work. Please understand that all the code I have submitted (other than
> amqp_channel) is a pure hack to try to expose and duplicate the errors!
>
> Thanks again.
> Regards,
> Ed
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080509/4fe9d664/attachment.htm 

From matthias at lshift.net  Fri May  9 16:10:29 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 09 May 2008 16:10:29 +0100
Subject: [rabbitmq-discuss] TCP timeouts
In-Reply-To: <OF3015D544.409EB47A-ON80257444.004D9970-80257444.0052B8B9@Edftrading.com>
References: <OF3015D544.409EB47A-ON80257444.004D9970-80257444.0052B8B9@Edftrading.com>
Message-ID: <48246965.2000605@lshift.net>

David,

David.Corcoran at edftrading.com wrote:
> If RabbitMQ has configurable heartbeat timeouts this problem might
> disappear. For example if you could up the disconnect timeout to 5 seconds
> or more it's probably more likely the heartbeat thread would have had a
> time slice by then.

See 
http://www.rabbitmq.com/javadoc/com/rabbitmq/client/ConnectionParameters.html#setRequestedHeartbeat(int)

Matthias.



From 0x6e6562 at gmail.com  Sat May 10 00:07:29 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Sat, 10 May 2008 00:07:29 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
	<6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
	<CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>
Message-ID: <289AC975-A747-49BF-9C83-738A379DE287@gmail.com>

Ed,

On 8 May 2008, at 21:11, Ben Hood wrote:
>
> On 8 May 2008, at 15:04, Edwin Fine wrote:
>> Thanks for looking into this. In the "real" code, all the setup is  
>> actually done within a single Erlang process, and the only thing  
>> the consumers do is handle the basic.deliver, as well as any  
>> basic.consume_ok  or basic.cancel_ok messages that may arise. In  
>> the test code, I rearranged some things specifically to be done  
>> concurrently, which I now see was a mistake. However, this is a bug  
>> in the test code, not in the production code. I will change the  
>> test code so that there is no concurrent work being done on a  
>> channel other than responding with basic.ack to basic.deliver  
>> messages.
>
> I've begun a discussion on this topic and it looks like we will add  
> the intelligence to the amqp_channel module to be able to serialize  
> concurrent RPC requests to the channel. I understand that you have a  
> workaround anyway, but on reflection, it seems like a good idea to  
> put this capability into the client. will let you know when it is  
> done.

This feature is now implemented in the trunk of the repo. There is  
also a test case to test the serialization of concurrent RPC requests.

I will now look into the next 2 issues you raised.

BTW, I am also in the process of moving the mtn repo to hg, so this  
might happen very soon as well.

HTH,

Ben



From rabbitmq-discuss_efine at usa.net  Sat May 10 01:02:27 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Fri, 9 May 2008 20:02:27 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <289AC975-A747-49BF-9C83-738A379DE287@gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
	<6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
	<CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>
	<289AC975-A747-49BF-9C83-738A379DE287@gmail.com>
Message-ID: <6c2563b20805091702w604c5972x9a563f00d3c8f400@mail.gmail.com>

Thanks, Ben, I will take a look and give you some feedback.

In the meantime, I have done the following:

   - Changed my consumer code (I use the term "consumer" loosely as
   "anything that eats the output of a producer") to use basic.get instead of
   basic.consume. Actually, it's set up so that I can select basic.get or
   basic.consume behavior at run-time. I didn't want to throw away working
   basic.consume code :)
   - Changed the process that creates consumers so that it now creates one
   channel per consumer. Previously, there was one channel only for all
   consumers. One-channel-per-consumer was the only way I could get the code to
   work with the network client; in the one-channel scenario I was getting back
   responses to messages destined for different consumers. I assume that with
   your changes I will be able to again use one channel for all consumers.
   - I tested with 50 queues (each with its own consumer and channel) and it
   seemed reasonably performant, even with the get. I need to try a full-blast
   test soon.

Again, thanks for your help and patience, and do let me know if you see any
merit in the rbmq_admin module I wrote, or if maybe you guys are releasing
an official one.

Regards,
Ed

On Fri, May 9, 2008 at 7:07 PM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Ed,
>
> On 8 May 2008, at 21:11, Ben Hood wrote:
>
>>
>> On 8 May 2008, at 15:04, Edwin Fine wrote:
>>
>>> Thanks for looking into this. In the "real" code, all the setup is
>>> actually done within a single Erlang process, and the only thing the
>>> consumers do is handle the basic.deliver, as well as any basic.consume_ok
>>>  or basic.cancel_ok messages that may arise. In the test code, I rearranged
>>> some things specifically to be done concurrently, which I now see was a
>>> mistake. However, this is a bug in the test code, not in the production
>>> code. I will change the test code so that there is no concurrent work being
>>> done on a channel other than responding with basic.ack to basic.deliver
>>> messages.
>>>
>>
>> I've begun a discussion on this topic and it looks like we will add the
>> intelligence to the amqp_channel module to be able to serialize concurrent
>> RPC requests to the channel. I understand that you have a workaround anyway,
>> but on reflection, it seems like a good idea to put this capability into the
>> client. will let you know when it is done.
>>
>
> This feature is now implemented in the trunk of the repo. There is also a
> test case to test the serialization of concurrent RPC requests.
>
> I will now look into the next 2 issues you raised.
>
> BTW, I am also in the process of moving the mtn repo to hg, so this might
> happen very soon as well.
>
> HTH,
>
> Ben
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080509/f26ac8e8/attachment.htm 

From 0x6e6562 at gmail.com  Mon May 12 19:07:01 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 12 May 2008 19:07:01 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805091702w604c5972x9a563f00d3c8f400@mail.gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
	<6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
	<CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>
	<289AC975-A747-49BF-9C83-738A379DE287@gmail.com>
	<6c2563b20805091702w604c5972x9a563f00d3c8f400@mail.gmail.com>
Message-ID: <94602FAF-4F50-4046-9FE2-11FD32094C9E@gmail.com>

Ed,

On 10 May 2008, at 01:02, Edwin Fine wrote:

> Thanks, Ben, I will take a look and give you some feedback.
>
> In the meantime, I have done the following:
> Changed my consumer code (I use the term "consumer" loosely as  
> "anything that eats the output of a producer") to use basic.get  
> instead of basic.consume. Actually, it's set up so that I can select  
> basic.get or basic.consume behavior at run-time. I didn't want to  
> throw away working basic.consume code :)
> Changed the process that creates consumers so that it now creates  
> one channel per consumer. Previously, there was one channel only for  
> all consumers. One-channel-per-consumer was the only way I could get  
> the code to work with the network client; in the one-channel  
> scenario I was getting back responses to messages destined for  
> different consumers. I assume that with your changes I will be able  
> to again use one channel for all consumers.
> I tested with 50 queues (each with its own consumer and channel) and  
> it seemed reasonably performant, even with the get. I need to try a  
> full-blast test soon.

I have now commited fix 2 of 3 to the mtn repo which addresses the  
issue of not being able to subscribe concurrently. So the 2 issues you  
mention here should be addressed.

The outstanding issue is to close the writer down properly in the  
network case.

HTH,

Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080512/0bf60111/attachment.htm 

From rabbitmq-discuss_efine at usa.net  Mon May 12 20:56:59 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Mon, 12 May 2008 15:56:59 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <94602FAF-4F50-4046-9FE2-11FD32094C9E@gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
	<6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
	<CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>
	<289AC975-A747-49BF-9C83-738A379DE287@gmail.com>
	<6c2563b20805091702w604c5972x9a563f00d3c8f400@mail.gmail.com>
	<94602FAF-4F50-4046-9FE2-11FD32094C9E@gmail.com>
Message-ID: <6c2563b20805121256r2aed20e2kccf82422bdabda17@mail.gmail.com>

Ben,

I was monitoring my running system, and unless I am mistaken, it looks as if
amqp_network_connection:reader_loop/4 has a non-tail recursive call, which
is making it eat stack and heap like there's no tomorrow. There's a call to
gen_tcp:close(Sock) at the end of the function. I suggest you move this to
the last line of start_reader as shown:

start_reader(Sock, FramingPid) ->
    process_flag(trap_exit, true),
    put({channel, 0},{chpid, FramingPid}),
    {ok, Ref} = prim_inet:async_recv(Sock, 7, -1),
    reader_loop(Sock, undefined, undefined, undefined),
*    gen_tcp:close(Sock).*

reader_loop(Sock, Type, Channel, Length) ->
    receive
        {inet_async, Sock, _, {ok, <<Payload:Length/binary,?FRAME_END>>} }
->
            case handle_frame(Type, Channel, Payload) of
                closed_ok ->
                    ok;
                _ ->
                    {ok, Ref} = prim_inet:async_recv(Sock, 7, -1),
                    reader_loop(Sock, undefined, undefined, undefined)
            end;
        {inet_async, Sock, _, {ok, <<_Type:8,_Channel:16,PayloadSize:32>>}}
->
            {ok, Ref} = prim_inet:async_recv(Sock, PayloadSize + 1, -1),
            reader_loop(Sock, _Type, _Channel, PayloadSize);
        {inet_async, Sock, Ref, {error, Reason}} ->
            io:format("Have a look into this one: ~p~n",[Reason]);
        {heartbeat, Heartbeat} ->
            rabbit_heartbeat:start_heartbeat(Sock, Heartbeat),
            reader_loop(Sock, Type, Channel, Length);
        {ChannelPid, ChannelNumber} ->
            start_framing_channel(ChannelPid, ChannelNumber),
            reader_loop(Sock, Type, Channel, Length);
        timeout ->
            io:format("Reader (~p) received timeout from heartbeat, exiting
~n");
        {'EXIT', Pid, Reason} ->
            [H|T] = get_keys({chpid,Pid}),
            erase(H),
            reader_loop(Sock, Type, Channel, Length);
        Other ->
            io:format("Other ~p~n",[Other])
    end,
*    gen_tcp:close(Sock). %% Non-tail recursive call*


On Mon, May 12, 2008 at 2:07 PM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Ed,
> On 10 May 2008, at 01:02, Edwin Fine wrote:
>
> Thanks, Ben, I will take a look and give you some feedback.
>
> In the meantime, I have done the following:
>
>    - Changed my consumer code (I use the term "consumer" loosely as
>    "anything that eats the output of a producer") to use basic.get instead of
>    basic.consume. Actually, it's set up so that I can select basic.get or
>    basic.consume behavior at run-time. I didn't want to throw away working
>    basic.consume code :)
>    - Changed the process that creates consumers so that it now creates
>    one channel per consumer. Previously, there was one channel only for all
>    consumers. One-channel-per-consumer was the only way I could get the code to
>    work with the network client; in the one-channel scenario I was getting back
>    responses to messages destined for different consumers. I assume that with
>    your changes I will be able to again use one channel for all consumers.
>    - I tested with 50 queues (each with its own consumer and channel)
>    and it seemed reasonably performant, even with the get. I need to try a
>    full-blast test soon.
>
>
> I have now commited fix 2 of 3 to the mtn repo which addresses the issue
> of not being able to subscribe concurrently. So the 2 issues you mention
> here should be addressed.
>
> The outstanding issue is to close the writer down properly in the network
> case.
>
> HTH,
>
> Ben
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080512/bd6ca729/attachment.htm 

From 0x6e6562 at gmail.com  Mon May 12 21:44:39 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 12 May 2008 21:44:39 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805121256r2aed20e2kccf82422bdabda17@mail.gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
	<6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
	<CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>
	<289AC975-A747-49BF-9C83-738A379DE287@gmail.com>
	<6c2563b20805091702w604c5972x9a563f00d3c8f400@mail.gmail.com>
	<94602FAF-4F50-4046-9FE2-11FD32094C9E@gmail.com>
	<6c2563b20805121256r2aed20e2kccf82422bdabda17@mail.gmail.com>
Message-ID: <6E3ADB49-EEEA-46E8-9220-37C49125BA86@gmail.com>

Ed,

On 12 May 2008, at 20:56, Edwin Fine wrote:

> Ben,
>
> I was monitoring my running system, and unless I am mistaken, it  
> looks as if amqp_network_connection:reader_loop/4 has a non-tail  
> recursive call, which is making it eat stack and heap like there's  
> no tomorrow. There's a call to gen_tcp:close(Sock) at the end of the  
> function. I suggest you move this to the last line of start_reader  
> as shown:

Fair point. I've applied this change. Thanks for pointing this one out.

> The outstanding issue is to close the writer down properly in the  
> network case.

I've fixed the issue with the network writer not being shut down  
properly and it's in mtn.

HTH,

Ben



From rabbitmq-discuss_efine at usa.net  Mon May 12 22:15:26 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Mon, 12 May 2008 17:15:26 -0400
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6E3ADB49-EEEA-46E8-9220-37C49125BA86@gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
	<6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
	<CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>
	<289AC975-A747-49BF-9C83-738A379DE287@gmail.com>
	<6c2563b20805091702w604c5972x9a563f00d3c8f400@mail.gmail.com>
	<94602FAF-4F50-4046-9FE2-11FD32094C9E@gmail.com>
	<6c2563b20805121256r2aed20e2kccf82422bdabda17@mail.gmail.com>
	<6E3ADB49-EEEA-46E8-9220-37C49125BA86@gmail.com>
Message-ID: <6c2563b20805121415g3066fc0gb8bc1cda4ab1a42e@mail.gmail.com>

Ben,

Thanks for being so responsive to input. It's really great and much
appreciated.

Regards,
Ed

On Mon, May 12, 2008 at 4:44 PM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Ed,
>
> On 12 May 2008, at 20:56, Edwin Fine wrote:
>
>  Ben,
> >
> > I was monitoring my running system, and unless I am mistaken, it looks
> > as if amqp_network_connection:reader_loop/4 has a non-tail recursive call,
> > which is making it eat stack and heap like there's no tomorrow. There's a
> > call to gen_tcp:close(Sock) at the end of the function. I suggest you move
> > this to the last line of start_reader as shown:
> >
>
> Fair point. I've applied this change. Thanks for pointing this one out.
>
>  The outstanding issue is to close the writer down properly in the network
> > case.
> >
>
> I've fixed the issue with the network writer not being shut down properly
> and it's in mtn.
>
> HTH,
>
> Ben
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080512/82efa35c/attachment.htm 

From chime at mu.dk  Tue May 13 07:18:43 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Tue, 13 May 2008 08:18:43 +0200
Subject: [rabbitmq-discuss] Some error messages
Message-ID: <42309DCB-0F58-46DA-820C-6C83C84CEBD3@mu.dk>

Hi,

I have some error messages from RabbitMQ that I'm not really sure what  
means.

First we have

=INFO REPORT==== 12-May-2008::18:21:54 ===
Exception: Channel 3, Reason {amqp,command_invalid,none}

And then later

=ERROR REPORT==== 12-May-2008::18:22:05 ===
Error in process <0.388.15> on node 'rabbit at staging' with exit value:  
{{badmatch
,{error,[{exit,{normal,{gen_server,call,[<0.389.15>, 
{notify_down,<0.387.15>}]}}}
]}},[{rabbit_channel,terminate,2},{buffering_proxy,mainloop,4}]}


=ERROR REPORT==== 12-May-2008::18:22:05 ===
Error in process <0.709.15> on node 'rabbit at staging' with exit value:  
{{badmatch
,{error,[{exit,{normal,{gen_server,call,[<0.710.15>, 
{notify_down,<0.708.15>}]}}}
]}},[{rabbit_channel,terminate,2},{buffering_proxy,mainloop,4}]}


Any idea what this means?

Michael
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080513/c3fab776/attachment.bin 

From mrcoder at yahoo.com  Tue May 13 17:53:14 2008
From: mrcoder at yahoo.com (Geoffrey Anderson)
Date: Tue, 13 May 2008 09:53:14 -0700 (PDT)
Subject: [rabbitmq-discuss] no connection established
Message-ID: <787106.39416.qm@web30004.mail.mud.yahoo.com>

The rabbitmq server runs, it seems, but no connections are being accepted by it,
from the java samples or dotnet sample programs or my own programs.

For three days I have been trying everything imaginable to me to get any client
program to connect to the rabbitmq server.  For example I disabled tcpv6 on my
system and tried all manner of user permissions in the rabbitmq server for 'guest'
and my custom account 'ga' which I gave all same permissions as 'guest'.

The web site asks users to send a note to legitimateconcern at rabbitmq.com if it takes
more than 2 minutes to connect.  Si I have sent a detailed note.  There has been no
response to it.

The web site says  Please join our mailing list or send questions to
info at rabbitmq.com. We'd love to hear from you.   I've subscribed and sent a detailed
message to the mailing list.  My email did not appear in the mailing list, and no
responses came back.

Nothing is working thus far, the mailing list, the feedback email, the rabbitmq
connections.  This is my last attempt for anything to happen after which rabbitmq
must be abandoned for lack of anything working.  More than three days of time is too
much to spend into something and get nothing from it.

To be clear, this message is solely intended as a reflection on my own inabilities
and oversights, and nothing I am aware of is wrong with rabbitmq.com, the rabbitmq
server, the documentation, the sample code, the mailing list, all of which is
graciously offered at no cost, and works for others on the mailing list.  I do not
mean to upset anyone.

My only intent is to ask for a nice person to volunteer their valuable time to share
information  with me that helps the rabbitmq server accept a connection from any
client program. Java is OK, dotnet is OK, either one as you like, I'll work with
you.  I am a C# 2.0 programmer FWIW.  Windows XP-SP2 is the operating system.


Details to demonstrate the RabbitMQ inability to accept a connection. Maybe this
info contains some clue to someone smarter than me, I don't know.


1. Server is launched:

C:\>"C:\rabbitmq\erl5.5.5\lib\rabbitmq_server-1.3.0\sbin\rabbitmq-server.bat"
RabbitMQ 1.3.0 (AMQP 8-0)
Copyright (C) 2007-2008 LShift Ltd., Cohesive Financial Technologies LLC., and
Rabbit Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

Logging to "C:/Documents and Settings/ga/rabbitmq//log/rabbit.log"
SASL logging to "C:/Documents and Settings/ga/rabbitmq//log/rabbit-sasl.log"

starting database             ...done
starting core processes       ...done
starting recovery             ...done
starting persister            ...done
starting builtin applications ...done
starting TCP listeners        ...done

broker running



2. Java sample program "Tracer" is launched:

C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat com.rabbitmq.tools.Tracer
Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
Invoked as: Tracer 5673 localhost 5672
com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false



3. Dotnet sample program is launched:

C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>DeclareQueue.exe alpeduez
testqueue
None of the specified endpoints were reachable
Endpoints attempted:
  endpoint=amqp-0-9://alpeduez:5672, attempts=1, outcome=AMQP server protocol
negotiation failure: server version 0-8, t
ransport parameters -1:-1
Stack trace:
   at RabbitMQ.Client.ConnectionFactory.CreateConnection(Int32 maxRedirects,
AmqpTcpEndpoint[] endpoints)
   at RabbitMQ.Client.ConnectionFactory.CreateConnection(AmqpTcpEndpoint[]
endpoints)
   at RabbitMQ.Client.ConnectionFactory.CreateConnection(String address)
   at RabbitMQ.Client.Examples.DeclareQueue.Main(String[] args)




4.  Go look again to see if Tracer saw any traffic:

C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat com.rabbitmq.tools.Tracer
Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
Invoked as: Tracer 5673 localhost 5672
com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false


It seems no traffic was detected during the dotnet sample program execution.


5. Do a netstat command to see if it looks like a server is really listening.

C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>netstat

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    alpeduez:1800          localhost:4369         ESTABLISHED
  TCP    alpeduez:4369          localhost:1800         ESTABLISHED
  TCP    alpeduez:1802          alpeduez:5672          TIME_WAIT

C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>


Yes there is something on alpeduez:5672 which is in a TIME_WAIT.  Maybe that's OK,
maybe not.  I don't know what a normally working system netstat looks like. Do you
know what a netstat returns on a working rabbitmq system installation?


6. I run my own C# software and attempt connection to rabbitmq.  

No connections are working and the error message talks about endpoints or protocols.
Sorry I dont remember exactly, my bad.  The CreateConnection method on the factory
is throwing the exception consistently on all input values.  I was using
Protocol.GetFromEnviroment and passing in my host name 'alpeduez' to the
CreateConnection method.



7.  This is the whole contents of rabbit.log


=INFO REPORT==== 13-May-2008::12:32:09 ===
disk_log: repairing "c:/Documents and
Settings/ga/rabbitmq/db/rabbit-mnesia/rabbit_persister.LOG" ...

=INFO REPORT==== 13-May-2008::12:32:09 ===
Repaired persister log - 1 recovered, 0 bad

=INFO REPORT==== 13-May-2008::12:32:09 ===
Rolling persister log to "c:/Documents and
Settings/ga/rabbitmq/db/rabbit-mnesia/rabbit_persister.LOG.previous"

=INFO REPORT==== 13-May-2008::12:32:09 ===
started TCP listener on 0.0.0.0:5672

=INFO REPORT==== 13-May-2008::12:39:39 ===
accepted TCP connection on 0.0.0.0:5672 from 192.168.1.100:1802

=ERROR REPORT==== 13-May-2008::12:39:39 ===
error on TCP connection from 192.168.1.100:1802
connection_closed_abruptly

=INFO REPORT==== 13-May-2008::12:39:39 ===
closing TCP connection from 192.168.1.100:1802



Thank you for any clues or attempts to help me get a connection to RabbitMQ.


Regards,

Geoffrey











From David.Corcoran at edftrading.com  Tue May 13 17:59:53 2008
From: David.Corcoran at edftrading.com (David.Corcoran at edftrading.com)
Date: Tue, 13 May 2008 17:59:53 +0100
Subject: [rabbitmq-discuss] no connection established
In-Reply-To: <787106.39416.qm@web30004.mail.mud.yahoo.com>
Message-ID: <OF710AE60B.142B7842-ON80257448.005D2305-80257448.005D5FCE@Edftrading.com>

Hey Geoffrey,

If you try:
DeclareQueue.exe localhost testqueue
do you have any more luck?

Although RabbitMQ is listening to 0.0.0.0 there may be some hostname
resolution issues happening.

Dave



                                                                           
             Geoffrey Anderson                                             
             <mrcoder at yahoo.co                                             
             m>                                                         To 
             Sent by:                  rabbitmq-discuss at lists.rabbitmq.com 
             rabbitmq-discuss-                                          cc 
             bounces at lists.rab                                             
             bitmq.com                                             Subject 
                                       [rabbitmq-discuss] no connection    
                                       established                         
             13/05/2008 17:53                                              
                                                                           
                                                                           
                                                                           
                                                                           
                                                                           





The rabbitmq server runs, it seems, but no connections are being accepted
by it,
from the java samples or dotnet sample programs or my own programs.

For three days I have been trying everything imaginable to me to get any
client
program to connect to the rabbitmq server.  For example I disabled tcpv6 on
my
system and tried all manner of user permissions in the rabbitmq server for
'guest'
and my custom account 'ga' which I gave all same permissions as 'guest'.

The web site asks users to send a note to legitimateconcern at rabbitmq.com if
it takes
more than 2 minutes to connect.  Si I have sent a detailed note.  There has
been no
response to it.

The web site says  Please join our mailing list or send questions to
info at rabbitmq.com. We'd love to hear from you.   I've subscribed and sent a
detailed
message to the mailing list.  My email did not appear in the mailing list,
and no
responses came back.

Nothing is working thus far, the mailing list, the feedback email, the
rabbitmq
connections.  This is my last attempt for anything to happen after which
rabbitmq
must be abandoned for lack of anything working.  More than three days of
time is too
much to spend into something and get nothing from it.

To be clear, this message is solely intended as a reflection on my own
inabilities
and oversights, and nothing I am aware of is wrong with rabbitmq.com, the
rabbitmq
server, the documentation, the sample code, the mailing list, all of which
is
graciously offered at no cost, and works for others on the mailing list.  I
do not
mean to upset anyone.

My only intent is to ask for a nice person to volunteer their valuable time
to share
information  with me that helps the rabbitmq server accept a connection
from any
client program. Java is OK, dotnet is OK, either one as you like, I'll work
with
you.  I am a C# 2.0 programmer FWIW.  Windows XP-SP2 is the operating
system.


Details to demonstrate the RabbitMQ inability to accept a connection. Maybe
this
info contains some clue to someone smarter than me, I don't know.


1. Server is launched:

C:\>"C:\rabbitmq\erl5.5.5\lib\rabbitmq_server-1.3.0
\sbin\rabbitmq-server.bat"
RabbitMQ 1.3.0 (AMQP 8-0)
Copyright (C) 2007-2008 LShift Ltd., Cohesive Financial Technologies LLC.,
and
Rabbit Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

Logging to "C:/Documents and Settings/ga/rabbitmq//log/rabbit.log"
SASL logging to "C:/Documents and
Settings/ga/rabbitmq//log/rabbit-sasl.log"

starting database             ...done
starting core processes       ...done
starting recovery             ...done
starting persister            ...done
starting builtin applications ...done
starting TCP listeners        ...done

broker running



2. Java sample program "Tracer" is launched:

C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat com.rabbitmq.tools.Tracer
Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
Invoked as: Tracer 5673 localhost 5672
com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false



3. Dotnet sample program is launched:

C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>DeclareQueue.exe
alpeduez
testqueue
None of the specified endpoints were reachable
Endpoints attempted:
  endpoint=amqp-0-9://alpeduez:5672, attempts=1, outcome=AMQP server
protocol
negotiation failure: server version 0-8, t
ransport parameters -1:-1
Stack trace:
   at RabbitMQ.Client.ConnectionFactory.CreateConnection(Int32
maxRedirects,
AmqpTcpEndpoint[] endpoints)
   at RabbitMQ.Client.ConnectionFactory.CreateConnection(AmqpTcpEndpoint[]
endpoints)
   at RabbitMQ.Client.ConnectionFactory.CreateConnection(String address)
   at RabbitMQ.Client.Examples.DeclareQueue.Main(String[] args)




4.  Go look again to see if Tracer saw any traffic:

C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat com.rabbitmq.tools.Tracer
Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
Invoked as: Tracer 5673 localhost 5672
com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false


It seems no traffic was detected during the dotnet sample program
execution.


5. Do a netstat command to see if it looks like a server is really
listening.

C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>netstat

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    alpeduez:1800          localhost:4369         ESTABLISHED
  TCP    alpeduez:4369          localhost:1800         ESTABLISHED
  TCP    alpeduez:1802          alpeduez:5672          TIME_WAIT

C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>


Yes there is something on alpeduez:5672 which is in a TIME_WAIT.  Maybe
that's OK,
maybe not.  I don't know what a normally working system netstat looks like.
Do you
know what a netstat returns on a working rabbitmq system installation?


6. I run my own C# software and attempt connection to rabbitmq.

No connections are working and the error message talks about endpoints or
protocols.
Sorry I dont remember exactly, my bad.  The CreateConnection method on the
factory
is throwing the exception consistently on all input values.  I was using
Protocol.GetFromEnviroment and passing in my host name 'alpeduez' to the
CreateConnection method.



7.  This is the whole contents of rabbit.log


=INFO REPORT==== 13-May-2008::12:32:09 ===
disk_log: repairing "c:/Documents and
Settings/ga/rabbitmq/db/rabbit-mnesia/rabbit_persister.LOG" ...

=INFO REPORT==== 13-May-2008::12:32:09 ===
Repaired persister log - 1 recovered, 0 bad

=INFO REPORT==== 13-May-2008::12:32:09 ===
Rolling persister log to "c:/Documents and
Settings/ga/rabbitmq/db/rabbit-mnesia/rabbit_persister.LOG.previous"

=INFO REPORT==== 13-May-2008::12:32:09 ===
started TCP listener on 0.0.0.0:5672

=INFO REPORT==== 13-May-2008::12:39:39 ===
accepted TCP connection on 0.0.0.0:5672 from 192.168.1.100:1802

=ERROR REPORT==== 13-May-2008::12:39:39 ===
error on TCP connection from 192.168.1.100:1802
connection_closed_abruptly

=INFO REPORT==== 13-May-2008::12:39:39 ===
closing TCP connection from 192.168.1.100:1802



Thank you for any clues or attempts to help me get a connection to
RabbitMQ.


Regards,

Geoffrey









_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss



*********************************************************************
This communication contains confidential information, some or all of which may be privileged. It is for the intended recipient only and others must not disclose, distribute, copy, print or rely on this communication. If an addressing or transmission error has misdirected this communication, please notify the sender by replying to this e-mail and then delete the e-mail. E-mail sent to EDF Trading may be monitored by the company. Thank you. 
EDF Trading Limited
80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
A Company registered in England No. 4255974. 
Switchboard: 020 7061 4000
EDF Trading Markets Limited is a member of the EDF Trading Limited Group and is authorised and regulated by the Financial Services Authority.
VAT number: GB 735 5479 07
*********************************************************************



From rabbitmq-discuss_efine at usa.net  Tue May 13 18:46:46 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Tue, 13 May 2008 13:46:46 -0400
Subject: [rabbitmq-discuss] no connection established
In-Reply-To: <OF710AE60B.142B7842-ON80257448.005D2305-80257448.005D5FCE@Edftrading.com>
References: <787106.39416.qm@web30004.mail.mud.yahoo.com>
	<OF710AE60B.142B7842-ON80257448.005D2305-80257448.005D5FCE@Edftrading.com>
Message-ID: <6c2563b20805131046v26229aefv40b89ac1da18ae60@mail.gmail.com>

I am not a RabbitMQ expert, but it seems to me that this message is te key
to your problems:

  endpoint=amqp-0-9://alpeduez:5672, attempts=1, outcome=*AMQP server
protocol negotiation failure: server version 0-8*, transport parameters
-1:-1

RabbitMQ Server currently supports AMQP protocol version 0.8, and it seems
as if the clients are connecting with a 0.9 protocol. I think if you ensure
that all clients are talking 0.8 things will work better. I think :)

Hope this helps
Edwin Fine

On Tue, May 13, 2008 at 12:59 PM, <David.Corcoran at edftrading.com> wrote:

> Hey Geoffrey,
>
> If you try:
> DeclareQueue.exe localhost testqueue
> do you have any more luck?
>
> Although RabbitMQ is listening to 0.0.0.0 there may be some hostname
> resolution issues happening.
>
> Dave
>
>
>
>
>             Geoffrey Anderson
>             <mrcoder at yahoo.co
>             m>                                                         To
>             Sent by:                  rabbitmq-discuss at lists.rabbitmq.com
>             rabbitmq-discuss-                                          cc
>             bounces at lists.rab
>             bitmq.com                                             Subject
>                                       [rabbitmq-discuss] no connection
>                                       established
>             13/05/2008 17:53
>
>
>
>
>
>
>
>
>
>
> The rabbitmq server runs, it seems, but no connections are being accepted
> by it,
> from the java samples or dotnet sample programs or my own programs.
>
> For three days I have been trying everything imaginable to me to get any
> client
> program to connect to the rabbitmq server.  For example I disabled tcpv6
> on
> my
> system and tried all manner of user permissions in the rabbitmq server for
> 'guest'
> and my custom account 'ga' which I gave all same permissions as 'guest'.
>
> The web site asks users to send a note to legitimateconcern at rabbitmq.comif
> it takes
> more than 2 minutes to connect.  Si I have sent a detailed note.  There
> has
> been no
> response to it.
>
> The web site says  Please join our mailing list or send questions to
> info at rabbitmq.com. We'd love to hear from you.   I've subscribed and sent
> a
> detailed
> message to the mailing list.  My email did not appear in the mailing list,
> and no
> responses came back.
>
> Nothing is working thus far, the mailing list, the feedback email, the
> rabbitmq
> connections.  This is my last attempt for anything to happen after which
> rabbitmq
> must be abandoned for lack of anything working.  More than three days of
> time is too
> much to spend into something and get nothing from it.
>
> To be clear, this message is solely intended as a reflection on my own
> inabilities
> and oversights, and nothing I am aware of is wrong with rabbitmq.com, the
> rabbitmq
> server, the documentation, the sample code, the mailing list, all of which
> is
> graciously offered at no cost, and works for others on the mailing list.
>  I
> do not
> mean to upset anyone.
>
> My only intent is to ask for a nice person to volunteer their valuable
> time
> to share
> information  with me that helps the rabbitmq server accept a connection
> from any
> client program. Java is OK, dotnet is OK, either one as you like, I'll
> work
> with
> you.  I am a C# 2.0 programmer FWIW.  Windows XP-SP2 is the operating
> system.
>
>
> Details to demonstrate the RabbitMQ inability to accept a connection.
> Maybe
> this
> info contains some clue to someone smarter than me, I don't know.
>
>
> 1. Server is launched:
>
> C:\>"C:\rabbitmq\erl5.5.5\lib\rabbitmq_server-1.3.0
> \sbin\rabbitmq-server.bat"
> RabbitMQ 1.3.0 (AMQP 8-0)
> Copyright (C) 2007-2008 LShift Ltd., Cohesive Financial Technologies LLC.,
> and
> Rabbit Technologies Ltd.
> Licensed under the MPL.  See http://www.rabbitmq.com/
>
> Logging to "C:/Documents and Settings/ga/rabbitmq//log/rabbit.log"
> SASL logging to "C:/Documents and
> Settings/ga/rabbitmq//log/rabbit-sasl.log"
>
> starting database             ...done
> starting core processes       ...done
> starting recovery             ...done
> starting persister            ...done
> starting builtin applications ...done
> starting TCP listeners        ...done
>
> broker running
>
>
>
> 2. Java sample program "Tracer" is launched:
>
> C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat com.rabbitmq.tools.Tracer
> Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
> Invoked as: Tracer 5673 localhost 5672
> com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
> com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
> com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
> com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false
>
>
>
> 3. Dotnet sample program is launched:
>
> C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>DeclareQueue.exe
> alpeduez
> testqueue
> None of the specified endpoints were reachable
> Endpoints attempted:
>  endpoint=amqp-0-9://alpeduez:5672, attempts=1, outcome=AMQP server
> protocol
> negotiation failure: server version 0-8, t
> ransport parameters -1:-1
> Stack trace:
>   at RabbitMQ.Client.ConnectionFactory.CreateConnection(Int32
> maxRedirects,
> AmqpTcpEndpoint[] endpoints)
>   at RabbitMQ.Client.ConnectionFactory.CreateConnection(AmqpTcpEndpoint[]
> endpoints)
>   at RabbitMQ.Client.ConnectionFactory.CreateConnection(String address)
>   at RabbitMQ.Client.Examples.DeclareQueue.Main(String[] args)
>
>
>
>
> 4.  Go look again to see if Tracer saw any traffic:
>
> C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat com.rabbitmq.tools.Tracer
> Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
> Invoked as: Tracer 5673 localhost 5672
> com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
> com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
> com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
> com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false
>
>
> It seems no traffic was detected during the dotnet sample program
> execution.
>
>
> 5. Do a netstat command to see if it looks like a server is really
> listening.
>
> C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>netstat
>
> Active Connections
>
>  Proto  Local Address          Foreign Address        State
>  TCP    alpeduez:1800          localhost:4369         ESTABLISHED
>  TCP    alpeduez:4369          localhost:1800         ESTABLISHED
>  TCP    alpeduez:1802          alpeduez:5672          TIME_WAIT
>
> C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>
>
>
> Yes there is something on alpeduez:5672 which is in a TIME_WAIT.  Maybe
> that's OK,
> maybe not.  I don't know what a normally working system netstat looks
> like.
> Do you
> know what a netstat returns on a working rabbitmq system installation?
>
>
> 6. I run my own C# software and attempt connection to rabbitmq.
>
> No connections are working and the error message talks about endpoints or
> protocols.
> Sorry I dont remember exactly, my bad.  The CreateConnection method on the
> factory
> is throwing the exception consistently on all input values.  I was using
> Protocol.GetFromEnviroment and passing in my host name 'alpeduez' to the
> CreateConnection method.
>
>
>
> 7.  This is the whole contents of rabbit.log
>
>
> =INFO REPORT==== 13-May-2008::12:32:09 ===
> disk_log: repairing "c:/Documents and
> Settings/ga/rabbitmq/db/rabbit-mnesia/rabbit_persister.LOG" ...
>
> =INFO REPORT==== 13-May-2008::12:32:09 ===
> Repaired persister log - 1 recovered, 0 bad
>
> =INFO REPORT==== 13-May-2008::12:32:09 ===
> Rolling persister log to "c:/Documents and
> Settings/ga/rabbitmq/db/rabbit-mnesia/rabbit_persister.LOG.previous"
>
> =INFO REPORT==== 13-May-2008::12:32:09 ===
> started TCP listener on 0.0.0.0:5672
>
> =INFO REPORT==== 13-May-2008::12:39:39 ===
> accepted TCP connection on 0.0.0.0:5672 from 192.168.1.100:1802
>
> =ERROR REPORT==== 13-May-2008::12:39:39 ===
> error on TCP connection from 192.168.1.100:1802
> connection_closed_abruptly
>
> =INFO REPORT==== 13-May-2008::12:39:39 ===
> closing TCP connection from 192.168.1.100:1802
>
>
>
> Thank you for any clues or attempts to help me get a connection to
> RabbitMQ.
>
>
> Regards,
>
> Geoffrey
>
>
>
>
>
>
>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
>
> *********************************************************************
> This communication contains confidential information, some or all of which
> may be privileged. It is for the intended recipient only and others must not
> disclose, distribute, copy, print or rely on this communication. If an
> addressing or transmission error has misdirected this communication, please
> notify the sender by replying to this e-mail and then delete the e-mail.
> E-mail sent to EDF Trading may be monitored by the company. Thank you.
> EDF Trading Limited
> 80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
> A Company registered in England No. 4255974.
> Switchboard: 020 7061 4000
> EDF Trading Markets Limited is a member of the EDF Trading Limited Group
> and is authorised and regulated by the Financial Services Authority.
> VAT number: GB 735 5479 07
> *********************************************************************
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080513/f3a33848/attachment.htm 

From 0x6e6562 at gmail.com  Tue May 13 18:53:30 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 13 May 2008 18:53:30 +0100
Subject: [rabbitmq-discuss] no connection established
In-Reply-To: <787106.39416.qm@web30004.mail.mud.yahoo.com>
References: <787106.39416.qm@web30004.mail.mud.yahoo.com>
Message-ID: <3345C962-0443-4B37-A897-A79E1C5871F0@gmail.com>

Hi Geoffrey,

Sorry to hear that you have run into difficulties.

On 13 May 2008, at 17:53, Geoffrey Anderson wrote:

> The rabbitmq server runs, it seems, but no connections are being  
> accepted by it,
> from the java samples or dotnet sample programs or my own programs.

Can you try with a simple TCP client, e.g.

nc 0.0.0.0 5672

?

What shows up in the server log when you do this?

> For three days I have been trying everything imaginable to me to get  
> any client
> program to connect to the rabbitmq server.  For example I disabled  
> tcpv6 on my
> system and tried all manner of user permissions in the rabbitmq  
> server for 'guest'
> and my custom account 'ga' which I gave all same permissions as  
> 'guest'.
>


By default Rabbit ships with the user/pass combination guest/guest, so  
without further ado that should work.

> The web site asks users to send a note to legitimateconcern at rabbitmq.com 
>  if it takes
> more than 2 minutes to connect.  Si I have sent a detailed note.   
> There has been no
> response to it.

Don't want to split hairs but the address is legitimategrievance at rabbitmq.com 
, so you probably sent a message to a non-existent mailbox.

>
>
> The web site says  Please join our mailing list or send questions to
> info at rabbitmq.com. We'd love to hear from you.   I've subscribed and  
> sent a detailed
> message to the mailing list.  My email did not appear in the mailing  
> list, and no
> responses came back.

Here's one :-)

> Nothing is working thus far, the mailing list, the feedback email,  
> the rabbitmq
> connections.  This is my last attempt for anything to happen after  
> which rabbitmq
> must be abandoned for lack of anything working.  More than three  
> days of time is too
> much to spend into something and get nothing from it.
>
...
>
> 2. Java sample program "Tracer" is launched:
>
> C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat  
> com.rabbitmq.tools.Tracer
> Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
> Invoked as: Tracer 5673 localhost 5672
> com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
> com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
> com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
> com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false
>
>
>
> 3. Dotnet sample program is launched:
>
> C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832- 
> net-2.0\bin>DeclareQueue.exe alpeduez
> testqueue
> None of the specified endpoints were reachable
> Endpoints attempted:
>  endpoint=amqp-0-9://alpeduez:5672, attempts=1, outcome=AMQP server  
> protocol
> negotiation failure: server version 0-8, t
> ransport parameters -1:-1
> Stack trace:
>   at RabbitMQ.Client.ConnectionFactory.CreateConnection(Int32  
> maxRedirects,
> AmqpTcpEndpoint[] endpoints)
>   at  
> RabbitMQ.Client.ConnectionFactory.CreateConnection(AmqpTcpEndpoint[]
> endpoints)
>   at RabbitMQ.Client.ConnectionFactory.CreateConnection(String  
> address)
>   at RabbitMQ.Client.Examples.DeclareQueue.Main(String[] args)
>

You need to specify the protocol version in your config file (refer to  
the .NET client manual).
This client is defaulting to AMQP 0-9 whereas Rabbit currently speaks  
0-8.

>
> 4.  Go look again to see if Tracer saw any traffic:
>
> C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat  
> com.rabbitmq.tools.Tracer
> Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
> Invoked as: Tracer 5673 localhost 5672
> com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
> com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
> com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
> com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false
>
>
> It seems no traffic was detected during the dotnet sample program  
> execution.
>

Your client will need to connect to the listen port of the tracer,  
i.e. 5673. By default AMQP clients connect to 5672.

HTH,

Ben




From 0x6e6562 at gmail.com  Tue May 13 18:55:05 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 13 May 2008 18:55:05 +0100
Subject: [rabbitmq-discuss] Some error messages
In-Reply-To: <42309DCB-0F58-46DA-820C-6C83C84CEBD3@mu.dk>
References: <42309DCB-0F58-46DA-820C-6C83C84CEBD3@mu.dk>
Message-ID: <C33943D5-50EF-4F01-8764-69D54228BA81@gmail.com>

Michael,

On 13 May 2008, at 07:18, Michael Arnoldus wrote:

> Hi,
>
> I have some error messages from RabbitMQ that I'm not really sure  
> what means.
>
> First we have
>
> =INFO REPORT==== 12-May-2008::18:21:54 ===
> Exception: Channel 3, Reason {amqp,command_invalid,none}
>
> And then later
>
> =ERROR REPORT==== 12-May-2008::18:22:05 ===
> Error in process <0.388.15> on node 'rabbit at staging' with exit  
> value: {{badmatch
> ,{error,[{exit,{normal,{gen_server,call,[<0.389.15>, 
> {notify_down,<0.387.15>}]}}}
> ]}},[{rabbit_channel,terminate,2},{buffering_proxy,mainloop,4}]}
>
>
> =ERROR REPORT==== 12-May-2008::18:22:05 ===
> Error in process <0.709.15> on node 'rabbit at staging' with exit  
> value: {{badmatch
> ,{error,[{exit,{normal,{gen_server,call,[<0.710.15>, 
> {notify_down,<0.708.15>}]}}}
> ]}},[{rabbit_channel,terminate,2},{buffering_proxy,mainloop,4}]}
>
>
> Any idea what this means?

Do you know how to reproduce this?

Ben



From mrcoder at yahoo.com  Tue May 13 19:06:39 2008
From: mrcoder at yahoo.com (Geoffrey Anderson)
Date: Tue, 13 May 2008 11:06:39 -0700 (PDT)
Subject: [rabbitmq-discuss] no connection established
In-Reply-To: <OF710AE60B.142B7842-ON80257448.005D2305-80257448.005D5FCE@Edftrading.com>
Message-ID: <549549.44821.qm@web30003.mail.mud.yahoo.com>

Hello David, 

The DeclareQueue sample dotnet program exhibits the connection problem too. All
programs do.  Below is the output.  Endpoint problems are indicated as always.  The
RabbitMQ server is already running in a different console window.   

If hostname resolution issues exist, I should think I would be able to detect the
problem with other programs and systems.  I have not seen problems in other programs
yet.   'Yet' is the operative word because something is definitely not working, for
sure.  Whether it is limited to RabbitMQ or not is unclear but the only program not
working on this host is RabbitMQ to the limit of my current knowledge so therefore I
will continue to focus on RabbitMQ. I used to use Apache ActiveMQ and Iona's brand
of the same but it had shutdown errors which made too much of a mess with the
message transactions to bear so I abandoned them.  Socket connections worked though.
I pushed stuff into those queues OK.


C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>declarequeue localhost
testqueue
None of the specified endpoints were reachable
Endpoints attempted:
  endpoint=amqp-0-9://localhost:5672, attempts=1, outcome=AMQP server protocol
negotiation failure: server version 0-8,
transport parameters -1:-1
Stack trace:
   at RabbitMQ.Client.ConnectionFactory.CreateConnection(Int32 maxRedirects,
AmqpTcpEndpoint[] endpoints)
...



--- David.Corcoran at edftrading.com wrote:

> Hey Geoffrey,
> 
> If you try:
> DeclareQueue.exe localhost testqueue
> do you have any more luck?
> 
> Although RabbitMQ is listening to 0.0.0.0 there may be some hostname
> resolution issues happening.
> 
> Dave
>



From matthias at lshift.net  Tue May 13 19:18:20 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 13 May 2008 19:18:20 +0100
Subject: [rabbitmq-discuss] no connection established
In-Reply-To: <787106.39416.qm@web30004.mail.mud.yahoo.com>
References: <787106.39416.qm@web30004.mail.mud.yahoo.com>
Message-ID: <4829DB6C.7050902@lshift.net>

Geoffrey,

Geoffrey Anderson wrote:

> The web site asks users to send a note to
> legitimateconcern at rabbitmq.com if it takes more than 2 minutes to
> connect.  Si I have sent a detailed note.  There has been no response
> to it.

I am attaching the replies that a colleague and I sent in response to 
your email to legitimategrievance at rabbitmq.com. Did you not receive them?

> I've subscribed and sent a detailed message to the mailing list. My
> email did not appear in the mailing list, and no responses came back.

That is strange. Please forward me the message you sent.

Given that *this* message *did* appear on the mailing list, your 
subscription appears to be working fine now.

> More than three days of time is too
> much to spend into something and get nothing from it.

I totally agree, which is why we have the legitimategrievance hotline :)

Hopefully the answers in the attached emails get you going. If not 
please mail back.


Matthias.
-------------- next part --------------
An embedded message was scrubbed...
From: Matthias Radestock <matthias at lshift.net>
Subject: Re: 2 minutes?  try 2 days
Date: Mon, 12 May 2008 00:13:25 +0100
Size: 4196
Url: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080513/f114c361/attachment.eml 
-------------- next part --------------
An embedded message was scrubbed...
From: Tony Garnock-Jones <tonyg at lshift.net>
Subject: Re: 2 minutes?  try 2 days
Date: Mon, 12 May 2008 11:35:51 +0100
Size: 2253
Url: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080513/f114c361/attachment-0001.eml 

From matthias at lshift.net  Tue May 13 19:39:57 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 13 May 2008 19:39:57 +0100
Subject: [rabbitmq-discuss] Some error messages
In-Reply-To: <42309DCB-0F58-46DA-820C-6C83C84CEBD3@mu.dk>
References: <42309DCB-0F58-46DA-820C-6C83C84CEBD3@mu.dk>
Message-ID: <4829E07D.1070602@lshift.net>

Michael,

Michael Arnoldus wrote:
> =INFO REPORT==== 12-May-2008::18:21:54 ===
> Exception: Channel 3, Reason {amqp,command_invalid,none}

That could be caused by any number of things. Is there nothing else of 
interest in the log?

I should note that error reporting will be improved in the next release, 
with better reports in both the server logs and responses to the client.

> =ERROR REPORT==== 12-May-2008::18:22:05 ===
> Error in process <0.388.15> on node 'rabbit at staging' with exit value: 
> {{badmatch
> ,{error,[{exit,{normal,{gen_server,call,[<0.389.15>,{notify_down,<0.387.15>}]}}} 
> 
> ]}},[{rabbit_channel,terminate,2},{buffering_proxy,mainloop,4}]}

You reported this one before, remember? See 
http://www.nabble.com/Possible-bug--td16805989.html

My answer there is still valid ;)


Matthias.



From mrcoder at yahoo.com  Tue May 13 20:16:05 2008
From: mrcoder at yahoo.com (Geoffrey Anderson)
Date: Tue, 13 May 2008 12:16:05 -0700 (PDT)
Subject: [rabbitmq-discuss] no connection established
In-Reply-To: <3345C962-0443-4B37-A897-A79E1C5871F0@gmail.com>
Message-ID: <660757.12172.qm@web30006.mail.mud.yahoo.com>


--- Ben Hood <0x6e6562 at gmail.com> wrote:

> Hi Geoffrey,
> 
> Sorry to hear that you have run into difficulties.
> 
> On 13 May 2008, at 17:53, Geoffrey Anderson wrote:
> 
> > The rabbitmq server runs, it seems, but no connections are being  
> > accepted by it,
> > from the java samples or dotnet sample programs or my own programs.
> 
> Can you try with a simple TCP client, e.g.
> 
> nc 0.0.0.0 5672
> 
> ?
> 
> What shows up in the server log when you do this?


C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>nc
'nc' is not recognized as an internal or external command,
operable program or batch file.


C:\Documents and Settings\ga>telnet 0.0.0.0 5672
Connecting To 0.0.0.0...Could not open connection to the host, on port 5672: Connect
failed

Thank you for the interesting suggestion.  I imagine telnet is just as good as 'nc'
for this purpose although I don't know what 'nc' is.

Seems like no process is listening on port 5672 doesn't it?

OTOH netstat suggests there really IS a process listening there, if I am reading it
correctly:

C:\Documents and Settings\ga>netstat -a

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    alpeduez:epmap         alpeduez:0             LISTENING
  TCP    alpeduez:microsoft-ds  alpeduez:0             LISTENING
  TCP    alpeduez:1227          alpeduez:0             LISTENING
  TCP    alpeduez:4369          alpeduez:0             LISTENING
  TCP    alpeduez:5672          alpeduez:0             LISTENING
  TCP    alpeduez:1229          localhost:4369         ESTABLISHED
  TCP    alpeduez:4369          localhost:1229         ESTABLISHED


> 
> > For three days I have been trying everything imaginable to me to get  
> > any client
> > program to connect to the rabbitmq server.  For example I disabled  
> > tcpv6 on my
> > system and tried all manner of user permissions in the rabbitmq  
> > server for 'guest'
> > and my custom account 'ga' which I gave all same permissions as  
> > 'guest'.
> >
> 
> 
> By default Rabbit ships with the user/pass combination guest/guest, so  
> without further ado that should work.
> 

I agree.  Unfortunately guest/guest really does not work at the moment if the sample
programs are an indication.  I shall remove the guest account's permissions for host
security purposes later after this problem is resoloved.  Default accounts that ship
with server programs are typical attack targets for malware and script kiddies.

> > The web site asks users to send a note to legitimateconcern at rabbitmq.com 
> >  if it takes
> > more than 2 minutes to connect.  Si I have sent a detailed note.   
> > There has been no
> > response to it.
> 
> Don't want to split hairs but the address is legitimategrievance at rabbitmq.com 
> , so you probably sent a message to a non-existent mailbox.
> 

What I didn't tell you until now -- your answer is actually reasonable given what
you knew -- was that I pulled that email address from (human) memory as I was
writing, really only meant as an approximation to get the idea across of what I had
done.  It's not the email address I really used, which was copied from the web page
at rabbitmq.com into the clipboard memory and then pasted into the mail program
verbatim.  And lo, just a few minutes ago, another person has confirmed receipt of
the original email message, so it's known to be the correct address which I had used
the other day.

> >
> >
> > The web site says  Please join our mailing list or send questions to
> > info at rabbitmq.com. We'd love to hear from you.   I've subscribed and  
> > sent a detailed
> > message to the mailing list.  My email did not appear in the mailing  
> > list, and no
> > responses came back.
> 
> Here's one :-)


Very much appreciated.


> > C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832- 
> > net-2.0\bin>DeclareQueue.exe alpeduez
> > testqueue
> > None of the specified endpoints were reachable
> > Endpoints attempted:
> >  endpoint=amqp-0-9://alpeduez:5672, attempts=1, outcome=AMQP server  
> > protocol
> > negotiation failure: server version 0-8, t
> > ransport parameters -1:-1
> > Stack trace:
> >   at RabbitMQ.Client.ConnectionFactory.CreateConnection(Int32  
> > maxRedirects,
> > AmqpTcpEndpoint[] endpoints)
> >   at  
> > RabbitMQ.Client.ConnectionFactory.CreateConnection(AmqpTcpEndpoint[]
> > endpoints)
> >   at RabbitMQ.Client.ConnectionFactory.CreateConnection(String  
> > address)
> >   at RabbitMQ.Client.Examples.DeclareQueue.Main(String[] args)
> >
> 
> You need to specify the protocol version in your config file (refer to  
> the .NET client manual).
> This client is defaulting to AMQP 0-9 whereas Rabbit currently speaks  
> 0-8.
> 


Your idea is intriguing... I have a good expectation about it.

You may well be correct.  It's interesting though, that the .Net client would be
defaulting to a version of the protocol which is more advanced than the RabbitMQ
server.  I wonder how the author developed the .Net client libs in advance of the
server.  He's a pretty advanced developer. ;)  

More specifically, in my own programs, I had been trying to use a construct like
this:

IProtocol protocol = Protocols.FromEnvironment();
IConnection conn = factory.CreateConnection(protocol, hostName);

To my surprise it didn't work.  Now, I am looking at the .NET client user guide
sections 2.2 and 2.3.

It says there is (or expected to be) an environment variable where it gets its
information:

"If no argument is passed to FromEnvironment() or FromConfiguration(), the value of
Protocols.DefaultAppSettingsKey is used. (At the time of writing, the default
appSettings key is
AMQP_PROTOCOL, the same as the name of the shell environment variable scanned.)"


Well the reality is that my system is telling me there really isn't any such shell
environment variable defined:  

C:\rabbitmq\librabbitmq-java-1.3.0>echo %AMQP_PROTOCOL%
%AMQP_PROTOCOL%

Maybe this missing envoronment variable is why Protocols.FromEnvironment() is not
useful on my system.

Tyring to follow along with your suggestion, I guess there are two ways to get the
sample .NET programs working with the 0.8 protocol rather than 0.9 protocol.

1 - Change the environment variable AMQP_PROTOCOL.  However, my system is reporting
that I don't have this environment variable defined anywhere, so I don't know for
sure what to do.  Should I define one now?  I guess I could try to create one and
see what happens.  I guess I will set AMQP_PROTOCOL to the value "AMQP_0_8".

2 - Change the .config file for every client application. Seeing as they don't have
config files out of the box, I would need to create config files for each one I
guess.

3 - If I am programming my own code, rather than working with the sample programs, I
could also specify my client to use just the desired protocol in a line of code like
this, per User Guide section 2.2:

Given the following App.config snippet,

<appSettings>
  <add key="my-protocol" value="AMQP_0_8"/>
</appSettings>

the following code will also bind p to the 0-8 IProtocol implementation:

ConnectionFactory factory = new ConnectionFactory();
//IProtocol protocol = Protocols.FromEnvironment();
IProtocol p = Protocols.FromConfiguration("my-protocol");
IConnection conn = factory.CreateConnection(p, hostName);

Hopefully my own code will run if I write something like the above.  And I can try
to get the sample programs working later if I have time.


I guess I would ask you to cut to the chase if that's OK.  What did you or other
people actually do specifically on your own systems to get the .NET sample programs
working?   Did you manually create the environment variable AMQP_PROTOCOL and set it
to the value "AMQP_0_8"?


> >
> > 4.  Go look again to see if Tracer saw any traffic:
> >
> > C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat  
> > com.rabbitmq.tools.Tracer
> > Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
> > Invoked as: Tracer 5673 localhost 5672
> > com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
> > com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
> > com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
> > com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false
> >
> >
> > It seems no traffic was detected during the dotnet sample program  
> > execution.
> >
> 
> Your client will need to connect to the listen port of the tracer,  
> i.e. 5673. By default AMQP clients connect to 5672.
> 
> HTH,
> 
> Ben
> 
> 


OK that makes some sense.  Tracer is a simple proxy server then.

Thank you for the insightful responses.

Geoffrey



From mrcoder at yahoo.com  Tue May 13 22:54:52 2008
From: mrcoder at yahoo.com (Geoffrey Anderson)
Date: Tue, 13 May 2008 14:54:52 -0700 (PDT)
Subject: [rabbitmq-discuss] TCP timeout is also happening for C# clients
Message-ID: <406590.35608.qm@web30006.mail.mud.yahoo.com>

FYI: I have found that a Hearbeat adjustment solves a BasicPublish() timeout problem
in dotnet clients.

OK guys thanks for guidance with diagnosing the connection problems.  It is solved
after I created an environment variable.

Now I progressed to the next problem (progress of sorts).  But I bring a solution
too.

It all started when I called this line of code in my C# application:

mqModel.BasicPublish(mqTicket, mqExchange, mqRoutingKey, null,
builder.GetContentBody());

The following exception is always thrown by it:

"AMQP close-reason, initiated by Library, code=541, text=\"Unexpected Exception\",
classId=0, methodId=0, cause=System.IO.IOException: Unable to read data from the
transport connection: A connection attempt failed because the connected party did
not properly respond after a period of time, or established connection failed
because connected host has failed to respond. --->
System.Net.Sockets.SocketException: A connection attempt failed because the
connected party did not properly respond after a period of time, or established
connection failed because connected host has failed to respond\r\n   at
System.Net.Sockets.Socket.Receive(Byte[] buffer, Int32 offset, Int32 size,
SocketFlags socketFlags)\r\n   at System.Net.Sockets.NetworkStream.Read(Byte[]
buffer, Int32 offset, Int32 size)\r\n   --- End of inner exception stack trace
---\r\n   at System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32 offset,
Int32 size)\r\n   at System.IO.Stream.ReadByte()\r\n   at
System.IO.BinaryReader.ReadByte()\r\n   at
RabbitMQ.Client.Impl.Frame.ReadFrom(NetworkBinaryReader reader)\r\n   at
RabbitMQ.Client.Impl.SocketFrameHandler_0_9.ReadFrame()\r\n   at
RabbitMQ.Client.Impl.ConnectionBase.MainLoopIteration()\r\n   at
RabbitMQ.Client.Impl.ConnectionBase.MainLoop()"


So I looked around for solutions on the web, and discovered a "Java"-related
discussion recently in the mailing list:

http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2008-May/001183.html

The topic is TCP timeouts.

One possible solution to the "java" problem was proposed by manipulating the
heartbeat value of the connection factory:

http://www.rabbitmq.com/javadoc/com/rabbitmq/client/ConnectionParameters.html#setRequestedHeartbeat(int

But now I'm using C# rather than Java but the symptoms looked similar enough.

So I added a line of C# code to manipulate the heartbeat, just before it runs the
CreateConnection():

mqFactory.Parameters.RequestedHeartbeat = 50;

50 is a totally wild first guess but it actually works.

As a result of heartbeat modification my BasicPublish() call runs OK now.  I dont
get the exception, and the code continues flowing in the preferred way.

I just want you all to know that by appearances this is not strictly a java specific
problem but the discussion seemed to assume it was limited to java clients, or
limited to the Sun company's products.

http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2008-May/001211.html

Excerpt:  "A very interesting anomaly indeed, especially considering that it only 
seems to affect 1.5, not 1.4 or 1.6. However, as far as I can tell this 
behaviour can only occur with one CPU."

http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2008-May/001207.html

Actually I do have just one CPU core, it's true, but I do not code in java, just C#.

Here is what my log shows FWIW.

=INFO REPORT==== 13-May-2008::17:22:42 ===
Rolling persister log to "c:/Documents and
Settings/ga/rabbitmq/db/rabbit-mnesia/rabbit_persister.LOG.previous"

=INFO REPORT==== 13-May-2008::17:22:43 ===
started TCP listener on 0.0.0.0:5672

=INFO REPORT==== 13-May-2008::17:23:01 ===
accepted TCP connection on 0.0.0.0:5672 from 192.168.1.100:1551

=ERROR REPORT==== 13-May-2008::17:23:03 ===
error on TCP connection from 192.168.1.100:1551
connection_closed_abruptly

=INFO REPORT==== 13-May-2008::17:23:03 ===
closing TCP connection from 192.168.1.100:1551


I now suspect there is a threading bug in the RabbitMQ stack and it is common to
both C# and java clients either by repetition of a mistaken code pattern, or by some
code layer in the RabbitMQ system which is shared in common by clients of both
languages.  Solutions applied in the application layer are probably not the best
way.


Hope this helps the knowledge base.


Geoffrey




From mrcoder at yahoo.com  Wed May 14 03:37:46 2008
From: mrcoder at yahoo.com (Geoffrey Anderson)
Date: Tue, 13 May 2008 19:37:46 -0700 (PDT)
Subject: [rabbitmq-discuss] RequestedHeartbeat
Message-ID: <86646.85986.qm@web30004.mail.mud.yahoo.com>

So I discovered more about how RabbitMQ works.  It gets interesting.

I find that if my application does this while preparing the ConnectionFactory:

mqFactory.Parameters.RequestedHeartbeat = 20;

Then I can post a new message to a queue without errors, as long as I call this line
of code, when I count out loud to myself to one or two:

mqModel.BasicPublish(mqTicket, mqExchange, mqRoutingKey, null,
builder.GetContentBody());                

But if I count to four out loud and then I call it, I get this exception:

AMQP close-reason, initiated by Library, code=541, text=\"Unexpected Exception\",
classId=0, methodId=0, cause=System.IO.IOException: Unable to read data from the
transport connection: A connection attempt failed because the connected party did
not properly respond after a period of time, or established connection failed
because connected host has failed to respond. --->
System.Net.Sockets.SocketException: A connection attempt failed because the
connected party did not properly respond after a period of time, or established
connection failed because connected host has failed to respond\r\n   at
System.Net.Sockets.Socket.Receive(Byte[] buffer, Int32 offset, Int32 size,
SocketFlags socketFlags)\r\n   at System.Net.Sockets.NetworkStream.Read(Byte[]
buffer, Int32 offset, Int32 size)\r\n   --- End of inner exception stack trace
---\r\n   at System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32 offset,
Int32 size)\r\n   at System.IO.Stream.ReadByte()\r\n   at
System.IO.BinaryReader.ReadByte()\r\n   at
RabbitMQ.Client.Impl.Frame.ReadFrom(NetworkBinaryReader reader)\r\n   at
RabbitMQ.Client.Impl.SocketFrameHandler_0_9.ReadFrame()\r\n   at
RabbitMQ.Client.Impl.ConnectionBase.MainLoopIteration()\r\n   at
RabbitMQ.Client.Impl.ConnectionBase.MainLoop()



Furthermore, I find that if my application does this while preparing the
ConnectionFactory:

mqFactory.Parameters.RequestedHeartbeat = 50;  //Notice it's five-zero now...

Then I can post a new message to a queue without errors, as long as I call this line
of code, when I count out loud to myself to one or two or three or four:

mqModel.BasicPublish(mqTicket, mqExchange, mqRoutingKey, null,
builder.GetContentBody());                

But if I count to six out loud and then I call it, I get this exception:

AMQP close-reason, initiated by Library, code=541, text=\"Unexpected Exception\",
classId=0, methodId=0, cause=System.IO.IOException: Unable to read data from the
transport connection: A connection attempt failed because the connected party did
not properly respond after a period of time, or established connection failed
because connected host has failed to respond. --->
System.Net.Sockets.SocketException: A connection attempt failed because the
connected party did not properly respond after a period of time, or established
connection failed because connected host has failed to respond\r\n   at
System.Net.Sockets.Socket.Receive(Byte[] buffer, Int32 offset, Int32 size,
SocketFlags socketFlags)\r\n   at System.Net.Sockets.NetworkStream.Read(Byte[]
buffer, Int32 offset, Int32 size)\r\n   --- End of inner exception stack trace
---\r\n   at System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32 offset,
Int32 size)\r\n   at System.IO.Stream.ReadByte()\r\n   at
System.IO.BinaryReader.ReadByte()\r\n   at
RabbitMQ.Client.Impl.Frame.ReadFrom(NetworkBinaryReader reader)\r\n   at
RabbitMQ.Client.Impl.SocketFrameHandler_0_9.ReadFrame()\r\n   at
RabbitMQ.Client.Impl.ConnectionBase.MainLoopIteration()\r\n   at
RabbitMQ.Client.Impl.ConnectionBase.MainLoop()


Isn't that an interesting coincidence?

Now I thought I would do a thought experiment.

Let's say I have an application in which I don't have the luxury to know in advance
exactly when the next queue message is going to arrive to be inserted to my queue. 
For example it might be on each new visitor to a web site.  Who knows when the next
visitor is going to visit my web site.  Let's assume its a pretty obscure web site,
and I'm not a very good marketer, which is not far from the truth.  (My
queue-insertion program is running in a specially prepared Windows service, and not
within the HTTP request context, so don't worry about HTTP being "sessionless" -- it
has nothing to do with my queue-insertion program.)

If I follow along the apparent trend, the way to prevent the exception in this
application is this line of code:

mqFactory.Parameters.RequestedHeartbeat = 5000000000000;


Is it going to work?  Just some food for thought. ;)

I looked at my connection's AutoClose property: It is false.

One conceivable solution would be to change the application design to use a
short-duration connection model, like the old days uwing Microsoft Transaction
Server's recommended practices.

Why did I write my app using a long-duration AMQP model in the first place?

2.2.4 The Connection Class
AMQP is a connected protocol. The connection is designed to be longlasting.

https://jira.amqp.org/confluence/download/attachments/720900/amqp0-8.pdf?version=1


Now what should I do with my application?

(Be nice.)

I guess the pragmatic answer must be, never mind the design of AMQP for now:  If
short lived connections reliably don't throw exceptions, then I'm going to use short
lived connections in my long running Windows service (server) program.

It would be great to hear some hard won advice if possible from others to save time
from those who have maybe been down this road.  

I don't know which of these objects *in practice* are better long-lived, or better
short-lived:  Factory, Connection, Model, Ticket.

And what are the constraints:  Is a ticket supposed to span connections?  Is a
ticket supposed to span models (ie., mqConnection.CreateModel())?  etc, etc.  

Or is it best in practice to construct all of these objects every time I insert
another queue item?

I can of course study the authoritative document for design advice:

https://jira.amqp.org/confluence/download/attachments/720900/amqp0-8.pdf?version=1

But if this beginning part is already not so accurate: "AMQP is a connected
protocol. The connection is designed to be longlasting"  then the rest of the advice
is likewise only half-accurate as well.  Time for lotta experimentation.  If I have
the time.  Some hard choices ahead, again.  I've been making hard choices every 3
days for like 2 weeks.  Grr.... I've never used IBM MQ Series.  But I'm beginning to
understand.


Thanks for reading.

Geoffrey



From chime at mu.dk  Wed May 14 07:41:57 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Wed, 14 May 2008 08:41:57 +0200
Subject: [rabbitmq-discuss] Some error messages
In-Reply-To: <4829E07D.1070602@lshift.net>
References: <42309DCB-0F58-46DA-820C-6C83C84CEBD3@mu.dk>
	<4829E07D.1070602@lshift.net>
Message-ID: <2FA5ACFF-1259-44B7-90BB-61309B6A898A@mu.dk>

Matthias,

On May 13, 2008, at 20:39 , Matthias Radestock wrote:

> Michael,
>
> Michael Arnoldus wrote:
>> =INFO REPORT==== 12-May-2008::18:21:54 ===
>> Exception: Channel 3, Reason {amqp,command_invalid,none}
>
> That could be caused by any number of things. Is there nothing else  
> of interest in the log?

No nothing. :-(

>
>
> I should note that error reporting will be improved in the next  
> release, with better reports in both the server logs and responses  
> to the client.

Sounds good :-)

>
>
>> =ERROR REPORT==== 12-May-2008::18:22:05 ===
>> Error in process <0.388.15> on node 'rabbit at staging' with exit  
>> value: {{badmatch
>> ,{error,[{exit,{normal,{gen_server,call,[<0.389.15>, 
>> {notify_down,<0.387.15>}]}}} ]}},[{rabbit_channel,terminate,2}, 
>> {buffering_proxy,mainloop,4}]}
>
> You reported this one before, remember? See http://www.nabble.com/Possible-bug--td16805989.html
>
> My answer there is still valid ;)

Sorry!

I thought (should be read as hoped) that it would provide further info  
to the above mentioned error.


Michael

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080514/8c8d37d6/attachment.bin 

From lars.bachmann at s2002.tu-chemnitz.de  Wed May 14 09:41:49 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Wed, 14 May 2008 10:41:49 +0200
Subject: [rabbitmq-discuss] persistence
Message-ID: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>

hello,

since some days Im trying to learn and understand rabbitmq. I think  
the decoupling between routing information and stored data very nice  
and flexible. I was able to configure the typical pub/sub scenario  
with one publisher and many subsriber. The publisher sends the  
messages to the exchange and the exchanges routes the messages to  
several queues. On each queue one subscriber is listening. If i send  
the messages transient without storing them to memory or harddisk  
everything works how it supposed to be. (each subsriber receives all  
messages). If i switch to persistent messages some problems occur and  
i dont know why.

1. if my producer sends only a small amount of messages (lets say  
5000), then all queues receive all messages persistent and everything  
is ok
2. if my producer sends a larger amount of messages (lets say 100000),  
then some strange behaviour appears. All queues receive only some of  
this messages. Sometimes 80% sometimes 50% sometimes even only 10% =>  
i couldnt discover any pattern, it seemed to be just random

So Im wondering why this happens. Could it be that there are too many  
messages to persist and the broker cant handle it because of i dont  
know too less memory or some like this ?

Another question: Lets say we have 5 subscriber (each listen to his  
"own" queue) in the pub / sub scenario and we want persistent message  
storing. Does this mean that each messages is stored 5 times ? (and  
for n subscribers n times which would cause a big overhead)

Or maybe Im doing something completly wrong in realising a durable  
pub/sub scenario where every subsriber must receive all messages.

Thank you

best regards

Lars






From tonyg at lshift.net  Wed May 14 11:58:20 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Wed, 14 May 2008 11:58:20 +0100
Subject: [rabbitmq-discuss] TCP timeout is also happening for C# clients
In-Reply-To: <406590.35608.qm@web30006.mail.mud.yahoo.com>
References: <406590.35608.qm@web30006.mail.mud.yahoo.com>
Message-ID: <482AC5CC.6070503@lshift.net>

Hi Geoffrey,

Geoffrey Anderson wrote:
> FYI: I have found that a Hearbeat adjustment solves a BasicPublish() timeout problem
> in dotnet clients.

I think you may have happened across a bug others have seen before; are
you running .NET on a Microsoft operating system? If so, it is likely
that the Heartbeat feature will not work well for you, and you should
disable heartbeats by setting the heartbeat interval to zero.

See
http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2008-April/001043.html
http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=94149

A future release of the RabbitMQ .NET client will employ an alternative
strategy for detecting idle sockets that does not fall foul of
Microsoft's broken read-timeout behaviour.

> OK guys thanks for guidance with diagnosing the connection problems.  It is solved
> after I created an environment variable.

Great! Pleased to hear it.

> I now suspect there is a threading bug in the RabbitMQ stack and it is common to
> both C# and java clients either by repetition of a mistaken code pattern, or by some
> code layer in the RabbitMQ system which is shared in common by clients of both
> languages.  Solutions applied in the application layer are probably not the best
> way.

I'd be surprised if you were seeing anything other than the
heartbeat-timeout problem.

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From tonyg at lshift.net  Wed May 14 12:01:34 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Wed, 14 May 2008 12:01:34 +0100
Subject: [rabbitmq-discuss] RequestedHeartbeat
In-Reply-To: <86646.85986.qm@web30004.mail.mud.yahoo.com>
References: <86646.85986.qm@web30004.mail.mud.yahoo.com>
Message-ID: <482AC68E.40400@lshift.net>


Hi Geoffrey,

Geoffrey Anderson wrote:
> If I follow along the apparent trend, the way to prevent the exception in this
> application is this line of code:
> mqFactory.Parameters.RequestedHeartbeat = 5000000000000;

Try zero :-)  (which means "heartbeating switched off" - see my previous
message.)

> And what are the constraints:  Is a ticket supposed to span connections?  Is a
> ticket supposed to span models (ie., mqConnection.CreateModel())?  etc, etc.  

A ticket is scoped to a model. As soon as the model (or of course its
underlying connection) disappears, the ticket is no longer valid.

Tickets will be phased out of AMQP in future releases of the specification.

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From matthias at lshift.net  Wed May 14 20:46:08 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 14 May 2008 20:46:08 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
Message-ID: <482B4180.5080306@lshift.net>

Lars,

Lars Bachmann wrote:
> 1. if my producer sends only a small amount of messages (lets say  
> 5000), then all queues receive all messages persistent and everything  
> is ok
> 2. if my producer sends a larger amount of messages (lets say 100000),  
> then some strange behaviour appears. All queues receive only some of  
> this messages. Sometimes 80% sometimes 50% sometimes even only 10% =>  
> i couldnt discover any pattern, it seemed to be just random

Could you send us the client code, please? I'd like to try reproducing this.

> So Im wondering why this happens. Could it be that there are too many  
> messages to persist and the broker cant handle it because of i dont  
> know too less memory or some like this ?

The way you described it above, the messages should certainly get routed 
to (and persisted by) all the queues.

Are there any errors in the server logs?

> Another question: Lets say we have 5 subscriber (each listen to his  
> "own" queue) in the pub / sub scenario and we want persistent message  
> storing. Does this mean that each messages is stored 5 times ? (and  
> for n subscribers n times which would cause a big overhead)

In a non-clustered setup only one copy of the message is stored. In a 
cluster we store one copy of the message *per node* that has queues to 
which the message was routed.


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Thu May 15 11:49:55 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Thu, 15 May 2008 12:49:55 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <482B4180.5080306@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
Message-ID: <20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>

hello,

> Lars,
>
> Lars Bachmann wrote:
>> 1. if my producer sends only a small amount of messages (lets say    
>> 5000), then all queues receive all messages persistent and   
>> everything  is ok
>> 2. if my producer sends a larger amount of messages (lets say   
>> 100000), then some strange behaviour appears. All queues receive   
>> only some of  this messages. Sometimes 80% sometimes 50% sometimes   
>> even only 10% =>  i couldnt discover any pattern, it seemed to be   
>> just random
>
> Could you send us the client code, please? I'd like to try reproducing this.

i attached the sources of the producer

>> So Im wondering why this happens. Could it be that there are too   
>> many  messages to persist and the broker cant handle it because of   
>> i dont  know too less memory or some like this ?
>
> The way you described it above, the messages should certainly get
> routed to (and persisted by) all the queues.
>
> Are there any errors in the server logs?

there are no errors in the logs

>> Another question: Lets say we have 5 subscriber (each listen to his  
>>   "own" queue) in the pub / sub scenario and we want persistent   
>> message  storing. Does this mean that each messages is stored 5   
>> times ? (and  for n subscribers n times which would cause a big   
>> overhead)
>
> In a non-clustered setup only one copy of the message is stored. In a
> cluster we store one copy of the message *per node* that has queues to
> which the message was routed.

thank you for information

>
> Matthias.

Lars



-------------- next part --------------
A non-text attachment was scrubbed...
Name: ConcurrentRabbitMQProducerTest.java
Type: text/x-java
Size: 3349 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080515/252ab263/attachment.java 

From 0x6e6562 at gmail.com  Thu May 15 12:36:43 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 15 May 2008 12:36:43 +0100
Subject: [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
In-Reply-To: <6c2563b20805091702w604c5972x9a563f00d3c8f400@mail.gmail.com>
References: <EEAD8AA0-04A1-49B5-813E-6685B2A6BD2A@gmail.com>
	<8407E0BF-8483-412E-88B4-0042EBD77296@gmail.com>
	<6c2563b20805080704i3850a81r545155f42fa16188@mail.gmail.com>
	<CAC65027-3BB9-4A14-8EE4-2558D51101E7@gmail.com>
	<289AC975-A747-49BF-9C83-738A379DE287@gmail.com>
	<6c2563b20805091702w604c5972x9a563f00d3c8f400@mail.gmail.com>
Message-ID: <DF3E8B9E-61BF-478D-BE8C-4FCD1D505D61@gmail.com>

Ed,

On 10 May 2008, at 01:02, Edwin Fine wrote:

> Thanks, Ben, I will take a look and give you some feedback.
>
> In the meantime, I have done the following:
> Changed my consumer code (I use the term "consumer" loosely as  
> "anything that eats the output of a producer") to use basic.get  
> instead of basic.consume. Actually, it's set up so that I can select  
> basic.get or basic.consume behavior at run-time. I didn't want to  
> throw away working basic.consume code :)
> Changed the process that creates consumers so that it now creates  
> one channel per consumer. Previously, there was one channel only for  
> all consumers. One-channel-per-consumer was the only way I could get  
> the code to work with the network client; in the one-channel  
> scenario I was getting back responses to messages destined for  
> different consumers. I assume that with your changes I will be able  
> to again use one channel for all consumers.
> I tested with 50 queues (each with its own consumer and channel) and  
> it seemed reasonably performant, even with the get. I need to try a  
> full-blast test soon.
> Again, thanks for your help and patience, and do let me know if you  
> see any merit in the rbmq_admin module I wrote, or if maybe you guys  
> are releasing an official one.

Sorry for not responding to this sooner, the offer is appreciated.  
Having said that, part of the functionality you have written is a  
wrapper around the rabbit_access_control module, which is pretty much  
what the rabbit_control module is (see the rabbitmqctl script). That's  
not to say there is no merit in improving the whole management aspect  
of RabbitMQ, which I think is the important point you making with the  
rbmq_admin module you have written. I know there have been a few posts  
about the reshaping the current management facilities, but (although I  
may stand corrected) these discussions have been more along the lines  
of requirements gathering and getting users to say what types of  
management functionality they'd like to see in the product. Hence your  
module can definitely serve as a description of what you'd like to  
see. In the past I have expressed some views about the remoting aspect  
of rabbit management, but what you are touching on is the core  
services that are offered. Obviously these will need to discussed in  
order to come up with a stable API that isn't so tightly coupled to  
the implementation aspects of the server, which *will* change over  
time. To generate interest in this, I suggest you start a new  
discussion topic on this.

On the other side of things, I have done some further refactoring to  
the writer cleanup and concurrency of RPC requests, so if you did get  
an opportunity to give your code a go using the single channel variant  
with basic consume, that would be greatly appreciated.

HTH,

Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080515/187f0ab5/attachment.htm 

From alexis.richardson at cohesiveft.com  Thu May 15 15:02:21 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Thu, 15 May 2008 15:02:21 +0100
Subject: [rabbitmq-discuss] no connection established
In-Reply-To: <660757.12172.qm@web30006.mail.mud.yahoo.com>
References: <3345C962-0443-4B37-A897-A79E1C5871F0@gmail.com>
	<660757.12172.qm@web30006.mail.mud.yahoo.com>
Message-ID: <167204d20805150702k6292eb65m7845bd135ef2dac1@mail.gmail.com>

Geoffrey

How are you getting on?  Have all your questions been answered
satisfactorily?  Let people know :-)

One thing - you asked about how we tested against different AMQP spec
versions.   To quote from http://www.rabbitmq.com/dotnet.html -

"The client library implements AMQP specifications version 0-8, 0-8bis
(0-8 as modified by QPid for their M2 release) and 0-9 (omitting
sections of the specification marked "work in progress", i.e. the
Message content-class). A single binary copy of the library contains
support for all three protocol variants, and code can select a variant
to use at runtime. The library has been tested against

    * RabbitMQ 1.2.x (AMQP 0-8)
    * QPid M2 (AMQP 0-8bis, 0-9 (in the M2.1 branch))
    * OpenAMQ 1.2c4 (AMQP 0-9)"

alexis





On Tue, May 13, 2008 at 8:16 PM, Geoffrey Anderson <mrcoder at yahoo.com> wrote:
>
> --- Ben Hood <0x6e6562 at gmail.com> wrote:
>
>> Hi Geoffrey,
>>
>> Sorry to hear that you have run into difficulties.
>>
>> On 13 May 2008, at 17:53, Geoffrey Anderson wrote:
>>
>> > The rabbitmq server runs, it seems, but no connections are being
>> > accepted by it,
>> > from the java samples or dotnet sample programs or my own programs.
>>
>> Can you try with a simple TCP client, e.g.
>>
>> nc 0.0.0.0 5672
>>
>> ?
>>
>> What shows up in the server log when you do this?
>
>
> C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-net-2.0\bin>nc
> 'nc' is not recognized as an internal or external command,
> operable program or batch file.
>
>
> C:\Documents and Settings\ga>telnet 0.0.0.0 5672
> Connecting To 0.0.0.0...Could not open connection to the host, on port 5672: Connect
> failed
>
> Thank you for the interesting suggestion.  I imagine telnet is just as good as 'nc'
> for this purpose although I don't know what 'nc' is.
>
> Seems like no process is listening on port 5672 doesn't it?
>
> OTOH netstat suggests there really IS a process listening there, if I am reading it
> correctly:
>
> C:\Documents and Settings\ga>netstat -a
>
> Active Connections
>
>  Proto  Local Address          Foreign Address        State
>  TCP    alpeduez:epmap         alpeduez:0             LISTENING
>  TCP    alpeduez:microsoft-ds  alpeduez:0             LISTENING
>  TCP    alpeduez:1227          alpeduez:0             LISTENING
>  TCP    alpeduez:4369          alpeduez:0             LISTENING
>  TCP    alpeduez:5672          alpeduez:0             LISTENING
>  TCP    alpeduez:1229          localhost:4369         ESTABLISHED
>  TCP    alpeduez:4369          localhost:1229         ESTABLISHED
>
>
>>
>> > For three days I have been trying everything imaginable to me to get
>> > any client
>> > program to connect to the rabbitmq server.  For example I disabled
>> > tcpv6 on my
>> > system and tried all manner of user permissions in the rabbitmq
>> > server for 'guest'
>> > and my custom account 'ga' which I gave all same permissions as
>> > 'guest'.
>> >
>>
>>
>> By default Rabbit ships with the user/pass combination guest/guest, so
>> without further ado that should work.
>>
>
> I agree.  Unfortunately guest/guest really does not work at the moment if the sample
> programs are an indication.  I shall remove the guest account's permissions for host
> security purposes later after this problem is resoloved.  Default accounts that ship
> with server programs are typical attack targets for malware and script kiddies.
>
>> > The web site asks users to send a note to legitimateconcern at rabbitmq.com
>> >  if it takes
>> > more than 2 minutes to connect.  Si I have sent a detailed note.
>> > There has been no
>> > response to it.
>>
>> Don't want to split hairs but the address is legitimategrievance at rabbitmq.com
>> , so you probably sent a message to a non-existent mailbox.
>>
>
> What I didn't tell you until now -- your answer is actually reasonable given what
> you knew -- was that I pulled that email address from (human) memory as I was
> writing, really only meant as an approximation to get the idea across of what I had
> done.  It's not the email address I really used, which was copied from the web page
> at rabbitmq.com into the clipboard memory and then pasted into the mail program
> verbatim.  And lo, just a few minutes ago, another person has confirmed receipt of
> the original email message, so it's known to be the correct address which I had used
> the other day.
>
>> >
>> >
>> > The web site says  Please join our mailing list or send questions to
>> > info at rabbitmq.com. We'd love to hear from you.   I've subscribed and
>> > sent a detailed
>> > message to the mailing list.  My email did not appear in the mailing
>> > list, and no
>> > responses came back.
>>
>> Here's one :-)
>
>
> Very much appreciated.
>
>
>> > C:\rabbitmq\rabbitmq-dotnet-1.2.8025.1832-
>> > net-2.0\bin>DeclareQueue.exe alpeduez
>> > testqueue
>> > None of the specified endpoints were reachable
>> > Endpoints attempted:
>> >  endpoint=amqp-0-9://alpeduez:5672, attempts=1, outcome=AMQP server
>> > protocol
>> > negotiation failure: server version 0-8, t
>> > ransport parameters -1:-1
>> > Stack trace:
>> >   at RabbitMQ.Client.ConnectionFactory.CreateConnection(Int32
>> > maxRedirects,
>> > AmqpTcpEndpoint[] endpoints)
>> >   at
>> > RabbitMQ.Client.ConnectionFactory.CreateConnection(AmqpTcpEndpoint[]
>> > endpoints)
>> >   at RabbitMQ.Client.ConnectionFactory.CreateConnection(String
>> > address)
>> >   at RabbitMQ.Client.Examples.DeclareQueue.Main(String[] args)
>> >
>>
>> You need to specify the protocol version in your config file (refer to
>> the .NET client manual).
>> This client is defaulting to AMQP 0-9 whereas Rabbit currently speaks
>> 0-8.
>>
>
>
> Your idea is intriguing... I have a good expectation about it.
>
> You may well be correct.  It's interesting though, that the .Net client would be
> defaulting to a version of the protocol which is more advanced than the RabbitMQ
> server.  I wonder how the author developed the .Net client libs in advance of the
> server.  He's a pretty advanced developer. ;)
>
> More specifically, in my own programs, I had been trying to use a construct like
> this:
>
> IProtocol protocol = Protocols.FromEnvironment();
> IConnection conn = factory.CreateConnection(protocol, hostName);
>
> To my surprise it didn't work.  Now, I am looking at the .NET client user guide
> sections 2.2 and 2.3.
>
> It says there is (or expected to be) an environment variable where it gets its
> information:
>
> "If no argument is passed to FromEnvironment() or FromConfiguration(), the value of
> Protocols.DefaultAppSettingsKey is used. (At the time of writing, the default
> appSettings key is
> AMQP_PROTOCOL, the same as the name of the shell environment variable scanned.)"
>
>
> Well the reality is that my system is telling me there really isn't any such shell
> environment variable defined:
>
> C:\rabbitmq\librabbitmq-java-1.3.0>echo %AMQP_PROTOCOL%
> %AMQP_PROTOCOL%
>
> Maybe this missing envoronment variable is why Protocols.FromEnvironment() is not
> useful on my system.
>
> Tyring to follow along with your suggestion, I guess there are two ways to get the
> sample .NET programs working with the 0.8 protocol rather than 0.9 protocol.
>
> 1 - Change the environment variable AMQP_PROTOCOL.  However, my system is reporting
> that I don't have this environment variable defined anywhere, so I don't know for
> sure what to do.  Should I define one now?  I guess I could try to create one and
> see what happens.  I guess I will set AMQP_PROTOCOL to the value "AMQP_0_8".
>
> 2 - Change the .config file for every client application. Seeing as they don't have
> config files out of the box, I would need to create config files for each one I
> guess.
>
> 3 - If I am programming my own code, rather than working with the sample programs, I
> could also specify my client to use just the desired protocol in a line of code like
> this, per User Guide section 2.2:
>
> Given the following App.config snippet,
>
> <appSettings>
>  <add key="my-protocol" value="AMQP_0_8"/>
> </appSettings>
>
> the following code will also bind p to the 0-8 IProtocol implementation:
>
> ConnectionFactory factory = new ConnectionFactory();
> //IProtocol protocol = Protocols.FromEnvironment();
> IProtocol p = Protocols.FromConfiguration("my-protocol");
> IConnection conn = factory.CreateConnection(p, hostName);
>
> Hopefully my own code will run if I write something like the above.  And I can try
> to get the sample programs working later if I have time.
>
>
> I guess I would ask you to cut to the chase if that's OK.  What did you or other
> people actually do specifically on your own systems to get the .NET sample programs
> working?   Did you manually create the environment variable AMQP_PROTOCOL and set it
> to the value "AMQP_0_8"?
>
>
>> >
>> > 4.  Go look again to see if Tracer saw any traffic:
>> >
>> > C:\rabbitmq\librabbitmq-java-1.3.0>runjava.bat
>> > com.rabbitmq.tools.Tracer
>> > Usage: Tracer [<listenport> [<connecthost> [<connectport>]]]
>> > Invoked as: Tracer 5673 localhost 5672
>> > com.rabbitmq.tools.Tracer.WITHHOLD_INBOUND_HEARTBEATS = false
>> > com.rabbitmq.tools.Tracer.WITHHOLD_OUTBOUND_HEARTBEATS = false
>> > com.rabbitmq.tools.Tracer.NO_ASSEMBLE_FRAMES = false
>> > com.rabbitmq.tools.Tracer.NO_DECODE_FRAMES = false
>> >
>> >
>> > It seems no traffic was detected during the dotnet sample program
>> > execution.
>> >
>>
>> Your client will need to connect to the listen port of the tracer,
>> i.e. 5673. By default AMQP clients connect to 5672.
>>
>> HTH,
>>
>> Ben
>>
>>
>
>
> OK that makes some sense.  Tracer is a simple proxy server then.
>
> Thank you for the insightful responses.
>
> Geoffrey
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From dmitriy.samovskiy at cohesiveft.com  Thu May 15 17:41:56 2008
From: dmitriy.samovskiy at cohesiveft.com (Dmitriy Samovskiy)
Date: Thu, 15 May 2008 11:41:56 -0500
Subject: [rabbitmq-discuss] possible bug starting rabbit with NODENAME set?
Message-ID: <482C67D4.1030105@cohesiveft.com>



rabbitmq-server 1.3.0, Debian Etch, erlang version doesn't seem to matter (R12B-2 and R11B-5)

When NODENAME is set to something other than "rabbit" in /etc/default/rabbitmq, 
`/etc/init.d/rabbitmq start` always fails (while broker is actually started)




My temporary fix is this (startup will take some time to allow the original start to time 
out):

# diff -uN rabbitmq-server-orig rabbitmq-server
--- rabbitmq-server-orig	2008-05-15 11:11:22.000000000 -0500
+++ rabbitmq-server	2008-05-15 11:16:25.000000000 -0500
@@ -28,6 +28,7 @@
  start_rabbitmq () {
        set +e
        su rabbitmq -s /bin/sh -c "$DAEMON start_all ${NODE_COUNT}" > 
/var/log/rabbitmq/startup.log 2> /var/log/rabbitmq/startup.err
+      /usr/sbin/rabbitmqctl -n $NODENAME status >/dev/null 2>&1
        case "$?" in
          0)
            echo SUCCESS;;
@@ -42,7 +43,8 @@

  stop_rabbitmq () {
      set +e
-    su rabbitmq -s /bin/sh -c "$DAEMON stop_all" > /var/log/rabbitmq/shutdown.log 2> 
/var/log/rabbitmq/shutdown.err
+    #su rabbitmq -s /bin/sh -c "$DAEMON stop_all" > /var/log/rabbitmq/shutdown.log 2> 
/var/log/rabbitmq/shutdown.err
+    /usr/sbin/rabbitmqctl -n $NODENAME stop
      if [ $? != 0 ] ; then
          echo FAILED - check /var/log/rabbitmq/shutdown.log, .err
          exit 0








Here are the screen shots:

# cat /etc/default/rabbitmq
NODENAME=wabbit

# /etc/init.d/rabbitmq-server start
Starting rabbitmq-server: FAILED - check /var/log/rabbitmq/startup.log, .err

# cat /var/log/rabbitmq/startup.*
Starting all nodes...
Starting node 0....
RabbitMQ 1.3.0 (AMQP 8-0)
Copyright (C) 2007-2008 LShift Ltd., Cohesive Financial Technologies LLC., and Rabbit 
Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

Logging to "/var/log/rabbitmq/wabbit.log"
SASL logging to "/var/log/rabbitmq/wabbit-sasl.log"

starting database             ...done
starting core processes       ...done
starting recovery             ...done
starting persister            ...done
starting builtin applications ...done
starting TCP listeners        ...done

broker running

rabbit_multi action start_all failed:
cannot_get_pid



rabbitmq 14717  0.6  0.7  14056  7768 ?        Sl   15:55   0:00 
//usr/lib/erlang/erts-5.5.5/bin/beam -W w -K true -A30 -- -root //usr/lib/erlang -progname 
erl -- -home /var/lib/rabbitmq -pa /usr/sbin/../ebin -noshell -noinput -s rabbit -sname 
wabbit -boot start_sasl -kernel inet_default_listen_options [{sndbuf,16384},{recbuf,4096}] 
-rabbit tcp_listeners [{"0.0.0.0", 5672}] -sasl errlog_type error -kernel error_logger 
{file,"/var/log/rabbitmq/wabbit.log"} -sasl sasl_error_logger 
{file,"/var/log/rabbitmq/wabbit-sasl.log"} -os_mon start_cpu_sup true -os_mon 
start_disksup false -os_mon start_memsup false -os_mon start_os_sup false -mnesia dir 
"/var/lib/rabbitmq/mnesia/wabbit" -noshell -noinput


Also, note rabbitmqctl behavior looked erroneous to me (but my expectation might be wrong 
here - I thought when NODENAME was set in /etc/default/rabbitmq, I didn't need to 
explicitly set -n):

# rabbitmqctl status
Status of node rabbit at host1 ...
{badrpc,nodedown}
done.

# rabbitmqctl -n wabbit status
Status of node wabbit at host1 ...
[{running_applications,[{rabbit,"RabbitMQ","1.3.0"},
                         {mnesia,"MNESIA  CXC 138 12","4.3.5"},
                         {os_mon,"CPO  CXC 138 46","2.1.2.1"},
                         {sasl,"SASL  CXC 138 11","2.1.5.1"},
                         {stdlib,"ERTS  CXC 138 10","1.14.5"},
                         {kernel,"ERTS  CXC 138 10","2.11.5"}]},
  {nodes,[wabbit at host1]},
  {running_nodes,[wabbit at host1]}]
done.






From matthias at lshift.net  Thu May 15 21:13:25 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 15 May 2008 21:13:25 +0100
Subject: [rabbitmq-discuss] possible bug starting rabbit with NODENAME
 set?
In-Reply-To: <482C67D4.1030105@cohesiveft.com>
References: <482C67D4.1030105@cohesiveft.com>
Message-ID: <482C9965.1060000@lshift.net>

Dmitriy,

Dmitriy Samovskiy wrote:
> 
> rabbitmq-server 1.3.0, Debian Etch, erlang version doesn't seem to matter (R12B-2 and R11B-5)
> 
> When NODENAME is set to something other than "rabbit" in /etc/default/rabbitmq, 
> `/etc/init.d/rabbitmq start` always fails (while broker is actually started)

Well spotted. The problem is two-fold. Firstly, rabbitmq-multi does not 
pay any attention to the settings of NODENAME, NODE_IP_ADDRESS and 
NODE_PORT. Secondly - and that's what is actually causing the error you 
reported - setting any of these vars in /etc/default/rabbitmq will 
override any settings provided by rabbitmq-multi.

I have filed bugs to get these fixed.


Matthias.



From alexis.richardson at cohesiveft.com  Thu May 15 23:11:36 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Thu, 15 May 2008 23:11:36 +0100
Subject: [rabbitmq-discuss] facebook using erlang
Message-ID: <167204d20805151511k26f45687s521822779d9e807d@mail.gmail.com>

Thanks to Ross Mason for this spot:

http://rossmason.blogspot.com/2008/05/facebook-chat-uses-erlang.html

If you click through from his blog, there is a pretty interesting
summary of how FB do chat.

alexis



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From matthias at lshift.net  Fri May 16 08:06:16 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 16 May 2008 08:06:16 +0100
Subject: [rabbitmq-discuss] possible bug starting rabbit with NODENAME
 set?
In-Reply-To: <6c2563b20805151422ye74396dr15de4d5ff825a7e8@mail.gmail.com>
References: <482C67D4.1030105@cohesiveft.com> <482C9965.1060000@lshift.net>
	<6c2563b20805151422ye74396dr15de4d5ff825a7e8@mail.gmail.com>
Message-ID: <482D3268.6070000@lshift.net>

Edwin,

Edwin Fine wrote:
> On this topic, does RabbitMQ have to use a short name (-sname) for its 
> node name? I had issues trying to use -name instead of -sname.

changing rabbitmq-server to use -name instead of -sname works fine for 
me, though rabbitmq-multi would need some tweaking to get working again 
after such a change.

What problems did you encounter?


Matthias.



From tonyg at lshift.net  Fri May 16 12:25:27 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Fri, 16 May 2008 12:25:27 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
Message-ID: <482D6F27.4020907@lshift.net>

Hi Lars,

Lars Bachmann wrote:
> i attached the sources of the producer

Could you also please send us code for the consumer?

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From lars.bachmann at s2002.tu-chemnitz.de  Fri May 16 12:58:33 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Fri, 16 May 2008 13:58:33 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <482D6F27.4020907@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
Message-ID: <20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>

hi,

now the sources are attached :-)

lars

> Hi Lars,
>
> Lars Bachmann wrote:
>> i attached the sources of the producer
>
> Could you also please send us code for the consumer?
>
> Regards,
>   Tony
> --
>  [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
>    [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
>  []  [] http://www.lshift.net/ | Email: tonyg at lshift.net
>
>



-------------- next part --------------
A non-text attachment was scrubbed...
Name: ConcurrentRabbitMQProducerTest.java
Type: text/x-java
Size: 3385 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080516/e0fc823f/attachment.java 

From matthias at lshift.net  Fri May 16 13:13:02 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 16 May 2008 13:13:02 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
Message-ID: <482D7A4E.7020307@lshift.net>

Lars,

Lars Bachmann wrote:
> now the sources are attached :-)

They were attached before.

However, these are still only the sources for the message *producer*. 
Where is the code for the *consumer*?


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Fri May 16 13:36:30 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Fri, 16 May 2008 14:36:30 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <482D7A4E.7020307@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
Message-ID: <20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>

Zitat von Matthias Radestock <matthias at lshift.net>:

> Lars,
>
> Lars Bachmann wrote:
>> now the sources are attached :-)
>
> They were attached before.
>
> However, these are still only the sources for the message *producer*.
> Where is the code for the *consumer*?
>
>
> Matthias.

well the consumer is not important in this case, because the error is  
that not all messages which the producer sends are received in each  
queue (persistent). The consumer just reads the messages from one  
queue. The error supposed to be within the producer because the  
messages are not stored correctly. When Im sending 60000 messages to  
one exchange which routes them to 2 queues but the 2 queues dont  
receive this 60000 messages, the consumer has nothing to do with it.

Lars





From matthias at lshift.net  Fri May 16 13:49:34 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 16 May 2008 13:49:34 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
Message-ID: <482D82DE.1020205@lshift.net>

Lars,

Lars Bachmann wrote:
> well the consumer is not important in this case, because the error is 
> that not all messages which the producer sends are received in each 
> queue (persistent). The consumer just reads the messages from one queue. 
> The error supposed to be within the producer because the messages are 
> not stored correctly. When Im sending 60000 messages to one exchange 
> which routes them to 2 queues but the 2 queues dont receive this 60000 
> messages, the consumer has nothing to do with it.

How did you find out all the above when you haven't got a consumer? I.e. 
how did you determine that "not all messages which the producer sends 
are received in each queue"?

In order to reproduce your problem I need to know what you measured / 
looked at.


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Fri May 16 14:13:55 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Fri, 16 May 2008 15:13:55 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <482D82DE.1020205@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
Message-ID: <20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>

Mathias,

Im using the erlang shell to connect to the broker. With  
"rabbit_amqqueue:stat_all()." i get a list of all queues with the  
messages of the broker. And the message count for the listed queues is  
not correct. but always when i sent a small amount of messages  
everything is ok, only with big amounts something goes wrong. Are  
there some parameters for limitation ? hm im running the broker on a  
virtual machine (openvz), maybe there are limitations, maybe i should  
set up the broker on another computer ... i dont know

Lars


> Lars,
>
> Lars Bachmann wrote:
>> well the consumer is not important in this case, because the error   
>> is that not all messages which the producer sends are received in   
>> each queue (persistent). The consumer just reads the messages from   
>> one queue. The error supposed to be within the producer because the  
>>  messages are not stored correctly. When Im sending 60000 messages   
>> to one exchange which routes them to 2 queues but the 2 queues dont  
>>  receive this 60000 messages, the consumer has nothing to do with it.
>
> How did you find out all the above when you haven't got a consumer?
> I.e. how did you determine that "not all messages which the producer
> sends are received in each queue"?
>
> In order to reproduce your problem I need to know what you measured /
> looked at.
>
>
> Matthias.







From matthias at lshift.net  Fri May 16 15:18:00 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 16 May 2008 15:18:00 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
Message-ID: <482D9798.60809@lshift.net>

Lars,

Lars Bachmann wrote:
> Im using the erlang shell to connect to the broker. With 
> "rabbit_amqqueue:stat_all()." i get a list of all queues with the 
> messages of the broker. And the message count for the listed queues is 
> not correct.

When do you perform this check? Straight after your producer has terminated?

Is the Erlang VM idle when you perform the check?

basic.publish is asynchronous; the messages may get buffered in various 
places before eventually hitting the queues.



Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Fri May 16 16:01:36 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Fri, 16 May 2008 17:01:36 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <482D9798.60809@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
Message-ID: <20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>

Mathias,

i perform this check after my producer has terminated, but even if i  
make this test some minutes later still the same result. I send 60000  
messages and only for example 48000 are in the queue. (i actually  
noticed it has nothing to do with pub/sub scenario its only about the  
amount of messages i sent persistent). So there are always some  
messages in the queue but not all. Now i connected a consumer to the  
queue and it receives only the amount of messages which were in the  
queue. (which means 48000 in the above example). I attached also the  
client of the consumer, which is the a modified simpletopic consumer  
from the cleint package.

Lars

> Lars,
>
> Lars Bachmann wrote:
>> Im using the erlang shell to connect to the broker. With   
>> "rabbit_amqqueue:stat_all()." i get a list of all queues with the   
>> messages of the broker. And the message count for the listed queues  
>>  is not correct.
>
> When do you perform this check? Straight after your producer has terminated?
>
> Is the Erlang VM idle when you perform the check?
>
> basic.publish is asynchronous; the messages may get buffered in various
> places before eventually hitting the queues.
>
>
>
> Matthias.



-------------- next part --------------
A non-text attachment was scrubbed...
Name: SimpleTopicConsumer.java
Type: text/x-java
Size: 3865 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080516/21ac6f3a/attachment.java 

From matthias at lshift.net  Fri May 16 16:23:57 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 16 May 2008 16:23:57 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
Message-ID: <482DA70D.4060909@lshift.net>

Lars,

Lars Bachmann wrote:
> i perform this check after my producer has terminated, but even if i 
> make this test some minutes later still the same result. I send 60000 
> messages and only for example 48000 are in the queue.

Interesting. I have a few theories of what might be happening. Could you 
try the following experiments and let me know whether the results change?

1) delay the call to channel.close in the producer

2) set the "mandatory" flag in the basicPublish call - see the 7-arg 
version of that method.


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Fri May 16 17:01:33 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Fri, 16 May 2008 18:01:33 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <482DA70D.4060909@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
Message-ID: <20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>

Mathias,

by now i tried only 1) and it definitly has some affect. I was able to  
send 70000, 100000 and 150000 messages and all were received by the  
broker. When i wanted to send 200000 i got a socketconnection  
exception. Next week i ll take a closer look why this happened and i  
ll also try out the mandatory flag.

So it seems that the channel was already closed but not all messages  
were sent, very interessting. Thank you for your help. Next week i ll  
give some more feedback.

Lars

> Lars,
>
> Lars Bachmann wrote:
>> i perform this check after my producer has terminated, but even if   
>> i make this test some minutes later still the same result. I send   
>> 60000 messages and only for example 48000 are in the queue.
>
> Interesting. I have a few theories of what might be happening. Could
> you try the following experiments and let me know whether the results
> change?
>
> 1) delay the call to channel.close in the producer
>
> 2) set the "mandatory" flag in the basicPublish call - see the 7-arg
> version of that method.
>
>
> Matthias.







From matthias at lshift.net  Fri May 16 17:38:18 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 16 May 2008 17:38:18 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
Message-ID: <482DB87A.9080107@lshift.net>

Lars,

Lars Bachmann wrote:
> by now i tried only 1) and it definitly has some affect. I was able to 
> send 70000, 100000 and 150000 messages and all were received by the 
> broker. When i wanted to send 200000 i got a socketconnection exception. 

Thanks for running this experiment. These results give me something to 
go on.

Btw, what version of RabbitMQ and what O/S are you running?


Matthias.



From matthias at lshift.net  Fri May 16 19:10:36 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 16 May 2008 19:10:36 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <482DB87A.9080107@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net>
Message-ID: <482DCE1C.7070400@lshift.net>

Lars,

Matthias Radestock wrote:
> Lars Bachmann wrote:
>> by now i tried only 1) and it definitly has some affect. I was able to 
>> send 70000, 100000 and 150000 messages and all were received by the 
>> broker. When i wanted to send 200000 i got a socketconnection exception. 
> 
> Thanks for running this experiment. These results give me something to 
> go on.

I think I've found the problem, though if my analysis is correct I would 
have expected an error in the server logs. Are you sure there is nothing 
unusual in there? Perhaps you could send me the log output recorded by 
the server when running your test program (in its original form, i.e. 
without the delay in closing the channel).


Matthias.



From rabbitmq-discuss_efine at usa.net  Fri May 16 22:36:16 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Fri, 16 May 2008 17:36:16 -0400
Subject: [rabbitmq-discuss] possible bug starting rabbit with NODENAME
	set?
In-Reply-To: <482D3268.6070000@lshift.net>
References: <482C67D4.1030105@cohesiveft.com> <482C9965.1060000@lshift.net>
	<6c2563b20805151422ye74396dr15de4d5ff825a7e8@mail.gmail.com>
	<482D3268.6070000@lshift.net>
Message-ID: <6c2563b20805161436r6fd173c0g3f3d1f86cd0e76@mail.gmail.com>

Matthias,

I can also successfully run /usr/sbin/rabbitmq-server from the command line
if I change -sname to -name. I just have to make sure that I change the
actual mnesia dir to match the NODENAME.

But I think that in addition to the rabbit_multi script, rabbit_multi.erl
will need some serious tweaking. I think it was written with local
clustering in mind and did not adequately consider the effect of using
fully-qualified domain names with -name.

This is my analysis of the code and behavior. If I am mistaken, I am sure
you will point out where and why :)

Firstly, rabbit_multi.erl hard-codes the node name "rabbit":

    NodeName = if NodeNumber == 0 ->
                       %% For compatibility with running a single node
                       "rabbit";
                  true ->
                       "rabbit_" ++ integer_to_list(NodeNumber)
               end,
    {NodePid, Started} = start_node(NodeName, "0.0.0.0", 5672 + NodeNumber,
                                    RpcTimeout),

and then goes on to cut everything off after the "@" in the node name in
localnode():

    Node = rabbit_misc:localnode(list_to_atom(NodeName)),
    case rpc:call(Node, os, getpid, []) of

Even if NodeName wasn't hard-coded to "rabbit", localnode would strip off
everything after the "@" anyway. Now if rabbit at myexample.com were running
locally, but using -name, the rpc call would fail because erlang would want
the full node name.

Anyway, the rpc fails because rabbit isn't running yet, so rabbit_multi will
now try to start it (but it will fail for reasons mentioned above). Just
prior to this, to add insult to injury, the code blasts any environment
values that might have existed. This explains the behavior of why RabbitMQ
times out waiting for Mnesia to start. It can't find the node. Even if I
called the node 'rabbit at something.com' and not 'grendel at something.com', it
would not work because it would be trying to rpc to 'rabbit', which does not
and never will exist while starting up with -name.

start_node(NodeName, NodeIPAddress, NodePort, RpcTimeout) ->
    os:putenv("NODENAME", NodeName),
    os:putenv("NODE_IP_ADDRESS", NodeIPAddress),
    os:putenv("NODE_PORT", integer_to_list(NodePort)),
    Node = rabbit_misc:localnode(list_to_atom(NodeName)),
    case rpc:call(Node, os, getpid, []) of
        {badrpc, _} ->
            Port = run_cmd(script_filename()),
            Started = wait_for_rabbit_to_start(Node, RpcTimeout, Port),
            Pid = case rpc:call(Node, os, getpid, []) of
                      {badrpc, _} -> throw(cannot_get_pid);
                      PidS -> list_to_integer(PidS)
                  end,
            {{Node, Pid}, Started};
        PidS ->
            Pid = list_to_integer(PidS),
            throw({node_already_running, Node, Pid})
    end.

I respectfully suggest that some more thought needs to go into
rabbit_multi.erl and perhaps the startup/node name architecture.

Regards,
Edwin

On Fri, May 16, 2008 at 3:06 AM, Matthias Radestock <matthias at lshift.net>
wrote:

> Edwin,
>
> Edwin Fine wrote:
>
>> On this topic, does RabbitMQ have to use a short name (-sname) for its
>> node name? I had issues trying to use -name instead of -sname.
>>
>
> changing rabbitmq-server to use -name instead of -sname works fine for me,
> though rabbitmq-multi would need some tweaking to get working again after
> such a change.
>
> What problems did you encounter?
>
>
> Matthias.
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080516/ff200040/attachment.htm 

From matthias at lshift.net  Fri May 16 23:22:03 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 16 May 2008 23:22:03 +0100
Subject: [rabbitmq-discuss] possible bug starting rabbit with NODENAME
 set?
In-Reply-To: <6c2563b20805161436r6fd173c0g3f3d1f86cd0e76@mail.gmail.com>
References: <482C67D4.1030105@cohesiveft.com>
	<482C9965.1060000@lshift.net>	<6c2563b20805151422ye74396dr15de4d5ff825a7e8@mail.gmail.com>	<482D3268.6070000@lshift.net>
	<6c2563b20805161436r6fd173c0g3f3d1f86cd0e76@mail.gmail.com>
Message-ID: <482E090B.6080908@lshift.net>

Edwin,

Edwin Fine wrote:
> I can also successfully run /usr/sbin/rabbitmq-server from the command 
> line if I change -sname to -name. I just have to make sure that I change 
> the actual mnesia dir to match the NODENAME.

By default the mnesia dir is based on the NODENAME. By "change" do you 
mean "rename", so you retain the existing data across the move? That 
wouldn't be a good idea - mnesia can get very confused if you its dirs 
between nodes.

> But I think that in addition to the rabbit_multi script, 
> rabbit_multi.erl will need some serious tweaking. I think it was written 
> with local clustering in mind and did not adequately consider the effect 
> of using fully-qualified domain names with -name.

Correct.

As a bit of background, rabbitmq-multi was introduced to give people a 
quick and easy way to set up a cluster on their local machine. It was 
never intended to cope with more complex set ups. There is all kinds of 
tweaking a user may want to do to their cluster and the rabbit start up 
in general. The scripts can only ever cater for a subset of that.

It's usually not that hard to construct your own scripts to start up 
rabbit in the particular way that suits your environment, so we would 
expect users to do just that.

> Firstly, rabbit_multi.erl hard-codes the node name "rabbit":

I filed a bug for that a few days ago.

> localnode would strip off everything after the "@" anyway. Now if
> rabbit at myexample.com <mailto:rabbit at myexample.com> were running
> locally, but using -name, the rpc call would fail because erlang
> would want the full node name.

As I said above, the scripts and supporting code were designed for 
-sname, not -name. However, they can probably be adjusted to cope with 
the latter. We will look into that.

> Just prior to this, to add insult to injury, the code blasts any 
> environment values that might have existed.

Indeed. I filed a bug for that a few days ago too.

> I respectfully suggest that some more thought needs to go into 
> rabbit_multi.erl and perhaps the startup/node name architecture.

Thanks for your analysis. Most of the points you raised should be 
addressed in the next RabbitMQ release.


Matthias.



From rabbitmq-discuss_efine at usa.net  Sat May 17 03:40:14 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Fri, 16 May 2008 22:40:14 -0400
Subject: [rabbitmq-discuss] possible bug starting rabbit with NODENAME
	set?
In-Reply-To: <482E090B.6080908@lshift.net>
References: <482C67D4.1030105@cohesiveft.com> <482C9965.1060000@lshift.net>
	<6c2563b20805151422ye74396dr15de4d5ff825a7e8@mail.gmail.com>
	<482D3268.6070000@lshift.net>
	<6c2563b20805161436r6fd173c0g3f3d1f86cd0e76@mail.gmail.com>
	<482E090B.6080908@lshift.net>
Message-ID: <6c2563b20805161940id54a19dt788aca75dfc8e9e2@mail.gmail.com>

Matthias

By default the mnesia dir is based on the NODENAME. By "change" do you mean
> "rename", so you retain the existing data across the move? That wouldn't be
> a good idea - mnesia can get very confused if you its dirs between nodes.
>

Yes, I meant rename the directory on disk, but just within the same
filesystem. Actually, I did a cp -R so the original directory was untouched.
As it turns out, mnesia didn't seem to mind, so maybe I just got lucky this
time. Even so, this is not a production system so I don't mind too much if I
have to reinitialize RabbitMQ.


>  Firstly, rabbit_multi.erl hard-codes the node name "rabbit":
>>
>
> I filed a bug for that a few days ago.


I haven't looked very hard  for this, but is there a bug tracker for
RabbitMQ that I can get to, and look for reported bugs so as not bug ;-) you
guys unnecessarily?

As I said above, the scripts and supporting code were designed for -sname,
> not -name. However, they can probably be adjusted to cope with the latter.
> We will look into that.
>

I want to use -name because I will have applications running on a
fully-qualified node (-name) that will be doing rpc:call()s to the rabbit
node (to access the queue management functions), and I can't do that if
Rabbit is running -sname and my stuff is running -name. I suppose I could do
it all over TCP/IP but I really don't want to at this stage. Hopefully this
clarifies my desire to use -name.


>  Just prior to this, to add insult to injury, the code blasts any
>> environment values that might have existed.
>>
>
> Indeed. I filed a bug for that a few days ago too.


Darn. I really need to find that bug tracker :)

Thanks so much for your attention and responsiveness. It bodes well for
RabbitMQ as a product.


> Matthias.
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080516/332e53c4/attachment.htm 

From matthias at lshift.net  Sat May 17 05:36:21 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Sat, 17 May 2008 05:36:21 +0100
Subject: [rabbitmq-discuss] possible bug starting rabbit with NODENAME
 set?
In-Reply-To: <6c2563b20805161940id54a19dt788aca75dfc8e9e2@mail.gmail.com>
References: <482C67D4.1030105@cohesiveft.com>
	<482C9965.1060000@lshift.net>	<6c2563b20805151422ye74396dr15de4d5ff825a7e8@mail.gmail.com>	<482D3268.6070000@lshift.net>	<6c2563b20805161436r6fd173c0g3f3d1f86cd0e76@mail.gmail.com>	<482E090B.6080908@lshift.net>
	<6c2563b20805161940id54a19dt788aca75dfc8e9e2@mail.gmail.com>
Message-ID: <482E60C5.10500@lshift.net>

Edwin,

Edwin Fine wrote:
> Yes, I meant rename the directory on disk, but just within the same 
> filesystem. Actually, I did a cp -R so the original directory was 
> untouched. As it turns out, mnesia didn't seem to mind, so maybe I just 
> got lucky this time.

There are a few discussions online on why just moving the dir won't 
work. See 
http://www.erlang.org/pipermail/erlang-questions/2002-January/004254.html, 
for example.

> I haven't looked very hard  for this, but is there a bug tracker for 
> RabbitMQ that I can get to, and look for reported bugs so as not bug ;-) 
> you guys unnecessarily?

The bug tracker isn't public. It will be one day; we just need to find 
the time to make the switch.

> I want to use -name because I will have applications running on a 
> fully-qualified node (-name) that will be doing rpc:call()s to the 
> rabbit node (to access the queue management functions), and I can't do 
> that if Rabbit is running -sname and my stuff is running -name.

Understood. -name is of course useful; we'll see whether the scripts can 
be made to support it more easily.


Matthias.




From rabbitmq-discuss_efine at usa.net  Sat May 17 05:41:14 2008
From: rabbitmq-discuss_efine at usa.net (Edwin Fine)
Date: Sat, 17 May 2008 00:41:14 -0400
Subject: [rabbitmq-discuss] possible bug starting rabbit with NODENAME
	set?
In-Reply-To: <482E60C5.10500@lshift.net>
References: <482C67D4.1030105@cohesiveft.com> <482C9965.1060000@lshift.net>
	<6c2563b20805151422ye74396dr15de4d5ff825a7e8@mail.gmail.com>
	<482D3268.6070000@lshift.net>
	<6c2563b20805161436r6fd173c0g3f3d1f86cd0e76@mail.gmail.com>
	<482E090B.6080908@lshift.net>
	<6c2563b20805161940id54a19dt788aca75dfc8e9e2@mail.gmail.com>
	<482E60C5.10500@lshift.net>
Message-ID: <6c2563b20805162141y713fae95m991031de51046f77@mail.gmail.com>

Thanks for the info!!

On Sat, May 17, 2008 at 12:36 AM, Matthias Radestock <matthias at lshift.net>
wrote:

> Edwin,
>
> Edwin Fine wrote:
>
>> Yes, I meant rename the directory on disk, but just within the same
>> filesystem. Actually, I did a cp -R so the original directory was untouched.
>> As it turns out, mnesia didn't seem to mind, so maybe I just got lucky this
>> time.
>>
>
> There are a few discussions online on why just moving the dir won't work.
> See
> http://www.erlang.org/pipermail/erlang-questions/2002-January/004254.html,
> for example.
>
>  I haven't looked very hard  for this, but is there a bug tracker for
>> RabbitMQ that I can get to, and look for reported bugs so as not bug ;-) you
>> guys unnecessarily?
>>
>
> The bug tracker isn't public. It will be one day; we just need to find the
> time to make the switch.
>
>  I want to use -name because I will have applications running on a
>> fully-qualified node (-name) that will be doing rpc:call()s to the rabbit
>> node (to access the queue management functions), and I can't do that if
>> Rabbit is running -sname and my stuff is running -name.
>>
>
> Understood. -name is of course useful; we'll see whether the scripts can be
> made to support it more easily.
>
>
> Matthias.
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080517/cd278582/attachment.htm 

From lars.bachmann at s2002.tu-chemnitz.de  Wed May 21 10:52:12 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Wed, 21 May 2008 11:52:12 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <482DCE1C.7070400@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net> <482DCE1C.7070400@lshift.net>
Message-ID: <20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>

Mathias,

after some days of vacation Im going on with rabbitmq. As i wrote last  
time the reason why the messages were not sent was because of an  
already closed channel.
But still Im not happy with all behaviour and having different issues.
I delayed the time before closing a channel up to 50 seconds. In this  
case i was able to send about 150000 messages correctly. If I try to  
send more messages I also have to increase the delay time. But if the  
communication between producer and broker takes too long i get an  
"java.net.SocketException". Here the stacktrace:

hit IOException in Producer: trace follows
java.net.SocketException: Connection reset
         at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:96)
         at java.net.SocketOutputStream.write(SocketOutputStream.java:136)
         at  
java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:65)
         at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:123)
         at java.io.DataOutputStream.flush(DataOutputStream.java:106)
         at  
com.rabbitmq.client.impl.SocketFrameHandler.writeFrame(SocketFrameHandler.java:156)
         at  
com.rabbitmq.client.impl.AMQConnection.writeFrame(AMQConnection.java:297)
         at com.rabbitmq.client.impl.AMQCommand.transmit(AMQCommand.java:190)
         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:369)
         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:350)
         at  
com.rabbitmq.test.ConcurrentRabbitMQProducerTest.runIt(ConcurrentRabbitMQProducerTest.java:100)
         at  
com.rabbitmq.test.ConcurrentRabbitMQProducerTest.run(ConcurrentRabbitMQProducerTest.java:71)
         at java.lang.Thread.run(Thread.java:619)
Exception in thread "Thread-1" java.lang.RuntimeException:  
java.net.SocketException: Connection reset
         at  
com.rabbitmq.test.ConcurrentRabbitMQProducerTest.run(ConcurrentRabbitMQProducerTest.java:75)
         at java.lang.Thread.run(Thread.java:619)
Caused by: java.net.SocketException: Connection reset
         at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:96)
         at java.net.SocketOutputStream.write(SocketOutputStream.java:136)
         at  
java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:65)
         at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:123)
         at java.io.DataOutputStream.flush(DataOutputStream.java:106)
         at  
com.rabbitmq.client.impl.SocketFrameHandler.writeFrame(SocketFrameHandler.java:156)
         at  
com.rabbitmq.client.impl.AMQConnection.writeFrame(AMQConnection.java:297)
         at com.rabbitmq.client.impl.AMQCommand.transmit(AMQCommand.java:190)
         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:369)
         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:350)
         at  
com.rabbitmq.test.ConcurrentRabbitMQProducerTest.runIt(ConcurrentRabbitMQProducerTest.java:100)
         at  
com.rabbitmq.test.ConcurrentRabbitMQProducerTest.run(ConcurrentRabbitMQProducerTest.java:71)

After this exception also the broker dont respond anymore. The process  
is still running but i cant connect with an erlang shell to the  
broker. Very strange behaviour. All I can do in this situation is to  
restart the broker ...

My System: Im running rabbitmq 1.3. on a gentoo linux. In the log file  
is nothing unusal. (How can I actually switch the log level to "debug"  
?)

Lars


> Lars,
>
> Matthias Radestock wrote:
>> Lars Bachmann wrote:
>>> by now i tried only 1) and it definitly has some affect. I was   
>>> able to send 70000, 100000 and 150000 messages and all were   
>>> received by the broker. When i wanted to send 200000 i got a   
>>> socketconnection exception.
>>
>> Thanks for running this experiment. These results give me something  
>>  to go on.
>
> I think I've found the problem, though if my analysis is correct I
> would have expected an error in the server logs. Are you sure there is
> nothing unusual in there? Perhaps you could send me the log output
> recorded by the server when running your test program (in its original
> form, i.e. without the delay in closing the channel).
>
>
> Matthias.







From lars.bachmann at s2002.tu-chemnitz.de  Wed May 21 11:33:12 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Wed, 21 May 2008 12:33:12 +0200
Subject: [rabbitmq-discuss] binding exchanges in java
Message-ID: <20080521123312.86m9g92k4gckc0kg@mail.tu-chemnitz.de>

Hello,

in rabbitmq routing information is seperated from data. One can set up  
an individually configuration by binding exchanges and queues  
together. With the Java API it is possible to declare queues and  
exchanges and connect them. The theory tells that it is also possible  
to bind an exchange to an exchange. But I couldn't find a way to do  
this in Java. So my question is: how to bind 2 exchanges together ?  
and is it also possible to do this also with the java client.

Lars





From matthias at lshift.net  Wed May 21 11:56:49 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 21 May 2008 11:56:49 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>	<482DB87A.9080107@lshift.net>
	<482DCE1C.7070400@lshift.net>
	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
Message-ID: <4833FFF1.8070008@lshift.net>

Lars,

Lars Bachmann wrote:
> Im not happy with all behaviour and having different issues.
> I delayed the time before closing a channel up to 50 seconds. In this 
> case i was able to send about 150000 messages correctly. If I try to 
> send more messages I also have to increase the delay time.

We know what the problem is here, and it's going to be fixed in the next 
release.

> But if the 
> communication between producer and broker takes too long i get an 
> "java.net.SocketException".

What do you mean by "takes too long"?

> After this exception also the broker dont respond anymore. The process 
> is still running but i cant connect with an erlang shell to the broker. 
> Very strange behaviour. All I can do in this situation is to restart the 
> broker ...

That's strange indeed. RabbitMQ is normally quite difficult to kill :)

> In the log file is nothing unusal.

Does this go for both the rabbit.log and rabbit-sasl.log?

In any case, please send me the contents of these files.


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Wed May 21 12:29:23 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Wed, 21 May 2008 13:29:23 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <4833FFF1.8070008@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net> <482DCE1C.7070400@lshift.net>
	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
	<4833FFF1.8070008@lshift.net>
Message-ID: <20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>

Mathias,


>> But if the communication between producer and broker takes too long  
>>  i get an "java.net.SocketException".
>
> What do you mean by "takes too long"?
>
Too long is the wrong word, lets better say too many messages. But Im  
not sure, in my last tests I didnt get this exception, but i got the  
"java.lang.IllegalStateException: Attempt to use closed connection"  
which is caused by trying to use the already closed channel. But the  
point is that even in this case the broker dont respond anymore. My  
system shows 100% processor use which is caused by the broker but i  
cant connect to the broker anymore.

Both log files are attached. Can u already say when the next release  
will be published ?

Lars


-------------- next part --------------
A non-text attachment was scrubbed...
Name: broker4.log
Type: text/x-log
Size: 133 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080521/4a4678c8/attachment.bin 

From matthias at lshift.net  Wed May 21 12:41:39 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 21 May 2008 12:41:39 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>	<482DB87A.9080107@lshift.net>
	<482DCE1C.7070400@lshift.net>	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>	<4833FFF1.8070008@lshift.net>
	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>
Message-ID: <48340A73.2010600@lshift.net>

Lars,

Lars Bachmann wrote:
> Both log files are attached.

There was only one attachment and it contains just a single message 
about the persister log being rolled. That can't be right; there should 
be log entries for every client connect and disconnect.

You should have four log files:
rabbit.log
rabbit.log.bak
rabbit-sasl.log
rabbit-sasl.log.bak

Please send me the contents of all of these.


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Wed May 21 14:31:59 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Wed, 21 May 2008 15:31:59 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <48340A73.2010600@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net> <482DCE1C.7070400@lshift.net>
	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
	<4833FFF1.8070008@lshift.net>
	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>
	<48340A73.2010600@lshift.net>
Message-ID: <20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>

> Lars,
>
> Lars Bachmann wrote:
>> Both log files are attached.
>
> There was only one attachment and it contains just a single message
> about the persister log being rolled. That can't be right; there should
> be log entries for every client connect and disconnect.
>
> You should have four log files:
> rabbit.log
> rabbit.log.bak
> rabbit-sasl.log
> rabbit-sasl.log.bak
>
> Please send me the contents of all of these.
>
>
> Matthias.

Mathias,

the log messages i sent you, were created by the communication with  
one client where the error occurs. However i made some more actions  
and Im sending u the files now. The "sasl" files are always empty but  
in the log files is one error message. I hope it ll help you.

Lars

-------------- next part --------------
A non-text attachment was scrubbed...
Name: broker4.log
Type: text/x-log
Size: 133 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080521/0150471a/attachment.bin 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: broker4.log.bak
Type: application/x-trash
Size: 507 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080521/0150471a/attachment.bak 

From matthias at lshift.net  Wed May 21 15:33:15 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 21 May 2008 15:33:15 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>	<482DB87A.9080107@lshift.net>
	<482DCE1C.7070400@lshift.net>	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>	<4833FFF1.8070008@lshift.net>	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>	<48340A73.2010600@lshift.net>
	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>
Message-ID: <483432AB.502@lshift.net>

Lars Bachmann wrote:
> the log messages i sent you, were created by the communication with one 
> client where the error occurs. However i made some more actions and Im 
> sending u the files now. The "sasl" files are always empty but in the 
> log files is one error message.

I do not see any error messages in the log files. Also, there is still 
no trace of the TCP listener starting, or the client 
connecting/disconnecting, which is extremely weird.

How exactly are you starting the broker?

Are you running a cluster?

One thing to try is to get an erlang shell in your broker and evaluate
   rabbit_log:info("show me!").
and then check whether the message appears in the rabbit log.

It would also be useful if you ran a clean test. Stop the broker remove 
the mnesia dir and log files. Start the broker. Then run your tests. And 
then send me the log files.


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Wed May 21 15:44:46 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Wed, 21 May 2008 16:44:46 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <483432AB.502@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net> <482DCE1C.7070400@lshift.net>
	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
	<4833FFF1.8070008@lshift.net>
	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>
	<48340A73.2010600@lshift.net>
	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>
	<483432AB.502@lshift.net>
Message-ID: <20080521164446.mfju19eyo08g4g4w@mail.tu-chemnitz.de>

Zitat von Matthias Radestock <matthias at lshift.net>:

> Lars Bachmann wrote:
>> the log messages i sent you, were created by the communication with  
>>  one client where the error occurs. However i made some more  
>> actions  and Im sending u the files now. The "sasl" files are  
>> always empty  but in the log files is one error message.
>
> I do not see any error messages in the log files. Also, there is still
> no trace of the TCP listener starting, or the client
> connecting/disconnecting, which is extremely weird.
>
> How exactly are you starting the broker?
>
> Are you running a cluster?
>
> One thing to try is to get an erlang shell in your broker and evaluate
>   rabbit_log:info("show me!").
> and then check whether the message appears in the rabbit log.
>
> It would also be useful if you ran a clean test. Stop the broker remove
> the mnesia dir and log files. Start the broker. Then run your tests.
> And then send me the log files.
>
>
> Matthias.

the error message is in the broker4.log.bak file and it says:

=ERROR REPORT==== 21-May-2008::13:22:48 ===
Error in process <0.166.0> on node 'broker4 at vmpontos' with exit value:  
{badarg,[{erlang,port_command,[#Port<0.258>,[<<7 bytes>>,<<4  
bytes>>,<<1  
byte>>]]},{rabbit_writer,internal_send_command_async,3},{rabbit_writer,handle_message,2},{rabbit_writer,mainloop,1}]}

and there are also messages about tcp connections (for example):

=INFO REPORT==== 21-May-2008::13:15:39 ===
started TCP listener on 10.1.2.130:5672

I run your test with log info and the text showed up in the logs and  
no, i dont run a cluster. I ll ran a clean test now and send u the  
result.

Lars





From matthias at lshift.net  Wed May 21 16:05:23 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 21 May 2008 16:05:23 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080521164446.mfju19eyo08g4g4w@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>	<482DB87A.9080107@lshift.net>
	<482DCE1C.7070400@lshift.net>	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>	<4833FFF1.8070008@lshift.net>	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>	<48340A73.2010600@lshift.net>	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>	<483432AB.502@lshift.net>
	<20080521164446.mfju19eyo08g4g4w@mail.tu-chemnitz.de>
Message-ID: <48343A33.4010406@lshift.net>

Lars,

Lars Bachmann wrote:

> the error message is in the broker4.log.bak file and it says:
> 
> =ERROR REPORT==== 21-May-2008::13:22:48 ===
> Error in process <0.166.0> on node 'broker4 at vmpontos' with exit value: 
> {badarg,[{erlang,port_command,[#Port<0.258>,[<<7 bytes>>,<<4 bytes>>,<<1 
> byte>>]]},{rabbit_writer,internal_send_command_async,3},{rabbit_writer,handle_message,2},{rabbit_writer,mainloop,1}]} 
> 
> and there are also messages about tcp connections (for example):
> 
> =INFO REPORT==== 21-May-2008::13:15:39 ===
> started TCP listener on 10.1.2.130:5672

Those messages are not in the log files you sent me. See for yourself at
http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2008-May/001264.html

> I run your test with log info and the text showed up in the logs and no, 
> i dont run a cluster. I ll ran a clean test now and send u the result.

Thanks. Just make sure to attach the complete logs in your report :)


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Wed May 21 16:10:50 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Wed, 21 May 2008 17:10:50 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <483432AB.502@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net> <482DCE1C.7070400@lshift.net>
	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
	<4833FFF1.8070008@lshift.net>
	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>
	<48340A73.2010600@lshift.net>
	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>
	<483432AB.502@lshift.net>
Message-ID: <20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>

Mathias,

here a short description of what i did and what exactly happened:

1. i stoped the broker, removed all stored messages and the logfiles  
and restarted the broker
2. my client is set up to wait 50 seconds after sending all messages  
before the channel will be closed
3. Im sending 500000 messages to the broker. 50 seconds seem to be to  
short thats why only 120000 messages are received by the broker => no  
client exception
4. Im sending again 500000 messages, some (of coz not all) messages  
are sent and then an exceptions occurs  
(java.lang.IllegalStateException: Attempt to use closed channel)
5. when i try to send one more time 500000 messages i get the  
socketexception immediatly and the broker is not reachable anymore and  
i have to kill the process

the log file is attached (in the sasl log file are no entries and  
there are no bak log files because i removed all on startup)

Lars



-------------- next part --------------
A non-text attachment was scrubbed...
Name: broker4.log
Type: text/x-log
Size: 133 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080521/e64df5dd/attachment.bin 

From matthias at lshift.net  Wed May 21 16:32:26 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 21 May 2008 16:32:26 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482B4180.5080306@lshift.net>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>	<482DB87A.9080107@lshift.net>
	<482DCE1C.7070400@lshift.net>	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>	<4833FFF1.8070008@lshift.net>	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>	<48340A73.2010600@lshift.net>	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>	<483432AB.502@lshift.net>
	<20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>
Message-ID: <4834408A.2090700@lshift.net>

Lars,

Lars Bachmann wrote:
> the log file is attached

Once again the log file you sent contains just a single entry. Something 
must be going wrong when you attach these files to your emails.


Matthias.



From lars.bachmann at s2002.tu-chemnitz.de  Wed May 21 17:35:46 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Wed, 21 May 2008 18:35:46 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <4834408A.2090700@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net> <482DCE1C.7070400@lshift.net>
	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
	<4833FFF1.8070008@lshift.net>
	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>
	<48340A73.2010600@lshift.net>
	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>
	<483432AB.502@lshift.net>
	<20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>
	<4834408A.2090700@lshift.net>
Message-ID: <20080521183546.95p3j7v484w4cck4@mail.tu-chemnitz.de>

Zitat von Matthias Radestock <matthias at lshift.net>:

> Lars,
>
> Lars Bachmann wrote:
>> the log file is attached
>
> Once again the log file you sent contains just a single entry.
> Something must be going wrong when you attach these files to your
> emails.
>
>
> Matthias.

oh sorry all my fault, i set up the broker on my computer and also on  
a vm. both locate the log files at the same position, but i sent u the  
files from my comp and not from the vm where Im running all my tests.  
how stupid :-) ok here we go ...

but i dont think there is something that could help u in the messages :-(

Lars

-------------- next part --------------
A non-text attachment was scrubbed...
Name: broker4.log
Type: text/x-log
Size: 5949 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080521/a66eaa6d/attachment.bin 

From lars.bachmann at s2002.tu-chemnitz.de  Thu May 22 09:22:51 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Thu, 22 May 2008 10:22:51 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <4834408A.2090700@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482B4180.5080306@lshift.net>
	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net> <482DCE1C.7070400@lshift.net>
	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
	<4833FFF1.8070008@lshift.net>
	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>
	<48340A73.2010600@lshift.net>
	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>
	<483432AB.502@lshift.net>
	<20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>
	<4834408A.2090700@lshift.net>
Message-ID: <20080522102251.mirikefyo0cck4k8@mail.tu-chemnitz.de>

Mathias,

I made some more tests (changing the delay time before the channel  
shut down, changing number of messages to sent) and I think the  
problem is always the closed channel. Sometimes when the channel is  
closed before all messages are sent the result is that not all  
messages are received by the broker, sometimes the client throws an  
"IllegalStateException Attempt to use closed channel" and sometimes  
even the broker is affeted and dont respond anymore. (For me it is  
also very strange why sometimes from lets say 200000 messages 100000  
are sent and sometimes only 15000. Is there some buffering for  
messages before sending ?)

Anyway u mentioned that u know this problem with the closed channel  
and u re working on it and it ll be fixed with the next release. Can u  
say when the next release will be published ? (some weeks, months,  
years ;-))

In our company we comparing different messaging solutions and rabbitmq  
seemed to be a good one, but the problems with the presistent messages  
are unfortunatelly a big minus.

Lars





From matthias at lshift.net  Thu May 22 10:08:44 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 22 May 2008 10:08:44 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080522102251.mirikefyo0cck4k8@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>	<482DB87A.9080107@lshift.net>
	<482DCE1C.7070400@lshift.net>	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>	<4833FFF1.8070008@lshift.net>	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>	<48340A73.2010600@lshift.net>	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>	<483432AB.502@lshift.net>	<20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>	<4834408A.2090700@lshift.net>
	<20080522102251.mirikefyo0cck4k8@mail.tu-chemnitz.de>
Message-ID: <4835381C.7060809@lshift.net>

Lars,

Lars Bachmann wrote:
> Anyway u mentioned that u know this problem with the closed channel and 
> u re working on it and it ll be fixed with the next release. Can u say 
> when the next release will be published ? (some weeks, months, years ;-))

We hope to have a new release in a few weeks.

> In our company we comparing different messaging solutions and rabbitmq 
> seemed to be a good one, but the problems with the presistent messages 
> are unfortunatelly a big minus.

The problem actually isn't with persistent messaging, but with sending 
lots of messages at a rate greater than the broker can process, and 
building up backlogs of 10th of thousands of messages in doing do. 
Persistence increases the workload and thus lowers the processing rate, 
which makes the problem more noticeable when persistence is enabled.

The bug is not causing any difficulties in practice unless *all* of the 
following are true of your clients:
- they publish messages to the broker at a rate that significantly 
exceeds the brokers processing capacity
- they sustain such a rate for a significant period of time (i.e. not 
just a few second blip)
- they disconnect shortly after sending all these messages

Regards,

Matthias.



From matthias at lshift.net  Thu May 22 13:49:42 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 22 May 2008 13:49:42 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <4835381C.7060809@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>	<482DB87A.9080107@lshift.net>
	<482DCE1C.7070400@lshift.net>	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>	<4833FFF1.8070008@lshift.net>	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>	<48340A73.2010600@lshift.net>	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>	<483432AB.502@lshift.net>	<20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>	<4834408A.2090700@lshift.net>
	<20080522102251.mirikefyo0cck4k8@mail.tu-chemnitz.de>
	<4835381C.7060809@lshift.net>
Message-ID: <48356BE6.2020302@lshift.net>

Lars,

Matthias Radestock wrote:
> Lars Bachmann wrote:
>> In our company we comparing different messaging solutions and rabbitmq 
>> seemed to be a good one, but the problems with the presistent messages 
>> are unfortunatelly a big minus.
> 
> The problem actually isn't with persistent messaging, but with sending 
> lots of messages at a rate greater than the broker can process, and 
> building up backlogs of 10th of thousands of messages in doing do. 
> Persistence increases the workload and thus lowers the processing rate, 
> which makes the problem more noticeable when persistence is enabled.
> 
> The bug is not causing any difficulties in practice unless *all* of the 
> following are true of your clients:
> - they publish messages to the broker at a rate that significantly 
> exceeds the brokers processing capacity
> - they sustain such a rate for a significant period of time (i.e. not 
> just a few second blip)
> - they disconnect shortly after sending all these messages

I forgot to mention that this is actually a grey area in the AMQP spec. 
What RabbitMQ is doing is perfectly compliant. We have initiated a 
discussion in the the AMQP working group to get the spec clarified. 
Independently of that, as I mentioned, we will fix the the problem in 
the next release.

I should also point out that AMQP's basic.publish is fundamentally 
asynchronous and thus limited in the guarantees it provides. You get 
stronger guarantees when wrapping your publish requests in transactions 
(see channel.tx{Select,Commit,Rollback}() in the Java API). The server 
guarantees that persistent messages have been written to disk by the 
time it returns tx.commit-ok, though obviously this carries a 
performance penalty.


Matthias.



From 0x6e6562 at gmail.com  Thu May 22 14:25:04 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 22 May 2008 14:25:04 +0100
Subject: [rabbitmq-discuss] Article discussing RabbitMQ
Message-ID: <1263AF59-0163-401C-8852-ECEFA7DE4050@gmail.com>

Hi all,

Although this is slightly OT, here is article that demonstrates how to  
do simple asynchronous RPCs using Rabbit and Flex: http://hopper.squarespace.com/blog/2008/5/22/pet-store-part-1.html

HTH,

Ben



From alexis.richardson at cohesiveft.com  Thu May 22 14:32:45 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Thu, 22 May 2008 14:32:45 +0100
Subject: [rabbitmq-discuss] binding exchanges in java
In-Reply-To: <20080521123312.86m9g92k4gckc0kg@mail.tu-chemnitz.de>
References: <20080521123312.86m9g92k4gckc0kg@mail.tu-chemnitz.de>
Message-ID: <167204d20805220632mfbcf510g59aa938e0e945767@mail.gmail.com>

Lars

Hi.

On Wed, May 21, 2008 at 11:33 AM, Lars Bachmann
<lars.bachmann at s2002.tu-chemnitz.de> wrote:
>
> in rabbitmq routing information is seperated from data. One can set up
> an individually configuration by binding exchanges and queues
> together. With the Java API it is possible to declare queues and
> exchanges and connect them. The theory tells that it is also possible
> to bind an exchange to an exchange. But I couldn't find a way to do
> this in Java. So my question is: how to bind 2 exchanges together ?
> and is it also possible to do this also with the java client.

This kind of feature will be defined in a future version of AMQP with
federation and other multi-hop addressing concepts.  These are useful
for B2B type cases.  Currently RabbitMQ is focussing on more
mainstream functionality.

Perhaps you could describe what use case you wish to implement.  If it
can be done with existing functionality, we can describe a solution.

alexis



From lars.bachmann at s2002.tu-chemnitz.de  Thu May 22 17:05:29 2008
From: lars.bachmann at s2002.tu-chemnitz.de (Lars Bachmann)
Date: Thu, 22 May 2008 18:05:29 +0200
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <48356BE6.2020302@lshift.net>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<482D6F27.4020907@lshift.net>
	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>
	<482D7A4E.7020307@lshift.net>
	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>
	<482D82DE.1020205@lshift.net>
	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>
	<482D9798.60809@lshift.net>
	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>
	<482DA70D.4060909@lshift.net>
	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>
	<482DB87A.9080107@lshift.net> <482DCE1C.7070400@lshift.net>
	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>
	<4833FFF1.8070008@lshift.net>
	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>
	<48340A73.2010600@lshift.net>
	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>
	<483432AB.502@lshift.net>
	<20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>
	<4834408A.2090700@lshift.net>
	<20080522102251.mirikefyo0cck4k8@mail.tu-chemnitz.de>
	<4835381C.7060809@lshift.net> <48356BE6.2020302@lshift.net>
Message-ID: <20080522180529.wfpd6ok1msgggg48@mail.tu-chemnitz.de>

Mathias,

thank you for your help and all the information you gave me. Now my  
task is to check some other mq brokers and in the end we ll see which  
system fits our requirements the best. The work with rabbitmq was all  
in all very satisfying except this channel bug. I hope it ll be fixed  
soon, but let's first have a look on the problems of the other brokers  
;-).

One more question. In the roadmap the jms integration is mentioned.  
Will this be also realized in the next release of rabbitmq ?

Lars

> Lars,
>
> Matthias Radestock wrote:
>> Lars Bachmann wrote:
>>> In our company we comparing different messaging solutions and   
>>> rabbitmq seemed to be a good one, but the problems with the   
>>> presistent messages are unfortunatelly a big minus.
>>
>> The problem actually isn't with persistent messaging, but with   
>> sending lots of messages at a rate greater than the broker can   
>> process, and building up backlogs of 10th of thousands of messages   
>> in doing do. Persistence increases the workload and thus lowers the  
>>  processing rate, which makes the problem more noticeable when   
>> persistence is enabled.
>>
>> The bug is not causing any difficulties in practice unless *all* of  
>>  the following are true of your clients:
>> - they publish messages to the broker at a rate that significantly   
>> exceeds the brokers processing capacity
>> - they sustain such a rate for a significant period of time (i.e.   
>> not just a few second blip)
>> - they disconnect shortly after sending all these messages
>
> I forgot to mention that this is actually a grey area in the AMQP spec.
> What RabbitMQ is doing is perfectly compliant. We have initiated a
> discussion in the the AMQP working group to get the spec clarified.
> Independently of that, as I mentioned, we will fix the the problem in
> the next release.
>
> I should also point out that AMQP's basic.publish is fundamentally
> asynchronous and thus limited in the guarantees it provides. You get
> stronger guarantees when wrapping your publish requests in transactions
> (see channel.tx{Select,Commit,Rollback}() in the Java API). The server
> guarantees that persistent messages have been written to disk by the
> time it returns tx.commit-ok, though obviously this carries a
> performance penalty.
>
>
> Matthias.







From 0x6e6562 at gmail.com  Mon May 26 11:34:01 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 26 May 2008 11:34:01 +0100
Subject: [rabbitmq-discuss] OT: TLS Support in the AS3 AMQP Client
Message-ID: <DF804268-9FF3-416B-B7F0-FBABEFA048A2@gmail.com>

Hi All,

This is another OT announcement about the TLS support that has been  
added to the AS3 client.

There is a article describing it here: http://hopper.squarespace.com/blog/2008/5/26/tls-support-in-the-as3-amqp-client.html

The setup is synonymous to the experimental TLS support of the Java  
Client ( http://www.rabbitmq.com/api-guide.html#ssl )

HTH,

Ben 



From sean at soundcloud.com  Wed May 28 13:55:32 2008
From: sean at soundcloud.com (Sean Treadway)
Date: Wed, 28 May 2008 14:55:32 +0200
Subject: [rabbitmq-discuss] Durable queues for STOMP broker
Message-ID: <EC24AD2C-7F4C-4B63-8C0A-E5687F237BA3@soundcloud.com>

Hi all,

I was pleased to find a STOMP broker to rabbitmq is under works,  
however the default queue creation parameters didn't meet my initial  
assumptions for using the broker as a reliable task dispatcher.   
Digging through the code, I found that the queues were always being  
created as non-durable and auto-deleted - any persistent messages  
would be discarded when no consumers were subscribed.  For our  
application, we needed to save these messages and process them at well  
defined intervals as well as have restart tolerant reliability.

Attached are 2 patches from my findings on how to expose some of the  
method parameters as STOMP headers.  They include the following changes:

  * utility function to extract boolean header values
  * expose 'passive', 'durable', 'auto-delete', 'exclusive' parameters  
of the AMQP 'queue.declare' method as STOMP headers in SUBSCRIBE
  * persist non AMQP binary content properties
  * test sender and receiver for durable queues

The simple reproduction case is as follows:

  * Connect a consumer and subscribe with the following headers:

SUBSCRIBE
destination: /queue/test
auto-delete: false
durable: true

  * Disconnect the consumer
  * Start a producer and send some persistent messages:

SEND
destination: /queue/test
delivery-mode: 2
content-length: 5
content-type: text/plain

ohai!

* Connect a consumer and subscribe to the queue with any headers

You should receive the persisted message sent to /queue/test.  There  
are 2 files in priv/tests-ruby that show this behavior a little bit  
better.  Comments are in persistent-sender.rb.

I also found a bug in message persistence over server restarts in  
rabbitmq-1.3.0.  In the comments for the content record, it states  
that at most, one of properties and properties_bin can be 'none'.   
During message persistence, it looked like there was an assumption  
that all properties came from AMQP binary packed blobs and the parsed  
headers were always cleared without checking that they could be  
restored later.  This patch will maintain the existing content/ 
properties when properties_bin is 'none'.  As well as fixing the stomp  
broker, this may fix persistence bugs with other erlang brokers that  
speak directly to rabbit_channel:do/3.

Without the patch, when the durable queues were restored and the  
persisted messages were resent, the content properties (including the  
STOMP headers) were lost and no longer matched by  
rabbit_stomp:send_reply/3 - logging an error and consuming the  
message.  With the patch, the persisted messages are are properly  
restored and resent to the first subscriber.

To reproduce this:

Run persistent-receiver.rb once - interrupt.
Run persistent-sender.rb once
Stop all running nodes of rabbitmq
Start rabbitmq
Run persistent-receiver.rb - you should receive the messages

Big thanks to you all at LShift for building this beautiful code.  My  
familiarity with AMQP is still fresh so feedback on the applicability  
of these patches is very welcome.  Points I am unsure about are - the  
role of the 'passive' parameter to queue.declare, whether or not to  
expose the 'nowait' parameter, whether or not to try and match  
ActiveMQ's STOMP header names or stick with the AMQP naming,  
interoperability of the properties patch for brokers such as HTTP and  
regression of the properties patch against AMQP messages with binary  
properties.  Also, the STOMP spec gives no insight for queue deletion  
when a durable queue is no longer needed.  Any ideas for that one?

Thanks,
-Sean

-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbitmq-stomp_durable_headers.patch
Type: application/octet-stream
Size: 3943 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080528/86c0b7ce/attachment.obj 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbitmq-1.3.0_persistent_headers.patch
Type: application/octet-stream
Size: 1630 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080528/86c0b7ce/attachment-0001.obj 

From tonyg at lshift.net  Fri May 30 10:15:19 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Fri, 30 May 2008 10:15:19 +0100
Subject: [rabbitmq-discuss] TX for guarantees of completion (was Re:
	persistence)
In-Reply-To: <20080522102251.mirikefyo0cck4k8@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>	<20080515124955.ewtg4rvhckcw0oks@mail.tu-chemnitz.de>	<482D6F27.4020907@lshift.net>	<20080516135833.3ljd4fc7c4g8gwos@mail.tu-chemnitz.de>	<482D7A4E.7020307@lshift.net>	<20080516143630.vy5g3k9rksscw8g8@mail.tu-chemnitz.de>	<482D82DE.1020205@lshift.net>	<20080516151355.nwkw0pa6g408sw4o@mail.tu-chemnitz.de>	<482D9798.60809@lshift.net>	<20080516170136.8ceragf971wcowcs@mail.tu-chemnitz.de>	<482DA70D.4060909@lshift.net>	<20080516180133.g2many17xccswgc4@mail.tu-chemnitz.de>	<482DB87A.9080107@lshift.net>
	<482DCE1C.7070400@lshift.net>	<20080521115212.c5nqmzhes4ssk88c@mail.tu-chemnitz.de>	<4833FFF1.8070008@lshift.net>	<20080521132923.3aqka9v0ys8wwsww@mail.tu-chemnitz.de>	<48340A73.2010600@lshift.net>	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>	<483432AB.502@lshift.net>	<20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>	<4834408A.2090700@lshift.net>
	<20080522102251.mirikefyo0cck4k8@mail.tu-chemnitz.de>
Message-ID: <483FC5A7.6060107@lshift.net>

Lars Bachmann wrote:
> Mathias,
> 
> I made some more tests [...]

Just to reiterate what Matthias said: I think that using TX mode will
get you the behaviour you're after.

If you like, you could try the following:

  1. as soon as you have opened a channel, call txSelect() on it
  2. every 50 (or 10, or 100, or 500) publishes, call txCommit()
  3. just before you call close(), call txCommit()

If you do something like this, you are effectively using the txCommit
(and, importantly, the reply you receive to it from the server) as a
synchronisation point.

The reply to txCommit counts as confirmation from the server that all
the submitted messages prior to the commit have been processed.

The final call to txCommit immediately before close is the part that
forces all the outstanding work to be complete before the socket closes.

You can vary the number in step two to trade off latency against throughput.

Do let us know how this works out for you, if you try it!

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From alexis.richardson at cohesiveft.com  Fri May 30 16:31:51 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Fri, 30 May 2008 16:31:51 +0100
Subject: [rabbitmq-discuss] persistence
In-Reply-To: <20080522180529.wfpd6ok1msgggg48@mail.tu-chemnitz.de>
References: <20080514104149.x8v1rwr1wcoc4w0g@mail.tu-chemnitz.de>
	<48340A73.2010600@lshift.net>
	<20080521153159.n458mjwys0wo8o44@mail.tu-chemnitz.de>
	<483432AB.502@lshift.net>
	<20080521171050.xbq5m4i9s0wwkwsg@mail.tu-chemnitz.de>
	<4834408A.2090700@lshift.net>
	<20080522102251.mirikefyo0cck4k8@mail.tu-chemnitz.de>
	<4835381C.7060809@lshift.net> <48356BE6.2020302@lshift.net>
	<20080522180529.wfpd6ok1msgggg48@mail.tu-chemnitz.de>
Message-ID: <167204d20805300831t65d5d892gdb7bb94bfaa999f8@mail.gmail.com>

Lars

Sorry - we did not answer this last week.

On Thu, May 22, 2008 at 5:05 PM, Lars Bachmann
<lars.bachmann at s2002.tu-chemnitz.de> wrote:
> Mathias,
>
> thank you for your help and all the information you gave me. Now my
> task is to check some other mq brokers and in the end we ll see which
> system fits our requirements the best. The work with rabbitmq was all
> in all very satisfying except this channel bug. I hope it ll be fixed
> soon, but let's first have a look on the problems of the other brokers
> ;-).

Good luck - please do share your results with the list so that we can
all improve RabbitMQ and understand more use cases and deployment
scenarios.


> One more question. In the roadmap the jms integration is mentioned.
> Will this be also realized in the next release of rabbitmq ?

Currently it is possible to run a subset of JMS against RabbitMQ by
using the Qpid M2.1 client.  This turns out to work quite well, and
gives you things like Spring integration, albeit confined to the
subset of cases.  The cases that are not supported yet are in the
further recesses of the JMS TCK.  The most awkward cases are
DTX and serverside Selectors which are addressed in versions of
the AMQP spec, such as 0-10.  We are just working through some
interop issue with other members of the WG which will reduce the
scope for variance in the cases not covered by Qpid M2.1.

Does that answer your question?

alexis


> Lars
>
>> Lars,
>>
>> Matthias Radestock wrote:
>>> Lars Bachmann wrote:
>>>> In our company we comparing different messaging solutions and
>>>> rabbitmq seemed to be a good one, but the problems with the
>>>> presistent messages are unfortunatelly a big minus.
>>>
>>> The problem actually isn't with persistent messaging, but with
>>> sending lots of messages at a rate greater than the broker can
>>> process, and building up backlogs of 10th of thousands of messages
>>> in doing do. Persistence increases the workload and thus lowers the
>>>  processing rate, which makes the problem more noticeable when
>>> persistence is enabled.
>>>
>>> The bug is not causing any difficulties in practice unless *all* of
>>>  the following are true of your clients:
>>> - they publish messages to the broker at a rate that significantly
>>> exceeds the brokers processing capacity
>>> - they sustain such a rate for a significant period of time (i.e.
>>> not just a few second blip)
>>> - they disconnect shortly after sending all these messages
>>
>> I forgot to mention that this is actually a grey area in the AMQP spec.
>> What RabbitMQ is doing is perfectly compliant. We have initiated a
>> discussion in the the AMQP working group to get the spec clarified.
>> Independently of that, as I mentioned, we will fix the the problem in
>> the next release.
>>
>> I should also point out that AMQP's basic.publish is fundamentally
>> asynchronous and thus limited in the guarantees it provides. You get
>> stronger guarantees when wrapping your publish requests in transactions
>> (see channel.tx{Select,Commit,Rollback}() in the Java API). The server
>> guarantees that persistent messages have been written to disk by the
>> time it returns tx.commit-ok, though obviously this carries a
>> performance penalty.
>>
>>
>> Matthias.
>
>
>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



