From matthias at lshift.net  Tue Apr  1 00:48:11 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 01 Apr 2008 00:48:11 +0100
Subject: [rabbitmq-discuss] Fwd: Fwd: Fw: Errors using Windows .NET
 Client Library
In-Reply-To: <333375.45845.qm@web804.biz.mail.mud.yahoo.com>
References: <333375.45845.qm@web804.biz.mail.mud.yahoo.com>
Message-ID: <47F1783B.8060700@lshift.net>

Bill,

BillC wrote:
> Thanks for your response.  I cleared everything in my Mnesia and Log 
> files and restarted the broker.  I also changed my props.DeliveryMode = 
> 1 to make non persistent messages on basicpublish.   I also ensured that 
> my basicpublisher closes both the channel and connections properly in 
> the basicpublisher code.

I was just trying to run your example and noticed that the consumer code 
you sent the other day isn't well-formed - it contains an "else" without 
an "if". Can you send through the exact code for both the publisher and 
consumer you are running?

It would also be useful to get hold of the compiled code, for me to run 
as a comparison. Perhaps you could post it on some upload service such 
as uploading.com?


Matthias.



From billc at inworksol.com  Tue Apr  1 02:23:17 2008
From: billc at inworksol.com (BillC)
Date: Mon, 31 Mar 2008 18:23:17 -0700 (PDT)
Subject: [rabbitmq-discuss] Fwd: Fwd: Fw: Errors using Windows .NET
	Client Library
In-Reply-To: <47F1783B.8060700@lshift.net>
Message-ID: <576457.59276.qm@web808.biz.mail.mud.yahoo.com>

Matthias,

Thanks for looking at this for me.  I have uploaded the a zip file which contains the files to the following URL where you can download:

http://www.inworksol.com/AllCode.zip

There are two folders:
1) ConsoleApplication2 is the Simple Subscriber
2) WindowsApplication1 is the Simple Publisher

The directories contain the full source code and also in the debug/bin folder of each you will find the .exe as well as the RabbitMQ.dll that I am using.

Thanks 

BillC


Matthias Radestock <matthias at lshift.net> wrote: Bill,

BillC wrote:
> Thanks for your response.  I cleared everything in my Mnesia and Log 
> files and restarted the broker.  I also changed my props.DeliveryMode = 
> 1 to make non persistent messages on basicpublish.   I also ensured that 
> my basicpublisher closes both the channel and connections properly in 
> the basicpublisher code.

I was just trying to run your example and noticed that the consumer code 
you sent the other day isn't well-formed - it contains an "else" without 
an "if". Can you send through the exact code for both the publisher and 
consumer you are running?

It would also be useful to get hold of the compiled code, for me to run 
as a comparison. Perhaps you could post it on some upload service such 
as uploading.com?


Matthias.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080331/56a05683/attachment.htm 

From billc at inworksol.com  Tue Apr  1 02:30:06 2008
From: billc at inworksol.com (BillC)
Date: Mon, 31 Mar 2008 18:30:06 -0700 (PDT)
Subject: [rabbitmq-discuss] Fwd: Fwd: Fw: Errors using Windows .NET
	Client Library
In-Reply-To: <576457.59276.qm@web808.biz.mail.mud.yahoo.com>
Message-ID: <557885.42134.qm@web802.biz.mail.mud.yahoo.com>

Sorry I forgot to tell you that you can change the hostname, port ..etc in the app.config files to run the .exe without recompiling ....

BillC <billc at inworksol.com> wrote: Matthias,

Thanks for looking at this for me.  I have uploaded the a zip file which contains the files to the following URL where you can download:

http://www.inworksol.com/AllCode.zip

There are two folders:
1) ConsoleApplication2 is the Simple Subscriber
2) WindowsApplication1 is the Simple Publisher

The directories contain the full source code and also in the debug/bin folder of each you will find the .exe as well as the RabbitMQ.dll that I am using.

Thanks 

BillC


Matthias Radestock <matthias at lshift.net> wrote: Bill,

BillC wrote:
> Thanks for your response.  I cleared everything in my Mnesia and Log 
> files and restarted the broker.  I also changed my props.DeliveryMode = 
> 1 to make non persistent messages on basicpublish.   I also ensured that  
> my basicpublisher closes both the channel and connections properly in 
> the basicpublisher code.

I was just trying to run your example and noticed that the consumer code 
you sent the other day isn't well-formed - it contains an "else" without 
an "if". Can you send through the exact code for both the publisher and 
consumer you are running?

It would also be useful to get hold of the compiled code, for me to run 
as a comparison. Perhaps you could post it on some upload service such 
as uploading.com?


Matthias.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080331/e5bec85a/attachment.htm 

From matthias at lshift.net  Tue Apr  1 02:58:53 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 01 Apr 2008 02:58:53 +0100
Subject: [rabbitmq-discuss] Fwd: Fwd: Fw: Errors using Windows .NET
 Client Library
In-Reply-To: <576457.59276.qm@web808.biz.mail.mud.yahoo.com>
References: <576457.59276.qm@web808.biz.mail.mud.yahoo.com>
Message-ID: <47F196DD.4010304@lshift.net>

Bill,

BillC wrote:
> There are two folders:
> 1) ConsoleApplication2 is the Simple Subscriber
> 2) WindowsApplication1 is the Simple Publisher
> 
> The directories contain the full source code and also in the debug/bin 
> folder of each you will find the .exe as well as the RabbitMQ.dll that I 
> am using.

I have run the exes of both apps against the broker at dev.rabbitmq.com 
and everything worked fine - the subscriber is happily waiting for 
messages to arrive and printing them.

That was using mono on debian though. You may want to consider switching 
to that ;)

I'll try WinXP tomorrow.


Matthias.



From matthias at lshift.net  Tue Apr  1 11:58:36 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 01 Apr 2008 11:58:36 +0100
Subject: [rabbitmq-discuss] RabbitMQ 1.3.0 released
Message-ID: <47F2155C.9040202@lshift.net>

The RabbitMQ team is pleased to announce the release of RabbitMQ 1.3.0.

This release has beta status and focuses on the following areas:

- bug fixes for a number of race conditions and non-compliances with the
   protocol specification
- several bug fixes and performance improvements for persistent
   messaging
- bug fixes in Debian and RPM packaging
- improved error reporting
- improved performance
- more examples

For details see the attached release notes.

Binary and source distributions of the new release can be found in the 
usual place, at http://www.rabbitmq.com/download.html

We recommend that all users of earlier versions of RabbitMQ upgrade to 
this latest release.

As always, we welcome any questions, bug reports, and other feedback on 
this release, as well as general suggestions for features and 
enhancements in future releases. Mail us via the RabbitMQ discussion 
list at rabbitmq-discuss at lists.rabbitmq.com, or directly at 
info at rabbitmq.com.

We have already started work on the next major release of RabbitMQ, 
which will see a rewrite of the server in Fortran, for improved 
performance and reduction in code size.


Regards,

The RabbitMQ Team
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: README-1.3.0.txt
Url: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080401/9a1ded2f/attachment.txt 

From codewalkerjoe at gmail.com  Tue Apr  1 15:43:58 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Tue, 1 Apr 2008 10:43:58 -0400
Subject: [rabbitmq-discuss] basic public-subscribe model with
	erlang-client
In-Reply-To: <D737AE2A-A061-47EB-8CBB-E0B229FAB0CB@gmail.com>
References: <50ec7a2e0803311405t593c3d60t79a29b4be8f05da2@mail.gmail.com>
	<D737AE2A-A061-47EB-8CBB-E0B229FAB0CB@gmail.com>
Message-ID: <50ec7a2e0804010743y3ba876na991522cdde85858@mail.gmail.com>

I did a quick search and educated myself bit on enterprise integration.  It
seems publish-subscribe model doesn't have any queue.  Message published
from the publisher first stored in publisher's memory and transfered to the
channel on the background.  Then the message get stored into memory of the
consumer and the consumer consumes the message from its memory.

I need something along the line of amazon sqs, asynchronous with queue.
This maybe a silly question to someone who is into enterprise integration.
If I go with synchronous message passing, can I have, for example, multiple
different channels sending messages to a single queue?  I just want to avoid
channel being the bottleneck.

thank you,
Joe


On Mon, Mar 31, 2008 at 5:33 PM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Joe,
> On 31 Mar 2008, at 22:05, joe lee wrote:
>
> Anyone knows how to do a basic publish (asynchronous method, no syncing
> with broker) using erlang-client, either in amqp mode or erlang mode?
>
>
> If I understand you correctly, if you want to publish a message, you can
> do the following:
>
> BasicPublish = #'basic.publish'{ticket = Ticket, exchange = X,
>                                     routing_key = RoutingKey,
>                                     mandatory = Mandatory,
>                                     immediate = Immediate},
> Content = #content{class_id = 60,
>          properties = amqp_util:basic_properties(), %% either 'none', or a
> decoded record/tuple
>          properties_bin = 'none', %% either 'none', or an encoded
> properties amqp_util:binary
>          %% Note: at most one of properties and properties_bin can be
> 'none' at once.
>          payload_fragments_rev = [Payload] %% list of binaries, in reverse
> order (!)
>         },
> amqp_channel:cast(Channel, BasicPublish, Content),
>
> This code is taken from the setup_publish/3 function in the test_util
> module of the Erlang client.
>
> The cast/3 function in amqp_channel sends the message asynchronously
> irrespective of whether you are using the TCP variant or native Erlang
> messaging.
>
> BTW, what do you mean when you say "amqp mode or erlang mode"?
>
> I have a queue and need to send message to the queue asynchronously and
> consumer will come along and process it.  If you are doing
> publish-subscribe, do you define a queue like you do for sysnchronous
> method?
>
>
> I'm not quite sure I follow. Which synchronous method are you referring
> to?
>
> HTH,
>
> Ben
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080401/b92d20cd/attachment.htm 

From holger at wizards.de  Tue Apr  1 16:35:43 2008
From: holger at wizards.de (=?ISO-8859-1?Q?Holger_Hoffst=E4tte?=)
Date: Tue, 01 Apr 2008 17:35:43 +0200
Subject: [rabbitmq-discuss] Small suggestion for 1.3 scripts
Message-ID: <47F2564F.8030607@wizards.de>

Guys,

Congrats on the 1.3 release - much improved and easier installation. Here 
are two small suggestions for the Windows scripts. I noticed that the logs 
& db are placed in %HOMEDRIVE%\%HOMEPATH%\rabbitmq. Windows convention is 
to use a subdirectory under the per-user %APPDATA% directory, i.e. change 
the definition of RABBITMQ_BASE in rabbitmq-server.bat and 
rabbitmq-multi.bat like this:

set RABBITMQ_BASE=%APPDATA%\RabbitMQ

The APPDATA path usually contains spaces ("Application Data") but I 
confirmed that everything still works fine.

Also, since that directory might be on a user's "network profile" (getting 
synced back and forth) it might be useful to only set the default if it 
has not been set already, for example when the db is supposed to be shared:

if "%RABBITMQ_BASE%"=="" (
     set RABBITMQ_BASE=%APPDATA%\RabbitMQ
)

Both changes are attached as patches.

Looking forward to that Fortran rewrite! (why not APL?)

Holger
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: rabbitmq-multi.bat.patch
Url: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080401/0d429f61/attachment.txt 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: rabbitmq-server.bat.patch
Url: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080401/0d429f61/attachment-0001.txt 

From alexis.richardson at cohesiveft.com  Tue Apr  1 16:39:40 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Tue, 1 Apr 2008 08:39:40 -0700
Subject: [rabbitmq-discuss] Small suggestion for 1.3 scripts
In-Reply-To: <47F2564F.8030607@wizards.de>
References: <47F2564F.8030607@wizards.de>
Message-ID: <167204d20804010839j2fd0cbeeo2849b908d6ebfed0@mail.gmail.com>

Thanks Holger.

We looked at APL but it just doesn't have the clarity of expression
that Fortran provides ;-)


On Tue, Apr 1, 2008 at 8:35 AM, Holger Hoffst?tte <holger at wizards.de> wrote:
> Guys,
>
>  Congrats on the 1.3 release - much improved and easier installation. Here
>  are two small suggestions for the Windows scripts. I noticed that the logs
>  & db are placed in %HOMEDRIVE%\%HOMEPATH%\rabbitmq. Windows convention is
>  to use a subdirectory under the per-user %APPDATA% directory, i.e. change
>  the definition of RABBITMQ_BASE in rabbitmq-server.bat and
>  rabbitmq-multi.bat like this:
>
>  set RABBITMQ_BASE=%APPDATA%\RabbitMQ
>
>  The APPDATA path usually contains spaces ("Application Data") but I
>  confirmed that everything still works fine.
>
>  Also, since that directory might be on a user's "network profile" (getting
>  synced back and forth) it might be useful to only set the default if it
>  has not been set already, for example when the db is supposed to be shared:
>
>  if "%RABBITMQ_BASE%"=="" (
>      set RABBITMQ_BASE=%APPDATA%\RabbitMQ
>  )
>
>  Both changes are attached as patches.
>
>  Looking forward to that Fortran rewrite! (why not APL?)
>
>  Holger
>
> --- rabbitmq_server-1.3.0\sbin\rabbitmq-multi.bat       2008-04-01 11:12:20.000000000 +0200
>  +++ RabbitMQ\sbin\rabbitmq-multi.bat    2008-04-01 17:14:03.515375000 +0200
>  @@ -24,7 +24,9 @@
>   REM   Contributor(s): ______________________________________.
>   REM
>
>  -set RABBITMQ_BASE=%HOMEDRIVE%%HOMEPATH%\rabbitmq
>  +if "%RABBITMQ_BASE%"=="" (
>  +    set RABBITMQ_BASE=%APPDATA%\RabbitMQ
>  +)
>
>   set PIDS_FILE=%RABBITMQ_BASE%\rabbitmq.pids
>   set SCRIPT_HOME=.
>
> --- rabbitmq_server-1.3.0\sbin\rabbitmq-server.bat      2008-04-01 11:12:20.000000000 +0200
>  +++ RabbitMQ\sbin\rabbitmq-server.bat   2008-04-01 17:30:57.754875000 +0200
>  @@ -24,7 +24,9 @@
>   REM   Contributor(s): ______________________________________.
>   REM
>
>  -set RABBITMQ_BASE=%HOMEDRIVE%%HOMEPATH%\rabbitmq
>  +if "%RABBITMQ_BASE%"=="" (
>  +    set RABBITMQ_BASE=%APPDATA%\RabbitMQ
>  +)
>
>   if "%NODENAME%"=="" (
>      set NODENAME=rabbit
>
> _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From alexis.richardson at cohesiveft.com  Tue Apr  1 16:52:02 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Tue, 1 Apr 2008 08:52:02 -0700
Subject: [rabbitmq-discuss] basic public-subscribe model with
	erlang-client
In-Reply-To: <50ec7a2e0804010743y3ba876na991522cdde85858@mail.gmail.com>
References: <50ec7a2e0803311405t593c3d60t79a29b4be8f05da2@mail.gmail.com>
	<D737AE2A-A061-47EB-8CBB-E0B229FAB0CB@gmail.com>
	<50ec7a2e0804010743y3ba876na991522cdde85858@mail.gmail.com>
Message-ID: <167204d20804010852n7cf9e93ar39cd2a74898ca8f2@mail.gmail.com>

Joe

On Tue, Apr 1, 2008 at 7:43 AM, Joe Lee <codewalkerjoe at gmail.com> wrote:
> I did a quick search and educated myself bit on enterprise integration.  It
> seems publish-subscribe model doesn't have any queue.

In AMQP the end consumers receive messages via a buffer - called a
queue.  If you stream on a 'pub/sub' basis then exchanges route to
queues whose bindings are in effect 'subscriptions'.  The spec is more
informative on this point.


> Message published
> from the publisher first stored in publisher's memory and transfered to the
> channel on the background.

That describes a physical implementation.  AMQP describes a logical
architecture.  AMQP allows for the broker (exchange+queue) to be
colocated with the publisher in memory.  The consuming client may then
be connected to the broker over a network.  Modulo your notion of
channel (which may not be the same as 'channel' in AMQP) this then
describes the physical topology that you want.

> Then the message get stored into memory of the
> consumer and the consumer consumes the message from its memory.

This is ambiguous because you could have two cases:

- physical queue colocated with consuming client
- client has private buffer holding messages delivered from queue
located at broker elsewhere




> I need something along the line of amazon sqs, asynchronous with queue.

In SQS the sending client is on one machine, which connects to 'the
cloud' where the SQS queue is hosted.  The receiving client is then on
another machine not on the cloud.  In other words:

sender --> broker --> receiver

... are on three different machines.

RabbitMQ provides this set-up easily.  Try the RabbitMQ broker at
dev.rabbitmq.com



> This maybe a silly question to someone who is into enterprise integration.

Not silly at all.  RabbitMQ is not just about enterprise integration.
Many users are 'web20' style companies who are just sending messages
within a system that they wholly control, to achieve scale,
availability, and reliability.  I think that some of them use Amazon
EC2 to run RabbitMQ instances.


> If I go with synchronous message passing, can I have, for example, multiple
> different channels sending messages to a single queue?  I just want to avoid
> channel being the bottleneck.

I am not sure if you mean an AMQP channel.  Channel will not be a
bottleneck in RabbitMQ.  Create a queue and bind it to a direct
exchange with key "test-direct".  Then create some clients and send
messages with that key to the broker.  They will all route that single
queue, as you require.

alexis



>
> On Mon, Mar 31, 2008 at 5:33 PM, Ben Hood <0x6e6562 at gmail.com> wrote:
> >
> >
> >
> >
> > Joe,
> >
> >
> >
> > On 31 Mar 2008, at 22:05, joe lee wrote:
> >
> > Anyone knows how to do a basic publish (asynchronous method, no syncing
> with broker) using erlang-client, either in amqp mode or erlang mode?
> >
> >
> >
> > If I understand you correctly, if you want to publish a message, you can
> do the following:
> >
> >
> >
> > BasicPublish = #'basic.publish'{ticket = Ticket, exchange = X,
> >                                     routing_key = RoutingKey,
> >                                     mandatory = Mandatory,
> >                                     immediate = Immediate},
> > Content = #content{class_id = 60,
> >          properties = amqp_util:basic_properties(), %% either 'none', or a
> decoded record/tuple
> >          properties_bin = 'none', %% either 'none', or an encoded
> properties amqp_util:binary
> >          %% Note: at most one of properties and properties_bin can be
> 'none' at once.
> >          payload_fragments_rev = [Payload] %% list of binaries, in reverse
> order (!)
> >         },
> > amqp_channel:cast(Channel, BasicPublish, Content),
> >
> > This code is taken from the setup_publish/3 function in the test_util
> module of the Erlang client.
> >
> >
> > The cast/3 function in amqp_channel sends the message asynchronously
> irrespective of whether you are using the TCP variant or native Erlang
> messaging.
> >
> >
> > BTW, what do you mean when you say "amqp mode or erlang mode"?
> >
> >
> >
> > I have a queue and need to send message to the queue asynchronously and
> consumer will come along and process it.  If you are doing
> publish-subscribe, do you define a queue like you do for sysnchronous
> method?
> >
> >
> > I'm not quite sure I follow. Which synchronous method are you referring
> to?
> >
> >
> > HTH,
> >
> >
> > Ben
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-discuss at lists.rabbitmq.com
> > http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> >
> >
>
>
> _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From 0x6e6562 at gmail.com  Tue Apr  1 17:08:50 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 1 Apr 2008 17:08:50 +0100
Subject: [rabbitmq-discuss] basic public-subscribe model with
	erlang-client
In-Reply-To: <50ec7a2e0804010743y3ba876na991522cdde85858@mail.gmail.com>
References: <50ec7a2e0803311405t593c3d60t79a29b4be8f05da2@mail.gmail.com>
	<D737AE2A-A061-47EB-8CBB-E0B229FAB0CB@gmail.com>
	<50ec7a2e0804010743y3ba876na991522cdde85858@mail.gmail.com>
Message-ID: <3CC38417-7E96-4980-BB75-B3AF08A73A17@gmail.com>

Joe,

When you publish a message to an AMQP broker using the Basic Publish  
command you are sending an message asynchronously to an exchange.

In doing so, you need to provide a routing key that the broker uses to  
determine where to deliver the message to.

Hence channels don't directly send messages to a queue using the  
Publish command.

Therefore you can have multiple channels deliver to a single queue if  
the routing keys match to one particular bound queue.

HTH,

Ben

On 1 Apr 2008, at 15:43, Joe Lee wrote:

> I did a quick search and educated myself bit on enterprise  
> integration.  It seems publish-subscribe model doesn't have any  
> queue.  Message published from the publisher first stored in  
> publisher's memory and transfered to the channel on the background.   
> Then the message get stored into memory of the consumer and the  
> consumer consumes the message from its memory.
>
> I need something along the line of amazon sqs, asynchronous with  
> queue.  This maybe a silly question to someone who is into  
> enterprise integration.  If I go with synchronous message passing,  
> can I have, for example, multiple different channels sending  
> messages to a single queue?  I just want to avoid channel being the  
> bottleneck.
>
> thank you,
> Joe
>
>
> On Mon, Mar 31, 2008 at 5:33 PM, Ben Hood <0x6e6562 at gmail.com> wrote:
> Joe,
>
> On 31 Mar 2008, at 22:05, joe lee wrote:
>> Anyone knows how to do a basic publish (asynchronous method, no  
>> syncing with broker) using erlang-client, either in amqp mode or  
>> erlang mode?
>
> If I understand you correctly, if you want to publish a message, you  
> can do the following:
>
> BasicPublish = #'basic.publish'{ticket = Ticket, exchange = X,
>                                     routing_key = RoutingKey,
>                                     mandatory = Mandatory,
>                                     immediate = Immediate},
> Content = #content{class_id = 60,
>          properties = amqp_util:basic_properties(), %% either  
> 'none', or a decoded record/tuple
>          properties_bin = 'none', %% either 'none', or an encoded  
> properties amqp_util:binary
>          %% Note: at most one of properties and properties_bin can  
> be 'none' at once.
>          payload_fragments_rev = [Payload] %% list of binaries, in  
> reverse order (!)
>         },
> amqp_channel:cast(Channel, BasicPublish, Content),
>
> This code is taken from the setup_publish/3 function in the  
> test_util module of the Erlang client.
>
> The cast/3 function in amqp_channel sends the message asynchronously  
> irrespective of whether you are using the TCP variant or native  
> Erlang messaging.
>
> BTW, what do you mean when you say "amqp mode or erlang mode"?
>
>> I have a queue and need to send message to the queue asynchronously  
>> and consumer will come along and process it.  If you are doing  
>> publish-subscribe, do you define a queue like you do for  
>> sysnchronous method?
>
> I'm not quite sure I follow. Which synchronous method are you  
> referring to?
>
> HTH,
>
> Ben
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080401/da672aec/attachment.htm 

From 0x6e6562 at gmail.com  Tue Apr  1 17:50:43 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 1 Apr 2008 17:50:43 +0100
Subject: [rabbitmq-discuss] RabbitMQ 1.3.0 released
In-Reply-To: <47F2155C.9040202@lshift.net>
References: <47F2155C.9040202@lshift.net>
Message-ID: <98B47DF8-6986-493E-A483-78EC7DA67CA4@gmail.com>

Excellent. I have just tested the AS3 client with the 1.3.0 release  
and it works fine.

Ben

On 1 Apr 2008, at 11:58, Matthias Radestock wrote:

> The RabbitMQ team is pleased to announce the release of RabbitMQ  
> 1.3.0.
>
> This release has beta status and focuses on the following areas:
>
> - bug fixes for a number of race conditions and non-compliances with  
> the
>  protocol specification
> - several bug fixes and performance improvements for persistent
>  messaging
> - bug fixes in Debian and RPM packaging
> - improved error reporting
> - improved performance
> - more examples
>
> For details see the attached release notes.
>
> Binary and source distributions of the new release can be found in  
> the usual place, at http://www.rabbitmq.com/download.html
>
> We recommend that all users of earlier versions of RabbitMQ upgrade  
> to this latest release.
>
> As always, we welcome any questions, bug reports, and other feedback  
> on this release, as well as general suggestions for features and  
> enhancements in future releases. Mail us via the RabbitMQ discussion  
> list at rabbitmq-discuss at lists.rabbitmq.com, or directly at info at rabbitmq.com 
> .
>
> We have already started work on the next major release of RabbitMQ,  
> which will see a rewrite of the server in Fortran, for improved  
> performance and reduction in code size.
>
>
> Regards,
>
> The RabbitMQ Team
> Release: RabbitMQ 1.3.0
> Status : beta
>
> Release Highlights
> ==================
>
> server
> ------
> bug fixes
> - eliminate a number of race conditions that could result in message
>  loss and other incorrect or unusual behaviour
> - eliminate duplication of messages when bindings overlap
> - prevent unbounded memory usage when topic exchanges encounter
>  messages with highly variable routing keys
> - redesigned persister so it works properly in a clustered broker
> - fix a couple of bugs that could cause persisted messages to stick
>  around forever, resulting in an unbounded memory usage
> - prevent performance drop under high load
> - do not requeue messages on tx.rollback
> - fix bug in heartbeat logic that could result in a connection
>  remaining alive even though the client had stopped sending any data
> - correct handling of queue.bind with empty routing key and queue name
> - complain about acks with an unknown delivery tag
> - prevent sending of zero-length content body frames
>
> enhancements
> - improve error reporting for various framing-related errors
> - improve rabbitmq-multi robustness and error reporting
> - identify log locations in startup message
> - keep log file contents on server restart
> - support QPid's extended field types
> - improve performance, particularly for persistent messaging
> - re-architect internals to eliminate some code duplication, reduce
>  component dependencies, and construct cleaner internal APIs
>
> Java client
> -----------
> bug fixes
> - eliminate edge case that could result in stuck AMQConnection.close
> - use linear timers to prevent heartbeat timeouts on system clock
>  adjustment, which happens in some virtualisation platforms
> - eliminate a race condition that could result in an exception when
>  establishing a connection
>
> enhancements
> - add SSL support
> - improve error reporting for various framing-related errors
> - add new FileProducer/Consumer example
> - make MulticastMain example more versatile, with improved command
>  line options
> - improve performance
>
> packaging
> ---------
> bug fixes
> - fix broken 'rabbitmqctl -n' on Debian
> - fix broken removal of the rabbitmq-server Debian package
> - fix broken Erlang library installation on 64bit RPM-based systems
> - fix failure of server shutdown when started at boot time on Debian
> - fix various problems with RPMs
>
> improvements
> - better compliance with debian packaging policies
>
>
> Upgrading
> =========
>
> Care must be taken when upgrading a server that contains persisted
> messages. The persister log format has changed between RabbitMQ-1.2.0
> and this release. When RabbitMQ-1.3.0 first starts following an
> upgrade it will move the existing persister log to a backup file -
> check the log files for details. Thus the previously persisted
> messages are not lost, but neither are they replayed. Therefore it is
> recommended that the upgrade is performed only when there are no
> important persistent messages remaining.
>
>
> Credits
> =======
>
> We would like to thank the following individuals for submitting bug
> reports and feedback that we incorporated into this release:
>
> Andrew Munn
> Barry Pederson
> Ben Hood
> David Pollak
> Emmanuel Okyere
> Joe Lee
> John Leuner
> Matt Darling
> Michael Arnoldus
> Nick Levine
> Tom Samplonius
> Willem van Heemstra
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss




From matthias at lshift.net  Wed Apr  2 20:33:40 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 02 Apr 2008 20:33:40 +0100
Subject: [rabbitmq-discuss] Fwd: Fwd: Fw: Errors using Windows
 .NET	Client Library
In-Reply-To: <47F196DD.4010304@lshift.net>
References: <576457.59276.qm@web808.biz.mail.mud.yahoo.com>
	<47F196DD.4010304@lshift.net>
Message-ID: <47F3DF94.6010503@lshift.net>

Bill,

Matthias Radestock wrote:
> I have run the exes of both apps against the broker at dev.rabbitmq.com 
> and everything worked fine - the subscriber is happily waiting for 
> messages to arrive and printing them.
> 
> That was using mono on debian though. You may want to consider switching 
> to that ;)
> 
> I'll try WinXP tomorrow.

I still haven't found the time to do that, but it turns out we recently 
had a similar problem reported by somebody else and believe the issue 
may be specific to Vista. Exactly what flavour of Windows are you running?

The client library uses socket receive-timeouts as part of the 
heartbeating process and we suspect the problem may lay in that area. To 
see whether that is the case, try setting the 
ConnectionParameters.RequestedHeartbeat property to 0 before you open 
the connection. The RabbitMQ server will honour this, interpreting it as 
a request for no heartbeating at all.

ConnectionFactory factory = new ConnectionFactory();
factory.Parameters.RequestedHeartbeat = 0;
IProtocol protocol = Protocols.FromEnvironment();
IConnection conn = factory.CreateConnection(protocol, hostName, portNumber);

Also, I'd be very interested in the value of the ErrorCode property on 
the SocketException that's being thrown, if you get an opportunity to do 
a bit of digging, perhaps by compiling the code yourself or by using a 
debugger against the precompiled library to find out.


Regards,

Matthias.



From yhe at usatech.com  Thu Apr  3 15:41:53 2008
From: yhe at usatech.com (Ying He)
Date: Thu, 3 Apr 2008 10:41:53 -0400
Subject: [rabbitmq-discuss] rabbitmq Mnesia database
Message-ID: <DC162902A1CB844CBEF4A6753064B42D03584070@usamal03.usatech.com>

Hi, All,

 

If I have a rabbitmq server running on localhost and the
producers/consumers are using realm "/data", queue name "queuename" , do
you know what is the way to examine the data in mnesia database?

 

Which table should we look for the messages being exchanged for
producers/consumers?

 

Thank you. 

 

Best,

Ying

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080403/601c8fa5/attachment.htm 

From matthias at lshift.net  Thu Apr  3 20:11:18 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 03 Apr 2008 20:11:18 +0100
Subject: [rabbitmq-discuss] rabbitmq Mnesia database
In-Reply-To: <DC162902A1CB844CBEF4A6753064B42D03584070@usamal03.usatech.com>
References: <DC162902A1CB844CBEF4A6753064B42D03584070@usamal03.usatech.com>
Message-ID: <47F52BD6.4090409@lshift.net>

Ying,

Ying He wrote:
> If I have a rabbitmq server running on localhost and the 
> producers/consumers are using realm ?/data?, queue name ?queuename? , do 
> you know what is the way to examine the data in mnesia database?
> 
> Which table should we look for the messages being exchanged for 
> producers/consumers?

AMQP messages do not pass through mnesia. Mnesia only stores routing and 
administrative data.

What are you trying to accomplish? Do you want to inspect the messages 
currently held by the queue "queuename"? There isn't really a convenient 
way of doing that. You would have to inspect the state of the running 
Erlang process for that queue.


Matthias.



From yhe at usatech.com  Thu Apr  3 21:16:45 2008
From: yhe at usatech.com (Ying He)
Date: Thu, 3 Apr 2008 16:16:45 -0400
Subject: [rabbitmq-discuss] rabbitmq Mnesia database
In-Reply-To: <47F52BD6.4090409@lshift.net>
References: <DC162902A1CB844CBEF4A6753064B42D03584070@usamal03.usatech.com>
	<47F52BD6.4090409@lshift.net>
Message-ID: <DC162902A1CB844CBEF4A6753064B42D03584074@usamal03.usatech.com>

Hi, Mathias,
Yes, we want to inspect the messages currently held by the queue
"queuename". I sent to the mailist before to suggest it will be good to
see how many messages has been gone through the queue, how many are
still being held...

If you can advise how to use running erlang to inspect the queue with
its message, that will be great. Thank you.

Best,
Ying

-----Original Message-----
From: Matthias Radestock [mailto:matthias at lshift.net] 
Sent: Thursday, April 03, 2008 3:11 PM
To: Ying He
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] rabbitmq Mnesia database

Ying,

Ying He wrote:
> If I have a rabbitmq server running on localhost and the 
> producers/consumers are using realm "/data", queue name "queuename" ,
do 
> you know what is the way to examine the data in mnesia database?
> 
> Which table should we look for the messages being exchanged for 
> producers/consumers?

AMQP messages do not pass through mnesia. Mnesia only stores routing and

administrative data.

What are you trying to accomplish? Do you want to inspect the messages 
currently held by the queue "queuename"? There isn't really a convenient

way of doing that. You would have to inspect the state of the running 
Erlang process for that queue.


Matthias.



From matthias at lshift.net  Thu Apr  3 23:15:46 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 03 Apr 2008 23:15:46 +0100
Subject: [rabbitmq-discuss] rabbitmq Mnesia database
In-Reply-To: <DC162902A1CB844CBEF4A6753064B42D03584074@usamal03.usatech.com>
References: <DC162902A1CB844CBEF4A6753064B42D03584070@usamal03.usatech.com>	<47F52BD6.4090409@lshift.net>
	<DC162902A1CB844CBEF4A6753064B42D03584074@usamal03.usatech.com>
Message-ID: <47F55712.8000502@lshift.net>

Ying,

Ying He wrote:

> Yes, we want to inspect the messages currently held by the queue
> "queuename". I sent to the mailist before to suggest it will be good to
> see how many messages has been gone through the queue, how many are
> still being held...

Right. As noted then, the closest we have is rabbit_amqqueue:stat_all(). 
That only gives you a message count though. You can get at the messages 
by inspecting the process state, but that involves some quite low-level 
hacking of RabbitMQ internals.

The RabbitMQ management interface is still being designed, and the same 
goes for the efforts in that area by the AMQP working group. Requests 
like the above are most welcome since they help steer us in the right 
direction.


Matthias.



From alexis.richardson at cohesiveft.com  Fri Apr  4 00:20:16 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Thu, 3 Apr 2008 16:20:16 -0700
Subject: [rabbitmq-discuss] rabbitmq Mnesia database
In-Reply-To: <47F55712.8000502@lshift.net>
References: <DC162902A1CB844CBEF4A6753064B42D03584070@usamal03.usatech.com>
	<47F52BD6.4090409@lshift.net>
	<DC162902A1CB844CBEF4A6753064B42D03584074@usamal03.usatech.com>
	<47F55712.8000502@lshift.net>
Message-ID: <167204d20804031620m3b855119lc318d389ae6c4337@mail.gmail.com>

Ying, and other folks interested in management,

To add to what Matthias has said, would it be useful for us to provide
more detail on how to use rabbit_amqqueue:stat_all() to show message
counts?

alexis


On Thu, Apr 3, 2008 at 3:15 PM, Matthias Radestock <matthias at lshift.net> wrote:
> Ying,
>
>
>  Ying He wrote:
>
>  > Yes, we want to inspect the messages currently held by the queue
>  > "queuename". I sent to the mailist before to suggest it will be good to
>  > see how many messages has been gone through the queue, how many are
>  > still being held...
>
>  Right. As noted then, the closest we have is rabbit_amqqueue:stat_all().
>  That only gives you a message count though. You can get at the messages
>  by inspecting the process state, but that involves some quite low-level
>  hacking of RabbitMQ internals.
>
>  The RabbitMQ management interface is still being designed, and the same
>  goes for the efforts in that area by the AMQP working group. Requests
>  like the above are most welcome since they help steer us in the right
>  direction.
>
>
>
>
>  Matthias.
>
>  _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From alexis.richardson at cohesiveft.com  Fri Apr  4 11:56:34 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Fri, 4 Apr 2008 11:56:34 +0100
Subject: [rabbitmq-discuss] Newton + Mule + RabbitMQ --- (Was: NPE in
	RpcClient)
Message-ID: <167204d20804040356w4d48e4a7t9f02acd4582d0683@mail.gmail.com>

Neil,

Please could I post the link for your Newton-Mule-RabbitMQ demo to the
list, plus a description of how to use it?

Everyone,

We were able to fix a lot of the issues in the RpcClient discussion
below.  For Mule users, please see the Mule Forge for any patches.
Neil has done a really cool demo that uses Newton to set up a bunch of
Mules and Rabbits performing a distributed workflow, which in the demo
is a news feed and image processor for a notional news aggregator.

alexis





On Sun, Mar 16, 2008 at 1:43 AM, Neil Ellis <neil.ellis at mangala.co.uk> wrote:
>
>
>  The mule configs are:
>
>
>  ------
>
>   <mule-descriptor name="Poller"
> implementation="org.mule.components.simple.BridgeComponent">
>
>             <inbound-router>
>                 <endpoint
> address="http://newsrss.bbc.co.uk/rss/newsonline_uk_edition/front_page/rss.xml"
>                           connector="pollingHttp">
>                     <properties>
>                         <property name="pollingFrequency" value="10000"/>
>                     </properties>
>                 </endpoint>
>             </inbound-router>
>
>             <outbound-router>
>                 <router
> className="org.mule.routing.outbound.FilteringXmlMessageSplitter">
>                     <endpoint address="amqp://news:fanout/?routing_key=news"
> synchronous="false" transformers="DOM2String">
>                         <filter expectedType="org.dom4j.Document"
>
> className="org.mule.routing.filters.PayloadTypeFilter"/>
>                     </endpoint>
>                     <reply-to
> address="amqp://result:fanout/?routing_key=result"/>
>                     <properties>
>                         <property name="splitExpression"
> value="/rss/channel/item"/>
>                         <property name="validateSchema" value="false"/>
>                     </properties>
>                 </router>
>             </outbound-router>
>
>         </mule-descriptor>
>
>  -----
>
>         <mule-descriptor name="Worker"
> implementation="org.mule.components.simple.PassThroughComponent">
>             <inbound-router>
>                 <endpoint address="amqp://news:fanout/?queue=news"
> transformers="RSSToHeadline" synchronous="false" />
>             </inbound-router>
>         </mule-descriptor>
>
>  -----
>
>         <mule-descriptor name="SimpleReceiver"
> implementation="org.mule.components.simple.EchoComponent">
>             <inbound-router>
>                 <endpoint address="amqp://result:fanout/?queue=result"/>
>             </inbound-router>
>             <outbound-router>
>                 <router
> className="org.mule.routing.outbound.OutboundPassThroughRouter">
>                     <endpoint address="stream://System.out"/>
>                 </router>
>             </outbound-router>
>         </mule-descriptor>
>
>  ----
>
>
>  The above are on 3 different instances of Mule on the same physical
> machine, the RabbitMQ server is running on a seperate VM. The exception is
> below:
>
>  > [03-16 00:37:00] ERROR DefaultExceptionStrategy [RabbitMQ.dispatcher.15]:
> Caught exception in Exception Strategy: Socket closed
>  java.net.SocketException: Socket closed
>         at
> java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:99)
>         at java.net.SocketOutputStream.write(SocketOutputStream.java:115)
>         at java.io.DataOutputStream.writeByte(DataOutputStream.java:136)
>         at com.rabbitmq.client.impl.Frame.writeTo(Frame.java:189)
>         at
> com.rabbitmq.client.impl.SocketFrameHandler.writeFrame(SocketFrameHandler.java:146)
>         at
> com.rabbitmq.client.impl.AMQConnection.writeFrame(AMQConnection.java:295)
>         at com.rabbitmq.client.impl.AMQCommand.transmit(AMQCommand.java:175)
>         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:370)
>         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:351)
>         at com.rabbitmq.client.RpcClient.publish(RpcClient.java:163)
>         at
> com.rabbitmq.mule.transport.RabbitDispatcher.doDispatch(RabbitDispatcher.java:78)
>
>  I'm taking another look at the code right now to see if I can figure out
> what's going wrong.
>
>  Kind regards
>  Neil
>
>
>  On 15 Mar 2008, at 18:42, Ross Mason wrote:
>
>
> > Hi Neil,
> >
> > This does sound interesting.  There is still a fair way to go on the
> > Mule Rabbit Transport, but there are some simple use cases that work.
> > What is the problem you have with A -> B -> C? is it that the message
> > doesn't get to C? If so, Are you trying to perform an RPC call from A?
> > (i.e.  RPC from A to get a response from C via B).
> >
> > BTW Guys, I would like to do a Beta release of the Rabbit Connector
> > before MuleCon, but right now I snowed under this weekend.
> >
> > Cheers,
> >
> > Ross Mason
> > CTO, Co-Founder
> > MuleSource Inc.
> >
> > http://mulesource.com | http://blog.rossmason.com
> >
> >
> > On 15 Mar 2008, at 17:22, Neil Ellis wrote:
> >
> >
> > > Hi Alexis
> > >
> > > No probs.
> > >
> > > Alas I don't have the budget for jet-setting :-(
> > >
> > > I've been having problems with getting the Mule connector to handle
> > > A->B->C messages although A->B seems okay. If anyone from the
> > > RabbitMQ side could give me a little hand on getting it up and
> > > running that would be fabulous - I'm pretty busy at the moment
> > > between this work and project:Einstein/deesel (
> http://einstein.codecauldron.org
> > > / http://deesel.codecauldron.org ) so any help would increase the
> > > chances of having a demo ready for you.
> > >
> > > I've restructured the current demo to show
> > >
> > > 1 Polller Mule instance reading from an RSS feed.
> > > 3-5 Worker Mule instances transforming the feed (at least a notional
> > > idea of work).
> > > 1 Displayer Mule instance displaying the transformed results to the
> > > screen.
> > >
> > > It's a bit noddy but it shows how Newton can distribute a set of
> > > Mule nodes based upon simple criteria, so on a single Newton
> > > instance you would have all the Mule instances at the same time on
> > > one instance, on 7 instances you would have 1 poller, 3-5 workers
> > > and 1 displayer - and in between it scales appropriately. And then
> > > shows RabbitMQ as the internode protocol. We could easily turn this
> > > into a demo of running RabbitMQ on a large number of nodes with
> > > super-easy deployment and failover in the future - that's something
> > > to think about.
> > >
> > > We could certainly help with providing materials (i.e. slides or
> > > user guide) and help getting you running the demo before hand - in
> > > return would you be able to ensure that Paremus/myself get
> > > appropriate credit at the demo for our part (i.e. powered by Newton
> > > and the appropriate links)?
> > >
> > > Anyway let us know - I'm on Skype most of the time - I think you
> > > have me as a contact (neilellis).
> > >
> > > All the best
> > > Neil
> > >
> > >
> > > On 15 Mar 2008, at 12:16, Alexis Richardson wrote:
> > >
> > >
> > > > Neil
> > > >
> > > > Thank-you very much.  That sounds like a really interesting demo.
> > > > Please let us know how you get on.  Also - will you be at MuleCon?  I
> > > > am going and would love to show anything you have to folks at the
> > > > conference.
> > > >
> > > > alexis
> > > >
> > > >
> > > > On Thu, Mar 13, 2008 at 5:48 PM, Neil Ellis
> > > > <neil.ellis at mangala.co.uk> wrote:
> > > >
> > > > > Hi Folks
> > > > >
> > > > > Not sure if this has already been reported; in version 1.2.0 of lib-
> > > > > rabbitmq there is a NPE if the publish() method has been called on
> > > > > RpcClient because the temp queue picks it up and attempts to call
> > > > > setBody() on the blocker. Trivially chaning blocker.set(body) to
> > > > > have
> > > > > a NP check fixes this:
> > > > >
> > > > >                 if(blocker != null) {
> > > > >                         blocker.set(body);
> > > > >                  }
> > > > >
> > > > > This was line 150 of RpcClient. I've cc-ed the list for the mule
> > > > > transport as it is the mule transport using publish() that caused my
> > > > > problem.
> > > > >
> > > > > Btw. The website for the work I'm doing is
> http://mule4newton.codecauldron.org/mule4newton-examples/mule4newton-rabbitmq/index.html
> > > > > and the src is at
> http://svn.codecauldron.org/mule4newton/trunk/examples/rabbitmq/
> > > > > - basically we're combining Newton, Mule and RabbitMQ as an
> > > > > illustration of a flexible open-source based messaging system.
> > > > >
> > > > > Kind regards
> > > > > Neil
> > > > >
> > > > >
> > > > > _______________________________________________
> > > > > rabbitmq-discuss mailing list
> > > > > rabbitmq-discuss at lists.rabbitmq.com
> > > > > http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> > > > >
> > > > >
> > > > >
> > > >
> > > >
> > > >
> > > > --
> > > > Alexis Richardson
> > > > +44 20 7617 7339 (UK)
> > > > +44 77 9865 2911 (cell)
> > > > +1 650 206 2517 (US)
> > > >
> > >
> > >
> >
> >
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-discuss at lists.rabbitmq.com
> > http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> >
>
>
> _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From neil.ellis at mangala.co.uk  Fri Apr  4 12:50:04 2008
From: neil.ellis at mangala.co.uk (Neil Ellis)
Date: Fri, 4 Apr 2008 12:50:04 +0100
Subject: [rabbitmq-discuss] Newton + Mule + RabbitMQ --- (Was: NPE in
	RpcClient)
In-Reply-To: <167204d20804040356w4d48e4a7t9f02acd4582d0683@mail.gmail.com>
References: <167204d20804040356w4d48e4a7t9f02acd4582d0683@mail.gmail.com>
Message-ID: <6BCF14D3-387E-42A3-ADCF-8663468849B9@mangala.co.uk>

I'll put out some notes later today about issues and the fixes I  
used.  I noticed we're still getting lifecycle issues in Mule 1.4.3 -  
I notice this in the ActiveMQ version also. It seems that listeners  
are becoming active before the components are ready to receive  
messages. I'll try and get round to posting the details onto the Mule  
lists.

We need to have a patched Mule connector and (as long as the NPE is  
fixed) RabbitMQ 1.3, I'll then create a page in the http://mule4newton.codecauldron.org 
  microsite with all the instructions and downloadables as well as a  
link to ESOD if we can get round the issues with multicast (which I  
would have thought we can?).

I need to clarify that the demo for RabbitMQ is only text based at the  
moment, I will switch back to the GUI when I have space to breathe !!!

Kind regards
Neil


On 4 Apr 2008, at 11:56, Alexis Richardson wrote:

> Neil,
>
> Please could I post the link for your Newton-Mule-RabbitMQ demo to the
> list, plus a description of how to use it?
>
> Everyone,
>
> We were able to fix a lot of the issues in the RpcClient discussion
> below.  For Mule users, please see the Mule Forge for any patches.
> Neil has done a really cool demo that uses Newton to set up a bunch of
> Mules and Rabbits performing a distributed workflow, which in the demo
> is a news feed and image processor for a notional news aggregator.
>
> alexis
>
>
>
>
>
> On Sun, Mar 16, 2008 at 1:43 AM, Neil Ellis  
> <neil.ellis at mangala.co.uk> wrote:
>>
>>
>> The mule configs are:
>>
>>
>> ------
>>
>>  <mule-descriptor name="Poller"
>> implementation="org.mule.components.simple.BridgeComponent">
>>
>>            <inbound-router>
>>                <endpoint
>> address="http://newsrss.bbc.co.uk/rss/newsonline_uk_edition/front_page/rss.xml 
>> "
>>                          connector="pollingHttp">
>>                    <properties>
>>                        <property name="pollingFrequency"  
>> value="10000"/>
>>                    </properties>
>>                </endpoint>
>>            </inbound-router>
>>
>>            <outbound-router>
>>                <router
>> className="org.mule.routing.outbound.FilteringXmlMessageSplitter">
>>                    <endpoint address="amqp://news:fanout/?routing_key=news 
>> "
>> synchronous="false" transformers="DOM2String">
>>                        <filter expectedType="org.dom4j.Document"
>>
>> className="org.mule.routing.filters.PayloadTypeFilter"/>
>>                    </endpoint>
>>                    <reply-to
>> address="amqp://result:fanout/?routing_key=result"/>
>>                    <properties>
>>                        <property name="splitExpression"
>> value="/rss/channel/item"/>
>>                        <property name="validateSchema"  
>> value="false"/>
>>                    </properties>
>>                </router>
>>            </outbound-router>
>>
>>        </mule-descriptor>
>>
>> -----
>>
>>        <mule-descriptor name="Worker"
>> implementation="org.mule.components.simple.PassThroughComponent">
>>            <inbound-router>
>>                <endpoint address="amqp://news:fanout/?queue=news"
>> transformers="RSSToHeadline" synchronous="false" />
>>            </inbound-router>
>>        </mule-descriptor>
>>
>> -----
>>
>>        <mule-descriptor name="SimpleReceiver"
>> implementation="org.mule.components.simple.EchoComponent">
>>            <inbound-router>
>>                <endpoint address="amqp://result:fanout/? 
>> queue=result"/>
>>            </inbound-router>
>>            <outbound-router>
>>                <router
>> className="org.mule.routing.outbound.OutboundPassThroughRouter">
>>                    <endpoint address="stream://System.out"/>
>>                </router>
>>            </outbound-router>
>>        </mule-descriptor>
>>
>> ----
>>
>>
>> The above are on 3 different instances of Mule on the same physical
>> machine, the RabbitMQ server is running on a seperate VM. The  
>> exception is
>> below:
>>
>>> [03-16 00:37:00] ERROR DefaultExceptionStrategy  
>>> [RabbitMQ.dispatcher.15]:
>> Caught exception in Exception Strategy: Socket closed
>> java.net.SocketException: Socket closed
>>        at
>> java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:99)
>>        at java.net.SocketOutputStream.write(SocketOutputStream.java: 
>> 115)
>>        at java.io.DataOutputStream.writeByte(DataOutputStream.java: 
>> 136)
>>        at com.rabbitmq.client.impl.Frame.writeTo(Frame.java:189)
>>        at
>> com 
>> .rabbitmq 
>> .client.impl.SocketFrameHandler.writeFrame(SocketFrameHandler.java: 
>> 146)
>>        at
>> com 
>> .rabbitmq.client.impl.AMQConnection.writeFrame(AMQConnection.java: 
>> 295)
>>        at  
>> com.rabbitmq.client.impl.AMQCommand.transmit(AMQCommand.java:175)
>>        at  
>> com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:370)
>>        at  
>> com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:351)
>>        at com.rabbitmq.client.RpcClient.publish(RpcClient.java:163)
>>        at
>> com 
>> .rabbitmq 
>> .mule.transport.RabbitDispatcher.doDispatch(RabbitDispatcher.java:78)
>>
>> I'm taking another look at the code right now to see if I can  
>> figure out
>> what's going wrong.
>>
>> Kind regards
>> Neil
>>
>>
>> On 15 Mar 2008, at 18:42, Ross Mason wrote:
>>
>>
>>> Hi Neil,
>>>
>>> This does sound interesting.  There is still a fair way to go on the
>>> Mule Rabbit Transport, but there are some simple use cases that  
>>> work.
>>> What is the problem you have with A -> B -> C? is it that the  
>>> message
>>> doesn't get to C? If so, Are you trying to perform an RPC call  
>>> from A?
>>> (i.e.  RPC from A to get a response from C via B).
>>>
>>> BTW Guys, I would like to do a Beta release of the Rabbit Connector
>>> before MuleCon, but right now I snowed under this weekend.
>>>
>>> Cheers,
>>>
>>> Ross Mason
>>> CTO, Co-Founder
>>> MuleSource Inc.
>>>
>>> http://mulesource.com | http://blog.rossmason.com
>>>
>>>
>>> On 15 Mar 2008, at 17:22, Neil Ellis wrote:
>>>
>>>
>>>> Hi Alexis
>>>>
>>>> No probs.
>>>>
>>>> Alas I don't have the budget for jet-setting :-(
>>>>
>>>> I've been having problems with getting the Mule connector to handle
>>>> A->B->C messages although A->B seems okay. If anyone from the
>>>> RabbitMQ side could give me a little hand on getting it up and
>>>> running that would be fabulous - I'm pretty busy at the moment
>>>> between this work and project:Einstein/deesel (
>> http://einstein.codecauldron.org
>>>> / http://deesel.codecauldron.org ) so any help would increase the
>>>> chances of having a demo ready for you.
>>>>
>>>> I've restructured the current demo to show
>>>>
>>>> 1 Polller Mule instance reading from an RSS feed.
>>>> 3-5 Worker Mule instances transforming the feed (at least a  
>>>> notional
>>>> idea of work).
>>>> 1 Displayer Mule instance displaying the transformed results to the
>>>> screen.
>>>>
>>>> It's a bit noddy but it shows how Newton can distribute a set of
>>>> Mule nodes based upon simple criteria, so on a single Newton
>>>> instance you would have all the Mule instances at the same time on
>>>> one instance, on 7 instances you would have 1 poller, 3-5 workers
>>>> and 1 displayer - and in between it scales appropriately. And then
>>>> shows RabbitMQ as the internode protocol. We could easily turn this
>>>> into a demo of running RabbitMQ on a large number of nodes with
>>>> super-easy deployment and failover in the future - that's something
>>>> to think about.
>>>>
>>>> We could certainly help with providing materials (i.e. slides or
>>>> user guide) and help getting you running the demo before hand - in
>>>> return would you be able to ensure that Paremus/myself get
>>>> appropriate credit at the demo for our part (i.e. powered by Newton
>>>> and the appropriate links)?
>>>>
>>>> Anyway let us know - I'm on Skype most of the time - I think you
>>>> have me as a contact (neilellis).
>>>>
>>>> All the best
>>>> Neil
>>>>
>>>>
>>>> On 15 Mar 2008, at 12:16, Alexis Richardson wrote:
>>>>
>>>>
>>>>> Neil
>>>>>
>>>>> Thank-you very much.  That sounds like a really interesting demo.
>>>>> Please let us know how you get on.  Also - will you be at  
>>>>> MuleCon?  I
>>>>> am going and would love to show anything you have to folks at the
>>>>> conference.
>>>>>
>>>>> alexis
>>>>>
>>>>>
>>>>> On Thu, Mar 13, 2008 at 5:48 PM, Neil Ellis
>>>>> <neil.ellis at mangala.co.uk> wrote:
>>>>>
>>>>>> Hi Folks
>>>>>>
>>>>>> Not sure if this has already been reported; in version 1.2.0 of  
>>>>>> lib-
>>>>>> rabbitmq there is a NPE if the publish() method has been called  
>>>>>> on
>>>>>> RpcClient because the temp queue picks it up and attempts to call
>>>>>> setBody() on the blocker. Trivially chaning blocker.set(body) to
>>>>>> have
>>>>>> a NP check fixes this:
>>>>>>
>>>>>>                if(blocker != null) {
>>>>>>                        blocker.set(body);
>>>>>>                 }
>>>>>>
>>>>>> This was line 150 of RpcClient. I've cc-ed the list for the mule
>>>>>> transport as it is the mule transport using publish() that  
>>>>>> caused my
>>>>>> problem.
>>>>>>
>>>>>> Btw. The website for the work I'm doing is
>> http://mule4newton.codecauldron.org/mule4newton-examples/mule4newton-rabbitmq/index.html
>>>>>> and the src is at
>> http://svn.codecauldron.org/mule4newton/trunk/examples/rabbitmq/
>>>>>> - basically we're combining Newton, Mule and RabbitMQ as an
>>>>>> illustration of a flexible open-source based messaging system.
>>>>>>
>>>>>> Kind regards
>>>>>> Neil
>>>>>>
>>>>>>
>>>>>> _______________________________________________
>>>>>> rabbitmq-discuss mailing list
>>>>>> rabbitmq-discuss at lists.rabbitmq.com
>>>>>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>>>>>
>>>>>>
>>>>>>
>>>>>
>>>>>
>>>>>
>>>>> --
>>>>> Alexis Richardson
>>>>> +44 20 7617 7339 (UK)
>>>>> +44 77 9865 2911 (cell)
>>>>> +1 650 206 2517 (US)
>>>>>
>>>>
>>>>
>>>
>>>
>>> _______________________________________________
>>> rabbitmq-discuss mailing list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>>
>>
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
>
>
>
> -- 
> Alexis Richardson
> +44 20 7617 7339 (UK)
> +44 77 9865 2911 (cell)
> +1 650 206 2517 (US)

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 2431 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080404/6bdf0297/attachment.bin 

From tonyg at lshift.net  Fri Apr  4 17:06:03 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Fri, 04 Apr 2008 17:06:03 +0100
Subject: [rabbitmq-discuss] Errors using Windows .NET Client Library
In-Reply-To: <576289.25874.qm@web806.biz.mail.mud.yahoo.com>
References: <576289.25874.qm@web806.biz.mail.mud.yahoo.com>
Message-ID: <47F651EB.4090401@lshift.net>

Hi Bill,

The heartbeat issue we've been discussing is possibly related to the
issue in the "troubleshooting" section, ?5.1 of the user manual at
http://www.rabbitmq.com/releases/doc/rabbitmq-dotnet-release_20080125/rabbitmq-dotnet-1.2.8025.1832-user-guide.pdf.

We've seen that issue, the immediate disconnect, on Mono 1.1.17.1 on
Windows as well as just today on Mono 1.2.2.1 on Xandros Linux (on an
EEEpc).

When the problem manifests itself for you, is the disconnect
*immediate*, or is it after about 3 seconds of connection idleness?

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From matthias at lshift.net  Fri Apr  4 20:03:57 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 04 Apr 2008 20:03:57 +0100
Subject: [rabbitmq-discuss] NPE in RpcClient
In-Reply-To: <6EBAC3E4-BA7A-49DC-A759-EE54318BEFF4@mangala.co.uk>
References: <6EBAC3E4-BA7A-49DC-A759-EE54318BEFF4@mangala.co.uk>
Message-ID: <47F67B9D.8000001@lshift.net>

Neil,

Neil Ellis wrote:
> Not sure if this has already been reported; in version 1.2.0 of 
> lib-rabbitmq there is a NPE if the publish() method has been called on 
> RpcClient because the temp queue picks it up and attempts to call 
> setBody() on the blocker. Trivially chaning blocker.set(body) to have a 
> NP check fixes this:
> 
>                    if(blocker != null) {                       
>                         blocker.set(body);
>                     }

Why would you call publish() on the RpcClient? You are meant to be using 
one of
   byte[] primitiveCall(byte[] message)
   String stringCall(String message)
   Map mapCall(Map message)
   Map mapCall(Object[] keyValuePairs)
to perform an RPC.


Matthias.



From neil.ellis at mangala.co.uk  Fri Apr  4 20:10:16 2008
From: neil.ellis at mangala.co.uk (Neil Ellis)
Date: Fri, 4 Apr 2008 20:10:16 +0100
Subject: [rabbitmq-discuss] NPE in RpcClient
In-Reply-To: <47F67B9D.8000001@lshift.net>
References: <6EBAC3E4-BA7A-49DC-A759-EE54318BEFF4@mangala.co.uk>
	<47F67B9D.8000001@lshift.net>
Message-ID: <B925AD96-A41F-4932-AF02-5916FB6DFD50@mangala.co.uk>

Hi Matthias

That's just how it's done in the Mule connector, it's making use of  
the same client for RPC calls and non RPC calls. I think Tony put that  
together so you may want to chat with him, I'm sure Ross would be  
happy to change it if there is a better strategy.

Kind regards
Neil
On 4 Apr 2008, at 20:03, Matthias Radestock wrote:

> Neil,
>
> Neil Ellis wrote:
>> Not sure if this has already been reported; in version 1.2.0 of lib- 
>> rabbitmq there is a NPE if the publish() method has been called on  
>> RpcClient because the temp queue picks it up and attempts to call  
>> setBody() on the blocker. Trivially chaning blocker.set(body) to  
>> have a NP check fixes this:
>>                   if(blocker != null)  
>> {                                               blocker.set(body);
>>                    }
>
> Why would you call publish() on the RpcClient? You are meant to be  
> using one of
>  byte[] primitiveCall(byte[] message)
>  String stringCall(String message)
>  Map mapCall(Map message)
>  Map mapCall(Object[] keyValuePairs)
> to perform an RPC.
>
>
> Matthias.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 2431 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080404/b54e0007/attachment.bin 

From matthias at lshift.net  Fri Apr  4 20:50:13 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 04 Apr 2008 20:50:13 +0100
Subject: [rabbitmq-discuss] NPE in RpcClient
In-Reply-To: <B925AD96-A41F-4932-AF02-5916FB6DFD50@mangala.co.uk>
References: <6EBAC3E4-BA7A-49DC-A759-EE54318BEFF4@mangala.co.uk>	<47F67B9D.8000001@lshift.net>
	<B925AD96-A41F-4932-AF02-5916FB6DFD50@mangala.co.uk>
Message-ID: <47F68675.7030403@lshift.net>

Neil,

Neil Ellis wrote:

> That's just how it's done in the Mule connector, it's making use of the 
> same client for RPC calls and non RPC calls. I think Tony put that 
> together so you may want to chat with him, I'm sure Ross would be happy 
> to change it if there is a better strategy.

Actually, using RpcClient.publish should be perfectly safe, if a little 
weird and undocumented. I cannot see the publish would end up placing 
messages in the reply queue of the same RpcClient. The reply queue is 
given a server-generated name and is bound to the default exchange (""), 
which is a direct exchange. To send a message to the reply queue it 
would have to be sent to the default exchange with a routing key equal 
to the generated queue name. Since both the exchange name and routing 
key are supplied to the constructor of the RpcClient there is no way for 
that to happen.

Instead what I suspect might be causing the problem is an rpc server 
replying to a message twice, or perhaps two rpc servers replying to the 
same message. Do you think that can occur in your set up?

The arrival of the second reply would indeed trigger an NPE. That's 
perhaps not the nicest exception to throw under the circumstances, but 
*some* exception is certainly warranted.


Matthias.



From themuleman at gmail.com  Sat Apr  5 05:39:14 2008
From: themuleman at gmail.com (Ross Mason)
Date: Fri, 4 Apr 2008 21:39:14 -0700
Subject: [rabbitmq-discuss] Newton + Mule + RabbitMQ --- (Was: NPE in
	RpcClient)
In-Reply-To: <6BCF14D3-387E-42A3-ADCF-8663468849B9@mangala.co.uk>
References: <167204d20804040356w4d48e4a7t9f02acd4582d0683@mail.gmail.com>
	<6BCF14D3-387E-42A3-ADCF-8663468849B9@mangala.co.uk>
Message-ID: <0B5B6106-D75D-4809-9295-8F59AC99CA65@gmail.com>




On 4 Apr 2008, at 04:50, Neil Ellis wrote:

> I'll put out some notes later today about issues and the fixes I  
> used.  I noticed we're still getting lifecycle issues in Mule 1.4.3  
> - I notice this in the ActiveMQ version also. It seems that  
> listeners are becoming active before the components are ready to  
> receive messages. I'll try and get round to posting the details onto  
> the Mule lists.
Nicely done Neil, can you raise an issue about the lifecycle. I doubt  
its an issue in 2.0
>
>
> We need to have a patched Mule connector and (as long as the NPE is  
> fixed) RabbitMQ 1.3, I'll then create a page in the http://mule4newton.codecauldron.org 
>  microsite with all the instructions and downloadables as well as a  
> link to ESOD if we can get round the issues with multicast (which I  
> would have thought we can?).
>
no need to patch the Rabbit/Mule connector, you ahve committer rights  
on the MuleForge project.

> I need to clarify that the demo for RabbitMQ is only text based at  
> the moment, I will switch back to the GUI when I have space to  
> breathe !!!
>
> Kind regards
> Neil
>
>
> On 4 Apr 2008, at 11:56, Alexis Richardson wrote:
>
>> Neil,
>>
>> Please could I post the link for your Newton-Mule-RabbitMQ demo to  
>> the
>> list, plus a description of how to use it?
>>
>> Everyone,
>>
>> We were able to fix a lot of the issues in the RpcClient discussion
>> below.  For Mule users, please see the Mule Forge for any patches.
>> Neil has done a really cool demo that uses Newton to set up a bunch  
>> of
>> Mules and Rabbits performing a distributed workflow, which in the  
>> demo
>> is a news feed and image processor for a notional news aggregator.
>>
>> alexis
>>
>>
>>
>>
>>
>> On Sun, Mar 16, 2008 at 1:43 AM, Neil Ellis  
>> <neil.ellis at mangala.co.uk> wrote:
>>>
>>>
>>> The mule configs are:
>>>
>>>
>>> ------
>>>
>>> <mule-descriptor name="Poller"
>>> implementation="org.mule.components.simple.BridgeComponent">
>>>
>>>           <inbound-router>
>>>               <endpoint
>>> address="http://newsrss.bbc.co.uk/rss/newsonline_uk_edition/front_page/rss.xml 
>>> "
>>>                         connector="pollingHttp">
>>>                   <properties>
>>>                       <property name="pollingFrequency"  
>>> value="10000"/>
>>>                   </properties>
>>>               </endpoint>
>>>           </inbound-router>
>>>
>>>           <outbound-router>
>>>               <router
>>> className="org.mule.routing.outbound.FilteringXmlMessageSplitter">
>>>                   <endpoint address="amqp://news:fanout/?routing_key=news 
>>> "
>>> synchronous="false" transformers="DOM2String">
>>>                       <filter expectedType="org.dom4j.Document"
>>>
>>> className="org.mule.routing.filters.PayloadTypeFilter"/>
>>>                   </endpoint>
>>>                   <reply-to
>>> address="amqp://result:fanout/?routing_key=result"/>
>>>                   <properties>
>>>                       <property name="splitExpression"
>>> value="/rss/channel/item"/>
>>>                       <property name="validateSchema"  
>>> value="false"/>
>>>                   </properties>
>>>               </router>
>>>           </outbound-router>
>>>
>>>       </mule-descriptor>
>>>
>>> -----
>>>
>>>       <mule-descriptor name="Worker"
>>> implementation="org.mule.components.simple.PassThroughComponent">
>>>           <inbound-router>
>>>               <endpoint address="amqp://news:fanout/?queue=news"
>>> transformers="RSSToHeadline" synchronous="false" />
>>>           </inbound-router>
>>>       </mule-descriptor>
>>>
>>> -----
>>>
>>>       <mule-descriptor name="SimpleReceiver"
>>> implementation="org.mule.components.simple.EchoComponent">
>>>           <inbound-router>
>>>               <endpoint address="amqp://result:fanout/? 
>>> queue=result"/>
>>>           </inbound-router>
>>>           <outbound-router>
>>>               <router
>>> className="org.mule.routing.outbound.OutboundPassThroughRouter">
>>>                   <endpoint address="stream://System.out"/>
>>>               </router>
>>>           </outbound-router>
>>>       </mule-descriptor>
>>>
>>> ----
>>>
>>>
>>> The above are on 3 different instances of Mule on the same physical
>>> machine, the RabbitMQ server is running on a seperate VM. The  
>>> exception is
>>> below:
>>>
>>>> [03-16 00:37:00] ERROR DefaultExceptionStrategy  
>>>> [RabbitMQ.dispatcher.15]:
>>> Caught exception in Exception Strategy: Socket closed
>>> java.net.SocketException: Socket closed
>>>       at
>>> java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:99)
>>>       at java.net.SocketOutputStream.write(SocketOutputStream.java: 
>>> 115)
>>>       at java.io.DataOutputStream.writeByte(DataOutputStream.java: 
>>> 136)
>>>       at com.rabbitmq.client.impl.Frame.writeTo(Frame.java:189)
>>>       at
>>> com 
>>> .rabbitmq 
>>> .client.impl.SocketFrameHandler.writeFrame(SocketFrameHandler.java: 
>>> 146)
>>>       at
>>> com 
>>> .rabbitmq.client.impl.AMQConnection.writeFrame(AMQConnection.java: 
>>> 295)
>>>       at  
>>> com.rabbitmq.client.impl.AMQCommand.transmit(AMQCommand.java:175)
>>>       at  
>>> com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:370)
>>>       at  
>>> com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:351)
>>>       at com.rabbitmq.client.RpcClient.publish(RpcClient.java:163)
>>>       at
>>> com 
>>> .rabbitmq 
>>> .mule.transport.RabbitDispatcher.doDispatch(RabbitDispatcher.java: 
>>> 78)
>>>
>>> I'm taking another look at the code right now to see if I can  
>>> figure out
>>> what's going wrong.
>>>
>>> Kind regards
>>> Neil
>>>
>>>
>>> On 15 Mar 2008, at 18:42, Ross Mason wrote:
>>>
>>>
>>>> Hi Neil,
>>>>
>>>> This does sound interesting.  There is still a fair way to go on  
>>>> the
>>>> Mule Rabbit Transport, but there are some simple use cases that  
>>>> work.
>>>> What is the problem you have with A -> B -> C? is it that the  
>>>> message
>>>> doesn't get to C? If so, Are you trying to perform an RPC call  
>>>> from A?
>>>> (i.e.  RPC from A to get a response from C via B).
>>>>
>>>> BTW Guys, I would like to do a Beta release of the Rabbit Connector
>>>> before MuleCon, but right now I snowed under this weekend.
>>>>
>>>> Cheers,
>>>>
>>>> Ross Mason
>>>> CTO, Co-Founder
>>>> MuleSource Inc.
>>>>
>>>> http://mulesource.com | http://blog.rossmason.com
>>>>
>>>>
>>>> On 15 Mar 2008, at 17:22, Neil Ellis wrote:
>>>>
>>>>
>>>>> Hi Alexis
>>>>>
>>>>> No probs.
>>>>>
>>>>> Alas I don't have the budget for jet-setting :-(
>>>>>
>>>>> I've been having problems with getting the Mule connector to  
>>>>> handle
>>>>> A->B->C messages although A->B seems okay. If anyone from the
>>>>> RabbitMQ side could give me a little hand on getting it up and
>>>>> running that would be fabulous - I'm pretty busy at the moment
>>>>> between this work and project:Einstein/deesel (
>>> http://einstein.codecauldron.org
>>>>> / http://deesel.codecauldron.org ) so any help would increase the
>>>>> chances of having a demo ready for you.
>>>>>
>>>>> I've restructured the current demo to show
>>>>>
>>>>> 1 Polller Mule instance reading from an RSS feed.
>>>>> 3-5 Worker Mule instances transforming the feed (at least a  
>>>>> notional
>>>>> idea of work).
>>>>> 1 Displayer Mule instance displaying the transformed results to  
>>>>> the
>>>>> screen.
>>>>>
>>>>> It's a bit noddy but it shows how Newton can distribute a set of
>>>>> Mule nodes based upon simple criteria, so on a single Newton
>>>>> instance you would have all the Mule instances at the same time on
>>>>> one instance, on 7 instances you would have 1 poller, 3-5 workers
>>>>> and 1 displayer - and in between it scales appropriately. And then
>>>>> shows RabbitMQ as the internode protocol. We could easily turn  
>>>>> this
>>>>> into a demo of running RabbitMQ on a large number of nodes with
>>>>> super-easy deployment and failover in the future - that's  
>>>>> something
>>>>> to think about.
>>>>>
>>>>> We could certainly help with providing materials (i.e. slides or
>>>>> user guide) and help getting you running the demo before hand - in
>>>>> return would you be able to ensure that Paremus/myself get
>>>>> appropriate credit at the demo for our part (i.e. powered by  
>>>>> Newton
>>>>> and the appropriate links)?
>>>>>
>>>>> Anyway let us know - I'm on Skype most of the time - I think you
>>>>> have me as a contact (neilellis).
>>>>>
>>>>> All the best
>>>>> Neil
>>>>>
>>>>>
>>>>> On 15 Mar 2008, at 12:16, Alexis Richardson wrote:
>>>>>
>>>>>
>>>>>> Neil
>>>>>>
>>>>>> Thank-you very much.  That sounds like a really interesting demo.
>>>>>> Please let us know how you get on.  Also - will you be at  
>>>>>> MuleCon?  I
>>>>>> am going and would love to show anything you have to folks at the
>>>>>> conference.
>>>>>>
>>>>>> alexis
>>>>>>
>>>>>>
>>>>>> On Thu, Mar 13, 2008 at 5:48 PM, Neil Ellis
>>>>>> <neil.ellis at mangala.co.uk> wrote:
>>>>>>
>>>>>>> Hi Folks
>>>>>>>
>>>>>>> Not sure if this has already been reported; in version 1.2.0  
>>>>>>> of lib-
>>>>>>> rabbitmq there is a NPE if the publish() method has been  
>>>>>>> called on
>>>>>>> RpcClient because the temp queue picks it up and attempts to  
>>>>>>> call
>>>>>>> setBody() on the blocker. Trivially chaning blocker.set(body) to
>>>>>>> have
>>>>>>> a NP check fixes this:
>>>>>>>
>>>>>>>               if(blocker != null) {
>>>>>>>                       blocker.set(body);
>>>>>>>                }
>>>>>>>
>>>>>>> This was line 150 of RpcClient. I've cc-ed the list for the mule
>>>>>>> transport as it is the mule transport using publish() that  
>>>>>>> caused my
>>>>>>> problem.
>>>>>>>
>>>>>>> Btw. The website for the work I'm doing is
>>> http://mule4newton.codecauldron.org/mule4newton-examples/mule4newton-rabbitmq/index.html
>>>>>>> and the src is at
>>> http://svn.codecauldron.org/mule4newton/trunk/examples/rabbitmq/
>>>>>>> - basically we're combining Newton, Mule and RabbitMQ as an
>>>>>>> illustration of a flexible open-source based messaging system.
>>>>>>>
>>>>>>> Kind regards
>>>>>>> Neil
>>>>>>>
>>>>>>>
>>>>>>> _______________________________________________
>>>>>>> rabbitmq-discuss mailing list
>>>>>>> rabbitmq-discuss at lists.rabbitmq.com
>>>>>>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>
>>>>>>
>>>>>>
>>>>>> --
>>>>>> Alexis Richardson
>>>>>> +44 20 7617 7339 (UK)
>>>>>> +44 77 9865 2911 (cell)
>>>>>> +1 650 206 2517 (US)
>>>>>>
>>>>>
>>>>>
>>>>
>>>>
>>>> _______________________________________________
>>>> rabbitmq-discuss mailing list
>>>> rabbitmq-discuss at lists.rabbitmq.com
>>>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>>>
>>>
>>>
>>> _______________________________________________
>>> rabbitmq-discuss mailing list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>>
>>>
>>
>>
>>
>> -- 
>> Alexis Richardson
>> +44 20 7617 7339 (UK)
>> +44 77 9865 2911 (cell)
>> +1 650 206 2517 (US)
>




From codewalkerjoe at gmail.com  Sun Apr  6 22:53:04 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Sun, 6 Apr 2008 17:53:04 -0400
Subject: [rabbitmq-discuss] pub-sub erlang problem
Message-ID: <50ec7a2e0804061453v8cef28em84cb95dfc250dd4@mail.gmail.com>

I am trying to get pub-sub model to work in rabbitmq.  My understanding is
that you still have to perform amqp_connection:start,
amqp_connection:open_channel, amqp_channel:call(Channel, Access), channel
close and connection close on each async call.
I am not sure what payload_fragments_rev = [Payload] is for.  I have
searched through amqp xml specs and pdf.  Maybe I am not hitting the right
keywords.  For pub-sub model, how do you assign the message, assign it to
Payload variable?

I am new to erlang.  This shouldn't be a show stopper.  I just need to get
this working.  I am getting following error:

(rabbit at home)1> amqp_async:amqp_lifecycle().
Connection: {<0.217.0>,direct}

=ERROR REPORT==== 6-Apr-2008::16:33:51 ===
Lax ticket check mode: ignoring cross-realm access for ticket 101
** exception exit: {{amqp,not_found,'basic.publish'},
                    {gen_server,call,
                        [<0.218.0>,
                         {call,{'channel.close',200,<<"Goodbye">>,0,0}}]}}
     in function  gen_server:call/2
     in call from amqp_async:amqp_lifecycle/0

my pub-sub code:

-module(amqp_async).

-include_lib("rabbitmq_server/include/rabbit_framing.hrl").
-include_lib("rabbitmq_server/include/rabbit.hrl").

-export([amqp_lifecycle/0]).

amqp_lifecycle() ->
    User = Password = "guest",
    Realm = <<"/data">>,

    %% Start a connection to the server

    Connection = amqp_connection:start(User, Password),
    io:format("Connection: ~p~n",[Connection]),
    %% Once you have a connection to the server, you can start an AMQP
channel gain access to a realm

    Channel = amqp_connection:open_channel(Connection),
    Access = #'access.request'{realm = Realm,
                               exclusive = false,
                               passive = true,
                               active = true,
                               write = true,
                               read = true},
    #'access.request_ok'{ticket = Ticket} = amqp_channel:call(Channel,
Access),

    X = <<"x">>,
    RoutingKey = <<"a.b.c.*">>,
    Payload = <<"foobar">>,
    BasicPublish = #'basic.publish'{ticket = Ticket,
                                    exchange = X,
                                    routing_key = RoutingKey,
                                    mandatory = false,
                                    immediate = false},
    Content = #content{class_id = 60,
         properties = amqp_util:basic_properties(),
         properties_bin = none,
         payload_fragments_rev = [Payload]
        },
    amqp_channel:cast(Channel, BasicPublish, Content),

    %% After you've finished with the channel and connection you should
close them down

    ChannelClose = #'channel.close'{reply_code = 200, reply_text =
<<"Goodbye">>,
                                    class_id = 0, method_id = 0},
    #'channel.close_ok'{} = amqp_channel:call(Channel, ChannelClose),
    ConnectionClose = #'connection.close'{reply_code = 200, reply_text =
<<"Goodbye">>,
                                          class_id = 0, method_id = 0},
    #'connection.close_ok'{} = amqp_connection:close(Connection,
ConnectionClose),
    ok.

Thank you,
Joe
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080406/e41c0ee2/attachment.htm 

From 0x6e6562 at gmail.com  Tue Apr  8 13:00:56 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 8 Apr 2008 13:00:56 +0100
Subject: [rabbitmq-discuss] pub-sub erlang problem
In-Reply-To: <50ec7a2e0804061453v8cef28em84cb95dfc250dd4@mail.gmail.com>
References: <50ec7a2e0804061453v8cef28em84cb95dfc250dd4@mail.gmail.com>
Message-ID: <E11BE3CD-3F00-4F3B-AFF3-6667B4113C32@gmail.com>

Joe,

Sorry about the delay in answering your question.

It looks like you're trying to publish to an exchange that doesn't  
exist, although the server diagnostic could be a little clearer on  
this point.

To fix your test, precede the exchange declare command before the  
publish command, i.e. put this code before the publish call:

ExchangeDeclare = #'exchange.declare'{ticket = Ticket, exchange = X,  
type = <<"topic">>,
                                           passive = false, durable =  
false, auto_delete = false, internal = false,
                                           nowait = false, arguments =  
[]},
#'exchange.declare_ok'{} = amqp_channel:call(Channel, ExchangeDeclare)

We should probably take on board better server diagnostics as an  
improvement item.

HTH,

Ben

On 6 Apr 2008, at 22:53, Joe Lee wrote:

> I am trying to get pub-sub model to work in rabbitmq.  My  
> understanding is that you still have to perform  
> amqp_connection:start, amqp_connection:open_channel,  
> amqp_channel:call(Channel, Access), channel close and connection  
> close on each async call.
> I am not sure what payload_fragments_rev = [Payload] is for.  I have  
> searched through amqp xml specs and pdf.  Maybe I am not hitting the  
> right keywords.  For pub-sub model, how do you assign the message,  
> assign it to Payload variable?
>
> I am new to erlang.  This shouldn't be a show stopper.  I just need  
> to get this working.  I am getting following error:
>
> (rabbit at home)1> amqp_async:amqp_lifecycle().
> Connection: {<0.217.0>,direct}
>
> =ERROR REPORT==== 6-Apr-2008::16:33:51 ===
> Lax ticket check mode: ignoring cross-realm access for ticket 101
> ** exception exit: {{amqp,not_found,'basic.publish'},
>                     {gen_server,call,
>                         [<0.218.0>,
>                          {call,{'channel.close',200,<<"Goodbye">>, 
> 0,0}}]}}
>      in function  gen_server:call/2
>      in call from amqp_async:amqp_lifecycle/0
>
> my pub-sub code:
>
> -module(amqp_async).
>
> -include_lib("rabbitmq_server/include/rabbit_framing.hrl").
> -include_lib("rabbitmq_server/include/rabbit.hrl").
>
> -export([amqp_lifecycle/0]).
>
> amqp_lifecycle() ->
>     User = Password = "guest",
>     Realm = <<"/data">>,
>
>     %% Start a connection to the server
>
>     Connection = amqp_connection:start(User, Password),
>     io:format("Connection: ~p~n",[Connection]),
>     %% Once you have a connection to the server, you can start an  
> AMQP channel gain access to a realm
>
>     Channel = amqp_connection:open_channel(Connection),
>     Access = #'access.request'{realm = Realm,
>                                exclusive = false,
>                                passive = true,
>                                active = true,
>                                write = true,
>                                read = true},
>     #'access.request_ok'{ticket = Ticket} =  
> amqp_channel:call(Channel, Access),
>
>     X = <<"x">>,
>     RoutingKey = <<"a.b.c.*">>,
>     Payload = <<"foobar">>,
>     BasicPublish = #'basic.publish'{ticket = Ticket,
>                                     exchange = X,
>                                     routing_key = RoutingKey,
>                                     mandatory = false,
>                                     immediate = false},
>     Content = #content{class_id = 60,
>          properties = amqp_util:basic_properties(),
>          properties_bin = none,
>          payload_fragments_rev = [Payload]
>         },
>     amqp_channel:cast(Channel, BasicPublish, Content),
>
>     %% After you've finished with the channel and connection you  
> should close them down
>
>     ChannelClose = #'channel.close'{reply_code = 200, reply_text =  
> <<"Goodbye">>,
>                                     class_id = 0, method_id = 0},
>     #'channel.close_ok'{} = amqp_channel:call(Channel, ChannelClose),
>     ConnectionClose = #'connection.close'{reply_code = 200,  
> reply_text = <<"Goodbye">>,
>                                           class_id = 0, method_id =  
> 0},
>     #'connection.close_ok'{} = amqp_connection:close(Connection,  
> ConnectionClose),
>     ok.
>
> Thank you,
> Joe
>
>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss




From stevej at gmail.com  Tue Apr  8 20:02:15 2008
From: stevej at gmail.com (Steve Jenson)
Date: Tue, 8 Apr 2008 12:02:15 -0700
Subject: [rabbitmq-discuss] RabbitMQ and monit?
Message-ID: <81d74c280804081202t6d5e842ct539e345bf2bc6d0e@mail.gmail.com>

Hi,

Does anybody out there use rabbitmq with monit?

Thanks,
Steve



From alexis.richardson at cohesiveft.com  Tue Apr  8 21:50:32 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Tue, 8 Apr 2008 21:50:32 +0100
Subject: [rabbitmq-discuss] pub-sub erlang problem
In-Reply-To: <E11BE3CD-3F00-4F3B-AFF3-6667B4113C32@gmail.com>
References: <50ec7a2e0804061453v8cef28em84cb95dfc250dd4@mail.gmail.com>
	<E11BE3CD-3F00-4F3B-AFF3-6667B4113C32@gmail.com>
Message-ID: <167204d20804081350p4dec4f3cr12cb684acc63ffcd@mail.gmail.com>

Joe

To add to Ben's comment:  If you are new to erlang you may wish to use
the Java client.  There are quite a few documented examples for that,
or you can try the .NET client docs.

Please keep the questions coming!

Best wishes

alexis



On Tue, Apr 8, 2008 at 1:00 PM, Ben Hood <0x6e6562 at gmail.com> wrote:
> Joe,
>
>  Sorry about the delay in answering your question.
>
>  It looks like you're trying to publish to an exchange that doesn't
>  exist, although the server diagnostic could be a little clearer on
>  this point.
>
>  To fix your test, precede the exchange declare command before the
>  publish command, i.e. put this code before the publish call:
>
>  ExchangeDeclare = #'exchange.declare'{ticket = Ticket, exchange = X,
>  type = <<"topic">>,
>                                            passive = false, durable =
>  false, auto_delete = false, internal = false,
>                                            nowait = false, arguments =
>  []},
>  #'exchange.declare_ok'{} = amqp_channel:call(Channel, ExchangeDeclare)
>
>  We should probably take on board better server diagnostics as an
>  improvement item.
>
>  HTH,
>
>  Ben
>
>
>
>  On 6 Apr 2008, at 22:53, Joe Lee wrote:
>
>  > I am trying to get pub-sub model to work in rabbitmq.  My
>  > understanding is that you still have to perform
>  > amqp_connection:start, amqp_connection:open_channel,
>  > amqp_channel:call(Channel, Access), channel close and connection
>  > close on each async call.
>  > I am not sure what payload_fragments_rev = [Payload] is for.  I have
>  > searched through amqp xml specs and pdf.  Maybe I am not hitting the
>  > right keywords.  For pub-sub model, how do you assign the message,
>  > assign it to Payload variable?
>  >
>  > I am new to erlang.  This shouldn't be a show stopper.  I just need
>  > to get this working.  I am getting following error:
>  >
>  > (rabbit at home)1> amqp_async:amqp_lifecycle().
>  > Connection: {<0.217.0>,direct}
>  >
>  > =ERROR REPORT==== 6-Apr-2008::16:33:51 ===
>  > Lax ticket check mode: ignoring cross-realm access for ticket 101
>  > ** exception exit: {{amqp,not_found,'basic.publish'},
>  >                     {gen_server,call,
>  >                         [<0.218.0>,
>  >                          {call,{'channel.close',200,<<"Goodbye">>,
>  > 0,0}}]}}
>  >      in function  gen_server:call/2
>  >      in call from amqp_async:amqp_lifecycle/0
>  >
>  > my pub-sub code:
>  >
>  > -module(amqp_async).
>  >
>  > -include_lib("rabbitmq_server/include/rabbit_framing.hrl").
>  > -include_lib("rabbitmq_server/include/rabbit.hrl").
>  >
>  > -export([amqp_lifecycle/0]).
>  >
>  > amqp_lifecycle() ->
>  >     User = Password = "guest",
>  >     Realm = <<"/data">>,
>  >
>  >     %% Start a connection to the server
>  >
>  >     Connection = amqp_connection:start(User, Password),
>  >     io:format("Connection: ~p~n",[Connection]),
>  >     %% Once you have a connection to the server, you can start an
>  > AMQP channel gain access to a realm
>  >
>  >     Channel = amqp_connection:open_channel(Connection),
>  >     Access = #'access.request'{realm = Realm,
>  >                                exclusive = false,
>  >                                passive = true,
>  >                                active = true,
>  >                                write = true,
>  >                                read = true},
>  >     #'access.request_ok'{ticket = Ticket} =
>  > amqp_channel:call(Channel, Access),
>  >
>  >     X = <<"x">>,
>  >     RoutingKey = <<"a.b.c.*">>,
>  >     Payload = <<"foobar">>,
>  >     BasicPublish = #'basic.publish'{ticket = Ticket,
>  >                                     exchange = X,
>  >                                     routing_key = RoutingKey,
>  >                                     mandatory = false,
>  >                                     immediate = false},
>  >     Content = #content{class_id = 60,
>  >          properties = amqp_util:basic_properties(),
>  >          properties_bin = none,
>  >          payload_fragments_rev = [Payload]
>  >         },
>  >     amqp_channel:cast(Channel, BasicPublish, Content),
>  >
>  >     %% After you've finished with the channel and connection you
>  > should close them down
>  >
>  >     ChannelClose = #'channel.close'{reply_code = 200, reply_text =
>  > <<"Goodbye">>,
>  >                                     class_id = 0, method_id = 0},
>  >     #'channel.close_ok'{} = amqp_channel:call(Channel, ChannelClose),
>  >     ConnectionClose = #'connection.close'{reply_code = 200,
>  > reply_text = <<"Goodbye">>,
>  >                                           class_id = 0, method_id =
>  > 0},
>  >     #'connection.close_ok'{} = amqp_connection:close(Connection,
>  > ConnectionClose),
>  >     ok.
>  >
>  > Thank you,
>  > Joe
>  >
>  >
>  >
>  >
>  > _______________________________________________
>  > rabbitmq-discuss mailing list
>  > rabbitmq-discuss at lists.rabbitmq.com
>  > http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
>  _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From slynko at brandproduction.ru  Wed Apr  9 11:55:35 2008
From: slynko at brandproduction.ru (Alexey Slynko)
Date: Wed, 09 Apr 2008 14:55:35 +0400
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
Message-ID: <47FCA0A7.5000006@brandproduction.ru>


Hi,

we have done some stress tests of rabbitmq. Our main goal was the ~10K
messages per second and maximum cpu & ram usage. Two servers with equal
configuration listed below were used for this task.


Intel SR1500AL:
Intel S5000PAL MB, 2 Quad Core Xeon 5345 2,33Ghz, 4Gb FB RAM :


$ /usr/sbin/prtdiag
System Configuration: Intel S5000PAL
BIOS Configuration: Intel Corporation S5000.86B.10.00.0085.112920071426
11/29/2007
BMC Configuration: IPMI 2.0 (KCS: Keyboard Controller Style)

==== Processor Sockets ====================================

Version                          Location Tag
-------------------------------- --------------------------
Intel(R) Xeon(R) CPU           E5345  @ 2.33GHz CPU1
Intel(R) Xeon(R) CPU           E5345  @ 2.33GHz CPU2

==== Memory Device Sockets ================================

Type    Status Set Device Locator      Bank Locator
------- ------ --- ------------------- --------------------
Unknown in use 1   ONBOARD DIMM_A1     Channel A
Unknown empty  2   ONBOARD DIMM_A2     Channel A
Unknown in use 1   ONBOARD DIMM_B1     Channel B
Unknown empty  2   ONBOARD DIMM_B2     Channel B
Unknown in use 5   ONBOARD DIMM_C1     Channel C
Unknown empty  6   ONBOARD DIMM_C2     Channel C
Unknown in use 5   ONBOARD DIMM_D1     Channel D
Unknown empty  6   ONBOARD DIMM_D2     Channel D

==== On-Board Devices =====================================
ATI Rage XL
Intel 82546EB Ethernet 1
Intel 82546EB Ethernet 2
ESB2 Integrated SATA Controller
NS PC87427 SIO3

==== Upgradeable Slots ====================================

ID  Status    Type             Description
--- --------- ---------------- ----------------------------
1   available PCI Express      FH Slot 1, PCI EXP x8
1   available PCI Express      LP Slot 1, PCI EXP x8
10  available PCI Express      I/O Module

These servers were connected with network link Ethernet 100Mb. The first
server (AMQP broker) powered by
Debian GNU/Linux Etch. Versions of installed software listed below:

# cat /etc/debian_version
4.0

# uname -sr
Linux 2.6.18-6-686-bigmem

# free
                total       used       free     shared    buffers     cached
Mem:       4139508     514148    3625360          0     210648     150388
-/+ buffers/cache:     153112    3986396
Swap:      4194296          0    4194296


Erlang version (stable debian distribution) :

# dpkg -l erlang\* | grep ii
ii  erlang-base      11.b.2-4       Concurrent, real-time, distributed
functiona
ii  erlang-nox       11.b.2-4       Concurrent, real-time, distributed
functiona

# erl
Erlang (BEAM) emulator version 5.5.2 [source] [async-threads:0]
[kernel-poll:false]

Eshell V5.5.2  (abort with ^G)



RabbitMQ version:

# apt-cache show rabbitmq-server | grep Version
Version: 1.3.0-1


We have modified startup script for handling more than 1024 tcp/connections:

--- rabbitmq-server.orig        2008-04-07 21:59:48.000000000 +0400
+++ /etc/init.d/rabbitmq-server 2008-04-04 18:05:25.000000000 +0400
@@ -24,8 +24,10 @@

   set -e
   cd /

+ulimit -n 65535
+
start_rabbitmq () {
         set +e
         su rabbitmq -s /bin/sh -c "$DAEMON start_all ${NODE_COUNT}" >
/var/log/rabbitmq/startup.log 2> /var/log/rabbitmq/startup.err
   case "$?" in


Another midfications were done for normal mnesia work (errors listed below)

ERROR REPORT==== 4-Apr-2008::18:29:14 ===
Error in process <0.20713.0> on node 'rabbit at altair' with exit value:
{{case_clause,{error,{system_limit,"Cannot create an ets table for
the local transaction
store",{system_limit,[{ets,new,[mnesia_trans_store,[bag,public]]},{mnesia_tm,doit_loop,1},{mnesia_sp,init_proc,4},{
proc_lib...

and for increasing common throughput

# diff -u rabbitmq-server.orig /usr/sbin/rabbitmq-server
--- rabbitmq-server.orig        2008-04-07 22:27:26.000000000 +0400
+++ /usr/sbin/rabbitmq-server   2008-04-07 22:28:40.000000000 +0400
@@ -28,7 +28,7 @@
   [ "x" = "x$NODE_IP_ADDRESS" ] && NODE_IP_ADDRESS=0.0.0.0
   [ "x" = "x$NODE_PORT" ] && NODE_PORT=5672

-ERL_ARGS="+K true +A30 -kernel inet_default_listen_options
[{sndbuf,16384},{recbuf,4096}]"
+ERL_ARGS="-env ERL_MAX_ETS_TABLES 10240 -env ERL_MAX_PORTS 10240 +K
true +A300 +P512000 -kernel inet_default_listen_options
[{sndbuf,65535},{recbuf,65535},{reuseaddr,true}] -smp auto"
   CLUSTER_CONFIG_FILE=/etc/default/rabbitmq_cluster.config
   CONFIG_FILE=/etc/default/rabbitmq


There is a system state after rabbitmq startup:

top - 22:41:58 up 3 days,  5:10,  3 users,  load average: 0.00, 0.00, 0.00
Tasks: 116 total,   1 running, 115 sleeping,   0 stopped,   0 zombie
Cpu(s):  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,
0.0%st
Mem:   4139508k total,   572228k used,  3567280k free,   212784k buffers
Swap:  4194296k total,        0k used,  4194296k free,   188600k cached

    PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND

31089 rabbitmq  15   0 2499m  15m 1620 S    0  0.4   0:00.29 beam.smp

30909 rabbitmq  15   0  1812  380  252 S    0  0.0   0:00.00 epmd

31085 rabbitmq  18   0  4176 1548 1080 S    0  0.0   0:00.01
rabbitmq-server
31410 rabbitmq  17   0  1808  452  360 S    0  0.0   0:00.00
inet_gethost
31411 rabbitmq  18   0  1852  580  468 S    0  0.0   0:00.00
inet_gethost


The second server (producer & consumer clients) powered by Solaris 10
07/. Versions of installed software listed below:

$ java -version
java version "1.5.0_12"
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_12-b04)
Java HotSpot(TM) Server VM (build 1.5.0_12-b04, mixed mode)

Client source code attached to this message.

So, let's try to start 100 producer's and
100 consumer's. Each producer generate 10 msgs/sec (t
1000 msgs/sec at all)

$ java -jar RabbitmqFastMessagingProducerTest.jar 100 > client.log

System snapshot:

top - 22:50:39 up 3 days,  5:19,  3 users,  load average: 0.51, 0.11, 0.04
Tasks: 116 total,   1 running, 115 sleeping,   0 stopped,   0 zombie
Cpu(s): 30.1%us,  5.3%sy,  0.0%ni, 64.2%id,  0.0%wa,  0.0%hi,  0.4%si,
0.0%st
Mem:   4139508k total,   590664k used,  3548844k free,   212844k buffers
Swap:  4194296k total,        0k used,  4194296k free,   188960k cached

    PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND

31089 rabbitmq  15   0 2520m  33m 1620 S  281  0.8   0:45.94 beam.smp

30909 rabbitmq  15   0  1812  380  252 S    0  0.0   0:00.00 epmd
31085 rabbitmq  18   0  4176 1548 1080 S    0  0.0   0:00.01 rabbitmq-server
31410 rabbitmq  17   0  1808  452  360 S    0  0.0   0:00.00 inet_gethost
31411 rabbitmq  18   0  1852  580  468 S    0  0.0   0:00.00 inet_gethost

Client eat about 5-7% CPU.
Client log file listed below:

> CLIENT_PRODUCER_THREAD_ID: 63 TIME: 1207594715030 MESSAGE: 1032 TIME: 1207594715030
> CLIENT_PRODUCER_THREAD_ID: 85 TIME: 1207594715030 MESSAGE: 1031 TIME: 1207594715030
> CLIENT_PRODUCER_THREAD_ID: 62 TIME: 1207594715030 MESSAGE: 1033 TIME: 1207594715030
> CLIENT_PRODUCER_THREAD_ID: 4 TIME: 1207594715030 MESSAGE: 1031 TIME: 1207594715030
> CLIENT_CONSUMER_THREAD_ID: 80 TIME: 1207594715051 MESSAGE: 1032 TIME: 1207594715030
> CLIENT_CONSUMER_THREAD_ID: 85 TIME: 1207594715051 MESSAGE: 1031 TIME: 1207594715030
> CLIENT_CONSUMER_THREAD_ID: 63 TIME: 1207594715052 MESSAGE: 1032 TIME: 1207594715030

Ok, try to calculate delay:

> $ tail -f client.log | awk '/CLIENT_CONSUMER_THREAD_ID/ {print "DELAY: " $4-$8 " " $0}'

> DELAY: 15 CLIENT_CONSUMER_THREAD_ID: 96 TIME: 1207594667285 MESSAGE: 596 TIME: 1207594667270
> DELAY: 15 CLIENT_CONSUMER_THREAD_ID: 76 TIME: 1207594667285 MESSAGE: 595 TIME: 1207594667270
> DELAY: 16 CLIENT_CONSUMER_THREAD_ID: 3 TIME: 1207594667286 MESSAGE: 596 TIME: 1207594667270
> DELAY: 2 CLIENT_CONSUMER_THREAD_ID: 49 TIME: 1207594667292 MESSAGE: 596 TIME: 1207594667290
> DELAY: 3 CLIENT_CONSUMER_THREAD_ID: 63 TIME: 1207594667293 MESSAGE: 596 TIME: 1207594667290
> DELAY: 3 CLIENT_CONSUMER_THREAD_ID: 0 TIME: 1207594667303 MESSAGE: 594 TIME: 1207594667300
> DELAY: 3 CLIENT_CONSUMER_THREAD_ID: 33 TIME: 1207594667303 MESSAGE: 596 TIME: 1207594667300
> DELAY: 43 CLIENT_CONSUMER_THREAD_ID: 12 TIME: 1207594667303 MESSAGE: 596 TIME: 1207594667260
> DELAY: 44 CLIENT_CONSUMER_THREAD_ID: 65 TIME: 1207594667304 MESSAGE: 593 TIME: 1207594667260
> DELAY: 4 CLIENT_CONSUMER_THREAD_ID: 42 TIME: 1207594667304 MESSAGE: 595 TIME: 1207594667300
> DELAY: 5 CLIENT_CONSUMER_THREAD_ID: 45 TIME: 1207594667305 MESSAGE: 596 TIME: 1207594667300
> DELAY: 45 CLIENT_CONSUMER_THREAD_ID: 29 TIME: 1207594667305 MESSAGE: 594 TIME: 1207594667260
> DELAY: 2 CLIENT_CONSUMER_THREAD_ID: 39 TIME: 1207594667312 MESSAGE: 596 TIME: 1207594667310
> DELAY: 6 CLIENT_CONSUMER_THREAD_ID: 54 TIME: 1207594667336 MESSAGE: 597 TIME: 1207594667330
> DELAY: 7 CLIENT_CONSUMER_THREAD_ID: 85 TIME: 1207594667337 MESSAGE: 595 TIME: 1207594667330
> DELAY: 8 CLIENT_CONSUMER_THREAD_ID: 22 TIME: 1207594667338 MESSAGE: 597 TIME: 1207594667330
> DELAY: 8 CLIENT_CONSUMER_THREAD_ID: 79 TIME: 1207594667338 MESSAGE: 596 TIME: 1207594667330
> 

So, the latency between 2-50 ms. It's suitable result.

We have increased thread count at the next step

> $ java -jar RabbitmqFastMessagingProducerTest.jar 500 > client.log

> $ tail -f client.log | awk '/CLIENT_CONSUMER_THREAD_ID/ {print "DELAY: " $4-$8 " " $0}'
> DELAY: 23338 CLIENT_CONSUMER_THREAD_ID: 367 TIME: 1207595791068 MESSAGE: 9 TIME: 1207595767730
> DELAY: 23210 CLIENT_CONSUMER_THREAD_ID: 417 TIME: 1207595791070 MESSAGE: 9 TIME: 1207595767860
> DELAY: 23326 CLIENT_CONSUMER_THREAD_ID: 464 TIME: 1207595791117 MESSAGE: 9 TIME: 1207595767791
> DELAY: 23147 CLIENT_CONSUMER_THREAD_ID: 481 TIME: 1207595791117 MESSAGE: 9 TIME: 1207595767970
> DELAY: 23327 CLIENT_CONSUMER_THREAD_ID: 386 TIME: 1207595791117 MESSAGE: 9 TIME: 1207595767790
> DELAY: 23197 CLIENT_CONSUMER_THREAD_ID: 469 TIME: 1207595791117 MESSAGE: 9 TIME: 1207595767920
> DELAY: 23984 CLIENT_CONSUMER_THREAD_ID: 322 TIME: 1207595791155 MESSAGE: 11 TIME: 1207595767171
> DELAY: 23307 CLIENT_CONSUMER_THREAD_ID: 350 TIME: 1207595791157 MESSAGE: 9 TIME: 1207595767850
> DELAY: 23158 CLIENT_CONSUMER_THREAD_ID: 453 TIME: 1207595791158 MESSAGE: 9 TIME: 1207595768000
> DELAY: 23258 CLIENT_CONSUMER_THREAD_ID: 306 TIME: 1207595791158 MESSAGE: 9 TIME: 1207595767900
> DELAY: 23283 CLIENT_CONSUMER_THREAD_ID: 356 TIME: 1207595791213 MESSAGE: 9 TIME: 1207595767930
> DELAY: 23294 CLIENT_CONSUMER_THREAD_ID: 256 TIME: 1207595791214 MESSAGE: 9 TIME: 1207595767920
> DELAY: 23144 CLIENT_CONSUMER_THREAD_ID: 456 TIME: 1207595791214 MESSAGE: 9 TIME: 1207595768070
> DELAY: 24063 CLIENT_CONSUMER_THREAD_ID: 112 TIME: 1207595791214 MESSAGE: 11 TIME: 1207595767151
> DELAY: 23144 CLIENT_CONSUMER_THREAD_ID: 484 TIME: 1207595791214 MESSAGE: 9 TIME: 1207595768070

Latency increased to 20-25 sec (not suitable).

System state snapshot:

   top - 23:22:10 up 3 days,  5:51,  3 users,  load average: 4.91, 2.89, 
1.56
Tasks: 116 total,   1 running, 115 sleeping,   0 stopped,   0 zombie
Cpu(s): 45.9%us,  5.9%sy,  0.0%ni, 47.3%id,  0.0%wa,  0.1%hi,  0.8%si,
0.0%st
Mem:   4139508k total,  1155792k used,  2983716k free,   213068k buffers
Swap:  4194296k total,        0k used,  4194296k free,   196008k cached

    PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND

31566 rabbitmq  15   0 3062m 572m 1620 S  412 14.2  12:14.58 beam.smp

30909 rabbitmq  15   0  1812  380  252 S    0  0.0   0:00.00 epmd

31562 rabbitmq  18   0  4172 1548 1080 S    0  0.0   0:00.00
rabbitmq-server
31887 rabbitmq  18   0  1808  452  360 S    0  0.0   0:00.00
inet_gethost
31888 rabbitmq  19   0  1852  576  468 S    0  0.0   0:00.00
inet_gethost


Try to increase threads up to 1000:

> $ java -jar RabbitmqFastMessagingProducerTest.jar 1000 > client.log

> $ tail -f client.log | awk '/CLIENT_CONSUMER_THREAD_ID/ {print "DELAY: " $4-$8 " " $0}'
> DELAY: 78805 CLIENT_CONSUMER_THREAD_ID: 562 TIME: 1207597161505 MESSAGE: 577 TIME: 1207597082700
> DELAY: 78843 CLIENT_CONSUMER_THREAD_ID: 602 TIME: 1207597161593 MESSAGE: 577 TIME: 1207597082750
> DELAY: 31985 CLIENT_CONSUMER_THREAD_ID: 483 TIME: 1207597161687 MESSAGE: 84 TIME: 1207597129702
> DELAY: 59055 CLIENT_CONSUMER_THREAD_ID: 694 TIME: 1207597161896 MESSAGE: 235 TIME: 1207597102841
> DELAY: 79510 CLIENT_CONSUMER_THREAD_ID: 562 TIME: 1207597162311 MESSAGE: 578 TIME: 1207597082801
> DELAY: 79512 CLIENT_CONSUMER_THREAD_ID: 602 TIME: 1207597162372 MESSAGE: 578 TIME: 1207597082860
> DELAY: 32710 CLIENT_CONSUMER_THREAD_ID: 483 TIME: 1207597162521 MESSAGE: 85 TIME: 1207597129811
> DELAY: 59680 CLIENT_CONSUMER_THREAD_ID: 694 TIME: 1207597162630 MESSAGE: 236 TIME: 1207597102950
> DELAY: 79967 CLIENT_CONSUMER_THREAD_ID: 562 TIME: 1207597162878 MESSAGE: 579 TIME: 1207597082911
> DELAY: 79953 CLIENT_CONSUMER_THREAD_ID: 602 TIME: 1207597162923 MESSAGE: 579 TIME: 1207597082970
> DELAY: 33231 CLIENT_CONSUMER_THREAD_ID: 483 TIME: 1207597163152 MESSAGE: 86 TIME: 1207597129921

Latency become unsuitable, and errors detected in client log:

> Apr 7, 2008 11:39:54 PM rabbitmqfastmessagingproducertest.FastMessagingProducer run
> SEVERE: null
> java.net.SocketException: Socket closed
>         at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:99)
>         at java.net.SocketOutputStream.write(SocketOutputStream.java:136)
>         at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:65)
>         at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:123)
>         at java.io.DataOutputStream.flush(DataOutputStream.java:106)
>         at com.rabbitmq.client.impl.SocketFrameHandler.writeFrame(SocketFrameHandler.java:156)
>         at com.rabbitmq.client.impl.AMQConnection.writeFrame(AMQConnection.java:297)
>         at com.rabbitmq.client.impl.AMQCommand.transmit(AMQCommand.java:175)
>         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:369)
>         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:350)
>         at rabbitmqfastmessagingproducertest.FastMessagingProducer.run(FastMessagingProducer.java:83)
> 

there are also errors in rabbitmq log:

> =WARNING REPORT==== 7-Apr-2008::23:34:04 ===
> Mnesia(rabbit at altair): ** WARNING ** Mnesia is overloaded: {mnesia_tm,
>                                                                message_queue_len,
>                                                                [732,626]}
> 
> 

CPU and RAM at AMQP broker server only half done.


Is there any way to increse common system throughput up to 10K msgs/sec?
Any ideas?

Thanks in advance


-- 
Alexey Slynko




-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbitmqfastmessagingproducertest.tar.gz
Type: application/x-compressed-tar
Size: 1951 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080409/366f4891/attachment.bin 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: RabbitmqFastMessagingProducerTest.jar
Type: application/x-java-archive
Size: 12199 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080409/366f4891/attachment-0001.bin 

From pzfreo at gmail.com  Wed Apr  9 13:13:43 2008
From: pzfreo at gmail.com (Paul Fremantle)
Date: Wed, 9 Apr 2008 13:13:43 +0100
Subject: [rabbitmq-discuss] Problem trying out rabbitmq-1.3.0
Message-ID: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>

Hi

I downloaded http://www.rabbitmq.com/releases/windows/complete-rabbitmq-bundle-1.3.0.zip

I installed the OTP package, and started rabbitmq-server.bat

I get this error, which makes me think I have some network config
issue, but its not clear to me what!

{error_logger,{{2008,4,9},{13,12,0}},"Protocol: ~p: register error: ~p~n",["inet
_tcp",{{badmatch,{error,econnrefused}},[{inet_tcp_dist,listen,1},{net_kernel,sta
rt_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,in
it,1},{gen_server,init_it,6},{proc_lib,init_p,5}]}]}
{error_logger,{{2008,4,9},{13,12,0}},crash_report,[[{pid,<0.21.0>},{registered_n
ame,net_kernel},{error_info,{error,badarg}},{initial_call,{gen,init_it,[gen_serv
er,<0.18.0>,<0.18.0>,{local,net_kernel},net_kernel,{rabbit,shortnames,15000},[]]
}},{ancestors,[net_sup,kernel_sup,<0.9.0>]},{messages,[]},{links,[#Port<0.8>,<0.
18.0>]},{dictionary,[{longnames,false}]},{trap_exit,true},{status,running},{heap
_size,610},{stack_size,21},{reductions,476}],[]]}
{error_logger,{{2008,4,9},{13,12,0}},supervisor_report,[{supervisor,{local,net_s
up}},{errorContext,start_error},{reason,{'EXIT',nodistribution}},{offender,[{pid
,undefined},{name,net_kernel},{mfa,{net_kernel,start_link,[[rabbit,shortnames]]}
},{restart_type,permanent},{shutdown,2000},{child_type,worker}]}]}
{error_logger,{{2008,4,9},{13,12,0}},supervisor_report,[{supervisor,{local,kerne
l_sup}},{errorContext,start_error},{reason,shutdown},{offender,[{pid,undefined},
{name,net_sup},{mfa,{erl_distribution,start_link,[]}},{restart_type,permanent},{
shutdown,infinity},{child_type,supervisor}]}]}
{error_logger,{{2008,4,9},{13,12,0}},crash_report,[[{pid,<0.8.0>},{registered_na
me,[]},{error_info,{shutdown,{kernel,start,[normal,[]]}}},{initial_call,{applica
tion_master,init,[<0.6.0>,<0.7.0>,{appl_data,kernel,[application_controller,erl_
reply,auth,boot_server,code_server,disk_log_server,disk_log_sup,erl_prim_loader,
error_logger,file_server_2,fixtable_server,global_group,global_name_server,heart
,init,kernel_config,kernel_sup,net_kernel,net_sup,rex,user,os_server,ddll_server
,erl_epmd,inet_db,pg2],undefined,{kernel,[]},[application,application_controller
,application_master,application_starter,auth,code,code_aux,packages,code_server,
dist_util,erl_boot_server,erl_distribution,erl_prim_loader,erl_reply,erlang,erro
r_handler,error_logger,file,file_server,file_io_server,prim_file,global,global_g
roup,global_search,group,heart,hipe_unified_loader,inet6_tcp,inet6_tcp_dist,inet
6_udp,inet_config,inet_hosts,inet_gethost_native,inet_tcp_dist,init,kernel,kerne
l_config,net,net_adm,net_kernel,os,ram_file,rpc,user,user_drv,user_sup,disk_log,
disk_log_1,disk_log_server,disk_log_sup,dist_ac,erl_ddll,erl_epmd,erts_debug,gen
_tcp,gen_udp,gen_sctp,prim_inet,inet,inet_db,inet_dns,inet_parse,inet_res,inet_t
cp,inet_udp,inet_sctp,pg2,seq_trace,wrap_log_reader,zlib,otp_ring0],[],infinity,
infinity},normal]}},{ancestors,[<0.7.0>]},{messages,[{'EXIT',<0.9.0>,normal}]},{
links,[<0.7.0>,<0.6.0>]},{dictionary,[]},{trap_exit,true},{status,running},{heap
_size,987},{stack_size,21},{reductions,2063}],[]]}
{error_logger,{{2008,4,9},{13,12,0}},std_info,[{application,kernel},{exited,{shu
tdown,{kernel,start,[normal,[]]}}},{type,permanent}]}
{"Kernel pid terminated",application_controller,"{application_start_failure,kern
el,{shutdown,{kernel,start,[normal,[]]}}}"}

Crash dump was written to: erl_crash.dump
Kernel pid terminated (application_controller) ({application_start_failure,kerne
l,{shutdown,{kernel,start,[normal,[]]}}})

Can someone help me get this running?

Thanks!

Paul

-- 
Paul Fremantle
Co-Founder and CTO, WSO2
Apache Synapse PMC Chair
OASIS WS-RX TC Co-chair

blog: http://pzf.fremantle.org
paul at wso2.com

"Oxygenating the Web Service Platform", www.wso2.com
-------------- next part --------------
A non-text attachment was scrubbed...
Name: erl_crash.dump
Type: application/octet-stream
Size: 218150 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080409/6c68da1f/attachment.obj 

From adrian at lshift.net  Wed Apr  9 14:02:34 2008
From: adrian at lshift.net (Adrien Pierard)
Date: Wed, 09 Apr 2008 14:02:34 +0100
Subject: [rabbitmq-discuss] Problem trying out rabbitmq-1.3.0
In-Reply-To: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>
References: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>
Message-ID: <47FCBE6A.1080905@lshift.net>

Paul Fremantle wrote:
> Hi

Hi Paul.


Where you already running a previous version of RabbitMQ?
If so, deleting the previous mnesia directory may solve your problem.


If not, could you please send me the log files rabbit.log and
rabbit-sasl.log, and a copy of the full launch process. It should be
something like:

(the logs folder is shown when you launch rabbit, as below)

==============
NODE_IP_ADDRESS= NODE_PORT= NODE_ONLY=true LOG_BASE=/tmp  RABBIT_ARGS="
-s rabbit" MNESIA_DIR=/tmp/rabbitmq-rabbit-mnesia ./scripts/rabbitmq-server
Erlang (BEAM) emulator version 5.5.5 [source] [async-threads:30]
[kernel-poll:true]

Eshell V5.5.5  (abort with ^G)
(rabbit at mrsideburns)1> RabbitMQ %%VERSION%% (AMQP 8-0)
Copyright (C) 2007-2008 LShift Ltd., Cohesive Financial Technologies
LLC., and Rabbit Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

Logging to "/tmp/rabbit.log"
SASL logging to "/tmp/rabbit-sasl.log"

starting database             ...done
starting core processes       ...done
starting recovery             ...done
starting persister            ...done
starting builtin applications ...done
starting TCP listeners        ...done
==============

And your crash happening sometime there I think.
You can copy/paste in windows console with a right click and selecting
"mark" or something like that.

> I get this error, which makes me think I have some network config
> issue, but its not clear to me what!

Indeed, it seems to be that...

Anyway, looking forward to hearing from you,

Adrien.

> {error_logger,{{2008,4,9},{13,12,0}},"Protocol: ~p: register error: ~p~n",["inet
> _tcp",{{badmatch,{error,econnrefused}},[{inet_tcp_dist,listen,1},{net_kernel,sta
> rt_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,in
> it,1},{gen_server,init_it,6},{proc_lib,init_p,5}]}]}
> {error_logger,{{2008,4,9},{13,12,0}},crash_report,[[{pid,<0.21.0>},{registered_n
> ame,net_kernel},{error_info,{error,badarg}},{initial_call,{gen,init_it,[gen_serv
> er,<0.18.0>,<0.18.0>,{local,net_kernel},net_kernel,{rabbit,shortnames,15000},[]]
> }},{ancestors,[net_sup,kernel_sup,<0.9.0>]},{messages,[]},{links,[#Port<0.8>,<0.
> 18.0>]},{dictionary,[{longnames,false}]},{trap_exit,true},{status,running},{heap
> _size,610},{stack_size,21},{reductions,476}],[]]}
> {error_logger,{{2008,4,9},{13,12,0}},supervisor_report,[{supervisor,{local,net_s
> up}},{errorContext,start_error},{reason,{'EXIT',nodistribution}},{offender,[{pid
> ,undefined},{name,net_kernel},{mfa,{net_kernel,start_link,[[rabbit,shortnames]]}
> },{restart_type,permanent},{shutdown,2000},{child_type,worker}]}]}
> {error_logger,{{2008,4,9},{13,12,0}},supervisor_report,[{supervisor,{local,kerne
> l_sup}},{errorContext,start_error},{reason,shutdown},{offender,[{pid,undefined},
> {name,net_sup},{mfa,{erl_distribution,start_link,[]}},{restart_type,permanent},{
> shutdown,infinity},{child_type,supervisor}]}]}
> {error_logger,{{2008,4,9},{13,12,0}},crash_report,[[{pid,<0.8.0>},{registered_na
> me,[]},{error_info,{shutdown,{kernel,start,[normal,[]]}}},{initial_call,{applica
> tion_master,init,[<0.6.0>,<0.7.0>,{appl_data,kernel,[application_controller,erl_
> reply,auth,boot_server,code_server,disk_log_server,disk_log_sup,erl_prim_loader,
> error_logger,file_server_2,fixtable_server,global_group,global_name_server,heart
> ,init,kernel_config,kernel_sup,net_kernel,net_sup,rex,user,os_server,ddll_server
> ,erl_epmd,inet_db,pg2],undefined,{kernel,[]},[application,application_controller
> ,application_master,application_starter,auth,code,code_aux,packages,code_server,
> dist_util,erl_boot_server,erl_distribution,erl_prim_loader,erl_reply,erlang,erro
> r_handler,error_logger,file,file_server,file_io_server,prim_file,global,global_g
> roup,global_search,group,heart,hipe_unified_loader,inet6_tcp,inet6_tcp_dist,inet
> 6_udp,inet_config,inet_hosts,inet_gethost_native,inet_tcp_dist,init,kernel,kerne
> l_config,net,net_adm,net_kernel,os,ram_file,rpc,user,user_drv,user_sup,disk_log,
> disk_log_1,disk_log_server,disk_log_sup,dist_ac,erl_ddll,erl_epmd,erts_debug,gen
> _tcp,gen_udp,gen_sctp,prim_inet,inet,inet_db,inet_dns,inet_parse,inet_res,inet_t
> cp,inet_udp,inet_sctp,pg2,seq_trace,wrap_log_reader,zlib,otp_ring0],[],infinity,
> infinity},normal]}},{ancestors,[<0.7.0>]},{messages,[{'EXIT',<0.9.0>,normal}]},{
> links,[<0.7.0>,<0.6.0>]},{dictionary,[]},{trap_exit,true},{status,running},{heap
> _size,987},{stack_size,21},{reductions,2063}],[]]}
> {error_logger,{{2008,4,9},{13,12,0}},std_info,[{application,kernel},{exited,{shu
> tdown,{kernel,start,[normal,[]]}}},{type,permanent}]}
> {"Kernel pid terminated",application_controller,"{application_start_failure,kern
> el,{shutdown,{kernel,start,[normal,[]]}}}"}
> 
> Crash dump was written to: erl_crash.dump
> Kernel pid terminated (application_controller) ({application_start_failure,kerne
> l,{shutdown,{kernel,start,[normal,[]]}}})
> 
> Can someone help me get this running?
> 
> Thanks!
> 
> Paul
> 


-- 
 [][][] Adrien Pi?rard     | mob_: +44 (0)78 0418 5351
   [][] Senior Developer   | mail: adrian at lshift.net
 []  [] LShift Ltd         | web_: www.lshift.net

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 252 bytes
Desc: OpenPGP digital signature
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080409/8792c8c2/attachment.pgp 

From holger at wizards.de  Wed Apr  9 14:16:22 2008
From: holger at wizards.de (=?ISO-8859-1?Q?Holger_Hoffst=E4tte?=)
Date: Wed, 09 Apr 2008 15:16:22 +0200
Subject: [rabbitmq-discuss] Problem trying out rabbitmq-1.3.0
In-Reply-To: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>
References: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>
Message-ID: <47FCC1A6.8010402@wizards.de>

Paul Fremantle wrote:
> Hi
> 
> I downloaded http://www.rabbitmq.com/releases/windows/complete-rabbitmq-bundle-1.3.0.zip
> 
> I installed the OTP package, and started rabbitmq-server.bat
> 
> I get this error, which makes me think I have some network config
> issue, but its not clear to me what!
> 
> {error_logger,{{2008,4,9},{13,12,0}},"Protocol: ~p: register error: ~p~n",["inet
> _tcp",{{badmatch,{error,econnrefused}},[{inet_tcp_dist,listen,1},{net_kernel,sta
> rt_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,in
> it,1},{gen_server,init_it,6},{proc_lib,init_p,5}]}]}

erlang uses an automatically-forked utility daemon called epmd (see 
http://linux.die.net/man/1/epmd for what it does); on Windows it might 
happen that the built-in firewall prevents this from starting. Try without 
firewall and - if it works - allow connections to epmd from localhost.
I got the firewall warning/asking pop-up too when I started it for the 
first time.

Holger



From matthias at lshift.net  Wed Apr  9 14:21:45 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 09 Apr 2008 14:21:45 +0100
Subject: [rabbitmq-discuss] Problem trying out rabbitmq-1.3.0
In-Reply-To: <47FCC1A6.8010402@wizards.de>
References: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>
	<47FCC1A6.8010402@wizards.de>
Message-ID: <47FCC2E9.9010209@lshift.net>

Paul,

Holger Hoffst?tte wrote:
> Paul Fremantle wrote:
>> I get this error, which makes me think I have some network config
>> issue, but its not clear to me what!
>>
>> {error_logger,{{2008,4,9},{13,12,0}},"Protocol: ~p: register error: ~p~n",["inet
>> _tcp",{{badmatch,{error,econnrefused}},[{inet_tcp_dist,listen,1},{net_kernel,sta
>> rt_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,in
>> it,1},{gen_server,init_it,6},{proc_lib,init_p,5}]}]}
> 
> erlang uses an automatically-forked utility daemon called epmd (see 
> http://linux.die.net/man/1/epmd for what it does); on Windows it might 
> happen that the built-in firewall prevents this from starting. Try without 
> firewall and - if it works - allow connections to epmd from localhost.
> I got the firewall warning/asking pop-up too when I started it for the 
> first time.

just to follow up on that...

you may be experiencing the same problem as reported at
   http://www.nabble.com/-erl--name--crashes-on-vista-td15257047.html

Are you running Vista by any chance?


Matthias.



From pzfreo at gmail.com  Wed Apr  9 14:32:51 2008
From: pzfreo at gmail.com (Paul Fremantle)
Date: Wed, 9 Apr 2008 14:32:51 +0100
Subject: [rabbitmq-discuss] Problem trying out rabbitmq-1.3.0
In-Reply-To: <47FCC2E9.9010209@lshift.net>
References: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>
	<47FCC1A6.8010402@wizards.de> <47FCC2E9.9010209@lshift.net>
Message-ID: <88f5d710804090632n4fe78cb2sceec9ee76f3a5690@mail.gmail.com>

Thanks for all the help so far:

1. I'm not running Vista - I'm on XP SP2
2. I've tried again with my firewall disabled without any change
3. I haven't run rabbitMQ before
4. My mnesia dir is empty. It wasn't even created, but I've created it
now and tried again its still empty
5. same for logs - so I can't send the logs - there aren't any.

Paul

On Wed, Apr 9, 2008 at 2:21 PM, Matthias Radestock <matthias at lshift.net> wrote:
> Paul,
>
>  Holger Hoffst?tte wrote:
>
>
> > Paul Fremantle wrote:
> >
> > > I get this error, which makes me think I have some network config
> > > issue, but its not clear to me what!
> > >
> > > {error_logger,{{2008,4,9},{13,12,0}},"Protocol: ~p: register error:
> ~p~n",["inet
> > >
> _tcp",{{badmatch,{error,econnrefused}},[{inet_tcp_dist,listen,1},{net_kernel,sta
> > >
> rt_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,in
> > > it,1},{gen_server,init_it,6},{proc_lib,init_p,5}]}]}
> > >
> >
> > erlang uses an automatically-forked utility daemon called epmd (see
> http://linux.die.net/man/1/epmd for what it does); on Windows it might
> happen that the built-in firewall prevents this from starting. Try without
> firewall and - if it works - allow connections to epmd from localhost.
> > I got the firewall warning/asking pop-up too when I started it for the
> first time.
> >
>
>  just to follow up on that...
>
>  you may be experiencing the same problem as reported at
>   http://www.nabble.com/-erl--name--crashes-on-vista-td15257047.html
>
>  Are you running Vista by any chance?
>
>
>  Matthias.
>



-- 
Paul Fremantle
Co-Founder and CTO, WSO2
Apache Synapse PMC Chair
OASIS WS-RX TC Co-chair

blog: http://pzf.fremantle.org
paul at wso2.com

"Oxygenating the Web Service Platform", www.wso2.com



From njbartlett at gmail.com  Wed Apr  9 14:36:00 2008
From: njbartlett at gmail.com (Neil Bartlett)
Date: Wed, 9 Apr 2008 14:36:00 +0100
Subject: [rabbitmq-discuss] OSGi Demo for RabbitMQ Client
Message-ID: <bb4674270804090636h26dfde59u982c6014cb1197d1@mail.gmail.com>

Hello,

With Tony's help I have put together a small demo of using RabbitMQ
Client in an OSGi environment. The demo simply has two bundles (the
OSGi term for a module): a producer bundle and a consumer bundle. They
each hook into the bundle lifecycle so the produce/consume threads can
be started and stopped from the OSGi console.

To download, fetch from my darcs repository:

	darcs get http://neilbartlett.name/darcs/rabbitmq-client-osgi

Instructions to build and run are in the readme:

	http://neilbartlett.name/darcs/rabbitmq-client-osgi/README.TXT

The directory is setup as an Eclipse project, so you should be able to
import it using the "Existing Projects" import wizard. However there
is no dependency on Eclipse, so you can open it in IntelliJ, NetBeans,
emacs or vi if you choose.

Regards,
Neil



From matthias at lshift.net  Wed Apr  9 14:50:53 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 09 Apr 2008 14:50:53 +0100
Subject: [rabbitmq-discuss] Problem trying out rabbitmq-1.3.0
In-Reply-To: <88f5d710804090632n4fe78cb2sceec9ee76f3a5690@mail.gmail.com>
References: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>	<47FCC1A6.8010402@wizards.de>
	<47FCC2E9.9010209@lshift.net>
	<88f5d710804090632n4fe78cb2sceec9ee76f3a5690@mail.gmail.com>
Message-ID: <47FCC9BD.3020409@lshift.net>

Paul,

Paul Fremantle wrote:
> 1. I'm not running Vista - I'm on XP SP2

ok. It's still worth performing some of the checks suggested in the 
thread at 
http://www.nabble.com/-erl--name--crashes-on-vista-td15257047.html, namely

1) does 'erl -sname foo' work?
if not
2) can you start the erlang port mapper daemon (empd) manually?
if not
3) do you have anything listening on port 4369?
if not
4) can you start the erlang port mapper daemon on a different port (epmd 
-port 4368, say)?


Matthias.



From alexis.richardson at cohesiveft.com  Wed Apr  9 15:52:46 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Wed, 9 Apr 2008 15:52:46 +0100
Subject: [rabbitmq-discuss] RabbitMQ and monit?
In-Reply-To: <81d74c280804081202t6d5e842ct539e345bf2bc6d0e@mail.gmail.com>
References: <81d74c280804081202t6d5e842ct539e345bf2bc6d0e@mail.gmail.com>
Message-ID: <167204d20804090752s1c850783h2e35ccb7b5f6393f@mail.gmail.com>

Steve

It's the first I'd heard of it.  Is it something that you would recommend?

alexis


On Tue, Apr 8, 2008 at 8:02 PM, Steve Jenson <stevej at gmail.com> wrote:
> Hi,
>
>  Does anybody out there use rabbitmq with monit?
>
>  Thanks,
>  Steve
>
>  _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From dmitriy.samovskiy at cohesiveft.com  Wed Apr  9 16:56:04 2008
From: dmitriy.samovskiy at cohesiveft.com (Dmitriy Samovskiy)
Date: Wed, 09 Apr 2008 10:56:04 -0500
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <47FCA0A7.5000006@brandproduction.ru>
References: <47FCA0A7.5000006@brandproduction.ru>
Message-ID: <47FCE714.9090801@cohesiveft.com>


Hi Alexey,

Alexey Slynko wrote:
> 
> Hi,
> 
> we have done some stress tests of rabbitmq. Our main goal was the ~10K
> messages per second and maximum cpu & ram usage. Two servers with equal
> configuration listed below were used for this task.
> 
What is your projected number of clients (producers and consumers combined)? In your tests 
below, it looks to me like you had 200, 1000 and 2000 clients - are these your expected 
levels? Each client is a socket. I think you might get higher throughput by reducing the 
number of clients.


> There is a system state after rabbitmq startup:
> 
> top - 22:41:58 up 3 days,  5:10,  3 users,  load average: 0.00, 0.00, 0.00
>    PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
> 31089 rabbitmq  15   0 2499m  15m 1620 S    0  0.4   0:00.29 beam.smp


> 
> So, let's try to start 100 producer's and
> 100 consumer's. Each producer generate 10 msgs/sec (t
> 1000 msgs/sec at all)
May I suggest increasing the number of messages per second as an alternative test (instead 
of increasing the number of clients)?

> 
> $ java -jar RabbitmqFastMessagingProducerTest.jar 100 > client.log
> 
> System snapshot:
> 
> top - 22:50:39 up 3 days,  5:19,  3 users,  load average: 0.51, 0.11, 0.04
> 
>    PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
> 
> 31089 rabbitmq  15   0 2520m  33m 1620 S  281  0.8   0:45.94 beam.smp
> 
>> $ java -jar RabbitmqFastMessagingProducerTest.jar 500 > client.log
> 
>   top - 23:22:10 up 3 days,  5:51,  3 users,  load average: 4.91, 2.89,  
>    PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
> 
> 31566 rabbitmq  15   0 3062m 572m 1620 S  412 14.2  12:14.58 beam.smp


It also looks like you restarted the broker before you ran the last top above (changed 
PID). Is there a way to capture its memory footprint right after restart? The difference 
in virt mem is 500M, which is 20% of what the first top shows.


I think one of your your biggest bottlenecks in this case is the number of sockets that 
you ask your OS to juggle at the same time (I may be wrong however). Things you might want 
to try:
1. reduce the number of clients
2. reduce the number of sockets each broker has to open by setting up a RabbitMQ cluster


- Dmitriy





From dmitriy.samovskiy at cohesiveft.com  Wed Apr  9 17:33:08 2008
From: dmitriy.samovskiy at cohesiveft.com (Dmitriy Samovskiy)
Date: Wed, 09 Apr 2008 11:33:08 -0500
Subject: [rabbitmq-discuss] RabbitMQ and monit?
In-Reply-To: <167204d20804090752s1c850783h2e35ccb7b5f6393f@mail.gmail.com>
References: <81d74c280804081202t6d5e842ct539e345bf2bc6d0e@mail.gmail.com>
	<167204d20804090752s1c850783h2e35ccb7b5f6393f@mail.gmail.com>
Message-ID: <47FCEFC4.8050108@cohesiveft.com>

Hi Steve,

You can obtain broker's OS process ID by something like this:
sed 's/.*,\(.*\)\}.*/\1/' /var/lib/rabbitmq/pids > /var/run/rabbitmq.pid
or
perl -ne 'm/,(.*)}/; print $1' /var/lib/rabbitmq/pids

(put it somewhere inside startup script around echo SUCCESS)


This will work if you have one rabbit node. If you have multiple, you can create multiple 
pid files for monit from /var/lib/rabbitmq/pids and monitor each process separately.


And then for monit:

check process rabbitmq-broker with pidfile /var/run/rabbitmq.pid
  start program = "/etc/init.d/rabbitmq start"
  stop program = "/etc/init.d/rabbitmq stop"
  if 5 restarts within 5 cycles then timeout
  alert someone at example.com only on { timeout }

Something like this might work. Please note however that I don't actually run this setup - 
it's just how I might do it when I get around to it.

- Dmitriy



Alexis Richardson wrote:
> Steve
> 
> It's the first I'd heard of it.  Is it something that you would recommend?
> 
> alexis
> 
> 
> On Tue, Apr 8, 2008 at 8:02 PM, Steve Jenson <stevej at gmail.com> wrote:
>> Hi,
>>
>>  Does anybody out there use rabbitmq with monit?
>>
>>  Thanks,
>>  Steve
>>
>>  _______________________________________________
>>  rabbitmq-discuss mailing list
>>  rabbitmq-discuss at lists.rabbitmq.com
>>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
> 
> 
> 



From stevej at gmail.com  Wed Apr  9 17:44:43 2008
From: stevej at gmail.com (Steve Jenson)
Date: Wed, 9 Apr 2008 09:44:43 -0700
Subject: [rabbitmq-discuss] RabbitMQ and monit?
In-Reply-To: <47FCEFC4.8050108@cohesiveft.com>
References: <81d74c280804081202t6d5e842ct539e345bf2bc6d0e@mail.gmail.com>
	<167204d20804090752s1c850783h2e35ccb7b5f6393f@mail.gmail.com>
	<47FCEFC4.8050108@cohesiveft.com>
Message-ID: <81d74c280804090944n1f8d5dabl8b546b3283bf585b@mail.gmail.com>

On Wed, Apr 9, 2008 at 9:33 AM, Dmitriy Samovskiy
<dmitriy.samovskiy at cohesiveft.com> wrote:
> Hi Steve,
>
>  You can obtain broker's OS process ID by something like this:
>  sed 's/.*,\(.*\)\}.*/\1/' /var/lib/rabbitmq/pids > /var/run/rabbitmq.pid
>  or
>  perl -ne 'm/,(.*)}/; print $1' /var/lib/rabbitmq/pids
>
>  (put it somewhere inside startup script around echo SUCCESS)

I like that a lot better than the "clever" awk I whipped up:

awk 'BEGIN { RS="}"; FS=","} /([:digit:].*)/ {print $2}'
/var/lib/rabbitmq/pids > $PIDFILE

BTW, I had to install the deb on another machine so I could get the
/etc/init.d script.
Would it be possible to include it in the binary generic unix server
distribution?

>  This will work if you have one rabbit node. If you have multiple, you can
> create multiple pid files for monit from /var/lib/rabbitmq/pids and monitor
> each process separately.
>
>
>  And then for monit:
>
>  check process rabbitmq-broker with pidfile /var/run/rabbitmq.pid
>   start program = "/etc/init.d/rabbitmq start"
>   stop program = "/etc/init.d/rabbitmq stop"
>   if 5 restarts within 5 cycles then timeout
>   alert someone at example.com only on { timeout }
>
>  Something like this might work. Please note however that I don't actually
> run this setup - it's just how I might do it when I get around to it.

Thanks! I am going to set this up today and will email back with any
modifications I have to make.

Steve



From matthias at lshift.net  Wed Apr  9 20:24:55 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 09 Apr 2008 20:24:55 +0100
Subject: [rabbitmq-discuss] Small suggestion for 1.3 scripts
In-Reply-To: <47F2564F.8030607@wizards.de>
References: <47F2564F.8030607@wizards.de>
Message-ID: <47FD1807.4050906@lshift.net>

Holger,

Holger Hoffst?tte wrote:
> Windows convention is to use a subdirectory under the per-user
> %APPDATA% directory, i.e. change the definition of RABBITMQ_BASE in 
> rabbitmq-server.bat and rabbitmq-multi.bat like this:
> 
> set RABBITMQ_BASE=%APPDATA%\RabbitMQ
> [...]
> Both changes are attached as patches.

Thanks. This is definitely the right thing to do. We will incorporate 
your patches in the next release.


Matthias.



From matthias at lshift.net  Wed Apr  9 20:32:28 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 09 Apr 2008 20:32:28 +0100
Subject: [rabbitmq-discuss] pub-sub erlang problem
In-Reply-To: <E11BE3CD-3F00-4F3B-AFF3-6667B4113C32@gmail.com>
References: <50ec7a2e0804061453v8cef28em84cb95dfc250dd4@mail.gmail.com>
	<E11BE3CD-3F00-4F3B-AFF3-6667B4113C32@gmail.com>
Message-ID: <47FD19CC.1050903@lshift.net>

Ben,

Ben Hood wrote:
> It looks like you're trying to publish to an exchange that doesn't  
> exist, although the server diagnostic could be a little clearer on  
> this point.
> [...]
> We should probably take on board better server diagnostics as an  
> improvement item.

Definitely. It's already on the list.


Matthias.



From matthias at lshift.net  Wed Apr  9 22:50:02 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 09 Apr 2008 22:50:02 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <47FCA0A7.5000006@brandproduction.ru>
References: <47FCA0A7.5000006@brandproduction.ru>
Message-ID: <47FD3A0A.1090600@lshift.net>

Alexey,

Alexey Slynko wrote:
> we have done some stress tests of rabbitmq. Our main goal was the ~10K
> messages per second and maximum cpu & ram usage. Two servers with equal
> configuration listed below were used for this task.

> Intel(R) Xeon(R) CPU           E5345  @ 2.33GHz CPU1
> Intel(R) Xeon(R) CPU           E5345  @ 2.33GHz CPU2

You shouldn't have any trouble hitting ~10k mps on these boxes. We have 
achieved that on machines with much lower specs.

> These servers were connected with network link Ethernet 100Mb.

That's rather slow, though you probably won't be hitting the limits in 
your tests. Check the stats on the network interface to get an idea how 
much headroom you have.

> Erlang version (stable debian distribution) :
> 
> # dpkg -l erlang\* | grep ii
> ii  erlang-base      11.b.2-4       Concurrent, real-time, distributed
> functiona
> ii  erlang-nox       11.b.2-4       Concurrent, real-time, distributed
> functiona

Any chance you could try the tests with R11B-5? Most of our testing has 
been done on that. I doubt it will make much difference but at the very 
least it will make it easier for us to compare results.

> Another midfications were done for normal mnesia work (errors listed below)
> 
> ERROR REPORT==== 4-Apr-2008::18:29:14 ===
> Error in process <0.20713.0> on node 'rabbit at altair' with exit value:
> {{case_clause,{error,{system_limit,"Cannot create an ets table for
> the local transaction
> store",{system_limit,[{ets,new,[mnesia_trans_store,[bag,public]]},{mnesia_tm,doit_loop,1},{mnesia_sp,init_proc,4},{ 
> 
> proc_lib...

We have never seen this before. At what point during your tests did you 
get this error?

> and for increasing common throughput
> 
> # diff -u rabbitmq-server.orig /usr/sbin/rabbitmq-server
> --- rabbitmq-server.orig        2008-04-07 22:27:26.000000000 +0400
> +++ /usr/sbin/rabbitmq-server   2008-04-07 22:28:40.000000000 +0400
> @@ -28,7 +28,7 @@
>   [ "x" = "x$NODE_IP_ADDRESS" ] && NODE_IP_ADDRESS=0.0.0.0
>   [ "x" = "x$NODE_PORT" ] && NODE_PORT=5672
> 
> -ERL_ARGS="+K true +A30 -kernel inet_default_listen_options
> [{sndbuf,16384},{recbuf,4096}]"
> +ERL_ARGS="-env ERL_MAX_ETS_TABLES 10240 -env ERL_MAX_PORTS 10240 +K
> true +A300 +P512000 -kernel inet_default_listen_options
> [{sndbuf,65535},{recbuf,65535},{reuseaddr,true}] -smp auto"
>   CLUSTER_CONFIG_FILE=/etc/default/rabbitmq_cluster.config
>   CONFIG_FILE=/etc/default/rabbitmq

These should all be fine except I have some concerns about the "-smp 
auto", given how old a version of Erlang/OTP are running. Did you test 
that adding the flag indeed improves performance?

Note that RabbitMQ when running with Erlang/OTP R11B (rather than the 
more recent R12) will not benefit much (if at all) from the multiple 
cores when running with -smp. In our experiments we have been getting 
much better results when configuring a local cluster of one non-smp node 
per code. So I'd recommend you do that.

> Client source code attached to this message.

The following will all impact performance:

- The queues are not auto-deleting and aren't being deleted explicitly, 
and your queue/exchange naming scheme is deterministic. Unless you 
restart the server between tests or subsequent tests will be affected by 
the queues from earlier tests. I'd also recommend clearing the mnesia 
dir prior to starting rabbit, just to make sure that there aren't any 
stray exchanges, queues or persistent messages.

- The consumer explicitly acknowledges each message. Would 
bulk-acknowledgment or auto-acknowledgment be an option?

- The tests use a single topic exchange, with a distinct routing/binding 
key for each producer/consumer pair. That is a rather peculiar set up 
and may well run into performance problems for high numbers of queues. 
The reason is that currently topic exchange routing simply pattern 
matches the routing key against each binding key in term, i.e. matching 
time is linear in the number of queues. That's on our todo list to 
change - we used to have some caching logic in pre-1.3.0 versions but 
removed that because it exhibited unbounded memory growth when people 
used UIDs for routing keys. Anyway, I'd suggest you use a direct 
exchange. All you should have to do is change the type in the exchange 
declaration; the rest of your code ought to work unchanged.

- You start lots of producers and consumer and each establishes a 
separate connection. Dmitriy already pointed out several reasons why 
that may be affecting performance. Another reason is that connection 
establishment and teardown is quite expensive in RabbitMQ. Queue 
creation, binding and deletion are quite expensive too. I notice you 
have some "sleep" statements in your code, presumably to prevent the set 
up tasks from interfering with the measurements. However, given the high 
number of producers and consumers you are creating I suspect you will 
still get interference. The mnesia errors/warnings you are seeing are an 
indication of that because the sending/receiving of messages does not 
involve any mnesia writes but connection, queue, exchange and binding 
creation all do. If you really want to measure throughput for that many 
connections and queues then I'd suggest you make sure they are all 
created prior to any messages being sent.


You may also want to run one of the test programs supplied with the 
RabbitMQ Java client packages, such as MulticastMain, e.g.
   sh ./runjava.sh com.rabbitmq.examples.MulticastMain -h <host> -a
which reports on throughput and latency.


I hope the above helps. Please do let us know what results you are getting.


Regards,

Matthias.



From stevej at gmail.com  Wed Apr  9 23:23:20 2008
From: stevej at gmail.com (Steve Jenson)
Date: Wed, 9 Apr 2008 15:23:20 -0700
Subject: [rabbitmq-discuss] RabbitMQ and monit?
In-Reply-To: <47FCEFC4.8050108@cohesiveft.com>
References: <81d74c280804081202t6d5e842ct539e345bf2bc6d0e@mail.gmail.com>
	<167204d20804090752s1c850783h2e35ccb7b5f6393f@mail.gmail.com>
	<47FCEFC4.8050108@cohesiveft.com>
Message-ID: <81d74c280804091523q12e6a330j4ced4584c993598d@mail.gmail.com>

On Wed, Apr 9, 2008 at 9:33 AM, Dmitriy Samovskiy
<dmitriy.samovskiy at cohesiveft.com> wrote:
>  And then for monit:
>
>  check process rabbitmq-broker with pidfile /var/run/rabbitmq.pid
>   start program = "/etc/init.d/rabbitmq start"
>   stop program = "/etc/init.d/rabbitmq stop"
>   if 5 restarts within 5 cycles then timeout
>   alert someone at example.com only on { timeout }
>
>  Something like this might work. Please note however that I don't actually
> run this setup - it's just how I might do it when I get around to it.

That worked for me pretty much verbatim except that my script is in
/etc/init.d/rabbitmq-server

Best,
Steve J.



From codewalkerjoe at gmail.com  Thu Apr 10 00:17:25 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Wed, 9 Apr 2008 19:17:25 -0400
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
Message-ID: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>

I have published the message asynchronously to the exchange.  Now to consume
the messages from the exchange, I can use either BasicGet or BasicConsume.
When you are consuming messages in pub/sub model, do you have to specify
what exchange to look for?  In addition, when you consume message from an
exchange regardless of messaging model(pub/sub), you still have to declare a
queue, bind it and consume the message from the queue?

BasicConsume and BasicGet there is a variable named queue = Q. In pub-sub
case, how do you define null queue in Erlang-client? In basic.consume I set
the queue = <<"">> like below:

BasicConsume = #'basic.consume'{ticket = Ticket,
                                    queue = <<"">>,

In basic.publish, I set immediate = false so that when the consumer started
later, message will be in the queue for it to consume.

Rabbitmq server throwing errors when I run the consumer code after the
message have been published to the exchange.

(rabbit at home)5> amqp_async_consume:amqp_lifecycle_consume().
Connection: {<0.178.0>,direct}
** exception exit: {{amqp_async_consume,amqp_lifecycle_consume,0},
                    {line,40},
                    match,
                    [{'queue.declare_ok',
                         <<"amq.q.gen1_rabbit at home_20080409224223_">>,0,0}]}
     in function  amqp_async_consume:amqp_lifecycle_consume/0


This is the line causing the problem:
amqp_channel:call(Channel,QueueDeclare) in
#'queue.declare_ok'{queue = Q,
                        message_count = MessageCount,
                        consumer_count = ConsumerCount}
                       = amqp_channel:call(Channel,QueueDeclare),


-module(amqp_async_consume).

-include_lib("rabbitmq_server/include/rabbit_framing.hrl").
-include_lib("rabbitmq_server/include/rabbit.hrl").
-include_lib("rabbitmq_client/include/amqp_client.hrl").

-export([amqp_lifecycle_consume/0]).

amqp_lifecycle_consume() ->
    User = Password = "guest",
    Realm = <<"/data">>,

    %% Start a connection to the server

    Connection = amqp_connection:start(User, Password),
    io:format("Connection: ~p~n",[Connection]),
    %% Once you have a connection to the server, you can start an AMQP
channel gain access to a realm

    Channel = amqp_connection:open_channel(Connection),
    Access = #'access.request'{realm = Realm,
                               exclusive = false,
                               passive = true,
                               active = true,
                               write = true,
                               read = true},
    #'access.request_ok'{ticket = Ticket} = amqp_channel:call(Channel,
Access),

    %% Register a consumer to listen to a queue
    Q = <<"">>,
    X = <<"x">>,
    BindKey = <<"a.b.c.*">>,

    QueueDeclare = #'queue.declare'{ticket = Ticket, queue = Q,
                                    passive = false, durable = false,
                                    exclusive = false, auto_delete = false,
                                    nowait = false, arguments = []},
    #'queue.declare_ok'{queue = Q,
                        message_count = MessageCount,
                        consumer_count = ConsumerCount}
                       = amqp_channel:call(Channel,QueueDeclare),


    %ExchangeDeclare = #'exchange.declare'{ticket = Ticket, exchange = X,
type = <<"topic">>,
    %                                      passive = false, durable = false,
auto_delete = false, internal = false,
    %                                      nowait = false, arguments = []},
    %#'exchange.declare_ok'{} = amqp_channel:call(Channel, ExchangeDeclare),

    QueueBind = #'queue.bind'{ticket = Ticket, queue = Q, exchange = X,
                              routing_key = BindKey, nowait = false,
arguments = []},
    #'queue.bind_ok'{} = amqp_channel:call(Channel, QueueBind),



    %ConsumerTag = <<"">>,
    %DeliveryTag = <<"">>,
    BasicConsume = #'basic.consume'{ticket = Ticket,
                                    queue = Q,
                                    consumer_tag = <<"">>,
                                    no_local = false,
                                    no_ack = true,
                                    exclusive = false,
                                    nowait = false},
    #'basic.consume_ok'{consumer_tag = ConsumerTag}
        = amqp_channel:call(Channel, BasicConsume, self()),

    %% If the registration was sucessful, then consumer will be notified

    receive
        #'basic.consume_ok'{consumer_tag = ConsumerTag} -> ok
    end,

    %% When a message is routed to the queue, it will then be delivered to
this consumer

    receive
        {#'basic.deliver'{delivery_tag = DeliveryTag}, Content} ->
            #content{payload_fragments_rev = [Payload]} = Content,
            io:format("Message received: ~p~n", [Payload])
    after 2000 ->
        exit(did_not_receive_message)
    end,

    %% After the consumer is finished interacting with the queue, it can
deregister itself

    BasicCancel = #'basic.cancel'{consumer_tag = ConsumerTag,
                                  nowait = false},
    #'basic.cancel_ok'{consumer_tag = ConsumerTag} =
amqp_channel:call(Channel,BasicCancel).

Thank you,
Joe
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080409/5c96a12d/attachment.htm 

From sustrik at imatix.com  Thu Apr 10 05:22:37 2008
From: sustrik at imatix.com (Martin Sustrik)
Date: Thu, 10 Apr 2008 06:22:37 +0200
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <47FD3A0A.1090600@lshift.net>
References: <47FCA0A7.5000006@brandproduction.ru> <47FD3A0A.1090600@lshift.net>
Message-ID: <47FD960D.6050200@imatix.com>


> You shouldn't have any trouble hitting ~10k mps on these boxes. We have 
> achieved that on machines with much lower specs.
>   
If there are 100 consumers for the feed, 10k of unique messages per 
second equals to 1,010,000 messages a second over the wire, no? No way a 
100MbE can handle that amount of data.

Martin



From matthias at lshift.net  Thu Apr 10 07:31:17 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 10 Apr 2008 07:31:17 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <47FD960D.6050200@imatix.com>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FD3A0A.1090600@lshift.net> <47FD960D.6050200@imatix.com>
Message-ID: <47FDB435.1050005@lshift.net>

Martin,

Martin Sustrik wrote:
> 
>> You shouldn't have any trouble hitting ~10k mps on these boxes. We 
>> have achieved that on machines with much lower specs.
>>   
> If there are 100 consumers for the feed, 10k of unique messages per 
> second equals to 1,010,000 messages a second over the wire, no? No way a 
> 100MbE can handle that amount of data.

That's what I thought at first too, but looking at the code the set up 
is such that each consumer only consumes the messages of one producer. 
So the number of outbound messages is the same as the number of inbound 
messages.


Matthias.



From alexis.richardson at cohesiveft.com  Thu Apr 10 10:12:12 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Thu, 10 Apr 2008 10:12:12 +0100
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
In-Reply-To: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
Message-ID: <167204d20804100212n4c387280n1acb40fb2fb972b6@mail.gmail.com>

Joe

On Thu, Apr 10, 2008 at 12:17 AM, Joe Lee <codewalkerjoe at gmail.com> wrote:
> I have published the message asynchronously to the exchange.  Now to consume
> the messages from the exchange, I can use either BasicGet or BasicConsume.
> When you are consuming messages in pub/sub model, do you have to specify
> what exchange to look for?

The consumer's messages are buffered by a queue Q which you must
explicitly bind, once, to a named exchange E.  As you are doing
pub/sub, then E needs to be a Topic exchange.  Q will bind to that
exchange with an associative pattern P (tuple of wildcards and routing
keys).  Then, E will route messages to Q when their routing keys match
the pattern P.  For example "buy.ibm" matches "*.ibm".


> In addition, when you consume message from an
> exchange regardless of messaging model(pub/sub), you still have to declare a
> queue, bind it and consume the message from the queue?

You can consume directly from an exchange.  So, yes, you must declare
at least one queue per consumer, bind it to at least one exchange, and
consume messages from the queue.  The queue is in effect 'subscribed'
to whichever topics match the binding pattern.

alexis



From alexis.richardson at cohesiveft.com  Thu Apr 10 10:16:25 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Thu, 10 Apr 2008 10:16:25 +0100
Subject: [rabbitmq-discuss] OSGi Demo for RabbitMQ Client
In-Reply-To: <bb4674270804090636h26dfde59u982c6014cb1197d1@mail.gmail.com>
References: <bb4674270804090636h26dfde59u982c6014cb1197d1@mail.gmail.com>
Message-ID: <167204d20804100216h3426a893j3baced91d8cd77fb@mail.gmail.com>

Neil,

Thanks very much for this!  Perhaps it would be useful to folks not
yet familiar with the benefits of OSGi to explain what this gets them.

Everyone,

If you are in London, Neil is doing a talk on OSGi next Monday at
Merrills.  Please contact us if you are interested in attending.

alexis



On Wed, Apr 9, 2008 at 2:36 PM, Neil Bartlett <njbartlett at gmail.com> wrote:
> Hello,
>
>  With Tony's help I have put together a small demo of using RabbitMQ
>  Client in an OSGi environment. The demo simply has two bundles (the
>  OSGi term for a module): a producer bundle and a consumer bundle. They
>  each hook into the bundle lifecycle so the produce/consume threads can
>  be started and stopped from the OSGi console.
>
>  To download, fetch from my darcs repository:
>
>         darcs get http://neilbartlett.name/darcs/rabbitmq-client-osgi
>
>  Instructions to build and run are in the readme:
>
>         http://neilbartlett.name/darcs/rabbitmq-client-osgi/README.TXT
>
>  The directory is setup as an Eclipse project, so you should be able to
>  import it using the "Existing Projects" import wizard. However there
>  is no dependency on Eclipse, so you can open it in IntelliJ, NetBeans,
>  emacs or vi if you choose.
>
>  Regards,
>  Neil
>
>  _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From alexis.richardson at cohesiveft.com  Thu Apr 10 10:33:01 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Thu, 10 Apr 2008 10:33:01 +0100
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
In-Reply-To: <167204d20804100212n4c387280n1acb40fb2fb972b6@mail.gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
	<167204d20804100212n4c387280n1acb40fb2fb972b6@mail.gmail.com>
Message-ID: <167204d20804100233j71bcbcafxf8a2df8f07d64dcb@mail.gmail.com>

Joe

CORRECTION

I meant to type 'cannot'!  Ahem...

On Thu, Apr 10, 2008 at 10:12 AM, Alexis Richardson
<alexis.richardson at cohesiveft.com> wrote:
>
>  You CANNOT consume directly from an exchange.
>  So, yes, you must declare
>  at least one queue per consumer, bind it to at least one exchange, and
>  consume messages from the queue.  The queue is in effect 'subscribed'
>  to whichever topics match the binding pattern.

alexis



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From njbartlett at gmail.com  Thu Apr 10 11:14:16 2008
From: njbartlett at gmail.com (Neil Bartlett)
Date: Thu, 10 Apr 2008 11:14:16 +0100
Subject: [rabbitmq-discuss] OSGi Demo for RabbitMQ Client
In-Reply-To: <167204d20804100216h3426a893j3baced91d8cd77fb@mail.gmail.com>
References: <bb4674270804090636h26dfde59u982c6014cb1197d1@mail.gmail.com>
	<167204d20804100216h3426a893j3baced91d8cd77fb@mail.gmail.com>
Message-ID: <bb4674270804100314v4ac034f8ya73a063ff7fcf491@mail.gmail.com>

Alexis,

This is mainly of interest to people already using OSGi, including of
course anybody developing Eclipse RCP applications or plug-ins. They
can take the two "bundleized" JARs and drop them into their OSGi
framework as-is. Several ESB-type middleware platforms are also moving
to OSGi (eg Mule, ServiceMix) and looking at RabbitMQ, so they should
consider using these JARs.

For those not already using OSGi, I can only really describe the
general benefits, namely: a strong, mature module system for Java with
explicit, versioned dependencies; dynamically hot-swappable modules;
side-by-side versions, etc. I believe most middleware platforms will
see an increasing need for these features in the near future.

Regards,
Neil


On Thu, Apr 10, 2008 at 10:16 AM, Alexis Richardson
<alexis.richardson at cohesiveft.com> wrote:
> Neil,
>
>  Thanks very much for this!  Perhaps it would be useful to folks not
>  yet familiar with the benefits of OSGi to explain what this gets them.
>
>  Everyone,
>
>  If you are in London, Neil is doing a talk on OSGi next Monday at
>  Merrills.  Please contact us if you are interested in attending.
>
>  alexis
>
>
>
>
>
>  On Wed, Apr 9, 2008 at 2:36 PM, Neil Bartlett <njbartlett at gmail.com> wrote:
>  > Hello,
>  >
>  >  With Tony's help I have put together a small demo of using RabbitMQ
>  >  Client in an OSGi environment. The demo simply has two bundles (the
>  >  OSGi term for a module): a producer bundle and a consumer bundle. They
>  >  each hook into the bundle lifecycle so the produce/consume threads can
>  >  be started and stopped from the OSGi console.
>  >
>  >  To download, fetch from my darcs repository:
>  >
>  >         darcs get http://neilbartlett.name/darcs/rabbitmq-client-osgi
>  >
>  >  Instructions to build and run are in the readme:
>  >
>  >         http://neilbartlett.name/darcs/rabbitmq-client-osgi/README.TXT
>  >
>  >  The directory is setup as an Eclipse project, so you should be able to
>  >  import it using the "Existing Projects" import wizard. However there
>  >  is no dependency on Eclipse, so you can open it in IntelliJ, NetBeans,
>  >  emacs or vi if you choose.
>  >
>  >  Regards,
>  >  Neil
>  >
>  >  _______________________________________________
>  >  rabbitmq-discuss mailing list
>  >  rabbitmq-discuss at lists.rabbitmq.com
>  >  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>  >
>
>
>
>  --
>  Alexis Richardson
>  +44 20 7617 7339 (UK)
>  +44 77 9865 2911 (cell)
>  +1 650 206 2517 (US)
>



From 0x6e6562 at gmail.com  Thu Apr 10 11:50:46 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 10 Apr 2008 11:50:46 +0100
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
In-Reply-To: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
Message-ID: <E2E51120-056C-4B39-B2D1-44788E174D81@gmail.com>

Hi Joe,

On 10 Apr 2008, at 00:17, Joe Lee wrote:
> BasicConsume and BasicGet there is a variable named queue = Q. In  
> pub-sub case, how do you define null queue in Erlang-client? In  
> basic.consume I set the queue = <<"">> like below:

Do you have a particular reason to declare a null queue?

Maybe you can tell us what you are trying to achieve.

HTH,

Ben



From colincrist at messageforge.org  Thu Apr 10 14:32:20 2008
From: colincrist at messageforge.org (Colin Crist)
Date: Thu, 10 Apr 2008 09:32:20 -0400
Subject: [rabbitmq-discuss] OSGi Demo for RabbitMQ Client
In-Reply-To: <167204d20804100216h3426a893j3baced91d8cd77fb@mail.gmail.com>
References: <bb4674270804090636h26dfde59u982c6014cb1197d1@mail.gmail.com>
	<167204d20804100216h3426a893j3baced91d8cd77fb@mail.gmail.com>
Message-ID: <B24E70CDADDC1040BCC4173D2A6CEF2A17F84F816E@mse17be2.mse17.exchange.ms>


I was at one of Neils talks last year on OSGi - very good it was too to help quickly up my knowledge in an hour on a subject that can seem a little impenetrable with lots of detail out there and yet not many good introductions.

Definitely worth going to if you're in the area and have the time...

Colin.

> -----Original Message-----
> From: rabbitmq-discuss-bounces at lists.rabbitmq.com
> [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On
> Behalf Of Alexis Richardson
> Sent: 10 April 2008 10:16
> To: Neil Bartlett
> Cc: rabbitmq-discuss at lists.rabbitmq.com
> Subject: Re: [rabbitmq-discuss] OSGi Demo for RabbitMQ Client
>
> Neil,
>
> Thanks very much for this!  Perhaps it would be useful to
> folks not yet familiar with the benefits of OSGi to explain
> what this gets them.
>
> Everyone,
>
> If you are in London, Neil is doing a talk on OSGi next
> Monday at Merrills.  Please contact us if you are interested
> in attending.
>
> alexis
>
>
>
> On Wed, Apr 9, 2008 at 2:36 PM, Neil Bartlett
> <njbartlett at gmail.com> wrote:
> > Hello,
> >
> >  With Tony's help I have put together a small demo of using
> RabbitMQ
> > Client in an OSGi environment. The demo simply has two
> bundles (the
> > OSGi term for a module): a producer bundle and a consumer
> bundle. They
> > each hook into the bundle lifecycle so the produce/consume
> threads can
> > be started and stopped from the OSGi console.
> >
> >  To download, fetch from my darcs repository:
> >
> >         darcs get
> http://neilbartlett.name/darcs/rabbitmq-client-osgi
> >
> >  Instructions to build and run are in the readme:
> >
> >
> http://neilbartlett.name/darcs/rabbitmq-client-osgi/README.TXT
> >
> >  The directory is setup as an Eclipse project, so you
> should be able
> > to  import it using the "Existing Projects" import wizard. However
> > there  is no dependency on Eclipse, so you can open it in IntelliJ,
> > NetBeans,  emacs or vi if you choose.
> >
> >  Regards,
> >  Neil
> >
> >  _______________________________________________
> >  rabbitmq-discuss mailing list
> >  rabbitmq-discuss at lists.rabbitmq.com
> >  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> >
>
>
>
> --
> Alexis Richardson
> +44 20 7617 7339 (UK)
> +44 77 9865 2911 (cell)
> +1 650 206 2517 (US)
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



From codewalkerjoe at gmail.com  Thu Apr 10 21:18:37 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Thu, 10 Apr 2008 16:18:37 -0400
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
In-Reply-To: <E2E51120-056C-4B39-B2D1-44788E174D81@gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
	<E2E51120-056C-4B39-B2D1-44788E174D81@gmail.com>
Message-ID: <50ec7a2e0804101318g3d1c84by9521fe2f133b4ec@mail.gmail.com>

On Thu, Apr 10, 2008 at 6:50 AM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Hi Joe,
>
> On 10 Apr 2008, at 00:17, Joe Lee wrote:
> > BasicConsume and BasicGet there is a variable named queue = Q. In
> > pub-sub case, how do you define null queue in Erlang-client? In
> > basic.consume I set the queue = <<"">> like below:
>
> Do you have a particular reason to declare a null queue?
>

Taken straight from amqp0.8.pdf file pg25.

Docs' psuedocode explanation has set queue=<empty>.  That was my reason to
declare a null queue.

Does null queue have any special functionality?


Abstract from the amqp docs:

2.1.5.3 Constructing a PubSub
Subscription Queue

Here is the pseudocode
for creating and binding the pubsub subscription queue:
Queue.Declare
    queue=<empty>
    auto_delete=TRUE
S:Queue.Declare-Ok
    queue=tmp.2
Queue.Bind
    queue=tmp.2
    TO exchange=amq.topic
    WHERE routing_key=STOCK.USD.*

To consume from the subscription queue, the consumer does this:

Basic.Consume
    queue=tmp.2

When publishing a message, the producer does something like this:

Basic.Publish
    exchange=amq.topic
    routing_key=STOCK.USD.IBM


>
> Maybe you can tell us what you are trying to achieve.
>

I just want to do simple publish a message and then consume the message.

Thank you,
Joe
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080410/21b89532/attachment.htm 

From 0x6e6562 at gmail.com  Thu Apr 10 22:40:46 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 10 Apr 2008 22:40:46 +0100
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
In-Reply-To: <50ec7a2e0804101318g3d1c84by9521fe2f133b4ec@mail.gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
	<E2E51120-056C-4B39-B2D1-44788E174D81@gmail.com>
	<50ec7a2e0804101318g3d1c84by9521fe2f133b4ec@mail.gmail.com>
Message-ID: <5B80D9CA-1E8D-44C8-B9D4-6C6556919049@gmail.com>

Joe,

On 10 Apr 2008, at 21:18, Joe Lee wrote:

> Does null queue have any special functionality?
>

Not really. As you correctly observe below, the expected behaviour of  
passing an empty queue name is that the broker fills this in for you  
and tells you what name it gave the queue. This is also the behaviour  
of RabbitMQ.

>
> Abstract from the amqp docs:
>
> 2.1.5.3 Constructing a PubSub
> Subscription Queue
>
> Here is the pseudocode
> for creating and binding the pubsub subscription queue:
> Queue.Declare
>     queue=<empty>
>     auto_delete=TRUE
> S:Queue.Declare-Ok
>     queue=tmp.2
> Queue.Bind
>     queue=tmp.2
>     TO exchange=amq.topic
>     WHERE routing_key=STOCK.USD.*
>
> To consume from the subscription queue, the consumer does this:
>
> Basic.Consume
>     queue=tmp.2
>
> When publishing a message, the producer does something like this:
>
> Basic.Publish
>     exchange=amq.topic
>     routing_key=STOCK.USD.IBM
>
>
> Maybe you can tell us what you are trying to achieve.
>
> I just want to do simple publish a message and then consume the  
> message.


This will work with Rabbit. The issue I think you are have is not to  
do with non-compliance with the specification.

As I said in my previous mail, I think you have a bug in your code  
where you match the response of the queue declare call.

In your code, one of the fields of the tuple you are matching on is  
already bound, and as Erlang doesn't allow destructive assignment, it  
treats the assignment operator in this context as a comparison.

The way to fix this is the following:

'queue.declare_ok'{
		       %% Don't use the previously bound variable called Q to store  
the
		       %% queue name field because the Erlang runtime will complain
		       queue = SomeVariableNameOtherThanTheOneYouPreviouslyAssigned,
                        message_count = MessageCount,
                        consumer_count = ConsumerCount}
                        = amqp_channel:call(Channel,QueueDeclare)

and then perform a basic consume using the value stored in the  
variable "SomeVariableNameOtherThanTheOneYouPreviouslyAssigned".

HTH,

Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080410/65236243/attachment.htm 

From adrian at lshift.net  Wed Apr  9 18:30:22 2008
From: adrian at lshift.net (Adrien Pierard)
Date: Wed, 09 Apr 2008 18:30:22 +0100
Subject: [rabbitmq-discuss] RabbitMQ and monit?
In-Reply-To: <81d74c280804090944n1f8d5dabl8b546b3283bf585b@mail.gmail.com>
References: <81d74c280804081202t6d5e842ct539e345bf2bc6d0e@mail.gmail.com>	<167204d20804090752s1c850783h2e35ccb7b5f6393f@mail.gmail.com>	<47FCEFC4.8050108@cohesiveft.com>
	<81d74c280804090944n1f8d5dabl8b546b3283bf585b@mail.gmail.com>
Message-ID: <47FCFD2E.4080201@lshift.net>

Steve Jenson wrote:

> BTW, I had to install the deb on another machine so I could get the
> /etc/init.d script.
> Would it be possible to include it in the binary generic unix server
> distribution?

It could definitely be made available, though I doubt this is the right
package to put it into, as various flavours of Un*x have various init
script systems. However, it is a good idea to have a "reference
implementation" of those scripts available somewhere. Or flavour
specific code maybe provided by rabbit users, as we don't have all the
unices to test those scripts against.

Adrian,

-- 
 [][][] Adrien Pi?rard     | mob_: +44 (0)78 0418 5351
   [][] Senior Developer   | mail: adrian at lshift.net
 []  [] LShift Ltd         | web_: www.lshift.net



From codewalkerjoe at gmail.com  Fri Apr 11 05:24:57 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Fri, 11 Apr 2008 00:24:57 -0400
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
In-Reply-To: <2DFE3F25-9079-49E2-B408-8EFFF0344177@gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
	<2DFE3F25-9079-49E2-B408-8EFFF0344177@gmail.com>
Message-ID: <50ec7a2e0804102124v1bc2ef78rc2b3c53056191e84@mail.gmail.com>

Hello all,

On Thu, Apr 10, 2008 at 6:55 AM, Ben Hood <0x6e6562 at gmail.com> wrote:

> You are trying to match this tuple
>
> #'queue.declare_ok'{queue = Q,
>                        message_count = MessageCount,
>                        consumer_count = ConsumerCount}
>                       = amqp_channel:call(Channel,QueueDeclare)
>
> with this tuple:
>
>  {'queue.declare_ok',
> >                         <<"amq.q.gen1_rabbit at home_20080409224223_
> > ">>,0,0}
> >
>
>
> so that fact that Q, which was previously bound to <<"">> is being
> compared to <"amq.q.gen1_rabbit at home_20080409224223_">> which violates the
> match condition.
>
> To fix this, don't re-use the *variable* Q, because in Erlang, it's not
> really a variable (non-destructive assignment).
>

I have tried what Ben suggested and used a new variable called Q1.  It
helped me get over that problem.  Now I have another issue with the consume
code.

I tried looking into mnesia tables and ets tables, but not much help.
Receive is timing out at after 2000 ->  exit(did_not_receive_message) end.
Only reason for to get timeout is when there isn't a message in the
exchange.  This shouldn't be the case because I just published the message.

 receive
        {#'basic.deliver'{delivery_tag = DeliveryTag}, Content} ->
            #content{payload_fragments_rev = [Payload]} = Content,
            io:format("Message received: ~p~n", [Payload])
    after 2000 ->
        exit(did_not_receive_message)
    end

3> amqp_async:amqp_lifecycle().
Connection: {<0.37.0>,network}
ok
4> amqp_async_consume:amqp_lifecycle_consume().
Connection: {<0.47.0>,network}
Have a look into this one: closed
** exception exit: {{amqp_async_consume,amqp_lifecycle_consume,0},
                    {line,80},
                    did_not_receive_message}
     in function  amqp_async_consume:amqp_lifecycle_consume/0
5>


Also, I captured the packet with Wireshark and getting [Unreassembled Packet
[incorrect TCP checksum]] and [Dissector bug, protocol AMQP:
packet-amqp.c:1252.  My guess is that rabbitmq is communicating with
amqp-0.8 protocol and Wireshark trying to make sense out of those packets
using amqp-0.9 protocol.

Wireshark amqp pub/sub output:

228    2008-04-10 22:50:59.646435000    127.0.0.1    127.0.0.1    TCP
amqp > 37251 [SYN, ACK] Seq=0 Ack=1 Win=6144 Len=0 MSS=16396 TSV=922137
TSER=922137 WS=6
229    2008-04-10 22:50:59.646478000    127.0.0.1    127.0.0.1    TCP
37251 > amqp [ACK] Seq=1 Ack=1 Win=32832 Len=0 TSV=922137 TSER=922137
230    2008-04-10 22:50:59.648524000    127.0.0.1    127.0.0.1    AMQP
Protocol-Header
231    2008-04-10 22:50:59.648557000    127.0.0.1    127.0.0.1    TCP
amqp > 37251 [ACK] Seq=1 Ack=9 Win=6080 Len=0 TSV=922140 TSER=922140
232    2008-04-10 22:50:59.760571000    127.0.0.1    127.0.0.1    AMQP
Connection.Start
233    2008-04-10 22:50:59.760615000    127.0.0.1    127.0.0.1    TCP
37251 > amqp [ACK] Seq=9 Ack=297 Win=33920 Len=0 TSV=922252 TSER=922252
234    2008-04-10 22:50:59.777853000    127.0.0.1    127.0.0.1    AMQP
Connection.Start-Ok
235    2008-04-10 22:50:59.777891000    127.0.0.1    127.0.0.1    TCP
amqp > 37251 [ACK] Seq=297 Ack=139 Win=5952 Len=0 TSV=922269 TSER=922269
236    2008-04-10 22:50:59.782283000    127.0.0.1    127.0.0.1    AMQP
Connection.Tune
237    2008-04-10 22:50:59.782427000    127.0.0.1    127.0.0.1    AMQP
Connection.Tune-Ok
238    2008-04-10 22:50:59.821494000    127.0.0.1    127.0.0.1    TCP
amqp > 37251 [ACK] Seq=317 Ack=159 Win=6144 Len=0 TSV=922313 TSER=922273
239    2008-04-10 22:50:59.821532000    127.0.0.1    127.0.0.1    AMQP
Connection.Open
240    2008-04-10 22:50:59.821704000    127.0.0.1    127.0.0.1    TCP
amqp > 37251 [ACK] Seq=317 Ack=175 Win=6144 Len=0 TSV=922313 TSER=922313
241    2008-04-10 22:50:59.846424000    127.0.0.1    127.0.0.1    AMQP
Connection.Open-Ok
242    2008-04-10 22:50:59.870959000    127.0.0.1    127.0.0.1    AMQP
Channel.Open
243    2008-04-10 22:50:59.877764000    127.0.0.1    127.0.0.1    AMQP
[Unreassembled Packet [incorrect TCP checksum]]
244    2008-04-10 22:50:59.878032000    127.0.0.1    127.0.0.1    AMQP
Access.Request
245    2008-04-10 22:50:59.880196000    127.0.0.1    127.0.0.1    AMQP
Access.Request-Ok
246    2008-04-10 22:50:59.880396000    127.0.0.1    127.0.0.1    AMQP
Exchange.Declare
247    2008-04-10 22:50:59.881167000    127.0.0.1    127.0.0.1    AMQP
Exchange.Declare-Ok
248    2008-04-10 22:50:59.881430000    127.0.0.1    127.0.0.1    AMQP
Basic.Publish Content-Header Content-Body
249    2008-04-10 22:50:59.920486000    127.0.0.1    127.0.0.1    TCP
amqp > 37251 [ACK] Seq=378 Ack=322 Win=6144 Len=0 TSV=922412 TSER=922372
250    2008-04-10 22:50:59.920515000    127.0.0.1    127.0.0.1    AMQP
Channel.Close
251    2008-04-10 22:50:59.920637000    127.0.0.1    127.0.0.1    TCP
amqp > 37251 [ACK] Seq=378 Ack=348 Win=6144 Len=0 TSV=922412 TSER=922412
252    2008-04-10 22:50:59.921226000    127.0.0.1    127.0.0.1    AMQP
Channel.Close-Ok
253    2008-04-10 22:50:59.921528000    127.0.0.1    127.0.0.1    AMQP
[Dissector bug, protocol AMQP: packet-amqp.c:1252: failed assertion "(0)"]
254    2008-04-10 22:50:59.921733000    127.0.0.1    127.0.0.1    AMQP
[Dissector bug, protocol AMQP: packet-amqp.c:1252: failed assertion "(0)"]
255    2008-04-10 22:50:59.921917000    127.0.0.1    127.0.0.1    TCP
37251 > amqp [FIN, ACK] Seq=374 Ack=402 Win=33920 Len=0 TSV=922413
TSER=922413
256    2008-04-10 22:50:59.922030000    127.0.0.1    127.0.0.1    TCP
amqp > 37251 [FIN, ACK] Seq=402 Ack=375 Win=6144 Len=0 TSV=922413
TSER=922413
257    2008-04-10 22:50:59.922055000    127.0.0.1    127.0.0.1    TCP
37251 > amqp [ACK] Seq=375 Ack=403 Win=33920 Len=0 TSV=922413 TSER=922413
258    2008-04-10 22:51:09.766385000    127.0.0.1    127.0.0.1    TCP
48524 > 48428 [PSH, ACK] Seq=249 Ack=249 Win=4096 [TCP CHECKSUM INCORRECT]
Len=4 TSV=932257 TSER=917257
259    2008-04-10 22:51:09.766603000    127.0.0.1    127.0.0.1    TCP
48428 > 48524 [PSH, ACK] Seq=249 Ack=253 Win=513 [TCP CHECKSUM INCORRECT]
Len=4 TSV=932258 TSER=932257
260    2008-04-10 22:51:09.766641000    127.0.0.1    127.0.0.1    TCP
48524 > 48428 [ACK] Seq=253 Ack=253 Win=4095 Len=0 TSV=932258 TSER=932258
261    2008-04-10 22:51:14.617207000    127.0.0.1    127.0.0.1    TCP
33647 > amqp [SYN] Seq=0 Win=32792 Len=0 MSS=16396 TSV=937108 TSER=0 WS=6
262    2008-04-10 22:51:14.617251000    127.0.0.1    127.0.0.1    TCP
amqp > 33647 [SYN, ACK] Seq=0 Ack=1 Win=6144 Len=0 MSS=16396 TSV=937108
TSER=937108 WS=6
263    2008-04-10 22:51:14.617287000    127.0.0.1    127.0.0.1    TCP
33647 > amqp [ACK] Seq=1 Ack=1 Win=32832 Len=0 TSV=937108 TSER=937108
264    2008-04-10 22:51:14.617405000    127.0.0.1    127.0.0.1    AMQP
Protocol-Header
265    2008-04-10 22:51:14.617426000    127.0.0.1    127.0.0.1    TCP
amqp > 33647 [ACK] Seq=1 Ack=9 Win=6080 Len=0 TSV=937108 TSER=937108
266    2008-04-10 22:51:14.618507000    127.0.0.1    127.0.0.1    AMQP
Connection.Start
267    2008-04-10 22:51:14.618540000    127.0.0.1    127.0.0.1    TCP
33647 > amqp [ACK] Seq=9 Ack=297 Win=33920 Len=0 TSV=937110 TSER=937110
268    2008-04-10 22:51:14.618730000    127.0.0.1    127.0.0.1    AMQP
Connection.Start-Ok
269    2008-04-10 22:51:14.618910000    127.0.0.1    127.0.0.1    AMQP
Connection.Tune
270    2008-04-10 22:51:14.619114000    127.0.0.1    127.0.0.1    AMQP
Connection.Tune-Ok
271    2008-04-10 22:51:14.658486000    127.0.0.1    127.0.0.1    TCP
amqp > 33647 [ACK] Seq=317 Ack=159 Win=6144 Len=0 TSV=937150 TSER=937110
272    2008-04-10 22:51:14.658513000    127.0.0.1    127.0.0.1    AMQP
Connection.Open
273    2008-04-10 22:51:14.658533000    127.0.0.1    127.0.0.1    TCP
amqp > 33647 [ACK] Seq=317 Ack=175 Win=6080 Len=0 TSV=937150 TSER=937150
274    2008-04-10 22:51:14.659453000    127.0.0.1    127.0.0.1    AMQP
Connection.Open-Ok
275    2008-04-10 22:51:14.660066000    127.0.0.1    127.0.0.1    AMQP
Channel.Open
276    2008-04-10 22:51:14.660332000    127.0.0.1    127.0.0.1    AMQP
[Unreassembled Packet [incorrect TCP checksum]]
277    2008-04-10 22:51:14.660548000    127.0.0.1    127.0.0.1    AMQP
Access.Request
278    2008-04-10 22:51:14.661351000    127.0.0.1    127.0.0.1    AMQP
Access.Request-Ok
279    2008-04-10 22:51:14.661573000    127.0.0.1    127.0.0.1    AMQP
Queue.Declare
280    2008-04-10 22:51:14.686647000    127.0.0.1    127.0.0.1    AMQP
Queue.Declare-Ok
281    2008-04-10 22:51:14.686925000    127.0.0.1    127.0.0.1    AMQP
Queue.Bind
282    2008-04-10 22:51:14.687699000    127.0.0.1    127.0.0.1    AMQP
Queue.Bind-Ok
283    2008-04-10 22:51:14.687920000    127.0.0.1    127.0.0.1    AMQP
[Unreassembled Packet [incorrect TCP checksum]]
284    2008-04-10 22:51:14.688307000    127.0.0.1    127.0.0.1    AMQP
Basic.Consume-Ok
285    2008-04-10 22:51:14.727486000    127.0.0.1    127.0.0.1    TCP
33647 > amqp [ACK] Seq=352 Ack=489 Win=33920 Len=0 TSV=937219 TSER=937179
286    2008-04-10 22:51:16.689197000    127.0.0.1    127.0.0.1    TCP
33647 > amqp [FIN, ACK] Seq=352 Ack=489 Win=33920 Len=0 TSV=939180
TSER=937179
287    2008-04-10 22:51:16.690130000    127.0.0.1    127.0.0.1    TCP
amqp > 33647 [FIN, ACK] Seq=489 Ack=353 Win=6144 Len=0 TSV=939181
TSER=939180

Thank you all, it's been a long day for me.
Joe
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080411/16f2527e/attachment.htm 

From 0x6e6562 at gmail.com  Fri Apr 11 06:36:16 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 11 Apr 2008 06:36:16 +0100
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
In-Reply-To: <50ec7a2e0804102124v1bc2ef78rc2b3c53056191e84@mail.gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
	<2DFE3F25-9079-49E2-B408-8EFFF0344177@gmail.com>
	<50ec7a2e0804102124v1bc2ef78rc2b3c53056191e84@mail.gmail.com>
Message-ID: <9DBA9574-F661-47CE-A884-F751C28EB0F0@gmail.com>


On 11 Apr 2008, at 05:24, Joe Lee wrote:

> Hello all,
>
> On Thu, Apr 10, 2008 at 6:55 AM, Ben Hood <0x6e6562 at gmail.com> wrote:
> You are trying to match this tuple
>
>
> #'queue.declare_ok'{queue = Q,
>                        message_count = MessageCount,
>                        consumer_count = ConsumerCount}
>                       = amqp_channel:call(Channel,QueueDeclare)
>
> with this tuple:
>
>
> {'queue.declare_ok',
>                         <<"amq.q.gen1_rabbit at home_20080409224223_">>, 
> 0,0}
>
>
> so that fact that Q, which was previously bound to <<"">> is being  
> compared to <"amq.q.gen1_rabbit at home_20080409224223_">> which  
> violates the match condition.
>
> To fix this, don't re-use the *variable* Q, because in Erlang, it's  
> not really a variable (non-destructive assignment).
>
> I have tried what Ben suggested and used a new variable called Q1.   
> It helped me get over that problem.  Now I have another issue with  
> the consume code.
>
> I tried looking into mnesia tables and ets tables, but not much  
> help.  Receive is timing out at after 2000 ->   
> exit(did_not_receive_message) end.  Only reason for to get timeout  
> is when there isn't a message in the exchange.  This shouldn't be  
> the case because I just published the message.
>
>  receive
>         {#'basic.deliver'{delivery_tag = DeliveryTag}, Content} ->
>             #content{payload_fragments_rev = [Payload]} = Content,
>             io:format("Message received: ~p~n", [Payload])
>     after 2000 ->
>         exit(did_not_receive_message)
>     end

f you are using the same code that you posted yesterday, this won't  
work because you are consuming from the wrong queue:

BasicConsume = #'basic.consume'{ticket = Ticket,
                                     queue = Q,
                                     consumer_tag = <<"">>,
                                     no_local = false,
                                     no_ack = true,
                                     exclusive = false,
                                     nowait = false},
     #'basic.consume_ok'{consumer_tag = ConsumerTag}
         = amqp_channel:call(Channel, BasicConsume, self()),

You need to consume from the queue whose name you stored in Q1.

HTH,

Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080411/86b94c19/attachment.htm 

From 0x6e6562 at gmail.com  Fri Apr 11 06:38:12 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 11 Apr 2008 06:38:12 +0100
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
References: <2DFE3F25-9079-49E2-B408-8EFFF0344177@gmail.com>
Message-ID: <3EADA36C-4507-45EB-B188-0D7284B069E3@gmail.com>

Message that didn't get posted to the list yesterday:

Begin forwarded message:

> From: Ben Hood <0x6e6562 at gmail.com>
> Date: 10 April 2008 11:55:49 BST
> To: Joe Lee <codewalkerjoe at gmail.com>
> Subject: Re: [rabbitmq-discuss] pub-sub part 2: erlang consume
>
> Joe,
>
> On 10 Apr 2008, at 00:17, Joe Lee wrote:
>> (rabbit at home)5> amqp_async_consume:amqp_lifecycle_consume().
>> Connection: {<0.178.0>,direct}
>> ** exception exit: {{amqp_async_consume,amqp_lifecycle_consume,0},
>>                    {line,40},
>>                    match,
>>                    [{'queue.declare_ok',
>>                          
>> <<"amq.q.gen1_rabbit at home_20080409224223_">>,0,0}]}
>>     in function  amqp_async_consume:amqp_lifecycle_consume/0
>
> The reason why this is not working is because the LHS does not match  
> the RHS.
>
> You are trying to match this tuple
>
> #'queue.declare_ok'{queue = Q,
>                        message_count = MessageCount,
>                        consumer_count = ConsumerCount}
>                       = amqp_channel:call(Channel,QueueDeclare)
>
> with this tuple:
>
>> {'queue.declare_ok',
>>                          
>> <<"amq.q.gen1_rabbit at home_20080409224223_">>,0,0}
>
>
> so that fact that Q, which was previously bound to <<"">> is being  
> compared to <"amq.q.gen1_rabbit at home_20080409224223_">> which  
> violates the match condition.
>
> To fix this, don't re-use the *variable* Q, because in Erlang, it's  
> not really a variable (non-destructive assignment).
>
> HTH,
>
> Ben

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080411/306a73c0/attachment.htm 

From 0x6e6562 at gmail.com  Fri Apr 11 06:50:18 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 11 Apr 2008 06:50:18 +0100
Subject: [rabbitmq-discuss] pub-sub part 2: erlang consume
In-Reply-To: <50ec7a2e0804102124v1bc2ef78rc2b3c53056191e84@mail.gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
	<2DFE3F25-9079-49E2-B408-8EFFF0344177@gmail.com>
	<50ec7a2e0804102124v1bc2ef78rc2b3c53056191e84@mail.gmail.com>
Message-ID: <B6B36F56-27C0-446A-A601-A023AA250A5C@gmail.com>

Joe,

On 11 Apr 2008, at 05:24, Joe Lee wrote:

> Also, I captured the packet with Wireshark and getting  
> [Unreassembled Packet [incorrect TCP checksum]] and [Dissector bug,  
> protocol AMQP: packet-amqp.c:1252.  My guess is that rabbitmq is  
> communicating with amqp-0.8 protocol and Wireshark trying to make  
> sense out of those packets using amqp-0.9 protocol.

It may be worth your while looking at the code for the test suite that  
is bundled with the client.

Look inside the test_util module.

To run the test within the same VM as the Erlang broker, run  
direct_client_test:test().

These tests execute the entire lifecycle of the AMQP interaction with  
the broker, so it will show you how the protocol looks like from a  
client's perspective when you are programming in Erlang.

HTH,

Ben



From neil.ellis at mangala.co.uk  Fri Apr 11 13:49:18 2008
From: neil.ellis at mangala.co.uk (Neil Ellis)
Date: Fri, 11 Apr 2008 13:49:18 +0100
Subject: [rabbitmq-discuss]
	http://www.theserverside.com/news/thread.tss?thread_id=49013
In-Reply-To: <B6B36F56-27C0-446A-A601-A023AA250A5C@gmail.com>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
	<2DFE3F25-9079-49E2-B408-8EFFF0344177@gmail.com>
	<50ec7a2e0804102124v1bc2ef78rc2b3c53056191e84@mail.gmail.com>
	<B6B36F56-27C0-446A-A601-A023AA250A5C@gmail.com>
Message-ID: <28CBE4FC-E1BF-4908-BBC2-8DC253B40195@mangala.co.uk>

Someone may wish to respond to:

I learn about AMQP at Mulecon. AMQP is a protocol-level standards  
initiative to provide a messaging infrastructure. Jahan told me, "AMQP  
tries to do something very important but may not be attainable.  
Because they are at the protocol level they may wind up being  
extensions on the side. I would bet on the JMS side."

http://www.theserverside.com/news/thread.tss?thread_id=49013
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080411/585627da/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 2431 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080411/585627da/attachment.bin 

From alexis.richardson at cohesiveft.com  Fri Apr 11 18:53:05 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Fri, 11 Apr 2008 18:53:05 +0100
Subject: [rabbitmq-discuss]
	http://www.theserverside.com/news/thread.tss?thread_id=49013
In-Reply-To: <28CBE4FC-E1BF-4908-BBC2-8DC253B40195@mangala.co.uk>
References: <50ec7a2e0804091617u33645e7y90d4e5e1068d2b93@mail.gmail.com>
	<2DFE3F25-9079-49E2-B408-8EFFF0344177@gmail.com>
	<50ec7a2e0804102124v1bc2ef78rc2b3c53056191e84@mail.gmail.com>
	<B6B36F56-27C0-446A-A601-A023AA250A5C@gmail.com>
	<28CBE4FC-E1BF-4908-BBC2-8DC253B40195@mangala.co.uk>
Message-ID: <167204d20804111053u4040096bh7e8fcd111cfaed00@mail.gmail.com>

Blimey!

Thanks Neil.  I met these guys at MuleCon.  Admittedly it was late and
a little dark...  Nevertheless they took the view that JMS was somehow
more generally useful than a protocol and anyone defending protocols
was "taking a very narrow view".  Charitably, this could mean "I need
a model and an API in order to program" - but then the community has
integrated RabbitMQ with Mule and other platforms!  Uncharitably, one
might point out that HTTP, TCP, XMPP, FTP, ... are all good examples
of why protocols beat APIs.

I would be grateful if folks wanted to chip in on the TSS forums: on
the subject of why AMQP is a good thing.  Please, if you do, respect
that JMS has been around for a while and is good for many tasks!

Carl, Martin, Rob, .. that includes you guys too :-)

alexis


On Fri, Apr 11, 2008 at 1:49 PM, Neil Ellis <neil.ellis at mangala.co.uk> wrote:
>
> Someone may wish to respond to:
>
> I learn about AMQP at Mulecon. AMQP is a protocol-level standards initiative
> to provide a messaging infrastructure. Jahan told me, "AMQP tries to do
> something very important but may not be attainable. Because they are at the
> protocol level they may wind up being extensions on the side. I would bet on
> the JMS side."
>
> http://www.theserverside.com/news/thread.tss?thread_id=49013
> _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From glahiru at gmail.com  Mon Apr 14 04:09:03 2008
From: glahiru at gmail.com (lahiru gunathilake)
Date: Mon, 14 Apr 2008 08:39:03 +0530
Subject: [rabbitmq-discuss] Can we download RabbitMQ java broker source
	distribution
Message-ID: <72b4c7110804132009h1dc21484s6f0bfdbbcf8c0e43@mail.gmail.com>

Hi devs,
I'm new to RabbitMQ mailing list and I want to go through the RabbitMQ Java
broker source code. I'm sorry!, I was unable to find the Java broker source
code from your site.It instruct to download the debs not the source. If you
have an SVN location could you please send me a reply to this mail or let me
know URI where you describe about installing using source distribution.

Thanks in advance
Regs
lahiru

-- 
East or West
Mahindians are the
Best... !
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/fcfc650b/attachment.htm 

From glahiru at gmail.com  Mon Apr 14 04:13:39 2008
From: glahiru at gmail.com (lahiru gunathilake)
Date: Mon, 14 Apr 2008 08:43:39 +0530
Subject: [rabbitmq-discuss] Can we download RabbitMQ java broker source
	distribution
In-Reply-To: <72b4c7110804132009h1dc21484s6f0bfdbbcf8c0e43@mail.gmail.com>
References: <72b4c7110804132009h1dc21484s6f0bfdbbcf8c0e43@mail.gmail.com>
Message-ID: <72b4c7110804132013m3d73eb9cld3e015754d982a10@mail.gmail.com>

Hi all,
I found the source distribution but I need the SVN location or CVS location
of the code.

Regs
lahiru

On Mon, Apr 14, 2008 at 8:39 AM, lahiru gunathilake <glahiru at gmail.com>
wrote:

> Hi devs,
> I'm new to RabbitMQ mailing list and I want to go through the RabbitMQ
> Java broker source code. I'm sorry!, I was unable to find the Java broker
> source code from your site.It instruct to download the debs not the source.
> If you have an SVN location could you please send me a reply to this mail or
> let me know URI where you describe about installing using source
> distribution.
>
> Thanks in advance
> Regs
> lahiru
>
> --
> East or West
> Mahindians are the
> Best... !




-- 
East or West
Mahindians are the
Best... !
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/fda9bdbc/attachment.htm 

From 0x6e6562 at gmail.com  Mon Apr 14 06:24:47 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 14 Apr 2008 06:24:47 +0100
Subject: [rabbitmq-discuss] Can we download RabbitMQ java broker source
	distribution
In-Reply-To: <72b4c7110804132013m3d73eb9cld3e015754d982a10@mail.gmail.com>
References: <72b4c7110804132009h1dc21484s6f0bfdbbcf8c0e43@mail.gmail.com>
	<72b4c7110804132013m3d73eb9cld3e015754d982a10@mail.gmail.com>
Message-ID: <87D62CAB-4FD1-4E13-8B88-3ED058D92631@gmail.com>

Lahiru,

On 14 Apr 2008, at 04:13, lahiru gunathilake wrote:
> I found the source distribution but I need the SVN location or CVS  
> location of the code.

At the moment the repository is not publicly available, people  
interested in the source have used snapshots that have published. But  
this is going to be changed very soon - a publicly available repo is  
being set up.

> I'm new to RabbitMQ mailing list and I want to go through the  
> RabbitMQ Java broker source code. I'm sorry!, I was unable to find  
> the Java broker source code from your site.It instruct to download  
> the debs not the source. If you have an SVN location could you  
> please send me a reply to this mail or let me know URI where you  
> describe about installing using source distribution.

BTW, you won't find any broker code written in Java, there is only the  
Java client for AMQP. The broker is written in Erlang.

HTH,

Ben



From pzfreo at gmail.com  Mon Apr 14 10:21:40 2008
From: pzfreo at gmail.com (Paul Fremantle)
Date: Mon, 14 Apr 2008 10:21:40 +0100
Subject: [rabbitmq-discuss] Problem trying out rabbitmq-1.3.0
In-Reply-To: <47FCC9BD.3020409@lshift.net>
References: <88f5d710804090513x4af0d2aby4ec1c7e273378431@mail.gmail.com>
	<47FCC1A6.8010402@wizards.de> <47FCC2E9.9010209@lshift.net>
	<88f5d710804090632n4fe78cb2sceec9ee76f3a5690@mail.gmail.com>
	<47FCC9BD.3020409@lshift.net>
Message-ID: <88f5d710804140221w924e540w65e175b667be1b8c@mail.gmail.com>

I got it running in the end by installing OTP 5.6.2. I think maybe
this was a firewall problem with one of the Erlang processes. I plan
to reinstall 5.5.5 and see if I can get it working on that.

Paul

On Wed, Apr 9, 2008 at 2:50 PM, Matthias Radestock <matthias at lshift.net> wrote:
> Paul,
>
>
>  Paul Fremantle wrote:
>
> > 1. I'm not running Vista - I'm on XP SP2
> >
>
>  ok. It's still worth performing some of the checks suggested in the thread
> at http://www.nabble.com/-erl--name--crashes-on-vista-td15257047.html,
> namely
>
>  1) does 'erl -sname foo' work?
>  if not
>  2) can you start the erlang port mapper daemon (empd) manually?
>  if not
>  3) do you have anything listening on port 4369?
>  if not
>  4) can you start the erlang port mapper daemon on a different port (epmd
> -port 4368, say)?
>
>
>  Matthias.
>



-- 
Paul Fremantle
Co-Founder and CTO, WSO2
Apache Synapse PMC Chair
OASIS WS-RX TC Co-chair

blog: http://pzf.fremantle.org
paul at wso2.com

"Oxygenating the Web Service Platform", www.wso2.com



From codewalkerjoe at gmail.com  Mon Apr 14 16:20:30 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Mon, 14 Apr 2008 11:20:30 -0400
Subject: [rabbitmq-discuss] Just publishing messages causes
	rabbit_writer:mainloop to hang and simultaneous pub problem
Message-ID: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>

I tried to send messages sequentially to a single rabbitmq server running on
127.0.0.1.  After sending messages around 32000, erlang client node
publishing the message crashed.  When I looked at the crash dump, I see
close to 32767 rabbit_writer:mainloop/1 process still in waiting status.  I
am not sure why so many rabbit_writer:mainloop processes are still hanging
around.  Furthermore, I started another node to get published message from
rabbitmq server, rabbitmq server sends basic.get_empty.

crash_dump.erl says:
Maximum number of Erlang Process has reached 32768

Process status in erlang crash dump:

<0.32765.6>    rabbit_writer:mainloop/1    Waiting    136    233    0
<0.32766.13>    rabbit_writer:mainloop/1    Waiting    132    233    0
<0.32767.1>    rabbit_writer:mainloop/1    Waiting    136    233    0


I tried spawning 3 erlang processes simultaneously to publish message using
pmap to a single rabbitmq_server running on 127.0.0.1 and rabbitmq server
throws badarg error.  Here is the error below:

=ERROR REPORT==== 14-Apr-2008::19:43:23 ===
Error in process <0.68.0> on node 'test at home' with exit value:
{badarg,[{erlang,size,[1]},{rabbit_binary_generator,build_content_frames,5},{rabbit_binary_generator,build_simple_content_frames,3},{rabbit_writer,assemble_frames,4},{rabbit_writer,internal_send_command_async...



=ERROR REPORT==== 14-Apr-2008::19:43:23 ===
Error in process <0.70.0> on node 'test at home' with exit value:
{badarg,[{erlang,size,[3]},{rabbit_binary_generator,build_content_frames,5},{rabbit_binary_generator,build_simple_content_frames,3},{rabbit_writer,assemble_frames,4},{rabbit_writer,internal_send_command_async...



=ERROR REPORT==== 14-Apr-2008::19:43:23 ===
Error in process <0.69.0> on node 'test at home' with exit value:
{badarg,[{erlang,size,[2]},{rabbit_binary_generator,build_content_frames,5},{rabbit_binary_generator,build_simple_content_frames,3},{rabbit_writer,assemble_frames,4},{rabbit_writer,internal_send_command_async...


Have a look into this one: closed
Have a look into this one: closed
Have a look into this one: closed
(test at home)2>

I am not sure what these errors mean.  Can someone tell me what I am doing
wrong?

Thank you,
Joe
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/ac089a06/attachment.htm 

From 0x6e6562 at gmail.com  Mon Apr 14 16:39:58 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 14 Apr 2008 16:39:58 +0100
Subject: [rabbitmq-discuss] Just publishing messages causes
	rabbit_writer:mainloop to hang and simultaneous pub problem
In-Reply-To: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
References: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
Message-ID: <67822B21-D550-4D5B-B054-4C0C652D0AF1@gmail.com>

Hi Joe,

Could you send the complete source code of the test that causes these  
problems so that we can have a look at this, please?

Thx,

Ben

On 14 Apr 2008, at 16:20, Joe Lee wrote:

> I tried to send messages sequentially to a single rabbitmq server  
> running on 127.0.0.1.  After sending messages around 32000, erlang  
> client node publishing the message crashed.  When I looked at the  
> crash dump, I see close to 32767 rabbit_writer:mainloop/1 process  
> still in waiting status.  I am not sure why so many  
> rabbit_writer:mainloop processes are still hanging around.   
> Furthermore, I started another node to get published message from  
> rabbitmq server, rabbitmq server sends basic.get_empty.
>
> crash_dump.erl says:
> Maximum number of Erlang Process has reached 32768
>
> Process status in erlang crash dump:
>
> <0.32765.6>    rabbit_writer:mainloop/1    Waiting    136    233    0
> <0.32766.13>    rabbit_writer:mainloop/1    Waiting    132    233    0
> <0.32767.1>    rabbit_writer:mainloop/1    Waiting    136    233    0
>
>
> I tried spawning 3 erlang processes simultaneously to publish  
> message using pmap to a single rabbitmq_server running on 127.0.0.1  
> and rabbitmq server throws badarg error.  Here is the error below:
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.68.0> on node 'test at home' with exit value:  
> {badarg,[{erlang,size,[1]}, 
> {rabbit_binary_generator,build_content_frames,5}, 
> {rabbit_binary_generator,build_simple_content_frames,3}, 
> {rabbit_writer,assemble_frames,4}, 
> {rabbit_writer,internal_send_command_async...
>
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.70.0> on node 'test at home' with exit value:  
> {badarg,[{erlang,size,[3]}, 
> {rabbit_binary_generator,build_content_frames,5}, 
> {rabbit_binary_generator,build_simple_content_frames,3}, 
> {rabbit_writer,assemble_frames,4}, 
> {rabbit_writer,internal_send_command_async...
>
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.69.0> on node 'test at home' with exit value:  
> {badarg,[{erlang,size,[2]}, 
> {rabbit_binary_generator,build_content_frames,5}, 
> {rabbit_binary_generator,build_simple_content_frames,3}, 
> {rabbit_writer,assemble_frames,4}, 
> {rabbit_writer,internal_send_command_async...
>
> Have a look into this one: closed
> Have a look into this one: closed
> Have a look into this one: closed
> (test at home)2>
>
> I am not sure what these errors mean.  Can someone tell me what I am  
> doing wrong?
>
> Thank you,
> Joe
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/0f319282/attachment.htm 

From 0x6e6562 at gmail.com  Mon Apr 14 16:43:53 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 14 Apr 2008 16:43:53 +0100
Subject: [rabbitmq-discuss] Just publishing messages causes
	rabbit_writer:mainloop to hang and simultaneous pub problem
In-Reply-To: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
References: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
Message-ID: <F03F16DC-93AE-458B-8238-05AC30477747@gmail.com>

Joe,

You are getting a {error, closed} message from the socket.

Without having seen any of the code that produces this error, is it  
possible that there is no TCP connection to the broker?

HTH,

Ben

On 14 Apr 2008, at 16:20, Joe Lee wrote:

> I tried to send messages sequentially to a single rabbitmq server  
> running on 127.0.0.1.  After sending messages around 32000, erlang  
> client node publishing the message crashed.  When I looked at the  
> crash dump, I see close to 32767 rabbit_writer:mainloop/1 process  
> still in waiting status.  I am not sure why so many  
> rabbit_writer:mainloop processes are still hanging around.   
> Furthermore, I started another node to get published message from  
> rabbitmq server, rabbitmq server sends basic.get_empty.
>
> crash_dump.erl says:
> Maximum number of Erlang Process has reached 32768
>
> Process status in erlang crash dump:
>
> <0.32765.6>    rabbit_writer:mainloop/1    Waiting    136    233    0
> <0.32766.13>    rabbit_writer:mainloop/1    Waiting    132    233    0
> <0.32767.1>    rabbit_writer:mainloop/1    Waiting    136    233    0
>
>
> I tried spawning 3 erlang processes simultaneously to publish  
> message using pmap to a single rabbitmq_server running on 127.0.0.1  
> and rabbitmq server throws badarg error.  Here is the error below:
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.68.0> on node 'test at home' with exit value:  
> {badarg,[{erlang,size,[1]}, 
> {rabbit_binary_generator,build_content_frames,5}, 
> {rabbit_binary_generator,build_simple_content_frames,3}, 
> {rabbit_writer,assemble_frames,4}, 
> {rabbit_writer,internal_send_command_async...
>
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.70.0> on node 'test at home' with exit value:  
> {badarg,[{erlang,size,[3]}, 
> {rabbit_binary_generator,build_content_frames,5}, 
> {rabbit_binary_generator,build_simple_content_frames,3}, 
> {rabbit_writer,assemble_frames,4}, 
> {rabbit_writer,internal_send_command_async...
>
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.69.0> on node 'test at home' with exit value:  
> {badarg,[{erlang,size,[2]}, 
> {rabbit_binary_generator,build_content_frames,5}, 
> {rabbit_binary_generator,build_simple_content_frames,3}, 
> {rabbit_writer,assemble_frames,4}, 
> {rabbit_writer,internal_send_command_async...
>
> Have a look into this one: closed
> Have a look into this one: closed
> Have a look into this one: closed
> (test at home)2>
>
> I am not sure what these errors mean.  Can someone tell me what I am  
> doing wrong?
>
> Thank you,
> Joe
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/1125994c/attachment.htm 

From codewalkerjoe at gmail.com  Mon Apr 14 18:59:37 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Mon, 14 Apr 2008 13:59:37 -0400
Subject: [rabbitmq-discuss] Just publishing messages causes
	rabbit_writer:mainloop to hang and simultaneous pub problem
In-Reply-To: <67822B21-D550-4D5B-B054-4C0C652D0AF1@gmail.com>
References: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
	<67822B21-D550-4D5B-B054-4C0C652D0AF1@gmail.com>
Message-ID: <50ec7a2e0804141059m78951951lb0a83c78ea950b57@mail.gmail.com>

Here are the files.  I think problem maybe how the Payload in amqp_async_pub
is assigned setup.  I maybe wrong.

Joe

On Mon, Apr 14, 2008 at 11:39 AM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Hi Joe,
>
> Could you send the complete source code of the test that causes these
> problems so that we can have a look at this, please?
>
> Thx,
>
> Ben
>
> On 14 Apr 2008, at 16:20, Joe Lee wrote:
>
> I tried to send messages sequentially to a single rabbitmq server running
> on 127.0.0.1.  After sending messages around 32000, erlang client node
> publishing the message crashed.  When I looked at the crash dump, I see
> close to 32767 rabbit_writer:mainloop/1 process still in waiting status.  I
> am not sure why so many rabbit_writer:mainloop processes are still hanging
> around.  Furthermore, I started another node to get published message from
> rabbitmq server, rabbitmq server sends basic.get_empty.
>
> crash_dump.erl says:
> Maximum number of Erlang Process has reached 32768
>
> Process status in erlang crash dump:
>
> <0.32765.6>    rabbit_writer:mainloop/1    Waiting    136    233    0
> <0.32766.13>    rabbit_writer:mainloop/1    Waiting    132    233    0
> <0.32767.1>    rabbit_writer:mainloop/1    Waiting    136    233    0
>
>
> I tried spawning 3 erlang processes simultaneously to publish message
> using pmap to a single rabbitmq_server running on 127.0.0.1 and rabbitmq
> server throws badarg error.  Here is the error below:
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.68.0> on node 'test at home' with exit value:
> {badarg,[{erlang,size,[1]},{rabbit_binary_generator,build_content_frames,5},{rabbit_binary_generator,build_simple_content_frames,3},{rabbit_writer,assemble_frames,4},{rabbit_writer,internal_send_command_async...
>
>
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.70.0> on node 'test at home' with exit value:
> {badarg,[{erlang,size,[3]},{rabbit_binary_generator,build_content_frames,5},{rabbit_binary_generator,build_simple_content_frames,3},{rabbit_writer,assemble_frames,4},{rabbit_writer,internal_send_command_async...
>
>
>
> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
> Error in process <0.69.0> on node 'test at home' with exit value:
> {badarg,[{erlang,size,[2]},{rabbit_binary_generator,build_content_frames,5},{rabbit_binary_generator,build_simple_content_frames,3},{rabbit_writer,assemble_frames,4},{rabbit_writer,internal_send_command_async...
>
>
> Have a look into this one: closed
> Have a look into this one: closed
> Have a look into this one: closed
> (test at home)2>
>
> I am not sure what these errors mean.  Can someone tell me what I am doing
> wrong?
>
> Thank you,
> Joe
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/5374c750/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: amqp_async_consume.erl
Type: application/octet-stream
Size: 2691 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/5374c750/attachment.obj 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: amqp_async_pub.erl
Type: application/octet-stream
Size: 2745 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/5374c750/attachment-0001.obj 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: my_pmap.erl
Type: application/octet-stream
Size: 540 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/5374c750/attachment-0002.obj 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbit_test.erl
Type: application/octet-stream
Size: 577 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/5374c750/attachment-0003.obj 

From 0x6e6562 at gmail.com  Mon Apr 14 22:00:46 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 14 Apr 2008 22:00:46 +0100
Subject: [rabbitmq-discuss] Just publishing messages causes
	rabbit_writer:mainloop to hang and simultaneous pub problem
In-Reply-To: <50ec7a2e0804141059m78951951lb0a83c78ea950b57@mail.gmail.com>
References: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
	<67822B21-D550-4D5B-B054-4C0C652D0AF1@gmail.com>
	<50ec7a2e0804141059m78951951lb0a83c78ea950b57@mail.gmail.com>
Message-ID: <57C8F7AF-B2F0-4E6A-91BD-C7ABB861F219@gmail.com>

Joe,

A cursory glance indicates that you are using the wrong routing key to  
publish to the exchange.

If you use a.b.c.d instead of a.b.c.*, then when a queue binds itself  
to a.b.c.*, messages will be delivered to it.

Hence why you are getting a get_empty.

So just change the routing key in the amqp_async_pub module.

As for the errors you are seeing, the reason is because you are  
passing in integers as the publish payload.

The API however, expects payload fragments to be opaque binaries  
rather than any Erlang type.

So to fix this problem, just convert whatever payload fragment you  
want to send to a binary.

In your case you are sending integers, so you could pass in something  
like <<MyInteger:32>> instead of MyInteger.

This may be a question for the design of the API. It may well be  
worthwile performing a guard condition (i.e. is_binary(Payload)) on  
the submission of a message. I'll look into this.

BTW, if you don't supply a host name when starting the connection, the  
client will start in a direct mode using native Erlang message passing  
rather than AMQP wire framing. This means that the client and server  
run in the same interpreter and eliminate the network overhead.

HTH,

Ben

On 14 Apr 2008, at 18:59, Joe Lee wrote:

> Here are the files.  I think problem maybe how the Payload in  
> amqp_async_pub is assigned setup.  I maybe wrong.
>
> Joe
>
> On Mon, Apr 14, 2008 at 11:39 AM, Ben Hood <0x6e6562 at gmail.com> wrote:
> Hi Joe,
>
> Could you send the complete source code of the test that causes  
> these problems so that we can have a look at this, please?
>
> Thx,
>
> Ben
>
> On 14 Apr 2008, at 16:20, Joe Lee wrote:
>> I tried to send messages sequentially to a single rabbitmq server  
>> running on 127.0.0.1.  After sending messages around 32000, erlang  
>> client node publishing the message crashed.  When I looked at the  
>> crash dump, I see close to 32767 rabbit_writer:mainloop/1 process  
>> still in waiting status.  I am not sure why so many  
>> rabbit_writer:mainloop processes are still hanging around.   
>> Furthermore, I started another node to get published message from  
>> rabbitmq server, rabbitmq server sends basic.get_empty.
>>
>> crash_dump.erl says:
>> Maximum number of Erlang Process has reached 32768
>>
>> Process status in erlang crash dump:
>>
>> <0.32765.6>    rabbit_writer:mainloop/1    Waiting    136    233    0
>> <0.32766.13>    rabbit_writer:mainloop/1    Waiting    132     
>> 233    0
>> <0.32767.1>    rabbit_writer:mainloop/1    Waiting    136    233    0
>>
>>
>> I tried spawning 3 erlang processes simultaneously to publish  
>> message using pmap to a single rabbitmq_server running on 127.0.0.1  
>> and rabbitmq server throws badarg error.  Here is the error below:
>>
>> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
>> Error in process <0.68.0> on node 'test at home' with exit value:  
>> {badarg,[{erlang,size,[1]}, 
>> {rabbit_binary_generator,build_content_frames,5}, 
>> {rabbit_binary_generator,build_simple_content_frames,3}, 
>> {rabbit_writer,assemble_frames,4}, 
>> {rabbit_writer,internal_send_command_async...
>>
>>
>> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
>> Error in process <0.70.0> on node 'test at home' with exit value:  
>> {badarg,[{erlang,size,[3]}, 
>> {rabbit_binary_generator,build_content_frames,5}, 
>> {rabbit_binary_generator,build_simple_content_frames,3}, 
>> {rabbit_writer,assemble_frames,4}, 
>> {rabbit_writer,internal_send_command_async...
>>
>>
>> =ERROR REPORT==== 14-Apr-2008::19:43:23 ===
>> Error in process <0.69.0> on node 'test at home' with exit value:  
>> {badarg,[{erlang,size,[2]}, 
>> {rabbit_binary_generator,build_content_frames,5}, 
>> {rabbit_binary_generator,build_simple_content_frames,3}, 
>> {rabbit_writer,assemble_frames,4}, 
>> {rabbit_writer,internal_send_command_async...
>>
>> Have a look into this one: closed
>> Have a look into this one: closed
>> Have a look into this one: closed
>> (test at home)2>
>>
>> I am not sure what these errors mean.  Can someone tell me what I  
>> am doing wrong?
>>
>> Thank you,
>> Joe
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
> < 
> amqp_async_consume 
> .erl><amqp_async_pub.erl><my_pmap.erl><rabbit_test.erl>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080414/844847af/attachment.htm 

From glahiru at gmail.com  Tue Apr 15 12:33:43 2008
From: glahiru at gmail.com (lahiru gunathilake)
Date: Tue, 15 Apr 2008 17:03:43 +0530
Subject: [rabbitmq-discuss] Build fails in with Java client
Message-ID: <72b4c7110804150433u1929ddcdi71063259243fb99f@mail.gmail.com>

Hi all,
I've downloaded the RabbitMQ source distribution and I was able to build the
server by refering the installation guide in source distribution.
But when I tried to build Java client it gives me this out put. build
breaks..
================================================================================
Buildfile: build.xml

exslt:

amqp-generate:
     [xslt] DEPRECATED - xalan processor is deprecated. Use trax instead.
     [xslt] DEPRECATED - xslp processor is deprecated. Use trax instead.
     [xslt] java.lang.ClassNotFoundException:
org.apache.tools.ant.taskdefs.optional.XslpLiaison
     [xslt]     at
org.apache.tools.ant.AntClassLoader.findClassInComponents(AntClassLoader.java:1166)
     [xslt]     at
org.apache.tools.ant.AntClassLoader.findClass(AntClassLoader.java:1107)
     [xslt]     at
org.apache.tools.ant.AntClassLoader.loadClass(AntClassLoader.java:977)
     [xslt]     at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
     [xslt]     at
java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
     [xslt]     at java.lang.Class.forName0(Native Method)
     [xslt]     at java.lang.Class.forName(Class.java:242)
     [xslt]     at
org.apache.tools.ant.taskdefs.XSLTProcess.loadClass(XSLTProcess.java:423)
     [xslt]     at
org.apache.tools.ant.taskdefs.XSLTProcess.resolveProcessor(XSLTProcess.java:397)
     [xslt]     at
org.apache.tools.ant.taskdefs.XSLTProcess.getLiaison(XSLTProcess.java:619)
     [xslt]     at
org.apache.tools.ant.taskdefs.XSLTProcess.execute(XSLTProcess.java:212)
     [xslt]     at
org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)
     [xslt]     at org.apache.tools.ant.Task.perform(Task.java:364)
     [xslt]     at org.apache.tools.ant.Target.execute(Target.java:341)
     [xslt]     at org.apache.tools.ant.Target.performTasks(Target.java:369)
     [xslt]     at
org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)
     [xslt]     at
org.apache.tools.ant.Project.executeTarget(Project.java:1185)
     [xslt]     at
org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)
     [xslt]     at
org.apache.tools.ant.Project.executeTargets(Project.java:1068)
     [xslt]     at org.apache.tools.ant.Main.runBuild(Main.java:668)
     [xslt]     at org.apache.tools.ant.Main.startAnt(Main.java:187)
     [xslt]     at
org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)
     [xslt]     at
org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)
     [xslt] java.lang.ClassNotFoundException:
org.apache.tools.ant.taskdefs.optional.XalanLiaison
     [xslt]     at
org.apache.tools.ant.AntClassLoader.findClassInComponents(AntClassLoader.java:1166)
     [xslt]     at
org.apache.tools.ant.AntClassLoader.findClass(AntClassLoader.java:1107)
     [xslt]     at
org.apache.tools.ant.AntClassLoader.loadClass(AntClassLoader.java:977)
     [xslt]     at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
     [xslt]     at
java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
     [xslt]     at java.lang.Class.forName0(Native Method)
     [xslt]     at java.lang.Class.forName(Class.java:242)
     [xslt]     at
org.apache.tools.ant.taskdefs.XSLTProcess.loadClass(XSLTProcess.java:423)
     [xslt]     at
org.apache.tools.ant.taskdefs.XSLTProcess.resolveProcessor(XSLTProcess.java:402)
     [xslt]     at
org.apache.tools.ant.taskdefs.XSLTProcess.getLiaison(XSLTProcess.java:616)
     [xslt]     at
org.apache.tools.ant.taskdefs.XSLTProcess.execute(XSLTProcess.java:212)
     [xslt]     at
org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)
     [xslt]     at org.apache.tools.ant.Task.perform(Task.java:364)
     [xslt]     at org.apache.tools.ant.Target.execute(Target.java:341)
     [xslt]     at org.apache.tools.ant.Target.performTasks(Target.java:369)
     [xslt]     at
org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)
     [xslt]     at
org.apache.tools.ant.Project.executeTarget(Project.java:1185)
     [xslt]     at
org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)
     [xslt]     at
org.apache.tools.ant.Project.executeTargets(Project.java:1068)
     [xslt]     at org.apache.tools.ant.Main.runBuild(Main.java:668)
     [xslt]     at org.apache.tools.ant.Main.startAnt(Main.java:187)
     [xslt]     at
org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)
     [xslt]     at
org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)

BUILD FAILED
/home/lahiru/software/rabbitmq-1.3.0/java/build.xml:66:
java.lang.ClassNotFoundException:
org.apache.tools.ant.taskdefs.optional.TraXLiaison

Total time: 1 second
===============================================================================
Any body can help me what's wrong with this.

Regs
lahiru
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080415/27bc30b6/attachment.htm 

From glahiru at gmail.com  Tue Apr 15 12:59:23 2008
From: glahiru at gmail.com (lahiru gunathilake)
Date: Tue, 15 Apr 2008 17:29:23 +0530
Subject: [rabbitmq-discuss] Build fails in with Java client
In-Reply-To: <72b4c7110804150433u1929ddcdi71063259243fb99f@mail.gmail.com>
References: <72b4c7110804150433u1929ddcdi71063259243fb99f@mail.gmail.com>
Message-ID: <72b4c7110804150459j784e055dqf22c8aff8e46a123@mail.gmail.com>

Hi Alexis and devs,

With the assist of Alexis I installed ant-optional and then It build
successfully.
I think If we can add that to Installation guide that would be great. But I
don't know it might be an obvious one to install ant-optional with ant
installation. This is just a suggession.

Thanks in advance
Regs
lahiru

On Tue, Apr 15, 2008 at 5:03 PM, lahiru gunathilake <glahiru at gmail.com>
wrote:

> Hi all,
> I've downloaded the RabbitMQ source distribution and I was able to build
> the server by refering the installation guide in source distribution.
> But when I tried to build Java client it gives me this out put. build
> breaks..
>
> ================================================================================
> Buildfile: build.xml
>
> exslt:
>
> amqp-generate:
>      [xslt] DEPRECATED - xalan processor is deprecated. Use trax instead.
>      [xslt] DEPRECATED - xslp processor is deprecated. Use trax instead.
>      [xslt] java.lang.ClassNotFoundException:
> org.apache.tools.ant.taskdefs.optional.XslpLiaison
>      [xslt]     at
> org.apache.tools.ant.AntClassLoader.findClassInComponents(AntClassLoader.java:1166)
>      [xslt]     at
> org.apache.tools.ant.AntClassLoader.findClass(AntClassLoader.java:1107)
>      [xslt]     at
> org.apache.tools.ant.AntClassLoader.loadClass(AntClassLoader.java:977)
>      [xslt]     at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
>      [xslt]     at
> java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
>      [xslt]     at java.lang.Class.forName0(Native Method)
>      [xslt]     at java.lang.Class.forName(Class.java:242)
>      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.loadClass(XSLTProcess.java:423)
>      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.resolveProcessor(XSLTProcess.java:397)
>      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.getLiaison(XSLTProcess.java:619)
>      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.execute(XSLTProcess.java:212)
>      [xslt]     at
> org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)
>      [xslt]     at org.apache.tools.ant.Task.perform(Task.java:364)
>      [xslt]     at org.apache.tools.ant.Target.execute(Target.java:341)
>      [xslt]     at
> org.apache.tools.ant.Target.performTasks(Target.java:369)
>      [xslt]     at
> org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)
>      [xslt]     at
> org.apache.tools.ant.Project.executeTarget(Project.java:1185)
>      [xslt]     at
> org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)
>      [xslt]     at
> org.apache.tools.ant.Project.executeTargets(Project.java:1068)
>      [xslt]     at org.apache.tools.ant.Main.runBuild(Main.java:668)
>      [xslt]     at org.apache.tools.ant.Main.startAnt(Main.java:187)
>      [xslt]     at
> org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)
>      [xslt]     at
> org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)
>      [xslt] java.lang.ClassNotFoundException:
> org.apache.tools.ant.taskdefs.optional.XalanLiaison
>      [xslt]     at
> org.apache.tools.ant.AntClassLoader.findClassInComponents(AntClassLoader.java:1166)
>      [xslt]     at
> org.apache.tools.ant.AntClassLoader.findClass(AntClassLoader.java:1107)
>      [xslt]     at
> org.apache.tools.ant.AntClassLoader.loadClass(AntClassLoader.java:977)
>      [xslt]     at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
>      [xslt]     at
> java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
>      [xslt]     at java.lang.Class.forName0(Native Method)
>      [xslt]     at java.lang.Class.forName(Class.java:242)
>      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.loadClass(XSLTProcess.java:423)
>      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.resolveProcessor(XSLTProcess.java:402)
>      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.getLiaison(XSLTProcess.java:616)
>      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.execute(XSLTProcess.java:212)
>      [xslt]     at
> org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)
>      [xslt]     at org.apache.tools.ant.Task.perform(Task.java:364)
>      [xslt]     at org.apache.tools.ant.Target.execute(Target.java:341)
>      [xslt]     at
> org.apache.tools.ant.Target.performTasks(Target.java:369)
>      [xslt]     at
> org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)
>      [xslt]     at
> org.apache.tools.ant.Project.executeTarget(Project.java:1185)
>      [xslt]     at
> org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)
>      [xslt]     at
> org.apache.tools.ant.Project.executeTargets(Project.java:1068)
>      [xslt]     at org.apache.tools.ant.Main.runBuild(Main.java:668)
>      [xslt]     at org.apache.tools.ant.Main.startAnt(Main.java:187)
>      [xslt]     at
> org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)
>      [xslt]     at
> org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)
>
> BUILD FAILED
> /home/lahiru/software/rabbitmq-1.3.0/java/build.xml:66:
> java.lang.ClassNotFoundException:
> org.apache.tools.ant.taskdefs.optional.TraXLiaison
>
> Total time: 1 second
>
> ===============================================================================
> Any body can help me what's wrong with this.
>
> Regs
> lahiru
>
>
>


-- 
East or West
Mahindians are the
Best... !
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080415/1f6041e8/attachment.htm 

From alexis.richardson at cohesiveft.com  Tue Apr 15 13:01:07 2008
From: alexis.richardson at cohesiveft.com (Alexis Richardson)
Date: Tue, 15 Apr 2008 13:01:07 +0100
Subject: [rabbitmq-discuss] Build fails in with Java client
In-Reply-To: <72b4c7110804150459j784e055dqf22c8aff8e46a123@mail.gmail.com>
References: <72b4c7110804150433u1929ddcdi71063259243fb99f@mail.gmail.com>
	<72b4c7110804150459j784e055dqf22c8aff8e46a123@mail.gmail.com>
Message-ID: <167204d20804150501h1e4b2047hef1881d876450785@mail.gmail.com>

Thanks Lahiru, we always want to make our docs better.  Not everything
is obvious :-)

alexis



On Tue, Apr 15, 2008 at 12:59 PM, lahiru gunathilake <glahiru at gmail.com> wrote:
> Hi Alexis and devs,
>
> With the assist of Alexis I installed ant-optional and then It build
> successfully.
> I think If we can add that to Installation guide that would be great. But I
> don't know it might be an obvious one to install ant-optional with ant
> installation. This is just a suggession.
>
> Thanks in advance
> Regs
> lahiru
>
>
>
> On Tue, Apr 15, 2008 at 5:03 PM, lahiru gunathilake <glahiru at gmail.com>
> wrote:
> > Hi all,
> > I've downloaded the RabbitMQ source distribution and I was able to build
> the server by refering the installation guide in source distribution.
> > But when I tried to build Java client it gives me this out put. build
> breaks..
> >
> ================================================================================
> > Buildfile: build.xml
> >
> > exslt:
> >
> > amqp-generate:
> >      [xslt] DEPRECATED - xalan processor is deprecated. Use trax instead.
> >      [xslt] DEPRECATED - xslp processor is deprecated. Use trax instead.
> >      [xslt] java.lang.ClassNotFoundException:
> org.apache.tools.ant.taskdefs.optional.XslpLiaison
> >      [xslt]     at
> org.apache.tools.ant.AntClassLoader.findClassInComponents(AntClassLoader.java:1166)
> >      [xslt]     at
> org.apache.tools.ant.AntClassLoader.findClass(AntClassLoader.java:1107)
> >      [xslt]     at
> org.apache.tools.ant.AntClassLoader.loadClass(AntClassLoader.java:977)
> >      [xslt]     at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
> >      [xslt]     at
> java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
> >      [xslt]     at java.lang.Class.forName0(Native Method)
> >      [xslt]     at java.lang.Class.forName(Class.java:242)
> >      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.loadClass(XSLTProcess.java:423)
> >      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.resolveProcessor(XSLTProcess.java:397)
> >      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.getLiaison(XSLTProcess.java:619)
> >      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.execute(XSLTProcess.java:212)
> >      [xslt]     at
> org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)
> >      [xslt]     at org.apache.tools.ant.Task.perform(Task.java:364)
> >      [xslt]     at org.apache.tools.ant.Target.execute(Target.java:341)
> >      [xslt]     at
> org.apache.tools.ant.Target.performTasks(Target.java:369)
> >      [xslt]     at
> org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)
> >      [xslt]     at
> org.apache.tools.ant.Project.executeTarget(Project.java:1185)
> >      [xslt]     at
> org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)
> >      [xslt]     at
> org.apache.tools.ant.Project.executeTargets(Project.java:1068)
> >      [xslt]     at org.apache.tools.ant.Main.runBuild(Main.java:668)
> >      [xslt]     at org.apache.tools.ant.Main.startAnt(Main.java:187)
> >      [xslt]     at
> org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)
> >      [xslt]     at
> org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)
> >      [xslt] java.lang.ClassNotFoundException:
> org.apache.tools.ant.taskdefs.optional.XalanLiaison
> >      [xslt]     at
> org.apache.tools.ant.AntClassLoader.findClassInComponents(AntClassLoader.java:1166)
> >      [xslt]     at
> org.apache.tools.ant.AntClassLoader.findClass(AntClassLoader.java:1107)
> >      [xslt]     at
> org.apache.tools.ant.AntClassLoader.loadClass(AntClassLoader.java:977)
> >      [xslt]     at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
> >      [xslt]     at
> java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
> >      [xslt]     at java.lang.Class.forName0(Native Method)
> >      [xslt]     at java.lang.Class.forName(Class.java:242)
> >      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.loadClass(XSLTProcess.java:423)
> >      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.resolveProcessor(XSLTProcess.java:402)
> >      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.getLiaison(XSLTProcess.java:616)
> >      [xslt]     at
> org.apache.tools.ant.taskdefs.XSLTProcess.execute(XSLTProcess.java:212)
> >      [xslt]     at
> org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)
> >      [xslt]     at org.apache.tools.ant.Task.perform(Task.java:364)
> >      [xslt]     at org.apache.tools.ant.Target.execute(Target.java:341)
> >      [xslt]     at
> org.apache.tools.ant.Target.performTasks(Target.java:369)
> >      [xslt]     at
> org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)
> >      [xslt]     at
> org.apache.tools.ant.Project.executeTarget(Project.java:1185)
> >      [xslt]     at
> org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)
> >      [xslt]     at
> org.apache.tools.ant.Project.executeTargets(Project.java:1068)
> >      [xslt]     at org.apache.tools.ant.Main.runBuild(Main.java:668)
> >      [xslt]     at org.apache.tools.ant.Main.startAnt(Main.java:187)
> >      [xslt]     at
> org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)
> >      [xslt]     at
> org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)
> >
> > BUILD FAILED
> > /home/lahiru/software/rabbitmq-1.3.0/java/build.xml:66:
> java.lang.ClassNotFoundException:
> org.apache.tools.ant.taskdefs.optional.TraXLiaison
> >
> > Total time: 1 second
> >
> ===============================================================================
> > Any body can help me what's wrong with this.
> >
> > Regs
> > lahiru
> >
> >
> >
>
>
>
> --
> East or West
> Mahindians are the
> Best... !
> _______________________________________________
>  rabbitmq-discuss mailing list
>  rabbitmq-discuss at lists.rabbitmq.com
>  http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>



-- 
Alexis Richardson
+44 20 7617 7339 (UK)
+44 77 9865 2911 (cell)
+1 650 206 2517 (US)



From matthias at lshift.net  Tue Apr 15 20:44:23 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 15 Apr 2008 20:44:23 +0100
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>
	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>
Message-ID: <48050597.1070600@lshift.net>

Michael,

Michael Arnoldus wrote:

> Thank you for your suggestion. There is no strace on Mac OS X, but I did 
> find a way to see what the C-program was doing (see below).

I can now reliably reproduce the problem on a Leopard machine at our 
offices, running on a ppc platform with Erlang R12B-0 from macports and 
the latest development snapshot of rabbit.

The results indicate that this is probably a bug in Leopard, or a bug in 
the Erlang runtime that only manifests itself on Leopard.

The trigger appears to be a tcp client closing the socket when the 
server is in the middle of writing to its peer.

The next step is to construct a test case that doesn't involve rabbit.


Matthias.



From chime at mu.dk  Tue Apr 15 21:08:01 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Tue, 15 Apr 2008 22:08:01 +0200
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <48050597.1070600@lshift.net>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>
	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>
	<48050597.1070600@lshift.net>
Message-ID: <5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>

Matthias,

Thanks - wonderful - and it fits with the traces I observed.

Since we are running on Intel HW, let me know if I can help by running  
stuff or reproduce the problem.

Michael

On Apr 15, 2008, at 21:44 , Matthias Radestock wrote:

> Michael,
>
> Michael Arnoldus wrote:
>
>> Thank you for your suggestion. There is no strace on Mac OS X, but  
>> I did find a way to see what the C-program was doing (see below).
>
> I can now reliably reproduce the problem on a Leopard machine at our  
> offices, running on a ppc platform with Erlang R12B-0 from macports  
> and the latest development snapshot of rabbit.
>
> The results indicate that this is probably a bug in Leopard, or a  
> bug in the Erlang runtime that only manifests itself on Leopard.
>
> The trigger appears to be a tcp client closing the socket when the  
> server is in the middle of writing to its peer.
>
> The next step is to construct a test case that doesn't involve rabbit.
>
>
> Matthias.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080415/df1b2bd8/attachment.bin 

From matthias at lshift.net  Tue Apr 15 21:15:24 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 15 Apr 2008 21:15:24 +0100
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>
	<5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>
Message-ID: <48050CDC.50802@lshift.net>

Michael,

Michael Arnoldus wrote:
> Since we are running on Intel HW, let me know if I can help by running 
> stuff or reproduce the problem.

Thanks for the offer. I might take you up on it once I have a simple 
test case ready.

Also, a minor correction to what I wrote ...

> On Apr 15, 2008, at 21:44 , Matthias Radestock wrote:
>> I can now reliably reproduce the problem on a Leopard machine at our 
>> offices, running on a ppc platform with Erlang R12B-0 from macports 
>> and the latest development snapshot of rabbit.

It's R12B-2 actually.


Matthias.



From sustrik at imatix.com  Tue Apr 15 21:16:02 2008
From: sustrik at imatix.com (Martin Sustrik)
Date: Tue, 15 Apr 2008 22:16:02 +0200
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <48050597.1070600@lshift.net>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>
	<48050597.1070600@lshift.net>
Message-ID: <48050D02.9050007@imatix.com>


> The results indicate that this is probably a bug in Leopard, or a bug in 
> the Erlang runtime that only manifests itself on Leopard.
>
> The trigger appears to be a tcp client closing the socket when the 
> server is in the middle of writing to its peer.
>
> The next step is to construct a test case that doesn't involve rabbit.
>   
Matthias,

I'm not sure whether this will help, but anyway: Leopard (and presumably 
OS X in general) handles connection closed by the other peer by 
returning POLLHUP from the poll rather than POLLIN as is common on most 
platforms. Can that confuse Erlang/Rabbit?

Martin



From matthias at lshift.net  Tue Apr 15 22:06:35 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 15 Apr 2008 22:06:35 +0100
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <48050D02.9050007@imatix.com>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>
	<48050D02.9050007@imatix.com>
Message-ID: <480518DB.40406@lshift.net>

Martin,

Martin Sustrik wrote:
> I'm not sure whether this will help, but anyway: Leopard (and presumably 
> OS X in general) handles connection closed by the other peer by 
> returning POLLHUP from the poll rather than POLLIN as is common on most 
> platforms. Can that confuse Erlang/Rabbit?

That is certainly worth looking into since a misdiagnosis of the event 
might cause the Erlang runtime to think the socket is ready for 
reading/writing when it fact it has been closed by the peer. Thanks for 
the pointer!


Matthias.



From matthias at lshift.net  Wed Apr 16 07:50:29 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 16 Apr 2008 07:50:29 +0100
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <48050CDC.50802@lshift.net>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>
	<5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>
	<48050CDC.50802@lshift.net>
Message-ID: <4805A1B5.1090303@lshift.net>

Michael, and anybody else who can spare a couple of minutes,

Matthias Radestock wrote:
> Michael Arnoldus wrote:
>> Since we are running on Intel HW, let me know if I can help by running 
>> stuff or reproduce the problem.
> 
> Thanks for the offer. I might take you up on it once I have a simple 
> test case ready.

...which I now have. See attached.


To run this,

1) save the attached file in some directory

2) cd to that directory

3) run the erlang shell, i.e. 'erl'

4) monitor the CPU consumption of the erlang process (usually called 
'beam' or 'beam.smp') with a program like 'top'

5) at the Erlang prompt, compile the program with
     c(sock_spin).
which should return
     {ok,sock_spin}

6) still at the Erlang prompt, pick a port (e.g. 5678) and run
     sock_spin:working(5678).

7) connect to the chosen port with, say, netcat (telnet should work too, 
but seems to be harder to kill; see next step), e.g.
     nc localhost 5678 > /dev/null

8) terminate the connection, e.g. by ^C-ing netcat or killing the process.

9) At this point (it may take a few seconds) the Erlang shell should 
return something like {error, closed} or {error, einval}. Check the CPU 
usage of the Erlang process.

Now repeat steps 6-9 but call
     sock_spin:broken(5678).
instead.

Finally, to quit the Erlang shell just type
     q().
at the prompt.


The CPU consumption of the Erlang process reported in step 9 should be 
near 0% at the end of both tests. However, on some systems the second 
test leaves the Erlang process consuming 100% CPU, though the Erlang 
shell remains responsive. I am interested in finding out which systems 
exhibit this behaviour and which don't.

When reporting your results please include information about your system 
(if you are on Unix just run 'uname -a') and Erlang version (the version 
number displayed when starting the Erlang shell will do just fine).


Regards,

Matthias.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: sock_spin.erl
Type: text/x-erlang
Size: 463 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/97ffe24c/attachment.bin 

From alter at tcontest.ru  Wed Apr 16 10:15:13 2008
From: alter at tcontest.ru (Andrew V. Statsenko)
Date: Wed, 16 Apr 2008 13:15:13 +0400
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <47FCE714.9090801@cohesiveft.com>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FCE714.9090801@cohesiveft.com>
Message-ID: <1208337313.12447.171.camel@alter.njam.naunet.ru>

? ???, 09/04/2008 ? 10:56 -0500, Dmitriy Samovskiy ?????:

Hi Dmitriy !


> > So, let's try to start 100 producer's and
> > 100 consumer's. Each producer generate 10 msgs/sec (t
> > 1000 msgs/sec at all)

> May I suggest increasing the number of messages per second as an alternative test (instead 
> of increasing the number of clients)?

Well, I was make an alternative test and increase the number of messages
per second + decrase number of clients - result is same ( very little
difference ).


> I think one of your your biggest bottlenecks in this case is the number of sockets that 
> you ask your OS to juggle at the same time (I may be wrong however). Things you might want 
> to try:
> 1. reduce the number of clients
> 2. reduce the number of sockets each broker has to open by setting up a RabbitMQ cluster

Hmm..  :-)

In real life we are looking for fast messaging middleware which can
interconnect 10-100K flash clients per server with _very_ low latency
(each client send & recieve 4 mgs per sec) and perfomance/latency
degradation with high number of sockets is important  fo us.


WBR,
Alter




From 0x6e6562 at gmail.com  Wed Apr 16 10:34:03 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Wed, 16 Apr 2008 10:34:03 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <1208337313.12447.171.camel@alter.njam.naunet.ru>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FCE714.9090801@cohesiveft.com>
	<1208337313.12447.171.camel@alter.njam.naunet.ru>
Message-ID: <E4992AEB-0D86-4CA3-B25D-BCD651C48F02@gmail.com>

Hi Andrew,

On 16 Apr 2008, at 10:15, Andrew V. Statsenko wrote:
> In real life we are looking for fast messaging middleware which can
> interconnect 10-100K flash clients per server with _very_ low latency
> (each client send & recieve 4 mgs per sec) and perfomance/latency
> degradation with high number of sockets is important  fo us.

Have you written your own flash client for AMQP?

Ben



From chime at mu.dk  Wed Apr 16 09:51:06 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Wed, 16 Apr 2008 10:51:06 +0200
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <4805A1B5.1090303@lshift.net>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>
	<5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>
	<48050CDC.50802@lshift.net> <4805A1B5.1090303@lshift.net>
Message-ID: <A997E81C-FA24-437D-90FC-60AA7DF98A23@mu.dk>

Matthias,

Nice work!!!

As expected I get 100% CPU wit sock_spin:broken().

uname -a:
Darwin Hobbes.local 9.2.2 Darwin Kernel Version 9.2.2: Tue Mar  4  
21:17:34 PST 2008; root:xnu-1228.4.31~1/RELEASE_I386 i386

erlang version:
Erlang (BEAM) emulator version 5.6.1 [source] [smp:2] [async-threads: 
0] [kernel-poll:false]

I'll be happy to try it on other HW and/or other versions if you think  
you need this.

Regards,

Michael

On Apr 16, 2008, at 8:50 , Matthias Radestock wrote:

> Michael, and anybody else who can spare a couple of minutes,
>
> Matthias Radestock wrote:
>> Michael Arnoldus wrote:
>>> Since we are running on Intel HW, let me know if I can help by  
>>> running stuff or reproduce the problem.
>> Thanks for the offer. I might take you up on it once I have a  
>> simple test case ready.
>
> ...which I now have. See attached.
>
>
> To run this,
>
> 1) save the attached file in some directory
>
> 2) cd to that directory
>
> 3) run the erlang shell, i.e. 'erl'
>
> 4) monitor the CPU consumption of the erlang process (usually called  
> 'beam' or 'beam.smp') with a program like 'top'
>
> 5) at the Erlang prompt, compile the program with
>    c(sock_spin).
> which should return
>    {ok,sock_spin}
>
> 6) still at the Erlang prompt, pick a port (e.g. 5678) and run
>    sock_spin:working(5678).
>
> 7) connect to the chosen port with, say, netcat (telnet should work  
> too, but seems to be harder to kill; see next step), e.g.
>    nc localhost 5678 > /dev/null
>
> 8) terminate the connection, e.g. by ^C-ing netcat or killing the  
> process.
>
> 9) At this point (it may take a few seconds) the Erlang shell should  
> return something like {error, closed} or {error, einval}. Check the  
> CPU usage of the Erlang process.
>
> Now repeat steps 6-9 but call
>    sock_spin:broken(5678).
> instead.
>
> Finally, to quit the Erlang shell just type
>    q().
> at the prompt.
>
>
> The CPU consumption of the Erlang process reported in step 9 should  
> be near 0% at the end of both tests. However, on some systems the  
> second test leaves the Erlang process consuming 100% CPU, though the  
> Erlang shell remains responsive. I am interested in finding out  
> which systems exhibit this behaviour and which don't.
>
> When reporting your results please include information about your  
> system (if you are on Unix just run 'uname -a') and Erlang version  
> (the version number displayed when starting the Erlang shell will do  
> just fine).
>
>
> Regards,
>
> Matthias.
> -module(sock_spin).
>
> -compile(export_all).
>
> working(Port) ->
>    spin(Port, []).
>
> broken(Port) ->
>    spin(Port, [{active, false}]).
>
> spin(Port, Opts) ->
>    {ok, LSock} = gen_tcp:listen(Port, Opts),
>    {ok, Sock} = gen_tcp:accept(LSock),
>    Res = send(Sock, list_to_binary(lists:duplicate(10000, $A))),
>    ok = gen_tcp:close(LSock),
>    Res.
>
> send(Sock, B) ->
>    case gen_tcp:send(Sock, B) of
>        ok    -> send(Sock, B);
>        Other -> Other
>    end.
>

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/0084c842/attachment.bin 

From 0x6e6562 at gmail.com  Wed Apr 16 10:49:09 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Wed, 16 Apr 2008 10:49:09 +0100
Subject: [rabbitmq-discuss] Fwd:  RabbitMQ running at 100% CPU.
References: <B3B0AC69-8B1E-46B0-87C7-165A1CC1E0FD@gmail.com>
Message-ID: <71558821-5BE2-447C-894E-0C2EB0AE48A7@gmail.com>



Begin forwarded message:

>
>
> Matthias,
>
> On 16 Apr 2008, at 07:50, Matthias Radestock wrote:
>
>> Michael, and anybody else who can spare a couple of minutes,
>
>> The CPU consumption of the Erlang process reported in step 9 should  
>> be near 0% at the end of both tests. However, on some systems the  
>> second test leaves the Erlang process consuming 100% CPU, though  
>> the Erlang shell remains responsive. I am interested in finding out  
>> which systems exhibit this behaviour and which don't.
>>
>> When reporting your results please include information about your  
>> system (if you are on Unix just run 'uname -a') and Erlang version  
>> (the version number displayed when starting the Erlang shell will  
>> do just fine).
>
> I can reproduce this as well using R12B-0.
>
> gr8:sock_spin 0x6e6562$ uname -a
> Darwin host46.msm.che.vodafone 9.2.2 Darwin Kernel Version 9.2.2:  
> Tue Mar  4 21:17:34 PST 2008; root:xnu-1228.4.31~1/RELEASE_I386 i386
>
> HTH,
>
> Ben

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/f51c57f7/attachment.htm 

From matthias at lshift.net  Wed Apr 16 10:54:38 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 16 Apr 2008 10:54:38 +0100
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <A997E81C-FA24-437D-90FC-60AA7DF98A23@mu.dk>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>	<5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>	<48050CDC.50802@lshift.net>
	<4805A1B5.1090303@lshift.net>
	<A997E81C-FA24-437D-90FC-60AA7DF98A23@mu.dk>
Message-ID: <4805CCDE.8010304@lshift.net>

Michael,

Michael Arnoldus wrote:
> As expected I get 100% CPU wit sock_spin:broken().

Excellent (well, in a way ;)

> uname -a:
> Darwin Hobbes.local 9.2.2 Darwin Kernel Version 9.2.2: Tue Mar  4 
> 21:17:34 PST 2008; root:xnu-1228.4.31~1/RELEASE_I386 i386
> 
> erlang version:
> Erlang (BEAM) emulator version 5.6.1 [source] [smp:2] [async-threads:0] 
> [kernel-poll:false]

That's a useful data point since it's a slightly different version of 
the O/S (9.2.2 on i386 vs 9.1.0 on ppc for me) and Erlang (R12B-1 vs 
R12B-2 for me).

> I'll be happy to try it on other HW and/or other versions if you think 
> you need this.

That would be great. I am particularly interested in the following 
combinations:
- R11B-x on Mac OS X Leopard
- R12B-x on Mac OS X Tiger


Matthias.



From chime at mu.dk  Wed Apr 16 11:21:06 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Wed, 16 Apr 2008 12:21:06 +0200
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <4805CCDE.8010304@lshift.net>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>	<5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>	<48050CDC.50802@lshift.net>
	<4805A1B5.1090303@lshift.net>
	<A997E81C-FA24-437D-90FC-60AA7DF98A23@mu.dk>
	<4805CCDE.8010304@lshift.net>
Message-ID: <CAD9AACC-2825-4F9D-9407-8AB102B16DF6@mu.dk>


On Apr 16, 2008, at 11:54 , Matthias Radestock wrote:

> Michael,
>
> That would be great. I am particularly interested in the following  
> combinations:
> - R11B-x on Mac OS X Leopard

100% CPU with sock_spin:broken().

uname -a:
Darwin AHP.local 9.2.2 Darwin Kernel Version 9.2.2: Tue Mar  4  
21:17:34 PST 2008; root:xnu-1228.4.31~1/RELEASE_I386 i386

erlang version:
Erlang (BEAM) emulator version 5.5.5 [source] [async-threads:0]  
[kernel-poll:false]

>
> - R12B-x on Mac OS X Tiger

No Tiger at work. I can try this at a friends house, but it'll take a  
day or two - let me know if that's interesting.

Michael

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/b001b301/attachment.bin 

From alter at tcontest.ru  Wed Apr 16 11:25:54 2008
From: alter at tcontest.ru (Andrew V. Statsenko)
Date: Wed, 16 Apr 2008 14:25:54 +0400
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <E4992AEB-0D86-4CA3-B25D-BCD651C48F02@gmail.com>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FCE714.9090801@cohesiveft.com>
	<1208337313.12447.171.camel@alter.njam.naunet.ru>
	<E4992AEB-0D86-4CA3-B25D-BCD651C48F02@gmail.com>
Message-ID: <1208341555.12447.178.camel@alter.njam.naunet.ru>

? ???, 16/04/2008 ? 10:34 +0100, Ben Hood ?????:

Hi Ben,


> On 16 Apr 2008, at 10:15, Andrew V. Statsenko wrote:
> > In real life we are looking for fast messaging middleware which can
> > interconnect 10-100K flash clients per server with _very_ low latency
> > (each client send & recieve 4 mgs per sec) and perfomance/latency
> > degradation with high number of sockets is important  fo us.
> 
> Have you written your own flash client for AMQP?

No. The good AMQP flash stack is also that we are looking for :-)

One of the project is http://sharesource.org/project/as3amqp/

WBR,
Alter.




From alter at tcontest.ru  Wed Apr 16 12:45:53 2008
From: alter at tcontest.ru (Andrew V. Statsenko)
Date: Wed, 16 Apr 2008 15:45:53 +0400
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <47FD3A0A.1090600@lshift.net>
References: <47FCA0A7.5000006@brandproduction.ru> <47FD3A0A.1090600@lshift.net>
Message-ID: <1208346354.12447.224.camel@alter.njam.naunet.ru>

? ???, 09/04/2008 ? 22:50 +0100, Matthias Radestock ?????:

Hello ?Matthias !

Fisrt off all many thank for help, second I am very sorry about my bad
written english.

We are continue testing RabbitMQ with ?Alexey Slynko and here the some
results.

> > Erlang version (stable debian distribution) :
> > 
> > # dpkg -l erlang\* | grep ii
> > ii  erlang-base      11.b.2-4       Concurrent, real-time, distributed
> > functiona
> > ii  erlang-nox       11.b.2-4       Concurrent, real-time, distributed
> > functiona
> 
> Any chance you could try the tests with R11B-5? Most of our testing has 
> been done on that. I doubt it will make much difference but at the very 
> least it will make it easier for us to compare results.

Chance is 100% . Just sey that we are have to rebuild. Current,
backported from Etch, Erlang is:

# dpkg -l erlang\* | grep ii
ii  erlang-base       11.b.5dfsg-12  Concurrent, real-time, distributed
functiona
ii  erlang-nox        11.b.5dfsg-12  Concurrent, real-time, distributed
functiona

as you say.


> > Another midfications were done for normal mnesia work (errors listed below)
> > 
> > ERROR REPORT==== 4-Apr-2008::18:29:14 ===
> > Error in process <0.20713.0> on node 'rabbit at altair' with exit value:
> > {{case_clause,{error,{system_limit,"Cannot create an ets table for
> > the local transaction
> > store",{system_limit,[{ets,new,[mnesia_trans_store,[bag,public]]},{mnesia_tm,doit_loop,1},{mnesia_sp,init_proc,4},{ 
> > 
> > proc_lib...
> 
> We have never seen this before. At what point during your tests did you 
> get this error?

Test starts, after 7-15 min Erlang eat a lot off memory and give the
errors, 
sometime crash.


> These should all be fine except I have some concerns about the "-smp 
> auto", given how old a version of Erlang/OTP are running. Did you test 
> that adding the flag indeed improves performance?

Yes. Then I use -smp flag the Erlang/OTP eating all 8 CPU core, without
- 1.

> 
> Note that RabbitMQ when running with Erlang/OTP R11B (rather than the 
> more recent R12) will not benefit much (if at all) from the multiple 
> cores when running with -smp. In our experiments we have been getting 
> much better results when configuring a local cluster of one non-smp node 
> per code. So I'd recommend you do that.

I am newbe man in Erlang/OTP system and correctly configuring a local
cluster 
is not easy for me. With SMP mode beam.smp can utilize up to 790% off
this server.


> The following will all impact performance:
> 
> - The queues are not auto-deleting and aren't being deleted explicitly, 
> and your queue/exchange naming scheme is deterministic. Unless you 
> restart the server between tests or subsequent tests will be affected by 
> the queues from earlier tests. I'd also recommend clearing the mnesia 
> dir prior to starting rabbit, just to make sure that there aren't any 
> stray exchanges, queues or persistent messages.

Well,

# invoke-rc.d rabbitmq-server stop
Stopping rabbitmq-server: rabbitmq-server.
# rm -f /var/lib/rabbitmq/mnesia/rabbit/*
# invoke-rc.d rabbitmq-server start
Starting rabbitmq-server: SUCCESS
rabbitmq-server.


> 
> - The consumer explicitly acknowledges each message. Would 
> bulk-acknowledgment or auto-acknowledgment be an option?

OK, I was delete the ?acknowledges each message code

- // channel.basicAck(envelope.getDeliveryTag(), false);

start the test

$ java -jar RabbitmqFastMessagingProducerTest.jar 1000 > client.log

after ~ 5 min the server side looks

?top - 15:10:19 up 11 days, 21:39,  2 users,  load average: 5.93, 2.69,
1.09
Tasks: 115 total,   1 running, 114 sleeping,   0 stopped,   0 zombie
Cpu(s): 58.2%us, 18.9%sy,  0.0%ni, 21.4%id,  0.0%wa,  0.4%hi,  1.1%si,
0.0%st
Mem:   4139508k total,  2233588k used,  1905920k free,   286108k buffers
Swap:  4194296k total,        0k used,  4194296k free,   826336k cached

PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
16082 rabbitmq  25   0 1133m 900m 1696 S  615 22.3  16:55.04 beam.smp
23983 rabbitmq  15   0  1828  388  256 S    0  0.0   0:00.00 epmd
16078 rabbitmq  20   0  4172 1548 1080 S    0  0.0   0:00.00
rabbitmq-server
16404 rabbitmq  17   0  1824  472  368 S    0  0.0   0:00.00
inet_gethost
16405 rabbitmq  18   0  1868  592  472 S    0  0.0   0:00.00
inet_gethost       


and the client side

$ tail -f client.log | awk '/CLIENT_CONSUMER_THREAD_ID/{print "DELAY: "
$4-$8 " " $0}'

DELAY: 188894 CLIENT_CONSUMER_THREAD_ID: 2 TIME: 1208344442697 MESSAGE:
23 TIME: 1208344253803
DELAY: 187904 CLIENT_CONSUMER_THREAD_ID: 951 TIME: 1208344442697
MESSAGE: 22 TIME: 1208344254793
DELAY: 187807 CLIENT_CONSUMER_THREAD_ID: 871 TIME: 1208344442698
MESSAGE: 22 TIME: 1208344254891
DELAY: 188168 CLIENT_CONSUMER_THREAD_ID: 706 TIME: 1208344442698
MESSAGE: 22 TIME: 1208344254530
DELAY: 188267 CLIENT_CONSUMER_THREAD_ID: 630 TIME: 1208344442698
MESSAGE: 22 TIME: 1208344254431
DELAY: 189608 CLIENT_CONSUMER_THREAD_ID: 626 TIME: 1208344442698
MESSAGE: 23 TIME: 1208344253090
DELAY: 188127 CLIENT_CONSUMER_THREAD_ID: 113 TIME: 1208344442698
MESSAGE: 22 TIME: 1208344254571
DELAY: 188596 CLIENT_CONSUMER_THREAD_ID: 519 TIME: 1208344442698
MESSAGE: 22 TIME: 1208344254102

The delay is about 3 min. I can't understand why.


> You may also want to run one of the test programs supplied with the 
> RabbitMQ Java client packages, such as MulticastMain, e.g.
>    sh ./runjava.sh com.rabbitmq.examples.MulticastMain -h <host> -a
> which reports on throughput and latency.


Well, the I start signle producer/consumer thread all looks good:

$ sh ./runjava.sh com.rabbitmq.examples.MulticastMain -h host.domain.tld
-a
starting consumer #0
starting producer #0
recving rate: 7780 msg/s, min/avg/max latency: 4083/109443/165431
microseconds
sending rate: 10679 msg/s
recving rate: 9734 msg/s, min/avg/max latency: 109790/135292/163872
microseconds
sending rate: 9821 msg/s
recving rate: 9873 msg/s, min/avg/max latency: 109995/134968/160787
microseconds
sending rate: 9848 msg/s
recving rate: 9969 msg/s, min/avg/max latency: 107159/132702/158851
microseconds
sending rate: 10083 msg/s
recving rate: 9868 msg/s, min/avg/max latency: 108387/134192/160497
microseconds


But, then I start 100 ?producer/consumer threads latency going to be
high 0.3->20 sec:

$ sh ./runjava.sh com.rabbitmq.examples.MulticastMain
-h ?host.domain.tld -a -x 100 -y 100 | grep recving
recving rate: 0 msg/s, min/avg/max latency: 11195/11195/11195
microseconds
recving rate: 33217 msg/s, min/avg/max latency: 10113/345828/996901
microseconds
recving rate: 27192 msg/s, min/avg/max latency: 58042/1010474/1997839
microseconds
recving rate: 33569 msg/s, min/avg/max latency: 65700/1562317/2997350
microseconds
recving rate: 24304 msg/s, min/avg/max latency: 90050/2142151/3991946
microseconds
recving rate: 37388 msg/s, min/avg/max latency: 111498/2970700/4996836
microseconds
recving rate: 28715 msg/s, min/avg/max latency: 118559/3476202/5998178
microseconds
recving rate: 28453 msg/s, min/avg/max latency: 144319/4098792/6999516
microseconds
recving rate: 27348 msg/s, min/avg/max latency: 157363/4722565/7998155
microseconds
recving rate: 27508 msg/s, min/avg/max latency: 182090/5381463/9003343
microseconds
recving rate: 27007 msg/s, min/avg/max latency: 192525/6034385/9982716
microseconds
recving rate: 26638 msg/s, min/avg/max latency: 207776/6694654/10998061
microseconds
recving rate: 27001 msg/s, min/avg/max latency: 211793/7335019/12002072
microseconds
recving rate: 26616 msg/s, min/avg/max latency: 244324/7996319/13001783
microseconds
recving rate: 26056 msg/s, min/avg/max latency: 231526/8642121/13997488
microseconds
recving rate: 26521 msg/s, min/avg/max latency: 252036/9327910/15016590
microseconds
recving rate: 26018 msg/s, min/avg/max latency: 262150/10006353/16007951
microseconds
recving rate: 26431 msg/s, min/avg/max latency: 264835/10697607/17017128
microseconds
recving rate: 26018 msg/s, min/avg/max latency: 342075/11366371/18016090
microseconds
recving rate: 25545 msg/s, min/avg/max latency: 273541/11965135/18987288
microseconds
recving rate: 25902 msg/s, min/avg/max latency: 280084/12749721/20008257
microseconds
recving rate: 25449 msg/s, min/avg/max latency: 304305/13347575/21019395
microseconds
recving rate: 25473 msg/s, min/avg/max latency: 309149/13985349/22019055
microseconds
recving rate: 25658 msg/s, min/avg/max latency: 302950/14691935/23020086
microseconds
recving rate: 25564 msg/s, min/avg/max latency: 403575/15483426/24021188
microseconds
recving rate: 25639 msg/s, min/avg/max latency: 323600/15878397/25021019
microseconds
recving rate: 25553 msg/s, min/avg/max latency: 321453/16720349/25974209
microseconds
recving rate: 25747 msg/s, min/avg/max latency: 343184/17436193/27023608
microseconds
recving rate: 24954 msg/s, min/avg/max latency: 386340/17945129/28010304
microseconds
recving rate: 24919 msg/s, min/avg/max latency: 377575/18603424/29026385
microseconds
recving rate: 25226 msg/s, min/avg/max latency: 349285/19401619/30013216
microseconds
recving rate: 25074 msg/s, min/avg/max latency: 491382/20007042/31005415
microseconds
recving rate: 25906 msg/s, min/avg/max latency: 374276/20710481/32014250
microseconds
recving rate: 25153 msg/s, min/avg/max latency: 363636/21417328/33015581
microseconds


Here the result then I run this test in AQMP server host (localhost):

$ sh ./runjava.sh com.rabbitmq.examples.MulticastMain -h localhost -a -x
100 -y 100 | grep recving
recving rate: 0 msg/s, min/avg/max latency: 15532/15532/15532
microseconds
recving rate: 10911 msg/s, min/avg/max latency: 15538/358765/953624
microseconds
recving rate: 19022 msg/s, min/avg/max latency: 86565/907865/2021696
microseconds
recving rate: 18619 msg/s, min/avg/max latency: 116191/1471139/3014532
microseconds
recving rate: 21881 msg/s, min/avg/max latency: 112003/2051780/4021113
microseconds
recving rate: 19014 msg/s, min/avg/max latency: 139058/2687275/4929168
microseconds
recving rate: 18237 msg/s, min/avg/max latency: 184713/3311977/5929642
microseconds
recving rate: 18837 msg/s, min/avg/max latency: 213375/4023915/6917634
microseconds
recving rate: 21111 msg/s, min/avg/max latency: 177935/4640096/7928183
microseconds
recving rate: 16905 msg/s, min/avg/max latency: 167707/5139316/8939816
microseconds
recving rate: 16678 msg/s, min/avg/max latency: 209396/5903245/9921387
microseconds
recving rate: 19055 msg/s, min/avg/max latency: 241024/6477019/10940078
microseconds
recving rate: 17407 msg/s, min/avg/max latency: 309125/7134191/11945223
microseconds
recving rate: 18369 msg/s, min/avg/max latency: 232026/7839258/12949816
microseconds
recving rate: 18599 msg/s, min/avg/max latency: 246842/8434456/13956746
microseconds
recving rate: 18142 msg/s, min/avg/max latency: 261445/9040292/14955231
microseconds
recving rate: 19064 msg/s, min/avg/max latency: 253654/9718233/15976520
microseconds
recving rate: 19028 msg/s, min/avg/max latency: 274436/10391275/16977331
microseconds
recving rate: 17648 msg/s, min/avg/max latency: 339277/11079915/17959945
microseconds
recving rate: 18170 msg/s, min/avg/max latency: 662897/11848865/18972830
microseconds
recving rate: 19169 msg/s, min/avg/max latency: 307943/12328233/19945237
microseconds
recving rate: 17994 msg/s, min/avg/max latency: 342600/13105338/20889999
microseconds
recving rate: 18205 msg/s, min/avg/max latency: 359897/13805425/21926401
microseconds
recving rate: 18324 msg/s, min/avg/max latency: 439293/14389845/22942993
microseconds
recving rate: 16720 msg/s, min/avg/max latency: 409930/15036274/23980343
microseconds
recving rate: 18435 msg/s, min/avg/max latency: 928834/15825577/24938658
microseconds
recving rate: 19078 msg/s, min/avg/max latency: 401601/16257366/25940399
microseconds
recving rate: 17531 msg/s, min/avg/max latency: 445536/17090242/26952144
microseconds
recving rate: 18717 msg/s, min/avg/max latency: 842400/17750288/27990323
microseconds
recving rate: 19389 msg/s, min/avg/max latency: 374073/18312400/28965579
microseconds


It looks strange... like the "reciever" in rabbitmq working match
faster, then "processor" & "sender". Is this result correct ?


WBR,
Alter







From matthias at lshift.net  Wed Apr 16 13:48:22 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 16 Apr 2008 13:48:22 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <1208346354.12447.224.camel@alter.njam.naunet.ru>
References: <47FCA0A7.5000006@brandproduction.ru> <47FD3A0A.1090600@lshift.net>
	<1208346354.12447.224.camel@alter.njam.naunet.ru>
Message-ID: <4805F596.7050605@lshift.net>

Andrew,

Andrew V. Statsenko wrote:
> ? ???, 09/04/2008 ? 22:50 +0100, Matthias Radestock ?????:
>> I have some concerns about the "-smp 
>> auto", given how old a version of Erlang/OTP are running. Did you test 
>> that adding the flag indeed improves performance?
> 
> Yes. Then I use -smp flag the Erlang/OTP eating all 8 CPU core, without
> - 1.
> [...]
> I am newbe man in Erlang/OTP system and correctly configuring a local
> cluster 
> is not easy for me. With SMP mode beam.smp can utilize up to 790% off
> this server.

Erlang in SMP mode will indeed happily use all your CPUs. It won't 
necessarily go any faster though. In our experience - and I should 
stress that this is for RabbitMQ and R11B-x only - it doesn't.

You don't need to know anything about Erlang to configure a local 
cluster. Take a look at the http://www.rabbitmq.com/clustering.html - if 
anything isn't clear in those instructions then please let us know ...

OTOH, you should only look into clustering once the other issues have 
been resolved.

>> - The queues are not auto-deleting and aren't being deleted explicitly, 
>> and your queue/exchange naming scheme is deterministic. Unless you 
>> restart the server between tests or subsequent tests will be affected by 
>> the queues from earlier tests. I'd also recommend clearing the mnesia 
>> dir prior to starting rabbit, just to make sure that there aren't any 
>> stray exchanges, queues or persistent messages.
> 
> Well,
> 
> # invoke-rc.d rabbitmq-server stop
> Stopping rabbitmq-server: rabbitmq-server.
> # rm -f /var/lib/rabbitmq/mnesia/rabbit/*
> # invoke-rc.d rabbitmq-server start
> Starting rabbitmq-server: SUCCESS
> rabbitmq-server.

ok. As long as you remember to run that between tests you should be fine.

>> - The consumer explicitly acknowledges each message. Would 
>> bulk-acknowledgment or auto-acknowledgment be an option?
> 
> OK, I was delete the ?acknowledges each message code
> 
> - // channel.basicAck(envelope.getDeliveryTag(), false);

That's not sufficient. You need to change channel.basicConsume(...) 
invocation to enable auto-ack. Otherwise your above change will result 
in the server hanging on to all messages.

> Well, the I start signle producer/consumer thread all looks good:
> 
> $ sh ./runjava.sh com.rabbitmq.examples.MulticastMain -h host.domain.tld
> -a

You should limit the sending rate with the -r flag. Otherwise the 
producers will flood the server.

> $ sh ./runjava.sh com.rabbitmq.examples.MulticastMain
> -h ?host.domain.tld -a -x 100 -y 100 | grep recving

Note that this will result in the consumers receiving the messages from 
*all* producers. The program is called "MulticastMain" for a reason :)


Matthias.



From alter at tcontest.ru  Wed Apr 16 14:17:30 2008
From: alter at tcontest.ru (Andrew V. Statsenko)
Date: Wed, 16 Apr 2008 17:17:30 +0400
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <4805F596.7050605@lshift.net>
References: <47FCA0A7.5000006@brandproduction.ru> <47FD3A0A.1090600@lshift.net>
	<1208346354.12447.224.camel@alter.njam.naunet.ru>
	<4805F596.7050605@lshift.net>
Message-ID: <1208351850.12447.233.camel@alter.njam.naunet.ru>

? ???, 16/04/2008 ? 13:48 +0100, Matthias Radestock ?????:
> Andrew,

> >> - The consumer explicitly acknowledges each message. Would 
> >> bulk-acknowledgment or auto-acknowledgment be an option?
> > 
> > OK, I was delete the ?acknowledges each message code
> > 
> > - // channel.basicAck(envelope.getDeliveryTag(), false);
> 
> That's not sufficient. You need to change channel.basicConsume(...) 
> invocation to enable auto-ack. Otherwise your above change will result 
> in the server hanging on to all messages.

?Yes, I was look to the javadoc:

basicConsume(int ticket, java.lang.String queue, boolean noAck,
Consumer callback) 
          Start a non-nolocal, non-exclusive consumer, with a
server-generated consumerTag.


and the consumer code I running in latest reported here test is:

  QueueingConsumer consumer = new QueueingConsumer(channel);         
  channel.basicConsume(ticket, topic, true, consumer);
            
  Thread.sleep(5000);

  for( int i = 0; i < MSG_COUNT; i++) {
      QueueingConsumer.Delivery delivery = consumer.nextDelivery();
      Envelope envelope = delivery.getEnvelope();
      System.out.println("CLIENT_CONSUMER_THREAD_ID: " + this.THREAD_ID
+ " TIME: " + System.currentTimeMillis() + " " + new
String(delivery.getBody()) ) ;
   }
  
?
Is this invocation "channel.basicConsume(ticket, topic, true,
consumer);" ?enable auto-ack ?




WBR,
Alter.






From matthias at lshift.net  Wed Apr 16 14:25:53 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 16 Apr 2008 14:25:53 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <1208351850.12447.233.camel@alter.njam.naunet.ru>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FD3A0A.1090600@lshift.net>	<1208346354.12447.224.camel@alter.njam.naunet.ru>	<4805F596.7050605@lshift.net>
	<1208351850.12447.233.camel@alter.njam.naunet.ru>
Message-ID: <4805FE61.2090305@lshift.net>

Andrew V. Statsenko wrote:
> Is this invocation "channel.basicConsume(ticket, topic, true,
> consumer);" ?enable auto-ack ?

Yes, that's fine.

Btw, the equivalent for MulticastMain is to supply the '-a' flag.


Matthias.



From matthias at lshift.net  Wed Apr 16 17:50:39 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 16 Apr 2008 17:50:39 +0100
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <CAD9AACC-2825-4F9D-9407-8AB102B16DF6@mu.dk>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>	<5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>	<48050CDC.50802@lshift.net>	<4805A1B5.1090303@lshift.net>	<A997E81C-FA24-437D-90FC-60AA7DF98A23@mu.dk>	<4805CCDE.8010304@lshift.net>
	<CAD9AACC-2825-4F9D-9407-8AB102B16DF6@mu.dk>
Message-ID: <48062E5F.7030300@lshift.net>

Michael,

Michael Arnoldus wrote:
>> - R11B-x on Mac OS X Leopard
> 
> 100% CPU with sock_spin:broken().

cheers.

>> - R12B-x on Mac OS X Tiger
> 
> No Tiger at work. I can try this at a friends house, but it'll take a 
> day or two - let me know if that's interesting.

Alexis has Tiger on his laptop and tried it there. It worked, i.e. no 
spinning, which is consistent with the tests we conducted some weeks ago.

So the problem does indeed appear to be confined to Leopard.


Matthias.



From 0x6e6562 at gmail.com  Thu Apr 17 01:16:17 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 17 Apr 2008 01:16:17 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <1208341555.12447.178.camel@alter.njam.naunet.ru>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FCE714.9090801@cohesiveft.com>
	<1208337313.12447.171.camel@alter.njam.naunet.ru>
	<E4992AEB-0D86-4CA3-B25D-BCD651C48F02@gmail.com>
	<1208341555.12447.178.camel@alter.njam.naunet.ru>
Message-ID: <4C762F3D-01EC-4F8B-AA68-63A7403D5178@gmail.com>

Andrew,

On 16 Apr 2008, at 11:25, Andrew V. Statsenko wrote:
> No. The good AMQP flash stack is also that we are looking for :-)
>
> One of the project is http://sharesource.org/project/as3amqp/

Yes, I wrote that project and it would be interesting to get some  
feedback about it's usability and fitness for purpose if you ever did  
get around to trying it out.

There is a discussion of it here: http://hopper.squarespace.com/blog/2008/3/24/as3-amqp-client-first-cut.html

HTH,

Ben



From codewalkerjoe at gmail.com  Thu Apr 17 01:21:23 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Wed, 16 Apr 2008 20:21:23 -0400
Subject: [rabbitmq-discuss] Just publishing messages causes
	rabbit_writer:mainloop to hang and simultaneous pub problem
In-Reply-To: <57C8F7AF-B2F0-4E6A-91BD-C7ABB861F219@gmail.com>
References: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
	<67822B21-D550-4D5B-B054-4C0C652D0AF1@gmail.com>
	<50ec7a2e0804141059m78951951lb0a83c78ea950b57@mail.gmail.com>
	<57C8F7AF-B2F0-4E6A-91BD-C7ABB861F219@gmail.com>
Message-ID: <50ec7a2e0804161721oa0fb604j925e2303a807c5e7@mail.gmail.com>

> BTW, if you don't supply a host name when starting the connection, the
> client will start in a direct mode using native Erlang message passing
> rather than AMQP wire framing. This means that the client and server run in
> the same interpreter and eliminate the network overhead.
>
Is this valid also when running rabbitmq erlang client and rabbitmq server
on separate erlang nodes?

I sent 3 amqp message to the rabbitmq broker from a separate erlang client
node.  The three 3 amqp messages create 3 rabbit_writer:mainloop/1
processes.  This rabbit_writer:mainloop/1 process never goes away.

<0.71.0>              rabbit_writer:mainloop/1               233      132
0
                      rabbit_writer:mainloop/1
2
<0.72.0>              rabbit_writer:mainloop/1               233      132
0
                      rabbit_writer:mainloop/1
2
<0.73.0>              rabbit_writer:mainloop/1               233      132
0
                      rabbit_writer:mainloop/1
2

One rabbit_writer:mainloop process traced:

initial_call: rabbit_writer:mainloop/1
current_function: rabbit_writer:mainloop/1
heap_size: 233
stack_size: 2
reductions: 132
trap_exit: false
<0.72.0>: getting_linked   <0.112.0>

After that I increased number of processes on a single erlang node to
something higer than 50 000 and sent 50 000 messages.  For some reason, 50
000 rabbit_writer:mainloop processes are still there.  They don't go away.
Processes only go away when I restart the rabbit erlang client node.

7> erlang:system_info(process_count).
50044

Thank you,
Joe
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/024c4be1/attachment.htm 

From 0x6e6562 at gmail.com  Thu Apr 17 08:08:12 2008
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 17 Apr 2008 08:08:12 +0100
Subject: [rabbitmq-discuss] Just publishing messages causes
	rabbit_writer:mainloop to hang and simultaneous pub problem
In-Reply-To: <50ec7a2e0804161721oa0fb604j925e2303a807c5e7@mail.gmail.com>
References: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
	<67822B21-D550-4D5B-B054-4C0C652D0AF1@gmail.com>
	<50ec7a2e0804141059m78951951lb0a83c78ea950b57@mail.gmail.com>
	<57C8F7AF-B2F0-4E6A-91BD-C7ABB861F219@gmail.com>
	<50ec7a2e0804161721oa0fb604j925e2303a807c5e7@mail.gmail.com>
Message-ID: <445BCCF6-67ED-44ED-90AB-6536A48FAA7E@gmail.com>

Joe,

On 17 Apr 2008, at 01:21, Joe Lee wrote:
> BTW, if you don't supply a host name when starting the connection,  
> the client will start in a direct mode using native Erlang message  
> passing rather than AMQP wire framing. This means that the client  
> and server run in the same interpreter and eliminate the network  
> overhead.
> Is this valid also when running rabbitmq erlang client and rabbitmq  
> server on separate erlang nodes?

Currently not. At the moment the direct driver only uses local message  
passing. It is conceivable that the direct driver could use Erlang's  
internode communication, but I guess you'd have to message this  
approach against normal AMQP wire framing. In both approaches you  
would have to serialize and deserialize to get the data over the wire.  
If the Erlang variant is significantly more efficient that AMQP, it  
might be worth looking into and benchmarking.

The main point  is that the client API provides a uniform interface to  
user code, irrespective of the actual physical message passing  
technology.

> I sent 3 amqp message to the rabbitmq broker from a separate erlang  
> client node.  The three 3 amqp messages create 3  
> rabbit_writer:mainloop/1 processes.  This rabbit_writer:mainloop/1  
> process never goes away.
>
> <0.71.0>              rabbit_writer:mainloop/1                
> 233      132    0
>                       rabbit_writer:mainloop/1                 2
> <0.72.0>              rabbit_writer:mainloop/1                
> 233      132    0
>                       rabbit_writer:mainloop/1                 2
> <0.73.0>              rabbit_writer:mainloop/1                
> 233      132    0
>                       rabbit_writer:mainloop/1                 2
>
> One rabbit_writer:mainloop process traced:
>
> initial_call: rabbit_writer:mainloop/1
> current_function: rabbit_writer:mainloop/1
> heap_size: 233
> stack_size: 2
> reductions: 132
> trap_exit: false
> <0.72.0>: getting_linked   <0.112.0>
>
> After that I increased number of processes on a single erlang node  
> to something higer than 50 000 and sent 50 000 messages.  For some  
> reason, 50 000 rabbit_writer:mainloop processes are still there.   
> They don't go away.  Processes only go away when I restart the  
> rabbit erlang client node.
>
> 7> erlang:system_info(process_count).
> 50044

Can you send the source of the test that is producing this behaviour,  
please?

HTH,

Ben



From codewalkerjoe at gmail.com  Thu Apr 17 13:19:51 2008
From: codewalkerjoe at gmail.com (Joe Lee)
Date: Thu, 17 Apr 2008 08:19:51 -0400
Subject: [rabbitmq-discuss] Just publishing messages causes
	rabbit_writer:mainloop to hang and simultaneous pub problem
In-Reply-To: <445BCCF6-67ED-44ED-90AB-6536A48FAA7E@gmail.com>
References: <50ec7a2e0804140820t6c0f8721u518c133c9ee89df6@mail.gmail.com>
	<67822B21-D550-4D5B-B054-4C0C652D0AF1@gmail.com>
	<50ec7a2e0804141059m78951951lb0a83c78ea950b57@mail.gmail.com>
	<57C8F7AF-B2F0-4E6A-91BD-C7ABB861F219@gmail.com>
	<50ec7a2e0804161721oa0fb604j925e2303a807c5e7@mail.gmail.com>
	<445BCCF6-67ED-44ED-90AB-6536A48FAA7E@gmail.com>
Message-ID: <50ec7a2e0804170519g4b8dd79j536df70a7bfd9a65@mail.gmail.com>

I ran the same files that I sent earlier:

amqp_async_consume.erl
amqp_async_pub.erl
my_pmap.erl
rabbit_test.erl

Where I made changes to what you have suggested.  In rabbit_test.erl,
made MyList = [<<1>>,<<2>>,<<3>>].  Ran the rabbit_test:main() in
separate erlang shell.  If you are not seeing 3
rabbit_writer:mainloop/1 process in erlang node after running
rabbit_test:main(), then it could be the case that my erlang &
rabbitmq setup maybe not be installed properly or missing some
packages.

Let me know if this the case on your side,
Joe

> > I sent 3 amqp message to the rabbitmq broker from a separate erlang
> > client node.  The three 3 amqp messages create 3
> > rabbit_writer:mainloop/1 processes.  This rabbit_writer:mainloop/1
> > process never goes away.
> >
> > <0.71.0>              rabbit_writer:mainloop/1
> > 233      132    0
> >                       rabbit_writer:mainloop/1                 2
> > <0.72.0>              rabbit_writer:mainloop/1
> > 233      132    0
> >                       rabbit_writer:mainloop/1                 2
> > <0.73.0>              rabbit_writer:mainloop/1
> > 233      132    0
> >                       rabbit_writer:mainloop/1                 2
> >
> > One rabbit_writer:mainloop process traced:
> >
> > initial_call: rabbit_writer:mainloop/1
> > current_function: rabbit_writer:mainloop/1
> > heap_size: 233
> > stack_size: 2
> > reductions: 132
> > trap_exit: false
> > <0.72.0>: getting_linked   <0.112.0>
> >
> > After that I increased number of processes on a single erlang node
> > to something higer than 50 000 and sent 50 000 messages.  For some
> > reason, 50 000 rabbit_writer:mainloop processes are still there.
> > They don't go away.  Processes only go away when I restart the
> > rabbit erlang client node.
> >
> > 7> erlang:system_info(process_count).
> > 50044
>
> Can you send the source of the test that is producing this behaviour,
> please?
>
> HTH,
>
> Ben
>
>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



From matthias at lshift.net  Fri Apr 18 18:18:02 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 18 Apr 2008 18:18:02 +0100
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <48062E5F.7030300@lshift.net>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>	<5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>	<48050CDC.50802@lshift.net>	<4805A1B5.1090303@lshift.net>	<A997E81C-FA24-437D-90FC-60AA7DF98A23@mu.dk>	<4805CCDE.8010304@lshift.net>
	<CAD9AACC-2825-4F9D-9407-8AB102B16DF6@mu.dk>
	<48062E5F.7030300@lshift.net>
Message-ID: <4808D7CA.7040603@lshift.net>

All,

Matthias Radestock wrote:
> So the problem does indeed appear to be confined to Leopard.

The Erlang/OTP team have produced a patch and I have verified that it 
works. The official fix will be available in the upcoming R12B-3 release 
of Erlang/OTP.

See http://www.erlang.org/pipermail/erlang-bugs/2008-April/000745.html 
for the details.


Matthias.



From chime at mu.dk  Fri Apr 18 20:58:25 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Fri, 18 Apr 2008 21:58:25 +0200
Subject: [rabbitmq-discuss] RabbitMQ running at 100% CPU.
In-Reply-To: <4808D7CA.7040603@lshift.net>
References: <D1C366E4-8FB0-4E33-9E77-27849CE6A3D3@mu.dk>	<47D8F8B5.1060708@lshift.net>	<3DDE342B-052C-4FC9-9596-FE0F88EB8778@mu.dk>	<48050597.1070600@lshift.net>	<5B1129DE-F1E5-4EA6-A6F3-5330F04FD818@mu.dk>	<48050CDC.50802@lshift.net>	<4805A1B5.1090303@lshift.net>	<A997E81C-FA24-437D-90FC-60AA7DF98A23@mu.dk>	<4805CCDE.8010304@lshift.net>
	<CAD9AACC-2825-4F9D-9407-8AB102B16DF6@mu.dk>
	<48062E5F.7030300@lshift.net> <4808D7CA.7040603@lshift.net>
Message-ID: <8E017878-5114-4BA8-9865-0F44C98AF908@mu.dk>

Matthias,

This is great news. Thank you!

Michael

On Apr 18, 2008, at 19:18 , Matthias Radestock wrote:

> All,
>
> Matthias Radestock wrote:
>> So the problem does indeed appear to be confined to Leopard.
>
> The Erlang/OTP team have produced a patch and I have verified that it
> works. The official fix will be available in the upcoming R12B-3  
> release
> of Erlang/OTP.
>
> See http://www.erlang.org/pipermail/erlang-bugs/2008-April/000745.html
> for the details.
>
>
> Matthias.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080418/dff68852/attachment.bin 

From chime at mu.dk  Mon Apr 21 10:09:47 2008
From: chime at mu.dk (Michael Arnoldus)
Date: Mon, 21 Apr 2008 11:09:47 +0200
Subject: [rabbitmq-discuss] Possible bug?
Message-ID: <2E192A74-FF1D-4052-AB9F-A47746B4C72A@mu.dk>

Some days ago we found this in the log file. Everything kept on  
working as expected.

==> /var/log/wiinz/rabbit.log <==

=ERROR REPORT==== 8-Apr-2008::16:22:19 ===
error on TCP connection from 192.168.239.10:65208
connection_closed_abruptly

=INFO REPORT==== 8-Apr-2008::16:22:19 ===
closing TCP connection from 192.168.239.10:65208

=ERROR REPORT==== 8-Apr-2008::16:22:19 ===
Error in process <0.3310.0> on node 'rabbit at staging' with exit value:
{{badmatch,{error,[{exit,{normal,{gen_server,call,[<0.3311.0>, 
{notify_down,<0.3309.0>}]}}}]}},[{rabbit_channel,terminate,2}, 
{buffering_proxy,mainloop,4}]}

Just FYI

Regards,

Michael

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080421/b3153794/attachment.bin 

From matthias at lshift.net  Mon Apr 21 10:38:14 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Mon, 21 Apr 2008 10:38:14 +0100
Subject: [rabbitmq-discuss] Possible bug?
In-Reply-To: <2E192A74-FF1D-4052-AB9F-A47746B4C72A@mu.dk>
References: <2E192A74-FF1D-4052-AB9F-A47746B4C72A@mu.dk>
Message-ID: <480C6086.3080906@lshift.net>

Michael,

Michael Arnoldus wrote:
> Some days ago we found this in the log file. Everything kept on working 
> as expected.
> [...]
> =ERROR REPORT==== 8-Apr-2008::16:22:19 ===
> Error in process <0.3310.0> on node 'rabbit at staging' with exit value:
> {{badmatch,{error,[{exit,{normal,{gen_server,call,[<0.3311.0>,{notify_down,<0.3309.0>}]}}}]}},[{rabbit_channel,terminate,2},{buffering_proxy,mainloop,4}]} 

Thanks for reporting this. The error is benign; we will change the code 
to handle this casegracefully.

Matthias.



From ksalasko at gmail.com  Tue Apr 22 03:05:45 2008
From: ksalasko at gmail.com (Kyle Salasko)
Date: Mon, 21 Apr 2008 19:05:45 -0700 (PDT)
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <4805F596.7050605@lshift.net>
References: <47FCA0A7.5000006@brandproduction.ru> <47FD3A0A.1090600@lshift.net>
	<1208346354.12447.224.camel@alter.njam.naunet.ru>
	<4805F596.7050605@lshift.net>
Message-ID: <16820093.post@talk.nabble.com>


Matthias, 


Matthias Radestock-2 wrote:
> 
> 
> Erlang in SMP mode will indeed happily use all your CPUs. It won't 
> necessarily go any faster though. In our experience - and I should 
> stress that this is for RabbitMQ and R11B-x only - it doesn't.
> 
> 

Do you have any benchmarks on running RabbitMQ with SMP mode on R12B-x? Is
it still useful to run a local cluster with one instance per core, or does
upgrading to R12B fix that issue? 

Thanks,
Kyle
-- 
View this message in context: http://www.nabble.com/RabbitMQ-perfomance-testing---troubles-tp16584417p16820093.html
Sent from the RabbitMQ mailing list archive at Nabble.com.




From ksalasko at gmail.com  Tue Apr 22 04:06:53 2008
From: ksalasko at gmail.com (Kyle Salasko)
Date: Mon, 21 Apr 2008 20:06:53 -0700 (PDT)
Subject: [rabbitmq-discuss]  New exchange type
Message-ID: <16820505.post@talk.nabble.com>


Hi all,

Recently I put together a new exchange type for RabbitMQ, because none of
the existing ones completely match our requirements. The problem it solves
is this: we want a publish-subscribe model where exactly one subscriber
receives any given message. If we set up a topic exchange and have all
subscribers listen on the same queue, we get this out of the box. But this
requires that all messages go to that one queue, which resides on one
machine, causing a pretty significant bottleneck. A reasonable way around
this was to implement a new exchange type ("anycast") that picks a random
queue when a message is routed. The diff and new file for
rabbit_exchange.erl are attached.

I'm very new to erlang, so feedback/comments/optimizations are extremely
welcome.

Thanks,
Kyle

http://www.nabble.com/file/p16820505/rabbit_exchange.erl.diff
rabbit_exchange.erl.diff 
http://www.nabble.com/file/p16820505/rabbit_exchange.erl rabbit_exchange.erl 
-- 
View this message in context: http://www.nabble.com/New-exchange-type-tp16820505p16820505.html
Sent from the RabbitMQ mailing list archive at Nabble.com.




From matthias at lshift.net  Tue Apr 22 05:49:41 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 22 Apr 2008 05:49:41 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <16820093.post@talk.nabble.com>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FD3A0A.1090600@lshift.net>	<1208346354.12447.224.camel@alter.njam.naunet.ru>	<4805F596.7050605@lshift.net>
	<16820093.post@talk.nabble.com>
Message-ID: <480D6E65.9060209@lshift.net>

Kyle,

Kyle Salasko wrote:
> Do you have any benchmarks on running RabbitMQ with SMP mode on R12B-x? Is
> it still useful to run a local cluster with one instance per core, or does
> upgrading to R12B fix that issue? 

R12B-2 is definitely an improvement over R11B-5 when it comes to running 
in SMP mode, but we haven't done enough testing to determine whether it 
does better than a one-node-per-core non-smp cluster.


Matthias.



From matthias at lshift.net  Tue Apr 22 06:16:01 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 22 Apr 2008 06:16:01 +0100
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <16820505.post@talk.nabble.com>
References: <16820505.post@talk.nabble.com>
Message-ID: <480D7491.6030200@lshift.net>

Kyle,

Kyle Salasko wrote:
> Recently I put together a new exchange type for RabbitMQ, because none of
> the existing ones completely match our requirements. The problem it solves
> is this: we want a publish-subscribe model where exactly one subscriber
> receives any given message. If we set up a topic exchange and have all
> subscribers listen on the same queue, we get this out of the box. But this
> requires that all messages go to that one queue, which resides on one
> machine, causing a pretty significant bottleneck. A reasonable way around
> this was to implement a new exchange type ("anycast") that picks a random
> queue when a message is routed. The diff and new file for
> rabbit_exchange.erl are attached.
> 
> I'm very new to erlang, so feedback/comments/optimizations are extremely
> welcome.

This looks pretty good and implements a useful feature.

It occurred to me that rather than introducing a new exchange type one 
could place an indicator in the exchange arguments that turns any 
exchange from a multicast to an anycast exchange. That has two advantages:

- we stay entirely within the defined protocol standard

- the user can select the most appropriate matching logic with the 
exchange type, rather than being constrained to topic-based matching


Re optimisations: I haven't done any profiling on this, but I believe 
erlang:now + random:seed are quite expensive, so it is costly to call 
them every time a message is routed. I can think of three ways of fixing 
that:

- don't call now+seed at all. That will result in the generated sequence 
being the same for all publishing channels, which may or may not be a 
problem

- call now+seed on channel creation. During normal operation channels 
are the only processes invoking the routing code, so this catches all 
the interesting cases.

- use a flag in the process dictionary to indicate whether the random 
number generator has been seeded. Check/set that flag in your current 
code that invokes random:uniform. This has the same effect as the 
previous approach but is a less intrusive change since you don't need to 
touch any other modules.


Matthias



From sustrik at imatix.com  Tue Apr 22 08:05:05 2008
From: sustrik at imatix.com (Martin Sustrik)
Date: Tue, 22 Apr 2008 09:05:05 +0200
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <480D7491.6030200@lshift.net>
References: <16820505.post@talk.nabble.com> <480D7491.6030200@lshift.net>
Message-ID: <480D8E21.70306@imatix.com>


>> Recently I put together a new exchange type for RabbitMQ, because none of
>> the existing ones completely match our requirements. The problem it solves
>> is this: we want a publish-subscribe model where exactly one subscriber
>> receives any given message. If we set up a topic exchange and have all
>> subscribers listen on the same queue, we get this out of the box. But this
>> requires that all messages go to that one queue, which resides on one
>> machine, causing a pretty significant bottleneck. A reasonable way around
>> this was to implement a new exchange type ("anycast") that picks a random
>> queue when a message is routed. The diff and new file for
>> rabbit_exchange.erl are attached.
>>     
I've seen this requirement before, however, AFAICS it breaks AMQP model. 
The exchanges are meant to be used for message distribution, i.e. the 
message should be delivered to *all* queues with appropriate binding to 
the exchange. Queues are intended to do the load-balancing. Not adhering 
to this model causes problems with some more sophisticated use cases 
(wire-tapping, federation). It also introduces a lot of unfairness to 
the load-balancing algorithm. Why do you believe a single queue would 
create a significantly graver bottleneck when compared to a single exchange?

Martin



From alter at tcontest.ru  Tue Apr 22 14:32:03 2008
From: alter at tcontest.ru (Andrew V. Statsenko)
Date: Tue, 22 Apr 2008 17:32:03 +0400
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <4805F596.7050605@lshift.net>
References: <47FCA0A7.5000006@brandproduction.ru> <47FD3A0A.1090600@lshift.net>
	<1208346354.12447.224.camel@alter.njam.naunet.ru>
	<4805F596.7050605@lshift.net>
Message-ID: <1208871123.30349.32.camel@alter.njam.naunet.ru>

? ???, 16/04/2008 ? 13:48 +0100, Matthias Radestock ?????:

Hello

> Erlang in SMP mode will indeed happily use all your CPUs. It won't 
> necessarily go any faster though. In our experience - and I should 
> stress that this is for RabbitMQ and R11B-x only - it doesn't.
> 
> You don't need to know anything about Erlang to configure a local 
> cluster. Take a look at the http://www.rabbitmq.com/clustering.html - if 
> anything isn't clear in those instructions then please let us know ...

> OTOH, you should only look into clustering once the other issues have 
> been resolved.

Well, I was configured the local cluster for 8 nodes:

# su rabbitmq -c "/usr/sbin/rabbitmq-multi start_all 8"
Starting all nodes...   
Starting node 0....
RabbitMQ 1.3.0 (AMQP 8-0)
Copyright (C) 2007-2008 LShift Ltd., Cohesive Financial Technologies
LLC., and Rabbit Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

Logging to "/var/log/rabbitmq/rabbit.log"
SASL logging to "/var/log/rabbitmq/rabbit-sasl.log"

starting database             ...done
starting core processes       ...done
starting recovery             ...done
starting persister            ...done
starting builtin applications ...done
starting TCP listeners        ...done

broker running
OK
....

and modify the my test client to connect for different nodes

    Random random = new Random();
    int port = Math.abs( random.nextInt() ) % 8;
    ConnectionFactory factory = new ConnectionFactory(params);
    this.connection = factory.newConnection(this.HOSTNAME,
AMQP.PROTOCOL.PORT + port);

So, then I was run 250 producer's and 250 consumers - 2500 mps:

$ java -jar RabbitmqFastMessagingProducerTest.jar 250 > client.log

the server side looks like:

Tasks: 140 total,   8 running, 132 sleeping,   0 stopped,   0 zombie
Cpu(s): 92.7%us,  0.7%sy,  0.0%ni,  6.1%id,  0.0%wa,  0.0%hi,  0.4%si,
0.0%st
Mem:   4139508k total,  2296220k used,  1843288k free,   324364k buffers
Swap:  4194296k total,        0k used,  4194296k free,   853184k cached

PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 4499 rabbitmq  25   0  136m  91m 1612 R  100  2.3  25:26.72 beam
 5131 rabbitmq  25   0  165m  99m 1612 R  100  2.5  27:13.94 beam
 6395 rabbitmq  25   0  121m  78m 1612 R  100  1.9  28:48.16 beam
 4183 rabbitmq  25   0  322m 282m 1984 R  100  7.0  47:28.18 beam
 5447 rabbitmq  25   0  146m 105m 1612 R  100  2.6  29:58.29 beam
 6079 rabbitmq  16   0  128m  85m 1612 R   88  2.1  31:46.84 beam
 4815 rabbitmq  16   0 97216  64m 1612 R   84  1.6  32:59.81 beam
 5763 rabbitmq  15   0  120m  79m 1612 S   79  2.0  28:58.69
beam                    

and the client log is 

$ tail -f client.log | awk '/CLIENT_CONSUMER_THREAD_ID/{print "DELAY: "
$4-$8 " " $0}'

DELAY: 13842 CLIENT_CONSUMER_THREAD_ID: 202 TIME: 1208870263522 MESSAGE:
1784 TIME: 1208870249680
DELAY: 42 CLIENT_CONSUMER_THREAD_ID: 229 TIME: 1208870263522 MESSAGE:
1911 TIME: 1208870263480
DELAY: 2597 CLIENT_CONSUMER_THREAD_ID: 21 TIME: 1208870263527 MESSAGE:
1888 TIME: 1208870260930
DELAY: 21917 CLIENT_CONSUMER_THREAD_ID: 230 TIME: 1208870263527 MESSAGE:
1709 TIME: 1208870241610
DELAY: 47 CLIENT_CONSUMER_THREAD_ID: 5 TIME: 1208870263527 MESSAGE: 1913
TIME: 1208870263480
DELAY: 43778 CLIENT_CONSUMER_THREAD_ID: 241 TIME: 1208870263528 MESSAGE:
1508 TIME: 1208870219750
DELAY: 16053 CLIENT_CONSUMER_THREAD_ID: 4 TIME: 1208870263533 MESSAGE:
1766 TIME: 1208870247480
DELAY: 76736 CLIENT_CONSUMER_THREAD_ID: 79 TIME: 1208870263536 MESSAGE:
1207 TIME: 1208870186800
DELAY: 50 CLIENT_CONSUMER_THREAD_ID: 39 TIME: 1208870263540 MESSAGE:
1911 TIME: 1208870263490
DELAY: 50 CLIENT_CONSUMER_THREAD_ID: 120 TIME: 1208870263540 MESSAGE:
1911 TIME: 1208870263490
DELAY: 8 CLIENT_CONSUMER_THREAD_ID: 123 TIME: 1208870263548 MESSAGE:
1912 TIME: 1208870263540
DELAY: 14131 CLIENT_CONSUMER_THREAD_ID: 185 TIME: 1208870263561 MESSAGE:
1782 TIME: 1208870249430
DELAY: 80914 CLIENT_CONSUMER_THREAD_ID: 175 TIME: 1208870263564 MESSAGE:
1170 TIME: 1208870182650

In this configuration latency may very good - 8-50 ms or very bad -
76736-80914 ms.

?
> Note that this will result in the consumers receiving the messages from 
> *all* producers. The program is called "MulticastMain" for a reason :)

OK, In variant N producers => 1 consumer I see, that RabbitMQ may act as very fast "message collector":

$ sh ./runjava.sh com.rabbitmq.examples.MulticastMain -h host.domain.tld -a -r 100 -x 100 -y 1 | grep recving
...
recving rate: 9544 msg/s, min/avg/max latency: 1767/32375/113036 microseconds
recving rate: 10049 msg/s, min/avg/max latency: 1075/29551/102870 microseconds
recving rate: 9861 msg/s, min/avg/max latency: 1617/47801/138087 microseconds
recving rate: 9824 msg/s, min/avg/max latency: 1368/42204/131378 microseconds
recving rate: 10516 msg/s, min/avg/max latency: 1385/31713/99587 microseconds

?
And in variant 1 producers => N consumer I, see that RabbitMQ may act as very fast "message brodcaster":

$ sh ./runjava.sh com.rabbitmq.examples.MulticastMain -h host.domain.tld -a -r 100 -x 1 -y 100 | grep recving
recving rate: 0 msg/s, min/avg/max latency: 48143/48143/48143 microseconds
recving rate: 10024 msg/s, min/avg/max latency: 5343/38838/96254 microseconds
recving rate: 9867 msg/s, min/avg/max latency: 5649/44256/93694 microseconds
recving rate: 9814 msg/s, min/avg/max latency: 2857/41523/92171 microseconds
recving rate: 10218 msg/s, min/avg/max latency: 2951/41081/101019 microseconds
recving rate: 9995 msg/s, min/avg/max latency: 5634/39705/92788 microseconds
recving rate: 9933 msg/s, min/avg/max latency: 2846/42851/100338 microseconds


I am very sorry about my (may be very stupid ?) question: 

Is any way to improve perfomance and reduce latency in my N producers => M consumers scheme ?


WBR,
Alter






From dmitriy.samovskiy at cohesiveft.com  Tue Apr 22 19:56:49 2008
From: dmitriy.samovskiy at cohesiveft.com (Dmitriy Samovskiy)
Date: Tue, 22 Apr 2008 13:56:49 -0500
Subject: [rabbitmq-discuss] FYI  snoopy breaks erlang (and rabbitmq)
Message-ID: <480E34F1.2070708@cohesiveft.com>

Hi all,

If you are on Debian Linux (other *nix flavors might be affected as well) and rabbitmq 
broker doesn't start, or you can't get its status with rabbitmqctl, please see if you have 
snoopy installed. If yes, remove it.

I wrote it up in more detail here:
http://somic-org.homelinux.org/blog/2008/04/22/snoopy-fubars-erlang/

- Dmitriy



From ksalasko at gmail.com  Wed Apr 23 04:19:47 2008
From: ksalasko at gmail.com (Kyle)
Date: Tue, 22 Apr 2008 23:19:47 -0400
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <480D8E21.70306@imatix.com>
References: <16820505.post@talk.nabble.com> <480D7491.6030200@lshift.net>
	<480D8E21.70306@imatix.com>
Message-ID: <ffa3c1da0804222019g5ea00885j57a68b9dac806385@mail.gmail.com>

Matthias,

It occurred to me that rather than introducing a new exchange type one could
> place an indicator in the exchange arguments that turns any exchange from a
> multicast to an anycast exchange. That has two advantages:
>
> - we stay entirely within the defined protocol standard
>
> - the user can select the most appropriate matching logic with the
> exchange type, rather than being constrained to topic-based matching


I'll take a look at this when I get a chance, sounds like a decent idea to
me.

- use a flag in the process dictionary to indicate whether the random number
> generator has been seeded. Check/set that flag in your current code that
> invokes random:uniform. This has the same effect as the previous approach
> but is a less intrusive change since you don't need to touch any other
> modules.
>

Got this working, and less intrusive wins out in my mind. I'll send out
another version of the diff when I get to the above change, or if I leave
that on the back burner for too long.

Martin,

I've seen this requirement before, however, AFAICS it breaks AMQP model. The
> exchanges are meant to be used for message distribution, i.e. the message
> should be delivered to *all* queues with appropriate binding to the
> exchange. Queues are intended to do the load-balancing. Not adhering to this
> model causes problems with some more sophisticated use cases (wire-tapping,
> federation). It also introduces a lot of unfairness to the load-balancing
> algorithm. Why do you believe a single queue would create a significantly
> graver bottleneck when compared to a single exchange?


>From what I could tell from the RabbitMQ docs,  even if I have a single
exchange, messages can be routed through any node in the cluster. Therefore
there should be no significant bottleneck with a single exchange, because
there is no single node that all messages must go through. With a single
queue, however, every message has to be sent to the machine on which that
queue lives, after which different subscribers can pull messages off. This
looks like a bottleneck to me, where all messages go through one machine,
whereas a single exchange does not have that problem (unless I missed
something). I'd love to have the queues do the load balancing, but as we're
dealing with commodity hardware (EC2), having a single machine handle all
our messages is a significant problem.

As to the other concern, clearly there are some use cases of AMQP that this
will not work for. We're using RabbitMQ for pub-sub style message
distribution as well as the requirement this change handles, and for
simplicity we would like to use the same technology (and implementation) to
satisfy both requirements.

Kyle
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080422/952f9a2b/attachment.htm 

From matthias at lshift.net  Wed Apr 23 06:18:57 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Wed, 23 Apr 2008 06:18:57 +0100
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <ffa3c1da0804222019g5ea00885j57a68b9dac806385@mail.gmail.com>
References: <16820505.post@talk.nabble.com>
	<480D7491.6030200@lshift.net>	<480D8E21.70306@imatix.com>
	<ffa3c1da0804222019g5ea00885j57a68b9dac806385@mail.gmail.com>
Message-ID: <480EC6C1.5020305@lshift.net>

Kyle,

Kyle wrote:
> Matthias,
>     - use a flag in the process dictionary to indicate whether the
>     random number generator has been seeded. Check/set that flag in your
>     current code that invokes random:uniform. This has the same effect
>     as the previous approach but is a less intrusive change since you
>     don't need to touch any other modules.
> 
> 
> Got this working, and less intrusive wins out in my mind. I'll send out 
> another version of the diff when I get to the above change, or if I 
> leave that on the back burner for too long.

Btw, if you look at the code (and docs) of the 'random' module you'll 
see it is using the process dictionary already to remember the last 
seed. So, to save duplication of work, I'd use something like the following:

random_uniform(N) ->
     Seed = case get(random_seed) of
                undefined -> erlang:now();
                Tuple -> Tuple
            end,
     {V, NewSeed} = random:uniform_s(N, Seed),
     put(random_seed, NewSeed),
     V.

>  From what I could tell from the RabbitMQ docs,  even if I have a single 
> exchange, messages can be routed through any node in the cluster. 
> Therefore there should be no significant bottleneck with a single 
> exchange, because there is no single node that all messages must go 
> through. With a single queue, however, every message has to be sent to 
> the machine on which that queue lives, after which different subscribers 
> can pull messages off. This looks like a bottleneck to me, where all 
> messages go through one machine, whereas a single exchange does not have 
> that problem (unless I missed something).

That analysis is correct. I think what Martin is getting at is that this 
is really an implementation issue - in principle AMQP queues do what you 
want, it just so happens that in RabbitMQ they are implemented as a 
single (Erlang) process rather than being distributed. The latter is 
something we are looking into, but it will take a while to implement. 
Meanwhile your solution is an excellent way of addressing the problem.


Matthias.



From sustrik at imatix.com  Wed Apr 23 07:42:03 2008
From: sustrik at imatix.com (Martin Sustrik)
Date: Wed, 23 Apr 2008 08:42:03 +0200
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <480EC6C1.5020305@lshift.net>
References: <16820505.post@talk.nabble.com>
	<480D7491.6030200@lshift.net>	<480D8E21.70306@imatix.com>
	<ffa3c1da0804222019g5ea00885j57a68b9dac806385@mail.gmail.com>
	<480EC6C1.5020305@lshift.net>
Message-ID: <480EDA3B.1000300@imatix.com>


>
>>  From what I could tell from the RabbitMQ docs,  even if I have a 
>> single exchange, messages can be routed through any node in the 
>> cluster. Therefore there should be no significant bottleneck with a 
>> single exchange, because there is no single node that all messages 
>> must go through. With a single queue, however, every message has to 
>> be sent to the machine on which that queue lives, after which 
>> different subscribers can pull messages off. This looks like a 
>> bottleneck to me, where all messages go through one machine, whereas 
>> a single exchange does not have that problem (unless I missed 
>> something).
>
> That analysis is correct. I think what Martin is getting at is that 
> this is really an implementation issue - in principle AMQP queues do 
> what you want, it just so happens that in RabbitMQ they are 
> implemented as a single (Erlang) process rather than being 
> distributed. The latter is something we are looking into, but it will 
> take a while to implement. Meanwhile your solution is an excellent way 
> of addressing the problem.
Thanks for explanation. I was just interested what the use case was.

Martin



From ksalasko at gmail.com  Wed Apr 23 18:50:06 2008
From: ksalasko at gmail.com (Kyle)
Date: Wed, 23 Apr 2008 13:50:06 -0400
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <480D7491.6030200@lshift.net>
References: <16820505.post@talk.nabble.com> <480D7491.6030200@lshift.net>
Message-ID: <ffa3c1da0804231050q47367ba9xdf34f7f8d3736d6@mail.gmail.com>

Attached is a revised version of the first patch with the changes below.
Rather than using a different exchange type, add "anycast" = 1 to the
arguments passed to exchangeDeclare. I've tested this with fanout and topic
exchanges with the RabbitMQ java library and py-amqplib from Barry Pederson.

Kyle

On Tue, Apr 22, 2008 at 1:16 AM, Matthias Radestock <matthias at lshift.net>
wrote:

>
> It occurred to me that rather than introducing a new exchange type one
> could place an indicator in the exchange arguments that turns any exchange
> from a multicast to an anycast exchange. That has two advantages:
>
> - we stay entirely within the defined protocol standard
>
> - the user can select the most appropriate matching logic with the
> exchange type, rather than being constrained to topic-based matching
>
> - use a flag in the process dictionary to indicate whether the random
> number generator has been seeded. Check/set that flag in your current code
> that invokes random:uniform. This has the same effect as the previous
> approach but is a less intrusive change since you don't need to touch any
> other modules.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080423/c9b15828/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbit_exchange.erl.diff
Type: text/x-diff
Size: 1276 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080423/c9b15828/attachment.diff 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbit_exchange.erl
Type: application/octet-stream
Size: 14275 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080423/c9b15828/attachment.obj 

From ksalasko at gmail.com  Thu Apr 24 02:38:12 2008
From: ksalasko at gmail.com (Kyle)
Date: Wed, 23 Apr 2008 21:38:12 -0400
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <ffa3c1da0804231050q47367ba9xdf34f7f8d3736d6@mail.gmail.com>
References: <16820505.post@talk.nabble.com> <480D7491.6030200@lshift.net>
	<ffa3c1da0804231050q47367ba9xdf34f7f8d3736d6@mail.gmail.com>
Message-ID: <ffa3c1da0804231838u51055309ha6114d953bb073c1@mail.gmail.com>

I accidentally deleted a couple of lines, causing the channel to crash on an
anycast exchange with no listeners, because random:uniform(0) is undefined.
Diff is attached.

Kyle
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080423/250cf71b/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbit_exchange.erl.diff
Type: text/x-diff
Size: 1311 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080423/250cf71b/attachment.diff 

From matthias at lshift.net  Thu Apr 24 20:49:09 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 24 Apr 2008 20:49:09 +0100
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <ffa3c1da0804231838u51055309ha6114d953bb073c1@mail.gmail.com>
References: <16820505.post@talk.nabble.com>
	<480D7491.6030200@lshift.net>	<ffa3c1da0804231050q47367ba9xdf34f7f8d3736d6@mail.gmail.com>
	<ffa3c1da0804231838u51055309ha6114d953bb073c1@mail.gmail.com>
Message-ID: <4810E435.2040209@lshift.net>

Kyle,


Kyle wrote:
>  Diff is attached.

a few comments ...

- Why is there the curious special-casing for the processing of the Args 
for a topic exchange?

- You should be able to use AMQP's boolean type for the "anycast" 
argument, rather than 0 and 1. Also, take a look at lists:keysearch. 
With those two changes the code should simplify to this:

H = route_sub(Exchange, RoutingKey),
case lists:keysearch(<<"anycast">>, 1, Args) of
     {value, {_Name, bool, true}} -> random_queue(H);
     _Other -> H
end.


Matthias.



From matthias at lshift.net  Thu Apr 24 21:16:55 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 24 Apr 2008 21:16:55 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <1208871123.30349.32.camel@alter.njam.naunet.ru>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FD3A0A.1090600@lshift.net>	<1208346354.12447.224.camel@alter.njam.naunet.ru>	<4805F596.7050605@lshift.net>
	<1208871123.30349.32.camel@alter.njam.naunet.ru>
Message-ID: <4810EAB7.7070209@lshift.net>

Alter,

Andrew V. Statsenko wrote:

> Well, I was configured the local cluster for 8 nodes:
> 
> # su rabbitmq -c "/usr/sbin/rabbitmq-multi start_all 8"
> Starting all nodes...   
> [...]
> broker running
> OK

Great. Glad it worked without problems.

> Is any way to improve perfomance and reduce latency in my N producers => M consumers scheme ?

Did you make the other changes I suggested previously, namely:

- change the exchange type from "topic" to "direct"

- make sure that all the producer & consumer connections are set up and 
the queues have been created before starting to send any messages

?


Matthias.



From ksalasko at gmail.com  Thu Apr 24 23:16:46 2008
From: ksalasko at gmail.com (Kyle)
Date: Thu, 24 Apr 2008 18:16:46 -0400
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <4810E435.2040209@lshift.net>
References: <16820505.post@talk.nabble.com> <480D7491.6030200@lshift.net>
	<ffa3c1da0804231050q47367ba9xdf34f7f8d3736d6@mail.gmail.com>
	<ffa3c1da0804231838u51055309ha6114d953bb073c1@mail.gmail.com>
	<4810E435.2040209@lshift.net>
Message-ID: <ffa3c1da0804241516s1ff25e1cw6eaf9ca762dc09b5@mail.gmail.com>

Matthias,

On Thu, Apr 24, 2008 at 3:49 PM, Matthias Radestock <matthias at lshift.net>
wrote:

> - Why is there the curious special-casing for the processing of the Args
> for a topic exchange?
>

The special case was already in the declare method in
rabbit_exchange.erl:60. Args for a topic exchange is set to a tuple:
{sets:new(), Args}, while Args for other exchanges is passed through as a
list. The code you posted won't work unless Args is a list in all exchange
types.

- You should be able to use AMQP's boolean type for the "anycast" argument,
> rather than 0 and 1. Also, take a look at lists:keysearch. With those two
> changes the code should simplify to this:
>

When I ran some tests of checking for the anycast argument, it came up as a
signedint. This may be due to the python library I used. I set anycast=True,
and got a signedint in rabbit_exchange:route. I didn't check setting
anycast=true in the java libs, I'll look into it. Otherwise the match would
have to be {_Name, signedint, 1}, correct?

Kyle
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080424/4db23756/attachment.htm 

From alter at tcontest.ru  Thu Apr 24 23:23:12 2008
From: alter at tcontest.ru (Andrew V.Statsenko)
Date: Fri, 25 Apr 2008 02:23:12 +0400
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <4810EAB7.7070209@lshift.net>
References: <47FCA0A7.5000006@brandproduction.ru> <47FD3A0A.1090600@lshift.net>
	<1208346354.12447.224.camel@alter.njam.naunet.ru>
	<4805F596.7050605@lshift.net>
	<1208871123.30349.32.camel@alter.njam.naunet.ru>
	<4810EAB7.7070209@lshift.net>
Message-ID: <1209075792.1750.45.camel@unknown>

?? ????, 24/04/2008 ?? 21:16 +0100, Matthias Radestock ??????????:


Matthias, thanks a lot for your answer !

> 
> > Well, I was configured the local cluster for 8 nodes:
> > 
> > # su rabbitmq -c "/usr/sbin/rabbitmq-multi start_all 8"
> > Starting all nodes...   
> > [...]
> > broker running
> > OK
> 
> Great. Glad it worked without problems.

And I'm still do think, that we are have a same stable Debian without
(white ? / black ?) magic  :-)


Mmm.. a little: usermod -s /bin/sh rabbitmq. 
Yes, a security hole, but I'm just testing.


> 
> > Is any way to improve perfomance and reduce latency in my N producers => M consumers scheme ?
> 
> Did you make the other changes I suggested previously, namely:
> 
> - change the exchange type from "topic" to "direct"

Well, just a second..

> 
> - make sure that all the producer & consumer connections are set up and 
> the queues have been created before starting to send any messages

Yes, all producers & consumers connections are set before start
send/recieve messages (class constructor) and thread sleep 10 sec after
queues creation and before starting to send any messages


I change the exchange type in producer & consumer from "topic" to
"direct" and start test:

$ java -jar RabbitmqFastMessagingProducerTest.jar 1000 > client.log

The server side of 8 local nodes with  10000 mps looks good:

top - 01:32:47 up 20 days,  8:01,  3 users,  load average: 0.84, 1.31,
0.71
Tasks: 152 total,   1 running, 151 sleeping,   0 stopped,   0 zombie
Cpu(s):  7.4%us,  1.3%sy,  0.0%ni, 89.6%id,  0.0%wa,  0.0%hi,  1.6%si,
0.0%st
Mem:   4139508k total,  1610992k used,  2528516k free,   334196k buffers
Swap:  4194296k total,        0k used,  4194296k free,   862924k cached

PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
12613 rabbitmq  15   0 47604  22m 1596 S   12  0.6   0:37.40 beam
12931 rabbitmq  15   0 48552  23m 1596 S   11  0.6   0:38.55 beam
14203 rabbitmq  15   0 48552  23m 1596 S   11  0.6   0:38.15 beam
13567 rabbitmq  15   0 47612  23m 1596 S   10  0.6   0:37.39 beam
14521 rabbitmq  15   0 48556  23m 1596 S   10  0.6   0:35.25 beam
13885 rabbitmq  15   0 48560  23m 1596 S    9  0.6   0:37.93 beam
14839 rabbitmq  15   0 48556  22m 1596 S    9  0.6   0:35.80 beam
13249 rabbitmq  15   0 48556  23m 1596 S    8  0.6   0:34.43 beam


The client side is also looks good and very low delay (1-20 ms):

$ tail -f client.log | awk '/CLIENT_CONSUMER_THREAD_ID/{print "DELAY: "
$4-$8 " " $0}'

DELAY: 1 CLIENT_CONSUMER_THREAD_ID: 167 TIME: 1209073100621 MESSAGE:
4469 TIME: 1209073100620
DELAY: 2 CLIENT_CONSUMER_THREAD_ID: 988 TIME: 1209073100622 MESSAGE:
4469 TIME: 1209073100620
DELAY: 2 CLIENT_CONSUMER_THREAD_ID: 333 TIME: 1209073100622 MESSAGE:
4468 TIME: 1209073100620
DELAY: 3 CLIENT_CONSUMER_THREAD_ID: 56 TIME: 1209073100623 MESSAGE: 4468
TIME: 1209073100620
DELAY: 43 CLIENT_CONSUMER_THREAD_ID: 857 TIME: 1209073100623 MESSAGE:
4467 TIME: 1209073100580
DELAY: 3 CLIENT_CONSUMER_THREAD_ID: 892 TIME: 1209073100623 MESSAGE:
4462 TIME: 1209073100620
DELAY: 4 CLIENT_CONSUMER_THREAD_ID: 607 TIME: 1209073100624 MESSAGE:
4465 TIME: 1209073100620
DELAY: 4 CLIENT_CONSUMER_THREAD_ID: 553 TIME: 1209073100624 MESSAGE:
4464 TIME: 1209073100620
DELAY: 5 CLIENT_CONSUMER_THREAD_ID: 272 TIME: 1209073100625 MESSAGE:
4466 TIME: 1209073100620
DELAY: 6 CLIENT_CONSUMER_THREAD_ID: 654 TIME: 1209073100626 MESSAGE:
4463 TIME: 1209073100620



But, then I try to calculate message log I have a some confuse 

$ cat client.log | ggrep -v -E "(START|STOP)" | grep
CLIENT_PRODUCER_THREAD_ID | wc -l
 1000000

$ cat client.log | ggrep -v -E "(START|STOP)" | grep
CLIENT_CONSUMER_THREAD_ID | wc -l
  137983

Logs tells that I send 1000000 messages, but recieve only 137983 . 

Hmm... So, why ? 

I can't loss any messages in real play. The test code is attached.


P.S.
I'm very sorry, I'm realy need some sleep. 



WBR,
Alter


-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbitmqfastmessagingproducertest.tar.gz
Type: application/x-compressed-tar
Size: 2017 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080425/dcd6231e/attachment.bin 

From matthias at lshift.net  Fri Apr 25 06:57:07 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 25 Apr 2008 06:57:07 +0100
Subject: [rabbitmq-discuss] New exchange type
In-Reply-To: <ffa3c1da0804241516s1ff25e1cw6eaf9ca762dc09b5@mail.gmail.com>
References: <16820505.post@talk.nabble.com>
	<480D7491.6030200@lshift.net>	<ffa3c1da0804231050q47367ba9xdf34f7f8d3736d6@mail.gmail.com>	<ffa3c1da0804231838u51055309ha6114d953bb073c1@mail.gmail.com>	<4810E435.2040209@lshift.net>
	<ffa3c1da0804241516s1ff25e1cw6eaf9ca762dc09b5@mail.gmail.com>
Message-ID: <481172B3.3020300@lshift.net>

Kyle,

Kyle wrote:
> On Thu, Apr 24, 2008 at 3:49 PM, Matthias Radestock <matthias at lshift.net 
> <mailto:matthias at lshift.net>> wrote:
> 
>     - Why is there the curious special-casing for the processing of the
>     Args for a topic exchange?
> 
> The special case was already in the declare method in 
> rabbit_exchange.erl:60. Args for a topic exchange is set to a tuple: 
> {sets:new(), Args},

Ah, I am pretty sure that bit of code is no longer needed. We should fix 
that. Well spotted.

>     - You should be able to use AMQP's boolean type for the "anycast"
>     argument, rather than 0 and 1. Also, take a look at lists:keysearch.
>     With those two changes the code should simplify to this:
> 
> When I ran some tests of checking for the anycast argument, it came up 
> as a signedint. This may be due to the python library I used. I set 
> anycast=True, and got a signedint in rabbit_exchange:route.

It turns out that the boolean table field type is a protocol extension 
introduced by qpid that we subsequently implemented in our broker for 
better interoperability. It is not supported by our Java client (we will 
consider adding it) and, I suspect, the python lib you are using.

> Otherwise the match would have to be {_Name, signedint, 1}, correct?

Yes, that should work.


Matthias.



From matthias at lshift.net  Fri Apr 25 07:15:20 2008
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 25 Apr 2008 07:15:20 +0100
Subject: [rabbitmq-discuss] RabbitMQ perfomance testing & troubles
In-Reply-To: <1209075792.1750.45.camel@unknown>
References: <47FCA0A7.5000006@brandproduction.ru>
	<47FD3A0A.1090600@lshift.net>	<1208346354.12447.224.camel@alter.njam.naunet.ru>	<4805F596.7050605@lshift.net>	<1208871123.30349.32.camel@alter.njam.naunet.ru>	<4810EAB7.7070209@lshift.net>
	<1209075792.1750.45.camel@unknown>
Message-ID: <481176F8.9090405@lshift.net>

Alter,

Andrew V.Statsenko wrote:
>> - make sure that all the producer & consumer connections are set up and 
>> the queues have been created before starting to send any messages
> 
> Yes, all producers & consumers connections are set before start
> send/recieve messages (class constructor) and thread sleep 10 sec after
> queues creation and before starting to send any messages

You should move the exchange declaration, queue declaration, queue bind 
and basicConsume call into the constructors. Then you won't need the 
'sleep' either.

This is important because ...

> But, then I try to calculate message log I have a some confuse 
> 
> $ cat client.log | ggrep -v -E "(START|STOP)" | grep
> CLIENT_PRODUCER_THREAD_ID | wc -l
>  1000000
> 
> $ cat client.log | ggrep -v -E "(START|STOP)" | grep
> CLIENT_CONSUMER_THREAD_ID | wc -l
>   137983
> 
> Logs tells that I send 1000000 messages, but recieve only 137983 . 
> 
> Hmm... So, why ? 
> 
> I can't loss any messages in real play. The test code is attached.

You are creating and binding the queues inside the thread. That creates 
a race; the producer may have started sending messages before the 
consumer queue has been created and bound, which results in the early 
messages being dropped.


Btw, I notice that you have set frameMax to 128. Why?


Matthias.



From David.Corcoran at edftrading.com  Wed Apr 30 17:39:48 2008
From: David.Corcoran at edftrading.com (David.Corcoran at edftrading.com)
Date: Wed, 30 Apr 2008 17:39:48 +0100
Subject: [rabbitmq-discuss] odd consumer behaviour
Message-ID: <OF9C53C83C.97795367-ON8025743B.005AAA2F-8025743B.005B86F4@Edftrading.com>


Hi,

I'm evaluating RabbitMQ as a replacement for our JMS code but I've run into
some slightly odd behaviour.

I've managed to replicate it in a simple example. So:

1. Run the HelloClient RabbitMQ example modified slightly so that it sends
20 messages instead of 1.
2. Run the HelloServer example but with a slight change to the code. Add a
Thread.sleep(10*1000) before the return in handleStringCall().
3. Now run a normal HelloServer example, without any sleep.
What I noticed here is that the normal example doesn't run at full speed.
It looks like the slow server is slowing down the normal one.
5. Kill the slow server (the one with the sleep) and the normal HelloServer
now runs at full speed and finishes the rest of the messages within the
second.

Any help would be great.

Thanks,

Dave


*********************************************************************
This communication contains confidential information, some or all of which may be privileged. It is for the intended recipient only and others must not disclose, distribute, copy, print or rely on this communication. If an addressing or transmission error has misdirected this communication, please notify the sender by replying to this e-mail and then delete the e-mail. E-mail sent to EDF Trading may be monitored by the company. Thank you. 
EDF Trading Limited
80 Victoria Street, 3rd Floor, Cardinal Place, London, SW1E 5JL
A Company registered in England No. 4255974. 
Switchboard: 020 7061 4000
EDF Trading Markets Limited is a member of the EDF Trading Limited Group and is authorised and regulated by the Financial Services Authority.
VAT number: GB 735 5479 07
*********************************************************************



From tonyg at lshift.net  Wed Apr 30 18:22:51 2008
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Wed, 30 Apr 2008 18:22:51 +0100
Subject: [rabbitmq-discuss] STOMP adapter updated for RabbitMQ v1.3.0
Message-ID: <4818AAEB.1050905@lshift.net>

Hi all,

Thanks to Carl Bourne, who reported a bug in the STOMP adapter, I've
gotten around to updating it to run against RabbitMQ server v1.3.0.

You can see the details at
http://www.lshift.net/blog/2008/04/30/stomp-adapter-updated-for-rabbitmq-130,
but in summary:

In window 1:
===========================================================================
curl http://www.rabbitmq.com/releases/source/rabbitmq-1.3.0.tar.gz | tar
-zxvf -

curl
http://hg.opensource.lshift.net/rabbitmq-stomp/archive/rabbitmq_v1_3_0_branch.tar.gz
| tar -zxvf -

make -C rabbitmq-1.3.0/erlang/rabbit

make -C rabbitmq-stomp-rabbitmq_v1_3_0_branch run
===========================================================================

In window 2:
===========================================================================
sudo apt-get install ruby
sudo apt-get install rubygems
sudo gem install stomp
ruby rabbitmq-stomp-rabbitmq_v1_3_0_branch/priv/tests-ruby/cb-receiver.rb
===========================================================================

In window 3:
===========================================================================
ruby rabbitmq-stomp-rabbitmq_v1_3_0_branch/priv/tests-ruby/cb-sender.rb
===========================================================================


Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



