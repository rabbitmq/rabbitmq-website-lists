<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ production setup questions around	clustering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%09clustering&In-Reply-To=%3CAANLkTilAsQxT7gbSzCe4o95q3ZX_AXWaKlZYz7NgXArN%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008119.html">
   <LINK REL="Next"  HREF="008124.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ production setup questions around	clustering</H1>
    <B>Aaron Westendorf</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%09clustering&In-Reply-To=%3CAANLkTilAsQxT7gbSzCe4o95q3ZX_AXWaKlZYz7NgXArN%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ production setup questions around	clustering">aaron at agoragames.com
       </A><BR>
    <I>Thu Jul 22 13:50:58 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008119.html">[rabbitmq-discuss] How to implement the Aggregator pattern?
</A></li>
        <LI>Next message: <A HREF="008124.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8123">[ date ]</a>
              <a href="thread.html#8123">[ thread ]</a>
              <a href="subject.html#8123">[ subject ]</a>
              <a href="author.html#8123">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dave,

Including the list on the reply.

On Wed, Jul 21, 2010 at 5:44 PM, Dave Greggory &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">davegreggory at yahoo.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Your postal service analogy is good one and that is how I understood it mostly.
</I>&gt;<i> From what I understood, if a client requests a message from a queue that is not
</I>&gt;<i> on the node he has the current connection to, because of clustering, you will
</I>&gt;<i> get the message back indirectly. But your analogy makes it sound like the client
</I>&gt;<i> will actually need to establish a second connection to the node that has the
</I>&gt;<i> queue. I'm fine with that, that's not a big deal.
</I>
I may be wrong in this, Alexandru hinted that clustering might be more
of flexible than I described.

&gt;<i> I declare my (durable) queues from the both producer and consumer ends because
</I>&gt;<i> exchanges would just drop the messages if we left it up to consumers and no
</I>&gt;<i> consumers were up at the time a producer sends message. So But I'm trying to
</I>&gt;<i> understand where a queue will be created when it's &#160;declared (will it be in the
</I>&gt;<i> node the client has the connection open to or &#160;could it end up existing in
</I>&gt;<i> another node)?
</I>
We have run in to that exact chicken-and-egg problem.  We don't have a
need for persistent messages before a consumer starts for the first
time, so we've been able to allow the consumer to drive the queue
declare and drop unrouteable messages.  If that doesn't work for you,
then perhaps you can have something that sits outside your apps and
ensures that all queues are declared and in good health.  We've taken
to adding a several monitoring tools because it's so easy and it adds
to our reliability.

The queue will exist on the host to which you are connected when you declare it.

&gt;<i> I may have misused the term load-balancer in this context (just because that's
</I>&gt;<i> what we use that piece of hardware most often). Let's just call it node-switcher
</I>&gt;<i> for this purpose. I intended it to serve two purposes,
</I>&gt;<i> a) Hide the hostnames/ip-addresses of rabbitmq nodes from producers and clients
</I>&gt;<i> b) Serve as switch for determining which rabbitmq nodes consumers/producers
</I>&gt;<i> connect to, so that we can:
</I>&gt;<i> &#160; &#160; i. Switch all new consumer/producer connections &#160;automatically to the other
</I>&gt;<i> node if the first node goes down
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; ii. Upgrade rabbitmq nodes without affecting producer/consumer nodes
</I>&gt;<i> because we can switch out different rabbitmq nodes
</I>
We've solved this problem with DNS aliases.  It's not automated by
design but it does allow us to cleanly disconnect nodes and have the
clients reconnect to another.  The trick there is that if a queue
existed on a node that is shutdown, the clients have to also declare
it, its bindings and the consumers again.  This was best accomplished
for us by simply killing the clients off on a Rabbit disconnect and
letting the &quot;hypervisor&quot; restart them.

That only worked because all consumers of the queue were connected to
the same host on which the queue resided.  If Alexandru is correct and
the cluster can be treated as a pool, then the reconnect scenario has
to include those other clients re-initializing their consumer calls to
the new queue, after it is re-declared.  So perhaps it is best to
always connect to the node hosting the queue you want to consume from.

cheers,
Aaron

-- 
Aaron Westendorf
Senior Software Engineer
Agora Games
359 Broadway
Troy, NY 12180
Phone: 518.268.1000
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">aaron at agoragames.com</A>
www.agoragames.com
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008119.html">[rabbitmq-discuss] How to implement the Aggregator pattern?
</A></li>
	<LI>Next message: <A HREF="008124.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8123">[ date ]</a>
              <a href="thread.html#8123">[ thread ]</a>
              <a href="subject.html#8123">[ subject ]</a>
              <a href="author.html#8123">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
