<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Preventing uncontrolled crashes due to file	descriptor exhaustion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Preventing%20uncontrolled%20crashes%20due%20to%20file%0A%09descriptor%20exhaustion&In-Reply-To=%3CAANLkTiltJvVdV1adQbU6MsuO904nOuwybs_oCWZAU6YX%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007931.html">
   <LINK REL="Next"  HREF="007949.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Preventing uncontrolled crashes due to file	descriptor exhaustion</H1>
    <B>Marek Majkowski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Preventing%20uncontrolled%20crashes%20due%20to%20file%0A%09descriptor%20exhaustion&In-Reply-To=%3CAANLkTiltJvVdV1adQbU6MsuO904nOuwybs_oCWZAU6YX%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Preventing uncontrolled crashes due to file	descriptor exhaustion">majek04 at gmail.com
       </A><BR>
    <I>Tue Jul 13 11:24:09 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007931.html">[rabbitmq-discuss] Preventing uncontrolled crashes due to file	descriptor exhaustion
</A></li>
        <LI>Next message: <A HREF="007949.html">[rabbitmq-discuss] Preventing uncontrolled crashes due to file	descriptor exhaustion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7936">[ date ]</a>
              <a href="thread.html#7936">[ thread ]</a>
              <a href="subject.html#7936">[ subject ]</a>
              <a href="author.html#7936">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Jul 12, 2010 at 20:01, Tony Spataro &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tony at rightscale.com</A>&gt; wrote:
&gt;<i> While load testing my RabbitMQ-based RPC mechanism, I managed to get my
</I>&gt;<i> RabbitMQ server into some very interesting states when it had a large number
</I>&gt;<i> of connections. When the AMQP server exceeded ~1020 active connections, it
</I>&gt;<i> would become unstable and eventually crash in a way that lost some data
</I>&gt;<i> (including a few persistent messages that had been posted to durable
</I>&gt;<i> queues).
</I>
Well, don't do it. File descriptors are a finite resource and bad things
can happen when you're getting close to the limit. The same applies
to memory and disk.

But I agree, rabbit shouldn't loose the data.

In the new persister branch &quot;bug21673&quot; we've made some magical tweaks.
In this branch we try to make sure that there are always enough file descriptors
for erlang.

Could you repeat your test on that branch, and tell us if it's any better?

Cheers!
  Marek Majkowski

&gt;<i> The cause for the crash wasn't hard to discover: the parent process of
</I>&gt;<i> RabbitMQ was restricted to 1,024 open file handles (this is apparently the
</I>&gt;<i> default for the Linux distro I was running), and the resource limit is
</I>&gt;<i> inherited by child processes. Simply adding a &quot;ulimit -n 65535&quot; to the
</I>&gt;<i> RabbitMQ init script and a &quot;+P&#160;131072&quot; to the Erlang VM command-line gave
</I>&gt;<i> the server enough file handles and Erlang processes to handle the load.
</I>&gt;<i> What piqued my interest, however, was the catastrophic and data-lossy way in
</I>&gt;<i> which the server crashed when it reached its limit. Normally, RabbitMQ is
</I>&gt;<i> very good about avoiding data loss even when it crashes!
</I>&gt;<i> Some scrutiny of the logs yielded the following explanation: exhausting the
</I>&gt;<i> file handles available to the process prevents various fault-tolerance and
</I>&gt;<i> process control mechanisms from working, including:
</I>&gt;<i> -- a &quot;cpu-sup&quot; process that the VM is trying to communicate with via a port
</I>&gt;<i> -- writing the Mnesia tables that hold persisted queue contents
</I>&gt;<i> -- the &quot;rabbitmqctl&quot; process
</I>&gt;<i> The result of all these failures taken together is that the server decides
</I>&gt;<i> to shutdown but can't shutdown cleanly, leading to data loss.
</I>&gt;<i> My ultimate solution is rather crude, but workable: using the iptables
</I>&gt;<i> conntrack module, I will limit the number of inbound TCP connections to the
</I>&gt;<i> server and ensure that the server has enough free file handles to take care
</I>&gt;<i> of &quot;housekeeping&quot; operations.
</I>&gt;<i> I thought I'd share my results with the group in case anyone else has
</I>&gt;<i> encountered this problem, and also query whether anyone else has come up
</I>&gt;<i> with a different/better solution. Has anyone run into this yet?
</I>&gt;<i> Cheers,
</I>&gt;<i> &#160;&#160; &#160;Tony
</I></PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007931.html">[rabbitmq-discuss] Preventing uncontrolled crashes due to file	descriptor exhaustion
</A></li>
	<LI>Next message: <A HREF="007949.html">[rabbitmq-discuss] Preventing uncontrolled crashes due to file	descriptor exhaustion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7936">[ date ]</a>
              <a href="thread.html#7936">[ thread ]</a>
              <a href="subject.html#7936">[ subject ]</a>
              <a href="author.html#7936">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
