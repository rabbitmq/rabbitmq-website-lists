<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20C%20library%20function%0A%09amqp_simple_wait_frame%20takes%20400%20ms&In-Reply-To=%3CAANLkTinKUM6-MhH1V9I9FOLtp2yKaOKimFcE35Ybyn6N%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007836.html">
   <LINK REL="Next"  HREF="007845.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms</H1>
    <B>Jim Irrer</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20C%20library%20function%0A%09amqp_simple_wait_frame%20takes%20400%20ms&In-Reply-To=%3CAANLkTinKUM6-MhH1V9I9FOLtp2yKaOKimFcE35Ybyn6N%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms">irrer at umich.edu
       </A><BR>
    <I>Thu Jul  1 19:08:59 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007836.html">[rabbitmq-discuss] RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms
</A></li>
        <LI>Next message: <A HREF="007845.html">[rabbitmq-discuss] RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7837">[ date ]</a>
              <a href="thread.html#7837">[ thread ]</a>
              <a href="subject.html#7837">[ subject ]</a>
              <a href="author.html#7837">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I suggest modifying the C client to set TCP_NODELAY in the amqp_open_socket
function.  The
Java version of the code seems to do this in the SocketFrameHandler class
with the setTcpNoDelay
call.  It seems like this would be the preferred mode in most situations and
should be the default
behavior.  If the user does not like it, they can always turn it off by
calling setsockopt.

Thanks,

- Jim

Jim Irrer     <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A>       (734) 647-4409
University of Michigan Hospital Radiation Oncology
519 W. William St.             Ann Arbor, MI 48103


On Thu, Jul 1, 2010 at 2:08 PM, Jim Irrer &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A>&gt; wrote:

&gt;<i> I had tried setting TCP_NODELAY before but did it this way:
</I>&gt;<i>
</I>&gt;<i> setsockopt(socketFD, SOL_SOCKET, TCP_NODELAY, &amp;one, sizeof(one));
</I>&gt;<i>
</I>&gt;<i> and instead it needed to be done like this:
</I>&gt;<i>
</I>&gt;<i> setsockopt(socketFD, IPPROTO_TCP, TCP_NODELAY, &amp;one, sizeof(one));
</I>&gt;<i>
</I>&gt;<i> Yes, that's it.  Runs really fast now.  1.4294 milliseconds per round
</I>&gt;<i> trip.  It seems like it would be
</I>&gt;<i> faster than that, but it's way better than 400ms and is sufficient for our
</I>&gt;<i> purposes.  I suppose it's
</I>&gt;<i> doing program context switches  If I bump into
</I>&gt;<i> any
</I>&gt;<i>
</I>&gt;<i> Thanks for not reading the part of my post that said that I had already
</I>&gt;<i> tried this, and then posting the
</I>&gt;<i> correct version of the call.  :)    And as a bonus you don't have to be
</I>&gt;<i> root do to make the call, which
</I>&gt;<i> was also suspicious because you can do it in Java without being root.
</I>&gt;<i>
</I>&gt;<i> - Jim
</I>&gt;<i>
</I>&gt;<i> Jim Irrer     <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A>       (734) 647-4409
</I>&gt;<i>
</I>&gt;<i> University of Michigan Hospital Radiation Oncology
</I>&gt;<i> 519 W. William St.             Ann Arbor, MI 48103
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, Jun 30, 2010 at 9:53 PM, Tony Garnock-Jones &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tonyg at lshift.net</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Jim,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think it's possible that Brett is on the right track with his suggestion
</I>&gt;&gt;<i> of
</I>&gt;&gt;<i> the Nagle algorithm being responsible for the delays. You could try the
</I>&gt;&gt;<i> following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  int one = 1;
</I>&gt;&gt;<i>  setsockopt(amqp_get_sockfd(conn),
</I>&gt;&gt;<i>             IPPROTO_TCP, TCP_NODELAY, &amp;one, sizeof(one));
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i>  Tony
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jim Irrer wrote:
</I>&gt;&gt;<i> &gt; Hi All -
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I'm working on two functions that act as a client-server pair.  They
</I>&gt;&gt;<i> &gt; use two amq.direct queues to communicate.  When ever either of
</I>&gt;&gt;<i> &gt; them calls the amqp_simple_wait_frame function, it does not return
</I>&gt;&gt;<i> &gt; for 436618 microseconds.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Some other background info that might be relevant:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; If I only send messages in one direction it's really fast.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Both processes are using separate connectors and different sockets.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I used the amqp_consumer.c amqp_producer.c code in
</I>&gt;&gt;<i> &gt; the examples directory as a reference.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Is there a way to avoid this delay?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Also ...
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Could I use the same socket in each program as long as it was only
</I>&gt;&gt;<i> &gt; used by one thread at a time?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Could I use the same connection in each program if it was only
</I>&gt;&gt;<i> &gt; used by one thread at a time?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Thanks for any insights,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; - Jim
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Jim Irrer     <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A>&gt;       (734)
</I>&gt;&gt;<i> 647-4409
</I>&gt;&gt;<i> &gt; University of Michigan Hospital Radiation Oncology
</I>&gt;&gt;<i> &gt; 519 W. William St.             Ann Arbor, MI 48103
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100701/2688fe01/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100701/2688fe01/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007836.html">[rabbitmq-discuss] RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms
</A></li>
	<LI>Next message: <A HREF="007845.html">[rabbitmq-discuss] RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7837">[ date ]</a>
              <a href="thread.html#7837">[ thread ]</a>
              <a href="subject.html#7837">[ subject ]</a>
              <a href="author.html#7837">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
