<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ production setup questions around	clustering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%09clustering&In-Reply-To=%3C524136.47554.qm%40web111003.mail.gq1.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008125.html">
   <LINK REL="Next"  HREF="008128.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ production setup questions around	clustering</H1>
    <B>Dave Greggory</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%09clustering&In-Reply-To=%3C524136.47554.qm%40web111003.mail.gq1.yahoo.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ production setup questions around	clustering">davegreggory at yahoo.com
       </A><BR>
    <I>Thu Jul 22 14:20:28 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008125.html">[rabbitmq-discuss] RabbitMQ production setup questions around clustering
</A></li>
        <LI>Next message: <A HREF="008128.html">[rabbitmq-discuss] Bug21673 (aka new persister) has landed on	default
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8126">[ date ]</a>
              <a href="thread.html#8126">[ thread ]</a>
              <a href="subject.html#8126">[ subject ]</a>
              <a href="author.html#8126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks, Alex. That clears up a lot. 

Looks like I will be setting up a 2 node cluster with both nodes as disc nodes (as that's the only way to recover from a permanent failure of a disc node). I will have clients connect through the node-switcher/load-balancer with the insist flag on.

On Thu Jul 22nd, 2010 8:05 AM EDT Alexandru Scvortov wrote:

&gt;<i>
</I>&gt;<i>Hi Dave,
</I>&gt;<i>
</I>&gt;&gt;<i> Questions:
</I>&gt;&gt;<i> 2. When a queue is declared (by one of our producers), is the queue always
</I>&gt;&gt;<i> created on the rabbitmq node the producer client has a connection to or is the
</I>&gt;&gt;<i> queue created on a randomly selected node within the cluster?
</I>&gt;<i>
</I>&gt;<i>The queue is created only on that one node, but is accessible from all
</I>&gt;<i>nodes in the cluster.  All nodes in the same cluster are functionally
</I>&gt;<i>interchangeable, i.e. it doesn't matter which of the nodes you connect to,
</I>&gt;<i>you can still use the queue.
</I>&gt;<i>
</I>&gt;&gt;<i> 3. If the queue is durable and the messages sent to it are marked persistent,
</I>&gt;&gt;<i> will these messages always be persisted to disk and be available after a restart
</I>&gt;&gt;<i> of the node that has that queue, regardless of whether the node is a disk node
</I>&gt;&gt;<i> or RAM node? (This line &quot;Should you do this, and suffer           a power
</I>&gt;&gt;<i> failure to the entire cluster, the entire state of           the cluster,
</I>&gt;&gt;<i> including all messages, will be lost.         &quot; in
</I>&gt;&gt;<i> <A HREF="http://www.rabbitmq.com/clustering.html">http://www.rabbitmq.com/clustering.html</A> is confusing)
</I>&gt;<i>
</I>&gt;<i>The distinction between RAM and disk nodes refers to where the Mnesia
</I>&gt;<i>tables are stored.  The routing configuration (what queues there are,
</I>&gt;<i>which exchanges they're bound to, etc.) is stored in Mnesia, so at least one
</I>&gt;<i>of the nodes should be a disk node.  This way, if both nodes go down
</I>&gt;<i>at the same time (power failure), when they're restarted, the cluster
</I>&gt;<i>should spring back to life just like before.
</I>&gt;<i>
</I>&gt;<i>Messages are persisted to disk, regardless of whether the node is a
</I>&gt;<i>disc node or not.  Also, messages are persisted to disk only on the node
</I>&gt;<i>on which the queue was declared.  If said node is a RAM node and it goes
</I>&gt;<i>down, it won't lose the messages; when it reconnects to the cluster, the
</I>&gt;<i>queue should just get recreated (assuming it was declared as durable).
</I>&gt;<i>
</I>&gt;<i>If both nodes are RAM nodes, and they both go down, when they're
</I>&gt;<i>restarted, they won't know what queues were declared, etc.  So, in this
</I>&gt;<i>case, the messages will be lost.
</I>&gt;<i>
</I>&gt;&gt;<i> 4. Should I configure both my nodes as disk nodes or will one disk node be
</I>&gt;&gt;<i> sufficient? In other words, if only 1 disk node was there in the cluster and its
</I>&gt;&gt;<i> hard drive went bust, what can I recover from the RAM node? If nothing can be
</I>&gt;&gt;<i> recovered from the RAM node
</I>&gt;<i>
</I>&gt;<i>As mentioned above, the RAM node will not store the routing configuration to disk.
</I>&gt;<i>If the disc node goes down, you should still be able to recover the broker
</I>&gt;<i>configuration from it by adding a new disc node to the cluster.
</I>&gt;<i>
</I>&gt;<i>If any of the nodes goes down permanently (disk failure, etc.), the
</I>&gt;<i>messages stored on it will be lost.  If you don't want this to happen,
</I>&gt;<i>have a look at the HA Clustering guide:
</I>&gt;<i>
</I>&gt;<i>  <A HREF="http://www.rabbitmq.com/pacemaker.html">http://www.rabbitmq.com/pacemaker.html</A>
</I>&gt;<i>
</I>&gt;&gt;<i> is it mainly for increasing the number of
</I>&gt;&gt;<i> connections without taking any hits to disk throughput?
</I>&gt;<i>
</I>&gt;<i>Pretty much, yes.
</I>&gt;<i>
</I>&gt;&gt;<i> 5. Are connections redirects actually supported by the current version? The FAQ
</I>&gt;&gt;<i> and Clustering documents on site are contradictory of each other. (FAQ says
</I>&gt;&gt;<i> &quot;Future releases will support live failover using, for 	      instance, a
</I>&gt;&gt;<i> combination of the &quot;known hosts&quot; field in connection.open-ok and the
</I>&gt;&gt;<i> connection.redirect message.&quot;)
</I>&gt;&gt;<i> 6. If redirects are supported, when all connections are being sent to a specific
</I>&gt;&gt;<i> rabbitmq node in the cluster by the loadbalancer, will that rabbitmq node still
</I>&gt;&gt;<i> send a redirect request to the client if it's getting too taxed? If so, then is
</I>&gt;&gt;<i> it possible to limit redirects to only the disk nodes within the cluster so that
</I>&gt;&gt;<i> we don't lose any data?
</I>&gt;&gt;<i> 7. Will the connections be redirected solely based on RabbitMQ node's ability to
</I>&gt;&gt;<i> serve it or is it more round-robin?
</I>&gt;<i>
</I>&gt;<i>There is currently some loadbalancing done via AMQP's connection.redirect
</I>&gt;<i>methods.
</I>&gt;<i>
</I>&gt;<i>Both redirects and loadbalancing will soon be removed from RabbitMQ.  It
</I>&gt;<i>would probably be better if you didn't count on this feature.
</I>&gt;<i>
</I>&gt;&gt;<i> 8. Is there a way to ensure that the cluster configuration is correct because
</I>&gt;&gt;<i> 'disc/RAM' is not reported correctly by rabbitmqctl (as per
</I>&gt;&gt;<i> <A HREF="http://old.nabble.com/Rabbitmq-v.-1.8.1---Bug-report---Could-not-start-a-node-as-RAM-node-in-cluster-ts29211668.html">http://old.nabble.com/Rabbitmq-v.-1.8.1---Bug-report---Could-not-start-a-node-as-RAM-node-in-cluster-ts29211668.html</A>)?
</I>&gt;<i>
</I>&gt;<i>Not in the current release, no.  It's been fixed on the develpment branch
</I>&gt;<i>and should make it into the next release.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Hope this clears things up.
</I>&gt;<i>
</I>&gt;<i>Cheers,
</I>&gt;<i>Alex
</I>


      
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008125.html">[rabbitmq-discuss] RabbitMQ production setup questions around clustering
</A></li>
	<LI>Next message: <A HREF="008128.html">[rabbitmq-discuss] Bug21673 (aka new persister) has landed on	default
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8126">[ date ]</a>
              <a href="thread.html#8126">[ thread ]</a>
              <a href="subject.html#8126">[ subject ]</a>
              <a href="author.html#8126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
