<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] channel.flow_ok{active=false} and java client 1.8.1
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20channel.flow_ok%7Bactive%3Dfalse%7D%20and%20java%0A%20client%201.8.1&In-Reply-To=%3C4C46C605.1050104%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008089.html">
   <LINK REL="Next"  HREF="008097.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] channel.flow_ok{active=false} and java client 1.8.1</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20channel.flow_ok%7Bactive%3Dfalse%7D%20and%20java%0A%20client%201.8.1&In-Reply-To=%3C4C46C605.1050104%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] channel.flow_ok{active=false} and java client 1.8.1">simon at rabbitmq.com
       </A><BR>
    <I>Wed Jul 21 11:03:49 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008089.html">[rabbitmq-discuss] channel.flow_ok{active=false} and java client 1.8.1
</A></li>
        <LI>Next message: <A HREF="008097.html">[rabbitmq-discuss] channel.flow_ok{active=false} and java client 1.8.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8096">[ date ]</a>
              <a href="thread.html#8096">[ thread ]</a>
              <a href="subject.html#8096">[ subject ]</a>
              <a href="author.html#8096">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Odd. Those are exactly the symptoms you'd expect to see if you were 
using an old version of the Java client that doesn't support 
channel.flow; recent versions of the server will forcibly disconnect 
such misbehaving clients rather than risk running out of memory.

Umm, you are sure you're using 1.8.1? No older versions lying around on 
the classpath?

Cheers, Simon

On 21/07/10 10:24, Chester Shen wrote:
&gt;<i> Hi Simon
</I>&gt;<i>
</I>&gt;<i> Thanks for the quick reply!
</I>&gt;<i>
</I>&gt;<i> I asked the question because my client always get the exception:
</I>&gt;<i> &quot;com.rabbitmq.client.AlreadyClosedException: clean connection shutdown;
</I>&gt;<i> reason: Attempt to use closed channel&quot; when it hit the memory watermark.
</I>&gt;<i> In the log I can find this:
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:13 ===
</I>&gt;<i> vm_memory_high_watermark set. Memory used:906599728 allowed:825611059
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:13 ===
</I>&gt;<i>      alarm_handler: {set,{vm_memory_high_watermark,[]}}
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:15 ===
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:809917968 allowed:825611059
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:15 ===
</I>&gt;<i>      alarm_handler: {clear,vm_memory_high_watermark}
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:16 ===
</I>&gt;<i> vm_memory_high_watermark set. Memory used:880253288 allowed:825611059
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:16 ===
</I>&gt;<i>      alarm_handler: {set,{vm_memory_high_watermark,[]}}
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:19 ===
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:778205448 allowed:825611059
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:19 ===
</I>&gt;<i>      alarm_handler: {clear,vm_memory_high_watermark}
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:21 ===
</I>&gt;<i> vm_memory_high_watermark set. Memory used:845297232 allowed:825611059
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:21 ===
</I>&gt;<i>      alarm_handler: {set,{vm_memory_high_watermark,[]}}
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 21-Jul-2010::11:08:23 ===
</I>&gt;<i> connection&lt;0.3067.2&gt;  (running), channel 1 - error:
</I>&gt;<i> {amqp_error,precondition_failed,
</I>&gt;<i>              &quot;timeout waiting for channel.flow_ok{active=false}&quot;,none}
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:24 ===
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:131894968 allowed:825611059
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Jul-2010::11:08:24 ===
</I>&gt;<i>      alarm_handler: {clear,vm_memory_high_watermark}
</I>&gt;<i>
</I>&gt;<i> It looks like that the client failed to reply channel.flow{active=false}
</I>&gt;<i> in the first place, so after 10 seconds the channel had been terminated.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, 2010-07-21 at 09:38 +0100, Simon MacMullen wrote:
</I>&gt;&gt;<i> On 21/07/10 08:26, Chester Shen wrote:
</I>&gt;&gt;&gt;<i> In my huge memory consumption program when it hit the memory watermark
</I>&gt;&gt;&gt;<i> the client will receive a channel.flow{active=false} which I can capture
</I>&gt;&gt;&gt;<i> in FlowListener, then I need to send a channel.flow_ok{active=false} to
</I>&gt;&gt;&gt;<i> acknowledge it, but I do not know how to do it in java client 1.8.1.
</I>&gt;&gt;&gt;<i> Is there a method that I miss or it has not been implemented yet?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Chester. You shouldn't need to do that - the Java client should
</I>&gt;&gt;<i> receive the flow message, automatically respond with flow-ok, and cause
</I>&gt;&gt;<i> Channel.basicPublish to block until it sees a channel.flow{active=true}.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The FlowListener is just there in case you need to be aware that this is
</I>&gt;&gt;<i> happening; in normal use you shouldn't need to do anything.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008089.html">[rabbitmq-discuss] channel.flow_ok{active=false} and java client 1.8.1
</A></li>
	<LI>Next message: <A HREF="008097.html">[rabbitmq-discuss] channel.flow_ok{active=false} and java client 1.8.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8096">[ date ]</a>
              <a href="thread.html#8096">[ thread ]</a>
              <a href="subject.html#8096">[ subject ]</a>
              <a href="author.html#8096">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
