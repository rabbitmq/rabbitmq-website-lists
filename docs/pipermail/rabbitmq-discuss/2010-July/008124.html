<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ production setup questions around	clustering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%09clustering&In-Reply-To=%3C501396.18930.qm%40web111007.mail.gq1.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008123.html">
   <LINK REL="Next"  HREF="008125.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ production setup questions around	clustering</H1>
    <B>Dave Greggory</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%09clustering&In-Reply-To=%3C501396.18930.qm%40web111007.mail.gq1.yahoo.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ production setup questions around	clustering">davegreggory at yahoo.com
       </A><BR>
    <I>Thu Jul 22 14:01:01 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008123.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
        <LI>Next message: <A HREF="008125.html">[rabbitmq-discuss] RabbitMQ production setup questions around clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8124">[ date ]</a>
              <a href="thread.html#8124">[ thread ]</a>
              <a href="subject.html#8124">[ subject ]</a>
              <a href="author.html#8124">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I sent this message yesterday to directly to Aaron and tried to send to the list as well but sent the wrong message again... Heh. 

Off-topic: Why isn't the reply-address set to the mailing address

On Wed Jul 21st, 2010 5:44 PM EDT Dave Greggory wrote:

&gt;<i>Thanks for the reply, Aaron. I look forward to reading your blog post.
</I>&gt;<i>
</I>&gt;<i>Your postal service analogy is good one and that is how I understood it mostly. 
</I>&gt;<i>From what I understood, if a client requests a message from a queue that is not 
</I>&gt;<i>on the node he has the current connection to, because of clustering, you will 
</I>&gt;<i>get the message back indirectly. But your analogy makes it sound like the client 
</I>&gt;<i>will actually need to establish a second connection to the node that has the 
</I>&gt;<i>queue. I'm fine with that, that's not a big deal. 
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>I declare my (durable) queues from the both producer and consumer ends because 
</I>&gt;<i>exchanges would just drop the messages if we left it up to consumers and no 
</I>&gt;<i>consumers were up at the time a producer sends message. So But I'm trying to 
</I>&gt;<i>understand where a queue will be created when it's  declared (will it be in the 
</I>&gt;<i>node the client has the connection open to or  could it end up existing in 
</I>&gt;<i>another node)? 
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>I may have misused the term load-balancer in this context (just because that's 
</I>&gt;<i>what we use that piece of hardware most often). Let's just call it node-switcher 
</I>&gt;<i>for this purpose. I intended it to serve two purposes,
</I>&gt;<i>a) Hide the hostnames/ip-addresses of rabbitmq nodes from producers and clients
</I>&gt;<i>b) Serve as switch for determining which rabbitmq nodes consumers/producers 
</I>&gt;<i>connect to, so that we can:
</I>&gt;<i>     i. Switch all new consumer/producer connections  automatically to the other 
</I>&gt;<i>node if the first node goes down 
</I>&gt;<i>
</I>&gt;<i>     ii. Upgrade rabbitmq nodes without affecting producer/consumer nodes 
</I>&gt;<i>because we can switch out different rabbitmq nodes
</I>&gt;<i>
</I>&gt;<i>If rabbitmq goes down on 1 node and the node-switches switches out that node, 
</I>&gt;<i>I'm okay with queues on the downed node not being available. But would a new 
</I>&gt;<i>queue be automatically be created on the switched-in node without having to be 
</I>&gt;<i>declared? I'm hoping that because it was part of the cluster before the first 
</I>&gt;<i>node went down, it knew that a certain queue existed on the other node and since 
</I>&gt;<i>the first node is no longer available, it will take over receiving messages for 
</I>&gt;<i>that queue from producers? If that's not true, how do people handle that 
</I>&gt;<i>scenario?
</I>&gt;<i>
</I>&gt;<i>Thanks for the heads up on not using redirects.
</I>&gt;<i>
</I>&gt;<i>Dave
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>----- Original Message ----
</I>&gt;<i>From: Aaron Westendorf &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">aaron at agoragames.com</A>&gt;
</I>&gt;<i>To: Dave Greggory &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">davegreggory at yahoo.com</A>&gt;
</I>&gt;<i>Cc: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i>Sent: Wed, July 21, 2010 5:02:46 PM
</I>&gt;<i>Subject: Re: [rabbitmq-discuss] RabbitMQ production setup questions around  
</I>&gt;<i>clustering
</I>&gt;<i>
</I>&gt;<i>Dave,
</I>&gt;<i>
</I>&gt;<i>I intend to write up a blog post on our cluster setup which will
</I>&gt;<i>hopefully address some of your questions.  You're trying to set up
</I>&gt;<i>your cluster much the way we originally did, but it's not quite the
</I>&gt;<i>way Rabbit or AMQP operate.
</I>&gt;<i>
</I>&gt;<i>Think of it as the postal service, where exchanges are your
</I>&gt;<i>street-corner deposit boxes and office tellers, and the postal service
</I>&gt;<i>is the cluster itself.  Your address is your routing scheme, and that
</I>&gt;<i>routing key will deliver a message to your postal box.  The box/queue
</I>&gt;<i>is the ultimate endpoint, it lives in a discrete location, and you
</I>&gt;<i>have to go to your local post office and consume the mail out of it.
</I>&gt;<i>
</I>&gt;<i>Your load balancer will be of little use for consumers, as your
</I>&gt;<i>consumers must be connecting to the node on which your queues reside.
</I>&gt;<i>Load balancing can be used for your producers though, in cases where
</I>&gt;<i>they are easily separated.
</I>&gt;<i>
</I>&gt;<i>I've heard redirect is removed from later specifications.  Regardless,
</I>&gt;<i>I recommend turning the &quot;insist&quot; flag on and avoiding redirects
</I>&gt;<i>altogether, because they're inconsistent with the way AMQP clustering
</I>&gt;<i>works.
</I>&gt;<i>
</I>&gt;<i>I hope that gives you a good start.
</I>&gt;<i>
</I>&gt;<i>-Aaron
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>On Wed, Jul 21, 2010 at 4:43 PM, Dave Greggory &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">davegreggory at yahoo.com</A>&gt; wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We are setting up a RabbitMQ cluster as our message broker for servicing our
</I>&gt;&gt;<i> guaranteed delivery needs. We will have a local data store on our producers 
</I>&gt;<i>for
</I>&gt;&gt;<i> guaranteeing delivery, but we don't want to resort to that except as a last
</I>&gt;&gt;<i> ditch effort in cases of catastrophic failures. I would like to better
</I>&gt;&gt;<i> understand how the cluster setup in RabbitMQ works.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Our setup:
</I>&gt;&gt;<i> 2 rabbitmq nodes clustered together sitting behind a hardware load balancer.
</I>&gt;&gt;<i> Upon initial release, our message volume will not be that high, but it will 
</I>&gt;&gt;<i>grow
</I>&gt;&gt;<i> real fast once we offload more work to the message broker from our current
</I>&gt;&gt;<i> non-messaging based infrastructure. Since the initial volume is not very high,
</I>&gt;&gt;<i> we do not intend to use the load balancer for actual load balancing but to
</I>&gt;&gt;<i> always send connections to a specific rabbitmq node in the cluster. If 
</I>&gt;<i>RabbitMQ
</I>&gt;&gt;<i> does not respond or the port is not open, it will automatically switch to the
</I>&gt;&gt;<i> second node for new connections.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Questions:
</I>&gt;&gt;<i> 1. Are there any case studies for setting up clustering in RabbitMQ?
</I>&gt;&gt;<i> 2. When a queue is declared (by one of our producers), is the queue always
</I>&gt;&gt;<i> created on the rabbitmq node the producer client has a connection to or is the
</I>&gt;&gt;<i> queue created on a randomly selected node within the cluster?
</I>&gt;&gt;<i> 3. If the queue is durable and the messages sent to it are marked persistent,
</I>&gt;&gt;<i> will these messages always be persisted to disk and be available after a 
</I>&gt;&gt;<i>restart
</I>&gt;&gt;<i> of the node that has that queue, regardless of whether the node is a disk node
</I>&gt;&gt;<i> or RAM node? (This line &quot;Should you do this, and suffer           a power
</I>&gt;&gt;<i> failure to the entire cluster, the entire state of           the cluster,
</I>&gt;&gt;<i> including all messages, will be lost.         &quot; in
</I>&gt;&gt;<i> <A HREF="http://www.rabbitmq.com/clustering.html">http://www.rabbitmq.com/clustering.html</A> is confusing)
</I>&gt;&gt;<i> 4. Should I configure both my nodes as disk nodes or will one disk node be
</I>&gt;&gt;<i> sufficient? In other words, if only 1 disk node was there in the cluster and 
</I>&gt;&gt;<i>its
</I>&gt;&gt;<i> hard drive went bust, what can I recover from the RAM node? If nothing can be
</I>&gt;&gt;<i> recovered from the RAM node, is it mainly for increasing the number of
</I>&gt;&gt;<i> connections without taking any hits to disk throughput?
</I>&gt;&gt;<i> 5. Are connections redirects actually supported by the current version? The 
</I>&gt;<i>FAQ
</I>&gt;&gt;<i> and Clustering documents on site are contradictory of each other. (FAQ says
</I>&gt;&gt;<i> &quot;Future releases will support live failover using, for        instance, a
</I>&gt;&gt;<i> combination of the &quot;known hosts&quot; field in connection.open-ok and the
</I>&gt;&gt;<i> connection.redirect message.&quot;)
</I>&gt;&gt;<i> 6. If redirects are supported, when all connections are being sent to a 
</I>&gt;&gt;<i>specific
</I>&gt;&gt;<i> rabbitmq node in the cluster by the loadbalancer, will that rabbitmq node 
</I>&gt;<i>still
</I>&gt;&gt;<i> send a redirect request to the client if it's getting too taxed? If so, then 
</I>&gt;<i>is
</I>&gt;&gt;<i> it possible to limit redirects to only the disk nodes within the cluster so 
</I>&gt;&gt;<i>that
</I>&gt;&gt;<i> we don't lose any data?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 7. Will the connections be redirected solely based on RabbitMQ node's ability 
</I>&gt;&gt;<i>to
</I>&gt;&gt;<i> serve it or is it more round-robin?
</I>&gt;&gt;<i> 8. Is there a way to ensure that the cluster configuration is correct because
</I>&gt;&gt;<i> 'disc/RAM' is not reported correctly by rabbitmqctl (as per
</I>&gt;&gt;<i><A HREF="http://old.nabble.com/Rabbitmq-v.-1.8.1---Bug-report---Could-not-start-a-node-as-RAM-node-in-cluster-ts29211668.html">http://old.nabble.com/Rabbitmq-v.-1.8.1---Bug-report---Could-not-start-a-node-as-RAM-node-in-cluster-ts29211668.html</A>)?
</I>&gt;&gt;<i>?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks so much,
</I>&gt;&gt;<i> Dave
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>-- 
</I>&gt;<i>Aaron Westendorf
</I>&gt;<i>Senior Software Engineer
</I>&gt;<i>Agora Games
</I>&gt;<i>359 Broadway
</I>&gt;<i>Troy, NY 12180
</I>&gt;<i>Phone: 518.268.1000
</I>&gt;<i><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">aaron at agoragames.com</A>
</I>&gt;<i>www.agoragames.com
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>      
</I>


      
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008123.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
	<LI>Next message: <A HREF="008125.html">[rabbitmq-discuss] RabbitMQ production setup questions around clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8124">[ date ]</a>
              <a href="thread.html#8124">[ thread ]</a>
              <a href="subject.html#8124">[ subject ]</a>
              <a href="author.html#8124">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
