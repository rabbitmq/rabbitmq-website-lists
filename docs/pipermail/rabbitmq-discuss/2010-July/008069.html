<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumers stopped consuming messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumers%20stopped%20consuming%20messages&In-Reply-To=%3C777676.82785.qm%40web26002.mail.ukl.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008184.html">
   <LINK REL="Next"  HREF="008076.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumers stopped consuming messages</H1>
    <B>Florence Chabanois</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumers%20stopped%20consuming%20messages&In-Reply-To=%3C777676.82785.qm%40web26002.mail.ukl.yahoo.com%3E"
       TITLE="[rabbitmq-discuss] Consumers stopped consuming messages">flocha2000-agile at yahoo.fr
       </A><BR>
    <I>Tue Jul 20 11:38:51 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008184.html">[rabbitmq-discuss] Disaster Recovery / Disaster tolerance	Features
</A></li>
        <LI>Next message: <A HREF="008076.html">[rabbitmq-discuss] Consumers stopped consuming messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8069">[ date ]</a>
              <a href="thread.html#8069">[ thread ]</a>
              <a href="subject.html#8069">[ subject ]</a>
              <a href="author.html#8069">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Simon (sorry for answering twice),

Thanks for your reply. We didn't find how to configure 
the basic.qos in the java API. Here is our spike code :

&#160;&#160;&#160; 
private void consommeEvenements() throws IOException {
&#160;&#160;&#160; &#160;&#160;&#160; 
Channel channel = acteurRabbitMQ.chaines.get(QUEUE_PRINCIPALE);
&#160;&#160;&#160; 
&#160;&#160;&#160; QueueingConsumer consumer = new QueueingConsumer(channel);
&#160;&#160;&#160; 
&#160;&#160;&#160; channel.basicConsume(QUEUE_PRINCIPALE.name(), consumer);
&#160;&#160;&#160; &#160;&#160;&#160; 
while (channel.isOpen()) {
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; QueueingConsumer.Delivery 
evenementBrut = null;
&#160;&#160;&#160; &#160;&#160;&#160;&#160;&#160;&#160;&#160; EvenementStat evenementRecu = null;
&#160;&#160;&#160;
 &#160;&#160;&#160; &#160;&#160;&#160; try
 {
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; evenementBrut = consumer.nextDelivery();
&#160;&#160;&#160; 
&#160;&#160;&#160; &#160;&#160;&#160;&#160;&#160;&#160;&#160; evenementRecu = decode(evenementBrut);
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160;&#160;&#160;&#160;&#160; 
logger.info(&quot;evenement recu : &quot; + evenementRecu);
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160;&#160;&#160;&#160;&#160; 
simuleErreurBaseDeDonnees(evenementRecu);
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; } catch 
(IOException e) {
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; logger.fatal(&quot;Soucis de 
deserialize&quot;, e);
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; } catch (Exception e) {
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; 
&#160;&#160;&#160; logger.error(&quot;Soucis d'&#233;criture en base&quot;, e);
&#160;&#160;&#160; &#160;&#160;&#160;
 &#160;&#160;&#160; &#160;&#160;&#160; if (evenementRecu.estReinjectable()) {
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; 
logger.info(&quot;--&gt; renvoi de &quot; + evenementRecu);
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160;
 programmeRepublication(evenementRecu);
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; } else {
&#160;&#160;&#160;
 &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; logger.info(&quot;--&gt; DEAD LETTER &quot; + evenementRecu);
&#160;&#160;&#160;
 &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; acteurRabbitMQ.publie(evenementRecu, 
QUEUE_DEAD_LETTER);
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; }
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; }
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160;
 boolean
 ackMultiple = false;
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; final long deliveryTag = 
evenementBrut.getEnvelope().getDeliveryTag();
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; 
logger.info(&quot;ACK &quot; + deliveryTag);
&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; 
channel.basicAck(deliveryTag, ackMultiple);
&#160;&#160;&#160; &#160;&#160;&#160; }
&#160;&#160;&#160; &#160;&#160;&#160; 
acteurRabbitMQ.ferme();
&#160;&#160;&#160; }

Yet, I'm not sure the basic.qos 
is the issue as long as the 6 consumers sometimes keep consuming the 
messages during the 10 minutes bench, and sometimes not. 

When 
the problem occurs, the list_queues option displays that the queue 
starts growing because the &quot;active&quot; (the ones that keep on consuming) 
consumers cannot insert in DB the overall messages load fast enough.

Cheers,
 
Florence.


--- En date de&#160;: Mar 20.7.10, Florence Chabanois &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">flocha2000-agile at yahoo.fr</A>&gt; a &#233;crit&#160;:


De: Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;
Objet: Re: [rabbitmq-discuss] Consumers stopped consuming messages
&#192;: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Date: Mardi 20 juillet 2010, 11h26

On 20/07/10 09:55, Florence Chabanois wrote:
&lt;snip&gt;
&gt;<i> We noticed that /*sometimes*/, consumers hang (well, they are not
</I>&gt;<i> blocked, but they dont consume messages anymore). We can see that
</I>&gt;<i> because each consumer save around 100 msg/sec in database, so when one
</I>&gt;<i> is stopping consumming, the overall messages saved per seconds in DB
</I>&gt;<i> fall down with the same ratio (if let say 3 consumers stop, we fall
</I>&gt;<i> around 600 msg/sec to 300 msg/sec).
</I>&lt;snip&gt;
&gt;<i> FYI there has been a similar issue here, but it wasn't resolved
</I> :
&gt;<i> <A HREF="http://old.nabble.com/Consumer-stop-to-receive-messages-but-continue-listening-queue-problem.-td27872888.html">http://old.nabble.com/Consumer-stop-to-receive-messages-but-continue-listening-queue-problem.-td27872888.html</A>
</I>
Hi Florence. One possibility that was considered in the linked thread was that all the messages were being sent to some consumers due to basic.qos not being set (in the absence of basic.qos, Rabbit is allowed to do that).

So:

* Are you setting the basic.qos prefetch count?
* What does rabbitmqctl lists_queues say about he queue when the system is in this state?
* Are you able to post your spike code anywhere?

Cheers, Simon

-- Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>






      


      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100720/59dbb7b0/attachment-0001.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100720/59dbb7b0/attachment-0001.htm</A>&gt;
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008184.html">[rabbitmq-discuss] Disaster Recovery / Disaster tolerance	Features
</A></li>
	<LI>Next message: <A HREF="008076.html">[rabbitmq-discuss] Consumers stopped consuming messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8069">[ date ]</a>
              <a href="thread.html#8069">[ thread ]</a>
              <a href="subject.html#8069">[ subject ]</a>
              <a href="author.html#8069">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
