<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ production setup questions around clustering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%20clustering&In-Reply-To=%3Calpine.LNX.2.00.1007221224360.2650%40dakota%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008108.html">
   <LINK REL="Next"  HREF="008122.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ production setup questions around clustering</H1>
    <B>Alexandru Scvortov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%20clustering&In-Reply-To=%3Calpine.LNX.2.00.1007221224360.2650%40dakota%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ production setup questions around clustering">alexandru at rabbitmq.com
       </A><BR>
    <I>Thu Jul 22 13:05:34 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008108.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
        <LI>Next message: <A HREF="008122.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8120">[ date ]</a>
              <a href="thread.html#8120">[ thread ]</a>
              <a href="subject.html#8120">[ subject ]</a>
              <a href="author.html#8120">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Dave,

&gt;<i> Questions:
</I>&gt;<i> 2. When a queue is declared (by one of our producers), is the queue always
</I>&gt;<i> created on the rabbitmq node the producer client has a connection to or is the
</I>&gt;<i> queue created on a randomly selected node within the cluster?
</I>
The queue is created only on that one node, but is accessible from all
nodes in the cluster.  All nodes in the same cluster are functionally
interchangeable, i.e. it doesn't matter which of the nodes you connect to,
you can still use the queue.

&gt;<i> 3. If the queue is durable and the messages sent to it are marked persistent,
</I>&gt;<i> will these messages always be persisted to disk and be available after a restart
</I>&gt;<i> of the node that has that queue, regardless of whether the node is a disk node
</I>&gt;<i> or RAM node? (This line &quot;Should you do this, and suffer           a power
</I>&gt;<i> failure to the entire cluster, the entire state of           the cluster,
</I>&gt;<i> including all messages, will be lost.         &quot; in
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/clustering.html">http://www.rabbitmq.com/clustering.html</A> is confusing)
</I>
The distinction between RAM and disk nodes refers to where the Mnesia
tables are stored.  The routing configuration (what queues there are,
which exchanges they're bound to, etc.) is stored in Mnesia, so at least one
of the nodes should be a disk node.  This way, if both nodes go down
at the same time (power failure), when they're restarted, the cluster
should spring back to life just like before.

Messages are persisted to disk, regardless of whether the node is a
disc node or not.  Also, messages are persisted to disk only on the node
on which the queue was declared.  If said node is a RAM node and it goes
down, it won't lose the messages; when it reconnects to the cluster, the
queue should just get recreated (assuming it was declared as durable).

If both nodes are RAM nodes, and they both go down, when they're
restarted, they won't know what queues were declared, etc.  So, in this
case, the messages will be lost.

&gt;<i> 4. Should I configure both my nodes as disk nodes or will one disk node be
</I>&gt;<i> sufficient? In other words, if only 1 disk node was there in the cluster and its
</I>&gt;<i> hard drive went bust, what can I recover from the RAM node? If nothing can be
</I>&gt;<i> recovered from the RAM node
</I>
As mentioned above, the RAM node will not store the routing configuration to disk.
If the disc node goes down, you should still be able to recover the broker
configuration from it by adding a new disc node to the cluster.

If any of the nodes goes down permanently (disk failure, etc.), the
messages stored on it will be lost.  If you don't want this to happen,
have a look at the HA Clustering guide:

  <A HREF="http://www.rabbitmq.com/pacemaker.html">http://www.rabbitmq.com/pacemaker.html</A>

&gt;<i> is it mainly for increasing the number of
</I>&gt;<i> connections without taking any hits to disk throughput?
</I>
Pretty much, yes.

&gt;<i> 5. Are connections redirects actually supported by the current version? The FAQ
</I>&gt;<i> and Clustering documents on site are contradictory of each other. (FAQ says
</I>&gt;<i> &quot;Future releases will support live failover using, for 	      instance, a
</I>&gt;<i> combination of the &quot;known hosts&quot; field in connection.open-ok and the
</I>&gt;<i> connection.redirect message.&quot;)
</I>&gt;<i> 6. If redirects are supported, when all connections are being sent to a specific
</I>&gt;<i> rabbitmq node in the cluster by the loadbalancer, will that rabbitmq node still
</I>&gt;<i> send a redirect request to the client if it's getting too taxed? If so, then is
</I>&gt;<i> it possible to limit redirects to only the disk nodes within the cluster so that
</I>&gt;<i> we don't lose any data?
</I>&gt;<i> 7. Will the connections be redirected solely based on RabbitMQ node's ability to
</I>&gt;<i> serve it or is it more round-robin?
</I>
There is currently some loadbalancing done via AMQP's connection.redirect
methods.

Both redirects and loadbalancing will soon be removed from RabbitMQ.  It
would probably be better if you didn't count on this feature.

&gt;<i> 8. Is there a way to ensure that the cluster configuration is correct because
</I>&gt;<i> 'disc/RAM' is not reported correctly by rabbitmqctl (as per
</I>&gt;<i> <A HREF="http://old.nabble.com/Rabbitmq-v.-1.8.1---Bug-report---Could-not-start-a-node-as-RAM-node-in-cluster-ts29211668.html">http://old.nabble.com/Rabbitmq-v.-1.8.1---Bug-report---Could-not-start-a-node-as-RAM-node-in-cluster-ts29211668.html</A>)?
</I>
Not in the current release, no.  It's been fixed on the develpment branch
and should make it into the next release.


Hope this clears things up.

Cheers,
Alex
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008108.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
	<LI>Next message: <A HREF="008122.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8120">[ date ]</a>
              <a href="thread.html#8120">[ thread ]</a>
              <a href="subject.html#8120">[ subject ]</a>
              <a href="author.html#8120">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
