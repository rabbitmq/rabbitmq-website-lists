<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ production setup questions around clustering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%20clustering&In-Reply-To=%3C20100726150944.GB6839%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008122.html">
   <LINK REL="Next"  HREF="008110.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ production setup questions around clustering</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20production%20setup%20questions%20around%0A%20clustering&In-Reply-To=%3C20100726150944.GB6839%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ production setup questions around clustering">matthew at rabbitmq.com
       </A><BR>
    <I>Mon Jul 26 16:09:44 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008122.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
        <LI>Next message: <A HREF="008110.html">[rabbitmq-discuss] RabbitMq and clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8179">[ date ]</a>
              <a href="thread.html#8179">[ thread ]</a>
              <a href="subject.html#8179">[ subject ]</a>
              <a href="author.html#8179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Aaron,

On Thu, Jul 22, 2010 at 08:33:48AM -0400, Aaron Westendorf wrote:
&gt;<i> So I can
</I>&gt;<i> connect to any host in the cluster, call basic.consume(), and receive
</I>&gt;<i> messages from a queue that resides on another host?
</I>
Correct. However, the messages are only stored on the node on which the
queue was created, thus latency will be higher due to the extra hop than
connecting to the queue-local node.

&gt;<i> What about the
</I>&gt;<i> case where multiple clients start at the same time and they each
</I>&gt;<i> declare the queue and its bindings (identically)?
</I>
By using distributed transactions in mnesia, we detect this case. Also,
queue declaration is idempotent, so the &quot;winner&quot; of the race will indeed
create a new queue. The &quot;loser&quot; of the race will return the queue that
was created by the winner.

&gt;<i> I swear that we
</I>&gt;<i> tried this exact setup, maybe in the 1.5 series, and we kept getting
</I>&gt;<i> dropped messages.  This has a big effect on how one can go about
</I>&gt;<i> clustering and failover, and matches our original plan for a generic
</I>&gt;<i> pool of rabbit hosts.
</I>
There were some bugs back then, especially with regards to what happens
when a queue is declared that was previously declared on a now-failed
node. That used to be permitted and caused all sorts of problems when
the failed node came back up (if not before). That case is not expressly
forbidden and will result in a 404 (literally - the node on which this
queue has been created cannot be found).

With regards to fail over, it should be noted that clustering is not a
means for HA because of the fact that when a node goes down it takes its
queues with it, and those queues can't be recovered before the node
comes back up.

&gt;<i> We have very wide pipes between our hosts, but there's still overhead
</I>&gt;<i> in handling inter-node traffic.  Is there an optimal setup, such as
</I>&gt;<i> all consumers of a queue connected to the host on which it resides?
</I>
Yes. Within a cluster, there is no batching of deliveries at least
nothing we're doing explicitly. I don't think the VM does anything magic
underneath but I could be wrong. Thus you may wish to try to ensure that
clients are directly connected to the correct nodes for their queues.

On the publishing side, we do do explicit batching so if you are
publishing a message which ends up going to several queues all on some
other node, then that will only be sent as one message to the other node
rather than N messages.

Matthew
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008122.html">[rabbitmq-discuss] RabbitMQ production setup questions around	clustering
</A></li>
	<LI>Next message: <A HREF="008110.html">[rabbitmq-discuss] RabbitMq and clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8179">[ date ]</a>
              <a href="thread.html#8179">[ thread ]</a>
              <a href="subject.html#8179">[ subject ]</a>
              <a href="author.html#8179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
