<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Bring cluster up after node crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bring%20cluster%20up%20after%20node%20crash&In-Reply-To=%3CA674608A754C4DDB8CCD0643F9A192C2%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026043.html">
   <LINK REL="Next"  HREF="026085.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Bring cluster up after node crash</H1>
    <B>Carl H&#246;rberg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bring%20cluster%20up%20after%20node%20crash&In-Reply-To=%3CA674608A754C4DDB8CCD0643F9A192C2%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Bring cluster up after node crash">carl.hoerberg at gmail.com
       </A><BR>
    <I>Tue Mar 19 03:41:21 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026043.html">[rabbitmq-discuss] Upgrade Java Driver 2.8.7 to 3.0.4 required?
</A></li>
        <LI>Next message: <A HREF="026085.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26002">[ date ]</a>
              <a href="thread.html#26002">[ thread ]</a>
              <a href="subject.html#26002">[ subject ]</a>
              <a href="author.html#26002">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Have a 3 node cluster, node 2 and 3 went down due to OOM, but node 1 survived, clients could push new messages but non were delivered, node 1 had plenty of memory left so no blocking were (or at least shouldn't have been) in action due to that.  

I then tried to bring node 2 and 3 back online by simply restarting them, this is what happened:  

Node1 floods the logs for a while at a rate of 20-100/sec:
=ERROR REPORT==== 18-Mar-2013::07:10:40 ===
Discarding message {'$gen_call',{&lt;0.17965.1&gt;,#Ref&lt;0.0.1.90282&gt;},stat} from &lt;0.17965.1&gt; to &lt;0.5037.1&gt; in an old incarnation (1) of this node (2)

Start up node 3
Floods
=ERROR REPORT==== 18-Mar-2013::08:23:15 ===
Discarding message {'$gen_call',{&lt;0.7609.0&gt;,#Ref&lt;0.0.1.142489&gt;},stat} from &lt;0.7609.0&gt; to &lt;0.25515.26&gt; in an old incarnation (1) of this node (3)
and is stuck at  
&quot;starting exchange, queue and binding recovery ...&quot;

rabbitmqctl status hangs for ever on node 1

Start up node 2, starts fast, says &quot;Broker started&quot; in startup_log, but doesn't list the plugins, &quot;service rabbitmq-server start&quot; never returns and  rabbitmqctl status and  never returns

node 2 then runs out of memory again, without client connections this time:  
=INFO REPORT==== 18-Mar-2013::09:09:35 ===
vm_memory_high_watermark set. Memory used:7336394640 allowed:7031336140
=WARNING REPORT==== 18-Mar-2013::09:09:35 ===
memory resource limit alarm set on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at tiger02</A>

Querying /api/overview at node1 gives:
{error,{error,{badmatch,false},
[{rabbit_mgmt_wm_overview,version,1},
{rabbit_mgmt_wm_overview,to_json,2},
{webmachine_resource,resource_call,3},
{webmachine_resource,do,3},
{webmachine_decision_core,resource_call,1},
{webmachine_decision_core,decision,1},
{webmachine_decision_core,handle_request,2},
{rabbit_webmachine,'-makeloop/1-fun-0-',2}]}}

node 3 starts eventually.  
kills node 2, starts again, stops at &quot;starting database &#8230;&quot;
nothing in the log or startup_err, cpu usage 0%
kills after 30min and starts again, same thing.  

node 3 can now output rabbitmqctl status, node 1 still cannot.
node 1 can't be shutdown, force kills
with node1 down, node 2 now comes pass &quot;starting database&quot; and starts
neither node 2 or node 3 responds to rabbitmqctl status
shutting down node 2, but doesn't respond, have to do kill -9
node 3 still doesn't respond to rabbitmqctl status
shutdowns node 3, doesnt respond, killing it instead, now all nodes are down.

note: When rabbitmqctl status doesnt work other stuff like list_users, cluster_status etc. works.  

Starting up node3, log now gets flooded with:
=ERROR REPORT==== 18-Mar-2013::11:09:04 ===
** Generic server &lt;0.629.0&gt; terminating
** Last message in was {init,&lt;0.182.0&gt;}
** When Server state == {q,{amqqueue,
{resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
&lt;&lt;&quot;tmp_topic-0.9934227485209703&quot;&gt;&gt;},
true,true,&lt;0.21310.24&gt;,[],&lt;0.629.0&gt;,[],[],
[{vhost,&lt;&lt;&quot;vhost1&quot;&gt;&gt;},
{name,&lt;&lt;&quot;HA&quot;&gt;&gt;},
{pattern,&lt;&lt;&quot;.*&quot;&gt;&gt;},
{definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
{priority,0}],
[{&lt;6868.7071.0&gt;,&lt;6868.7070.0&gt;},
{&lt;6867.19845.80&gt;,&lt;6867.19844.80&gt;},
{&lt;0.21601.24&gt;,&lt;0.21548.24&gt;}]},
none,false,undefined,undefined,
{[],[]},
undefined,undefined,undefined,undefined,
{state,fine,5000,undefined},
{0,nil},
undefined,undefined,undefined,
{dict,0,16,16,8,80,48,
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]},
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]}}},
1,
{{0,nil},{0,nil}},
undefined,
{dict,0,16,16,8,80,48,
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]},
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]}}},
undefined,undefined}
** Reason for termination ==  
** {'module could not be loaded',
[{undefined,init,
[{amqqueue,
{resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
&lt;&lt;&quot;tmp_topic-0.9934227485209703&quot;&gt;&gt;},
true,true,&lt;0.21310.24&gt;,[],&lt;0.629.0&gt;,[],[],
[{vhost,&lt;&lt;&quot;vhost1&quot;&gt;&gt;},
{name,&lt;&lt;&quot;HA&quot;&gt;&gt;},
{pattern,&lt;&lt;&quot;.*&quot;&gt;&gt;},
{definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
{priority,0}],
[{&lt;6868.7071.0&gt;,&lt;6868.7070.0&gt;},
{&lt;6867.19845.80&gt;,&lt;6867.19844.80&gt;},
{&lt;0.21601.24&gt;,&lt;0.21548.24&gt;}]},
true,#Fun&lt;rabbit_amqqueue_process.5.64830354&gt;]},
{rabbit_amqqueue_process,handle_call,3},
{gen_server2,handle_msg,2},
{proc_lib,wake_up,3}]}

but comes online eventually and can do &quot;rabbitmqctl status&quot;

starts up node2, also reports a lot of:
=ERROR REPORT==== 18-Mar-2013::11:11:06 ===
** Generic server &lt;0.640.0&gt; terminating
** Last message in was {init,&lt;0.152.0&gt;}
** When Server state == {q,{amqqueue,
{resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
&lt;&lt;&quot;tmp_topic-0.1019297200255096&quot;&gt;&gt;},
true,true,&lt;0.977.11&gt;,[],&lt;0.640.0&gt;,[],[],
undefined,[]},
none,false,undefined,undefined,
{[],[]},
undefined,undefined,undefined,undefined,
{state,fine,5000,undefined},
{0,nil},
undefined,undefined,undefined,
{dict,0,16,16,8,80,48,
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]},
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]}}},
1,
{{0,nil},{0,nil}},
undefined,
{dict,0,16,16,8,80,48,
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]},
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]}}},
undefined,undefined}
** Reason for termination ==  
** {'module could not be loaded',
[{undefined,init,
[{amqqueue,
{resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
&lt;&lt;&quot;tmp_topic-0.1019297200255096&quot;&gt;&gt;},
true,true,&lt;0.977.11&gt;,[],&lt;0.640.0&gt;,[],[],undefined,[]},
true,#Fun&lt;rabbit_amqqueue_process.5.64830354&gt;]},
{rabbit_amqqueue_process,handle_call,3},
{gen_server2,handle_msg,2},
{proc_lib,wake_up,3}]}
=ERROR REPORT==== 18-Mar-2013::11:11:06 ===
** Generic server &lt;0.645.0&gt; terminating
** Last message in was {init,&lt;0.152.0&gt;}
** When Server state == {q,{amqqueue,
{resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
&lt;&lt;&quot;tmp_topic-0.8794151877518743&quot;&gt;&gt;},
true,true,&lt;0.30538.0&gt;,[],&lt;0.645.0&gt;,[],[],
[{vhost,&lt;&lt;&quot;vhost1&quot;&gt;&gt;},
{name,&lt;&lt;&quot;HA&quot;&gt;&gt;},
{pattern,&lt;&lt;&quot;.*&quot;&gt;&gt;},
{definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
{priority,0}],
[{&lt;6872.28270.5&gt;,&lt;6872.28269.5&gt;},
{&lt;0.32304.1&gt;,&lt;0.30804.0&gt;}]},
none,false,undefined,undefined,
{[],[]},
undefined,undefined,undefined,undefined,
{state,fine,5000,undefined},
{0,nil},
undefined,undefined,undefined,
{dict,0,16,16,8,80,48,
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]},
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]}}},
1,
{{0,nil},{0,nil}},
undefined,
{dict,0,16,16,8,80,48,
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]},
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[]}}},
undefined,undefined}
** Reason for termination ==  
** {'module could not be loaded',
[{undefined,init,
[{amqqueue,
{resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
&lt;&lt;&quot;tmp_topic-0.8794151877518743&quot;&gt;&gt;},
true,true,&lt;0.30538.0&gt;,[],&lt;0.645.0&gt;,[],[],
[{vhost,&lt;&lt;&quot;vhost1&quot;&gt;&gt;},
{name,&lt;&lt;&quot;HA&quot;&gt;&gt;},
{pattern,&lt;&lt;&quot;.*&quot;&gt;&gt;},
{definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
{priority,0}],
[{&lt;6872.28270.5&gt;,&lt;6872.28269.5&gt;},{&lt;0.32304.1&gt;,&lt;0.30804.0&gt;}]},
true,#Fun&lt;rabbit_amqqueue_process.5.64830354&gt;]},
{rabbit_amqqueue_process,handle_call,3},
{gen_server2,handle_msg,2},
{proc_lib,wake_up,3}]}

node 2 comes online i can now query rabbitmqctl status
starting up node 1, comes online
the cluster is now working again but several durables queues are gone(!)




</PRE>









































































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026043.html">[rabbitmq-discuss] Upgrade Java Driver 2.8.7 to 3.0.4 required?
</A></li>
	<LI>Next message: <A HREF="026085.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26002">[ date ]</a>
              <a href="thread.html#26002">[ thread ]</a>
              <a href="subject.html#26002">[ subject ]</a>
              <a href="author.html#26002">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
