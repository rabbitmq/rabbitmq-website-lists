<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Bring cluster up after node crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bring%20cluster%20up%20after%20node%20crash&In-Reply-To=%3C59E427F8-BE70-429B-873F-C6CE2632DCA4%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026002.html">
   <LINK REL="Next"  HREF="026090.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Bring cluster up after node crash</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bring%20cluster%20up%20after%20node%20crash&In-Reply-To=%3C59E427F8-BE70-429B-873F-C6CE2632DCA4%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Bring cluster up after node crash">tim at rabbitmq.com
       </A><BR>
    <I>Wed Mar 20 16:25:58 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026002.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
        <LI>Next message: <A HREF="026090.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26085">[ date ]</a>
              <a href="thread.html#26085">[ thread ]</a>
              <a href="subject.html#26085">[ subject ]</a>
              <a href="author.html#26085">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Carl,

What version of rabbit are you running? A number of bugs pertaining to the 'Discarding message ... in an old incarnation .. of this node' were fixed in recent(ish) releases.

Cheers,
Tim 

On 19 Mar 2013, at 03:41, Carl H&#246;rberg wrote:

&gt;<i> Have a 3 node cluster, node 2 and 3 went down due to OOM, but node 1 survived, clients could push new messages but non were delivered, node 1 had plenty of memory left so no blocking were (or at least shouldn't have been) in action due to that.  
</I>&gt;<i> 
</I>&gt;<i> I then tried to bring node 2 and 3 back online by simply restarting them, this is what happened:  
</I>&gt;<i> 
</I>&gt;<i> Node1 floods the logs for a while at a rate of 20-100/sec:
</I>&gt;<i> =ERROR REPORT==== 18-Mar-2013::07:10:40 ===
</I>&gt;<i> Discarding message {'$gen_call',{&lt;0.17965.1&gt;,#Ref&lt;0.0.1.90282&gt;},stat} from &lt;0.17965.1&gt; to &lt;0.5037.1&gt; in an old incarnation (1) of this node (2)
</I>&gt;<i> 
</I>&gt;<i> Start up node 3
</I>&gt;<i> Floods
</I>&gt;<i> =ERROR REPORT==== 18-Mar-2013::08:23:15 ===
</I>&gt;<i> Discarding message {'$gen_call',{&lt;0.7609.0&gt;,#Ref&lt;0.0.1.142489&gt;},stat} from &lt;0.7609.0&gt; to &lt;0.25515.26&gt; in an old incarnation (1) of this node (3)
</I>&gt;<i> and is stuck at  
</I>&gt;<i> &quot;starting exchange, queue and binding recovery ...&quot;
</I>&gt;<i> 
</I>&gt;<i> rabbitmqctl status hangs for ever on node 1
</I>&gt;<i> 
</I>&gt;<i> Start up node 2, starts fast, says &quot;Broker started&quot; in startup_log, but doesn't list the plugins, &quot;service rabbitmq-server start&quot; never returns and  rabbitmqctl status and  never returns
</I>&gt;<i> 
</I>&gt;<i> node 2 then runs out of memory again, without client connections this time:  
</I>&gt;<i> =INFO REPORT==== 18-Mar-2013::09:09:35 ===
</I>&gt;<i> vm_memory_high_watermark set. Memory used:7336394640 allowed:7031336140
</I>&gt;<i> =WARNING REPORT==== 18-Mar-2013::09:09:35 ===
</I>&gt;<i> memory resource limit alarm set on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at tiger02</A>
</I>&gt;<i> 
</I>&gt;<i> Querying /api/overview at node1 gives:
</I>&gt;<i> {error,{error,{badmatch,false},
</I>&gt;<i> [{rabbit_mgmt_wm_overview,version,1},
</I>&gt;<i> {rabbit_mgmt_wm_overview,to_json,2},
</I>&gt;<i> {webmachine_resource,resource_call,3},
</I>&gt;<i> {webmachine_resource,do,3},
</I>&gt;<i> {webmachine_decision_core,resource_call,1},
</I>&gt;<i> {webmachine_decision_core,decision,1},
</I>&gt;<i> {webmachine_decision_core,handle_request,2},
</I>&gt;<i> {rabbit_webmachine,'-makeloop/1-fun-0-',2}]}}
</I>&gt;<i> 
</I>&gt;<i> node 3 starts eventually.  
</I>&gt;<i> kills node 2, starts again, stops at &quot;starting database &#8230;&quot;
</I>&gt;<i> nothing in the log or startup_err, cpu usage 0%
</I>&gt;<i> kills after 30min and starts again, same thing.  
</I>&gt;<i> 
</I>&gt;<i> node 3 can now output rabbitmqctl status, node 1 still cannot.
</I>&gt;<i> node 1 can't be shutdown, force kills
</I>&gt;<i> with node1 down, node 2 now comes pass &quot;starting database&quot; and starts
</I>&gt;<i> neither node 2 or node 3 responds to rabbitmqctl status
</I>&gt;<i> shutting down node 2, but doesn't respond, have to do kill -9
</I>&gt;<i> node 3 still doesn't respond to rabbitmqctl status
</I>&gt;<i> shutdowns node 3, doesnt respond, killing it instead, now all nodes are down.
</I>&gt;<i> 
</I>&gt;<i> note: When rabbitmqctl status doesnt work other stuff like list_users, cluster_status etc. works.  
</I>&gt;<i> 
</I>&gt;<i> Starting up node3, log now gets flooded with:
</I>&gt;<i> =ERROR REPORT==== 18-Mar-2013::11:09:04 ===
</I>&gt;<i> ** Generic server &lt;0.629.0&gt; terminating
</I>&gt;<i> ** Last message in was {init,&lt;0.182.0&gt;}
</I>&gt;<i> ** When Server state == {q,{amqqueue,
</I>&gt;<i> {resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
</I>&gt;<i> &lt;&lt;&quot;tmp_topic-0.9934227485209703&quot;&gt;&gt;},
</I>&gt;<i> true,true,&lt;0.21310.24&gt;,[],&lt;0.629.0&gt;,[],[],
</I>&gt;<i> [{vhost,&lt;&lt;&quot;vhost1&quot;&gt;&gt;},
</I>&gt;<i> {name,&lt;&lt;&quot;HA&quot;&gt;&gt;},
</I>&gt;<i> {pattern,&lt;&lt;&quot;.*&quot;&gt;&gt;},
</I>&gt;<i> {definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
</I>&gt;<i> {priority,0}],
</I>&gt;<i> [{&lt;6868.7071.0&gt;,&lt;6868.7070.0&gt;},
</I>&gt;<i> {&lt;6867.19845.80&gt;,&lt;6867.19844.80&gt;},
</I>&gt;<i> {&lt;0.21601.24&gt;,&lt;0.21548.24&gt;}]},
</I>&gt;<i> none,false,undefined,undefined,
</I>&gt;<i> {[],[]},
</I>&gt;<i> undefined,undefined,undefined,undefined,
</I>&gt;<i> {state,fine,5000,undefined},
</I>&gt;<i> {0,nil},
</I>&gt;<i> undefined,undefined,undefined,
</I>&gt;<i> {dict,0,16,16,8,80,48,
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []},
</I>&gt;<i> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []}}},
</I>&gt;<i> 1,
</I>&gt;<i> {{0,nil},{0,nil}},
</I>&gt;<i> undefined,
</I>&gt;<i> {dict,0,16,16,8,80,48,
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []},
</I>&gt;<i> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []}}},
</I>&gt;<i> undefined,undefined}
</I>&gt;<i> ** Reason for termination ==  
</I>&gt;<i> ** {'module could not be loaded',
</I>&gt;<i> [{undefined,init,
</I>&gt;<i> [{amqqueue,
</I>&gt;<i> {resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
</I>&gt;<i> &lt;&lt;&quot;tmp_topic-0.9934227485209703&quot;&gt;&gt;},
</I>&gt;<i> true,true,&lt;0.21310.24&gt;,[],&lt;0.629.0&gt;,[],[],
</I>&gt;<i> [{vhost,&lt;&lt;&quot;vhost1&quot;&gt;&gt;},
</I>&gt;<i> {name,&lt;&lt;&quot;HA&quot;&gt;&gt;},
</I>&gt;<i> {pattern,&lt;&lt;&quot;.*&quot;&gt;&gt;},
</I>&gt;<i> {definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
</I>&gt;<i> {priority,0}],
</I>&gt;<i> [{&lt;6868.7071.0&gt;,&lt;6868.7070.0&gt;},
</I>&gt;<i> {&lt;6867.19845.80&gt;,&lt;6867.19844.80&gt;},
</I>&gt;<i> {&lt;0.21601.24&gt;,&lt;0.21548.24&gt;}]},
</I>&gt;<i> true,#Fun&lt;rabbit_amqqueue_process.5.64830354&gt;]},
</I>&gt;<i> {rabbit_amqqueue_process,handle_call,3},
</I>&gt;<i> {gen_server2,handle_msg,2},
</I>&gt;<i> {proc_lib,wake_up,3}]}
</I>&gt;<i> 
</I>&gt;<i> but comes online eventually and can do &quot;rabbitmqctl status&quot;
</I>&gt;<i> 
</I>&gt;<i> starts up node2, also reports a lot of:
</I>&gt;<i> =ERROR REPORT==== 18-Mar-2013::11:11:06 ===
</I>&gt;<i> ** Generic server &lt;0.640.0&gt; terminating
</I>&gt;<i> ** Last message in was {init,&lt;0.152.0&gt;}
</I>&gt;<i> ** When Server state == {q,{amqqueue,
</I>&gt;<i> {resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
</I>&gt;<i> &lt;&lt;&quot;tmp_topic-0.1019297200255096&quot;&gt;&gt;},
</I>&gt;<i> true,true,&lt;0.977.11&gt;,[],&lt;0.640.0&gt;,[],[],
</I>&gt;<i> undefined,[]},
</I>&gt;<i> none,false,undefined,undefined,
</I>&gt;<i> {[],[]},
</I>&gt;<i> undefined,undefined,undefined,undefined,
</I>&gt;<i> {state,fine,5000,undefined},
</I>&gt;<i> {0,nil},
</I>&gt;<i> undefined,undefined,undefined,
</I>&gt;<i> {dict,0,16,16,8,80,48,
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []},
</I>&gt;<i> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []}}},
</I>&gt;<i> 1,
</I>&gt;<i> {{0,nil},{0,nil}},
</I>&gt;<i> undefined,
</I>&gt;<i> {dict,0,16,16,8,80,48,
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []},
</I>&gt;<i> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []}}},
</I>&gt;<i> undefined,undefined}
</I>&gt;<i> ** Reason for termination ==  
</I>&gt;<i> ** {'module could not be loaded',
</I>&gt;<i> [{undefined,init,
</I>&gt;<i> [{amqqueue,
</I>&gt;<i> {resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
</I>&gt;<i> &lt;&lt;&quot;tmp_topic-0.1019297200255096&quot;&gt;&gt;},
</I>&gt;<i> true,true,&lt;0.977.11&gt;,[],&lt;0.640.0&gt;,[],[],undefined,[]},
</I>&gt;<i> true,#Fun&lt;rabbit_amqqueue_process.5.64830354&gt;]},
</I>&gt;<i> {rabbit_amqqueue_process,handle_call,3},
</I>&gt;<i> {gen_server2,handle_msg,2},
</I>&gt;<i> {proc_lib,wake_up,3}]}
</I>&gt;<i> =ERROR REPORT==== 18-Mar-2013::11:11:06 ===
</I>&gt;<i> ** Generic server &lt;0.645.0&gt; terminating
</I>&gt;<i> ** Last message in was {init,&lt;0.152.0&gt;}
</I>&gt;<i> ** When Server state == {q,{amqqueue,
</I>&gt;<i> {resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
</I>&gt;<i> &lt;&lt;&quot;tmp_topic-0.8794151877518743&quot;&gt;&gt;},
</I>&gt;<i> true,true,&lt;0.30538.0&gt;,[],&lt;0.645.0&gt;,[],[],
</I>&gt;<i> [{vhost,&lt;&lt;&quot;vhost1&quot;&gt;&gt;},
</I>&gt;<i> {name,&lt;&lt;&quot;HA&quot;&gt;&gt;},
</I>&gt;<i> {pattern,&lt;&lt;&quot;.*&quot;&gt;&gt;},
</I>&gt;<i> {definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
</I>&gt;<i> {priority,0}],
</I>&gt;<i> [{&lt;6872.28270.5&gt;,&lt;6872.28269.5&gt;},
</I>&gt;<i> {&lt;0.32304.1&gt;,&lt;0.30804.0&gt;}]},
</I>&gt;<i> none,false,undefined,undefined,
</I>&gt;<i> {[],[]},
</I>&gt;<i> undefined,undefined,undefined,undefined,
</I>&gt;<i> {state,fine,5000,undefined},
</I>&gt;<i> {0,nil},
</I>&gt;<i> undefined,undefined,undefined,
</I>&gt;<i> {dict,0,16,16,8,80,48,
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []},
</I>&gt;<i> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []}}},
</I>&gt;<i> 1,
</I>&gt;<i> {{0,nil},{0,nil}},
</I>&gt;<i> undefined,
</I>&gt;<i> {dict,0,16,16,8,80,48,
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []},
</I>&gt;<i> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i> []}}},
</I>&gt;<i> undefined,undefined}
</I>&gt;<i> ** Reason for termination ==  
</I>&gt;<i> ** {'module could not be loaded',
</I>&gt;<i> [{undefined,init,
</I>&gt;<i> [{amqqueue,
</I>&gt;<i> {resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,queue,
</I>&gt;<i> &lt;&lt;&quot;tmp_topic-0.8794151877518743&quot;&gt;&gt;},
</I>&gt;<i> true,true,&lt;0.30538.0&gt;,[],&lt;0.645.0&gt;,[],[],
</I>&gt;<i> [{vhost,&lt;&lt;&quot;vhost1&quot;&gt;&gt;},
</I>&gt;<i> {name,&lt;&lt;&quot;HA&quot;&gt;&gt;},
</I>&gt;<i> {pattern,&lt;&lt;&quot;.*&quot;&gt;&gt;},
</I>&gt;<i> {definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
</I>&gt;<i> {priority,0}],
</I>&gt;<i> [{&lt;6872.28270.5&gt;,&lt;6872.28269.5&gt;},{&lt;0.32304.1&gt;,&lt;0.30804.0&gt;}]},
</I>&gt;<i> true,#Fun&lt;rabbit_amqqueue_process.5.64830354&gt;]},
</I>&gt;<i> {rabbit_amqqueue_process,handle_call,3},
</I>&gt;<i> {gen_server2,handle_msg,2},
</I>&gt;<i> {proc_lib,wake_up,3}]}
</I>&gt;<i> 
</I>&gt;<i> node 2 comes online i can now query rabbitmqctl status
</I>&gt;<i> starting up node 1, comes online
</I>&gt;<i> the cluster is now working again but several durables queues are gone(!)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>














































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026002.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
	<LI>Next message: <A HREF="026090.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26085">[ date ]</a>
              <a href="thread.html#26085">[ thread ]</a>
              <a href="subject.html#26085">[ subject ]</a>
              <a href="author.html#26085">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
