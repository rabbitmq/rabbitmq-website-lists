<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Strange%20reaction%20to%20publishing%20message%20with%0A%20invalid%20expiration.&In-Reply-To=%3C513F6A7A.60304%40noaa.gov%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025880.html">
   <LINK REL="Next"  HREF="026025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.</H1>
    <B>James Gardner</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Strange%20reaction%20to%20publishing%20message%20with%0A%20invalid%20expiration.&In-Reply-To=%3C513F6A7A.60304%40noaa.gov%3E"
       TITLE="[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.">james.gardner at noaa.gov
       </A><BR>
    <I>Tue Mar 12 17:48:42 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025880.html">[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
</A></li>
        <LI>Next message: <A HREF="026025.html">[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25886">[ date ]</a>
              <a href="thread.html#25886">[ thread ]</a>
              <a href="subject.html#25886">[ subject ]</a>
              <a href="author.html#25886">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Ok thanks, good to know. If that's how AMQP handles errors, that part's 
fine, and I'm used to PHP extensions not dealing with things correctly 
:<i>), but I don't appear to be getting an exception when my Java code reaches:
</I>channel.basicPublish(&quot;e.test&quot;, &quot;&quot;, props, &quot;Hi!!!&quot;.getBytes());
That statement, along with everything else (including the call to 
consume, which *does* throw an exception just fine) is inside a try 
{...} catch (Exception e) {...} .
If you say I should be getting an exception, then I cannot explain why I 
am not.
Here, I'll just include the code. All of this is just inside a main 
function in a Test class (I took out the consume part):

try {
             ConnectionFactory factory = new ConnectionFactory();
factory.setUri(&quot;<A HREF="amqp://user:pwd@amqp1.ourserver.gov/ourvhost&quot;">amqp://user:pwd@amqp1.ourserver.gov/ourvhost&quot;</A>);
             Connection conn = factory.newConnection();

             Channel channel = conn.createChannel();

             BasicProperties props = new BasicProperties
                                     .Builder()
                                     .expiration(&quot;trete&quot;)
                                     .build();

             channel.basicPublish(&quot;e.test&quot;, &quot;&quot;, props, &quot;Hi!!!&quot;.getBytes());


         }
         catch (Exception e) {
             System.out.println(&quot;Threw exception: &quot;);
             e.printStackTrace(System.out);
         }

My Java is a little rusty so forgive me if I am missing something. Am I 
supposed to get an IOException if the publish fails due to the bad 
header, or only if the channel had been closed before I do the publish 
or if I tried to use the channel again after the bad publish?

- James


On 03/12/2013 11:12 AM, Simon MacMullen wrote:
&gt;<i> Well, the channel is getting closed with an error message (same as it 
</I>&gt;<i> would be for an illegal user_id in fact). That's AMQP's approach to 
</I>&gt;<i> error handling.
</I>&gt;<i>
</I>&gt;<i> You should be able to see an IOException getting thrown in the Java 
</I>&gt;<i> client, with a more descriptive cause property, or you can register a 
</I>&gt;<i> ShutdownListener. I have no idea how the PHP client signals errors I'm 
</I>&gt;<i> afraid.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> On 12/03/13 14:49, James Gardner wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> I found a behavior which, to me at least, acts more like a bug than a
</I>&gt;&gt;<i> feature...
</I>&gt;&gt;<i> It seems that when you publish a message with an invalid expiration
</I>&gt;&gt;<i> string (eg. &quot;blah&quot;), it renders that channel inoperable for consume
</I>&gt;&gt;<i> operations afterwards. I would think it should just discard the message.
</I>&gt;&gt;<i> In the official Java client, something closes the channel, although I
</I>&gt;&gt;<i> don't get any exception until I try to use it for the ensuing consume
</I>&gt;&gt;<i> operation.
</I>&gt;&gt;<i> In the PHP AMQP client (this one:
</I>&gt;&gt;<i> <A HREF="http://www.php.net/manual/en/book.amqp.php">http://www.php.net/manual/en/book.amqp.php</A>), the channel stays open but
</I>&gt;&gt;<i> when you execute $queue-&gt;consume(...) and look in the management
</I>&gt;&gt;<i> interface you can see it has not registered as a consumer on the queue
</I>&gt;&gt;<i> of interest.
</I>&gt;&gt;<i> Given the commonalities, I assume these are different client
</I>&gt;&gt;<i> interpretations of the same broker behavior. I am not using transactions
</I>&gt;&gt;<i> or publisher confirms or anything fancy. I am less familiar with the
</I>&gt;&gt;<i> Java client so perhaps I am missing some sort of error handling?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> RabbitMQ version: RabbitMQ 3.0.3, Erlang R14B04 on RHEL 6.4
</I>&gt;&gt;<i> PHP AMQP version is 1.0.1 (admittedly a little outdated)
</I>&gt;&gt;<i> Java client is version: 3.0.3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I can provide code for either client if you would like but I imagine you
</I>&gt;&gt;<i> can replicate it easily just by establishing a connection, then a single
</I>&gt;&gt;<i> channel, then publishing the 'bad' msg to a topic exchange, then trying
</I>&gt;&gt;<i> to consume off a queue bound to that exchange with '#'.
</I>&gt;&gt;<i> When you change expiration to a valid string integer, everything works
</I>&gt;&gt;<i> as you would wish.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Of course one answer, as the doctor joke goes, is to not 'move your arm
</I>&gt;&gt;<i> like that'. Which is fine so long as there's a choice, but if I were
</I>&gt;&gt;<i> creating messages and taking the expiration from a source outside my
</I>&gt;&gt;<i> program (eg. database), this error might occur at some point if the data
</I>&gt;&gt;<i> were bad. I could/should(?) sanitize/verify first of course, the point
</I>&gt;&gt;<i> is more that I thought the typical broker reaction to illegal data was
</I>&gt;&gt;<i> to deal with it 'silently' (as it does with an illegal user_id, for
</I>&gt;&gt;<i> example) rather than effectively make the channel unusable.
</I>&gt;&gt;<i> Is there a different way I (or the client code) should be handling this
</I>&gt;&gt;<i> or is this an unexpected broker behavior?
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> James Gardner
</I>&gt;&gt;<i> NWS - Internet Dissemination System
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025880.html">[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
</A></li>
	<LI>Next message: <A HREF="026025.html">[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25886">[ date ]</a>
              <a href="thread.html#25886">[ thread ]</a>
              <a href="subject.html#25886">[ subject ]</a>
              <a href="author.html#25886">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
