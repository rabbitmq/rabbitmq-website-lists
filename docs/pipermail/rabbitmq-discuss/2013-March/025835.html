<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Huge queues - memory alarm going off
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Huge%20queues%20-%20memory%20alarm%20going%20off&In-Reply-To=%3C513C87ED.4030301%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025834.html">
   <LINK REL="Next"  HREF="025836.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Huge queues - memory alarm going off</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Huge%20queues%20-%20memory%20alarm%20going%20off&In-Reply-To=%3C513C87ED.4030301%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Huge queues - memory alarm going off">matthias at rabbitmq.com
       </A><BR>
    <I>Sun Mar 10 13:17:33 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025834.html">[rabbitmq-discuss] Huge queues - memory alarm going off
</A></li>
        <LI>Next message: <A HREF="025836.html">[rabbitmq-discuss] Huge queues - memory alarm going off
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25835">[ date ]</a>
              <a href="thread.html#25835">[ thread ]</a>
              <a href="subject.html#25835">[ subject ]</a>
              <a href="author.html#25835">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Tim,

On 10/03/13 12:14, Tim Robertson wrote:
&gt;<i> it is really not good practice to
</I>&gt;<i> deliberately use RMQ as a large buffering technology for queues, due to
</I>&gt;<i> the memory management.  Namely, that if one queue is hugely backed up,
</I>&gt;<i> we'll get into a oscillation of:
</I>&gt;<i>    i) memory limit hit
</I>&gt;<i>    ii) block everything while flush partially to disk
</I>&gt;<i>    iii) repeat immediately (while the disabled consumer remains)
</I>&gt;<i> While it will work, we'll likely cripple other parts of the system if
</I>&gt;<i> they are going through the same broker.
</I>
Rabbit will start paging to disk *before* the memory limit is hit, in 
order to prevent precisely the stop-start scenario you describe above.

Obviously if the publishing happens at a faster rate than rabbit can 
write to disk then eventually the memory limit will still be hit and 
producers blocked while rabbit catches up.

Furthermore, as Jerry says, messages do have a non-zero memory footprint 
even when paged to disk. As a consequence, when &quot;filling&quot; rabbit with 
messages, the paging becomes more and more aggressive over time to the 
point where all memory is taken up by the residual footprint of paged 
messages, and publishing even a small number of messages will trigger a 
memory alarm. And eventually *all* memory is consumed that way and 
publishers are blocked indefinitely until some messages are removed from 
the queues.

&gt;<i> I think this was probably a lack of understanding on our part, as we
</I>&gt;<i> anticipated using it as a queue (to do large buffering) whereas I
</I>&gt;<i> presume it is (?) really intended to be a messaging system and targeting
</I>&gt;<i> zero queue sizes is the expected behavior (consumer throughput matched
</I>&gt;<i> to producer).
</I>
We used to say that &quot;an empty rabbit is a healthy rabbit&quot;, but that 
statement predates many improvements to persistence and flow-control 
that have happened since. So nowadays I'd rephrase that as &quot;a non-obese 
rabbit is a healthy rabbit&quot;.

&gt;<i> Are there alternative configurations that you are aware of that would
</I>&gt;<i> allow it to back up large queues, without hitting memory limits?  (the
</I>&gt;<i> tokyo cabinet plugin perhaps?)
</I>
Exactly that. With the tokyo cabinet plugin, messages that have been 
paged to disk leave zero memory footprint, allowing rabbit to hold on to 
as much message data as will fit on disk.

Note however that the plugin is rarely used and is not included in our 
distributions due to the dependency on non-Erlang, platform-specific code.

Alternatively, increase the amount of memory on your rabbit machine.

Regards,

Matthias.
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025834.html">[rabbitmq-discuss] Huge queues - memory alarm going off
</A></li>
	<LI>Next message: <A HREF="025836.html">[rabbitmq-discuss] Huge queues - memory alarm going off
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25835">[ date ]</a>
              <a href="thread.html#25835">[ thread ]</a>
              <a href="subject.html#25835">[ subject ]</a>
              <a href="author.html#25835">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
