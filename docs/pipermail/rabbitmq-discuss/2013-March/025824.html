<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Keeping idle connections alive in EC2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Keeping%20idle%20connections%20alive%20in%20EC2&In-Reply-To=%3CCACkkimmfEoxEJNKhZT%3Dp7b7_5Wd%2BUyb%3D-3_H2kbBWb%3DSvJaThw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025823.html">
   <LINK REL="Next"  HREF="025825.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Keeping idle connections alive in EC2</H1>
    <B>Nishanth Babu Achuthan</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Keeping%20idle%20connections%20alive%20in%20EC2&In-Reply-To=%3CCACkkimmfEoxEJNKhZT%3Dp7b7_5Wd%2BUyb%3D-3_H2kbBWb%3DSvJaThw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Keeping idle connections alive in EC2">nishanth at urbanmapping.com
       </A><BR>
    <I>Fri Mar  8 19:59:41 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025823.html">[rabbitmq-discuss] Keeping idle connections alive in EC2
</A></li>
        <LI>Next message: <A HREF="025825.html">[rabbitmq-discuss] Keeping idle connections alive in EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25824">[ date ]</a>
              <a href="thread.html#25824">[ thread ]</a>
              <a href="subject.html#25824">[ subject ]</a>
              <a href="author.html#25824">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Roy,

I am not using time.sleep in my app.

Worker consumes message from the queue. It then starts processing it which
takes several hours to complete. In the meantime, the connection is dropped
off due to timeout. Once the processing is complete, the worker tries to
send ACK. While doing so, it fails with the error below and the worker
shuts down.

render_jobs_consumer - INFO -
tableau-classic-admin0-borders-en-us-extent-101.mbtiles published for
merging
render_jobs_consumer - INFO -
tableau-classic-admin0-borders-en-us-extent-101.mbtiles rendering completed
in 334.802966833. Sending acknowledgement
pika.adapters.base_connection - ERROR - Read empty data, calling disconnect
pika.adapters.base_connection - WARNING - Unknown state on disconnect: 5
pika.connection - WARNING - Disconnected from RabbitMQ at
192.168.2.182:5672(0):
pika.adapters.select_connection - INFO - Unregistering poller on fd 3


Thanks
Nishanth


On Fri, Mar 8, 2013 at 11:44 AM, Gavin M. Roy &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">gmr at meetme.com</A>&gt; wrote:

&gt;<i>  Depends on your code. Do you use time.sleep in your app? If you enable
</I>&gt;<i> logging in your app, set pika to INFO -- do you see any messages on the
</I>&gt;<i> Pika side? Are you consuming messages when it times out?
</I>&gt;<i>
</I>&gt;<i>  On Friday, March 8, 2013 at 1:13 PM, Nishanth Babu Achuthan wrote:
</I>&gt;<i>
</I>&gt;<i> Hi Michael &amp; Emile,
</I>&gt;<i>
</I>&gt;<i> Thank you very much for the inputs.
</I>&gt;<i>
</I>&gt;<i> I set the heartbeat interval to 25 seconds as below in the client.
</I>&gt;<i>
</I>&gt;<i> parameters      =
</I>&gt;<i> pika.ConnectionParameters(host=RABBITMQ_HOSTNAME,heartbeat_interval=25,credentials=pika.PlainCredentials(RABBITMQ_USERNAME,RABBITMQ_PASSWORD))
</I>&gt;<i>
</I>&gt;<i> connection      =       pika.SelectConnection(parameters,on_connected)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> My rabbitmq conifg looks like below
</I>&gt;<i>
</I>&gt;<i> [
</I>&gt;<i>
</I>&gt;<i>         {rabbit,
</I>&gt;<i>
</I>&gt;<i>                 [
</I>&gt;<i>
</I>&gt;<i>                         {heartbeat,25},
</I>&gt;<i>
</I>&gt;<i>                         {tcp_listen_options,    [binary,        {packet,
</I>&gt;<i>      raw},
</I>&gt;<i>
</I>&gt;<i>                                                 {reuseaddr,     true},
</I>&gt;<i>
</I>&gt;<i>                                                 {backlog,       128},
</I>&gt;<i>
</I>&gt;<i>                                                 {nodelay,       true},
</I>&gt;<i>
</I>&gt;<i>                                                 {keepalive,     true}]}
</I>&gt;<i>
</I>&gt;<i>                 ]
</I>&gt;<i>
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i> ].
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I ran the rabbitmqctl list_connections timeout as below
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ip-10-78-237-240</A>:/mnt# rabbitmqctl list_connections timeout
</I>&gt;<i>
</I>&gt;<i> Listing connections ...
</I>&gt;<i>
</I>&gt;<i> 25
</I>&gt;<i>
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> After 25 seconds, the connection dropped off. It says heartbeat_timeout in
</I>&gt;<i> the logs
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 8-Mar-2013::17:59:03 ===
</I>&gt;<i>
</I>&gt;<i> accepting AMQP connection &lt;0.542.0&gt; (10.79.18.130:60527 -&gt;
</I>&gt;<i> 10.78.237.240:5672)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 8-Mar-2013::18:00:18 ===
</I>&gt;<i>
</I>&gt;<i> closing AMQP connection &lt;0.542.0&gt; (10.79.18.130:60527 -&gt;
</I>&gt;<i> 10.78.237.240:5672):
</I>&gt;<i>
</I>&gt;<i> {heartbeat_timeout,running}
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am not sure why the connection is dropped here. Am I doing anything
</I>&gt;<i> wrong?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i> Nishanth
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Mar 8, 2013 at 7:50 AM, Laing, Michael P. &lt;
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">Michael.Laing at nytimes.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> We keep connections alive for long periods in EC2.
</I>&gt;<i>
</I>&gt;<i> We set the heartbeat to 25 secs to achieve this, as elastic load
</I>&gt;<i> balancers, in particular, have short timeouts.
</I>&gt;<i>
</I>&gt;<i> I would recommend upgrading to the latest rabbitmq and setting the
</I>&gt;<i> heartbeat in the configuration.
</I>&gt;<i>
</I>&gt;<i> Look to see that it shows up in the management console. It's possible for
</I>&gt;<i> client interface code to not agree to heartbeat w the server.
</I>&gt;<i>
</I>&gt;<i> Michael
</I>&gt;<i>
</I>&gt;<i> On 3/8/13 4:56 AM, &quot;Emile Joubert&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;On 07/03/13 22:59, Nishanth wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; While they process the message, rabbitmq drops their connection silently
</I>&gt;<i> &gt;&gt; as it considers them to have been idle for a long time.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;The broker will not drop connections silently. The culprit is more
</I>&gt;<i> &gt;likely a firewall and enabling heartbeats is the correct way to solve
</I>&gt;<i> &gt;the problem.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; I tried to set up heartbeat interval in worker connections but it didn't
</I>&gt;<i> &gt;&gt; resolve the issue. It keeps timing out. I am not able to understand how
</I>&gt;<i> &gt;&gt; this heartbeat work or how to debug to find out why its timing out.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;You can check that the heartbeat is indeed recognised in the broker by
</I>&gt;<i> &gt;issuing &quot;rabbitmqctl list_connections timeout&quot;.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;If the heartbeat is set too long then connections may of course still be
</I>&gt;<i> &gt;dropped, e.g. if an intervening firewall has a 10 minute timeout and the
</I>&gt;<i> &gt;AMQP heartbeats are exchanged every 15 minutes then connections will
</I>&gt;<i> &gt;still be dropped.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;-Emile
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;_______________________________________________
</I>&gt;<i> &gt;rabbitmq-discuss mailing list
</I>&gt;<i> &gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130308/8f227308/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130308/8f227308/attachment.htm</A>&gt;
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025823.html">[rabbitmq-discuss] Keeping idle connections alive in EC2
</A></li>
	<LI>Next message: <A HREF="025825.html">[rabbitmq-discuss] Keeping idle connections alive in EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25824">[ date ]</a>
              <a href="thread.html#25824">[ thread ]</a>
              <a href="subject.html#25824">[ subject ]</a>
              <a href="author.html#25824">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
