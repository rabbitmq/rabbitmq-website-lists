<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Strange%20reaction%20to%20publishing%20message%20with%0A%20invalid%20expiration.&In-Reply-To=%3C5148809E.5040904%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026025.html">
   <LINK REL="Next"  HREF="026028.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Strange%20reaction%20to%20publishing%20message%20with%0A%20invalid%20expiration.&In-Reply-To=%3C5148809E.5040904%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.">simon at rabbitmq.com
       </A><BR>
    <I>Tue Mar 19 15:13:34 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026025.html">[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
</A></li>
        <LI>Next message: <A HREF="026028.html">[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26026">[ date ]</a>
              <a href="thread.html#26026">[ thread ]</a>
              <a href="subject.html#26026">[ subject ]</a>
              <a href="author.html#26026">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi James. Yes, the basicPublish() invocation is not guaranteed to throw 
an exception, since it's not synchronous - the message may not have 
reached the server (or even left the client) by the time the method 
returns. An exception will get thrown at some point later. If you need 
to ensure that you find out about errors immediately you can close the 
channel (and create a new one), invoke any synchronous AMQP method 
(almost anything apart from basic.publish), or wait for confirms.

Cheers, Simon

On 19/03/13 14:59, James Gardner wrote:
&gt;<i> Didn't get a response to email below, sending again in hopes someone can
</I>&gt;<i> answer...
</I>&gt;<i>
</I>&gt;<i> ==============
</I>&gt;<i>
</I>&gt;<i> Ok thanks, good to know. If that's how AMQP handles errors, that part's
</I>&gt;<i> fine, and I'm used to PHP extensions not dealing with things correctly
</I>&gt;<i> :), but I don't appear to be getting an exception when my Java code
</I>&gt;<i> reaches:
</I>&gt;<i> channel.basicPublish(&quot;e.test&quot;, &quot;&quot;, props, &quot;Hi!!!&quot;.getBytes());
</I>&gt;<i> That statement, along with everything else (including the call to
</I>&gt;<i> consume, which *does* throw an exception just fine) is inside a try
</I>&gt;<i> {...} catch (Exception e) {...} .
</I>&gt;<i> If you say I should be getting an exception, then I cannot explain why I
</I>&gt;<i> am not.
</I>&gt;<i> Here, I'll just include the code. All of this is just inside a main
</I>&gt;<i> function in a Test class (I took out the consume part):
</I>&gt;<i>
</I>&gt;<i> try {
</I>&gt;<i>              ConnectionFactory factory = new ConnectionFactory();
</I>&gt;<i> factory.setUri(&quot;<A HREF="amqp://user:pwd@amqp1.ourserver.gov/ourvhost&quot;">amqp://user:pwd@amqp1.ourserver.gov/ourvhost&quot;</A>);
</I>&gt;<i>              Connection conn = factory.newConnection();
</I>&gt;<i>
</I>&gt;<i>              Channel channel = conn.createChannel();
</I>&gt;<i>
</I>&gt;<i>              BasicProperties props = new BasicProperties
</I>&gt;<i>                                      .Builder()
</I>&gt;<i>                                      .expiration(&quot;trete&quot;)
</I>&gt;<i>                                      .build();
</I>&gt;<i>
</I>&gt;<i>              channel.basicPublish(&quot;e.test&quot;, &quot;&quot;, props, &quot;Hi!!!&quot;.getBytes());
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>          }
</I>&gt;<i>          catch (Exception e) {
</I>&gt;<i>              System.out.println(&quot;Threw exception: &quot;);
</I>&gt;<i>              e.printStackTrace(System.out);
</I>&gt;<i>          }
</I>&gt;<i>
</I>&gt;<i> My Java is a little rusty so forgive me if I am missing something.
</I>&gt;<i> Am I supposed to get an IOException if the publish fails due to the bad
</I>&gt;<i> header, or only if the channel had been closed before I do the publish
</I>&gt;<i> or if I tried to use the channel again after the bad publish? The
</I>&gt;<i> Javadocs seem vague on this.
</I>&gt;<i>
</I>&gt;<i> - James
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 03/12/2013 11:12 AM, Simon MacMullen wrote:
</I>&gt;&gt;<i> Well, the channel is getting closed with an error message (same as it
</I>&gt;&gt;<i> would be for an illegal user_id in fact). That's AMQP's approach to
</I>&gt;&gt;<i> error handling.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You should be able to see an IOException getting thrown in the Java
</I>&gt;&gt;<i> client, with a more descriptive cause property, or you can register a
</I>&gt;&gt;<i> ShutdownListener. I have no idea how the PHP client signals errors I'm
</I>&gt;&gt;<i> afraid.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 12/03/13 14:49, James Gardner wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i> I found a behavior which, to me at least, acts more like a bug than a
</I>&gt;&gt;&gt;<i> feature...
</I>&gt;&gt;&gt;<i> It seems that when you publish a message with an invalid expiration
</I>&gt;&gt;&gt;<i> string (eg. &quot;blah&quot;), it renders that channel inoperable for consume
</I>&gt;&gt;&gt;<i> operations afterwards. I would think it should just discard the message.
</I>&gt;&gt;&gt;<i> In the official Java client, something closes the channel, although I
</I>&gt;&gt;&gt;<i> don't get any exception until I try to use it for the ensuing consume
</I>&gt;&gt;&gt;<i> operation.
</I>&gt;&gt;&gt;<i> In the PHP AMQP client (this one:
</I>&gt;&gt;&gt;<i> <A HREF="http://www.php.net/manual/en/book.amqp.php">http://www.php.net/manual/en/book.amqp.php</A>), the channel stays open but
</I>&gt;&gt;&gt;<i> when you execute $queue-&gt;consume(...) and look in the management
</I>&gt;&gt;&gt;<i> interface you can see it has not registered as a consumer on the queue
</I>&gt;&gt;&gt;<i> of interest.
</I>&gt;&gt;&gt;<i> Given the commonalities, I assume these are different client
</I>&gt;&gt;&gt;<i> interpretations of the same broker behavior. I am not using transactions
</I>&gt;&gt;&gt;<i> or publisher confirms or anything fancy. I am less familiar with the
</I>&gt;&gt;&gt;<i> Java client so perhaps I am missing some sort of error handling?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> RabbitMQ version: RabbitMQ 3.0.3, Erlang R14B04 on RHEL 6.4
</I>&gt;&gt;&gt;<i> PHP AMQP version is 1.0.1 (admittedly a little outdated)
</I>&gt;&gt;&gt;<i> Java client is version: 3.0.3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I can provide code for either client if you would like but I imagine you
</I>&gt;&gt;&gt;<i> can replicate it easily just by establishing a connection, then a single
</I>&gt;&gt;&gt;<i> channel, then publishing the 'bad' msg to a topic exchange, then trying
</I>&gt;&gt;&gt;<i> to consume off a queue bound to that exchange with '#'.
</I>&gt;&gt;&gt;<i> When you change expiration to a valid string integer, everything works
</I>&gt;&gt;&gt;<i> as you would wish.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Of course one answer, as the doctor joke goes, is to not 'move your arm
</I>&gt;&gt;&gt;<i> like that'. Which is fine so long as there's a choice, but if I were
</I>&gt;&gt;&gt;<i> creating messages and taking the expiration from a source outside my
</I>&gt;&gt;&gt;<i> program (eg. database), this error might occur at some point if the data
</I>&gt;&gt;&gt;<i> were bad. I could/should(?) sanitize/verify first of course, the point
</I>&gt;&gt;&gt;<i> is more that I thought the typical broker reaction to illegal data was
</I>&gt;&gt;&gt;<i> to deal with it 'silently' (as it does with an illegal user_id, for
</I>&gt;&gt;&gt;<i> example) rather than effectively make the channel unusable.
</I>&gt;&gt;&gt;<i> Is there a different way I (or the client code) should be handling this
</I>&gt;&gt;&gt;<i> or is this an unexpected broker behavior?
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> James Gardner
</I>&gt;&gt;&gt;<i> NWS - Internet Dissemination System
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026025.html">[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
</A></li>
	<LI>Next message: <A HREF="026028.html">[rabbitmq-discuss] Strange reaction to publishing message with invalid expiration.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26026">[ date ]</a>
              <a href="thread.html#26026">[ thread ]</a>
              <a href="subject.html#26026">[ subject ]</a>
              <a href="author.html#26026">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
