<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmq connections blocking but memory is blow	watermark
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq%20connections%20blocking%20but%20memory%20is%20blow%0A%09watermark&In-Reply-To=%3CDAA6050191B145279520BCC228E950B9%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025726.html">
   <LINK REL="Next"  HREF="025732.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmq connections blocking but memory is blow	watermark</H1>
    <B>xzhang84 at gmail.com</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq%20connections%20blocking%20but%20memory%20is%20blow%0A%09watermark&In-Reply-To=%3CDAA6050191B145279520BCC228E950B9%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmq connections blocking but memory is blow	watermark">xzhang84 at gmail.com
       </A><BR>
    <I>Fri Mar  1 14:39:55 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025726.html">[rabbitmq-discuss] reliability guide
</A></li>
        <LI>Next message: <A HREF="025732.html">[rabbitmq-discuss] rabbitmq connections blocking but memory is blow watermark
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25730">[ date ]</a>
              <a href="thread.html#25730">[ thread ]</a>
              <a href="subject.html#25730">[ subject ]</a>
              <a href="author.html#25730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
we are use rabbitmq in our application,  two hours ago, one of our app server is blocked when try to connect to rabbitmq, after check rabbitmq server ,  we found one node's memory is over watermark, a few minutes later, this node is down. after restart this node, the whole cluster sames work fine, but i notice there's a lot of connection in blocking and blocked state from web management&#65292;but use  `rabbitmqctl list_connections pid name peer_address state` in all nodes shows there is no connection in blocking/blocked&#8230;so this really make me confuse:  
1.  after  one node of whole cluster over watermark, but other node is work fine, my application can't connect to rabbitmq cluster?  ps:  we use spring.amqp &amp; spring-rabbit with version 1.1.0.RELEASE
2.  node will down for what reason when over watermark?
3.  why after restart node, there is still blocking connection, but with rabbitmqctl they all in running state?

here is some logs from my rabbitmq server:

=INFO REPORT==== 1-Mar-2013::19:36:21 === vm_memory_high_watermark clear. Memory used:1656590680 allowed:1658778419 =INFO REPORT==== 1-Mar-2013::19:36:21 === alarm_handler: {clear,{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">resource_limit,memory,rabbit at cos22</A>}}

when i try to close blocked connection from web management, it goes error:

=INFO REPORT==== 1-Mar-2013::20:55:24 === Closing connection &lt;0.17197.115&gt; because &quot;Closed via management plugin&quot; =ERROR REPORT==== 1-Mar-2013::20:55:24 === webmachine error: path=&quot;/api/connections/10.64.13.200%3A45891%20-%3E%2010.64.12.226%3A5672&quot; {throw, {error,{not_a_connection_pid,&lt;0.17197.115&gt;}}, [{rabbit_networking,close_connection,2, [{file,&quot;src/rabbit_networking.erl&quot;},{line,317}]}, {rabbit_mgmt_wm_connection,delete_resource,2, [{file,&quot;rabbitmq-management/src/rabbit_mgmt_wm_connection.erl&quot;}, {line,52}]}, {webmachine_resource,resource_call,3, [{file, &quot;webmachine-wrapper/webmachine-git/src/webmachine_resource.erl&quot;}, {line,169}]}, {webmachine_resource,do,3, [{file, &quot;webmachine-wrapper/webmachine-git/src/webmachine_resource.erl&quot;}, {line,128}]}, {webmachine_decision_core,resource_call,1, [{file, &quot;webmachine-wrapper/webmachine-git/src/webmachine_decision_core.erl&quot;}, {line,48}]}, {webmachine_decision_core,decision,1, [{file, &quot;webmachine-wrapper/webmachine-git/src/webmachine_decision_core.erl&quot;}, {line,416}]}, {webmachine_decision_core,handle_request,2, [{file, &quot;webmachine-wrapper/webmachine-git/src/webmachine_decision_core.erl&quot;}, {line,33}]}, {rabbit_webmachine,'-makeloop/1-fun-0-',3, [{file,&quot;rabbitmq-mochiweb/src/rabbit_webmachine.erl&quot;},{line,75}]}]}


use rabbitmqctl shows all in running state:

rabbitmqctl list_connections pid name peer_address state
Listing connections ...
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1271.51</A>&gt;        10.64.13.197:57321 -&gt; 10.64.12.225:5672 10.64.13.197    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1100.51</A>&gt;        10.64.13.196:57240 -&gt; 10.64.12.225:5672 10.64.13.196    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1056.51</A>&gt;        10.64.12.196:58608 -&gt; 10.64.12.225:5672 10.64.12.196    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1079.51</A>&gt;        10.64.11.235:48962 -&gt; 10.64.12.225:5672 10.64.11.235    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1419.51</A>&gt;        10.64.13.228:49857 -&gt; 10.64.12.225:5672 10.64.13.228    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1049.51</A>&gt;        10.64.11.193:36387 -&gt; 10.64.12.225:5672 10.64.11.193    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1159.51</A>&gt;        10.64.10.123:52017 -&gt; 10.64.12.225:5672 10.64.10.123    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.26289.45</A>&gt;       10.64.12.247:38504 -&gt; 10.64.12.225:5672 10.64.12.247    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1121.51</A>&gt;        10.64.10.29:51483 -&gt; 10.64.12.225:5672  10.64.10.29     running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1067.51</A>&gt;        10.64.11.234:50244 -&gt; 10.64.12.225:5672 10.64.11.234    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1149.51</A>&gt;        10.64.11.178:33795 -&gt; 10.64.12.225:5672 10.64.11.178    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1136.51</A>&gt;        10.64.10.28:39557 -&gt; 10.64.12.225:5672  10.64.10.28     running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1370.51</A>&gt;        10.64.13.233:38766 -&gt; 10.64.12.225:5672 10.64.13.233    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1388.51</A>&gt;        10.64.13.229:50932 -&gt; 10.64.12.225:5672 10.64.13.229    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1254.51</A>&gt;        10.64.13.241:49311 -&gt; 10.64.12.225:5672 10.64.13.241    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1031.51</A>&gt;        10.64.11.195:39455 -&gt; 10.64.12.225:5672 10.64.11.195    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1038.51</A>&gt;        10.64.10.27:58938 -&gt; 10.64.12.225:5672  10.64.10.27     running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1167.51</A>&gt;        10.64.13.240:37777 -&gt; 10.64.12.225:5672 10.64.13.240    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos23.1.1442.51</A>&gt;        10.64.10.130:37251 -&gt; 10.64.12.225:5672 10.64.10.130    running
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos22.3.2659.0</A>&gt; 10.64.13.200:54840 -&gt; 10.64.12.226:5672 10.64.13.200    running
...done.



and there is a connection with a lot of channel is in blocked state, but i can't find this connection by use rabbitctl list_connections:

AMQP 0-9-1
10.64.13.200:45891 -&gt; 10.64.12.226:5672 (<A HREF="http://10.64.12.226:55672/#/connections/10.64.13.200%3A45891%20-%3E%2010.64.12.226%3A5672">http://10.64.12.226:55672/#/connections/10.64.13.200%3A45891%20-%3E%2010.64.12.226%3A5672</A>)
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cos22</A>
0B/s(49.2MB total)
0B/s(2.4MB total)
0s
60920





thanks a lot for any help and suggestion.

--  
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">xzhang84 at gmail.com</A>
&#24050;&#20351;&#29992; Sparrow (<A HREF="http://www.sparrowmailapp.com/?sig">http://www.sparrowmailapp.com/?sig</A>)

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130301/da22c7ab/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130301/da22c7ab/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025726.html">[rabbitmq-discuss] reliability guide
</A></li>
	<LI>Next message: <A HREF="025732.html">[rabbitmq-discuss] rabbitmq connections blocking but memory is blow watermark
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25730">[ date ]</a>
              <a href="thread.html#25730">[ thread ]</a>
              <a href="subject.html#25730">[ subject ]</a>
              <a href="author.html#25730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
