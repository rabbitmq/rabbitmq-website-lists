<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Bring cluster up after node crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bring%20cluster%20up%20after%20node%20crash&In-Reply-To=%3CC2115F08-6BB0-413A-A4CF-A81CFC7D97DD%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026085.html">
   <LINK REL="Next"  HREF="026148.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Bring cluster up after node crash</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bring%20cluster%20up%20after%20node%20crash&In-Reply-To=%3CC2115F08-6BB0-413A-A4CF-A81CFC7D97DD%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Bring cluster up after node crash">tim at rabbitmq.com
       </A><BR>
    <I>Wed Mar 20 18:03:45 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026085.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
        <LI>Next message: <A HREF="026148.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26090">[ date ]</a>
              <a href="thread.html#26090">[ thread ]</a>
              <a href="subject.html#26090">[ subject ]</a>
              <a href="author.html#26090">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Carl,

On 20 Mar 2013, at 16:25, Tim Watson wrote:
&gt;<i> What version of rabbit are you running? A number of bugs pertaining to the 'Discarding message ... in an old incarnation .. of this node' were fixed in recent(ish) releases.
</I>&gt;<i> 
</I>
And another couple of questions if that's ok. Firstly - how did you install RabbitMQ on each of these nodes? It's possible one or more installs is corrupted somehow - have you made any modifications to the installs? What does the config look like for each of the nodes?  

&gt;<i> On 19 Mar 2013, at 03:41, Carl H&#246;rberg wrote:
</I>&gt;&gt;<i> Node1 floods the logs for a while at a rate of 20-100/sec:
</I>&gt;&gt;<i> =ERROR REPORT==== 18-Mar-2013::07:10:40 ===
</I>&gt;&gt;<i> Discarding message {'$gen_call',{&lt;0.17965.1&gt;,#Ref&lt;0.0.1.90282&gt;},stat} from &lt;0.17965.1&gt; to &lt;0.5037.1&gt; in an old incarnation (1) of this node (2)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Start up node 3
</I>&gt;&gt;<i> Floods
</I>&gt;&gt;<i> =ERROR REPORT==== 18-Mar-2013::08:23:15 ===
</I>&gt;&gt;<i> Discarding message {'$gen_call',{&lt;0.7609.0&gt;,#Ref&lt;0.0.1.142489&gt;},stat} from &lt;0.7609.0&gt; to &lt;0.25515.26&gt; in an old incarnation (1) of this node (3)
</I>&gt;&gt;<i> and is stuck at  
</I>&gt;&gt;<i> &quot;starting exchange, queue and binding recovery ...&quot;
</I>&gt;&gt;<i> 
</I>
This 'old incarnation of ... ' stuff indicates that we have a process id for a queue that is no longer valid. In theory, the only way (I can see) for this to happen is if a queue master restarts faster than any of the slaves can detect it's death (we have an outstanding bug to look at that, but it may not be relevant since recent releases have included several HA bug fixes) - but regardless, that kind of problem ought to present far earlier than the 'stat' request that's failing...

&gt;&gt;<i> Start up node 2, starts fast, says &quot;Broker started&quot; in startup_log, but doesn't list the plugins, &quot;service rabbitmq-server start&quot; never returns and  rabbitmqctl status and  never returns
</I>&gt;&gt;<i> 
</I>
That sounds suspicious - are you sure the enabled-plugins file and configuration for that node are intact?

&gt;&gt;<i> node 2 then runs out of memory again, without client connections this time:  
</I>&gt;&gt;<i> =INFO REPORT==== 18-Mar-2013::09:09:35 ===
</I>&gt;&gt;<i> vm_memory_high_watermark set. Memory used:7336394640 allowed:7031336140
</I>&gt;&gt;<i> =WARNING REPORT==== 18-Mar-2013::09:09:35 ===
</I>&gt;&gt;<i> memory resource limit alarm set on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at tiger02</A>
</I>&gt;&gt;<i> 
</I>
Is this happening whilst node 1 is still stuck? How long does it take (roughly) to reach this state?

&gt;&gt;<i> Querying /api/overview at node1 gives:
</I>&gt;&gt;<i> {error,{error,{badmatch,false},
</I>&gt;&gt;<i> [{rabbit_mgmt_wm_overview,version,1},
</I>&gt;&gt;<i> {rabbit_mgmt_wm_overview,to_json,2},
</I>&gt;&gt;<i> {webmachine_resource,resource_call,3},
</I>&gt;&gt;<i> {webmachine_resource,do,3},
</I>&gt;&gt;<i> {webmachine_decision_core,resource_call,1},
</I>&gt;&gt;<i> {webmachine_decision_core,decision,1},
</I>&gt;&gt;<i> {webmachine_decision_core,handle_request,2},
</I>&gt;&gt;<i> {rabbit_webmachine,'-makeloop/1-fun-0-',2}]}}
</I>&gt;&gt;<i> 
</I>
What version of Erlang are you running? Upgrading to a recent version of Erlang would be a good idea due to bug fixes and the fact that line numbers in exception stack traces would make it easier to identify where things are going wrong.

For that matter, what OS/Platform are you running on? How did you install Erlang?

&gt;&gt;<i> node 3 starts eventually.  
</I>&gt;&gt;<i> kills node 2, starts again, stops at &quot;starting database &#8230;&quot;
</I>
What do you mean 'kills node 2' exactly? A node will never kill another node. Do you mean that 'you' killed node 2? If so, how did you do this?

&gt;&gt;<i> nothing in the log or startup_err, cpu usage 0%
</I>&gt;&gt;<i> kills after 30min and starts again, same thing.  
</I>&gt;&gt;<i> 
</I>
Again, what do you mean 'kills after 30min and starts again' - is this something you're doing? How are you 'killing' these nodes?

&gt;&gt;<i> node 3 can now output rabbitmqctl status, node 1 still cannot.
</I>&gt;&gt;<i> node 1 can't be shutdown, force kills
</I>
Right - so at this point you've done something like `kill -9` right?

&gt;&gt;<i> with node1 down, node 2 now comes pass &quot;starting database&quot; and starts
</I>&gt;&gt;<i> neither node 2 or node 3 responds to rabbitmqctl status
</I>
For how long do they not respond? I wonder if it could be that all these 'kill' signals you're issuing have left the mnesia database in an inconsistent state somehow.

&gt;&gt;<i> shutting down node 2, but doesn't respond, have to do kill -9
</I>
'shutting down node 2' how - are you issuing `sudo rabbitmqctl stop` to do that?

&gt;&gt;<i> node 3 still doesn't respond to rabbitmqctl status
</I>&gt;&gt;<i> shutdowns node 3, doesnt respond, killing it instead, now all nodes are down.
</I>&gt;&gt;<i> 
</I>
The same approach right?

&gt;&gt;<i> note: When rabbitmqctl status doesnt work other stuff like list_users, cluster_status etc. works.  
</I>&gt;&gt;<i> 
</I>
Sounds like a process is stuck somewhere - the status call attempts to list all running erlang applications on the node, with the timeout set to 'infinity'. If an application has got stuck during startup (or shutdown!) that can be one of the symptoms. Again, please tell us which version of rabbit you're running. We've fixed bugs in (relatively) recent releases that presented as supervision trees getting stuck during shutdown/restart, which might (possibly) explain some of this.

&gt;&gt;<i> Starting up node3, log now gets flooded with:
</I>&gt;&gt;<i> =ERROR REPORT==== 18-Mar-2013::11:09:04 ===
</I>&gt;&gt;<i> ** Generic server &lt;0.629.0&gt; terminating
</I>&gt;&gt;<i> ** Last message in was {init,&lt;0.182.0&gt;}
</I>&gt;&gt;<i> ** When Server state == {q,{amqqueue,
</I>[snip]
&gt;&gt;<i> ** Reason for termination ==  
</I>&gt;&gt;<i> ** {'module could not be loaded',
</I>&gt;&gt;<i> [{undefined,init,
</I>[snip]

This error has occurred because the backing queue module for the queue process is set to 'undefined' - have you made any configuration changes, such as setting the name of the backing queue module by any chance?

Please let us know the answers to these queries and we'll try to figure out what's going on.

Cheers,
Tim

 
</PRE>














































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026085.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
	<LI>Next message: <A HREF="026148.html">[rabbitmq-discuss] Bring cluster up after node crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26090">[ date ]</a>
              <a href="thread.html#26090">[ thread ]</a>
              <a href="subject.html#26090">[ subject ]</a>
              <a href="author.html#26090">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
