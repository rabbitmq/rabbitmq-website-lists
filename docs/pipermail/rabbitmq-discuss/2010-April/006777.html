<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ crashed again
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20crashed%20again&In-Reply-To=F32DA9B1-5E9B-413D-B536-0B5961DB658E%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006776.html">
   <LINK REL="Next"  HREF="006786.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ crashed again</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20crashed%20again&In-Reply-To=F32DA9B1-5E9B-413D-B536-0B5961DB658E%40gmail.com"
       TITLE="[rabbitmq-discuss] RabbitMQ crashed again">matthew at lshift.net
       </A><BR>
    <I>Fri Apr  2 16:50:49 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006776.html">[rabbitmq-discuss] sub-request a message using a message batch
</A></li>
        <LI>Next message: <A HREF="006786.html">[rabbitmq-discuss] Rabbitmq-c compatibility
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6777">[ date ]</a>
              <a href="thread.html#6777">[ thread ]</a>
              <a href="subject.html#6777">[ subject ]</a>
              <a href="author.html#6777">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Mar 31, 2010 at 05:37:40PM -0500, Ian Ragsdale wrote:
&gt;<i> Thanks for confirming, Michael.  Is it safe to assume that closing a connection will deallocate any associated resources?  I have the example for how to increase the number of processes, so I can increase that and make sure that the connections get reopened on a regular basis, which should hopefully keep whatever is causing this slow resource from crashing the server.
</I>
Your reference to system_limits makes me wonder if you've run out of
ets tables. Do you have a large number of queues or bindings which churn
at a high rate? You could try setting the ERL_MAX_ETS_TABLES env var -
adding the following to your rabbitmq.conf file should pimp it out for
reasonably extreme running:

SERVER_ERL_ARGS=&quot;-env ERL_MAX_ETS_TABLES 90240 -env ERL_MAX_PORTS 40240 +K true +A300 +P512000&quot;

(all one line).

Closing a connection should certainly free up all the resources associated
with it (exclusive queues etc etc), but if you've actually hit some
system limit then it's likely the ErlangVM is in a bad way at that point
and recovery from there is going to be tricky.

We've recently fixed a bug which could cause the ets table exhaustion:
<A HREF="http://www.lshift.net/blog/2010/03/29/on-the-limits-of-concurrency-worker-pools-in-erlang">http://www.lshift.net/blog/2010/03/29/on-the-limits-of-concurrency-worker-pools-in-erlang</A>

And the new persister is (needless to say!) even better at resource
management! Depends how bleeding edge you like it really.

&gt;<i> Any thoughts on the behavior I mentioned where the server seemed to continue to accept messages?  I don't see that behavior if I manually stop the server, just in the case of this crash - does that seem at all possible?  I could try to reproduce it locally if that would help.
</I>
Yeah, it's possible the queue has died, but that doesn't mean you can't
publish to the exchange - if the queue has died, the exchange won't care
and if the messages are then destined to go to no queues then the exchange
will throw the message away. Setting the mandatory bit on publish will
help here, though maybe at some performance cost.

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006776.html">[rabbitmq-discuss] sub-request a message using a message batch
</A></li>
	<LI>Next message: <A HREF="006786.html">[rabbitmq-discuss] Rabbitmq-c compatibility
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6777">[ date ]</a>
              <a href="thread.html#6777">[ thread ]</a>
              <a href="subject.html#6777">[ subject ]</a>
              <a href="author.html#6777">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
