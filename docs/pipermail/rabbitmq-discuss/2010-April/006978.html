<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problem with BasicProperties (bug?)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Problem%20with%20BasicProperties%20%28bug%3F%29&In-Reply-To=4BD42657.1070907%40rabbitmq.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006977.html">
   <LINK REL="Next"  HREF="006979.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problem with BasicProperties (bug?)</H1>
    <B>radisb</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Problem%20with%20BasicProperties%20%28bug%3F%29&In-Reply-To=4BD42657.1070907%40rabbitmq.com"
       TITLE="[rabbitmq-discuss] Problem with BasicProperties (bug?)">radisb at gmail.com
       </A><BR>
    <I>Sun Apr 25 18:10:44 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006977.html">[rabbitmq-discuss] Problem with BasicProperties (bug?)
</A></li>
        <LI>Next message: <A HREF="006979.html">[rabbitmq-discuss] Problem with BasicProperties (bug?)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6978">[ date ]</a>
              <a href="thread.html#6978">[ thread ]</a>
              <a href="subject.html#6978">[ subject ]</a>
              <a href="author.html#6978">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi matthias, 
 I looked into the source code of MessageProperties.XXXXX and the reason for
the problem is that   MessageProperties.XXXXX are static final. This means
that either I am mistaken in thinking that their use were as a shortcut for
construction of BasicProperties, or they shouldnt be static. 
But I then read in the javadoc that they are &quot;Constant holder class with
useful static instances of AMQContentHeader. These are intended for use with
Channel.basicPublish&quot;. This makes sense but the problem is that the
BasicProperty class holds user data (the headers) that is to be set and get
by the user. So the kind of use  MessageProperties.XXXXX the javadoc
suggests, is useless for me because this way how am I going to set my
headers before calling basicPublish? I have to create a fresh
BasicProperties instance to set the headers and then pass them to
basicPublish. And since MessageProperties.XXXX is static , the only way to
do that is create BasicProperties by constructor. The constructor has many
boilerplate arguments, thats why I though the MessageProperties where a
convinience for construction. It seems the current design of
MessageProperties assumes the user is only making use of the body and not
the headers. For those users that they need access to headers (and I think
they are a lot) shouldn't we provide the same convinience? :wistle::-D


Thanks a lot,

Bill Radis.


Matthias Radestock-3 wrote:
&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> radisb wrote:
</I>&gt;&gt;<i> The problem is in the forwarding threads code. If before forwarding the
</I>&gt;&gt;<i> message, the thread recreates the BasicProperties and sends a fresh
</I>&gt;&gt;<i> BasicProperties , this causes the consumer on Replies to lose messages
</I>&gt;&gt;<i> and
</I>&gt;&gt;<i> get duplicates in their place. Sometimes the forwarder throws null
</I>&gt;&gt;<i> pointer
</I>&gt;&gt;<i> exception because it cant find the header that has the key(This cant
</I>&gt;&gt;<i> happen
</I>&gt;&gt;<i> because all messages are assigned one before sending). What is strange is
</I>&gt;&gt;<i> that if the 2 forwarders are started in separate JVMs the problem
</I>&gt;&gt;<i> disappears.
</I>&gt;<i>  &gt; [...]
</I>&gt;&gt;<i> 	BasicProperties props = MessageProperties.PERSISTENT_TEXT_PLAIN;
</I>&gt;&gt;<i>       [...]
</I>&gt;&gt;<i> 	props.setHeaders(new HashMap&lt;String, Object&gt;());
</I>&gt;<i> 
</I>&gt;<i> That last line ends up modifying the 
</I>&gt;<i> MessageProperties.PERSISTENT_TEXT_PLAIN object. That's bad in itself, 
</I>&gt;<i> but made worse by the fact that you have multiple threads doing this 
</I>&gt;<i> concurrently.
</I>&gt;<i> 
</I>&gt;<i> To avoid this, you should clone() the object first and then use/modify 
</I>&gt;<i> the clone instead.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> 
</I>&gt;<i> Matthias.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>
-- 
View this message in context: <A HREF="http://old.nabble.com/Problem-with-BasicProperties-%28bug-%29-tp28351417p28357380.html">http://old.nabble.com/Problem-with-BasicProperties-%28bug-%29-tp28351417p28357380.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.


</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006977.html">[rabbitmq-discuss] Problem with BasicProperties (bug?)
</A></li>
	<LI>Next message: <A HREF="006979.html">[rabbitmq-discuss] Problem with BasicProperties (bug?)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6978">[ date ]</a>
              <a href="thread.html#6978">[ thread ]</a>
              <a href="subject.html#6978">[ subject ]</a>
              <a href="author.html#6978">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
