<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problem with BasicProperties (bug?)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Problem%20with%20BasicProperties%20%28bug%3F%29&In-Reply-To=28351417.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006976.html">
   <LINK REL="Next"  HREF="006978.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problem with BasicProperties (bug?)</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Problem%20with%20BasicProperties%20%28bug%3F%29&In-Reply-To=28351417.post%40talk.nabble.com"
       TITLE="[rabbitmq-discuss] Problem with BasicProperties (bug?)">matthias at rabbitmq.com
       </A><BR>
    <I>Sun Apr 25 12:24:07 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006976.html">[rabbitmq-discuss]  Problem with BasicProperties (bug?)
</A></li>
        <LI>Next message: <A HREF="006978.html">[rabbitmq-discuss] Problem with BasicProperties (bug?)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6977">[ date ]</a>
              <a href="thread.html#6977">[ thread ]</a>
              <a href="subject.html#6977">[ subject ]</a>
              <a href="author.html#6977">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

radisb wrote:
&gt;<i> The problem is in the forwarding threads code. If before forwarding the
</I>&gt;<i> message, the thread recreates the BasicProperties and sends a fresh
</I>&gt;<i> BasicProperties , this causes the consumer on Replies to lose messages and
</I>&gt;<i> get duplicates in their place. Sometimes the forwarder throws null pointer
</I>&gt;<i> exception because it cant find the header that has the key(This cant happen
</I>&gt;<i> because all messages are assigned one before sending). What is strange is
</I>&gt;<i> that if the 2 forwarders are started in separate JVMs the problem
</I>&gt;<i> disappears.
</I> &gt; [...]
&gt;<i> 	BasicProperties props = MessageProperties.PERSISTENT_TEXT_PLAIN;
</I>&gt;<i>       [...]
</I>&gt;<i> 	props.setHeaders(new HashMap&lt;String, Object&gt;());
</I>
That last line ends up modifying the 
MessageProperties.PERSISTENT_TEXT_PLAIN object. That's bad in itself, 
but made worse by the fact that you have multiple threads doing this 
concurrently.

To avoid this, you should clone() the object first and then use/modify 
the clone instead.

Regards,

Matthias.

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006976.html">[rabbitmq-discuss]  Problem with BasicProperties (bug?)
</A></li>
	<LI>Next message: <A HREF="006978.html">[rabbitmq-discuss] Problem with BasicProperties (bug?)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6977">[ date ]</a>
              <a href="thread.html#6977">[ thread ]</a>
              <a href="subject.html#6977">[ subject ]</a>
              <a href="author.html#6977">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
