<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 1.7.2 with Erlang R13B04 crashes after several hours running MulticastMain from 1.7.2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%201.7.2%20with%20Erlang%20R13B04%20crashes%0A%20after%20several%20hours%20running%20MulticastMain%20from%201.7.2&In-Reply-To=h2h173a1edc1004050620n4c538968yd9d904783ef9e606%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006790.html">
   <LINK REL="Next"  HREF="006767.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 1.7.2 with Erlang R13B04 crashes after several hours running MulticastMain from 1.7.2</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%201.7.2%20with%20Erlang%20R13B04%20crashes%0A%20after%20several%20hours%20running%20MulticastMain%20from%201.7.2&In-Reply-To=h2h173a1edc1004050620n4c538968yd9d904783ef9e606%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] RabbitMQ 1.7.2 with Erlang R13B04 crashes after several hours running MulticastMain from 1.7.2">matthew at lshift.net
       </A><BR>
    <I>Mon Apr  5 14:41:52 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006790.html">[rabbitmq-discuss] RabbitMQ 1.7.2 with Erlang R13B04 crashes	after several hours running MulticastMain from 1.7.2
</A></li>
        <LI>Next message: <A HREF="006767.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing	to a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6792">[ date ]</a>
              <a href="thread.html#6792">[ thread ]</a>
              <a href="subject.html#6792">[ subject ]</a>
              <a href="author.html#6792">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi John,

On Fri, Apr 02, 2010 at 05:01:14PM +0100, Matthew Sackman wrote:
&gt;<i> The &quot;Memory limit set to 819MB.&quot; shows that rabbit really did detect
</I>&gt;<i> 4GB of Ram in there, which is interesting for a Windows system - it
</I>&gt;<i> suggests you're running a 64-bit Erlang.
</I>
No, no it doesn't. I can't do maths...

819/0.4 = 2048.

On Mon, Apr 05, 2010 at 03:20:26PM +0200, John Apps wrote:
&gt;<i> Here you go:
</I>&gt;<i> &gt;&gt;&gt;os:type().
</I>&gt;<i> {win32,nt}
</I>&gt;<i> &gt;&gt;&gt;erlang:system_info(wordsize).
</I>&gt;<i> 4
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;&gt;Also, if you start up rabbit, and in the rabbit shell, type:
</I>&gt;<i> &gt;&gt;&gt;vm_memory_monitor:get_total_memory().
</I>&gt;<i> 4284735488
</I>
Right, this all makes sense. You're running a 32-bit Erlang, which
depending on all sorts of fairly ridiculous issues with Windows, means
that the biggest amount of memory that Windows will allocate to Erlang
(or any 32 bit process) is sometimes 2GB and sometimes 3GB. Under 32-bit
windows, we take the minimum of the detected RAM (4GB in your case), and
2GB (32bit on Windows). The 0.4 scaling is done after that, which is why
we end up with 819MB.

It would then seem that the malloc failed because it would have taken
the erlang process above the 2GB or 3GB limit (whichever your version of
Windows applies to 32-bit programs). The correct thing to do in this
case is to lower the 0.4 and try again, I'm afraid. Slightly more
documentation is available at
<A HREF="http://www.rabbitmq.com/extensions.html#memsup">http://www.rabbitmq.com/extensions.html#memsup</A>

I am surprised that even inspite of the 0.4 scaling, you still managed
to get Rabbit to go above the address space limit. Flow control should
have kicked in, stopping the producer. The consumer could still continue
but clearly something happened which caused Erlang to require more
memory than Windows could supply it with.

Does it still happen if you lower the -n parameter in your tests?

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006790.html">[rabbitmq-discuss] RabbitMQ 1.7.2 with Erlang R13B04 crashes	after several hours running MulticastMain from 1.7.2
</A></li>
	<LI>Next message: <A HREF="006767.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing	to a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6792">[ date ]</a>
              <a href="thread.html#6792">[ thread ]</a>
              <a href="subject.html#6792">[ subject ]</a>
              <a href="author.html#6792">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
