<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Old%20consumer%20tags%20delivered%20after%0A%20re-subscribing%20to%20a%20queue&In-Reply-To=0F7F2E94-69CB-41EA-84FF-B0975CC0F633%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006767.html">
   <LINK REL="Next"  HREF="006781.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Old%20consumer%20tags%20delivered%20after%0A%20re-subscribing%20to%20a%20queue&In-Reply-To=0F7F2E94-69CB-41EA-84FF-B0975CC0F633%40gmail.com"
       TITLE="[rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue">matthew at lshift.net
       </A><BR>
    <I>Fri Apr  2 17:15:12 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006767.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing	to a queue
</A></li>
        <LI>Next message: <A HREF="006781.html">[rabbitmq-discuss] Old consumer tags delivered after	re-subscribing to a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6779">[ date ]</a>
              <a href="thread.html#6779">[ thread ]</a>
              <a href="subject.html#6779">[ subject ]</a>
              <a href="author.html#6779">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Apr 01, 2010 at 12:05:25PM -0300, Juan Wajnerman wrote:
&gt;<i> After unsubscribing from a queue, following &quot;recover&quot; calls will still redeliver unack'd messages through the channel. Even worse, after resubscribing to the queue, the recovered messages are still sent with the old consumer tag.
</I>
The documentation of basic.recover is clear:
&quot;This method asks the server to redeliver all unacknowledged messages
on a specified channel.&quot;

I don't know the ruby library at all, but I assume from your code below
they inverted the noAck flag to ack, hence your :ack =&gt; true indicates
you are commiting to acking messages manually. Your code does not do that
hence every message you receive as part of the subscription is unack'd,
hence will be redelivered when you issue the recover.

Similarly, the documention for basic.cancel (unsubscribe):
&quot;This method cancels a consumer. This does not affect already delivered
messages, but it does mean the server will not send any more messages for
that consumer.&quot;

Thus it is clear that cancelling your subscription does not void your
commitment to acknowledge the messages you've already been sent.

&gt;<i> I'm using the amqp ruby library to consume the queues. Here's a small snippet that reproduces the issue. When I execute this, I always get an error similar to: Basic.Deliver for invalid consumer tag: myqueue-396735623077.
</I>
That really shouldn't be happening - and I suspect it's a client bug.
I've just checked our code - the queue is told to forget about the
consumer tag on the basic.cancel, and is told about the new consumer
tag on basic.consume. Your ctag of myqueue-396735623077 is clearly one
that you, or the library, is specifying - all the server generated
ctags start &quot;amq.ctag-&quot;. I have no idea what the ruby amqp library is
doing under the bonnet - given that you're not supplying a ctag
yourself, nor should the library.

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006767.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing	to a queue
</A></li>
	<LI>Next message: <A HREF="006781.html">[rabbitmq-discuss] Old consumer tags delivered after	re-subscribing to a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6779">[ date ]</a>
              <a href="thread.html#6779">[ thread ]</a>
              <a href="subject.html#6779">[ subject ]</a>
              <a href="author.html#6779">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
