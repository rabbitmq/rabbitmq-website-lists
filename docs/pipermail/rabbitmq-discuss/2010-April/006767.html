<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Old consumer tags delivered after re-subscribing	to a queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Old%20consumer%20tags%20delivered%20after%20re-subscribing%0A%09to%20a%20queue&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006792.html">
   <LINK REL="Next"  HREF="006779.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Old consumer tags delivered after re-subscribing	to a queue</H1>
    <B>Juan Wajnerman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Old%20consumer%20tags%20delivered%20after%20re-subscribing%0A%09to%20a%20queue&In-Reply-To="
       TITLE="[rabbitmq-discuss] Old consumer tags delivered after re-subscribing	to a queue">juan.wajnerman at gmail.com
       </A><BR>
    <I>Thu Apr  1 16:05:25 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006792.html">[rabbitmq-discuss] RabbitMQ 1.7.2 with Erlang R13B04 crashes after several hours running MulticastMain from 1.7.2
</A></li>
        <LI>Next message: <A HREF="006779.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6767">[ date ]</a>
              <a href="thread.html#6767">[ thread ]</a>
              <a href="subject.html#6767">[ subject ]</a>
              <a href="author.html#6767">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm facing the following issue with RabbitMQ. 
After unsubscribing from a queue, following &quot;recover&quot; calls will still redeliver unack'd messages through the channel. Even worse, after resubscribing to the queue, the recovered messages are still sent with the old consumer tag.

I'm using the amqp ruby library to consume the queues. Here's a small snippet that reproduces the issue. When I execute this, I always get an error similar to: Basic.Deliver for invalid consumer tag: myqueue-396735623077.

==========

require 'rubygems'
require 'amqp'
require 'mq'

Thread.new { EM.run}

AMQP.start(:host =&gt; 'localhost', :logging =&gt; false)

MQ.error do |msg|
  puts &quot;ERROR: #{msg}&quot;
end

@exchange = MQ.direct(&quot;myexchange&quot;)  
@queue = MQ.queue(&quot;myqueue&quot;).bind(@exchange)

def subscribe
  @queue.subscribe(:ack =&gt; true) do |msg|
    puts &quot;Message received: #{msg}&quot;
  end
end

subscribe ; sleep 0.2
@exchange.publish Kernel.rand(1E10).to_s ; sleep 0.2
@queue.unsubscribe ; sleep 0.2
subscribe ; sleep 0.2
MQ.recover ; sleep 0.2

==========

The reason I'm doing this is because I want to accommodate to availability of the target services. So, whenever any component is temporarily down or full, I want to stop receiving messages from the queue. Maybe is there any other way to achieve this?

I'm using RabbitMQ 1.7.2 and the ruby library is amqp 0.6.6.

Thanks,
- Juan

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006792.html">[rabbitmq-discuss] RabbitMQ 1.7.2 with Erlang R13B04 crashes after several hours running MulticastMain from 1.7.2
</A></li>
	<LI>Next message: <A HREF="006779.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6767">[ date ]</a>
              <a href="thread.html#6767">[ thread ]</a>
              <a href="subject.html#6767">[ subject ]</a>
              <a href="author.html#6767">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
