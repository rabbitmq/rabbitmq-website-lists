<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Old consumer tags delivered after	re-subscribing to a queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Old%20consumer%20tags%20delivered%20after%0A%09re-subscribing%20to%20a%20queue&In-Reply-To=20100402161512.GJ11613%40wellquite.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006779.html">
   <LINK REL="Next"  HREF="006782.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Old consumer tags delivered after	re-subscribing to a queue</H1>
    <B>Juan Wajnerman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Old%20consumer%20tags%20delivered%20after%0A%09re-subscribing%20to%20a%20queue&In-Reply-To=20100402161512.GJ11613%40wellquite.org"
       TITLE="[rabbitmq-discuss] Old consumer tags delivered after	re-subscribing to a queue">juan.wajnerman at gmail.com
       </A><BR>
    <I>Fri Apr  2 17:37:11 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006779.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue
</A></li>
        <LI>Next message: <A HREF="006782.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6781">[ date ]</a>
              <a href="thread.html#6781">[ thread ]</a>
              <a href="subject.html#6781">[ subject ]</a>
              <a href="author.html#6781">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthew, thanks for your reply! Some comments inline:

On Apr 2, 2010, at 1:15 PM, Matthew Sackman wrote:

&gt;<i> On Thu, Apr 01, 2010 at 12:05:25PM -0300, Juan Wajnerman wrote:
</I>&gt;&gt;<i> After unsubscribing from a queue, following &quot;recover&quot; calls will still redeliver unack'd messages through the channel. Even worse, after resubscribing to the queue, the recovered messages are still sent with the old consumer tag.
</I>&gt;<i> 
</I>&gt;<i> The documentation of basic.recover is clear:
</I>&gt;<i> &quot;This method asks the server to redeliver all unacknowledged messages
</I>&gt;<i> on a specified channel.&quot;
</I>
But what should happen if the subscription was canceled before the messages
were ack'd? The current implementation is still sending the messages with the same consumer tag.

&gt;<i> 
</I>&gt;<i> I don't know the ruby library at all, but I assume from your code below
</I>&gt;<i> they inverted the noAck flag to ack, hence your :ack =&gt; true indicates
</I>&gt;<i> you are commiting to acking messages manually. Your code does not do that
</I>&gt;<i> hence every message you receive as part of the subscription is unack'd,
</I>&gt;<i> hence will be redelivered when you issue the recover.
</I>
That's right. The omission was completely intentional to reproduce the issue.
I'm sorry, maybe I wasn't clear enough about this. The idea is to cancel the
subscription before the message was ack'd and then resubscribe and perform a recover. 

&gt;<i> 
</I>&gt;<i> Similarly, the documention for basic.cancel (unsubscribe):
</I>&gt;<i> &quot;This method cancels a consumer. This does not affect already delivered
</I>&gt;<i> messages, but it does mean the server will not send any more messages for
</I>&gt;<i> that consumer.&quot;
</I>
I understand this, but I'm looking at the bits on the wire, and after sending a cancel, the
following recover will send the unack'd messages using the same old consumer tag.

&gt;<i> 
</I>&gt;<i> Thus it is clear that cancelling your subscription does not void your
</I>&gt;<i> commitment to acknowledge the messages you've already been sent.
</I>&gt;<i> 
</I>&gt;&gt;<i> I'm using the amqp ruby library to consume the queues. Here's a small snippet that reproduces the issue. When I execute this, I always get an error similar to: Basic.Deliver for invalid consumer tag: myqueue-396735623077.
</I>&gt;<i> 
</I>&gt;<i> That really shouldn't be happening - and I suspect it's a client bug.
</I>&gt;<i> I've just checked our code - the queue is told to forget about the
</I>&gt;<i> consumer tag on the basic.cancel, and is told about the new consumer
</I>&gt;<i> tag on basic.consume. Your ctag of myqueue-396735623077 is clearly one
</I>&gt;<i> that you, or the library, is specifying - all the server generated
</I>&gt;<i> ctags start &quot;amq.ctag-&quot;. I have no idea what the ruby amqp library is
</I>&gt;<i> doing under the bonnet - given that you're not supplying a ctag
</I>&gt;<i> yourself, nor should the library.
</I>
I was digging into the source code after sending my email and I found that (correct me if I'm wrong, it's my first time
I look into this code) in rabbit_channel.erl:578 the recover is taking the unack'd messages
and redelivering these using the same ConsumerTag as it was sent before. I think this is
indeed what the FIXME warns: &quot;What should happen if the consumer's been cancelled since?&quot;.

&gt;<i> 
</I>&gt;<i> Matthew
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100402/0b5650a1/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100402/0b5650a1/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006779.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue
</A></li>
	<LI>Next message: <A HREF="006782.html">[rabbitmq-discuss] Old consumer tags delivered after re-subscribing to a queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6781">[ date ]</a>
              <a href="thread.html#6781">[ thread ]</a>
              <a href="subject.html#6781">[ subject ]</a>
              <a href="author.html#6781">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
