<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] behavior when client socket close
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20behavior%20when%20client%20socket%20close&In-Reply-To=%3CCAHiEoM5CDSb2xKehKaPYQzOibh92HQH%2B429eiWwbyaL5mH21Rw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015121.html">
   <LINK REL="Next"  HREF="015124.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] behavior when client socket close</H1>
    <B>Aaron Westendorf</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20behavior%20when%20client%20socket%20close&In-Reply-To=%3CCAHiEoM5CDSb2xKehKaPYQzOibh92HQH%2B429eiWwbyaL5mH21Rw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] behavior when client socket close">aaron at agoragames.com
       </A><BR>
    <I>Fri Sep 16 14:17:50 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015121.html">[rabbitmq-discuss] behavior when client socket close
</A></li>
        <LI>Next message: <A HREF="015124.html">[rabbitmq-discuss] behavior when client socket close
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15123">[ date ]</a>
              <a href="thread.html#15123">[ thread ]</a>
              <a href="subject.html#15123">[ subject ]</a>
              <a href="author.html#15123">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Opposite direction; the clients where turned off, rabbit continued
serving our infrastructure.

This is an important problem for us because our monitoring tools freak
out when the running clients do not match the number of connections
reported by rabbit.

If the problem is not in our networking setup, then it likely lies
somewhere between linux and rabbit. When I've written epoll network
apps, I've found that I always am notified of a read event when the
socket closes, and then if no data is read, the socket is closed. I'm
wondering if rabbit is making that assumption as well, because if it
is, then the problem lies elsewhere.

-Aaron



On Fri, Sep 16, 2011 at 8:16 AM, Marek Majkowski &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">majek04 at gmail.com</A>&gt; wrote:
&gt;<i> On Tue, Sep 13, 2011 at 21:17, Aaron Westendorf &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">aaron at agoragames.com</A>&gt; wrote:
</I>&gt;&gt;<i> We're trying to determine Rabbits expected behavior when a client host
</I>&gt;&gt;<i> shuts off. Server is hardware 2.5.1, client is a VM that was shut down
</I>&gt;&gt;<i> cleanly (i.e. power off). We have no heartbeats, and the client turns
</I>&gt;&gt;<i> on keepalives. We found that linux reported these sockets as
</I>&gt;&gt;<i> ESTABLISHED after the clients were turned off, and we're trying to
</I>&gt;&gt;<i> determine if this is a problem with our vendor's network or expected
</I>&gt;&gt;<i> behavior. Host OS is Linux 2.6.35.
</I>&gt;<i>
</I>&gt;<i> What should happen when you type 'shutdown':
</I>&gt;<i> &#160;1) linux starts shutting down process
</I>&gt;<i> &#160;2) as one of the shutdown steps rabbitmq is cleanly closed
</I>&gt;<i> &#160; (equivalent to /etc/init.d/rabbitmq-server stop)
</I>&gt;<i> &#160;3) during shutdown all network connections get properly closed
</I>&gt;<i>
</I>&gt;<i> The behaviour you're explaining may happen, for example
</I>&gt;<i> when the server is closed uncleanly - 'power cord' shutdown kind
</I>&gt;<i> of thing. TCP/IP is not able to distinguish transient network
</I>&gt;<i> failure from remote host being completely down.
</I>&gt;<i>
</I>&gt;<i> But, it is quite possible that 2) took more time than expected,
</I>&gt;<i> which could be what you're seeing. Rabbitmq sometimes
</I>&gt;<i> needs quite some time to dump messages to the disk
</I>&gt;<i> and shutdown cleanly. In such case operating system won't
</I>&gt;<i> wait too long and will shutdown with rabbitmq and its connections
</I>&gt;<i> still up.
</I>&gt;<i>
</I>&gt;<i> As a workaround:
</I>&gt;<i> &#160;- stop rabbitmq manually before shutting down the system
</I>&gt;<i> &#160;(and make sure it has enough time to write messages)
</I>&gt;<i> &#160;- use keepalives/heartbeats so that clients can detect
</I>&gt;<i> &#160; this kind of issues earlier.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> &#160;Marek
</I>&gt;<i>
</I>


-- 
Aaron Westendorf
Senior Software Engineer
Agora Games
359 Broadway
Troy, NY 12180
Phone: 518.268.1000
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">aaron at agoragames.com</A>
www.agoragames.com
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015121.html">[rabbitmq-discuss] behavior when client socket close
</A></li>
	<LI>Next message: <A HREF="015124.html">[rabbitmq-discuss] behavior when client socket close
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15123">[ date ]</a>
              <a href="thread.html#15123">[ thread ]</a>
              <a href="subject.html#15123">[ subject ]</a>
              <a href="author.html#15123">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
