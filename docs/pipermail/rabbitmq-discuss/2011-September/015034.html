<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] latency in starting/stopping a rabbitmq node
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20latency%20in%20starting/stopping%20a%20rabbitmq%20node&In-Reply-To=%3C20110912145125.GI3803%40southbank.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015008.html">
   <LINK REL="Next"  HREF="014990.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] latency in starting/stopping a rabbitmq node</H1>
    <B>Alexandru Scvor&#355;ov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20latency%20in%20starting/stopping%20a%20rabbitmq%20node&In-Reply-To=%3C20110912145125.GI3803%40southbank.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] latency in starting/stopping a rabbitmq node">alexandru at rabbitmq.com
       </A><BR>
    <I>Mon Sep 12 15:51:25 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015008.html">[rabbitmq-discuss] latency in starting/stopping a rabbitmq node
</A></li>
        <LI>Next message: <A HREF="014990.html">[rabbitmq-discuss] questions about log messages and problems with	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15034">[ date ]</a>
              <a href="thread.html#15034">[ thread ]</a>
              <a href="subject.html#15034">[ subject ]</a>
              <a href="author.html#15034">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Praveen,

Thanks a lot for the info.

I can now replicate the slow start-up.  The good news is that the
broker eventually does start-up (I left it overnight, so I'm not sure
how long it actually took), but it's not immediately obvious how to
speed that up.  We'll look into it further.

The fix to speed up the shutdown didn't make it into 2.6.1 :,(  It'll
probably be in the release after that.

&gt;<i> It says that it is rebuilding the index from scratch..and that mnesia is
</I>&gt;<i> overloaded with  write_threshold and then time_threshold.
</I>&gt;<i> I'm not very sure I understand what they really mean. :(
</I>
That's not really a problem; that just indicates that the database is
being used a lot.

&gt;<i> Can you please tell me if these configs are ok, or am I missing something?
</I>
They look fine.

There's not much you can do about the slow shutdown and slow recovery
right now.  Sorry.

Cheers,
Alex

On Fri, Sep 09, 2011 at 11:57:09AM -0700, Praveen M wrote:
&gt;<i> Hi Alex, thanks for your email. That helped a lot.
</I>&gt;<i> 
</I>&gt;<i> To answer your question about the hang in the &quot;starting exchange, queue and
</I>&gt;<i> binding recovery..&quot; step on creating 100,000 durable queues and restarting
</I>&gt;<i> the broker,
</I>&gt;<i> 
</I>&gt;<i> *Is it really hung?  Is it using the CPU or disk at all at this time?  Is
</I>&gt;<i> there anything in the logs (both the rabbit and SASL logs)?*
</I>&gt;<i> *
</I>&gt;<i> *
</I>&gt;<i> The SASL log doesn't have anything. But the rabbit log has something.
</I>&gt;<i> 
</I>&gt;<i> I have attached the .log file for your reference.
</I>&gt;<i> 
</I>&gt;<i> It says that it is rebuilding the index from scratch..and that mnesia is
</I>&gt;<i> overloaded with  write_threshold and then time_threshold.
</I>&gt;<i> I'm not very sure I understand what they really mean. :(
</I>&gt;<i> 
</I>&gt;<i> My /etc/rabbitmq/rabbitmq.config file entry is as follows:
</I>&gt;<i> 
</I>&gt;<i> [ {mnesia, [{dump_log_write_threshold, 50000}, {dc_dump_limit, 40}]},
</I>&gt;<i> {rabbit, [{vm_memory_high_watermark, 0.34}]}].
</I>&gt;<i> 
</I>&gt;<i> Can you please tell me if these configs are ok, or am I missing something?
</I>&gt;<i> 
</I>&gt;<i> Also, I checked the IO and CPU...when I just start the broker after the
</I>&gt;<i> 100,000 queues creation
</I>&gt;<i> both IO and CPU shoots up for the first minute, but then when everything
</I>&gt;<i> required is fetched to
</I>&gt;<i> memory there is no activity in IO. But CPU consistently stays up.
</I>&gt;<i> 
</I>&gt;<i> From top  the values are like below ~ and the CPU almost always stays up and
</I>&gt;<i> it never goes down.
</I>&gt;<i> 
</I>&gt;<i> PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
</I>&gt;<i> 13997 root      20   0 3184m 2.5g   2324 S  210      21.2       8:17.97
</I>&gt;<i>  beam.smp
</I>&gt;<i> 
</I>&gt;<i> Feel free to let me know if you need more info. I can provide you with
</I>&gt;<i> memory dumps and stack traces if required.
</I>&gt;<i> 
</I>&gt;<i> Thanks a lot for your help.
</I>&gt;<i> Praveen
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Fri, Sep 9, 2011 at 3:12 AM, Alexandru Scvor&#355;ov
</I>&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexandru at rabbitmq.com</A>&gt;wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hi Praveen,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; However I realized when i wanted to shutdown the broker before starting a
</I>&gt;<i> &gt; &gt; new test, the stop command (rabbitmqctl stop) took a long time
</I>&gt;<i> &gt; &gt; to complete.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We are aware of this problem.  The fix is currently going through QA and
</I>&gt;<i> &gt; will probably be in the next release, which should be around fairly
</I>&gt;<i> &gt; soon.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Query 1)
</I>&gt;<i> &gt; &gt; I am curious as to what causes the latency to stop the broker when issued
</I>&gt;<i> &gt; a
</I>&gt;<i> &gt; &gt; rabbitmqctl stop command. It seems to be something to do with the number
</I>&gt;<i> &gt; of
</I>&gt;<i> &gt; &gt; queues created as the stop time increase proportionally as the number of
</I>&gt;<i> &gt; &gt; queues increases.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Internally, when we terminate a queue, we do a few file operations.  This
</I>&gt;<i> &gt; is usually not a problem, but when you close a connection with 100 000s
</I>&gt;<i> &gt; of queues, the same order of file operations get scheduled.  Erlang's
</I>&gt;<i> &gt; IO system then does some expensive operations of this long queue and
</I>&gt;<i> &gt; it ends up processing the operations in quadratic time.  The fix going
</I>&gt;<i> &gt; through QA brings this down to linear time; for instance, I can delete
</I>&gt;<i> &gt; 40k queues in 20s (compared to 211s on the latest release).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Query 2)
</I>&gt;<i> &gt; &gt; In the case of durable queues, I measured the time taken to restart the
</I>&gt;<i> &gt; &gt; broker after stopping it (a clean and unclean stop).
</I>&gt;<i> &gt; &gt; I found that even after a clean/unclean stop the time to restart the
</I>&gt;<i> &gt; broker
</I>&gt;<i> &gt; &gt; was just about 20 seconds on an average.
</I>&gt;<i> &gt; &gt; However, in the case where i created 50000 durable queues and did an
</I>&gt;<i> &gt; unclean
</I>&gt;<i> &gt; &gt; stop(just aborted the broker) and tried to restart the broker it didn't
</I>&gt;<i> &gt; &gt; start for over to 6 minutes (when I gave up)...
</I>&gt;<i> &gt; &gt; It was hung in the step of &quot;starting exchange,queue and binding
</I>&gt;<i> &gt; recovery..&quot;
</I>&gt;<i> &gt; &gt; It will be great if someone could explain why this could be caused.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I can't reproduce this.  Declaring 100 000 durable queues, killing the
</I>&gt;<i> &gt; broker
</I>&gt;<i> &gt; and re-starting it seems to work fine.  It takes about 1 min on my
</I>&gt;<i> &gt; machine.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is it really hung?  Is it using the CPU or disk at all at this time?  Is
</I>&gt;<i> &gt; there anything in the logs (both the rabbit and SASL logs)?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; It will be great if someone could answer the above queries or provide me
</I>&gt;<i> &gt; &gt; with some pointers about the same.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; There's not much you can do at the moment except avoiding terminating a
</I>&gt;<i> &gt; large number of queues at the same time.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hope this clears things up.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Cheers,
</I>&gt;<i> &gt; Alex
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, Sep 08, 2011 at 07:38:14PM -0700, Praveen M wrote:
</I>&gt;<i> &gt; &gt; Hi,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I'm a rabbitmq newbie and am trying to run some experiments to figure out
</I>&gt;<i> &gt; if
</I>&gt;<i> &gt; &gt; rabbitmq would serve my use case.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I would like to create queues in the order of 100,000s. (one for each of
</I>&gt;<i> &gt; my
</I>&gt;<i> &gt; &gt; customers).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I ran various tests,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I'm using the latest 2.6.0 server and 2.6.0 client, and the following
</I>&gt;<i> &gt; tests
</I>&gt;<i> &gt; &gt; in durable queues mode and in non-durable queues mode.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Tests,
</I>&gt;<i> &gt; &gt; 1) to create 1000 queues , produce, consume
</I>&gt;<i> &gt; &gt; 2) to create 10000 queues , produce, consume
</I>&gt;<i> &gt; &gt; 3) to create 50000 queues, produce and consume.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; It works like a charm and the memory usage even with 50,000 queues seem
</I>&gt;<i> &gt; very
</I>&gt;<i> &gt; &gt; reasonable. (the order of 1-1.7G)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; However I realized when i wanted to shutdown the broker before starting a
</I>&gt;<i> &gt; &gt; new test, the stop command (rabbitmqctl stop) took a long time
</I>&gt;<i> &gt; &gt; to complete.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I made a small chart of how long the stop command on the broker takes to
</I>&gt;<i> &gt; &gt; execute after the test creates 'N' queues listed below.
</I>&gt;<i> &gt; &gt; Also, in the case of durable queues, i found some weird numbers for the
</I>&gt;<i> &gt; time
</I>&gt;<i> &gt; &gt; taken to restart the queues after a clean/unclean(aborting broker) stop
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; *NON_DURABLE_QUEUES TEST*
</I>&gt;<i> &gt; &gt; *No of Queues Stop Time*
</I>&gt;<i> &gt; &gt; 1000 10.7 seconds
</I>&gt;<i> &gt; &gt; 10000 2 minutes
</I>&gt;<i> &gt; &gt; 50000 11 minutes
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; *
</I>&gt;<i> &gt; &gt; *
</I>&gt;<i> &gt; &gt; *DURABLE_QUEUES TEST
</I>&gt;<i> &gt; &gt; *No of Queues Start Time Stop Time*
</I>&gt;<i> &gt; &gt; 1000 2 seconds 10 seconds
</I>&gt;<i> &gt; &gt; 10000 24 seconds 2 minutes
</I>&gt;<i> &gt; &gt; 10000 after crash it recovers in 20 seconds (on improper shutdown).
</I>&gt;<i> &gt; &gt; 50000 even at 6 minutes the queues doesn't start on a improper shutdown
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Query 1)
</I>&gt;<i> &gt; &gt; I am curious as to what causes the latency to stop the broker when issued
</I>&gt;<i> &gt; a
</I>&gt;<i> &gt; &gt; rabbitmqctl stop command. It seems to be something to do with the number
</I>&gt;<i> &gt; of
</I>&gt;<i> &gt; &gt; queues created as the stop time increase proportionally as the number of
</I>&gt;<i> &gt; &gt; queues increases.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Query 2)
</I>&gt;<i> &gt; &gt; In the case of durable queues, I measured the time taken to restart the
</I>&gt;<i> &gt; &gt; broker after stopping it (a clean and unclean stop).
</I>&gt;<i> &gt; &gt; I found that even after a clean/unclean stop the time to restart the
</I>&gt;<i> &gt; broker
</I>&gt;<i> &gt; &gt; was just about 20 seconds on an average.
</I>&gt;<i> &gt; &gt; However, in the case where i created 50000 durable queues and did an
</I>&gt;<i> &gt; unclean
</I>&gt;<i> &gt; &gt; stop(just aborted the broker) and tried to restart the broker it didn't
</I>&gt;<i> &gt; &gt; start for over to 6 minutes (when I gave up)...
</I>&gt;<i> &gt; &gt; It was hung in the step of &quot;starting exchange,queue and binding
</I>&gt;<i> &gt; recovery..&quot;
</I>&gt;<i> &gt; &gt; It will be great if someone could explain why this could be caused.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; It will be great if someone could answer the above queries or provide me
</I>&gt;<i> &gt; &gt; with some pointers about the same.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Thank you for your help,
</I>&gt;<i> &gt; &gt; --
</I>&gt;<i> &gt; &gt; -Praveen
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> -Praveen
</I>
&gt;<i> [ {mnesia, [{dump_log_write_threshold, 50000}, {dc_dump_limit, 40}]},
</I>&gt;<i> {rabbit, [{vm_memory_high_watermark, 0.34}]}].
</I>

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015008.html">[rabbitmq-discuss] latency in starting/stopping a rabbitmq node
</A></li>
	<LI>Next message: <A HREF="014990.html">[rabbitmq-discuss] questions about log messages and problems with	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15034">[ date ]</a>
              <a href="thread.html#15034">[ thread ]</a>
              <a href="subject.html#15034">[ subject ]</a>
              <a href="author.html#15034">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
