<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] active/active HA cluster appears to be	deadlocked
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20active/active%20HA%20cluster%20appears%20to%20be%0A%09deadlocked&In-Reply-To=%3CCAP%2B1M2eJC0NjtQA4i3%3D%3D%2BkODMjyvJmU3Fw31xQeHQ5J6G13VQg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014919.html">
   <LINK REL="Next"  HREF="014926.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] active/active HA cluster appears to be	deadlocked</H1>
    <B>Bryan Murphy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20active/active%20HA%20cluster%20appears%20to%20be%0A%09deadlocked&In-Reply-To=%3CCAP%2B1M2eJC0NjtQA4i3%3D%3D%2BkODMjyvJmU3Fw31xQeHQ5J6G13VQg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] active/active HA cluster appears to be	deadlocked">bmurphy1976 at gmail.com
       </A><BR>
    <I>Wed Sep  7 02:37:45 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014919.html">[rabbitmq-discuss] active/active HA cluster appears to be	deadlocked
</A></li>
        <LI>Next message: <A HREF="014926.html">[rabbitmq-discuss] active/active HA cluster appears to be deadlocked
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14920">[ date ]</a>
              <a href="thread.html#14920">[ thread ]</a>
              <a href="subject.html#14920">[ subject ]</a>
              <a href="author.html#14920">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've tried to duplicate this and the second time around the cluster is
behaving like I would have expected.  Unfortunately, I stupidly
overwrote the old cluster so I can't go back to it for any deeper
inspection.

After trawling the archives a bit, it seems that the only way to bring
a dead node out of the cluster is to create a new node that
masquerades as the old node.  That seems pretty messy to me.  Am I
correct about this?  Are there plans to address this in a future
release?

Thanks!
Bryan

On Tue, Sep 6, 2011 at 3:34 PM, Bryan Murphy &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">bmurphy1976 at gmail.com</A>&gt; wrote:
&gt;<i> Additional info,
</I>&gt;<i>
</I>&gt;<i> I killed the rabbitmq process on of the servers in the cluster. &#160;I was
</I>&gt;<i> then able to run a &quot;rabbitmqctl list_queues&quot; on the remaining server
</I>&gt;<i> and verify that there are messages in the queue that have not been
</I>&gt;<i> picked up.
</I>&gt;<i>
</I>&gt;<i> I restarted the process, and &quot;/etc/init.d/rabbitmq-server start&quot; never
</I>&gt;<i> exited. &#160;I had to ^C to get out, however, the server does appear to
</I>&gt;<i> have restarted and rejoined the cluster.
</I>&gt;<i>
</I>&gt;<i> I can now run &quot;rabbitmqclt list_queues&quot; on both nodes in the cluster,
</I>&gt;<i> but the messages are still not flowing and the node I restarted shows
</I>&gt;<i> the following error when I run &quot;rabbitmqclt list_queues&quot;:
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 6-Sep-2011::20:31:35 ===
</I>&gt;<i> Discarding message
</I>&gt;<i> {'$gen_call',{&lt;0.256.0&gt;,#Ref&lt;0.0.0.646&gt;},{info,[name,messages]}} from
</I>&gt;<i> &lt;0.256.0&gt; to &lt;0.1382.0&gt; in an old incarnation (2) of this node (3)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, Sep 6, 2011 at 3:26 PM, Bryan Murphy &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">bmurphy1976 at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> I created a 3 server RabbitMQ v2.6.0 cluster with all queues
</I>&gt;&gt;<i> configured for &quot;x-ha-policy&quot;: &quot;all&quot;. &#160;Everything seemed to be working
</I>&gt;&gt;<i> fine, and then I killed one of the servers (halt). &#160;This is in a
</I>&gt;&gt;<i> virtualized environment (ec2) so that server is gone. &#160;I wanted to
</I>&gt;&gt;<i> simulate scenarios where one of the servers failed catastrophically.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem is, now my cluster seems to be stuck in some sort of
</I>&gt;&gt;<i> deadlocked state. &#160;One of my processes *thinks* it posted a message to
</I>&gt;&gt;<i> the cluster, but I am unable to list_queues to verify this and the
</I>&gt;&gt;<i> consumer has yet to receive this message.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;rabbitmqctl list_queues&quot; blocks forever and never returns.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;/etc/init.d/rabbitmq-server stop&quot; blocks forever and never actually
</I>&gt;&gt;<i> shuts down the server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;rabbitmqctl cluster_status&quot; returns immediately showing me the three
</I>&gt;&gt;<i> registered nodes with only two listed as running:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at domU-12-31-39-00-E1-D7</A>' ...
</I>&gt;&gt;<i> [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ip-10-212-138-134</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ip-10-90-195-244</A>',
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at domU-12-31-39-00-E1-D7</A>']}]},
</I>&gt;&gt;<i> &#160;{running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ip-10-212-138-134</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at domU-12-31-39-00-E1-D7</A>']}]
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> as you can see, all three nodes were configured as &quot;disk&quot; nodes and
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ip-10-90-195-244</A> is no longer running.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, somehow the cluster seems to be deadlocked. &#160;Since this server
</I>&gt;&gt;<i> cannot possibly be restored, how do I get out of this state? &#160;Is there
</I>&gt;&gt;<i> a way I can forcefully tell the rest of the cluster to forget about
</I>&gt;&gt;<i> the missing server? &#160;I can't find an example of how to do this in the
</I>&gt;&gt;<i> documentation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Bryan
</I>&gt;&gt;<i>
</I>&gt;<i>
</I></PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014919.html">[rabbitmq-discuss] active/active HA cluster appears to be	deadlocked
</A></li>
	<LI>Next message: <A HREF="014926.html">[rabbitmq-discuss] active/active HA cluster appears to be deadlocked
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14920">[ date ]</a>
              <a href="thread.html#14920">[ thread ]</a>
              <a href="subject.html#14920">[ subject ]</a>
              <a href="author.html#14920">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
