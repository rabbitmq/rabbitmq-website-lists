<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] No IOException from basicPublish when connection is lost
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20No%20IOException%20from%20basicPublish%20when%0A%20connection%20is%20lost&In-Reply-To=%3CCABzX%2BqxSFy0v2YsnFR2FE1z6-n9ETYj_OhQxx0_diu0yt1FSKA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015312.html">
   <LINK REL="Next"  HREF="015317.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] No IOException from basicPublish when connection is lost</H1>
    <B>Marek Majkowski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20No%20IOException%20from%20basicPublish%20when%0A%20connection%20is%20lost&In-Reply-To=%3CCABzX%2BqxSFy0v2YsnFR2FE1z6-n9ETYj_OhQxx0_diu0yt1FSKA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] No IOException from basicPublish when connection is lost">majek04 at gmail.com
       </A><BR>
    <I>Fri Sep 30 12:43:54 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015312.html">[rabbitmq-discuss] No IOException from basicPublish when connection	is lost
</A></li>
        <LI>Next message: <A HREF="015317.html">[rabbitmq-discuss] unack'd messages are starving my consumers/tasks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15329">[ date ]</a>
              <a href="thread.html#15329">[ thread ]</a>
              <a href="subject.html#15329">[ subject ]</a>
              <a href="author.html#15329">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Sep 28, 2011 at 14:59,
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mikael.beauvois at non.schneider-electric.com</A>&gt; wrote:
&gt;<i> I have a problem when I call the basicPublish method defined in the Channel
</I>&gt;<i> interface.
</I>&gt;<i>
</I>&gt;<i> In my client, I create a Connection using the ConnectionFactory
</I>&gt;<i> (com.rabbitmq.client.ConnectionFactory) to the broker running on a remote
</I>&gt;<i> host (connected in the local network). Then I create a Channel from this
</I>&gt;<i> Connection.
</I>&gt;<i> I call the basicPublish method in a loop (waiting 10s between each publish).
</I>&gt;<i> During the test, I unplug the network cable from the client running on the
</I>&gt;<i> local host.
</I>
RabbitMQ uses AMQP. AMQP uses TCP.

Tcp is a protocol that tries to do best to detect failures, but it's done
using timeouts.

For example, from an idle tcp connection point of view, it's
completely valid that you will
unplug the network cable, wait for a day, and plug it back again.

If you unplug a network cable when tcp connection is transmitting data,
tcp will retry sending over a period of time and will eventually fail.
But this is going to take some time.

&gt;<i> The basicPublish method doesn't throw any exception (I expected at least
</I>&gt;<i> IOException because the network connection is lost).
</I>
If you unplug the network cable - the link is lost. The TCP connection
is not lost until tcp gives up retransmitting.

&gt;<i> All calls to
</I>&gt;<i> basicPublish method in the loop never raise the IOException exception (or
</I>&gt;<i> any other exception). Obviously, the broker never received the messages sent
</I>&gt;<i> after loosing the network connection.
</I>&gt;<i>
</I>&gt;<i> A ShutdownListener has been implemented but the shutdownCompleted method is
</I>&gt;<i> called by the RabbitMQ java client stack around 15 minutes after unplugging
</I>&gt;<i> the network cable.
</I>&gt;<i>
</I>&gt;<i> I also tested the disconnection using the command line in a terminal. The
</I>&gt;<i> results are the same.
</I>
What do you mean?

&gt;<i> I am running RabbitMQ broker 2.6.1 with the RabbitMQ java client , Linux
</I>&gt;<i> Ubuntu 11.04 with kernel 2.6.38-11 (x86) and I tested my code with 2 JVM
</I>&gt;<i> (OpenJDK and Java HotSpot 1.6.0 (build 1.6.0_27-b07)).
</I>&gt;<i>
</I>&gt;<i> Please, could you help me?
</I>
If you want to force tcp connection to be closed quicker, take a look
at tcp heatbeats and/or AMQP keepalive feature.

Cheers,
    Marek
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015312.html">[rabbitmq-discuss] No IOException from basicPublish when connection	is lost
</A></li>
	<LI>Next message: <A HREF="015317.html">[rabbitmq-discuss] unack'd messages are starving my consumers/tasks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15329">[ date ]</a>
              <a href="thread.html#15329">[ thread ]</a>
              <a href="subject.html#15329">[ subject ]</a>
              <a href="author.html#15329">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
