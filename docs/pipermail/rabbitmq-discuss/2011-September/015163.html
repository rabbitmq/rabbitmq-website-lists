<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] JSON-RPC channel plugin crash on	tuple_to_list(Props)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20JSON-RPC%20channel%20plugin%20crash%20on%0A%09tuple_to_list%28Props%29&In-Reply-To=%3CCALeXXgm_z39wf5m4hQh-dT6DU1zideeGw5VgPpcwpoj7B1-PiA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015171.html">
   <LINK REL="Next"  HREF="015182.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] JSON-RPC channel plugin crash on	tuple_to_list(Props)</H1>
    <B>Nick Marino</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20JSON-RPC%20channel%20plugin%20crash%20on%0A%09tuple_to_list%28Props%29&In-Reply-To=%3CCALeXXgm_z39wf5m4hQh-dT6DU1zideeGw5VgPpcwpoj7B1-PiA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] JSON-RPC channel plugin crash on	tuple_to_list(Props)">nmarino at m5net.com
       </A><BR>
    <I>Mon Sep 19 17:15:49 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015171.html">[rabbitmq-discuss] Consuming a queue via Splunk
</A></li>
        <LI>Next message: <A HREF="015182.html">[rabbitmq-discuss] JSON-RPC channel plugin crash	on	tuple_to_list(Props)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15163">[ date ]</a>
              <a href="thread.html#15163">[ thread ]</a>
              <a href="subject.html#15163">[ subject ]</a>
              <a href="author.html#15163">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I've recently been seeing some intermittent process crashes in the JSON-RPC
channel plugin. Here is an example:

=ERROR REPORT==== 9-Sep-2011::16:35:52 ===
** Generic server &lt;0.13801.1107&gt; terminating
** Last message in was {'EXIT',&lt;0.13799.1107&gt;,
                           {badarg,
                               [{erlang,tuple_to_list,[none]},
                                {rabbit_jsonrpc_channel,do_send_async,3},
                                {rabbit_jsonrpc_channel,handle_info,2},
                                {gen_server,handle_msg,5},
                                {proc_lib,init_p_do_apply,3}]}}
** When Server state == {ch,running,rabbit_jsonrpc_channel,&lt;0.13799.1107&gt;,
                         &lt;0.13799.1107&gt;,undefined,
                         #Fun&lt;rabbit_jsonrpc_channel.0.50269389&gt;,none,
                         {set,0,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},

{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},
                         4,
                         {[],[]},
                         {[],[]},
                         &lt;&lt;&quot;guest&quot;&gt;&gt;,&lt;&lt;&quot;/580627&quot;&gt;&gt;,
                         &lt;&lt;&quot;amq.gen-gHphjRfHaC0YWeflaEIezg==&quot;&gt;&gt;,
                         {dict,1,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                          {{[],[],[],[],[],[],[],[],[],[],[],[],[],
                            [[&lt;&lt;&quot;amq.ctag-5QgH+lAhBr93FnOG8Y4T6A==&quot;&gt;&gt;|
                              {resource,&lt;&lt;&quot;/580627&quot;&gt;&gt;,queue,
                               &lt;&lt;&quot;amq.gen-sV5mnds/lpCC6eza+CbMRQ==&quot;&gt;&gt;}]],
                            [],[]}}},
                         {dict,0,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},

{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},
                         &lt;0.13800.1107&gt;,
                         {state,none,undefined}}
** Reason for termination ==
** {badarg,[{erlang,tuple_to_list,[none]},
            {rabbit_jsonrpc_channel,do_send_async,3},
            {rabbit_jsonrpc_channel,handle_info,2},
            {gen_server,handle_msg,5},
            {proc_lib,init_p_do_apply,3}]}

I looked through the RabbitMQ code, and I believe this is getting triggered
when the system in question starts getting enough load that messages are
queued up instead of published immediately as they come in. The decoded
properties get cleared out in rabbit_variable_queue to avoid persisting
extra data, and then later when the message is passed to the json plugin, it
tries to call tuple_to_list on the properties which are now set to the atom
'none'.

(Incidentally, I'm seeing this problem in RabbitMQ 2.1.0, but I checked out
the latest code from hg and the plugin still calls tuple_to_list without
calling ensure_content_decoded first.)

The twist here is that I'm not sure if this is an error anyone would
normally see, but we have written a custom exchange type plugin that creates
messages, calls ensure_content_encoded on them, and then passes them to
rabbit_amqqueue:deliver. The json plugin crash only seems to happen on these
messages that are generated in this way (but like I said, only
intermittently, and most of the time it doesn't seem to cause any issues).
We also have other components of our system that connect to RabbitMQ
directly (not through the json plugin), and there never seem to be any
crashes associated with those connections, despite the fact that they're
dealing with the same kind of messages that do occasionally cause crashes in
the json plugin.

Based on my limited knowledge of the Rabbit code though, it doesn't seem
like we're doing anything wrong in our exchange type plugin, and it seems
like it would make sense for the json plugin to call ensure_content_decoded
before it assumes the content is actually decoded. Could this be considered
a bug in the json plugin? If so, I would be happy to write up a patch and
submit it to whatever the appropriate place might be.

Thanks for your help!
Nick Marino
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110919/3c72f186/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110919/3c72f186/attachment.htm</A>&gt;
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015171.html">[rabbitmq-discuss] Consuming a queue via Splunk
</A></li>
	<LI>Next message: <A HREF="015182.html">[rabbitmq-discuss] JSON-RPC channel plugin crash	on	tuple_to_list(Props)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15163">[ date ]</a>
              <a href="thread.html#15163">[ thread ]</a>
              <a href="subject.html#15163">[ subject ]</a>
              <a href="author.html#15163">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
