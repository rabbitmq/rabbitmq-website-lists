<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] acks from temporary queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20acks%20from%20temporary%20queues&In-Reply-To=%3Cb79de5c5-02df-4199-9b51-76643c25ee20%40k34g2000yqm.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015275.html">
   <LINK REL="Next"  HREF="015226.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] acks from temporary queues</H1>
    <B>gneeri</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20acks%20from%20temporary%20queues&In-Reply-To=%3Cb79de5c5-02df-4199-9b51-76643c25ee20%40k34g2000yqm.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] acks from temporary queues">gneeri at gmail.com
       </A><BR>
    <I>Mon Sep 26 17:42:02 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015275.html">[rabbitmq-discuss] acks from temporary queues
</A></li>
        <LI>Next message: <A HREF="015226.html">[rabbitmq-discuss] Pika - how to properly publish from a periodic	background thread?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15276">[ date ]</a>
              <a href="thread.html#15276">[ thread ]</a>
              <a href="subject.html#15276">[ subject ]</a>
              <a href="author.html#15276">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

No problem at all, and again, thanks for the clarification. I really
do appreciate the help. That said, I think I now have a decent sense
of how to proceed. I'll let you know if I run into any perplexities,
but will try not to take much more of your time.

Thanks again,
Jonathan

On Sep 26, 12:28&#160;pm, Alexandru Scvor&#355;ov &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexan... at rabbitmq.com</A>&gt;
wrote:
&gt;<i> Hi Jonathan,
</I>&gt;<i>
</I>&gt;<i> &gt; This is a point of confusion for me then. In a previous note where I
</I>&gt;<i> &gt; mentioned setting autoAck to false and manually using basicAck,
</I>&gt;<i> &gt; Matthias replied as follows:
</I>&gt;<i>
</I>&gt;<i> Uf, I forgot about the persister in the last message. &#160;Sorry.
</I>&gt;<i>
</I>&gt;<i> &gt; If in the fanout context I could have used consumer acks to hold off
</I>&gt;<i> &gt; broker acks to the publisher, I would have expected that I could
</I>&gt;<i> &gt; effectively block confirms until after I sent basicAcks from the
</I>&gt;<i> &gt; consumer to the broker and then on up to the publisher. From
</I>&gt;<i> &gt; Matthias's note (and my tests), however, it appears that the broker
</I>&gt;<i> &gt; sends an ack back to the publisher as soon as it takes control of the
</I>&gt;<i> &gt; message and so issues a confirm without waiting on anything from the
</I>&gt;<i> &gt; consumer.
</I>&gt;<i>
</I>&gt;<i> He's right. &#160;I was hoping the immediate flag will hold off the confirm,
</I>&gt;<i> but, of course, it won't.
</I>&gt;<i>
</I>&gt;<i> &gt; In the direct exchange context, however, I took your notes
</I>&gt;<i> &gt; to be indicating that the broker there will wait for an ack from the
</I>&gt;<i> &gt; consumer, such that if the consumer died while in process, but before
</I>&gt;<i> &gt; sending the ack, the broker would return a basic.return along with the
</I>&gt;<i> &gt; confirm. If this is not the case, then, my sense is that I will have
</I>&gt;<i> &gt; to have the consumers publish a response directly back to original
</I>&gt;<i> &gt; publisher as Matthias notes--while using the fanout broadcast to keep
</I>&gt;<i> &gt; track of the number of expected responses (as you indicate).
</I>&gt;<i>
</I>&gt;<i> You will have to have consumers send something to the original
</I>&gt;<i> publisher and a fanout to keep track of responses. &#160;You'll only need a
</I>&gt;<i> timeout of some sort, so that if any of the consumers takes to long to
</I>&gt;<i> respond, you react somehow (that probably means the consumer died
</I>&gt;<i> processing the message).
</I>&gt;<i>
</I>&gt;<i> You'll still need the mandatory, immediate flags to at least see that
</I>&gt;<i> the consumer was alive and was consuming from the queue at the time the
</I>&gt;<i> message was sent.
</I>&gt;<i>
</I>&gt;<i> &gt; Does that make sense? Basically, it still orbits around a question of
</I>&gt;<i> &gt; how and/or if consumer acks can be made to effect a producer. I am
</I>&gt;<i> &gt; guessing that my implementation will have to require the return
</I>&gt;<i> &gt; publications (responses), but any clarification you could add to the
</I>&gt;<i> &gt; consumer ack, confirm chain would be greatly appreciated.
</I>&gt;<i>
</I>&gt;<i> You'll need to publish back. &#160;The only things confirms will give you in
</I>&gt;<i> this case is the guarantee that basic.returns happen before confirms.
</I>&gt;<i> So, once you receive the confirm, you know the message has reached the
</I>&gt;<i> consumer.
</I>&gt;<i>
</I>&gt;<i> There's also no need to delay acknowledgement on the consumer side.
</I>&gt;<i>
</I>&gt;<i> Sorry for the confusion.
</I>&gt;<i>
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Sep 26, 2011 at 09:04:06AM -0700, gneeri wrote:
</I>&gt;<i> &gt; Hi Alex,
</I>&gt;<i>
</I>&gt;<i> &gt; This is a point of confusion for me then. In a previous note where I
</I>&gt;<i> &gt; mentioned setting autoAck to false and manually using basicAck,
</I>&gt;<i> &gt; Matthias replied as follows:
</I>&gt;<i>
</I>&gt;<i> &gt; &quot;Confirms mean one thing and one thing only: that the broker has
</I>&gt;<i> &gt; accepted
</I>&gt;<i> &gt; responsibility for the message.
</I>&gt;<i>
</I>&gt;<i> &gt; &quot;They concern the interaction between producers and the broker, and
</I>&gt;<i> &gt; have
</I>&gt;<i> &gt; nothing to do with consumer acks.&quot;
</I>&gt;<i>
</I>&gt;<i> &gt; If in the fanout context I could have used consumer acks to hold off
</I>&gt;<i> &gt; broker acks to the publisher, I would have expected that I could
</I>&gt;<i> &gt; effectively block confirms until after I sent basicAcks from the
</I>&gt;<i> &gt; consumer to the broker and then on up to the publisher. From
</I>&gt;<i> &gt; Matthias's note (and my tests), however, it appears that the broker
</I>&gt;<i> &gt; sends an ack back to the publisher as soon as it takes control of the
</I>&gt;<i> &gt; message and so issues a confirm without waiting on anything from the
</I>&gt;<i> &gt; consumer. In the direct exchange context, however, I took your notes
</I>&gt;<i> &gt; to be indicating that the broker there will wait for an ack from the
</I>&gt;<i> &gt; consumer, such that if the consumer died while in process, but before
</I>&gt;<i> &gt; sending the ack, the broker would return a basic.return along with the
</I>&gt;<i> &gt; confirm. If this is not the case, then, my sense is that I will have
</I>&gt;<i> &gt; to have the consumers publish a response directly back to original
</I>&gt;<i> &gt; publisher as Matthias notes--while using the fanout broadcast to keep
</I>&gt;<i> &gt; track of the number of expected responses (as you indicate).
</I>&gt;<i>
</I>&gt;<i> &gt; Does that make sense? Basically, it still orbits around a question of
</I>&gt;<i> &gt; how and/or if consumer acks can be made to effect a producer. I am
</I>&gt;<i> &gt; guessing that my implementation will have to require the return
</I>&gt;<i> &gt; publications (responses), but any clarification you could add to the
</I>&gt;<i> &gt; consumer ack, confirm chain would be greatly appreciated.
</I>&gt;<i>
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt; Jonathan
</I>&gt;<i>
</I>&gt;<i> &gt; On Sep 26, 11:34&#160;am, Alexandru Scvor&#355;ov &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexan... at rabbitmq.com</A>&gt;
</I>&gt;<i> &gt; wrote:
</I>&gt;<i> &gt; &gt; Hi Jonathan,
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; &quot;In addition, when processing &quot;please log out this user&quot; messages, a
</I>&gt;<i> &gt; &gt; &gt; machine should *not* acknowledge that it has received the message
</I>&gt;<i> &gt; &gt; &gt; until after it publishes its response (this way, if the machine dies
</I>&gt;<i> &gt; &gt; &gt; while processing, the sender will get a basic.return for it).&quot;
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; Am I correct in understanding from this that, in the direct exchange
</I>&gt;<i> &gt; &gt; &gt; context, I can control when the consumer machine sends back its ack,
</I>&gt;<i> &gt; &gt; &gt; by calling something like basicAck at some point in the consumption/
</I>&gt;<i> &gt; &gt; &gt; delivery code?
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; The exchange type has nothing to do with it. &#160;When you consume from a
</I>&gt;<i> &gt; &gt; queue, you specify the autoAck parameter. &#160;If this is set to true
</I>&gt;<i> &gt; &gt; (which it is, by default), then the server will not wait for the
</I>&gt;<i> &gt; &gt; consumer to acknowledge receipt of the message (so, it's effectively
</I>&gt;<i> &gt; &gt; auto-ack'ing all messages). &#160;If it's set to false, the broker will not
</I>&gt;<i> &gt; &gt; consider the message delivered to the consumer until it explicitly ack's
</I>&gt;<i> &gt; &gt; the message. &#160;See the API guide for an example (I assume you're using
</I>&gt;<i> &gt; &gt; the Java client, but the other clients have very similar APIs):
</I>&gt;<i> &gt; &gt; &#160;<A HREF="http://www.rabbitmq.com/api-guide.html#consuming">http://www.rabbitmq.com/api-guide.html#consuming</A>
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; If so, I would expect that I could skip the return
</I>&gt;<i> &gt; &gt; &gt; publishing (i.e., the response) from the consumer to the producer and
</I>&gt;<i> &gt; &gt; &gt; simply check confirms and confirms + basic.returns for each message
</I>&gt;<i> &gt; &gt; &gt; sent directly to each machine. Moreover, if, prior to publishing, I
</I>&gt;<i> &gt; &gt; &gt; associate the machine (or direct queue corresponding to it) to the
</I>&gt;<i> &gt; &gt; &gt; message to be sent, I should be able to find out which machines
</I>&gt;<i> &gt; &gt; &gt; present which form of response (i.e., confirm or confirm +
</I>&gt;<i> &gt; &gt; &gt; basic.return). Does this make sense or am I still reading too much
</I>&gt;<i> &gt; &gt; &gt; into the consumer ack (such that, for example, the confirmation
</I>&gt;<i> &gt; &gt; &gt; received by the publisher just represents the handoff of the message
</I>&gt;<i> &gt; &gt; &gt; to the queue and not its uptake by the consumer)?
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; Oh. &#160;I missed that. &#160;Yes, I think that would work.
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; Cheers,
</I>&gt;<i> &gt; &gt; Alex
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; On Mon, Sep 26, 2011 at 08:04:28AM -0700, gneeri wrote:
</I>&gt;<i> &gt; &gt; &gt; Hi Alex,
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; Thanks so much for the detailed reply. I had begun thinking along
</I>&gt;<i> &gt; &gt; &gt; these lines, but really appreciate the level of detail regarding the
</I>&gt;<i> &gt; &gt; &gt; specific types of publish requests, queues and exchanges. This is
</I>&gt;<i> &gt; &gt; &gt; really helpful and will likely save me many hours of trial and error.
</I>&gt;<i> &gt; &gt; &gt; I do have just one quick question though regarding the following:
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; &quot;In addition, when processing &quot;please log out this user&quot; messages, a
</I>&gt;<i> &gt; &gt; &gt; machine should *not* acknowledge that it has received the message
</I>&gt;<i> &gt; &gt; &gt; until after it publishes its response (this way, if the machine dies
</I>&gt;<i> &gt; &gt; &gt; while processing, the sender will get a basic.return for it).&quot;
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; Am I correct in understanding from this that, in the direct exchange
</I>&gt;<i> &gt; &gt; &gt; context, I can control when the consumer machine sends back its ack,
</I>&gt;<i> &gt; &gt; &gt; by calling something like basicAck at some point in the consumption/
</I>&gt;<i> &gt; &gt; &gt; delivery code? If so, I would expect that I could skip the return
</I>&gt;<i> &gt; &gt; &gt; publishing (i.e., the response) from the consumer to the producer and
</I>&gt;<i> &gt; &gt; &gt; simply check confirms and confirms + basic.returns for each message
</I>&gt;<i> &gt; &gt; &gt; sent directly to each machine. Moreover, if, prior to publishing, I
</I>&gt;<i> &gt; &gt; &gt; associate the machine (or direct queue corresponding to it) to the
</I>&gt;<i> &gt; &gt; &gt; message to be sent, I should be able to find out which machines
</I>&gt;<i> &gt; &gt; &gt; present which form of response (i.e., confirm or confirm +
</I>&gt;<i> &gt; &gt; &gt; basic.return). Does this make sense or am I still reading too much
</I>&gt;<i> &gt; &gt; &gt; into the consumer ack (such that, for example, the confirmation
</I>&gt;<i> &gt; &gt; &gt; received by the publisher just represents the handoff of the message
</I>&gt;<i> &gt; &gt; &gt; to the queue and not its uptake by the consumer)?
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; Thanks again, really, I very much appreciate your help.
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; Cheers,
</I>&gt;<i> &gt; &gt; &gt; Jonathan
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; On Sep 26, 5:54&#160;am, Alexandru Scvor&#355;ov &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexan... at rabbitmq.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; &gt; &gt; Hi Jonathan,
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; 1. Do consumer acks have more significance in transactions, such that
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; I could use those to effect the functionality I'm looking for?
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; &gt; Not really, no. &#160;I don't think there's anyway to get what you want
</I>&gt;<i> &gt; &gt; &gt; &gt; automatically.
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; 2. If not, is there any way (apart from the admin HTTP API) for
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; determining the number of consumers (e.g., bound queues) for a given
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; exchange? This way I could test the number of reply messages as you
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; suggest; otherwise, with needing to register and account for a dynamic
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; array of servers, I would lose a good deal of what I had hoped would
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; be the benefit of a fanout broadcast.
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; &gt; There's no AMQP way of finding how many queues are bound to an exchange.
</I>&gt;<i> &gt; &gt; &gt; &gt; As you say, there's the management API, but using that is likely to lead
</I>&gt;<i> &gt; &gt; &gt; &gt; to races (what happens if you query the number of queues, then one of
</I>&gt;<i> &gt; &gt; &gt; &gt; the machines dies before it sends its acknowledgement?).
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; &gt; &gt; You could kind of get what you want with AMQP. &#160;Use a fanout exchange
</I>&gt;<i> &gt; &gt; &gt; &gt; like you want for broadcast messages, but use a direct exchange for
</I>&gt;<i> &gt; &gt; &gt; &gt; direct communication between machines. &#160;You could use the fanout
</I>&gt;<i> &gt; &gt; &gt; &gt; exchange to make sure that all the machines know about each other (in
</I>&gt;<i> &gt; &gt; &gt; &gt; particular, that each knows the queues the others bound to the direct
</I>&gt;<i> &gt; &gt; &gt; &gt; exchange, so that they can communicate directly). &#160;And you could
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> read more &#187;
</I></PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015275.html">[rabbitmq-discuss] acks from temporary queues
</A></li>
	<LI>Next message: <A HREF="015226.html">[rabbitmq-discuss] Pika - how to properly publish from a periodic	background thread?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15276">[ date ]</a>
              <a href="thread.html#15276">[ thread ]</a>
              <a href="subject.html#15276">[ subject ]</a>
              <a href="author.html#15276">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
