<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer Performance Issues?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20Performance%20Issues%3F&In-Reply-To=%3C4E82E65D.7020205%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015284.html">
   <LINK REL="Next"  HREF="015286.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer Performance Issues?</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20Performance%20Issues%3F&In-Reply-To=%3C4E82E65D.7020205%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Consumer Performance Issues?">matthias at rabbitmq.com
       </A><BR>
    <I>Wed Sep 28 10:18:21 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015284.html">[rabbitmq-discuss] Consumer Performance Issues?
</A></li>
        <LI>Next message: <A HREF="015286.html">[rabbitmq-discuss] Anything special on dev.rabbitmq.com wrt.	x-expire?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15308">[ date ]</a>
              <a href="thread.html#15308">[ thread ]</a>
              <a href="subject.html#15308">[ subject ]</a>
              <a href="author.html#15308">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Marv,

On 27/09/11 00:47, cOre dUmPeR wrote:
&gt;<i> One thing I've been seeing that has me a little puzzled is that (for my
</I>&gt;<i> test setup) message rates on the input side are an order of magnitude
</I>&gt;<i> higher that on the output side. Meaning I can push 25K msgs/sec from my
</I>&gt;<i> producer. However, my consumer, only seems to get about 2.5K
</I>&gt;<i> msgs/sec...although both consumer and producer are setup similarly.
</I>&gt;<i>
</I>&gt;<i> Do I have something misconfigured? Or is this expected? I would expect
</I>&gt;<i> *some* difference between producer(s)/consumer(s)...but not an order of
</I>&gt;<i> magnitude.
</I>
When the broker is heavily loaded the internal scheduling could well 
result in messages getting accepted at a much higher rate than they are 
delivered to consumers. That said, a 10:1 ratio is quite unusual.

&gt;<i> HW
</I>&gt;<i> ------
</I>&gt;<i> (3) EC2 m1.xlarge boxes - 4 cores, 15GB mem
</I>&gt;<i> 1 producer, 1 consumer, 1 broker
</I>&gt;<i>
</I>&gt;<i> Broker
</I>&gt;<i> ----------
</I>&gt;<i> Basic RabbitMQ broker install. Didnt really play with any options,
</I>&gt;<i> except installing the Management plugins and using a different port than
</I>&gt;<i> default.
</I>&gt;<i>
</I>&gt;<i> Producer
</I>&gt;<i> -------------
</I>&gt;<i> Java Client. 4 Producer threads, each with its own connection and
</I>&gt;<i> channel. Direct exchange, NO persist, NO autodelete.
</I>&gt;<i>
</I>&gt;<i> Consumer
</I>&gt;<i> ---------------
</I>&gt;<i> Java client, 4 consumer threads, each with its own connection and
</I>&gt;<i> channel. AutoAck YES.
</I> &gt;
&gt;<i> Messages
</I>&gt;<i> -----------------
</I>&gt;<i> JSON bytes, about 150bytes each message.
</I>
So you have four producers publishing to the same queue, and four 
consumers consuming off that queue, correct?

If so, the above setup can be approximated quite well with the 
MulticastMain test program that ships with the java client. Run it with 
the options &quot;-x 4 -y 4 -u q -a -s 150&quot;

With RabbitMQ 2.6.1 (if you are running anything older then please try 
this one) running on my desktop machine and limited to 4 cores I see a 
balanced inbound and outbound rate of about 36kHz (NB: MulticastMain 
reports the sending rate independently for each producer; I'm seeing 
~9kHz x 4). It can easily get out of balance though - I've seen producer 
rates as high as 45kHz and consumer rates as low as 12kHz.

&gt;<i> Other Details
</I>&gt;<i> --------------------
</I>&gt;<i> My consumer CPU
</I>&gt;<i> load is almost nothing, SO I dont think its the Consumer holding things
</I>&gt;<i> up. *On the broker side....there is only 1 CPU out of 4 that is doing
</I>&gt;<i> any real work. Is this normal?* With 4 consumer threads...I would expect
</I>&gt;<i> more to be happening on the Broker.  I know when the Producer is pushing
</I>&gt;<i> with 4 threads...the broker is generally very busy. But when I stop the
</I>&gt;<i> producer, and leave the consumer running (again, with 4
</I>&gt;<i> threads)...again, I see only 1 CPU on the broker working.
</I>
A queue is effectively a single-threaded resource. Marshalling and 
sending are done in separate threads though, so I would expect to see 
additional cores used for that. In my experiments draining a queue with 
four consumers causes the broker to utilise 2.7 cores.


Regards,

Matthias.
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015284.html">[rabbitmq-discuss] Consumer Performance Issues?
</A></li>
	<LI>Next message: <A HREF="015286.html">[rabbitmq-discuss] Anything special on dev.rabbitmq.com wrt.	x-expire?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15308">[ date ]</a>
              <a href="thread.html#15308">[ thread ]</a>
              <a href="subject.html#15308">[ subject ]</a>
              <a href="author.html#15308">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
