<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Channels closed unexpectedly in Java client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Channels%20closed%20unexpectedly%20in%20Java%20client&In-Reply-To=%3C925DDDE9D69E7143B3252E2D4680A36703C174CE%4034093-C5-EVS1.exchange.rackspace.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015122.html">
   <LINK REL="Next"  HREF="015059.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Channels closed unexpectedly in Java client</H1>
    <B>Iain Hull</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Channels%20closed%20unexpectedly%20in%20Java%20client&In-Reply-To=%3C925DDDE9D69E7143B3252E2D4680A36703C174CE%4034093-C5-EVS1.exchange.rackspace.com%3E"
       TITLE="[rabbitmq-discuss] Channels closed unexpectedly in Java client">iain.hull at workday.com
       </A><BR>
    <I>Tue Sep 13 16:43:41 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015122.html">[rabbitmq-discuss] Issues with RabbitMQ, 	SSL and .NET
</A></li>
        <LI>Next message: <A HREF="015059.html">[rabbitmq-discuss] Channels closed unexpectedly in Java client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15058">[ date ]</a>
              <a href="thread.html#15058">[ thread ]</a>
              <a href="subject.html#15058">[ subject ]</a>
              <a href="author.html#15058">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I am currently running a stress test on one of our RabbitMQ production
servers.  The goal of the test is to discover how many queues RabbitMQ
can support this will tell us how many tenants we can scale to on a
single box.  The test creates a large number of queues, then for each
queue adds three tasks to a thread pool (with 20 threads).  One task
writes 100 messages, the next reads 100 messages and the third task
reads and writes 100 messages.  The messages are read with basicGet.  We
are currently using RabbitMQ 2.5.1 server and Java client on CentOS
64bit with 8 cores and 96Gb of Ram (the high water mark is set to 0.8).

As we ramp up the number of queues above 32,000 some of the tasks start
to fail in basicGet with an IOException, there is also an error in the
server log file.   As the queues increase these errors become more
frequent.

Queues: 32000 task success: 95997 errors: 3
Queues: 64000 task success: 159997 errors: 32003
Queues: 128000 task success: 287997 errors: 96003

The errors occur in batches and then clear up, however the numbers for
the errors are very suspicious as they are (n - 32000 + 3).  During the
whole test only 6-8Gb of ram is used and rabbit server uses at most 350%
cpu (of 800%).  I am wondering if this is a sign that I am hitting the
limit in the number of queues, I have miss configured RabbitMQ or my
test is not valid.  Any help to figure this out would be appreciated.

Regards,
Iain.


=ERROR REPORT==== 13-Sep-2011::09:09:41 ===
connection &lt;0.9484.159&gt;, channel 1 - error:
{amqp_error,not_found,&quot;no queue 'TestExchange_31997' in vhost '/'&quot;,
            'basic.get'}

=ERROR REPORT==== 13-Sep-2011::09:09:41 ===
** Generic server &lt;0.9652.183&gt; terminating
** Last message in was {deliver,
                        {delivery,true,false,none,&lt;0.9651.183&gt;,
                         {basic_message,
 
{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;TestExchange_31998&quot;&gt;&gt;},
                          [&lt;&lt;&gt;&gt;],
                          {content,60,
 
{'P_basic',&lt;&lt;&quot;text/plain&quot;&gt;&gt;,undefined,undefined,2,
                            0,undefined,undefined,undefined,undefined,
 
undefined,undefined,undefined,undefined,undefined},
 
&lt;&lt;152,0,10,116,101,120,116,47,112,108,97,105,110,2,0&gt;&gt;,
                           rabbit_framing_amqp_0_9_1,
                           [&lt;&lt;&quot;Hello World!0 from q=hello&quot;&gt;&gt;]},
 
&lt;&lt;18,156,101,170,65,11,23,81,252,168,116,117,202,153,
                            120,220&gt;&gt;,
                          true},
                         undefined}}
** When Server state == {q,
                         {amqqueue,
 
{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;TestExchange_31998&quot;&gt;&gt;},
                          true,false,none,[],&lt;0.9652.183&gt;},
                         none,false,rabbit_variable_queue,
                         {vqstate,
                          {[],[]},
                          {0,{[],[]}},
                          {delta,undefined,0,undefined},
                          {0,{[],[]}},
                          {[],[]},
                          0,
                          {dict,0,16,16,8,80,48,
 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                             []}}},
                          undefined,
                          {0,nil},
                          {qistate,
 
&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at dev182</A>/queues/3N66B3H9OM1Y8OASL0S3XK8TT
&quot;,
                           {{dict,0,16,16,8,80,48,
 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []}}},
                            []},
                           undefined,0,262144,
                           #Fun&lt;rabbit_variable_queue.2.111108431&gt;,[]},
                          {{client_msstate,msg_store_persistent,
 
&lt;&lt;81,127,46,195,11,139,99,60,19,29,15,68,36,202,
                              246,12&gt;&gt;,
                            {dict,0,16,16,8,80,48,
 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []}}},
                            {state,245835,
 
&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at dev182</A>/msg_store_persistent&quot;},
                            rabbit_msg_store_ets_index,
 
&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at dev182</A>/msg_store_persistent&quot;,
                            &lt;0.240.0&gt;,249932,241738,254029},
                           {client_msstate,msg_store_transient,
 
&lt;&lt;201,227,238,162,120,244,196,219,223,246,129,3,
                              224,211,0,204&gt;&gt;,
                            {dict,0,16,16,8,80,48,
 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []}}},
                            {state,229447,
 
&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at dev182</A>/msg_store_transient&quot;},
                            rabbit_msg_store_ets_index,
 
&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at dev182</A>/msg_store_transient&quot;,
                            &lt;0.232.0&gt;,233544,225350,237641}},
                          {sync,[],[],[],[]},
 
true,0,#Fun&lt;rabbit_amqqueue_process.4.73542412&gt;,
                          #Fun&lt;rabbit_amqqueue_process.5.110277333&gt;,0,0,
                          infinity,0,0,0,0,0,0,
                          {rates,
                           {{1315,904981,880372},0},
                           {{1315,904981,880372},0},
                           0.0,0.0,
                           {1315,904981,880372}},
                          {0,nil},
                          {0,nil},
                          {0,nil},
                          {0,nil},
                          0,0,
                          {rates,
                           {{1315,904981,880372},0},
                           {{1315,904981,880372},0},
                           0.0,0.0,
                           {1315,904981,880372}}},
                         {[],[]},
                         {[],[]},
                         undefined,undefined,
                         {1315904986880394,#Ref&lt;0.0.298.230323&gt;},
                         undefined,
 
{state,fine,{1315904986880410,#Ref&lt;0.0.298.230325&gt;}},
                         {dict,0,16,16,8,80,48,
 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},
                         undefined,undefined}
** Reason for termination == 
** {{badmatch,{error,emlink}},
    [{rabbit_queue_index,get_journal_handle,1},
     {rabbit_queue_index,publish,5},
     {rabbit_variable_queue,maybe_write_index_to_disk,3},
     {rabbit_variable_queue,maybe_write_to_disk,4},
     {rabbit_variable_queue,publish,5},
     {rabbit_variable_queue,publish,4},
     {rabbit_amqqueue_process,deliver_or_enqueue,2},
     {rabbit_amqqueue_process,handle_call,3}]}





Tue Sep 13 09:09:41 UTC 2011: java.io.IOException
        at com.rabbitmq.client.impl.AMQChannel.wrap(AMQChannel.java:110)
        at
com.rabbitmq.client.impl.AMQChannel.exnWrappingRpc(AMQChannel.java:134)
        at com.rabbitmq.client.impl.ChannelN.basicGet(ChannelN.java:806)
        at
com.workday.messaging.test.BreakRabbitBreakTest.receiveMessages(BreakRab
bitBreakTest.java:200)
        at
com.workday.messaging.test.BreakRabbitBreakTest.access$2(BreakRabbitBrea
kTest.java:198)
        at
com.workday.messaging.test.BreakRabbitBreakTest$SendAndReceive.perform(B
reakRabbitBreakTest.java:262)
        at
com.workday.messaging.test.BreakRabbitBreakTest$AbstractMessageRunner.ca
ll(BreakRabbitBreakTest.java:234)
        at
com.workday.messaging.test.BreakRabbitBreakTest$AbstractMessageRunner.ca
ll(BreakRabbitBreakTest.java:1)
        at
java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)
        at
java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)
        at
java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)
        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecuto
r.java:886)
        at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.ja
va:908)
        at java.lang.Thread.run(Thread.java:662)
Caused by: com.rabbitmq.client.ShutdownSignalException: channel error;
reason: {#method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND -
no queue 'TestExchange_31997' in vhost '/', class-id=60,
method-id=70),null,&quot;&quot;}
        at
com.rabbitmq.utility.ValueOrException.getValue(ValueOrException.java:67)
        at
com.rabbitmq.utility.BlockingValueOrException.uninterruptibleGetValue(Bl
ockingValueOrException.java:33)
        at
com.rabbitmq.client.impl.AMQChannel$BlockingRpcContinuation.getReply(AMQ
Channel.java:337)
        at
com.rabbitmq.client.impl.AMQChannel.privateRpc(AMQChannel.java:210)
        at
com.rabbitmq.client.impl.AMQChannel.exnWrappingRpc(AMQChannel.java:128)
        ... 14 more
Caused by: com.rabbitmq.client.ShutdownSignalException: channel error;
reason: {#method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND -
no queue 'TestExchange_31997' in vhost '/', class-id=60,
method-id=70),null,&quot;&quot;}
        at
com.rabbitmq.client.impl.ChannelN.asyncShutdown(ChannelN.java:422)
        at
com.rabbitmq.client.impl.ChannelN.processAsync(ChannelN.java:262)
        at
com.rabbitmq.client.impl.AMQChannel.handleCompleteInboundCommand(AMQChan
nel.java:154)
        at
com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:99)
        at
com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:4
43)
Tue Sep 13 09:09:41 UTC 2011: java.io.IOException
        at com.rabbitmq.client.impl.AMQChannel.wrap(AMQChannel.java:110)
        at
com.rabbitmq.client.impl.AMQChannel.exnWrappingRpc(AMQChannel.java:134)
        at com.rabbitmq.client.impl.ChannelN.basicGet(ChannelN.java:806)
        at
com.workday.messaging.test.BreakRabbitBreakTest.receiveMessages(BreakRab
bitBreakTest.java:200)
        at
com.workday.messaging.test.BreakRabbitBreakTest.access$2(BreakRabbitBrea
kTest.java:198)
        at
com.workday.messaging.test.BreakRabbitBreakTest$SendAndReceive.perform(B
reakRabbitBreakTest.java:262)
        at
com.workday.messaging.test.BreakRabbitBreakTest$AbstractMessageRunner.ca
ll(BreakRabbitBreakTest.java:234)
        at
com.workday.messaging.test.BreakRabbitBreakTest$AbstractMessageRunner.ca
ll(BreakRabbitBreakTest.java:1)
        at
java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)
        at
java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)
        at
java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)
        at
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecuto
r.java:886)
        at
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.ja
va:908)
        at java.lang.Thread.run(Thread.java:662)
Caused by: com.rabbitmq.client.ShutdownSignalException: channel error;
reason: {#method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND -
no queue 'TestExchange_31998' in vhost '/', class-id=60,
method-id=70),null,&quot;&quot;}
        at
com.rabbitmq.utility.ValueOrException.getValue(ValueOrException.java:67)
        at
com.rabbitmq.utility.BlockingValueOrException.uninterruptibleGetValue(Bl
ockingValueOrException.java:33)
        at
com.rabbitmq.client.impl.AMQChannel$BlockingRpcContinuation.getReply(AMQ
Channel.java:337)
        at
com.rabbitmq.client.impl.AMQChannel.privateRpc(AMQChannel.java:210)
        at
com.rabbitmq.client.impl.AMQChannel.exnWrappingRpc(AMQChannel.java:128)
        ... 14 more
Caused by: com.rabbitmq.client.ShutdownSignalException: channel error;
reason: {#method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND -
no queue 'TestExchange_31998' in vhost '/', class-id=60,
method-id=70),null,&quot;&quot;}
        at
com.rabbitmq.client.impl.ChannelN.asyncShutdown(ChannelN.java:422)
        at
com.rabbitmq.client.impl.ChannelN.processAsync(ChannelN.java:262)
        at
com.rabbitmq.client.impl.AMQChannel.handleCompleteInboundCommand(AMQChan
nel.java:154)
        at
com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:99)
        at
com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:4
43)
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015122.html">[rabbitmq-discuss] Issues with RabbitMQ, 	SSL and .NET
</A></li>
	<LI>Next message: <A HREF="015059.html">[rabbitmq-discuss] Channels closed unexpectedly in Java client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15058">[ date ]</a>
              <a href="thread.html#15058">[ thread ]</a>
              <a href="subject.html#15058">[ subject ]</a>
              <a href="author.html#15058">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
