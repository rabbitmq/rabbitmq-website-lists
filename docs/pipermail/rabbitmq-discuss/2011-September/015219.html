<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pika problem, channel starts consuming before I call start_consuming(), then raises Queue.DeclareOk KeyError
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pika%20problem%2C%0A%20channel%20starts%20consuming%20before%20I%20call%20start_consuming%28%29%2C%0A%20then%20raises%20Queue.DeclareOk%20KeyError&In-Reply-To=%3Cbb90fe31-c3e3-4bca-a6f2-6912a9ac517f%40br5g2000vbb.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015324.html">
   <LINK REL="Next"  HREF="015221.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pika problem, channel starts consuming before I call start_consuming(), then raises Queue.DeclareOk KeyError</H1>
    <B>Aaron Voelker</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pika%20problem%2C%0A%20channel%20starts%20consuming%20before%20I%20call%20start_consuming%28%29%2C%0A%20then%20raises%20Queue.DeclareOk%20KeyError&In-Reply-To=%3Cbb90fe31-c3e3-4bca-a6f2-6912a9ac517f%40br5g2000vbb.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Pika problem, channel starts consuming before I call start_consuming(), then raises Queue.DeclareOk KeyError">aaron at contextlogic.com
       </A><BR>
    <I>Wed Sep 21 22:26:59 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015324.html">[rabbitmq-discuss] RabbitMQ, Gretty, and Channel question
</A></li>
        <LI>Next message: <A HREF="015221.html">[rabbitmq-discuss] Pika problem, channel starts consuming before I call start_consuming(), then raises Queue.DeclareOk KeyError
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15219">[ date ]</a>
              <a href="thread.html#15219">[ thread ]</a>
              <a href="subject.html#15219">[ subject ]</a>
              <a href="author.html#15219">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Environment: Python 2.6.6, Ubuntu 10.10, Pika 0.95. I have reproduced
this problem on several machines with the same specs.

Description of Test: Publish to test1, then consume from test1 and
test2.

What Happens: The queue with the message begins consuming before I
have even told it to start_consuming. Pika seems to get into a weird
state, and then throws a Queue.DeclareOk KeyError.

&quot;&quot;&quot;
In Callback Hello World
Traceback (most recent call last):
  File &quot;./rabbittests.py&quot;, line 31, in &lt;module&gt;
    channel.queue_declare(queue=queue_name)
  File &quot;/usr/local/lib/python2.6/dist-packages/pika/spec.py&quot;, line
2437, in queue_declare
    [Queue.DeclareOk])
  File &quot;/usr/local/lib/python2.6/dist-packages/pika/adapters/
blocking_connection.py&quot;, line 221, in rpc
    frame = self._frames[reply]
KeyError: 'Queue.DeclareOk'
&quot;&quot;&quot;

The Code:

#!/usr/bin/python

import pika

######### Producer Code

connection =
pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()

for queue_name in ('test1', 'test2'):
    channel.queue_declare(queue=queue_name)

channel.basic_publish(exchange='', routing_key='test1', body='Hello
World')
connection.close()

######### Consumer Code

connection =
pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()

def callback(ch, method, properties, body):
    print &quot;In Callback&quot;, body
    ch.basic_ack(delivery_tag = method.delivery_tag)

for queue_name in ('test1', 'test2'):
    channel.queue_declare(queue=queue_name)
    channel.basic_consume(callback, queue=queue_name)

assert False # NOTE: this doesn't execute!
channel.start_consuming()
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015324.html">[rabbitmq-discuss] RabbitMQ, Gretty, and Channel question
</A></li>
	<LI>Next message: <A HREF="015221.html">[rabbitmq-discuss] Pika problem, channel starts consuming before I call start_consuming(), then raises Queue.DeclareOk KeyError
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15219">[ date ]</a>
              <a href="thread.html#15219">[ thread ]</a>
              <a href="subject.html#15219">[ subject ]</a>
              <a href="author.html#15219">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
