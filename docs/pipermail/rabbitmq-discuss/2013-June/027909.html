<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mirrored queues behind a load balancer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirrored%20queues%20behind%20a%20load%20balancer&In-Reply-To=%3CCAD6m6fE6xc4XH%2Br_JXYvGoayTxHaC00A-CgXM1qC0dUjMY7x1g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027899.html">
   <LINK REL="Next"  HREF="027910.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mirrored queues behind a load balancer</H1>
    <B>Jason McIntosh</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirrored%20queues%20behind%20a%20load%20balancer&In-Reply-To=%3CCAD6m6fE6xc4XH%2Br_JXYvGoayTxHaC00A-CgXM1qC0dUjMY7x1g%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Mirrored queues behind a load balancer">mcintoshj at gmail.com
       </A><BR>
    <I>Mon Jun 17 05:24:14 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027899.html">[rabbitmq-discuss] Mirrored queues behind a load balancer
</A></li>
        <LI>Next message: <A HREF="027910.html">[rabbitmq-discuss] Mirrored queues behind a load balancer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27909">[ date ]</a>
              <a href="thread.html#27909">[ thread ]</a>
              <a href="subject.html#27909">[ subject ]</a>
              <a href="author.html#27909">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Queues exist (definition wise) on all nodes in a cluster.  Messages only
existing unless the queue is mirrored on a single node.  You can mirror a
queue's messages to N number of cluster nodes.  Admin console is an overall
view of the cluster, so you'll see all the available
nodes/queues/exchanges/etc.

One reason you'd NOT have queues have their messages automatically
replicated to other nodes is scaling.  If you had a cluster of 10 machines,
and all the machines mirrored, then your message would have to hit all 10
nodes before being acknowledged (publish confirm situation as I recall).
 You CAN instead say a queue must be mirrored on N number of nodes,
allowing a failover capacity of N.

Rabbit is also a Master-slave write system. Only ONE node in a cluster is
the &quot;master&quot;.  Other nodes would be there for failover/scaling support.
 i.e. queues could be created on any one of the nodes in a cluster to
distribute load.  In the event of a failure on the master, a slave node
would take over the masters position.  When the old master comes on line,
it becomes a slave, but unless you have 3.1 and auto healing type stuff, it
would only get messages as of the time it has recovered, leaving an
indeterminate amount of time before it goes back into sync.

Further, if clients do auto queue creation, it can get even more
complex/diverse.  RabbitMQ makes messaging pretty simple but architecting
it right and true understanding is a much bigger issue.

Jason


On Fri, Jun 14, 2013 at 10:37 AM, Girish Gangadharan &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">girish at giri.sh</A>&gt; wrote:

&gt;<i> Thanks for your reply. Please see my response in red.
</I>&gt;<i>
</I>&gt;<i> On Fri, Jun 14, 2013 at 4:03 AM, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 13/06/13 20:41, Girish Gangadharan wrote:
</I>&gt;&gt;<i> &gt; For example, if a publisher writes a message to an exchange that ends
</I>&gt;&gt;<i> &gt; up in a specific queue bound to that exchange, it immediately shows
</I>&gt;&gt;<i> &gt; up in the same queue on the other node.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There is only one queue on one node in this case. The cluster offers a
</I>&gt;&gt;<i> consistent view of all resources in the cluster and allows producers and
</I>&gt;&gt;<i> consumers to connect to any node. Messages are transparently routed
</I>&gt;&gt;<i> across the cluster.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Does this mean that the queues actually exist only in one node to whose
</I>&gt;<i> exchange the message was originally written to? And the fact that I can see
</I>&gt;<i> them in the admin console of the other node is just to provide a consistent
</I>&gt;<i> view across the cluster? So any action that I do with the original queue on
</I>&gt;<i> the other nodes' admin consoles basically makes the changes to the queue on
</I>&gt;<i> the original node and not to the copy of that queue on the other nodes? In
</I>&gt;<i> fact, if I understand you correctly, there IS no copy of the queue on the
</I>&gt;<i> other nodes? Did I get that right?
</I>&gt;<i>
</I>&gt;<i> Not sure I understand the consistent view explanation either? What are the
</I>&gt;<i> main benefits of having multiple nodes in a cluster if they can't really
</I>&gt;<i> share anything? I would think Mirrored Queues should be an automatic
</I>&gt;<i> by-product of clustering, thus offering HA out of the box. Can you explain
</I>&gt;<i> to me why somebody would create a cluster of nodes and NOT have mirrored
</I>&gt;<i> queues set up?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; But then why does the article on Mirrored Queues say that *you have
</I>&gt;&gt;<i> &gt; to explicitly set up mirrored queues by policy*?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If a queue exists on only one node and that node crashes then the queue
</I>&gt;&gt;<i> becomes unavailable. Mirrored queues provides resilience by maintaining
</I>&gt;&gt;<i> copies of the queue that can take over in case a node crashes. See
</I>&gt;&gt;<i> <A HREF="http://www.rabbitmq.com/ha.html">http://www.rabbitmq.com/ha.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; So if one node goes down, the load balancer would automatically
</I>&gt;&gt;<i> &gt; redirect all the traffic just to the node that is up and running. And
</I>&gt;&gt;<i> &gt; the clients will not be affected. Would that work? Is that the
</I>&gt;&gt;<i> &gt; recommended approach?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is a common approach. Another is to provide clients with reconnect
</I>&gt;&gt;<i> logic that allows them to select the alternative node when one node
</I>&gt;&gt;<i> crashes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; I was thinking about using Shoveling technique to push messages from
</I>&gt;&gt;<i> &gt; a logical broker sitting on a cluster in our local HA servers to a
</I>&gt;&gt;<i> &gt; different logical broker to the DR server. In this case, a copy of
</I>&gt;&gt;<i> &gt; the messages will keep getting pumped into the DR with no clients
</I>&gt;&gt;<i> &gt; processing it. What will happen to those messages?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Nothing will happen to them. They will accumulate in the DR server
</I>&gt;&gt;<i> unless you take action to remove them, or unless they expire.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Should I have a workflow to go purge them every day manually or via a
</I>&gt;&gt;<i> &gt; script (after I make sure those messages aren't needed anymore since
</I>&gt;&gt;<i> &gt; the clients have already process them from the main HA cluster).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That depends on the specifics of your disaster scenario, your messaging
</I>&gt;&gt;<i> pattern and how you plan to switch over to your DR environment. Purging
</I>&gt;&gt;<i> queues after a day sounds reasonable.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; If the main HA cluster goes down and I have to bring the DR server into
</I>&gt;&gt;<i> &gt; action, what happens to the messages that did get processed already by
</I>&gt;&gt;<i> &gt; the clients? Should the clients have logic built in to ignore duplicates
</I>&gt;&gt;<i> &gt; to handle this specific scenario?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Performing deduplication in clients is probably the simplest solution,
</I>&gt;&gt;<i> or you could mirror the effects of consumers removing messages from
</I>&gt;&gt;<i> queues in your DR environment.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -Emile
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Jason McIntosh
<A HREF="http://mcintosh.poetshome.com/blog/">http://mcintosh.poetshome.com/blog/</A>
573-424-7612
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130616/fcc5c63d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130616/fcc5c63d/attachment.htm</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027899.html">[rabbitmq-discuss] Mirrored queues behind a load balancer
</A></li>
	<LI>Next message: <A HREF="027910.html">[rabbitmq-discuss] Mirrored queues behind a load balancer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27909">[ date ]</a>
              <a href="thread.html#27909">[ thread ]</a>
              <a href="subject.html#27909">[ subject ]</a>
              <a href="author.html#27909">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
