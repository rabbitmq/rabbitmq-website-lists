<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmq memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq%20memory%20usage&In-Reply-To=%3C51B0BF4B.5080909%40lshift.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027726.html">
   <LINK REL="Next"  HREF="027720.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmq memory usage</H1>
    <B>Ceri Storey</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq%20memory%20usage&In-Reply-To=%3C51B0BF4B.5080909%40lshift.net%3E"
       TITLE="[rabbitmq-discuss] rabbitmq memory usage">ceri at lshift.net
       </A><BR>
    <I>Thu Jun  6 17:56:43 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027726.html">[rabbitmq-discuss] rabbitmq memory usage
</A></li>
        <LI>Next message: <A HREF="027720.html">[rabbitmq-discuss] No rabbitmq_v3_1_1 tag in rabbitmq-stomp?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27730">[ date ]</a>
              <a href="thread.html#27730">[ thread ]</a>
              <a href="subject.html#27730">[ subject ]</a>
              <a href="author.html#27730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>(06/06/13 16:37), Sean Allen wrote:
&gt;<i> On Thu, Jun 6, 2013 at 10:03 AM, Ceri Storey &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ceri at lshift.net</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ceri at lshift.net</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     (06/06/13 14:45), Sean Allen wrote:
</I>&gt;<i>     &gt; I'm trying to understand memory usage in rabbitmq. Pointers to
</I>&gt;<i>     &gt; relevant docs, salient comments etc greatly welcomed. We have a
</I>&gt;<i>     number
</I>&gt;<i>     &gt; of batch jobs that are handled by one process putting
</I>&gt;<i>     information on a
</I>&gt;<i>     &gt; queue and then storm spouts read the info off and process. In
</I>&gt;<i>     the case
</I>&gt;<i>     &gt; of one job, we put about 5.9 million integers on a queue as
</I>&gt;<i>     individual
</I>&gt;<i>     &gt; messages and process. When those 5.9 go on, rabbitmq usage jumps
</I>&gt;<i>     up by
</I>&gt;<i>     &gt; about a gig.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; ....
</I>&gt;<i>     I'm sure that one of the Rabbit team themselves can shed a bit more
</I>&gt;<i>     light on this, but AIUI RabbitMQ uses ETS in-memory tables to
</I>&gt;<i>     index the
</I>&gt;<i>     queues, so with some back of the envelope arithmetic your rabbit is
</I>&gt;<i>     using approximately 175bytes per message. So on the face of it, that
</I>&gt;<i>     might look a bit odd, but doesn't seem unreasonable.
</I>&gt;<i>
</I>&gt;<i>     Are you seeing any concrete issues because of this, or are you more
</I>&gt;<i>     concerned about resource usage? Also, do you anticipate having to
</I>&gt;<i>     process batches many factors larger than that?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> We are adding more batch processes and with 2 gigs per node, we are
</I>&gt;<i> able to push past that.
</I>&gt;<i> So yes, that are some concerns there.
</I>Okay--so the biggest risk that I can foresee for rabbit itself Rabbit
will start hitting it's high watermark for memory usage, and start
exerting back-pressure by not reading from the socket. Once the storm
AMQP spout has drained enough messages from the queue, Rabbit's memory
usage will drop, and start reading from publishers once again.

So, the question in my mind, would be how well the publishing
applications deals with the back pressure; if it will just wait blocking
on the socket, you should be fine. Assuming that the spout continuously
consumes messages, I don't /believe/ there would be a problem; but it'll
be worth checking that the heartbeat period is longer than it takes for
rabbit to unblock connections and process the buffered data. (Rabbit
logs to rabbit.log when it hits and clears the high water mark alarms).

I'd be tempted to stress test the whole setup, and see how far you can
push it before it breaks bearing in mind the above caveats.

Hopefully that's of some use, at least.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130606/26a019b4/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130606/26a019b4/attachment.htm</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027726.html">[rabbitmq-discuss] rabbitmq memory usage
</A></li>
	<LI>Next message: <A HREF="027720.html">[rabbitmq-discuss] No rabbitmq_v3_1_1 tag in rabbitmq-stomp?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27730">[ date ]</a>
              <a href="thread.html#27730">[ thread ]</a>
              <a href="subject.html#27730">[ subject ]</a>
              <a href="author.html#27730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
