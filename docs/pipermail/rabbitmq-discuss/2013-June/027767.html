<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Persistent queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Persistent%20queues&In-Reply-To=%3C51B1F5EA.7080602%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027763.html">
   <LINK REL="Next"  HREF="027773.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Persistent queues</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Persistent%20queues&In-Reply-To=%3C51B1F5EA.7080602%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Persistent queues">simon at rabbitmq.com
       </A><BR>
    <I>Fri Jun  7 16:02:02 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027763.html">[rabbitmq-discuss] Persistent queues
</A></li>
        <LI>Next message: <A HREF="027773.html">[rabbitmq-discuss] Persistent queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27767">[ date ]</a>
              <a href="thread.html#27767">[ thread ]</a>
              <a href="subject.html#27767">[ subject ]</a>
              <a href="author.html#27767">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/06/13 15:12, Marc Labbe wrote:
&gt;<i> Hi guys,
</I>
Hi.

&gt;<i> From what I (believe I) saw and read, I really expected Rabbit to route
</I>&gt;<i> messages and physically save them to disk for each of the consumers to
</I>&gt;<i> read (1 queue/consumer, 1msg copy/queue). The reason I expected that is
</I>&gt;<i> because if messages are ack'ed by consumers 1 and 2, I expected their
</I>&gt;<i> queue to be free of their messages while consumer 3 would still need
</I>&gt;<i> them to be persisted until it has read them. That was possible a false
</I>&gt;<i> assumption I should have verified with you guys. It would indeed be more
</I>&gt;<i> optimal to store a single copy of the messages and only keep the
</I>&gt;<i> metadata. *Is this correct?*
</I>
Yes. The message (properties and body) is persisted once for all queues; 
the metadata (location in queue and whether the message is out for 
delivery) is duplicated across all queues.

(Minor exception: dead-lettering a message creates a new copy, breaking 
this property.)

&gt;<i> Also, during a test where I continuously sent (a lot) of messages while
</I>&gt;<i> my big consumer 3 was offline. The observation I made then is that
</I>&gt;<i> _obviously:_
</I>&gt;<i> - data was accumulating on disk
</I>&gt;<i> - memory usage on all nodes went up. to the point where it eventually
</I>&gt;<i> choked the brokers
</I>&gt;<i>
</I>&gt;<i> I assumed then that the increasing memory usage was because the queue
</I>&gt;<i> and msg metadata was increasing in Mnesia. This was a decisive factor to
</I>&gt;<i> me because I didn't want to be in a situation where my realtime
</I>&gt;<i> consumers would be affected by a slow moving elephant. Is there way I
</I>&gt;<i> could have avoided that situation I didn't see?
</I>
Technically queue contents are not held in Mnesia but that's a side issue.

The default message store index has a per-message in-memory cost of ~160 
bytes (again, not per queue). The message store index is pluggable and 
can be replaced, there's an implementation based on Tokyo Cabinet which 
has no memory cost per message. But it's not part of the default 
distribution of RabbitMQ making it rather fiddlier to install.

If you are prepared to lose the messages that are unconsumed by your 
elephant, <A HREF="http://www.rabbitmq.com/ttl.html">http://www.rabbitmq.com/ttl.html</A> might be another answer.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027763.html">[rabbitmq-discuss] Persistent queues
</A></li>
	<LI>Next message: <A HREF="027773.html">[rabbitmq-discuss] Persistent queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27767">[ date ]</a>
              <a href="thread.html#27767">[ thread ]</a>
              <a href="subject.html#27767">[ subject ]</a>
              <a href="author.html#27767">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
