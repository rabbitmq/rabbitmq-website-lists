<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Getting many messages,	ack() failing if total messages not equal a 10 increment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Getting%20many%20messages%2C%0A%09ack%28%29%20failing%20if%20total%20messages%20not%20equal%20a%2010%20increment&In-Reply-To=%3C76DAD01F-1549-42E0-B09C-D10B78B9BA3E%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028034.html">
   <LINK REL="Next"  HREF="028035.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Getting many messages,	ack() failing if total messages not equal a 10 increment</H1>
    <B>Ask Solem</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Getting%20many%20messages%2C%0A%09ack%28%29%20failing%20if%20total%20messages%20not%20equal%20a%2010%20increment&In-Reply-To=%3C76DAD01F-1549-42E0-B09C-D10B78B9BA3E%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Getting many messages,	ack() failing if total messages not equal a 10 increment">ask at rabbitmq.com
       </A><BR>
    <I>Fri Jun 28 12:28:05 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028034.html">[rabbitmq-discuss] Getting many messages, ack() failing if total messages not equal a 10 increment
</A></li>
        <LI>Next message: <A HREF="028035.html">[rabbitmq-discuss] RabbitMQ in Depth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28168">[ date ]</a>
              <a href="thread.html#28168">[ thread ]</a>
              <a href="subject.html#28168">[ subject ]</a>
              <a href="author.html#28168">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Jun 22, 2013, at 3:32 PM, Matthew Taft &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthewetaft at gmail.com</A>&gt; wrote:

&gt;<i> Hi everyone,
</I>&gt;<i> 
</I>&gt;<i> Hoping someone can help me with this problem.  After going through a few tutorials, I've pieced together some code the produce and consume messages.  I'm using kombu.  I'lll past the code below.  But the idea is to be able to send many messages to the queue, possibly hundreds, then have a periodic task that wakes up and consumes all messages.  Right now I haven't set up the periodic task.  It's just a simply python file.  When passed &quot;produce,&quot; it produces some random messages.  When passed &quot;consume,&quot; it consumes them.
</I>&gt;<i> 
</I>&gt;<i> I've found that when the total messages is in increments of 10 (90, 100, 510, etc.), all messages get processed correctly and the qsize value shows there are 0 messages remaining.  However -- and this is better explained by example - if the queue contains 78 messages, after processing all of them, the queue reports 8 remaining, but the consumer can no longer get them (times out).  Any time the total qsize at the start is anything other than a 10 increment (129, 523, 234, etc.), the part beyond the latest 10 increment is left remaining (9, 3, 4, etc.). 
</I>&gt;<i> 
</I>&gt;<i> I've added some print statements to confirm that each message is actually consumed correctly, and the ack() is being called for each one.  However, I noticed that the qsize value is only being updated every 10 messages.  Here's the log for some of them to give you a better idea. The first number is the counter.  It's shown three times for each message because I'm printing before the get, after the get, then after the ack().  Notice the qsize value only updates every 10 messages:
</I>&gt;<i> 
</I>&gt;<i> Is it just some configuration I have to set?  Or is there something wrong in the code?  Here's the code in full:
</I>&gt;<i> 
</I>
Welcome Matthew!

It reports correctly for me here:

from kombu import Connection

def get(q):
   for i in range(1000):
       print(len(q))
       m = q.get()
       m.ack()

def put(q):
   for i in range(1000):
       q.put('hello')

if __name__ = '__main__'
   conn = Connection('<A HREF="amqp://'">amqp://'</A>)
   q = conn.SimpleQueue('squ')
   q.channel.basic_qos(prefetch_count=1)
   put(q)
   get(q)


If you change the prefetch count it may skip numbers, but it always decreases.


Maybe you have a left-over consumer still running that you did not terminate correctly?
Take a look at the consumer count by running the command:

 rabbitmqctl list_queues -p $your_vhost name consumers


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028034.html">[rabbitmq-discuss] Getting many messages, ack() failing if total messages not equal a 10 increment
</A></li>
	<LI>Next message: <A HREF="028035.html">[rabbitmq-discuss] RabbitMQ in Depth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28168">[ date ]</a>
              <a href="thread.html#28168">[ thread ]</a>
              <a href="subject.html#28168">[ subject ]</a>
              <a href="author.html#28168">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
