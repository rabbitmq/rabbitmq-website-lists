<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Possible process leak in RabbitMQ server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Possible%20process%20leak%20in%20RabbitMQ%20server&In-Reply-To=%3C4BF5E4C0-D560-47C7-8643-2AF3D1780658%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027696.html">
   <LINK REL="Next"  HREF="027701.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Possible process leak in RabbitMQ server</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Possible%20process%20leak%20in%20RabbitMQ%20server&In-Reply-To=%3C4BF5E4C0-D560-47C7-8643-2AF3D1780658%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Possible process leak in RabbitMQ server">tim at rabbitmq.com
       </A><BR>
    <I>Fri Jun  7 11:20:06 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027696.html">[rabbitmq-discuss] Possible process leak in RabbitMQ server
</A></li>
        <LI>Next message: <A HREF="027701.html">[rabbitmq-discuss] Acknowledging messages across the federation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27757">[ date ]</a>
              <a href="thread.html#27757">[ thread ]</a>
              <a href="subject.html#27757">[ subject ]</a>
              <a href="author.html#27757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Daniel,

On 5 Jun 2013, at 17:00, Daniel Luna wrote:
&gt;<i> We are experiencing a growth of processes in the rabbitmq server for long running connections.  I have no idea if we are doing something wrong or if this is a bug in rabbitmq itself.
</I>&gt;<i> 
</I>&gt;<i> In an idle system we have about 30k connections to rabbitmq, using around 31k channels.
</I>&gt;<i> 
</I>&gt;<i> Sockets and file descriptors match more or less one-to-one to the connections and so does the number of Erlang processes initally.  My problem here is that the number of Erlang processes is steadily growing.
</I>&gt;<i> 
</I>
There should be quite a few more Erlang processes than there are connections + channels. For each connection, for example, there will be more than one process (i.e., a reader plus a writer). For each queue there will be a process, and so on.

&gt;<i> At the moment we have ~500k Erlang processes in our rabbitmq server with 47k connections using 54k channels.  As soon as the load on our system lightens up the number of connections and channels will go down as expected, but the number of processes will stay high.
</I>&gt;<i> 
</I>
That figure doesn't necessarily look wrong, given the 47k connections require a reader and a writer process, plus all the channels, plus a process per queue, plus various other system processes, supervisors, mirror queue masters/coordinators/slaves, and so on. It might be a little high, but the key point is whether or not the process count goes down as the load lightens, which you're saying it doesn't.

Do note that processes associated with a client, i.e., related to connections and channels, won't necessarily die immediately upon client disconnect. It will depend on how the disconnect occurs, and various other factors.

&gt;<i> Restarting the client will drop the process count, so this is something related to keeping long living connections and/or channels around.
</I>&gt;<i> 
</I>
Possibly. I'm not saying &quot;nothing's wrong&quot;, but as you've mentioned below, a bit more research is a good idea.

&gt;<i> Oh, yeah, upgrading from 2.8.2 to 3.1.1 made no difference.
</I>&gt;<i> 
</I>&gt;<i> Connection counts are steady as are channel counts (i.e. they grow and shrink as expected depending on load).  We use both a polling and a subscribing pattern depending on the particular consumer.  I've seen a system with all empty queues have this issue so it's not based on that either.
</I>&gt;<i> 
</I>&gt;<i> I'm suspecting that there's a missing exit that leaves a dangling processes for some sort of operation. It's something that's properly linked with the connection (or channel) though since they go away on connection restart.
</I>&gt;<i> 
</I>
That seems unlikely. Can you tell us a bit more about your system? Are you clustered? Are you running any plugins? How many queues are there? How are you counting the number of Erlang processes? Anything interesting in the logs? The output of `rabbitmqctl report' on each node would be useful. Which client libraries are you using? Are we talking just AMQP connections, or other things (such as STOMP, MQTT, etc) as well? 

&gt;<i> I'll research some more and see what I can dig up.
</I>&gt;<i> 
</I>
Thanks for that. The more info the better.

&gt;<i> Help would be appreciated.
</I>&gt;<i> 
</I>
If we're leaking processes, then we definitely want to know. I suspect not, but the more info you can provide the better.

Cheers,
Tim


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027696.html">[rabbitmq-discuss] Possible process leak in RabbitMQ server
</A></li>
	<LI>Next message: <A HREF="027701.html">[rabbitmq-discuss] Acknowledging messages across the federation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27757">[ date ]</a>
              <a href="thread.html#27757">[ thread ]</a>
              <a href="subject.html#27757">[ subject ]</a>
              <a href="author.html#27757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
