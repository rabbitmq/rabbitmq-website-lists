<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mnesia Corruption Bug
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mnesia%20Corruption%20Bug&In-Reply-To=%3C2fb2deb0-748b-46a0-b9b2-05b3688c9bf7%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027862.html">
   <LINK REL="Next"  HREF="027860.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mnesia Corruption Bug</H1>
    <B>Lee Hambley</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mnesia%20Corruption%20Bug&In-Reply-To=%3C2fb2deb0-748b-46a0-b9b2-05b3688c9bf7%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Mnesia Corruption Bug">lee.hambley at gmail.com
       </A><BR>
    <I>Thu Jun 13 12:36:04 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027862.html">[rabbitmq-discuss] 3.1.1 High watermark permanent blocking
</A></li>
        <LI>Next message: <A HREF="027860.html">[rabbitmq-discuss] Mnesia Corruption Bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27858">[ date ]</a>
              <a href="thread.html#27858">[ thread ]</a>
              <a href="subject.html#27858">[ subject ]</a>
              <a href="author.html#27858">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Posting this to the list after some discussion on IRC with bob2351 on 
irc.freenode.net.

We have a *slightly* strange situation with using RabbitMQ, we start it 
under `runit`, and it effectively believes that it's running in the 
foreground. I have anecdotal evidence that this causes other problems, but 
at least not anything that hurts too often (i.e you lose &quot;persistent 
messages&quot; in this setup)

That all aside, attached ( <A HREF="https://gist.github.com/leehambley/5773039">https://gist.github.com/leehambley/5773039</A> ) is 
a stacktrace from a problematic box, we couldn't get it to recover (single 
node, single replica, etc, etc) - we simply deleted the mnesia database, 
which worked well enough.

Some information about our environment:

$ erl --version
Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:8:8] [rq:8] 
[async-threads:0] [kernel-poll:false]
$ dpkg --list | grep rabbit
ii  rabbitmq-server     3.0.4-1     AMQP server written in Erlang
$ sudo RABBITMQ_NODENAME=ourproject rabbitmqctl status
Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ourproject at carla</A> ...
[{pid,8055},
 {running_applications,
     [{rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;3.0.4&quot;},
      {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;3.0.4&quot;},
      {rabbit,&quot;RabbitMQ&quot;,&quot;3.0.4&quot;},
      {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.7&quot;},
      {rabbitmq_web_dispatch,&quot;RabbitMQ Web Dispatcher&quot;,&quot;3.0.4&quot;},
      {webmachine,&quot;webmachine&quot;,&quot;1.9.1-rmq3.0.4-git52e62bc&quot;},
      {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;2.3.1-rmq3.0.4-gitd541e9a&quot;},
      {xmerl,&quot;XML parser&quot;,&quot;1.2.10&quot;},
      {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.7.1&quot;},
      {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.5&quot;},
      {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;3.0.4&quot;},
      {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.10&quot;},
      {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.17.5&quot;},
      {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.14.5&quot;}]},
 {os,{unix,linux}},
 {erlang_version,
     &quot;Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:8:8] [rq:8] 
[async-threads:30] [kernel-poll:true]\n&quot;},
 {memory,
     [{total,33984216},
      {connection_procs,756760},
      {queue_procs,325576},
      {plugins,218728},
      {other_proc,9518440},
      {mnesia,93728},
      {mgmt_db,148472},
      {msg_index,71528},
      {other_ets,1145600},
      {binary,604208},
      {code,17266925},
      {atom,1550457},
      {other_system,2283794}]},
 {vm_memory_high_watermark,0.4},
 {vm_memory_limit,6656894566},
 {disk_free_limit,1000000000},
 {disk_free,11247643770880},
 {file_descriptors,
     [{total_limit,924},
      {total_used,23},
      {sockets_limit,829},
      {sockets_used,12}]},
 {processes,[{limit,1048576},{used,345}]},
 {run_queue,0},
 {uptime,2692}]
...done.


I believe this bug is already being tracked internally, and I post the 
report here in the hope that I'll have a place to attach a snapshot of an 
mnesia database the next time this happens to us, or that someone else 
might find this report and be able to contribute. Finally, selfishly, in 
the hope that I'll get notified when this gets fixed, and I upgrade, and 
sleep at night again.

- Lee Hambley
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130613/b70dd7e6/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130613/b70dd7e6/attachment.htm</A>&gt;
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027862.html">[rabbitmq-discuss] 3.1.1 High watermark permanent blocking
</A></li>
	<LI>Next message: <A HREF="027860.html">[rabbitmq-discuss] Mnesia Corruption Bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27858">[ date ]</a>
              <a href="thread.html#27858">[ thread ]</a>
              <a href="subject.html#27858">[ subject ]</a>
              <a href="author.html#27858">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
