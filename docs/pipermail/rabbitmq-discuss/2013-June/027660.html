<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%203.1.0%20lost%20messages%20and%20autoheal%0A%20failures%20when%20recovering%20from%20cluster%20partition&In-Reply-To=%3C7F7BFE76D0F5234F9258D88C37C9EC6B15205E9A%40VALVCSMBX002PH.val.vlss.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027650.html">
   <LINK REL="Next"  HREF="027663.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition</H1>
    <B>Maslinski, Ray</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%203.1.0%20lost%20messages%20and%20autoheal%0A%20failures%20when%20recovering%20from%20cluster%20partition&In-Reply-To=%3C7F7BFE76D0F5234F9258D88C37C9EC6B15205E9A%40VALVCSMBX002PH.val.vlss.local%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition">MaslinskiR at valassis.com
       </A><BR>
    <I>Mon Jun  3 14:01:54 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027650.html">[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
</A></li>
        <LI>Next message: <A HREF="027663.html">[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27660">[ date ]</a>
              <a href="thread.html#27660">[ thread ]</a>
              <a href="subject.html#27660">[ subject ]</a>
              <a href="author.html#27660">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>For this particular test, I was trying to gain some insight as to the behavior of the cluster while the partition was in effect, so the partition wasn't resolved until the test was completed or aborted.  My general expectation was that both sides of the partition would begin to process messages more or less normally once the cluster connection timed out and the slave promoted itself to master, possibly with some glitches such as dropped messages during the transition.  The slow trickle of messages delivered on one of the existing connections was unexpected, and seemed to be a bit of an anomaly when combined with the growing count of unacked messages shown on the console.

Ray Maslinski
Senior Software Developer, Engineering
Valassis / Digital Media
Cell: 585.330.2426
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">maslinskir at valassis.com</A>
www.valassis.com

Creating the future of intelligent media delivery to drive your greatest success

_____________________________________________________________________________

This message may include proprietary or protected information. If you are not the intended&#160;
recipient, please notify me, delete this message and do not further communicate the information&#160;
contained herein without my express consent.

-----Original Message-----
From: Simon MacMullen [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>] 
Sent: Monday, June 03, 2013 6:37 AM
To: Maslinski, Ray
Cc: Discussions about RabbitMQ
Subject: Re: [rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition

Just to be clear - at what point in this test are you unblocking the connection so the partition can heal?

Cheers, Simon

On 31/05/13 20:04, Maslinski, Ray wrote:
&gt;<i> The net_ticktime is using the default value, and event sequence seems 
</I>&gt;<i> consistent with the associated timeout.
</I>&gt;<i>
</I>&gt;<i> Roughly,
</I>&gt;<i>
</I>&gt;<i> Start test
</I>&gt;<i>
</I>&gt;<i> Block cluster connection at some point -&gt; trace data shows that only 
</I>&gt;<i> publish events are occurring after this happens
</I>&gt;<i>
</I>&gt;<i> After a bit more than a minute, RabbitMQ server log shows lost cluster 
</I>&gt;<i> connection on both nodes, along with the death of the mirrors and 
</I>&gt;<i> promotion of slave to master.
</I>&gt;<i>
</I>&gt;<i> Test continues and completes publish phase, since these appeared to be 
</I>&gt;<i> progressing normally, with no errors visible to client
</I>&gt;<i>
</I>&gt;<i> Test then starts to verify that all messages were received by polling 
</I>&gt;<i> the contents of a buffer used to store incoming messages.  In a normal 
</I>&gt;<i> scenario without faults, this generally means that the first poll 
</I>&gt;<i> finds all the messages expected to be present and test completes 
</I>&gt;<i> successfully.  Otherwise, the poll rechecks for any missing messages 
</I>&gt;<i> once per second, and gives up if 30 seconds elapse without any new 
</I>&gt;<i> messages showing up (timer is reset if any messages arrived during 
</I>&gt;<i> polling window).
</I>&gt;<i>
</I>&gt;<i> The slow trickle of messages occurs during the last phase, as one 
</I>&gt;<i> appears to arrive every 14 seconds and the polling loop continues to 
</I>&gt;<i> retry.  Trace data doesn't appear to log any deliver events during 
</I>&gt;<i> this stage, but console shows a slow increment in the number of 
</I>&gt;<i> unacknowledged messages that lines up with the delivery rate observed 
</I>&gt;<i> by the client.
</I>&gt;<i>
</I>&gt;<i> Ray Maslinski Senior Software Developer, Engineering Valassis / 
</I>&gt;<i> Digital Media Cell: 585.330.2426 <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">maslinskir at valassis.com</A> 
</I>&gt;<i> www.valassis.com
</I>&gt;<i>
</I>&gt;<i> Creating the future of intelligent media delivery to drive your 
</I>&gt;<i> greatest success
</I>&gt;<i>
</I>&gt;<i> ______________________________________________________________________
</I>&gt;<i> _______
</I>&gt;<i>
</I>&gt;<i>  This message may include proprietary or protected information. If you 
</I>&gt;<i> are not the intended recipient, please notify me, delete this message 
</I>&gt;<i> and do not further communicate the information contained herein 
</I>&gt;<i> without my express consent.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original Message----- From: Simon MacMullen 
</I>&gt;<i> [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>] Sent: Friday, May 31, 2013 12:33 PM To:
</I>&gt;<i> Maslinski, Ray Cc: Discussions about RabbitMQ Subject: Re:
</I>&gt;<i> [rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures 
</I>&gt;<i> when recovering from cluster partition
</I>&gt;<i>
</I>&gt;<i> Hi. The behaviour you describe doesn't really match what I would 
</I>&gt;<i> expect to see. In the beginning of a partition I would expect:
</I>&gt;<i>
</I>&gt;<i> 1) Partition starts
</I>&gt;<i>
</I>&gt;<i> 2) Things behave slowly for approximately net_ticktime (see
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/partitions.html#net_ticktime">http://www.rabbitmq.com/partitions.html#net_ticktime</A>) as nodes attempt 
</I>&gt;<i> to contact each other and time out
</I>&gt;<i>
</I>&gt;<i> 3) On each node, Erlang decides the other nodes are down. Things speed 
</I>&gt;<i> up again, HA queues fail over. Split-brain has begun.
</I>&gt;<i>
</I>&gt;<i> It sounds like you were stuck in 2) for an extended period of time.
</I>&gt;<i> Have you changed net_ticktime?
</I>&gt;<i>
</I>&gt;<i> Alternatively, when testing partitions I have see really odd behaviour 
</I>&gt;<i> by blocking network traffic in one direction only with iptables. You 
</I>&gt;<i> might want to check if you've done that by mistake.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> On 30/05/13 22:14, Maslinski, Ray wrote:
</I>&gt;&gt;<i> Follow-up question ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried some experiments to gain some understanding of how the 
</I>&gt;&gt;<i> cluster behaved with clients attached during a network partition 
</I>&gt;&gt;<i> event. Essentially, I repeated the previous tests described below for 
</I>&gt;&gt;<i> autohealing and automatic queue synchronization, but left the cluster 
</I>&gt;&gt;<i> communications port blocked while the client test completed. One 
</I>&gt;&gt;<i> oddity I noticed was that while the consumer connected to the slave 
</I>&gt;&gt;<i> appeared to receive an indication that something was amiss (client 
</I>&gt;&gt;<i> log showed a consumer cancel exception being handled by the Spring 
</I>&gt;&gt;<i> AMQP framework, and other monitoring logs appeared to show the client 
</I>&gt;&gt;<i> restarting a connection, which seems to be consistent with 
</I>&gt;&gt;<i> documentation), the consumer connected to the master seemed to remain 
</I>&gt;&gt;<i> oblivious to any possible issues.
</I>&gt;&gt;<i> That consumer continued to receive messages, but at an extremely slow 
</I>&gt;&gt;<i> rate (test published at 16/sec fixed rate, but the remaining consumer 
</I>&gt;&gt;<i> began to receive messages at the rate of about 1 every 14 seconds).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Since the test client waits around for expected message deliveries 
</I>&gt;&gt;<i> with a resettable 30 second timeout, it continued to run for an 
</I>&gt;&gt;<i> extended period of time (longer than I waited around for).  In 
</I>&gt;&gt;<i> addition, the admin console showed a relatively small number of 
</I>&gt;&gt;<i> unacked messages on that server, with the unacked count increasing 
</I>&gt;&gt;<i> with each actual delivery (client should always be acknowledging in 
</I>&gt;&gt;<i> the test setup, and reported no errors).  Eventually unblocking the 
</I>&gt;&gt;<i> cluster port released a bunch of messages in a short interval (albeit 
</I>&gt;&gt;<i> with some lost, as described previously).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I also saw  producer connections go into flow control during the 
</I>&gt;&gt;<i> outage and remain there during the slow consumer delivery (though the 
</I>&gt;&gt;<i> test had long since completed delivering all its messages).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does this sound like expected behavior during a partition?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ray Maslinski Senior Software Developer, Engineering Valassis / 
</I>&gt;&gt;<i> Digital Media Cell: 585.330.2426 <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">maslinskir at valassis.com</A> 
</I>&gt;&gt;<i> www.valassis.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Creating the future of intelligent media delivery to drive your 
</I>&gt;&gt;<i> greatest success
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _____________________________________________________________________
</I>&gt;&gt;<i> _
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>_______
&gt;&gt;<i>
</I>&gt;&gt;<i> This message may include proprietary or protected information. If you 
</I>&gt;&gt;<i> are not the intended recipient, please notify me, delete this message 
</I>&gt;&gt;<i> and do not further communicate the information contained herein 
</I>&gt;&gt;<i> without my express consent.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Original Message----- From: Simon MacMullen 
</I>&gt;&gt;<i> [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>] Sent: Monday, May 20, 2013 6:30 AM To:
</I>&gt;&gt;<i> Discussions about RabbitMQ Cc: Maslinski, Ray Subject: Re:
</I>&gt;&gt;<i> [rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures 
</I>&gt;&gt;<i> when recovering from cluster partition
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 17/05/13 20:38, Maslinski, Ray wrote:
</I>&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi!
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> To simulate a network partition failure, I've been using iptables to 
</I>&gt;&gt;&gt;<i> temporarily block inbound and outbound access on one of the nodes to 
</I>&gt;&gt;&gt;<i> the single port configured for cluster communications through 
</I>&gt;&gt;&gt;<i> inet_dist_listen_min and inet_dist_listen_max settings (min = max). 
</I>&gt;&gt;&gt;<i> Client access is not blocked during a simulated partition fault.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sounds reasonable.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've observed two anomalies during testing that I wasn't expecting 
</I>&gt;&gt;&gt;<i> based on the documentation I've read:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -At a sufficiently high message rate, some number of messages will 
</I>&gt;&gt;&gt;<i> be lost during the fault sequence, with the number lost tending to 
</I>&gt;&gt;&gt;<i> increase with message rate.  No indication of a send error has been 
</I>&gt;&gt;&gt;<i> observed by the client program. Based on results obtained from test 
</I>&gt;&gt;&gt;<i> logs and an independent monitor listening on trace messages from 
</I>&gt;&gt;&gt;<i> each node, it appears that as soon as the port is blocked, both 
</I>&gt;&gt;&gt;<i> nodes continue to accept published messages, but (temporarily) stop 
</I>&gt;&gt;&gt;<i> delivering messages until the cluster heartbeat failure is detected, 
</I>&gt;&gt;&gt;<i> at which point the cluster is partitioned and the slave promotes 
</I>&gt;&gt;&gt;<i> itself to become master. In the sequences I've looked at, the 
</I>&gt;&gt;&gt;<i> messages that are lost all appear to be published to the original 
</I>&gt;&gt;&gt;<i> master (and final master after a winner is selected during 
</I>&gt;&gt;&gt;<i> autoheal). Neither the start nor the end of the lost message window 
</I>&gt;&gt;&gt;<i> appear to line up with any events in the logs, other than the start 
</I>&gt;&gt;&gt;<i> occurring sometime after the port connection is blocked but before 
</I>&gt;&gt;&gt;<i> the cluster heartbeat failure is detected, and the end occurring 
</I>&gt;&gt;&gt;<i> sometime after the detection of the cluster heartbeat failure and 
</I>&gt;&gt;&gt;<i> before the detection of the partitioned cluster after the connection 
</I>&gt;&gt;&gt;<i> is unblocked.  Is message loss to be expected in this scenario?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would expect to see message loss in a cluster heal scenario.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It's important to remember that a cluster partition is still a 
</I>&gt;&gt;<i> substantial problem, and the healing process involves throwing state 
</I>&gt;&gt;<i> away. Autoheal mode just means you get through this process faster, 
</I>&gt;&gt;<i> and hopefully spend much less time accepting messages that will end 
</I>&gt;&gt;<i> up being lost.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would expect intuitively that only messages from the losing 
</I>&gt;&gt;<i> partitions would be lost. But I am not entirely surprised if messages 
</I>&gt;&gt;<i> from the winner are lost too; there is a period after the partitions 
</I>&gt;&gt;<i> have come back together but before autoheal kicks in during which we 
</I>&gt;&gt;<i> will have multiple masters for a queue, and behaviour can be 
</I>&gt;&gt;<i> unpredictable.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -Occasionally the autoheal loser node fails to rejoin the cluster 
</I>&gt;&gt;&gt;<i> after restart.  I don't have a lot of data points on this one since 
</I>&gt;&gt;&gt;<i> it's only happened a handful of times during overnight test 
</I>&gt;&gt;&gt;<i> iterations.  During one failure, the autoheal winner showed the log 
</I>&gt;&gt;&gt;<i> message below during recovery:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ah, that looks like a bug in autoheal. I think the stack trace you 
</I>&gt;&gt;<i> posted should contain enough information to fix it. Thanks.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -- Simon MacMullen RabbitMQ, Pivotal
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -- Simon MacMullen RabbitMQ, Pivotal
</I>&gt;<i>
</I>

--
Simon MacMullen
RabbitMQ, Pivotal
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027650.html">[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
</A></li>
	<LI>Next message: <A HREF="027663.html">[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27660">[ date ]</a>
              <a href="thread.html#27660">[ thread ]</a>
              <a href="subject.html#27660">[ subject ]</a>
              <a href="author.html#27660">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
