<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Possible memory leak in the management plugin
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Possible%20memory%20leak%20in%20the%20management%20plugin&In-Reply-To=%3CCACCscvw1HiPiqxUgjPyvXJR8t_WQc%3DHG-EhfKe8vJ8dEq0tdTQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027922.html">
   <LINK REL="Next"  HREF="027934.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Possible memory leak in the management plugin</H1>
    <B>Travis Mehlinger</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Possible%20memory%20leak%20in%20the%20management%20plugin&In-Reply-To=%3CCACCscvw1HiPiqxUgjPyvXJR8t_WQc%3DHG-EhfKe8vJ8dEq0tdTQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Possible memory leak in the management plugin">tmehlinger at gmail.com
       </A><BR>
    <I>Mon Jun 17 20:08:10 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027922.html">[rabbitmq-discuss] Possible memory leak in the management plugin
</A></li>
        <LI>Next message: <A HREF="027934.html">[rabbitmq-discuss] Possible memory leak in the management plugin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27923">[ date ]</a>
              <a href="thread.html#27923">[ thread ]</a>
              <a href="subject.html#27923">[ subject ]</a>
              <a href="author.html#27923">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simon,

I have more information for you. It turns out I hadn't fully understood the
interaction causing this to happen.

Aside from their regular communication, our services also declare a queue
bound on # to an exchange that we use for collecting stats the services
store internally. In addition to hitting the REST API for information about
the broker, the monitor also opens a connection/channel, declares an
anonymous queue for itself, then sends a message indicating to our services
that they should respond with their statistics. The services then send a
message with a routing key that will direct the response onto the queue
declared by the monitor. This happens every five seconds.

It appears that this is in fact responsible for memory consumption growing
out of control. If I disable that aspect of monitoring and leave the REST
API monitor up, memory consumption stays level.

The problem seems reminiscent of the issues described in this mailing list
thread:
<A HREF="http://rabbitmq.1065348.n5.nabble.com/RabbitMQ-Queues-memory-leak-td25813.html.">http://rabbitmq.1065348.n5.nabble.com/RabbitMQ-Queues-memory-leak-td25813.html.</A>
However, the queues we declare for stats collection are *not* mirrored.

Hope that helps narrow things down. :)

Best, Travis


On Mon, Jun 17, 2013 at 12:58 PM, Travis Mehlinger &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tmehlinger at gmail.com</A>&gt;wrote:

&gt;<i> Hi Simon,
</I>&gt;<i>
</I>&gt;<i> I flipped our monitor back on and let Rabbit consume some additional
</I>&gt;<i> memory. Invoking the garbage collector had no impact.
</I>&gt;<i>
</I>&gt;<i> Let me know what further information you'd like to see and I'll be happy
</I>&gt;<i> to provide it.
</I>&gt;<i>
</I>&gt;<i> Thanks, Travis
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Jun 17, 2013 at 10:32 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 17/06/13 15:45, Travis Mehlinger wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi Simon,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks for getting back to me. I'll need to restart our monitor and give
</I>&gt;&gt;&gt;<i> it some time to leak the memory. I'll let you know the results sometime
</I>&gt;&gt;&gt;<i> later today.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> One thing I failed to mention in my initial report: whenever we
</I>&gt;&gt;&gt;<i> restarted one of our services, the queues they were using would get
</I>&gt;&gt;&gt;<i> cleaned up (we have them set to auto-delete) and redeclared. Whenever we
</I>&gt;&gt;&gt;<i> did that, we would see the memory consumption of the management DB fall
</I>&gt;&gt;&gt;<i> off sharply before starting to rise again.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is presumably because the historical data the management plugin has
</I>&gt;&gt;<i> been retaining for those queues got thrown away. If you don't want to
</I>&gt;&gt;<i> retain this data at all, change the configuration as documented here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://www.rabbitmq.com/**management.html#sample-**retention&lt;http://www.rabbitmq.com/management.html#sample-retention">http://www.rabbitmq.com/**management.html#sample-**retention&lt;http://www.rabbitmq.com/management.html#sample-retention</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, I (currently) don't believe it's this historical data you are
</I>&gt;&gt;<i> seeing as &quot;leaking&quot; since making queries should not cause any more of it to
</I>&gt;&gt;<i> be retained.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  Let me know if you'd like any further information in the meantime.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Best, Travis
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Mon, Jun 17, 2013 at 6:39 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Hi. Thanks for the report.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     My first guess is that garbage collection for the management DB
</I>&gt;&gt;&gt;<i>     process is happening too slowly. Can you invoke:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     $ rabbitmqctl eval
</I>&gt;&gt;&gt;<i>     'P=global:whereis_name(rabbit_**__mgmt_db),M1=process_info(P,
</I>&gt;&gt;&gt;<i>     memory),garbage_collect(P),M2=**__process_info(P,
</I>&gt;&gt;&gt;<i>     memory),{M1,M2,rabbit_vm:__**memory()}.'
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     and post the results?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Cheers, Simon
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     On 15/06/13 03:09, Travis Mehlinger wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         We recently upgraded RabbitMQ from 3.0.4 to 3.1.1 after noticing
</I>&gt;&gt;&gt;<i>         two bug
</I>&gt;&gt;&gt;<i>         fixes in 3.1.0 related to our RabbitMQ deployment:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>            * 25524 fix memory leak in mirror queue slave with many
</I>&gt;&gt;&gt;<i>         short-lived
</I>&gt;&gt;&gt;<i>              publishing channel
</I>&gt;&gt;&gt;<i>            * 25290 fix per-queue memory leak recording stats for mirror
</I>&gt;&gt;&gt;<i>         queue slaves
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         However, in our case, it seems that the management plugin may
</I>&gt;&gt;&gt;<i>         still have
</I>&gt;&gt;&gt;<i>         a memory leak. We have a monitoring agent that hits the REST API
</I>&gt;&gt;&gt;<i> to
</I>&gt;&gt;&gt;<i>         gather information about the broker (number of queues, queue
</I>&gt;&gt;&gt;<i> depth,
</I>&gt;&gt;&gt;<i>         etc.). With the monitoring agent running and making requests
</I>&gt;&gt;&gt;<i>         against the
</I>&gt;&gt;&gt;<i>         API, memory consumption steadily increased; when we stopped the
</I>&gt;&gt;&gt;<i>         agent,
</I>&gt;&gt;&gt;<i>         memory consumption in the management plugin leveled off.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         Here a couple graphs detailing memory consumption in the broker
</I>&gt;&gt;&gt;<i> (the
</I>&gt;&gt;&gt;<i>         figures are parsed from rabbitmqctl report). The first graph
</I>&gt;&gt;&gt;<i>         shows the
</I>&gt;&gt;&gt;<i>         ebb and flow of memory consumption in a number of components and
</I>&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;<i>         second shows just consumption by the management plugin. You can
</I>&gt;&gt;&gt;<i> see
</I>&gt;&gt;&gt;<i>         pretty clearly where we stopped the monitoring agent at 1:20.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         <A HREF="https://dl.dropboxusercontent.**__com/u/7022167/Screenshots/n-**">https://dl.dropboxusercontent.**__com/u/7022167/Screenshots/n-**</A>
</I>&gt;&gt;&gt;<i> __np6obt-m9f.png
</I>&gt;&gt;&gt;<i>         &lt;<A HREF="https://dl.**dropboxusercontent.com/u/**">https://dl.**dropboxusercontent.com/u/**</A>
</I>&gt;&gt;&gt;<i> 7022167/Screenshots/n-np6obt-**m9f.png&lt;<A HREF="https://dl.dropboxusercontent.com/u/7022167/Screenshots/n-np6obt-m9f.png">https://dl.dropboxusercontent.com/u/7022167/Screenshots/n-np6obt-m9f.png</A>&gt;
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i>         <A HREF="https://dl.dropboxusercontent.**__com/u/7022167/Screenshots/__**">https://dl.dropboxusercontent.**__com/u/7022167/Screenshots/__**</A>
</I>&gt;&gt;&gt;<i> an6dpup33xvx.png
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         &lt;<A HREF="https://dl.**dropboxusercontent.com/u/**7022167/Screenshots/**">https://dl.**dropboxusercontent.com/u/**7022167/Screenshots/**</A>
</I>&gt;&gt;&gt;<i> an6dpup33xvx.png&lt;<A HREF="https://dl.dropboxusercontent.com/u/7022167/Screenshots/an6dpup33xvx.png">https://dl.dropboxusercontent.com/u/7022167/Screenshots/an6dpup33xvx.png</A>&gt;
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         We have two clustered brokers, both running RabbitMQ 3.1.1 on
</I>&gt;&gt;&gt;<i> Erlang
</I>&gt;&gt;&gt;<i>         R14B-04.1. There are typically around 200 queues, about 20 of
</I>&gt;&gt;&gt;<i>         which are
</I>&gt;&gt;&gt;<i>         mirrored. There are generally about 200 consumers. Messages are
</I>&gt;&gt;&gt;<i>         rarely
</I>&gt;&gt;&gt;<i>         queued and most queues typically sit idle.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         I'll be happy to provide any further diagnostic information.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         Thanks!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         ______________________________**___________________
</I>&gt;&gt;&gt;<i>         rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.__rabbi</A>**tmq.com &lt;<A HREF="http://rabbitmq.com">http://rabbitmq.com</A>&gt;
</I>&gt;&gt;&gt;<i>         &lt;mailto:rabbitmq-discuss@**lists.rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i>         <A HREF="https://lists.rabbitmq.com/__**cgi-bin/mailman/listinfo/__**">https://lists.rabbitmq.com/__**cgi-bin/mailman/listinfo/__**</A>
</I>&gt;&gt;&gt;<i> rabbitmq-discuss&lt;<A HREF="https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss">https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss</A>&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         &lt;<A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**</A>
</I>&gt;&gt;&gt;<i> rabbitmq-discuss&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     --
</I>&gt;&gt;&gt;<i>     Simon MacMullen
</I>&gt;&gt;&gt;<i>     RabbitMQ, Pivotal
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Simon MacMullen
</I>&gt;&gt;<i> RabbitMQ, Pivotal
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130617/91da6640/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130617/91da6640/attachment.htm</A>&gt;
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027922.html">[rabbitmq-discuss] Possible memory leak in the management plugin
</A></li>
	<LI>Next message: <A HREF="027934.html">[rabbitmq-discuss] Possible memory leak in the management plugin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27923">[ date ]</a>
              <a href="thread.html#27923">[ thread ]</a>
              <a href="subject.html#27923">[ subject ]</a>
              <a href="author.html#27923">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
