<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mnesia Corruption Bug
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mnesia%20Corruption%20Bug&In-Reply-To=%3C51B9BFE6.4010300%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027858.html">
   <LINK REL="Next"  HREF="027972.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mnesia Corruption Bug</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mnesia%20Corruption%20Bug&In-Reply-To=%3C51B9BFE6.4010300%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Mnesia Corruption Bug">simon at rabbitmq.com
       </A><BR>
    <I>Thu Jun 13 13:49:42 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027858.html">[rabbitmq-discuss] Mnesia Corruption Bug
</A></li>
        <LI>Next message: <A HREF="027972.html">[rabbitmq-discuss] Mnesia Corruption Bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27860">[ date ]</a>
              <a href="thread.html#27860">[ thread ]</a>
              <a href="subject.html#27860">[ subject ]</a>
              <a href="author.html#27860">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Lee. I would be interested to know how you got the machine into that 
state.

There is a bug with a similar stack trace that will be fixed in the next 
release - but I don't think it's the same bug. In your case we are 
seeing a message which has been published and delivered according to the 
queue index, but only published (and not delivered) according to the 
queue index's journal. As the journal should always record the same 
state or newer as the main index, this should be impossible.

So to eliminate obvious causes of weirdness first: are you usuing an 
unusual filesystem, or mounting the filesystem with unusual options?

Cheers, Simon

On 13/06/13 12:36, Lee Hambley wrote:
&gt;<i> Posting this to the list after some discussion on IRC with bob2351 on
</I>&gt;<i> irc.freenode.net.
</I>&gt;<i>
</I>&gt;<i> We have a *slightly* strange situation with using RabbitMQ, we start it
</I>&gt;<i> under `runit`, and it effectively believes that it's running in the
</I>&gt;<i> foreground. I have anecdotal evidence that this causes other problems,
</I>&gt;<i> but at least not anything that hurts too often (i.e you lose &quot;persistent
</I>&gt;<i> messages&quot; in this setup)
</I>&gt;<i>
</I>&gt;<i> That all aside, attached ( <A HREF="https://gist.github.com/leehambley/5773039">https://gist.github.com/leehambley/5773039</A> )
</I>&gt;<i> is a stacktrace from a problematic box, we couldn't get it to recover
</I>&gt;<i> (single node, single replica, etc, etc) - we simply deleted the mnesia
</I>&gt;<i> database, which worked well enough.
</I>&gt;<i>
</I>&gt;<i> Some information about our environment:
</I>&gt;<i>
</I>&gt;<i>     $ erl --version
</I>&gt;<i>     Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:8:8] [rq:8]
</I>&gt;<i>     [async-threads:0] [kernel-poll:false]
</I>&gt;<i>     $ dpkg --list | grep rabbit
</I>&gt;<i>     ii  rabbitmq-server     3.0.4-1     AMQP server written in Erlang
</I>&gt;<i>     $ sudo RABBITMQ_NODENAME=ourproject rabbitmqctl status
</I>&gt;<i>     Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ourproject at carla</A> ...
</I>&gt;<i>     [{pid,8055},
</I>&gt;<i>       {running_applications,
</I>&gt;<i>           [{rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;3.0.4&quot;},
</I>&gt;<i>            {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;3.0.4&quot;},
</I>&gt;<i>            {rabbit,&quot;RabbitMQ&quot;,&quot;3.0.4&quot;},
</I>&gt;<i>            {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.7&quot;},
</I>&gt;<i>            {rabbitmq_web_dispatch,&quot;RabbitMQ Web Dispatcher&quot;,&quot;3.0.4&quot;},
</I>&gt;<i>            {webmachine,&quot;webmachine&quot;,&quot;1.9.1-rmq3.0.4-git52e62bc&quot;},
</I>&gt;<i>            {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;2.3.1-rmq3.0.4-gitd541e9a&quot;},
</I>&gt;<i>            {xmerl,&quot;XML parser&quot;,&quot;1.2.10&quot;},
</I>&gt;<i>            {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.7.1&quot;},
</I>&gt;<i>            {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.5&quot;},
</I>&gt;<i>            {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;3.0.4&quot;},
</I>&gt;<i>            {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.10&quot;},
</I>&gt;<i>            {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.17.5&quot;},
</I>&gt;<i>            {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.14.5&quot;}]},
</I>&gt;<i>       {os,{unix,linux}},
</I>&gt;<i>       {erlang_version,
</I>&gt;<i>           &quot;Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:8:8] [rq:8]
</I>&gt;<i>     [async-threads:30] [kernel-poll:true]\n&quot;},
</I>&gt;<i>       {memory,
</I>&gt;<i>           [{total,33984216},
</I>&gt;<i>            {connection_procs,756760},
</I>&gt;<i>            {queue_procs,325576},
</I>&gt;<i>            {plugins,218728},
</I>&gt;<i>            {other_proc,9518440},
</I>&gt;<i>            {mnesia,93728},
</I>&gt;<i>            {mgmt_db,148472},
</I>&gt;<i>            {msg_index,71528},
</I>&gt;<i>            {other_ets,1145600},
</I>&gt;<i>            {binary,604208},
</I>&gt;<i>            {code,17266925},
</I>&gt;<i>            {atom,1550457},
</I>&gt;<i>            {other_system,2283794}]},
</I>&gt;<i>       {vm_memory_high_watermark,0.4},
</I>&gt;<i>       {vm_memory_limit,6656894566},
</I>&gt;<i>       {disk_free_limit,1000000000},
</I>&gt;<i>       {disk_free,11247643770880},
</I>&gt;<i>       {file_descriptors,
</I>&gt;<i>           [{total_limit,924},
</I>&gt;<i>            {total_used,23},
</I>&gt;<i>            {sockets_limit,829},
</I>&gt;<i>            {sockets_used,12}]},
</I>&gt;<i>       {processes,[{limit,1048576},{used,345}]},
</I>&gt;<i>       {run_queue,0},
</I>&gt;<i>       {uptime,2692}]
</I>&gt;<i>     ...done.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I believe this bug is already being tracked internally, and I post the
</I>&gt;<i> report here in the hope that I'll have a place to attach a snapshot of
</I>&gt;<i> an mnesia database the next time this happens to us, or that someone
</I>&gt;<i> else might find this report and be able to contribute. Finally,
</I>&gt;<i> selfishly, in the hope that I'll get notified when this gets fixed, and
</I>&gt;<i> I upgrade, and sleep at night again.
</I>&gt;<i>
</I>&gt;<i> - Lee Hambley
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027858.html">[rabbitmq-discuss] Mnesia Corruption Bug
</A></li>
	<LI>Next message: <A HREF="027972.html">[rabbitmq-discuss] Mnesia Corruption Bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27860">[ date ]</a>
              <a href="thread.html#27860">[ thread ]</a>
              <a href="subject.html#27860">[ subject ]</a>
              <a href="author.html#27860">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
