<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Robust zone-aware topology?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Robust%20zone-aware%20topology%3F&In-Reply-To=%3C1393539431.9325.YahooMailNeo%40web160802.mail.bf1.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034236.html">
   <LINK REL="Next"  HREF="034225.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Robust zone-aware topology?</H1>
    <B>Mordy Ovits</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Robust%20zone-aware%20topology%3F&In-Reply-To=%3C1393539431.9325.YahooMailNeo%40web160802.mail.bf1.yahoo.com%3E"
       TITLE="[rabbitmq-discuss] Robust zone-aware topology?">mordyovits at yahoo.com
       </A><BR>
    <I>Thu Feb 27 22:17:11 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034236.html">[rabbitmq-discuss] How to restrict to one connection per same	user at a time and same routing key ?
</A></li>
        <LI>Next message: <A HREF="034225.html">[rabbitmq-discuss] Robust zone-aware topology?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34224">[ date ]</a>
              <a href="thread.html#34224">[ thread ]</a>
              <a href="subject.html#34224">[ subject ]</a>
              <a href="author.html#34224">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm new to rabbitmq and would appreciate some feedback on a design.

I'm looking to create a robust topology for routing messages in a zone-aware way.&#160; I'd like messages to be sent to a &quot;zone&quot; and be handled by zone-local machines reading from a queue in that zone.&#160; In case all the consumers in a zone are down, consumers in another zone become eligible to consume the messages.&#160; If the consumers in the first zone come back, messages to the zone resume routing to the now-up consumers.&#160; Messages should never go to more than one queue, but a rare lost message isn't the end of the world.&#160; IOW, I'd prefer for the machines local to a zone handle the messages in that zone, but if they can't, then another zone can do it until that zone's consumers recover.

The solution I came up with depends on RabbitMQ's alternate-exchange feature.&#160; I create (say) 3 exchanges, each with an a-e of another. E.g.:
X: new_york (a-e: miami)
X: miami (a-e: new_york)
X: london (a-e: new_york)

There is one queue per exchange, direct binding, with auto_delete true.&#160; Consumers in a zone all read only from that one queue.&#160; Since the queue is auto_delete, if no consumer is bound to the (by-design-only) queue in that zone's exchange, the exchange sends its messages to its a-e.

I've tested this and it works.&#160; I can bring consumers up and down in the zone and the locality of message routing is maintained where possible and returns at recovery. However, I have some questions. 

1) Is there a better way to do this?&#160; It seems odd to need a rabbitmq extension, so I'm suspicious I'm missing something basic.&#160; Maybe with federation or shovel?&#160; Keep in mind that a message should only go to one queue.

2) Do I have to worry about a-e routing loops?&#160; The documentation implies it's ok, but doesn't spell it out.&#160; If I have an alternate-exchange path of &quot;a -&gt; b -&gt; c -&gt; a&quot; could it go haywire when all the queues go down?&#160; The (one-hop) testing I did seemed to handle it, but I'd like a clearer understanding of how rabbitmq prevents a-e routing loops.

3) How can I isolate the concerns of producers from the HA topology?&#160; I'd prefer if the producers didn't have to know about the HA nature of the exchange, so that I can change it independent of them (i.e. change the a-e parameter).&#160; However, the &quot;identity&quot; of an exchange in terms of the test for its preexistence in the declare seems to include every parameter, including the a-e setting.&#160; Therefore, producers get failure on their exchange_declare if their zone's exchange details aren't completely identical, but I might have 5 producers managed by three groups.&#160; I might be able to manually manage the creation of exchanges and have the producers use but not declare them, but perhaps there's a cleaner way that I don't know.

Thanks,
Mordy

</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034236.html">[rabbitmq-discuss] How to restrict to one connection per same	user at a time and same routing key ?
</A></li>
	<LI>Next message: <A HREF="034225.html">[rabbitmq-discuss] Robust zone-aware topology?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34224">[ date ]</a>
              <a href="thread.html#34224">[ thread ]</a>
              <a href="subject.html#34224">[ subject ]</a>
              <a href="author.html#34224">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
