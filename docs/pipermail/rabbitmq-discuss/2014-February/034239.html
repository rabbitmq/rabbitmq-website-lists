<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problem with c# client ModelBase.ConfirmSelect()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20c%23%20client%20ModelBase.ConfirmSelect%28%29&In-Reply-To=%3C5A1884FA08C6B74D8D1B5F047268FF1F2A4170DD%40exchange2%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034237.html">
   <LINK REL="Next"  HREF="034240.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problem with c# client ModelBase.ConfirmSelect()</H1>
    <B>Robert Higgins</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20c%23%20client%20ModelBase.ConfirmSelect%28%29&In-Reply-To=%3C5A1884FA08C6B74D8D1B5F047268FF1F2A4170DD%40exchange2%3E"
       TITLE="[rabbitmq-discuss] Problem with c# client ModelBase.ConfirmSelect()">RHi at np6.com
       </A><BR>
    <I>Fri Feb 28 10:07:16 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034237.html">[rabbitmq-discuss] Federation queues: original routing key of	message
</A></li>
        <LI>Next message: <A HREF="034240.html">[rabbitmq-discuss] Problem with c# client	ModelBase.ConfirmSelect()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34239">[ date ]</a>
              <a href="thread.html#34239">[ thread ]</a>
              <a href="subject.html#34239">[ subject ]</a>
              <a href="author.html#34239">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I've encountered a problem with confirmed publishes in the c# client library. Basically, you cannot enable publish confirms via ConfirmSelect() more than one time on the same channel. If you do, you risk losing track of the publish acknowledgements.

Why you would want to call ConfirmSelect() more than once is another question, however as there is no error raised and this limitation is not documented, I'd consider it a bug.

The channel uses a counter m_nextPubSeqNo to identify published messages and store them as unconfirmed. The server acknowledges the published messages using the same identifier and this permits the channel to confirm delivery.

However, ModelBase.ConfirmSelect() sets m_nextPubSeqNo to 1 regardless of whether the channel has already had confirms enabled by a previous call to ConfirmSelect(). On the server side this sequence counter is not reset. The two become desynchronised and acknowledgements arrive that do not correspond to the messages published. Functions like WaitForConfirms() wait forever as messages are never confirmed.

After comparing the implementation of the java client, there is definitely a divergence of behaviour between the two. In the java client nextPublishSeqNo is set to 1 only if it was previously 0. In the c# client, no such test is made.

ModelBase.cs:
   973         public void ConfirmSelect()
   974         {
   975             m_nextPubSeqNo = 1;
   976             _Private_ConfirmSelect(false);
   977         }

ChannelN.java:
  1054     public Confirm.SelectOk confirmSelect()
  1055         throws IOException
  1056     {
  1057         if (nextPublishSeqNo == 0) nextPublishSeqNo = 1;
  1058         return (Confirm.SelectOk)
  1059             exnWrappingRpc(new Confirm.Select(false)).getMethod();
  1060 
  1061     }

A correction of this behaviour would be trivial, I hope my description has helped!

Regards

Cordialement,
Robert Higgins
Ing&#233;nieur R&amp;D

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rhi at np6.com</A>
 
Tel :  +33 (0)5 57 92 41 21
Fax :  +33 (0)5 57 92 07 17

www.np6.com




Bordeaux
32 av Canteranne&#160;
33600 Pessac&#160;
T. 05 57 92 41 21
Paris
131 bd S&#233;bastopol
75002 Paris
T. 01 75 43 76 10
London
58 Broadwick Street
London W1F 7AL&#160;
T. +44 207 434 7383&#160;



</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034237.html">[rabbitmq-discuss] Federation queues: original routing key of	message
</A></li>
	<LI>Next message: <A HREF="034240.html">[rabbitmq-discuss] Problem with c# client	ModelBase.ConfirmSelect()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34239">[ date ]</a>
              <a href="thread.html#34239">[ thread ]</a>
              <a href="subject.html#34239">[ subject ]</a>
              <a href="author.html#34239">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
