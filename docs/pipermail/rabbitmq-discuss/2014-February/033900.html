<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] amqp_connection:open_channel link channel
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20amqp_connection%3Aopen_channel%20link%20channel&In-Reply-To=%3Cldtg4m%24sf7%241%40ger.gmane.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033895.html">
   <LINK REL="Next"  HREF="033859.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] amqp_connection:open_channel link channel</H1>
    <B>Matwey V. Kornilov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20amqp_connection%3Aopen_channel%20link%20channel&In-Reply-To=%3Cldtg4m%24sf7%241%40ger.gmane.org%3E"
       TITLE="[rabbitmq-discuss] amqp_connection:open_channel link channel">matwey.kornilov at gmail.com
       </A><BR>
    <I>Mon Feb 17 17:16:19 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="033895.html">[rabbitmq-discuss] amqp_connection:open_channel link channel
</A></li>
        <LI>Next message: <A HREF="033859.html">[rabbitmq-discuss] Management API hangs after upgrade from 3.1.5 to	3.2.3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33900">[ date ]</a>
              <a href="thread.html#33900">[ thread ]</a>
              <a href="subject.html#33900">[ subject ]</a>
              <a href="author.html#33900">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>17.02.2014 17:02, Tim Watson &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> On 16 Feb 2014, at 18:08, Matwey V. Kornilov wrote:
</I>&gt;&gt;<i> Is it a good practice to link the channel to the process going to consume the messages? I do want to close the channel when my consumer crashed, and let the broker to redeliver unacked message.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> {ok, Channel} = amqp_connection:open_channel(Connection),
</I>&gt;&gt;<i> link(Channel),
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why there is no open_channel_link counterpart, as start and start_link?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The reason is that there is a level of indirection between the channel process(es) and the process that calls open channel, i.e., the channel process is linked to an internal supervisor process, not to the process that calls open_channel. Probably the easiest way to achieve what you want is to open the channel in your process' initialisation phase and close it during the shutdown phase. If your consumer is built on one of the OTP behaviours (such as gen_server) then you can open and close the channel in the respective init/1 and terminate/2 callbacks. HTH!
</I>
To use terminate, I have not to forget trap_exit and not brutal_kill in 
supervisor.

&gt;<i>
</I>&gt;&gt;<i> This is for case when channel goes down between open_channel and link.
</I>&gt;<i>
</I>&gt;<i> Indeed, that's a different problem to closing the channel if/when your consumer crashes. The easiest way might seem at first, to use a monitor instead of linking, guaranteeing a 'DOWN' message even if the monitor-ee was dead when the monitor was established. Personally however, I'd suggest looking at the amqp_gen_consumer behaviour instead, since that defines a terminate/2 callback which behaves as follows (from the edocs):
</I>&gt;<i>
</I>&gt;<i>       %% This callback is invoked by the channel after it has shut down and
</I>&gt;<i>       %% just before its process exits.
</I>
amqp_direct_consumer exits gracefully when my consumer process dies, but 
it leads to whole connection and all other channels crash.

I want to close the one specific channel, when my corresponding consumer 
process dies or exits. And vice versa, when channel is dead, my consumer 
process have to shutdown and to be restarted (and reopen new channel) by 
supervisor.


</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033895.html">[rabbitmq-discuss] amqp_connection:open_channel link channel
</A></li>
	<LI>Next message: <A HREF="033859.html">[rabbitmq-discuss] Management API hangs after upgrade from 3.1.5 to	3.2.3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33900">[ date ]</a>
              <a href="thread.html#33900">[ thread ]</a>
              <a href="subject.html#33900">[ subject ]</a>
              <a href="author.html#33900">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
