<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] problem seen with multiple listeners on a single	reply queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20seen%20with%20multiple%20listeners%20on%20a%20single%0A%09reply%20queue&In-Reply-To=%3CCABCvSHB7W7POP2VC8unrs2By69X0NVuHxQiv4mYSsqaXYX8U6Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033599.html">
   <LINK REL="Next"  HREF="033601.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] problem seen with multiple listeners on a single	reply queue</H1>
    <B>TaraGopi N</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20seen%20with%20multiple%20listeners%20on%20a%20single%0A%09reply%20queue&In-Reply-To=%3CCABCvSHB7W7POP2VC8unrs2By69X0NVuHxQiv4mYSsqaXYX8U6Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] problem seen with multiple listeners on a single	reply queue">tgv812 at gmail.com
       </A><BR>
    <I>Wed Feb  5 22:08:43 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="033599.html">[rabbitmq-discuss] Federation with multiple uri's?
</A></li>
        <LI>Next message: <A HREF="033601.html">[rabbitmq-discuss] RabbitMQ management down after cluster issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33600">[ date ]</a>
              <a href="thread.html#33600">[ thread ]</a>
              <a href="subject.html#33600">[ subject ]</a>
              <a href="author.html#33600">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi
We are beginners in rabbitmq. We use rabbitmq 3.2.2. I recently observed an
issue with multiple listeners on the same reply queue when performance
testing
our application written in Java.

Here is the test scenario:
50 Concurrent users post a request to Service F to create an entity A. The
message contains a user id and a timestamp. Each concurrent user posts
roughly two messages per second.

F publishes this message to a non-durable queue via a topic exchange (using
convertSendAndReceive) and waits for the response on a fixed reply queue
ReplyQ1.

Service A picks up this message and creates this entity (basically an entry
in a table) after
validating that the user id wihin that message is valid.

For the validation, Service A sends this message to another non-durable
queue via a topic exchange (convertSendAndReceive) and waits for a response
on
another fixed reply queue, ReplyQ2.

A validating service V picks up this user id, validates it (basically a
select from a db table) and then sends the response back to ReplyQ2.
Service A picks this up, based on the message, creates the entity and then
sends response to ReplyQ1.

CreateEntity A Request -&gt; Service F -&gt; Q1 -&gt; Service A -&gt; Q2 - Service V
Service V-&gt; ReplyQ2 -&gt; Service A (creates entity A if user valid) -&gt;
ReplyQ1 -&gt; Service F

F, A and V all live within the same tomcat instance. When a second tomcat
instance was started with service A and V, I started to notice warning
messages in tomcat logs:

WARN : org.springframework.amqp.rabbit.core.RabbitTemplate - Reply received
after timeout for b3fd4f57-0403-4704-8f16-8c3055ca0cd9

It looked like messages were not picked up by the correct listener from the
validation response queues.

Response times were high for this create Entity A request (10 seconds) and
only about 5 transactions were processed per second. Tests were run in AWS
on m1.large instances.
High response time was not caused by network latency. network latency was
really small

On testing with separate reply queues for the user id validation response,
(ReplyQ21 and ReplyQ22 instead of ReplyQ2), response times improved (1
second) and more transactions (roughly 70) were processed per second.

Is this a good design approach for this scenario? Or is there a better way
to handle this ?

All messages are non-persistent. No concurrency or prefetch settings
configured on the listeners. Please let me know if you need any other
information.

Thanks.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140205/42110461/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140205/42110461/attachment.html</A>&gt;
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033599.html">[rabbitmq-discuss] Federation with multiple uri's?
</A></li>
	<LI>Next message: <A HREF="033601.html">[rabbitmq-discuss] RabbitMQ management down after cluster issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33600">[ date ]</a>
              <a href="thread.html#33600">[ thread ]</a>
              <a href="subject.html#33600">[ subject ]</a>
              <a href="author.html#33600">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
