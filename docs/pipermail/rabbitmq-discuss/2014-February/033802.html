<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [rabbitmq-c-master] memory leakinkg while	reconnect.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5Brabbitmq-c-master%5D%20memory%20leakinkg%20while%0A%09reconnect.&In-Reply-To=%3CCAAt2poJrXzjz3UjzuNkGPRQ8fTWBzKej%2BbLKxTZqNpA6rqU%2BQg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033794.html">
   <LINK REL="Next"  HREF="033823.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [rabbitmq-c-master] memory leakinkg while	reconnect.</H1>
    <B>Alan Antonuk</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5Brabbitmq-c-master%5D%20memory%20leakinkg%20while%0A%09reconnect.&In-Reply-To=%3CCAAt2poJrXzjz3UjzuNkGPRQ8fTWBzKej%2BbLKxTZqNpA6rqU%2BQg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] [rabbitmq-c-master] memory leakinkg while	reconnect.">alan.antonuk at gmail.com
       </A><BR>
    <I>Thu Feb 13 16:07:32 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="033794.html">[rabbitmq-discuss] [rabbitmq-c-master] memory leakinkg while	reconnect.
</A></li>
        <LI>Next message: <A HREF="033823.html">[rabbitmq-discuss] [rabbitmq-c-master] memory leakinkg while	reconnect.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33802">[ date ]</a>
              <a href="thread.html#33802">[ thread ]</a>
              <a href="subject.html#33802">[ subject ]</a>
              <a href="author.html#33802">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Rohit;


On Thu, Feb 13, 2014 at 7:05 AM, Rohit Patle
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">Rohit.Patle at techmahindra.com</A>&gt;wrote:

&gt;<i>  Hi Alan,
</I>&gt;<i>
</I>&gt;<i> As suggested by you I run our code with Valgrind and also with GDB bellow
</I>&gt;<i> is the outcome for your reference.
</I>&gt;<i>
</I>
For your valgrind run could you modify your program to exit the program
after doing a couple runs of your loop (instead of using ^C to break out of
the program)? The leak that valgrind is showing is because the program is
being terminated in the middle of the loop, so the amqp_connection_state_t
object isn't freed.

When I tried to reproduce your situation last night by repeatedly failing
to connect to a broker in a tight loop (you should really consider having
some kind of exponential back-off or a limit on the number of retries in
this case too...) I was unable to reproduce the runaway memory consumption
you were seeing.


&gt;<i> From GDB outcome I can see that the Segmentation fault occurs due to non
</I>&gt;<i> availability of malloc_consolidate in malloc.c also I am not able to find
</I>&gt;<i> the file in my downloaded rabbitmq-c-master package.
</I>&gt;<i>
</I>
malloc.c is part of the C standard library, probably glibc. The fact that
gdb cannot find is is not surprising (and not really of too much concern in
this case - gdb is just looking for it to print out the line that thinks
the segfault occurred on). The segfault however is concerning - when you
get these you should do a 'bt' command in gdb which will give you a
backtrace. Its easier to then to figure out what call into malloc() or
free() is causing the error.

-Alan


&gt;<i> Please suggest.
</I>&gt;<i>
</I>&gt;<i> ========================= Valgrind ======================
</I>&gt;<i> ==6778==
</I>&gt;<i> ==6778== Process terminating with default action of signal 2 (SIGINT)
</I>&gt;<i> ==6778==    at 0x414D311: connect (socket.S:64)
</I>&gt;<i> ==6778==    by 0x69682E30: ???
</I>&gt;<i> ==6778==
</I>&gt;<i> ==6778== HEAP SUMMARY:
</I>&gt;<i> ==6778==     in use at exit: 667,319 bytes in 3,295 blocks
</I>&gt;<i> ==6778==   total heap usage: 4,393 allocs, 1,098 frees, 789,240 bytes
</I>&gt;<i> allocated
</I>&gt;<i> ==6778==
</I>&gt;<i> ==6778== Searching for pointers to 3,295 not-freed blocks
</I>&gt;<i> ==6778== Checked 206,660 bytes
</I>&gt;<i> ==6778==
</I>&gt;<i> ==6778== 414,730 (344 direct, 414,386 indirect) bytes in 2 blocks are
</I>&gt;<i> definitely lost in loss record 378 of 378
</I>&gt;<i> ==6778==    at 0x402A5E6: calloc (in
</I>&gt;<i> /usr/lib/valgrind/vgpreload_memcheck-x86-linux.so)
</I>&gt;<i> ==6778==    by 0x404C623: amqp_new_connection (amqp_connection.c:68)
</I>&gt;<i> ==6778==    by 0x40754D2: (below main) (libc-start.c:226)
</I>&gt;<i> ==6778==
</I>&gt;<i> ==6778== LEAK SUMMARY:
</I>&gt;<i> ==6778==    definitely lost: 344 bytes in 2 blocks
</I>&gt;<i> ==6778==    indirectly lost: 414,386 bytes in 372 blocks
</I>&gt;<i> ==6778==      possibly lost: 0 bytes in 0 blocks
</I>&gt;<i> ==6778==    still reachable: 252,589 bytes in 2,921 blocks
</I>&gt;<i> ==6778==         suppressed: 0 bytes in 0 blocks
</I>&gt;<i> ==6778== Reachable blocks (those to which a pointer was found) are not
</I>&gt;<i> shown.
</I>&gt;<i> ==6778== To see them, rerun with: --leak-check=full --show-reachable=yes
</I>&gt;<i> ==6778==
</I>&gt;<i> ==6778== Use --track-origins=yes to see where uninitialised values come
</I>&gt;<i> from
</I>&gt;<i> ==6778== ERROR SUMMARY: 7 errors from 2 contexts (suppressed: 0 from 0)
</I>&gt;<i> ==6778==
</I>&gt;<i> ==6778== 6 errors in context 1 of 2:
</I>&gt;<i> ==6778== Conditional jump or move depends on uninitialised value(s)
</I>&gt;<i> ==6778==    at 0x4346494: ASN1_STRING_set (asn1_lib.c:382)
</I>&gt;<i> ==6778==    by 0x432FF02: ASN1_mbstring_ncopy (a_mbstr.c:204)
</I>&gt;<i> ==6778==    by 0x433018A: ASN1_mbstring_copy (a_mbstr.c:86)
</I>&gt;<i> ==6778==    by 0x4331258: ASN1_STRING_to_UTF8 (a_strex.c:570)
</I>&gt;<i> ==6778==    by 0x4332F0B: x509_name_canon (x_name.c:408)
</I>&gt;<i> ==6778==    by 0x43335BF: x509_name_ex_d2i (x_name.c:210)
</I>&gt;<i> ==6778==    by 0x433B017: ASN1_item_ex_d2i (tasn_dec.c:239)
</I>&gt;<i> ==6778==    by 0x433BD9E: asn1_template_noexp_d2i (tasn_dec.c:746)
</I>&gt;<i> ==6778==
</I>&gt;<i> ==6778== ERROR SUMMARY: 7 errors from 2 contexts (suppressed: 0 from 0)
</I>&gt;<i> ===============================END==================
</I>&gt;<i>
</I>&gt;<i> GDB outcome:
</I>&gt;<i>
</I>&gt;<i> ========================== GDB =======================
</I>&gt;<i> Using host libthread_db library &quot;/lib/i386-linux-gnu/libthread_db.so.1&quot;.
</I>&gt;<i> creating connection
</I>&gt;<i> opening SSL/TLS connection
</I>&gt;<i>
</I>&gt;<i> Program received signal SIGSEGV, Segmentation fault.
</I>&gt;<i> 0xb7e80175 in malloc_consolidate (av=0xb7fb0440) at malloc.c:4278
</I>&gt;<i> 4278    malloc.c: No such file or directory.
</I>&gt;<i> (gdb) n
</I>&gt;<i> =====================================================
</I>&gt;<i>
</I>&gt;<i> Thanks &amp; Regards,
</I>&gt;<i> Rohit
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> DISCLAIMER:
</I>&gt;<i> This email (including any attachments) is intended for the sole use of the
</I>&gt;<i> intended recipient/s and may contain material that is CONFIDENTIAL AND
</I>&gt;<i> PRIVATE COMPANY INFORMATION. Any review or reliance by others or copying or
</I>&gt;<i> distribution or forwarding of any or all of the contents in this message is
</I>&gt;<i> STRICTLY PROHIBITED. If you are not the intended recipient, please contact
</I>&gt;<i> the sender by email and delete all copies; your cooperation in this regard
</I>&gt;<i> is appreciated.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140213/52e7cb25/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140213/52e7cb25/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033794.html">[rabbitmq-discuss] [rabbitmq-c-master] memory leakinkg while	reconnect.
</A></li>
	<LI>Next message: <A HREF="033823.html">[rabbitmq-discuss] [rabbitmq-c-master] memory leakinkg while	reconnect.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33802">[ date ]</a>
              <a href="thread.html#33802">[ thread ]</a>
              <a href="subject.html#33802">[ subject ]</a>
              <a href="author.html#33802">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
