<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Unexaplainable behaviour with shovel plugin.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unexaplainable%20behaviour%20with%20shovel%20plugin.&In-Reply-To=%3C530F2996.1090605%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034155.html">
   <LINK REL="Next"  HREF="034200.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Unexaplainable behaviour with shovel plugin.</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unexaplainable%20behaviour%20with%20shovel%20plugin.&In-Reply-To=%3C530F2996.1090605%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Unexaplainable behaviour with shovel plugin.">simon at rabbitmq.com
       </A><BR>
    <I>Thu Feb 27 12:03:34 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034155.html">[rabbitmq-discuss] Unexaplainable behaviour with shovel plugin.
</A></li>
        <LI>Next message: <A HREF="034200.html">[rabbitmq-discuss] Unexaplainable behaviour with shovel plugin.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34199">[ date ]</a>
              <a href="thread.html#34199">[ thread ]</a>
              <a href="subject.html#34199">[ subject ]</a>
              <a href="author.html#34199">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/02/14 08:57, Claire Fautsch wrote:
&gt;<i> Hello,
</I>
Hi!

&gt;<i> This leads to the fact, that we have on the destination servers a total
</I>&gt;<i> of two hanful of messages that are not yet confirmed, however on the
</I>&gt;<i> source servers we have millions of messages that are waiting for
</I>&gt;<i> confirmation (acknowledgement)
</I>&gt;<i>
</I>&gt;<i> We would expect with some threshold that
</I>&gt;<i> delivery rate on source = publish rate on destination (which is the case)
</I>&gt;<i> confirm rate on destination = acknowledge rate on source (which shows
</I>&gt;<i> considerable difference)
</I>&gt;<i>
</I>&gt;<i> Does anyone have an idea or suggestion what could be the reason for
</I>&gt;<i> this? Is it a bad idea to have load balancer as destination in the
</I>&gt;<i> shovel, or should that work fine? Network issue?
</I>
I doubt the load balancer is the problem. I think I have a reasonable 
idea where the problem lies.

The issue is that the shovel does not enforce any form of flow control 
other than (optionally) using prefetch limiting, which you are not using.

So your source servers are delivering messages into the shovel as fast 
as they can, and your destination servers are accepting messages as fast 
as *they* can, but they are ending up being a bit slower. Nothing is 
creating any back pressure on the source servers, and so messages are 
queuing up inside the shovel. Since you are using on_confirm ack mode, 
these show as unacknowledged messages on the source.

&gt;<i> Here some more details on our shovel setup:
</I>&gt;<i> ack_mode=on_confirm
</I>&gt;<i> prefetch_count=0 (default)
</I>&gt;<i> reconnect_delay=5
</I>
I suspect that if you set prefetch_count to some high-but-not-insane 
number (exactly how high depends on your message size + rate but I might 
start the bidding at 1,000) this might solve your problem.

Of course, if your destination servers are actually slower than your 
source ones, then you might need to do something about that. But turning 
on prefetch limiting would make the system better-behaved and make it 
clearer where your issues are.

There might be another issue though - on all released versions of 
RabbitMQ turning on prefetch limiting reduces performance somewhat. This 
will get fixed in the next release.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034155.html">[rabbitmq-discuss] Unexaplainable behaviour with shovel plugin.
</A></li>
	<LI>Next message: <A HREF="034200.html">[rabbitmq-discuss] Unexaplainable behaviour with shovel plugin.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34199">[ date ]</a>
              <a href="thread.html#34199">[ thread ]</a>
              <a href="subject.html#34199">[ subject ]</a>
              <a href="author.html#34199">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
