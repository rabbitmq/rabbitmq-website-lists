<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] A question on federation status reporting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20A%20question%20on%20federation%20status%20reporting&In-Reply-To=%3CCACLE7ixv8w1s_ftqsgdrxCOSgKPjXJbHFrn0fR36HTVEYk6Hcw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033016.html">
   <LINK REL="Next"  HREF="033140.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] A question on federation status reporting</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20A%20question%20on%20federation%20status%20reporting&In-Reply-To=%3CCACLE7ixv8w1s_ftqsgdrxCOSgKPjXJbHFrn0fR36HTVEYk6Hcw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] A question on federation status reporting">mpietrek at skytap.com
       </A><BR>
    <I>Fri Jan 17 01:11:34 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="033016.html">[rabbitmq-discuss] A question on federation status reporting
</A></li>
        <LI>Next message: <A HREF="033140.html">[rabbitmq-discuss] A question on federation status reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33126">[ date ]</a>
              <a href="thread.html#33126">[ thread ]</a>
              <a href="subject.html#33126">[ subject ]</a>
              <a href="author.html#33126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Simon,

Ultimately, I got this to work by adding:

&quot;apply-to&quot;:&quot;exchanges&quot;

to my profile definitions.


However, one issue you may want to know about. After reapplying my profile,
I didn't see a reduction in links like I'd expect, despite the fact that
the

 In fact, even restarting the broker caused the broken state to remain.

In order to get this policy to take effect, I need to restart the brokers.
Not sure if this is expected behavior or not.

Thanks,

Matt


On Tue, Jan 14, 2014 at 2:00 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i> Hi Matt.
</I>&gt;<i>
</I>&gt;<i> Your policy applies to exchanges and queues with &quot;skytap&quot; in the name -
</I>&gt;<i> that includes the internal queues. Since the policy includes &quot;ha-mode&quot; I'm
</I>&gt;<i> assuming you want it to apply to both exchanges and queues - so you could
</I>&gt;<i> (1) change the regex to &quot;^skytap&quot; (i.e. names have to start with skytap,
</I>&gt;<i> not just contain it or (2) create a second policy to apply &quot;ha-mode&quot; to
</I>&gt;<i> queues and set the current policy to apply to exchanges only.
</I>&gt;<i>
</I>&gt;<i> Note that as of 3.2.x policies can be set to apply to exchanges or queues
</I>&gt;<i> or both: <A HREF="http://www.rabbitmq.com/parameters.html#policies">http://www.rabbitmq.com/parameters.html#policies</A>
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 13/01/2014 23:49, Matt Pietrek wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Thanks Simon!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm not sure how I manage to misconfigure my federation to include the
</I>&gt;&gt;<i> internal queues.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If it helps, here's what my Policies page shows for the federation:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> skytap-federation
</I>&gt;&gt;<i> &lt;<A HREF="http://tuk5r1mqvip1.mgt.integ.skytap.com:15672/#/">http://tuk5r1mqvip1.mgt.integ.skytap.com:15672/#/</A>
</I>&gt;&gt;<i> policies/%2F/skytap-federation&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> skytap  all
</I>&gt;&gt;<i> federation-upstream-set:        all
</I>&gt;&gt;<i> ha-mode:        all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And her are the snippets of python code I use to set up federation:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbitmq_invoke_http_api(broker_host,
</I>&gt;&gt;<i>                                        'PUT',
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> '/api/parameters/federation-upstream/%%2f/upstream-%s' %
</I>&gt;&gt;<i> (quote_plus(federated_broker)),
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> '{&quot;value&quot;:{&quot;uri&quot;:&quot;<A HREF="amqp://%(username">amqp://%(username</A>)s:%(password)s@%(host)s:%(port)s&quot;}}'
</I>&gt;&gt;<i> % (federated_settings))
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> then,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbitmq_invoke_http_api(broker_host,
</I>&gt;&gt;<i>                                        'PUT',
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> '/api/policies/%2f/skytap-federation',
</I>&gt;&gt;<i>                                        '{&quot;pattern&quot;:&quot;skytap&quot;,
</I>&gt;&gt;<i> &quot;definition&quot;:{&quot;federation-upstream-set&quot;:&quot;all&quot;,&quot;ha-mode&quot;:&quot;all&quot;}}')
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks again,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Matt
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, Jan 13, 2014 at 10:21 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Hi Matt.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Federated exchanges declare queues for internal use. These are the
</I>&gt;&gt;<i>     queues with names beginning &quot;federation: &quot; which you have probably
</I>&gt;&gt;<i>     already seen.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     It looks like in your case those internal queues are themselves
</I>&gt;&gt;<i>     becoming federated. This is unlikely to be a useful thing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     You should review your federation policies and make sure those
</I>&gt;&gt;<i>     queues are not included in them. If you don't intend to federate
</I>&gt;&gt;<i>     queues at all then the easiest way is to set the federation policy
</I>&gt;&gt;<i>     to only apply to exchanges.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     I'll also file a bug to prevent those queues from ever federating,
</I>&gt;&gt;<i>     regardless of policy...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Cheers, Simon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     On 13/01/2014 18:08, Matt Pietrek wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         We have a bi-directional federation setup between three nodes
</I>&gt;&gt;<i>         like this
</I>&gt;&gt;<i>         on RabbitMQ 3.2.2:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         mq_integ/sea &lt;===&gt; mq_integ &lt;===&gt; mq_integ/tuk
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         All three nodes use a &quot;skytap&quot; exchange and the mq_integ/sea
</I>&gt;&gt;<i>         and mq_integ/tuk are *_not_* federated with each other
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Here's what's interesting. In the *mq_integ/sea* broker, the
</I>&gt;&gt;<i>         &quot;Federation
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Upstreams&quot; page is what I'd expect it to be, that is, a
</I>&gt;&gt;<i>         connection to
</I>&gt;&gt;<i>         mq_integ:
</I>&gt;&gt;<i>         Name    URI     Expiry  Message TTL     Max Hops        Prefetch
</I>&gt;&gt;<i>         Count  Reconnect Delay
</I>&gt;&gt;<i>         Ack mode        Trust User-ID
</I>&gt;&gt;<i>         upstream-integ
</I>&gt;&gt;<i>         &lt;<A HREF="http://tuk5r1mq1.mgt.integ.__skytap.com:15672/#/federation-">http://tuk5r1mq1.mgt.integ.__skytap.com:15672/#/federation-</A>
</I>&gt;&gt;<i> __upstreams/%2F/upstream-integ
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         &lt;<A HREF="http://tuk5r1mq1.mgt.integ.skytap.com:15672/#/federation-">http://tuk5r1mq1.mgt.integ.skytap.com:15672/#/federation-</A>
</I>&gt;&gt;<i> upstreams/%2F/upstream-integ&gt;&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         <A HREF="amqp://foo:bar@sea_m2:5672">amqp://foo:bar@sea_m2:5672</A>
</I>&gt;&gt;<i>                 ?       ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         However, in the &quot;Federation Status&quot; page for *mq_integ/sea* looks
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         strange (see below). In particular, I see four entries, whereas in
</I>&gt;&gt;<i>         RabbitMQ 3.0.2 I only saw one line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         In addition, the third entry references the mq_integ/tuk broker,
</I>&gt;&gt;<i>         even
</I>&gt;&gt;<i>         though I haven't configured mq_integ/sea to know anything about
</I>&gt;&gt;<i>         mq_integ/tuk:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Connection      URI     Exchange / Queue        Node    State
</I>&gt;&gt;<i>         Inbound message rate    Last
</I>&gt;&gt;<i>         changed
</I>&gt;&gt;<i>         upstream-integ  <A HREF="amqp://sea_m2:5672">amqp://sea_m2:5672</A>      federation: skytap -&gt;
</I>&gt;&gt;<i>         mq_integ_queue
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea_r2</A>
</I>&gt;&gt;<i>         running
</I>&gt;&gt;<i>                          2014-01-11 1:35:28
</I>&gt;&gt;<i>         upstream-integ  <A HREF="amqp://sea5_m2:5672">amqp://sea5_m2:5672</A>     federation: skytap -&gt;
</I>&gt;&gt;<i>         mq_integ/sea_queue      <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea_r2</A>
</I>&gt;&gt;<i>         running
</I>&gt;&gt;<i>                          2014-01-11 1:35:28
</I>&gt;&gt;<i>         upstream-integ  <A HREF="amqp://sea_m2:5672">amqp://sea_m2:5672</A>      federation: skytap -&gt;
</I>&gt;&gt;<i>         mq_integ/tuk_queue      <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea_r2</A>
</I>&gt;&gt;<i>         running
</I>&gt;&gt;<i>                          2014-01-11 1:35:29
</I>&gt;&gt;<i>         upstream-integ  <A HREF="amqp://sea_m2:5672">amqp://sea_m2:5672</A>      skytap_exchange
</I>&gt;&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea_r2</A>
</I>&gt;&gt;<i>         running
</I>&gt;&gt;<i>                  0.00/s  2014-01-11 1:35:29
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Is this what you'd expect to see? Am I not understanding
</I>&gt;&gt;<i> something?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Matt
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         _________________________________________________
</I>&gt;&gt;<i>         rabbitmq-discuss mailing list
</I>&gt;&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.__rabbitmq.com</A>
</I>&gt;&gt;<i>         &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i>         <A HREF="https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/_">https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/_</A>_
</I>&gt;&gt;<i> rabbitmq-discuss
</I>&gt;&gt;<i>         &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/</A>
</I>&gt;&gt;<i> rabbitmq-discuss&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140116/67ecdca4/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140116/67ecdca4/attachment.html</A>&gt;
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033016.html">[rabbitmq-discuss] A question on federation status reporting
</A></li>
	<LI>Next message: <A HREF="033140.html">[rabbitmq-discuss] A question on federation status reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33126">[ date ]</a>
              <a href="thread.html#33126">[ thread ]</a>
              <a href="subject.html#33126">[ subject ]</a>
              <a href="author.html#33126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
