<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Dead-Lettering Queue Contents On Queue Expiration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Dead-Lettering%20Queue%20Contents%20On%20Queue%20Expiration&In-Reply-To=%3CCABWF3X0-f8CMJ3PCVjrhcpBaz9bjwC8taO-JszM6R-8UyX9SxQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033036.html">
   <LINK REL="Next"  HREF="033098.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Dead-Lettering Queue Contents On Queue Expiration</H1>
    <B>Alex Robson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Dead-Lettering%20Queue%20Contents%20On%20Queue%20Expiration&In-Reply-To=%3CCABWF3X0-f8CMJ3PCVjrhcpBaz9bjwC8taO-JszM6R-8UyX9SxQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Dead-Lettering Queue Contents On Queue Expiration">asrobson at gmail.com
       </A><BR>
    <I>Tue Jan 14 19:20:57 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="033036.html">[rabbitmq-discuss] ANN Hutch 0.7.0 is released
</A></li>
        <LI>Next message: <A HREF="033098.html">[rabbitmq-discuss] Dead-Lettering Queue Contents On Queue	Expiration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33037">[ date ]</a>
              <a href="thread.html#33037">[ thread ]</a>
              <a href="subject.html#33037">[ subject ]</a>
              <a href="author.html#33037">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,

I would like to see messages in an expired queue published to the
dead-letter exchange (if one has been provided) instead of having them lost.

Our use case is somewhat complex to explain, but ultimately, setting TTL on
a message is very different from TTL on a queue in that queue expiry is
based on the presence of a consumer. The utility of having both the queue
disposed and messages re-published seems pretty high to me. Let me try an
explain our use case.

A common pattern I've seen is to have multiple instances of the same
service consuming from the same queue. This makes the system resilient to
individual service instance failures because remaining instances (or new
ones) will continue consuming messages from the queue.

A problem in this pattern is when common state is being mutated as a result
of the messages; you end up with race conditions/last-write-wins style
behaviors that can become problematic.

The way we solve for this (within the realm of Rabbit) is to have a
consistent-hash exchange that hashes the correlation-id which is set to our
aggregate root (parent record id). This allows us to bind a
queue-per-service-instance and get the isolation guarantees we like while
still allowing us to horizontally scale. The problem with this approach is
that in the event that a service loses its connection/falls over, messages
in the queue sit and can be 'orphaned'.

If we use a queue TTL policy for these kinds of queues, it will allow us to
prevent orphaned queues, but presently it does not appear that the messages
in the queue are published to the defined dead letter exchange. Since
messages with a TLL behave this way, it seems logical that messages within
a queue that expires could/should also take advantage of the same behavior.

I believe it would be a real win for users everywhere as it allows for a
really clean way to scale horizontally without increasing race-conditions,
requiring distributed locking patterns or introducing failure modes that
could result in message loss or dramatically increased latency in message
processing.

Interested in your thoughts on this. If folks like the idea but there's not
a great deal of bandwidth, I'd be happy to attempt an initial
implementation via PR.

Thanks so much for RabbitMQ, it's awesome.

Alex
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140114/9a9c030a/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140114/9a9c030a/attachment.html</A>&gt;
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033036.html">[rabbitmq-discuss] ANN Hutch 0.7.0 is released
</A></li>
	<LI>Next message: <A HREF="033098.html">[rabbitmq-discuss] Dead-Lettering Queue Contents On Queue	Expiration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33037">[ date ]</a>
              <a href="thread.html#33037">[ thread ]</a>
              <a href="subject.html#33037">[ subject ]</a>
              <a href="author.html#33037">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
