<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] What can cause mnesia partitioning?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20What%20can%20cause%20mnesia%20partitioning%3F&In-Reply-To=%3C507BE91E.6000401%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023015.html">
   <LINK REL="Next"  HREF="023016.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] What can cause mnesia partitioning?</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20What%20can%20cause%20mnesia%20partitioning%3F&In-Reply-To=%3C507BE91E.6000401%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] What can cause mnesia partitioning?">tim at rabbitmq.com
       </A><BR>
    <I>Mon Oct 15 11:44:46 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023015.html">[rabbitmq-discuss] What can cause mnesia partitioning?
</A></li>
        <LI>Next message: <A HREF="023016.html">[rabbitmq-discuss] Loss of queues after network partition?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23045">[ date ]</a>
              <a href="thread.html#23045">[ thread ]</a>
              <a href="subject.html#23045">[ subject ]</a>
              <a href="author.html#23045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

On 10/12/2012 07:06 PM, tsuraan wrote:
&gt;<i> We had a pair of computers running a rabbit cluster, and somehow their
</I>&gt;<i> mnesia databases diverged.  Each computer was running its own rabbit
</I>&gt;<i> happily, but they both had cluster_status messages showing only
</I>&gt;<i> themselves as the only &quot;running&quot; node, and they both had log messages
</I>&gt;<i> to the effect of:
</I>&gt;<i>
</I>&gt;<i> Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node-1</A>'): ** ERROR ** mnesia_event got
</I>&gt;<i> {inconsistent_database, starting_partitioned_network, '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node-2</A>'}
</I>
This indicates that a netsplit has occurred; A situation that mnesia 
(and therefore clustered rabbit) does not handle well.

&gt;<i> I restarted both rabbit instances, and they both came up in an
</I>&gt;<i> apparently functional single-node instance (cluster_status on each
</I>&gt;<i> still showed the other node as a disc node, but not as a running
</I>&gt;<i> node).  From my reading of <A HREF="http://www.rabbitmq.com/clustering.html,">http://www.rabbitmq.com/clustering.html,</A> it
</I>&gt;<i> doesn't seem like that should happen, unless each node was somehow
</I>&gt;<i> convinced that it was the most up to date disc node.  Otherwise, one
</I>&gt;<i> of the nodes should have waited 30 seconds for the other one, and then
</I>&gt;<i> crashed if it couldn't be reached, right?  What sort of circumstances
</I>&gt;<i> would cause both nodes to think they were the most up to date, and
</I>&gt;<i> that they should continue running on their own?
</I>
A netsplit can cause this to happen. The 30 second delay behaviour is 
for when all the nodes in a cluster have been shut down cleanly, but 
this will not work if the mnesia databases have diverged due to a netsplit.

&gt;<i> Along that line, is there any way to configure a rabbit node to only
</I>&gt;<i> run if it can contact a strict majority of disc nodes?  I think that
</I>&gt;<i> would make this sort of problem less likely to happen, assuming the
</I>&gt;<i> problem stems from a network partition, or perhaps even from some
</I>&gt;<i> period of time where each machine was running while the other was not.
</I>
The latter case should not present a problem, as the mnesia databases 
won't have diverged as such, therefore mnesia will synchronise them 
whilst starting up the node that was offline temporarily. In terms of 
configuring rabbit to 'only run if it can contact a strcit majority of 
disc nodes', there are other issues to consider besides the number of 
nodes that can be contacted. Mnesia will not magically recover from 
netsplits without intervention, so this problem is actually non-trivial 
to fix - nevertheless, we are actively looking for solutions to this 
situation!

Cheers,
Tim
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023015.html">[rabbitmq-discuss] What can cause mnesia partitioning?
</A></li>
	<LI>Next message: <A HREF="023016.html">[rabbitmq-discuss] Loss of queues after network partition?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23045">[ date ]</a>
              <a href="thread.html#23045">[ thread ]</a>
              <a href="subject.html#23045">[ subject ]</a>
              <a href="author.html#23045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
