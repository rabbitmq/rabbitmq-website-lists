<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Two nodes in a cluster losing sight of each	other?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Two%20nodes%20in%20a%20cluster%20losing%20sight%20of%20each%0A%09other%3F&In-Reply-To=%3CCACLE7izEP%3DAc9EvRPP_H3T5Vom1p52%3D15iqa-qQ%2BsqVM%3DtoHkQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023309.html">
   <LINK REL="Next"  HREF="023308.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Two nodes in a cluster losing sight of each	other?</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Two%20nodes%20in%20a%20cluster%20losing%20sight%20of%20each%0A%09other%3F&In-Reply-To=%3CCACLE7izEP%3DAc9EvRPP_H3T5Vom1p52%3D15iqa-qQ%2BsqVM%3DtoHkQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Two nodes in a cluster losing sight of each	other?">mpietrek at skytap.com
       </A><BR>
    <I>Wed Oct 24 02:22:10 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023309.html">[rabbitmq-discuss] use best practices with IBasicProperties
</A></li>
        <LI>Next message: <A HREF="023308.html">[rabbitmq-discuss] Two nodes in a cluster losing sight of each	other?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23302">[ date ]</a>
              <a href="thread.html#23302">[ thread ]</a>
              <a href="subject.html#23302">[ subject ]</a>
              <a href="author.html#23302">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm trying to track down a fun one. This is with 2.8.6. (We're in the
process of moving these guys to 2.8.7, but want to understand what's
happening first.)

We have two nodes, mq1 and mq2. They simultaneously lose communication with
each other,  breaking the cluster, although they still continue to function
independently. That is, each one things the other is down.

Now the obvious solution is some sort of network partition. However, in all
of our extensive logs and by pouring over all sorts of system data, I don't
see any evidence of a a network blip. Not saying it's not possible, just
pretty unlikely. The only thing of note I can think of is that we were in
towards the end an &quot;apt-get update&quot; when this happened.

On mq1, the <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1.log</A> file is:

=ERROR REPORT==== 22-Oct-2012::09:40:28 ===
** Node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2</A> not responding **
** Removing (timedout) connection **

=ERROR REPORT==== 22-Oct-2012::09:40:28 ===
webmachine error: path=&quot;/api/overview&quot;
{error,
    {error,function_clause,
        [{rabbit_mgmt_wm_overview,'-contexts/1-lc$^0/1-0-',
             [{badrpc,nodedown}<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at mq2</A>],
             []},

{rabbit_mgmt_wm_overview,'-rabbit_mochiweb_contexts/0-lc$^0/1-0-',1,
             []},
         {rabbit_mgmt_wm_overview,rabbit_mochiweb_contexts,0,[]},
         {rabbit_mgmt_wm_overview,to_json,2,[]},
         {webmachine_resource,resource_call,3,[]},
         {webmachine_resource,do,3,[]},
         {webmachine_decision_core,resource_call,1,[]},
         {webmachine_decision_core,decision,1,[]}]}}

=ERROR REPORT==== 22-Oct-2012::09:40:28 ===
webmachine error: path=&quot;/api/overview&quot;
{error,
    {error,function_clause,
        [{rabbit_mgmt_wm_overview,'-contexts/1-lc$^0/1-0-',
             [{badrpc,nodedown}<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at mq2</A>],
             []},

{rabbit_mgmt_wm_overview,'-rabbit_mochiweb_contexts/0-lc$^0/1-0-',1,
             []},
         {rabbit_mgmt_wm_overview,rabbit_mochiweb_contexts,0,[]},
         {rabbit_mgmt_wm_overview,to_json,2,[]},
         {webmachine_resource,resource_call,3,[]},
         {webmachine_resource,do,3,[]},
         {webmachine_decision_core,resource_call,1,[]},
         {webmachine_decision_core,decision,1,[]}]}}
&lt;&lt; several more of these &gt;&gt;

The <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1-sasl.log</A> has one of these per queue:
=CRASH REPORT==== 22-Oct-2012::09:40:28 ===
  crasher:
    initial call: gen:init_it/6
    pid: &lt;0.260.0&gt;
    registered_name: []
    exception exit: {function_clause,
                     [{gm,handle_info,
                       [{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mnesia_locker,rabbit at mq2</A>,granted},
                        {state,
                         {3,&lt;0.260.0&gt;},
                         {{3,&lt;0.260.0&gt;},undefined},
                         {{3,&lt;0.260.0&gt;},undefined},
                         {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;charon&quot;&gt;&gt;},
                         rabbit_mirror_queue_coordinator,
                         {12,
                          [{{3,&lt;0.260.0&gt;},
                            {view_member,
                             {3,&lt;0.260.0&gt;},
                             [],
                             {3,&lt;0.260.0&gt;},
                             {3,&lt;0.260.0&gt;}}}]},
                         972,[],
                         [&lt;0.1073.0&gt;],
                         {[],[]},
                         [],undefined}],
                       []},
                      {gen_server2,handle_msg,2,[]},
                      {proc_lib,wake_up,3,
                       [{file,&quot;proc_lib.erl&quot;},{line,237}]}]}
      in function  gen_server2:terminate/3
    ancestors: [&lt;0.259.0&gt;,rabbit_mirror_queue_slave_sup,rabbit_sup,
                  &lt;0.145.0&gt;]
    messages: []
    links: [&lt;0.1073.0&gt;]
    dictionary: [{random_seed,{986,23084,10363}}]
    trap_exit: false
    status: running
    heap_size: 1597
    stack_size: 24
    reductions: 263704
  neighbours:
    neighbour: [{pid,&lt;0.1073.0&gt;},
                  {registered_name,[]},
                  {initial_call,{gen,init_it,
                                     ['Argument__1','Argument__2',
                                      'Argument__3','Argument__4',
                                      'Argument__5','Argument__6']}},
                  {current_function,{gen,do_call,4}},
                  {ancestors,[&lt;0.259.0&gt;,rabbit_mirror_queue_slave_sup,
                              rabbit_sup,&lt;0.145.0&gt;]},
                  {messages,[]},
                  {links,[&lt;0.259.0&gt;,&lt;0.260.0&gt;]},
                  {dictionary,[]},
                  {trap_exit,false},
                  {status,waiting},
                  {heap_size,377},
                  {stack_size,27},
                  {reductions,23907}]

Meanwhile, on mq2, the <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2.log</A> file is:

=INFO REPORT==== 22-Oct-2012::09:40:28 ===
rabbit on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A> down

=ERROR REPORT==== 22-Oct-2012::09:40:28 ===
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2</A>): ** ERROR ** mnesia_event got {inconsistent_database,
running_partitioned_network, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>}

=INFO REPORT==== 22-Oct-2012::09:40:28 ===
Mirrored-queue (queue 'cmcmd' in vhost '/'): Slave &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2.2.260.0</A>&gt; saw
deaths of mirrors &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1.1.261.0</A>&gt;

=INFO REPORT==== 22-Oct-2012::09:40:28 ===
Mirrored-queue (queue 'cmcmd' in vhost '/'): Promoting slave
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2.2.260.0</A>&gt; to master

=INFO REPORT==== 22-Oct-2012::09:40:28 ===
Mirrored-queue (queue 'charon' in vhost '/'): Slave &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2.2.258.0</A>&gt;
saw deaths of mirrors &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1.1.259.0</A>&gt;

=INFO REPORT==== 22-Oct-2012::09:40:28 ===
Mirrored-queue (queue 'charon' in vhost '/'): Promoting slave
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2.2.258.0</A>&gt; to master

=INFO REPORT==== 22-Oct-2012::09:40:28 ===
    application: rabbitmq_management
    exited: shutdown
    type: permanent

and the <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2-sasl.log</A> file has:

=SUPERVISOR REPORT==== 22-Oct-2012::09:40:28 ===
     Supervisor: {local,rabbit_mgmt_sup}
     Context:    child_terminated
     Reason:     {shutdown,
                     [{killed,
                          {child,undefined,rabbit_mgmt_db,
                              {rabbit_mgmt_db,start_link,[]},
                              permanent,4294967295,worker,
                              [rabbit_mgmt_db]}}]}
     Offender:   [{pid,&lt;0.303.0&gt;},
                  {name,mirroring},
                  {mfa,
                      {mirrored_supervisor,start_internal,
                          [rabbit_mgmt_sup,
                           [{rabbit_mgmt_db,
                                {rabbit_mgmt_db,start_link,[]},
                                permanent,4294967295,worker,
                                [rabbit_mgmt_db]}]]}},
                  {restart_type,permanent},
                  {shutdown,4294967295},
                  {child_type,worker}]


=SUPERVISOR REPORT==== 22-Oct-2012::09:40:28 ===
     Supervisor: {local,rabbit_mgmt_sup}
     Context:    shutdown
     Reason:     reached_max_restart_intensity
     Offender:   [{pid,&lt;0.303.0&gt;},
                  {name,mirroring},
                  {mfa,
                      {mirrored_supervisor,start_internal,
                          [rabbit_mgmt_sup,
                           [{rabbit_mgmt_db,
                                {rabbit_mgmt_db,start_link,[]},
                                permanent,4294967295,worker,
                                [rabbit_mgmt_db]}]]}},
                  {restart_type,permanent},
                  {shutdown,4294967295},
                  {child_type,worker}]
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121023/7bb8565b/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121023/7bb8565b/attachment.htm</A>&gt;
</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023309.html">[rabbitmq-discuss] use best practices with IBasicProperties
</A></li>
	<LI>Next message: <A HREF="023308.html">[rabbitmq-discuss] Two nodes in a cluster losing sight of each	other?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23302">[ date ]</a>
              <a href="thread.html#23302">[ thread ]</a>
              <a href="subject.html#23302">[ subject ]</a>
              <a href="author.html#23302">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
