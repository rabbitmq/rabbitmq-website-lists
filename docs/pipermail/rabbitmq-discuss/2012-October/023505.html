<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pub/Sub -- block publisher until all acks	received from subscribers?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pub/Sub%20--%20block%20publisher%20until%20all%20acks%0A%09received%20from%20subscribers%3F&In-Reply-To=%3CCAFedJMhM%2BpfzigOd2SY6_gWUam6-t46Psm%3DdZuhAP7bHSA7VMQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023492.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pub/Sub -- block publisher until all acks	received from subscribers?</H1>
    <B>Nick Martin</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pub/Sub%20--%20block%20publisher%20until%20all%20acks%0A%09received%20from%20subscribers%3F&In-Reply-To=%3CCAFedJMhM%2BpfzigOd2SY6_gWUam6-t46Psm%3DdZuhAP7bHSA7VMQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Pub/Sub -- block publisher until all acks	received from subscribers?">nick at faceture.com
       </A><BR>
    <I>Wed Oct 31 22:10:39 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023492.html">[rabbitmq-discuss] loadbalancer configuration for clustered	rabbitmq cluster.
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23505">[ date ]</a>
              <a href="thread.html#23505">[ thread ]</a>
              <a href="subject.html#23505">[ subject ]</a>
              <a href="author.html#23505">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a publish-subscribe use case where I would like to block on the
publish side until each of the subscribers confirm that they have completed
handling the message sent by the publisher.

I (incorrectly?) assumed that I could use RabbitMQ and its Java
amqp-client's Channel.waitForConfirmsOrDie method as part of my solution.
The issue is that I haven't found a case in which waitForConfirmsOrDie will
actually block.

According to the javadocs (
<A HREF="http://www.rabbitmq.com/javadoc/com/rabbitmq/client/Channel.html#waitForConfirmsOrDie(">http://www.rabbitmq.com/javadoc/com/rabbitmq/client/Channel.html#waitForConfirmsOrDie(</A>)),
waitForConfirmsOrDie is supposed to:

&gt;<i> Wait until all messages published since the last call have been either
</I>ack'd or nack'd by the broker. If any of the messages were nack'd,
waitForConfirmsOrDie will throw an IOException. When called on a
non-Confirm channel, it will return immediately.

In order to test that this method really works, I started with example code
from the RabbitMQ website (
<A HREF="http://hg.rabbitmq.com/rabbitmq-java-client/raw-file/da241e35951b/test/src/com/rabbitmq/examples/ConfirmDontLoseMessages.java">http://hg.rabbitmq.com/rabbitmq-java-client/raw-file/da241e35951b/test/src/com/rabbitmq/examples/ConfirmDontLoseMessages.java</A>
).

The example code creates a publisher and a consumer, each on its own
separate thread. Then the publisher sends messages to the exchange while
the consumer consumes the messages. It seems to me that the publisher is
supposed to block until all of the messages are ack'd via its call to
waitForConfirmsOrDie(). Is this what this is really supposed to do?

This example code seemed like it matched up perfectly with what I was
trying to do. But, it doesn't seem to work the way I thought it did. In
fact, if, in the consumer thread, I turn off auto-acking messages, then
waitForConfirmsOrDie() still returns immediately.

I turned off auto ack by just changing one false to true:
ch.queueDeclare(QUEUE_NAME, false, false, false, null);
becomes
ch.queueDeclare(QUEUE_NAME, true, false, false, null); (2nd arg false
instead of true).

I believe this means that acks should no longer be sent by the consumer.

So what does waitForConfirmsOrDie() actually do? When would it block?

If waitForConfirmsOrDie doesn't do what I want, is there a way to make a
publisher wait until all subscribers ack a message before proceeding?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121031/b4932924/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121031/b4932924/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023492.html">[rabbitmq-discuss] loadbalancer configuration for clustered	rabbitmq cluster.
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23505">[ date ]</a>
              <a href="thread.html#23505">[ thread ]</a>
              <a href="subject.html#23505">[ subject ]</a>
              <a href="author.html#23505">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
