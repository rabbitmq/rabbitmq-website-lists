<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] 2.8.7 - Unexpected termination of HA node
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%202.8.7%20-%20Unexpected%20termination%20of%20HA%20node&In-Reply-To=%3C03CFB894A02BE24885082C694F789A7B13BF1920%40PERMLS03.zettaserve.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022882.html">
   <LINK REL="Next"  HREF="022893.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] 2.8.7 - Unexpected termination of HA node</H1>
    <B>Rensen, Nathanael</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%202.8.7%20-%20Unexpected%20termination%20of%20HA%20node&In-Reply-To=%3C03CFB894A02BE24885082C694F789A7B13BF1920%40PERMLS03.zettaserve.com%3E"
       TITLE="[rabbitmq-discuss] 2.8.7 - Unexpected termination of HA node">nathanael.rensen at zettaserve.com
       </A><BR>
    <I>Mon Oct  8 01:56:30 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022882.html">[rabbitmq-discuss] Redeliever message with path in exchange to exchange binding
</A></li>
        <LI>Next message: <A HREF="022893.html">[rabbitmq-discuss] 2.8.7 - Unexpected termination of HA node
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22883">[ date ]</a>
              <a href="thread.html#22883">[ thread ]</a>
              <a href="subject.html#22883">[ subject ]</a>
              <a href="author.html#22883">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>While testing RabbitMQ version 2.8.7 I've encountered an issue where the slave node in a HA pair terminates when the master is forcefully rebooted.

The environment is Centos 6.3 with RabbitMQ 2.8.7, Erlang R14B, with a durable queue mirrored across a pair of nodes in a HA cluster. The master is rebooted using reboot -nf to simulate an ungraceful failure. When the master comes back up the slave node terminates with error log shown below.

The behaviour when testing with version 2.8.6 was that the queue would vanish from the cluster. With version 2.8.7 the queue remains intact, but the slave node terminates.

I've found that if the rabbitmq-server is not configured to start at boot the slave node eventually promotes itself to master and survives the eventual restart of the original master.

Nathanael

=INFO REPORT==== 5-Oct-2012::17:24:35 ===
rabbit on node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>' down

=INFO REPORT==== 5-Oct-2012::17:24:35 ===
Statistics database started.

=INFO REPORT==== 5-Oct-2012::17:24:35 ===
Mirrored-queue (queue 'zg-ha-test' in vhost '/'): Slave
&lt;'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-001</A>'.3.252.0&gt; saw deaths of mirrors
&lt;'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>'.2.252.0&gt;

=INFO REPORT==== 5-Oct-2012::17:24:35 ===
Mirrored-queue (queue 'zg-ha-test' in vhost '/'): Promoting slave
&lt;'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-001</A>'.3.252.0&gt; to master

=ERROR REPORT==== 5-Oct-2012::17:24:35 ===
** Generic server &lt;0.253.0&gt; terminating
** Last message in was {mnesia_tm,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>',
                                  {vote_yes,{tid,2235,&lt;0.253.0&gt;}}}
** When Server state == {state,
                            {3,&lt;0.253.0&gt;},
                            {{3,&lt;0.253.0&gt;},undefined},
                            {{3,&lt;0.253.0&gt;},undefined},
                            {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;zg-ha-test&quot;&gt;&gt;},
                            rabbit_mirror_queue_coordinator,
                            {6,
                             [{{3,&lt;0.253.0&gt;},
                               {view_member,
                                   {3,&lt;0.253.0&gt;},
                                   [],
                                   {3,&lt;0.253.0&gt;},
                                   {3,&lt;0.253.0&gt;}}}]},
                            0,[],
                            [&lt;0.336.0&gt;],
                            {[],[]},
                            [],undefined}
** Reason for termination ==
** {function_clause,
       [{gm,handle_info,
            [{mnesia_tm,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>',
                 {vote_yes,{tid,2235,&lt;0.253.0&gt;}}},
             {state,
                 {3,&lt;0.253.0&gt;},
                 {{3,&lt;0.253.0&gt;},undefined},
                 {{3,&lt;0.253.0&gt;},undefined},
                 {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;zg-ha-test&quot;&gt;&gt;},
                 rabbit_mirror_queue_coordinator,
                 {6,
                  [{{3,&lt;0.253.0&gt;},
                    {view_member,
                        {3,&lt;0.253.0&gt;},
                        [],
                        {3,&lt;0.253.0&gt;},
                        {3,&lt;0.253.0&gt;}}}]},
                 0,[],
                 [&lt;0.336.0&gt;],
                 {[],[]},
                 [],undefined}]},
        {gen_server2,handle_msg,2},
        {proc_lib,wake_up,3}]}

=ERROR REPORT==== 5-Oct-2012::17:24:36 ===
** Generic server &lt;0.252.0&gt; terminating
** Last message in was {'EXIT',&lt;0.336.0&gt;,
                        {function_clause,
                         [{gm,handle_info,
                           [{mnesia_tm,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>',
                             {vote_yes,{tid,2235,&lt;0.253.0&gt;}}},
                            {state,
                             {3,&lt;0.253.0&gt;},
                             {{3,&lt;0.253.0&gt;},undefined},
                             {{3,&lt;0.253.0&gt;},undefined},
                             {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;zg-ha-test&quot;&gt;&gt;},
                             rabbit_mirror_queue_coordinator,
                             {6,
                              [{{3,&lt;0.253.0&gt;},
                                {view_member,
                                 {3,&lt;0.253.0&gt;},
                                 [],
                                 {3,&lt;0.253.0&gt;},
                                 {3,&lt;0.253.0&gt;}}}]},
                             0,[],
                             [&lt;0.336.0&gt;],
                             {[],[]},
                             [],undefined}]},
                          {gen_server2,handle_msg,2},
                          {proc_lib,wake_up,3}]}}
** When Server state == {q,
                         {amqqueue,
                          {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;zg-ha-test&quot;&gt;&gt;},
                          true,false,none,
                          [{&lt;&lt;&quot;x-ha-policy&quot;&gt;&gt;,longstr,&lt;&lt;&quot;all&quot;&gt;&gt;}],
                          &lt;0.252.0&gt;,[],all},
                         none,false,rabbit_mirror_queue_master,
                         {state,&lt;0.253.0&gt;,&lt;0.336.0&gt;,rabbit_variable_queue,
                          {vqstate,
                           {0,{[],[]}},
                           {0,{[],[]}},
                           {delta,undefined,0,undefined},
                           {0,{[],[]}},
[... lots of stuff omitted...]
                           {291,
                           29148,
                           {0,nil},
                           undefined,
                           {0,nil},
                           {qistate,

&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-001</A>/queues/EVSP28XGBN529KMXDI7YW0GM2&quot;,
                            {{dict,0,16,16,8,80,48,
                              {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []},
                              {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []}}},
                             []},
                            undefined,0,262144,
                            #Fun&lt;rabbit_variable_queue.2.121033067&gt;,
                            {0,nil}},
                           {{client_msstate,msg_store_persistent,
                             &lt;&lt;64,124,193,190,179,5,132,252,0,55,122,227,216,
                               123,112,237&gt;&gt;,
                             {dict,0,16,16,8,80,48,
                              {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []},
                              {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []}}},
                             {state,303177,

&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-001</A>/msg_store_persistent&quot;},
                             rabbit_msg_store_ets_index,

&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-001</A>/msg_store_persistent&quot;,
                             &lt;0.246.0&gt;,307274,299080,311371,315468},
                            {client_msstate,msg_store_transient,
                             &lt;&lt;38,48,43,9,149,2,213,22,77,78,223,24,149,53,175,
                               245&gt;&gt;,
                             {dict,0,16,16,8,80,48,
                              {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []},
                              {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []}}},
                             {state,282692,

&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-001</A>/msg_store_transient&quot;},
                             rabbit_msg_store_ets_index,

&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-001</A>/msg_store_transient&quot;,
                             &lt;0.241.0&gt;,286789,278595,290886,294983}},
                           true,0,#Fun&lt;rabbit_mirror_queue_slave.1.40624233&gt;,
                           291,0,infinity,291,0,152,0,291,
                           {rates,
                            {{1349,429050,591110},0},
                            {{1349,429050,591110},0},
                            1076.4632093998348,1076.4632093998348,
                            {1349,429051,592073}},
                           {0,nil},
                           {0,nil},
                           {0,nil},
                           {0,nil},
                           0,0,
                           {rates,
                            {{1349,429050,591110},0},
                            {{1349,429050,591110},0},
                            1071.7981467372135,1076.4632093998348,
                            {1349,429051,592073}}},
                          0,
                          {dict,6,16,16,8,80,48,
                           {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                           {{[],[],
                             [[&lt;&lt;218,200,61,58,97,50,72,197,144,158,220,215,
                                 159,163,253,105&gt;&gt;|
                               published]],
                             [[&lt;&lt;80,182,167,56,95,139,134,134,192,40,123,239,
                                 62,193,49,206&gt;&gt;|
                               published],
                              [&lt;&lt;159,219,2,228,110,119,150,246,97,74,183,72,
                                 254,233,74,33&gt;&gt;|
                               published],
                              [&lt;&lt;223,108,153,205,69,107,192,83,254,145,181,
                                 172,15,61,33,190&gt;&gt;|
                               published]],
                             [],[],[],[],
                             [[&lt;&lt;8,84,74,65,208,81,184,115,74,86,225,237,241,
                                 172,148,18&gt;&gt;|
                               published]],
                             [],[],[],[],[],
                             [[&lt;&lt;&quot;&#245;jq$&#249;&#248;&#222;S!&#253;,a&#187;&#250;u&#255;&quot;&gt;&gt;|published]],
                             []}}},
                          [],
                          {dict,0,16,16,8,80,48,
                           {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                           {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                             []}}},
                          {set,0,16,16,8,80,48,
                           {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                           {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                             []}}}},
                         {[],[]},
                         undefined,undefined,#Ref&lt;0.0.0.1342&gt;,undefined,
                         {state,fine,5000,#Ref&lt;0.0.0.1406&gt;},
                         {0,nil},
                         undefined,undefined,undefined,
                         {dict,1,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                          {{[],[],[],[],[],[],
                            [[&lt;7527.317.0&gt;|#Ref&lt;0.0.0.732&gt;]],
                            [],[],[],[],[],[],[],[],[]}}},
                         1,
                         {{0,nil},{0,nil}},
                         undefined,
                         {dict,0,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                          {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},
                         undefined,undefined}
** Reason for termination ==
** {noproc,{gen_server2,call,[&lt;0.253.0&gt;,info,infinity]}}
** In 'terminate' callback with reason ==
** {function_clause,
       [{gm,handle_info,
            [{mnesia_tm,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>',
                 {vote_yes,{tid,2235,&lt;0.253.0&gt;}}},
             {state,
                 {3,&lt;0.253.0&gt;},
                 {{3,&lt;0.253.0&gt;},undefined},
                 {{3,&lt;0.253.0&gt;},undefined},
                 {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;zg-ha-test&quot;&gt;&gt;},
                 rabbit_mirror_queue_coordinator,
                 {6,
                  [{{3,&lt;0.253.0&gt;},
                    {view_member,
                        {3,&lt;0.253.0&gt;},
                        [],
                        {3,&lt;0.253.0&gt;},
                        {3,&lt;0.253.0&gt;}}}]},
                 0,[],
                 [&lt;0.336.0&gt;],
                 {[],[]},
                 [],undefined}]},
        {gen_server2,handle_msg,2},
        {proc_lib,wake_up,3}]}

=INFO REPORT==== 5-Oct-2012::17:24:36 ===
rabbit on node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>' up

=ERROR REPORT==== 5-Oct-2012::17:24:36 ===
** Generic server &lt;0.292.0&gt; terminating
** Last message in was {mnesia_tm,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>',
                                  {vote_yes,{tid,2236,&lt;0.292.0&gt;}}}
** When Server state == {state,&lt;0.290.0&gt;,&lt;0.291.0&gt;,rabbit_mgmt_sup,
                            [{rabbit_mgmt_db,
                                 {rabbit_mgmt_db,start_link,[]},
                                 permanent,4294967295,worker,
                                 [rabbit_mgmt_db]}]}
** Reason for termination ==
** {unexpected_info,{mnesia_tm,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at zg-dev-nr-002</A>',
                               {vote_yes,{tid,2236,&lt;0.292.0&gt;}}}}

=INFO REPORT==== 5-Oct-2012::17:24:36 ===
    application: rabbitmq_management
    exited: shutdown
    type: permanent

=INFO REPORT==== 5-Oct-2012::17:24:36 ===
stopped TCP Listener on [::]:5672

________________________________

ZettaServe Disclaimer: This email and any files transmitted with it are confidential and intended solely for the use of the individual or entity to whom they are addressed. If you are not the named addressee you should not disseminate, distribute or copy this e-mail. Please notify the sender immediately if you have received this email by mistake and delete this email from your system. Computer viruses can be transmitted via email. The recipient should check this email and any attachments for the presence of viruses. ZettaServe Pty Ltd accepts no liability for any damage caused by any virus transmitted by this email.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121008/416518b3/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121008/416518b3/attachment.htm</A>&gt;
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022882.html">[rabbitmq-discuss] Redeliever message with path in exchange to exchange binding
</A></li>
	<LI>Next message: <A HREF="022893.html">[rabbitmq-discuss] 2.8.7 - Unexpected termination of HA node
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22883">[ date ]</a>
              <a href="thread.html#22883">[ thread ]</a>
              <a href="subject.html#22883">[ subject ]</a>
              <a href="author.html#22883">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
