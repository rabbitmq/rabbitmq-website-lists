<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] AMQP restart
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20AMQP%20restart&In-Reply-To=%3CCAKwS4iiSwZ5%3D5aAejKv5tWm4_HkHj9K5ascQMqHwVioE_m4-iA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023079.html">
   <LINK REL="Next"  HREF="023059.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] AMQP restart</H1>
    <B>tom kelly</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20AMQP%20restart&In-Reply-To=%3CCAKwS4iiSwZ5%3D5aAejKv5tWm4_HkHj9K5ascQMqHwVioE_m4-iA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] AMQP restart">ttom.kelly at gmail.com
       </A><BR>
    <I>Thu Oct 18 21:09:41 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023079.html">[rabbitmq-discuss] AMQP restart
</A></li>
        <LI>Next message: <A HREF="023059.html">[rabbitmq-discuss] Response times for publisher confirms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23169">[ date ]</a>
              <a href="thread.html#23169">[ thread ]</a>
              <a href="subject.html#23169">[ subject ]</a>
              <a href="author.html#23169">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Tim,

Thanks for your answers!

My original question on the links &amp; supervisors came from my need to know
that when my mystery error (cause still unknown but more than likely caused
by myself) occurred I got some type of exit or notification so that i could
do something about it. I've built a wrapper around it now that monitors the
connection &amp; channel so can happily forget about meddling with the
supervision tree :-)

While doing this I've built up more understanding of the library and added
the confirmation &amp; retry handling to my wrapper relatively easily. So I
just want to say good work on rabbitmq-erlang-client guys!

//TTom.


On Tue, Oct 16, 2012 at 12:57 PM, Tim Watson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>&gt; wrote:

&gt;<i> Hi!
</I>&gt;<i>
</I>&gt;<i> On 15 Oct 2012, at 16:07, tom kelly wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Hi List,
</I>&gt;<i> &gt; New user here, debugging some code I inherited so apologies if my
</I>&gt;<i> questions below are irrelevant.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm investigating an amqp crash that I've seen in my logs a few times
</I>&gt;<i> and after a code review of the amqp component I'm a bit concerned that my
</I>&gt;<i> connections may be dying &amp; silently failing when this crash occurs.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Ok, let's look at that then.
</I>&gt;<i>
</I>&gt;<i> &gt; I'm using an older version that unlinked from the process that called
</I>&gt;<i> &quot;start_link&quot;, anyone know why that was? I'm publishing through this channel
</I>&gt;<i> by calling amqp_channel:cast, so now I'm worried that if the connection &amp;
</I>&gt;<i> channel were closed down everything that I thought I was publishing after
</I>&gt;<i> this error just silently failed. And because of the unlink there's no way
</I>&gt;<i> the application would have known.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> I'm really no too sure about this unlink business, but if you could
</I>&gt;<i> clarify where that was happening then I can probably look through the hg
</I>&gt;<i> logs to try and figure out what was going on there.
</I>&gt;<i>
</I>&gt;<i> &gt; I plan upgrading to the latest version but I'm not sure that it has all
</I>&gt;<i> the features to help solve this problem. I see that the unlink is gone and
</I>&gt;<i> the supervision policy is still:{one_for_all, 0, 1} So I guess this means I
</I>&gt;<i> have to trap exits and I have responsibility for reopening the connection &amp;
</I>&gt;<i> channel if it dies?
</I>&gt;<i>
</I>&gt;<i> My reading of the supervision hierarchy is thus:
</I>&gt;<i>
</I>&gt;<i> The application has a top level simple_one_for_one supervisor for all
</I>&gt;<i> connections, which handles the amqp_connection_sup. This just ensures that
</I>&gt;<i> each connection can actually be started and they connection_sup is
</I>&gt;<i> temporary, so no restarts will ever take place. This is presumably what
</I>&gt;<i> you'd expect, as we're not trying to second guess how long your connections
</I>&gt;<i> need to live for.
</I>&gt;<i>
</I>&gt;<i> The actual connection consists of a few processes - the gen_connection,
</I>&gt;<i> connection_type_sup and channel_sup_sup. This is a one_for_all supervisor
</I>&gt;<i> and the actual gen_connection process is an 'intrinsic' worker, so a
</I>&gt;<i> non-normal exit will kill the supervisor (and sibling processes), but a
</I>&gt;<i> normal exit will take everyone else down cleanly.
</I>&gt;<i>
</I>&gt;<i> Now the channel_sup_sup starts a temporary worker (amqp_channel_sup) and
</I>&gt;<i> that starts an intrinsic worker.  So all in all, it looks to me as if the
</I>&gt;<i> connection and channel will be properly re-established if a non-normal exit
</I>&gt;<i> occurs.
</I>&gt;<i>
</I>&gt;<i> &gt; But before I restart it, what happens to any attempts to publish
</I>&gt;<i> messages? I see there's new confirmation functionality that sounds like it
</I>&gt;<i> might do what's required but from my reading it seems that if amqp_channel
</I>&gt;<i> is shut down after a crash on the connection then all the confirm info is
</I>&gt;<i> discarded. Is there no way to keep this process alive and try to re-open
</I>&gt;<i> the connection immediately on failure?
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> I'm not really sure what you're asking here, but my reading of the client
</I>&gt;<i> is that if you're expecting a confirm and you've not seen it, then you
</I>&gt;<i> can/should assume the message wasn't accepted by the broker. If you're
</I>&gt;<i> asking about tracking the confirms between channel instances, then yes,
</I>&gt;<i> you'll need to do that yourself, using whatever mechanism suits your design
</I>&gt;<i> (shared/stable storage, stateful parent process, etc).
</I>&gt;<i>
</I>&gt;<i> &gt; I'm just about to plug in the new version and play with the
</I>&gt;<i> confirmations but any explanations of the current design might help
</I>&gt;<i> enormously,
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt; //TTom.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Well I hope my comments have made it a bit clearly and not worse! Please
</I>&gt;<i> *do* feel free to come back with any questions, or to clear up anything
</I>&gt;<i> I've not explained properly.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Tim
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121018/5574094a/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121018/5574094a/attachment.htm</A>&gt;
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023079.html">[rabbitmq-discuss] AMQP restart
</A></li>
	<LI>Next message: <A HREF="023059.html">[rabbitmq-discuss] Response times for publisher confirms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23169">[ date ]</a>
              <a href="thread.html#23169">[ thread ]</a>
              <a href="subject.html#23169">[ subject ]</a>
              <a href="author.html#23169">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
