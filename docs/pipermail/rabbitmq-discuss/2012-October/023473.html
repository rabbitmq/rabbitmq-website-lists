<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cluster busting - shut off all nodes at the same time.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20busting%20-%20shut%20off%20all%20nodes%20at%20the%0A%20same%20time.&In-Reply-To=%3C509102CE.3090102%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023457.html">
   <LINK REL="Next"  HREF="023456.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cluster busting - shut off all nodes at the same time.</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20busting%20-%20shut%20off%20all%20nodes%20at%20the%0A%20same%20time.&In-Reply-To=%3C509102CE.3090102%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Cluster busting - shut off all nodes at the same time.">simon at rabbitmq.com
       </A><BR>
    <I>Wed Oct 31 10:51:58 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023457.html">[rabbitmq-discuss] Cluster busting - shut off all nodes at the	same time.
</A></li>
        <LI>Next message: <A HREF="023456.html">[rabbitmq-discuss] RabbitMQ + Logstash + Rails
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23473">[ date ]</a>
              <a href="thread.html#23473">[ thread ]</a>
              <a href="subject.html#23473">[ subject ]</a>
              <a href="author.html#23473">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/10/12 18:07, Mark Ward wrote:
&gt;<i> After looking at the section again this statement stands out &quot;... ensure
</I>&gt;<i> that your use of messaging generally results in very short or empty
</I>&gt;<i> queues that rapidly drain.&quot;  When dealing with the cluster buster test
</I>&gt;<i> scenarios I have been using a scenario that a queue is not empty and is
</I>&gt;<i> not rapidly drained.
</I>&gt;<i>
</I>&gt;<i> It has us nervous that if each node in the cluster is restarted one at a
</I>&gt;<i> time and allowed to rejoin the cluster then all data in the idle
</I>&gt;<i> persistent queues would be lost. Performing Windows updates might be
</I>&gt;<i> fatal to idle queued data!  To clarify the messages are published
</I>&gt;<i> with persistent on.
</I>
Yes.

We have various enhancements planned to queue synchronisation; the 
current situation is clearly not ideal when queues drain slowly.

One thing you'll be able to do in 3.0 (not that this is at all a perfect 
solution) is switch off mirroring for queues, do any cluster 
maintenance, and then switch mirroring back on. Another non-ideal 
alternative is to take the whole cluster down, do your Windows updates, 
and then start it up again.

&gt;<i> Back to the cluster test scenario....
</I>&gt;<i>
</I>&gt;<i> I guess the conclusion is the cluster performed as designed and it did
</I>&gt;<i> require all nodes in the cluster to be started under the 30 second
</I>&gt;<i> timeout.  Although, I am not sure if the erl_crash.dump is expected.
</I>
Yeah, erl_crash.dump is emitted whenever RabbitMQ fails to start. The 
log file entries below are also consistent with this happening.

Cheers, Simon

&gt;<i> When all 3 servers were booted things went as expected but with an
</I>&gt;<i> erl_crash.dump.  Each server performed the 30 second search and then
</I>&gt;<i> shutdown + crash.dump.  After I noticed all 3 services were not running
</I>&gt;<i> I quickly started each service under the 30 seconds and the cluster came
</I>&gt;<i> up plus no queue data was lost.
</I>&gt;<i>
</I>&gt;<i> Each server had its relative log
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 30-Oct-2012::08:36:36 ===
</I>&gt;<i> Limiting to approx 924 file handles (829 sockets)
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 30-Oct-2012::08:37:13 ===
</I>&gt;<i> Timeout contacting cluster nodes. Since RabbitMQ was shut down forcefully
</I>&gt;<i> it cannot determine which nodes are timing out. Details on all nodes will
</I>&gt;<i> follow.
</I>&gt;<i>
</I>&gt;<i> DIAGNOSTICS
</I>&gt;<i> ===========
</I>&gt;<i>
</I>&gt;<i> nodes in question: ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOBARON-1</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at CUST1-MASTER</A>']
</I>&gt;<i>
</I>&gt;<i> hosts, their running nodes and ports:
</I>&gt;<i> - CUST1-MASTER: [{rabbit,55021}]
</I>&gt;<i> - RIOBARON-1: []
</I>&gt;<i>
</I>&gt;<i> current node details:
</I>&gt;<i> - node name: '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOOVERLORD-1</A>'
</I>&gt;<i> - home dir: C:\Windows
</I>&gt;<i> - cookie hash: MXZdkdzg76BGNNu+ev94Ow==
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 30-Oct-2012::08:37:14 ===
</I>&gt;<i>      application: rabbit
</I>&gt;<i>      exited: {bad_return,{{rabbit,start,[normal,[]]},
</I>&gt;<i>                           {'EXIT',{rabbit,failure_during_boot}}}}
</I>&gt;<i>      type: permanent
</I>&gt;<i>
</I>&gt;<i> Then, in the -sasl.log there is the following entry + the
</I>&gt;<i> &quot;erl_crash.dump&quot; file.
</I>&gt;<i>
</I>&gt;<i> =CRASH REPORT==== 30-Oct-2012::08:35:40 ===
</I>&gt;<i>    crasher:
</I>&gt;<i>      initial call: application_master:init/4
</I>&gt;<i>      pid: &lt;0.133.0&gt;
</I>&gt;<i>      registered_name: []
</I>&gt;<i>      exception exit: {bad_return,{{rabbit,start,[normal,[]]},
</I>&gt;<i>                                   {'EXIT',{rabbit,failure_during_boot}}}}
</I>&gt;<i>        in function  application_master:init/4 (application_master.erl,
</I>&gt;<i> line 138)
</I>&gt;<i>      ancestors: [&lt;0.132.0&gt;]
</I>&gt;<i>      messages: [{'EXIT',&lt;0.134.0&gt;,normal}]
</I>&gt;<i>      links: [&lt;0.132.0&gt;,&lt;0.7.0&gt;]
</I>&gt;<i>      dictionary: []
</I>&gt;<i>      trap_exit: true
</I>&gt;<i>      status: running
</I>&gt;<i>      heap_size: 1597
</I>&gt;<i>      stack_size: 24
</I>&gt;<i>      reductions: 132
</I>&gt;<i>    neighbours:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I do not know if the sasl.log entry has anything to do with the
</I>&gt;<i> crash.dump file output but I have one.
</I>&gt;<i>
</I>&gt;<i> =erl_crash_dump:0.1
</I>&gt;<i> Tue Oct 30 08:37:17 2012
</I>&gt;<i> Slogan: Kernel pid terminated (application_controller)
</I>&gt;<i> ({application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}})
</I>&gt;<i> System version: Erlang R15B02 (erts-5.9.2) [async-threads:30]
</I>&gt;<i> Compiled: Mon Sep  3 11:00:33 2012
</I>&gt;<i> Taints:
</I>&gt;<i> Atoms: 21679
</I>&gt;<i> =memory
</I>&gt;<i> total: 16514240
</I>&gt;<i> processes: 4423098
</I>&gt;<i> processes_used: 4423098
</I>&gt;<i> system: 12091142
</I>&gt;<i> atom: 495069
</I>&gt;<i> atom_used: 481297
</I>&gt;<i> binary: 21864
</I>&gt;<i> code: 9403948
</I>&gt;<i> ets: 27188
</I>&gt;<i> =hash_table:atom_tab
</I>&gt;<i> size: 19289
</I>&gt;<i> used: 13066
</I>&gt;<i> objs: 21679
</I>&gt;<i> depth: 8
</I>&gt;<i> ............................
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, Oct 30, 2012 at 11:49 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> I am not sure quite what you are saying. You say that when you started
</I>&gt;<i> the nodes again, none of them successfully started? And there was &quot;an
</I>&gt;<i> error&quot;. But then you started them &quot;quickly&quot; and that worked?
</I>&gt;<i>
</I>&gt;<i> When each node is started it decides whether it thinks there are any
</I>&gt;<i> other nodes which were running when it was killed. If so it waits 30
</I>&gt;<i> seconds for them to become available and if nothing appears gives an
</I>&gt;<i> error about &quot;timeout waiting for tables&quot;,
</I>&gt;<i>
</I>&gt;<i> Was this the error you saw?
</I>&gt;<i>
</I>&gt;<i> We might make this 30 seconds configurable in future, but we need to
</I>&gt;<i> think of the other case (where people start one node and not the other,
</I>&gt;<i> and don't realise anything is wrong until the timeout).
</I>&gt;<i>
</I>&gt;<i> You should also read:
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/ha.html#unsynchronised-slaves">http://www.rabbitmq.com/ha.html#unsynchronised-slaves</A>
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> On Tuesday, October 30, 2012 9:45:21 AM UTC-5, Mark Ward wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023457.html">[rabbitmq-discuss] Cluster busting - shut off all nodes at the	same time.
</A></li>
	<LI>Next message: <A HREF="023456.html">[rabbitmq-discuss] RabbitMQ + Logstash + Rails
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23473">[ date ]</a>
              <a href="thread.html#23473">[ thread ]</a>
              <a href="subject.html#23473">[ subject ]</a>
              <a href="author.html#23473">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
