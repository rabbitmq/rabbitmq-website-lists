<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] nodename variable and mnesia directory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20nodename%20variable%20and%20mnesia%20directory&In-Reply-To=%3CE94F626F5C43D14F8B8479C5EBD79038A85DE341%40vmexchange02.seegrid.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023268.html">
   <LINK REL="Next"  HREF="023325.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] nodename variable and mnesia directory</H1>
    <B>Elizabeth Liao</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20nodename%20variable%20and%20mnesia%20directory&In-Reply-To=%3CE94F626F5C43D14F8B8479C5EBD79038A85DE341%40vmexchange02.seegrid.local%3E"
       TITLE="[rabbitmq-discuss] nodename variable and mnesia directory">eliao at seegrid.com
       </A><BR>
    <I>Wed Oct 24 22:06:39 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023268.html">[rabbitmq-discuss] nodename variable and mnesia directory
</A></li>
        <LI>Next message: <A HREF="023325.html">[rabbitmq-discuss] nodename variable and mnesia directory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23324">[ date ]</a>
              <a href="thread.html#23324">[ thread ]</a>
              <a href="subject.html#23324">[ subject ]</a>
              <a href="author.html#23324">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I confirmed that when I run the sequence of commands and then log out and log back in, the rabbitmq server seems to start up fine.  However, these commands are run in a script so I didn't want to have to re-login to startup the rabbitmq server.

After trying various things, it seems that rabbit is using the HOSTNAME environment variable and I needed to set that for it to work. So running the following commands appeared to work:

* /etc/init.d/rabbitmq-server stop
* In /etc/hosts changed line from 127.0.1.1 &lt;oldhostname&gt; &lt;oldhostname&gt;.localdomain -&gt; 127.0.1.1 &lt;newhostname&gt; &lt;newhostname&gt;.localdomain
* in /etc/sysconfig/network changed HOSTNAME=&lt;oldhostname&gt; -&gt; HOSTNAME=&lt;newhostname&gt;
* /bin/hostname &lt;newhostname&gt;
* export HOSTNAME=&lt;newhostname&gt;
* /etc/init.d/rabbitmq-server start

Can you confirm this on your system as well?  Is there an added benefit of also running rabbitmqctl stop and epmd -kill?

Thanks.

Liz
________________________________________
From: Tim Watson [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">watson.timothy at gmail.com</A>]
Sent: Tuesday, October 23, 2012 4:33 AM
To: Elizabeth Liao
Cc: Discussions about RabbitMQ
Subject: Re: [rabbitmq-discuss] nodename variable and mnesia directory

Hi

On 22 Oct 2012, at 23:14, Elizabeth Liao &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">eliao at seegrid.com</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> This is what I tried
</I>&gt;<i> * I start running rabbit with no NODENAME set and entered the following commands
</I>&gt;<i>  * rabbitmqctl stop
</I>&gt;<i>  * /etc/init.d/rabbitmq-server stop
</I>&gt;<i>  * epmd -kill ( Is this correct? I didn't see a restart in the documentation )
</I>
That is correct.

&gt;<i>  * In /etc/hosts changed line from 127.0.1.1 &lt;oldhostname&gt; &lt;oldhostname&gt;.localdomain -&gt; 127.0.1.1 &lt;newhostname&gt; &lt;newhostname&gt;.localdomain
</I>&gt;<i>  * in /etc/sysconfig/network changed HOSTNAME=&lt;oldhostname&gt; -&gt; HOSTNAME=&lt;newhostname&gt;
</I>&gt;<i>  * /bin/hostname &lt;newhostname&gt;
</I>
At this point I found I needed to log out and back in again, though that was on centos an I'm not sure it's necessary to restart a profile on all operating systems. What os are you running an what does the documentation state about hostname changes? Do you, for example, have to restart the os networking sub system?

&gt;<i> * /etc/init.d/rabbitmq-server start
</I>&gt;<i>
</I>&gt;<i> The error I get is this:
</I>&gt;<i> Activating RabbitMQ plugins ...
</I>&gt;<i> 3 plugins activated:
</I>&gt;<i> * amqp_client-2.8.6
</I>&gt;<i> * erlando-2.8.6
</I>&gt;<i> * rabbitmq_shovel-2.8.6
</I>&gt;<i>
</I>&gt;<i> ERROR: epmd error for host &quot;&lt;oldhostname&gt;&quot;: nxdomain (non-existing domain)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ________________________________________
</I>&gt;<i> From: Tim Watson [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>]
</I>&gt;<i> Sent: Monday, October 22, 2012 6:41 AM
</I>&gt;<i> To: Discussions about RabbitMQ
</I>&gt;<i> Cc: Elizabeth Liao
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] nodename variable and mnesia directory
</I>&gt;<i>
</I>&gt;<i> Hi again,
</I>&gt;<i>
</I>&gt;<i> On 20 Oct 2012, at 10:52, Tim Watson wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Liz,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sorry i wasn't aware of the context. What Ian recommended should not be necessary, though I'll follow up with him on Monday to try and figure out why he needed to do that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Once you change the hostname you,ll possibly need to restart epmd and restart your rabbit, but you shouldn't need to change the node name from say rabbit to hare.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Were you able to try this again (changing only the host name but not the node name) and did it work for you? If not I'd like to know so we can investigate.
</I>&gt;<i>
</I>&gt;<i> Cheers
</I>&gt;<i> Tim
</I>&gt;<i>
</I>&gt;&gt;<i> Cheers
</I>&gt;&gt;<i> Tim
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 19 Oct 2012, at 19:44, Elizabeth Liao &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">eliao at seegrid.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi Tim,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm going to back up a bit because it seems that I've misunderstood something previously.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The first thing I'm going to say is that this isn't really a desirable
</I>&gt;&gt;&gt;<i> state of affairs. Why do you need to change NODENAME at all, just
</I>&gt;&gt;&gt;<i> because the host name has changed? This seems like an odd step to me -
</I>&gt;&gt;&gt;<i> can you explain the rationale behind it?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I had an earlier problem changing the hostname and restarting the rabbitmq-server. The proposed fix was to add the NODENAME variable which I'm guessing was not right? :
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-July/021435.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-July/021435.html</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Can you explain a bit more about this 'bug' please? What exactly is
</I>&gt;&gt;&gt;<i> going wrong?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The bug is on our end where the NODENAME is set to an empty string. Of course this is moot if NODENAME doesn't even have to be set in the first place.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Liz
</I>&gt;&gt;&gt;<i> ________________________________________
</I>&gt;&gt;&gt;<i> From: Tim Watson [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>]
</I>&gt;&gt;&gt;<i> Sent: Friday, October 19, 2012 12:48 PM
</I>&gt;&gt;&gt;<i> To: Discussions about RabbitMQ
</I>&gt;&gt;&gt;<i> Cc: Elizabeth Liao
</I>&gt;&gt;&gt;<i> Subject: Re: [rabbitmq-discuss] nodename variable and mnesia directory
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 10/19/2012 03:41 PM, Elizabeth Liao wrote:
</I>&gt;&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> We are currently running rabbitmq on a system where there is a need to change the hostname occasionally.  Right now, when the hostname is changed, we also update the NODENAME variable in the rabbitmq-env.conf file.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The first thing I'm going to say is that this isn't really a desirable
</I>&gt;&gt;&gt;<i> state of affairs. Why do you need to change NODENAME at all, just
</I>&gt;&gt;&gt;<i> because the host name has changed? This seems like an odd step to me -
</I>&gt;&gt;&gt;<i> can you explain the rationale behind it?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The problem we're having right now is that due to a bug when setting up the rabbitmq-env.conf file, sometimes the NODENAME variable exists but is not set to anything ( NODENAME=) so rabbit never successfully starts up.  Even after setting the NODENAME variable to the hostname, rabbit still doesn't start up properly.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Can you explain a bit more about this 'bug' please? What exactly is
</I>&gt;&gt;&gt;<i> going wrong?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The only way that I could find to recover from this situation without killing the erlang process, was to also set a MNESIA_DIR variable. After I did that, once the NODENAME was set to the correct hostname, rabbit started up properly.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Now this makes no sense at all to me. If you are trying to recover
</I>&gt;&gt;&gt;<i> 'without killing the erlang process' then how are you planning on
</I>&gt;&gt;&gt;<i> changing the NODENAME? Once an erlang node has become part of a
</I>&gt;&gt;&gt;<i> distributed system, you cannot arbitrarily change the node's name
</I>&gt;&gt;&gt;<i> without restarting the net_kernel AFAIK so I can't see how this is even
</I>&gt;&gt;&gt;<i> possible. Also, because you're stating that 'rabbit started up properly'
</I>&gt;&gt;&gt;<i> I'm assuming that you have in fact taken the node offline (using
</I>&gt;&gt;&gt;<i> `rabbitmqctl stop` or one of the various service scripts that invokes
</I>&gt;&gt;&gt;<i> it) and that you are now starting the node again. The rabbit startup
</I>&gt;&gt;&gt;<i> scripts (and associated infrastructure) is not set up to handle changing
</I>&gt;&gt;&gt;<i> the name of a node post-installation in this manner, so I would not
</I>&gt;&gt;&gt;<i> expect this to work smoothly.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> A couple of questions:
</I>&gt;&gt;&gt;&gt;<i> Is this the proper way to fix the situation?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> No. As I said a moment ago, rabbit is not set up for this kind of
</I>&gt;&gt;&gt;<i> scenario so I'd be very cautious about doing this and would really
</I>&gt;&gt;&gt;<i> recommend against it.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Will this have unintended consequences?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have no idea, but it is entirely possible that various things could
</I>&gt;&gt;&gt;<i> break in obscure and alarming ways. I really would not do this if I were
</I>&gt;&gt;&gt;<i> you.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> We are running rabbitmq-server-2.8.6 and erlang-R15B.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thanks!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Liz. I would like to help you find a safe work-around so that you can
</I>&gt;&gt;&gt;<i> use rabbit in your environment. I would really like to understand why
</I>&gt;&gt;&gt;<i> the changing of a machine's host-name is causing problems for you. I
</I>&gt;&gt;&gt;<i> fully realise that after changing the hostname, it is possible that a
</I>&gt;&gt;&gt;<i> restart may be required (although I'd have to do some research to verify
</I>&gt;&gt;&gt;<i> whether or not this is a hard requirement). But I cannot understand why
</I>&gt;&gt;&gt;<i> a change to the machine's host name requires changing the rabbit
</I>&gt;&gt;&gt;<i> NODENAME at all, unless you've altered the rabbit start scripts to use
</I>&gt;&gt;&gt;<i> 'longnames' configuration (i.e., including the complete host name in the
</I>&gt;&gt;&gt;<i> node name) in which case, a simple solution to your problem might be to
</I>&gt;&gt;&gt;<i> switch back to using 'shortnames'. If erlang is started using -sname
</I>&gt;&gt;&gt;<i> rabbit@`hostname -s` and your /etc/hosts configuration supports
</I>&gt;&gt;&gt;<i> resolving the machine's IP to the short version of the name, then
</I>&gt;&gt;&gt;<i> changing the hostname shouldn't cause all of these headaches.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> For example, if I launch rabbit with something like this:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> env RABBITMQ_NODENAME=rabbit RABBITMQ_NODE_PORT=5672
</I>&gt;&gt;&gt;<i> RABBITMQ_LOG_BASE=&quot;/tmp&quot;
</I>&gt;&gt;&gt;<i> RABBITMQ_MNESIA_DIR=&quot;/tmp/rabbitmq-rabbit-mnesia&quot;
</I>&gt;&gt;&gt;<i> RABBITMQ_PID_FILE=&quot;/tmp/rabbitmq-rabbit.pid&quot;
</I>&gt;&gt;&gt;<i> RABBITMQ_PLUGINS_EXPAND_DIR=&quot;/tmp/rabbitmq-rabbit-plugins-scratch&quot;
</I>&gt;&gt;&gt;<i> RABBITMQ_ENABLED_PLUGINS_FILE=&quot;/tmp/enabled-plugins&quot;
</I>&gt;&gt;&gt;<i> RABBITMQ_CONFIG_FILE=&quot;/tmp/etc/rabbit&quot; ./scripts/rabbitmq-server
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Then change the hostname, then stop rabbit and start it again,
</I>&gt;&gt;&gt;<i> everything is fine.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Cheers,
</I>&gt;&gt;&gt;<i> Tim
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Liz
</I>&gt;&gt;&gt;&gt;<i> Email Confidentiality Notice
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The information contained in this transmission is confidential, proprietary or privileged and may be subject to protection under the law. This message is intended for the sole use of the individual or entity to whom it's addressed. If you are not the intended recipient, you are notified that any use, distribution or copying of the message is strictly prohibited and may subject you to criminal or civil penalties. If you received this transmission in error, please contact the sender immediately by replying to this email and delete the material from any computer.
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Email Confidentiality Notice
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The information contained in this transmission is confidential, proprietary or privileged and may be subject to protection under the law. This message is intended for the sole use of the individual or entity to whom it's addressed. If you are not the intended recipient, you are notified that any use, distribution or copying of the message is strictly prohibited and may subject you to criminal or civil penalties. If you received this transmission in error, please contact the sender immediately by replying to this email and delete the material from any computer.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> Email Confidentiality Notice
</I>&gt;<i>
</I>&gt;<i> The information contained in this transmission is confidential, proprietary or privileged and may be subject to protection under the law. This message is intended for the sole use of the individual or entity to whom it's addressed. If you are not the intended recipient, you are notified that any use, distribution or copying of the message is strictly prohibited and may subject you to criminal or civil penalties. If you received this transmission in error, please contact the sender immediately by replying to this email and delete the material from any computer.
</I>Email Confidentiality Notice

The information contained in this transmission is confidential, proprietary or privileged and may be subject to protection under the law. This message is intended for the sole use of the individual or entity to whom it's addressed. If you are not the intended recipient, you are notified that any use, distribution or copying of the message is strictly prohibited and may subject you to criminal or civil penalties. If you received this transmission in error, please contact the sender immediately by replying to this email and delete the material from any computer.
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023268.html">[rabbitmq-discuss] nodename variable and mnesia directory
</A></li>
	<LI>Next message: <A HREF="023325.html">[rabbitmq-discuss] nodename variable and mnesia directory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23324">[ date ]</a>
              <a href="thread.html#23324">[ thread ]</a>
              <a href="subject.html#23324">[ subject ]</a>
              <a href="author.html#23324">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
