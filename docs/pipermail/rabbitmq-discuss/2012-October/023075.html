<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Response times for publisher confirms
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Response%20times%20for%20publisher%20confirms&In-Reply-To=%3CB306DD00-5B75-438B-9804-B9DEE96A8466%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023059.html">
   <LINK REL="Next"  HREF="023077.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Response times for publisher confirms</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Response%20times%20for%20publisher%20confirms&In-Reply-To=%3CB306DD00-5B75-438B-9804-B9DEE96A8466%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Response times for publisher confirms">tim at rabbitmq.com
       </A><BR>
    <I>Tue Oct 16 12:28:33 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023059.html">[rabbitmq-discuss] Response times for publisher confirms
</A></li>
        <LI>Next message: <A HREF="023077.html">[rabbitmq-discuss] Response times for publisher confirms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23075">[ date ]</a>
              <a href="thread.html#23075">[ thread ]</a>
              <a href="subject.html#23075">[ subject ]</a>
              <a href="author.html#23075">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

On 15 Oct 2012, at 16:32, Aaron Pfeifer wrote:

&gt;<i> Hey everyone -
</I>&gt;<i> 
</I>&gt;<i> We've been running some tests on a RabbitMQ stack that we have running in EC2 and encountered some unexpected behaviors in the response times for publisher confirms and wanted to see if folks here had an idea of what the root cause might be.
</I>&gt;<i> 
</I>&gt;<i> First, some details on the stack:
</I>&gt;<i> * EC2 m1.xlarge (15GB memory, 8 EC2 compute units, 64-bit, 1 Gigabit Ethernet)
</I>&gt;<i> * Ubuntu 10.04
</I>&gt;<i> * Erlang R13B03
</I>&gt;<i> * RabbitMQ 2.8.5
</I>&gt;<i> * Mounted to 4 RAID0 ephemeral drives (I believe 400GB each)
</I>&gt;<i> 
</I>&gt;<i> ...and some details on the setup:
</I>&gt;<i> * 16 durable, fanout exchanges
</I>&gt;<i> * 16 durable queues
</I>&gt;<i> * Each exchange mapped to a single queue
</I>&gt;<i> * Each message published as persistent
</I>&gt;<i> 
</I>&gt;<i> We have about 5,000 connections (over many servers) publishing a message once every 15s.  Each connection has publisher confirms enabled.  Each message is approximately 10-15KB in size (give or take).  While running this test we tracked the following data:
</I>&gt;<i> 
</I>&gt;<i> * Maximum amount of time to receive a confirm: <A HREF="http://i.imgur.com/SrXJP.png">http://i.imgur.com/SrXJP.png</A>
</I>&gt;<i> * Average amount of time to receive a confirm: <A HREF="http://i.imgur.com/ryWmr.png">http://i.imgur.com/ryWmr.png</A>
</I>&gt;<i> 
</I>&gt;<i> Looking at this graph seems to indicate that there's something going on in RabbitMQ about every 10 minutes that causes a significant increase in the amount of time it takes to receive a publisher confirm.
</I>&gt;<i> 
</I>&gt;<i> To get some further data about what was happening during each of these spikes, we logged the following data through vmstat and iostat on the machine: <A HREF="https://gist.github.com/3874134.">https://gist.github.com/3874134.</A>  You'll notice that during this spike we experience a significant decrease in the amount of data being written to disk and a significant increase in the await time on each disk.
</I>&gt;<i> 
</I>
I note from vmstat that there are quite a few other processes running - are you sure that there is no contention for the disk between rabbit and another application running on the instance? If another application is performing synchronous I/O then that might account for some of what you're seeing.

Are you publishing and/or expecting confirms in batches? Can you see a constant (flat) throughput in the management UI as well?

&gt;<i> And just a little background: we were planning on using durable queues and publisher confirms to verify that the message was actually received by RabbitMQ.  I believe I've also read that publisher confirms are typically preferred to transactions.
</I>&gt;<i> 
</I>
Yes they're generally much faster than transactions. Bare in mind though, that if you're asking for confirms and the messages are persistent, then you're asking rabbit to fsync to disk repeatedly which is very expensive. Whether or not this is related to what you're seeing every 10 minutes is a little unclear to me, though some of the more knowledgeable rabbits may spot something I've missed here.

If you're interested in amortizing the round trip cost, then you could consider dealing with confirms asynchronously as well. But either way, it's probably worth making sure there's not I/O contention from outside sources at regular intervals first. 

</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023059.html">[rabbitmq-discuss] Response times for publisher confirms
</A></li>
	<LI>Next message: <A HREF="023077.html">[rabbitmq-discuss] Response times for publisher confirms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23075">[ date ]</a>
              <a href="thread.html#23075">[ thread ]</a>
              <a href="subject.html#23075">[ subject ]</a>
              <a href="author.html#23075">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
