<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cluster busting - shut off all nodes at the	same time.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20busting%20-%20shut%20off%20all%20nodes%20at%20the%0A%09same%20time.&In-Reply-To=%3C92dc557b-b0c8-4e4a-84c7-cfd250b9c241%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023453.html">
   <LINK REL="Next"  HREF="023473.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cluster busting - shut off all nodes at the	same time.</H1>
    <B>Mark Ward</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20busting%20-%20shut%20off%20all%20nodes%20at%20the%0A%09same%20time.&In-Reply-To=%3C92dc557b-b0c8-4e4a-84c7-cfd250b9c241%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Cluster busting - shut off all nodes at the	same time.">ward.mark at gmail.com
       </A><BR>
    <I>Tue Oct 30 18:07:12 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023453.html">[rabbitmq-discuss] Cluster busting - shut off all nodes at the same time.
</A></li>
        <LI>Next message: <A HREF="023473.html">[rabbitmq-discuss] Cluster busting - shut off all nodes at the same time.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23457">[ date ]</a>
              <a href="thread.html#23457">[ thread ]</a>
              <a href="subject.html#23457">[ subject ]</a>
              <a href="author.html#23457">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Simon,

I am sorry that my post appears all over the place. I am trying to work out 
a clear understanding of a cluster to advise what not do do to avoid data 
loss. It is becoming clear that server maintenance must account for the 
status of the queues in the cluster and great care must be applied to 
maintain the cluster. I have read the unsynchronised-saves section and 
basically the cluster buster testing is to purposely break the cluster in 
the way that the queue synchronization is documented to not handle. By 
doing this I am learning in more detail about how the cluster actually 
works.

After looking at the section again this statement stands out &quot;... ensure 
that your use of messaging generally results in very short or empty queues 
that rapidly drain.&quot;  When dealing with the cluster buster test scenarios I 
have been using a scenario that a queue is not empty and is not rapidly 
drained.  

It has us nervous that if each node in the cluster is restarted one at a 
time and allowed to rejoin the cluster then all data in the idle persistent 
queues would be lost. Performing Windows updates might be fatal to idle 
queued data!  To clarify the messages are published with persistent on.

Back to the cluster test scenario....

I guess the conclusion is the cluster performed as designed and it did 
require all nodes in the cluster to be started under the 30 second timeout. 
 Although, I am not sure if the erl_crash.dump is expected.

When all 3 servers were booted things went as expected but with an 
erl_crash.dump.  Each server performed the 30 second search and then 
shutdown + crash.dump.  After I noticed all 3 services were not running I 
quickly started each service under the 30 seconds and the cluster came up 
plus no queue data was lost.

Each server had its relative log 

=INFO REPORT==== 30-Oct-2012::08:36:36 ===
Limiting to approx 924 file handles (829 sockets)

=ERROR REPORT==== 30-Oct-2012::08:37:13 ===
Timeout contacting cluster nodes. Since RabbitMQ was shut down forcefully
it cannot determine which nodes are timing out. Details on all nodes will
follow.

DIAGNOSTICS
===========

nodes in question: ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOBARON-1</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at CUST1-MASTER</A>']

hosts, their running nodes and ports:
- CUST1-MASTER: [{rabbit,55021}]
- RIOBARON-1: []

current node details:
- node name: '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOOVERLORD-1</A>'
- home dir: C:\Windows
- cookie hash: MXZdkdzg76BGNNu+ev94Ow==



=INFO REPORT==== 30-Oct-2012::08:37:14 ===
    application: rabbit
    exited: {bad_return,{{rabbit,start,[normal,[]]},
                         {'EXIT',{rabbit,failure_during_boot}}}}
    type: permanent

Then, in the -sasl.log there is the following entry + the &quot;erl_crash.dump&quot; 
file.

=CRASH REPORT==== 30-Oct-2012::08:35:40 ===
  crasher:
    initial call: application_master:init/4
    pid: &lt;0.133.0&gt;
    registered_name: []
    exception exit: {bad_return,{{rabbit,start,[normal,[]]},
                                 {'EXIT',{rabbit,failure_during_boot}}}}
      in function  application_master:init/4 (application_master.erl, line 
138)
    ancestors: [&lt;0.132.0&gt;]
    messages: [{'EXIT',&lt;0.134.0&gt;,normal}]
    links: [&lt;0.132.0&gt;,&lt;0.7.0&gt;]
    dictionary: []
    trap_exit: true
    status: running
    heap_size: 1597
    stack_size: 24
    reductions: 132
  neighbours:


I do not know if the sasl.log entry has anything to do with the crash.dump 
file output but I have one.

=erl_crash_dump:0.1
Tue Oct 30 08:37:17 2012
Slogan: Kernel pid terminated (application_controller) 
({application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}})
System version: Erlang R15B02 (erts-5.9.2) [async-threads:30]
Compiled: Mon Sep  3 11:00:33 2012
Taints: 
Atoms: 21679
=memory
total: 16514240
processes: 4423098
processes_used: 4423098
system: 12091142
atom: 495069
atom_used: 481297
binary: 21864
code: 9403948
ets: 27188
=hash_table:atom_tab
size: 19289
used: 13066
objs: 21679
depth: 8
............................


On Tue, Oct 30, 2012 at 11:49 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; 
wrote:
I am not sure quite what you are saying. You say that when you started the 
nodes again, none of them successfully started? And there was &quot;an error&quot;. 
But then you started them &quot;quickly&quot; and that worked?

When each node is started it decides whether it thinks there are any other 
nodes which were running when it was killed. If so it waits 30 seconds for 
them to become available and if nothing appears gives an error about 
&quot;timeout waiting for tables&quot;,

Was this the error you saw?

We might make this 30 seconds configurable in future, but we need to think 
of the other case (where people start one node and not the other, and don't 
realise anything is wrong until the timeout).

You should also read:
<A HREF="http://www.rabbitmq.com/ha.html#unsynchronised-slaves">http://www.rabbitmq.com/ha.html#unsynchronised-slaves</A>

Cheers, Simon

On Tuesday, October 30, 2012 9:45:21 AM UTC-5, Mark Ward wrote:
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121030/39c8f876/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121030/39c8f876/attachment.htm</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023453.html">[rabbitmq-discuss] Cluster busting - shut off all nodes at the same time.
</A></li>
	<LI>Next message: <A HREF="023473.html">[rabbitmq-discuss] Cluster busting - shut off all nodes at the same time.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23457">[ date ]</a>
              <a href="thread.html#23457">[ thread ]</a>
              <a href="subject.html#23457">[ subject ]</a>
              <a href="author.html#23457">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
