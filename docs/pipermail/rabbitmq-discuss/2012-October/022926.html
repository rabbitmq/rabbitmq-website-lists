<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Re-subscribing to a queue in a cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Re-subscribing%20to%20a%20queue%20in%20a%20cluster&In-Reply-To=%3CBD46CD450E3D7843BCE36FF301A8BC4C2AA33C57%40LCEEXMB02.LCE.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022894.html">
   <LINK REL="Next"  HREF="022973.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Re-subscribing to a queue in a cluster</H1>
    <B>Adam Brightwell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Re-subscribing%20to%20a%20queue%20in%20a%20cluster&In-Reply-To=%3CBD46CD450E3D7843BCE36FF301A8BC4C2AA33C57%40LCEEXMB02.LCE.com%3E"
       TITLE="[rabbitmq-discuss] Re-subscribing to a queue in a cluster">abrightwell at LCE.com
       </A><BR>
    <I>Tue Oct  9 17:07:06 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022894.html">[rabbitmq-discuss] Re-subscribing to a queue in a cluster
</A></li>
        <LI>Next message: <A HREF="022973.html">[rabbitmq-discuss] Re-subscribing to a queue in a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22926">[ date ]</a>
              <a href="thread.html#22926">[ thread ]</a>
              <a href="subject.html#22926">[ subject ]</a>
              <a href="author.html#22926">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Emile,

Thanks for the response.

So, I think I found my issue.  Or at least it resolved my issue.

It would appear that in order to &quot;re-subscribe&quot; I had to handle this
action in a separate thread.  If I use the following &quot;test&quot; code in my
consumer's &quot;handleCancel()&quot; method it would not work:

public void handleCancel(String consumerTag) {
    Channel channel = super.getChannel();
    TestConsumer consumer = new TestConsumer();
    channel.basicConsume(this.queue, consumer);
}

However, if I put the &quot;basicConsume&quot; off on its own thread, like the
following, I have success:

public void handleCancel(String consumerTag) {
    Channel channel = super.getChannel();
    TestConsumer consumer = new TestConsumer();

    Thread t = new Thread() {
        public void run() {
            try {
                channel.basicConsume(queue, consumer);
            } catch (IOException exception) {
                exception.printStackTrace();
            }
        }
    };
}

Digging further into the threading/concurrency model of RabbitMQ, I found
that I obviously have to be careful about concurrently executing
operations on a single channel.  And I also found that the connection
operations are apparently thread-safe except the ones that involve RPC
calls.  I understand that the &quot;basicConsume&quot; just so happens to be an RPC
based command.

So, with the above in mind, what I can only assume is happening is that
the RPC call involved with the basicConsume is blocking other Channel
based operations.  This is why I suspect that the &quot;basicAck&quot; was unable to
execute successfully and that the &quot;handleDelivery&quot; was never being reached.

I hope this makes sense, but to sum it up it seems that I simply had a
threading problem.  I'm in the process of updating our consumer and
application to handle this properly, but I was curious if there are any
established patterns or guidelines the community might suggest?  For
instance, having a thread pool dedicated for such operations, utilizing
java's ExecutorService or is there something already built in to the
client api that will provide me a way to run this code if I wrapped it in
a Runnable, Callable, etc.?

Also, as a side note, has any consideration been given to using java's
concurrency model more widely in the java client api?  For instance,
synchronization of methods or code blocks to possibly help avoid such
situations?

As for my version, I am currently locked in to 2.8.1.  Unfortunately, I
cannot upgrade yet.  However, I have validated this same behavior in 2.8.7.

Thanks again for all your help, it is greatly appreciated.

Thanks,
Adam



On 10/8/12 7:23 AM, &quot;Emile Joubert&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i>Hi Adam,
</I>&gt;<i>
</I>&gt;<i>On 05/10/12 00:13, Adam Brightwell wrote:
</I>&gt;&gt;<i> 1. Create new consumer and call basicConsume on the original channel.
</I>&gt;&gt;<i> 2. Close original channel, recreate channel and call basicConsume with
</I>&gt;&gt;<i>the
</I>&gt;&gt;<i> new channel.
</I>&gt;&gt;<i> 3. Close the original channel, close the original Connection.
</I>&gt;&gt;<i>Reconnect,
</I>&gt;&gt;<i> recreate channel, call basicConsume with the new channel.
</I>&gt;<i>
</I>&gt;<i>All three options should work, but it is not necessary to re-establish a
</I>&gt;<i>new consumer, channel or connection unless directly connected to the
</I>&gt;<i>failing node and therefore all options do more work than necessary. The
</I>&gt;<i>only required action is to resubscribe the existing consumer (and that
</I>&gt;<i>consumer must be prepared to receive duplicate messages).
</I>&gt;<i>
</I>&gt;&gt;<i> OR they will be consumed and unacknowledged. In the latter case, they
</I>&gt;&gt;<i> are not being processed by my consumer or at least not making it to
</I>&gt;&gt;<i> the &quot;handleDelivery()&quot; method.
</I>&gt;<i>
</I>&gt;<i>So messages are consumed without acknowledgement, but don't make it to
</I>&gt;<i>the handleDelivery method? Can you explain what you mean by that?
</I>&gt;<i>
</I>&gt;<i>Also, what version of RabbitMQ are you using? You are advised to use the
</I>&gt;<i>latest version.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>-Emile
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022894.html">[rabbitmq-discuss] Re-subscribing to a queue in a cluster
</A></li>
	<LI>Next message: <A HREF="022973.html">[rabbitmq-discuss] Re-subscribing to a queue in a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22926">[ date ]</a>
              <a href="thread.html#22926">[ thread ]</a>
              <a href="subject.html#22926">[ subject ]</a>
              <a href="author.html#22926">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
