<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [2.4.0] Durable queue dropped when channel	issues basicAck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5B2.4.0%5D%20Durable%20queue%20dropped%20when%20channel%0A%09issues%20basicAck&In-Reply-To=%3C8fc6dbee-6100-4591-aa10-df892888288e%40r35g2000prj.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012340.html">
   <LINK REL="Next"  HREF="012243.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [2.4.0] Durable queue dropped when channel	issues basicAck</H1>
    <B>jadz0r</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5B2.4.0%5D%20Durable%20queue%20dropped%20when%20channel%0A%09issues%20basicAck&In-Reply-To=%3C8fc6dbee-6100-4591-aa10-df892888288e%40r35g2000prj.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] [2.4.0] Durable queue dropped when channel	issues basicAck">kippage at gmail.com
       </A><BR>
    <I>Sat Apr  2 04:34:15 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012340.html">[rabbitmq-discuss] Reconnect logic for C library
</A></li>
        <LI>Next message: <A HREF="012243.html">[rabbitmq-discuss] [2.4.0] Durable queue dropped when channel issues basicAck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12242">[ date ]</a>
              <a href="thread.html#12242">[ thread ]</a>
              <a href="subject.html#12242">[ subject ]</a>
              <a href="author.html#12242">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi All,

I've run across a problem with durable my durable message queue being
dropped when my channel issues a basicAck. Messages are being sent
with delivery_type 2 (persistent).

If I publish 2 messages into the queue, the first message is processed
by my consumer and issues the basicAck method. An error is generated
in the logs and my queue disappears (running sudo rabbitmqctl
list_queues).

Interestingly enough my consumer is able to process the next message
in the queue, but subsequent messages that are newly published are not
picked up by my consumer.

My understanding is that this would be because the consumer isn't
aware that a new queue has been created.

Any help would be greatly appreciated.

Thanks,
Jared

Publisher code:
$ch = $conn-&gt;channel();
$ch-&gt;access_request($VHOST, false, false, true, true);
$ch-&gt;exchange_declare($EXCHANGE.&quot;_&quot;.$queue, 'direct', false, true,
false);
$ch-&gt;queue_declare($queue, false, true, false, false)  ;
$ch-&gt;queue_bind($queue, $EXCHANGE.&quot;_&quot;.$queue);

Here is the basic code for consuming a message:
public void start() throws IOException
	{
		_channel.queueDeclare(getQueueName(), true, false, false, null);
		_channel.basicConsume(getQueueName(), false, _consumer);
		preConsume(); // class implementing functionality of consumer
initiates internals specific to itselfl
		while(true) {
			QueueingConsumer.Delivery delivery;
			try {
				delivery = _consumer.nextDelivery();
				String message = new String(delivery.getBody());

				consume(message); // message is processed by implemented class
			}
			catch(InterruptedException exception) {
				continue;
			}
			_channel.basicAck(delivery.getEnvelope().getDeliveryTag(),
false); // Queue is dropped here once ack is sent
		}
	}

Error from sasl log:

=CRASH REPORT==== 2-Apr-2011::07:54:59 ===
  crasher:
    pid: &lt;0.358.0&gt;
    registered_name: []
    exception exit: {undef,[{gb_trees,map,
                                      [#Fun&lt;rabbit_amqqueue_process.
12.104672275&gt;,
                                       {0,nil}]},
                            {rabbit_amqqueue_process,confirm_messages,
2},
                            {rabbit_amqqueue_process,next_state,1},
                            {rabbit_amqqueue_process,noreply,1},
                            {gen_server2,handle_msg,2},
                            {proc_lib,wake_up,3}]}
      in function  gen_server2:terminate/3
    initial call: gen_server2:wake_hib({gs2_state,&lt;0.178.0&gt;,&lt;0.358.0&gt;,
                                        {q,
                                         {amqqueue,
                                          {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,
                                           &lt;&lt;&quot;db_company&quot;&gt;&gt;},
                                          true,false,none,
[],&lt;0.358.0&gt;},
 
none,true,rabbit_variable_queue,
                                         {vqstate,
                                          {[],[]},
                                          {0,{[],[]}},
                                          {delta,undefined,
0,undefined},
                                          {0,{[],[]}},
                                          {[],[]},
                                          2,
                                          {dict,2,16,16,8,80,48,
                                           {[],[],[],[],[],[],[],[],[],
[],[],
                                            [],[],[],[],[]},
                                           {{[[0|
                                               {true,
 
&lt;&lt;121,6,154,117,162,112,237,
 
254,21,76,48,123,154,135,53,
                                                  114&gt;&gt;,
                                                {message_properties,
                                                 undefined,false}}]],
                                             [],[],[],[],[],[],[],[],
[],[],
                                             [[1|
                                               {true,
 
&lt;&lt;175,159,166,165,243,114,240,
 
245,199,17,72,46,220,53,186,
                                                  196&gt;&gt;,
                                                {message_properties,
                                                 undefined,false}}]],
                                             [],[],[],[]}}},
                                          undefined,
                                          {0,nil},
                                          {qistate,
                                           &quot;/var/lib/rabbitmq/mnesia/
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-dev</A>/queues/EVF8J2RHRQO46CTTX0DVJKTK9&quot;,
                                           {{dict,0,16,16,8,80,48,
                                             {[],[],[],[],[],[],[],[],
[],[],
                                              [],[],[],[],[],[]},
                                             {{[],[],[],[],[],[],[],[],
[],[],
                                               [],[],[],[],[],[]}}},
                                            [{segment,0,
                                              &quot;/var/lib/rabbitmq/
mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-dev</A>/queues/EVF8J2RHRQO46CTTX0DVJKTK9/0.idx&quot;,
                                              {array,16384,0,undefined,
100000},
                                              2}]},
                                           #Ref&lt;0.0.0.721&gt;,0,262144,
                                           #Fun&lt;rabbit_variable_queue.
2.121033067&gt;,
                                           []},
                                          {{client_msstate,
                                            msg_store_persistent,
 
&lt;&lt;31,33,216,196,241,242,147,144,
 
217,18,255,160,157,100,196,140&gt;&gt;,
                                            {dict,0,16,16,8,80,48,
                                             {[],[],[],[],[],[],[],[],
[],[],
                                              [],[],[],[],[],[]},
                                             {{[],[],[],[],[],[],[],[],
[],[],
                                               [],[],[],[],[],[]}}},
                                            {state,83,
                                             &quot;/var/lib/rabbitmq/mnesia/
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-dev</A>/msg_store_persistent&quot;},
 
rabbit_msg_store_ets_index,
                                            &quot;/var/lib/rabbitmq/mnesia/
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-dev</A>/msg_store_persistent&quot;,
                                            &lt;0.177.0&gt;,85,82,84,86},
                                           {client_msstate,
                                            msg_store_transient,
 
&lt;&lt;16,117,138,232,194,41,140,239,62,
 
188,209,66,185,246,189,69&gt;&gt;,
                                            {dict,0,16,16,8,80,48,
                                             {[],[],[],[],[],[],[],[],
[],[],
                                              [],[],[],[],[],[]},
                                             {{[],[],[],[],[],[],[],[],
[],[],
                                               [],[],[],[],[],[]}}},
                                            {state,78,
                                             &quot;/var/lib/rabbitmq/mnesia/
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-dev</A>/msg_store_transient&quot;},
 
rabbit_msg_store_ets_index,
                                            &quot;/var/lib/rabbitmq/mnesia/
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-dev</A>/msg_store_transient&quot;,
                                            &lt;0.169.0&gt;,80,77,79,81}},
                                          {sync,[],[],[],[]},
                                          true,0,
                                          #Fun&lt;rabbit_amqqueue_process.
4.56639861&gt;,
                                          #Fun&lt;rabbit_amqqueue_process.
5.103465571&gt;,
                                          0,2,infinity,0,0,0,0,0,0,
                                          {rates,
                                           {{1301,691228,21015},0},
                                           {{1301,691228,21015},0},
                                           0.1382354671152684,0.0,
                                           {1301,691230,692626}},
                                          {0,nil},
                                          {0,nil},
                                          {0,nil},
                                          {0,nil},
                                          0,0,
                                          {rates,
                                           {{1301,691228,21015},0},
                                           {{1301,691228,21015},0},
                                           0.0,0.1382354671152684,
                                           {1301,691230,692626}}},
                                         {[{&lt;0.383.0&gt;,
                                            {consumer,
                                             &lt;&lt;&quot;amq.ctag-
ve0ALPxaqYEjstvbwd2p1g==&quot;&gt;&gt;,
                                             true}}],
                                          []},
                                         {[],[]},
 
undefined,undefined,undefined,
                                         undefined,
                                         {state,none,undefined},
                                         {dict,0,16,16,8,80,48,
                                          {[],[],[],[],[],[],[],[],[],
[],[],
                                           [],[],[],[],[]},
                                          {{[],[],[],[],[],[],[],[],[],
[],[],
                                            [],[],[],[],[]}}},
                                         undefined,undefined},
 
rabbit_amqqueue_process,hibernate,
                                        {{1301,691230,692715},
                                         {backoff,2665,1000,10000,
                                          {12376,17423,26819}}},
                                        {queue,[],[]},
 
[],#Fun&lt;gen_server2.13.80334034&gt;,
                                        #Fun&lt;gen_server2.12.71926735&gt;,
 
#Fun&lt;gen_server2.12.71926735&gt;})
    ancestors: [rabbit_amqqueue_sup,rabbit_sup,&lt;0.108.0&gt;]
    messages: [{'$gen_cast',
                      {run_backing_queue,
                          #Fun&lt;rabbit_variable_queue.38.117862577&gt;}}]
    links: [&lt;0.178.0&gt;]
    dictionary: [{fhc_age_tree,{0,nil}},
                  {guid,{{39,&lt;0.358.0&gt;},1}},
                  {{ch,&lt;0.383.0&gt;},
                   {cr,1,&lt;0.383.0&gt;,undefined,#Ref&lt;0.0.0.767&gt;,
                       {sets,1,16,16,8,80,48,
                             {[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[],[]},
                             {{[],[],[],[],[],[],[],[],[],[],[],
                               [1],
                               [],[],[],[]}}},
                       false,none,0}}]
    trap_exit: true
    status: running
    heap_size: 4181
    stack_size: 23
    reductions: 10009
  neighbours:

=SUPERVISOR REPORT==== 2-Apr-2011::07:54:59 ===
     Supervisor: {local,rabbit_amqqueue_sup}
     Context:    child_terminated
     Reason:     {undef,[{gb_trees,map,
                                   [#Fun&lt;rabbit_amqqueue_process.
12.104672275&gt;,
                                    {0,nil}]},
                         {rabbit_amqqueue_process,confirm_messages,2},
                         {rabbit_amqqueue_process,next_state,1},
                         {rabbit_amqqueue_process,noreply,1},
                         {gen_server2,handle_msg,2},
                         {proc_lib,wake_up,3}]}
     Offender:   [{pid,&lt;0.358.0&gt;},
                  {name,rabbit_amqqueue},
                  {mfa,
                      {rabbit_amqqueue_process,start_link,
                          [{amqqueue,
 
{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;db_company&quot;&gt;&gt;},
                               true,false,none,[],none}]}},
                  {restart_type,temporary},
                  {shutdown,4294967295},
                  {child_type,worker}]


Error from log:

=INFO REPORT==== 2-Apr-2011::07:51:40 ===
Limiting to approx 924 file handles (829 sockets)

=INFO REPORT==== 2-Apr-2011::07:51:40 ===
Memory limit set to 806MB.

=INFO REPORT==== 2-Apr-2011::07:51:40 ===
msg_store_transient: using rabbit_msg_store_ets_index to provide index

=INFO REPORT==== 2-Apr-2011::07:51:40 ===
msg_store_persistent: using rabbit_msg_store_ets_index to provide
index

=INFO REPORT==== 2-Apr-2011::07:51:40 ===
started TCP Listener on 0.0.0.0:5672

=ERROR REPORT==== 2-Apr-2011::07:51:40 ===
** gen_event handler rabbit_error_logger crashed.
** Was installed in error_logger
** Last event was: {info_msg,&lt;0.107.0&gt;,
                             {&lt;0.182.0&gt;,&quot;started ~s on ~s:~p~n&quot;,
                              [&quot;TCP Listener&quot;,&quot;0.0.0.0&quot;,5672]}}
** When handler state ==
{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;amq.rabbitmq.log&quot;&gt;&gt;}
** Reason == {'function not exported',
                 [{mnesia,read,
                      [rabbit_topic_trie_edge,
                       {trie_edge,
 
{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;amq.rabbitmq.log&quot;&gt;&gt;},
                           root,&quot;info&quot;}]},
                  {rabbit_exchange_type_topic,trie_child,3},
                  {rabbit_exchange_type_topic,trie_match_part,6},
                  {lists,foldl,3},
                  {mnesia_tm,non_transaction,5},
                  {rabbit_exchange_type_topic,'-route/2-lc$^0/1-0-',
2},
                  {rabbit_exchange_type_topic,route,2},
                  {rabbit_exchange,route,2}]}

=INFO REPORT==== 2-Apr-2011::07:53:33 ===
accepted TCP connection on 0.0.0.0:5672 from 127.0.0.1:34112

=INFO REPORT==== 2-Apr-2011::07:53:33 ===
starting TCP connection &lt;0.353.0&gt; from 127.0.0.1:34112

=INFO REPORT==== 2-Apr-2011::07:53:33 ===
closing TCP connection &lt;0.353.0&gt; from 127.0.0.1:34112

=INFO REPORT==== 2-Apr-2011::07:53:46 ===
accepted TCP connection on 0.0.0.0:5672 from 192.168.1.17:56019

=INFO REPORT==== 2-Apr-2011::07:53:46 ===
starting TCP connection &lt;0.380.0&gt; from 192.168.1.17:56019

=ERROR REPORT==== 2-Apr-2011::07:54:59 ===
** Generic server &lt;0.358.0&gt; terminating
** Last message in was {'$gen_cast',
                           {run_backing_queue,
                               #Fun&lt;rabbit_variable_queue.
38.117862577&gt;}}
** When Server state == {q,
                         {amqqueue,
                          {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;db_company&quot;&gt;&gt;},
                          true,false,none,[],&lt;0.358.0&gt;},
                         none,true,rabbit_variable_queue,
                         {vqstate,
                          {[],[]},
                          {0,{[],[]}},
                          {delta,undefined,0,undefined},
                          {0,{[],[]}},
                          {[],[]},
                          2,
                          {dict,1,16,16,8,80,48,
                           {[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[]},
                           {{[],[],[],[],[],[],[],[],[],[],[],
                             [[1|
                               {true,
 
&lt;&lt;175,159,166,165,243,114,240,245,199,17,72,46,
                                  220,53,186,196&gt;&gt;,
 
{message_properties,undefined,false}}]],
                             [],[],[],[]}}},
                          undefined,
                          {0,nil},
                          {qistate,
                           &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-dev</A>/
queues/EVF8J2RHRQO46CTTX0DVJKTK9&quot;,
                           {{dict,0,16,16,8,80,48,
                             {[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[],[]},
                             {{[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[],
                               []}}},
                            [{segment,0,
                              &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-</A>
dev/queues/EVF8J2RHRQO46CTTX0DVJKTK9/0.idx&quot;,
                              {array,16384,0,undefined,
                               {{{{{{no_pub,no_del,ack},
 
undefined,undefined,undefined,undefined,
 
undefined,undefined,undefined,undefined,
                                    undefined},
                                   10,10,10,10,10,10,10,10,10,10},
 
100,100,100,100,100,100,100,100,100,100},
 
1000,1000,1000,1000,1000,1000,1000,1000,1000,
                                 1000},
 
10000,10000,10000,10000,10000,10000,10000,
                                10000,10000,10000}},
                              1}]},
                           #Ref&lt;0.0.0.721&gt;,1,262144,
                           #Fun&lt;rabbit_variable_queue.2.121033067&gt;,
[]},
                          {{client_msstate,msg_store_persistent,
 
&lt;&lt;31,33,216,196,241,242,147,144,217,18,255,160,157,
                              100,196,140&gt;&gt;,
                            {dict,0,16,16,8,80,48,
                             {[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[],[]},
                             {{[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[],
                               []}}},
                            {state,83,
                             &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-</A>
dev/msg_store_persistent&quot;},
                            rabbit_msg_store_ets_index,
                            &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-</A>
dev/msg_store_persistent&quot;,
                            &lt;0.177.0&gt;,85,82,84,86},
                           {client_msstate,msg_store_transient,
 
&lt;&lt;16,117,138,232,194,41,140,239,62,188,209,66,185,
                              246,189,69&gt;&gt;,
                            {dict,0,16,16,8,80,48,
                             {[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[],[]},
                             {{[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[],
                               []}}},
                            {state,78,
                             &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-</A>
dev/msg_store_transient&quot;},
                            rabbit_msg_store_ets_index,
                            &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at involv-</A>
dev/msg_store_transient&quot;,
                            &lt;0.169.0&gt;,80,77,79,81}},
                          {sync,[],[],[],[]},
                          true,0,#Fun&lt;rabbit_amqqueue_process.
4.56639861&gt;,
                          #Fun&lt;rabbit_amqqueue_process.5.103465571&gt;,
0,1,
                          infinity,0,0,0,0,0,0,
                          {rates,
                           {{1301,691228,21015},0},
                           {{1301,691228,21015},0},
                           0.1382354671152684,0.0,
                           {1301,691230,692626}},
                          {0,nil},
                          {0,nil},
                          {0,nil},
                          {0,nil},
                          1,0,
                          {rates,
                           {{1301,691228,21015},0},
                           {{1301,691228,21015},0},
                           0.0,0.1382354671152684,
                           {1301,691230,692626}}},
                         {[{&lt;0.383.0&gt;,
                            {consumer,
                             &lt;&lt;&quot;amq.ctag-
ve0ALPxaqYEjstvbwd2p1g==&quot;&gt;&gt;,true}}],
                          []},
                         {[],[]},
                         undefined,undefined,
                         {1301691304961094,#Ref&lt;0.0.0.828&gt;},
                         undefined,
                         {state,none,undefined},
                         {dict,0,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[]},
                          {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
[],[]}}},
                         undefined,undefined}
** Reason for termination ==
** {'function not exported',
       [{gb_trees,map,
            [#Fun&lt;rabbit_amqqueue_process.12.104672275&gt;,{0,nil}]},
        {rabbit_amqqueue_process,confirm_messages,2},
        {rabbit_amqqueue_process,next_state,1},
        {rabbit_amqqueue_process,noreply,1},
        {gen_server2,handle_msg,2},
        {proc_lib,wake_up,3}]}

=WARNING REPORT==== 2-Apr-2011::07:57:22 ===
exception on TCP connection &lt;0.380.0&gt; from 192.168.1.17:56019
connection_closed_abruptly

=INFO REPORT==== 2-Apr-2011::07:57:22 ===
closing TCP connection &lt;0.380.0&gt; from 192.168.1.17:56019

=INFO REPORT==== 2-Apr-2011::07:57:44 ===
accepted TCP connection on 0.0.0.0:5672 from 192.168.1.17:56066

=INFO REPORT==== 2-Apr-2011::07:57:44 ===
starting TCP connection &lt;0.738.0&gt; from 192.168.1.17:56066

=INFO REPORT==== 2-Apr-2011::07:57:47 ===
accepted TCP connection on 0.0.0.0:5672 from 127.0.0.1:49494

=INFO REPORT==== 2-Apr-2011::07:57:47 ===
starting TCP connection &lt;0.750.0&gt; from 127.0.0.1:49494

=INFO REPORT==== 2-Apr-2011::07:57:47 ===
closing TCP connection &lt;0.750.0&gt; from 127.0.0.1:49494

</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012340.html">[rabbitmq-discuss] Reconnect logic for C library
</A></li>
	<LI>Next message: <A HREF="012243.html">[rabbitmq-discuss] [2.4.0] Durable queue dropped when channel issues basicAck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12242">[ date ]</a>
              <a href="thread.html#12242">[ thread ]</a>
              <a href="subject.html#12242">[ subject ]</a>
              <a href="author.html#12242">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
