<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] server crashes with very fast consumers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20server%20crashes%20with%20very%20fast%20consumers&In-Reply-To=%3C208F31D5-72F9-4CFB-860F-27DA4A35E4B6%40detreville.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012314.html">
   <LINK REL="Next"  HREF="012313.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] server crashes with very fast consumers</H1>
    <B>John DeTreville</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20server%20crashes%20with%20very%20fast%20consumers&In-Reply-To=%3C208F31D5-72F9-4CFB-860F-27DA4A35E4B6%40detreville.org%3E"
       TITLE="[rabbitmq-discuss] server crashes with very fast consumers">john at detreville.org
       </A><BR>
    <I>Fri Apr  8 21:37:08 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012314.html">[rabbitmq-discuss] Management plugin
</A></li>
        <LI>Next message: <A HREF="012313.html">[rabbitmq-discuss] server crashes with very fast consumers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12311">[ date ]</a>
              <a href="thread.html#12311">[ thread ]</a>
              <a href="subject.html#12311">[ subject ]</a>
              <a href="author.html#12311">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex,

I ran your tests on a Linux VM with much larger ulimits. I saw some problems, but not the crash you described.

Your scripts start up 1,000 Unix processes to declare 1,000 queues, then 1,000 processes to publish messages (each to &quot;its&quot; queue), then 1,000 processes to consume messages (each from &quot;its&quot; queue). Each publishing process publishes 3,000 messages; each consuming process consumes 3,000 messages.

When I run your test, many of the publishers and consumers die because they can't contact the RabbitMQ broker, or can't connect to it in time. This is not surprising, since a small VM with over 1,000 active processes will run very slowly. The failing processes die with messages like &quot;Cannot connect to localhost:5672&quot; and &quot;Opening socket: Connection timed out&quot; and so on.

Although these processes were temporarily unable to connect to the RabbitMQ broker, the broker itself seems to behave properly; it processes messages from and to the subset of publishers and consumers that were able to get through the initial connection storm. It had nothing unusual in its log.

Could you confirm that this is NOT the failure mode you saw? And how did you know that the RabbitMQ broker had crashed? Did the process go away? Or was it impossible to contact it later on? And how did you try to contact it?

Cheers,
John

On Mar 29, 2011, at 6:54 PM, John DeTreville wrote:

&gt;<i> My laptop has a lower ulimit hardwired in. I'll build a VM running another OS.
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> John
</I>&gt;<i> 
</I>&gt;<i> On Mar 29, 2011, at 12:10 AM, alex chen wrote:
</I>&gt;<i> 
</I>&gt;<i> John,
</I>&gt;<i> 
</I>&gt;&gt;<i> One more question. You say RabbitMQ crashes when you run these tests? And it crashes without writing anything interesting in th logs? Or printing anything to the console? It just exits?
</I>&gt;<i> 
</I>&gt;<i> It crashed without any errors in the log.
</I>&gt;<i> 
</I>&gt;<i> I found a problem with my the amqp_consumer.c that I sent last week.  it did not send acknowledgement after consuming the messages.  Attached please find the updated amqp_consumer with ack enabled.  please use this for testing.
</I>&gt;<i> 
</I>&gt;<i> Currently the tests would send 3000 messages to each queue (MESSAGE_COUNT=3000 in common.sh).
</I>&gt;<i> If you find some fast consumers already finish consuming 3000 messages much earlier than other consumers, please change MESSAGE_COUNT=5000.  this would reliably reproduce the broker crash.  if you ran
</I>&gt;<i> &quot;top | grep beam&quot; while all 1000 consumers are running, you can see its memory usage grows to more than 3500 MB before it crashes.
</I>&gt;<i> 
</I>&gt;<i> Thanks.
</I>&gt;<i> 
</I>&gt;<i> -alex
</I>&gt;<i> 
</I>&gt;<i> &lt;amqp_consumer.c&gt;
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012314.html">[rabbitmq-discuss] Management plugin
</A></li>
	<LI>Next message: <A HREF="012313.html">[rabbitmq-discuss] server crashes with very fast consumers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12311">[ date ]</a>
              <a href="thread.html#12311">[ thread ]</a>
              <a href="subject.html#12311">[ subject ]</a>
              <a href="author.html#12311">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
