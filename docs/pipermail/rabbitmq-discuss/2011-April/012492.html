<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%202.3.1%20high%20CPU%20usage%20%26%20disks%20operations&In-Reply-To=%3CBANLkTindRBsXO-FSDj4%2BPs3Zmpzs4qC6TQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012489.html">
   <LINK REL="Next"  HREF="012498.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations</H1>
    <B>Raphael Simon</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%202.3.1%20high%20CPU%20usage%20%26%20disks%20operations&In-Reply-To=%3CBANLkTindRBsXO-FSDj4%2BPs3Zmpzs4qC6TQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations">raphael at rightscale.com
       </A><BR>
    <I>Thu Apr 21 00:58:14 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012489.html">[rabbitmq-discuss] Is there a way to get all the queues for a channel ?
</A></li>
        <LI>Next message: <A HREF="012498.html">[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12492">[ date ]</a>
              <a href="thread.html#12492">[ thread ]</a>
              <a href="subject.html#12492">[ subject ]</a>
              <a href="author.html#12492">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,

We recently moved from RabbitMQ 1.8 to 2.3.1 on production and since then we
have noticed that after a few days of operations the brokers will get into a
mode where they use a lot of cpu to the point where it gets impossible to
even use SSH on the machines. This seems to get triggered when many queues
get deleted. Inspecting the broker (OS) processes with etop indicates a lot
of reductions in (Erlang) processes that are currently executing
prim_file:drv_get_response. This is correlated by the collectd daemon
showing &gt; 12,000 reads / sec and &gt; 2000 writes /sec ! These disks access
don't end up hitting the actual disk (are served by the OS cache) hence the
high throughput.

It seems to always be the same processes causing this (around 20). Looking
at the state of one using sys:get_status returns [1]. Looks like a queue
process. There are about 9K queues on the brokers when this happens and ~60K
messages. Up to this happening the brokers hover around 40% cpu usage
peaking at 60% when the message store is combining the messages (about every
5 minutes with our throughput).

It's interesting that this seems to be caused by a small amount of queue
processes, always the same that come up in etop. Also the CPU graph is a
direct reflection of the disk ops graph.

So what are the scenarios that will cause a queue process to access the disk
in what looks like an infinite loop? Anything else that could be causing
this behavior?

Thanks!

--
Raphael.

[1]
{status,&lt;0.17050.0&gt;,
        {module,gen_server2},
        [[{{#Ref&lt;0.0.1.210978&gt;,fhc_handle},
           {handle,{file_descriptor,prim_file,{#Port&lt;0.29642&gt;,8437}},
                   0,0,false,576,infinity,
                   [[&lt;&lt;192,0,0,0,0,0,64,144&gt;&gt;],
                    [&lt;&lt;128,0,0,0,0,0,64,144&gt;&gt;],
                    [&lt;&lt;0,0,0,0,0,0,65,166&gt;&gt;,
                     [&lt;&lt;218,154,254,188,128,203,224,...&gt;&gt;,
                      &lt;&lt;0,4,161,101,66,238,...&gt;&gt;]],
                    [&lt;&lt;192,0,0,0,0,0,64,143&gt;&gt;],
                    [&lt;&lt;128,0,0,0,0,0,64,...&gt;&gt;],
                    [&lt;&lt;0,0,0,0,0,0,...&gt;&gt;,
                     [&lt;&lt;134,78,165,193,...&gt;&gt;,&lt;&lt;0,4,161,...&gt;&gt;]],
                    [&lt;&lt;192,0,0,0,0,...&gt;&gt;],
                    [&lt;&lt;128,0,0,0,...&gt;&gt;],
                    [&lt;&lt;0,0,0,...&gt;&gt;,[&lt;&lt;&quot;u&lt;&quot;...&gt;&gt;,&lt;&lt;...&gt;&gt;]],
                    [&lt;&lt;192,0,...&gt;&gt;],
                    [&lt;&lt;128,...&gt;&gt;],
                    [&lt;&lt;...&gt;&gt;|...],
                    [...]|...],
                   true,
                   &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at broker1-2</A>
/queues/FIN41VKU7DXMV7IZOJED8MUO/journal.jif&quot;,
                   [write,binary,raw,read],
                   [{write_buffer,infinity}],
                   true,true,
                   {1303,269920,172427}}},
          {{#Ref&lt;0.0.474.103189&gt;,fhc_handle},
           {handle,{file_descriptor,prim_file,{#Port&lt;0.116464&gt;,596}},
                   15487841,0,false,0,1048576,[],false,
                   &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at broker1-2</A>
/msg_store_persistent/0.rdq&quot;,
                   [raw,binary,read],
                   [{write_buffer,1048576}],
                   false,true,
                   {1303,269928,232634}}},
          {'$ancestors',[rabbit_amqqueue_sup,rabbit_sup,&lt;0.131.0&gt;]},
          {{&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at broker1-2</A>
/msg_store_persistent/0.rdq&quot;,
            fhc_file},
           {file,1,false}},
          {fhc_age_tree,{2,
                         {{1303,269920,172427},
                          #Ref&lt;0.0.1.210978&gt;,nil,

 {{1303,269928,232634},#Ref&lt;0.0.474.103189&gt;,nil,nil}}}},
          {{&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at broker1-2</A>
/queues/FIN41VKU7DXMV7IZOJED8MUO/journal.jif&quot;,
            fhc_file},
           {file,1,true}},
          {'$initial_call',{gen,init_it,6}}],
         running,&lt;0.10398.0&gt;,[],
         [{header,&quot;Status for generic server &lt;0.17050.0&gt;&quot;},
          {data,[{&quot;Status&quot;,running},
                 {&quot;Parent&quot;,&lt;0.10398.0&gt;},
                 {&quot;Logged events&quot;,[]},
                 {&quot;Queued messages&quot;,[]}]},
          {data,[{&quot;State&quot;,
                  {q,{amqqueue,{resource,&lt;&lt;&quot;/right_net&quot;&gt;&gt;,queue,
                                         &lt;&lt;&quot;nanite-rs-instan&quot;...&gt;&gt;},
                               true,false,none,
                               [{&lt;&lt;&quot;x-messag&quot;...&gt;&gt;,signedint,86400000}],
                               &lt;0.17050.0&gt;},
                     none,false,rabbit_variable_queue,
                     {vqstate,{[],[]},
                              {0,{[],...}},
                              {delta,undefined,...},
                              {277,...},
                              {...},...},
                     {[],[]},
                     {[],[]},
                     undefined,
                     {1303269928237652,#Ref&lt;0.0.1710.21035&gt;},
                     {1303269928766020,...},
                     undefined,...}}]}]]}
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110420/cf1915c8/attachment-0001.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110420/cf1915c8/attachment-0001.htm</A>&gt;
</PRE>





















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012489.html">[rabbitmq-discuss] Is there a way to get all the queues for a channel ?
</A></li>
	<LI>Next message: <A HREF="012498.html">[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12492">[ date ]</a>
              <a href="thread.html#12492">[ thread ]</a>
              <a href="subject.html#12492">[ subject ]</a>
              <a href="author.html#12492">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
