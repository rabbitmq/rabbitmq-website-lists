<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Clustering issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Clustering%20issue&In-Reply-To=%3Cb54b0231-4816-4b72-b874-78d13579e9f0%40a19g2000prj.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012460.html">
   <LINK REL="Next"  HREF="012464.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Clustering issue</H1>
    <B>Valentin Bernard</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Clustering%20issue&In-Reply-To=%3Cb54b0231-4816-4b72-b874-78d13579e9f0%40a19g2000prj.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Clustering issue">vbernard42 at gmail.com
       </A><BR>
    <I>Tue Apr 19 14:16:24 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012460.html">[rabbitmq-discuss] Clustering issue
</A></li>
        <LI>Next message: <A HREF="012464.html">[rabbitmq-discuss] Clustering issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12463">[ date ]</a>
              <a href="thread.html#12463">[ thread ]</a>
              <a href="subject.html#12463">[ subject ]</a>
              <a href="author.html#12463">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thank you for your explanations.

Yet, there is still something odd about it. Here is a concrete case:

We have three nodes on three different hosts (n1, n2 and n3), all
connected as a cluster on the local network.
The &quot;rabbitmqctl status&quot; command on any of these nodes shows the
following:
   {nodes,[{disc,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at n1</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n2</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n3</A>]}]},
   {running_nodes,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at n1</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n2</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n3</A>]}]

Now, we physically disconnect n1 from the local network, then
reconnect it after a little while.

n1 now shows the following:
   {nodes,[{disc,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at n1</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n2</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n3</A>]}]},
   {running_nodes,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at n1</A>]}]

... while n2 and n3 both logically show the following:
   {nodes,[{disc,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at n1</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n2</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n3</A>]}]},
   {running_nodes,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at n2</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n3</A>]}]

The cluster is partitioned, as you've explained. Now here is the
thing: if we just run the following commands on either n1, n2 OR n3:
   &gt; rabbitmqctl stop_app
   &gt; rabbitmqctl start_app

... then all the nodes are back to the cluster, and the &quot;status&quot;
command shows the following on every node:
   {nodes,[{disc,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at n1</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n2</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n3</A>]}]},
   {running_nodes,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at n1</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n2</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at n3</A>]}]

... and at the same time, we get a few inconsistent_database/
running_partitioned_network errors in the logs. If, while the cluster
was partitioned, we added or deleted some queues/exchanges, the nodes
indeed aren't synchronized, and even though they consider being in the
same cluster (and are able to communicate between each other), they
aren't aware of the same entities. No node were reseted during the
whole process. Is that a bug? This really isn't a problem for us, but
that's still somewhat disturbing &#8211; if the mnesia database is
inconsistent, the cluster should probably remain partitioned ;)

Thanks,

Valentin.

On 19 avr, 12:59, Matthew Sackman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matt... at rabbitmq.com</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> On Fri, Apr 08, 2011 at 01:33:15AM -0700, Valentin Bernard wrote:
</I>&gt;<i> &gt; I have a question regarding clustering. If, for test reasons, I break
</I>&gt;<i> &gt; the physical link between two nodes (without stopping them), then
</I>&gt;<i> &gt; restore the link, the cluster is split and the nodes can't communicate
</I>&gt;<i> &gt; between each other until I either kill a node process and restart it,
</I>&gt;<i> &gt; or run the stop_app/cluster/start_app commands on one node with
</I>&gt;<i> &gt; rabbitmqctl.
</I>&gt;<i>
</I>&gt;<i> &gt; Is that a normal behavior?
</I>&gt;<i>
</I>&gt;<i> Yes.
</I>&gt;<i>
</I>&gt;<i> &gt; I couldn't find any documentation or
</I>&gt;<i> &gt; discussion about this issue. Is there a way to make the nodes
</I>&gt;<i> &gt; automatically join the cluster back after a network failure?
</I>&gt;<i>
</I>&gt;<i> No, not without resetting one node. During the time of the network
</I>&gt;<i> partition, both nodes remain working, but they can diverge - e.g. one
</I>&gt;<i> node could have a client delete a queue, but the other node doesn't.
</I>&gt;<i> It's then not clear what should happen when the partition goes away.
</I>&gt;<i> Rabbit does not attempt to cope with partitions - it's incredibly
</I>&gt;<i> difficult.
</I>&gt;<i>
</I>&gt;<i> Matthew
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012460.html">[rabbitmq-discuss] Clustering issue
</A></li>
	<LI>Next message: <A HREF="012464.html">[rabbitmq-discuss] Clustering issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12463">[ date ]</a>
              <a href="thread.html#12463">[ thread ]</a>
              <a href="subject.html#12463">[ subject ]</a>
              <a href="author.html#12463">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
