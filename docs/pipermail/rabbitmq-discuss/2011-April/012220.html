<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] ERL crashes when messages are being pumped into a queue under win32 envir
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20ERL%20crashes%20when%20messages%20are%20being%20pumped%0A%20into%20a%20queue%20under%20win32%20envir&In-Reply-To=%3C19F7DB1491CA0149AF64F65336540FEA0E63EE05%40server.rmmsoft.com.cn%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012233.html">
   <LINK REL="Next"  HREF="012240.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] ERL crashes when messages are being pumped into a queue under win32 envir</H1>
    <B>Ming Li</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20ERL%20crashes%20when%20messages%20are%20being%20pumped%0A%20into%20a%20queue%20under%20win32%20envir&In-Reply-To=%3C19F7DB1491CA0149AF64F65336540FEA0E63EE05%40server.rmmsoft.com.cn%3E"
       TITLE="[rabbitmq-discuss] ERL crashes when messages are being pumped into a queue under win32 envir">mli at rmmsoft.com.cn
       </A><BR>
    <I>Fri Apr  1 03:11:23 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012233.html">[rabbitmq-discuss] Searchable version of the list archives?
</A></li>
        <LI>Next message: <A HREF="012240.html">[rabbitmq-discuss] ERL crashes when messages are being pumped into a queue under win32 envir
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12220">[ date ]</a>
              <a href="thread.html#12220">[ thread ]</a>
              <a href="subject.html#12220">[ subject ]</a>
              <a href="author.html#12220">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>My test environment:  receiver and broker running on the same hardware, the broker ran out of memory and not the receiver, since we do not process any messages received.

RabbitMQ's RAM started to increase and fast, far exceeded win32's limitation.  It  does crash at times, but other times,  my receiver and senders would stop working, RabbitMQ would still being shown in the process list, but when use rabbitmqctl to check the state of it, it tells me the node is already down/none existent. 

Also, my sender and receiver memory consumption rather stable, well within our assessment.


Process	           pid      	Physical Mem   		Visual Mem   		  threads
Erl.exe	        		2992		757524K	876384K		41



here is a snippet of the broker log file:

=INFO REPORT==== 1-Apr-2011::09:32:13 ===
Memory limit set to 819MB.

=INFO REPORT==== 1-Apr-2011::09:32:13 ===
Added vhost &lt;&lt;&quot;/&quot;&gt;&gt;

=INFO REPORT==== 1-Apr-2011::09:32:13 ===
Created user &lt;&lt;&quot;guest&quot;&gt;&gt;

=INFO REPORT==== 1-Apr-2011::09:32:13 ===
Set user admin flag for user &lt;&lt;&quot;guest&quot;&gt;&gt; to true

=INFO REPORT==== 1-Apr-2011::09:32:13 ===
msg_store_transient: using rabbit_msg_store_ets_index to provide index

=INFO REPORT==== 1-Apr-2011::09:32:13 ===
msg_store_persistent: using rabbit_msg_store_ets_index to provide index

=WARNING REPORT==== 1-Apr-2011::09:32:13 ===
msg_store_persistent: rebuilding indices from scratch

=INFO REPORT==== 1-Apr-2011::09:32:13 ===
started TCP Listener on 0.0.0.0:9007

=INFO REPORT==== 1-Apr-2011::09:32:25 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5610

=INFO REPORT==== 1-Apr-2011::09:32:25 ===
starting TCP connection &lt;0.255.0&gt; from 192.168.3.43:5610

=INFO REPORT==== 1-Apr-2011::09:32:34 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5611

=INFO REPORT==== 1-Apr-2011::09:32:34 ===
starting TCP connection &lt;0.277.0&gt; from 192.168.3.43:5611

=INFO REPORT==== 1-Apr-2011::09:32:41 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5612

=INFO REPORT==== 1-Apr-2011::09:32:41 ===
starting TCP connection &lt;0.295.0&gt; from 192.168.3.43:5612

=INFO REPORT==== 1-Apr-2011::09:32:48 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5613

=INFO REPORT==== 1-Apr-2011::09:32:48 ===
starting TCP connection &lt;0.312.0&gt; from 192.168.3.43:5613

=INFO REPORT==== 1-Apr-2011::09:32:58 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5614

=INFO REPORT==== 1-Apr-2011::09:32:58 ===
starting TCP connection &lt;0.335.0&gt; from 192.168.3.43:5614

=INFO REPORT==== 1-Apr-2011::09:33:07 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5615

=INFO REPORT==== 1-Apr-2011::09:33:07 ===
starting TCP connection &lt;0.357.0&gt; from 192.168.3.43:5615

=INFO REPORT==== 1-Apr-2011::09:33:09 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5616

=INFO REPORT==== 1-Apr-2011::09:33:09 ===
starting TCP connection &lt;0.367.0&gt; from 192.168.3.43:5616

=INFO REPORT==== 1-Apr-2011::09:33:13 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5617

=INFO REPORT==== 1-Apr-2011::09:33:13 ===
starting TCP connection &lt;0.382.0&gt; from 192.168.3.43:5617

=INFO REPORT==== 1-Apr-2011::09:33:14 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5618

=INFO REPORT==== 1-Apr-2011::09:33:14 ===
starting TCP connection &lt;0.389.0&gt; from 192.168.3.43:5618

=INFO REPORT==== 1-Apr-2011::09:33:22 ===
accepted TCP connection on 0.0.0.0:9007 from 192.168.3.43:5619

=INFO REPORT==== 1-Apr-2011::09:33:22 ===
starting TCP connection &lt;0.409.0&gt; from 192.168.3.43:5619

=INFO REPORT==== 1-Apr-2011::09:37:20 ===
vm_memory_high_watermark set. Memory used:860143728 allowed:858993459

=INFO REPORT==== 1-Apr-2011::09:37:20 ===
    alarm_handler: {set,{{vm_memory_high_watermark,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at DEV-004</A>'},[]}}

=INFO REPORT==== 1-Apr-2011::09:37:20 ===
vm_memory_high_watermark clear. Memory used:858369128 allowed:858993459

=INFO REPORT==== 1-Apr-2011::09:37:20 ===
    alarm_handler: {clear,{vm_memory_high_watermark,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at DEV-004</A>'}}

=INFO REPORT==== 1-Apr-2011::09:37:22 ===
vm_memory_high_watermark set. Memory used:859860800 allowed:858993459

=INFO REPORT==== 1-Apr-2011::09:37:22 ===
    alarm_handler: {set,{{vm_memory_high_watermark,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at DEV-004</A>'},[]}}



thanks



----------------------------------
Ming Li

-----Original Message-----
From: Emile Joubert [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>] 
Sent: Thursday, March 31, 2011 11:26 PM
To: Ming Li
Cc: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Subject: Re: [rabbitmq-discuss] ERL crashes when messages are being pumped into a queue under win32 envir

Hi Ming,

On 30/03/11 10:40, Ming Li wrote:
&gt;<i> 1.using RabbitMQ2.4.0(windows bundle).winxp,creates an exchange and a queue.
</I>&gt;<i>
</I>&gt;<i> 2.use multiple sender to send messages into the created queue,only a 
</I>&gt;<i> single receiverreceiving message from the same queue.
</I>&gt;<i>
</I>&gt;<i> 3.while running, what i discovered is that the ERL's RAM usage 
</I>&gt;<i> continue to increase and then crash when it reaches a certain 
</I>&gt;<i> percentage
</I>&gt;<i>
</I>&gt;<i> Is there a way to prevent it from crashing?
</I>
Are you sure it's the broker that runs out of memory and not the receiver? Is the receiver and the rabbit broker running on the same hardware?

I see that the channel is not setting QoS. This will cause the broker to deliver messages to the receiver QueueingBasicConsumer as quickly as it can, and the receiver could run out of memory as a result. This is more likely to occur if the consumer is slower than the sender. The solution to this problem is to set the QoS prefetch count (IModel.BasicQos) to a small number and use explicit acknowledgements.

If it really is the broker that runs out of memory could you confirm whether the broker logfile contains entries with both &quot;alarm_handler&quot; 
and &quot;vm_memory_high_watermark&quot;? What else appears in the broker logfile near the time of the crash?

-Emile

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012233.html">[rabbitmq-discuss] Searchable version of the list archives?
</A></li>
	<LI>Next message: <A HREF="012240.html">[rabbitmq-discuss] ERL crashes when messages are being pumped into a queue under win32 envir
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12220">[ date ]</a>
              <a href="thread.html#12220">[ thread ]</a>
              <a href="subject.html#12220">[ subject ]</a>
              <a href="author.html#12220">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
