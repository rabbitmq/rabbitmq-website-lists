<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] pika behavior when server die
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20pika%20behavior%20when%20server%20die&In-Reply-To=%3CBANLkTikazw6U%3D0pPQ5eHpQEhN46jcRxr8A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012519.html">
   <LINK REL="Next"  HREF="012521.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] pika behavior when server die</H1>
    <B>can xiang</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20pika%20behavior%20when%20server%20die&In-Reply-To=%3CBANLkTikazw6U%3D0pPQ5eHpQEhN46jcRxr8A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] pika behavior when server die">xiang.can at gmail.com
       </A><BR>
    <I>Sat Apr 23 11:16:58 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012519.html">[rabbitmq-discuss] Debian/Ubuntu apt package issues.
</A></li>
        <LI>Next message: <A HREF="012521.html">[rabbitmq-discuss] pika behavior when server die
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12518">[ date ]</a>
              <a href="thread.html#12518">[ thread ]</a>
              <a href="subject.html#12518">[ subject ]</a>
              <a href="author.html#12518">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm testing rabbitmq pubsub pattern with pika 0.9.5. Basically what I do are
the following:

1. publish message in a tornado application
2. consume message in a standalone script
3. ab test the tornado application to see how messages goes

basic parameters used:

1. exchange_type = fanout
2. auto_delete = False
3. durable = True
4. delivery_mode = 2
5. no_ack = True
6. SimpleReconnectionStrategy for reconnection

When I'm testing the server die scenario. I found three issues:

ISSUE 1:
=======
Stop rabbitmq server, tornado application raises the following exception and
become not responsive:

2011-04-23 11:48:53,872 - ERROR - TornadoConnection: Socket Error on 9: 104
2011-04-23 11:48:53,872 - ERROR - Exception in I/O handler for fd 9
Traceback (most recent call last):
  File
&quot;/usr/local/lib/python2.6/dist-packages/tornado-1.1-py2.6.egg/tornado/ioloop.py&quot;,
line 272, in start
    self._handlers[fd](fd, events)
  File
&quot;/usr/local/lib/python2.6/dist-packages/tornado-1.1-py2.6.egg/tornado/stack_context.py&quot;,
line 128, in wrapped
    callback(*args, **kwargs)
  File
&quot;/usr/local/lib/python2.6/dist-packages/pika-0.9.5-py2.6.egg/pika/adapters/base_connection.py&quot;,
line 137, in _handle_events
    self._handle_error(error)
  File
&quot;/usr/local/lib/python2.6/dist-packages/pika-0.9.5-py2.6.egg/pika/adapters/base_connection.py&quot;,
line 106, in _handle_error
    error_code = error[0]  # Python &lt;= 2.5
TypeError: 'NoneType' object is unsubscriptable
2011-04-23 11:48:53,886 - ERROR - Exception in callback &lt;functools.partial
object at 0x9e500f4&gt;
Traceback (most recent call last):
  File
&quot;/usr/local/lib/python2.6/dist-packages/tornado-1.1-py2.6.egg/tornado/ioloop.py&quot;,
line 333, in _run_callback
    callback()
  File
&quot;/usr/local/lib/python2.6/dist-packages/tornado-1.1-py2.6.egg/tornado/stack_context.py&quot;,
line 128, in wrapped
    callback(*args, **kwargs)
  File &quot;/home/ken/workspace/QvodGround2/utils/messaging.py&quot;, line 53, in
connect
    reconnection_strategy=srs)
  File
&quot;/usr/local/lib/python2.6/dist-packages/pika-0.9.5-py2.6.egg/pika/adapters/tornado_connection.py&quot;,
line 33, in __init__
    reconnection_strategy)
  File
&quot;/usr/local/lib/python2.6/dist-packages/pika-0.9.5-py2.6.egg/pika/adapters/base_connection.py&quot;,
line 50, in __init__
    reconnection_strategy)
  File
&quot;/usr/local/lib/python2.6/dist-packages/pika-0.9.5-py2.6.egg/pika/connection.py&quot;,
line 170, in __init__
    self._connect()
  File
&quot;/usr/local/lib/python2.6/dist-packages/pika-0.9.5-py2.6.egg/pika/connection.py&quot;,
line 228, in _connect
    self.parameters.port or  spec.PORT)
  File
&quot;/usr/local/lib/python2.6/dist-packages/pika-0.9.5-py2.6.egg/pika/adapters/tornado_connection.py&quot;,
line 39, in _adapter_connect
    BaseConnection._adapter_connect(self, host, port)
  File
&quot;/usr/local/lib/python2.6/dist-packages/pika-0.9.5-py2.6.egg/pika/adapters/base_connection.py&quot;,
line 58, in _adapter_connect
    self.socket.connect((host, port))
  File &quot;&lt;string&gt;&quot;, line 1, in connect
error: [Errno 111] Connection refused

ISSUE2:
=======
I tested 800 messages, with slow consumer. while it runs, stop
rabbitmq-server with Ctrl+C, consumer is able to continuing consuming
message and finish all 800 messages, then it EXIT.

It's very weird indeed, because the server already gone. Is there any
incoming message buffer in pika? How many messages can be buffered? Are
those message stored in memory? Is it possible to configure the memory
usage?

ISSUE3:
=======
In my use case, it's very important the tornado application wouldn't die for
any reason. If there is anything bad happened to the rabbitmq-server or
connection, messaging system can be down-graded as a not functioning part,
which can go back automatically when server issues resolved. The long
running consuming process shouldn't die or exit when server died or
connection broken. Is this requirement sensible enough?

I hope SimpleReconnectionStrategy works for my case, which is not. Is there
anything wrong in my application code? Or I just roll my own one, any
suggestion on how to do it?

I appreciate any help.

Best regards!
can

PS:  partial tornado application code can be found at gist:
<A HREF="https://gist.github.com/938517">https://gist.github.com/938517</A> , consumer script:
<A HREF="https://gist.github.com/938226">https://gist.github.com/938226</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110423/5387469f/attachment-0001.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110423/5387469f/attachment-0001.htm</A>&gt;
</PRE>















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012519.html">[rabbitmq-discuss] Debian/Ubuntu apt package issues.
</A></li>
	<LI>Next message: <A HREF="012521.html">[rabbitmq-discuss] pika behavior when server die
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12518">[ date ]</a>
              <a href="thread.html#12518">[ thread ]</a>
              <a href="subject.html#12518">[ subject ]</a>
              <a href="author.html#12518">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
