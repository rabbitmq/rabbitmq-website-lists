<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Creating a job only once (using Java Client API)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Creating%20a%20job%20only%20once%20%28using%20Java%20Client%20API%29&In-Reply-To=%3CBANLkTi%3DuSB%2Bqq2SH7N4xfjtg-WEcZyoViA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012411.html">
   <LINK REL="Next"  HREF="012416.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Creating a job only once (using Java Client API)</H1>
    <B>Allan Kamau</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Creating%20a%20job%20only%20once%20%28using%20Java%20Client%20API%29&In-Reply-To=%3CBANLkTi%3DuSB%2Bqq2SH7N4xfjtg-WEcZyoViA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Creating a job only once (using Java Client API)">kamauallan at gmail.com
       </A><BR>
    <I>Sat Apr 16 13:03:20 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012411.html">[rabbitmq-discuss] Hello World Example
</A></li>
        <LI>Next message: <A HREF="012416.html">[rabbitmq-discuss] Creating a job only once (using Java Client	API)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12415">[ date ]</a>
              <a href="thread.html#12415">[ thread ]</a>
              <a href="subject.html#12415">[ subject ]</a>
              <a href="author.html#12415">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have potentially many clients what may attempt create a given type
of job at the same time and more than once. And I would like the given
job (maybe identified by a job_name) for the given queue to be created
only once. And for the given job to be or have been executed
successfully only once in the future, present or in the past.

This is the long format of the situation.
I have several clients for whom a particular initialization step needs
to happen only once. Each such client represents an instance of an
application I am executing in parallel, for a particular node I would
like some data initialization procedure to be run only once triggered
by a single instance of these processes even though there will be many
such instances (processes) started at the same time. After the task
has been created a note that such a task as already been created
(already run or not) should be evident for all instances of this
application present and even for the instances to be created in the
future accessing a given queue_name.

Below is what I have tried without much success.

	public void runHelper()throws IOException,java.lang.InterruptedException
	{
		long start_time=System.currentTimeMillis();
		long duration=0;
		ConnectionFactory factory=new ConnectionFactory();
		factory.setHost(&quot;localhost&quot;);
		Connection connection=factory.newConnection();
		Channel channel=connection.createChannel();
		
		channel.queueDeclare(queue_name,false,false,false,null);
		String message=null;

		QueueingConsumer consumer=new QueueingConsumer(channel);
		boolean autoAck=false;
		channel.basicConsume(queue_name,autoAck,consumer);
		
		int messages_cnt=0;
		for(int i=1;i&lt;=number_of_messages;i++)
		{
			QueueingConsumer.Delivery
delivery=consumer.nextDelivery(1000);//consumer.nextDelivery();
			if(delivery==null)
			{
				//this means no message has been send received for the given
channel and queue.
				//so let's send one.
				message=&quot;dothis, from \&quot;&quot;+_id__producer+&quot;\&quot;, id:&quot;+i;
				channel.basicPublish(&quot;&quot;,queue_name,null,message.getBytes());
				number_of_jobs_posted++;
				
			}
			else
			{
				//consume the message
				messages_cnt+=1;
				String message2=new String(delivery.getBody());
				if(message2.startsWith(&quot;dothis&quot;))
				{
					System.out.println(new java.util.Date()+&quot;,
_id__producer:\&quot;&quot;+_id__producer+&quot;\&quot;, got the job to be executed only
once:\&quot;&quot;+message2+&quot;\&quot;&quot;);
					message2=&quot;donethat&quot;;
					channel.basicPublish(&quot;&quot;,queue_name,null,message2.getBytes());
					channel.basicAck(delivery.getEnvelope().getDeliveryTag(),false);
					number_of_jobs_received++;
				}
				else
				{
					//do not acknowledge the receiption of the message.
				}
				System.out.println(new java.util.Date()+&quot; -
_id__producer:\&quot;&quot;+_id__producer+&quot;\&quot;, messages_cnt:&quot;+messages_cnt+&quot;,
[x]Received:'&quot;+message2+&quot;'. &quot;+new java.util.Date());
			}
		}
		duration=System.currentTimeMillis()-start_time;
		System.out.println(&quot;[x] Thread:\&quot;&quot;+_id__producer+&quot;\&quot; completed
sending:&quot;+number_of_messages+&quot;, messages in:&quot;+duration+&quot;ms.&quot;);
		
		channel.close();
		connection.close();
		
	}
</PRE>




































































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012411.html">[rabbitmq-discuss] Hello World Example
</A></li>
	<LI>Next message: <A HREF="012416.html">[rabbitmq-discuss] Creating a job only once (using Java Client	API)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12415">[ date ]</a>
              <a href="thread.html#12415">[ thread ]</a>
              <a href="subject.html#12415">[ subject ]</a>
              <a href="author.html#12415">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
