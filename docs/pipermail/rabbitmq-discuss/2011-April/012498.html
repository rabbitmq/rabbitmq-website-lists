<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%202.3.1%20high%20CPU%20usage%20%26%20disks%0A%20operations&In-Reply-To=%3C20110421104215.GA14121%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012492.html">
   <LINK REL="Next"  HREF="012505.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%202.3.1%20high%20CPU%20usage%20%26%20disks%0A%20operations&In-Reply-To=%3C20110421104215.GA14121%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations">matthew at rabbitmq.com
       </A><BR>
    <I>Thu Apr 21 11:42:16 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012492.html">[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations
</A></li>
        <LI>Next message: <A HREF="012505.html">[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks	operations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12498">[ date ]</a>
              <a href="thread.html#12498">[ thread ]</a>
              <a href="subject.html#12498">[ subject ]</a>
              <a href="author.html#12498">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Raphael,

Thanks for the detailed report. This is an interesting one, and a few
ideas spring to mind.

You seem to be using the x-message-ttl feature now, with message expiry
around 1 day. Do these events happen to correspond with the bulk expiry
of a lot of messages? Certainly 60,000 odd msgs in the broker shouldn't
cause any problems at all, but just want to check that one. Also, when
you say &quot;many queues get deleted&quot;, how many are we talking about? The
only thing we can think of is if you're deleting more queues than you
have file descriptors available for the process then you may run into
problems: Rabbit won't crash, but it might thrash fds between different
queues which can overall result in vastly more disk activity than
necessary.

The normal Linux default fd limit (ulimit -n) is 1024, though on OS X,
it's down at 256 by default IIRC. If you're deleting more than about
900 queues at any one go, then I'd suggest that you try increasing that
substantially: having about double the number of fds available than
queues should eliminate any thrashing - if indeed this is the problem.
If this is the problem then by strace, you should be able to see an
awful lot of open and close calls to various files, whereas if this
problem is solved by higher fd ulimit then you should see files stay
open for much longer.

Please let us know how you get on.

Matthew
</PRE>
















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012492.html">[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks operations
</A></li>
	<LI>Next message: <A HREF="012505.html">[rabbitmq-discuss] RabbitMQ 2.3.1 high CPU usage &amp; disks	operations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12498">[ date ]</a>
              <a href="thread.html#12498">[ thread ]</a>
              <a href="subject.html#12498">[ subject ]</a>
              <a href="author.html#12498">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
