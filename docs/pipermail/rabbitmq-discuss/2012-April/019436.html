<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Client connection to ssl rabbitMQ is very slow
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Client%20connection%20to%20ssl%20rabbitMQ%20is%20very%0A%20slow&In-Reply-To=%3C33654326.post%40talk.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019396.html">
   <LINK REL="Next"  HREF="019443.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Client connection to ssl rabbitMQ is very slow</H1>
    <B>Rabbit001</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Client%20connection%20to%20ssl%20rabbitMQ%20is%20very%0A%20slow&In-Reply-To=%3C33654326.post%40talk.nabble.com%3E"
       TITLE="[rabbitmq-discuss] Client connection to ssl rabbitMQ is very slow">rcrespopanizo at gmail.com
       </A><BR>
    <I>Mon Apr  9 08:23:00 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019396.html">[rabbitmq-discuss] Client connection to ssl rabbitMQ is very	slow
</A></li>
        <LI>Next message: <A HREF="019443.html">[rabbitmq-discuss] Client connection to ssl rabbitMQ is very slow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19436">[ date ]</a>
              <a href="thread.html#19436">[ thread ]</a>
              <a href="subject.html#19436">[ subject ]</a>
              <a href="author.html#19436">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Carl,

I follow your instructions and I've modified rabbitmq.config and put
{ciphers,[{rsa,aes_128_cbc,sha}]}. The server starts correctly but my client
display this error,

trigger seeding of SecureRandom
done seeding SecureRandom
Allow unsafe renegotiation: false
Allow legacy hello messages: true
Is initial handshake: true
Is secure renegotiation: false
main, setSoTimeout(10000) called
%% No cached client session
*** ClientHello, TLSv1
RandomCookie:  GMT: 1317113069 bytes = { 232, 24, 48, 31, 62, 172, 47, 240,
38, 205, 140, 162, 102, 226, 22, 0, 240, 6, 93, 111, 113, 187, 44, 85, 132,
255, 0, 48 }
Session ID:  {}
Cipher Suites: [SSL_RSA_WITH_RC4_128_MD5, SSL_RSA_WITH_RC4_128_SHA,
TLS_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA,
TLS_DHE_DSS_WITH_AES_128_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA,
SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA,
SSL_RSA_WITH_DES_CBC_SHA, SSL_DHE_RSA_WITH_DES_CBC_SHA,
SSL_DHE_DSS_WITH_DES_CBC_SHA, SSL_RSA_EXPORT_WITH_RC4_40_MD5,
SSL_RSA_EXPORT_WITH_DES40_CBC_SHA, SSL_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA,
SSL_DHE_DSS_EXPORT_WITH_DES40_CBC_SHA, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]
Compression Methods:  { 0 }
***
main, WRITE: TLSv1 Handshake, length = 75
main, WRITE: SSLv2 client hello message, length = 101
main, waiting for close_notify or alert: state 1
main, Exception while waiting for close java.net.SocketException: Connection
reset
main, handling exception: java.net.SocketException: Connection reset
main, SEND TLSv1 ALERT:  fatal, description = unexpected_message
main, WRITE: TLSv1 Alert, length = 2
main, Exception sending alert: java.net.SocketException: Connection reset by
peer: socket write error
main, called closeSocket()
main, called close()
main, called closeInternal(true)
Exception in thread &quot;main&quot; java.net.SocketException: Connection reset
	at java.net.SocketInputStream.read(Unknown Source)
	at com.sun.net.ssl.internal.ssl.InputRecord.readFully(Unknown Source)
	at com.sun.net.ssl.internal.ssl.InputRecord.read(Unknown Source)
	at com.sun.net.ssl.internal.ssl.SSLSocketImpl.readRecord(Unknown Source)
	at com.sun.net.ssl.internal.ssl.SSLSocketImpl.waitForClose(Unknown Source)
	at com.sun.net.ssl.internal.ssl.HandshakeOutStream.flush(Unknown Source)
	at com.sun.net.ssl.internal.ssl.Handshaker.kickstart(Unknown Source)
	at com.sun.net.ssl.internal.ssl.SSLSocketImpl.kickstartHandshake(Unknown
Source)
	at
com.sun.net.ssl.internal.ssl.SSLSocketImpl.performInitialHandshake(Unknown
Source)
	at com.sun.net.ssl.internal.ssl.SSLSocketImpl.writeRecord(Unknown Source)
	at com.sun.net.ssl.internal.ssl.AppOutputStream.write(Unknown Source)
	at java.io.BufferedOutputStream.flushBuffer(Unknown Source)
	at java.io.BufferedOutputStream.flush(Unknown Source)
	at java.io.DataOutputStream.flush(Unknown Source)
	at
com.rabbitmq.client.impl.SocketFrameHandler.sendHeader(SocketFrameHandler.java:121)
	at
com.rabbitmq.client.impl.SocketFrameHandler.sendHeader(SocketFrameHandler.java:126)
	at com.rabbitmq.client.impl.AMQConnection.start(AMQConnection.java:287)
	at
com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:516)
	at
com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:533)
	at mediapost.tests.RabbitMQSSLSample.main(RabbitMQSSLSample.java:24)

Any idea?

Best Regards,


Carl H&#246;rberg wrote:
&gt;<i> 
</I>&gt;<i> the DHE key exchange algorithm  is very computational intensive, so
</I>&gt;<i> make sure you disable it (<A HREF="http://matt.io/entry/ur">http://matt.io/entry/ur</A>)
</I>&gt;<i> 
</I>&gt;<i> this config allows only the AES 128 chiper with RSA (and not DHE) as
</I>&gt;<i> key exchange and SHA as hash algoritm (md5 is somewhat weaker but
</I>&gt;<i> faster):
</I>&gt;<i> 
</I>&gt;<i> {ssl_options, [{cacertfile,&quot;/etc/rabbitmq/ca.pem&quot;},
</I>&gt;<i>                     {certfile,&quot;/etc/rabbitmq/cert.pem&quot;},
</I>&gt;<i>                     {ciphers,[{rsa,aes_128_cbc,sha}]}]}
</I>&gt;<i> 
</I>&gt;<i> for all options, see <A HREF="http://www.erlang.org/doc/man/ssl.html,">http://www.erlang.org/doc/man/ssl.html,</A> as Emile
</I>&gt;<i> said.
</I>&gt;<i> 
</I>&gt;<i> On Wed, Apr 4, 2012 at 12:43, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 02/04/12 15:26, Rabbit001 wrote:
</I>&gt;&gt;&gt;<i> &#160; I've follow the ssl configuration instructions in rabbitmq page
</I>&gt;&gt;&gt;<i> 'www.rabbitmq.com/ssl.html' to configure ssl access to rabbitmq server.
</I>&gt;&gt;&gt;<i> I've
</I>&gt;&gt;&gt;<i> started rabbitmq server correctly and I've executed the example1 (sample
</I>&gt;&gt;&gt;<i> code for ssl java client) and the result is good, but the method
</I>&gt;&gt;&gt;<i> factory.newConnection() finish over 5sg. In the other hand, without ssl
</I>&gt;&gt;&gt;<i> &#160;the
</I>&gt;&gt;&gt;<i> method factory.newConnection() finish in &lt;200 ms.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160; How do i increasse the performance in the first scenario (ssl
</I>&gt;&gt;&gt;<i> configuration)? any idea?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If your broker CPU has hardware support for certain ciphers and OpenSSL
</I>&gt;&gt;<i> can make use of it then try to restrict the SSL connection to those
</I>&gt;&gt;<i> ciphers, or to prioritise them. The &quot;ciphers&quot; SSL configuration option
</I>&gt;&gt;<i> in the broker is one way of achieving that. For configuration details
</I>&gt;&gt;<i> see <A HREF="http://www.erlang.org/doc/man/ssl.html">http://www.erlang.org/doc/man/ssl.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You might also gain some useful insight by using an SSL traffic analyser
</I>&gt;&gt;<i> such as &quot;ssldump&quot;. If long gaps appear in the timeline then the output
</I>&gt;&gt;<i> may help you to determine what is responsible for the delay.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do other SSL clients also take long to connect? Try using the &quot;openssl
</I>&gt;&gt;<i> s_client&quot; option as described here:
</I>&gt;&gt;<i> <A HREF="http://www.rabbitmq.com/troubleshooting-ssl.html">http://www.rabbitmq.com/troubleshooting-ssl.html</A>
</I>&gt;&gt;<i> and check whether such connections also take long.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does the Java client take long to connect when the SSL layer is provided
</I>&gt;&gt;<i> by a different SSL service? You can try this by connecting to the broker
</I>&gt;&gt;<i> via stunnel, socat or similar.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The last two questions may help you to focus on whether the problem lies
</I>&gt;&gt;<i> on the client or server side.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -Emile
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>
-- 
View this message in context: <A HREF="http://old.nabble.com/Client-connection-to-ssl-rabbitMQ-is-very-slow-tp33544994p33654326.html">http://old.nabble.com/Client-connection-to-ssl-rabbitMQ-is-very-slow-tp33544994p33654326.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019396.html">[rabbitmq-discuss] Client connection to ssl rabbitMQ is very	slow
</A></li>
	<LI>Next message: <A HREF="019443.html">[rabbitmq-discuss] Client connection to ssl rabbitMQ is very slow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19436">[ date ]</a>
              <a href="thread.html#19436">[ thread ]</a>
              <a href="subject.html#19436">[ subject ]</a>
              <a href="author.html#19436">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
