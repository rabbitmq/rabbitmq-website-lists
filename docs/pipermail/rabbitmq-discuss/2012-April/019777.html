<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cannot send message with STOMP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cannot%20send%20message%20with%20STOMP&In-Reply-To=%3C978D862C-5198-4892-94EC-AD04CE5B05B9%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019678.html">
   <LINK REL="Next"  HREF="019782.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cannot send message with STOMP</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cannot%20send%20message%20with%20STOMP&In-Reply-To=%3C978D862C-5198-4892-94EC-AD04CE5B05B9%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Cannot send message with STOMP">steve at rabbitmq.com
       </A><BR>
    <I>Fri Apr 27 09:35:34 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019678.html">[rabbitmq-discuss] Cannot send message with STOMP
</A></li>
        <LI>Next message: <A HREF="019782.html">[rabbitmq-discuss] Cannot send message with STOMP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19777">[ date ]</a>
              <a href="thread.html#19777">[ thread ]</a>
              <a href="subject.html#19777">[ subject ]</a>
              <a href="author.html#19777">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thans Lionel,
(*The very tardy reply is my fault -- sorry*)

&gt;&gt;<i> the rather arbitrary notion of escaping colons in header values as well
</I>&gt;&gt;<i> as names (why?) [...]
</I>&gt;<i> 
</I>&gt;<i> Without backslash escaping, header names and values would have been
</I>&gt;<i> limited. This quite simple escaping removed this restriction.
</I>
Here is the problem: you are forcing us to escape colons. Why? The
terminator for a header value is the newline. Yes, to allow newlines we
need an escape for newline (and therefore for backslash) but not for
colon. Never for colon.

&gt;&gt;<i> and the insistence of UTF-8 for all header names and values [...]
</I>&gt;<i> 
</I>&gt;<i> Here again, without this in the spec, the headers would have been
</I>&gt;<i> limited to basically US-ASCII.
</I>
I really don't understand this. 1.1 limits headers to UTF-8 sequences.
There is no conceivable benefit in doing this -- all binary sequences
could have been used (with escapes for a few) but you chose to restrict
it. All this does is make the properly compliant server's job harder.
And, by the way, clients too.

One day, when two clients choose to represent the same UTF-8 string
using different UTF-8 encodings (with, say, resequenced decorations or
whatever) the spec will cause problems for implementations and clients
alike.

&gt;<i> Some users (us included) do need more. This widely used encoding allows
</I>&gt;<i> any text string in the header.
</I>
Well, my point is we had (almost) enough already and 1.1 gave us less.
How is any binary OCTET sequence worse than any UTF-8 text string?

&gt;<i> The BNF indeed allows more than what the protocol accepts. The best
</I>&gt;<i> solution is probably to ignore the BNF and only implement what is in the
</I>&gt;<i> protocol text. After all, it's probably two orders of magnitude shorter
</I>&gt;<i> than AMQP 1-0 ;-)
</I>
Well, I cannot deny that :-)

If UTF-8 wasn't there it would have been easy to improve so that the
valid forms of a frame were described in BNF. The only errors not then
identifiable would have been semantic ones (like use of an unknown id).

&gt;<i> Maybe you also want reject empty header names (e.g. SEND\n:foo\n\n\0).
</I>&gt;<i> This is arguable.
</I>
I'll see what we currently do. It might be valid. Leading spaces? A space?

Incidentally, the spec(s) allow the server to not send an ERROR frame if
it doesn't want to, but I can see that if nothing is logged at all it could be
frustrating -- we will try to improve this.

Steve Powell
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">steve at rabbitmq.com</A>
[wrk: +44-2380-111-528] [mob: +44-7815-838-558]

On 20 Apr 2012, at 14:58, Lionel Cons wrote:

&gt;<i> Steve Powell writes:
</I>&gt;&gt;<i> The STOMP 1.0 specification is unsatisfactory in many respects, [...]
</I>&gt;<i> 
</I>&gt;<i> Indeed. This is what triggered the creation of 1.1.
</I>&gt;<i> 
</I>&gt;&gt;<i> The STOMP 1.1 specification has drawbacks of its own -- [...]
</I>&gt;<i> 
</I>&gt;<i> Although I agree that 1.1 is not perfect (so I'm sure we will see 1.2
</I>&gt;<i> or 2.0 one day), I do not share your view on the points you mention.
</I>&gt;<i> 
</I>&gt;&gt;<i> the rather arbitrary notion of escaping colons in header values as
</I>&gt;&gt;<i> well as names (why?) [...]
</I>&gt;<i> 
</I>&gt;<i> Without backslash escaping, header names and values would have been
</I>&gt;<i> limited. This quite simple escaping removed this restriction.
</I>&gt;<i> 
</I>&gt;&gt;<i> and the insistence of UTF-8 for all header names and values [...]
</I>&gt;<i> 
</I>&gt;<i> Here again, without this in the spec, the headers would have been
</I>&gt;<i> limited to basically US-ASCII. Some users (us included) do need
</I>&gt;<i> more. This widely used encoding allows any text string in the header.
</I>&gt;<i> Icing on the cake: it's backward compatible with 1.0 and transparent
</I>&gt;<i> to implementations using only US-ASCII.
</I>&gt;<i> 
</I>&gt;&gt;<i> So I think it is _incorrect_ in that it specifies a considerable
</I>&gt;&gt;<i> superset of what you can receive (or are allowed to send) over the wire.
</I>&gt;<i> 
</I>&gt;<i> The BNF indeed allows more than what the protocol accepts. The best
</I>&gt;<i> solution is probably to ignore the BNF and only implement what is in
</I>&gt;<i> the protocol text. After all, it's probably two orders of magnitude
</I>&gt;<i> shorter than AMQP 1-0 ;-)
</I>&gt;<i> 
</I>&gt;&gt;<i> I'm going to raise a bug [24896] to track this, and propose the
</I>&gt;&gt;<i> following solution:
</I>&gt;<i> 
</I>&gt;<i> Thanks.
</I>&gt;<i> 
</I>&gt;&gt;<i> We use the negotiated connection type to determine the parsing rules
</I>&gt;&gt;<i> (and generating rules) for frame headers.
</I>&gt;<i> 
</I>&gt;<i> Perfect.
</I>&gt;<i> 
</I>&gt;&gt;<i> For 1.0 connections we will allow OCTET streams for header names and
</I>&gt;&gt;<i> values, excepting colons in names, and excepting newlines (\u000A
</I>&gt;&gt;<i> newline character coded in UTF-8 is x'0A') anywhere, and do NO escaping
</I>&gt;&gt;<i> either on input or output. We will reject no headers on input unless
</I>&gt;&gt;<i> they do not contain a colon before the first newline (because they
</I>&gt;&gt;<i> cannot be malformed under these rules) though the remaining frame
</I>&gt;&gt;<i> parsing can fail.
</I>&gt;<i> 
</I>&gt;<i> Maybe you also want reject empty header names (e.g. SEND\n:foo\n\n\0).
</I>&gt;<i> This is arguable.
</I>&gt;<i> 
</I>&gt;&gt;<i> For 1.1 connections we will allow OCTET streams for header names and
</I>&gt;&gt;<i> values, excepting colons, newlines and backslashes, interpreting escape
</I>&gt;&gt;<i> sequences for these, and generating escapes for these characters on
</I>&gt;&gt;<i> output. We will NOT reject non-UTF-8 OCTETs but instead just pass them
</I>&gt;&gt;<i> through asis in order to allow the simplest client access. We will NOT
</I>&gt;&gt;<i> reject other escapes (\ followed by non c, n or \), but leave these
</I>&gt;&gt;<i> asis.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Although this is not strictly what the spec says (we would not enforce
</I>&gt;&gt;<i> UTF-8 or the errors on bad escape sequences) I believe it is a
</I>&gt;&gt;<i> reasonable compromise.
</I>&gt;<i> 
</I>&gt;<i> Fair enough.
</I>&gt;<i> 
</I>&gt;<i> IMHO, the main point is that RabbitMQ should accept any valid STOMP
</I>&gt;<i> 1.1 input. Your proposed solution seems address this point.
</I>&gt;<i> 
</I>&gt;<i> If you also accept invalid input, this should not be a problem in
</I>&gt;<i> practice.
</I>&gt;<i> 
</I>&gt;<i> Thanks for your work improving RabbitMQ's STOMP support.
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> 
</I>&gt;<i> Lionel
</I>
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019678.html">[rabbitmq-discuss] Cannot send message with STOMP
</A></li>
	<LI>Next message: <A HREF="019782.html">[rabbitmq-discuss] Cannot send message with STOMP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19777">[ date ]</a>
              <a href="thread.html#19777">[ thread ]</a>
              <a href="subject.html#19777">[ subject ]</a>
              <a href="author.html#19777">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
