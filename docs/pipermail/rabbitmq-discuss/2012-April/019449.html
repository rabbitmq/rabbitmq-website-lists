<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] librabbitmq faults
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20librabbitmq%20faults&In-Reply-To=%3CCAAt2poLJk3cDGJGyCVzn5qi%2BO-8Ro6XRTChnq_icJmnKGaTU1w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019432.html">
   <LINK REL="Next"  HREF="019385.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] librabbitmq faults</H1>
    <B>Alan Antonuk</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20librabbitmq%20faults&In-Reply-To=%3CCAAt2poLJk3cDGJGyCVzn5qi%2BO-8Ro6XRTChnq_icJmnKGaTU1w%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] librabbitmq faults">alan.antonuk at gmail.com
       </A><BR>
    <I>Tue Apr 10 14:51:56 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019432.html">[rabbitmq-discuss] librabbitmq faults
</A></li>
        <LI>Next message: <A HREF="019385.html">[rabbitmq-discuss] librabbitmq faults
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19449">[ date ]</a>
              <a href="thread.html#19449">[ thread ]</a>
              <a href="subject.html#19449">[ subject ]</a>
              <a href="author.html#19449">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Looking at the Net::RabbitMQ code - it looks like the rabbitmq-c code it
wraps is pretty old.  You've done what I would recommend which would be to
upgrade to the latest version of the rabbitmq-c code that the Net::RabbitMQ
module wraps.

-Alan

On Tue, Apr 10, 2012 at 1:22 AM, Matti Linnanvuori &lt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matti.linnanvuori at portalify.com</A>&gt; wrote:

&gt;<i> Hi!
</I>&gt;<i>
</I>&gt;<i> Yes, I did build Net::RabbitMQ with that version of rabbitmq-c and it ran
</I>&gt;<i> the script below without crashing.
</I>&gt;<i>
</I>&gt;<i> On Apr 5, 2012, at 9:18 PM, Alan Antonuk wrote:
</I>&gt;<i>
</I>&gt;<i> What do you mean by it doesn't segfault with rabbitmq-c-fb6fca832fd2 ?
</I>&gt;<i>  Did you build Net::RabbitMQ with that version of rabbitmq-c and it ran the
</I>&gt;<i> script below without crashing?
</I>&gt;<i>
</I>&gt;<i> -Alan
</I>&gt;<i>
</I>&gt;<i> On Wed, Apr 4, 2012 at 3:12 AM, Matti Linnanvuori &lt;
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matti.linnanvuori at portalify.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I wonder how it is possible to have recv hang if RabbitMQ server has
</I>&gt;&gt;<i> disconnected. Maybe RabbitMQ server has a bug that it does not disconnect a
</I>&gt;&gt;<i> socket.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am afraid I don't have a succinct example that can reproduce this
</I>&gt;&gt;<i> segfault. It occurred with Net::RabbitMQ versions 0.2.0 and 0.2.2, but not
</I>&gt;&gt;<i> with rabbitmq-c-fb6fca832fd2.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I reported the segmentation fault in CPAN:
</I>&gt;&gt;<i> <A HREF="https://rt.cpan.org/Public/Bug/Display.html?id=76205">https://rt.cpan.org/Public/Bug/Display.html?id=76205</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I got the segmentation fault in subroutine get. I think it is because
</I>&gt;&gt;<i> memory allocation failed.
</I>&gt;&gt;<i> I have Net::RabbitMQ version 0.2.2. I got a similar bug in Net::RabbitMQ
</I>&gt;&gt;<i> version 0.2.0, too:<A HREF="https://rt.cpan.org/Public/Bug/Display.html?id=76156">https://rt.cpan.org/Public/Bug/Display.html?id=76156</A>
</I>&gt;&gt;<i> This is perl, v5.10.0 built for x86_64-linux-thread-multi
</I>&gt;&gt;<i> Linux pmc-inst-test 2.6.32.12-0.7-default #1 SMP 2010-05-20 11:14:20
</I>&gt;&gt;<i> +0200 x86_64 x86_64 x86_64 GNU/Linux
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Program received signal SIGSEGV, Segmentation fault.
</I>&gt;&gt;<i> 0x00007ffff724fa41 in memcpy () from /lib64/libc.so.6
</I>&gt;&gt;<i> (gdb) bt
</I>&gt;&gt;<i> #0 0x00007ffff724fa41 in memcpy () from /lib64/libc.so.6
</I>&gt;&gt;<i> #1 0x00007ffff6db2c0d in amqp_handle_input (state=0x7bc8a0,
</I>&gt;&gt;<i> received_data=..., decoded_frame=0x7fffffffe2c0)
</I>&gt;&gt;<i> at /usr/include/bits/string3.h:52
</I>&gt;&gt;<i> #2 0x00007ffff6dbbeec in wait_frame_inner (state=0x7bc8a0,
</I>&gt;&gt;<i> decoded_frame=0x7fffffffe2c0) at amqp_socket.c:167
</I>&gt;&gt;<i> #3 0x00007ffff6dbc489 in amqp_simple_rpc (state=0x7bc8a0, channel=3,
</I>&gt;&gt;<i> request_id=, expected_reply_ids=0x7fffffffe3a0,
</I>&gt;&gt;<i> decoded_request_method=) at amqp_socket.c:283
</I>&gt;&gt;<i> #4 0x00007ffff6db156c in amqp_basic_get (state=0x7bc8a0, channel=7,
</I>&gt;&gt;<i> queue=..., no_ack=1) at amqp_api.c:258
</I>&gt;&gt;<i> #5 0x00007ffff6da7432 in XS_Net__RabbitMQ_get (my_perl=,
</I>&gt;&gt;<i> cv=) at RabbitMQ.xs:618
</I>&gt;&gt;<i> #6 0x000000000047e115 in Perl_pp_entersub ()
</I>&gt;&gt;<i> #7 0x0000000000455ad3 in Perl_runops_debug ()
</I>&gt;&gt;<i> #8 0x000000000047a005 in perl_run ()
</I>&gt;&gt;<i> #9 0x000000000042172c in main ()
</I>&gt;&gt;<i> (gdb)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #!/usr/bin/perl -w
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =pod
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =head1 sds2sds_sf_fault.t
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  Test 1: publish a Dispatch JSON message with ack_level and valid_until
</I>&gt;&gt;<i>  - from SDS to SDS in exchange.pmc.router-in.
</I>&gt;&gt;<i>  Try to receive a message from exchange.pmc.router-in in 8 seconds.
</I>&gt;&gt;<i>  Test 1 expected result: a message is received from
</I>&gt;&gt;<i> exchange.pmc.router-in in 8 seconds.
</I>&gt;&gt;<i>  Test 2: decode the message as JSON.
</I>&gt;&gt;<i>  Test 2 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 3: check that the sender field is the same as in the sent message.
</I>&gt;&gt;<i>  Test 3 expected result: the sender field is the same as in the sent
</I>&gt;&gt;<i> message.
</I>&gt;&gt;<i>  Test 4: check the body of the received message and the sent one.
</I>&gt;&gt;<i>  Test 4 expected result: the body fields are the same.
</I>&gt;&gt;<i>  Test 5: check the timestamp field.
</I>&gt;&gt;<i>  Test 5 expected result: the timestamp field is the same as in the
</I>&gt;&gt;<i> published message.
</I>&gt;&gt;<i>  Test 6: try to receive a message from exchange.pmc.sf-in in 8 seconds.
</I>&gt;&gt;<i>  Test 6 expected result: a message is received from exchange.pmc.sf-in in
</I>&gt;&gt;<i> 8 seconds.
</I>&gt;&gt;<i>  Test 7: decode the message as JSON.
</I>&gt;&gt;<i>  Test 7 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 8: check that the sender field is &quot;exchange.pmc.router-in&quot;.
</I>&gt;&gt;<i>  Test 8 expected result: the sender field is &quot;exchange.pmc.router-in&quot;.
</I>&gt;&gt;<i>  Test 9: check the body of the received message and the sent one.
</I>&gt;&gt;<i>  Test 9 expected result: the body fields are the same.
</I>&gt;&gt;<i>  Test 10: check that the timestamp in an integer.
</I>&gt;&gt;<i>  Test 10 expected result: the timestamp in an integer.
</I>&gt;&gt;<i>  Test 11: check that the timestamp is greater than or equal to that of
</I>&gt;&gt;<i> before publishing.
</I>&gt;&gt;<i>  Test 11 expected result: the timestamp is greater than or equal to that
</I>&gt;&gt;<i> of before publishing.
</I>&gt;&gt;<i>  Test 12: check that the timestamp is less than or equal to that of now.
</I>&gt;&gt;<i>  Test 12 expected result: the timestamp is less than or equal to that of
</I>&gt;&gt;<i> now.
</I>&gt;&gt;<i>  Test 13: try to receive a message from exchange.pmc.router-in in 8
</I>&gt;&gt;<i> seconds.
</I>&gt;&gt;<i>  Test 13 expected result: a message is received from
</I>&gt;&gt;<i> exchange.pmc.router-in in 8 seconds.
</I>&gt;&gt;<i>  Test 14: decode the message as JSON.
</I>&gt;&gt;<i>  Test 14 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 15: check that the sender field is &quot;exchange.pmc.sf-in&quot;.
</I>&gt;&gt;<i>  Test 15 expected result: the sender field is &quot;exchange.pmc.sf-in&quot;.
</I>&gt;&gt;<i>  Test 16: check the body of the received message and the sent one.
</I>&gt;&gt;<i>  Test 16 expected result: the body fields are the same.
</I>&gt;&gt;<i>  Test 17: check that the timestamp in an integer.
</I>&gt;&gt;<i>  Test 17 expected result: the timestamp in an integer.
</I>&gt;&gt;<i>  Test 18: check that the timestamp is greater than or equal to that of
</I>&gt;&gt;<i> before publishing.
</I>&gt;&gt;<i>  Test 18 expected result: the timestamp is greater than or equal to that
</I>&gt;&gt;<i> of before publishing.
</I>&gt;&gt;<i>  Test 19: check that the timestamp is less than or equal to that of now.
</I>&gt;&gt;<i>  Test 19 expected result: the timestamp is less than or equal to that of
</I>&gt;&gt;<i> now.
</I>&gt;&gt;<i>  Test 20: try to receive a message from exchange.pmc.router-in in 8
</I>&gt;&gt;<i> seconds.
</I>&gt;&gt;<i>  Test 20 expected result: a message is received from
</I>&gt;&gt;<i> exchange.pmc.router-in in 8 seconds.
</I>&gt;&gt;<i>  Test 21: decode the message as JSON.
</I>&gt;&gt;<i>  Test 21 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 22: check that the sender field is &quot;exchange.pmc.sf-in&quot;.
</I>&gt;&gt;<i>  Test 22 expected result: the sender field is &quot;exchange.pmc.sf-in&quot;.
</I>&gt;&gt;<i>  Test 23: check that the timestamp in an integer.
</I>&gt;&gt;<i>  Test 23 expected result: the timestamp in an integer.
</I>&gt;&gt;<i>  Test 24: check that the timestamp is greater than or equal to that of
</I>&gt;&gt;<i> before publishing.
</I>&gt;&gt;<i>  Test 24 expected result: the timestamp is greater than or equal to that
</I>&gt;&gt;<i> of before publishing.
</I>&gt;&gt;<i>  Test 25: check that the timestamp is less than or equal to that of now.
</I>&gt;&gt;<i>  Test 25 expected result: the timestamp is less than or equal to that of
</I>&gt;&gt;<i> now.
</I>&gt;&gt;<i>  Test 26: check that the id fields of the received and the published
</I>&gt;&gt;<i> messages are the same.
</I>&gt;&gt;<i>  Test 26 expected result: the id fields of the received and the published
</I>&gt;&gt;<i> messages are the same.
</I>&gt;&gt;<i>  Test 27: check that the ack_type field has value &quot;processed&quot;.
</I>&gt;&gt;<i>  Test 27 expected result: the ack_type field has value &quot;processed&quot;.
</I>&gt;&gt;<i>  Test 28: check that the from field of the received message is the same as
</I>&gt;&gt;<i>  the to field of the published message.
</I>&gt;&gt;<i>  Test 28 expected result: the from field of the received message is the
</I>&gt;&gt;<i> same as
</I>&gt;&gt;<i>  the to field of the published message.
</I>&gt;&gt;<i>  Test 29: check that the type field has value &quot;ack&quot;.
</I>&gt;&gt;<i>  Test 29 expected result: the type field has value &quot;ack&quot;.
</I>&gt;&gt;<i>  Test 30: check that the version field has value 1.
</I>&gt;&gt;<i>  Test 30 expected result: the version field has value 1.
</I>&gt;&gt;<i>  Test 31: try to receive a message from exchange.pmc.cassidian-in in 8
</I>&gt;&gt;<i> seconds.
</I>&gt;&gt;<i>  Test 31 expected result: a message is received from
</I>&gt;&gt;<i> exchange.pmc.cassidian-in in 8 seconds.
</I>&gt;&gt;<i>  Test 32: decode the message as JSON.
</I>&gt;&gt;<i>  Test 32 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 33: check that the sender field is &quot;exchange.pmc.router-in&quot;.
</I>&gt;&gt;<i>  Test 33 expected result: the sender field is &quot;exchange.pmc.router-in&quot;.
</I>&gt;&gt;<i>  Test 34: check the body of the received message and the sent one.
</I>&gt;&gt;<i>  Test 34 expected result: the body fields are the same.
</I>&gt;&gt;<i>  Test 35: check that the timestamp in an integer.
</I>&gt;&gt;<i>  Test 35 expected result: the timestamp in an integer.
</I>&gt;&gt;<i>  Test 36: check that the timestamp is greater than or equal to that of
</I>&gt;&gt;<i> before publishing.
</I>&gt;&gt;<i>  Test 36 expected result: the timestamp is greater than or equal to that
</I>&gt;&gt;<i> of before publishing.
</I>&gt;&gt;<i>  Test 37: check that the timestamp is less than or equal to that of now.
</I>&gt;&gt;<i>  Test 37 expected result: the timestamp is less than or equal to that of
</I>&gt;&gt;<i> now.
</I>&gt;&gt;<i>  Test 38: try to receive a message from exchange.pmc.cassidian-in in 8
</I>&gt;&gt;<i> seconds.
</I>&gt;&gt;<i>  Test 38 expected result: a message is received from
</I>&gt;&gt;<i> exchange.pmc.cassidian-in in 8 seconds.
</I>&gt;&gt;<i>  Test 39: decode the message as JSON.
</I>&gt;&gt;<i>  Test 39 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 40: check that the sender field is &quot;exchange.pmc.router-in&quot;.
</I>&gt;&gt;<i>  Test 40 expected result: the sender field is &quot;exchange.pmc.router-in&quot;.
</I>&gt;&gt;<i>  Test 41: check that the timestamp in an integer.
</I>&gt;&gt;<i>  Test 41 expected result: the timestamp in an integer.
</I>&gt;&gt;<i>  Test 42: check that the timestamp is greater than or equal to that of
</I>&gt;&gt;<i> before publishing.
</I>&gt;&gt;<i>  Test 42 expected result: the timestamp is greater than or equal to that
</I>&gt;&gt;<i> of before publishing.
</I>&gt;&gt;<i>  Test 43: check that the timestamp is less than or equal to that of now.
</I>&gt;&gt;<i>  Test 43 expected result: the timestamp is less than or equal to that of
</I>&gt;&gt;<i> now.
</I>&gt;&gt;<i>  Test 44: check that the id fields of the received and the published
</I>&gt;&gt;<i> messages are the same.
</I>&gt;&gt;<i>  Test 44 expected result: the id fields of the received and the published
</I>&gt;&gt;<i> messages are the same.
</I>&gt;&gt;<i>  Test 45: check that the ack_type field has value &quot;processed&quot;.
</I>&gt;&gt;<i>  Test 45 expected result: the ack_type field has value &quot;processed&quot;.
</I>&gt;&gt;<i>  Test 46: check that the from field of the received message is the same as
</I>&gt;&gt;<i>  the to field of the published message.
</I>&gt;&gt;<i>  Test 46 expected result: the from field of the received message is the
</I>&gt;&gt;<i> same as
</I>&gt;&gt;<i>  the to field of the published message.
</I>&gt;&gt;<i>  Test 47: check that the type field has value &quot;ack&quot;.
</I>&gt;&gt;<i>  Test 47 expected result: the type field has value &quot;ack&quot;.
</I>&gt;&gt;<i>  Test 48: check that the version field has value 1.
</I>&gt;&gt;<i>  Test 48 expected result: the version field has value 1.
</I>&gt;&gt;<i>  Test 49: publish an Ack sent message from the SSI in
</I>&gt;&gt;<i> exchange.pmc.router-in.
</I>&gt;&gt;<i>  try to receive a message from exchange.pmc.router-in in 8 seconds.
</I>&gt;&gt;<i>  Test 49 expected result: a message is received from
</I>&gt;&gt;<i> exchange.pmc.router-in in 8 seconds.
</I>&gt;&gt;<i>  Test 50: decode the message as JSON.
</I>&gt;&gt;<i>  Test 50 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 51: check that the timestamp of the received message is the same as
</I>&gt;&gt;<i> that of published one.
</I>&gt;&gt;<i>  Test 51 expected result:
</I>&gt;&gt;<i>  the timestamp of the received message is the same as that of published
</I>&gt;&gt;<i> one.
</I>&gt;&gt;<i>  Test 52: check the sender field of the received message.
</I>&gt;&gt;<i>  Test 52 expected result:
</I>&gt;&gt;<i>  the sender field of the received message has value
</I>&gt;&gt;<i> &quot;exchange.pmc.cassidian-in&quot;.
</I>&gt;&gt;<i>  Test 53: check the body fields of the received and the published
</I>&gt;&gt;<i> messages.
</I>&gt;&gt;<i>  Test 53 expected result:
</I>&gt;&gt;<i>  the body fields of the received and the published messages are the same.
</I>&gt;&gt;<i>  Test 54: try to receive a message from exchange.pmc.sf-in in 8 seconds.
</I>&gt;&gt;<i>  Test 54 expected result: a message is received from exchange.pmc.sf-in
</I>&gt;&gt;<i> in 8 seconds.
</I>&gt;&gt;<i>  Test 55: decode the message as JSON.
</I>&gt;&gt;<i>  Test 55 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 56: check the sender field of the received message.
</I>&gt;&gt;<i>  Test 56 expected result:
</I>&gt;&gt;<i>  the sender field of the received message has value
</I>&gt;&gt;<i> &quot;exchange.pmc.router-in&quot;.
</I>&gt;&gt;<i>  Test 57: check the body fields of the received and the published
</I>&gt;&gt;<i> messages.
</I>&gt;&gt;<i>  Test 57 expected result:
</I>&gt;&gt;<i>  the body fields of the received and the published messages are the same.
</I>&gt;&gt;<i>  Test 58: check that the timestamp in an integer.
</I>&gt;&gt;<i>  Test 58 expected result: the timestamp in an integer.
</I>&gt;&gt;<i>  Test 59: check that the timestamp is greater than or equal to that of
</I>&gt;&gt;<i> before publishing.
</I>&gt;&gt;<i>  Test 59 expected result: the timestamp is greater than or equal to that
</I>&gt;&gt;<i> of before publishing.
</I>&gt;&gt;<i>  Test 60: check that the timestamp is less than or equal to that of now.
</I>&gt;&gt;<i>  Test 60 expected result: the timestamp is less than or equal to that of
</I>&gt;&gt;<i> now.
</I>&gt;&gt;<i>  Test 61: try to receive a message from exchange.pmc.router-in in 8
</I>&gt;&gt;<i> seconds.
</I>&gt;&gt;<i>  Test 61 expected result: a message is received from
</I>&gt;&gt;<i> exchange.pmc.router-in in 8 seconds.
</I>&gt;&gt;<i>  Test 62: decode the message as JSON.
</I>&gt;&gt;<i>  Test 62 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 63: check the sender field of the received message.
</I>&gt;&gt;<i>  Test 63 expected result:
</I>&gt;&gt;<i>  the sender field of the received message has value &quot;exchange.pmc.sf-in&quot;.
</I>&gt;&gt;<i>  Test 64: check the body fields of the received and the published
</I>&gt;&gt;<i> messages.
</I>&gt;&gt;<i>  Test 64 expected result:
</I>&gt;&gt;<i>  the body fields of the received and the published messages are the same.
</I>&gt;&gt;<i>  Test 65: check that the timestamp in an integer.
</I>&gt;&gt;<i>  Test 65 expected result: the timestamp in an integer.
</I>&gt;&gt;<i>  Test 66: check that the timestamp is greater than or equal to that of
</I>&gt;&gt;<i> before publishing.
</I>&gt;&gt;<i>  Test 66 expected result: the timestamp is greater than or equal to that
</I>&gt;&gt;<i> of before publishing.
</I>&gt;&gt;<i>  Test 67: check that the timestamp is less than or equal to that of now.
</I>&gt;&gt;<i>  Test 67 expected result: the timestamp is less than or equal to that of
</I>&gt;&gt;<i> now.
</I>&gt;&gt;<i>  Test 68: try to receive a message from exchange.pmc.cassidian-in in 8
</I>&gt;&gt;<i> seconds.
</I>&gt;&gt;<i>  Test 68 expected result: a message is received from
</I>&gt;&gt;<i> exchange.pmc.cassidian-in in 8 seconds.
</I>&gt;&gt;<i>  Test 69: decode the message as JSON.
</I>&gt;&gt;<i>  Test 69 expected result: the message is decoded as JSON.
</I>&gt;&gt;<i>  Test 70: check the sender field of the received message.
</I>&gt;&gt;<i>  Test 70 expected result:
</I>&gt;&gt;<i>  the sender field of the received message has value
</I>&gt;&gt;<i> &quot;exchange.pmc.router-in&quot;.
</I>&gt;&gt;<i>  Test 71: check the body fields of the received and the published
</I>&gt;&gt;<i> messages.
</I>&gt;&gt;<i>  Test 71 expected result:
</I>&gt;&gt;<i>  the body fields of the received and the published messages are the same.
</I>&gt;&gt;<i>  Test 72: check that the timestamp in an integer.
</I>&gt;&gt;<i>  Test 72 expected result: the timestamp in an integer.
</I>&gt;&gt;<i>  Test 73: check that the timestamp is greater than or equal to that of
</I>&gt;&gt;<i> before publishing.
</I>&gt;&gt;<i>  Test 73 expected result: the timestamp is greater than or equal to that
</I>&gt;&gt;<i> of before publishing.
</I>&gt;&gt;<i>  Test 74: check that the timestamp is less than or equal to that of now.
</I>&gt;&gt;<i>  Test 74 expected result: the timestamp is less than or equal to that of
</I>&gt;&gt;<i> now.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =cut
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> use strict;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> use Net::RabbitMQ;
</I>&gt;&gt;<i> use Test::More tests =&gt; 74;
</I>&gt;&gt;<i> use JSON;
</I>&gt;&gt;<i> use Time::HiRes qw(gettimeofday);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> use constant ROUTER_EXCHANGE    =&gt; 'exchange.pmc.router-in';
</I>&gt;&gt;<i> use constant ROUTER_CHANNEL     =&gt; 1;
</I>&gt;&gt;<i> use constant ROUTER_QUEUE       =&gt; 'queue.test.router-in';
</I>&gt;&gt;<i> use constant SF_EXCHANGE        =&gt; 'exchange.pmc.sf-in';
</I>&gt;&gt;<i> use constant SF_CHANNEL         =&gt; 2;
</I>&gt;&gt;<i> use constant SF_QUEUE           =&gt; 'queue.test.sf-in';
</I>&gt;&gt;<i> use constant CASSIDIAN_EXCHANGE =&gt; 'exchange.pmc.cassidian-in';
</I>&gt;&gt;<i> use constant CASSIDIAN_CHANNEL  =&gt; 3;
</I>&gt;&gt;<i> use constant CASSIDIAN_QUEUE    =&gt; 'queue.test.cassidian-in';
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sub timestamp {
</I>&gt;&gt;<i>    return int( gettimeofday() * 1000 );
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> system(
</I>&gt;&gt;<i> 'service pmc-smpp stop &gt;&amp;2; service pmc-cassidian stop &gt;&amp;2; service
</I>&gt;&gt;<i> pmc-email stop &gt;&amp;2; service pmc-sf stop &gt;&amp;2; service pmc-routing stop &gt;&amp;2'
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sleep 1;    # Wait for the message-sending to stop.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> system(
</I>&gt;&gt;<i>    'rabbitmqctl stop_app; rabbitmqctl reset; rabbitmqctl start_app; mongo
</I>&gt;&gt;<i> &lt;&lt;END
</I>&gt;&gt;<i> use database
</I>&gt;&gt;<i> db.dropDatabase();
</I>&gt;&gt;<i> END'
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> system('service pmc-sf start &gt;&amp;2; service pmc-routing start &gt;&amp;2');
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sleep 8;    # Wait for Store &amp; Forward and Routing to start.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $json_text = '{
</I>&gt;&gt;<i> &quot;timestamp&quot; : 1330327514213,
</I>&gt;&gt;<i> &quot;sender&quot; : &quot;' . CASSIDIAN_EXCHANGE . '&quot;,
</I>&gt;&gt;<i> &quot;body&quot; : {
</I>&gt;&gt;<i> &quot;type&quot; : &quot;dispatch&quot;,
</I>&gt;&gt;<i> &quot;version&quot; : 1,
</I>&gt;&gt;<i> &quot;id&quot; : &quot;8f970b1b-f8a3-4c78-aa24-3b8e2205648788&quot;,
</I>&gt;&gt;<i> &quot;from&quot; : {
</I>&gt;&gt;<i> &quot;type&quot; : &quot;ssi&quot;,
</I>&gt;&gt;<i> &quot;address&quot; : &quot;16777215&quot;
</I>&gt;&gt;<i> },
</I>&gt;&gt;<i> &quot;to&quot; : {
</I>&gt;&gt;<i> &quot;type&quot; : &quot;ssi&quot;,
</I>&gt;&gt;<i> &quot;address&quot; : &quot;0&quot;
</I>&gt;&gt;<i> },
</I>&gt;&gt;<i> &quot;body&quot; : &quot;This is a test message.&quot;,
</I>&gt;&gt;<i> &quot;ack_level&quot; : &quot;sent&quot;,
</I>&gt;&gt;<i> &quot;valid_until&quot; : 9223372036854775807,
</I>&gt;&gt;<i> &quot;auxiliary&quot; : {
</I>&gt;&gt;<i> &quot;timestamp&quot; : 1325376000000,
</I>&gt;&gt;<i> &quot;sdstl&quot; : {
</I>&gt;&gt;<i> &quot;protocol_id&quot; : 130,
</I>&gt;&gt;<i> &quot;message_reference&quot; : 42,
</I>&gt;&gt;<i> &quot;short_report_allowed&quot; : true,
</I>&gt;&gt;<i> &quot;protocol_data&quot; : {
</I>&gt;&gt;<i> &quot;encoding&quot; : 0,
</I>&gt;&gt;<i> &quot;timestamp&quot; : {
</I>&gt;&gt;<i> &quot;month&quot; : 1,
</I>&gt;&gt;<i> &quot;day&quot; : 1,
</I>&gt;&gt;<i> &quot;hour&quot; : 0,
</I>&gt;&gt;<i> &quot;minute&quot; : 0
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }';
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $mq_router = Net::RabbitMQ-&gt;new();
</I>&gt;&gt;<i> $mq_router-&gt;connect( &quot;localhost&quot;, { user =&gt; &quot;guest&quot;, password =&gt; &quot;guest&quot;
</I>&gt;&gt;<i> } );
</I>&gt;&gt;<i> $mq_router-&gt;channel_open(ROUTER_CHANNEL);
</I>&gt;&gt;<i> $mq_router-&gt;queue_declare(
</I>&gt;&gt;<i>    ROUTER_CHANNEL,
</I>&gt;&gt;<i>    ROUTER_QUEUE,
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>        passive     =&gt; 0,
</I>&gt;&gt;<i>        durable     =&gt; 1,
</I>&gt;&gt;<i>        exclusive   =&gt; 0,
</I>&gt;&gt;<i>        auto_delete =&gt; 0
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i> $mq_router-&gt;queue_bind( ROUTER_CHANNEL, ROUTER_QUEUE, ROUTER_EXCHANGE, ''
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i> $mq_router-&gt;purge( ROUTER_CHANNEL, ROUTER_QUEUE );
</I>&gt;&gt;<i> $mq_router-&gt;consume( ROUTER_CHANNEL, ROUTER_QUEUE );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $mq_sf = Net::RabbitMQ-&gt;new();
</I>&gt;&gt;<i> $mq_sf-&gt;connect( &quot;localhost&quot;, { user =&gt; &quot;guest&quot;, password =&gt; &quot;guest&quot; } );
</I>&gt;&gt;<i> $mq_sf-&gt;channel_open(SF_CHANNEL);
</I>&gt;&gt;<i> $mq_sf-&gt;exchange_declare(
</I>&gt;&gt;<i>    SF_CHANNEL,
</I>&gt;&gt;<i>    SF_EXCHANGE,
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>        exchange_type =&gt; 'direct',
</I>&gt;&gt;<i>        passive       =&gt; 0,
</I>&gt;&gt;<i>        durable       =&gt; 1,
</I>&gt;&gt;<i>        auto_delete   =&gt; 0
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i> $mq_sf-&gt;queue_declare(
</I>&gt;&gt;<i>    SF_CHANNEL,
</I>&gt;&gt;<i>    SF_QUEUE,
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>        passive     =&gt; 0,
</I>&gt;&gt;<i>        durable     =&gt; 1,
</I>&gt;&gt;<i>        exclusive   =&gt; 0,
</I>&gt;&gt;<i>        auto_delete =&gt; 0
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i> $mq_sf-&gt;queue_bind( SF_CHANNEL, SF_QUEUE, SF_EXCHANGE, '' );
</I>&gt;&gt;<i> $mq_sf-&gt;purge( SF_CHANNEL, SF_QUEUE );
</I>&gt;&gt;<i> $mq_sf-&gt;consume( SF_CHANNEL, SF_QUEUE );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $mq_cassidian = Net::RabbitMQ-&gt;new();
</I>&gt;&gt;<i> $mq_cassidian-&gt;connect( &quot;localhost&quot;, { user =&gt; &quot;guest&quot;, password =&gt;
</I>&gt;&gt;<i> &quot;guest&quot; } );
</I>&gt;&gt;<i> $mq_cassidian-&gt;channel_open(CASSIDIAN_CHANNEL);
</I>&gt;&gt;<i> $mq_cassidian-&gt;exchange_declare(
</I>&gt;&gt;<i>    CASSIDIAN_CHANNEL,
</I>&gt;&gt;<i>    CASSIDIAN_EXCHANGE,
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>        exchange_type =&gt; 'direct',
</I>&gt;&gt;<i>        passive       =&gt; 0,
</I>&gt;&gt;<i>        durable       =&gt; 1,
</I>&gt;&gt;<i>        auto_delete   =&gt; 0
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i> $mq_cassidian-&gt;queue_declare(
</I>&gt;&gt;<i>    CASSIDIAN_CHANNEL,
</I>&gt;&gt;<i>    CASSIDIAN_QUEUE,
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>        passive     =&gt; 0,
</I>&gt;&gt;<i>        durable     =&gt; 1,
</I>&gt;&gt;<i>        exclusive   =&gt; 0,
</I>&gt;&gt;<i>        auto_delete =&gt; 0
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i> $mq_cassidian-&gt;queue_bind( CASSIDIAN_CHANNEL, CASSIDIAN_QUEUE,
</I>&gt;&gt;<i>    CASSIDIAN_EXCHANGE, '' );
</I>&gt;&gt;<i> $mq_cassidian-&gt;purge( CASSIDIAN_CHANNEL, CASSIDIAN_QUEUE );
</I>&gt;&gt;<i> $mq_cassidian-&gt;consume( CASSIDIAN_CHANNEL, CASSIDIAN_QUEUE );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $before = timestamp();
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> $mq_router-&gt;publish(
</I>&gt;&gt;<i>    ROUTER_CHANNEL,
</I>&gt;&gt;<i>    '',
</I>&gt;&gt;<i>    $json_text,
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        # Options
</I>&gt;&gt;<i>        exchange =&gt; ROUTER_EXCHANGE
</I>&gt;&gt;<i>    },
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        # Props
</I>&gt;&gt;<i>        content_encoding =&gt; &quot;UTF-8&quot;,
</I>&gt;&gt;<i>        content_type     =&gt; &quot;application/json&quot;
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $sent = decode_json($json_text);
</I>&gt;&gt;<i> my $message;
</I>&gt;&gt;<i> eval {
</I>&gt;&gt;<i>    local $SIG{ALRM} = sub { die &quot;Timeout\n&quot; };
</I>&gt;&gt;<i>    alarm 8;
</I>&gt;&gt;<i>    $message = $mq_router-&gt;recv();
</I>&gt;&gt;<i>    alarm 0;
</I>&gt;&gt;<i> };
</I>&gt;&gt;<i> is( $@, '', 'A message was received from queue' );
</I>&gt;&gt;<i> my $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@, '', 'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, $sent-&gt;{'sender'}, 'sender ' . $sent-&gt;{'sender'} );
</I>&gt;&gt;<i> is_deeply( $json-&gt;{'body'}, $sent-&gt;{'body'}, 'body the same' );
</I>&gt;&gt;<i> is( $json-&gt;{'timestamp'}, $sent-&gt;{'timestamp'},
</I>&gt;&gt;<i>    &quot;timestamp &quot; . $sent-&gt;{'timestamp'} );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> eval {
</I>&gt;&gt;<i>    local $SIG{ALRM} = sub { die &quot;Timeout\n&quot; };
</I>&gt;&gt;<i>    alarm 8;
</I>&gt;&gt;<i>    $message = $mq_sf-&gt;recv();
</I>&gt;&gt;<i>    alarm 0;
</I>&gt;&gt;<i> };
</I>&gt;&gt;<i> is( $@, '', 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@, '', 'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, ROUTER_EXCHANGE, 'sender ' . ROUTER_EXCHANGE );
</I>&gt;&gt;<i> is_deeply( $json-&gt;{'body'}, $sent-&gt;{'body'}, 'body the same' );
</I>&gt;&gt;<i> like( $json-&gt;{'timestamp'}, qr/^\d+$/, &quot;timestamp an integer&quot; );
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &gt;= $before,
</I>&gt;&gt;<i>    'timestamp greater than or equal to that of before publishing' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &lt; $before&quot;);
</I>&gt;&gt;<i> my $now = timestamp();
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &lt;= $now,
</I>&gt;&gt;<i>    'timestamp less than or equal to that of now' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &gt; $now&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> eval {
</I>&gt;&gt;<i>    local $SIG{ALRM} = sub { die &quot;Timeout\n&quot; };
</I>&gt;&gt;<i>    alarm 8;
</I>&gt;&gt;<i>    $message = $mq_router-&gt;recv();
</I>&gt;&gt;<i>    alarm 0;
</I>&gt;&gt;<i> };
</I>&gt;&gt;<i> is( $@, '', 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@,                '',          'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, SF_EXCHANGE, 'sender ' . SF_EXCHANGE );
</I>&gt;&gt;<i> is_deeply( $json-&gt;{'body'}, $sent-&gt;{'body'}, 'body the same' );
</I>&gt;&gt;<i> like( $json-&gt;{'timestamp'}, qr/^\d+$/, &quot;timestamp an integer&quot; );
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &gt;= $before,
</I>&gt;&gt;<i>    'timestamp greater than or equal to that of before publishing' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &lt; $before&quot;);
</I>&gt;&gt;<i> $now = timestamp();
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &lt;= $now,
</I>&gt;&gt;<i>    'timestamp less than or equal to that of now' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &gt; $now&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> eval {
</I>&gt;&gt;<i>    local $SIG{ALRM} = sub { die &quot;Timeout\n&quot; };
</I>&gt;&gt;<i>    alarm 8;
</I>&gt;&gt;<i>    $message = $mq_router-&gt;recv();
</I>&gt;&gt;<i>    alarm 0;
</I>&gt;&gt;<i> };
</I>&gt;&gt;<i> is( $@, '', 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@,                '',          'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, SF_EXCHANGE, 'sender ' . SF_EXCHANGE );
</I>&gt;&gt;<i> like( $json-&gt;{'timestamp'}, qr/^\d+$/, &quot;timestamp an integer&quot; );
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &gt;= $before,
</I>&gt;&gt;<i>    'timestamp greater than or equal to that of before publishing' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &lt; $before&quot;);
</I>&gt;&gt;<i> $now = timestamp();
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &lt;= $now,
</I>&gt;&gt;<i>    'timestamp less than or equal to that of now' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &gt; $now&quot;);
</I>&gt;&gt;<i> is( $json-&gt;{'body'}-&gt;{'id'}, $sent-&gt;{'body'}-&gt;{'id'}, 'id the same' );
</I>&gt;&gt;<i> is( $json-&gt;{'body'}-&gt;{'ack_type'}, 'processed', 'ack_type processed' );
</I>&gt;&gt;<i> is_deeply(
</I>&gt;&gt;<i>    $json-&gt;{'body'}-&gt;{'from'},
</I>&gt;&gt;<i>    $sent-&gt;{'body'}-&gt;{'to'},
</I>&gt;&gt;<i>    'from is the same as to of sent'
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i> is( $json-&gt;{'body'}-&gt;{'type'},    'ack', 'type is ack' );
</I>&gt;&gt;<i> is( $json-&gt;{'body'}-&gt;{'version'}, 1,     'version is 1' );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $end = time() + 8;
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> do {
</I>&gt;&gt;<i>    eval {
</I>&gt;&gt;<i>        $message = $mq_cassidian-&gt;get( CASSIDIAN_CHANNEL, CASSIDIAN_QUEUE
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i>    };
</I>&gt;&gt;<i>    if ($@) {
</I>&gt;&gt;<i>        diag($@);
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> } until ( defined $message or time() &gt; $end or $@ );
</I>&gt;&gt;<i> ok( defined $message, 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@, '', 'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, ROUTER_EXCHANGE, 'sender ' . ROUTER_EXCHANGE );
</I>&gt;&gt;<i> is_deeply( $json-&gt;{'body'}, $sent-&gt;{'body'}, 'body the same' );
</I>&gt;&gt;<i> like( $json-&gt;{'timestamp'}, qr/^\d+$/, &quot;timestamp an integer&quot; );
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &gt;= $before,
</I>&gt;&gt;<i>    'timestamp greater than or equal to that of before publishing' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &lt; $before&quot;);
</I>&gt;&gt;<i> $now = timestamp();
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &lt;= $now,
</I>&gt;&gt;<i>    'timestamp less than or equal to that of now' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &gt; $now&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> $end = time() + 8;
</I>&gt;&gt;<i> note(&quot;Trying to receive an Ack from Cassidian exchange&quot;);
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> do {
</I>&gt;&gt;<i>    eval {
</I>&gt;&gt;<i>        $message = $mq_cassidian-&gt;get( CASSIDIAN_CHANNEL, CASSIDIAN_QUEUE
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i>    };
</I>&gt;&gt;<i>    if ($@) {
</I>&gt;&gt;<i>        diag($@);
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> } until ( defined $message or time() &gt; $end or $@ );
</I>&gt;&gt;<i> ok( defined $message, 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@, '', 'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, ROUTER_EXCHANGE, 'sender ' . ROUTER_EXCHANGE );
</I>&gt;&gt;<i> like( $json-&gt;{'timestamp'}, qr/^\d+$/, &quot;timestamp an integer&quot; );
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &gt;= $before,
</I>&gt;&gt;<i>    'timestamp greater than or equal to that of before publishing' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &lt; $before&quot;);
</I>&gt;&gt;<i> $now = timestamp();
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &lt;= $now,
</I>&gt;&gt;<i>    'timestamp less than or equal to that of now' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &gt; $now&quot;);
</I>&gt;&gt;<i> is( $json-&gt;{'body'}-&gt;{'id'}, $sent-&gt;{'body'}-&gt;{'id'}, 'id the same' );
</I>&gt;&gt;<i> is( $json-&gt;{'body'}-&gt;{'ack_type'}, 'processed', 'ack_type processed' );
</I>&gt;&gt;<i> is_deeply(
</I>&gt;&gt;<i>    $json-&gt;{'body'}-&gt;{'from'},
</I>&gt;&gt;<i>    $sent-&gt;{'body'}-&gt;{'to'},
</I>&gt;&gt;<i>    'from is the same as to of sent'
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i> is( $json-&gt;{'body'}-&gt;{'type'},    'ack', 'type is ack' );
</I>&gt;&gt;<i> is( $json-&gt;{'body'}-&gt;{'version'}, 1,     'version is 1' );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $ack = '{
</I>&gt;&gt;<i> &quot;timestamp&quot; : 1328020064358,
</I>&gt;&gt;<i> &quot;sender&quot; : &quot;' . CASSIDIAN_EXCHANGE . '&quot;,
</I>&gt;&gt;<i> &quot;body&quot; : {
</I>&gt;&gt;<i> &quot;type&quot; : &quot;ack&quot;,
</I>&gt;&gt;<i> &quot;version&quot; : 1,
</I>&gt;&gt;<i> &quot;id&quot; : &quot;8f970b1b-f8a3-4c78-aa24-3b8e2205648788&quot;,
</I>&gt;&gt;<i> &quot;from&quot; : {
</I>&gt;&gt;<i> &quot;type&quot; : &quot;ssi&quot;,
</I>&gt;&gt;<i> &quot;address&quot; : &quot;0&quot;
</I>&gt;&gt;<i> },
</I>&gt;&gt;<i> &quot;ack_type&quot; : &quot;sent&quot;,
</I>&gt;&gt;<i> &quot;auxiliary&quot; : {
</I>&gt;&gt;<i> &quot;timestamp&quot; : 1325376000000,
</I>&gt;&gt;<i> &quot;original_message&quot; : ' . encode_json( $sent-&gt;{'body'} ) . ',
</I>&gt;&gt;<i> &quot;sdstl&quot; : {
</I>&gt;&gt;<i> &quot;protocol_id&quot; : 130,
</I>&gt;&gt;<i> &quot;message_reference&quot; : 42,
</I>&gt;&gt;<i> &quot;short_report_allowed&quot; : true,
</I>&gt;&gt;<i> &quot;protocol_data&quot; : {
</I>&gt;&gt;<i> &quot;encoding&quot; : 0,
</I>&gt;&gt;<i> &quot;timestamp&quot; : {
</I>&gt;&gt;<i> &quot;month&quot; : 1,
</I>&gt;&gt;<i> &quot;day&quot; : 1,
</I>&gt;&gt;<i> &quot;hour&quot; : 0,
</I>&gt;&gt;<i> &quot;minute&quot; : 0
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }';
</I>&gt;&gt;<i> $sent   = decode_json($ack);
</I>&gt;&gt;<i> $before = timestamp();
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> $mq_router-&gt;publish(
</I>&gt;&gt;<i>    ROUTER_CHANNEL,
</I>&gt;&gt;<i>    '', $ack,
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        # Options
</I>&gt;&gt;<i>        exchange =&gt; ROUTER_EXCHANGE
</I>&gt;&gt;<i>    },
</I>&gt;&gt;<i>    {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        # Props
</I>&gt;&gt;<i>        content_encoding =&gt; &quot;UTF-8&quot;,
</I>&gt;&gt;<i>        content_type     =&gt; &quot;application/json&quot;
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i> );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> eval {
</I>&gt;&gt;<i>    local $SIG{ALRM} = sub { die &quot;Timeout\n&quot; };
</I>&gt;&gt;<i>    alarm 8;
</I>&gt;&gt;<i>    $message = $mq_router-&gt;recv();
</I>&gt;&gt;<i>    alarm 0;
</I>&gt;&gt;<i> };
</I>&gt;&gt;<i> is( $@, '', 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@, '', 'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'timestamp'}, $sent-&gt;{'timestamp'},
</I>&gt;&gt;<i>    'timestamp ' . $sent-&gt;{'timestamp'} )
</I>&gt;&gt;<i>  or diag( $message-&gt;{'body'} );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, CASSIDIAN_EXCHANGE, 'sender ' . CASSIDIAN_EXCHANGE
</I>&gt;&gt;<i> )
</I>&gt;&gt;<i>  or diag( $message-&gt;{'body'} );
</I>&gt;&gt;<i> is_deeply( $json-&gt;{'body'}, $sent-&gt;{'body'}, 'body the same' )
</I>&gt;&gt;<i>  or diag( $message-&gt;{'body'} );
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> eval {
</I>&gt;&gt;<i>    local $SIG{ALRM} = sub { die &quot;Timeout\n&quot; };
</I>&gt;&gt;<i>    alarm 8;
</I>&gt;&gt;<i>    $message = $mq_sf-&gt;recv();
</I>&gt;&gt;<i>    alarm 0;
</I>&gt;&gt;<i> };
</I>&gt;&gt;<i> is( $@, '', 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@, '', 'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, ROUTER_EXCHANGE, 'sender ' . ROUTER_EXCHANGE );
</I>&gt;&gt;<i> is_deeply( $json-&gt;{'body'}, $sent-&gt;{'body'}, 'body the same' );
</I>&gt;&gt;<i> like( $json-&gt;{'timestamp'}, qr/^\d+$/, &quot;timestamp an integer&quot; );
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &gt;= $before,
</I>&gt;&gt;<i>    'timestamp greater than or equal to that of before publishing' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &lt; $before&quot;);
</I>&gt;&gt;<i> $now = timestamp();
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &lt;= $now,
</I>&gt;&gt;<i>    'timestamp less than or equal to that of now' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &gt; $now&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> eval {
</I>&gt;&gt;<i>    local $SIG{ALRM} = sub { die &quot;Timeout\n&quot; };
</I>&gt;&gt;<i>    alarm 8;
</I>&gt;&gt;<i>    $message = $mq_router-&gt;recv();
</I>&gt;&gt;<i>    alarm 0;
</I>&gt;&gt;<i> };
</I>&gt;&gt;<i> is( $@, '', 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@,                '',          'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, SF_EXCHANGE, 'sender ' . SF_EXCHANGE );
</I>&gt;&gt;<i> is_deeply( $json-&gt;{'body'}, $sent-&gt;{'body'}, 'body the same' );
</I>&gt;&gt;<i> like( $json-&gt;{'timestamp'}, qr/^\d+$/, &quot;timestamp an integer&quot; );
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &gt;= $before,
</I>&gt;&gt;<i>    'timestamp greater than or equal to that of before publishing' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &lt; $before&quot;);
</I>&gt;&gt;<i> $now = timestamp();
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &lt;= $now,
</I>&gt;&gt;<i>    'timestamp less than or equal to that of now' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &gt; $now&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> undef $message;
</I>&gt;&gt;<i> eval {
</I>&gt;&gt;<i>    local $SIG{ALRM} = sub { die &quot;Timeout\n&quot; };
</I>&gt;&gt;<i>    alarm 8;
</I>&gt;&gt;<i>    $message = $mq_cassidian-&gt;recv();
</I>&gt;&gt;<i>    alarm 0;
</I>&gt;&gt;<i> };
</I>&gt;&gt;<i> is( $@, '', 'A message was received' );
</I>&gt;&gt;<i> undef $json;
</I>&gt;&gt;<i> eval { $json = decode_json( $message-&gt;{'body'} ); };
</I>&gt;&gt;<i> is( $@, '', 'A JSON message received' );
</I>&gt;&gt;<i> is( $json-&gt;{'sender'}, ROUTER_EXCHANGE, 'sender ' . ROUTER_EXCHANGE );
</I>&gt;&gt;<i> is_deeply( $json-&gt;{'body'}, $sent-&gt;{'body'}, 'body the same' );
</I>&gt;&gt;<i> like( $json-&gt;{'timestamp'}, qr/^\d+$/, &quot;timestamp an integer&quot; );
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &gt;= $before,
</I>&gt;&gt;<i>    'timestamp greater than or equal to that of before publishing' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &lt; $before&quot;);
</I>&gt;&gt;<i> $now = timestamp();
</I>&gt;&gt;<i> ok( $json-&gt;{'timestamp'} &lt;= $now,
</I>&gt;&gt;<i>    'timestamp less than or equal to that of now' )
</I>&gt;&gt;<i>  or diag(&quot;$json-&gt;{'timestamp'} &gt; $now&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> END {
</I>&gt;&gt;<i>    $mq_sf-&gt;queue_unbind( SF_CHANNEL, SF_QUEUE, SF_EXCHANGE, '' );
</I>&gt;&gt;<i>    $mq_router-&gt;queue_unbind( ROUTER_CHANNEL, ROUTER_QUEUE,
</I>&gt;&gt;<i> ROUTER_EXCHANGE,
</I>&gt;&gt;<i>        '' );
</I>&gt;&gt;<i>    $mq_cassidian-&gt;queue_unbind( CASSIDIAN_CHANNEL, CASSIDIAN_QUEUE,
</I>&gt;&gt;<i>        CASSIDIAN_EXCHANGE, '' );
</I>&gt;&gt;<i>    system(
</I>&gt;&gt;<i> 'service pmc-smpp start &gt;&amp;2; service pmc-cassidian start &gt;&amp;2; service
</I>&gt;&gt;<i> pmc-email start &gt;&amp;2'
</I>&gt;&gt;<i>    );
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> regards, Matti Linnanvuori
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> regards, Matti Linnanvuori
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120410/daac0a98/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120410/daac0a98/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019432.html">[rabbitmq-discuss] librabbitmq faults
</A></li>
	<LI>Next message: <A HREF="019385.html">[rabbitmq-discuss] librabbitmq faults
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19449">[ date ]</a>
              <a href="thread.html#19449">[ thread ]</a>
              <a href="subject.html#19449">[ subject ]</a>
              <a href="author.html#19449">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
