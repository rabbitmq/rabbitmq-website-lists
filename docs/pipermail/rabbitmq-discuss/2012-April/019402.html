<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mirrored queue failover
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirrored%20queue%20failover&In-Reply-To=%3C20120405112633.GA17466%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019434.html">
   <LINK REL="Next"  HREF="019415.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mirrored queue failover</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirrored%20queue%20failover&In-Reply-To=%3C20120405112633.GA17466%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Mirrored queue failover">matthew at rabbitmq.com
       </A><BR>
    <I>Thu Apr  5 12:26:33 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019434.html">[rabbitmq-discuss] Custom error message for basic reject
</A></li>
        <LI>Next message: <A HREF="019415.html">[rabbitmq-discuss] Mirrored queue failover
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19402">[ date ]</a>
              <a href="thread.html#19402">[ thread ]</a>
              <a href="subject.html#19402">[ subject ]</a>
              <a href="author.html#19402">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Kats,

(Just popping this back on the mailing list in case others are seeing
the same problem)

On Thu, Apr 05, 2012 at 05:47:36PM +0900, Katsushi Fukui wrote:
&gt;<i> But today I re-built new 3-nodes cluster and got the same situation now (unfortunately). Attached logs.
</I>&gt;<i> 
</I>&gt;<i> The result of list_queues are odd. Now rabbit3 has an error, and list_queues on that node shows different results.
</I>&gt;<i> rabbit1:
</I>&gt;<i> # ./rabbitmqctl list_queues name durable pid slave_pids synnchronised_slave_pids
</I>&gt;<i> Listing queues ...
</I>&gt;<i> que1	true	&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit1.1.578.0</A>&gt;	[&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit2.2.856.0</A>&gt;]	[&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit2.2.856.0</A>&gt;]
</I>&gt;<i> ...done.
</I>&gt;<i> 
</I>&gt;<i> rabbit2:
</I>&gt;<i> # ./rabbitmqctl list_queues name durable pid slave_pids synnchronised_slave_pids
</I>&gt;<i> Listing queues ...
</I>&gt;<i> que1	true	&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit1.1.578.0</A>&gt;	[&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit2.2.856.0</A>&gt;]	[&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit2.2.856.0</A>&gt;]
</I>&gt;<i> ...done.
</I>&gt;<i> 
</I>&gt;<i> rabbit3:
</I>&gt;<i> # ./rabbitmqctl list_queues name durable pid slave_pids
</I>&gt;<i> Listing queues ...
</I>&gt;<i> que1	true	&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit1.1.578.0</A>&gt;	[&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit3.3.705.0</A>&gt;, &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit2.2.856.0</A>&gt;]
</I>&gt;<i> ...done.
</I>&gt;<i> 
</I>&gt;<i> Please check the logs rabbit1-3-script.log.
</I>&gt;<i> 
</I>&gt;<i> If I stop rabbit1 now, the que1 loose all slaves like this:
</I>&gt;<i> Listing queues ...
</I>&gt;<i> que1    &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit2.2.856.0</A>&gt;        []
</I>&gt;<i> ...done.
</I>
I think this is a mis-reporting issue actually - the errors in the logs
are indicating more that the querying the slaves for their status is the
problem, not that the slaves don't exist. That doesn't mean the slave on
3 *does* exist, but the error doesn't indicate it doesn't, if you see
what I mean.

Could you repeat the test, and when you get to the same situation (i.e.
a slave seems to have vanished), stop both of the other nodes and then
check the logs of the &quot;phantom&quot; node.

So in your above example, you stopped rabbit1, which should promote
rabbit2 to master (and there should be log entries indicating that).
Then, even though it looks like there's no slave on rabbit3, try
stopping rabbit2 too, and see if the queue then still exists on rabbit3
- eg a rabbitmqctl -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit3</A> list_queues, and also again check
the logs of rabbit3 to see if there are messages about the promotion of
a slave to master.

Matthew
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019434.html">[rabbitmq-discuss] Custom error message for basic reject
</A></li>
	<LI>Next message: <A HREF="019415.html">[rabbitmq-discuss] Mirrored queue failover
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19402">[ date ]</a>
              <a href="thread.html#19402">[ thread ]</a>
              <a href="subject.html#19402">[ subject ]</a>
              <a href="author.html#19402">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
