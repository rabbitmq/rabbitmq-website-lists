<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Help with persistence using RabbitMQ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Help%20with%20persistence%20using%20RabbitMQ%3F&In-Reply-To=%3CCABzX%2BqxzihJ4Cu7gdWRvhjBW%2BATcW1V4LDN6Tyx_rHCBE5kC0A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019371.html">
   <LINK REL="Next"  HREF="019394.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Help with persistence using RabbitMQ?</H1>
    <B>Marek Majkowski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Help%20with%20persistence%20using%20RabbitMQ%3F&In-Reply-To=%3CCABzX%2BqxzihJ4Cu7gdWRvhjBW%2BATcW1V4LDN6Tyx_rHCBE5kC0A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Help with persistence using RabbitMQ?">majek04 at gmail.com
       </A><BR>
    <I>Wed Apr  4 11:57:38 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019371.html">[rabbitmq-discuss] Help with persistence using RabbitMQ?
</A></li>
        <LI>Next message: <A HREF="019394.html">[rabbitmq-discuss] Help with persistence using RabbitMQ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19383">[ date ]</a>
              <a href="thread.html#19383">[ thread ]</a>
              <a href="subject.html#19383">[ subject ]</a>
              <a href="author.html#19383">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Apr 3, 2012 at 17:22, iceblaze &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">iceblaze at gmail.com</A>&gt; wrote:
&gt;<i> Thanks for attempting to assist me here. I have made a light version of the
</I>&gt;<i> module and a sender script as you requested. You can find the files here:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://iceblaze.com/rabbit.zip">http://iceblaze.com/rabbit.zip</A>
</I>&gt;<i>
</I>&gt;<i> Simply unzip the files into the same directory and run the &quot;sender.pl&quot;
</I>&gt;<i> script. Note that you will need to install Net::RabbitMQ from CPAN. You can
</I>&gt;<i> also modify the login credentials for rabbit (right now its just using
</I>&gt;<i> guest/guest) in $self of Rabbit.pm's new() function:
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; my $self =
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; {
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _rabbit =&gt; Net::RabbitMQ-&gt;new(),
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _rabbit_user =&gt; &quot;guest&quot;,
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _rabbit_pass =&gt; &quot;guest&quot;,
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _rabbit_host =&gt; &quot;localhost&quot;,
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _rabbit_port =&gt; 5672,
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _queue =&gt; $queue,
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _channel =&gt; $channel,
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _no_ack =&gt; $no_ack,
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _queue_declared =&gt; '',
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; };
</I>
Oh, installing Net::RabbitMQ from CPAN wasn't easy at all!
But in the end after few attempts &quot;cpan; notest install Net::RabbitMQ&quot;
did the trick.

So, the problem is that in your code the &quot;delivery_mode =&gt; 2&quot;
doesn't work.

(btw, I debugged your issue by using the management plugin and
getting a message from the queue using it - it clearly shows
that &quot;delivery_mode&quot; is not set)

Reading the docs:
<A HREF="http://search.cpan.org/~jesus/Net--RabbitMQ-0.2.2/RabbitMQ.pm">http://search.cpan.org/~jesus/Net--RabbitMQ-0.2.2/RabbitMQ.pm</A>

    publish($channel, $routing_key, $body, $options, $props)
    [...]
    $props is an optional hash (the AMQP 'props') respecting the
following keys: { content_type =&gt; $string, content_encoding =&gt;
$string, correlation_id =&gt; $string, reply_to =&gt; $string, expiration =&gt;
$string, message_id =&gt; $string, type =&gt; $string, user_id =&gt; $string,
app_id =&gt; $string, delivery_mode =&gt; $integer, priority =&gt; $integer,
timestamp =&gt; $integer, }

So, &quot;delivery_mode&quot; is a feature of &quot;props&quot;, not &quot;options&quot;.
Appropriate code should therefore look like:

    $self-&gt;{_rabbit}-&gt;publish($self-&gt;{_channel}, $self-&gt;{_queue},
$data, {mandatory =&gt; 1, immediate =&gt; 0 }, {delivery_mode =&gt; 2});


Additionally, if you want to shield against broker falling down,
and have a reliable message delivery you should be using
transactions or publish confirms.

By default sending messages in rabbit is asynchronous. You don't know
when the message reached the broker and even if it did so.
Rabbit recognizes this and it doesn't immediately flush messages
to disk. Actually it will be quire reluctant to save them on disk
(this has been tweaked in RabbitMQ 2.8.0).

If you wish to make sure that Rabbit indeed handled messages
reliably, you must use transactions or publisher confirms to
get a confirmation of delivery from the broker.
Once the confirmation is received you can be sure the messages
are safe.

On the other hand if you are only going to be closing rabbit
gracefully (via the init scripts), setting the &quot;delivery_mode&quot;
properly should be enough to persist your messages.

Marek
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019371.html">[rabbitmq-discuss] Help with persistence using RabbitMQ?
</A></li>
	<LI>Next message: <A HREF="019394.html">[rabbitmq-discuss] Help with persistence using RabbitMQ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19383">[ date ]</a>
              <a href="thread.html#19383">[ thread ]</a>
              <a href="subject.html#19383">[ subject ]</a>
              <a href="author.html#19383">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
