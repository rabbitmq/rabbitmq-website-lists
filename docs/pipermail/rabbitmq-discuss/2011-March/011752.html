<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Failure during shutdown with v2.3.1
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Failure%20during%20shutdown%20with%20v2.3.1&In-Reply-To=%3CAANLkTim6SSfPEWQf9C_q5GxeEsX534%2BsCTSbNADdHeGx%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011771.html">
   <LINK REL="Next"  HREF="011861.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Failure during shutdown with v2.3.1</H1>
    <B>Lee Kirchhoff</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Failure%20during%20shutdown%20with%20v2.3.1&In-Reply-To=%3CAANLkTim6SSfPEWQf9C_q5GxeEsX534%2BsCTSbNADdHeGx%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Failure during shutdown with v2.3.1">lee at rightscale.com
       </A><BR>
    <I>Fri Mar 11 04:03:42 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011771.html">[rabbitmq-discuss] rabbitmq 2.3 and SERVER_START_ARGS
</A></li>
        <LI>Next message: <A HREF="011861.html">[rabbitmq-discuss] Failure during shutdown with v2.3.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11752">[ date ]</a>
              <a href="thread.html#11752">[ thread ]</a>
              <a href="subject.html#11752">[ subject ]</a>
              <a href="author.html#11752">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I recently upgraded from RabbitMQ 1.8.1 to 2.3.1 and am running in Mac and
Ubuntu enviroments. I have a plugin that uses the amqp_client to access a
local queue. With 2.3.1 when shutting down I get the error below, which I
never encountered previously. There is no load when the shutdown is
happening.

I tried to determine the cause. It appears that it may be something of a
race in that when I insert a 500 msec delay in
amqp_channels_manger:handle_channel_down/4 I get the initial internal error
indication, but no following error report. My plugin is listed before the
amqp_client application when I do a 'rabbitmqctl status' so I it should be
the first getting a chance to shutdown and close its amqp connection, i.e.,
before the amqp_client shuts down, but I suppose applications shutdown
asynchronously.

Is this a bug or am I violating some RabbitMQ design assumption. Like I
said, it wasn't happening with 1.8.1 over the last 10 months of use.

Lee Kirchhoff


=WARNING REPORT==== 10-Mar-2011::16:19:53 ===
Connection (&lt;0.258.0&gt;) closing: internal error in channel (&lt;0.263.0&gt;):
shutdown

=INFO REPORT==== 10-Mar-2011::16:19:53 ===
stopped TCP Listener on 0.0.0.0:5672

=ERROR REPORT==== 10-Mar-2011::16:19:53 ===
** Generic server &lt;0.258.0&gt; terminating
** Last message in was {'$gen_cast',channels_terminated}
** When Server state == {state,amqp_direct_connection,
                         {state,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Lee-Kirchoffs-MacBook-Pro-9</A>',
                          {user,&lt;&lt;&quot;admin&quot;&gt;&gt;,false,
                           rabbit_auth_backend_internal,
                           {internal_user,&lt;&lt;&quot;admin&quot;&gt;&gt;,

&lt;&lt;167,250,242,115,130,251,81,144,147,129,52,74,15,
                              106,4,17,219,130,101,154&gt;&gt;,
                            false}},
                          &lt;&lt;&quot;/right_net&quot;&gt;&gt;,&lt;0.261.0&gt;,
                          {internal_error,541,&lt;&lt;&gt;&gt;}},
                         &lt;0.256.0&gt;,&lt;0.259.0&gt;,
                         {amqp_params,&lt;&lt;&quot;admin&quot;&gt;&gt;,&lt;&lt;&quot;71a8B521&quot;&gt;&gt;,
                          &lt;&lt;&quot;/right_net&quot;&gt;&gt;,&quot;localhost&quot;,5672,
                          '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Lee-Kirchoffs-MacBook-Pro-9</A>',0,0,0,none,
                          [#Fun&lt;amqp_auth_mechanisms.plain.3&gt;,
                           #Fun&lt;amqp_auth_mechanisms.amqplain.3&gt;],
                          []},
                         0,
                         [{&lt;&lt;&quot;copyright&quot;&gt;&gt;,longstr,
                           &lt;&lt;&quot;Copyright (C) 2007-2011 VMware, Inc.&quot;&gt;&gt;},
                          {&lt;&lt;&quot;information&quot;&gt;&gt;,longstr,
                           &lt;&lt;&quot;Licensed under the MPL.  See
<A HREF="http://www.rabbitmq.com/&quot;">http://www.rabbitmq.com/&quot;</A>&gt;&gt;},
                          {&lt;&lt;&quot;platform&quot;&gt;&gt;,longstr,&lt;&lt;&quot;Erlang/OTP&quot;&gt;&gt;},
                          {&lt;&lt;&quot;product&quot;&gt;&gt;,longstr,&lt;&lt;&quot;RabbitMQ&quot;&gt;&gt;},
                          {&lt;&lt;&quot;version&quot;&gt;&gt;,longstr,&lt;&lt;&quot;%%VSN%%&quot;&gt;&gt;}],
                         #Fun&lt;amqp_connection_sup.1.27217533&gt;,
                         #Fun&lt;amqp_connection_sup.2.105785818&gt;,
                         {closing,internal_error,
                          {'connection.close',541,&lt;&lt;&gt;&gt;,0,0},
                          none}}
** Reason for termination ==
** {internal_error,541,&lt;&lt;&gt;&gt;}
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110310/bb2fea91/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110310/bb2fea91/attachment.htm</A>&gt;
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011771.html">[rabbitmq-discuss] rabbitmq 2.3 and SERVER_START_ARGS
</A></li>
	<LI>Next message: <A HREF="011861.html">[rabbitmq-discuss] Failure during shutdown with v2.3.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11752">[ date ]</a>
              <a href="thread.html#11752">[ thread ]</a>
              <a href="subject.html#11752">[ subject ]</a>
              <a href="author.html#11752">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
