<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer - threw an exception for channel	AMQChannel
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20-%20threw%20an%20exception%20for%20channel%0A%09AMQChannel&In-Reply-To=%3C78D0945F-E0CF-4932-AC36-EC07023AB54E%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011779.html">
   <LINK REL="Next"  HREF="011767.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer - threw an exception for channel	AMQChannel</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20-%20threw%20an%20exception%20for%20channel%0A%09AMQChannel&In-Reply-To=%3C78D0945F-E0CF-4932-AC36-EC07023AB54E%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Consumer - threw an exception for channel	AMQChannel">steve at rabbitmq.com
       </A><BR>
    <I>Mon Mar 14 16:53:56 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011779.html">[rabbitmq-discuss] Consumer - threw an exception for channel	AMQChannel
</A></li>
        <LI>Next message: <A HREF="011767.html">[rabbitmq-discuss] Reddit news
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11800">[ date ]</a>
              <a href="thread.html#11800">[ thread ]</a>
              <a href="subject.html#11800">[ subject ]</a>
              <a href="author.html#11800">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rishi,

I think that new String(delivery.getBody()) will generate a String occupying about two times as much storage as the byte array, so 16 messages is about 96MB.

It is extremely unlikely that gc would fail to recover storage that was unreachable, so you cannot be losing the references to the new String() s.

It is possible that you have a reference to the String s kept around in your code, or else, the Eclipse execution environment is keeping these references for tracing/debugging purposes, which wouldn't happen in a product environment.

The details you give look OK for Eclipse, though what you say implies that the problem of OoM only happens when 'running at full throttle'.  Is that why you can give me memory patterns for beyond 16 messages?

I've run a few tests of my own in Eclipse, and as far as I can see strings are garbage collected (each takes about 6.3MB for a 3MB array), though my simple tests aren't using rabbit.

Maybe we could help if we saw more of your consumer loop.  What do you do with those String s?

Steve Powell
On 13 Mar 2011, at 11:46, RishiDev wrote:

&gt;<i> I am running this test program from within eclipse. My eclipse.ini
</I>&gt;<i> file has below properties.
</I>&gt;<i> -startup
</I>&gt;<i> plugins/org.eclipse.equinox.launcher_1.1.0.v20100507.jar
</I>&gt;<i> --launcher.library
</I>&gt;<i> plugins/org.eclipse.equinox.launcher.win32.win32.x86_1.1.0.v20100503
</I>&gt;<i> -product
</I>&gt;<i> org.eclipse.epp.package.java.product
</I>&gt;<i> --launcher.defaultAction
</I>&gt;<i> openFile
</I>&gt;<i> --launcher.XXMaxPermSize
</I>&gt;<i> 256M
</I>&gt;<i> -showsplash
</I>&gt;<i> org.eclipse.platform
</I>&gt;<i> --launcher.XXMaxPermSize
</I>&gt;<i> 256m
</I>&gt;<i> --launcher.defaultAction
</I>&gt;<i> openFile
</I>&gt;<i> -vm
</I>&gt;<i> C:/programs/java/jdk1.6.0_012/bin
</I>&gt;<i> -vmargs
</I>&gt;<i> -Dosgi.requiredJavaVersion=1.5
</I>&gt;<i> -Xms512m
</I>&gt;<i> -Xmx1024m
</I>&gt;<i> 
</I>&gt;<i> I believe problem is coming because in while loop I am converting the
</I>&gt;<i> byte[] into string using new String(byte[]).
</I>&gt;<i> Below line of code is the cause:
</I>&gt;<i> msgContent=new String(delivery.getBody());
</I>&gt;<i> 
</I>&gt;<i> GC does tries to free up memory, still I think it doesn't take care of
</I>&gt;<i> string objects sitting in heap as soon as they are not needed. While
</I>&gt;<i> loop is running @ full throttle.
</I>&gt;<i> Here is memory (Runtime.getRuntime().freeMemory()) pattern on receipt
</I>&gt;<i> of each msg:
</I>&gt;<i> Intial Memory 4831168
</I>&gt;<i> 0 : Memory = 4300664
</I>&gt;<i> 1 : Memory = 12289864
</I>&gt;<i> 2 : Memory = 12289912
</I>&gt;<i> 3 : Memory = 15001624
</I>&gt;<i> 4 : Memory = 12289528
</I>&gt;<i> 5 : Memory = 14513344
</I>&gt;<i> 6 : Memory = 14513120
</I>&gt;<i> 7 : Memory = 13986864
</I>&gt;<i> 8 : Memory = 14382256
</I>&gt;<i> 9 : Memory = 13986760
</I>&gt;<i> 10 : Memory = 16178360
</I>&gt;<i> 11 : Memory = 16178336
</I>&gt;<i> 12 : Memory = 16440544
</I>&gt;<i> 13 : Memory = 16309256
</I>&gt;<i> 14 : Memory = 16569344
</I>&gt;<i> 15 : Memory = 17710224
</I>&gt;<i> 16 : Memory = 16571624
</I>&gt;<i> 17 : Memory = 13634552
</I>&gt;<i> 18 : Memory = 13958824
</I>&gt;<i> 19 : Memory = 16146296
</I>&gt;<i> 20 : Memory = 17551288
</I>&gt;<i> 21 : Memory = 14966368
</I>&gt;<i> 22 : Memory = 17026856
</I>&gt;<i> 23 : Memory = 14966496
</I>&gt;<i> 24 : Memory = 15320384
</I>&gt;<i> 25 : Memory = 16183312
</I>&gt;<i> 26 : Memory = 16359344
</I>&gt;<i> 27 : Memory = 20692472
</I>&gt;<i> 28 : Memory = 23010888
</I>&gt;<i> 29 : Memory = 21177504
</I>&gt;<i> 30 : Memory = 21222064
</I>&gt;<i> 31 : Memory = 22916800
</I>&gt;<i> 32 : Memory = 22916624
</I>&gt;<i> 33 : Memory = 25201640
</I>&gt;<i> 34 : Memory = 28177344
</I>&gt;<i> 35 : Memory = 29973712
</I>&gt;<i> 36 : Memory = 28923024
</I>&gt;<i> 37 : Memory = 26630152
</I>&gt;<i> 38 : Memory = 26850696
</I>&gt;<i> 39 : Memory = 29737008
</I>&gt;<i> 40 : Memory = 30523536
</I>&gt;<i> 41 : Memory = 27552984
</I>&gt;<i> 42 : Memory = 31575736
</I>&gt;<i> 43 : Memory = 29255120
</I>&gt;<i> 44 : Memory = 29977904
</I>&gt;<i> 45 : Memory = 28688760
</I>&gt;<i> 46 : Memory = 30220600
</I>&gt;<i> 47 : Memory = 32055928
</I>&gt;<i> 48 : Memory = 31662688
</I>&gt;<i> 49 : Memory = 27281776
</I>&gt;<i> 50 : Memory = 32715880
</I>&gt;<i> 51 : Memory = 31796376
</I>&gt;<i> 52 : Memory = 29213632
</I>&gt;<i> 53 : Memory = 26370440
</I>&gt;<i> 54 : Memory = 26370112
</I>&gt;<i> 55 : Memory = 31009408
</I>&gt;<i> 56 : Memory = 31929120
</I>&gt;<i> 57 : Memory = 28557568
</I>&gt;<i> 58 : Memory = 29215280
</I>&gt;<i> 59 : Memory = 29215360
</I>&gt;<i> 60 : Memory = 31402672
</I>&gt;<i> 61 : Memory = 23395400
</I>&gt;<i> 62 : Memory = 26461160
</I>&gt;<i> 63 : Memory = 29963944
</I>&gt;<i> 64 : Memory = 30881736
</I>&gt;<i> 65 : Memory = 26107536
</I>&gt;<i> 66 : Memory = 28036680
</I>&gt;<i> 67 : Memory = 27117232
</I>&gt;<i> 68 : Memory = 26371872
</I>&gt;<i> 69 : Memory = 26371648
</I>&gt;<i> 70 : Memory = 27903384
</I>&gt;<i> 71 : Memory = 30095208
</I>&gt;<i> 72 : Memory = 26369784
</I>&gt;<i> 73 : Memory = 23526928
</I>&gt;<i> 74 : Memory = 25320624
</I>&gt;<i> 75 : Memory = 25583208
</I>&gt;<i> 76 : Memory = 24274456
</I>&gt;<i> 77 : Memory = 19631280
</I>&gt;<i> 78 : Memory = 24536536
</I>&gt;<i> 79 : Memory = 26986152
</I>&gt;<i> 80 : Memory = 26594952
</I>&gt;<i> 81 : Memory = 20682104
</I>&gt;<i> 82 : Memory = 17836880
</I>&gt;<i> 83 : Memory = 20682152
</I>&gt;<i> 84 : Memory = 20682176
</I>&gt;<i> 85 : Memory = 17836736
</I>&gt;<i> 86 : Memory = 17836680
</I>&gt;<i> 87 : Memory = 18060384
</I>&gt;<i> 88 : Memory = 17706216
</I>&gt;<i> 89 : Memory = 14336712
</I>&gt;<i> 90 : Memory = 14467672
</I>&gt;<i> 91 : Memory = 9302712
</I>&gt;<i> 92 : Memory = 6459032
</I>&gt;<i> 93 : Memory = 8777240
</I>&gt;<i> 94 : Memory = 5633480
</I>&gt;<i> 95 : Memory = 8517688
</I>&gt;<i> 96 : Memory = 7337728
</I>&gt;<i> 97 : Memory = 7337984
</I>&gt;<i> 
</I>&gt;<i> Please advice.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> Rishi
</I>&gt;<i> 
</I>&gt;<i> On Mar 11, 9:30 pm, Rob Harrop &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">r... at rabbitmq.com</A>&gt; wrote:
</I>&gt;&gt;<i> What heap size do you have configured for your JVM? It's is entirely
</I>&gt;&gt;<i> possible that if you're using the default sizes that 16 3MB msgs will
</I>&gt;&gt;<i> cause you to start hitting the OOM exception.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Regards,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Rob
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 11/03/11 16:02, RishiDev wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I have about 10K large msgs (each ~3 MB) in a queue. Started running a
</I>&gt;&gt;&gt;<i> java consumer client on the queue and after receiving 16 msgs I got
</I>&gt;&gt;&gt;<i> following exception. Please help resolve/understand the issue.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Consumer <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">com.rabbitmq.client.QueueingConsumer at 15b9e68</A> (amq.ctag-bEjkq
</I>&gt;&gt;&gt;<i> +5EqqmXsp1idK9rrg==) method handleDelivery for channel
</I>&gt;&gt;&gt;<i> AMQChannel(<A HREF="amqp://guest@localhost:5672/,1">amqp://guest@localhost:5672/,1</A>) threw an exception for
</I>&gt;&gt;&gt;<i> channel AMQChannel(<A HREF="amqp://guest@localhost:5672/,1">amqp://guest@localhost:5672/,1</A>):
</I>&gt;&gt;&gt;<i> java.lang.OutOfMemoryError
</I>&gt;&gt;&gt;<i> com.rabbitmq.client.AlreadyClosedException: clean connection shutdown;
</I>&gt;&gt;&gt;<i> reason: Attempt to use closed channel
</I>&gt;&gt;&gt;<i>    at com.rabbitmq.client.impl.AMQChannel.ensureIsOpen(AMQChannel.java:
</I>&gt;&gt;&gt;<i> 195)
</I>&gt;&gt;&gt;<i>    at com.rabbitmq.client.impl.AMQChannel.transmit(AMQChannel.java:290)
</I>&gt;&gt;&gt;<i>    at com.rabbitmq.client.impl.AMQChannel.transmit(AMQChannel.java:284)
</I>&gt;&gt;&gt;<i>    at com.rabbitmq.client.impl.ChannelN.basicAck(ChannelN.java:669)
</I>&gt;&gt;&gt;<i>    at
</I>&gt;&gt;&gt;<i> com.octanner.jmspoc.rabbitmq.RabbitMQConsumer.receiveMsgs(RabbitMQConsumer.java:
</I>&gt;&gt;&gt;<i> 69)
</I>&gt;&gt;&gt;<i>    at
</I>&gt;&gt;&gt;<i> com.octanner.jmspoc.rabbitmq.RabbitMQConsumer.main(RabbitMQConsumer.java:
</I>&gt;&gt;&gt;<i> 77)
</I>&gt;&gt;&gt;<i> Exception in thread &quot;main&quot;
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;<i> Rishi
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011779.html">[rabbitmq-discuss] Consumer - threw an exception for channel	AMQChannel
</A></li>
	<LI>Next message: <A HREF="011767.html">[rabbitmq-discuss] Reddit news
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11800">[ date ]</a>
              <a href="thread.html#11800">[ thread ]</a>
              <a href="subject.html#11800">[ subject ]</a>
              <a href="author.html#11800">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
