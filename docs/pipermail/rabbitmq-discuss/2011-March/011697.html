<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Incorrect number of messages saved to the queue	after RabbitMQ broker failure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Incorrect%20number%20of%20messages%20saved%20to%20the%0A%20queue%09after%20RabbitMQ%20broker%20failure&In-Reply-To=%3C4076B622-20FF-47EE-8F5F-BFF2E8B444BF%40vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011696.html">
   <LINK REL="Next"  HREF="011699.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Incorrect number of messages saved to the queue	after RabbitMQ broker failure</H1>
    <B>Jerry Kuch</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Incorrect%20number%20of%20messages%20saved%20to%20the%0A%20queue%09after%20RabbitMQ%20broker%20failure&In-Reply-To=%3C4076B622-20FF-47EE-8F5F-BFF2E8B444BF%40vmware.com%3E"
       TITLE="[rabbitmq-discuss] Incorrect number of messages saved to the queue	after RabbitMQ broker failure">jerryk at vmware.com
       </A><BR>
    <I>Wed Mar  9 00:24:39 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011696.html">[rabbitmq-discuss] Incorrect number of messages saved to the queue	after RabbitMQ broker failure
</A></li>
        <LI>Next message: <A HREF="011699.html">[rabbitmq-discuss] Incorrect number of messages saved to the queue	after RabbitMQ broker failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11697">[ date ]</a>
              <a href="thread.html#11697">[ thread ]</a>
              <a href="subject.html#11697">[ subject ]</a>
              <a href="author.html#11697">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, Venkat...

If you haven't ACKed your 10 consumed messages, either by using the auto-ACK setting in your consuming code, or by explicitly invoking basic.ack, the broker will maintain those messages, since it isn't certain that a client has taken responsibility.  The intent of this behavior is to guard against the case where a consumer crashes after getting a message but before doing whatever work it had planned to do on it.

Best regards,
Jerry

On Mar 8, 2011, at 4:16 PM, venkat veludandi wrote:

&gt;<i> Good evening.
</I>&gt;<i> After consuming few published messages, if I bring down the RabbitMQ broker (hard failure) and bring it back, the number of messages saved to queue is incorrect.
</I>&gt;<i> For example, I publish 100 messages. After consuming 10 messages, I bring down the broker and bring it back. Run: rabbitmqctl list_queues messages_ready, I see the count of messages_ready as 100 instead of 90.
</I>&gt;<i> Could you please let me know if there is anything wrong with the following Producer and consumer code:
</I>&gt;<i>  
</I>&gt;<i> Thanks
</I>&gt;<i> Venkat
</I>&gt;<i> ===========================
</I>&gt;<i> TestProducer.java
</I>&gt;<i> -------------------------
</I>&gt;<i> public class TestProducer {
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> public static void main(String[] args) {
</I>&gt;<i> 
</I>&gt;<i> for(int i=0; i &lt; 100; i++) {
</I>&gt;<i> 
</I>&gt;<i> String msg = &quot;M&quot; + i;
</I>&gt;<i> 
</I>&gt;<i> try {
</I>&gt;<i> 
</I>&gt;<i> RabbitMQProducer.INSTANCE.run(msg);
</I>&gt;<i> 
</I>&gt;<i> } catch(Exception e) {
</I>&gt;<i> 
</I>&gt;<i> System.out.println(&quot;exception occurred&quot;);
</I>&gt;<i> 
</I>&gt;<i> break;
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> =============================================================
</I>&gt;<i> 
</I>&gt;<i> RabbitMQProducer.java:
</I>&gt;<i> 
</I>&gt;<i> --------------------------------
</I>&gt;<i> 
</I>&gt;<i> public class RabbitMQProducer {
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> public static final RabbitMQProducer INSTANCE = new RabbitMQProducer();
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> private RabbitMQProducer() {}
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> public void run(String msg) {
</I>&gt;<i> 
</I>&gt;<i> String hostName = &quot;localhost&quot;;
</I>&gt;<i> 
</I>&gt;<i> String port = &quot;5672&quot;;
</I>&gt;<i> 
</I>&gt;<i> int portNumber = Integer.valueOf(port);;
</I>&gt;<i> 
</I>&gt;<i> Connection conn = null;
</I>&gt;<i> 
</I>&gt;<i> try {
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ConnectionFactory cf = new ConnectionFactory();
</I>&gt;<i> 
</I>&gt;<i> cf.setHost(hostName);
</I>&gt;<i> 
</I>&gt;<i> cf.setPort(portNumber);
</I>&gt;<i> 
</I>&gt;<i> cf.setUsername(&quot;guest&quot;);
</I>&gt;<i> 
</I>&gt;<i> cf.setPassword(&quot;guest&quot;);
</I>&gt;<i> 
</I>&gt;<i> conn = cf.newConnection();
</I>&gt;<i> 
</I>&gt;<i> Channel ch = conn.createChannel();
</I>&gt;<i> 
</I>&gt;<i> ch.exchangeDeclare(&quot;mdb.testq.exchange&quot;, &quot;topic&quot;, true);
</I>&gt;<i> 
</I>&gt;<i> ch.queueDeclare(&quot;mdb.testq.queue&quot;, true, false, false, null);
</I>&gt;<i> 
</I>&gt;<i> ch.txSelect();
</I>&gt;<i> 
</I>&gt;<i> ch.basicPublish(&quot;mdb.testq.exchange&quot;, &quot;mdb.testq.queue&quot;, MessageProperties.PERSISTENT_BASIC, msg.getBytes());
</I>&gt;<i> 
</I>&gt;<i> ch.txCommit();
</I>&gt;<i> 
</I>&gt;<i> ch.close();
</I>&gt;<i> 
</I>&gt;<i> conn.close();
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> } catch (IOException e) {
</I>&gt;<i> 
</I>&gt;<i> e.printStackTrace();
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> =================================================================
</I>&gt;<i> 
</I>&gt;<i> public class RabbitConsumer {
</I>&gt;<i> 
</I>&gt;<i> private int count = 0;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> private void runConsumer() {
</I>&gt;<i> 
</I>&gt;<i> Connection conn = null;
</I>&gt;<i> 
</I>&gt;<i> try {
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> String hostName = &quot;localhost&quot;;
</I>&gt;<i> 
</I>&gt;<i> String port = &quot;5672&quot;;
</I>&gt;<i> 
</I>&gt;<i> int portNumber = Integer.valueOf(port);
</I>&gt;<i> 
</I>&gt;<i> ConnectionFactory cf = new ConnectionFactory();
</I>&gt;<i> 
</I>&gt;<i> cf.setHost(hostName);
</I>&gt;<i> 
</I>&gt;<i> cf.setPort(portNumber);
</I>&gt;<i> 
</I>&gt;<i> cf.setUsername(&quot;guest&quot;);
</I>&gt;<i> 
</I>&gt;<i> cf.setPassword(&quot;guest&quot;);
</I>&gt;<i> 
</I>&gt;<i> conn = cf.newConnection();
</I>&gt;<i> 
</I>&gt;<i> Channel channel = conn.createChannel();
</I>&gt;<i> 
</I>&gt;<i> channel.exchangeDeclare(&quot;mdb.testq.exchange&quot;, &quot;topic&quot;, true);
</I>&gt;<i> 
</I>&gt;<i> channel.queueBind(&quot;mdb.testq.queue&quot;, &quot;mdb.testq.exchange&quot;, &quot;#&quot;);
</I>&gt;<i> 
</I>&gt;<i> Consumer consumer = new QueueingConsumer(channel);
</I>&gt;<i> 
</I>&gt;<i> channel.basicQos(1);
</I>&gt;<i> 
</I>&gt;<i> channel.basicConsume(&quot;mdb.testq.queue&quot;, false, consumer);
</I>&gt;<i> 
</I>&gt;<i> boolean running = true;
</I>&gt;<i> 
</I>&gt;<i> while(running) {
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> QueueingConsumer.Delivery delivery;
</I>&gt;<i> 
</I>&gt;<i> try {
</I>&gt;<i> 
</I>&gt;<i> delivery = ((QueueingConsumer) consumer).nextDelivery();
</I>&gt;<i> 
</I>&gt;<i> Thread.currentThread().sleep(500);
</I>&gt;<i> 
</I>&gt;<i> count++;
</I>&gt;<i> 
</I>&gt;<i> System.out.println(&quot;count: &quot;+count);
</I>&gt;<i> 
</I>&gt;<i> channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
</I>&gt;<i> 
</I>&gt;<i> } catch (Exception e) {
</I>&gt;<i> 
</I>&gt;<i> e.printStackTrace();
</I>&gt;<i> 
</I>&gt;<i> break;
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> } catch (IOException e) {
</I>&gt;<i> 
</I>&gt;<i> e.printStackTrace();
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> public static void main(String[] args) {
</I>&gt;<i> 
</I>&gt;<i> RabbitConsumer rc = new RabbitConsumer();
</I>&gt;<i> 
</I>&gt;<i> rc.runConsumer();
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &lt;ATT00001..txt&gt;
</I>
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011696.html">[rabbitmq-discuss] Incorrect number of messages saved to the queue	after RabbitMQ broker failure
</A></li>
	<LI>Next message: <A HREF="011699.html">[rabbitmq-discuss] Incorrect number of messages saved to the queue	after RabbitMQ broker failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11697">[ date ]</a>
              <a href="thread.html#11697">[ thread ]</a>
              <a href="subject.html#11697">[ subject ]</a>
              <a href="author.html#11697">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
