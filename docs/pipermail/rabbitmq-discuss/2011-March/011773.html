<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Subscription Pattern in .net
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Subscription%20Pattern%20in%20.net&In-Reply-To=%3CAANLkTim%3D9nDjV9UVmudcC3dh4XdK9DjHT5uLiUHew6-M%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011824.html">
   <LINK REL="Next"  HREF="011830.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Subscription Pattern in .net</H1>
    <B>Steven Taylor</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Subscription%20Pattern%20in%20.net&In-Reply-To=%3CAANLkTim%3D9nDjV9UVmudcC3dh4XdK9DjHT5uLiUHew6-M%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Subscription Pattern in .net">taylste at gmail.com
       </A><BR>
    <I>Sat Mar 12 08:06:18 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="011824.html">[rabbitmq-discuss] Reddit news
</A></li>
        <LI>Next message: <A HREF="011830.html">[rabbitmq-discuss] Subscription Pattern in .net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11773">[ date ]</a>
              <a href="thread.html#11773">[ thread ]</a>
              <a href="subject.html#11773">[ subject ]</a>
              <a href="author.html#11773">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I like the Consumer pattern, but I wanted a timed version of it.  FYI: the
Consumer pattern is basically a message enumerator/iterator that you can use
in a foreach statement.  i.e. when a message turns up, you get another pass
through the loop during which your code can decide what to do with the
message.  Consumer lives in the RabbitMQ.Client.MessagePatterns namespace.

For me, Foreach is neat approach as It hides uneccessesary detail.

 I finally managed to dig into some of the RabbitMQ source code.  Is source
code better than documentation?  Maybe.

Anyway, the functionality I wanted was always there.  How did I miss that?
There's a version of the Next function that has a parameter for a timed
wait.

So, instead of:

using(Subscription sub=new Subscription(ch,QueueNme)) {
  foreach(BasicDeliverEventArgs ev in sub) {
    DoRQMessage(ev.Body);
    // do work here
    ch.BasicAck(ev.DeliveryTag,true);
  }
  sub.Ack();
}

Use this instead...

using(Subscription sub=new Subscription(ch,QueueNme)) {
  BasicDeliverEventArgs message;
  while(true) {
    sub.Next(5000,out message); // wait up to 5 seconds
    if(message==null) {
      // logic to deal with the timeout
      break; // kill the loop if that's what you want
    }
    // do work here
    ch.BasicAck(message.DeliveryTag,true);
  }
}

Note: behind the scenes foreach uses IEnumerator.MoveNext(), which being
parameterless, in turn calls the Next() function, not the timed version
above &quot;sub.Next(5000,out message); &quot;.  There's nothing stopping us putting
in a simple if branch that accessess module level variables set by a
constructor for a slightly neater approach.

So what is the policy on updating the Mercurial repository?  If I get a
spare chance, and this is desirable, I'll alter Subscribe with an additional
constructor that has a timer argument.  Then those of us that care can
continue to use the foreach statement.
e.g. using(Subscription sub=new Subscription(ch,QueueNme,5000))  ...
foreach(BasicDeliverEventArgs ev in sub)

Does anyone like this change?  There's not a big difference between doing a
foreach and a while.  Just a tiny bit neater IMO.

cheers,
-Steven
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110312/f5d06129/attachment-0001.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110312/f5d06129/attachment-0001.htm</A>&gt;
</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011824.html">[rabbitmq-discuss] Reddit news
</A></li>
	<LI>Next message: <A HREF="011830.html">[rabbitmq-discuss] Subscription Pattern in .net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11773">[ date ]</a>
              <a href="thread.html#11773">[ thread ]</a>
              <a href="subject.html#11773">[ subject ]</a>
              <a href="author.html#11773">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
