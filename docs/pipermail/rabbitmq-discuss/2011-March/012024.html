<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] parallel consuming from one queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20parallel%20consuming%20from%20one%20queue&In-Reply-To=%3C4412D9D8F22D764F87903CF7FA46B2DC14D50B6B%40UNILONEX01.unibet.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012009.html">
   <LINK REL="Next"  HREF="012025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] parallel consuming from one queue</H1>
    <B>Jan Andersson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20parallel%20consuming%20from%20one%20queue&In-Reply-To=%3C4412D9D8F22D764F87903CF7FA46B2DC14D50B6B%40UNILONEX01.unibet.com%3E"
       TITLE="[rabbitmq-discuss] parallel consuming from one queue">Jan.Andersson at UNIBET.com
       </A><BR>
    <I>Fri Mar 25 08:10:45 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012009.html">[rabbitmq-discuss] parallel consuming from one queue
</A></li>
        <LI>Next message: <A HREF="012025.html">[rabbitmq-discuss] parallel consuming from one queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12024">[ date ]</a>
              <a href="thread.html#12024">[ thread ]</a>
              <a href="subject.html#12024">[ subject ]</a>
              <a href="author.html#12024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/24/2011 05:50 PM, Emile Joubert wrote:
&gt;<i> Hi Jan,
</I>&gt;<i>
</I>&gt;<i> On 24/03/11 16:38, Jan Andersson wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> we are trying to setup something that we hoped would be pretty straight
</I>&gt;&gt;<i> forward but can't seem to get it to work.
</I>&gt;&gt;<i> We want to consume messages from a persistent queue and use ack:s.
</I>&gt;&gt;<i> However all of our attempts end in us consuming one message off the
</I>&gt;&gt;<i> queue and then no one else (thread or process) can consume messages off
</I>&gt;&gt;<i> the queue until that message has been ack:ed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is in Java, we set up one channel per thread like this:
</I>&gt;&gt;<i> [code]
</I>&gt;&gt;<i> channel = connection.createChannel();
</I>&gt;&gt;<i> channel.exchangeDeclare(configuration.getExchangeName(), &quot;topic&quot;, true);
</I>&gt;&gt;<i> channel.queueDeclare(queueName, true); // durable queue
</I>&gt;&gt;<i> channel.queueBind(queueName, configuration.getExchangeName(), 
</I>&gt;&gt;<i> routingKey);
</I>&gt;&gt;<i> consumer = new QueueingConsumer(channel);
</I>&gt;<i>
</I>&gt;<i> channel.basicQos(SMALL_NUMBER);
</I>&gt;<i>
</I>&gt;&gt;<i> channel.basicConsume(queueName, false, consumer);
</I>&gt;&gt;<i> [/code]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The ack is done like this:
</I>&gt;&gt;<i> [code]
</I>&gt;&gt;<i> channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
</I>&gt;&gt;<i> [/code]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Might be hard to answer this but if anyone could point us in the right
</I>&gt;&gt;<i> direction that would be great!
</I>&gt;<i>
</I>&gt;<i> You should set QoS on each channel. The first QueueingConsumer has 
</I>&gt;<i> taken all the messages - that's why no other consumers can retrieve 
</I>&gt;<i> messages. Setting QoS will prevent the broker from delivering more 
</I>&gt;<i> than the set number of messages without acknowledgement and allow 
</I>&gt;<i> other consumers to retrieve some messages.
</I>&gt;<i>
</I>&gt;<i> Regards
</I>&gt;<i>
</I>&gt;<i> Emile
</I>

Hi,
after setting the QoS like &quot;channel.basicQos(1);&quot; we can pickup messages 
in parallel.
However, every message gets the deliveryTag set to 1. So when we ack the 
2nd, 3rd... message we get the error:

channel error; reason: 
{#method&lt;channel.close&gt;(reply-code=406,reply-text=PRECONDITION_FAILED - 
unknown delivery tag 1,class-id=60,method-id=80),null,&quot;&quot;}

Are we consuming the messages in the wrong way somehow?
(QueueingConsumer.Delivery delivery = consumer.nextDelivery();)

thanks for your quick reply,
regards
Jan

The information in this email is confidential and may be legally privileged.
If you are not the intended recipient, you must not read, use or disseminate that information
and upon reception, permanently delete the original and destroy any copies.
Although this email and any attachments are believed to be free of any virus
or any other defect which might affect any computer or IT system into which
they are received and opened, it is the responsibility of the recipient to
ensure that they are virus free and no responsibility is accepted by Unibet
for any loss or damage arising in any way from receipt or use thereof.

</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012009.html">[rabbitmq-discuss] parallel consuming from one queue
</A></li>
	<LI>Next message: <A HREF="012025.html">[rabbitmq-discuss] parallel consuming from one queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12024">[ date ]</a>
              <a href="thread.html#12024">[ thread ]</a>
              <a href="subject.html#12024">[ subject ]</a>
              <a href="author.html#12024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
