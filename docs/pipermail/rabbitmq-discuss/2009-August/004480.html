<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Socket errors and connections not closing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Socket%20errors%20and%20connections%20not%20closing&In-Reply-To=3de9aeb50908111942j1521cc11o323cf9eadac068e0%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004478.html">
   <LINK REL="Next"  HREF="004481.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Socket errors and connections not closing</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Socket%20errors%20and%20connections%20not%20closing&In-Reply-To=3de9aeb50908111942j1521cc11o323cf9eadac068e0%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Socket errors and connections not closing">matthias at lshift.net
       </A><BR>
    <I>Wed Aug 12 05:46:09 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004478.html">[rabbitmq-discuss] Socket errors and connections not closing
</A></li>
        <LI>Next message: <A HREF="004481.html">[rabbitmq-discuss] Socket errors and connections not closing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4480">[ date ]</a>
              <a href="thread.html#4480">[ thread ]</a>
              <a href="subject.html#4480">[ subject ]</a>
              <a href="author.html#4480">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Mark,

Mark Westling wrote:
&gt;<i> I'm using RabbitMQ for background processing in a Ruby on Rails 
</I>&gt;<i> environment.
</I>&gt;<i> [...]
</I>&gt;<i> Everything works perfectly on two different deployments of this system 
</I>&gt;<i> but on the third, the clients are getting occasional errors, &quot;Connection 
</I>&gt;<i> closed unexpectedly by peer&quot;.  At the same time, I'm not seeing any 
</I>&gt;<i> errors at all in the RabbitMQ log on the other server.  
</I>&gt;<i> 
</I>&gt;<i> When the client gets an error sending a message, it creates a new 
</I>&gt;<i> connection and tries passing the message again.  I do see the new 
</I>&gt;<i> connection in rabbit.log but nothing corresponding to the error reported 
</I>&gt;<i> by the client.  The result is a slow but steadily growing number of 
</I>&gt;<i> sockets in use by RabbitMQ; lsof shows an increase of about 150-200 of 
</I>&gt;<i> these sockets per day with state &quot;established&quot;.  I haven't watched 
</I>&gt;<i> carefully but it appears these sockets aren't dying, even though they 
</I>&gt;<i> refer to ports that aren't open any more on the client machine.
</I>
Did you check with lsof/netstat on the *client* machine whether the 
sockets are really dead there?

Also, are these connections going via some kind of firewall or 
loadbalancer? If so, perhaps the connections to the server are kept open 
there.

&gt;<i> If that fails, is there a configuration option that lets 
</I>&gt;<i> RabbitMQ close broken connections?
</I>
AMQP's heartbeat mechanism is designed precisely for this situation. The 
heartbeat frequency is negotiated between the client and the server at 
connection establishment. I don't know anything about the Ruby client, 
but I am assuming from the above that it disables heartbeats. If so, try 
to find a way to enable them.

Regards,

Matthias.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004478.html">[rabbitmq-discuss] Socket errors and connections not closing
</A></li>
	<LI>Next message: <A HREF="004481.html">[rabbitmq-discuss] Socket errors and connections not closing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4480">[ date ]</a>
              <a href="thread.html#4480">[ thread ]</a>
              <a href="subject.html#4480">[ subject ]</a>
              <a href="author.html#4480">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
