<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] building chat
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20building%20chat&In-Reply-To=167204d20908070352g43e8e2efv732f664bdd398bb0%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004421.html">
   <LINK REL="Next"  HREF="004393.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] building chat</H1>
    <B>Ben Browitt</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20building%20chat&In-Reply-To=167204d20908070352g43e8e2efv732f664bdd398bb0%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] building chat">ben.browitt at gmail.com
       </A><BR>
    <I>Sat Aug  8 14:31:05 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004421.html">[rabbitmq-discuss] building chat
</A></li>
        <LI>Next message: <A HREF="004393.html">[rabbitmq-discuss] regex permissions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4448">[ date ]</a>
              <a href="thread.html#4448">[ thread ]</a>
              <a href="subject.html#4448">[ subject ]</a>
              <a href="author.html#4448">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Aug 7, 2009 at 12:52 PM, Alexis Richardson &lt;
<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexis.richardson at gmail.com</A>&gt; wrote:

&gt;<i> Ben,
</I>&gt;<i>
</I>&gt;<i> Further to your email exchanges with Paul...
</I>&gt;<i>
</I>&gt;<i> On Thu, Aug 6, 2009 at 3:32 PM, Ben Browitt&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ben.browitt at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm trying to understand how AMQP and RabbitMQ works by building a simple
</I>&gt;<i> &gt; chat.
</I>&gt;<i>
</I>&gt;<i> Cool :-)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; From reading the AMQP specs I get the impression that it's best usage is
</I>&gt;<i> &gt; when someone publish content to an exchange
</I>&gt;<i> &gt; and someone else bind his queue to this exchange to get updates. This
</I>&gt;<i> model
</I>&gt;<i> &gt; works very well for publish-subscribe
</I>&gt;<i> &gt; and to finance systems but chat could be different.
</I>&gt;<i>
</I>&gt;<i> I think chat is a very natural application of AMQP.  The benefit of
</I>&gt;<i> using XMPP would be to integrate with existing chat infra in a
</I>&gt;<i> standard way, but that does not prevent you from using an AMQP based
</I>&gt;<i> implementation underneath.
</I>&gt;<i>
</I>&gt;<i> Do you want to do MUC or IM?
</I>

I'm not actually building it.
I keep hearing about AMQP and RabbitMQ so I read the spec and the server
docs.
I couldn't find use cases on the web so I thought I'll try to fit the
protocol to a fun application.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In fact, you can use a single approach to both.
</I>&gt;<i>
</I>&gt;<i> One approach is to have one queue per consumer 'chat window' and one
</I>&gt;<i> exchange per 'chat room'.  The queue is bound to the exchange when the
</I>&gt;<i> user is in the chatroom.  Then, IM is a special case of MUC - it is a
</I>&gt;<i> chatroom with two participants.
</I>&gt;<i>
</I>&gt;<i> Another approach would be to have one queue per consumer, and have
</I>&gt;<i> that queue bound to the exchange(s) N times, where N is the number of
</I>&gt;<i> chatrooms (or IMs) which the consumer is currently in.  In this
</I>&gt;<i> approach, you will need to identify which message came from which
</I>&gt;<i> room, before you show the messages to the user.  That's easy but it's
</I>&gt;<i> extra work and data to carry around.
</I>&gt;<i>
</I>
When a client sends a message to another client he usually doesn't create a
chatroom for two,
he just sends the message and the server routes it. With your suggestion the
server will create
the room if it doesn't exists when it needs to route a message.
When all the users leaves a MUC room if it is not persistent the server
destroys it.
What will be the case with a chatroom with two participants?
Maybe the server will destroy it when both users are offline?
Is there a way to destroy an exchange if it is not active for several
minutes to save memory?
Can you use a standard XMPP client with this setup?


&gt;<i>
</I>&gt;<i> Let me know if you want more detail on either of the above, eg which
</I>&gt;<i> exchange type to use.
</I>

I thought of a non durable exchange. One exchange per chatroom and one queue
per user.



&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I read the xmpp gateway
</I>&gt;<i> &gt; docs and have some questions.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In a chat we want to be able to get presence from users on our
</I>&gt;<i> friend-list,
</I>&gt;<i> &gt; send them messages
</I>&gt;<i> &gt; and send subscription request and messages to users not yet on our
</I>&gt;<i> &gt; friend-list.
</I>&gt;<i>
</I>&gt;<i> Do you only want to enable chat when both users are online and have a
</I>&gt;<i> 'friend' relationship?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; One possibility is that each user will have an exchange and a queue with
</I>&gt;<i> &gt; binding to his own exchange.
</I>&gt;<i> &gt; When user1 wants to send a message to user2 he send it directly to the
</I>&gt;<i> &gt; exchange of user2.
</I>&gt;<i> &gt; There is a problem with presence updates. If user1 changes his presence,
</I>&gt;<i> &gt; he'll have to sends the update
</I>&gt;<i> &gt; to the exchange of all the users on his friend-list. With this design we
</I>&gt;<i> &gt; move the logic to the client rather then use the AMQP features.
</I>&gt;<i>
</I>&gt;<i> One approach to presence is to broadcast changes using the pubsub
</I>&gt;<i> system.  Changes could include:
</I>&gt;<i>
</I>&gt;<i> * User goes online / offline
</I>&gt;<i> * User changes their 'status message'
</I>&gt;<i>
</I>
All I know is that there are queues exchanges and bindings.
What do you mean by the pubsub system?


&gt;<i>
</I>&gt;<i> &gt; Another option is that when a user logs in he'll create a binding to the
</I>&gt;<i> &gt; exchanges of all the users on his friend-list.
</I>&gt;<i>
</I>&gt;<i> You can do this but it creates quite a lot of churn on the exchange
</I>&gt;<i> layer.  Paul's suggestion is one way to prevent that.  Another is to
</I>&gt;<i> use exchange-exchange bindings, which we are also looking at.
</I>&gt;<i>
</I>
I meant to create bindings to all your online friends.
Can you explain how Paul's suggestion or exchange-exchange bindings solve or
improve it?

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; When user1 want to send a private message or a presence update to user2
</I>&gt;<i> &gt; he'll send it to his own exchange and it'll be directed to user2. The
</I>&gt;<i> &gt; problem with this design is that users without mutual presence
</I>&gt;<i> subscription
</I>&gt;<i> &gt; can't send private message to each other and can't send subscription
</I>&gt;<i> &gt; requests.
</I>&gt;<i>
</I>&gt;<i> You can decouple presence, which is about status updates, from
</I>&gt;<i> friendship.  If you like, you could have a set up where one user can
</I>&gt;<i> DM another, provided they are mutual friends, regardless of who is
</I>&gt;<i> online.  Do you want that?
</I>&gt;<i>
</I>&gt;<i> Subscription requests could also be implemented using a queue - one
</I>&gt;<i> per user.  Whenever a new user wishes to request mutual friendship
</I>&gt;<i> with user A, then user A could be notified of this via a queue.
</I>&gt;<i>
</I>
In that case will the server send the friendship request directly to the
queue?
Do you need another queue per user just for friendship requests or can you
use the same queue from above?


&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Can you please share your thoughts on the two options and maybe other
</I>&gt;<i> design
</I>&gt;<i> &gt; options?
</I>&gt;<i>
</I>&gt;<i> I've tried to shed some light on some of the issues above.  Feel free
</I>&gt;<i> to elaborate on your needs and ask more questions.
</I>&gt;<i>
</I>&gt;<i> alexis
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Thanks
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090808/6652a8b5/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090808/6652a8b5/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004421.html">[rabbitmq-discuss] building chat
</A></li>
	<LI>Next message: <A HREF="004393.html">[rabbitmq-discuss] regex permissions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4448">[ date ]</a>
              <a href="thread.html#4448">[ thread ]</a>
              <a href="subject.html#4448">[ subject ]</a>
              <a href="author.html#4448">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
