<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Weird%20Crash%20-%20Recovery%20logic%20for%20durable%0A%09messages/queues/exchanges%3F&In-Reply-To=4A7BFC58.9050304%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004417.html">
   <LINK REL="Next"  HREF="004424.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?</H1>
    <B>Darien Kindlund</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Weird%20Crash%20-%20Recovery%20logic%20for%20durable%0A%09messages/queues/exchanges%3F&In-Reply-To=4A7BFC58.9050304%40lshift.net"
       TITLE="[rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?">darien at kindlund.com
       </A><BR>
    <I>Fri Aug  7 16:04:11 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004417.html">[rabbitmq-discuss] Weird Crash - Recovery logic for durable messages/queues/exchanges?
</A></li>
        <LI>Next message: <A HREF="004424.html">[rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4423">[ date ]</a>
              <a href="thread.html#4423">[ thread ]</a>
              <a href="subject.html#4423">[ subject ]</a>
              <a href="author.html#4423">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Your consumers aren't by any chance containing some reconnecting logic that
</I>&gt;<i> tries to connect to the server again whenever a connection has been dropped?
</I>&gt;<i> I seem to recall reports that, for example, the ruby client does something
</I>&gt;<i> like that. Please check the server log to be sure - it contains a record of
</I>&gt;<i> all connects/disconnects.
</I>
Understood.  Yes, I've checked and there were no
connection/re-connection attempts, when I had witnessed the the
persistent messages in the durable queue were still marked as
un-ack'd.

&gt;<i> Once the server has delivered a message to a consumer, it will only become
</I>&gt;<i> available again to other consumers when then recipients channel/connection
</I>&gt;<i> is closed.
</I>
Okay.

&gt;&gt;<i> I'm trying to avoid having to shutdown the RabbitMQ server and
</I>&gt;&gt;<i> obliterate the nmesia persister log in order to clear out these
</I>&gt;&gt;<i> messages.
</I>&gt;<i>
</I>&gt;<i> That would remove all messages completely, rather than just making the
</I>&gt;<i> unacknowledged messages available to other consumers again. If the former is
</I>&gt;<i> really what you want then the 'queue.purge' command is your friend.
</I>
Okay, so 'queue.purge' will flush all 'ready' and 'un-ack'd' messages
from a particular queue -- or just un-ack'd messages?  Is there a
command in the AMQP spec that will instruct RabbitMQ to re-mark all
un-ack'd messages as ready?  If no such command exists, I'm thinking
it would be useful to include such a command in future versions of the
spec, so that people could develop 'message recovery logic', when
dealing with buggy consumers that are connected but are not actually
properly processing the messages.  I'm guessing your reply would be to
simply forcefully terminate the buggy consumers manually (i'm assuming
there's an AMQP spec command to do this), which would cause RabbitMQ
to re-mark those un-ack'd messages as 'ready'.  However, providing an
explicit command may be helpful for debugging purposes, as I've seemed
to encounter a bug where RabbitMQ didn't perform the re-mark operation
as expected.

If I run into this issue in the future, would it help if I could
provide you a copy of the mnesia directory once RabbitMQ has
unexpectedly crashed?

Thanks again,
-- Darien


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004417.html">[rabbitmq-discuss] Weird Crash - Recovery logic for durable messages/queues/exchanges?
</A></li>
	<LI>Next message: <A HREF="004424.html">[rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4423">[ date ]</a>
              <a href="thread.html#4423">[ thread ]</a>
              <a href="subject.html#4423">[ subject ]</a>
              <a href="author.html#4423">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
