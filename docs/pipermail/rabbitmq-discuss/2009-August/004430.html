<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Weird%20Crash%20-%20Recovery%20logic%20for%20durable%0A%09messages/queues/exchanges%3F&In-Reply-To=50c8ffe90908070804r2d3c6d07i2b5f8cf90d5f8cb1%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004424.html">
   <LINK REL="Next"  HREF="004427.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Weird%20Crash%20-%20Recovery%20logic%20for%20durable%0A%09messages/queues/exchanges%3F&In-Reply-To=50c8ffe90908070804r2d3c6d07i2b5f8cf90d5f8cb1%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?">matthias at lshift.net
       </A><BR>
    <I>Fri Aug  7 19:20:51 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004424.html">[rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?
</A></li>
        <LI>Next message: <A HREF="004427.html">[rabbitmq-discuss] Receiving Undelivered Persistent Messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4430">[ date ]</a>
              <a href="thread.html#4430">[ thread ]</a>
              <a href="subject.html#4430">[ subject ]</a>
              <a href="author.html#4430">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Darien,

Darien Kindlund wrote:
&gt;<i> Understood.  Yes, I've checked and there were no
</I>&gt;<i> connection/re-connection attempts, when I had witnessed the the
</I>&gt;<i> persistent messages in the durable queue were still marked as
</I>&gt;<i> un-ack'd.
</I>
And you are sure that the server actually restarted?

Also, how easy is it to reproduce this problem? Does it happen with,
say, a clean installation (empty db dir, no log files) when you publish
a few persistent messages, consume (but not ack) them, and then restart
the broker?

If you can construct such a test case for us then we'll try to replicate
it on our systems.

&gt;<i> Okay, so 'queue.purge' will flush all 'ready' and 'un-ack'd' messages
</I>&gt;<i> from a particular queue -- or just un-ack'd messages?
</I>
Good question :) In AMQP 0-8 the spec requires that queue.purge removes
*all* messages. In 0-9-1 this got changed to the more sensible &quot;all
messages not awaiting acknowledgement&quot;, and that is what RabbitMQ
implements.

&gt;<i> Is there a command in the AMQP spec that will instruct RabbitMQ to re-mark all
</I>&gt;<i> un-ack'd messages as ready?
</I>
There have been several discussions about this on the mailing list.
AMQP's 'basic.reject' command, which, if RabbitMQ implemented it (which
it doesn't, yet) would allow a client to reject, and thus make available
to other consumers, specific messages it has received.

But that falls short of what you are after, since you want some agent
other than the consumer to initiate the reclaim of messages.

&gt;<i> If no such command exists, I'm thinking it would be useful to include
</I>&gt;<i> such a command in future versions of the spec, so that people could
</I>&gt;<i> develop 'message recovery logic', when dealing with buggy consumers
</I>&gt;<i> that are connected but are not actually properly processing the
</I>&gt;<i> messages.
</I>
Do you want to have a stab at defining the syntax and semantics of this
new command? Take a look at the 0-9-1 xml spec
(<A HREF="http://jira.amqp.org/confluence/download/attachments/720900/amqp0-9-1.xml">http://jira.amqp.org/confluence/download/attachments/720900/amqp0-9-1.xml</A>),
to get an idea of the flavour in which AMQP commands are defined, and
follow that as closely as possible.

I'd be happy to review and discuss your proposal.

One issue you are going to have to think about is what to do with
acknowledgments sent by the original consumer for a message that has
been &quot;reclaimed&quot;. Do we treat the message as ack'ed at that point? Or
not? Should the ack fail (as it would if a consumer tried to ack a
message it didn't receive)? If we treat the message as ack'ed, what then
happens when another consumer to which the reclaimed message was sent
tries to ack it?

&gt;<i> If I run into this issue in the future, would it help if I could
</I>&gt;<i> provide you a copy of the mnesia directory once RabbitMQ has
</I>&gt;<i> unexpectedly crashed?
</I>
Possibly. Though looking at the code I am struggling to see how mnesia
or the persister could have anything to do with the behaviour you are
observing. You see, messages don't actually carry an 'unacknowledged'
mark. Instead when a message is sent to a consumer it is moved to a
different part of the state of the queue process, associated with that
particular consumer. rabbitmqctl quite literally counts the messages in
all these so-called consumer records to determined the unack'ed message
count. The consumer records do not survive a server restart. So for the
count to return a non-zero number after a restart the queue process must
have created some consumer records, which means some consumers must have
connected. Now, there could of course be all kinds of bugs lurking in
the code, including the queue processes conjuring up consumer records
from thin air, but atm I cannot see how a bug in the persistence
mechanism would result in the behaviour you have described.


Regards,

Matthias


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004424.html">[rabbitmq-discuss] Weird Crash - Recovery logic for durable	messages/queues/exchanges?
</A></li>
	<LI>Next message: <A HREF="004427.html">[rabbitmq-discuss] Receiving Undelivered Persistent Messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4430">[ date ]</a>
              <a href="thread.html#4430">[ thread ]</a>
              <a href="subject.html#4430">[ subject ]</a>
              <a href="author.html#4430">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
