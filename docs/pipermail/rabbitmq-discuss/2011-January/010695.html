<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Are queues replicated across a cluster?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Are%20queues%20replicated%20across%20a%20cluster%3F&In-Reply-To=%3C20110114170832.GI18402%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010660.html">
   <LINK REL="Next"  HREF="010701.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Are queues replicated across a cluster?</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Are%20queues%20replicated%20across%20a%20cluster%3F&In-Reply-To=%3C20110114170832.GI18402%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Are queues replicated across a cluster?">matthew at rabbitmq.com
       </A><BR>
    <I>Fri Jan 14 17:08:32 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010660.html">[rabbitmq-discuss] Are queues replicated across a cluster?
</A></li>
        <LI>Next message: <A HREF="010701.html">[rabbitmq-discuss] Are queues replicated across a cluster?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10695">[ date ]</a>
              <a href="thread.html#10695">[ thread ]</a>
              <a href="subject.html#10695">[ subject ]</a>
              <a href="author.html#10695">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Bill,

On Thu, Jan 13, 2011 at 06:42:19AM -0800, Bill Moseley wrote:
&gt;<i> I don't understand that sentence that says the queues only reside on the
</I>&gt;<i> node that created them -- but they are visible on both.  Is that talking
</I>&gt;<i> about replicating *messages* or queues?  Queues and messages are separate
</I>&gt;<i> things.  I understand that messages are not duplicated/replicated in the
</I>&gt;<i> cluster.
</I>
Within a cluster, the fact that a queue exists or not is recorded in a
distributed Erlang database, called mnesia. Thus all nodes within the
cluster know that a particular queue exists. Each queue however, only
exists on a single node. I.e. only one node will receive the messages
for that queue, and if that node goes down then the queue, and the
messages it contains, become unavailable.

The fact that the queue's existence is known to all nodes means that any
node that needs to route a message to said queue will be able to do so.

&gt;<i> What's the distinction between &quot;residing&quot; and &quot;visible&quot;?  Does it mean the
</I>&gt;<i> messages are only stored on node1 until consumed (by either node)?
</I>
Yes, precisely.

&gt;<i> But, I
</I>&gt;<i> can declare the same queue on both nodes and see the same behavior.  Can
</I>&gt;<i> someone please clear this up for me?
</I>
The second declaration is really just an assertion that the queue
exists. Thus the queue will be created on the node to which the
connection which first issues the queue declaration is connected.

&gt;<i> What I have failed to find when reading about clustering is how to connect
</I>&gt;<i> to the nodes in a cluster.  If I have node1 and node2 in my cluster and 10
</I>&gt;<i> producers (say web servers) and 4 worker machines do I configure 5 producers
</I>&gt;<i> to connect to node1 and 5 to node2, and then likewise split the consumer
</I>&gt;<i> connections across the two nodes?
</I>
Entirely up to you - resources are visible throughout the cluster and so
any sane load balancing should be just fine. If they all connect to the
same node then you'll likely find that all resources exist solely on
that node and thus the other nodes are not being used at all. Thus
really, you want to make sure that the clients which create resources
(queues in particular) are connected across all the nodes.

The other thing to consider is the inter-node hops required to route
messages. Thus you may wish to make sure that if client 1 is
predominantly sending messages to or consuming messages from queue 1,
that client 1 is connected to the same node on which queue 1 resides.

&gt;<i> To be clear, this is not HA.  So, if node1 fails then 1/2 the producers and
</I>&gt;<i> 1/2 the consumers can no longer function.  Correct?
</I>
Well, as explained, it depends where the queues reside, but yes, you
will likely lose some resources, and all the clients connected to the
failed node will need to reconnect to a surviving node.

&gt;<i> Or is the typical approach to use something like HAProxy in front of node1
</I>&gt;<i> and node2 and have all consumers and producers connect to HAProxy?  (That
</I>&gt;<i> ends up as a single point of failure.)
</I>
Yup, indeed. Though obviously with enough magic hackery you can even
remove the SPoF with something like an HAProxy. But it does depend on
your precise performance requirements etc.

Matthew
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010660.html">[rabbitmq-discuss] Are queues replicated across a cluster?
</A></li>
	<LI>Next message: <A HREF="010701.html">[rabbitmq-discuss] Are queues replicated across a cluster?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10695">[ date ]</a>
              <a href="thread.html#10695">[ thread ]</a>
              <a href="subject.html#10695">[ subject ]</a>
              <a href="author.html#10695">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
