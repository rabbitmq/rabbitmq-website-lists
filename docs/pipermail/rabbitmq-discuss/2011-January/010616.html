<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Java client: channel shutdown notification while closing connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Java%20client%3A%20channel%20shutdown%20notification%20while%0A%20closing%20connection&In-Reply-To=%3C20110111115028.11234me7qyqi7pc0%40webmail.active24.cz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010617.html">
   <LINK REL="Next"  HREF="010833.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Java client: channel shutdown notification while closing connection</H1>
    <B>jiri at krutil.com</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Java%20client%3A%20channel%20shutdown%20notification%20while%0A%20closing%20connection&In-Reply-To=%3C20110111115028.11234me7qyqi7pc0%40webmail.active24.cz%3E"
       TITLE="[rabbitmq-discuss] Java client: channel shutdown notification while closing connection">jiri at krutil.com
       </A><BR>
    <I>Tue Jan 11 10:50:28 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010617.html">[rabbitmq-discuss] Is there any mature C/C++ client for	rabbitmq?
</A></li>
        <LI>Next message: <A HREF="010833.html">[rabbitmq-discuss] Java client: channel shutdown notification while closing connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10616">[ date ]</a>
              <a href="thread.html#10616">[ thread ]</a>
              <a href="subject.html#10616">[ subject ]</a>
              <a href="author.html#10616">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I have run into a deadlock in my Java client application.

I have a synchronized method registered as a shutdown listener on both  
the channel and the connection.

One of our theads got stuck while trying to close the connection  
inside a method synchronized on the same lock as the shutdown listener.

The thread was executing this code:

     private synchronized void closeConnection() throws IOException {
         connection.removeShutdownListener(this);
         if (connection.isOpen())
             connection.close();
     }

The connection shutdown listener has been disabled, but it seems that  
something has triggered the channel shutdown listener. Not sure if  
this was the attempt to close the connection or something else.

The call stack of the closeConnection thread was:

     java/lang/Object.wait(Native Method)
     java/lang/Object.wait(Object.java:199)
     com/rabbitmq/utility/BlockingCell.get(BlockingCell.java:64)
     com/rabbitmq/utility/BlockingCell.get(BlockingCell.java:79)
      
com/rabbitmq/utility/BlockingCell.uninterruptibleGet(BlockingCell.java:125)
      
com/rabbitmq/utility/BlockingValueOrException.uninterruptibleGetValue(BlockingValueOrException.java:51)
      
com/rabbitmq/client/impl/AMQChannel$BlockingRpcContinuation.getReply(AMQChannel.java:348)
     com/rabbitmq/client/impl/AMQConnection.close(AMQConnection.java:710)
     com/rabbitmq/client/impl/AMQConnection.close(AMQConnection.java:640)
     com/rabbitmq/client/impl/AMQConnection.close(AMQConnection.java:626)
     com/rabbitmq/client/impl/AMQConnection.close(AMQConnection.java:619)
     AmqpAdapter.closeConnection(AmqpAdapter.java:477)
     ...

It seems that the method Connection.close() running in our thread was  
waiting for the completion of the channel shutdown listener running in  
the AMQP connection thread. But since the registered listener was  
waiting for the Java lock held by my method closeConnection(), a  
deadlock occured.

Both broker and Java client versions are 2.1.0.

Apparently I am doing something wrong, but I'm not sure what is the  
correct way how to do these things.

Should I unregister the channel shutdown listener before closing the  
connection?
Or should I avoid any synchronization in my shutdown listener? (would  
probably have to redesign)
It seems Connection.close() is synchronous. Should I make my shutdown  
listener asynchronous? (not sure how I would do that)

Any help is appreciated!

Jiri

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010617.html">[rabbitmq-discuss] Is there any mature C/C++ client for	rabbitmq?
</A></li>
	<LI>Next message: <A HREF="010833.html">[rabbitmq-discuss] Java client: channel shutdown notification while closing connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10616">[ date ]</a>
              <a href="thread.html#10616">[ thread ]</a>
              <a href="subject.html#10616">[ subject ]</a>
              <a href="author.html#10616">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
