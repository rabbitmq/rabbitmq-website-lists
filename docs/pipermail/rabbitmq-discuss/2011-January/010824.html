<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Reordering messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Reordering%20messages&In-Reply-To=%3Cyrv4caaiup8tc.fsf%40dwragg.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010823.html">
   <LINK REL="Next"  HREF="010827.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Reordering messages</H1>
    <B>David Wragg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Reordering%20messages&In-Reply-To=%3Cyrv4caaiup8tc.fsf%40dwragg.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] Reordering messages">david at rabbitmq.com
       </A><BR>
    <I>Fri Jan 21 15:37:03 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010823.html">[rabbitmq-discuss] Reordering messages
</A></li>
        <LI>Next message: <A HREF="010827.html">[rabbitmq-discuss] Cleaning up unhandled messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10824">[ date ]</a>
              <a href="thread.html#10824">[ thread ]</a>
              <a href="subject.html#10824">[ subject ]</a>
              <a href="author.html#10824">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Dimitri,

Dimitri del Marmol &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tontondimsum at gmail.com</A>&gt; writes:
&gt;&gt;<i> Put the two categories of messages onto two separate queues, and write
</I>&gt;&gt;<i> your application to preferentially consume from the higher priority
</I>&gt;&gt;<i> queue.
</I>&gt;<i>
</I>&gt;<i> I actually toyed with the idea but I have trouble imagining what the
</I>&gt;<i> listener(s) would look like: should one listener subscribe to both
</I>&gt;<i> queues? If so, it will have to know when to ignore the low priority
</I>&gt;<i> callback (because the high priority queue is not empty)
</I>
The details of how you achieve this depend on which client library you
are using, and how your application is organized.  So with more
information someone might be able to give more specific advice.  But
here is the general idea.

As you suggest, your listener should consume from both queues.  You
should consume with no-ack=False (i.e. explicit acks).

In your code, you'll need a data structure to hold pending high-priority
messages (those that have arrived, but not yet been processed), and
another to hold pending low-prority messages.  The basic logic is then
as follows:

When a message arrives (from either queue):
  If a message is already being processed:
    Add the new message to the approprite pending messages data structure
  Else:
    Start processing the message

When processing of a message completes:
  Ack the processed message
  If there are any pending high-priority messages
    Remove one and start processing it
  Else, if there are any pending low-priority messages
    Remove one and start processing it
  Else:
    Nothing to do, so wait until another message arrives

So we obey the priorities because we always look for the high-priority
messages before looking in the low-priority slot.  If there are always
high-priority messages coming in, then we never look at the low-priority
messages, though we may have many of them sitting there un-acked.

How you would code this up depends upon the client library, and whether you
are in a multi-threaded or event-driven environment.

Things are a bit more complicated if you want to have multiple workers,
all obeying the priorities.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010823.html">[rabbitmq-discuss] Reordering messages
</A></li>
	<LI>Next message: <A HREF="010827.html">[rabbitmq-discuss] Cleaning up unhandled messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10824">[ date ]</a>
              <a href="thread.html#10824">[ thread ]</a>
              <a href="subject.html#10824">[ subject ]</a>
              <a href="author.html#10824">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
