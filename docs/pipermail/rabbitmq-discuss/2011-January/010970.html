<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] exceptions on fast opening a number of connections / exception on TCP connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20exceptions%20on%20fast%20opening%20a%20number%20of%0A%20connections%20/%20exception%20on%20TCP%20connection&In-Reply-To=%3C4D4459FF.4090404%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010967.html">
   <LINK REL="Next"  HREF="010971.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] exceptions on fast opening a number of connections / exception on TCP connection</H1>
    <B>Marcin Krol</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20exceptions%20on%20fast%20opening%20a%20number%20of%0A%20connections%20/%20exception%20on%20TCP%20connection&In-Reply-To=%3C4D4459FF.4090404%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] exceptions on fast opening a number of connections / exception on TCP connection">mrkafk at gmail.com
       </A><BR>
    <I>Sat Jan 29 18:18:39 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010967.html">[rabbitmq-discuss] Ordering of redelivered messages?
</A></li>
        <LI>Next message: <A HREF="010971.html">[rabbitmq-discuss] pika exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10970">[ date ]</a>
              <a href="thread.html#10970">[ thread ]</a>
              <a href="subject.html#10970">[ subject ]</a>
              <a href="author.html#10970">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


I wrote a &quot;stress test&quot; function that (relatively) quickly does the
following: it creates a number of threads that open a new connection to
Rabbit, do RPC call over Rabbit, close the connection, sleep some
milliseconds and iterate again.

I'm getting following exceptions in Rabbit log:

=ERROR REPORT==== 29-Jan-2011::18:06:04 ===
exception on TCP connection &lt;0.22244.4&gt; from 10.0.0.234:54501
{inet_error,enomem}

=WARNING REPORT==== 29-Jan-2011::18:06:07 ===
exception on TCP connection &lt;0.22240.4&gt; from 10.0.0.234:54500
connection_closed_abruptly


pika throws following exception:

Exception in thread Thread-6:
Traceback (most recent call last):
  File &quot;/usr/lib/python2.5/threading.py&quot;, line 486, in __bootstrap_inner
    self.run()
  File &quot;./rc_mt2.py&quot;, line 167, in run
    self.testfun(*self.args, **self.kwargs)
  File &quot;./rc_mt2.py&quot;, line 176, in rpc_testcall
    rc = RPCClient(node, servnum, rdonly)
  File &quot;./rc_mt2.py&quot;, line 66, in __init__
    self.setup_conn(self.node)
  File &quot;./rc_mt2.py&quot;, line 82, in setup_conn
    self.chan = self.conn.channel()
  File &quot;/usr/local/bin/src/pika/pika/connection.py&quot;, line 385, in channel
    return channel.Channel(channel.ChannelHandler(self))
  File &quot;/usr/local/bin/src/pika/pika/channel.py&quot;, line 205, in __init__
    self.handler._rpc(spec.Channel.Open(), [spec.Channel.OpenOk])
  File &quot;/usr/local/bin/src/pika/pika/channel.py&quot;, line 187, in _rpc
    return self.connection._rpc(self.channel_number, method,
acceptable_replies)
  File &quot;/usr/local/bin/src/pika/pika/connection.py&quot;, line 324, in _rpc
    channel = self._ensure_channel(channel_number)
  File &quot;/usr/local/bin/src/pika/pika/connection.py&quot;, line 287, in
_ensure_channel
    raise ConnectionClosed(self.connection_close)
ConnectionClosed: Connection.Close(class_id = 0, method_id = 0,
reply_code = 0, reply_text = 'Socket closed')


If I add some time.sleep between the calls, the problem disappears (see
class TestThread and function stress_test in code below), but that's
kind of not the point, right?


Code:

<A HREF="http://pastie.org/pastes/1509383/text">http://pastie.org/pastes/1509383/text</A>




- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - <A HREF="http://enigmail.mozdev.org/">http://enigmail.mozdev.org/</A>

iQEcBAEBAgAGBQJNRFn+AAoJEFMgHzhQQ7hOQ3AH/0ydNs1RRTsCAi4Cx9stPDuA
r3OMWnW1/scq6WcqpswIZTCe7a/2pAu/UbDkPgZxRPb0/pclqxAOwGud/Uij6ivq
63B8kuAZKVsXqHnel2ED/yGXRkm65ot0/wASRZR+38abUhMC88tvLP4XinqF9hnt
umCxMiF4tPUDspj7d1MF0Bwk9RjqT0rnmPHfNsrO10P4Ob8Ithm53rknfn3tHYNu
c8WeuzMVS+wth4SMQilqqyzVESy8Gpr8k9Ghn1GuEAhQrFzDE4+q960jbbhaKuH+
1KY4XKYMR1jDn+8C1BPm1eSbANGetpZb5gCcxHMRhtIJjOhEXX628dFArtinlls=
=uc7b
-----END PGP SIGNATURE-----
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010967.html">[rabbitmq-discuss] Ordering of redelivered messages?
</A></li>
	<LI>Next message: <A HREF="010971.html">[rabbitmq-discuss] pika exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10970">[ date ]</a>
              <a href="thread.html#10970">[ thread ]</a>
              <a href="subject.html#10970">[ subject ]</a>
              <a href="author.html#10970">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
