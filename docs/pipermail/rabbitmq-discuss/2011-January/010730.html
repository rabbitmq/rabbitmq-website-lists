<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Erlang crashes trying to allocate 583848200 bytes of memory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20trying%20to%20allocate%20583848200%0A%20bytes%20of%20memory&In-Reply-To=%3CAANLkTikN8jS%3DTM7jct5hQZQADTLWzTxg7Y_4LnmdggZC%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010720.html">
   <LINK REL="Next"  HREF="010748.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Erlang crashes trying to allocate 583848200 bytes of memory</H1>
    <B>Marek Majkowski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20trying%20to%20allocate%20583848200%0A%20bytes%20of%20memory&In-Reply-To=%3CAANLkTikN8jS%3DTM7jct5hQZQADTLWzTxg7Y_4LnmdggZC%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Erlang crashes trying to allocate 583848200 bytes of memory">majek04 at gmail.com
       </A><BR>
    <I>Tue Jan 18 11:40:38 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010720.html">[rabbitmq-discuss] Erlang crashes trying to allocate	583848200	bytes of memory
</A></li>
        <LI>Next message: <A HREF="010748.html">[rabbitmq-discuss] Erlang crashes trying to allocate 583848200 bytes of memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10730">[ date ]</a>
              <a href="thread.html#10730">[ thread ]</a>
              <a href="subject.html#10730">[ subject ]</a>
              <a href="author.html#10730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Jan 17, 2011 at 10:20, Mark Hudson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">markrogerhudson at gmail.com</A>&gt; wrote:
&gt;<i> Hi, I'm experiencing&#160;reproducible&#160;crashes of&#160;Erlang&#160;when running
</I>&gt;<i> RabbitMQ 2.20 on a clean install of 64 bit Windows server 2008 R2 box
</I>&gt;<i>
</I>&gt;<i> In particular I get
</I>&gt;<i> &quot;broker running
</I>&gt;<i> Crash dump was written to: erl_crash.dump
</I>&gt;<i> eheap_alloc: Cannot allocate 583848200 bytes of memory (of type &quot;old_heap&quot;).
</I>&gt;<i> This application has requested the Runtime to terminate it in an unusual way.
</I>&gt;<i> Please contact the application's support team for more information.&quot;
</I>&gt;<i> &quot;Cannot allocate 583848200 bytes of memory (of type &quot;old_heap&quot;).&quot; is
</I>&gt;<i> the same message talked about in the previous discussion.
</I>&gt;<i> I find that rabbitmqctl.bat takes a while to
</I>&gt;<i> return there are no queues, then the erl.exe process grows to about
</I>&gt;<i> 650 meg before erland crashes dumping out
</I>
The problem is that although you're using 64 bit windows,
there is no 64 bit Erlang for windows.
Erlang in windows runs as 32-bit program.

Looking here:
<A HREF="http://msdn.microsoft.com/en-us/library/aa366778(v=VS.85">http://msdn.microsoft.com/en-us/library/aa366778(v=VS.85</A>).aspx
it looks like by default, without IMAGE_FILE_LARGE_ADDRESS_AWARE flag set,
32 bit processes can use only 2 GB of RAM.

Additionally, Erlang garbage collector works like that:
 - allocate a large chunk of continuous memory
 - rewrite data (skipping unused garbage)
 - free old memory

As a result, to run Erlang you need to always stay
below 50% available memory (to have other 50% available
for garbage collector).

As your process is using 650megs, and the virtual memory is limited
to 2GB, we're getting close to the boundary. Add some bad luck
with memory fragmentation, and erlang can easily fail to allocate
big chunk of continuous memory.

That's what happens to you.

Possible solutions:
 - upgrade to erlang &gt;= R13B3
   <A HREF="http://www.lshift.net/blog/2009/12/01/garbage-collection-in-erlang">http://www.lshift.net/blog/2009/12/01/garbage-collection-in-erlang</A>
 - use multiple (smaller) queues (erlang GC should be isolated to
   memory used by one erlang process)
 - Configure 'vm_memory_high_watermark' value (as Jerry suggested).
   The smaller the value, the sooner Rabbit will stop accepting
   new messages and growing memory.
 - Switch to 64-bit operating system supported by Erlang.
 - Play with IMAGE_FILE_LARGE_ADDRESS_AWARE flag.

We're looking forward to see a proper 64-bit erlang release for windows,
but that's Ericsson's job.

Cheers,
   Marek
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010720.html">[rabbitmq-discuss] Erlang crashes trying to allocate	583848200	bytes of memory
</A></li>
	<LI>Next message: <A HREF="010748.html">[rabbitmq-discuss] Erlang crashes trying to allocate 583848200 bytes of memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10730">[ date ]</a>
              <a href="thread.html#10730">[ thread ]</a>
              <a href="subject.html#10730">[ subject ]</a>
              <a href="author.html#10730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
