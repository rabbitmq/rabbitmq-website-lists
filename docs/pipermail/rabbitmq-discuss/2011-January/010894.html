<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Low message publish throughput
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Low%20message%20publish%20throughput&In-Reply-To=%3CAANLkTimvjJAKf4xKGtCYKRHrkLjKm%2BrCWFzADnOs%3DGhf%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010890.html">
   <LINK REL="Next"  HREF="010904.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Low message publish throughput</H1>
    <B>Cameron Harris</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Low%20message%20publish%20throughput&In-Reply-To=%3CAANLkTimvjJAKf4xKGtCYKRHrkLjKm%2BrCWFzADnOs%3DGhf%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Low message publish throughput">cameron at cameronharris.org
       </A><BR>
    <I>Tue Jan 25 14:42:53 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010890.html">[rabbitmq-discuss] Slow consumer disconnect availability on RAbbitMQ
</A></li>
        <LI>Next message: <A HREF="010904.html">[rabbitmq-discuss] Low message publish throughput
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10894">[ date ]</a>
              <a href="thread.html#10894">[ thread ]</a>
              <a href="subject.html#10894">[ subject ]</a>
              <a href="author.html#10894">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I'm having problems achieving a high publish throughput with RabbitMQ 2.2.

I am using the .NET client on two Win7/64 desktops with Core 2 duos, and the
broker is running on RHEL5.6 (OTP R14B01) on a quad core Xeon blade, and the
link between the blade and the desktops is 1Gb/s ethernet.

I created a minimal publisher and consumer in .NET and ran one on each
machine. The consumer was able to receive more than 50 000 empty messages
per second, however the publisher was only able to publish 5000 empty
messages per second before maxing out my desktop's CPU. I ported the
publisher to Java, and that went up to 10 000 per second, which is better
but still not great. The network utilization is almost insignificant and the
broker's CPU usage was around 10% on one core. The bottleneck appears to be
CPU usage inside the RabbitMQ .NET library. I achieve at least 45MB/s
throughput in a single plain TCP connection from Win7 to the blade, so the
link is definitely not the problem.

I attached a profiler to my publisher and I found that more than 90% of the
CPU time was spent calling Flush in WriteFrame (called by BasicPublish). I
created an alternate non-flushing code path in the RabbitMQ for
BasicPublish, and the publishing speed went up to between 35 000 and 45 000
messages per second, and the messages still got to the client quickly.

Am I doing something incorrect? I presume the client flushes as soon as
possible to reduce latency, but in this case, I don't mind giving up some
latency to get better throughput, such as by only explicitly flushing once
every 50ms or something along these lines. Is there a way to support my
requirements with the RabbitMQ .NET library?

Thanks!
Cameron Harris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/b709fbc3/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/b709fbc3/attachment.htm</A>&gt;
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010890.html">[rabbitmq-discuss] Slow consumer disconnect availability on RAbbitMQ
</A></li>
	<LI>Next message: <A HREF="010904.html">[rabbitmq-discuss] Low message publish throughput
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10894">[ date ]</a>
              <a href="thread.html#10894">[ thread ]</a>
              <a href="subject.html#10894">[ subject ]</a>
              <a href="author.html#10894">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
