<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET API: How it works?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Responsibility%20Transfer%20using%20RabbitMQ%20.NET%0A%20API%3A%20How%20it%20works%3F&In-Reply-To=%3CAANLkTimuWUTRGv8azj2NqLnuuaZZhh1JRA9N039ivzjG%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010930.html">
   <LINK REL="Next"  HREF="010953.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET API: How it works?</H1>
    <B>Alfonso Pantoja</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Responsibility%20Transfer%20using%20RabbitMQ%20.NET%0A%20API%3A%20How%20it%20works%3F&In-Reply-To=%3CAANLkTimuWUTRGv8azj2NqLnuuaZZhh1JRA9N039ivzjG%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET API: How it works?">alfonso.pantoja at gmail.com
       </A><BR>
    <I>Thu Jan 27 23:40:35 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010930.html">[rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET API: How it works?
</A></li>
        <LI>Next message: <A HREF="010953.html">[rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET API: How it works?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10952">[ date ]</a>
              <a href="thread.html#10952">[ thread ]</a>
              <a href="subject.html#10952">[ subject ]</a>
              <a href="author.html#10952">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,


Firstly, thank you very much for your answer. You've really helped me.
As you suggested we'll update RabbitMQ to version 2.2.0 as soon as possible.
It is great you are introducing publisher confirms in next release because
it will offer more fine control to message publishing.


Regarding transfer responsibility I have one more doubt.
As you said, &quot;TxCommit will succeed if messages are lost during routing (due
to non-existing queues)&quot;,
so does it mean that TxCommit launches an exception when it fails?

In this case in my code I should handle unexpected exceptions (txSelect,
basic.publish, txCommit) and also basic.return in cause immediate and/or
mandatory message can't be delivered, right?



Regards,

Alfonso




2011/1/27 Alexandru Scvor&#355;ov &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexandru at rabbitmq.com</A>&gt;

&gt;<i> Hi Alfonso,
</I>&gt;<i>
</I>&gt;<i> &gt; I've been googling a lot and some people suggested using this schema:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ch.TxSelect()
</I>&gt;<i> &gt; ch.BasicPublish(.....)
</I>&gt;<i> &gt; ch.TxCommit()
</I>&gt;<i> ...
</I>&gt;<i> &gt; Reading the API user guide I've found that this is called &quot;transfer
</I>&gt;<i> &gt; responsibility&quot;.
</I>&gt;<i>
</I>&gt;<i> That's correct.  The only way right now to transfer responsibility for
</I>&gt;<i> a message to the broker is using transactions.
</I>&gt;<i>
</I>&gt;<i> That said, I don't think it's exactly what you want.  The TxCommit will
</I>&gt;<i> succeed if messages are lost during routing (due to non-existing
</I>&gt;<i> queues).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; My question is:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Being TxCommit a void function I tested this block of code using a
</I>&gt;<i> &gt; non-existing routing key and I didn't get any exception.
</I>&gt;<i> &gt; Since safe publishing would be highly desiderable non routed messages
</I>&gt;<i> should
</I>&gt;<i> &gt; be detected because the application ACKs the messages of &quot;events queue&quot;
</I>&gt;<i> &gt; when after evaluating its content has successfully sent another message
</I>&gt;<i> to
</I>&gt;<i> &gt; the &quot;results queue&quot; (currently if a a routing key is not being routed to
</I>&gt;<i> a
</I>&gt;<i> &gt; queue the messages are silently dropped and I have no way to detect the
</I>&gt;<i> &gt; failure so the application ACKs the messages from &quot;events queue&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Please, can someone tell me how I can't get that &quot;CommitOK&quot; responses?
</I>&gt;<i>
</I>&gt;<i> As far as I know, there's no way cause the broker to throw an exception
</I>&gt;<i> for unroutable messages.
</I>&gt;<i>
</I>&gt;<i> What you could do instead is this:
</I>&gt;<i>  - as you've suggested, publish with mandatory, immediate, and
</I>&gt;<i>    persistent set;
</I>&gt;<i>  - do publishes to persistent queues;
</I>&gt;<i>  - wrap publishes in that tx code;
</I>&gt;<i>  - have the publisher watch for basic.returns and handle somehow lost
</I>&gt;<i>    messages (maybe rollback the transaction, republish to a different
</I>&gt;<i>    and commit).
</I>&gt;<i>
</I>&gt;<i> The message flags and the transactions should ensure that the broker
</I>&gt;<i> either save the messages to disk or send it to a consumer.  The
</I>&gt;<i> ReturnHandler should allow you to republish or somehow handle lost
</I>&gt;<i> messages.
</I>&gt;<i>
</I>&gt;<i> Basic.publish/basic.return aren't synchronous out of the box and aren't
</I>&gt;<i> meant to be used like that.  For unroutable messages, the broker sends
</I>&gt;<i> the basic.return immediately after processing the basic.publish, so if
</I>&gt;<i> you publish to a non-existent queue, you should expect the basic.return
</I>&gt;<i> soonish; you could use this to make publishes/returns somewhat
</I>&gt;<i> synchronous, but I wouldn't recommend it.
</I>&gt;<i>
</I>&gt;<i> BTW, the AMQP spec says you shouldn't rely on the broker's behaviour
</I>&gt;<i> when publishing mandatory/immediate messages inside transactions, but I
</I>&gt;<i> think there are any pitfalls doing this with rabbit.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> As you may have guessed by now, the scenario you described isn't handled
</I>&gt;<i> very nicely by AMQP.  We're introducing publisher confirms to remedy
</I>&gt;<i> this.  The code's on default now, and should be in the next release.
</I>&gt;<i> The basic idea is that the broker sends a basic.ack back to the
</I>&gt;<i> publisher when it's dealt with a message.  In addition, the basic.return
</I>&gt;<i> would always be sent before the basic.ack, so the publisher would know
</I>&gt;<i> when the message is no longer its responsibility.  Of course, this
</I>&gt;<i> isn't synchronous, but it is fast, and the logic is a lot simpler than
</I>&gt;<i> trying to do the same thing with transactions.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; PS: I'm using the API version 1.7.2 and RabbitMQ server is the same
</I>&gt;<i> version.
</I>&gt;<i>
</I>&gt;<i> You really should upgrade.  Since 1.7.2, we've fixed lots of bugs
</I>&gt;<i> (including a few serious ones), introduced a new persister (which is
</I>&gt;<i> quite relevant if you care about transfer of responsibility) and added some
</I>&gt;<i> very nice management and monitoring features (including a web UI).
</I>&gt;<i> Publisher confirms are on default now, and should be in the next
</I>&gt;<i> release.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hope this helps,
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;<i> On Mon, Jan 24, 2011 at 05:47:17PM +0100, Alfonso Pantoja wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've developed an application that consumes messages from a queue
</I>&gt;<i> (&quot;events
</I>&gt;<i> &gt; queue&quot;) and depending on their data
</I>&gt;<i> &gt; it publishes (per received message) a message to another queue (&quot;results
</I>&gt;<i> &gt; queue&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The logic that checks the content of the received messages is publishing
</I>&gt;<i> &gt; messages using BasicPublish (with mandatory=2, immediate=false and
</I>&gt;<i> setting
</I>&gt;<i> &gt; deliveryMode=2 to the messages to be sent)
</I>&gt;<i> &gt; My concern is that BasicPublish is asynchronous  and the only exception I
</I>&gt;<i> &gt; can get is when there is no connection to RabbitMQ or the destination
</I>&gt;<i> &gt; exchange does not exist.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Since the application logic at this point is synchronous I can't use
</I>&gt;<i> &gt; BasicReturn in order to use a handler when messages can't be delivered.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've been googling a lot and some people suggested using this schema:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ch.TxSelect()
</I>&gt;<i> &gt; ch.BasicPublish(.....)
</I>&gt;<i> &gt; ch.TxCommit()
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; and also is suggested that &quot;commit-ok&quot; will be returned if the message
</I>&gt;<i> has
</I>&gt;<i> &gt; been published safely to the broker.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Reading the API user guide I've found that this is called &quot;transfer
</I>&gt;<i> &gt; responsibility&quot;.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Copy &amp; paste follows:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; To transfer responsibility for delivery of a message to a broker
</I>&gt;<i> &gt; &#8226; ensure (ahead of time) that the target queue exists and is durable,
</I>&gt;<i> &gt; &#8226; select Tx mode using IModel.TxSelect,
</I>&gt;<i> &gt; &#8226; publish the message with the &quot;mandatory&quot; flag set and DeliveryMode set
</I>&gt;<i> &gt; equal to 2, and
</I>&gt;<i> &gt; &#8226; commit the Tx transaction using IModel.TxCommit.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Once a broker replies with CommitOk (i.e. the TxCommit() call returns to
</I>&gt;<i> the
</I>&gt;<i> &gt; caller), it has taken
</I>&gt;<i> &gt; responsibility for keeping the message on disk and on the target queue
</I>&gt;<i> until
</I>&gt;<i> &gt; some other application
</I>&gt;<i> &gt; retrieves and acknowledges the message.
</I>&gt;<i> &gt; A commit is not required after every message: batching of publications
</I>&gt;<i> may
</I>&gt;<i> &gt; be done, depending on the
</I>&gt;<i> &gt; precise delivery guarantees the publishing application requires.
</I>&gt;<i> &gt; Responsibility can also be placed with an external database, even further
</I>&gt;<i> &gt; along the chain - see the section
</I>&gt;<i> &gt; on interaction with external resources below
</I>&gt;<i> &gt; ---
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My question is:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Being TxCommit a void function I tested this block of code using a
</I>&gt;<i> &gt; non-existing routing key and I didn't get any exception.
</I>&gt;<i> &gt; Since safe publishing would be highly desiderable non routed messages
</I>&gt;<i> should
</I>&gt;<i> &gt; be detected because the application ACKs the messages of &quot;events queue&quot;
</I>&gt;<i> &gt; when after evaluating its content has successfully sent another message
</I>&gt;<i> to
</I>&gt;<i> &gt; the &quot;results queue&quot; (currently if a a routing key is not being routed to
</I>&gt;<i> a
</I>&gt;<i> &gt; queue the messages are silently dropped and I have no way to detect the
</I>&gt;<i> &gt; failure so the application ACKs the messages from &quot;events queue&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Please, can someone tell me how I can't get that &quot;CommitOK&quot; responses?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thank you in advance.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Alfonso
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; PS: I'm using the API version 1.7.2 and RabbitMQ server is the same
</I>&gt;<i> version.
</I>&gt;<i>
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110128/64fe947c/attachment-0001.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110128/64fe947c/attachment-0001.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010930.html">[rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET API: How it works?
</A></li>
	<LI>Next message: <A HREF="010953.html">[rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET API: How it works?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10952">[ date ]</a>
              <a href="thread.html#10952">[ thread ]</a>
              <a href="subject.html#10952">[ subject ]</a>
              <a href="author.html#10952">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
