<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Low message publish throughput
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Low%20message%20publish%20throughput&In-Reply-To=%3CAANLkTimQ922xyE_zprmCk4ND0X3vtcejWHnX%3DKCpE0ML%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010904.html">
   <LINK REL="Next"  HREF="010907.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Low message publish throughput</H1>
    <B>Cameron Harris</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Low%20message%20publish%20throughput&In-Reply-To=%3CAANLkTimQ922xyE_zprmCk4ND0X3vtcejWHnX%3DKCpE0ML%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Low message publish throughput">cameron at cameronharris.org
       </A><BR>
    <I>Wed Jan 26 12:27:01 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010904.html">[rabbitmq-discuss] Low message publish throughput
</A></li>
        <LI>Next message: <A HREF="010907.html">[rabbitmq-discuss] Low message publish throughput
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10906">[ date ]</a>
              <a href="thread.html#10906">[ thread ]</a>
              <a href="subject.html#10906">[ subject ]</a>
              <a href="author.html#10906">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Emile,

When I removed the flush, I added an alternate code path so that flushing
would only be disabled when called via BasicPublish, and that initiation
would still explicitly flush. I initially just commented out the flush, but
as you suggested, the connection initiation just failed due to a timeout.
Unfortunatey, the problem with just hacking out publish flushing is that
sometimes messages will just sit there forever until something forces them
out, which could clearly cause a deadlock if your systems ended up waiting
on each other. It also caused problems when closing the connection to the
broker. I'm guessing that all publish messages need to have been flushed
before the library tries to do something else (e.g. a TxCommit or other
control messages)? Plus, manually hacking up the RabbitMQ library isn't
really a path I want to go down, since it'll make upgrading it far more
difficult.

I just commented out the line where it sets socket nodelay, and it increased
publish to about 9-10k messages per second on the Win7 system, which is a
nice improvement. Is there anywhere I can configure this with the standard
client library, rather than building my own with it hacked out? The Java
client had a way of overriding the socket factory function.

I think the throughput is still being held back significantly by the
explicit flushing. It'd still be nice if we could not flush after every
publish or manually take control over when publish flushes occur while still
maintaining stability of the library/connection. Are there any plans
regarding the flushing behavior, or is Rabbit's primary focus going to be
strictly low latency over high throughput?

Thanks for your help,
Cameron Harris


On 26 January 2011 11:36, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> Hi Cameron,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 25/01/11 14:42, Cameron Harris wrote:
</I>&gt;<i>
</I>&gt;<i>  I attached a profiler to my publisher and I found that more than 90% of
</I>&gt;&gt;<i> the CPU time was spent calling Flush in WriteFrame (called by
</I>&gt;&gt;<i> BasicPublish). I created an alternate non-flushing code path in the
</I>&gt;&gt;<i> RabbitMQ for BasicPublish, and the publishing speed went up to between
</I>&gt;&gt;<i> 35 000 and 45 000 messages per second, and the messages still got to the
</I>&gt;&gt;<i> client quickly.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I would advise caution when removing the flush. Synchronous methods during
</I>&gt;<i> AMQP connection establishment can timeout and cause failure unless the
</I>&gt;<i> stream is flushed.
</I>&gt;<i>
</I>&gt;<i> I'd be interested to know whether disabling the socket nodelay option has
</I>&gt;<i> any impact on your test. This would be another way of obtaining a different
</I>&gt;<i> latency/throughput trade-off.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards
</I>&gt;<i>
</I>&gt;<i> Emile
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110126/a1d24c5d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110126/a1d24c5d/attachment.htm</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010904.html">[rabbitmq-discuss] Low message publish throughput
</A></li>
	<LI>Next message: <A HREF="010907.html">[rabbitmq-discuss] Low message publish throughput
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10906">[ date ]</a>
              <a href="thread.html#10906">[ thread ]</a>
              <a href="subject.html#10906">[ subject ]</a>
              <a href="author.html#10906">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
