<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Persister logs never getting rolled/cleaned	up?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Persister%20logs%20never%20getting%20rolled/cleaned%0A%09up%3F&In-Reply-To=%3CAANLkTi%3DqeRVnp7ix3OijmYTAcRK0gh4%3DWw-H%2BzeJju8b%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010555.html">
   <LINK REL="Next"  HREF="010556.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Persister logs never getting rolled/cleaned	up?</H1>
    <B>Marek Majkowski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Persister%20logs%20never%20getting%20rolled/cleaned%0A%09up%3F&In-Reply-To=%3CAANLkTi%3DqeRVnp7ix3OijmYTAcRK0gh4%3DWw-H%2BzeJju8b%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Persister logs never getting rolled/cleaned	up?">majek04 at gmail.com
       </A><BR>
    <I>Fri Jan  7 10:14:06 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010555.html">[rabbitmq-discuss] Persister logs never getting rolled/cleaned up?
</A></li>
        <LI>Next message: <A HREF="010556.html">[rabbitmq-discuss] Handling Undelivered messages in rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10573">[ date ]</a>
              <a href="thread.html#10573">[ thread ]</a>
              <a href="subject.html#10573">[ subject ]</a>
              <a href="author.html#10573">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Steve,

On Thu, Jan 6, 2011 at 03:43, Steve Garrity &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">sgarrity at gmail.com</A>&gt; wrote:
&gt;<i> Apologies if this is a n00b question, which I think it is, but we're
</I>&gt;<i> running a plain vanilla install of rabbitmq 2.1.1 on erlang r14B with
</I>&gt;<i> celeryd 2.1.4 and we're continually running into persister log issues
</I>&gt;<i> and Google has thus far not turned up results.
</I>&gt;<i>
</I>&gt;<i> Every few weeks rabbit just stops accepting new connections...stopping
</I>&gt;<i> and starting rabbit takes on the order of 15 minutes and it just
</I>&gt;<i> continues to choke once it gets started again. Looking at /var/lib/
</I>&gt;<i> rabbitmq/mnesia/rabbit shows ~170MB of persister logs (this is running
</I>&gt;<i> on a 1GB RAM machine, so the vm memory alarm is set at ~400MB (which
</I>&gt;<i> we routinely bounce off of trying to reload these logs). By deleting
</I>&gt;<i> (or renaming) this directory, recreating users/vhosts, and restarting
</I>&gt;<i> rabbit, everything works great again (for a few weeks).
</I>
Sounds scary. You definitely shouldn't need to go that far!

&gt;<i> This led us to believe we were using celery incorrectly and
</I>&gt;<i> accidentally persisting results for all time, but we've tried with
</I>&gt;<i> ignore_result=True, delivery_mode=transient, durable=False, and
</I>&gt;<i> result_persistent=False and nothing seems to fix it.
</I>&gt;<i>
</I>&gt;<i> These don't seem like logs that we should have to rotate
</I>&gt;<i> manually...can someone point us in the right direction?
</I>
Rabbit should do everything automatically, something is very
wrong if it doesn't.

Rabbit only stops &quot;accepting&quot; new connections when it's running
out of file descriptors - I'm sure you would have noticed that.
On the other hand Rabbit does &quot;block&quot; connections which
publish messages when it's running out-of-memory
(ie: grows above 400megs in your case).

You can easily detect such a situation by looking in the
rabbit logs, it will say something like:

=INFO REPORT==== 7-Jan-2011::10:11:16 ===
vm_memory_high_watermark set. Memory used:XXX allowed:XXX


I'd guess, that in your case the rabbit is probably just overloaded.
400 megs of RAM for Rabbit is plenty if you're not doing
anything complex. But once you have a nontrivial setup
or many messages, it may not be enough.

Can you please:
 - run rabbitmqctl list_queues or management plugin
   to see how many messages Rabbit is usually
   storing in your setup, to make sure it's not overloaded
   by a high number of messages.
   (here are details about management plugin:
   <A HREF="http://www.rabbitmq.com/management.html">http://www.rabbitmq.com/management.html</A> )
 - Take closer look at the result of 'rabbitmqctl list_queues
messages_unacknowledged'.
   If this number is growing, something really bad is happening.

Cheers,
  Marek
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010555.html">[rabbitmq-discuss] Persister logs never getting rolled/cleaned up?
</A></li>
	<LI>Next message: <A HREF="010556.html">[rabbitmq-discuss] Handling Undelivered messages in rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10573">[ date ]</a>
              <a href="thread.html#10573">[ thread ]</a>
              <a href="subject.html#10573">[ subject ]</a>
              <a href="author.html#10573">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
