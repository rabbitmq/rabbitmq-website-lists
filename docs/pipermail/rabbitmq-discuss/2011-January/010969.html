<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Java client: channel shutdown notification while closing connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Java%20client%3A%20channel%20shutdown%20notification%0A%20while%20closing%20connection&In-Reply-To=%3C4D43EFD1.10202%40krutil.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010833.html">
   <LINK REL="Next"  HREF="010619.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Java client: channel shutdown notification while closing connection</H1>
    <B>Jiri Krutil</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Java%20client%3A%20channel%20shutdown%20notification%0A%20while%20closing%20connection&In-Reply-To=%3C4D43EFD1.10202%40krutil.com%3E"
       TITLE="[rabbitmq-discuss] Java client: channel shutdown notification while closing connection">jiri at krutil.com
       </A><BR>
    <I>Sat Jan 29 10:45:37 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010833.html">[rabbitmq-discuss] Java client: channel shutdown notification while closing connection
</A></li>
        <LI>Next message: <A HREF="010619.html">[rabbitmq-discuss] RabbitMQ Test case - Possible Memory Leak problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10969">[ date ]</a>
              <a href="thread.html#10969">[ thread ]</a>
              <a href="subject.html#10969">[ subject ]</a>
              <a href="author.html#10969">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthias,

&gt;<i> The shutdown listeners get called in the main connection thread. That 
</I>&gt;<i> means they should not perform any possibly blocking AMQP operations. 
</I>&gt;<i> If they do then a deadlock can ensue.
</I>...
&gt;<i> Why are you calling connection.close() at all? The connection will 
</I>&gt;<i> already have been closed. After all, you are in the connection 
</I>&gt;<i> shutdown handler code.
</I>
To achieve some kind of resiliency to short network and broker downtimes 
in our application, we have a synchronized disconnect-and-start-over 
method that is used as both connection and channel shutdown listener. If 
this fails we retry in regular periods. The goal is to make sure that 
the application will reconnect and re-register its consumers as soon as 
possible.

This is used in part due to the (in my opinion unfortunate) feature of 
AMQP that an error in an operation on a channel closes that channel.

To keep things simple, we close the connection in this method, in case 
it would be invoked by a channel shutdown. And that's where our problems 
seem to appear: when closing the connection, channels are closed and 
their shutdown listeners invoked, which in turn attempt to acquire the 
same lock, resulting in a deadlock.

We seem to have solved the problem by explicitly unregistering the 
channel shutdown listeners before closing the connection.

Cheers
Jiri
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010833.html">[rabbitmq-discuss] Java client: channel shutdown notification while closing connection
</A></li>
	<LI>Next message: <A HREF="010619.html">[rabbitmq-discuss] RabbitMQ Test case - Possible Memory Leak problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10969">[ date ]</a>
              <a href="thread.html#10969">[ thread ]</a>
              <a href="subject.html#10969">[ subject ]</a>
              <a href="author.html#10969">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
