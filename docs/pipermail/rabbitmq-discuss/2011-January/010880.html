<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Erlang crashes trying to allocate 583848200	bytes of memory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20trying%20to%20allocate%20583848200%0A%09bytes%20of%20memory&In-Reply-To=%3C0409a620-98fb-45e6-901f-a412d4dd4205%40y2g2000prf.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010869.html">
   <LINK REL="Next"  HREF="010882.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Erlang crashes trying to allocate 583848200	bytes of memory</H1>
    <B>Dom54</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20trying%20to%20allocate%20583848200%0A%09bytes%20of%20memory&In-Reply-To=%3C0409a620-98fb-45e6-901f-a412d4dd4205%40y2g2000prf.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Erlang crashes trying to allocate 583848200	bytes of memory">D.Rotondi at Computer.Org
       </A><BR>
    <I>Tue Jan 25 10:30:42 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010869.html">[rabbitmq-discuss] Erlang crashes trying to allocate	583848200	bytes of memory
</A></li>
        <LI>Next message: <A HREF="010882.html">[rabbitmq-discuss] Erlang crashes trying to allocate 583848200 bytes of memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10880">[ date ]</a>
              <a href="thread.html#10880">[ thread ]</a>
              <a href="subject.html#10880">[ subject ]</a>
              <a href="author.html#10880">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Jan 24, 9:36&#160;pm, Jerry Kuch &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jer... at vmware.com</A>&gt; wrote:
Thanks Jerry for the reply.
My answers/comments inline.
Ciao
    Dom

&gt;<i> Hi, Dom...
</I>&gt;<i>
</I>&gt;<i> &gt; we have a similar problem that can be summarised as follows. &#160;Our goal
</I>&gt;<i> &gt; is to compare RabbitMQ (the last stable version) to ActiveMQ. &#160;To this
</I>&gt;<i> &gt; end we set up two minimal and similar testing environments having both
</I>&gt;<i> &gt; 1 publisher, 1 subscriber and 1 message broker (RabbitMQ/ ActiveMQ)
</I>&gt;<i> &gt; server. &#160;In both testing environments the message broker runs under a
</I>&gt;<i> &gt; Windows Hyper-V virtual machine (hosted on a Windows Server 23008 64
</I>&gt;<i> &gt; bits) that has as OS a 32 bit Windows Server 2008 (if I'm correct we
</I>&gt;<i> &gt; allocated 2 GB, perhpas 4 GB, to the VM and 1 CPU). &#160;The
</I>&gt;<i> &gt; publishers/subscribers are run under Windows XP/Vista and are on the
</I>&gt;<i> &gt; same LAN as the broker VM.
</I>&gt;<i>
</I>&gt;<i> This ought to be an entirely reasonable set up. &#160;Apologies that you're
</I>&gt;<i> having trouble with it. &#160;There's definitely something awry here and
</I>&gt;<i> current evidence points toward it not being yiour fault.
</I>&gt;<i>
</I>&gt;<i> &gt; On the subscriber side it connects to the broker waiting for messages.
</I>&gt;<i> &gt; When a new chuck started message is received, it saves the received
</I>&gt;<i> &gt; timestamp and then counts how many messages it has received till the
</I>&gt;<i> &gt; indication of the chunk end message. At this point it reads the system
</I>&gt;<i> &gt; clock and calculates how much time has elapsed since the chunck start
</I>&gt;<i> &gt; on the publisher side (as reported in the received timestamp) and the
</I>&gt;<i> &gt; arrival on the chunk end message on the subscriber side. &#160;The
</I>&gt;<i> &gt; subscriber then logs all these data (start timestamp, end timestamp,
</I>&gt;<i> &gt; elapsed time, number of messages), and is ready to process a new
</I>&gt;<i> &gt; message chunk. &#160;Anyway further details and the Java code is available
</I>&gt;<i> &gt; in the indicated RabbitMQ newsgroup's message. &#160;In our testing
</I>&gt;<i> &gt; environment, therefore, there are no durable queues, no permanent
</I>&gt;<i> &gt; messages, a single subscriber, ...
</I>&gt;<i>
</I>&gt;<i> Our of curiosity when and how is your consumer ACK-ing the messages it
</I>&gt;<i> gets? &#160;Do you have auto-ACK set? &#160;Or are you explicitly ACK-ing them,
</I>&gt;<i> either individually or as a range?
</I>
We tried both using auto-ACK and explicit ACK on each received
message. The result was exactly the same.
BTW our VM has a 2 GB RAM. The RbbitMQ exchange type is a direct one,
and there only 1 consumer queue bound to that exchange.
You can find all our test code here (<A HREF="http://lists.rabbitmq.com/">http://lists.rabbitmq.com/</A>
pipermail/rabbitmq-discuss/2011-January/
010818.html).

&gt;<i>
</I>&gt;<i> &gt; What we experienced are crashes of the RabbitMQ server due to the
</I>&gt;<i> &gt; memory allocation issues. Indeed, the Windows Task Manager shows the
</I>&gt;<i> &gt; RabbitMQ process increasing memory, until it crashes. &#160;On the RabbitMQ
</I>&gt;<i> &gt; forum someone suggested to my colleague Cristoforo to reduce the
</I>&gt;<i> &gt; vm_memory_high_watermark value from its default 0.40 value. &#160;We tried
</I>&gt;<i> &gt; with 0.25, 0.20 and 0.10. The crash problem doesn't disappear unless
</I>&gt;<i> &gt; the subscriber runs on a fast machine (e.g. putting the subscriber on
</I>&gt;<i> &gt; the same VM as the message broker seems to have less crashing issues).
</I>&gt;<i> &gt; With ActiveMQ we don't experience similar issues at all. &#160;We are not
</I>&gt;<i> &gt; using Erlnag under a 64 bit OS (our VM, as stated, is a 32 bit Windows
</I>&gt;<i> &gt; Server 2008), and the vm_memory_high_watermark has been lowered enough
</I>&gt;<i> &gt; (we think).
</I>&gt;<i>
</I>&gt;<i> So your observations are that when you have a fast consumer, your
</I>&gt;<i> broker fares better?
</I>
Yes. To our understanding the RabbitMQ broker (and its supporting
Erlang environment) keeps to be delivered messages in memory; if the
consumer is not fast enough the Erlang memory footprint grows till the
broker crash.

&gt;<i>
</I>&gt;<i> &gt; Our conclusion is that the Windows Erlang implementation has some
</I>&gt;<i> &gt; serious issues on memory management under Windows, or that we have not
</I>&gt;<i> &gt; configured Erlang/RabbitMQ in a proper way.
</I>&gt;<i>
</I>&gt;<i> At the moment, it looks like the former is very likely true. &#160;Some on
</I>&gt;<i> the Rabbit team have had some interaction with Erlang's maintainers on
</I>&gt;<i> the issue, but we don't have a good answer for you yet.
</I>&gt;<i>
</I>&gt;<i> &gt; Sorry for the long comment, but I think it was necessary to describe a
</I>&gt;<i> &gt; testing scenario that, in my opinion, can shed some lights on the
</I>&gt;<i> &gt; flagged issue.
</I>&gt;<i>
</I>&gt;<i> No apologies necessary... &#160;your feedback is helpful, and has helped us
</I>&gt;<i> confirm that something is awry on Windows. &#160;The Rabbit user base seems
</I>&gt;<i> rather tilted toward Unix so when there are problems specific to
</I>&gt;<i> running on Windows, we don't always find out as quickly as we might
</I>&gt;<i> like...
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Jerry
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010869.html">[rabbitmq-discuss] Erlang crashes trying to allocate	583848200	bytes of memory
</A></li>
	<LI>Next message: <A HREF="010882.html">[rabbitmq-discuss] Erlang crashes trying to allocate 583848200 bytes of memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10880">[ date ]</a>
              <a href="thread.html#10880">[ thread ]</a>
              <a href="subject.html#10880">[ subject ]</a>
              <a href="author.html#10880">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
