<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Disc node clustering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Disc%20node%20clustering&In-Reply-To=%3C4F22929F.2050801%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017768.html">
   <LINK REL="Next"  HREF="017718.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Disc node clustering</H1>
    <B>Artsiom Gulin</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Disc%20node%20clustering&In-Reply-To=%3C4F22929F.2050801%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Disc node clustering">u2.storm at gmail.com
       </A><BR>
    <I>Fri Jan 27 12:03:43 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017768.html">[rabbitmq-discuss] Stuck log rotation in linux?
</A></li>
        <LI>Next message: <A HREF="017718.html">[rabbitmq-discuss] Disc node clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17714">[ date ]</a>
              <a href="thread.html#17714">[ thread ]</a>
              <a href="subject.html#17714">[ subject ]</a>
              <a href="author.html#17714">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello.

I have some unpleasant issues while clustering disc nodes.
Two brokers located on two hosts.
Steps to reproduce:

1. Cluster *second* machine *with first* as disc node. 
(RABBITMQ_NODENAME=wosnfs).
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t3</A> ~]#  rabbitmqctl stop_app &amp;&amp; rabbitmqctl reset &amp;&amp; 
rabbitmqctl cluster wosnfs@`hostname -s` <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A> &amp;&amp; 
rabbitmqctl start_app

2. Remove first node
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t2</A>]# rabbitmqctl stop_app &amp;&amp; rabbitmqctl cluster 
wosnfs@`hostname -s` &amp;&amp; rabbitmqctl reset &amp;&amp; rabbitmqctl start_app

3. Restart rabbitmq-server service on second node.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t3</A> ~]# service rabbitmq-server restart
Restarting rabbitmq-server: FAILED - check 
/var/log/rabbitmq/startup_{log, _err}
rabbitmq-server.

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t3</A> ~]# cat /var/log/rabbitmq/startup_err
Erlang has closed

Crash dump was written to: erl_crash.dump
Kernel pid terminated (application_controller) 
({application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}})
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t3</A> ~]# cat /var/log/rabbitmq/startup_log
Activating RabbitMQ plugins ...
0 plugins activated:

/&lt;-CUT-&gt;/
erlang version : 5.8.4

-- rabbit boot start
starting file handle cache server                                     
...done
starting worker pool                                                  
...done
starting database                                                     
...BOOT ERROR: FAILED
Reason: {error,
             {unable_to_join_cluster,
                 [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,wosnfs at epbyminw2482t2</A>],
                 {merge_schema_failed,
                     &quot;Bad cookie in table definition 
mirrored_sup_childspec: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A> = 
{cstruct,mirrored_sup_childspec,ordered_set,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A>],[],[],0,read_write,false,[],[],false,mirrored_sup_childspec,[key,mirroring_pid,childspec],[],[],{{1327,663993,999525},*<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A>*},{{3,1},{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A>,{1327,664433,471064}}}}, 
*<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A>* = 
{cstruct,mirrored_sup_childspec,ordered_set,[*<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A>*],[],[],0,read_write,false,[],[],false,mirrored_sup_childspec,[key,mirroring_pid,childspec],[],[],{{1327,664434,761441},*<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A>*},{{2,0},[]}}\n&quot;}}}
Stacktrace: [{rabbit_mnesia,init_db,3},
              {rabbit_mnesia,init,0},
              {rabbit,'-run_boot_step/1-lc$^1/1-1-',1},
              {rabbit,run_boot_step,1},
              {rabbit,'-start/2-lc$^0/1-0-',1},
              {rabbit,start,2},
              {application_master,start_it_old,4}]
{&quot;Kernel pid 
terminated&quot;,application_controller,&quot;{application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}}&quot;}

All commands finished successfully except the last.
Could you help me to find out what kind of error appeared and why?
It seems that first node (epbyminw2482t2) has already been removed from 
the cluster, why some information about the one left in mnesia on 
another node and appears in error log? I suppose that that correct 
removing of any node from cluster should not influence on others.
Problem is reproducible with arbitrary number of disc nodes.

It is interesting, that if we change an order joining to cluster - join 
first node to second,  then no error will appear.

Environment:
CentOS 6.0
Erlang R1403
RabbitMQ 2.7.1

--
Best regards,
Artsiom

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120127/08026af7/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120127/08026af7/attachment.htm</A>&gt;
</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017768.html">[rabbitmq-discuss] Stuck log rotation in linux?
</A></li>
	<LI>Next message: <A HREF="017718.html">[rabbitmq-discuss] Disc node clustering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17714">[ date ]</a>
              <a href="thread.html#17714">[ thread ]</a>
              <a href="subject.html#17714">[ subject ]</a>
              <a href="author.html#17714">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
