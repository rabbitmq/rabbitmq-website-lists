<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20server%20performance%20issue%20%28erl.exe%29&In-Reply-To=%3C4F228F15.2080405%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017709.html">
   <LINK REL="Next"  HREF="017717.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20server%20performance%20issue%20%28erl.exe%29&In-Reply-To=%3C4F228F15.2080405%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)">simon at rabbitmq.com
       </A><BR>
    <I>Fri Jan 27 11:48:37 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017709.html">[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)
</A></li>
        <LI>Next message: <A HREF="017717.html">[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17712">[ date ]</a>
              <a href="thread.html#17712">[ thread ]</a>
              <a href="subject.html#17712">[ subject ]</a>
              <a href="author.html#17712">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I can't run code that is incomplete :-) but some things stand out:

You are declaring and binding queues on every delivery, and then 
deleting them shortly after as well. On a system where a lot's going on 
in parallel this might lead to lots of retried transactions, which could 
lead to high CPU use. It's not clear when call() gets called but if that 
is in a tight loop then you could be declaring and immediately deleting 
queues constantly.

You said in your original message that there would only ever be 100 
queues - if that is the case then can they just be created once? Or use 
  queue leases (<A HREF="http://www.rabbitmq.com/extensions.html#queue-leases">http://www.rabbitmq.com/extensions.html#queue-leases</A>) to 
make sure they get tidied up after some period of inactivity?

You might want to connect your application through the Tracer 
(<A HREF="http://www.rabbitmq.com/api-guide.html#tracer">http://www.rabbitmq.com/api-guide.html#tracer</A>) to see what is happening 
at the protocol level.

Cheers, Simon

On 27/01/12 08:52, Yogesh Ketkar wrote:
&gt;<i> Hello Simon,
</I>&gt;<i> This is how code looks like
</I>&gt;<i> main(String[] argv) {
</I>&gt;<i>      // Read messages from MainQueue
</I>&gt;<i>      Channel ch = c.createChannel();
</I>&gt;<i>      ch.basicConsume(&quot;MainQueue&quot;, false, &quot;&quot;, new
</I>&gt;<i> MainQueueConsumer(ch));
</I>&gt;<i>
</I>&gt;<i>      // Read messages from dynamically declared queues
</I>&gt;<i>      ExecutorService es = Executors.newFixedThreadPool(tpSize);
</I>&gt;<i>      Collection&lt;QueueProcessor&gt;  vAppProcessorCollection = new
</I>&gt;<i> ArrayList&lt;QueueProcessor&gt;();
</I>&gt;<i>      while(true) {
</I>&gt;<i>          // Get the queues currently present using
</I>&gt;<i>          // <A HREF="http://&lt;rabbitmq-server">http://&lt;rabbitmq-server</A>&gt;:55672/api/queues/%2f/
</I>&gt;<i>          List&lt;String&gt;  qs = AMQPUtil.getvAppQueues();
</I>&gt;<i>          vAppProcessorCollection.clear();
</I>&gt;<i>          for(String q : qs) {
</I>&gt;<i>              QueueProcessor p = new QueueProcessor(c, q);
</I>&gt;<i>              vAppProcessorCollection.add(p);
</I>&gt;<i>          }
</I>&gt;<i>          es.invokeAll(vAppProcessorCollection);
</I>&gt;<i>      }
</I>&gt;<i> }
</I>&gt;<i> MainQueueConsumer, in handleDelivery does something like
</I>&gt;<i> public void handleDelivery() {
</I>&gt;<i>      // Get Queue name from payload
</I>&gt;<i>      c.queueDeclare(queueName, true, false, false,
</I>&gt;<i> getQueueProperties());
</I>&gt;<i>      c.queueBind(queueName, exchange, routingKey);
</I>&gt;<i>      c.basicPublish(exchange, routingKey, props, body);
</I>&gt;<i>      ch.basicAck(envelope.getDeliveryTag(), false);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> And QueueProcessor does this in call() method
</I>&gt;<i> public Boolean call() {
</I>&gt;<i>      try {
</I>&gt;<i>          Channel ch = c.createChannel();
</I>&gt;<i>          while(true) {
</I>&gt;<i>              GetResponse r = ch.basicGet(queue, false);
</I>&gt;<i>              if(r != null) {
</I>&gt;<i>                  // process message
</I>&gt;<i>                  ch.basicAck(r.getEnvelope().getDeliveryTag(), false);
</I>&gt;<i>              } else break;
</I>&gt;<i>          }
</I>&gt;<i>          Util.queueDelete(ch, queue, true, true);
</I>&gt;<i>          if(ch.isOpen()) ch.close();
</I>&gt;<i>      } catch(Throwable th) {
</I>&gt;<i>          BaseUtil.logException(logger, th);
</I>&gt;<i>      }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> Just couple of things
</I>&gt;<i> - If I don't delete the queue in call() method, things are much better
</I>&gt;<i>    and I am even able to 50000 messages on MainQueue without much
</I>&gt;<i> issues
</I>&gt;<i> - Ideally I would like to get rid of while(true) { ... basicGet ... }.
</I>&gt;<i>    Is there any pattern where I can do
</I>&gt;<i>    basicConsume() on the dynamically generated queue and
</I>&gt;<i>    remove the consumer and the queue when number of message on it are 0
</I>&gt;<i>
</I>&gt;<i> regards, Yogesh
</I>&gt;<i>
</I>&gt;<i> On Jan 25, 7:23 pm, Simon MacMullen&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">si... at rabbitmq.com</A>&gt;  wrote:
</I>&gt;&gt;<i> On 25/01/12 08:30, Yogesh Ketkar wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Any clues how to debug this?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That sounds odd. 10k messages should be nothing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can you share your code somehow so I can try to replicate this?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Simon MacMullen
</I>&gt;&gt;<i> RabbitMQ, VMware
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017709.html">[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)
</A></li>
	<LI>Next message: <A HREF="017717.html">[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17712">[ date ]</a>
              <a href="thread.html#17712">[ thread ]</a>
              <a href="subject.html#17712">[ subject ]</a>
              <a href="author.html#17712">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
