<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Queue Lease (x-expires)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20Lease%20%28x-expires%29&In-Reply-To=%3CDE73113C-23E2-407C-95C7-59D30DC861C1%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017563.html">
   <LINK REL="Next"  HREF="017392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Queue Lease (x-expires)</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20Lease%20%28x-expires%29&In-Reply-To=%3CDE73113C-23E2-407C-95C7-59D30DC861C1%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Queue Lease (x-expires)">steve at rabbitmq.com
       </A><BR>
    <I>Mon Jan 23 17:27:26 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017563.html">[rabbitmq-discuss] Queue Lease (x-expires)
</A></li>
        <LI>Next message: <A HREF="017392.html">[rabbitmq-discuss] rabbitmq-c for a reliable rabbitmq client in	production environment.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17577">[ date ]</a>
              <a href="thread.html#17577">[ thread ]</a>
              <a href="subject.html#17577">[ subject ]</a>
              <a href="author.html#17577">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yogesh,

I don't believe there is a possibility of deadlock in this situation. It is
possible that the second client will declare the queue and that it is then
deleted (by the first client) before it can start using it, but no deadlock will
occur.

However, there is a window between Declaring a queue and it being 'in use'
(which means there is a Consumer subscribed), so that publishers that declare
before use, and consumers that declare before use, might have the queue removed
from them just when they don't want it removed.

The Consume will fail if the queue disappears, so some retry logic is all that
is needed on the Consumer client app.

Publishing to a non-existent queue is quite OK -- no failure there, so some
options on the publish would need to be employed to ensure that the message
reaches its destination.

I'm not sure what a fail-safe solution to the declare-publish window is, so I'll
ask my colleagues.

Hope this is useful,
Steve Powell  (a loppy bunny)
----------some more definitions from the SPD----------
vermin (v.) Treating the dachshund for roundworm.
chinchilla (n.) Cooling device for the lower jaw.
socialcast (n.) Someone to whom everyone is speaking but nobody likes.

On 23 Jan 2012, at 14:33, Yogesh Ketkar wrote:

&gt;<i> Thanks Steve.
</I>&gt;<i> 
</I>&gt;<i> I am planning to write a Java Client which will get list of queues
</I>&gt;<i> using something like
</I>&gt;<i> Process proc = Runtime.getRuntime().exec(&quot;rabbitmqadmin.py list queues
</I>&gt;<i> name -f bash&quot;) and then iterate over each queue name
</I>&gt;<i> and call
</I>&gt;<i> channel1.queueDelete(queueName, true, true)
</I>&gt;<i> 
</I>&gt;<i> Just one question.
</I>&gt;<i> Assume that this client is trying to delete the queue on one channel
</I>&gt;<i> and and some other client is trying to do
</I>&gt;<i> channel2.queueDeclare as it wants to publish a message on the same
</I>&gt;<i> queue.
</I>&gt;<i> Is there a chance of deadlock due to timing of these 2 calls, on two
</I>&gt;<i> different channels, channel1.queueDelete and channel2.queueDeclare?
</I>&gt;<i> 
</I>&gt;<i> regards, Yogesh
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Jan 23, 5:23 pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
</I>&gt;&gt;<i> Yogesh,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> rabbitmqadmin can delete the queue but without the checks that it might not be
</I>&gt;&gt;<i> empty and might be being used.  If you can be sure that the queue is dead, then
</I>&gt;&gt;<i> a rabbitmqadmin check followed by a delete would be quite adequate.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> However, if it is possible that the queue might not be dead (just usage being
</I>&gt;&gt;<i> slow) or it might be reused, then it is imperative that the delete be
</I>&gt;&gt;<i> conditional.  The java client interface (or some other client interface) should
</I>&gt;&gt;<i> be used to make the delete conditional.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> We notice here that the rabbitmqadmin interface doesn't allow you to
</I>&gt;&gt;<i> conditionally delete. We have raised a bug to do this -- but in the meantime, I
</I>&gt;&gt;<i> would code a script that issues the rabbitmqadmin calls to determine which
</I>&gt;&gt;<i> queues to conditionally delete, and then invoke simple stand-alone client app to
</I>&gt;&gt;<i> do the conditional deletes.   It's a bit klunky, but reasonably safe.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Hope this helps.
</I>&gt;&gt;<i> Steve Powell  (a happy bunny)
</I>&gt;&gt;<i> ----------some more definitions from the SPD----------
</I>&gt;&gt;<i> vermin (v.) Treating the dachshund for roundworm.
</I>&gt;&gt;<i> chinchilla (n.) Cooling device for the lower jaw.
</I>&gt;&gt;<i> socialcast (n.) Someone to whom everyone is speaking but nobody likes.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 22 Jan 2012, at 07:40, Yogesh Ketkar wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Thanks Steve and Simon.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I checked that rabbitmqadmin.py uses http calls (RESTful APIs)
</I>&gt;&gt;&gt;<i> provided by RabbitMQ to perform the operations.
</I>&gt;&gt;&gt;<i> Can you provide me a sample
</I>&gt;&gt;&gt;<i> - (either using rabbitmqadmin or using RESTful client) to delete a
</I>&gt;&gt;&gt;<i> queue say &quot;Yogesh&quot; with isEmpty and isUnused flags set to True?
</I>&gt;&gt;&gt;<i>  I could delete the queue using DELETE http request on
</I>&gt;&gt;&gt;<i> <A HREF="http://localhost:55672/api/queues/%2f/Yogesh">http://localhost:55672/api/queues/%2f/Yogesh</A>
</I>&gt;&gt;&gt;<i>  But couldn't figure out a way to specify isEmpty and isUnused flags.
</I>&gt;&gt;&gt;<i> - I was able to do this in a Java client using interface
</I>&gt;&gt;&gt;<i> com.rabbitmq.client.Channel { queueDelete(&quot;Yogesh&quot;, true, true) }.
</I>&gt;&gt;&gt;<i>  But then, how do I get list of queues using com.rabbitmq.client?
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> regards, Yogesh
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On Jan 20, 7:25 pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> Just a thought,
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> If you go the way Simon says and have something from outside poking the mgmt API
</I>&gt;&gt;&gt;&gt;<i> every few minutes, make sure you issue queueDelete with the if-empty bit set.
</I>&gt;&gt;&gt;&gt;<i> There is a window between the poking and the deleting in which messages may
</I>&gt;&gt;&gt;&gt;<i> arrive on the queue (i.e. it's not idle anymore), and it may even not be in-use
</I>&gt;&gt;&gt;&gt;<i> (have consumers) by the time you get to it.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Steve Powell
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;<i> [wrk:+44-2380-111-528begin_of_the_skype_highlighting            +44-2380-111-528      begin_of_the_skype_highlighting            +44-2380-111-528      ] [mob:+44-7815-838-558begin_of_the_skype_highlighting            +44-7815-838-558      begin_of_the_skype_highlighting            +44-7815-838-558      ]
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> On 20 Jan 2012, at 12:47, Simon MacMullen wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> On 16/01/12 15:56, Yogesh Ketkar wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I would like to delete the queue with no messages in it and so asked
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> the question.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> I see.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Can you suggest an alternative to achieve
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 1. Delete the queue when last event processed from the queue has
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> &lt;Action&gt;Delete&lt;/Action&gt;  as this implies that
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>    no more events with same&lt;AppId&gt;  would ever get created.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Well, you could have your client do that.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2. Delete the queue when it is IDLE for certain period, meaning it is
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> empty and no more event was added to it for certain time period.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Hmm. Well there's nothing built in to do this, but you could have something from outside poking the mgmt API every few minutes - look at the output of (e.g.)
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> rabbitmqadmin list queues name messages consumers idle_since
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> --
</I>&gt;&gt;&gt;&gt;&gt;<i> Simon MacMullen
</I>&gt;&gt;&gt;&gt;&gt;<i> RabbitMQ, VMware
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discussTh
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120123/d4f7893d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120123/d4f7893d/attachment.htm</A>&gt;
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017563.html">[rabbitmq-discuss] Queue Lease (x-expires)
</A></li>
	<LI>Next message: <A HREF="017392.html">[rabbitmq-discuss] rabbitmq-c for a reliable rabbitmq client in	production environment.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17577">[ date ]</a>
              <a href="thread.html#17577">[ thread ]</a>
              <a href="subject.html#17577">[ subject ]</a>
              <a href="author.html#17577">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
