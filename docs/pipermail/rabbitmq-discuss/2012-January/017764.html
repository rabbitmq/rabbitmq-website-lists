<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Disc node clustering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Disc%20node%20clustering&In-Reply-To=%3C4F269529.8070200%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017722.html">
   <LINK REL="Next"  HREF="017724.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Disc node clustering</H1>
    <B>Artsiom Gulin</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Disc%20node%20clustering&In-Reply-To=%3C4F269529.8070200%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Disc node clustering">u2.storm at gmail.com
       </A><BR>
    <I>Mon Jan 30 13:03:37 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017722.html">[rabbitmq-discuss] Disc node clustering
</A></li>
        <LI>Next message: <A HREF="017724.html">[rabbitmq-discuss] Add RabbitMQ Binding to existing Application	Config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17764">[ date ]</a>
              <a href="thread.html#17764">[ thread ]</a>
              <a href="subject.html#17764">[ subject ]</a>
              <a href="author.html#17764">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, Simon.
&gt;<i> So it looks like you are leaving the cluster and then resetting, 
</I>&gt;<i> rather than the other way around (which is more normal). It looks like 
</I>&gt;<i> the request to leave the cluster gets ignored in this case. I'll file 
</I>&gt;<i> a bug.
</I>
I've tried scenario, when removing node from cluster is performed like this:

1) join machine B (epbyminw2482t3) to machine A (epbyminw2482t2).

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t3</A> ~]# rabbitmqctl stop_app &amp;&amp; rabbitmqctl reset &amp;&amp; 
rabbitmqctl cluster wosnfs@`hostname -s` <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A> &amp;&amp; 
rabbitmqctl start_app
&lt;-CUT-&gt;
Clustering node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A> with [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A>,
                                             <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A>] ...
...done.
Starting node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A> ...
...done.

Everything is ok.

2) remove node A from cluster

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t2</A> ~]# *rabbitmqctl stop_app &amp;&amp; rabbitmqctl reset &amp;&amp; 
rabbitmqctl start_app*
Stopping node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A> ...
...done.
Resetting node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A> ...
...done.
Starting node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A> ...
...done.

 From now node A and B are standalone, and operate/independently./

3) restart broker on node B.
Restarting rabbitmq-server: FAILED - check 
/var/log/rabbitmq/startup_{log, _err}
rabbitmq-server.

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t3</A> ~]# cat /var/log/rabbitmq/startup_log
Activating RabbitMQ plugins ...
0 plugins activated:
&lt;-CUT-&gt;
node           : <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A>
app descriptor : 
/usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/../ebin/rabbit.app
home dir       : /var/lib/rabbitmq
config file(s) : (none)
&lt;-CUT-&gt;
erlang version : 5.8.4

-- rabbit boot start
starting file handle cache server                                     
...done
starting worker pool                                                  
...done
starting database                                                     
...BOOT ERROR: FAILED
Reason: {error,
             {unable_to_join_cluster,
                 [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,wosnfs at epbyminw2482t2</A>],
                 {merge_schema_failed,
                     &quot;Bad cookie in table definition 
mirrored_sup_childspec: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A> = 
{cstruct,mirrored_sup_childspec,ordered_set,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A>],[],[],0,read_write,false,[],[],false,mirrored_sup_childspec,[key,mirroring_pid,childspec],[],[],{{1327,927347,889571}<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,wosnfs at epbyminw2482t2</A>},{{3,1},{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t3</A>,{1327,927549,609065}}}}, 
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A> = 
{cstruct,mirrored_sup_childspec,ordered_set,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wosnfs at epbyminw2482t2</A>],[],[],0,read_write,false,[],[],false,mirrored_sup_childspec,[key,mirroring_pid,childspec],[],[],{{1327,927550,935402}<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,wosnfs at epbyminw2482t2</A>},{{2,0},[]}}\n&quot;}}}
Stacktrace: [{rabbit_mnesia,init_db,3},
              {rabbit_mnesia,init,0},
              {rabbit,'-run_boot_step/1-lc$^1/1-1-',1},
              {rabbit,run_boot_step,1},
              {rabbit,'-start/2-lc$^0/1-0-',1},
              {rabbit,start,2},
              {application_master,start_it_old,4}]
{&quot;Kernel pid 
terminated&quot;,application_controller,&quot;{application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}}&quot;}

We got this error.

3.1) But, if we stop application on node A
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t2</A> ~]# rabbitmqctl stop_app

3.2)[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at epbyminw2482t3</A> ~]# service rabbitmq-server restart
Restarting rabbitmq-server: RabbitMQ is not running
SUCCESS
rabbitmq-server.

Rabbitmq broker on node B(!) restarts successfully.
Until broker(or application) on node A is down, node B work fine.
When broker on node A is up, node  B faces above mentioned troubles on 
restart (or `rabbitmqctl reset`).
Workaround is to remove mnesia db on node B, but it is bad idea, while 
node B is still joined to the cluster.
It seems that there is some kind of rule about order of joining and 
removing nodes from cluster...

In our application all rabbitmq brokers have to joined in cluster as 
disk nodes, and it have to be possible
to add\remove any node at any time. Could you suggest me, have to 
achieve that and avoid &quot;bad cookie&quot; problem?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120130/9e40c04f/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120130/9e40c04f/attachment.htm</A>&gt;
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017722.html">[rabbitmq-discuss] Disc node clustering
</A></li>
	<LI>Next message: <A HREF="017724.html">[rabbitmq-discuss] Add RabbitMQ Binding to existing Application	Config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17764">[ date ]</a>
              <a href="thread.html#17764">[ thread ]</a>
              <a href="subject.html#17764">[ subject ]</a>
              <a href="author.html#17764">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
