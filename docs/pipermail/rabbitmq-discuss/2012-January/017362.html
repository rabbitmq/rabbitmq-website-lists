<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] WCF bindings connection drop outs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20WCF%20bindings%20connection%20drop%20outs&In-Reply-To=%3C5acc550d-1f04-4063-95ea-f43ec47b4d14%40f11g2000yql.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017366.html">
   <LINK REL="Next"  HREF="017370.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] WCF bindings connection drop outs</H1>
    <B>LuCo</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20WCF%20bindings%20connection%20drop%20outs&In-Reply-To=%3C5acc550d-1f04-4063-95ea-f43ec47b4d14%40f11g2000yql.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] WCF bindings connection drop outs">lucooo at gmail.com
       </A><BR>
    <I>Fri Jan 13 10:27:34 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017366.html">[rabbitmq-discuss] Number of queues and messages
</A></li>
        <LI>Next message: <A HREF="017370.html">[rabbitmq-discuss] WCF bindings connection drop outs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17362">[ date ]</a>
              <a href="thread.html#17362">[ thread ]</a>
              <a href="subject.html#17362">[ subject ]</a>
              <a href="author.html#17362">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi there.

I am using the RabbitMQ.ServiceModel WCF bindings with a .Net client
talking to a standard WCF service (two way) and am having a problem
with a long running connection which seems to stop responding after a
long period of time (vague, but it happens without fail if I leave the
client open overnight) only when I next try to use the WCF client
channel.

On the server, the WCF service runs ok and I can confirm in the
RabbitMQ Management plugin that the queue has been created for this
service (I might add I slightly modified the RabbitMQ WCF source to
use durable queues for the service).

On the client, I create a WCF channel from a ChannelFactory&lt;T&gt; and
maintain a single instance of these objects during the lifetime of the
client (ignoring potential channel faulting for now to keep things
simple). Once I use the channel to call the service (successfully) I
can confirm in the RabbitMQ Management plugin that the client has a
queue created on the broker and messages are flowing between the
client and service.

If I leave the client overnight, the next time I attempt to use the
channel to call the service I receive an IOException at the following
point in the stack:

&quot;Unable to read data from the transport connection: An existing
connection was forcibly closed by the remote host.&quot;

   at System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32
offset, Int32 size)
   at System.IO.BufferedStream.ReadByte()
   at System.IO.BinaryReader.ReadByte()
   at RabbitMQ.Client.Impl.Frame.ReadFrom(NetworkBinaryReader reader)

InnerException: SocketException (SocketErrorCode = ConnectionReset)

I have observed the following in trying to work out what is going on
here:
(1) Prior to the exception above, the RabbitMQ Management plugin shows
the client queue at a port number I can confirm is ESTABLISHED via a
netstat on the client

(2) After the exception above, a netstat on the client reveals the
port has been removed from the list, however, the RabbitMQ Management
plugin still shows the client queue at the old port number and does
not update. I have enabled tracing on the broker and no messages are
exchanged when the exception is raised, nor have been since the last
successful message (previous day).

(3) Attempting to use the channel after the exception (again, without
creating a new channel) results in the below exception:
&quot;The AMQP operation was interrupted: AMQP close-reason, initiated by
Library, code=541, text=&quot;Unexpected Exception&quot;, classId=0, methodId=0,
cause=System.IO.IOException: Unable to read data from the transport
connection: An existing connection was forcibly closed by the remote
host. ---&gt; System.Net.Sockets.SocketException: An existing connection
was forcibly closed by the remote host
   at System.Net.Sockets.Socket.Receive(Byte[] buffer, Int32 offset,
Int32 size, SocketFlags socketFlags)
   at System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32
offset, Int32 size)
   --- End of inner exception stack trace ---
   at RabbitMQ.Client.Impl.Frame.ReadFrom(NetworkBinaryReader reader)
in C:\rabbitmq-dotnet-client-2.7.0\projects\client\RabbitMQ.Client\src
\client\impl\Frame.cs:line 103
   at RabbitMQ.Client.Impl.SocketFrameHandler_0_9.ReadFrame() in C:
\rabbitmq-dotnet-client-2.7.0\projects\client\RabbitMQ.Client\src
\client\impl\SocketFrameHandler_0_9.cs:line 136
   at RabbitMQ.Client.Impl.ConnectionBase.MainLoopIteration() in C:
\rabbitmq-dotnet-client-2.7.0\projects\client\RabbitMQ.Client\src
\client\impl\ConnectionBase.cs:line 632
   at RabbitMQ.Client.Impl.ConnectionBase.MainLoop() in C:\rabbitmq-
dotnet-client-2.7.0\projects\client\RabbitMQ.Client\src\client\impl
\ConnectionBase.cs:line 582&quot;

(4) I can create a new client channel without any issues and
successfully send messages to the service. However, whilst this solves
the issue on the client, I end up with ghost queues on the broker that
just hang around uselessly.

(5) I can switch the WCF bindings to TCP (eliminating RabbitMQ from
the equation) and I do not see the above problem.

Any thoughts? Am I not using the RabbitMQ WCF bindings as I should be?
Do I need to modify the RabbitMQ.ServiceModel source to toggle timeout
settings?

Thanks. Daniel
</PRE>







































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017366.html">[rabbitmq-discuss] Number of queues and messages
</A></li>
	<LI>Next message: <A HREF="017370.html">[rabbitmq-discuss] WCF bindings connection drop outs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17362">[ date ]</a>
              <a href="thread.html#17362">[ thread ]</a>
              <a href="subject.html#17362">[ subject ]</a>
              <a href="author.html#17362">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
