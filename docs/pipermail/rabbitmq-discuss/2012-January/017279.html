<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20broker%20crashing%20under%20heavy%20load%0A%09with%20mirrored%20queues&In-Reply-To=%3C0CF971BF-82C1-4D62-BB41-2628875837AE%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017266.html">
   <LINK REL="Next"  HREF="017285.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20broker%20crashing%20under%20heavy%20load%0A%09with%20mirrored%20queues&In-Reply-To=%3C0CF971BF-82C1-4D62-BB41-2628875837AE%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues">steve at rabbitmq.com
       </A><BR>
    <I>Tue Jan 10 16:27:52 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017266.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load with mirrored queues
</A></li>
        <LI>Next message: <A HREF="017285.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17279">[ date ]</a>
              <a href="thread.html#17279">[ thread ]</a>
              <a href="subject.html#17279">[ subject ]</a>
              <a href="author.html#17279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Venkat,

I'm glad things are better under 2.7.1.

&gt;<i> I have one question, referring to <A HREF="http://www.rabbitmq.com/ha.html:">http://www.rabbitmq.com/ha.html:</A>
</I>&gt;&gt;<i> As a result of the requeuing, clients that re-consume from the queue
</I>&gt;&gt;<i> must be aware that they are likely to subsequently receive messages
</I>&gt;&gt;<i> that they have seen previously
</I>
This is an accurate quote, and is still true.  Acknowledgements are only sent
to the master and then copied to the slaves, so the slaves might not know
about some of them if the master goes down before some acknowledgements can
be forwarded.  If you are lucky (and it appears that you are, or else you are
using auto acknowledgements) then none of the acknowledgements are lost
(or none are required!).

&gt;<i> You notice that there are two lines displaying 1999, this is because
</I>&gt;<i> two messages were lost. Otherwise you see 2000 messages processed
</I>&gt;<i> from each thread.
</I>&gt;<i> 
</I>&gt;<i> From this, does it mean that I don't have to worry about duplicate
</I>&gt;<i> messages due to requeing?
</I>
No, it doesn't mean that. If you have explicit acknowledgements by your
consumers, then when the master fails the slave may redeliver some messages
that were acknowledged, as well as the ones that weren't.

What interests me is the messages that are lost. If I understand it
correctly, messages are published to the master and all the slaves
simultaneously, so the failure of the master shouldn't lose any messages.

Having said that, you haven't said to which broker your test apps connect.
If they were connected to the master at the time, then what do they do when
the master fails?  Do they automatically reconnect (I presume this is in
the tests' logs)? Do they resend the last message (which will have failed
because the connection will have been dropped)?

If they do not resend, then this could be the source of the lost messages
-- they were not sent in the first place.

Please can you explain just a little more about the test thread connection
history, and to which broker they are connected?  I would expect that, if
they are connected to the slave, then you won't see any lost messages in
this test scenario.

&gt;<i> I assuming that HA Proxy
</I>&gt;<i> was not quick enough to detect about the Crashed Node A and thus those
</I>&gt;<i> 2/3 messages were routed to crashed NodeA. Please correct me if I am
</I>&gt;<i> wrong.
</I>
I don't think this is the problem, as messages are published to all the
brokers mirroring the queue.

&gt;<i> The other thing that I just wanted to bring it to your attention (it
</I>&gt;<i> doesn't bother me). It is as follows:
</I>&gt;<i> I have NodeA in the beginning of the cluster then I join NodeB to the
</I>&gt;<i> cluster.
</I>&gt;<i> If I run rabbitmqctl report on NodeA, it throws an error saying that
</I>&gt;<i> NodeA is down (when it is really not down). But it works fine on
</I>&gt;<i> NodeB.
</I>
This is interesting, too. Can you supply us with the complete output from
rabbitmqctl status for both nodes, and explain exactly what you mean by
'run rabbitmqctl on NodeA'?

Thank you for reporting these issues.

Steve Powell  (a curious bunny)
----------some more definitions from the SPD----------
avoirdupois (phr.) 'Would you like peas with that?'
distribute (v.) To denigrate an award ceremony.
definite (phr.) 'It's hard of hearing, I think.'
modest (n.) The most mod.

On 9 Jan 2012, at 23:39, Venkat wrote:

&gt;<i> Hi Steve I have run some tests using RabbitMQ 2.7.1 please find the
</I>&gt;<i> following:
</I>...(elided)
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017266.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load with mirrored queues
</A></li>
	<LI>Next message: <A HREF="017285.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17279">[ date ]</a>
              <a href="thread.html#17279">[ thread ]</a>
              <a href="subject.html#17279">[ subject ]</a>
              <a href="author.html#17279">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
