<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Stuck log rotation in linux?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stuck%20log%20rotation%20in%20linux%3F&In-Reply-To=%3C4F228FCB.1030402%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017705.html">
   <LINK REL="Next"  HREF="017723.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Stuck log rotation in linux?</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stuck%20log%20rotation%20in%20linux%3F&In-Reply-To=%3C4F228FCB.1030402%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Stuck log rotation in linux?">simon at rabbitmq.com
       </A><BR>
    <I>Fri Jan 27 11:51:39 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017705.html">[rabbitmq-discuss] Stuck log rotation in linux?
</A></li>
        <LI>Next message: <A HREF="017723.html">[rabbitmq-discuss] Stuck log rotation in linux?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17713">[ date ]</a>
              <a href="thread.html#17713">[ thread ]</a>
              <a href="subject.html#17713">[ subject ]</a>
              <a href="author.html#17713">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rob.

The ps snippet you show just shows the tree of processes launched by a 
running RabbitMQ server - nothing out of the ordinary there.

If logrotate is getting stuck, presumably this is due to its invocation 
of /etc/init.d/rabbitmq-server rotate-logs hanging. When it's in the 
stuck state, what does this command return? The logrotate configuration 
file pipes the output of that command to /dev/null - can you redirect it 
somewhere else so we can see what it's doing?

Cheers, Simon

On 26/01/12 21:18, Sutherland, Rob wrote:
&gt;<i> Several times now I&#8217;ve run into the issue of rabbitmq getting &#8220;stuck&#8221;
</I>&gt;<i> during log rotation. Log rotation is done via the usual logrotate daily
</I>&gt;<i> cron using the default logrotate configutaion. This is not simply a case
</I>&gt;<i> of log rotation taking too long as this condition can persist for
</I>&gt;<i> months. This cause log rotation to freeze for the entire system (since
</I>&gt;<i> logrotate correctly refuses to be invoked if there&#8217;s already a log
</I>&gt;<i> rotation in progress) and results in log files growing out of control
</I>&gt;<i> (e.g. a 900 MB /var/log/messages file).
</I>&gt;<i>
</I>&gt;<i> Here&#8217;s an example of such a process tree (a snippet from ps axjf):
</I>&gt;<i>
</I>&gt;<i> PPID PID PGID SID TTY TPGID STAT UID TIME COMMAND
</I>&gt;<i>
</I>&gt;<i> 1 25352 25352 25352 ? -1 Ss 0 0:00 sh -c /usr/sbin/rabbitmq-server &gt;
</I>&gt;<i> /var/log/rabbitmq/startup_log 2&gt; /var/log/rabbitmq/startup_err
</I>&gt;<i>
</I>&gt;<i> 25352 25356 25352 25352 ? -1 S 0 0:00 \_ /bin/sh /usr/sbin/rabbitmq-server
</I>&gt;<i>
</I>&gt;<i> 25356 25363 25352 25352 ? -1 S 0 0:00 \_ su rabbitmq -s /bin/sh -c
</I>&gt;<i> /usr/lib/rabbitmq/bin/rabbitmq-server
</I>&gt;<i>
</I>&gt;<i> 25363 25367 25367 25367 ? -1 Ssl 105 3:56 \_
</I>&gt;<i> /usr/lib64/erlang/erts-5.8.1/bin/beam.smp -W w -K true -A30 -P 1048576
</I>&gt;<i> -- -root /usr/lib64/erlang -prognam
</I>&gt;<i>
</I>&gt;<i> 25367 25479 25479 25479 ? -1 Ss 105 0:00 \_
</I>&gt;<i> /usr/lib64/erlang/lib/os_mon-2.2.5/priv/bin/cpu_sup
</I>&gt;<i>
</I>&gt;<i> 25367 25480 25480 25480 ? -1 Ss 105 0:00 \_ inet_gethost 4
</I>&gt;<i>
</I>&gt;<i> 25480 25481 25480 25480 ? -1 S 105 0:00 \_ inet_gethost 4
</I>&gt;<i>
</I>&gt;<i> Any ideas? I have yet to find a pattern to the appearance of this issue.
</I>&gt;<i>
</I>&gt;<i> Thanks in advance,
</I>&gt;<i>
</I>&gt;<i> Rob
</I>&gt;<i>
</I>&gt;<i> OS: SUSE Linux Enterprise System version 11 SP1
</I>&gt;<i>
</I>&gt;<i> # uname -a
</I>&gt;<i>
</I>&gt;<i> Linux PVHA30node1 2.6.32.46-0.3-default #1 SMP 2011-09-29 17:49:31 +0200
</I>&gt;<i> x86_64 x86_64 x86_64 GNU/Linux
</I>&gt;<i>
</I>&gt;<i> # cat /etc/logrotate.d/ rabbitmq-server
</I>&gt;<i>
</I>&gt;<i> /var/log/rabbitmq/*.log {
</I>&gt;<i>
</I>&gt;<i> weekly
</I>&gt;<i>
</I>&gt;<i> missingok
</I>&gt;<i>
</I>&gt;<i> rotate 20
</I>&gt;<i>
</I>&gt;<i> compress
</I>&gt;<i>
</I>&gt;<i> delaycompress
</I>&gt;<i>
</I>&gt;<i> notifempty
</I>&gt;<i>
</I>&gt;<i> sharedscripts
</I>&gt;<i>
</I>&gt;<i> postrotate
</I>&gt;<i>
</I>&gt;<i> /sbin/service rabbitmq-server rotate-logs &gt; /dev/null
</I>&gt;<i>
</I>&gt;<i> endscript
</I>&gt;<i>
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017705.html">[rabbitmq-discuss] Stuck log rotation in linux?
</A></li>
	<LI>Next message: <A HREF="017723.html">[rabbitmq-discuss] Stuck log rotation in linux?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17713">[ date ]</a>
              <a href="thread.html#17713">[ thread ]</a>
              <a href="subject.html#17713">[ subject ]</a>
              <a href="author.html#17713">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
