<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20broker%20crashing%20under%20heavy%20load%0A%09with%20mirrored%20queues&In-Reply-To=%3C01432630-2a5e-463e-8a41-01e9addc9886%40j42g2000vbt.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017400.html">
   <LINK REL="Next"  HREF="017268.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues</H1>
    <B>Venkat</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20broker%20crashing%20under%20heavy%20load%0A%09with%20mirrored%20queues&In-Reply-To=%3C01432630-2a5e-463e-8a41-01e9addc9886%40j42g2000vbt.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues">vveludan at gmail.com
       </A><BR>
    <I>Mon Jan 23 00:39:27 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017400.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
</A></li>
        <LI>Next message: <A HREF="017268.html">[rabbitmq-discuss] Question about HA extension benefits
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17549">[ date ]</a>
              <a href="thread.html#17549">[ thread ]</a>
              <a href="subject.html#17549">[ subject ]</a>
              <a href="author.html#17549">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Steve, sorry for the delayed response. Please find the following:
is it still true that the rabbitmqctl report
&gt;<i> command is failing on t-2? I wondered if this might be something to do with the
</I>&gt;<i> user you are running the rabbitmqctl command under? &#160;Try it with and without
</I>&gt;<i> sudo, for example.
</I>I was running the command without sudo. I will try with sudo and let
you know.

&gt;<i> Your message rate of 40k with only one exception/loss is good, isn't it? I'm not
</I>&gt;<i> certain that the recreate connection code you have used is all necessary, but if
</I>&gt;<i> it works for you, that's fine. What made you put in a 2-second delay (why a
</I>&gt;<i> delay and why 2 seconds)?
</I>
Steve in HA Proxy config the check interval was set to 2 seconds.
Therefore I have set 2 seconds delay.
While posting 40K messages, one message was sent with retry option
when I brought down the broker. In other words all 40K messages were
posted to the queue.
But the consumer was losing 4K to 5K messages. I have run several
tests. Consistently 4K-5K messages were lost.
Finally I used channel transaction while posting messages as follows:
	@Bean
	public RabbitTemplate rabbitTemplate() {
		RabbitTemplate template = new RabbitTemplate(connectionFactory());
		template.setChannelTransacted(true);
		template.setMessageConverter(messageConverter());
		configureMDBTemplate(template);
		return template;
	}

Steve I am not sure if I could use confirms with spring-amqp. That's
why I used channel transaction.
Even after using channel transaction, 4K to 5K messages were lost.
This loss was consistent from 10-15 runs.
I have verified the loss of messages having the queue consumer stopped
so that I could track received message count.

Thanks
Venkat





On Jan 16, 10:21&#160;am, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
&gt;<i> Hi Venkat,
</I>&gt;<i>
</I>&gt;<i> I'm not at all sure what is happening with the cluster nodes. But it is hard to
</I>&gt;<i> tell with the information provided. &#160;It looks as though your nodes are both
</I>&gt;<i> running as disc nodes happily -- is it still true that the rabbitmqctl report
</I>&gt;<i> command is failing on t-2? I wondered if this might be something to do with the
</I>&gt;<i> user you are running the rabbitmqctl command under? &#160;Try it with and without
</I>&gt;<i> sudo, for example.
</I>&gt;<i>
</I>&gt;<i> Your message rate of 40k with only one exception/loss is good, isn't it? I'm not
</I>&gt;<i> certain that the recreate connection code you have used is all necessary, but if
</I>&gt;<i> it works for you, that's fine. What made you put in a 2-second delay (why a
</I>&gt;<i> delay and why 2 seconds)?
</I>&gt;<i>
</I>&gt;<i> The only other thing I might suggest is that you investigate publisher confirms.
</I>&gt;<i> This is a lightweight way of knowing that a publish actually got through to the
</I>&gt;<i> rabbitmq node and was successfully passed on (or stored). See
</I>&gt;<i> [<A HREF="http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/]">http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/]</A> for an
</I>&gt;<i> introduction using Java, and
</I>&gt;<i> [<A HREF="http://www.rabbitmq.com/extensions.html#publishing]">http://www.rabbitmq.com/extensions.html#publishing]</A> for the AMQP details. It
</I>&gt;<i> may be just what you want to know when wondering if your message is lost.
</I>&gt;<i>
</I>&gt;<i> Steve Powell &#160;(a happy bunny)
</I>&gt;<i> ----------some more definitions from the SPD----------
</I>&gt;<i> avoirdupois (phr.) 'Would you like peas with that?'
</I>&gt;<i> distribute (v.) To denigrate an award ceremony.
</I>&gt;<i> definite (phr.) 'It's hard of hearing, I think.'
</I>&gt;<i> modest (n.) The most mod.
</I>&gt;<i>
</I>&gt;<i> On 13 Jan 2012, at 05:03, Venkat wrote:
</I>&gt;<i>
</I>&gt;<i> (You did start_app after the cluster command, didn't you??? &#160;:-))
</I>&gt;<i>
</I>&gt;<i> Hi Steve I did restart the the app.
</I>&gt;<i> Following are the steps I have performed on both nodes:
</I>&gt;<i>
</I>&gt;<i> Starting the second node t-4:
</I>&gt;<i> ./rabbitmq-server -detached
</I>&gt;<i>
</I>&gt;<i> Steps to join t-4 node to t-2:
</I>&gt;<i> /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl stop_app
</I>&gt;<i> /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl reset
</I>&gt;<i> /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl cluster <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>
</I>&gt;<i> Clustering node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>' with ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>',
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>'] ...
</I>&gt;<i> ...done.
</I>&gt;<i> /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl start_app
</I>&gt;<i> Starting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>' ...
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i> Running cluster_status on t-4 node:
</I>&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ecloud at t-4</A> sbin]$ /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl cluster_status
</I>&gt;<i> Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>' ...
</I>&gt;<i> [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>']}]},
</I>&gt;<i> {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>']}]
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i> Running cluster_status on t-2 node (to which t-4 is joined):
</I>&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ecloud at t-2</A> vv]$ /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl cluster_status
</I>&gt;<i> Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>' ...
</I>&gt;<i> [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>']}]},
</I>&gt;<i> {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>']}]
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i> --------------------------------------------------------------------------- -----
</I>&gt;<i> I have been testing with HA feature with different scenario.
</I>&gt;<i> In my previous test the messages were pumped in with a SOAP service.
</I>&gt;<i> This was pumping messages at slow rate.
</I>&gt;<i> I have used a test that pumps in messages by calling plain Java
</I>&gt;<i> Service. I have also increased messages pumping in from 20K to 40K.
</I>&gt;<i> I am finding that messages are lost while pumping into the queue.
</I>&gt;<i> As you mentioned earlier this could be due to connecting to dead
</I>&gt;<i> broker.
</I>&gt;<i> I modified the producer code by giving 2 seconds lapse of time and
</I>&gt;<i> setting a fresh ConnectionFactory as follows:
</I>&gt;<i>
</I>&gt;<i> @Override
</I>&gt;<i> public void convertAndSend(final Object message) throws AmqpException
</I>&gt;<i> {
</I>&gt;<i> &#160; MessageProperties props = null;
</I>&gt;<i> &#160; try {
</I>&gt;<i> &#160; &#160; props = new MessageProperties();
</I>&gt;<i> &#160; &#160; props.setDeliveryMode(MessageDeliveryMode.PERSISTENT); &#160; //setting delivery mode as PERSISTENT
</I>&gt;<i> &#160; &#160; send(getMessageConverter().toMessage(message, props));
</I>&gt;<i> &#160; } catch (AmqpException amqpe) {
</I>&gt;<i> &#160; &#160; System.out.println(&quot;Exception occurred while sending:&quot;+amqpe.getMessage());
</I>&gt;<i> &#160; &#160; try {
</I>&gt;<i> &#160; &#160; &#160; Thread.sleep(2000);
</I>&gt;<i> &#160; &#160; } catch (InterruptedException e) {
</I>&gt;<i> &#160; &#160; &#160; e.printStackTrace();
</I>&gt;<i> &#160; &#160; }
</I>&gt;<i> &#160; &#160; Properties props1 = FrameworkServiceLocator.getInstance().
</I>&gt;<i> &#160; &#160; &#160; getCommonsConfigurationService(ServiceConstants.DMB_COMMONS_CONFIG_SERVICE) .
</I>&gt;<i> &#160; &#160; &#160; getProperties(CommonsConfigurationConstants.RABBIT_MQ_CONFIG_NAME);
</I>&gt;<i> &#160; &#160; String rabbitMQUser = props1.getProperty(CommonsConfigurationConstants.RABBITMQ_USER);
</I>&gt;<i> &#160; &#160; String rabbitMQPassword = props1.getProperty(CommonsConfigurationConstants.RABBITMQ_PASSWORD);
</I>&gt;<i> &#160; &#160; String rabbitMQHost = props1.getProperty(CommonsConfigurationConstants.RABBITMQ_HOST);
</I>&gt;<i> &#160; &#160; String rabbitMQChannelCacheSize = props1.getProperty(CommonsConfigurationConstants.RABBITMQ_CHANNEL_CACHE_SIZ E);
</I>&gt;<i> &#160; &#160; CachingConnectionFactory connectionFactory = new CachingConnectionFactory(rabbitMQHost);
</I>&gt;<i> &#160; &#160; connectionFactory.setChannelCacheSize(Integer.parseInt(rabbitMQChannelCache Size));
</I>&gt;<i> &#160; &#160; connectionFactory.setUsername(rabbitMQUser);
</I>&gt;<i> &#160; &#160; connectionFactory.setPassword(rabbitMQPassword);
</I>&gt;<i> &#160; &#160; setConnectionFactory(connectionFactory);
</I>&gt;<i> &#160; &#160; try {
</I>&gt;<i> &#160; &#160; &#160; send(getMessageConverter().toMessage(message, props));
</I>&gt;<i> &#160; &#160; } catch(AmqpException e1) {
</I>&gt;<i> &#160; &#160; &#160; e1.printStackTrace();
</I>&gt;<i> &#160; &#160; }
</I>&gt;<i> &#160; }
</I>&gt;<i>
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> After this change is made, I saw an exception occurred once while
</I>&gt;<i> sending 40K messages which is as follows:
</I>&gt;<i> java.net.SocketException: Broken pipe.
</I>&gt;<i> I have run the test 10-15 times each time 5K-6K messages were lost
</I>&gt;<i> but this exception was occurring only once.
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i> Venkat
</I>&gt;<i>
</I>&gt;<i> On Jan 11, 12:55 pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
</I>&gt;<i> Hi Venkat,
</I>&gt;<i>
</I>&gt;<i> This time there were no messages lost. All 20K messages were
</I>&gt;<i> processed.
</I>&gt;<i>
</I>&gt;<i> That's great.
</I>&gt;<i>
</I>&gt;<i> I'm trying to figure out what might be wrong with
</I>&gt;<i> rabbitmqctl report; I'll get back to you.
</I>&gt;<i>
</I>&gt;<i> Meanwhile, running
</I>&gt;<i> &#160; &#160; &#160; &#160;rabbitmqctl -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A> status
</I>&gt;<i> ON NODE t-4 might be interesting.
</I>&gt;<i>
</I>&gt;<i> Also, can you tell us the output from
</I>&gt;<i> &#160; &#160; &#160; &#160;rabbitmqctl cluster_status
</I>&gt;<i> on both nodes, please.
</I>&gt;<i>
</I>&gt;<i> It is not clear if you have issued the stop_app and start_app and
</I>&gt;<i> reset/force_reset commands properly (you probably have), so could you follow
</I>&gt;<i> the steps as described in the clustering guide, and issue
</I>&gt;<i> rabbitmqctl cluster_status on both nodes after each cluster change?
</I>&gt;<i> We should be able to see where things went wrong, then.
</I>&gt;<i>
</I>&gt;<i> (You did start_app after the cluster command, didn't you??? &#160;:-))
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> Steve Powell &#160;(a hoppy bunny)
</I>&gt;<i> ----------some more definitions from the SPD----------
</I>&gt;<i> avoirdupois (phr.) 'Would you like peas with that?'
</I>&gt;<i> distribute (v.) To denigrate an award ceremony.
</I>&gt;<i> definite (phr.) 'It's hard of hearing, I think.'
</I>&gt;<i> modest (n.) The most mod.
</I>&gt;<i>
</I>&gt;<i> On 11 Jan 2012, at 01:22, Venkat wrote:&gt; ...
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017400.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
</A></li>
	<LI>Next message: <A HREF="017268.html">[rabbitmq-discuss] Question about HA extension benefits
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17549">[ date ]</a>
              <a href="thread.html#17549">[ thread ]</a>
              <a href="subject.html#17549">[ subject ]</a>
              <a href="author.html#17549">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
