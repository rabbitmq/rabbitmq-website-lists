<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20broker%20crashing%20under%20heavy%20load%0A%09with%20mirrored%20queues&In-Reply-To=%3C7DCEDEF1-71CE-495F-A476-5937273CFFC2%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017361.html">
   <LINK REL="Next"  HREF="017549.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20broker%20crashing%20under%20heavy%20load%0A%09with%20mirrored%20queues&In-Reply-To=%3C7DCEDEF1-71CE-495F-A476-5937273CFFC2%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues">steve at rabbitmq.com
       </A><BR>
    <I>Mon Jan 16 15:21:19 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017361.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
</A></li>
        <LI>Next message: <A HREF="017549.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17400">[ date ]</a>
              <a href="thread.html#17400">[ thread ]</a>
              <a href="subject.html#17400">[ subject ]</a>
              <a href="author.html#17400">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Venkat,

I'm not at all sure what is happening with the cluster nodes. But it is hard to
tell with the information provided.  It looks as though your nodes are both
running as disc nodes happily -- is it still true that the rabbitmqctl report
command is failing on t-2? I wondered if this might be something to do with the
user you are running the rabbitmqctl command under?  Try it with and without
sudo, for example.

Your message rate of 40k with only one exception/loss is good, isn't it? I'm not
certain that the recreate connection code you have used is all necessary, but if
it works for you, that's fine. What made you put in a 2-second delay (why a
delay and why 2 seconds)?

The only other thing I might suggest is that you investigate publisher confirms.
This is a lightweight way of knowing that a publish actually got through to the
rabbitmq node and was successfully passed on (or stored). See
[<A HREF="http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/]">http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/]</A> for an
introduction using Java, and
[<A HREF="http://www.rabbitmq.com/extensions.html#publishing]">http://www.rabbitmq.com/extensions.html#publishing]</A> for the AMQP details. It
may be just what you want to know when wondering if your message is lost.

Steve Powell  (a happy bunny)
----------some more definitions from the SPD----------
avoirdupois (phr.) 'Would you like peas with that?'
distribute (v.) To denigrate an award ceremony.
definite (phr.) 'It's hard of hearing, I think.'
modest (n.) The most mod.

On 13 Jan 2012, at 05:03, Venkat wrote:

(You did start_app after the cluster command, didn't you???  :-))

Hi Steve I did restart the the app.
Following are the steps I have performed on both nodes:

Starting the second node t-4:
./rabbitmq-server -detached

Steps to join t-4 node to t-2:
/usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl stop_app
/usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl reset
/usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl cluster <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>
Clustering node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>' with ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>',
                                    '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>'] ...
...done.
/usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl start_app
Starting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>' ...
...done.

Running cluster_status on t-4 node:
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ecloud at t-4</A> sbin]$ /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl cluster_status
Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>' ...
[{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>']}]},
{running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>']}]
...done.

Running cluster_status on t-2 node (to which t-4 is joined):
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ecloud at t-2</A> vv]$ /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/rabbitmqctl cluster_status
Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>' ...
[{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>']}]},
{running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-4</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A>']}]
...done.

--------------------------------------------------------------------------------
I have been testing with HA feature with different scenario.
In my previous test the messages were pumped in with a SOAP service.
This was pumping messages at slow rate.
I have used a test that pumps in messages by calling plain Java
Service. I have also increased messages pumping in from 20K to 40K.
I am finding that messages are lost while pumping into the queue.
As you mentioned earlier this could be due to connecting to dead
broker.
I modified the producer code by giving 2 seconds lapse of time and
setting a fresh ConnectionFactory as follows:

@Override
public void convertAndSend(final Object message) throws AmqpException
{
  MessageProperties props = null;
  try {
    props = new MessageProperties();
    props.setDeliveryMode(MessageDeliveryMode.PERSISTENT);   //setting delivery mode as PERSISTENT
    send(getMessageConverter().toMessage(message, props));
  } catch (AmqpException amqpe) {
    System.out.println(&quot;Exception occurred while sending:&quot;+amqpe.getMessage());
    try {
      Thread.sleep(2000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    Properties props1 = FrameworkServiceLocator.getInstance().
      getCommonsConfigurationService(ServiceConstants.DMB_COMMONS_CONFIG_SERVICE).
      getProperties(CommonsConfigurationConstants.RABBIT_MQ_CONFIG_NAME);
    String rabbitMQUser = props1.getProperty(CommonsConfigurationConstants.RABBITMQ_USER);
    String rabbitMQPassword = props1.getProperty(CommonsConfigurationConstants.RABBITMQ_PASSWORD);
    String rabbitMQHost = props1.getProperty(CommonsConfigurationConstants.RABBITMQ_HOST);
    String rabbitMQChannelCacheSize = props1.getProperty(CommonsConfigurationConstants.RABBITMQ_CHANNEL_CACHE_SIZE);
    CachingConnectionFactory connectionFactory = new CachingConnectionFactory(rabbitMQHost);
    connectionFactory.setChannelCacheSize(Integer.parseInt(rabbitMQChannelCacheSize));
    connectionFactory.setUsername(rabbitMQUser);
    connectionFactory.setPassword(rabbitMQPassword);
    setConnectionFactory(connectionFactory);
    try {
      send(getMessageConverter().toMessage(message, props));
    } catch(AmqpException e1) {
      e1.printStackTrace();
    }
  }
}

After this change is made, I saw an exception occurred once while
sending 40K messages which is as follows:
java.net.SocketException: Broken pipe.
I have run the test 10-15 times each time 5K-6K messages were lost
but this exception was occurring only once.

Thanks
Venkat


On Jan 11, 12:55 pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
Hi Venkat,

This time there were no messages lost. All 20K messages were
processed.

That's great.

I'm trying to figure out what might be wrong with
rabbitmqctl report; I'll get back to you.

Meanwhile, running
       rabbitmqctl -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at t-2</A> status
ON NODE t-4 might be interesting.

Also, can you tell us the output from
       rabbitmqctl cluster_status
on both nodes, please.

It is not clear if you have issued the stop_app and start_app and
reset/force_reset commands properly (you probably have), so could you follow
the steps as described in the clustering guide, and issue
rabbitmqctl cluster_status on both nodes after each cluster change?
We should be able to see where things went wrong, then.

(You did start_app after the cluster command, didn't you???  :-))

Cheers,

Steve Powell  (a hoppy bunny)
----------some more definitions from the SPD----------
avoirdupois (phr.) 'Would you like peas with that?'
distribute (v.) To denigrate an award ceremony.
definite (phr.) 'It's hard of hearing, I think.'
modest (n.) The most mod.

On 11 Jan 2012, at 01:22, Venkat wrote:&gt; ...

_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017361.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
</A></li>
	<LI>Next message: <A HREF="017549.html">[rabbitmq-discuss] RabbitMQ broker crashing under heavy load	with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17400">[ date ]</a>
              <a href="thread.html#17400">[ thread ]</a>
              <a href="subject.html#17400">[ subject ]</a>
              <a href="author.html#17400">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
