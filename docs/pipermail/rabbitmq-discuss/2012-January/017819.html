<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problems with rabbit and hoping I can get	some help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problems%20with%20rabbit%20and%20hoping%20I%20can%20get%0A%09some%20help&In-Reply-To=%3CCA%2B22WDQ1s3jdsTC279cfFX-s-nbTngvxqF1hMz6dCXriBK%2B1Lg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017818.html">
   <LINK REL="Next"  HREF="017820.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problems with rabbit and hoping I can get	some help</H1>
    <B>Dathan Pattishall</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problems%20with%20rabbit%20and%20hoping%20I%20can%20get%0A%09some%20help&In-Reply-To=%3CCA%2B22WDQ1s3jdsTC279cfFX-s-nbTngvxqF1hMz6dCXriBK%2B1Lg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Problems with rabbit and hoping I can get	some help">dathan at schoolfeed.com
       </A><BR>
    <I>Tue Jan 31 21:05:39 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017818.html">[rabbitmq-discuss] Problems with rabbit and hoping I can get	some	help
</A></li>
        <LI>Next message: <A HREF="017820.html">[rabbitmq-discuss] Problems with rabbit and hoping I can get	some help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17819">[ date ]</a>
              <a href="thread.html#17819">[ thread ]</a>
              <a href="subject.html#17819">[ subject ]</a>
              <a href="author.html#17819">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jerry,

I neglected to mentioned that I am not hitting the memory-based flow
control according to my memory alarm stat from
rabbitmqadmin.py list nodes

What threshold would the TCP back pressure logic hit? I assume when the
memory limit is reached rabbit pushes back on the publishers? Rabbit did
not use more then 2G of RAM out of the 5G allowed for it, if that is the
case.

Also is there a way to tell rabbit drop the messages instead of block?


On Tue, Jan 31, 2012 at 12:56 PM, Jerry Kuch &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at vmware.com</A>&gt; wrote:

&gt;<i> Hi, Dathan...
</I>&gt;<i>
</I>&gt;<i> What are your consumers doing with the published messages?  If you use
</I>&gt;<i> rabbitmqctl or
</I>&gt;<i> the management plugin to look at what's going on in your queues, do you
</I>&gt;<i> see messages
</I>&gt;<i> accumulating but not being delivered?  Or delivered but not ACKed?  If
</I>&gt;<i> messages are
</I>&gt;<i> building up (either undelivered or unACKed) faster than consumers are
</I>&gt;<i> draining them,
</I>&gt;<i> you might be hitting memory-based flow control, which will use TCP back
</I>&gt;<i> pressure to
</I>&gt;<i> stop the publishers.
</I>&gt;<i>
</I>&gt;<i> See here for more information:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/memory.html">http://www.rabbitmq.com/memory.html</A>
</I>&gt;<i>
</I>&gt;<i> To get an idea whether this is happening to you, check out your queue
</I>&gt;<i> contents as
</I>&gt;<i> suggested above, and see if memory alarms are being set in your rabbit
</I>&gt;<i> logs.../
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Jerry
</I>&gt;<i>
</I>&gt;<i> ----- Original Message -----
</I>&gt;<i> From: &quot;Dathan Pattishall&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dathan at schoolfeed.com</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> Sent: Tuesday, January 31, 2012 12:52:55 PM
</I>&gt;<i> Subject: [rabbitmq-discuss] Problems with rabbit and hoping I can get some
</I>&gt;<i>      help
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Let me first describe my setup.
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at webnode1</A>]# rabbitmqadmin.py show overview
</I>&gt;<i>
</I>&gt;<i> +--------------------+-----------------+--------------------+------------------+
</I>&gt;<i> | management_version | node | statistics_db_node | statistics_level |
</I>&gt;<i>
</I>&gt;<i> +--------------------+-----------------+--------------------+------------------+
</I>&gt;<i> | 2.7.1 | <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at webnode1</A> | <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at webnode1</A> | fine |
</I>&gt;<i>
</I>&gt;<i> +--------------------+-----------------+--------------------+------------------+
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Rabbit MQ's producers comes from PHP 5.3.8
</I>&gt;<i> <A HREF="http://www.php.net/manual/en/book.amqp.php">http://www.php.net/manual/en/book.amqp.php</A> . Each apache process could
</I>&gt;<i> produce a rabbit message, I am producing around 1000 messages a second on
</I>&gt;<i> c1.xtralarge instance at ec2.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> My erlang version is
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> /usr/local/bin/erl -v
</I>&gt;<i> Erlang R15B (erts-5.9) [source] [64-bit] [smp:8:8] [async-threads:0]
</I>&gt;<i> [hipe] [kernel-poll:false]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The PROBLEM:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> After about 40 mins of rabbit accepting messages all connections block
</I>&gt;<i> causing a rather bad error on the front ends killing traffic. Turning
</I>&gt;<i> rabbit off and restarting the web servers forces a recovery.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Stats from Rabbit:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Roughly 5000 queues are made
</I>&gt;<i> Roughly 3600 exchanges are made
</I>&gt;<i> Each exchange can have at most 1200 queues bound to it.
</I>&gt;<i> Each Queue is setup for autodelete and so is the exchanges with delivery
</I>&gt;<i> type 1.
</I>&gt;<i> All data passed is JSON
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The consumer is NODE and its keeping up with the consumption
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> RabbitMQ memlimit is around 5.3G
</I>&gt;<i> RabbitMQ mem used hits around 1.9G when it freezes produces
</I>&gt;<i> RabbitMQ proc used hits around 220K
</I>&gt;<i> RabbitMQ fd_total is 50K
</I>&gt;<i> RabbitMQ socks_total is around 45K and Socks used is 4K
</I>&gt;<i> mem_ets hists 100M // not sure what this is
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Any idea what is going on? What limit am I hitting? Why does RabbitMQ
</I>&gt;<i> block? How can I detect that I am about to hit a block state? Any
</I>&gt;<i> suggestions or request of additional data would be great.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120131/b5eec2c9/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120131/b5eec2c9/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017818.html">[rabbitmq-discuss] Problems with rabbit and hoping I can get	some	help
</A></li>
	<LI>Next message: <A HREF="017820.html">[rabbitmq-discuss] Problems with rabbit and hoping I can get	some help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17819">[ date ]</a>
              <a href="thread.html#17819">[ thread ]</a>
              <a href="subject.html#17819">[ subject ]</a>
              <a href="author.html#17819">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
