<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] WCF bindings connection drop outs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20WCF%20bindings%20connection%20drop%20outs&In-Reply-To=%3Cb5d0a2b1-1a9b-4c7b-8973-962ebb02df99%40i25g2000vbt.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017372.html">
   <LINK REL="Next"  HREF="017622.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] WCF bindings connection drop outs</H1>
    <B>LuCo</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20WCF%20bindings%20connection%20drop%20outs&In-Reply-To=%3Cb5d0a2b1-1a9b-4c7b-8973-962ebb02df99%40i25g2000vbt.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] WCF bindings connection drop outs">lucooo at gmail.com
       </A><BR>
    <I>Tue Jan 24 16:48:44 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017372.html">[rabbitmq-discuss] WCF bindings connection drop outs
</A></li>
        <LI>Next message: <A HREF="017622.html">[rabbitmq-discuss] WCF bindings connection drop outs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17620">[ date ]</a>
              <a href="thread.html#17620">[ thread ]</a>
              <a href="subject.html#17620">[ subject ]</a>
              <a href="author.html#17620">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;&gt;<i>The heartbeat does solve the connection drop outs thanks. I added this to the RabbitMQTransportBindingElement as you suggested.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Related, but not causing a noticeable issue is a message in a RabbitMQ trace that I was using to investigate drop outs that is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>&quot;Due to a user abort the reliable session cannot continue&quot; (wrapped in a message on the client queue)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>This message is sent to the client queue after periods of inactivity. I understand what this message means and have played around with the timeout &gt;&gt;settings (receive,inactivity) on the RabbitMQ WCF binding to no avail. This message is always raised even though keep alive messages (ack &gt;&gt;requests/acknowledgements) are exchanged between client and server queues at a frequency that matches timeout settings (or half of in the case of &gt;&gt;the inactivity timeout) as seen in the trace.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>As I said, there is no noticeable affect on sending/receiving messages but am curious why the message appears in the trace at all?
</I>&gt;&gt;<i>
</I>
&gt;<i>What is the period of inactivity that precedes the error? If it is 10 minutes then you may need to adjust &quot;Inactivity Timeout&quot;. If you have already tried &gt;that can you show how you changed the binding or the config file?
</I>
The actual problem is the ReceiveTimeout. If the period of inactivity
exceeds the ReceiveTimeout on the service, the message below is sent
to the client queue:

Node:         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE2</A>
Exchange:     amq.direct
Routing keys: [&lt;&lt;&quot;/439a2420-2369-4d00-8e23-704b4d31dda1&quot;&gt;&gt;]
Properties:   []
Payload:
&lt;s:Envelope xmlns:s=&quot;<A HREF="http://www.w3.org/2003/05/soap-envelope&quot;">http://www.w3.org/2003/05/soap-envelope&quot;</A>
xmlns:a=&quot;<A HREF="http://www.w3.org/2005/08/addressing&quot;">http://www.w3.org/2005/08/addressing&quot;</A>&gt;&lt;s:Header&gt;&lt;a:Action
s:mustUnderstand=&quot;1&quot;&gt;<A HREF="http://www.w3.org/2005/08/addressing/soap/fault&lt;/">http://www.w3.org/2005/08/addressing/soap/fault&lt;/</A>
a:Action&gt;&lt;a:To s:mustUnderstand=&quot;1&quot;&gt;soap.<A HREF="amqp:///">amqp:///</A>
439a2420-2369-4d00-8e23-704b4d31dda1&lt;/a:To&gt;&lt;/
s:Header&gt;&lt;s:Body&gt;&lt;s:Fault&gt;&lt;s:Code&gt;&lt;s:Value&gt;s:Receiver&lt;/
s:Value&gt;&lt;s:Subcode&gt;&lt;s:Value xmlns:a=&quot;<A HREF="http://schemas.xmlsoap.org/ws/">http://schemas.xmlsoap.org/ws/</A>
2005/02/rm&quot;&gt;a:SequenceTerminated&lt;/s:Value&gt;&lt;/s:Subcode&gt;&lt;/
s:Code&gt;&lt;s:Reason&gt;&lt;s:Text xml:lang=&quot;en-GB&quot;&gt;Due to a user abort the
reliable session cannot continue.&lt;/s:Text&gt;&lt;/
s:Reason&gt;&lt;s:Detail&gt;&lt;r:Identifier xmlns:r=&quot;<A HREF="http://schemas.xmlsoap.org/">http://schemas.xmlsoap.org/</A>
ws/2005/02/rm&quot;&gt;urn:uuid:e4415296-97ff-4b1a-9b3c-e43b862037ca&lt;/
r:Identifier&gt;&lt;/s:Detail&gt;&lt;/s:Fault&gt;&lt;/s:Body&gt;&lt;/s:Envelope&gt;

I have added to the
RabbitMQ.ServiceModel.RabbitMQBindingConfigurationElement class (I can
send you the code if you wish) ...

[ConfigurationProperty(&quot;inactivityTimeout&quot;, DefaultValue=&quot;00:10:00&quot;)]
public TimeSpan InactivityTimeout ... (etc.)
[ConfigurationProperty(&quot;receiveTimeout&quot;, DefaultValue = &quot;00:10:00&quot;)]
public new TimeSpan ReceiveTimeout ... (etc.)

... to capture configured values. The OnApplyConfiguration method in
the above class will then use values from the above properties to set
the relevant properties on the RabbitMQ.ServiceModel.RabbitMQBinding
class (InitializeFrom also modified to set on 'binding' parameter). By
setting the InactivityTimeout I am effectively getting infrastructure
ack messages sent to the client and server queues and I can see this
in the messages below (first message is to service queue, second
message is to client queue):

================================================================================
2012-1-24 14:6:0: Message published

Node:         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE2</A>
Exchange:     amq.direct
Routing keys: [&lt;&lt;&quot;/Service&quot;&gt;&gt;]
Properties:   []
Payload:
&lt;s:Envelope xmlns:s=&quot;<A HREF="http://www.w3.org/2003/05/soap-envelope&quot;">http://www.w3.org/2003/05/soap-envelope&quot;</A>
xmlns:r=&quot;<A HREF="http://schemas.xmlsoap.org/ws/2005/02/rm&quot;">http://schemas.xmlsoap.org/ws/2005/02/rm&quot;</A> xmlns:a=&quot;http://
www.w3.org/2005/08/addressing&quot;&gt;&lt;s:Header&gt;&lt;r:AckRequested&gt;&lt;r:Identifier&gt;urn:uuid:e4415296-97ff-4b1a-9b3c-e43b862037ca&lt;/r:Identifier&gt;&lt;/r:AckRequested&gt;&lt;a:Action
s:mustUnderstand=&quot;1&quot;&gt;<A HREF="http://schemas.xmlsoap.org/ws/2005/02/rm/">http://schemas.xmlsoap.org/ws/2005/02/rm/</A>
AckRequested&lt;/a:Action&gt;&lt;/s:Header&gt;&lt;s:Body/&gt;&lt;/s:Envelope&gt;

================================================================================
2012-1-24 14:6:0: Message published

Node:         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE2</A>
Exchange:     amq.direct
Routing keys: [&lt;&lt;&quot;/439a2420-2369-4d00-8e23-704b4d31dda1&quot;&gt;&gt;]
Properties:   []
Payload:
&lt;s:Envelope xmlns:s=&quot;<A HREF="http://www.w3.org/2003/05/soap-envelope&quot;">http://www.w3.org/2003/05/soap-envelope&quot;</A>
xmlns:r=&quot;<A HREF="http://schemas.xmlsoap.org/ws/2005/02/rm&quot;">http://schemas.xmlsoap.org/ws/2005/02/rm&quot;</A> xmlns:a=&quot;http://
www.w3.org/2005/08/addressing&quot;&gt;&lt;s:Header&gt;&lt;r:SequenceAcknowledgement&gt;&lt;r:Identifier&gt;urn:uuid:e4415296-97ff-4b1a-9b3c-e43b862037ca&lt;/r:Identifier&gt;&lt;r:AcknowledgementRange
Lower=&quot;1&quot; Upper=&quot;2&quot;/&gt;&lt;netrm:BufferRemaining xmlns:netrm=&quot;http://
schemas.microsoft.com/ws/2006/05/rm&quot;&gt;8&lt;/netrm:BufferRemaining&gt;&lt;/
r:SequenceAcknowledgement&gt;&lt;a:Action s:mustUnderstand=&quot;1&quot;&gt;http://
schemas.xmlsoap.org/ws/2005/02/rm/SequenceAcknowledgement&lt;/
a:Action&gt;&lt;a:To s:mustUnderstand=&quot;1&quot;&gt;soap.<A HREF="amqp:///">amqp:///</A>
439a2420-2369-4d00-8e23-704b4d31dda1&lt;/a:To&gt;&lt;/s:Header&gt;&lt;s:Body/&gt;&lt;/
s:Envelope&gt;

For example, if I set the InactivityTimeout and ReceiveTimeout
properties to 2 minutes I am seeing an ack message sent at 1 minute
(after initial call - as expected as the infrastructure message is
fired every half of the inactivity value), but then at 2 minutes the
error message above is sent to the client queue (when the
receivetimeout expires). So even though messages are being exchanged,
the connection still aborts as it has not received any application
messages during this time.

After some Googling I came across this (<A HREF="http://msdn.microsoft.com/en-">http://msdn.microsoft.com/en-</A>
us/library/system.servicemodel.channels.binding.receivetimeout.aspx)
which answers the question I believe. The ReceiveTimeout listens for
application messages, and if none are received within the duration
specified it will fault the channel. The InactivityTimeout listens for
application AND infrastructure messages. I think I will need to set
the ReceiveTimeout value on the service to a sufficiently large value
for real world scenarios (max is 24 days I think).

Anyway, I have added some new config fields to the binding
configuration (as described above) which should enable toggling of
these values to provide the best fit.

Daniel.


</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017372.html">[rabbitmq-discuss] WCF bindings connection drop outs
</A></li>
	<LI>Next message: <A HREF="017622.html">[rabbitmq-discuss] WCF bindings connection drop outs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17620">[ date ]</a>
              <a href="thread.html#17620">[ thread ]</a>
              <a href="subject.html#17620">[ subject ]</a>
              <a href="author.html#17620">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
