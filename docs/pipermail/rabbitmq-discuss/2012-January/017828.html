<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Lost messages in HA tests in a cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lost%20messages%20in%20HA%20tests%20in%20a%20cluster&In-Reply-To=%3CCAOn7oW9D9XEfrDxWyLnWc%3DtPB4xb2Wqy8To_R3odbHCOD4ZW1A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017827.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Lost messages in HA tests in a cluster</H1>
    <B>Simone Busoli</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lost%20messages%20in%20HA%20tests%20in%20a%20cluster&In-Reply-To=%3CCAOn7oW9D9XEfrDxWyLnWc%3DtPB4xb2Wqy8To_R3odbHCOD4ZW1A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Lost messages in HA tests in a cluster">simone.busoli at gmail.com
       </A><BR>
    <I>Tue Jan 31 23:43:53 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017827.html">[rabbitmq-discuss] Lost messages in HA tests in a cluster
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17828">[ date ]</a>
              <a href="thread.html#17828">[ thread ]</a>
              <a href="subject.html#17828">[ subject ]</a>
              <a href="author.html#17828">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Pablo, looking at your code I can't see where you are republishing
messages which have not been confirmed by the broker. If you want to make
sure that publishes will eventually be delivered you have to keep track of
them and re-issue them in case an ack doesn't arrive from the broker, which
usually happens when the broker dies.
On Jan 31, 2012 11:52 PM, &quot;Pablo Molnar&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pablomolnar at gmail.com</A>&gt; wrote:

&gt;<i> Hi all!
</I>&gt;<i>
</I>&gt;<i> I'm doing some HA tests stressing my cluster and I'm experimenting lost
</I>&gt;<i> messages ONLY when the publisher lost the connection due a kill -9.
</I>&gt;<i>
</I>&gt;<i> *Test OK*: Kill node while consuming:
</I>&gt;<i> 1 - Setup a clean 3 node's cluster
</I>&gt;<i> 2 - Execute producer with 10.000 messages connected to node A
</I>&gt;<i> 3 - Wait producer to finish
</I>&gt;<i> 4 - Execute consumer connected to node A
</I>&gt;<i> 5 - While consumer is running kill node A
</I>&gt;<i>
</I>&gt;<i> Result: The consumer reconnects to another node and consume the rest of
</I>&gt;<i> messages ok. All 10.000 messages were consumed ok.
</I>&gt;<i>
</I>&gt;<i> *Test FAILED*: Kill node while producing:
</I>&gt;<i> 1 - Setup a clean 3 node's cluster
</I>&gt;<i> 2 - Execute consumer to start listening connected node A
</I>&gt;<i> 3 - Execute producer with 10.000 messages connected to node A
</I>&gt;<i> 4 - While producer is running kill node A
</I>&gt;<i>
</I>&gt;<i> Result: The producer reconnects fine (the consumer too) and keep
</I>&gt;<i> publishing but some of the messages* already published* to node A are
</I>&gt;<i> lost.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> These are my settings:
</I>&gt;<i>
</I>&gt;<i> rabbitmqctl status
</I>&gt;<i> Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>' ...
</I>&gt;<i> [{pid,11339},
</I>&gt;<i>  {running_applications,
</I>&gt;<i>      [{rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;2.7.1&quot;},
</I>&gt;<i>       {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;2.7.1&quot;},
</I>&gt;<i>       {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;2.7.1&quot;},
</I>&gt;<i>       {rabbit,&quot;RabbitMQ&quot;,&quot;2.7.1&quot;},
</I>&gt;<i>       {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.4&quot;},
</I>&gt;<i>       {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.8&quot;},
</I>&gt;<i>       {rabbitmq_mochiweb,&quot;RabbitMQ Mochiweb Embedding&quot;,&quot;2.7.1&quot;},
</I>&gt;<i>       {webmachine,&quot;webmachine&quot;,&quot;1.7.0-rmq2.7.1-hg&quot;},
</I>&gt;<i>       {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;1.3-rmq2.7.1-git&quot;},
</I>&gt;<i>       {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.2&quot;},
</I>&gt;<i>       {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.4.12&quot;},
</I>&gt;<i>       {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.16.4&quot;},
</I>&gt;<i>       {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.13.4&quot;}]},
</I>&gt;<i>  {os,{unix,linux}},
</I>&gt;<i>  {erlang_version,
</I>&gt;<i>      &quot;Erlang R13B03 (erts-5.7.4) [source] [64-bit] [smp:2:2] [rq:2]
</I>&gt;<i> [async-threads:0] [hipe] [kernel-poll:false]\n&quot;},
</I>&gt;<i>  {memory,
</I>&gt;<i>      [{total,92565608},
</I>&gt;<i>       {processes,4004968},
</I>&gt;<i>       {processes_used,3996224},
</I>&gt;<i>       {system,88560640},
</I>&gt;<i>       {atom,1322033},
</I>&gt;<i>       {atom_used,1291462},
</I>&gt;<i>       {binary,32496},
</I>&gt;<i>       {code,15264387},
</I>&gt;<i>       {ets,1174192}]},
</I>&gt;<i>  {vm_memory_high_watermark,0.3999999999362281},
</I>&gt;<i>  {vm_memory_limit,2508940902}]
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> rabbitmqctl cluster_status
</I>&gt;<i> Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>' ...
</I>&gt;<i> [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-0000001a-zsm</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>']},
</I>&gt;<i>          {ram,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000009-asm</A>']}]},
</I>&gt;<i>  {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-0000001a-zsm</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>']}]
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *
</I>&gt;<i> Java amqp-client 2.7.1*
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> - Producer.groovy (java amqp-client 2.7.1)
</I>&gt;<i>
</I>&gt;<i> import com.rabbitmq.client.*
</I>&gt;<i> try{
</I>&gt;<i>
</I>&gt;<i> // Get rabbitmq config
</I>&gt;<i> def config = new ConfigSlurper().parse(new
</I>&gt;<i> File('../rabbitmq.properties').toURL())
</I>&gt;<i>
</I>&gt;<i> def rabbit = new RabbitHA(config)
</I>&gt;<i> rabbit.init = { channel -&gt;
</I>&gt;<i>   channel.exchangeDeclare('myExchange', &quot;direct&quot;, true) // Durable exchange
</I>&gt;<i>   channel.queueDeclare('myQueue', true, false, false, [&quot;x-ha-policy&quot;:
</I>&gt;<i> &quot;all&quot;]) // Durable exchange and HA policy
</I>&gt;<i>   channel.queueBind('myQueue', 'myExchange', '')
</I>&gt;<i>   channel.confirmSelect()
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> 10000.times { idx -&gt;
</I>&gt;<i>   rabbit.publish { channel -&gt;
</I>&gt;<i>     def properties = new
</I>&gt;<i> AMQP.BasicProperties.Builder().deliveryMode(2).build() // Delivery mode 2:
</I>&gt;<i> persistent
</I>&gt;<i>     def msg = &quot;Message $idx&quot;
</I>&gt;<i>     channel.basicPublish('myExchange', '', properties, msg.getBytes())
</I>&gt;<i>     println msg
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> rabbit.close()
</I>&gt;<i>
</I>&gt;<i> } catch(e){e.printStackTrace()}
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> - Consumer.groovy
</I>&gt;<i>
</I>&gt;<i> import com.rabbitmq.client.*
</I>&gt;<i>
</I>&gt;<i> try{
</I>&gt;<i>
</I>&gt;<i>   // Get rabbitmq config
</I>&gt;<i>   def config = new ConfigSlurper().parse(new
</I>&gt;<i> File('../rabbitmq.properties').toURL())
</I>&gt;<i>
</I>&gt;<i>   // Connect
</I>&gt;<i>   def rabbit = new RabbitHA(config)
</I>&gt;<i>   rabbit.onDelivery('myQueue'){ delivery, channel -&gt;
</I>&gt;<i>   def msg = new String(delivery.body)
</I>&gt;<i>   println msg
</I>&gt;<i>
</I>&gt;<i>   // Manual ack
</I>&gt;<i>   channel.basicAck(delivery.envelope.deliveryTag, false)
</I>&gt;<i>
</I>&gt;<i> } catch(e){e.printStackTrace()}
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> - RabbitHA.groovy
</I>&gt;<i>
</I>&gt;<i> import com.rabbitmq.client.*
</I>&gt;<i>
</I>&gt;<i> /**
</I>&gt;<i>  *
</I>&gt;<i>  * RabbitMQ highly available proxy.
</I>&gt;<i>  * Basic implementation of a basic suscriber/publisher with reconnect
</I>&gt;<i> logic.
</I>&gt;<i>  *
</I>&gt;<i>  */
</I>&gt;<i> class RabbitHA {
</I>&gt;<i>     ConnectionFactory connectionFactory
</I>&gt;<i>     Address[] addresses
</I>&gt;<i>     Closure init
</I>&gt;<i>
</I>&gt;<i>     Connection connection
</I>&gt;<i>     Channel channel
</I>&gt;<i>     QueueingConsumer consumer
</I>&gt;<i>
</I>&gt;<i>     public RabbitHA(Map config) {
</I>&gt;<i>         this(config, null)
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     public RabbitHA(Map config, Closure init){
</I>&gt;<i>         this.connectionFactory = new ConnectionFactory([username:
</I>&gt;<i> config.username, password: config.password, virtualHost:
</I>&gt;<i> config.virtualHost])
</I>&gt;<i>         this.addresses = Address.parseAddresses(config.addresses)
</I>&gt;<i>         this.init = init
</I>&gt;<i>         connectChannel()
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     void onDelivery(String queueName, Closure closure) {
</I>&gt;<i>         basicConsume(queueName)
</I>&gt;<i>         int i = 0
</I>&gt;<i>
</I>&gt;<i>         while(true) {
</I>&gt;<i>             try {
</I>&gt;<i>                 QueueingConsumer.Delivery delivery =
</I>&gt;<i> consumer.nextDelivery()
</I>&gt;<i>                 closure(delivery, channel)
</I>&gt;<i>                 i = 0
</I>&gt;<i>             } catch(e) {
</I>&gt;<i>                 // Only handle exceptions
</I>&gt;<i>                 if(!(e in ShutdownSignalException || e in IOException ||
</I>&gt;<i> e in AlreadyClosedException)) throw e
</I>&gt;<i>
</I>&gt;<i>                 i++
</I>&gt;<i>                 e.printStackTrace()
</I>&gt;<i>                 println &quot;ShutdownSignalException recieved! Reconnection
</I>&gt;<i> attempt #$i&quot;
</I>&gt;<i>                 connectChannel()
</I>&gt;<i>                 basicConsume(queueName)
</I>&gt;<i>             }
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     void publish(Closure closure) {
</I>&gt;<i>         int i = 0
</I>&gt;<i>         boolean retry = true
</I>&gt;<i>         while(retry) {
</I>&gt;<i>             try {
</I>&gt;<i>                 closure(channel)
</I>&gt;<i>                 i = 0
</I>&gt;<i>                 retry = false
</I>&gt;<i>             } catch(e) {
</I>&gt;<i>                 // Only handle exceptions
</I>&gt;<i>                 if(!(e in ShutdownSignalException || e in IOException ||
</I>&gt;<i> e in AlreadyClosedException)) throw e
</I>&gt;<i>
</I>&gt;<i>                 i++
</I>&gt;<i>                 retry = true
</I>&gt;<i>                 e.printStackTrace()
</I>&gt;<i>                 println &quot;ShutdownSignalException recieved! Reconnection
</I>&gt;<i> attempt #$i&quot;
</I>&gt;<i>                 connectChannel()
</I>&gt;<i>             }
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     void connectChannel() {
</I>&gt;<i>         connection = connectionFactory.newConnection(addresses)
</I>&gt;<i>         channel = connection.createChannel()
</I>&gt;<i>
</I>&gt;<i>         println &quot;Succesfully connected to $connection.address&quot;
</I>&gt;<i>
</I>&gt;<i>         if(init) {
</I>&gt;<i>             init(channel)
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     void basicConsume(queueName) {
</I>&gt;<i>         consumer = new QueueingConsumer(channel)
</I>&gt;<i>         channel.basicConsume(queueName, false, consumer)
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     void close() {
</I>&gt;<i>         channel.waitForConfirmsOrDie()
</I>&gt;<i>         channel.close()
</I>&gt;<i>         connection.close()
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Output:
</I>&gt;<i>
</I>&gt;<i> cat consumer-output.txt |grep Message | wc
</I>&gt;<i>    9957   19914  128330
</I>&gt;<i>
</I>&gt;<i> cat producer-output.txt | grep Message | wc
</I>&gt;<i>   10000   20000  128890
</I>&gt;<i>
</I>&gt;<i> *Note that consumer lost 43 messages*
</I>&gt;<i>
</I>&gt;<i> Output from producer :
</I>&gt;<i> ...
</I>&gt;<i> Message 1466
</I>&gt;<i> Message 1467
</I>&gt;<i> Message 1468
</I>&gt;<i> Message 1469
</I>&gt;<i> Message 1470
</I>&gt;<i> ShutdownSignalException recieved! Reconnection attempt #1
</I>&gt;<i> Succesfully connected to i-0000001a-zsm/172.16.158.46
</I>&gt;<i> Message 1471
</I>&gt;<i> Message 1472
</I>&gt;<i> Message 1473
</I>&gt;<i> Message 1474
</I>&gt;<i> Message 1475
</I>&gt;<i> Message 1476
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> *
</I>&gt;<i> Note messages [1471..1476] were consumed ok, but [1466..1470] are missing
</I>&gt;<i> in consumer output.*
</I>&gt;<i>
</I>&gt;<i> The complete outputs are in
</I>&gt;<i> <A HREF="https://github.com/pablomolnar/rabbitmq_samples/tree/master/out.">https://github.com/pablomolnar/rabbitmq_samples/tree/master/out.</A> There
</I>&gt;<i> you can see reconnection log of both parts.
</I>&gt;<i> I've a strong feeling the publisher confirms is not well configured.
</I>&gt;<i>
</I>&gt;<i> Please anyone could shed some light on the issue?
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Pablo Molnar
</I>&gt;<i>
</I>&gt;<i> PD: Also I take the opportunity to share a lot of groovy examples I've
</I>&gt;<i> been working in the last days:
</I>&gt;<i> <A HREF="https://github.com/pablomolnar/rabbitmq_samples">https://github.com/pablomolnar/rabbitmq_samples</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120201/92cc3e5b/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120201/92cc3e5b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017827.html">[rabbitmq-discuss] Lost messages in HA tests in a cluster
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17828">[ date ]</a>
              <a href="thread.html#17828">[ thread ]</a>
              <a href="subject.html#17828">[ subject ]</a>
              <a href="author.html#17828">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
