<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20server%20performance%20issue%20%28erl.exe%29&In-Reply-To=%3Cf69e4587-0af7-46a7-896c-755730763a5c%40c9g2000pbh.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017712.html">
   <LINK REL="Next"  HREF="017642.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)</H1>
    <B>Yogesh Ketkar</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20server%20performance%20issue%20%28erl.exe%29&In-Reply-To=%3Cf69e4587-0af7-46a7-896c-755730763a5c%40c9g2000pbh.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)">yogimogi at gmail.com
       </A><BR>
    <I>Fri Jan 27 12:49:28 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017712.html">[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)
</A></li>
        <LI>Next message: <A HREF="017642.html">[rabbitmq-discuss] RabbitMQ/Shovel &amp; Compression
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17717">[ date ]</a>
              <a href="thread.html#17717">[ thread ]</a>
              <a href="subject.html#17717">[ subject ]</a>
              <a href="author.html#17717">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> You said in your original message that there would only ever be 100 queues
</I>Actually this is my test-bed. I wouldn't bother deleting the queues if
there were only 100.
Real life scenario, there could be thousands of queues with 5 to 10
messages on
each queue. And that is why I want to delete a queue, once all the
messages on it are consumed.

&gt;<i> It's not clear when call() gets called but
</I>call() gets called by ExecutorService.

&gt;<i> You are declaring and binding queues on every delivery,
</I>I don't have a choice, when delivery of message happens, destination
queue might have been deleted.
Is there a way in client API to find out
- If queue is already declared
- Is there a binding to the queue?

&gt;<i> <A HREF="http://www.rabbitmq.com/extensions.html#queue-leases">http://www.rabbitmq.com/extensions.html#queue-leases</A>
</I>I had thought about this, but with x-expires, queues get deleted even
if they have
messages.

&gt;<i> <A HREF="http://www.rabbitmq.com/api-guide.html#tracer">http://www.rabbitmq.com/api-guide.html#tracer</A>
</I>I will and try and debug using this.

I will try and give you runnable code by removing all the scaffolding
code.

regards, Yogesh


On Jan 27, 4:48&#160;pm, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">si... at rabbitmq.com</A>&gt; wrote:
&gt;<i> I can't run code that is incomplete :-) but some things stand out:
</I>&gt;<i>
</I>&gt;<i> You are declaring and binding queues on every delivery, and then
</I>&gt;<i> deleting them shortly after as well. On a system where a lot's going on
</I>&gt;<i> in parallel this might lead to lots of retried transactions, which could
</I>&gt;<i> lead to high CPU use. It's not clear when call() gets called but if that
</I>&gt;<i> is in a tight loop then you could be declaring and immediately deleting
</I>&gt;<i> queues constantly.
</I>&gt;<i>
</I>&gt;<i> You said in your original message that there would only ever be 100
</I>&gt;<i> queues - if that is the case then can they just be created once? Or use
</I>&gt;<i> &#160; queue leases (<A HREF="http://www.rabbitmq.com/extensions.html#queue-leases">http://www.rabbitmq.com/extensions.html#queue-leases</A>) to
</I>&gt;<i> make sure they get tidied up after some period of inactivity?
</I>&gt;<i>
</I>&gt;<i> You might want to connect your application through the Tracer
</I>&gt;<i> (<A HREF="http://www.rabbitmq.com/api-guide.html#tracer">http://www.rabbitmq.com/api-guide.html#tracer</A>) to see what is happening
</I>&gt;<i> at the protocol level.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> On 27/01/12 08:52, Yogesh Ketkar wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Hello Simon,
</I>&gt;<i> &gt; This is how code looks like
</I>&gt;<i> &gt; main(String[] argv) {
</I>&gt;<i> &gt; &#160; &#160; &#160;// Read messages from MainQueue
</I>&gt;<i> &gt; &#160; &#160; &#160;Channel ch = c.createChannel();
</I>&gt;<i> &gt; &#160; &#160; &#160;ch.basicConsume(&quot;MainQueue&quot;, false, &quot;&quot;, new
</I>&gt;<i> &gt; MainQueueConsumer(ch));
</I>&gt;<i>
</I>&gt;<i> &gt; &#160; &#160; &#160;// Read messages from dynamically declared queues
</I>&gt;<i> &gt; &#160; &#160; &#160;ExecutorService es = Executors.newFixedThreadPool(tpSize);
</I>&gt;<i> &gt; &#160; &#160; &#160;Collection&lt;QueueProcessor&gt; &#160;vAppProcessorCollection = new
</I>&gt;<i> &gt; ArrayList&lt;QueueProcessor&gt;();
</I>&gt;<i> &gt; &#160; &#160; &#160;while(true) {
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;// Get the queues currently present using
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;// <A HREF="http://&lt;rabbitmq-server">http://&lt;rabbitmq-server</A>&gt;:55672/api/queues/%2f/
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;List&lt;String&gt; &#160;qs = AMQPUtil.getvAppQueues();
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;vAppProcessorCollection.clear();
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;for(String q : qs) {
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160;QueueProcessor p = new QueueProcessor(c, q);
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160;vAppProcessorCollection.add(p);
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;}
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;es.invokeAll(vAppProcessorCollection);
</I>&gt;<i> &gt; &#160; &#160; &#160;}
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt; MainQueueConsumer, in handleDelivery does something like
</I>&gt;<i> &gt; public void handleDelivery() {
</I>&gt;<i> &gt; &#160; &#160; &#160;// Get Queue name from payload
</I>&gt;<i> &gt; &#160; &#160; &#160;c.queueDeclare(queueName, true, false, false,
</I>&gt;<i> &gt; getQueueProperties());
</I>&gt;<i> &gt; &#160; &#160; &#160;c.queueBind(queueName, exchange, routingKey);
</I>&gt;<i> &gt; &#160; &#160; &#160;c.basicPublish(exchange, routingKey, props, body);
</I>&gt;<i> &gt; &#160; &#160; &#160;ch.basicAck(envelope.getDeliveryTag(), false);
</I>&gt;<i> &gt; }
</I>&gt;<i>
</I>&gt;<i> &gt; And QueueProcessor does this in call() method
</I>&gt;<i> &gt; public Boolean call() {
</I>&gt;<i> &gt; &#160; &#160; &#160;try {
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;Channel ch = c.createChannel();
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;while(true) {
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160;GetResponse r = ch.basicGet(queue, false);
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160;if(r != null) {
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;// process message
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ch.basicAck(r.getEnvelope().getDeliveryTag(), false);
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160;} else break;
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;}
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;Util.queueDelete(ch, queue, true, true);
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;if(ch.isOpen()) ch.close();
</I>&gt;<i> &gt; &#160; &#160; &#160;} catch(Throwable th) {
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160;BaseUtil.logException(logger, th);
</I>&gt;<i> &gt; &#160; &#160; &#160;}
</I>&gt;<i> &gt; }
</I>&gt;<i>
</I>&gt;<i> &gt; Just couple of things
</I>&gt;<i> &gt; - If I don't delete the queue in call() method, things are much better
</I>&gt;<i> &gt; &#160; &#160;and I am even able to 50000 messages on MainQueue without much
</I>&gt;<i> &gt; issues
</I>&gt;<i> &gt; - Ideally I would like to get rid of while(true) { ... basicGet ... }.
</I>&gt;<i> &gt; &#160; &#160;Is there any pattern where I can do
</I>&gt;<i> &gt; &#160; &#160;basicConsume() on the dynamically generated queue and
</I>&gt;<i> &gt; &#160; &#160;remove the consumer and the queue when number of message on it are 0
</I>&gt;<i>
</I>&gt;<i> &gt; regards, Yogesh
</I>&gt;<i>
</I>&gt;<i> &gt; On Jan 25, 7:23 pm, Simon MacMullen&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">si... at rabbitmq.com</A>&gt; &#160;wrote:
</I>&gt;<i> &gt;&gt; On 25/01/12 08:30, Yogesh Ketkar wrote:
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; Any clues how to debug this?
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; That sounds odd. 10k messages should be nothing.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; Can you share your code somehow so I can try to replicate this?
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; --
</I>&gt;<i> &gt;&gt; Simon MacMullen
</I>&gt;<i> &gt;&gt; RabbitMQ, VMware
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt;&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, VMware
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017712.html">[rabbitmq-discuss] RabbitMQ server performance issue (erl.exe)
</A></li>
	<LI>Next message: <A HREF="017642.html">[rabbitmq-discuss] RabbitMQ/Shovel &amp; Compression
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17717">[ date ]</a>
              <a href="thread.html#17717">[ thread ]</a>
              <a href="subject.html#17717">[ subject ]</a>
              <a href="author.html#17717">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
