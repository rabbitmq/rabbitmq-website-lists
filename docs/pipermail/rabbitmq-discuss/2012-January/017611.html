<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mnesia crash after RabbitMQ node machine restart (clustered)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mnesia%20crash%20after%20RabbitMQ%20node%20machine%0A%20restart%20%28clustered%29&In-Reply-To=%3C4F1E91B7.7040605%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017605.html">
   <LINK REL="Next"  HREF="017606.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mnesia crash after RabbitMQ node machine restart (clustered)</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mnesia%20crash%20after%20RabbitMQ%20node%20machine%0A%20restart%20%28clustered%29&In-Reply-To=%3C4F1E91B7.7040605%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Mnesia crash after RabbitMQ node machine restart (clustered)">simon at rabbitmq.com
       </A><BR>
    <I>Tue Jan 24 11:10:47 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017605.html">[rabbitmq-discuss] Mnesia crash after RabbitMQ node machine restart	(clustered)
</A></li>
        <LI>Next message: <A HREF="017606.html">[rabbitmq-discuss] WCF bindings connection drop outs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17611">[ date ]</a>
              <a href="thread.html#17611">[ thread ]</a>
              <a href="subject.html#17611">[ subject ]</a>
              <a href="author.html#17611">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We could probably do with better error reporting / handling in this 
case, but I think this is what happened (certainly I did this and saw 
the same errors)...

* Build a cluster with node1 = disc and node2 = ram
* Stop both nodes
* Start node2 *first*

At this point node2 does not have any disc nodes to catch up from... so 
it initialises a fresh copy of the mnesia database in RAM and starts up 
by itself.

* Start node1

At this point node1 knows that it needs to cluster with node2, but node2 
doesn't agree, and has a different version of the database anyway. Hence 
the error message.

At this point I was able to recover by stopping node2 again, and 
starting node1 first, then node2.

I'll file a bug to make the errors clearer in this case, but for the 
time being you should make sure to always bring at least one disc node 
up first in any cluster.

In your case you should consider switching to a cluster with two disc 
nodes anyway - only having one disc node is a SPOF.

Cheers, Simon

On 24/01/12 09:32, LuCo wrote:
&gt;<i> Hello.
</I>&gt;<i>
</I>&gt;<i> We have a RabbitMQ cluster across 2 machines. Machine 1 is created as
</I>&gt;<i> a disc node, and Machine 2 as a memory node.
</I>&gt;<i>
</I>&gt;<i> These machines are restarted on the weekend every week. This has not
</I>&gt;<i> been a problem over the last 5 weeks (since trialling RabbitMQ) and
</I>&gt;<i> during this time the nodes have been little used, however the weekend
</I>&gt;<i> just passed resulted in the error below on the disc node just after
</I>&gt;<i> the machine on which the node runs was restarted:
</I>&gt;<i>
</I>&gt;<i> &quot;
</I>&gt;<i> =ERROR REPORT==== 22-Jan-2012::01:17:37 ===
</I>&gt;<i> Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE1</A>'): ** ERROR ** (core dumped to file: &quot;c:/
</I>&gt;<i> Documents and Settings/user/Application Data/RabbitMQ/
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">MnesiaCore.rabbit at MACHINE1_1327_195058_860060</A>&quot;)
</I>&gt;<i>   ** FATAL ** Failed to merge schema: Bad cookie in table definition
</I>&gt;<i> mirrored_sup_childspec: '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE1</A>' =
</I>&gt;<i> {cstruct,mirrored_sup_childspec,ordered_set,
</I>&gt;<i> ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE2</A>,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE1</A>'],[],[],0,read_write,false,[],
</I>&gt;<i> [],false,mirrored_sup_childspec,[key,mirroring_pid,childspec],[],[],
</I>&gt;<i> {{1324,33984,878002},'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE1</A>'},{{5,0},{'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE2</A>',
</I>&gt;<i> {1324,34466,491790}}}}, '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE2</A>' =
</I>&gt;<i> {cstruct,mirrored_sup_childspec,ordered_set,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE2</A>'],[],[],
</I>&gt;<i> 0,read_write,false,[],[],false,mirrored_sup_childspec,
</I>&gt;<i> [key,mirroring_pid,childspec],[],[],
</I>&gt;<i> {{1327,194914,615072},'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MACHINE2</A>'},{{2,0},[]}}
</I>&gt;<i> =ERROR REPORT==== 22-Jan-2012::01:17:44 ===
</I>&gt;<i> ** Generic server mnesia_subscr terminating
</I>&gt;<i> ** Last message in was {'EXIT',&lt;0.51.0&gt;,killed}
</I>&gt;<i> ** When Server state == {state,&lt;0.51.0&gt;,57361}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** killed
</I>&gt;<i> =ERROR REPORT==== 22-Jan-2012::01:17:44 ===
</I>&gt;<i> ** Generic server mnesia_monitor terminating
</I>&gt;<i> ** Last message in was {'EXIT',&lt;0.51.0&gt;,killed}
</I>&gt;<i> ** When Server state == {state,&lt;0.51.0&gt;,[],[],true,[],undefined,[]}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** killed
</I>&gt;<i> =ERROR REPORT==== 22-Jan-2012::01:17:44 ===
</I>&gt;<i> ** Generic server mnesia_recover terminating
</I>&gt;<i> ** Last message in was {'EXIT',&lt;0.51.0&gt;,killed}
</I>&gt;<i> ** When Server state == {state,&lt;0.51.0&gt;,undefined,undefined,undefined,
</I>&gt;<i> 0,false,
</I>&gt;<i>                                 true,[]}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** killed
</I>&gt;<i> =ERROR REPORT==== 22-Jan-2012::01:17:44 ===
</I>&gt;<i> ** Generic server mnesia_snmp_sup terminating
</I>&gt;<i> ** Last message in was {'EXIT',&lt;0.51.0&gt;,killed}
</I>&gt;<i> ** When Server state == {state,
</I>&gt;<i>                              {local,mnesia_snmp_sup},
</I>&gt;<i>                              simple_one_for_one,
</I>&gt;<i>                              [{child,undefined,mnesia_snmp_sup,
</I>&gt;<i>                                   {mnesia_snmp_hook,start,[]},
</I>&gt;<i>                                   transient,3000,worker,
</I>&gt;<i>                                   [mnesia_snmp_sup,mnesia_snmp_hook,
</I>&gt;<i>                                    supervisor]}],
</I>&gt;<i>                              undefined,0,86400000,[],mnesia_snmp_sup,
</I>&gt;<i> []}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** killed
</I>&gt;<i> =INFO REPORT==== 22-Jan-2012::01:17:44 ===
</I>&gt;<i>      application: mnesia
</I>&gt;<i>      exited: {shutdown,{mnesia_sup,start,[normal,[]]}}
</I>&gt;<i>      type: permanent
</I>&gt;<i> &quot;
</I>&gt;<i>
</I>&gt;<i> The memory node then had this error in the log just after the machine
</I>&gt;<i> on which the node runs was restarted:
</I>&gt;<i> &quot;
</I>&gt;<i> =INFO REPORT==== 22-Jan-2012::01:12:08 ===
</I>&gt;<i> node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at G1SVR2-IIS</A>' lost 'rabbit'
</I>&gt;<i> =INFO REPORT==== 22-Jan-2012::01:12:08 ===
</I>&gt;<i> Statistics database started.
</I>&gt;<i> =INFO REPORT==== 22-Jan-2012::01:15:13 ===
</I>&gt;<i> Limiting to approx 924 file handles (829 sockets)
</I>&gt;<i> =INFO REPORT==== 22-Jan-2012::01:15:14 ===
</I>&gt;<i>      application: mnesia
</I>&gt;<i>      exited: stopped
</I>&gt;<i>      type: permanent
</I>&gt;<i> =INFO REPORT==== 22-Jan-2012::01:15:14 ===
</I>&gt;<i> Memory limit set to 818MB of 2047MB total.
</I>&gt;<i> ...&lt;log continues with default initialisation of the node&gt;...
</I>&gt;<i> &quot;
</I>&gt;<i>
</I>&gt;<i> As mentioned, the nodes have been seldom used and contained only 2
</I>&gt;<i> durable queues. This crash resulted in the nodes resuming their
</I>&gt;<i> default configuration (lost previously configured users).
</I>&gt;<i>
</I>&gt;<i> The times on the machines above are the same so I am a little confused
</I>&gt;<i> at the messages on the MACHINE 2 (memory) which seems to have crashed
</I>&gt;<i> before MACHINE 1?
</I>&gt;<i>
</I>&gt;<i> I can understand why this has possibly happened (one node up/one node
</I>&gt;<i> down when attempting to cluster on restart) but why has it not
</I>&gt;<i> happened the previous 5 restarts? What actually happens on a Rabbit
</I>&gt;<i> restart (following server restart) in a cluster scenario? Do I need a
</I>&gt;<i> custom start up script to cover all bases?
</I>&gt;<i>
</I>&gt;<i> Any thoughts?
</I>&gt;<i>
</I>&gt;<i> Daniel
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>




































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017605.html">[rabbitmq-discuss] Mnesia crash after RabbitMQ node machine restart	(clustered)
</A></li>
	<LI>Next message: <A HREF="017606.html">[rabbitmq-discuss] WCF bindings connection drop outs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17611">[ date ]</a>
              <a href="thread.html#17611">[ thread ]</a>
              <a href="subject.html#17611">[ subject ]</a>
              <a href="author.html#17611">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
