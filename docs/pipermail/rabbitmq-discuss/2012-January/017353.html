<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens under Load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Windows%20RabbitMQ%20Crashes%20and%20Blue%20Screens%0A%20under%20Load&In-Reply-To=%3CCAOn7oW_jaitQT%3DXw%3DYMqVfEKfiFNRYSD2zNf69%3D5p1sog11hqQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017352.html">
   <LINK REL="Next"  HREF="017354.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens under Load</H1>
    <B>Simone Busoli</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Windows%20RabbitMQ%20Crashes%20and%20Blue%20Screens%0A%20under%20Load&In-Reply-To=%3CCAOn7oW_jaitQT%3DXw%3DYMqVfEKfiFNRYSD2zNf69%3D5p1sog11hqQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens under Load">simone.busoli at gmail.com
       </A><BR>
    <I>Thu Jan 12 18:02:41 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017352.html">[rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens under Load
</A></li>
        <LI>Next message: <A HREF="017354.html">[rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens under Load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17353">[ date ]</a>
              <a href="thread.html#17353">[ thread ]</a>
              <a href="subject.html#17353">[ subject ]</a>
              <a href="author.html#17353">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Are you acking messages? If you don't, those messages will have to be
stored somewhere and 2000 * 2MB * 1/s = 4 GB/s

On Thu, Jan 12, 2012 at 18:55, &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">james.poole at rsa.com</A>&gt; wrote:

&gt;<i> Simone, that would be great if you could try to reproduce it.****
</I>&gt;<i>
</I>&gt;<i> ** **
</I>&gt;<i>
</I>&gt;<i> As mentioned, we are creating 2000 consumers each with their own queue
</I>&gt;<i> bound to a fanout exchange.  After the queues have all been created and
</I>&gt;<i> bound, a producer publishes a 2 MB message to this fanout exchange once
</I>&gt;<i> every second for 50 seconds.****
</I>&gt;<i>
</I>&gt;<i> ** **
</I>&gt;<i>
</I>&gt;<i> All queues are non-durable.  And autoAck was set to false in the Java
</I>&gt;<i> client.****
</I>&gt;<i>
</I>&gt;<i> ** **
</I>&gt;<i>
</I>&gt;<i> Everything hums along until the vm_memory_high_watermark is triggered and
</I>&gt;<i> then we see the crash.  One interesting thing is that in the log it still
</I>&gt;<i> shows it accepting and starting tcp connections after the memory alarm is
</I>&gt;<i> triggered (for around 15 seconds before the crash).  I thought this was
</I>&gt;<i> supposed to block until the memory was under control?****
</I>&gt;<i>
</I>&gt;<i> ** **
</I>&gt;<i>
</I>&gt;<i> -James****
</I>&gt;<i>
</I>&gt;<i> ** **
</I>&gt;<i>
</I>&gt;<i> *From:* Simone Busoli [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simone.busoli at gmail.com</A>]
</I>&gt;<i> *Sent:* Wednesday, January 11, 2012 3:02 PM
</I>&gt;<i> *To:* Poole, James
</I>&gt;<i> *Cc:* <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>; Kuch, Jerry (VMware)
</I>&gt;<i>
</I>&gt;<i> *Subject:* Re: [rabbitmq-discuss] Windows RabbitMQ Crashes and Blue
</I>&gt;<i> Screens under Load****
</I>&gt;<i>
</I>&gt;<i> ** **
</I>&gt;<i>
</I>&gt;<i> Hi James,****
</I>&gt;<i>
</I>&gt;<i> If you can provide more details about the load you're applying to the
</I>&gt;<i> broker I would be glad to try to reproduce it.
</I>&gt;<i> We've been using RabbitMQ on Windows in production for some months now and
</I>&gt;<i> didn't experience any weird behavior.
</I>&gt;<i> What I'm interested in is whether entities and messages are durable, if
</I>&gt;<i> you use transactions or publisher confirms and the like.****
</I>&gt;<i>
</I>&gt;<i> On Jan 11, 2012 7:52 PM, &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">james.poole at rsa.com</A>&gt; wrote:****
</I>&gt;<i>
</I>&gt;<i> Yeah, I should have mentioned that we started out testing with the 64-bit
</I>&gt;<i> version and found this issue... though the VM probably didn't have very
</I>&gt;<i> much more memory than a 32-bit address space would provide.  Then we backed
</I>&gt;<i> down to the 32-bit version to see if it went away, but it didn't.
</I>&gt;<i>
</I>&gt;<i> I will see if we can send out the test program (it's just a simple java
</I>&gt;<i> app using the rabbitmq-java-client-2.7.1).  If I can send it out, how would
</I>&gt;<i> I go about this... attach to the email or upload it to a server somewhere?
</I>&gt;<i>
</I>&gt;<i> -James
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Jerry Kuch [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at vmware.com</A>]
</I>&gt;<i> Sent: Wednesday, January 11, 2012 1:44 PM
</I>&gt;<i> To: Poole, James
</I>&gt;<i> Cc: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens
</I>&gt;<i> under Load
</I>&gt;<i>
</I>&gt;<i> James:  Out of curiousity have you tried the new 64-bit release of
</I>&gt;<i> Erlang for Windows in your environment?  The address space size
</I>&gt;<i> limitations of the 32-bit version have been associated with crashy
</I>&gt;<i> Rabbits in the past (although bringing your memory high watermark
</I>&gt;<i> value down so that the back-pressure mechanisms engage when the
</I>&gt;<i> broker is in less trouble may help).  I think you can scare up the
</I>&gt;<i> new Erlang here:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.erlang.org/download/otp_win64_R15B.exe">http://www.erlang.org/download/otp_win64_R15B.exe</A>
</I>&gt;<i>
</I>&gt;<i> Until recently there was no 64-bit Erlang, so even those running on
</I>&gt;<i> 64-bit Windows boxes were still relegated to 32-bit VMs.
</I>&gt;<i>
</I>&gt;<i> I am curious about the different results between a physical machine
</I>&gt;<i> and a virtualized one, with one showing a &quot;clean&quot; Erlang VM crash and
</I>&gt;<i> the other exhibiting a blue-screen, fatal OS-wrecker...
</I>&gt;<i>
</I>&gt;<i> Is the traffic you're using to bring these systems down part of a
</I>&gt;<i> large or proprietary app, or can you extract a bare minimum piece
</I>&gt;<i> of code that brings the pain and share it with us?  If you could
</I>&gt;<i> do the latter we could more easily investigate the situation within
</I>&gt;<i> VMware since the difference in behavior between baremetal and
</I>&gt;<i> virtualization is disquieting...
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Jerry
</I>&gt;<i>
</I>&gt;<i> ----- Original Message -----
</I>&gt;<i> From: &quot;james poole&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">james.poole at rsa.com</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> Sent: Wednesday, January 11, 2012 10:32:23 AM
</I>&gt;<i> Subject: [rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens
</I>&gt;<i> under     Load
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> We&#8217;ve let loose one of our testing ninjas on RabbitMQ for load testing,
</I>&gt;<i> and we&#8217;re consistently running into issues when the high memory watermark
</I>&gt;<i> is hit.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Windows Server 2003 32-bit , Erlang R15B 32-bit, Rabbit 2.7.1
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2,000 Consumers each with their own queue bound to a direct exchange
</I>&gt;<i>
</I>&gt;<i> 1 Producer, publishing a 2 MB message to the exchange, once every second,
</I>&gt;<i> for a total of 50 seconds
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Everything behaves as expected, until the memory footprint hits the high
</I>&gt;<i> watermark, at which point:
</I>&gt;<i>
</I>&gt;<i> On a physical machine: ERL process crashes and dump file is created
</I>&gt;<i>
</I>&gt;<i> On a Virtual Machine: Blue Screen of Death is shown and server reboots
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> VM environment = VMware, Inc.&#174; vCenter Lab Manager 4.0 (4.0.3.1318)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> One other note is that we see the same problem with ERL R14B04 and Rabbit
</I>&gt;<i> 2.7.0.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have looked through the log file and also turned on the console debug
</I>&gt;<i> output, and nothing seems to be jumping out as an error. If needed, I can
</I>&gt;<i> upload the minidump from the Blue Screen and the ERL crash dump file, just
</I>&gt;<i> point me where to do it.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Let me know if there is anything else I can do to try and help get this
</I>&gt;<i> fixed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In the rabbit log, there are no errors, and only a few warnings 20 seconds
</I>&gt;<i> before the crash:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 11-Jan-2012::10:55:53 ===
</I>&gt;<i>
</I>&gt;<i> closing TCP connection &lt;0.4405.0&gt; from 10.6.64.104:57830
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> =WARNING REPORT==== 11-Jan-2012::10:55:53 ===
</I>&gt;<i>
</I>&gt;<i> exception on TCP connection &lt;0.20552.0&gt; from 10.6.64.104:59521
</I>&gt;<i>
</I>&gt;<i> connection_closed_abruptly
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In the console output log file for the physical machine, this is the only
</I>&gt;<i> message I see:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> starting direct_client ...done
</I>&gt;<i>
</I>&gt;<i> starting notify cluster nodes ...done
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> broker running
</I>&gt;<i>
</I>&gt;<i> Eshell V5.9 (abort with ^G)
</I>&gt;<i>
</I>&gt;<i> (<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at QEDLP082</A>)1&gt;
</I>&gt;<i>
</I>&gt;<i> Crash dump was written to: C:/Documents and
</I>&gt;<i> Settings/Administrator.QEDLP/Application Data/RabbitMQ/erl_crash.dump
</I>&gt;<i>
</I>&gt;<i> eheap_alloc: Cannot allocate 6731340 bytes of memory (of type &quot;heap&quot;).
</I>&gt;<i>
</I>&gt;<i> in message_loop
</I>&gt;<i>
</I>&gt;<i> win32sysinfo:Erlang has closed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss****">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss****</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120112/c025f33d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120112/c025f33d/attachment.htm</A>&gt;
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017352.html">[rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens under Load
</A></li>
	<LI>Next message: <A HREF="017354.html">[rabbitmq-discuss] Windows RabbitMQ Crashes and Blue Screens under Load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17353">[ date ]</a>
              <a href="thread.html#17353">[ thread ]</a>
              <a href="subject.html#17353">[ subject ]</a>
              <a href="author.html#17353">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
