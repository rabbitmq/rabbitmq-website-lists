<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Publishing to or consuming from a node that's	mirroring queues fails
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Publishing%20to%20or%20consuming%20from%20a%20node%20that%27s%0A%09mirroring%20queues%20fails&In-Reply-To=%3C2475AAC4-5E03-4122-8834-F16449803658%40rosettastone.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017645.html">
   <LINK REL="Next"  HREF="017663.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Publishing to or consuming from a node that's	mirroring queues fails</H1>
    <B>Urie, Ethan</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Publishing%20to%20or%20consuming%20from%20a%20node%20that%27s%0A%09mirroring%20queues%20fails&In-Reply-To=%3C2475AAC4-5E03-4122-8834-F16449803658%40rosettastone.com%3E"
       TITLE="[rabbitmq-discuss] Publishing to or consuming from a node that's	mirroring queues fails">eurie at rosettastone.com
       </A><BR>
    <I>Wed Jan 25 14:45:31 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017645.html">[rabbitmq-discuss] RabbitMQ/Shovel &amp; Compression
</A></li>
        <LI>Next message: <A HREF="017663.html">[rabbitmq-discuss] Publishing to or consuming from a node that's mirroring queues fails
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17655">[ date ]</a>
              <a href="thread.html#17655">[ thread ]</a>
              <a href="subject.html#17655">[ subject ]</a>
              <a href="author.html#17655">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,
I'm attempting to set up a 2-node cluster with mirrored queues. I've tried it twice with different machines and have seen the same result.

My first attempt was with 2 Macs running 10.6.8 and Rabbit 2.7.1 with Erlang R15B.

I was able to successfully cluster the two machines, and verified that the queues were mirrored via the admin and rabbitmqctl. 

In my test, I had one exchange (fanout) with one queue that was declared with x-ha-policy = all. The exchange and queue were declared by a consumer connecting to node 1 after the nodes were clustered and both were running. 

Publishing and consuming work fine when connecting to node 1. However, if I connect to node 2, published messages don't show up in the queue and I get no error messages on the publisher or the logs. 

Connecting a consumer to node 2, however, causes the connection to error out. The following shows up in the logs:

=ERROR REPORT==== 25-Jan-2012::09:10:48 ===
** Generic server &lt;0.29257.1&gt; terminating
** Last message in was {'$gen_cast',
                          {method,
                              {'queue.declare',0,&lt;&lt;&quot;RaiderAgent&quot;&gt;&gt;,false,
                                  true,false,false,false,
                                  [{&lt;&lt;&quot;x-ha-policy&quot;&gt;&gt;,longstr,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
                              none}}
** When Server state == {ch,running,rabbit_framing_amqp_0_9_1,1,&lt;0.29253.1&gt;,
                           &lt;0.29255.1&gt;,&lt;0.29253.1&gt;,
                           {token,&lt;0.29256.1&gt;,false},
                           none,1,
                           {[],[]},
                           {[],[]},
                           [],
                           {user,&lt;&lt;&quot;sappy_development&quot;&gt;&gt;,[],
                               rabbit_auth_backend_internal,
                               {internal_user,&lt;&lt;&quot;sappy_development&quot;&gt;&gt;,
                                   &lt;&lt;45,57,22,84,184,35,204,58,106,148,26,227,
                                     153,72,42,191,26,208,27,25&gt;&gt;,
                                   []}},
                           &lt;&lt;&quot;/sappy_development&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,
                           {dict,0,16,16,8,80,48,
                               {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []},
                               {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 [],[]}}},
                           {dict,0,16,16,8,80,48,
                               {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []},
                               {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 [],[]}}},
                           {set,0,16,16,8,80,48,
                               {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []},
                               {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 [],[]}}},
                           {dict,0,16,16,8,80,48,
                               {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []},
                               {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 [],[]}}},
                           &lt;0.29251.1&gt;,
                           {state,fine,5000,#Ref&lt;0.0.0.38570&gt;},
                           false,1,
                           {0,nil},
                           {0,nil},
                           [],[],none}
** Reason for termination == 
** {{case_clause,badarg},
   [{rabbit_channel,handle_method,3},
    {rabbit_channel,handle_cast,2},
    {gen_server2,handle_msg,2},
    {proc_lib,init_p_do_apply,3}]}

=ERROR REPORT==== 25-Jan-2012::09:10:48 ===
connection &lt;0.29253.1&gt;, channel 1 - error:
{{case_clause,badarg},
[{rabbit_channel,handle_method,3},
 {rabbit_channel,handle_cast,2},
 {gen_server2,handle_msg,2},
 {proc_lib,init_p_do_apply,3}]}

=WARNING REPORT==== 25-Jan-2012::09:10:48 ===
Non-AMQP exit reason '{{case_clause,badarg},
                      [{rabbit_channel,handle_method,3},
                       {rabbit_channel,handle_cast,2},
                       {gen_server2,handle_msg,2},
                       {proc_lib,init_p_do_apply,3}]}'


If I have messages in the queue, and stop rabbit on node 1, consumers can connect and consume fine from node 2.

My understanding of how the clustering is meant to work with mirroring is that a consumer may consume from a queue regardless of what node &quot;owns&quot; it and a producer may publish to any node in the cluster and the messages get routed to the proper queues. Is this understanding wrong? Or do I have something wrong in my set up?


Thanks in advance,
Ethan

</PRE>













































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017645.html">[rabbitmq-discuss] RabbitMQ/Shovel &amp; Compression
</A></li>
	<LI>Next message: <A HREF="017663.html">[rabbitmq-discuss] Publishing to or consuming from a node that's mirroring queues fails
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17655">[ date ]</a>
              <a href="thread.html#17655">[ thread ]</a>
              <a href="subject.html#17655">[ subject ]</a>
              <a href="author.html#17655">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
