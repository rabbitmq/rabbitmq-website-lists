<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Lost messages in HA tests in a cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lost%20messages%20in%20HA%20tests%20in%20a%20cluster&In-Reply-To=%3CCANVSfpLnE%3D0%2B51PvMz7vB2L%2B3UEv-CSoNndEsC4edwy96PGOnA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017826.html">
   <LINK REL="Next"  HREF="017828.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Lost messages in HA tests in a cluster</H1>
    <B>Pablo Molnar</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lost%20messages%20in%20HA%20tests%20in%20a%20cluster&In-Reply-To=%3CCANVSfpLnE%3D0%2B51PvMz7vB2L%2B3UEv-CSoNndEsC4edwy96PGOnA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Lost messages in HA tests in a cluster">pablomolnar at gmail.com
       </A><BR>
    <I>Tue Jan 31 22:51:44 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017826.html">[rabbitmq-discuss] help required: bind function
</A></li>
        <LI>Next message: <A HREF="017828.html">[rabbitmq-discuss] Lost messages in HA tests in a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17827">[ date ]</a>
              <a href="thread.html#17827">[ thread ]</a>
              <a href="subject.html#17827">[ subject ]</a>
              <a href="author.html#17827">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all!

I'm doing some HA tests stressing my cluster and I'm experimenting lost
messages ONLY when the publisher lost the connection due a kill -9.

*Test OK*: Kill node while consuming:
1 - Setup a clean 3 node's cluster
2 - Execute producer with 10.000 messages connected to node A
3 - Wait producer to finish
4 - Execute consumer connected to node A
5 - While consumer is running kill node A

Result: The consumer reconnects to another node and consume the rest of
messages ok. All 10.000 messages were consumed ok.

*Test FAILED*: Kill node while producing:
1 - Setup a clean 3 node's cluster
2 - Execute consumer to start listening connected node A
3 - Execute producer with 10.000 messages connected to node A
4 - While producer is running kill node A

Result: The producer reconnects fine (the consumer too) and keep publishing
but some of the messages* already published* to node A are lost.


These are my settings:

rabbitmqctl status
Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>' ...
[{pid,11339},
 {running_applications,
     [{rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;2.7.1&quot;},
      {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;2.7.1&quot;},
      {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;2.7.1&quot;},
      {rabbit,&quot;RabbitMQ&quot;,&quot;2.7.1&quot;},
      {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.4&quot;},
      {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.8&quot;},
      {rabbitmq_mochiweb,&quot;RabbitMQ Mochiweb Embedding&quot;,&quot;2.7.1&quot;},
      {webmachine,&quot;webmachine&quot;,&quot;1.7.0-rmq2.7.1-hg&quot;},
      {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;1.3-rmq2.7.1-git&quot;},
      {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.2&quot;},
      {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.4.12&quot;},
      {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.16.4&quot;},
      {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.13.4&quot;}]},
 {os,{unix,linux}},
 {erlang_version,
     &quot;Erlang R13B03 (erts-5.7.4) [source] [64-bit] [smp:2:2] [rq:2]
[async-threads:0] [hipe] [kernel-poll:false]\n&quot;},
 {memory,
     [{total,92565608},
      {processes,4004968},
      {processes_used,3996224},
      {system,88560640},
      {atom,1322033},
      {atom_used,1291462},
      {binary,32496},
      {code,15264387},
      {ets,1174192}]},
 {vm_memory_high_watermark,0.3999999999362281},
 {vm_memory_limit,2508940902}]
...done.



rabbitmqctl cluster_status
Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>' ...
[{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-0000001a-zsm</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>']},
         {ram,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000009-asm</A>']}]},
 {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-0000001a-zsm</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>']}]
...done.


*
Java amqp-client 2.7.1*


- Producer.groovy (java amqp-client 2.7.1)

import com.rabbitmq.client.*
try{

// Get rabbitmq config
def config = new ConfigSlurper().parse(new
File('../rabbitmq.properties').toURL())

def rabbit = new RabbitHA(config)
rabbit.init = { channel -&gt;
  channel.exchangeDeclare('myExchange', &quot;direct&quot;, true) // Durable exchange
  channel.queueDeclare('myQueue', true, false, false, [&quot;x-ha-policy&quot;:
&quot;all&quot;]) // Durable exchange and HA policy
  channel.queueBind('myQueue', 'myExchange', '')
  channel.confirmSelect()
}

10000.times { idx -&gt;
  rabbit.publish { channel -&gt;
    def properties = new
AMQP.BasicProperties.Builder().deliveryMode(2).build() // Delivery mode 2:
persistent
    def msg = &quot;Message $idx&quot;
    channel.basicPublish('myExchange', '', properties, msg.getBytes())
    println msg
  }
}

rabbit.close()

} catch(e){e.printStackTrace()}


- Consumer.groovy

import com.rabbitmq.client.*

try{

  // Get rabbitmq config
  def config = new ConfigSlurper().parse(new
File('../rabbitmq.properties').toURL())

  // Connect
  def rabbit = new RabbitHA(config)
  rabbit.onDelivery('myQueue'){ delivery, channel -&gt;
  def msg = new String(delivery.body)
  println msg

  // Manual ack
  channel.basicAck(delivery.envelope.deliveryTag, false)

} catch(e){e.printStackTrace()}


- RabbitHA.groovy

import com.rabbitmq.client.*

/**
 *
 * RabbitMQ highly available proxy.
 * Basic implementation of a basic suscriber/publisher with reconnect logic.
 *
 */
class RabbitHA {
    ConnectionFactory connectionFactory
    Address[] addresses
    Closure init

    Connection connection
    Channel channel
    QueueingConsumer consumer

    public RabbitHA(Map config) {
        this(config, null)
    }

    public RabbitHA(Map config, Closure init){
        this.connectionFactory = new ConnectionFactory([username:
config.username, password: config.password, virtualHost:
config.virtualHost])
        this.addresses = Address.parseAddresses(config.addresses)
        this.init = init
        connectChannel()
    }

    void onDelivery(String queueName, Closure closure) {
        basicConsume(queueName)
        int i = 0

        while(true) {
            try {
                QueueingConsumer.Delivery delivery = consumer.nextDelivery()
                closure(delivery, channel)
                i = 0
            } catch(e) {
                // Only handle exceptions
                if(!(e in ShutdownSignalException || e in IOException || e
in AlreadyClosedException)) throw e

                i++
                e.printStackTrace()
                println &quot;ShutdownSignalException recieved! Reconnection
attempt #$i&quot;
                connectChannel()
                basicConsume(queueName)
            }
        }
    }

    void publish(Closure closure) {
        int i = 0
        boolean retry = true
        while(retry) {
            try {
                closure(channel)
                i = 0
                retry = false
            } catch(e) {
                // Only handle exceptions
                if(!(e in ShutdownSignalException || e in IOException || e
in AlreadyClosedException)) throw e

                i++
                retry = true
                e.printStackTrace()
                println &quot;ShutdownSignalException recieved! Reconnection
attempt #$i&quot;
                connectChannel()
            }
        }
    }


    void connectChannel() {
        connection = connectionFactory.newConnection(addresses)
        channel = connection.createChannel()

        println &quot;Succesfully connected to $connection.address&quot;

        if(init) {
            init(channel)
        }
    }

    void basicConsume(queueName) {
        consumer = new QueueingConsumer(channel)
        channel.basicConsume(queueName, false, consumer)
    }

    void close() {
        channel.waitForConfirmsOrDie()
        channel.close()
        connection.close()
    }
}



Output:

cat consumer-output.txt |grep Message | wc
   9957   19914  128330

cat producer-output.txt | grep Message | wc
  10000   20000  128890

*Note that consumer lost 43 messages*

Output from producer :
...
Message 1466
Message 1467
Message 1468
Message 1469
Message 1470
ShutdownSignalException recieved! Reconnection attempt #1
Succesfully connected to i-0000001a-zsm/172.16.158.46
Message 1471
Message 1472
Message 1473
Message 1474
Message 1475
Message 1476
...

*
Note messages [1471..1476] were consumed ok, but [1466..1470] are missing
in consumer output.*

The complete outputs are in
<A HREF="https://github.com/pablomolnar/rabbitmq_samples/tree/master/out.">https://github.com/pablomolnar/rabbitmq_samples/tree/master/out.</A> There you
can see reconnection log of both parts.
I've a strong feeling the publisher confirms is not well configured.

Please anyone could shed some light on the issue?

Cheers,
Pablo Molnar

PD: Also I take the opportunity to share a lot of groovy examples I've been
working in the last days: <A HREF="https://github.com/pablomolnar/rabbitmq_samples">https://github.com/pablomolnar/rabbitmq_samples</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120131/778556da/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120131/778556da/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017826.html">[rabbitmq-discuss] help required: bind function
</A></li>
	<LI>Next message: <A HREF="017828.html">[rabbitmq-discuss] Lost messages in HA tests in a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17827">[ date ]</a>
              <a href="thread.html#17827">[ thread ]</a>
              <a href="subject.html#17827">[ subject ]</a>
              <a href="author.html#17827">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
