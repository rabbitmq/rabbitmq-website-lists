<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Securing RabbitMQ
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Securing%20RabbitMQ&In-Reply-To=%3C20120129202348.GI3692%40southbank.Home%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017743.html">
   <LINK REL="Next"  HREF="017752.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Securing RabbitMQ</H1>
    <B>Alexandru Scvor&#355;ov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Securing%20RabbitMQ&In-Reply-To=%3C20120129202348.GI3692%40southbank.Home%3E"
       TITLE="[rabbitmq-discuss] Securing RabbitMQ">alexandru at rabbitmq.com
       </A><BR>
    <I>Sun Jan 29 20:23:48 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017743.html">[rabbitmq-discuss] Securing RabbitMQ
</A></li>
        <LI>Next message: <A HREF="017752.html">[rabbitmq-discuss] Securing RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17745">[ date ]</a>
              <a href="thread.html#17745">[ thread ]</a>
              <a href="subject.html#17745">[ subject ]</a>
              <a href="author.html#17745">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Paul,

Cool architecture.

&gt;<i> If an attacker has access to queue storage (the Mnesia directory?) 
</I>
Yes, the queues are stored in the Mnesia directory (but they're not
really a Mnesia database; it doesn't matter in this case).

&gt;<i> If an attacker has access to queue storage (the Mnesia directory?) he might be able to deconstruct the clear text messages and reconstruct spurious messages of his own making. 
</I>
I'd like to point out that if he actually has access to the machine and
rabbitmq account (and not just the disk), he could do a lot worse; for
instance, he could stop RabbitMQ, reconfigure it or replace it with
something else; or he could create new RabbitMQ users to facilitate
further attacks.  I don't think there's much you could do in this
situation.

If you're just protecting the disks, an encrypted file system is
probably the way to go.

&gt;<i> If he then had access to RabbitMQ, i.e., could connect and login to it, he could insert spurious messages into the queue.
</I>
Ok, I see.

&gt;<i> But there are other security issues here: 
</I>&gt;<i> 
</I>&gt;<i> a. securing the broker password. I routinely see the &quot;guest/guest&quot; examples where the password is stored in code. I know these are examples and, as such, provide needful and simple instruction. But in the real world, we can't be storing passwords in code. As usual, the storing/securing of keys and passwords is the hard part of security.
</I>
You could just not use passwords.  If you use SSL connections, RabbitMQ
can authenticate users by the certificate they provide.

See the auth-mechanism-ssl plugin for details:
  <A HREF="http://hg.rabbitmq.com/rabbitmq-auth-mechanism-ssl/file/default/README">http://hg.rabbitmq.com/rabbitmq-auth-mechanism-ssl/file/default/README</A>

If you still decide to use username/passwords, you could make the system
more flexible by delegating the task of authenticating users to an LDAP
server.  See the auth-backend-ldap plugin for details:
  <A HREF="http://hg.rabbitmq.com/rabbitmq-auth-backend-ldap/file/default/README">http://hg.rabbitmq.com/rabbitmq-auth-backend-ldap/file/default/README</A>

These don't solve the problem, but they make it a lot harder for an
attacker to forge user credentials.

That said, yes, securing credentials on user's systems is hard.  But is
RabbitMQ dealing with users directly here?  My understanding is that
your broker only talks to consumers that are under your control (and are
driven by events from the REST web service).  So you'd only have to
authenticate the consumers (let's call them clients from now on) and 
trust that they speak on behalf of users.

I don't think there's much you can do preventively in order to stop
a compromised consumer from sending spurious messages to the queues.
You could use the access control features to limit the damage an attacker
could cause.  See the access control guide for more details:
  <A HREF="http://www.rabbitmq.com/access-control.html">http://www.rabbitmq.com/access-control.html</A>

If it's acceptable, you could also set a TTL for messages on the queues.
That way, RabbitMQ will discard messages not consumed in some time-frame
(this is giving in to the DoS, but at least it limits the extent of the
overloaded services):
  <A HREF="http://www.rabbitmq.com/extensions.html#lifetimes">http://www.rabbitmq.com/extensions.html#lifetimes</A>

&gt;<i> b. then there's the matter of the web services themselves: they are, presumably, publicly accessible via  a web browser. If you know the URL you can try to invoke these services, whether or not you put anything in the queue via an authenticated log in.
</I>
No comments on that.  The web messaging people would be more qualified
to comment.

Cheers,
Alex

On Sun, Jan 29, 2012 at 11:58:25AM -0500, Bell, Paul M. wrote:
&gt;<i> Hi Alex,
</I>&gt;<i> 
</I>&gt;<i> Thanks very much for your instructive reply.
</I>&gt;<i> 
</I>&gt;<i> By way of background, I am working on a layered architecture. One of these layers, sitting just above the business services, is an AMQP consumer as it faces up. Facing down, it is a REST web service client. Suppose that the enqueued messages look pretty much like RESTful URIs (e.g., <A HREF="http://&lt;host">http://&lt;host</A>&gt;:&lt;port&gt;/&lt;appContextPath&gt;/users meaning something like &quot;return a list of users&quot;). The consumer pulls such a message and presents it via customary servlet container infrastructure (e.g., Tomcat + Spring) to the appropriate business service where the real work is done.
</I>&gt;<i> 
</I>&gt;<i> Such messages were produced in the first place by an authenticated user at a UI. (It is interesting to me that, despite the significant advantages of decoupling layers via a queue, the queue itself becomes almost like another login point. That is, just as input can come from the UI, input can come also from the queue.) Ideally, only an authenticated user (or process) can place messages into the queue. And that's where one of the security issues arises.
</I>&gt;<i> 
</I>&gt;<i> If an attacker has access to queue storage (the Mnesia directory?) he might be able to deconstruct the clear text messages and reconstruct spurious messages of his own making. If he then had access to RabbitMQ, i.e., could connect and login to it, he could insert spurious messages into the queue.
</I>&gt;<i> 
</I>&gt;<i> So that's why I was thinking along the lines of messages being encrypted in the queue. 
</I>&gt;<i> 
</I>&gt;<i> But there are other security issues here: 
</I>&gt;<i> 
</I>&gt;<i> a. securing the broker password. I routinely see the &quot;guest/guest&quot; examples where the password is stored in code. I know these are examples and, as such, provide needful and simple instruction. But in the real world, we can't be storing passwords in code. As usual, the storing/securing of keys and passwords is the hard part of security.
</I>&gt;<i> 
</I>&gt;<i> b. then there's the matter of the web services themselves: they are, presumably, publicly accessible via  a web browser. If you know the URL you can try to invoke these services, whether or not you put anything in the queue via an authenticated log in.
</I>&gt;<i> 
</I>&gt;<i> I would like to hear your and others' thoughts about these issues.
</I>&gt;<i> 
</I>&gt;<i> Thanks again.
</I>&gt;<i> 
</I>&gt;<i> -Paul 
</I>&gt;<i> ________________________________________
</I>&gt;<i> From: Alexandru Scvor&#355;ov [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">scvalex at gmail.com</A>] On Behalf Of Alexandru Scvor&#355;ov [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexandru at rabbitmq.com</A>]
</I>&gt;<i> Sent: Saturday, January 28, 2012 12:11 PM
</I>&gt;<i> To: Bell, Paul M.
</I>&gt;<i> Cc: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] Securing RabbitMQ
</I>&gt;<i> 
</I>&gt;<i> Hi Paul,
</I>&gt;<i> 
</I>&gt;<i> &gt; Is there any in-built support for encrypting/decrypting the at-rest messages in the queue? I suppose that producer could encrypt and consumer decrypt. But I was hoping to avoid a &quot;roll your own&quot; approach.
</I>&gt;<i> 
</I>&gt;<i> No, there isn't any in-built RabbitMQ feature to encrypt at-rest
</I>&gt;<i> messages.  You'll have to roll your own.  As a rule, RabbitMQ does *not*
</I>&gt;<i> modify (or inspect) the contents of received messages.
</I>&gt;<i> 
</I>&gt;<i> If you use SSL on both the producer and consumer sides, the only way for
</I>&gt;<i> an attacker to get the messages would be to gain access to machine
</I>&gt;<i> hosting RabbitMQ or to the network the RabbitMQ cluster is running on
</I>&gt;<i> (if there is a cluster).
</I>&gt;<i> 
</I>&gt;<i> So, are you planning against an attacker who has gotten his hands on an
</I>&gt;<i> offline machine with RabbitMQ on it?  I haven't tried, but I suppose you
</I>&gt;<i> could use an encrypted file system.  RabbitMQ stores messages and state
</I>&gt;<i> only in its mnesia database directory, so if you encrypt that, you
</I>&gt;<i> should be secure.
</I>&gt;<i> 
</I>&gt;<i> &gt; I am trying to think about a rogue producer injecting meaningful messages into the queue, i.e., a message whose processing might return a valuable data resource. Then there's also the need to prevent someone from inspecting the queue with an eye to reverse-engineering message syntax.
</I>&gt;<i> 
</I>&gt;<i> I'm not quite sure I follow.  Could you elaborate?
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> Alex
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Sat, Jan 28, 2012 at 11:40:33AM -0500, Bell, Paul M. wrote:
</I>&gt;<i> &gt; Hello again,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have started reading <A HREF="http://www.rabbitmq.com/ssl.html,">http://www.rabbitmq.com/ssl.html,</A> and it looks....reassuring. :)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is there any in-built support for encrypting/decrypting the at-rest messages in the queue? I suppose that producer could encrypt and consumer decrypt. But I was hoping to avoid a &quot;roll your own&quot; approach.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am trying to think about a rogue producer injecting meaningful messages into the queue, i.e., a message whose processing might return a valuable data resource. Then there's also the need to prevent someone from inspecting the queue with an eye to reverse-engineering message syntax.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -Paul
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ________________________________
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ATTENTION: -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The information contained in this message (including any files transmitted with this message) may contain proprietary, trade secret or other confidential and/or legally privileged information. Any pricing information contained in this message or in any files transmitted with this message is always confidential and cannot be shared with any third parties without prior written approval from Syncsort. This message is intended to be read only by the individual or entity to whom it is addressed or by their designee. If the reader of this message is not the intended recipient, you are on notice that any use, disclosure, copying or distribution of this message, in any form, is strictly prohibited. If you have received this message in error, please immediately notify the sender and/or Syncsort and destroy all copies of this message in your possession, custody or control.
</I>&gt;<i> 
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017743.html">[rabbitmq-discuss] Securing RabbitMQ
</A></li>
	<LI>Next message: <A HREF="017752.html">[rabbitmq-discuss] Securing RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17745">[ date ]</a>
              <a href="thread.html#17745">[ thread ]</a>
              <a href="subject.html#17745">[ subject ]</a>
              <a href="author.html#17745">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
