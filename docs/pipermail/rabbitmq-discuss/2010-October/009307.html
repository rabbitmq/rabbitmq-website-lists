<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] unsynchronized access to com.rabbitmq.client.impl.AMQChannel#_blockContent in java client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20unsynchronized%20access%20to%0A%20com.rabbitmq.client.impl.AMQChannel%23_blockContent%20in%20java%20client&In-Reply-To=%3C20101006124606.GD20604%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009327.html">
   <LINK REL="Next"  HREF="009308.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] unsynchronized access to com.rabbitmq.client.impl.AMQChannel#_blockContent in java client</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20unsynchronized%20access%20to%0A%20com.rabbitmq.client.impl.AMQChannel%23_blockContent%20in%20java%20client&In-Reply-To=%3C20101006124606.GD20604%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] unsynchronized access to com.rabbitmq.client.impl.AMQChannel#_blockContent in java client">matthew at rabbitmq.com
       </A><BR>
    <I>Wed Oct  6 13:46:06 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009327.html">[rabbitmq-discuss] RabbitMQ clustering and node failure recovery strategies
</A></li>
        <LI>Next message: <A HREF="009308.html">[rabbitmq-discuss] Upgrading RabbitMQ cluster from 1.7.x to 2.1.x.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9307">[ date ]</a>
              <a href="thread.html#9307">[ thread ]</a>
              <a href="subject.html#9307">[ subject ]</a>
              <a href="author.html#9307">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Anton,

On Thu, Sep 23, 2010 at 12:40:19PM +0400, mabrek wrote:
&gt;<i> I use Channel.basicPublish() in http request handler (java client 2.1.0).
</I>&gt;<i> Messages should be sent immediately or exception should be thrown
</I>&gt;<i> after rabbitmq server had sent channel.flow active=false. If I don't
</I>&gt;<i> handle channel.flow status, basicPublish() will hang until server
</I>&gt;<i> sends channel.flow active=true.
</I>
That suggests that whilst you're using the client 2.1.0, you're not
using the broker 2.1.0 - the broker no longer sends channel.flow events
to the client - it simply relies on TCP backpressure to block clients
when the broker's under too much pressure. It is true that in the Java
client, when the broker is refusing publishes, the publish method in the
client will block. We have a bug open to try and figure out what we
could do here.

&gt;<i> I'm trying to check channel flow status before sending messages. It
</I>&gt;<i> seems that the proper way to do it is to check
</I>&gt;<i> channel.getFlow().getActive() but
</I>&gt;<i> com.rabbitmq.client.impl.ChannelN#getFlow uses unsynchronized access
</I>&gt;<i> to field _blockContent. Access to _blockContent is protected by
</I>&gt;<i> synchronized (_channelMutex) in all other places.
</I>
That is a flawed approach as 1. we don't use channel.flow any more
anyway; 2. even if we did, what you propose is racey as the channel
could become blocked between you checking the status of the channel and
trying to publish.

Really, you need to make your application asynchronous and perhaps
buffer messages internally so that should a publish block, the rest of
your application can carry on regardless.

Matthew
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009327.html">[rabbitmq-discuss] RabbitMQ clustering and node failure recovery strategies
</A></li>
	<LI>Next message: <A HREF="009308.html">[rabbitmq-discuss] Upgrading RabbitMQ cluster from 1.7.x to 2.1.x.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9307">[ date ]</a>
              <a href="thread.html#9307">[ thread ]</a>
              <a href="subject.html#9307">[ subject ]</a>
              <a href="author.html#9307">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
