<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Lose messages between restarts of broker
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lose%20messages%20between%20restarts%20of%20broker&In-Reply-To=%3C5D226D9E05A7E342B774D1881408C3EB013B4B5B56%4034093-MBX-C15.mex07a.mlsrvr.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009668.html">
   <LINK REL="Next"  HREF="009670.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Lose messages between restarts of broker</H1>
    <B>Rudi Wirth</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lose%20messages%20between%20restarts%20of%20broker&In-Reply-To=%3C5D226D9E05A7E342B774D1881408C3EB013B4B5B56%4034093-MBX-C15.mex07a.mlsrvr.com%3E"
       TITLE="[rabbitmq-discuss] Lose messages between restarts of broker">rwirth at demandware.com
       </A><BR>
    <I>Thu Oct 28 19:50:43 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009668.html">[rabbitmq-discuss] Lose messages between restarts of broker
</A></li>
        <LI>Next message: <A HREF="009670.html">[rabbitmq-discuss] problem with new persiter with 1000	topics/queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9674">[ date ]</a>
              <a href="thread.html#9674">[ thread ]</a>
              <a href="subject.html#9674">[ subject ]</a>
              <a href="author.html#9674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> If you really need messages to go safely to disk, then you should put
</I>&gt;<i> the channel into transactional mode (tx.select), and issue a tx.commit
</I>
What about unacknowledged messages? 

A Producer (rabbit 2.1.1 java client, not Spring Rabbit AMQP) commits some persistent messages on a durable queue/exchange. 

The Consumer is neither ack'ing nor rejecting the message to leave it on the queue (and let recovery retry it later), but I am committing periodically, e.g.:

  QueueingConsumer.Delivery delivery = consumer.nextDelivery();
  // neither channel.basicReject or Ack
  channel.txCommit();

Per ctl:

  $ rabbitmqctl list_queues name messages messages_unacknowledged messages_ready
  Listing queues ...
  testQueue       5       5       0

Using a soft &quot;rabbitmqctl stop&quot;, a Broker restart will make the unacknowledged messages ready again (as expected). 
  testQueue       5       0       5

With a Broker hardkill, the unack'd messages disappear.
  testQueue       0       0       0

For our implementation, I was going to rely on unacknowledged messages, flow control (qos) and periodic channel.basicRecover() to implement a crude, controlled &quot;delayed retry&quot; behavior, without using a temporary parking queue or application-provided intermediate storage. Not that anyone would kill the broker but is there a way to flush unack'd messages to disk?

Thanks
-Rudi

This e-mail message and all attachments transmitted with it may contain privileged and/or confidential information intended solely for the use of the addressee(s). If the reader of this message is not the intended recipient, you are hereby notified that any reading, dissemination, distribution, copying, forwarding or other use of this message or its attachments is strictly prohibited. If you have received this message in error, please notify the sender immediately and delete this message, all attachments and all copies and backups thereof.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009668.html">[rabbitmq-discuss] Lose messages between restarts of broker
</A></li>
	<LI>Next message: <A HREF="009670.html">[rabbitmq-discuss] problem with new persiter with 1000	topics/queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9674">[ date ]</a>
              <a href="thread.html#9674">[ thread ]</a>
              <a href="subject.html#9674">[ subject ]</a>
              <a href="author.html#9674">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
