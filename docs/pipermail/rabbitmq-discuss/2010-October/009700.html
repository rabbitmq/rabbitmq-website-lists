<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss]  unacknowledged messages lost after broker kill, despite consumer txCommit and noAck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%20unacknowledged%20messages%20lost%20after%20broker%20kill%2C%0A%20despite%20consumer%20txCommit%20and%20noAck&In-Reply-To=%3C30088199.post%40talk.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009698.html">
   <LINK REL="Next"  HREF="009701.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss]  unacknowledged messages lost after broker kill, despite consumer txCommit and noAck</H1>
    <B>rjwirth</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%20unacknowledged%20messages%20lost%20after%20broker%20kill%2C%0A%20despite%20consumer%20txCommit%20and%20noAck&In-Reply-To=%3C30088199.post%40talk.nabble.com%3E"
       TITLE="[rabbitmq-discuss]  unacknowledged messages lost after broker kill, despite consumer txCommit and noAck">rwirth at demandware.com
       </A><BR>
    <I>Fri Oct 29 19:46:58 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009698.html">[rabbitmq-discuss] Binding routing key to queue on default exchange
</A></li>
        <LI>Next message: <A HREF="009701.html">[rabbitmq-discuss] Missing features making me look at moving off	RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9700">[ date ]</a>
              <a href="thread.html#9700">[ thread ]</a>
              <a href="subject.html#9700">[ subject ]</a>
              <a href="author.html#9700">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Sorry on the repeat post from the &quot;Lose messages between restarts of broker&quot;
thread.

&gt;<i> If you really need messages to go safely to disk, then you should put
</I>&gt;<i> the channel into transactional mode (tx.select), and issue a tx.commit
</I>
What about unacknowledged messages?

A Producer (rabbit 2.1.1 java client, not Spring Rabbit AMQP) commits some
persistent messages on a durable queue/exchange.

The Consumer is neither ack'ing nor rejecting the message to leave it on the
queue (and let recovery retry it later), but I am committing periodically,
e.g.:

  QueueingConsumer.Delivery delivery = consumer.nextDelivery();
  // neither channel.basicReject or Ack
  channel.txCommit();

Per ctl:

  $ rabbitmqctl list_queues name messages messages_unacknowledged
messages_ready
  Listing queues ...
  testQueue       5       5       0

Using a soft &quot;rabbitmqctl stop&quot;, a Broker restart will make the
unacknowledged messages ready again (as expected).
  testQueue       5       0       5

With a Broker hardkill, the unack'd messages disappear even after I have
just committed the channel
  testQueue       0       0       0

Is there anything to commit on the channel if the Broker didn't get an Ack? 
Shouldn't the &quot;lease&quot; of the message be at least committed?

For our implementation, I was going to rely on unacknowledged messages, flow
control (qos) and periodic channel.basicRecover() to implement a crude,
controlled &quot;delayed retry&quot; behavior, without using a temporary parking queue
or application-provided intermediate storage. Not that anyone would kill the
broker but is there a way to flush unack'd messages to disk?

Thanks much!
-Rudi 

-----
Rudi Wirth

-- 
View this message in context: <A HREF="http://old.nabble.com/unacknowledged-messages-lost-after-broker-kill%2C-despite-consumer-txCommit-and-noAck-tp30088199p30088199.html">http://old.nabble.com/unacknowledged-messages-lost-after-broker-kill%2C-despite-consumer-txCommit-and-noAck-tp30088199p30088199.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009698.html">[rabbitmq-discuss] Binding routing key to queue on default exchange
</A></li>
	<LI>Next message: <A HREF="009701.html">[rabbitmq-discuss] Missing features making me look at moving off	RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9700">[ date ]</a>
              <a href="thread.html#9700">[ thread ]</a>
              <a href="subject.html#9700">[ subject ]</a>
              <a href="author.html#9700">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
