<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Failed upgrade from 1.8.1 to 2.1.0
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Failed%20upgrade%20from%201.8.1%20to%202.1.0&In-Reply-To=%3CD36A9E17-B4AE-4132-98E7-8A8FBFF5F936%40ketralnis.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009352.html">
   <LINK REL="Next"  HREF="009380.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Failed upgrade from 1.8.1 to 2.1.0</H1>
    <B>David King</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Failed%20upgrade%20from%201.8.1%20to%202.1.0&In-Reply-To=%3CD36A9E17-B4AE-4132-98E7-8A8FBFF5F936%40ketralnis.com%3E"
       TITLE="[rabbitmq-discuss] Failed upgrade from 1.8.1 to 2.1.0">dking at ketralnis.com
       </A><BR>
    <I>Fri Oct  8 19:53:28 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009352.html">[rabbitmq-discuss] Failed upgrade from 1.8.1 to 2.1.0
</A></li>
        <LI>Next message: <A HREF="009380.html">[rabbitmq-discuss] Failed upgrade from 1.8.1 to 2.1.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9367">[ date ]</a>
              <a href="thread.html#9367">[ thread ]</a>
              <a href="subject.html#9367">[ subject ]</a>
              <a href="author.html#9367">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Ok, how much memory is in the box, and what are the average sizes of
</I>&gt;<i> these messages? Are you setting the memory_high_watermark to anything
</I>&gt;<i> non-default (of 0.4)? When rabbit starts, there should be entries in the
</I>&gt;<i> logs saying things like:
</I>
The messages average about 8 bytes (they are mostly IDs that look like &quot;t3_abcde&quot;). The machine has 7.5gb of RAM, and the log messages you describe look like:

    =INFO REPORT==== 7-Oct-2010::15:54:19 ===
    Limiting to approx 924 file handles (829 sockets)
    =INFO REPORT==== 7-Oct-2010::15:54:19 ===
    Memory limit set to 3081MB.

&gt;<i> I suspect that you're maybe hitting the memory high watermark - are
</I>&gt;<i> there any entries in the logs like:
</I>
There are no messages mentioning vm_memory_high_watermark or alarms:

    <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ri at q01</A>:~/rabbitmq_server/log$ egrep -i '(alarm|memory)' *
    <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at q01.log</A>:Memory limit set to 3081MB.
    <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at q01.log.1</A>:Memory limit set to 3081MB.
    <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at q01.log.1</A>:Memory limit set to 3081MB.

And as you can see in the memory graph I included at the end there, the bump at the end was this attempted upgrade, and the machine definitely didn't run out of RAM. But that &quot;924 file handles&quot; does look quite low, how can I increase that?

&gt;<i> Also, are you publishing messages transient or persistent (what's the
</I>&gt;<i> delivery_mode when you publish messages)?. And your consumers that
</I>&gt;<i> blocked, are these the ones using basic.get or basic.consume? And are
</I>&gt;<i> they acking messages or using autoack? Are any of the consumers doing
</I>&gt;<i> any publishes too?
</I>
Some messages are transient and some are persistent. The blocked queues appear to be a mix of basic.get and basic.consume. The consumers ack their own messages (not autoack). I don't think any of the consumers publish messages

&gt;<i> Interesting. What actions other than basic.consume (I assume) are these
</I>&gt;<i> consumers doing when they connect? Do they try and redeclare the queue
</I>&gt;<i> or create any other resources?
</I>
They do all try to redeclare all of the queues and bindings, yes

&gt;<i> Ok, what was the disk activity during this exercise in general?
</I>
I didn't get a note of it, but the CPU usage, including WAIT CPU, didn't noticeably increase (I have the CPU graph for that period and it's flat with respect to before, during, and after the upgrade), and I'd expect the WAIT to go up if the disk was swamped. 

&gt;&gt;<i> Also, this is unrelated, but I'd provisioned the new machine a couple
</I>&gt;&gt;<i> of weeks ago, and it's been sitting literally 100% idle until I tried
</I>&gt;&gt;<i> moving today. But look at its memory usage over the last week
</I>&gt;&gt;<i> &lt;<A HREF="http://i.imgur.com/M7x6m.png">http://i.imgur.com/M7x6m.png</A>&gt;. What on earth could it be doing that
</I>&gt;&gt;<i> it's growing in memory when *not used*? This machine is identical to
</I>&gt;&gt;<i> our other machines (it's an EC2 node from the same AMI), but only this
</I>&gt;&gt;<i> node has this problem, and all it's running is rabbit.
</I>&gt;<i> Now that is interesting. What version of Erlang are you running?
</I>
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ri at q01</A>:~/rabbitmq_server/log$ erl --version
Erlang R14B (erts-5.8.1) [source] [64-bit] [smp:2:2] [rq:2] [async-threads:0] [kernel-poll:false]

Thanks for the help so far :)
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009352.html">[rabbitmq-discuss] Failed upgrade from 1.8.1 to 2.1.0
</A></li>
	<LI>Next message: <A HREF="009380.html">[rabbitmq-discuss] Failed upgrade from 1.8.1 to 2.1.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9367">[ date ]</a>
              <a href="thread.html#9367">[ thread ]</a>
              <a href="subject.html#9367">[ subject ]</a>
              <a href="author.html#9367">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
