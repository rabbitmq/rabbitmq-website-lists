<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Publish messages only when needed ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Publish%20messages%20only%20when%20needed%20%3F&In-Reply-To=%3C29913525.post%40talk.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009324.html">
   <LINK REL="Next"  HREF="009346.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Publish messages only when needed ?</H1>
    <B>RomainC</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Publish%20messages%20only%20when%20needed%20%3F&In-Reply-To=%3C29913525.post%40talk.nabble.com%3E"
       TITLE="[rabbitmq-discuss] Publish messages only when needed ?">romain.conseil at gmail.com
       </A><BR>
    <I>Fri Oct  8 09:42:33 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009324.html">[rabbitmq-discuss] Publish messages only when needed ?
</A></li>
        <LI>Next message: <A HREF="009346.html">[rabbitmq-discuss] Publish messages only when needed ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9345">[ date ]</a>
              <a href="thread.html#9345">[ thread ]</a>
              <a href="subject.html#9345">[ subject ]</a>
              <a href="author.html#9345">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi and thanks for your interest !

Marek, I checked my code and I had already set the mandatory and immediate
flags to false.
Matthias, here is the description of my case :

the server (2.1.0) is started on linux after a clean.
I start 5 publishers that sends 2000 messages of 78 bytes per second on 10
exchnages. that is to say :

-10 exchanges (with x-lvc plugin that stores in mnesia database the last
value for each message)
-10000 different messages @ 1Hz (= 10000 different routeId) --&gt; ~700Kb/s
- each exchange handles 1000 msg/s

&quot;top&quot; shows me a 130% CPU load with no subscriber (= no queue) for the
moment, just publishing.
Here are the control traces :

Listing exchanges ...
amq.direct	direct
amq.topic	topic
<A HREF="tm://SAT.DRV7">tm://SAT.DRV7</A>	x-lvc
<A HREF="tm://SAT.DRV1">tm://SAT.DRV1</A>	x-lvc
amq.rabbitmq.log	topic
<A HREF="tm://SAT.DRV6">tm://SAT.DRV6</A>	x-lvc
<A HREF="tm://SAT.DRV2">tm://SAT.DRV2</A>	x-lvc
<A HREF="tm://SAT.DRV4">tm://SAT.DRV4</A>	x-lvc
amq.fanout	fanout
<A HREF="tm://SAT.DRV8">tm://SAT.DRV8</A>	x-lvc
<A HREF="tm://SAT.DRV3">tm://SAT.DRV3</A>	x-lvc
<A HREF="tm://SAT.DRV5">tm://SAT.DRV5</A>	x-lvc
<A HREF="tm://SAT.DRV0">tm://SAT.DRV0</A>	x-lvc
amq.headers	headers
<A HREF="tm://SAT.DRV9">tm://SAT.DRV9</A>	x-lvc
	direct
amq.match	headers
...done.
Listing queues ...
...done.
Listing channels ...
	guest	false	0	0
	guest	false	0	0
	guest	false	0	0
	guest	false	0	0
	guest	false	0	0
...done.
Listing connections ...
guest	140.94.126.54	2831	running
guest	140.94.126.54	2834	running
guest	140.94.126.54	2835	running
guest	140.94.126.54	2833	running
guest	140.94.126.54	2832	running
...done.
Listing bindings ...
...done.

I made the same test with direct exchanges (without mnesia) : 
CPU load : 120%
Control traces :

Listing exchanges ...
amq.direct	direct
amq.topic	topic
<A HREF="tm://SAT.DRV7">tm://SAT.DRV7</A>	direct
<A HREF="tm://SAT.DRV1">tm://SAT.DRV1</A>	direct
amq.rabbitmq.log	topic
<A HREF="tm://SAT.DRV6">tm://SAT.DRV6</A>	direct
<A HREF="tm://SAT.DRV2">tm://SAT.DRV2</A>	direct
<A HREF="tm://SAT.DRV4">tm://SAT.DRV4</A>	direct
amq.fanout	fanout
<A HREF="tm://SAT.DRV8">tm://SAT.DRV8</A>	direct
<A HREF="tm://SAT.DRV3">tm://SAT.DRV3</A>	direct
<A HREF="tm://SAT.DRV5">tm://SAT.DRV5</A>	direct
<A HREF="tm://SAT.DRV0">tm://SAT.DRV0</A>	direct
amq.headers	headers
<A HREF="tm://SAT.DRV9">tm://SAT.DRV9</A>	direct
	direct
amq.match	headers
...done.
Listing queues ...
...done.
Listing channels ...
	guest	false	0	0
	guest	false	0	0
	guest	false	0	0
	guest	false	0	0
	guest	false	0	0
...done.
Listing connections ...
guest	140.94.126.54	2956	running
guest	140.94.126.54	2955	running
guest	140.94.126.54	2952	running
guest	140.94.126.54	2954	running
guest	140.94.126.54	2953	running
...done.
Listing bindings ...
...done.


What disturbs me is this high CPU load whereas there is no subscriber.
That's the reason why I search a way to &quot;control the message flow sent by
publishers&quot;. for instance when listening the bindings on a subscriber.

Thanks a lot for your help.
Romain


Marek Majkowski wrote:
&gt;<i> 
</I>&gt;&gt;<i> I try to find some ways to enhance this. So my question : would it be
</I>&gt;&gt;<i> possible to publish essages to the exchange only if there is at least one
</I>&gt;&gt;<i> consumer that subscribed this message ? In other words, I would like to
</I>&gt;&gt;<i> implement a kind of binding listener on exchanges and a way to request
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> list of bindings (in Java).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I searched the api and it doesn't seem to be available. I am also aware
</I>&gt;&gt;<i> that
</I>&gt;&gt;<i> this breaks the publisher/subscriber model since the publisher doesn't
</I>&gt;&gt;<i> have
</I>&gt;&gt;<i> to carry about diffusion, it just publishes.
</I>&gt;<i> 
</I>&gt;<i> Have you looked at the &quot;immediate&quot; and &quot;mandatory&quot; flags in basic.publish?
</I>&gt;<i> 
</I>&gt;<i> From <A HREF="http://www.rabbitmq.com/api-guide.html:">http://www.rabbitmq.com/api-guide.html:</A>
</I>&gt;<i> &quot;If a message is published with the &quot;mandatory&quot; or &quot;immediate&quot; flags
</I>&gt;<i> set, but cannot be delivered, the broker will return it to the sending
</I>&gt;<i> client (via a AMQP.Basic.Return command).&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i>   Marek
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>
-- 
View this message in context: <A HREF="http://old.nabble.com/Publish-messages-only-when-needed---tp29904396p29913525.html">http://old.nabble.com/Publish-messages-only-when-needed---tp29904396p29913525.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20101008/91e43974/attachment-0001.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20101008/91e43974/attachment-0001.htm</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009324.html">[rabbitmq-discuss] Publish messages only when needed ?
</A></li>
	<LI>Next message: <A HREF="009346.html">[rabbitmq-discuss] Publish messages only when needed ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9345">[ date ]</a>
              <a href="thread.html#9345">[ thread ]</a>
              <a href="subject.html#9345">[ subject ]</a>
              <a href="author.html#9345">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
