<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Multi-threaded Dispatch in Java Client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Multi-threaded%20Dispatch%20in%20Java%20Client&In-Reply-To=%3C2B5773E7-547A-49BA-9D57-41B23CBC64F4%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009236.html">
   <LINK REL="Next"  HREF="009267.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Multi-threaded Dispatch in Java Client</H1>
    <B>Rob Harrop</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Multi-threaded%20Dispatch%20in%20Java%20Client&In-Reply-To=%3C2B5773E7-547A-49BA-9D57-41B23CBC64F4%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Multi-threaded Dispatch in Java Client">rob at rabbitmq.com
       </A><BR>
    <I>Fri Oct  1 18:54:10 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009236.html">[rabbitmq-discuss] hanging on message sending with py-amqplib
</A></li>
        <LI>Next message: <A HREF="009267.html">[rabbitmq-discuss] Multi-threaded Dispatch in Java Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9237">[ date ]</a>
              <a href="thread.html#9237">[ thread ]</a>
              <a href="subject.html#9237">[ subject ]</a>
              <a href="author.html#9237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Recently I pushed branch bug18384 that changes the way callbacks are sent to Consumer implementations.

Following this change, the Connection maintains a dispatch thread that is used to send callbacks to the Consumers. This frees Consumers call blocking methods on the Connection and Channel.

A question came up on Twitter about making this configurable, allowing for a custom Executor to be plugged into the ConnectionFactory. I wanted to outline why this is complicated, discuss a possible implementation and see if there is much interest.

First off, we should establish that each Consumer should only receive callbacks in a single thread. If this is not the case, then chaos will ensue and Consumers will need to worry about their own thread safety beyond that of initialisation safety.

With only a single dispatch thread for all Consumers, this Consumer-Thread pairing is easy honoured.

When we introduce multiple threads, we have to ensure that each Consumer is paired with only one thread. When using the Executor abstraction, this prevents each callback dispatch from being wrapped up in a Runnable and sent to Executor, because you cannot guarantee which thread will be used.

To get around this, the Executor can be set to run 'n' long-running tasks (n being the number of threads in the Executor). Each of these tasks pulls dispatch instructions off a queue and executes them. Each Consumer is paired with one dispatch instruction queue, probably assigned on a round-robin basis. This is not too complicated and will provide simple balancing of dispatch load across the threads in the Executor.

Now, there are still some problems:

1. The number of threads in an Executor is not necessarily fixed (as with ThreadPoolExecutor).
2. There is no way, via Executor or ExecutorService to find out how many threads there are. Thus, we cannot know how many dispatch instruction queues to create.

However, we can certainly introduce a ConnectionFactory.setDispatchThreadCount(int). Behind the scenes this will create an Executors.newFixedThreadPool() and the correct number of dispatch queues and dispatch tasks.

I'm interested in hearing if anyone thinks I'm overlooking some simpler way of solving this, and indeed if this is even worth solving.

Regards,

Rob
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009236.html">[rabbitmq-discuss] hanging on message sending with py-amqplib
</A></li>
	<LI>Next message: <A HREF="009267.html">[rabbitmq-discuss] Multi-threaded Dispatch in Java Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9237">[ date ]</a>
              <a href="thread.html#9237">[ thread ]</a>
              <a href="subject.html#9237">[ subject ]</a>
              <a href="author.html#9237">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
