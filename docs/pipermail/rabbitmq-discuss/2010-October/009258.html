<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] hanging on message sending with py-amqplib
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20hanging%20on%20message%20sending%20with%20py-amqplib&In-Reply-To=%3C4CA6F6D7.2020605%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009257.html">
   <LINK REL="Next"  HREF="009260.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] hanging on message sending with py-amqplib</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20hanging%20on%20message%20sending%20with%20py-amqplib&In-Reply-To=%3C4CA6F6D7.2020605%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] hanging on message sending with py-amqplib">matthias at rabbitmq.com
       </A><BR>
    <I>Sat Oct  2 10:09:43 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009257.html">[rabbitmq-discuss] hanging on message sending with py-amqplib
</A></li>
        <LI>Next message: <A HREF="009260.html">[rabbitmq-discuss] hanging on message sending with py-amqplib
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9258">[ date ]</a>
              <a href="thread.html#9258">[ thread ]</a>
              <a href="subject.html#9258">[ subject ]</a>
              <a href="author.html#9258">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Tsuraan,

tsuraan wrote:
&gt;<i> Don't feel like doing the confusing name-mangling stuff, so sending
</I>&gt;<i> these directly to you
</I>&gt;<i> [...]
</I>
The output of list_connections show many connections in the 'blocked' 
state, which means the broker is refusing to accept any more data.

That should only happen if the memory alarm is currently active. What 
does the log file say about that? Perhaps you could post it.

The output of list_queues shows a number of queues with messages waiting 
for acknowledgement. One queue in particular has a high count. What's 
the average message size of messages in that queue?

The messages waiting for acks also show up in list_channels.

Tracing the from the queue through the consumers, channels and 
connections to find the connection which is consuming from the high-ack 
queue, we discover that connection to be blocked.


So I think what is happening here is that you have a client that is both 
a consumer and producer. At some point the memory alarm is raised. 
Because the client has been identified as a producer the server blocks 
the inbound socket data stream, thus pausing the client in its tracks. 
But messages still get delivered to the client. And they all pile up in 
memory, in the server's channel process. That is preventing the server 
from ever recovering, clearing the memory alarm and unblocking the 
connections.


I reckon one way to prevent this situation is to set a 
qos.prefetch_count, thus bounding the number of messages which are 
waiting for acknowledgement. Or, if you can consume in no-ack mode that 
would be even better.


Regards,

Matthias.
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009257.html">[rabbitmq-discuss] hanging on message sending with py-amqplib
</A></li>
	<LI>Next message: <A HREF="009260.html">[rabbitmq-discuss] hanging on message sending with py-amqplib
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9258">[ date ]</a>
              <a href="thread.html#9258">[ thread ]</a>
              <a href="subject.html#9258">[ subject ]</a>
              <a href="author.html#9258">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
