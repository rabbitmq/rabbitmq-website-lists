From moseley at hank.org  Mon Jan  3 02:18:36 2011
From: moseley at hank.org (Bill Moseley)
Date: Sun, 2 Jan 2011 18:18:36 -0800
Subject: [rabbitmq-discuss] prefetch_count with Net::RabbitMQ?
Message-ID: <AANLkTinc_CwqnKGFX_S6A_G+GBmpr8=3Qv0vvhLye-7w@mail.gmail.com>

I hope I didn't miss something, but following the tutorial (
http://www.rabbitmq.com/tutorial-two-python.html) with the Perl client I
didn't see how to set the prefetch_count to 1.  Is that possible?

If I have a number of consumers I don't want a consumer that gets stuck on a
long running task to prevent jobs from flowing to other workers.

Thanks,

-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110102/5ada57fd/attachment.htm>

From emile at rabbitmq.com  Mon Jan  3 15:00:29 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Mon, 03 Jan 2011 15:00:29 +0000
Subject: [rabbitmq-discuss] prefetch_count with Net::RabbitMQ?
In-Reply-To: <AANLkTinc_CwqnKGFX_S6A_G+GBmpr8=3Qv0vvhLye-7w@mail.gmail.com>
References: <AANLkTinc_CwqnKGFX_S6A_G+GBmpr8=3Qv0vvhLye-7w@mail.gmail.com>
Message-ID: <4D21E48D.4060709@rabbitmq.com>


Hi Bill,

Op 03/01/2011 02:18, het Bill Moseley geskryf:
> I hope I didn't miss something, but following the tutorial
> (http://www.rabbitmq.com/tutorial-two-python.html) with the Perl client
> I didn't see how to set the prefetch_count to 1.  Is that possible?
>
> If I have a number of consumers I don't want a consumer that gets stuck
> on a long running task to prevent jobs from flowing to other workers.

Net::RabbitMQ is a wrapper around the rabbitmq C client which lacks an 
API for setting QOS at this time. You could try one of the other Perl 
clients that offer QOS support.

If you have translated any of the tutorials to another language then you 
may want to consider contributing.


Regards

Emile

From kot.begemot at gmail.com  Mon Jan  3 17:37:02 2011
From: kot.begemot at gmail.com (Vadim Chekan)
Date: Mon, 3 Jan 2011 09:37:02 -0800
Subject: [rabbitmq-discuss] Wcf one-way call
Message-ID: <AANLkTikAj4mWATsweQkw0wMqGEm3pvqZpcGscmv0RbDz@mail.gmail.com>

Hi all,

For cache invalidation purposes I am trying to implement a broadcast
as a one-way call using wcf. As long as it is a broadcast call, I
don't expect any response. So it must be one-way call. But I
experience blocking waiting for response until timeout. Most likely it
is because reasons mentioned in this article "One-way is not always
really one-way":
http://bloggingabout.net/blogs/gerben/archive/2010/02/01/wcf-best-practice-5-one-way-is-not-always-really-one-way.aspx

The Rabbit's Wcf documentation mentions that behavior *can* be marked
as one-way, in addition to a call, but it seems to me that it is
actually the only way to make one-way call working. Is there any way
to make an OperationContract one-way? Because if I mark the whole
service with one-way behavior, then I'll be in troubles if I'll mix
one and two way calls in the same service.

Vadim.

Some snippets of my code:
============================================
    [ServiceContract]
    public interface ICategoryService
    {
        [OperationContract(IsOneWay=true)]
        void InvalidateAll();
    }

        class Broadcast : ClientBase<ICategoryService>, ICategoryService
        {
            public Broadcast() : base("Category") { }

            public void InvalidateAll()
            {
                base.Channel.InvalidateAll();
            }
        }
...
...
            // broadcast the change
            using (var broadcast = new Broadcast())
            {
                broadcast.InvalidateAll();
                broadcast.Close();
            }
...
...
============================================

-- 
>From RFC 2631: In ASN.1, EXPLICIT tagging is implicit unless IMPLICIT
is explicitly specified

From david.renz at gmail.com  Mon Jan  3 22:56:10 2011
From: david.renz at gmail.com (drenz)
Date: Mon, 3 Jan 2011 14:56:10 -0800 (PST)
Subject: [rabbitmq-discuss] Rabbitmq Java Client Memory Leak?
In-Reply-To: <AANLkTikMHMk=p8uQLFcmJxERZjV+avFdty-iB_nYyuca@mail.gmail.com>
References: <c2846c00-7788-428d-a871-fa9fbbd7c00e@l8g2000yqh.googlegroups.com>
	<AANLkTinC1v=7V_VgD43WDWYuWL_pMJ9zrw1-DOzofybj@mail.gmail.com>
	<b85eda13-f182-4b62-a8ac-1a4b942f0152@j29g2000yqm.googlegroups.com>
	<AANLkTikMHMk=p8uQLFcmJxERZjV+avFdty-iB_nYyuca@mail.gmail.com>
Message-ID: <cdc93c68-54a8-46e6-b668-083c84f1270f@f20g2000vbc.googlegroups.com>

Thanks for the help guys! I've resolved the issue.

Not surprisingly, this was my own fault. I had a long running database
connection in another layer of the code that was eating up memory.
Nothing was wrong with rabbitmq.

Thanks,

Dave


On Dec 12 2010, 3:02?pm, Benjamin Bennett <benbenn... at gmail.com>
wrote:
> Don't know if it is possible, I would attach the source to your
> debugger.That might give you some idea what is going on.
> I had ?quick look at the QueueingConsumer code and it looks pretty
> strait forward.
> ?What profiler are you using ? I am yourkit memory inspections would
> give you some idea what class is holding the reference.
> ?Something is holding onto the bytes and it cannot be gc'd.
> Other item is the new ByteStreamInputArray() wonder if you can set
> that as a variable and set it to null after you read. But looking at
> the javadocs that shouldn't be the issue.
> I would still try it to 100% that isn't the issue.
>
>
>
>
>
>
>
>
>
> On Sun, Dec 12, 2010 at 1:36 PM, drenz <david.r... at gmail.com> wrote:
> > I've updated the code to explicitly set body = null after I am done
> > using it. See below.
>
> > However, the memory continues to build up. This is the only part of
> > the code that runs, so it has to be something in here. ?It almost
> > looks like the QueueingConsumer object might be keeping these
> > references around. ?Is that possible?
>
> > Thanks
>
> > byte[] body = delivery.getBody();
>
> > ObjectInputStream in = new ObjectInputStream(new
> > ByteArrayInputStream(body));
> > Status s = (Status) in.readObject();
>
> > body = null;
>
> > in.close();
>
> > in = null;
>
> > On Dec 12, 12:51?pm, Benjamin Bennett <benbenn... at gmail.com> wrote:
> >> Having a quick look at it make sure the line is not holding a
> >> reference , considering you are saying the profiler is saying that a
> >> reference is out there.
> >> ?byte[] body = delivery.getBody();
> >> de references the delivery.getBody();
>
> >> if the body variable is referencing the delivery.getBody() it will
> >> prevent it from being gc'ed .
>
> >> On Sun, Dec 12, 2010 at 9:58 AM, drenz <david.r... at gmail.com> wrote:
> >> > Hello,
>
> >> > I have a pretty simple set up where I use the RabbitMQ client library
> >> > to pull objects from a RabbitMQ server.
>
> >> > Unfortunately, there seems to be some memory leak in my program
> >> > because it quickly consumes all of the heap memory with byte arrays.
> >> > I've increased the max memory for the JVM to 2 GB and it consumes all
> >> > of that too.
>
> >> > Here is the code I use to pull data from the queue. ?Having used a few
> >> > Java profilers, it looks like the leak is associated with they
> >> > QueueingConsumer.Delivery object, because each Delivery object has a
> >> > member byte[] called _body.
>
> >> > Does anyone have any idea how I can ensure these arrays are garbage
> >> > collected / destroyed?
>
> >> > Thanks in advance!!!
>
> >> > Property values:
> >> > queue.user=guest
> >> > queue.password=guest
> >> > queue.virtualHost=/
> >> > queue.host=127.0.0.1
> >> > queue.hostPort=5672
> >> > queue.heartBeat=0
> >> > queue.exchange=myExchange
> >> > queue.queueName=dtt
> >> > queue.routingKey=dttRoute
>
> >> > Code:
>
> >> > ? ? ? ?public void consume() throws IOException, ClassNotFoundException {
>
> >> > ? ? ? ? ? ? ? ?ConnectionFactory factory = new ConnectionFactory();
> >> > ? ? ? ? ? ? ? ?factory.setUsername(PropertyUtil
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?.getProperyFile().getProperty("queue.user"));
> >> > ? ? ? ? ? ? ? ?factory.setPassword(PropertyUtil
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?.getProperyFile().getProperty("queue.password"));
> >> > ? ? ? ? ? ? ? ?factory.setVirtualHost(PropertyUtil
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?.getProperyFile().getProperty("queue.virtualHost"));
> >> > ? ? ? ? ? ? ? ?factory.setRequestedHeartbeat(Integer.parseInt(PropertyUtil
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?.getProperyFile().getProperty("queue.heartBeat")));
> >> > ? ? ? ? ? ? ? ?factory.setHost(PropertyUtil
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?.getProperyFile().getProperty("queue.host"));
> >> > ? ? ? ? ? ? ? ?factory.setPort(Integer.parseInt(PropertyUtil
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?.getProperyFile().getProperty("queue.hostPort")));
>
> >> > ? ? ? ? ? ? ? ?boolean durable = true;
> >> > ? ? ? ? ? ? ? ?boolean noAck = false;
>
> >> > ? ? ? ? ? ? ? ?Connection conn = factory.newConnection();
>
> >> > ? ? ? ? ? ? ? ?Channel channel = conn.createChannel();
>
> >> > ? ? ? ? ? ? ? ?channel.basicQos(2);
> >> > ? ? ? ? ? ? ? ?channel.exchangeDeclare(getExchangeName(), "direct", durable);
> >> > ? ? ? ? ? ? ? ?channel.queueDeclare(getQueueName(), durable, false, false, null);
> >> > ? ? ? ? ? ? ? ?channel.queueBind(getQueueName(), getExchangeName(),
> >> > getRoutingKey());
>
> >> > ? ? ? ? ? ? ? ?QueueingConsumer consumer = new QueueingConsumer(channel);
> >> > ? ? ? ? ? ? ? ?channel.basicConsume(getQueueName(), noAck, consumer);
>
> >> > ? ? ? ? ? ? ? ?boolean runInfinite = true;
>
> >> > ? ? ? ? ? ? ? ?java.sql.Connection sqlConn = null;
> >> > ? ? ? ? ? ? ? ?sqlConn = DatabaseUtil.getConnection();
>
> >> > ? ? ? ? ? ? ? ?long start = 0;
> >> > ? ? ? ? ? ? ? ?long end = 0;
>
> >> > ? ? ? ? ? ? ? ?while (runInfinite) {
> >> > ? ? ? ? ? ? ? ? ? ? ? ?start = System.currentTimeMillis();
> >> > ? ? ? ? ? ? ? ? ? ? ? ?QueueingConsumer.Delivery delivery = null;
> >> > ? ? ? ? ? ? ? ? ? ? ? ?try {
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?delivery = consumer.nextDelivery();
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ?} catch (Exception ie) {
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?log.error(ie.getMessage(), ie);
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?continue;
> >> > ? ? ? ? ? ? ? ? ? ? ? ?}
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ?byte[] body = delivery.getBody();
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ?ObjectInputStream in = new ObjectInputStream(
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?new ByteArrayInputStream(body));
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ?Status s = (Status) in.readObject();
> >> > ? ? ? ? ? ? ? ? ? ? ? ?in.close();
> >> > ? ? ? ? ? ? ? ? ? ? ? ?in = null;
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ?try {
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?try {
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?process(s, sqlConn);
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?} catch (Exception e) {
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?try{
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?sqlConn = DatabaseUtil.getConnection();
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?} catch (Exception e1){
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?log.error(e.getMessage(), e1);
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?throw e1;
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?}
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?}
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?// only send an acknowledgement when the processing completed
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?// successfully
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?channel
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?.basicAck(delivery.getEnvelope().getDeliveryTag(),
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?false);
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ?} catch (Exception e) {
> >> > ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?log.error(e.getMessage(), e);
> >> > ? ? ? ? ? ? ? ? ? ? ? ?}
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ?end = System.currentTimeMillis();
> >> > ? ? ? ? ? ? ? ? ? ? ? ?delivery = null;
>
> >> > ? ? ? ? ? ? ? ? ? ? ? ?log.debug("Processing time: "+ (end - start) +" ms");
>
> >> > ? ? ? ? ? ? ? ?}
> >> > ? ? ? ? ? ? ? ?try {
> >> > ? ? ? ? ? ? ? ? ? ? ? ?sqlConn.close();
> >> > ? ? ? ? ? ? ? ?} catch (SQLException e) {
> >> > ? ? ? ? ? ? ? ? ? ? ? ?// TODO Auto-generated catch block
> >> > ? ? ? ? ? ? ? ? ? ? ? ?log.error(e.getMessage(), e);
> >> > ? ? ? ? ? ? ? ?}
>
> >> > ? ? ? ? ? ? ? ?channel.close();
> >> > ? ? ? ? ? ? ? ?conn.close();
>
> >> > ? ? ? ?}
>
> >> > _______________________________________________
> >> > rabbitmq-discuss mailing list
> >> > rabbitmq-disc... at lists.rabbitmq.com
> >> >https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
> >> _______________________________________________
> >> rabbitmq-discuss mailing list
> >> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-disc... at lists.rabbitmq.com
> >https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From moseley at hank.org  Mon Jan  3 23:13:30 2011
From: moseley at hank.org (Bill Moseley)
Date: Mon, 3 Jan 2011 15:13:30 -0800
Subject: [rabbitmq-discuss] Web use scenarios
Message-ID: <AANLkTikkKOLWgFnRPmg=CkBzBfu=6uyMG4doYqfi0zX_@mail.gmail.com>

Hi,

I'm just starting out with RabbitMQ and trying to wrap my head around a few
concepts.  I apologize if I ask something that should be obvious or I missed
in the docs and faq.  I'm hoping someone can help with a few scenarios, and
please point me to further reading as needed.

I'm curious about use-cases that are not directly related to RabbitMQ, but
how to best use RabbitMQ in an web application's architecture.  Thes are
probably very common situations.

1) Notification of job status and completion:  If the web app produces a
request to generate an expensive PDF is there a common approach to detecting
when the consumer is completed and the pdf is ready for downloading?  Should
I create a single-use return queue with x-expires and/or x-message-ttl on
the queue?   In a web app the web user may never come back to pick up the
PDF.

2) Job sequencing:  What's a common approach to multiple step processing
that must be done serially?  I.e. queue job "A" and when it's complete queue
job "B".  Doesn't really seem like consumer "A" should be responsible for
submitting job "B".  Is it better to create a consumer "AB" that submits "A"
and waits for a message that "A" is complete and then submits job "B"?

3) Scheduling: I assume there's no facility for scheduling jobs to be
delivered to consumers at some future time.  Is there a better approach than
using cron to check the database for jobs that should be queued based on
time?

4) Cancel a request:  We have some situations when a subsequent request
should cancel processing of an earlier request.  (Frankly, I think this is a
design problem on our end.)

5) Prevent duplicate job requests: In a web environment when things break
problems often compound by users reloading requests that caused the problem
in the first place.  I'm not sure RabbitMQ would be involved at all in this
scenario, but I'm asking just in case. ;)

Finally, it's great that RabbitMQ will send a message again if is is not
ACK'd and a consumer closes its connection.  But, is there any kind of max
retry count available?  That is, what's a good approach to prevent an errant
job from killing all consumers one-by-one?

Thanks,

-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110103/1e5c9cf4/attachment.htm>

From chenhouwu at gmail.com  Tue Jan  4 08:27:42 2011
From: chenhouwu at gmail.com (Chen Houwu)
Date: Tue, 4 Jan 2011 00:27:42 -0800 (PST)
Subject: [rabbitmq-discuss] how to send a message including a array via
	.net client?
In-Reply-To: <AANLkTin_k9FcSRgnBm2=bvdj+3qJFV6cdgu1sCGj+ief@mail.gmail.com>
References: <afdb5cda-2531-4703-aa87-077f067a2102@o4g2000yqd.googlegroups.com>
	<AANLkTin_k9FcSRgnBm2=bvdj+3qJFV6cdgu1sCGj+ief@mail.gmail.com>
Message-ID: <f8dff6ee-3d86-40f1-8429-c2ad8b44bf43@t35g2000yqj.googlegroups.com>

Do you mean that .net client has no build-in support for simple data
structure?
But I have found it should support according to the AMQP 1.0
specification.
AMQP is a binary protocol, but json is text.
Though I can send binary content after encoding it to BASE64, it is
too inefficient.

It seams as if the python client support array and dictionary
object.....

On 2010?12?29?, ??6?47?, Marek Majkowski <maje... at gmail.com> wrote:
> Hi,
>
> I think you should be using some standardized encoding,
> like for example json.
>
> Take a look at this library:http://james.newtonking.com/pages/json-net.aspxhttp://stackoverflow.com/questions/571168/what-json-library-works-wel...
>
> Cheers,
> ? Marek
>
>
>
>
>
>
>
>
>
> On Mon, Dec 27, 2010 at 11:22, Chen Houwu <chenho... at gmail.com> wrote:
> > ? I am a newbie to rabbitmq, I want to send a message object as
> > following via .net client:
>
> > ? public class Message
> > ? ?{
> > ? ? ? ?public int ID { get; set; }
> > ? ? ? ?public string Name { get; set; }
> > ? ? ? ?public byte[] Binary { get; set; }
> > ? ? ? ?public string[] Infos{get;set;}
> > ? ? ? ?public Dictionary<string,int> CountMap { get; set; }
> > ? ?}
>
> > Here is my code:
> > -------------------------------------------
> > var builder = new
> > RabbitMQ.Client.Content.StreamMessageBuilder(_channel);
> > builder.writeObject(msg.ID);
> > builder.writeObject(msg.Name);
> > /*----------How to deal with msg.Infos and CountMap here?------------/
>
> > /*shoud it be written by myself such as: */
> > builder.writeObject(infos.count)
> > foreach(var info in infos)
> > {
> > ? builder.writerObject(info)
> > }
> > /* or the suporting to array and dictionary already exists?*/
>
> > /* I have found in"src/client/impl/WireFormatting.cs"? there are
> > methods like "WriteArray", and "WriteTable"*/
>
> > ?IBasicProperties props = _channel.CreateBasicProperties();
> > props.DeliveryMode = 2;
> > ?_channel.BasicPublish(_exchangeName, "some key", props,
> > builder.GetContentBody());
> > -----------------
>
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-disc... at lists.rabbitmq.com
> >https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From emile at rabbitmq.com  Tue Jan  4 10:21:41 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Tue, 04 Jan 2011 10:21:41 +0000
Subject: [rabbitmq-discuss] how to send a message including a array via
 .net client?
In-Reply-To: <f8dff6ee-3d86-40f1-8429-c2ad8b44bf43@t35g2000yqj.googlegroups.com>
References: <afdb5cda-2531-4703-aa87-077f067a2102@o4g2000yqd.googlegroups.com>	<AANLkTin_k9FcSRgnBm2=bvdj+3qJFV6cdgu1sCGj+ief@mail.gmail.com>
	<f8dff6ee-3d86-40f1-8429-c2ad8b44bf43@t35g2000yqj.googlegroups.com>
Message-ID: <4D22F4B5.7080909@rabbitmq.com>

Hi Chen,

If your message producers and consumers are both .net then you may use 
any of the built-in .net serialisers.
See http://msdn.microsoft.com/en-us/library/7ay27kt9.aspx

If you are in a mixed language environment then a format like YAML, 
JSON, protocol buffers or perhaps XML makes more sense.

On 04/01/11 08:27, Chen Houwu wrote:
> Do you mean that .net client has no build-in support for simple data
> structure?
> But I have found it should support according to the AMQP 1.0
> specification.

The .net client supports byte arrays for message payloads as required by 
the AMQP 0.9.1 spec.

> AMQP is a binary protocol, but json is text.
> Though I can send binary content after encoding it to BASE64, it is
> too inefficient.

There is no need to use base64. Base64 would only be required if the 
payload needed to be 7bit clean.



Regards

Emile

From taylste at gmail.com  Tue Jan  4 10:22:47 2011
From: taylste at gmail.com (Steven Taylor)
Date: Tue, 4 Jan 2011 10:22:47 +0000
Subject: [rabbitmq-discuss] how to send a message including a array via
 .net client?
In-Reply-To: <f8dff6ee-3d86-40f1-8429-c2ad8b44bf43@t35g2000yqj.googlegroups.com>
References: <afdb5cda-2531-4703-aa87-077f067a2102@o4g2000yqd.googlegroups.com>
	<AANLkTin_k9FcSRgnBm2=bvdj+3qJFV6cdgu1sCGj+ief@mail.gmail.com>
	<f8dff6ee-3d86-40f1-8429-c2ad8b44bf43@t35g2000yqj.googlegroups.com>
Message-ID: <AANLkTikcextxUGfKv_-ZAaqtEG70DC4S4s=TVa3UJJAY@mail.gmail.com>

Hi Chen,

I like binary serialization at the moment.

http://msdn.microsoft.com/en-us/library/system.runtime.serialization.formatter.aspx

In future I'd like to use binary Json, and there's also google protobuffers
which look pretty good (not sure on how good the .net support is though).
Json is certainly better IMHO than XML. The binary / cross-platform binary
options are more suited to my purposes.

Under .net Json / Binary / Soap serialization works just about the same way.

http://pietschsoft.com/post/2008/02/NET-35-JSON-Serialization-using-the-DataContractJsonSerializer.aspx

Start off serializing / deserializing an object with one property. Get that
going and you'll find it's the same set of steps for anything that inherits
from "object" (includes arrays).  Tag it up / decorate it correctly, and job
done.  Step two, see if Rabbit handles it faithfully (it does for me).

cheers,
-Steven
On 4 January 2011 08:27, Chen Houwu <chenhouwu at gmail.com> wrote:

> Do you mean that .net client has no build-in support for simple data
> structure?
> But I have found it should support according to the AMQP 1.0
> specification.
> AMQP is a binary protocol, but json is text.
> Though I can send binary content after encoding it to BASE64, it is
> too inefficient.
>
> It seams as if the python client support array and dictionary
> object.....
>
> On 2010?12?29?, ??6?47?, Marek Majkowski <maje... at gmail.com> wrote:
> > Hi,
> >
> > I think you should be using some standardized encoding,
> > like for example json.
> >
> > Take a look at this library:
> http://james.newtonking.com/pages/json-net.aspxhttp://stackoverflow.com/questions/571168/what-json-library-works-wel.
> ..
> >
> > Cheers,
> >   Marek
>  >
> >
> >
> >
> >
> >
> >
> >
> >
> > On Mon, Dec 27, 2010 at 11:22, Chen Houwu <chenho... at gmail.com> wrote:
> > >   I am a newbie to rabbitmq, I want to send a message object as
> > > following via .net client:
> >
> > >   public class Message
> > >    {
> > >        public int ID { get; set; }
> > >        public string Name { get; set; }
> > >        public byte[] Binary { get; set; }
> > >        public string[] Infos{get;set;}
> > >        public Dictionary<string,int> CountMap { get; set; }
> > >    }
> >
> > > Here is my code:
> > > -------------------------------------------
> > > var builder = new
> > > RabbitMQ.Client.Content.StreamMessageBuilder(_channel);
> > > builder.writeObject(msg.ID);
> > > builder.writeObject(msg.Name);
> > > /*----------How to deal with msg.Infos and CountMap here?------------/
> >
> > > /*shoud it be written by myself such as: */
> > > builder.writeObject(infos.count)
> > > foreach(var info in infos)
> > > {
> > >   builder.writerObject(info)
> > > }
> > > /* or the suporting to array and dictionary already exists?*/
> >
> > > /* I have found in"src/client/impl/WireFormatting.cs"? there are
> > > methods like "WriteArray", and "WriteTable"*/
> >
> > >  IBasicProperties props = _channel.CreateBasicProperties();
> > > props.DeliveryMode = 2;
> > >  _channel.BasicPublish(_exchangeName, "some key", props,
> > > builder.GetContentBody());
> > > -----------------
> >
> > > _______________________________________________
> > > rabbitmq-discuss mailing list
> > > rabbitmq-disc... at lists.rabbitmq.com
> > >https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> >
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-disc... at lists.rabbitmq.comhttps://
> lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>  _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110104/8245a5f2/attachment.htm>

From chenhouwu at gmail.com  Tue Jan  4 11:25:57 2011
From: chenhouwu at gmail.com (Chen Houwu)
Date: Tue, 4 Jan 2011 03:25:57 -0800 (PST)
Subject: [rabbitmq-discuss] how to send a message including a array via
	.net client?
In-Reply-To: <AANLkTikcextxUGfKv_-ZAaqtEG70DC4S4s=TVa3UJJAY@mail.gmail.com>
References: <afdb5cda-2531-4703-aa87-077f067a2102@o4g2000yqd.googlegroups.com>
	<AANLkTin_k9FcSRgnBm2=bvdj+3qJFV6cdgu1sCGj+ief@mail.gmail.com>
	<f8dff6ee-3d86-40f1-8429-c2ad8b44bf43@t35g2000yqj.googlegroups.com>
	<AANLkTikcextxUGfKv_-ZAaqtEG70DC4S4s=TVa3UJJAY@mail.gmail.com>
Message-ID: <2b82c0c9-993f-4a7a-93f0-ca19ee15ef10@p1g2000yqm.googlegroups.com>

Thanks for all the above answers.

I studied the AMQP 0.9.1 and AMQP 1.0 specification, and found:

in 0.9.1:  only  opaque binary message content (here means the
*playload*) is supported.

but in 1.0 :  message content can be one of the following data type
A. opaque binary data: note, in particular, that the section is not an
instance of the AMQP binary type).
B. amqp-data: zero or more encoded AMQP values)
C. amqp-map: zero length or consist of a single encoded instance of an
AMQP map.
D. amqp-list: zero length or consist of a single encoded instance of
an AMQP list.

RabbitMQ's .net Client is supporting up to AMQP 0.9.1, so message
content does not support those data types other than opaque binary.

AMQP 1.0 has contained it's one message content format similar to JSON
and Protocol Buffer.

From cameron at cameronharris.org  Tue Jan  4 17:35:00 2011
From: cameron at cameronharris.org (Cameron Harris)
Date: Tue, 4 Jan 2011 17:35:00 +0000
Subject: [rabbitmq-discuss] .NET client Subscription constructor not using
	noAck parameter
Message-ID: <AANLkTinJRDY=Ya8Xf0EdUtgB6gs3Jh89_N-O5Q=G-wJM@mail.gmail.com>

Hi,

I think there's a bug in the Subscription class in the .NET client (
http://hg.rabbitmq.com/rabbitmq-dotnet-client/file/43c71543a9f9/projects/client/RabbitMQ.Client/src/client/messagepatterns/Subscription.cs).


On line 137, it appears that the constructor is not using the noAck
parameter. Therefore, when calling BasicConsume, the noAck parameter is
always its default value (false), which also contradicts the documentation
for the class. I guess it's missing a m_noAck = noAck.


Thanks,
Cameron Harris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110104/ae07f4ac/attachment.htm>

From emile at rabbitmq.com  Tue Jan  4 17:56:23 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Tue, 04 Jan 2011 17:56:23 +0000
Subject: [rabbitmq-discuss] .NET client Subscription constructor not
 using noAck parameter
In-Reply-To: <AANLkTinJRDY=Ya8Xf0EdUtgB6gs3Jh89_N-O5Q=G-wJM@mail.gmail.com>
References: <AANLkTinJRDY=Ya8Xf0EdUtgB6gs3Jh89_N-O5Q=G-wJM@mail.gmail.com>
Message-ID: <4D235F47.1020101@rabbitmq.com>


Hi Cameron,

On 04/01/11 17:35, Cameron Harris wrote:
> Hi,
>
> I think there's a bug in the Subscription class in the .NET client
> (http://hg.rabbitmq.com/rabbitmq-dotnet-client/file/43c71543a9f9/projects/client/RabbitMQ.Client/src/client/messagepatterns/Subscription.cs).
>
>
> On line 137, it appears that the constructor is not using the noAck
> parameter. Therefore, when calling BasicConsume, the noAck parameter is
> always its default value (false), which also contradicts the
> documentation for the class. I guess it's missing a m_noAck = noAck.

Thanks for bringing this to our attention. That is definitely a mistake 
which we will put right.

Regards

Emile

From clegnitto at mozilla.com  Tue Jan  4 21:21:12 2011
From: clegnitto at mozilla.com (Christian Legnitto)
Date: Tue, 4 Jan 2011 13:21:12 -0800
Subject: [rabbitmq-discuss] Security/resource limit questions
Message-ID: <A53EF604-615A-4BFB-988E-A01F97310E31@mozilla.com>

I intend to have RabbitMQ publicly available over the internet via AMQP and have some outstanding questions. I haven't had time to investigate these myself, but figured I'd send to the list as someone else may have the answers already. I am asking these about RabbitMQ itself. I realize the client libraries may have limitations of their own, possibly different.

* What characters are allowed / expected in the routing key, binding topic, queue name, user name, and password? Is it just ASCII? 
* What is the maximum length of the routing key, binding topic, queue name, user name, or password a client can specify? 
* If a message is rejected due to hitting max length or an invalid character, what happens? How are the limits enforced? Rejection? Truncation? Conversion?
* How many bindings are supported per queue? Is it possible to starve the broker of resources be specifying 100000s of bindings?
* Is it possible for malicious consumers to DOS the server by specifying 100000s of queues with 100000s of bindings listening to '#' on all exchanges?
* Is it possible for a malicious producer to be able to affect the AMQP message / behavior by including control characters / AMQP escape sequences in the message payload?
* Is it possible for malicious consumers to starve the broker of connections during protocol negotiation or consuming? What are the timeouts in place to prevent such an attack? Are they configurable?

Thanks,
Christian

From moseley at hank.org  Tue Jan  4 21:39:41 2011
From: moseley at hank.org (Bill Moseley)
Date: Tue, 4 Jan 2011 13:39:41 -0800
Subject: [rabbitmq-discuss] Web use scenarios
In-Reply-To: <AANLkTikkKOLWgFnRPmg=CkBzBfu=6uyMG4doYqfi0zX_@mail.gmail.com>
References: <AANLkTikkKOLWgFnRPmg=CkBzBfu=6uyMG4doYqfi0zX_@mail.gmail.com>
Message-ID: <AANLkTi=iLD3B2Us8dv2N0ciaL5-L5uLgmx-oUuwxwayN@mail.gmail.com>

Anyone have time to take a few of these on?

I know they are not specifically on-topic (and a bit open-ended) but we are
evaluating messaging solutions (and even discussing writing our own) so it
would be a huge help to get some feedback.  I'd be happy to provide more
specifics if needed.

Thanks,

On Mon, Jan 3, 2011 at 3:13 PM, Bill Moseley <moseley at hank.org> wrote:

> Hi,
>
> I'm just starting out with RabbitMQ and trying to wrap my head around a few
> concepts.  I apologize if I ask something that should be obvious or I missed
> in the docs and faq.  I'm hoping someone can help with a few scenarios, and
> please point me to further reading as needed.
>
> I'm curious about use-cases that are not directly related to RabbitMQ, but
> how to best use RabbitMQ in an web application's architecture.  Thes are
> probably very common situations.
>
> 1) Notification of job status and completion:  If the web app produces a
> request to generate an expensive PDF is there a common approach to detecting
> when the consumer is completed and the pdf is ready for downloading?  Should
> I create a single-use return queue with x-expires and/or x-message-ttl on
> the queue?   In a web app the web user may never come back to pick up the
> PDF.
>
> 2) Job sequencing:  What's a common approach to multiple step processing
> that must be done serially?  I.e. queue job "A" and when it's complete queue
> job "B".  Doesn't really seem like consumer "A" should be responsible for
> submitting job "B".  Is it better to create a consumer "AB" that submits "A"
> and waits for a message that "A" is complete and then submits job "B"?
>
> 3) Scheduling: I assume there's no facility for scheduling jobs to be
> delivered to consumers at some future time.  Is there a better approach than
> using cron to check the database for jobs that should be queued based on
> time?
>
> 4) Cancel a request:  We have some situations when a subsequent request
> should cancel processing of an earlier request.  (Frankly, I think this is a
> design problem on our end.)
>
> 5) Prevent duplicate job requests: In a web environment when things break
> problems often compound by users reloading requests that caused the problem
> in the first place.  I'm not sure RabbitMQ would be involved at all in this
> scenario, but I'm asking just in case. ;)
>
> Finally, it's great that RabbitMQ will send a message again if is is not
> ACK'd and a consumer closes its connection.  But, is there any kind of max
> retry count available?  That is, what's a good approach to prevent an errant
> job from killing all consumers one-by-one?
>
> Thanks,
>
> --
> Bill Moseley
> moseley at hank.org
>



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110104/ed1f8ec2/attachment.htm>

From andrew at glyde.com  Tue Jan  4 22:12:32 2011
From: andrew at glyde.com (andrew chase)
Date: Tue, 4 Jan 2011 14:12:32 -0800
Subject: [rabbitmq-discuss] Web use scenarios
In-Reply-To: <AANLkTi=iLD3B2Us8dv2N0ciaL5-L5uLgmx-oUuwxwayN@mail.gmail.com>
References: <AANLkTikkKOLWgFnRPmg=CkBzBfu=6uyMG4doYqfi0zX_@mail.gmail.com>
	<AANLkTi=iLD3B2Us8dv2N0ciaL5-L5uLgmx-oUuwxwayN@mail.gmail.com>
Message-ID: <AANLkTiknFBVjSBp44aXktc7hfMWDpiFV2YxJ7R1Dw1ki@mail.gmail.com>

Most of your bullet points are outside the realm (IMO) of what a
message system should be concerned with. In particular, it looks like
most of the features you're after are more in line with what a
background job processing system would handle. Those types of systems
often use messaging under the covers but often also use some type of
persistent data store in addition (or instead of) a messaging system.
I'd suggest taking a look at a couple of these systems to see if they
may be more what you're after (I know a couple ruby-based ones of the
top of my head like Resque, DelayedJob, etc
https://github.com/defunkt/resque).

When it comes to guaranteeing job completion, request cancellation,
etc, it's nice to use a persistent data store and if speed is your
concern there are a host of new non-RDBMS solutions out there that
would probably serve your needs well.

Maybe other rabbitmq folks disagree?

Cheers,
Andrew


On Tue, Jan 4, 2011 at 1:39 PM, Bill Moseley <moseley at hank.org> wrote:
> Anyone have time to take a few of these on?
> I know they are not specifically on-topic (and a bit open-ended) but we are
> evaluating messaging solutions (and even discussing writing our own) so it
> would be a huge help to get some feedback. ?I'd be happy to provide more
> specifics if needed.
> Thanks,
>
> On Mon, Jan 3, 2011 at 3:13 PM, Bill Moseley <moseley at hank.org> wrote:
>>
>> Hi,
>> I'm just starting out with RabbitMQ and trying to wrap my head around a
>> few concepts. ?I apologize if I ask something that should be obvious or I
>> missed in the docs and faq. ?I'm hoping someone can help with a few
>> scenarios, and please point me to further reading as needed.
>> I'm curious about use-cases that are not directly related to RabbitMQ, but
>> how to best use RabbitMQ in an web application's?architecture. ?Thes are
>> probably very common situations.
>> 1) Notification of job status and completion: ?If the web app produces a
>> request to generate an expensive PDF is there a common approach to detecting
>> when the consumer is completed and the pdf is ready for downloading? ?Should
>> I create a single-use return queue with x-expires and/or x-message-ttl on
>> the queue? ? In a web app the web user may never come back to pick up the
>> PDF.
>> 2) Job sequencing: ?What's a common approach to multiple step processing
>> that must be done serially? ?I.e. queue job "A" and when it's complete queue
>> job "B". ?Doesn't really seem like consumer "A" should be responsible for
>> submitting job "B". ?Is it better to create a consumer "AB" that submits "A"
>> and waits for a message that "A" is complete and then submits job "B"?
>> 3) Scheduling: I assume there's no facility for scheduling jobs to be
>> delivered to consumers at some future time. ?Is there a better approach than
>> using cron to check the database for jobs that should be queued based on
>> time?
>> 4) Cancel a request: ?We have some situations when a subsequent request
>> should cancel processing of an earlier request. ?(Frankly, I think this is a
>> design problem on our end.)
>> 5) Prevent duplicate job requests: In a web environment when things break
>> problems often compound by users reloading requests that caused the problem
>> in the first place. ?I'm not sure RabbitMQ would be involved at all in this
>> scenario, but I'm asking just in case. ;)
>> Finally, it's great that RabbitMQ will send a message again if is is not
>> ACK'd and a consumer closes its connection. ?But, is there any kind of max
>> retry count available? ?That is, what's a good approach to prevent an errant
>> job from killing all consumers one-by-one?
>> Thanks,
>> --
>> Bill Moseley
>> moseley at hank.org
>
>
>
> --
> Bill Moseley
> moseley at hank.org
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

From moseley at hank.org  Wed Jan  5 07:15:34 2011
From: moseley at hank.org (Bill Moseley)
Date: Tue, 4 Jan 2011 23:15:34 -0800
Subject: [rabbitmq-discuss] Web use scenarios
In-Reply-To: <AANLkTiknFBVjSBp44aXktc7hfMWDpiFV2YxJ7R1Dw1ki@mail.gmail.com>
References: <AANLkTikkKOLWgFnRPmg=CkBzBfu=6uyMG4doYqfi0zX_@mail.gmail.com>
	<AANLkTi=iLD3B2Us8dv2N0ciaL5-L5uLgmx-oUuwxwayN@mail.gmail.com>
	<AANLkTiknFBVjSBp44aXktc7hfMWDpiFV2YxJ7R1Dw1ki@mail.gmail.com>
Message-ID: <AANLkTikNM49e6J90OZaidDPEFXN7g9t=OkNwunV8mczO@mail.gmail.com>

On Tue, Jan 4, 2011 at 2:12 PM, andrew chase <andrew at glyde.com> wrote:

> Most of your bullet points are outside the realm (IMO) of what a
> message system should be concerned with. In particular, it looks like
> most of the features you're after are more in line with what a
> background job processing system would handle. Those types of systems
> often use messaging under the covers but often also use some type of
> persistent data store in addition (or instead of) a messaging system.
> I'd suggest taking a look at a couple of these systems to see if they
> may be more what you're after (I know a couple ruby-based ones of the
> top of my head like Resque, DelayedJob, etc
> https://github.com/defunkt/resque).
>

Thanks Andrew,

I spent some time looking at those tonight and came full circle.  Found a
post where Resque was used as a replacement for DJ and then in the post's
comments people suggesting RabbitMQ... ;)  I'll keep reading, though.  I
have plenty to learn.

I think our organization has been in the habit of building somewhat
monolithic code and are looking for a solution that does everything as we do
it now.  I'm concerned we will attempt to build our own if we can't find a
perfect fit, which I suspect is a much harder task to get right than we
think.  As for scheduling, we already have a database table with the
scheduled items, so maybe we only need a few producers that run from cron.


I had two slightly more RabbitMQ-specific questions that are hopefully more
straight forward to answer.

When a job is re-queued due to failure to ACK is there anything that
indicates to the next consumer that the message has already been delivered
to a failed consumer? I need a way to recognize that a message is causing
consumers to die and stop the job.

And is it a common pattern for consumers to use RabbitMQ to message back
that their work is done?  I was wondering if that's a good use for x-expires
and/or x-message-ttl.

Thanks again,


On Tue, Jan 4, 2011 at 1:39 PM, Bill Moseley <moseley at hank.org> wrote:
> > Anyone have time to take a few of these on?
> > I know they are not specifically on-topic (and a bit open-ended) but we
> are
> > evaluating messaging solutions (and even discussing writing our own) so
> it
> > would be a huge help to get some feedback.  I'd be happy to provide more
> > specifics if needed.
> > Thanks,
> >
> > On Mon, Jan 3, 2011 at 3:13 PM, Bill Moseley <moseley at hank.org> wrote:
> >>
> >> Hi,
> >> I'm just starting out with RabbitMQ and trying to wrap my head around a
> >> few concepts.  I apologize if I ask something that should be obvious or
> I
> >> missed in the docs and faq.  I'm hoping someone can help with a few
> >> scenarios, and please point me to further reading as needed.
> >> I'm curious about use-cases that are not directly related to RabbitMQ,
> but
> >> how to best use RabbitMQ in an web application's architecture.  Thes are
> >> probably very common situations.
> >> 1) Notification of job status and completion:  If the web app produces a
> >> request to generate an expensive PDF is there a common approach to
> detecting
> >> when the consumer is completed and the pdf is ready for downloading?
>  Should
> >> I create a single-use return queue with x-expires and/or x-message-ttl
> on
> >> the queue?   In a web app the web user may never come back to pick up
> the
> >> PDF.
> >> 2) Job sequencing:  What's a common approach to multiple step processing
> >> that must be done serially?  I.e. queue job "A" and when it's complete
> queue
> >> job "B".  Doesn't really seem like consumer "A" should be responsible
> for
> >> submitting job "B".  Is it better to create a consumer "AB" that submits
> "A"
> >> and waits for a message that "A" is complete and then submits job "B"?
> >> 3) Scheduling: I assume there's no facility for scheduling jobs to be
> >> delivered to consumers at some future time.  Is there a better approach
> than
> >> using cron to check the database for jobs that should be queued based on
> >> time?
> >> 4) Cancel a request:  We have some situations when a subsequent request
> >> should cancel processing of an earlier request.  (Frankly, I think this
> is a
> >> design problem on our end.)
> >> 5) Prevent duplicate job requests: In a web environment when things
> break
> >> problems often compound by users reloading requests that caused the
> problem
> >> in the first place.  I'm not sure RabbitMQ would be involved at all in
> this
> >> scenario, but I'm asking just in case. ;)
> >> Finally, it's great that RabbitMQ will send a message again if is is not
> >> ACK'd and a consumer closes its connection.  But, is there any kind of
> max
> >> retry count available?  That is, what's a good approach to prevent an
> errant
> >> job from killing all consumers one-by-one?
> >> Thanks,
> >> --
> >> Bill Moseley
> >> moseley at hank.org
> >
> >
> >
> > --
> > Bill Moseley
> > moseley at hank.org
> >
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-discuss at lists.rabbitmq.com
> > https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> >
> >
>



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110104/10cc6a80/attachment-0001.htm>

From thomasbam at gmail.com  Wed Jan  5 07:42:58 2011
From: thomasbam at gmail.com (Bruno Thomas)
Date: Wed, 5 Jan 2011 08:42:58 +0100
Subject: [rabbitmq-discuss] gen_event handler rabbit_error_logger crashed.
	Reason badarg
Message-ID: <AANLkTikxzE04_yY=VyaYHw4dq_731hE_frZHgKBB+0ox@mail.gmail.com>

Hi All,

First of all, happy new year 2011.

We have rabbitmq (1.8.0) in production since 7th of december. There is
a virtual IP proxy in front of two rabbitmq server nodes (2 machines)
clustered.

We see sometimes theses errors in rabbitmq logs, causing one node to
fall, and then be restarted by the cluster :

=ERROR REPORT==== 22-Dec-2010::20:31:10 ===
** gen_event handler rabbit_error_logger crashed.
** Was installed in error_logger
** Last event was: {info_msg,<0.113.0>,
                             {<0.161.0>,
                              "closing TCP connection ~p from ~s:~p~n",
                              [<0.19903.120>,"10.175.60.13",56518]}}
** When handler state == {resource,<<"/">>,exchange,<<"amq.rabbitmq.log">>}
** Reason == {badarg,[{ets,lookup,[rabbit_exchange_type_registry,topic]},
                      {rabbit_exchange_type_registry,lookup_module,1},
                      {rabbit_exchange,type_to_module,1},
                      {rabbit_exchange,publish,3},
                      {rabbit_basic,publish,1},
                      {rabbit_error_logger,publish1,4},
                      {rabbit_error_logger,handle_event,2},
                      {gen_event,server_update,4}]}

Do you have an idea of what it means ?
Do you think we should upgrade to 2.2.0 ?

Thank you for your answsers.

Bruno Thomas

From taylste at gmail.com  Wed Jan  5 09:01:42 2011
From: taylste at gmail.com (Steven Taylor)
Date: Wed, 5 Jan 2011 09:01:42 +0000
Subject: [rabbitmq-discuss] how to send a message including a array via
 .net client?
In-Reply-To: <2b82c0c9-993f-4a7a-93f0-ca19ee15ef10@p1g2000yqm.googlegroups.com>
References: <afdb5cda-2531-4703-aa87-077f067a2102@o4g2000yqd.googlegroups.com>
	<AANLkTin_k9FcSRgnBm2=bvdj+3qJFV6cdgu1sCGj+ief@mail.gmail.com>
	<f8dff6ee-3d86-40f1-8429-c2ad8b44bf43@t35g2000yqj.googlegroups.com>
	<AANLkTikcextxUGfKv_-ZAaqtEG70DC4S4s=TVa3UJJAY@mail.gmail.com>
	<2b82c0c9-993f-4a7a-93f0-ca19ee15ef10@p1g2000yqm.googlegroups.com>
Message-ID: <AANLkTikw4Ly7wj5cCw=FB+VU6NbjdQdE4JkdtG-V3EVb@mail.gmail.com>

where did you find that spec?  I wonder what map, list, and values look
like. I remember one compact message format rendered XML as value
pairs seperated by 0x00. If not now, perhaps RabbitMQ will support these
message formats in the future.  If you took a tunneling approach, binary is
a pretty good catch all.

1. render to Json (or other format), 2. render to binary.

I suppose the downside is it's less transparent at the tansport level.
-Steven
On 4 January 2011 11:25, Chen Houwu <chenhouwu at gmail.com> wrote:

> Thanks for all the above answers.
>
> I studied the AMQP 0.9.1 and AMQP 1.0 specification, and found:
>
> in 0.9.1:  only  opaque binary message content (here means the
> *playload*) is supported.
>
> but in 1.0 :  message content can be one of the following data type
> A. opaque binary data: note, in particular, that the section is not an
> instance of the AMQP binary type).
> B. amqp-data: zero or more encoded AMQP values)
> C. amqp-map: zero length or consist of a single encoded instance of an
> AMQP map.
> D. amqp-list: zero length or consist of a single encoded instance of
> an AMQP list.
>
> RabbitMQ's .net Client is supporting up to AMQP 0.9.1, so message
> content does not support those data types other than opaque binary.
>
> AMQP 1.0 has contained it's one message content format similar to JSON
> and Protocol Buffer.
>  _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110105/38e6ecfb/attachment.htm>

From henrik at beepsend.se  Wed Jan  5 10:04:10 2011
From: henrik at beepsend.se (Henrik Abrahamsson)
Date: Wed, 5 Jan 2011 11:04:10 +0100
Subject: [rabbitmq-discuss] Stability of repository code
Message-ID: <AANLkTim-pQBBiw4YbFwA=Z_jmZteb4WU4LvzLUr5E3ht@mail.gmail.com>

Hello,

I'm running into some bugs that are solved in the hg repository but are not
in any release yet. To solve this I'm planning to build and run the
rabbitmq-server from repository code. So my question is how stable is the
"default" branch of the repository code? Is it a bad idea to run it on a
production system or should it be considered just as stable as a normal
release?

/Henrik
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110105/e08ee2de/attachment.htm>

From simon at rabbitmq.com  Wed Jan  5 10:18:00 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Wed, 05 Jan 2011 10:18:00 +0000
Subject: [rabbitmq-discuss] Stability of repository code
In-Reply-To: <AANLkTim-pQBBiw4YbFwA=Z_jmZteb4WU4LvzLUr5E3ht@mail.gmail.com>
References: <AANLkTim-pQBBiw4YbFwA=Z_jmZteb4WU4LvzLUr5E3ht@mail.gmail.com>
Message-ID: <4D244558.1030601@rabbitmq.com>

On 05/01/11 10:04, Henrik Abrahamsson wrote:
> I'm running into some bugs that are solved in the hg repository but are
> not in any release yet. To solve this I'm planning to build and run the
> rabbitmq-server from repository code. So my question is how stable is
> the "default" branch of the repository code? Is it a bad idea to run it
> on a production system or should it be considered just as stable as a
> normal release?

Hi Henrik. I would expect you should be fine; work is done on branches 
and then QAed before being merged so the quality level is in general 
fairly reasonable. Whether to use it in production depends on how 
conservative you are. I would, but then I might be biased :)

Be aware that if you use any plugins you will very likely need to 
compile all of them from default too.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From david at rabbitmq.com  Wed Jan  5 11:15:05 2011
From: david at rabbitmq.com (David Wragg)
Date: Wed, 05 Jan 2011 11:15:05 +0000
Subject: [rabbitmq-discuss] how to send a message including a array via
	.net client?
In-Reply-To: <2b82c0c9-993f-4a7a-93f0-ca19ee15ef10@p1g2000yqm.googlegroups.com>
	(Chen Houwu's message of "Tue, 4 Jan 2011 03:25:57 -0800 (PST)")
References: <afdb5cda-2531-4703-aa87-077f067a2102@o4g2000yqd.googlegroups.com>
	<AANLkTin_k9FcSRgnBm2=bvdj+3qJFV6cdgu1sCGj+ief@mail.gmail.com>
	<f8dff6ee-3d86-40f1-8429-c2ad8b44bf43@t35g2000yqj.googlegroups.com>
	<AANLkTikcextxUGfKv_-ZAaqtEG70DC4S4s=TVa3UJJAY@mail.gmail.com>
	<2b82c0c9-993f-4a7a-93f0-ca19ee15ef10@p1g2000yqm.googlegroups.com>
Message-ID: <yrv4c8vyzbo06.fsf@dwragg.eng.vmware.com>

Hi,

Chen Houwu <chenhouwu at gmail.com> writes:
> I studied the AMQP 0.9.1 and AMQP 1.0 specification, and found:
>
> in 0.9.1:  only  opaque binary message content (here means the
> *playload*) is supported.

While the 0.9.1 payload is binary, it is not necessarily opaque: The
Content-Type heaer should be used to identify the format contained
within that payload.  There are many established serialization formats
that you can choose from: JSON, XML, ASN.1 (in its various encodings),
language/platform-specific formats, etc.

Of course, the binary payload is opaque to the message broker, but
that is a good thing - why should the message broker constrain the
message formats that can be used?

> but in 1.0 :  message content can be one of the following data type
> A. opaque binary data: note, in particular, that the section is not an
> instance of the AMQP binary type).
> B. amqp-data: zero or more encoded AMQP values)
> C. amqp-map: zero length or consist of a single encoded instance of an
> AMQP map.
> D. amqp-list: zero length or consist of a single encoded instance of
> an AMQP list.

This feature of 1.0 is questionable.  The serialization format is
specific to AMQP 1.0.  It is not necessarily suited to the needs of
messaging applications (as opposed to a messaging protocol).  And while
and AMQP client and server must implement that format, their
implementations may be optimised to work in their target context, and so
lack features and convenient APIs that would make them suitable for
general application use.

David

From alexis at rabbitmq.com  Wed Jan  5 12:14:58 2011
From: alexis at rabbitmq.com (Alexis Richardson)
Date: Wed, 5 Jan 2011 12:14:58 +0000
Subject: [rabbitmq-discuss] Web use scenarios
In-Reply-To: <AANLkTiknFBVjSBp44aXktc7hfMWDpiFV2YxJ7R1Dw1ki@mail.gmail.com>
References: <AANLkTikkKOLWgFnRPmg=CkBzBfu=6uyMG4doYqfi0zX_@mail.gmail.com>
	<AANLkTi=iLD3B2Us8dv2N0ciaL5-L5uLgmx-oUuwxwayN@mail.gmail.com>
	<AANLkTiknFBVjSBp44aXktc7hfMWDpiFV2YxJ7R1Dw1ki@mail.gmail.com>
Message-ID: <AANLkTi=HV0=PsDpQ2=8fWufryNViL7SKtizuGbMYb7de@mail.gmail.com>

Andrew

We agree that databases and queues are different in that queues can be
seen as data for FIFO, streamed, delivery, whereas databases support
more general queries.

Rabbit is currently FIFO which means that other models have to be
supported at the application layer, eg by using clever routing
patterns, clients with timers, and so on.

Projects like Celery are worth understanding here.

alexis


On Tue, Jan 4, 2011 at 10:12 PM, andrew chase <andrew at glyde.com> wrote:
> Most of your bullet points are outside the realm (IMO) of what a
> message system should be concerned with. In particular, it looks like
> most of the features you're after are more in line with what a
> background job processing system would handle. Those types of systems
> often use messaging under the covers but often also use some type of
> persistent data store in addition (or instead of) a messaging system.
> I'd suggest taking a look at a couple of these systems to see if they
> may be more what you're after (I know a couple ruby-based ones of the
> top of my head like Resque, DelayedJob, etc
> https://github.com/defunkt/resque).
>
> When it comes to guaranteeing job completion, request cancellation,
> etc, it's nice to use a persistent data store and if speed is your
> concern there are a host of new non-RDBMS solutions out there that
> would probably serve your needs well.
>
> Maybe other rabbitmq folks disagree?
>
> Cheers,
> Andrew
>
>
> On Tue, Jan 4, 2011 at 1:39 PM, Bill Moseley <moseley at hank.org> wrote:
>> Anyone have time to take a few of these on?
>> I know they are not specifically on-topic (and a bit open-ended) but we are
>> evaluating messaging solutions (and even discussing writing our own) so it
>> would be a huge help to get some feedback. ?I'd be happy to provide more
>> specifics if needed.
>> Thanks,
>>
>> On Mon, Jan 3, 2011 at 3:13 PM, Bill Moseley <moseley at hank.org> wrote:
>>>
>>> Hi,
>>> I'm just starting out with RabbitMQ and trying to wrap my head around a
>>> few concepts. ?I apologize if I ask something that should be obvious or I
>>> missed in the docs and faq. ?I'm hoping someone can help with a few
>>> scenarios, and please point me to further reading as needed.
>>> I'm curious about use-cases that are not directly related to RabbitMQ, but
>>> how to best use RabbitMQ in an web application's?architecture. ?Thes are
>>> probably very common situations.
>>> 1) Notification of job status and completion: ?If the web app produces a
>>> request to generate an expensive PDF is there a common approach to detecting
>>> when the consumer is completed and the pdf is ready for downloading? ?Should
>>> I create a single-use return queue with x-expires and/or x-message-ttl on
>>> the queue? ? In a web app the web user may never come back to pick up the
>>> PDF.
>>> 2) Job sequencing: ?What's a common approach to multiple step processing
>>> that must be done serially? ?I.e. queue job "A" and when it's complete queue
>>> job "B". ?Doesn't really seem like consumer "A" should be responsible for
>>> submitting job "B". ?Is it better to create a consumer "AB" that submits "A"
>>> and waits for a message that "A" is complete and then submits job "B"?
>>> 3) Scheduling: I assume there's no facility for scheduling jobs to be
>>> delivered to consumers at some future time. ?Is there a better approach than
>>> using cron to check the database for jobs that should be queued based on
>>> time?
>>> 4) Cancel a request: ?We have some situations when a subsequent request
>>> should cancel processing of an earlier request. ?(Frankly, I think this is a
>>> design problem on our end.)
>>> 5) Prevent duplicate job requests: In a web environment when things break
>>> problems often compound by users reloading requests that caused the problem
>>> in the first place. ?I'm not sure RabbitMQ would be involved at all in this
>>> scenario, but I'm asking just in case. ;)
>>> Finally, it's great that RabbitMQ will send a message again if is is not
>>> ACK'd and a consumer closes its connection. ?But, is there any kind of max
>>> retry count available? ?That is, what's a good approach to prevent an errant
>>> job from killing all consumers one-by-one?
>>> Thanks,
>>> --
>>> Bill Moseley
>>> moseley at hank.org
>>
>>
>>
>> --
>> Bill Moseley
>> moseley at hank.org
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From emile at rabbitmq.com  Wed Jan  5 12:30:37 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Wed, 05 Jan 2011 12:30:37 +0000
Subject: [rabbitmq-discuss] Wcf one-way call
In-Reply-To: <AANLkTikAj4mWATsweQkw0wMqGEm3pvqZpcGscmv0RbDz@mail.gmail.com>
References: <AANLkTikAj4mWATsweQkw0wMqGEm3pvqZpcGscmv0RbDz@mail.gmail.com>
Message-ID: <4D24646D.6030505@rabbitmq.com>

Hi Vadim,

On 03/01/11 17:37, Vadim Chekan wrote:
> Hi all,
>
> For cache invalidation purposes I am trying to implement a broadcast
> as a one-way call using wcf. As long as it is a broadcast call, I
> don't expect any response. So it must be one-way call. But I
> experience blocking waiting for response until timeout.

Does the same happen when you run OneWayTest? 
(http://hg.rabbitmq.com/rabbitmq-dotnet-client/file/default/projects/examples/wcf/Test/OneWayTest/)
Do all the other samples complete successfully?

Has a return queue been set up on the broker when at the time of waiting?

Is there anything of interest in the broker logfile?

Regards

Emile

From gunnlaugur at gmail.com  Wed Jan  5 12:22:26 2011
From: gunnlaugur at gmail.com (Gunnlaugur Briem)
Date: Wed, 5 Jan 2011 04:22:26 -0800 (PST)
Subject: [rabbitmq-discuss] Building rabbit mq server on mac
In-Reply-To: <8A58327F-DEF8-44C6-AD4D-5DA42FDFCFE8@vmware.com>
Message-ID: <5018328.2639.1294230146836.JavaMail.geo-discussion-forums@yqng23>

Hi guys,

Use the special-purpose MacPorts repository at rabbitmq.com, it is more 
up-to-date and, well, works. 

Instructions: http://www.rabbitmq.com/macports.html

Regards,

- Gulli

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110105/6cae011f/attachment.htm>

From emile at rabbitmq.com  Wed Jan  5 14:14:54 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Wed, 05 Jan 2011 14:14:54 +0000
Subject: [rabbitmq-discuss] Security/resource limit questions
In-Reply-To: <A53EF604-615A-4BFB-988E-A01F97310E31@mozilla.com>
References: <A53EF604-615A-4BFB-988E-A01F97310E31@mozilla.com>
Message-ID: <4D247CDE.4070902@rabbitmq.com>

Hi Christian

On 04/01/11 21:21, Christian Legnitto wrote:

> * What characters are allowed / expected in the routing key, binding
> topic, queue name, user name, and password? Is it just ASCII?

The AMQP 0.9.1 specification offers this:

"""
Short strings, used to hold short text properties. Short strings are 
limited to 255 octets and can be parsed with no risk of buffer overflows.

Short strings can carry up to 255 octets of UTF-8 data, but may not 
contain binary zero octets.

The routing key used for a topic exchange MUST consist of zero or more 
words delimited by dots. Each word may contain the letters A-Z and a-z 
and digits 0-9.

Standard message queues are prefixed by "amq."
"""

The routing key and queue name are short strings. I don't see any 
limitations on usernames and passwords, but SASL will complain if they 
contain null bytes.

RabbitMQ represents short strings as Erlang binaries internally without 
enforcing the alphabet from the specification.

> * What is the maximum length of the routing key, binding topic, queue
> name, user name, or password a client can specify?

Length of username and password appear unlimited. The rest are 255 bytes.

> * If a message is rejected due to hitting max length or an invalid
> character, what happens? How are the limits enforced? Rejection?
> Truncation? Conversion?

Clients should prevent this problem, e.g. 
com.rabbitmq.client.impl.ValueWriter in the Java client contains this:
"Short string too long [...] max = 255."

If a long shortstr reaches the broker it will produce a 
"method_field_shortstr_overflow" exception in the framing layer.

> * How many bindings are supported per queue? Is it possible to starve
> the broker of resources be specifying 100000s of bindings?

The number of bindings is limited by the amount of RAM you have. The 
broker has much more work to do in that case, so you can expect slower 
operation, depending on the exchange type.

> * Is it possible for malicious consumers to DOS the server by
> specifying 100000s of queues with 100000s of bindings listening to
> '#' on all exchanges?

Yes. Perhaps there should be some configurable limits...

> * Is it possible for a malicious producer to be able to affect the
> AMQP message / behavior by including control characters / AMQP escape
> sequences in the message payload?

No, as long as the framing is correct the broker does not care about the 
content.

> * Is it possible for malicious consumers to starve the broker of
> connections during protocol negotiation or consuming? What are the
> timeouts in place to prevent such an attack? Are they configurable?

The protocol negotiation phase has a 3 sec timeout to prevent that. The 
timeout is not configurable - you will need to modify the definitions in 
rabbit_reader.erl and recompile if you want a different value.



Regards

Emile

From moshima at advent.com  Wed Jan  5 14:48:51 2011
From: moshima at advent.com (Michi Oshima)
Date: Wed, 5 Jan 2011 06:48:51 -0800 (PST)
Subject: [rabbitmq-discuss] Private messages
In-Reply-To: <4D1B2B6F.2030604@rabbitmq.com>
References: <30539657.post@talk.nabble.com> <4D1B2B6F.2030604@rabbitmq.com>
Message-ID: <30596562.post@talk.nabble.com>


Thanks for your reply, Emile.  A happy new year to you.


Emile Joubert-2 wrote:
> 
> 
> Op 27/12/2010 15:41, het Michi Oshima geskryf:
>>
>> 7. Producer binds queues on behalf of consumers.
> 
> This is very restrictive and demands too much cooperation between 
> producers and consumers.
> 
> 

I agree.  I couldn't think of a better alternative, however.  I am eager to
know if there is one.


Emile Joubert-2 wrote:
> 
> 
>> 8. Producer binds a queue with two items in the header
> 
> This has consequences in the broker beyond the immediate problem and 
> makes it impossible to specify recipients on a per-message basis.
> 
> 

I don't quite understand this.  Can you elaborate more?  What kind of
consequences do you have in mind?  

My proposal allows specifying recipients on a per-message basis, in my mind. 
Producer would populate the header table of a given message with IDs of the
recipients for that message.  Non-recipients wouldn't get the message. 
Also, Producer may specify a different set of recipients for the next
message.


-- 
View this message in context: http://old.nabble.com/Private-messages-tp30539657p30596562.html
Sent from the RabbitMQ mailing list archive at Nabble.com.


From matthias at rabbitmq.com  Wed Jan  5 16:36:24 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Wed, 05 Jan 2011 16:36:24 +0000
Subject: [rabbitmq-discuss] Security/resource limit questions
In-Reply-To: <4D247CDE.4070902@rabbitmq.com>
References: <A53EF604-615A-4BFB-988E-A01F97310E31@mozilla.com>
	<4D247CDE.4070902@rabbitmq.com>
Message-ID: <4D249E08.60602@rabbitmq.com>

Emile Joubert wrote:
> If a long shortstr reaches the broker it will produce a 
> "method_field_shortstr_overflow" exception in the framing layer.

That cannot happen on the inbound side. short strings are encoded with a 
1-byte length prefix, so there is no way for the client to send a long 
shortstr. And in a standard broker setup it cannot happen on the 
outbound side either since the broker does not create shortstrs (except 
for error messages, which get truncated at 255).

Matthias.

From clegnitto at mozilla.com  Wed Jan  5 17:24:33 2011
From: clegnitto at mozilla.com (Christian Legnitto)
Date: Wed, 5 Jan 2011 09:24:33 -0800
Subject: [rabbitmq-discuss] Security/resource limit questions
In-Reply-To: <4D249E08.60602@rabbitmq.com>
References: <A53EF604-615A-4BFB-988E-A01F97310E31@mozilla.com>
	<4D247CDE.4070902@rabbitmq.com> <4D249E08.60602@rabbitmq.com>
Message-ID: <6F201978-3DC3-499E-8FE5-7D4C4C7CD161@mozilla.com>

On Jan 5, 2011, at 8:36 AM, Matthias Radestock wrote:

> Emile Joubert wrote:
>> If a long shortstr reaches the broker it will produce a "method_field_shortstr_overflow" exception in the framing layer.
> 
> That cannot happen on the inbound side. short strings are encoded with a 1-byte length prefix, so there is no way for the client to send a long shortstr. And in a standard broker setup it cannot happen on the outbound side either since the broker does not create shortstrs (except for error messages, which get truncated at 255).
> 

Great to know, thanks!


From emile at rabbitmq.com  Wed Jan  5 18:07:42 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Wed, 05 Jan 2011 18:07:42 +0000
Subject: [rabbitmq-discuss] Private messages
In-Reply-To: <30596562.post@talk.nabble.com>
References: <30539657.post@talk.nabble.com> <4D1B2B6F.2030604@rabbitmq.com>
	<30596562.post@talk.nabble.com>
Message-ID: <4D24B36E.5000305@rabbitmq.com>

Hi Michi,

On 05/01/11 14:48, Michi Oshima wrote:

>>> 8. Producer binds a queue with two items in the header
>>
>> This has consequences in the broker beyond the immediate problem and
>> makes it impossible to specify recipients on a per-message basis.
>>
>>
>
> I don't quite understand this.  Can you elaborate more?  What kind of
> consequences do you have in mind?

I'm not clear on whether your design requires modification to the 
broker. If not then ignore my comment.

> My proposal allows specifying recipients on a per-message basis, in my mind.
> Producer would populate the header table of a given message with IDs of the
> recipients for that message.  Non-recipients wouldn't get the message.
> Also, Producer may specify a different set of recipients for the next
> message.

In that case I misread your email - sorry. If your design allows 
producers to specify a set of recipients per message then that is good.


Regards


Emile

From jerryk at vmware.com  Thu Jan  6 02:43:15 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Wed, 5 Jan 2011 18:43:15 -0800
Subject: [rabbitmq-discuss] |Spam| Memory usage about java client?
In-Reply-To: <tencent_27E29974704106537F5DB1EA@qq.com>
References: <tencent_27E29974704106537F5DB1EA@qq.com>
Message-ID: <126BB34D-0539-4EFC-B9EA-6BFB7E196921@vmware.com>

Hi, Yaohui...  Responses are inline below...

On Dec 30, 2010, at 3:56 AM, yaohui wrote:

   My java client would use memory of JVM that i defined  by -Xms512m -Xmm512m. Is that normal?
someon tell me the reason. There exist another methode of client not using loop while(true)?

To avoid having your client memory swamped in this way, you need to impose some limits on how much data the server will deliver to your consumer before the server requires an acknowledgment.

You can do this using the basicQos method on the Channel class, which is documented here:

http://www.rabbitmq.com/javadoc/com/rabbitmq/client/Channel.html#basicQos(int,%20int,%20boolean)

The different forms of basicQos(...) let you specify how many messages or octets of data the server should let itself send before an ack is needed to continue.

Also, in your call to basicConsume(...) you should specify 'false' for the second parameter below.  Passing a t'rue' indicates that the server should consider messages acknowledged as soon as they're delivered to the QueueingConsumer you've created.  Passing a 'false' instead will make the server expect explicit acknowledgments, which you can then provide with a call to basicAck on Channel, something like:

chan.basicAck(delivery.getEnvelope().getDeliveryTag(), false);

after you've done your thing with the message data you obtained with delivery.getBody().

The boolean flag in the second argument to basicAck lets you avoid ack-ing each delivery individually, by letting you ack multiple messages up to and including the delivery tag you specify.  This lets you handle thing in batches if appropriate, which you may find to be more efficient.

With regard to your second question about whether you need to use the "while(true)" idiom employed in your example, the answer is "yes, there is another way to do things."  You are free to implement the Consumer interface directly.  See its Javadoc at:

http://www.rabbitmq.com/releases/rabbitmq-java-client/v2.1.0/rabbitmq-java-client-javadoc-2.1.0/com/rabbitmq/client/Consumer.html

Notice that you'll want to be prudent in what you do in your implementation of Consumer, since its methods are going to be called on the thread that's running your Connection.  Thus, you'll want to avoid blocking, bogging down in long running operations, etc.

Also, the SimpleConsumer example in the 'examples' directory of the RabbitMQ directory might be instructive to look at.  It demonstrates a scenario very close to what you're doing here and comes with a matching SimpleProducer for you to experiment with.  The examples (and the unit tests) can be a treasure trove of examples of RabbitMQ and AMQP usage.

Best regards,
Jerry

 my code is like this:
  Connection conn = null;
  ConnectionFactory factory = new ConnectionFactory();
  factory.setHost("localhost");
  conn = factory.newConnection();
  Channel chan = conn.createChannel();

  chan.queueDeclare("your_queue" , false, false, false, null);
  QueueingConsumer consumer = new QueueingConsumer(chan);
  chan.basicConsume("your_queue", true, consumer);

  while (true) {
    try {
       delivery = consumer.nextDelivery();
       byte msg[] = delivery.getBody();

     } catch (InterruptedException ie) {
       System.out.println("Error: " + ie);
       continue;
    }
 }



From sgarrity at gmail.com  Thu Jan  6 03:43:48 2011
From: sgarrity at gmail.com (Steve Garrity)
Date: Wed, 5 Jan 2011 19:43:48 -0800 (PST)
Subject: [rabbitmq-discuss] Persister logs never getting rolled/cleaned up?
Message-ID: <5c18a357-5043-4506-9ae2-d14c67047abd@y19g2000prb.googlegroups.com>

Apologies if this is a n00b question, which I think it is, but we're
running a plain vanilla install of rabbitmq 2.1.1 on erlang r14B with
celeryd 2.1.4 and we're continually running into persister log issues
and Google has thus far not turned up results.

Every few weeks rabbit just stops accepting new connections...stopping
and starting rabbit takes on the order of 15 minutes and it just
continues to choke once it gets started again. Looking at /var/lib/
rabbitmq/mnesia/rabbit shows ~170MB of persister logs (this is running
on a 1GB RAM machine, so the vm memory alarm is set at ~400MB (which
we routinely bounce off of trying to reload these logs). By deleting
(or renaming) this directory, recreating users/vhosts, and restarting
rabbit, everything works great again (for a few weeks).

This led us to believe we were using celery incorrectly and
accidentally persisting results for all time, but we've tried with
ignore_result=True, delivery_mode=transient, durable=False, and
result_persistent=False and nothing seems to fix it.

These don't seem like logs that we should have to rotate
manually...can someone point us in the right direction?

Thanks! /s

From PRYD at mach.com  Thu Jan  6 09:15:10 2011
From: PRYD at mach.com (Prashant Yadav)
Date: Thu, 6 Jan 2011 14:45:10 +0530
Subject: [rabbitmq-discuss] Handling Undelivered messages in rabbitmq
Message-ID: <11EC96EC521B304EA05595E6F2987FC2028D4A45@EXCHBAN.machcorp.lan>

Hi,

 

For one of the reuirement we need to keep track of queue depth and
successfully processed messages. The idea is to publish messages and get
a list of successful and failed messages. To simulate the requirement I
did the following

 

1)      Publish the messages with Mandatory and Immediate flag sent
channel.basicPublish 'exchange' ,'rKey',true,false, props,"Hello
World".bytes

2)      The consumer consumes even marked ( I have put numbers from
1..10 as marked value in header of each messages)  and does not ACKS odd
numbered messages.

3)      I have implemented setReturnListnere in the publisher to capture
undelivered messages.

 

While am able to get the number of unack messages via Rabbmitmqctl
list_queues messages_unacknowledged, somehow my handleBasicReturn method
does not gets called. Am in missing something.

 

Code snippets:

 

Producer:

channel.setReturnListener(new ReturnListener() {

        public void handleBasicReturn(int replyCode, 

 
String replyText, 

 
String exchange, 

 
String routingKey, 

 
AMQP.BasicProperties properties, 

 
byte[] body) 

            throws IOException {

                                                println "Debugging
messages!!!!"

            println "The details of returned messages are ${replyText}
from  ${exchange} with routingKey as ${routingKey} with properties"

        }

    });

 

println " queuename is ${dec.queue} and consumerCount is
${dec.consumerCount} messageCount is ${dec.messageCount}"

                (1..10).each {

                                println "Sending file ${i}....."

                                def headers = new
HashMap<String,Object>()

                                headers.put "operatiion","scp"

                                headers.put "dest","joker.dk.mach.com"

                                headers.put "id", i

                                println headers

 

                                BasicProperties props = new
BasicProperties(null, null, headers, null, null, null, null, null,null,
null, null, null,null, null)

                                                channel.basicPublish
'exchange' ,'rKey',true,false, props,"Hello Worls".bytes


                                i++                         

                }

channel.close()

 

Consumer:

while (true) {

                def delivery = consumer.nextDelivery()

                def headers = delivery?.properties?.headers

                def id = headers.get("id")

    println "Received message:"

                println " ${id.toString()}"

 

                if( id % 2 == 0){

                channel.basicAck delivery.envelope.deliveryTag, false


                }    

}

 

Regds

Pras

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110106/e6246eb2/attachment-0001.htm>

From rob at rabbitmq.com  Thu Jan  6 10:21:43 2011
From: rob at rabbitmq.com (Rob Harrop)
Date: Thu, 06 Jan 2011 10:21:43 +0000
Subject: [rabbitmq-discuss] Forcing headers on incoming commands
In-Reply-To: <AANLkTinzfjZ-VCQ-06pDNTxAwyMep+C1xz0QJOLE=+UB@mail.gmail.com>
References: <AANLkTinzfjZ-VCQ-06pDNTxAwyMep+C1xz0QJOLE=+UB@mail.gmail.com>
Message-ID: <97f25a64610a22aca79fb410868183fb@rabbitmq.com>

Hi Mike,

On Mon, 27 Dec 2010 21:26:04 -0500, Mike Keen <mkeen.atl at gmail.com> wrote:
> Hello,
> 
> I'm part of a small group working on a realtime social game powered by
> RabbitMQ/STOMP and run on Flash clients in the browser.
> 
> We've run into some security concerns related to exposing our STOMP port
to
> the public. Specifically, we've noticed that without the "exclusive:
true"
> header in an initial subscription (even to an anonymous queue), and the
> socket is dropped before the client sends a clean disconnect, the queues
> remain open for a pretty long time (at least a few minutes). This has
lead
> to the concern that an attacker might be able to create any number of
> queues
> that could hang around and waste memory, or even lead to memory being
> exhausted.

A few things have changed in the STOMP adapter that make this a bit
different now. 

Most importantly, custom headers such as 'exclusive' are no longer
supported. Instead, we now support destination types with set semantics.
The support destinations are /queue/<name>, /topic/<name> and
/exchange/<name>/<routing_key>. The /queue and /topic types are designed to
work as closely to the corresponding types in ActiveMQ as possible.

For /queue, created queues are now durable and are not exclusive. This
means that it is a separate administration task to clean up queues. This is
designed to match ActiveMQ.

For /topic, a queue is created per SUBSCRIPTION, but only lasts for the
duration of that subscription. That means that after all subscribers to a
topic destination disconnect, no queues exist for that topic.

I recently updated the README for this. The changes are still going
through QA, but the relevant revision can be found here:
http://hg.rabbitmq.com/rabbitmq-stomp/file/6cfb4d0f9cd9/README.md.

> 
> Two questions considering the above:
> 
> 1) Is it possible to set, through the config file, to force
queue.exclusive
> = true on every new queue creation on the server?

This isn't possible at the moment. I don't think we have any plans to
introduce such a feature.

> 
> 2) Is this a legitimate security concern? Or would a massive number of
> queues (all bound to a topic exchange) not be enough to cause
performance
> issues?

Well, importantly, you can only create queues if you are an authenticated
user, so the attacker would need to get past that hurdle first. I have a
task to add SSL support for STOMP which will make sending credentials in
the CONNECT header a lot safer :)

Also, if you're using  /topic destinations (probably the easiest way in
the new adapter to access topic semantics), then you would have to have a
large number of active subscriptions in order to have a large number of
queues. RabbitMQ handles large numbers of queues nicely, so for this to be
a major problem, you'd need to a large number of subscriptions created on a
topic that has a large publish volume. The subscriptions would have to be
in ack:client mode and would need to *not* ack the messsages. Even then,
new support in RabbitMQ 2.2.0 for handling large ack volumes means that you
a really only limited by disk space when it comes to the ack backlog. 

One possible issue is that storing transaction state for STOMP transaction
takes up a non-trivial amount of RAM, so creating massive transactions and
not committing them could lead to out of memory. For this reason, I can
imagine a configuration option that allows for transaction support to be
disabled.

I hope this helps.

> 
> Thanks in advance for your help.
> 
> Mike

From emile at rabbitmq.com  Thu Jan  6 10:58:32 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Thu, 06 Jan 2011 10:58:32 +0000
Subject: [rabbitmq-discuss] Handling Undelivered messages in rabbitmq
In-Reply-To: <11EC96EC521B304EA05595E6F2987FC2028D4A45@EXCHBAN.machcorp.lan>
References: <11EC96EC521B304EA05595E6F2987FC2028D4A45@EXCHBAN.machcorp.lan>
Message-ID: <4D25A058.3080909@rabbitmq.com>

Hi Prashant,

On 06/01/11 09:15, Prashant Yadav wrote:

> *1)*Publish the messages with Mandatory and Immediate flag sent
> *channel.basicPublish 'exchange' ,'rKey',true,false, props,"Hello
> World".bytes*

The 'false' in that call should be 'true' if you want 'immediate' set.

> *2)*The consumer consumes even marked ( I have put numbers from 1..10 as
> marked value in header of each messages) and does not ACKS odd numbered
> messages.**
>
> *3)*I have implemented setReturnListnere in the publisher to capture
> undelivered messages.**
>
> While am able to get the number of unack messages via Rabbmitmqctl
> list_queues messages_unacknowledged, somehow my handleBasicReturn method
> does not gets called. Am in missing something.

In your case the 'mandatory' flag will cause handleBasicReturn to be 
called only if the message cannot be routed, i.e.  the message ends up 
in 0 queues. But your messages can be routed so handleBasicReturn won't 
be called.

If you had 'immediate' set and there were no consumers registered on any 
of the relevant queues then handleBasicReturn would be called. But you 
do have consumers registered so handleBasicReturn won't be called.

You could make use of the 'redelivered' flag upon message delivery to 
check whether processing has already been attempted and act accordingly.

You could republish messages to success and failure queues after 
processing, depending on the outcome and depending on how you want to 
treat failed messages.

---

Of possible interest is the ability of the management and monitoring 
plugin to report the number of unacknowledged messages.
See http://www.rabbitmq.com/management.html .

You can also retrieve queue depth over AMQP in the queue declare-ok 
return value after passively declaring a queue.


Regards

Emile

From PRYD at mach.com  Thu Jan  6 11:49:05 2011
From: PRYD at mach.com (Prashant Yadav)
Date: Thu, 6 Jan 2011 17:19:05 +0530
Subject: [rabbitmq-discuss] Handling Undelivered messages in rabbitmq
In-Reply-To: <4D25A058.3080909@rabbitmq.com>
References: <11EC96EC521B304EA05595E6F2987FC2028D4A45@EXCHBAN.machcorp.lan>
	<4D25A058.3080909@rabbitmq.com>
Message-ID: <11EC96EC521B304EA05595E6F2987FC2028D4BFB@EXCHBAN.machcorp.lan>

Hello Emile,

Thanks for the quick response.

I presume by "consumer registered on queue", you mean binding queue to
the QueuingConsumer in my case. I changed the basicPublish immediate
flag to true and changed the queue declaration and binding of my
consumer.
Still am not able to get any response on my Producer for undelivered
messages.
According to you " If you had 'immediate' set and there were no
consumers registered on any of the relevant queues then
handleBasicReturn would be called "
My set up has single queue where producer is publishing messages and
consumers listens on different queue( which effectively fulfills your
condition, isn't ? I even tried just publishing with no consumers
running, still handleBasicReturn does not get called. 

Regds
Prashant


-----Original Message-----
From: Emile Joubert [mailto:emile at rabbitmq.com] 
Sent: Thursday, January 06, 2011 4:29 PM
To: Prashant Yadav
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Handling Undelivered messages in
rabbitmq

Hi Prashant,

On 06/01/11 09:15, Prashant Yadav wrote:

> *1)*Publish the messages with Mandatory and Immediate flag sent
> *channel.basicPublish 'exchange' ,'rKey',true,false, props,"Hello
> World".bytes*

The 'false' in that call should be 'true' if you want 'immediate' set.

> *2)*The consumer consumes even marked ( I have put numbers from 1..10
as
> marked value in header of each messages) and does not ACKS odd
numbered
> messages.**
>
> *3)*I have implemented setReturnListnere in the publisher to capture
> undelivered messages.**
>
> While am able to get the number of unack messages via Rabbmitmqctl
> list_queues messages_unacknowledged, somehow my handleBasicReturn
method
> does not gets called. Am in missing something.

In your case the 'mandatory' flag will cause handleBasicReturn to be 
called only if the message cannot be routed, i.e.  the message ends up 
in 0 queues. But your messages can be routed so handleBasicReturn won't 
be called.

If you had 'immediate' set and there were no consumers registered on any

of the relevant queues then handleBasicReturn would be called. But you 
do have consumers registered so handleBasicReturn won't be called.

You could make use of the 'redelivered' flag upon message delivery to 
check whether processing has already been attempted and act accordingly.

You could republish messages to success and failure queues after 
processing, depending on the outcome and depending on how you want to 
treat failed messages.

---

Of possible interest is the ability of the management and monitoring 
plugin to report the number of unacknowledged messages.
See http://www.rabbitmq.com/management.html .

You can also retrieve queue depth over AMQP in the queue declare-ok 
return value after passively declaring a queue.


Regards

Emile

From emile at rabbitmq.com  Thu Jan  6 12:29:59 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Thu, 06 Jan 2011 12:29:59 +0000
Subject: [rabbitmq-discuss] Handling Undelivered messages in rabbitmq
In-Reply-To: <11EC96EC521B304EA05595E6F2987FC2028D4BFB@EXCHBAN.machcorp.lan>
References: <11EC96EC521B304EA05595E6F2987FC2028D4A45@EXCHBAN.machcorp.lan>
	<4D25A058.3080909@rabbitmq.com>
	<11EC96EC521B304EA05595E6F2987FC2028D4BFB@EXCHBAN.machcorp.lan>
Message-ID: <4D25B5C7.1010109@rabbitmq.com>

Hi Prashant,

On 06/01/11 11:49, Prashant Yadav wrote:
> Hello Emile,
>
> Thanks for the quick response.
>
> I presume by "consumer registered on queue", you mean binding queue to
> the QueuingConsumer in my case. I changed the basicPublish immediate
> flag to true and changed the queue declaration and binding of my
> consumer.
> Still am not able to get any response on my Producer for undelivered
> messages.
> According to you " If you had 'immediate' set and there were no
> consumers registered on any of the relevant queues then
> handleBasicReturn would be called "
> My set up has single queue where producer is publishing messages and
> consumers listens on different queue( which effectively fulfills your
> condition, isn't ? I even tried just publishing with no consumers
> running, still handleBasicReturn does not get called.

If you are publishing with the 'immediate' flag asserted, to an exchange 
that in turn routes to a single queue without consumers, and you have a 
returnlistener set up on the same channel then the handleBasicReturn 
method in the returnListener should get called.

Can you supply a minimal runnable piece of code that exhibits the 
problem you describe?


Regards

Emile


From emile at rabbitmq.com  Thu Jan  6 14:24:46 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Thu, 06 Jan 2011 14:24:46 +0000
Subject: [rabbitmq-discuss] QoS prefetch and rabbitmq-c
In-Reply-To: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EA0A48EC@IS-EXCHANGEC101.wsod.local>
References: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EA0A48EC@IS-EXCHANGEC101.wsod.local>
Message-ID: <4D25D0AE.9000305@rabbitmq.com>

Hi Paul,

On 16/12/10 22:10, Paul Pearcy wrote:
> Hey,
>
> Don?t see a direct way via rabbitmq-c to setup QoS prefetch count for a
> consumer. Searching the lists, I came across this thread, which seemed
> to have a sample for how to do this:
>
> http://old.nabble.com/problem-with-new-persiter-with-1000-topics-queues-td29434516.html#a29476031
>
> Is rolling your own QoS via amqp_simple_rpc the current recommended
> (only?) way to do this?

The AMQP rabbitmq-c client currently lacks an API method to set the QoS 
prefetch count. This is on our radar and a bug has been filed for making 
this change. In general it should not be necessary to roll your own methods.

Regards

Emile

From wsmith at tacc.utexas.edu  Thu Jan  6 14:36:29 2011
From: wsmith at tacc.utexas.edu (Warren Smith)
Date: Thu, 6 Jan 2011 08:36:29 -0600
Subject: [rabbitmq-discuss] X.509 client authentication
Message-ID: <083D5377F8EC294D884D590409EFE70D71116DC9D1@MAIL02.austin.utexas.edu>


Hi all,

I'm investigating using RabbitMQ as part of a project and I've got a question about client authentication. Right now, the clients in this project (users, daemons, etc.) all have X.509 certificates.  It would be very useful if these identities could be used for authentication and authorization in RabbitMQ.

I found the SSL documentation for RabbitMQ and I've been working on configuring a RabbitMQ service to support SSL. However, it appears that even if the client program presents a certificate for authentication, this identity doesn't seem to be used by RabbitMQ. The client still needs to present a username/password - this is what I'd like to avoid.

Is it currently possible to use the DN in the client certificate as the identity of the client? I found a thread about this on the email list (http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-July/004045.html) and the conclusion seemed to be that using the client DN was possible with some modifications to RabbitMQ and that someone was going to take a look at it. I don't see it referenced anywhere else, so maybe it didn't happen.

The approach of mapping the DN in a client certificate to a RabbitMQ username and then doing authorization based on that username seems like it would work fine for what I'm trying to do, btw.

Thanks,

Warren
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110106/d6532cf3/attachment.htm>

From simon at rabbitmq.com  Thu Jan  6 14:56:17 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Thu, 06 Jan 2011 14:56:17 +0000
Subject: [rabbitmq-discuss] X.509 client authentication
In-Reply-To: <083D5377F8EC294D884D590409EFE70D71116DC9D1@MAIL02.austin.utexas.edu>
References: <083D5377F8EC294D884D590409EFE70D71116DC9D1@MAIL02.austin.utexas.edu>
Message-ID: <4D25D811.906@rabbitmq.com>

On 06/01/11 14:36, Warren Smith wrote:
> Hi all,

Hi Warren.

> I?m investigating using RabbitMQ as part of a project and I?ve got a
> question about client authentication. Right now, the clients in this
> project (users, daemons, etc.) all have X.509 certificates. It would be
> very useful if these identities could be used for authentication and
> authorization in RabbitMQ.
>
> I found the SSL documentation for RabbitMQ and I?ve been working on
> configuring a RabbitMQ service to support SSL. However, it appears that
> even if the client program presents a certificate for authentication,
> this identity doesn?t seem to be used by RabbitMQ. The client still
> needs to present a username/password ? this is what I?d like to avoid.
 >
> Is it currently possible to use the DN in the client certificate as the
> identity of the client?

Not in any current release.

However, we have been working on this recently and the next version will 
have a much expanded view of authentication / authorisation that will 
allow you to do this, using the SASL EXTERNAL authentication mechanism 
(which we take to mean "take the authenticated user as being the CN from 
the X509 certificate).

There will also be an authentication / authorisation backend plugin 
mechanism that will mean details of which users exist do not need to be 
stored in the internal Mnesia database.

This is all on the default branch today if you feel like building from 
source.

To use SASL EXTERNAL, support is needed in the clients. We've added it 
to the Java, .NET and Erlang clients, but if you're using a third party 
client it will need a (hopefully rather small) tweak.

For your needs, would you want to store the details of users and 
permissions in some database (either Mnesia or something like LDAP), or 
would you want your PKI to be the entire user database (which would 
require that all users have the same hard-coded permissions)? The former 
will definitely be possible with the next release, the latter would need 
some kind of null backend plugin which could probably be written fairly 
easily.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From jim at rabbitmq.com  Thu Jan  6 15:29:09 2011
From: jim at rabbitmq.com (Jim Apperly)
Date: Thu, 6 Jan 2011 15:29:09 +0000
Subject: [rabbitmq-discuss] More RabbitMQ tutorials available
Message-ID: <AANLkTikA_MQDq+3tykci5dUKXkRQWFLsGLPx+f=6huFd@mail.gmail.com>

I am delighted to announce that we have expanded the set of "Getting
Started" tutorials available on the website.

We now have:
1. "Hello World!" - the simplest thing that does something
2. Work queues - distributing tasks amongst workers
3. Publish/Subscribe - sending messages to many consumers at once
4. Routing *new* - receiving messages selectively
5. Topics *new* - receiving messages based on topic

The tutorials are available at:
http://www.rabbitmq.com/getstarted.html

All of the tutorials come with code samples in Python. We are working on
translating the samples into different languages and adding to the base set
of subjects covered (I'm told that RPC is next, but don't hold me to that).

I want to thank everyone who has been involved in making this happen. Marek
gets an extra large carrot for doing the lion's share of the writing.

If anyone has ideas on what they would like to see or comments and feedback
on how we can make the content better then please don't hold back!
Contributions are always welcome.

Jim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110106/875a079c/attachment.htm>

From moseley at hank.org  Thu Jan  6 16:25:52 2011
From: moseley at hank.org (Bill Moseley)
Date: Thu, 6 Jan 2011 08:25:52 -0800
Subject: [rabbitmq-discuss] More RabbitMQ tutorials available
In-Reply-To: <AANLkTikA_MQDq+3tykci5dUKXkRQWFLsGLPx+f=6huFd@mail.gmail.com>
References: <AANLkTikA_MQDq+3tykci5dUKXkRQWFLsGLPx+f=6huFd@mail.gmail.com>
Message-ID: <AANLkTikwTV-zAOUuw5y_840ajcDZZt=Rvr+p0Zq95kXx@mail.gmail.com>

On Thu, Jan 6, 2011 at 7:29 AM, Jim Apperly <jim at rabbitmq.com> wrote:

> The tutorials are available at:
> http://www.rabbitmq.com/getstarted.html
>
> All of the tutorials come with code samples in Python. We are working on
> translating the samples into different languages and adding to the base set
> of subjects covered (I'm told that RPC is next, but don't hold me to that).
>

As someone (obviously ;) very new to RabbitMQ I found those tutorials very
valuable.  Thanks to all that worked on them.

Personally, I'd be more interested in additional tutorials than just the
same ones in different languages.  I'm not a Python programmer but Python
was fine for explaining the concepts.  Sure, actual code that could be
copied-and-pasted would be handy, but it was pretty easy to work the
tutorials in another language.

The messaging paradigm is somewhat new to our organization (what we have is
all built in-house), so seeing examples of solving common problems would
help very helpful for people in our situation.

Anyway, thanks again.


-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110106/3324c9c8/attachment-0001.htm>

From wsmith at tacc.utexas.edu  Thu Jan  6 16:46:45 2011
From: wsmith at tacc.utexas.edu (Warren Smith)
Date: Thu, 6 Jan 2011 10:46:45 -0600
Subject: [rabbitmq-discuss] X.509 client authentication
In-Reply-To: <4D25D811.906@rabbitmq.com>
References: <083D5377F8EC294D884D590409EFE70D71116DC9D1@MAIL02.austin.utexas.edu>
	<4D25D811.906@rabbitmq.com>
Message-ID: <083D5377F8EC294D884D590409EFE70D71116DCAA8@MAIL02.austin.utexas.edu>


Hi Simon,

Thanks for the quick response. I'll grab the latest source and see what I can do with it. One thing - you say CN, not DN. Is this customizable so that a DN can be used instead? We have enough users and accept more than one CA so it becomes possible that 2 people have the same CN (but different DNs). I don't expect to hit this for any of the use cases I want to support in the next year or so, though.

I've been using the Java client when trying out the SSL stuff so that should be fine. Ultimately I'd like to use a Python client.

I could handle storage of user details and authorization in a number of ways without any problems. I could store an external mapping of DN -> RabbitMQ username and then let RabbitMQ do its normal authorization against the username. I could store DNs and permissions externally and have RabbitMQ do authorization call outs. I'm sure there are other ways that would work fine, too. I do want different users to have different permissions, but doing this on a per-vhost level should be enough for me.

I think the main thing is how much you all want to integrate client DNs into the service vs a plugin. If you want it very integrated, DN->username mappings could be stored in the Mnesia and managed by rabbitmqctl. A user could then potentially have multiple DNs (we have this situation sometimes) and be able to authenticate using a DN or a username/password.

Thanks,


Warren


-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Simon MacMullen
Sent: Thursday, January 06, 2011 8:56 AM
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] X.509 client authentication

On 06/01/11 14:36, Warren Smith wrote:
> Hi all,

Hi Warren.

> I'm investigating using RabbitMQ as part of a project and I've got a
> question about client authentication. Right now, the clients in this
> project (users, daemons, etc.) all have X.509 certificates. It would be
> very useful if these identities could be used for authentication and
> authorization in RabbitMQ.
>
> I found the SSL documentation for RabbitMQ and I've been working on
> configuring a RabbitMQ service to support SSL. However, it appears that
> even if the client program presents a certificate for authentication,
> this identity doesn't seem to be used by RabbitMQ. The client still
> needs to present a username/password - this is what I'd like to avoid.
 >
> Is it currently possible to use the DN in the client certificate as the
> identity of the client?

Not in any current release.

However, we have been working on this recently and the next version will 
have a much expanded view of authentication / authorisation that will 
allow you to do this, using the SASL EXTERNAL authentication mechanism 
(which we take to mean "take the authenticated user as being the CN from 
the X509 certificate).

There will also be an authentication / authorisation backend plugin 
mechanism that will mean details of which users exist do not need to be 
stored in the internal Mnesia database.

This is all on the default branch today if you feel like building from 
source.

To use SASL EXTERNAL, support is needed in the clients. We've added it 
to the Java, .NET and Erlang clients, but if you're using a third party 
client it will need a (hopefully rather small) tweak.

For your needs, would you want to store the details of users and 
permissions in some database (either Mnesia or something like LDAP), or 
would you want your PKI to be the entire user database (which would 
require that all users have the same hard-coded permissions)? The former 
will definitely be possible with the next release, the latter would need 
some kind of null backend plugin which could probably be written fairly 
easily.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From underattack7 at googlemail.com  Thu Jan  6 17:25:00 2011
From: underattack7 at googlemail.com (underattack7)
Date: Thu, 6 Jan 2011 17:25:00 +0000
Subject: [rabbitmq-discuss] Permission on routing key
Message-ID: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>

Hi,

Is it possible to allow a user to create and bind a queue to a topic
exchange with a specific routing key ?

For example, I have :
- virtual host:  host_test
- user : usertest
- exchange: exchangetest

I would like the usertest to be able to create queues on exchangetest but
only with the routing key "toto.*.*"


>From the documentation, I cannot see how to achieve such things.

Thanks.

Fab
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110106/39e5a129/attachment.htm>

From francesco.davide.carnovale at gmail.com  Thu Jan  6 19:28:52 2011
From: francesco.davide.carnovale at gmail.com (Davide Carnovale)
Date: Thu, 6 Jan 2011 20:28:52 +0100
Subject: [rabbitmq-discuss] iPhone client API
Message-ID: <AANLkTim_LJs2nkDtBWt1kgWWdtzjJjw58gcwN8TzsfxT@mail.gmail.com>

Hi everyone!
I'm new to rabbitMQ and i would like to know if there's something to help
iPhone development.
I saw there are client APIs for Java (which i'm using right now) and for
some other languages, but nothing seems to be available for iPhone.

Also, if there is nothing ready, what would be the best approach to build a
client on the iPhone?

Thanks for your time.

Davide
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110106/14d50029/attachment.htm>

From jasonjwwilliams at gmail.com  Thu Jan  6 19:35:25 2011
From: jasonjwwilliams at gmail.com (Jason J. W. Williams)
Date: Thu, 6 Jan 2011 12:35:25 -0700
Subject: [rabbitmq-discuss] iPhone client API
In-Reply-To: <AANLkTim_LJs2nkDtBWt1kgWWdtzjJjw58gcwN8TzsfxT@mail.gmail.com>
References: <AANLkTim_LJs2nkDtBWt1kgWWdtzjJjw58gcwN8TzsfxT@mail.gmail.com>
Message-ID: <AANLkTin=ffgTqTWcQZrPFjQx8R1BbZiPT1NC5YK8C2Jy@mail.gmail.com>

You might try this STOMP client with the Rabbit STOMP plugin:
https://github.com/juretta/objc-stomp

There's also the RabbitMQ C client, but I don't know what it's state is:

http://hg.rabbitmq.com/rabbitmq-c/

-J

On Thu, Jan 6, 2011 at 12:28 PM, Davide Carnovale
<francesco.davide.carnovale at gmail.com> wrote:
> Hi everyone!
> I'm new to rabbitMQ and i would like to know if there's something to help
> iPhone development.
> I saw there are client APIs for Java (which i'm using right now) and for
> some other languages, but nothing seems to be available for iPhone.
>
> Also, if there is nothing ready, what would be the best approach to build a
> client on the iPhone?
>
> Thanks for your time.
>
> Davide
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

From kot.begemot at gmail.com  Fri Jan  7 00:42:08 2011
From: kot.begemot at gmail.com (Vadim Chekan)
Date: Thu, 6 Jan 2011 16:42:08 -0800
Subject: [rabbitmq-discuss] Async consumer for .net client
Message-ID: <AANLkTimyfTGTe=mLa-Ey8foR8oS7Fkip_SF=2ECzMfp0@mail.gmail.com>

Hi all,

Is it possible to consume messages asynchronously in .net client?
What I want is something like this (pseudocode)

var consumer = new SomeConsumer(_model, queue);
consumer.OnRecieve = (msg) => {
  ClearCache(); // do my stuff
  _model.Ack(msg);
}

Is there anybody planning to work on async api? If not, would
contribution be welcome, or there are some objections to it?

Vadim.

-- 
>From RFC 2631: In ASN.1, EXPLICIT tagging is implicit unless IMPLICIT
is explicitly specified

From matthias at rabbitmq.com  Fri Jan  7 09:43:28 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 07 Jan 2011 09:43:28 +0000
Subject: [rabbitmq-discuss] gen_event handler rabbit_error_logger
 crashed. Reason badarg
In-Reply-To: <AANLkTikxzE04_yY=VyaYHw4dq_731hE_frZHgKBB+0ox@mail.gmail.com>
References: <AANLkTikxzE04_yY=VyaYHw4dq_731hE_frZHgKBB+0ox@mail.gmail.com>
Message-ID: <4D26E040.4080207@rabbitmq.com>

Bruno,

Bruno Thomas wrote:
> We have rabbitmq (1.8.0) in production since 7th of december. There is
> a virtual IP proxy in front of two rabbitmq server nodes (2 machines)
> clustered.
> 
> We see sometimes theses errors in rabbitmq logs, causing one node to
> fall, and then be restarted by the cluster :
> 
> =ERROR REPORT==== 22-Dec-2010::20:31:10 ===
> ** gen_event handler rabbit_error_logger crashed.
> ** Was installed in error_logger
> ** Last event was: {info_msg,<0.113.0>,
>                              {<0.161.0>,
>                               "closing TCP connection ~p from ~s:~p~n",
>                               [<0.19903.120>,"10.175.60.13",56518]}}
> ** When handler state == {resource,<<"/">>,exchange,<<"amq.rabbitmq.log">>}
> ** Reason == {badarg,[{ets,lookup,[rabbit_exchange_type_registry,topic]},
>                       {rabbit_exchange_type_registry,lookup_module,1},
>                       {rabbit_exchange,type_to_module,1},
>                       {rabbit_exchange,publish,3},
>                       {rabbit_basic,publish,1},
>                       {rabbit_error_logger,publish1,4},
>                       {rabbit_error_logger,handle_event,2},
>                       {gen_event,server_update,4}]}
> 
> Do you have an idea of what it means ?

That looks like a symptom of something quite fundamental having gone 
wrong, quite possibly some resource exhaustion, e.g. Erlang processes.

> Do you think we should upgrade to 2.2.0 ?

Yes!

Regards,

Matthias.

From matthias at rabbitmq.com  Fri Jan  7 09:51:02 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 07 Jan 2011 09:51:02 +0000
Subject: [rabbitmq-discuss] Async consumer for .net client
In-Reply-To: <AANLkTimyfTGTe=mLa-Ey8foR8oS7Fkip_SF=2ECzMfp0@mail.gmail.com>
References: <AANLkTimyfTGTe=mLa-Ey8foR8oS7Fkip_SF=2ECzMfp0@mail.gmail.com>
Message-ID: <4D26E206.7040604@rabbitmq.com>

Vadim,

Vadim Chekan wrote:
> Is it possible to consume messages asynchronously in .net client?
> What I want is something like this (pseudocode)
> 
> var consumer = new SomeConsumer(_model, queue);
> consumer.OnRecieve = (msg) => {
>   ClearCache(); // do my stuff
>   _model.Ack(msg);
> }

See section 2.8 of the RabbitMQ .Net Client  Library User Guide:
<quote>
Another alternative is to subclass DefaultBasicConsumer, overriding 
methods as necessary, or implement IBasicConsumer directly. You will 
generally want to implement the core method HandleBasicDeliver.
</quote>

Make sure to also read the section after that on "Threading, deadlocks, 
and associated restrictions on consumers".


Regards,

Matthias.

From majek04 at gmail.com  Fri Jan  7 10:14:06 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 7 Jan 2011 10:14:06 +0000
Subject: [rabbitmq-discuss] Persister logs never getting rolled/cleaned
	up?
In-Reply-To: <5c18a357-5043-4506-9ae2-d14c67047abd@y19g2000prb.googlegroups.com>
References: <5c18a357-5043-4506-9ae2-d14c67047abd@y19g2000prb.googlegroups.com>
Message-ID: <AANLkTi=qeRVnp7ix3OijmYTAcRK0gh4=Ww-H+zeJju8b@mail.gmail.com>

Steve,

On Thu, Jan 6, 2011 at 03:43, Steve Garrity <sgarrity at gmail.com> wrote:
> Apologies if this is a n00b question, which I think it is, but we're
> running a plain vanilla install of rabbitmq 2.1.1 on erlang r14B with
> celeryd 2.1.4 and we're continually running into persister log issues
> and Google has thus far not turned up results.
>
> Every few weeks rabbit just stops accepting new connections...stopping
> and starting rabbit takes on the order of 15 minutes and it just
> continues to choke once it gets started again. Looking at /var/lib/
> rabbitmq/mnesia/rabbit shows ~170MB of persister logs (this is running
> on a 1GB RAM machine, so the vm memory alarm is set at ~400MB (which
> we routinely bounce off of trying to reload these logs). By deleting
> (or renaming) this directory, recreating users/vhosts, and restarting
> rabbit, everything works great again (for a few weeks).

Sounds scary. You definitely shouldn't need to go that far!

> This led us to believe we were using celery incorrectly and
> accidentally persisting results for all time, but we've tried with
> ignore_result=True, delivery_mode=transient, durable=False, and
> result_persistent=False and nothing seems to fix it.
>
> These don't seem like logs that we should have to rotate
> manually...can someone point us in the right direction?

Rabbit should do everything automatically, something is very
wrong if it doesn't.

Rabbit only stops "accepting" new connections when it's running
out of file descriptors - I'm sure you would have noticed that.
On the other hand Rabbit does "block" connections which
publish messages when it's running out-of-memory
(ie: grows above 400megs in your case).

You can easily detect such a situation by looking in the
rabbit logs, it will say something like:

=INFO REPORT==== 7-Jan-2011::10:11:16 ===
vm_memory_high_watermark set. Memory used:XXX allowed:XXX


I'd guess, that in your case the rabbit is probably just overloaded.
400 megs of RAM for Rabbit is plenty if you're not doing
anything complex. But once you have a nontrivial setup
or many messages, it may not be enough.

Can you please:
 - run rabbitmqctl list_queues or management plugin
   to see how many messages Rabbit is usually
   storing in your setup, to make sure it's not overloaded
   by a high number of messages.
   (here are details about management plugin:
   http://www.rabbitmq.com/management.html )
 - Take closer look at the result of 'rabbitmqctl list_queues
messages_unacknowledged'.
   If this number is growing, something really bad is happening.

Cheers,
  Marek

From jim at rabbitmq.com  Fri Jan  7 10:28:43 2011
From: jim at rabbitmq.com (Jim Apperly)
Date: Fri, 7 Jan 2011 10:28:43 +0000
Subject: [rabbitmq-discuss] More RabbitMQ tutorials available
In-Reply-To: <AANLkTikwTV-zAOUuw5y_840ajcDZZt=Rvr+p0Zq95kXx@mail.gmail.com>
References: <AANLkTikA_MQDq+3tykci5dUKXkRQWFLsGLPx+f=6huFd@mail.gmail.com>
	<AANLkTikwTV-zAOUuw5y_840ajcDZZt=Rvr+p0Zq95kXx@mail.gmail.com>
Message-ID: <AANLkTikT+mmNbdjFXY0x9HAPrChyA2GNsJzKHyeZhWBj@mail.gmail.com>

Bill,

On 6 January 2011 16:25, Bill Moseley <moseley at hank.org> wrote:

> Personally, I'd be more interested in additional tutorials than just the
> same ones in different languages.
>

Do you have any suggestions or specific requests?

Jim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110107/730ac1ee/attachment.htm>

From simon at rabbitmq.com  Fri Jan  7 11:43:49 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Fri, 07 Jan 2011 11:43:49 +0000
Subject: [rabbitmq-discuss] X.509 client authentication
In-Reply-To: <083D5377F8EC294D884D590409EFE70D71116DCAA8@MAIL02.austin.utexas.edu>
References: <083D5377F8EC294D884D590409EFE70D71116DC9D1@MAIL02.austin.utexas.edu>
	<4D25D811.906@rabbitmq.com>
	<083D5377F8EC294D884D590409EFE70D71116DCAA8@MAIL02.austin.utexas.edu>
Message-ID: <4D26FC75.1000402@rabbitmq.com>

On 06/01/11 16:46, Warren Smith wrote:
> Thanks for the quick response. I'll grab the latest source and see
> what I can do with it. One thing - you say CN, not DN. Is this
> customizable so that a DN can be used instead? We have enough users
> and accept more than one CA so it becomes possible that 2 people have
> the same CN (but different DNs). I don't expect to hit this for any
> of the use cases I want to support in the next year or so, though.

I have to admit I picked CNs for simplicity. The problem with DNs is 
that in general we assume that a username is a string, and can be 
matched as such. As soon as we start using DNs as usernames we have all 
sorts of problems with normalisation. I'm not a real X.509 expert, but 
it doesn't seem like there's a standard normalisation for DNs as 
strings. There are some conventions but they seem to get very hazy once 
you look at issues like escaping.

I'll have a look at how this could be made to work though.

> I've been using the Java client when trying out the SSL stuff so that
> should be fine. Ultimately I'd like to use a Python client.
>
> I could handle storage of user details and authorization in a number
> of ways without any problems. I could store an external mapping of DN
> ->  RabbitMQ username and then let RabbitMQ do its normal
> authorization against the username. I could store DNs and permissions
> externally and have RabbitMQ do authorization call outs. I'm sure
> there are other ways that would work fine, too. I do want different
> users to have different permissions, but doing this on a per-vhost
> level should be enough for me.
>
> I think the main thing is how much you all want to integrate client
> DNs into the service vs a plugin. If you want it very integrated,
> DN->username mappings could be stored in the Mnesia and managed by
> rabbitmqctl. A user could then potentially have multiple DNs (we have
> this situation sometimes) and be able to authenticate using a DN or a
> username/password.

Hmm. The idea is that SASL EXTERNAL is just another way to authenticate, 
and so it provides a username. I'm not sure a DN-to-username mapping is 
the best way to proceed (suppose you're not storing users in Mnesia - do 
all auth backends need to support such a mapping?)

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From underattack7 at googlemail.com  Fri Jan  7 13:51:55 2011
From: underattack7 at googlemail.com (underattack7)
Date: Fri, 7 Jan 2011 13:51:55 +0000
Subject: [rabbitmq-discuss] amq.rabbitmq.log and log bindings
Message-ID: <AANLkTin0FBx=U=N2_3W4ttG9_kXFXb9Xc9WnOroB9Ctm@mail.gmail.com>

Hi,

Is there to monitor the queue bindings and see their routing keys ?

I would be interested to monitor the queue declarations along with the
routing keys used in real time. I had a look a the amq.rabbitmq.log exchange
but it does provide with this information.

Any idea ?

Regards,


Fab
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110107/38354baf/attachment.htm>

From jamesc.000 at gmail.com  Fri Jan  7 14:06:54 2011
From: jamesc.000 at gmail.com (James Casey)
Date: Fri, 7 Jan 2011 15:06:54 +0100
Subject: [rabbitmq-discuss] X.509 client authentication
In-Reply-To: <4D26FC75.1000402@rabbitmq.com>
References: <083D5377F8EC294D884D590409EFE70D71116DC9D1@MAIL02.austin.utexas.edu>
	<4D25D811.906@rabbitmq.com>
	<083D5377F8EC294D884D590409EFE70D71116DCAA8@MAIL02.austin.utexas.edu>
	<4D26FC75.1000402@rabbitmq.com>
Message-ID: <AANLkTimcTbnHSmk=NqyW1rqyaFThYF4AsJbcjM+eQw85@mail.gmail.com>

On 7 January 2011 12:43, Simon MacMullen <simon at rabbitmq.com> wrote:
> On 06/01/11 16:46, Warren Smith wrote:
>>
>> Thanks for the quick response. I'll grab the latest source and see
>> what I can do with it. One thing - you say CN, not DN. Is this
>> customizable so that a DN can be used instead? We have enough users
>> and accept more than one CA so it becomes possible that 2 people have
>> the same CN (but different DNs). I don't expect to hit this for any
>> of the use cases I want to support in the next year or so, though.
>
> I have to admit I picked CNs for simplicity. The problem with DNs is that in
> general we assume that a username is a string, and can be matched as such.

Hi Simon,

what are the restrictions you have in usernames ?  Does it have to be
a non-whitespace string ?  Are there length restrictions ?

We're also in the situation where we have to accept 50-60 CAs (all
with different naming structures for the DN).  We implemented
something for activemq (where the username is just any Java string
that can be compared against).  Here we simply did standard URI
escaping to map into a username.  E.g for my DN:

'/DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jamesc/CN=380618/CN=James Casey'

I get a username of
 '%2FDC%3Dch%2FDC%3Dcern%2FOU%3DOrganic%20Units%2FOU%3DUsers%2FCN%3Djamesc%2FCN%3D380618%2FCN%3DJames%20Casey'
Since these are never entered directly by a user it's not such a big
problem that they are long.  Of course if you've no problems with
spaces, etc in a username you could just use the DN directly as the
username.


> As soon as we start using DNs as usernames we have all sorts of problems
> with normalisation. I'm not a real X.509 expert, but it doesn't seem like
> there's a standard normalisation for DNs as strings. There are some
> conventions but they seem to get very hazy once you look at issues like
> escaping.
I guess the 'standard' is what 'openssl x509 -subject' gives back.
Note that the java tools work differently (elements in reversed order
with comma separation instead of / separators.

>
> I'll have a look at how this could be made to work though.
>
>> I've been using the Java client when trying out the SSL stuff so that
>> should be fine. Ultimately I'd like to use a Python client.
>>
>> I could handle storage of user details and authorization in a number
>> of ways without any problems. I could store an external mapping of DN
>> -> ?RabbitMQ username and then let RabbitMQ do its normal
>> authorization against the username. I could store DNs and permissions
>> externally and have RabbitMQ do authorization call outs. I'm sure
>> there are other ways that would work fine, too. I do want different
>> users to have different permissions, but doing this on a per-vhost
>> level should be enough for me.
>>
>> I think the main thing is how much you all want to integrate client
>> DNs into the service vs a plugin. If you want it very integrated,
>> DN->username mappings could be stored in the Mnesia and managed by
>> rabbitmqctl. A user could then potentially have multiple DNs (we have
>> this situation sometimes) and be able to authenticate using a DN or a
>> username/password.
>
> Hmm. The idea is that SASL EXTERNAL is just another way to authenticate, and
> so it provides a username. I'm not sure a DN-to-username mapping is the best
> way to proceed (suppose you're not storing users in Mnesia - do all auth
> backends need to support such a mapping?)
>

I think this isn't such a good idea - it's tricky mapping multiple DNs
to the same 'user'.  Often a user has multiple DNs since he wants to
distinguish himself this way (an DN for admin access vs a DN for
normal access).  The issue I see here is what happens when a user gets
a new DN after an old one expired and the CA has a policy of
generating a new DN string (usually by appending a random number in a
CN field.  Normally you then need admin tools to change a username,
keeping the same permissions.

One question here on the implementation - with an external provider
it's only for authentication, right?  Authorization is still done by
storing permissions in Mnesia against users ?

cheers,

James.

> Cheers, Simon
>
> --
> Simon MacMullen
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From simon at rabbitmq.com  Fri Jan  7 14:07:17 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Fri, 07 Jan 2011 14:07:17 +0000
Subject: [rabbitmq-discuss] amq.rabbitmq.log and log bindings
In-Reply-To: <AANLkTin0FBx=U=N2_3W4ttG9_kXFXb9Xc9WnOroB9Ctm@mail.gmail.com>
References: <AANLkTin0FBx=U=N2_3W4ttG9_kXFXb9Xc9WnOroB9Ctm@mail.gmail.com>
Message-ID: <4D271E15.7060207@rabbitmq.com>

On 07/01/11 13:51, underattack7 wrote:
> Is there to monitor the queue bindings and see their routing keys ?
>
> I would be interested to monitor the queue declarations along with the
> routing keys used in real time. I had a look a the amq.rabbitmq.log
> exchange but it does provide with this information.

Hi Fab.

No, there's not at the moment. amq.rabbitmq.log only shows the same 
messages as get written to the log file.

That information is available internally via the rabbit_event event 
stream, but it's not hooked up to AMQP. I have wondered about writing 
some plugin to expose this information; it wouldn't be too hard. Is 
anyone else interested in this?

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From simon at rabbitmq.com  Fri Jan  7 14:15:37 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Fri, 07 Jan 2011 14:15:37 +0000
Subject: [rabbitmq-discuss] amq.rabbitmq.log and log bindings
In-Reply-To: <4D271E15.7060207@rabbitmq.com>
References: <AANLkTin0FBx=U=N2_3W4ttG9_kXFXb9Xc9WnOroB9Ctm@mail.gmail.com>
	<4D271E15.7060207@rabbitmq.com>
Message-ID: <4D272009.10903@rabbitmq.com>

On 07/01/11 14:07, Simon MacMullen wrote:
> On 07/01/11 13:51, underattack7 wrote:
>> Is there to monitor the queue bindings and see their routing keys ?
>>
>> I would be interested to monitor the queue declarations along with the
>> routing keys used in real time. I had a look a the amq.rabbitmq.log
>> exchange but it does provide with this information.
>
> Hi Fab.
>
> No, there's not at the moment. amq.rabbitmq.log only shows the same
> messages as get written to the log file.
>
> That information is available internally via the rabbit_event event
> stream, but it's not hooked up to AMQP. I have wondered about writing
> some plugin to expose this information; it wouldn't be too hard. Is
> anyone else interested in this?

That of course assumes that when you say "in real time" you mean that 
you want to get notification when these things are created. Of course 
you can use rabbitmqctl or the management plugin to retrieve lists of them.

Cheers, Simon
-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From underattack7 at googlemail.com  Fri Jan  7 14:26:27 2011
From: underattack7 at googlemail.com (underattack7)
Date: Fri, 7 Jan 2011 14:26:27 +0000
Subject: [rabbitmq-discuss] amq.rabbitmq.log and log bindings
In-Reply-To: <4D272009.10903@rabbitmq.com>
References: <AANLkTin0FBx=U=N2_3W4ttG9_kXFXb9Xc9WnOroB9Ctm@mail.gmail.com>
	<4D271E15.7060207@rabbitmq.com> <4D272009.10903@rabbitmq.com>
Message-ID: <AANLkTindW8kUkpxhz9T84EG0u3VwmaOeLWeFt9mfYDL9@mail.gmail.com>

yeah, the idea is to be able to detect "bad behaviour" and delete queue
automatically.

So ideally, I would have liked to create a queue bound to amq.rabbitmq.log,
with a consumer monitoring the queue bindings.

The original problem is that we wanted to use permissions to prevent users
from binding queue using certain routing keys.

For example, I would like to allow people to bind queue with routing key
"site1.*.*.*.*" but not "site2.*.*.*.*".  As this does not seem to be
possible with permissions, we were thinking at detecting such bindings and
delete the queue.

Cheers,

Fab


On 7 January 2011 14:15, Simon MacMullen <simon at rabbitmq.com> wrote:

> On 07/01/11 14:07, Simon MacMullen wrote:
>
>> On 07/01/11 13:51, underattack7 wrote:
>>
>>> Is there to monitor the queue bindings and see their routing keys ?
>>>
>>> I would be interested to monitor the queue declarations along with the
>>> routing keys used in real time. I had a look a the amq.rabbitmq.log
>>> exchange but it does provide with this information.
>>>
>>
>> Hi Fab.
>>
>> No, there's not at the moment. amq.rabbitmq.log only shows the same
>> messages as get written to the log file.
>>
>> That information is available internally via the rabbit_event event
>> stream, but it's not hooked up to AMQP. I have wondered about writing
>> some plugin to expose this information; it wouldn't be too hard. Is
>> anyone else interested in this?
>>
>
> That of course assumes that when you say "in real time" you mean that you
> want to get notification when these things are created. Of course you can
> use rabbitmqctl or the management plugin to retrieve lists of them.
>
>
> Cheers, Simon
> --
> Simon MacMullen
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110107/306e4e2d/attachment.htm>

From matthias at rabbitmq.com  Fri Jan  7 14:33:06 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 07 Jan 2011 14:33:06 +0000
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>
Message-ID: <4D272422.7070504@rabbitmq.com>

Fab,

underattack7 wrote:
> Is it possible to allow a user to create and bind a queue to a topic 
> exchange with a specific routing key ?
> 
> For example, I have :
> - virtual host:  host_test
> - user : usertest
> - exchange: exchangetest
> 
> I would like the usertest to be able to create queues on exchangetest 
> but only with the routing key "toto.*.*"
> 
> 
>  From the documentation, I cannot see how to achieve such things.

You can't. But given that you know all the above, why don't you (the 
creator of the usertest user) create the queue and binding, so the user 
doesn't have to create anything?

Regards,

Matthias.

From underattack7 at googlemail.com  Fri Jan  7 14:40:25 2011
From: underattack7 at googlemail.com (underattack7)
Date: Fri, 7 Jan 2011 14:40:25 +0000
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <4D272422.7070504@rabbitmq.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>
	<4D272422.7070504@rabbitmq.com>
Message-ID: <AANLkTinswVnp-BFEUWi0+sbYxsNF4_L6RBtw+xHXe8jE@mail.gmail.com>

That's not that easy as the routing key has the format:

site.user.param1.param2.param3

and different users are interested in different things, for example :
"site1"."toto".#,  "site2".#, "site1"."toto"."paramtoto".# .....

so we cannot really create all the queue in advance.

Cheers,
Fabien


On 7 January 2011 14:33, Matthias Radestock <matthias at rabbitmq.com> wrote:

> Fab,
>
>
> underattack7 wrote:
>
>> Is it possible to allow a user to create and bind a queue to a topic
>> exchange with a specific routing key ?
>>
>> For example, I have :
>> - virtual host:  host_test
>> - user : usertest
>> - exchange: exchangetest
>>
>> I would like the usertest to be able to create queues on exchangetest but
>> only with the routing key "toto.*.*"
>>
>>
>>  From the documentation, I cannot see how to achieve such things.
>>
>
> You can't. But given that you know all the above, why don't you (the
> creator of the usertest user) create the queue and binding, so the user
> doesn't have to create anything?
>
> Regards,
>
> Matthias.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110107/403fbad8/attachment.htm>

From matthias at rabbitmq.com  Fri Jan  7 14:44:30 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 07 Jan 2011 14:44:30 +0000
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <AANLkTinswVnp-BFEUWi0+sbYxsNF4_L6RBtw+xHXe8jE@mail.gmail.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>	<4D272422.7070504@rabbitmq.com>
	<AANLkTinswVnp-BFEUWi0+sbYxsNF4_L6RBtw+xHXe8jE@mail.gmail.com>
Message-ID: <4D2726CE.4030402@rabbitmq.com>

Fab,

underattack7 wrote:
> That's not that easy as the routing key has the format:
> 
> site.user.param1.param2.param3
> 
> and different users are interested in different things, for example : 
> "site1"."toto".#,  "site2".#, "site1"."toto"."paramtoto".# .....
> 
> so we cannot really create all the queue in advance.

Are you saying that there are constraints on what users can bind to but 
they may only be interested in a *subset* of that?

In which case create an internal topic exchange per user and bind that 
with all their *allowed* bindings to the main exchange. Users can then 
create queues and bind them to their internal exchange for stuff they 
are interested in.

See http://www.rabbitmq.com/extensions.html#exchange-bindings

Regards,

Matthias.

From moshima at advent.com  Fri Jan  7 15:02:37 2011
From: moshima at advent.com (Michi Oshima)
Date: Fri, 7 Jan 2011 07:02:37 -0800 (PST)
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <4D272422.7070504@rabbitmq.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>
	<4D272422.7070504@rabbitmq.com>
Message-ID: <30614971.post@talk.nabble.com>



Matthias Radestock-3 wrote:
> 
> 
> You can't. But given that you know all the above, why don't you (the 
> creator of the usertest user) create the queue and binding, so the user 
> doesn't have to create anything?
> 
> 

Suppose I want to delete the queue when the user disconnects.  And I want to
handle abrupt/unexpected user disconnection (say the user application
crashes) by deleting the queue.

In this case, shouldn't the user process create the queue with autodelete
set to true?  Isn't that the best way to quarantee queue deletion when the
connection is terminated?

Michi Oshima


-- 
View this message in context: http://old.nabble.com/Permission-on-routing-key-tp30607142p30614971.html
Sent from the RabbitMQ mailing list archive at Nabble.com.


From underattack7 at googlemail.com  Fri Jan  7 15:06:46 2011
From: underattack7 at googlemail.com (underattack7)
Date: Fri, 7 Jan 2011 15:06:46 +0000
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <4D2726CE.4030402@rabbitmq.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>
	<4D272422.7070504@rabbitmq.com>
	<AANLkTinswVnp-BFEUWi0+sbYxsNF4_L6RBtw+xHXe8jE@mail.gmail.com>
	<4D2726CE.4030402@rabbitmq.com>
Message-ID: <AANLkTikdJOzmYyvr7iA4B7+SGD1G8RQGFQS=0_UPygyW@mail.gmail.com>

Hi Matthias,

This looks interesting, however how can I allow a user to use a specific
exchange only ?

Let's say we have an exchange:

- exchange_main

Then 3 exchanges bound to it:
- exchange1 : bound to exchange_main with "site1".#
- exchange2 : bound to exchange_main with "site2".#
- exchange3 : bound to exchange_main with "site3".#

then how can I allow :
-user1 to create queue bound to exchange1 only
-user2 to create queue bound to exchange2 only
-user3 to create queue bound to exchange3 only

Cheers,
Fabine

On 7 January 2011 14:44, Matthias Radestock <matthias at rabbitmq.com> wrote:

> Fab,
>
>
> underattack7 wrote:
>
>> That's not that easy as the routing key has the format:
>>
>> site.user.param1.param2.param3
>>
>> and different users are interested in different things, for example :
>> "site1"."toto".#,  "site2".#, "site1"."toto"."paramtoto".# .....
>>
>> so we cannot really create all the queue in advance.
>>
>
> Are you saying that there are constraints on what users can bind to but
> they may only be interested in a *subset* of that?
>
> In which case create an internal topic exchange per user and bind that with
> all their *allowed* bindings to the main exchange. Users can then create
> queues and bind them to their internal exchange for stuff they are
> interested in.
>
> See http://www.rabbitmq.com/extensions.html#exchange-bindings
>
> Regards,
>
> Matthias.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110107/16e1e5f7/attachment.htm>

From matthias at rabbitmq.com  Fri Jan  7 15:08:22 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 07 Jan 2011 15:08:22 +0000
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <30614971.post@talk.nabble.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>	<4D272422.7070504@rabbitmq.com>
	<30614971.post@talk.nabble.com>
Message-ID: <4D272C66.7070507@rabbitmq.com>

Michi,

Michi Oshima wrote:
> Matthias Radestock-3 wrote:
>>
>> You can't. But given that you know all the above, why don't you (the 
>> creator of the usertest user) create the queue and binding, so the user 
>> doesn't have to create anything?
>>
>>
> 
> Suppose I want to delete the queue when the user disconnects.  And I want to
> handle abrupt/unexpected user disconnection (say the user application
> crashes) by deleting the queue.
> 
> In this case, shouldn't the user process create the queue with autodelete
> set to true?  Isn't that the best way to quarantee queue deletion when the
> connection is terminated?

Actually you probably want exclusive=true. See my other post in this 
thread which addresses the issue of how we can still get the users to 
create/delete their own queues.


Matthias.

From matthias at rabbitmq.com  Fri Jan  7 15:14:12 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 07 Jan 2011 15:14:12 +0000
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <AANLkTikdJOzmYyvr7iA4B7+SGD1G8RQGFQS=0_UPygyW@mail.gmail.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>	<4D272422.7070504@rabbitmq.com>	<AANLkTinswVnp-BFEUWi0+sbYxsNF4_L6RBtw+xHXe8jE@mail.gmail.com>	<4D2726CE.4030402@rabbitmq.com>
	<AANLkTikdJOzmYyvr7iA4B7+SGD1G8RQGFQS=0_UPygyW@mail.gmail.com>
Message-ID: <4D272DC4.90701@rabbitmq.com>

Fabine,

underattack7 wrote:
> This looks interesting, however how can I allow a user to use a specific 
> exchange only ?
> 
> Let's say we have an exchange:
> 
> - exchange_main
> 
> Then 3 exchanges bound to it:
> - exchange1 : bound to exchange_main with "site1".#
> - exchange2 : bound to exchange_main with "site2".#
> - exchange3 : bound to exchange_main with "site3".#
> 
> then how can I allow :
> -user1 to create queue bound to exchange1 only
> -user2 to create queue bound to exchange2 only
> -user3 to create queue bound to exchange3 only

Rabbit's permission system is definitely capable of expressing that. 
You'd need to give each user read permissions for their exchange (only). 
And obviously configure, read and write permissions for their queue.

Matthias.

From moshima at advent.com  Fri Jan  7 15:14:30 2011
From: moshima at advent.com (Michi Oshima)
Date: Fri, 7 Jan 2011 07:14:30 -0800 (PST)
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <4D272C66.7070507@rabbitmq.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>
	<4D272422.7070504@rabbitmq.com> <30614971.post@talk.nabble.com>
	<4D272C66.7070507@rabbitmq.com>
Message-ID: <30615079.post@talk.nabble.com>


And I just read the "Queue Leases" section of Extentions and Experimental
Features.  That might also be useful.  I have more learning/experimenting to
do.  Thanks.

Michi
-- 
View this message in context: http://old.nabble.com/Permission-on-routing-key-tp30607142p30615079.html
Sent from the RabbitMQ mailing list archive at Nabble.com.


From kot.begemot at gmail.com  Fri Jan  7 20:01:10 2011
From: kot.begemot at gmail.com (Vadim Chekan)
Date: Fri, 7 Jan 2011 12:01:10 -0800
Subject: [rabbitmq-discuss] Async consumer for .net client
In-Reply-To: <4D26E206.7040604@rabbitmq.com>
References: <AANLkTimyfTGTe=mLa-Ey8foR8oS7Fkip_SF=2ECzMfp0@mail.gmail.com>
	<4D26E206.7040604@rabbitmq.com>
Message-ID: <AANLkTi=JRqzn=Q07nd8x=9vFs+UbSwhzq7frb47Z8qq+@mail.gmail.com>

I hate those mailist where you have to "reply to all", so repeating my
previous mail:

I see. So it is not there out of the box, but you can do it.
Perhaps QueingBasicConsumer is the right place to add async event
because it disconnects message receiving from handling by using
internal in-memory queue.

Vadim.

On Fri, Jan 7, 2011 at 1:51 AM, Matthias Radestock
<matthias at rabbitmq.com> wrote:
> Vadim,
>
> Vadim Chekan wrote:
>>
>> Is it possible to consume messages asynchronously in .net client?
>> What I want is something like this (pseudocode)
>>
>> var consumer = new SomeConsumer(_model, queue);
>> consumer.OnRecieve = (msg) => {
>> ?ClearCache(); // do my stuff
>> ?_model.Ack(msg);
>> }
>
> See section 2.8 of the RabbitMQ .Net Client ?Library User Guide:
> <quote>
> Another alternative is to subclass DefaultBasicConsumer, overriding methods
> as necessary, or implement IBasicConsumer directly. You will generally want
> to implement the core method HandleBasicDeliver.
> </quote>
>
> Make sure to also read the section after that on "Threading, deadlocks, and
> associated restrictions on consumers".
>
>
> Regards,
>
> Matthias.
>



-- 
>From RFC 2631: In ASN.1, EXPLICIT tagging is implicit unless IMPLICIT
is explicitly specified

From moshima at advent.com  Fri Jan  7 23:36:41 2011
From: moshima at advent.com (Michi Oshima)
Date: Fri, 7 Jan 2011 15:36:41 -0800 (PST)
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <30615079.post@talk.nabble.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>
	<4D272422.7070504@rabbitmq.com> <30614971.post@talk.nabble.com>
	<4D272C66.7070507@rabbitmq.com> <30615079.post@talk.nabble.com>
Message-ID: <30619161.post@talk.nabble.com>


In this thread we've been trying to control how queue are bound to an
exchange.  One way to get that to happen was for us (aka., "the creator of
the usertest user") to bind a queue on behalf of the user.

In addition I wanted to ensure queue deletion when the user connection
terminates.

I'm finding that exclusive=true won't work.

Around queue creation and binding, we brought up two cases:

1. We create and bind the queue on behalf of the user.
2. User creates a queue, but we bind the queue on behalf of the user.

In #1, exclusive=true causes an error when the user tries to consume a queue
created by us.

In #2, exclusive=true causes an error when when we try to bind the queue
created by the user.

-- 
View this message in context: http://old.nabble.com/Permission-on-routing-key-tp30607142p30619161.html
Sent from the RabbitMQ mailing list archive at Nabble.com.


From moseley at hank.org  Sat Jan  8 01:40:57 2011
From: moseley at hank.org (Bill Moseley)
Date: Fri, 7 Jan 2011 17:40:57 -0800
Subject: [rabbitmq-discuss] Can a queue auto_delete if it doesn't have a
	consumer when created?
Message-ID: <AANLkTinHUJfi=06GVQ3TPvFmEJGX83h+QLFOasGPyLzK@mail.gmail.com>

This is not a classic reply queue setup where only two processes are
involved.  I have three processes involved here:

In one process I've created a "reply queue" with auto_delete true and I bind
it to an exchange (using the queue's name as the routing key).  I then
publish a message and include the reply queue's name in "reply_to" property
-- I'm passing the routing key to another process it can use for replying.

The consumer picks up that message off a queue and then publishes a new
message (the "reply") to the reply queue using the routing key provided.

Finally, in a third process that knows the reply queue's name a
"amqp_basic_get" is used to consume from reply queue.  This process now has
the "reply" message.  This is working as expected.

But, when that's all done the queue is still around:

$ sudo rabbitmqctl -q list_queues name messages consumers auto_delete
amq.gen-tYjOPWR6ZV0crLn5ga5KZg==        0       0       true

So, there's no consumers on the queue, and it's flagged auto_delete.  An I
misunderstanding how auto_delete works on queues?

Is the problem that when I created the "amq.gen-tYjOPWR6ZV0crLn5ga5KZg== "
queue that there were no consumers so the queue will never get deleted?

Is using "x-expires" the solution?

-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110107/6124c4d2/attachment.htm>

From matthias at rabbitmq.com  Sat Jan  8 08:06:43 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Sat, 08 Jan 2011 08:06:43 +0000
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <30619161.post@talk.nabble.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>	<4D272422.7070504@rabbitmq.com>
	<30614971.post@talk.nabble.com>	<4D272C66.7070507@rabbitmq.com>
	<30615079.post@talk.nabble.com> <30619161.post@talk.nabble.com>
Message-ID: <4D281B13.70600@rabbitmq.com>

Michi,

Michi Oshima wrote:
> In this thread we've been trying to control how queue are bound to an
> exchange.  One way to get that to happen was for us (aka., "the creator of
> the usertest user") to bind a queue on behalf of the user.
> 
> In addition I wanted to ensure queue deletion when the user connection
> terminates.
> 
> I'm finding that exclusive=true won't work.
> 
> Around queue creation and binding, we brought up two cases:
> 
> 1. We create and bind the queue on behalf of the user.
> 2. User creates a queue, but we bind the queue on behalf of the user.
> 
> In #1, exclusive=true causes an error when the user tries to consume a queue
> created by us.
> 
> In #2, exclusive=true causes an error when when we try to bind the queue
> created by the user.

You missed the third case we discussed: We create an internal exchange 
per user, bind that to the main exchange with all the allowed binding 
keys, and then let the user create queues and bind them to their 
internal exchange. exclusive=true works fine in that case.


Matthias.


From matthias at rabbitmq.com  Sat Jan  8 08:16:03 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Sat, 08 Jan 2011 08:16:03 +0000
Subject: [rabbitmq-discuss] Can a queue auto_delete if it doesn't have
 a	consumer when created?
In-Reply-To: <AANLkTinHUJfi=06GVQ3TPvFmEJGX83h+QLFOasGPyLzK@mail.gmail.com>
References: <AANLkTinHUJfi=06GVQ3TPvFmEJGX83h+QLFOasGPyLzK@mail.gmail.com>
Message-ID: <4D281D43.4090507@rabbitmq.com>

Bill,

Bill Moseley wrote:
> So, there's no consumers on the queue, and it's flagged auto_delete.  An 
> I misunderstanding how auto_delete works on queues?
> 
> Is the problem that when I created the "amq.gen-tYjOPWR6ZV0crLn5ga5KZg== 
> " queue that there were no consumers so the queue will never get deleted?

 From the xml spec for auto-delete:
"If set, the queue is deleted when all consumers have finished using it. 
  The last consumer can be cancelled either explicitly or because its 
channel is closed. If there was no consumer ever on the queue, it won't 
be deleted. Applications can explicitly delete auto-delete queues using 
the Delete method as normal."

> Is using "x-expires" the solution?

That's one option. Or instead of consuming the message with basic.get 
use basic.consume. Or, as noted above, delete the queue explicitly. With 
x-expires the queue will get deleted eventually even when the reply is 
never read, which may or may not be what you want to happen.

Regards,

Matthias.

From harvey.robin at gmail.com  Sat Jan  8 13:46:39 2011
From: harvey.robin at gmail.com (Robin Harvey)
Date: Sat, 8 Jan 2011 13:46:39 +0000
Subject: [rabbitmq-discuss] New open source PHP Amqp implementation
Message-ID: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>

Hello Rabbiteers!


I hope I'm not being importune by posting this message to let you know about
an LGPL Amqp implementation I've recently written for PHP 5.3:

https://github.com/BraveSirRobin/amqphp

I've implemented the 0.9.1 Amqp spec using a code-generation approach.  If
any of the more experienced Amqp people were able to take a quick look at my
code in order to provide feedback, or have any other advice I'd be very
grateful.  There's a UML class diagram showing the implementation classes
here: https://github.com/BraveSirRobin/amqphp/raw/master/diag/amqp.png

Secondly, I have a question regarding using basic.consume on multiple
channels.  Is it possible for message frames to be mixed up for
basic.consume?  Section 4.2.6 of the spec says this:

*Content frames on a specific channel are strictly sequential. That is, they
may be mixed with frames for*
*other channels, but no two content frames from the same channel may be
mixed or overlapped, nor may*
*content frames for a single content be mixed with method frames on the same
channel.*

What I find confusing is that a single "message" consists of a frame header,
a content header and one or more content frames, for large messages there
can be many content frames; a single message contains many frames.  For
example, is it possible to get a content header frame on channel A, then a
content header frame on channel B, then the message content for channel A,
then the message content for channel B?  The testing I've done so far
indicates that RMQ always sends basic.deliver messages sequentially - it
sends the content header then all content frames for a single message on a
single channel in a non-interleaved fashion.  Is this always the case?  Is
this what the spec guarantees?


Many thanks,
--Robin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110108/c4db6a57/attachment.htm>

From matthias at rabbitmq.com  Sat Jan  8 14:13:49 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Sat, 08 Jan 2011 14:13:49 +0000
Subject: [rabbitmq-discuss] New open source PHP Amqp implementation
In-Reply-To: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
References: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
Message-ID: <4D28711D.5010504@rabbitmq.com>

Robin,

Robin Harvey wrote:
> https://github.com/BraveSirRobin/amqphp
> 
> I've implemented the 0.9.1 Amqp spec using a code-generation
> approach.

Great. Codegen is definitely the way to go since it will allow you
to keep up with the changes to the spec. Though you may want to grab the 
version of the xml spec from our dotnet client repo since it contains 
the rabbit-specific extensions. 
http://hg.rabbitmq.com/rabbitmq-dotnet-client/raw-file/default/docs/specs/amqp0-9-1.xml

Btw, the reason we don't use the xml in our server codegen, and instead 
have a json version of the spec, is because of legal issues with the 
AMQP XML spec that the Debian folks were unhappy about. This has since 
been fixed with the release of the stripped versions of the XML spec 
under a different license. But we haven't found the time to switch to 
using that.

> is it possible to get a content header frame on channel A, then a
> content header frame on channel B, then the message content for
> channel A, then the message content for channel B?

Yes, that is possible.

> The testing I've done so far indicates that RMQ always sends
> basic.deliver messages sequentially - it sends the content header
> then all content frames for a single message on a single channel in a
> non-interleaved fashion.  Is this always the case?

You were just lucky. Shorten the frame size, use very large messages
and lots of channels and I am sure you'd see some interleaving.


Regards,

Matthias.

From matthew at rabbitmq.com  Sat Jan  8 14:20:49 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Sat, 8 Jan 2011 14:20:49 +0000
Subject: [rabbitmq-discuss] New open source PHP Amqp implementation
In-Reply-To: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
References: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
Message-ID: <20110108142048.GA23493@wellquite.org>

On Sat, Jan 08, 2011 at 01:46:39PM +0000, Robin Harvey wrote:
> What I find confusing is that a single "message" consists of a frame header,
> a content header and one or more content frames, for large messages there
> can be many content frames; a single message contains many frames.  For
> example, is it possible to get a content header frame on channel A, then a
> content header frame on channel B, then the message content for channel A,
> then the message content for channel B?

Your interpretation of the spec is correct, and yes, these interleavings
are legal.

> The testing I've done so far
> indicates that RMQ always sends basic.deliver messages sequentially - it
> sends the content header then all content frames for a single message on a
> single channel in a non-interleaved fashion.  Is this always the case?  Is
> this what the spec guarantees?

The spec does not guarantee this. We happen to have implemented it this
way in the past, but we spotted this recently and it's already been
changed on the default branch - thus if you compile from source and send
suitably large messages (or negotiate a small frame size) you should now
be able to see this readily enough.

Good to see another implementation coming out.

Best wishes,

Matthew

From harvey.robin at gmail.com  Sun Jan  9 17:11:35 2011
From: harvey.robin at gmail.com (Robin Harvey)
Date: Sun, 9 Jan 2011 17:11:35 +0000
Subject: [rabbitmq-discuss] New open source PHP Amqp implementation
In-Reply-To: <AANLkTi=CT+V=EShKxMR6Biws5yv+SGDJ7ggg1xtqRB-8@mail.gmail.com>
References: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
	<4D28711D.5010504@rabbitmq.com>
	<AANLkTim2X-+CTJXdUCw4pUSXxtU2wjqk-Cam7nq3KPJU@mail.gmail.com>
	<4D287D54.3070507@rabbitmq.com>
	<AANLkTima_Gottvxnb+kc6675ZrVeYxb4o6DiEQ2sb4Wq@mail.gmail.com>
	<4D2884C8.3020405@rabbitmq.com>
	<AANLkTi=CT+V=EShKxMR6Biws5yv+SGDJ7ggg1xtqRB-8@mail.gmail.com>
Message-ID: <AANLkTi=bMZnG2A2K-NnNqigsJ+pehz7_-=QznVHx+rm+@mail.gmail.com>

Hi,

This is in response to Matthew Sackman - I've only just spotted Matthew's
response from yesterday - I get the daily digest so Matthew's response
missed me until just now! (appologies is this causes confusion)

> it's already been
> changed on the default branch - thus if you compile from source and send
> suitably large messages (or negotiate a small frame size) you should now
> be able to see this readily enough.

I'm using version 2.2.0-1 on Ubuntu 10.10
(from rabbitmq-server_2.2.0-1_all.deb) - is this the wrong version to get
interleaved messages?  Is there a .deb for the correct version or is it just
your repo HEAD version for now?

Thanks,
--Robin



On Sat, Jan 8, 2011 at 3:51 PM, Robin Harvey <harvey.robin at gmail.com> wrote:

> Thanks for you help Matthias, the stripped xml file seems to have
> everything.
>
> --Robin
>
>
> On Sat, Jan 8, 2011 at 3:37 PM, Matthias Radestock <matthias at rabbitmq.com>wrote:
>
>> Robin,
>>
>>
>> Robin Harvey wrote:
>>
>>> I can't see exchange.bind - should this be at
>>> /amqp/class[@name="exchange"]/method[@name="bind"] ?
>>>
>>
>> It's only in amqp0-9-1.stripped.xml. You really should be using that for
>> the code gen due to its more liberal license.
>>
>>
>>  For the access class, can I remove all this code for 0.9.1?  At the
>>> moment my API captures the response request-ok.ticket field and
>>> automatically adds this to outgoing messages (in the deprecated-1 field) -
>>> can this all be removed?
>>>
>>
>> Yes. All that is gone.
>>
>>
>> Matthias.
>>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110109/16a4f03c/attachment.htm>

From matthew at rabbitmq.com  Sun Jan  9 17:58:50 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Sun, 9 Jan 2011 17:58:50 +0000
Subject: [rabbitmq-discuss] New open source PHP Amqp implementation
In-Reply-To: <AANLkTi=bMZnG2A2K-NnNqigsJ+pehz7_-=QznVHx+rm+@mail.gmail.com>
References: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
	<4D28711D.5010504@rabbitmq.com>
	<AANLkTim2X-+CTJXdUCw4pUSXxtU2wjqk-Cam7nq3KPJU@mail.gmail.com>
	<4D287D54.3070507@rabbitmq.com>
	<AANLkTima_Gottvxnb+kc6675ZrVeYxb4o6DiEQ2sb4Wq@mail.gmail.com>
	<4D2884C8.3020405@rabbitmq.com>
	<AANLkTi=CT+V=EShKxMR6Biws5yv+SGDJ7ggg1xtqRB-8@mail.gmail.com>
	<AANLkTi=bMZnG2A2K-NnNqigsJ+pehz7_-=QznVHx+rm+@mail.gmail.com>
Message-ID: <20110109175848.GA19650@wellquite.org>

Hi Robin,

On Sun, Jan 09, 2011 at 05:11:35PM +0000, Robin Harvey wrote:
> I'm using version 2.2.0-1 on Ubuntu 10.10
> (from rabbitmq-server_2.2.0-1_all.deb) - is this the wrong version to get
> interleaved messages?  Is there a .deb for the correct version or is it just
> your repo HEAD version for now?

Just the head of default branch (not tip) for now has this. Nothing
released does this yet.

Matthew

From underattack7 at googlemail.com  Sun Jan  9 23:47:40 2011
From: underattack7 at googlemail.com (underattack7)
Date: Sun, 9 Jan 2011 23:47:40 +0000
Subject: [rabbitmq-discuss] Permission on routing key
In-Reply-To: <4D281B13.70600@rabbitmq.com>
References: <AANLkTim4vnrgvj1gY-NoBDeOai3TzrKds4mt4J5=p3oe@mail.gmail.com>
	<4D272422.7070504@rabbitmq.com> <30614971.post@talk.nabble.com>
	<4D272C66.7070507@rabbitmq.com> <30615079.post@talk.nabble.com>
	<30619161.post@talk.nabble.com> <4D281B13.70600@rabbitmq.com>
Message-ID: <AANLkTi=spfycv07MsLe+sg0o5+HBH6gDCwjZgKZtbAkd@mail.gmail.com>

Thanks Matthias,
Exchanges bound to exchanges work fine for us.
Cheers,
Fab

Le samedi 8 janvier 2011, Matthias Radestock <matthias at rabbitmq.com> a ?crit?:
> Michi,
>
> Michi Oshima wrote:
>
> In this thread we've been trying to control how queue are bound to an
> exchange. ?One way to get that to happen was for us (aka., "the creator of
> the usertest user") to bind a queue on behalf of the user.
>
> In addition I wanted to ensure queue deletion when the user connection
> terminates.
>
> I'm finding that exclusive=true won't work.
>
> Around queue creation and binding, we brought up two cases:
>
> 1. We create and bind the queue on behalf of the user.
> 2. User creates a queue, but we bind the queue on behalf of the user.
>
> In #1, exclusive=true causes an error when the user tries to consume a queue
> created by us.
>
> In #2, exclusive=true causes an error when when we try to bind the queue
> created by the user.
>
>
> You missed the third case we discussed: We create an internal exchange per user, bind that to the main exchange with all the allowed binding keys, and then let the user create queues and bind them to their internal exchange. exclusive=true works fine in that case.
>
>
> Matthias.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From jamesc.000 at gmail.com  Mon Jan 10 09:00:34 2011
From: jamesc.000 at gmail.com (James Casey)
Date: Mon, 10 Jan 2011 10:00:34 +0100
Subject: [rabbitmq-discuss] Management API questions
Message-ID: <AANLkTimqdfMfj94U=3mdDQAUSiuYKmukc-Jc4uX+DKPd@mail.gmail.com>

Hi,

I've written some Nagios plugins using the management API :
<http://github.com/jamesc/nagios-plugins-rabbitmq> to do some remote
monitoring of a broker.  I just wanted to clarify some things I see
when running them.

Currently I use 2 API calls:

1)  /api/aliveness-test

I have a question here - is it understood that testing only 1 vhost is
enough to check the aliveness of the broker, or should all vhosts be
tested?

2) /api/nodes

I want to reduce the permissions of the monitoring user to the
minimum, in particular to not give it admin rights.  But I note that
/api/nodes is protected and only accessible by admin (while other
generic calls such as /api/overview) are not.  Is this a design
decision or a bug ?

Anyway, the management API is great and has made it very easy to write
these nagios checks.

cheers,

James.

From simon at rabbitmq.com  Mon Jan 10 10:35:03 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Mon, 10 Jan 2011 10:35:03 +0000
Subject: [rabbitmq-discuss] X.509 client authentication
In-Reply-To: <AANLkTimcTbnHSmk=NqyW1rqyaFThYF4AsJbcjM+eQw85@mail.gmail.com>
References: <083D5377F8EC294D884D590409EFE70D71116DC9D1@MAIL02.austin.utexas.edu>	<4D25D811.906@rabbitmq.com>	<083D5377F8EC294D884D590409EFE70D71116DCAA8@MAIL02.austin.utexas.edu>	<4D26FC75.1000402@rabbitmq.com>
	<AANLkTimcTbnHSmk=NqyW1rqyaFThYF4AsJbcjM+eQw85@mail.gmail.com>
Message-ID: <4D2AE0D7.8080100@rabbitmq.com>

On 07/01/11 14:06, James Casey wrote:
> what are the restrictions you have in usernames ?  Does it have to be
> a non-whitespace string ?  Are there length restrictions ?

There are no limits to the string format, and I'm not aware of any 
limits to the length.

> We're also in the situation where we have to accept 50-60 CAs (all
> with different naming structures for the DN).  We implemented
> something for activemq (where the username is just any Java string
> that can be compared against).  Here we simply did standard URI
> escaping to map into a username.  E.g for my DN:
>
> '/DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jamesc/CN=380618/CN=James Casey'
>
> I get a username of
>   '%2FDC%3Dch%2FDC%3Dcern%2FOU%3DOrganic%20Units%2FOU%3DUsers%2FCN%3Djamesc%2FCN%3D380618%2FCN%3DJames%20Casey'
> Since these are never entered directly by a user it's not such a big
> problem that they are long.  Of course if you've no problems with
> spaces, etc in a username you could just use the DN directly as the
> username.

Sure, we could use the un-uri-escaped version.

>> As soon as we start using DNs as usernames we have all sorts of problems
>> with normalisation. I'm not a real X.509 expert, but it doesn't seem like
>> there's a standard normalisation for DNs as strings. There are some
>> conventions but they seem to get very hazy once you look at issues like
>> escaping.
> I guess the 'standard' is what 'openssl x509 -subject' gives back.
> Note that the java tools work differently (elements in reversed order
> with comma separation instead of / separators.

I think the Java format is RFC 4514, which is more of a standard. What 
'openssl x509 -subject' gives back isn't documented anywhere that I can 
see. However, even if we say "use RFC 4514", that doesn't define a 
normailised representation. So we'd want to answer questions like:

* Since matching for some types of RDNs is case insensitive, should we 
covert these to lower case, upper case or what?

* Since there are multiple ways to escape, which is canonical?

This is all predicated on the idea that people will want to be able to 
predict the exact DN representation we use.

>>> I could handle storage of user details and authorization in a number
>>> of ways without any problems. I could store an external mapping of DN
>>> ->    RabbitMQ username and then let RabbitMQ do its normal
>>> authorization against the username. I could store DNs and permissions
>>> externally and have RabbitMQ do authorization call outs. I'm sure
>>> there are other ways that would work fine, too. I do want different
>>> users to have different permissions, but doing this on a per-vhost
>>> level should be enough for me.
>>>
>>> I think the main thing is how much you all want to integrate client
>>> DNs into the service vs a plugin. If you want it very integrated,
>>> DN->username mappings could be stored in the Mnesia and managed by
>>> rabbitmqctl. A user could then potentially have multiple DNs (we have
>>> this situation sometimes) and be able to authenticate using a DN or a
>>> username/password.
>>
>> Hmm. The idea is that SASL EXTERNAL is just another way to authenticate, and
>> so it provides a username. I'm not sure a DN-to-username mapping is the best
>> way to proceed (suppose you're not storing users in Mnesia - do all auth
>> backends need to support such a mapping?)
>>
>
> I think this isn't such a good idea - it's tricky mapping multiple DNs
> to the same 'user'.  Often a user has multiple DNs since he wants to
> distinguish himself this way (an DN for admin access vs a DN for
> normal access).  The issue I see here is what happens when a user gets
> a new DN after an old one expired and the CA has a policy of
> generating a new DN string (usually by appending a random number in a
> CN field.  Normally you then need admin tools to change a username,
> keeping the same permissions.

Hmm. The trouble with mapping multiple DNs to one user (from my point of 
view!) is that it makes the EXTERNAL provider stateful, and (as 
mentioned below) the state can't be assumed to reside in Mnesia.

I think I need to think about this more...

> One question here on the implementation - with an external provider
> it's only for authentication, right?  Authorization is still done by
> storing permissions in Mnesia against users ?

If you want. The "user database" part has also become pluggable on 
default, so permissions could be held in LDAP for example.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From simon at rabbitmq.com  Mon Jan 10 10:53:40 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Mon, 10 Jan 2011 10:53:40 +0000
Subject: [rabbitmq-discuss] Management API questions
In-Reply-To: <AANLkTimqdfMfj94U=3mdDQAUSiuYKmukc-Jc4uX+DKPd@mail.gmail.com>
References: <AANLkTimqdfMfj94U=3mdDQAUSiuYKmukc-Jc4uX+DKPd@mail.gmail.com>
Message-ID: <4D2AE534.6050003@rabbitmq.com>

On 10/01/11 09:00, James Casey wrote:
> I've written some Nagios plugins using the management API :
> <http://github.com/jamesc/nagios-plugins-rabbitmq>  to do some remote
> monitoring of a broker.

Cool!

> I just wanted to clarify some things I see
> when running them.
>
> Currently I use 2 API calls:
>
> 1)  /api/aliveness-test
>
> I have a question here - is it understood that testing only 1 vhost is
> enough to check the aliveness of the broker, or should all vhosts be
> tested?

It should be. The vhost is required for that call because the test does 
some work; it needs a vhost to do it in. However, while I can't 
necessarily predict all failure scenarios, it's very hard to think of 
one that would break one vhost and leave others working; vhosts are 
quite shallow inside Rabbit.

> 2) /api/nodes
>
> I want to reduce the permissions of the monitoring user to the
> minimum, in particular to not give it admin rights.  But I note that
> /api/nodes is protected and only accessible by admin (while other
> generic calls such as /api/overview) are not.  Is this a design
> decision or a bug ?

Somewhere in between I think. In future the user might be able to start 
/ stop nodes, which would certainly require admin rights. I'm not sure 
there's a good reason other than that. I'll have a look at this.

By the way, I had a look in the plugin code and I see you're pulling 
down /api/nodes/rabbit@(shortname). Is there a reason not to use 
/api/nodes, which will return detail for all nodes (if there's more than 
one node in the cluster)?

> Anyway, the management API is great and has made it very easy to write
> these nagios checks.

Thanks!

Cheers, Simon
-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From matthias at rabbitmq.com  Mon Jan 10 11:02:39 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Mon, 10 Jan 2011 11:02:39 +0000
Subject: [rabbitmq-discuss] X.509 client authentication
In-Reply-To: <4D2AE0D7.8080100@rabbitmq.com>
References: <083D5377F8EC294D884D590409EFE70D71116DC9D1@MAIL02.austin.utexas.edu>	<4D25D811.906@rabbitmq.com>	<083D5377F8EC294D884D590409EFE70D71116DCAA8@MAIL02.austin.utexas.edu>	<4D26FC75.1000402@rabbitmq.com>	<AANLkTimcTbnHSmk=NqyW1rqyaFThYF4AsJbcjM+eQw85@mail.gmail.com>
	<4D2AE0D7.8080100@rabbitmq.com>
Message-ID: <4D2AE74F.7040408@rabbitmq.com>

On 10/01/11 10:35, Simon MacMullen wrote:
> I think the Java format is RFC 4514, which is more of a standard. What
> 'openssl x509 -subject' gives back isn't documented anywhere that I can
> see.

The openssl "-nameopt RFC2253" option produces standards-compliant output.

See http://www.lshift.net/blog/2007/10/30/whats-in-a-distinguished-name 
for a nice little primer on DNs and DN equivalence.

> So we'd want to answer questions like:
>
> * Since matching for some types of RDNs is case insensitive, should we
> covert these to lower case, upper case or what?
>
> * Since there are multiple ways to escape, which is canonical?

+ how to deal with multi-valued RDNs.


Matthias.

From jamesc.000 at gmail.com  Mon Jan 10 12:34:49 2011
From: jamesc.000 at gmail.com (James Casey)
Date: Mon, 10 Jan 2011 13:34:49 +0100
Subject: [rabbitmq-discuss] Management API questions
In-Reply-To: <4D2AE534.6050003@rabbitmq.com>
References: <AANLkTimqdfMfj94U=3mdDQAUSiuYKmukc-Jc4uX+DKPd@mail.gmail.com>
	<4D2AE534.6050003@rabbitmq.com>
Message-ID: <AANLkTi=5VcXT=20NubEq+FO-Xp4RKhHUFeAT6gUwoU+U@mail.gmail.com>

On 10 January 2011 11:53, Simon MacMullen <simon at rabbitmq.com> wrote:
> On 10/01/11 09:00, James Casey wrote:
>>
>> I've written some Nagios plugins using the management API :
>> <http://github.com/jamesc/nagios-plugins-rabbitmq> ?to do some remote
>> monitoring of a broker.
>
> Cool!
>
>> I just wanted to clarify some things I see
>> when running them.
>>
>> Currently I use 2 API calls:
>>
>> 1) ?/api/aliveness-test
>>
>> I have a question here - is it understood that testing only 1 vhost is
>> enough to check the aliveness of the broker, or should all vhosts be
>> tested?
>
> It should be. The vhost is required for that call because the test does some
> work; it needs a vhost to do it in. However, while I can't necessarily
> predict all failure scenarios, it's very hard to think of one that would
> break one vhost and leave others working; vhosts are quite shallow inside
> Rabbit.
>
Ok great.  So I can setup a monitoring vhost which only that user has
access to (and the monitor user doesn't need access to my normal
vhosts used for application messages).

>> 2) /api/nodes
>>
>> I want to reduce the permissions of the monitoring user to the
>> minimum, in particular to not give it admin rights. ?But I note that
>> /api/nodes is protected and only accessible by admin (while other
>> generic calls such as /api/overview) are not. ?Is this a design
>> decision or a bug ?
>
> Somewhere in between I think. In future the user might be able to start /
> stop nodes, which would certainly require admin rights. I'm not sure there's
> a good reason other than that. I'll have a look at this.
>
One nice thing here might be a read-only mode as well as admin mode
for a user.  I can see situations where I would give end-users
read-only access to the higher level nodes/overview information
without giving them full admin access.

Maybe this can be done on the mochiweb config level too where one is
only allowed GETs and not PUT/POST/DELETEs.

> By the way, I had a look in the plugin code and I see you're pulling down
> /api/nodes/rabbit@(shortname). Is there a reason not to use /api/nodes,
> which will return detail for all nodes (if there's more than one node in the
> cluster)?

My thinking was that there would be a separate instance of the nagios
check bound to each underlying machine in the cluster so that the
alarm would appear on the right machine.  But I can see the use of
giving overall cluster metrics too.

I'll set up a cluster and have play with that.

cheers,

James.
>
>> Anyway, the management API is great and has made it very easy to write
>> these nagios checks.
>
> Thanks!
>
> Cheers, Simon
> --
> Simon MacMullen
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From thehcdreamer at gmail.com  Mon Jan 10 15:48:58 2011
From: thehcdreamer at gmail.com (Oscar Del Ben)
Date: Mon, 10 Jan 2011 07:48:58 -0800 (PST)
Subject: [rabbitmq-discuss] Getting error when starting database
Message-ID: <379d4f51-7909-4783-969e-87d595153437@n2g2000pre.googlegroups.com>

Hello guys,

I'm a bit unexperienced with Erlang and rabbitmq. I was able to
install rabbitmq on my local machine and it was running ok since
today, when I started to get this error:

Any idea what's wrong?

Activating RabbitMQ plugins ...
0 plugins activated:


+---+   +---+
|   |   |   |
|   |   |   |
|   |   |   |
|   +---+   +-------+
|                   |
| RabbitMQ  +---+   |
|           |   |   |
|   v2.1.1  +---+   |
|                   |
+-------------------+
AMQP 0-9-1 / 0-9 / 0-8
Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies
LLC., and Rabbit Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

node           : rabbit at oscar
app descriptor : /usr/local/Cellar/rabbitmq/2.1.1/lib/rabbitmq/erlang/
lib/rabbitmq-2.1.1/ebin/rabbit.app
home dir       : /Users/oscardelben
cookie hash    : 02ReUvRNJFuD70l4hQ7N8g==
log            : /usr/local/var/log/rabbitmq/rabbit at oscar.log
sasl log       : /usr/local/var/log/rabbitmq/rabbit at oscar-sasl.log
database dir   : /usr/local/var/lib/rabbitmq/mnesia/rabbit at oscar
erlang version : 5.8.1

starting file handle cache
server                                     ...done
starting worker
pool                                                  ...done
starting
database                                                     ...
{"Kernel pid
terminated",application_controller,"{application_start_failure,rabbit,
{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{{case_clause,{error,
{timeout_waiting_for_tables,
[rabbit_user,rabbit_user_permission,rabbit_vhost,rabbit_listener,rabbit_durable_route,rabbit_route,rabbit_reverse_route,rabbit_durable_exchange,rabbit_exchange,rabbit_durable_queue,rabbit_queue]}}},
[{rabbit,'-run_boot_step/1-lc$^1/1-1-',1},{rabbit,run_boot_step,1},
{rabbit,'-start/2-lc$^0/1-0-',1},{rabbit,start,2},
{application_master,start_it_old,4}]}}}}}"}

Crash dump was written to: erl_crash.dump
Kernel pid terminated (application_controller)
({application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,
[]]},{'EXIT',{{case_clause,{error,{timeout_waiting_for_tables,
[rabbit_user,rabbit

From matthew at rabbitmq.com  Mon Jan 10 15:55:31 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Mon, 10 Jan 2011 15:55:31 +0000
Subject: [rabbitmq-discuss] Getting error when starting database
In-Reply-To: <379d4f51-7909-4783-969e-87d595153437@n2g2000pre.googlegroups.com>
References: <379d4f51-7909-4783-969e-87d595153437@n2g2000pre.googlegroups.com>
Message-ID: <20110110155531.GB20637@rabbitmq.com>

On Mon, Jan 10, 2011 at 07:48:58AM -0800, Oscar Del Ben wrote:
> Hello guys,
> 
> I'm a bit unexperienced with Erlang and rabbitmq. I was able to
> install rabbitmq on my local machine and it was running ok since
> today, when I started to get this error:

My guess is that you clustered it and now it's waiting for the master to
come up before it can resync.

The simplest thing for you to do is to
rm -rf '/usr/local/var/lib/rabbitmq/mnesia/rabbit at oscar'
though you'll lose all messages, queues, exchanges, bindings and users
you've created so far. If you're just experimenting atm though, that's
unlikely to be important to you.

Matthew

From abhishek.kona at gmail.com  Mon Jan 10 16:10:52 2011
From: abhishek.kona at gmail.com (Abhishek Kona)
Date: Mon, 10 Jan 2011 21:40:52 +0530
Subject: [rabbitmq-discuss] RabbitMQ JavaAPI Queueing Consumer
Message-ID: <4D2B2F8C.5000306@gmail.com>

Hi

I have had a look at the Queuing Consumer example given at 
http://www.rabbitmq.com/api-guide.html

*boolean*  autoAck =*false*;
QueueingConsumer consumer =*new*  QueueingConsumer(channel);
channel.basicConsume(queueName, autoAck, consumer);
*while*  (//* decide whether to continue reading *//) {
     QueueingConsumer.Delivery delivery;
     *try*  {
         delivery = consumer.nextDelivery();

	
     }*catch*  (InterruptedException ie) {
         *continue*;
     }
     ///MY APPLICATION CODE
/     channel.basicAck(delivery.getEnvelope().getDeliveryTag(),*false*);
}


I want to pass the message to a Separate Java Runnable Class (I am using 
Java ThreadPool Executors).
So I want to know how can the separate thread acknowledge the message.
I believe the message gets re-enqueued once the channel is closed.

Also how can I handle channel closing down or going stale (due to 
reasons like network outage)   in the above scenario.

-Abhishek Kona
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110110/8c7fa26a/attachment.htm>

From david at rabbitmq.com  Mon Jan 10 16:33:03 2011
From: david at rabbitmq.com (David Wragg)
Date: Mon, 10 Jan 2011 16:33:03 +0000
Subject: [rabbitmq-discuss] iPhone client API
In-Reply-To: <AANLkTin=ffgTqTWcQZrPFjQx8R1BbZiPT1NC5YK8C2Jy@mail.gmail.com>
	(Jason J. W. Williams's message of "Thu, 6 Jan 2011 12:35:25 -0700")
References: <AANLkTim_LJs2nkDtBWt1kgWWdtzjJjw58gcwN8TzsfxT@mail.gmail.com>
	<AANLkTin=ffgTqTWcQZrPFjQx8R1BbZiPT1NC5YK8C2Jy@mail.gmail.com>
Message-ID: <yrv4c39p0wwg0.fsf@dwragg.eng.vmware.com>

"Jason J. W. Williams" <jasonjwwilliams at gmail.com> writes:
> There's also the RabbitMQ C client, but I don't know what it's state is:
>
> http://hg.rabbitmq.com/rabbitmq-c/

The C client is widely used and actively developed.  I haven't heard of
anyone using it under iOS, but I expect it would work there (it works
under OS X).

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From thehcdreamer at gmail.com  Mon Jan 10 19:09:28 2011
From: thehcdreamer at gmail.com (Oscar Del Ben)
Date: Mon, 10 Jan 2011 11:09:28 -0800 (PST)
Subject: [rabbitmq-discuss] Getting error when starting database
In-Reply-To: <20110110155531.GB20637@rabbitmq.com>
References: <379d4f51-7909-4783-969e-87d595153437@n2g2000pre.googlegroups.com>
	<20110110155531.GB20637@rabbitmq.com>
Message-ID: <2ee47209-541e-444e-9fa4-bd35406940b3@c13g2000prc.googlegroups.com>

Thanks.

That did solve the problem indeed.

On Jan 10, 4:55?pm, Matthew Sackman <matt... at rabbitmq.com> wrote:
> On Mon, Jan 10, 2011 at 07:48:58AM -0800, Oscar Del Ben wrote:
> > Hello guys,
>
> > I'm a bit unexperienced with Erlang and rabbitmq. I was able to
> > install rabbitmq on my local machine and it was running ok since
> > today, when I started to get this error:
>
> My guess is that you clustered it and now it's waiting for the master to
> come up before it can resync.
>
> The simplest thing for you to do is to
> rm -rf '/usr/local/var/lib/rabbitmq/mnesia/rabbit at oscar'
> though you'll lose all messages, queues, exchanges, bindings and users
> you've created so far. If you're just experimenting atm though, that's
> unlikely to be important to you.
>
> Matthew
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From tonygarnockjones+rabbitmq at gmail.com  Mon Jan 10 21:38:01 2011
From: tonygarnockjones+rabbitmq at gmail.com (Tony Garnock-Jones)
Date: Mon, 10 Jan 2011 16:38:01 -0500
Subject: [rabbitmq-discuss] Pika
Message-ID: <AANLkTinn66KftUoLzwZq5Z+EO5ZhdHmtHGkHHxao87EL@mail.gmail.com>

Hi all,

I'm afraid I've been away from the community for a while, as I'm currently
starting work toward a PhD at Northeastern University in Boston and haven't
had much time to work on RabbitMQ or rabbit-related things. Because of this,
some of the rabbity code I've written, such as Pika, has suffered, and so
I'm pleased to announce that Gavin M. Roy http://github.com/gmr has joined
the Pika project. His first contribution is support for fully-asynchronous
use of the library, initially for use with Tornado.

For now we'll both be pushing changes to http://github.com/tonyg/pika. If
anyone else would like to get involved, now would be a good time to speak up
:-) and I guess you can contact either me or Gavin (cc'd) or both.

Regards,
  Tony
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110110/ced98eba/attachment-0001.htm>

From ciprian.craciun at gmail.com  Mon Jan 10 22:30:41 2011
From: ciprian.craciun at gmail.com (Ciprian Dorin Craciun)
Date: Tue, 11 Jan 2011 00:30:41 +0200
Subject: [rabbitmq-discuss] Strange RabbitMQ management plugin error!
In-Reply-To: <AANLkTi=WAUNMnCK5WyTZFYMHXBJMZ8C_Vz6sHyJy77Wf@mail.gmail.com>
References: <AANLkTi=WAUNMnCK5WyTZFYMHXBJMZ8C_Vz6sHyJy77Wf@mail.gmail.com>
Message-ID: <AANLkTim8pSf6r+o=i0tTWXEumU2faJnh3N=wfExWRR3C@mail.gmail.com>

 ? Hello all!

? ?I've installed the management plugin (and it's dependencies), and
when accessing it I get the following error on almost all pages and I
don't see any counters... (But it seems to work otherwise as I can see
and manipulate other entities: queues, exchanges, etc.)

~~~~
TypeError: overview.queue_totals is undefined
~~~~

? ?Is there something wrong?

? ?Thanks,
? ?Ciprian.

? ?P.S.: Maybe I should add that the way in which I've installed
RabbitMQ and the plugins is a little unorthodox --- although it works
perfectly in any other ways (it passes the amqp_client tests)... I've
compiled the `erl` source code for Rabbit manually and not with the
makefiles (I've just runned the makefile to obtain the automatic
generated files), and then I've put all the applications (rabbit, the
management plugin and its dependencies) in a folder obeying the OTP
application hierarchy (unarchived), and started them as follows. (I
also used a config file based on the one packaged with the Rabbit
distribution.)

~~~~
...
? ? ? ?ok = application:start (os_mon),
? ? ? ?ok = application:start (crypto),
? ? ? ?ok = application:start (mnesia),
? ? ? ?ok = application:start (inets),
? ? ? ?ok = application:start (rabbit),
? ? ? ?ok = application:start (mochiweb),
? ? ? ?ok = application:start (webmachine),
? ? ? ?ok = application:start (rabbit_mochiweb),
? ? ? ?ok = application:start (rabbit_management_agent),
? ? ? ?ok = application:start (rabbit_management),

? ? ? ?ok = rabbit:prepare (),
...
~~~~

From nehakothari86 at gmail.com  Mon Jan 10 21:57:08 2011
From: nehakothari86 at gmail.com (Neha)
Date: Mon, 10 Jan 2011 13:57:08 -0800 (PST)
Subject: [rabbitmq-discuss] Consumers stops to pick up messages after long
	inactivity
Message-ID: <02df0bac-c856-4af7-93ee-fbcd600a4fff@j25g2000vbs.googlegroups.com>

I have an application which uses rabbitmq. It has messages being sent
from Monday to Friday and on the weekend there are no messages sent.

The application works fine on regular days, i.e producers puts the
message on the queue and the consumer receives the message. But every
Monday, after the weekend the consumer starts behaving strangely. It
stops receiving messages even though the queue has messages present.
The heartbeat of the consumer all this time is working fine but it
still doesn't receive all these messages on the queue. To overcome
this problem I have to restart the consumers every Monday, and as soon
as I do that, all the messages that are present in the queue starts
getting consumed.

Looking at a problem, I feel it might be due to inactivity during the
weekend. I wanted to know if anyone else has faced this problem
wherein the consumer stops consuming after a long duration of
inactivity? Is there a setting to be tweaked to increase this period?

Comments, suggestions, help is appreciated.

Thanks
Neha



From simon at rabbitmq.com  Tue Jan 11 10:34:03 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Tue, 11 Jan 2011 10:34:03 +0000
Subject: [rabbitmq-discuss] Strange RabbitMQ management plugin error!
In-Reply-To: <AANLkTim8pSf6r+o=i0tTWXEumU2faJnh3N=wfExWRR3C@mail.gmail.com>
References: <AANLkTi=WAUNMnCK5WyTZFYMHXBJMZ8C_Vz6sHyJy77Wf@mail.gmail.com>
	<AANLkTim8pSf6r+o=i0tTWXEumU2faJnh3N=wfExWRR3C@mail.gmail.com>
Message-ID: <4D2C321B.8040100@rabbitmq.com>

On 10/01/11 22:30, Ciprian Dorin Craciun wrote:
>      Hello all!

Hi Ciprian.

>     I've installed the management plugin (and it's dependencies), and
> when accessing it I get the following error on almost all pages and I
> don't see any counters... (But it seems to work otherwise as I can see
> and manipulate other entities: queues, exchanges, etc.)
>
> ~~~~
> TypeError: overview.queue_totals is undefined
> ~~~~

Thanks for explaining the unusual way you're starting RabbitMQ. That is 
likely to be the problem.

The management plugin uses a feature (fine grained statistics) that it 
needs to turn on in the main rabbit application. It sounds like this is 
not happening. This is controlled via a couple of application 
configuration parameters. Normally they default to turning this on, and 
the management plugin should detect if that's switched off and adjust 
the interface (and display warnings) accordingly, but that might not be 
happening for you.

What does your config file look like?

Also, why have you done this? What problem is it solving?

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From sami at samhuri.net  Tue Jan 11 00:15:25 2011
From: sami at samhuri.net (Sami Samhuri)
Date: Mon, 10 Jan 2011 16:15:25 -0800
Subject: [rabbitmq-discuss] Implementing a "processing" queue with message
	expiry
Message-ID: <AANLkTikRt91x_VFa1aXqzvMeX1hLE9nDAaA6BHe226Ur@mail.gmail.com>

Hi all,

I'm designing a small distributed system with some queueing involved and
have some doubts that Rabbit is the right solution for parts of it. Hoping
that some of you can shed some light and let me know if Rabbit can do it
all, which would be great, or if there's a better and/or simpler solution
I've missed. I realize that Rabbit is for message passing and is not a work
queue, so perhaps I'm trying to shove a square peg into a round hole. If so
please tell me that I'm barking up the wrong tree.

The system is pretty simple and will only have 2 persistent queues, 1
producer, and 1 consumer (initially anyway). Our frontend machine will act
on requests from our users and queue up jobs on request. The worker machine
will get jobs from that queue, process them, and then place the results in a
2nd queue which the frontend machine will consume, making the results
available to our users. So far it's pretty straightforward and RabbitMQ
handles this with ease.

,----------,                    ,--------,
|          |  --- Queue #1 ---> |        |   Work to be done goes in Queue
#1
| Frontend |                    | Worker |
|          | <--- Queue #2 ---  |        |   Completed work goes in Queue #2
`----------`                    `--------`

Now real life has to come along and mess it all up. When a worker is struck
by lightning in the simple system above the job it was working on would be
lost, which is bad. To me it seems like we need a 3rd "queue" that holds
jobs that are currently being processed, and a timeout so that if a job
being processed hasn't completed within N minutes it's put back into the
first queue so another worker can pick up the job. This queue must also be
persistent. The problem is that this 3rd thing isn't really a queue at all.
I'd like to remove any specific item from this thing, whether the job was
completed or timed out, and thus I need to find and remove arbitrary
messages/items.

I feel like I need to write a bit of code that handles the list of
jobs-in-progress and persists it to our main data store (distributed, backed
up, etc). If I do all of that when not just put the other 2 queues in our
main data store as well? Rabbit still buys us a little for those 2 queues,
but not very much. It's easy enough for me to add authenticated HTTP
endpoints and distributed, fault-tolerance persistence for a couple of
queues.

Is there some other solution that makes this easier, or does Rabbit have
something to handle these sorts of cases? If I can't use Rabbit for all of
this it may not be worth adding Rabbit to our infrastructure for the 2 very
simple queues illustrated above.

Thanks for reading this far :)

-s
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110110/2ce3b615/attachment.htm>

From yaohui1984 at qq.com  Tue Jan 11 08:16:48 2011
From: yaohui1984 at qq.com (=?ISO-8859-1?B?eWFvaHVp?=)
Date: Tue, 11 Jan 2011 16:16:48 +0800
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for rabbitmq?
Message-ID: <tencent_0BCB958774C49336664C9567@qq.com>

thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110111/d7cbb81f/attachment.htm>

From jiri at krutil.com  Tue Jan 11 10:50:28 2011
From: jiri at krutil.com (jiri at krutil.com)
Date: Tue, 11 Jan 2011 11:50:28 +0100
Subject: [rabbitmq-discuss] Java client: channel shutdown notification while
 closing connection
Message-ID: <20110111115028.11234me7qyqi7pc0@webmail.active24.cz>

Hi

I have run into a deadlock in my Java client application.

I have a synchronized method registered as a shutdown listener on both  
the channel and the connection.

One of our theads got stuck while trying to close the connection  
inside a method synchronized on the same lock as the shutdown listener.

The thread was executing this code:

     private synchronized void closeConnection() throws IOException {
         connection.removeShutdownListener(this);
         if (connection.isOpen())
             connection.close();
     }

The connection shutdown listener has been disabled, but it seems that  
something has triggered the channel shutdown listener. Not sure if  
this was the attempt to close the connection or something else.

The call stack of the closeConnection thread was:

     java/lang/Object.wait(Native Method)
     java/lang/Object.wait(Object.java:199)
     com/rabbitmq/utility/BlockingCell.get(BlockingCell.java:64)
     com/rabbitmq/utility/BlockingCell.get(BlockingCell.java:79)
      
com/rabbitmq/utility/BlockingCell.uninterruptibleGet(BlockingCell.java:125)
      
com/rabbitmq/utility/BlockingValueOrException.uninterruptibleGetValue(BlockingValueOrException.java:51)
      
com/rabbitmq/client/impl/AMQChannel$BlockingRpcContinuation.getReply(AMQChannel.java:348)
     com/rabbitmq/client/impl/AMQConnection.close(AMQConnection.java:710)
     com/rabbitmq/client/impl/AMQConnection.close(AMQConnection.java:640)
     com/rabbitmq/client/impl/AMQConnection.close(AMQConnection.java:626)
     com/rabbitmq/client/impl/AMQConnection.close(AMQConnection.java:619)
     AmqpAdapter.closeConnection(AmqpAdapter.java:477)
     ...

It seems that the method Connection.close() running in our thread was  
waiting for the completion of the channel shutdown listener running in  
the AMQP connection thread. But since the registered listener was  
waiting for the Java lock held by my method closeConnection(), a  
deadlock occured.

Both broker and Java client versions are 2.1.0.

Apparently I am doing something wrong, but I'm not sure what is the  
correct way how to do these things.

Should I unregister the channel shutdown listener before closing the  
connection?
Or should I avoid any synchronization in my shutdown listener? (would  
probably have to redesign)
It seems Connection.close() is synchronous. Should I make my shutdown  
listener asynchronous? (not sure how I would do that)

Any help is appreciated!

Jiri


From david at rabbitmq.com  Tue Jan 11 10:59:59 2011
From: david at rabbitmq.com (David Wragg)
Date: Tue, 11 Jan 2011 10:59:59 +0000
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <tencent_0BCB958774C49336664C9567@qq.com> (yaohui's message of
	"Tue, 11 Jan 2011 16:16:48 +0800")
References: <tencent_0BCB958774C49336664C9567@qq.com>
Message-ID: <yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>

Yes.  rabbitmq-c a.k.a. librabbitmq:

http://hg.rabbitmq.com/rabbitmq-c/
https://github.com/rabbitmq/rabbitmq-c

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From majek04 at gmail.com  Tue Jan 11 11:31:25 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Tue, 11 Jan 2011 11:31:25 +0000
Subject: [rabbitmq-discuss] Implementing a "processing" queue with
	message expiry
In-Reply-To: <AANLkTikRt91x_VFa1aXqzvMeX1hLE9nDAaA6BHe226Ur@mail.gmail.com>
References: <AANLkTikRt91x_VFa1aXqzvMeX1hLE9nDAaA6BHe226Ur@mail.gmail.com>
Message-ID: <AANLkTim0i-oeF=uN9qzTZ6fxg9-PdToNN-ztMmWs-=mn@mail.gmail.com>

On Tue, Jan 11, 2011 at 00:15, Sami Samhuri <sami at samhuri.net> wrote:
> The system is pretty simple and will only have 2 persistent queues, 1
> producer, and 1 consumer (initially anyway). Our frontend machine will act
> on requests from our users and queue up jobs on request. The worker machine
> will get jobs from that queue, process them, and then place the results in a
> 2nd queue which the frontend machine will consume, making the results
> available to our users. So far it's pretty straightforward and RabbitMQ
> handles this with ease.
> ,----------, ? ? ? ? ? ? ? ? ? ?,--------,
> | ? ? ? ? ?| ?--- Queue #1 ---> | ? ? ? ?| ? Work to be done goes in Queue #1
> | Frontend | ? ? ? ? ? ? ? ? ? ?| Worker |
> | ? ? ? ? ?| <--- Queue #2 --- ?| ? ? ? ?| ? Completed work goes in Queue #2
> `----------` ? ? ? ? ? ? ? ? ? ?`--------`
> Now real life has to come along and mess it all up.?When a worker is struck
> by lightning in the simple system above the job it was working on would be
> lost, which is bad. To me it seems like we need a 3rd "queue" that holds
> jobs that are currently being processed, and a timeout so that if a job
> being processed hasn't completed within N minutes it's put back into the
> first queue so another worker can pick up the job.

That's a strange idea. Rabbitmq deals with this problem by using 'acks'.
A worker first gets a message (request), does the job, replies,
and after sending the reply it 'acks' the initial request message.
The request is removed from Rabbit only after it received an ack.

That way when your worker dies during processing of the request,
the request will be redelivered and hopefully handled by another worker.

> This queue must also be
> persistent. The problem is that this 3rd thing isn't really a queue at all.
> I'd like to remove any specific item from this thing, whether the job was
> completed or timed out, and thus I need to find and remove arbitrary
> messages/items.

Rabbit can't do it - you can't 'find arbitrary messages'. Rabbit queues
are FIFO-like structures. You append new messages to one end.
You pop messages from the other end.

> I feel like I need to write a bit of code that handles the list of
> jobs-in-progress and persists it to our main data store (distributed, backed
> up, etc). If I do all of that when not just put the other 2 queues in our
> main data store as well? Rabbit still buys us a little for those 2 queues,
> but not very much. It's easy enough for me to add authenticated HTTP
> endpoints and distributed, fault-tolerance persistence for a couple of
> queues.
> Is there some other solution that makes this easier, or does Rabbit have
> something to handle these sorts of cases? If I can't use Rabbit for all of
> this it may not be worth adding Rabbit to our infrastructure for the 2 very
> simple queues illustrated above.
> Thanks for reading this far :)

Alternative solution would be to make requests idempotent and re-send
the request when the client decides it's waiting too long (ie: message
was lost).

This is worse solution, in practice you can never assume how long
will it take to handle a request.

Cheers,
  Marek

From cristofer.seccia at gmail.com  Tue Jan 11 11:44:54 2011
From: cristofer.seccia at gmail.com (Crisoforo Seccia)
Date: Tue, 11 Jan 2011 12:44:54 +0100
Subject: [rabbitmq-discuss] RabbitMQ Test case - Possible Memory Leak problem
Message-ID: <AANLkTimgA6tNpstggKpeKTj2yUC+xdWGpuAD+CvYP9jq@mail.gmail.com>

Hi,
I'm developing a stress test to compare and measure the performance between
RabbitMQ and ActiveMQ. Also the objective was to compare the standard AMQP
with the JMS specifications. There is something that I would like to share
with the community since I think in could be a possible bug or a memory leak
problem. The stress test is very easy; there are no exponential ore base
variables, just a linear test case. I'm going to describe the scenario.
The scenario is composed by two JAVA clients: a publisher and a subscriber,
and one instance of RabbitMQ (V. 2.2.0) running over a virtual machine 2GB
RAM. The clients, both publisher and subscriber are placed in two different
physical machines. The messages to be sent by the publisher and received by
the subscriber are described within a cluster. A cluster specifies the size
of the body message (in byte) and the total number of messages to send and
receive for that dimension. Ex: C1 = (512::10000). The publisher uses a list
of clusters, and for each one of them it starts a new loop in which messages
are sent. Es: C1 = (512::500000); C2 = (1024::100000); C3 = (2048::10000).
At begin and at the end of each cluster, the publisher sends a special
message used to inform the subscriber that a new cluster is started or is
just finished. Also a special message is sent to the subscriber when all the
clusters have been elaborated. The subscriber does nothing more than
receiving messages and calculates the elapsed time (in seconds) between the
start and the end message for each cluster. The Publisher uses a "direct"
exchange (non-durable, non auto-delete) to publish the messages while the
subscriber creates and binds a new queue over the same "direct" exchange.

This is the code used to initialize the publisher:

ConnectionFactory factory = new ConnectionFactory();
factory.setUsername("guest");
factory.setPassword("guest");
factory.setVirtualHost("/");
factory.setHost("RabbitMQ_Srv_01");
factory.setPort(5672);
conn = factory.newConnection();
channel = conn.createChannel();
boolean durable = false;
boolean autoDelete = false;
channel.exchangeDeclare("linearTest", "direct", durable, autoDelete, null);
...
//Define some properties
AMQP.BasicProperties props = MessageProperties.PERSISTENT_TEXT_PLAIN;
Map<String, Object> headers = new HashMap<String, Object>();
headers.put("TestCommand", CURRENT_COMMAND);
...
props.setHeaders(headers);
//Basic publish
channel.basicPublish("linearExch", "linearKey", props,
CLUSTER[i].messageBodyBytes);
...

This is the code used to initialize the subscriber:

ConnectionFactory factory = new ConnectionFactory();
factory.setUsername("guest");
factory.setPassword("guest");
factory.setVirtualHost("/");
factory.setHost("RabbitMQ_Srv_01");
factory.setPort(5672);
Connection conn = factory.newConnection();
Channel channel = conn.createChannel();
boolean durable = false;
boolean autoDelete = false;
boolean exclusive = false;
channel.exchangeDeclare("linearExch", "direct", durable, autoDelete, null);
channel.queueDeclare("linearQueue", durable, exclusive, autoDelete, null);
channel.queueBind("linearQueue", "linearExch", "linearKey", null);
QueueingConsumer consumer = new QueueingConsumer(channel);
boolean autoAck = false;
channel.basicConsume("linearQueue", autoAck, consumer);

while (true) {
try {
QueueingConsumer.Delivery delivery = consumer.nextDelivery();
onMessage(delivery);
channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
//If shutdown from the publisher is received
if (shutdown) {
channel.close();
conn.close();
break;
}
}
catch (InterruptedException ie) {
continue;
}
}

This is how I've set up the test case:

1.    Started the RabbitMQ broker by using the .bat "rubbitmq-server.bat"
(NO extra configuration used).
2.    Open the task manager to view the RabbitMQ (.erl process) memory
usage.
3.    Started the subscriber.
4.    Started the publisher.
5.    Defined Clusters As: {C1(512:10000); C2(512:10000); C3(512:10000);
C4(512:100000); C5(512:100000); C6(512:100000); C7(1024:10000);
C8(1024:10000); C9(1024:10000); C10(1024:100000); C11(1024:100000);
C12(1024:100000); C13(2048:10000); C14(2048:10000); C15(2048:10000);
C16(2048:100000); C17(2048:100000); C18(2048:100000) }

These are some results and notifications:

. I've started a first test case, I've noticed that RabbitMQ uses lots of
memory during the test. At the first step, where only the broker was
running, just 19 KB of memory were used. At the end of the process the
memory usage increases up to more than 850 KB. After stopping the publisher
and the subscriber, the memory usage was very slowly decreasing from
850-800KB down to 50-20 KB.

. I've started a second test case but this time using the publisher and the
subscriber over the same physical machine. After a few minutes the broker
crashed down showing the following message: "eheap_alloc: Cannot allocate
373662860 bytes of memory (of type "heap")". I've repeated the same test
more and more but every time the broker crashed down.

. I?ve started a third test case, similar to the first one (publisher and
subscriber placed in two different machines) but this time using the
following cluster list:  {C1(512:10000); C2(512:10000); C3(512:10000);
C4(512:100000); C5(512:100000); C6(512:100000); C7(512:500000);
C8(512:500000); C9(512:500000)}. At the time of elaborating the last element
(C9) the broker crashed down showing the same message as the one in the
previous test.

I think that the reason for the second test case can be found in the network
usage, which causes the broker to store in the memory a lots of message
because publisher and subscriber are placed in the same machine and, it?s
clearly that the subscriber leads substantially the usage and the
performance of the process (maybe because of the acknowledgements). But I
don?t have a good idea for the third test case, which causes the same error.

Now I?m facing with the fact that, comparing to ActiveMQ, the second test
and the third test are successfully done, in fact, even if the subscriber
and the publisher are placed in the same machine (the ActiveMQ broker runs
in the same virtual machine as the one used for the RabbitMQ) the test case
comes successfully to the end, and the broke doesn?t crash down. However,
the first test case (described in the first point) seems to be more
efficient, in terms of seconds, by using RabbitMQ.

Here some questions:

. In general, what do you think about the test?
. Am I adopting a very strange test case which is not well handled by
RabbitMQ?
. Is there any connection with the solved bug described in the RabbitMQ 2.2
release notes (?fix memory leak when long-running channels consume and
cancel on many queues?)?
. How does RabbitMQ handle message flooding? As stated in ActiveMQ official
page, the flow control, in the current version means that: ?if the broker
detects that the memory limit for the destination, or the temp- or
file-store limits for the broker, have been exceeded, then the flow of
messages can be slowed down. The producer will be either blocked until
resources are available or will receive a JMSException?.

Thanks for any response.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110111/ae46a278/attachment.htm>

From techabc at gmail.com  Tue Jan 11 13:14:57 2011
From: techabc at gmail.com (techabc)
Date: Tue, 11 Jan 2011 21:14:57 +0800
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
Message-ID: <AANLkTikBr0tDqGvex0dfkfhSOMPDMviH3N0KMPYCxmkj@mail.gmail.com>

>
> but NOT support m$ windows platform.
> the *dg1sbg* branch (https://github.com/dg1sbg, include 2 entry, but what
> the* difference*? ) seems can't keep the same step with rabbitmq-c.
>
> 2011/1/11 David Wragg <david at rabbitmq.com>
>
> Yes.  rabbitmq-c a.k.a. librabbitmq:
>>
>> http://hg.rabbitmq.com/rabbitmq-c/
>> https://github.com/rabbitmq/rabbitmq-c
>>
>> --
>> David Wragg
>> Staff Engineer, RabbitMQ
>> SpringSource, a division of VMware
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110111/a18ce5d0/attachment.htm>

From david at rabbitmq.com  Tue Jan 11 13:21:51 2011
From: david at rabbitmq.com (David Wragg)
Date: Tue, 11 Jan 2011 13:21:51 +0000
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	(techabc@gmail.com's message of "Tue, 11 Jan 2011 21:13:29 +0800")
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
Message-ID: <yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>

techabc <techabc at gmail.com> writes:
> but NOT support m$ windows platform.
> the *dg1sbg* branch (https://github.com/dg1sbg, include 2 entry, but what
> the* difference*? ) seems can't keep the same step with rabbitmq-c.

rabbitmq-c has supported building on Windows with the Microsoft compiler
for a few months.  See the README.windows file for details.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From parki at whatevernot.com  Tue Jan 11 14:11:59 2011
From: parki at whatevernot.com (Brian Parkinson)
Date: Tue, 11 Jan 2011 09:11:59 -0500
Subject: [rabbitmq-discuss] Performance question - java
Message-ID: <68500D9F-43A2-44A9-B7D2-A5512F773E2C@whatevernot.com>

Hello -

I'm evaluating AMQP for use with both Java and C++, and have a question related to the Java library - does it share/pool connections?

I am working on a distributed system, and currently we create an HTTP connection, send a message to a server (host/port) and then tear down the connection - there is a slight overhead to this, but likely not affecting our overall throughput, but ideally, we would like to have the connection open for the send, to avoid the cost of constructing the connection for every message.

So, asking wrt Rabbit - if I send a bunch of messages, is there a connection creation cost for each one?

Any help here is appreciated - I'm spending some time looking at performance, as throughput for us is extremely important.

Thanks.

Brian...



From dbecker at cpicorp.com  Tue Jan 11 15:21:35 2011
From: dbecker at cpicorp.com (Derek Chen-Becker)
Date: Tue, 11 Jan 2011 09:21:35 -0600
Subject: [rabbitmq-discuss] Implementing a "processing" queue with
 message expiry
In-Reply-To: <AANLkTikRt91x_VFa1aXqzvMeX1hLE9nDAaA6BHe226Ur@mail.gmail.com>
References: <AANLkTikRt91x_VFa1aXqzvMeX1hLE9nDAaA6BHe226Ur@mail.gmail.com>
Message-ID: <4D2C757F.2070102@cpicorp.com>

On 01/10/2011 06:15 PM, Sami Samhuri wrote:
> Hi all,
> 
> I'm designing a small distributed system with some queueing involved and
> have some doubts that Rabbit is the right solution for parts of it.
> Hoping that some of you can shed some light and let me know if Rabbit
> can do it all, which would be great, or if there's a better and/or
> simpler solution I've missed. I realize that Rabbit is for message
> passing and is not a work queue, so perhaps I'm trying to shove a square
> peg into a round hole. If so please tell me that I'm barking up the
> wrong tree.

We use RabbitMQ for a render farm work queue and the way you deal with
possible "lost" consumers is with ACKs. You need to turn off auto-ack
when you set up the consumer, and then after you process the message you
explicitly ACK it (BasicAck). If, for some reason, your client dies
while in the middle of processing messages, any unacked messages it was
holding on to get re-inserted into the queue.

Derek

From vfilby at gmail.com  Tue Jan 11 15:25:10 2011
From: vfilby at gmail.com (Vince Filby)
Date: Tue, 11 Jan 2011 10:25:10 -0500
Subject: [rabbitmq-discuss] How to use queues for RPC
Message-ID: <AANLkTinn3hmfrcJsbZf1kz+MjwVSJomLoa3rtAA7LSdt@mail.gmail.com>

I have a distributed system with one central controller and many
devices on remote networks, I want to use AMQP to facilitate
communication between the controller and the clients.  The
communication is mostly RPC but some or pure data (logs, etc).

It is also imperative that the communication is secure, so that no one
can eavesdrop or pose as a client to send false messages.

Should each client have their own queue that is consistently named?
Perhaps when the client connects it creates a randomly named queue it
tells the controller what queue it will be subscribed to? What are the
best practises?

Any advice would be greatly appreciated, especially with regard to
securing the queues.

Regards,
V

From majek04 at gmail.com  Tue Jan 11 15:34:47 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Tue, 11 Jan 2011 15:34:47 +0000
Subject: [rabbitmq-discuss] How to use queues for RPC
In-Reply-To: <AANLkTinn3hmfrcJsbZf1kz+MjwVSJomLoa3rtAA7LSdt@mail.gmail.com>
References: <AANLkTinn3hmfrcJsbZf1kz+MjwVSJomLoa3rtAA7LSdt@mail.gmail.com>
Message-ID: <AANLkTikjkVrusm62yBf9Sbt8x_07cOUEbHLbeJETpHv1@mail.gmail.com>

Hi,

On Tue, Jan 11, 2011 at 15:25, Vince Filby <vfilby at gmail.com> wrote:
> I have a distributed system with one central controller and many
> devices on remote networks, I want to use AMQP to facilitate
> communication between the controller and the clients. ?The
> communication is mostly RPC but some or pure data (logs, etc).
>
> It is also imperative that the communication is secure, so that no one
> can eavesdrop or pose as a client to send false messages.
>
> Should each client have their own queue that is consistently named?

Clients should have random callback queue names.

> Perhaps when the client connects it creates a randomly named queue it
> tells the controller what queue it will be subscribed to? What are the
> best practises?

We're working on tutorial that says about RPC.
You can find the code here:
https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/python/rpc_client.py
https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/python/rpc_server.py

A general idea is explained here:
http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-November/009909.html

>
> Any advice would be greatly appreciated, especially with regard to
> securing the queues.

There's not much to be said on this matter. If you want to make sure
that rpc client doesn't behave as rpc worker you need to use strong
AMQP credentials. You can use rabbitmqctl tool for setting usernames
and permissions.

Hope that helps

Cheers,
 Marek

From emile at rabbitmq.com  Tue Jan 11 15:47:44 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Tue, 11 Jan 2011 15:47:44 +0000
Subject: [rabbitmq-discuss] Consumers stops to pick up messages after
 long inactivity
In-Reply-To: <02df0bac-c856-4af7-93ee-fbcd600a4fff@j25g2000vbs.googlegroups.com>
References: <02df0bac-c856-4af7-93ee-fbcd600a4fff@j25g2000vbs.googlegroups.com>
Message-ID: <4D2C7BA0.9010508@rabbitmq.com>


Hi Neha,

On 10/01/11 21:57, Neha wrote:
> I have an application which uses rabbitmq. It has messages being sent
> from Monday to Friday and on the weekend there are no messages sent.
>
> The application works fine on regular days, i.e producers puts the
> message on the queue and the consumer receives the message. But every
> Monday, after the weekend the consumer starts behaving strangely. It
> stops receiving messages even though the queue has messages present.
> The heartbeat of the consumer all this time is working fine but it
> still doesn't receive all these messages on the queue. To overcome
> this problem I have to restart the consumers every Monday, and as soon
> as I do that, all the messages that are present in the queue starts
> getting consumed.
>
> Looking at a problem, I feel it might be due to inactivity during the
> weekend. I wanted to know if anyone else has faced this problem
> wherein the consumer stops consuming after a long duration of
> inactivity? Is there a setting to be tweaked to increase this period?

Long periods of inactivity should have no effect. The problem is almost 
certainly network-related. Here are some things to check.

Is there anything of interest in the broker logfile?

As there any device along the network path that might have caused the 
connections to be reset?

Does the broker consider the clients to be connected on Monday mornings? 
"rabbitmqctl list_connections" and "rabbitmqctl list_consumers" can help 
determine this. The logfile will show when any connections were 
terminated. Also verify the connection timeout (rabbitmqctl 
list_connections timeout).

You may want to try using a different connection heartbeat value and 
check whether the message consumers are able to recover from network 
interruptions automatically.


Regards

Emile


From msteele at beringmedia.com  Tue Jan 11 16:32:48 2011
From: msteele at beringmedia.com (Mark Steele)
Date: Tue, 11 Jan 2011 11:32:48 -0500
Subject: [rabbitmq-discuss] New open source PHP Amqp implementation
In-Reply-To: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
References: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
Message-ID: <AANLkTi=ALnyw3r5FEhmziDdXg78o1K8OUtV2hL=O5bGA@mail.gmail.com>

Hi Robin,

A few questions:

   - Is it possible to make your class work with SSL connections? (Use php's
   stream context api instead of creating plain sockets?).
   - Will it behave properly in an app that uses signals/alarms?


Nice work, looking forward to testing it.

Mark Steele
Bering Media Inc.


On Sat, Jan 8, 2011 at 8:46 AM, Robin Harvey <harvey.robin at gmail.com> wrote:

> Hello Rabbiteers!
>
>
> I hope I'm not being importune by posting this message to let you know
> about an LGPL Amqp implementation I've recently written for PHP 5.3:
>
>  https://github.com/BraveSirRobin/amqphp
>
> I've implemented the 0.9.1 Amqp spec using a code-generation approach.  If
> any of the more experienced Amqp people were able to take a quick look at my
> code in order to provide feedback, or have any other advice I'd be very
> grateful.  There's a UML class diagram showing the implementation classes
> here: https://github.com/BraveSirRobin/amqphp/raw/master/diag/amqp.png
>
> Secondly, I have a question regarding using basic.consume on multiple
> channels.  Is it possible for message frames to be mixed up for
> basic.consume?  Section 4.2.6 of the spec says this:
>
> *Content frames on a specific channel are strictly sequential. That is,
> they may be mixed with frames for*
> *other channels, but no two content frames from the same channel may be
> mixed or overlapped, nor may*
> *content frames for a single content be mixed with method frames on the
> same channel.*
>
> What I find confusing is that a single "message" consists of a frame
> header, a content header and one or more content frames, for large messages
> there can be many content frames; a single message contains many frames.
>  For example, is it possible to get a content header frame on channel A,
> then a content header frame on channel B, then the message content for
> channel A, then the message content for channel B?  The testing I've done so
> far indicates that RMQ always sends basic.deliver messages sequentially - it
> sends the content header then all content frames for a single message on a
> single channel in a non-interleaved fashion.  Is this always the case?  Is
> this what the spec guarantees?
>
>
> Many thanks,
> --Robin
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110111/9ffe87d9/attachment-0001.htm>

From jon.rowland at isam.com  Tue Jan 11 17:39:05 2011
From: jon.rowland at isam.com (Jon Rowland)
Date: Tue, 11 Jan 2011 11:39:05 -0600
Subject: [rabbitmq-discuss] Erlang version for Rabbit MQ 2.2.0 on Redhat
	Enterprise 5.5
Message-ID: <985477893245CF449ABD4F01814A9FF65F3C534234@34093-MBX-C06.mex07a.mlsrvr.com>

Hi all,

I'm looking to install rabbitmq server onto a production machine, and am a little confused as to the erlang dependencies. I see that version R12-B3 is mentioned in one place, and R13-B5 in another (admittedly Windows which could be different).

We will be installing version 2.2.0 from RPM on a RedHat Enterprise 5.5 server. Following the yum/EPEL route gives me the erlang version R12-B5.

Could anyone please clarify if this combination is suitable?

Many thanks,
Jon Rowland

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110111/6863dbd7/attachment.htm>

From simon at rabbitmq.com  Tue Jan 11 18:28:00 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Tue, 11 Jan 2011 18:28:00 +0000
Subject: [rabbitmq-discuss] Erlang version for Rabbit MQ 2.2.0 on Redhat
 Enterprise 5.5
In-Reply-To: <985477893245CF449ABD4F01814A9FF65F3C534234@34093-MBX-C06.mex07a.mlsrvr.com>
References: <985477893245CF449ABD4F01814A9FF65F3C534234@34093-MBX-C06.mex07a.mlsrvr.com>
Message-ID: <4D2CA130.3030003@rabbitmq.com>

On 11/01/11 17:39, Jon Rowland wrote:
> I'm looking to install rabbitmq server onto a production machine, and am
> a little confused as to the erlang dependencies. I see that version
> R12-B3 is mentioned in one place, and R13-B5 in another (admittedly
> Windows which could be different).

I don't see a reference to R13-B5 anywhere, but yes, we do end up 
mentioning a lot of versions.

We support back to R12-B3, but we tend to only test that on Unix since 
the main reason to run an old Erlang is "it comes with Red Hat / Debian".

> We will be installing version 2.2.0 from RPM on a RedHat Enterprise 5.5
> server. Following the yum/EPEL route gives me the erlang version R12-B5.
>
> Could anyone please clarify if this combination is suitable?

That will work. However:

* SSL support is quite unreliable
* Performance of garbage collection is not as good
* Many plugins will not work

Whether to go down the route of trying to get a more modern Erlang 
depends on how you feel about these things versus how you feel about 
using the official packages.

If you decide you do need a newer Erlang, I've heard that RPM users have 
had success with the following procedure:

* Open the SRPM
* Replace the R12-B5 tarball with the latest version
* Replace various references to the version in the spec file
* Repack the SRPM
* Build the RPM from the SRPM

This is likely to be less ugly than installing from source directly on a 
production server.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From jon.rowland at isam.com  Tue Jan 11 18:35:16 2011
From: jon.rowland at isam.com (Jon Rowland)
Date: Tue, 11 Jan 2011 12:35:16 -0600
Subject: [rabbitmq-discuss] Erlang version for Rabbit MQ 2.2.0 on Redhat
 Enterprise 5.5
In-Reply-To: <4D2CA130.3030003@rabbitmq.com>
References: <985477893245CF449ABD4F01814A9FF65F3C534234@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D2CA130.3030003@rabbitmq.com>
Message-ID: <985477893245CF449ABD4F01814A9FF65F3C534287@34093-MBX-C06.mex07a.mlsrvr.com>

Sorry, I meant R13-B3 (mentioned in the Windows section).

Thanks for the info.

Jon

-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Simon MacMullen
Sent: 11 January 2011 18:28
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Erlang version for Rabbit MQ 2.2.0 on Redhat Enterprise 5.5

On 11/01/11 17:39, Jon Rowland wrote:
> I'm looking to install rabbitmq server onto a production machine, and am
> a little confused as to the erlang dependencies. I see that version
> R12-B3 is mentioned in one place, and R13-B5 in another (admittedly
> Windows which could be different).

I don't see a reference to R13-B5 anywhere, but yes, we do end up 
mentioning a lot of versions.

We support back to R12-B3, but we tend to only test that on Unix since 
the main reason to run an old Erlang is "it comes with Red Hat / Debian".

> We will be installing version 2.2.0 from RPM on a RedHat Enterprise 5.5
> server. Following the yum/EPEL route gives me the erlang version R12-B5.
>
> Could anyone please clarify if this combination is suitable?

That will work. However:

* SSL support is quite unreliable
* Performance of garbage collection is not as good
* Many plugins will not work

Whether to go down the route of trying to get a more modern Erlang 
depends on how you feel about these things versus how you feel about 
using the official packages.

If you decide you do need a newer Erlang, I've heard that RPM users have 
had success with the following procedure:

* Open the SRPM
* Replace the R12-B5 tarball with the latest version
* Replace various references to the version in the spec file
* Repack the SRPM
* Build the RPM from the SRPM

This is likely to be less ugly than installing from source directly on a 
production server.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From ciprian.craciun at gmail.com  Tue Jan 11 18:48:02 2011
From: ciprian.craciun at gmail.com (Ciprian Dorin Craciun)
Date: Tue, 11 Jan 2011 20:48:02 +0200
Subject: [rabbitmq-discuss] Strange RabbitMQ management plugin error!
In-Reply-To: <4D2C321B.8040100@rabbitmq.com>
References: <AANLkTi=WAUNMnCK5WyTZFYMHXBJMZ8C_Vz6sHyJy77Wf@mail.gmail.com>
	<AANLkTim8pSf6r+o=i0tTWXEumU2faJnh3N=wfExWRR3C@mail.gmail.com>
	<4D2C321B.8040100@rabbitmq.com>
Message-ID: <AANLkTi=AqzaHFpHZmVnVhuxU+kQr=i7-2r4QUb+4MfOg@mail.gmail.com>

On Tue, Jan 11, 2011 at 12:34, Simon MacMullen <simon at rabbitmq.com> wrote:
> On 10/01/11 22:30, Ciprian Dorin Craciun wrote:
>>
>> ? ? Hello all!
>
> Hi Ciprian.
>
>> ? ?I've installed the management plugin (and it's dependencies), and
>> when accessing it I get the following error on almost all pages and I
>> don't see any counters... (But it seems to work otherwise as I can see
>> and manipulate other entities: queues, exchanges, etc.)
>>
>> ~~~~
>> TypeError: overview.queue_totals is undefined
>> ~~~~
>
> Thanks for explaining the unusual way you're starting RabbitMQ. That is
> likely to be the problem.

    It seems that indeed this is the problem...


> The management plugin uses a feature (fine grained statistics) that it needs
> to turn on in the main rabbit application. It sounds like this is not
> happening. This is controlled via a couple of application configuration
> parameters. Normally they default to turning this on, and the management
> plugin should detect if that's switched off and adjust the interface (and
> display warnings) accordingly, but that might not be happening for you.

    I don't see any errors displayed from the management plugin. It
just says that it started the web server, serving the usual URL.
    I've also tried to set both the `force_fine_statistics` and
`collect_statistics` but they don't seem to have any effect.


> What does your config file look like?

~~~~
[
	{sasl, [
		{errlog_type, error}]},
	{os_mon, [
		{start_cpu_sup, true},
		{start_memsup, true},
		{start_disksup, true},
		{start_os_sup, false}]},
	{mnesia, [
		{dir, "/tmp/rabbit.db"}]},
	{rabbit, [
		{tcp_listeners, [{"127.0.0.1", 5672}]},
		{collect_statistics, fine}]},
	{rabbit_management_agent, [
		{force_fine_statistics, true}]},
	{rabbit_mochiweb, [
		{port, 55672}]},
	{rabbit_management, [
		{http_log_dir, none}]}
].
~~~~

    And this is how I've started the whole thing up -- not by using
the boot script:

~~~~
erl -env ERL_LIBS /tmp/rabbit.lib -config /tmp/rabbit.config -run run_rabbit run
~~~~

-module (run_rabbit).

-export ([run/0]).

run () ->
	
	ok = application:start (sasl, permanent),
	ok = application:start (os_mon, permanent),
	ok = application:start (mnesia, permanent),
	
	if
		true ->
			ok = application:start (inets, permanent),
			ok = application:start (crypto, permanent),
			ok = application:start (mochiweb, permanent),
			ok = application:start (rabbit_mochiweb, permanent);
		true -> ok
	end,
	
	ok = rabbit:prepare (),
	ok = application:start (rabbit, permanent),
	ok = application:start (amqp_client, permanent),
	
	if
		true ->
			ok = application:start (rabbit_management_agent, permanent),
			ok = application:start (webmachine, permanent),
			ok = application:start (rabbit_management, permanent);
		true -> ok
	end,
	
	ok = timer:sleep (120 * 1000),
	
	ok = init:stop(),
	ok.
~~~~

    I've also tried to start with that module and the default RabbitMQ
installation and the same problem appears... So it's definitely a
configuration problem... But I'm not seeing where I'm wrong...


> Also, why have you done this? What problem is it solving?
>
> Cheers, Simon

    Good question. :) We'll I'm trying to "embed" RabbitMQ into
another Erlang application -- a web server that instead of handling
the requests it just puts them on a queue, and waits for the response
(the same pattern as in the rpc module is doing). I intend to use
`amqp_client` in with the `direct` connector. I've seen that there is
a similar project but for SMTP -- `rabbitmq-smtp`.

    Thanks for your time,
    Ciprian.

From jerryk at vmware.com  Tue Jan 11 21:25:28 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Tue, 11 Jan 2011 13:25:28 -0800
Subject: [rabbitmq-discuss] Performance question - java
In-Reply-To: <68500D9F-43A2-44A9-B7D2-A5512F773E2C@whatevernot.com>
References: <68500D9F-43A2-44A9-B7D2-A5512F773E2C@whatevernot.com>
Message-ID: <B36C5355-7CE1-476E-B801-1E73FA88D435@vmware.com>

Hi, Brian...

> I'm evaluating AMQP for use with both Java and C++, and have a question related to the Java library - does it share/pool connections?

That depends what you mean.  The Connection class that is exposed to the Java client wraps a TCP connection and runs a Java thread to handle AMQP related activity on the behalf of your client code and the broker on the other side of the connection.

> I am working on a distributed system, and currently we create an HTTP connection, send a message to a server (host/port) and then tear down the connection - there is a slight overhead to this, but likely not affecting our overall throughput, but ideally, we would like to have the connection open for the send, to avoid the cost of constructing the connection for every message.
> 
> So, asking wrt Rabbit - if I send a bunch of messages, is there a connection creation cost for each one?

Nope.  You create a connection, and then from the connection you create one or more channels.  Channels in Rabbit and AMQP effectively let you multiplex the expensive TCP connection.  You can have one or more channels associated with a given connection, and they can publish, receive, ack, etc. independently of one another as long as some basic thread safety practices are observed.  You can keep a connection and its channels open in your client for long sessions if you like, potentially handling many messages over its lifetime.

There's a summary of the relationships of these entities, and some Java sample code here:

http://www.rabbitmq.com/api-guide.html#connecting

The samples are usually straightforward to adapt to the client libraries for other languages.

> Any help here is appreciated - I'm spending some time looking at performance, as throughput for us is extremely important.

The documentation on the Rabbit website, and the new Rabbit tutorials...

http://www.rabbitmq.com/documentation.html

http://www.rabbitmq.com/getstarted.html

might be of interest to you.  Also, if you're already looking at the Java client, it comes with many samples you can experiment with and use as inspiration.  Its unit tests can also be instructive to look at.

Best regards,
Jerry


From jerryk at vmware.com  Tue Jan 11 21:39:54 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Tue, 11 Jan 2011 13:39:54 -0800
Subject: [rabbitmq-discuss] RabbitMQ JavaAPI Queueing Consumer
In-Reply-To: <4D2B2F8C.5000306@gmail.com>
References: <4D2B2F8C.5000306@gmail.com>
Message-ID: <330CB210-9164-4DBA-B37E-A052C003DA52@vmware.com>

Hi, Abhishek...

> I want to pass the message to a Separate Java Runnable Class (I am using Java ThreadPool Executors).
> So I want to know how can the separate thread acknowledge the message.
> I believe the message gets re-enqueued once the channel is closed.

The main thing to keep in mind is that you must avoid sharing channel instances between threads, or, if multiple threads are going to use a particular channel, then you need to handle mutual exclusion of access to that channel in your own code.  

One plausible design for your scenario would be the following.  When you pass a "unit of work" object off to your Executor, have it include a reference to the channel on which you need to ack the message once your work with its contents concludes.  Make sure that you add synchronization to ensure that you have exclusive access to that channel when you make calls on it to ack, etc.

> Also how can I handle channel closing down or going stale (due to reasons like network outage)   in the above scenario.

If the channel has closed when your executor thread comes to try to work on it, an exception should be thrown when you try to ack (or do pretty much anything else).  

In this case you've got a situation where a message has been sent to you, and received by you, and you've done the work it entailed, but not acknowledged back to Rabbit that your'e done with it.  

Since you haven't managed to transmit an ack back, as far as Rabbit knows this message is still in play and should be requeued.  

The easiest way to take care of this is for your application to be as idempotent as possible in the case where a requeued work-requiring messaging comes in for a second time.

You'll need to do this in any event, since, in addition to a channel or connection going down, your own code could have crashed after doing its work but before sending an ack to let Rabbit to know that it no longer has to worry about your message. 

Best regards,
Jerry


From moseley at hank.org  Wed Jan 12 03:57:19 2011
From: moseley at hank.org (Bill Moseley)
Date: Tue, 11 Jan 2011 19:57:19 -0800
Subject: [rabbitmq-discuss] HA between data centers
Message-ID: <AANLkTi=s2=M-V_aH-QpMU8Me3fsHBXcbxnTx0O_ZdhSe@mail.gmail.com>

The High Availablity docs at http://www.rabbitmq.com/pacemaker.html seem
pretty thorough.  Are there any other approaches commonly used for HA? What
about for syncing between data centers? Can anyone discuss their HA approach
if it differs from the link above?

We are evaluating messaging systems and the question of HA has come up
frequently.  The concern is that some items, once entered onto the queue,
should never be lost -- even if the entire data center goes down.

We are comparing RabbitMQ with writing a system in-house.  The in-house
queue system would use a Postgresql table for the queue with replication
(currently via Slony) for hot-backup (it's not really HA).  We also
replicate to a secondary data center with the eventual goal of reasonably
fast tip-over between data centers.  We are not in the financial or medical
industry so nobody's life is at risk if we drop a few jobs.  I suspect we
only need to handle three to five million message a day -- nothing too big.
 (Oddly, one argument against using RabbitMQ was it was overkill for our
needs.)

Postgresql and replication is what we use for application data currently, so
it is a familiar technology for us.  Another reason we are considering
building a custom message queue system is to put more functionality into the
broker -- such as scheduling and job routing that would be specific to our
business.  And there's fear that nobody knows Erlang if something broke and
we needed to try and resolve.

My opinion is AMQP is very flexible and we should be able to make it meet
our needs.  We are not doing anything that unusual.  And I suspect building
something as reliable as RabbitMQ is no easy task -- especially if the point
is to make a system more complex than what RabbitMQ provides.  Scheduling,
for example, seems like something a simple database table and cron could
solve easily with RabbitMQ.

Another argument for a custom broker was to make better use of workers --
i.e. the broker would look at load and other factors when determining where
to send jobs.  My feeling here is resources are limited so it's a matter of
balancing the number and type of consumers with queue load -- and an
external process can manage starting and stopping consumers easily as demand
profile changes (by looking at queue sizes and rates) without having to be
part of the broker.  Are there common approaches for dynamically adjusting
workers?

Anyone go through this kind of discussion in your own organization?

Thanks,

-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110111/4f794bf5/attachment.htm>

From taylste at gmail.com  Wed Jan 12 06:37:01 2011
From: taylste at gmail.com (Steven Taylor)
Date: Wed, 12 Jan 2011 06:37:01 +0000
Subject: [rabbitmq-discuss] Implementing a "processing" queue with
	message expiry
In-Reply-To: <4D2C757F.2070102@cpicorp.com>
References: <AANLkTikRt91x_VFa1aXqzvMeX1hLE9nDAaA6BHe226Ur@mail.gmail.com>
	<4D2C757F.2070102@cpicorp.com>
Message-ID: <AANLkTimdxj6ZH5O=5qMirVcL2Oa+5NZCkpKBq4EuNeAK@mail.gmail.com>

 Often, a bit like threading, things can get split off, but later reconverge
/ reconvene / rejoin the same execution stream (e.g. do the resutls end up
in a database / are they sent to the same end client)

"idempotent" as mentioned is a very useful solution (i.e. the job could get
done twice, but results/persistent state will look the same). You could
implement that as reject 2nd duplicated worker results, or copy it in again,
it doesn't matter. Assuming subsystems underneath the worker are transaction
based (in the database sense), you can ensure nothing gets inconsistent.

It took me a a few days to get comfortable with the "idempotent" idea, but
now I think I can work that idea into most situations.  The resulting code
while not materially that different appears to me to be more complete, and
thinking through an additional edge case, once you get used to it, in my
opinion adds value and doesn't get in the way of the development process.

-Steven
On 11 January 2011 15:21, Derek Chen-Becker <dbecker at cpicorp.com> wrote:

> On 01/10/2011 06:15 PM, Sami Samhuri wrote:
> > Hi all,
> >
> > I'm designing a small distributed system with some queueing involved and
> > have some doubts that Rabbit is the right solution for parts of it.
> > Hoping that some of you can shed some light and let me know if Rabbit
> > can do it all, which would be great, or if there's a better and/or
> > simpler solution I've missed. I realize that Rabbit is for message
> > passing and is not a work queue, so perhaps I'm trying to shove a square
> > peg into a round hole. If so please tell me that I'm barking up the
> > wrong tree.
>
> We use RabbitMQ for a render farm work queue and the way you deal with
> possible "lost" consumers is with ACKs. You need to turn off auto-ack
> when you set up the consumer, and then after you process the message you
> explicitly ACK it (BasicAck). If, for some reason, your client dies
> while in the middle of processing messages, any unacked messages it was
> holding on to get re-inserted into the queue.
>
> Derek
>  _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110112/222d1f37/attachment.htm>

From sumit1234 at gmail.com  Wed Jan 12 07:42:19 2011
From: sumit1234 at gmail.com (Sumit Arora)
Date: Wed, 12 Jan 2011 16:42:19 +0900
Subject: [rabbitmq-discuss] Load Balancing among Producers (devices) and
 Messaging Server ( Apache Qpid or RabbitMQ )
Message-ID: <AANLkTimfkOubf8PsQAE-+X_Jnt3Ayn+=pFysgSnBLCaK@mail.gmail.com>

Recently I started working on a project which require to implement Messaging
and viable options are :  Apache Qpid or RabbitMq , My Task is like this :

 +A+ >>.[Millions Devices (Producers) -- Connected to -- Messaging Server
(Clustered -- Qpid or RabbitMQ) ]   { LOAD BALANCING)

 And then

 +B+ >>.[Messaging Server (Clustered -- Qpid or RabbitMQ) -- Connected to --
GateWay Server (Clustered) ]

 And then

 +C+ >>.[GateWay Server (Clustered) -- Connected to -- Internet
Explorers/Browsers (Consumers) ]


See +A+ >>-- I need to use messaging usually for Load Balancing , and then
later *Gateway Server* relay the produced data to Consumers (Browsers)

Means several queues are created inside Broker, by using some Load Balancing
Algorithms. Producers ( Device Client) -- Send Message's Data to a specific
queue, Delivery to a queue based on either Round Robin, or with other common
Load Balancing Algos, Possibly it require Ack as well for guaranteed
delivery, and then Consumers Picks the Messages from Queues and relayed
further, All pretty standard stuff.

I studied basics of AMQP, and executed basic examples of both Qpid and
RabbitMQ and then here are my questions :


-- >> Is there a way , or some experiments or anything which can provide
some thing to choose either RabbitMQ or Apache Qpid ?

-- >> Is there any one who have ever worked on more or less similar
requirement ? and he/she can provide any comments about it ? or some
pointers before actually Implementing the algo , Implementation of Producers
and Consumers ?

-- >> My Overall requirement is related with Load Balancing, as my project
expects millions of devices connected to Messaging server -- later Messaging
data to be relayed and major confusion at this time to Select Apache Qpid or
RabbitMQ, and to me both looks same

/Sumit
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110112/6d7f64a9/attachment.htm>

From gustavo.bouzas at gmail.com  Wed Jan 12 00:07:42 2011
From: gustavo.bouzas at gmail.com (gus27)
Date: Tue, 11 Jan 2011 16:07:42 -0800 (PST)
Subject: [rabbitmq-discuss] RabbitMQ 2.0 broker crashes
In-Reply-To: <20101221201156.GA16081@wellquite.org>
Message-ID: <31233523.155.1294790862047.JavaMail.geo-discussion-forums@vbrk36>

Hi Matthew,

We are using RabbitMQ 2.2.0 on Windows 2008 Server (64-bits) with Erlang 
R13B03.

Today our broker crashed with the following error:
"Kernel pid terminated (application controller) 
({application_terminated,rabbit,shutdown})"

The broker's log file shows the following annotations at the time of the 
crash:

=ERROR REPORT==== 11-Jan-2011::11:41:41 ===
** Generic server <0.178.0> terminating
** Last message in was {'$gen_cast',{delete,9}}
** When Server state == {state,
                            {dict,0,16,16,8,80,48,
                               
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {gc_state,
                               
 "c:/Users/Administrator/AppData/Roaming/RabbitMQ/db/rabbit at WIN-BQANP1S30VP-mnesia/msg_store_persistent",
                                rabbit_msg_store_ets_index,
                                {state,159801,
                                   
 "c:/Users/Administrator/AppData/Roaming/RabbitMQ/db/rabbit at WIN-BQANP1S30VP-mnesia/msg_store_persistent"},
                                155704,<0.172.0>}}
** Reason for termination == 
** {{badmatch,{error,eacces}},
    [{rabbit_msg_store,delete_file,2},
     {rabbit_msg_store_gc,attempt_action,3},
     {rabbit_msg_store_gc,handle_cast,2},
     {gen_server2,handle_msg,2},
     {proc_lib,wake_up,3}]}

At the time of the crash, one of our modules was quickly consuming 50.000 
messages aprox from one of the broker's queues. Does this mean we are 
experimenting the same problem reported above?

(We have the "erl_crash.dump" file available, in case it helps to determine 
the cause of the crash).

Thanks in advance for your help.

Best regards,
- Gustavo.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110111/c34559f5/attachment-0001.htm>

From matthew at rabbitmq.com  Wed Jan 12 11:32:20 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Wed, 12 Jan 2011 11:32:20 +0000
Subject: [rabbitmq-discuss] RabbitMQ 2.0 broker crashes
In-Reply-To: <31233523.155.1294790862047.JavaMail.geo-discussion-forums@vbrk36>
References: <20101221201156.GA16081@wellquite.org>
	<31233523.155.1294790862047.JavaMail.geo-discussion-forums@vbrk36>
Message-ID: <20110112113218.GA18402@rabbitmq.com>

Hi Gustavo,

On Tue, Jan 11, 2011 at 04:07:42PM -0800, gus27 wrote:
> Today our broker crashed with the following error:
> ** Reason for termination == 
> ** {{badmatch,{error,eacces}},
>     [{rabbit_msg_store,delete_file,2},
>      {rabbit_msg_store_gc,attempt_action,3},
>      {rabbit_msg_store_gc,handle_cast,2},
>      {gen_server2,handle_msg,2},
>      {proc_lib,wake_up,3}]}
> 
> At the time of the crash, one of our modules was quickly consuming 50.000 
> messages aprox from one of the broker's queues. Does this mean we are 
> experimenting the same problem reported above?

Yes, it's the same problem. We have worked out how to solve it, but the
work is yet to be done. Given the number of people this is currently
affecting, I would hope this will get fixed fairly promptly now we're
all back from Christmas and we've worked out how to solve it. Especially
seeing as the only real work around at the moment is to not use Windows.

Matthew

From gustavo.bouzas at gmail.com  Wed Jan 12 13:38:33 2011
From: gustavo.bouzas at gmail.com (gus27)
Date: Wed, 12 Jan 2011 05:38:33 -0800 (PST)
Subject: [rabbitmq-discuss] RabbitMQ 2.0 broker crashes
In-Reply-To: <20110112113218.GA18402@rabbitmq.com>
Message-ID: <11156081.394.1294839513743.JavaMail.geo-discussion-forums@vbyc22>

Hi Matthew,

Thank you for your prompt reply. Those are very good news. We'll be looking 
forward to trying the new release as soon as it's available.

Best regards,
- Gustavo.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110112/121bdd9d/attachment.htm>

From simon at rabbitmq.com  Wed Jan 12 15:21:00 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Wed, 12 Jan 2011 15:21:00 +0000
Subject: [rabbitmq-discuss] Strange RabbitMQ management plugin error!
In-Reply-To: <AANLkTi=AqzaHFpHZmVnVhuxU+kQr=i7-2r4QUb+4MfOg@mail.gmail.com>
References: <AANLkTi=WAUNMnCK5WyTZFYMHXBJMZ8C_Vz6sHyJy77Wf@mail.gmail.com>	<AANLkTim8pSf6r+o=i0tTWXEumU2faJnh3N=wfExWRR3C@mail.gmail.com>	<4D2C321B.8040100@rabbitmq.com>
	<AANLkTi=AqzaHFpHZmVnVhuxU+kQr=i7-2r4QUb+4MfOg@mail.gmail.com>
Message-ID: <4D2DC6DC.3090008@rabbitmq.com>

On 11/01/11 18:48, Ciprian Dorin Craciun wrote:
>      I don't see any errors displayed from the management plugin. It
> just says that it started the web server, serving the usual URL.
>      I've also tried to set both the `force_fine_statistics` and
> `collect_statistics` but they don't seem to have any effect.

I had a play with your run_rabbit script and I found the problem.

RabbitMQ has the concept of a boot step - part of the startup process of 
the rabbit application. These are the things like

"starting xyz                                          ...done"

that appear on stdout during startup.

Some plugins, including rabbit_management_agent need to insert boot 
steps into the rabbit app (as well as being their own apps). 
rabbit_management_agent does this in order to collect the statistics 
it's asked for.

The way this works is that when rabbit starts up it looks for boot steps 
in all *loaded* applications. Our boot script loads all applications, 
then starts them. So you need to as well:

~~~~
-module (run_rabbit).

-export ([run/0]).

run () ->
     Apps1 = [sasl, os_mon, mnesia, inets, crypto, mochiweb,
              rabbit_mochiweb],
     Apps2 = [rabbit, amqp_client, rabbit_management_agent, webmachine,
              rabbit_management],

     [ok = application:load(A) || A <- Apps1 ++ Apps2],

     [ok = application:start(A, permanent) || A <- Apps1],
     ok = rabbit:prepare(),
     [ok = application:start(A, permanent) || A <- Apps2],

     ok = timer:sleep(120 * 1000),
     ok = init:stop(),
     ok.
~~~~

>> Also, why have you done this? What problem is it solving?
>>
>> Cheers, Simon
>
>      Good question. :) We'll I'm trying to "embed" RabbitMQ into
> another Erlang application -- a web server that instead of handling
> the requests it just puts them on a queue, and waits for the response
> (the same pattern as in the rpc module is doing). I intend to use
> `amqp_client` in with the `direct` connector. I've seen that there is
> a similar project but for SMTP -- `rabbitmq-smtp`.

I think rabbitmq-smtp is just a regular plugin. You might want to 
consider doing the same thing - turning things inside out so that your 
web server is running as a RabbitMQ plugin. This is more or less exactly 
what the management plugin does.

Or you can continue on your current path, but the extent to which we 
don't support running RabbitMQ this way is quite high :)

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From dbecker at cpicorp.com  Wed Jan 12 16:22:42 2011
From: dbecker at cpicorp.com (Derek Chen-Becker)
Date: Wed, 12 Jan 2011 10:22:42 -0600
Subject: [rabbitmq-discuss] Implementing a "processing" queue
 with	message expiry
In-Reply-To: <AANLkTimdxj6ZH5O=5qMirVcL2Oa+5NZCkpKBq4EuNeAK@mail.gmail.com>
References: <AANLkTikRt91x_VFa1aXqzvMeX1hLE9nDAaA6BHe226Ur@mail.gmail.com>	<4D2C757F.2070102@cpicorp.com>
	<AANLkTimdxj6ZH5O=5qMirVcL2Oa+5NZCkpKBq4EuNeAK@mail.gmail.com>
Message-ID: <4D2DD552.4050700@cpicorp.com>

On 01/12/2011 12:37 AM, Steven Taylor wrote:
> Often, a bit like threading, things can get split off, but later
> reconverge / reconvene / rejoin the same execution stream (e.g. do the
> resutls end up in a database / are they sent to the same end client)
>  
> "idempotent" as mentioned is a very useful solution (i.e. the job could
> get done twice, but results/persistent state will look the same). You
> could implement that as reject 2nd duplicated worker results, or copy it
> in again, it doesn't matter. Assuming subsystems underneath the worker
> are transaction based (in the database sense), you can ensure nothing
> gets inconsistent. 

I agree. In our case we have a workflow that actually manages the state
of the overall process. A given job may get executed more than once due
to some pathological condition, but the workflow acts as a master
controller to make sure that once a job has been marked as done, further
notifications of job completion just get ignored.

Derek

From ciprian.craciun at gmail.com  Wed Jan 12 17:21:43 2011
From: ciprian.craciun at gmail.com (Ciprian Dorin Craciun)
Date: Wed, 12 Jan 2011 19:21:43 +0200
Subject: [rabbitmq-discuss] Strange RabbitMQ management plugin error!
In-Reply-To: <4D2DC6DC.3090008@rabbitmq.com>
References: <AANLkTi=WAUNMnCK5WyTZFYMHXBJMZ8C_Vz6sHyJy77Wf@mail.gmail.com>
	<AANLkTim8pSf6r+o=i0tTWXEumU2faJnh3N=wfExWRR3C@mail.gmail.com>
	<4D2C321B.8040100@rabbitmq.com>
	<AANLkTi=AqzaHFpHZmVnVhuxU+kQr=i7-2r4QUb+4MfOg@mail.gmail.com>
	<4D2DC6DC.3090008@rabbitmq.com>
Message-ID: <AANLkTimCOJvetLnLD6kdFyTttcSFnpu2TzRm0dZady41@mail.gmail.com>

On Wed, Jan 12, 2011 at 17:21, Simon MacMullen <simon at rabbitmq.com> wrote:
> On 11/01/11 18:48, Ciprian Dorin Craciun wrote:
>>
>> ? ? I don't see any errors displayed from the management plugin. It
>> just says that it started the web server, serving the usual URL.
>> ? ? I've also tried to set both the `force_fine_statistics` and
>> `collect_statistics` but they don't seem to have any effect.
>
> I had a play with your run_rabbit script and I found the problem.

    Thank you for your time and effort!


> RabbitMQ has the concept of a boot step - part of the startup process of the
> rabbit application. These are the things like
>
> "starting xyz ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?...done"
>
> that appear on stdout during startup.

    I've seen these boot steps -- both in `rabbit.erl` and in
`rabbit.script`, and I've tried to mirror them (this is how I've got
the `application:run(...)` order), but -- as I'm not that accustomed
with the OTP environment -- I thought that I don't need to explicitly
load the application before starting any of them... So it seems that
this was a very bad assumption. :)


> Some plugins, including rabbit_management_agent need to insert boot steps
> into the rabbit app (as well as being their own apps).
> rabbit_management_agent does this in order to collect the statistics it's
> asked for.
>
> The way this works is that when rabbit starts up it looks for boot steps in
> all *loaded* applications. Our boot script loads all applications, then
> starts them. So you need to as well:

    Aha. Got it now.


> ~~~~
> -module (run_rabbit).
>
> -export ([run/0]).
>
> run () ->
> ? ?Apps1 = [sasl, os_mon, mnesia, inets, crypto, mochiweb,
> ? ? ? ? ? ? rabbit_mochiweb],
> ? ?Apps2 = [rabbit, amqp_client, rabbit_management_agent, webmachine,
> ? ? ? ? ? ? rabbit_management],
>
> ? ?[ok = application:load(A) || A <- Apps1 ++ Apps2],
>
> ? ?[ok = application:start(A, permanent) || A <- Apps1],
> ? ?ok = rabbit:prepare(),
> ? ?[ok = application:start(A, permanent) || A <- Apps2],
>
> ? ?ok = timer:sleep(120 * 1000),
> ? ?ok = init:stop(),
> ? ?ok.
> ~~~~

    Works perfectly. :)


>>> Also, why have you done this? What problem is it solving?
>>>
>>> Cheers, Simon
>>
>> ? ? Good question. :) We'll I'm trying to "embed" RabbitMQ into
>> another Erlang application -- a web server that instead of handling
>> the requests it just puts them on a queue, and waits for the response
>> (the same pattern as in the rpc module is doing). I intend to use
>> `amqp_client` in with the `direct` connector. I've seen that there is
>> a similar project but for SMTP -- `rabbitmq-smtp`.
>
> I think rabbitmq-smtp is just a regular plugin. You might want to consider
> doing the same thing - turning things inside out so that your web server is
> running as a RabbitMQ plugin. This is more or less exactly what the
> management plugin does.

    Yes, I've though about this possibility of writing an RabbitMQ
plugin. In fact from my development point of view not much should
change, except maybe only the way I bootstrap the whole application.

    But when I decided to "embed" RabbitMQ into my web server (which
is actually one of either Misultin, Mochiweb or inets, I've not
decided yet), I planed that in the end, the web server shall use a
dedicated RabbitMQ instance, but for testing and quick deployment
purposes, I've decided to also (optionally) provide an embed RabbitMQ
instance.


> Or you can continue on your current path, but the extent to which we don't
> support running RabbitMQ this way is quite high :)
>
> Cheers, Simon

    I'm perfectly aware that the way I'm doing things right now,
incurs the risk of not being able to one day upgrade to a later
RabbitMQ which breaks this startup style. But embedding RabbitMQ is
too tenting right now. :)

    So once again thank you for taking time to help me!

    Ciprian.


    P.S.: I promise I'll return the favor by releasing the code of the
HTTP gateway -- maybe also as a RabbitMQ plugin. (It's part of an
European funded research project ( www.mosaic-cloud.eu ), and RabbitMQ
has a central role in the whole thing. :) )

From pascaldergane at gmail.com  Wed Jan 12 18:01:03 2011
From: pascaldergane at gmail.com (pascaldergane at gmail.com)
Date: Wed, 12 Jan 2011 19:01:03 +0100
Subject: [rabbitmq-discuss] Compatibily between rabbitmq client 2.2.0 and 1.8
Message-ID: <BD5AD068-94DF-4383-AF9C-BAA0377FBDE3@gmail.com>

Hi 
Could you confirm That of a java rabbitmq 2.2.0 client as producer could send message to a rabbitmq 1.8.1 java client consumer via rabbitmq 2.2.0 server?
Is There any restrictions?
Tanks

Envoy? de mon iPhone

From david at rabbitmq.com  Wed Jan 12 21:38:26 2011
From: david at rabbitmq.com (David Wragg)
Date: Wed, 12 Jan 2011 21:38:26 +0000
Subject: [rabbitmq-discuss] Compatibily between rabbitmq client 2.2.0
	and 1.8
In-Reply-To: <BD5AD068-94DF-4383-AF9C-BAA0377FBDE3@gmail.com>
	(pascaldergane@gmail.com's message of "Wed, 12 Jan 2011 19:01:03
	+0100")
References: <BD5AD068-94DF-4383-AF9C-BAA0377FBDE3@gmail.com>
Message-ID: <yrv4c39ox950t.fsf@dwragg.eng.vmware.com>

Hi Pascal,

"pascaldergane at gmail.com" <pascaldergane at gmail.com> writes:
> Could you confirm That of a java rabbitmq 2.2.0 client as producer
> could send message to a rabbitmq 1.8.1 java client consumer via
> rabbitmq 2.2.0 server?  Is There any restrictions?

This should work fine.  The 2.2.0 client will talk AMQP 0.9.1 to the
server, and the 1.8.1 client will talk AMQP 0.8 to the server, but the
exchange, queue, and message models used by the two protocol versions
are basically identical, and there should be no problems with the
clients interchanging messages.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From techabc at gmail.com  Thu Jan 13 03:51:49 2011
From: techabc at gmail.com (techabc)
Date: Thu, 13 Jan 2011 11:51:49 +0800
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
Message-ID: <AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>

It troubled me compile in msvc10, both failed:
1) dg1sbg:
I directly open the
D:\lib.rabbitmq\dg1sbg-librabbitmq-ffd6c00\windows\build\librabbitmq\librabbitmq.sln
file, after config the include dir, I  got a  missing file amqp_frame.h/.cpp
error;
2) rabbitmq-c-16e2faae8a2f :
My vc10 installed at D:\Program Files @ windows 7 32bit, so I got error can
NOT find the vc tool, then I modify the build script and specific the msvc
directory. Finally I got " checking location of AMQP codegen directory...
configure: error: could not find
AMQP spec file at "'codegen/amqp-rabbitmq-0.9.1.json'" in mingw shell:

see below details:


techabc at apple ~
$ cd /d/lib.rabbitmq/rabbitmq-c-16e2faae8a2f

techabc at apple /d/lib.rabbitmq/rabbitmq-c-16e2faae8a2f
$ etc/build.sh
Using Visual Studio install at /d/Program Files/Microsoft Visual Studio 10.0
Using Windows SDK install at /c/Program Files/Microsoft SDKs/Windows/v7.0A
+ autoreconf -i
D:\MinGW.MSYS\bin\libtoolize: putting auxiliary files in `.'.
D:\MinGW.MSYS\bin\libtoolize: copying file `./ltmain.sh'
D:\MinGW.MSYS\bin\libtoolize: Consider adding `AC_CONFIG_MACRO_DIR([m4])' to
con
figure.ac and
D:\MinGW.MSYS\bin\libtoolize: rerunning D:\MinGW.MSYS\bin\libtoolize, to
keep th
e correct libtool macros in-tree.
D:\MinGW.MSYS\bin\libtoolize: Consider adding `-I m4' to ACLOCAL_AMFLAGS in
Make
file.am.
configure.ac:12: installing `./config.guess'
configure.ac:12: installing `./config.sub'
configure.ac:3: installing `./install-sh'
configure.ac:3: installing `./missing'
examples/Makefile.am: installing `./depcomp'
+ ./configure CC=cl.exe LD=link.exe CFLAGS=-nologo
checking for a BSD-compatible install... /bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking for style of include used by make... GNU
checking for gcc... cl.exe
checking whether the C compiler works... yes
checking for C compiler default output file name... conftest.exe
checking for suffix of executables... .exe
checking whether we are cross compiling... no
checking for suffix of object files... obj
checking whether we are using the GNU C compiler... no
checking whether cl.exe accepts -g... yes
checking for cl.exe option to accept ISO C89... none needed
checking dependency style of cl.exe... none
checking how to run the C preprocessor... cl.exe -E
checking for grep that handles long lines and -e... /bin/grep
checking for egrep... /bin/grep -E
checking for ANSI C header files... yes
checking for sys/types.h... yes
checking for sys/stat.h... yes
checking for stdlib.h... yes
checking for string.h... yes
checking for memory.h... yes
checking for strings.h... no
checking for inttypes.h... no
checking for stdint.h... yes
checking for unistd.h... no
checking minix/config.h usability... no
checking minix/config.h presence... no
checking for minix/config.h... no
checking whether it is safe to define __EXTENSIONS__... yes
checking for gcc... (cached) cl.exe
checking whether we are using the GNU C compiler... (cached) no
checking whether cl.exe accepts -g... (cached) yes
checking for cl.exe option to accept ISO C89... (cached) none needed
checking dependency style of cl.exe... (cached) none
checking build system type... i686-pc-mingw32
checking host system type... i686-pc-mingw32
checking for as... as
checking for dlltool... dlltool
checking for objdump... objdump
checking how to print strings... printf
checking for a sed that does not truncate output... /bin/sed
checking for fgrep... /bin/grep -F
checking for non-GNU ld... link.exe
checking if the linker (link.exe) is GNU ld... no
checking for BSD- or MS-compatible name lister (nm)... /mingw/bin/nm
checking the name lister (/mingw/bin/nm) interface... BSD nm
checking whether ln -s works... no, using cp -p
checking the maximum length of command line arguments... 8192
checking whether the shell understands some XSI constructs... yes
checking whether the shell understands "+="... yes
checking how to convert i686-pc-mingw32 file names to i686-pc-mingw32
format...
func_convert_file_msys_to_w32
checking how to convert i686-pc-mingw32 file names to toolchain format...
func_c
onvert_file_msys_to_w32
checking for link.exe option to reload object files... -r
checking for objdump... (cached) objdump
checking how to recognize dependent libraries... file_magic ^x86 archive
import|
^x86 DLL
checking for dlltool... (cached) dlltool
checking how to associate runtime and link libraries...
func_cygming_dll_for_imp
lib
checking for ar... ar
checking for archiver @FILE support... @
checking for strip... strip
checking for ranlib... ranlib
checking command to parse /mingw/bin/nm output from cl.exe object... ok
checking for sysroot... no
checking for mt... no
checking if : is a manifest tool... no
checking for dlfcn.h... no
checking for objdir... .libs
checking for cl.exe option to produce PIC... -DDLL_EXPORT -DPIC
checking if cl.exe PIC flag -DDLL_EXPORT -DPIC works... yes
checking if cl.exe static flag  works... yes
checking if cl.exe supports -c -o file.obj... no
checking if cl.exe supports -c -o file.obj... (cached) no
checking if we can lock with hard links... yes
checking whether the cl.exe linker (link.exe) supports shared libraries...
yes
checking dynamic linker characteristics... Win32 link.exe
checking how to hardcode library paths into programs... immediate
checking whether stripping libraries is possible... yes
checking if libtool supports shared libraries... yes
checking whether to build shared libraries... yes
checking whether to build static libraries... yes
checking for ANSI C header files... (cached) yes
checking for inline... __inline
checking location of AMQP codegen directory... configure: error: could not
find
AMQP spec file at "'codegen/amqp-rabbitmq-0.9.1.json'"

techabc at apple /d/lib.rabbitmq/rabbitmq-c-16e2faae8a2f
$


what should I do?

2011/1/11 David Wragg <david at rabbitmq.com>

> techabc <techabc at gmail.com> writes:
> > but NOT support m$ windows platform.
> > the *dg1sbg* branch (https://github.com/dg1sbg, include 2 entry, but
> what
> > the* difference*? ) seems can't keep the same step with rabbitmq-c.
>
> rabbitmq-c has supported building on Windows with the Microsoft compiler
> for a few months.  See the README.windows file for details.
>
> David
>
> --
> David Wragg
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/099d0dd0/attachment-0001.htm>

From 176047528 at qq.com  Thu Jan 13 04:14:12 2011
From: 176047528 at qq.com (=?ISO-8859-1?B?eWFvaHVp?=)
Date: Thu, 13 Jan 2011 12:14:12 +0800
Subject: [rabbitmq-discuss] |Spam| Re: Is there any mature C/C++ client for
Message-ID: <tencent_606F414D59FE784F716D3CA1@qq.com>

>2) rabbitmq-c-16e2faae8a2f :
>My vc10 installed at D:\Program Files @ windows 7 32bit, so I got error can
>NOT find the vc tool, then I modify the build script and specific the msvc
>directory. Finally I got " checking location of AMQP codegen directory...
>configure: error: could not find
>AMQP spec file at "'codegen/amqp-rabbitmq-0.9.1.json'" in mingw shell
  
 I have met this problem but i compiler in linux (redhat).  
 You'd better download rabbitmq-codegen from url
 http://hg.rabbitmq.com/rabbitmq-codegen/summary
 and unzip ,rename this directory  to codegen, put it in the dir rabbitmq-c, then compiler. 
  
 that's what i do, i hope that will help you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/e573af64/attachment.htm>

From techabc at gmail.com  Thu Jan 13 07:01:54 2011
From: techabc at gmail.com (techabc)
Date: Thu, 13 Jan 2011 15:01:54 +0800
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
	<AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
Message-ID: <AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>

according the official web, the lib is still EXPERIMENTAL, not MATURE!

I download codegen(http://hg.rabbitmq.com/rabbitmq-codegen<http://hg.rabbitmq.com/rabbitmq-codegen/summary>),
config well python and simplejson, but got error below:

PYTHONPATH=../codegen python ./codegen.py header
../codegen/amqp-rabbitmq-0.9.1.
json amqp_framing.h
Traceback (most recent call last):
  File "./codegen.py", line 636, in <module>
    do_main(generateHrl, generateErl)
  File "d:\lib.rabbitmq\rabbitmq-c-16e2faae8a2f\codegen\amqp_codegen.py",
line 2
63, in do_main
    do_main_dict({"header": header_fn, "body": body_fn})
  File "d:\lib.rabbitmq\rabbitmq-c-16e2faae8a2f\codegen\amqp_codegen.py",
line 2
98, in do_main_dict
    execute(funcDict[function], sources, dest)
  File "d:\lib.rabbitmq\rabbitmq-c-16e2faae8a2f\codegen\amqp_codegen.py",
line 2
79, in execute
    remove(out_file)
WindowsError: [Error 32] : 'amqp_framing.h'
make[2]: *** [amqp_framing.h] Error 1
make[2]: Leaving directory
`/d/lib.rabbitmq/rabbitmq-c-16e2faae8a2f/librabbitmq'

make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory `/d/lib.rabbitmq/rabbitmq-c-16e2faae8a2f'
make: *** [all] Error 2

2011/1/13 techabc <techabc at gmail.com>

> It troubled me compile in msvc10, both failed:
> 1) dg1sbg:
> I directly open the
> D:\lib.rabbitmq\dg1sbg-librabbitmq-ffd6c00\windows\build\librabbitmq\librabbitmq.sln
> file, after config the include dir, I  got a  missing file amqp_frame.h/.cpp
> error;
> 2) rabbitmq-c-16e2faae8a2f :
> My vc10 installed at D:\Program Files @ windows 7 32bit, so I got error can
> NOT find the vc tool, then I modify the build script and specific the msvc
> directory. Finally I got " checking location of AMQP codegen directory...
> configure: error: could not find
> AMQP spec file at "'codegen/amqp-rabbitmq-0.9.1.json'" in mingw shell:
>
> see below details:
>
>
> techabc at apple ~
> $ cd /d/lib.rabbitmq/rabbitmq-c-16e2faae8a2f
>
> techabc at apple /d/lib.rabbitmq/rabbitmq-c-16e2faae8a2f
> $ etc/build.sh
> Using Visual Studio install at /d/Program Files/Microsoft Visual Studio
> 10.0
> Using Windows SDK install at /c/Program Files/Microsoft SDKs/Windows/v7.0A
> + autoreconf -i
> D:\MinGW.MSYS\bin\libtoolize: putting auxiliary files in `.'.
> D:\MinGW.MSYS\bin\libtoolize: copying file `./ltmain.sh'
> D:\MinGW.MSYS\bin\libtoolize: Consider adding `AC_CONFIG_MACRO_DIR([m4])'
> to con
> figure.ac and
> D:\MinGW.MSYS\bin\libtoolize: rerunning D:\MinGW.MSYS\bin\libtoolize, to
> keep th
> e correct libtool macros in-tree.
> D:\MinGW.MSYS\bin\libtoolize: Consider adding `-I m4' to ACLOCAL_AMFLAGS in
> Make
> file.am.
> configure.ac:12: installing `./config.guess'
> configure.ac:12: installing `./config.sub'
> configure.ac:3: installing `./install-sh'
> configure.ac:3: installing `./missing'
> examples/Makefile.am: installing `./depcomp'
> + ./configure CC=cl.exe LD=link.exe CFLAGS=-nologo
> checking for a BSD-compatible install... /bin/install -c
> checking whether build environment is sane... yes
> checking for a thread-safe mkdir -p... /bin/mkdir -p
> checking for gawk... gawk
> checking whether make sets $(MAKE)... yes
> checking for style of include used by make... GNU
> checking for gcc... cl.exe
> checking whether the C compiler works... yes
> checking for C compiler default output file name... conftest.exe
> checking for suffix of executables... .exe
> checking whether we are cross compiling... no
> checking for suffix of object files... obj
> checking whether we are using the GNU C compiler... no
> checking whether cl.exe accepts -g... yes
> checking for cl.exe option to accept ISO C89... none needed
> checking dependency style of cl.exe... none
> checking how to run the C preprocessor... cl.exe -E
> checking for grep that handles long lines and -e... /bin/grep
> checking for egrep... /bin/grep -E
> checking for ANSI C header files... yes
> checking for sys/types.h... yes
> checking for sys/stat.h... yes
> checking for stdlib.h... yes
> checking for string.h... yes
> checking for memory.h... yes
> checking for strings.h... no
> checking for inttypes.h... no
> checking for stdint.h... yes
> checking for unistd.h... no
> checking minix/config.h usability... no
> checking minix/config.h presence... no
> checking for minix/config.h... no
> checking whether it is safe to define __EXTENSIONS__... yes
> checking for gcc... (cached) cl.exe
> checking whether we are using the GNU C compiler... (cached) no
> checking whether cl.exe accepts -g... (cached) yes
> checking for cl.exe option to accept ISO C89... (cached) none needed
> checking dependency style of cl.exe... (cached) none
> checking build system type... i686-pc-mingw32
> checking host system type... i686-pc-mingw32
> checking for as... as
> checking for dlltool... dlltool
> checking for objdump... objdump
> checking how to print strings... printf
> checking for a sed that does not truncate output... /bin/sed
> checking for fgrep... /bin/grep -F
> checking for non-GNU ld... link.exe
> checking if the linker (link.exe) is GNU ld... no
> checking for BSD- or MS-compatible name lister (nm)... /mingw/bin/nm
> checking the name lister (/mingw/bin/nm) interface... BSD nm
> checking whether ln -s works... no, using cp -p
> checking the maximum length of command line arguments... 8192
> checking whether the shell understands some XSI constructs... yes
> checking whether the shell understands "+="... yes
> checking how to convert i686-pc-mingw32 file names to i686-pc-mingw32
> format...
> func_convert_file_msys_to_w32
> checking how to convert i686-pc-mingw32 file names to toolchain format...
> func_c
> onvert_file_msys_to_w32
> checking for link.exe option to reload object files... -r
> checking for objdump... (cached) objdump
> checking how to recognize dependent libraries... file_magic ^x86 archive
> import|
> ^x86 DLL
> checking for dlltool... (cached) dlltool
> checking how to associate runtime and link libraries...
> func_cygming_dll_for_imp
> lib
> checking for ar... ar
> checking for archiver @FILE support... @
> checking for strip... strip
> checking for ranlib... ranlib
> checking command to parse /mingw/bin/nm output from cl.exe object... ok
> checking for sysroot... no
> checking for mt... no
> checking if : is a manifest tool... no
> checking for dlfcn.h... no
> checking for objdir... .libs
> checking for cl.exe option to produce PIC... -DDLL_EXPORT -DPIC
> checking if cl.exe PIC flag -DDLL_EXPORT -DPIC works... yes
> checking if cl.exe static flag  works... yes
> checking if cl.exe supports -c -o file.obj... no
> checking if cl.exe supports -c -o file.obj... (cached) no
> checking if we can lock with hard links... yes
> checking whether the cl.exe linker (link.exe) supports shared libraries...
> yes
> checking dynamic linker characteristics... Win32 link.exe
> checking how to hardcode library paths into programs... immediate
> checking whether stripping libraries is possible... yes
> checking if libtool supports shared libraries... yes
> checking whether to build shared libraries... yes
> checking whether to build static libraries... yes
> checking for ANSI C header files... (cached) yes
> checking for inline... __inline
> checking location of AMQP codegen directory... configure: error: could not
> find
> AMQP spec file at "'codegen/amqp-rabbitmq-0.9.1.json'"
>
> techabc at apple /d/lib.rabbitmq/rabbitmq-c-16e2faae8a2f
> $
>
>
> what should I do?
>
> 2011/1/11 David Wragg <david at rabbitmq.com>
>
>> techabc <techabc at gmail.com> writes:
>>
>> > but NOT support m$ windows platform.
>> > the *dg1sbg* branch (https://github.com/dg1sbg, include 2 entry, but
>> what
>> > the* difference*? ) seems can't keep the same step with rabbitmq-c.
>>
>> rabbitmq-c has supported building on Windows with the Microsoft compiler
>> for a few months.  See the README.windows file for details.
>>
>> David
>>
>> --
>> David Wragg
>> Staff Engineer, RabbitMQ
>> SpringSource, a division of VMware
>>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/b6d4a2e1/attachment.htm>

From ycombo at gmail.com  Thu Jan 13 07:07:57 2011
From: ycombo at gmail.com (=?GB2312?B?0qa/tbGm?=)
Date: Thu, 13 Jan 2011 02:07:57 -0500
Subject: [rabbitmq-discuss] followed the RabbitMQ tutorial, but meet an error
Message-ID: <AANLkTimh=ZZvJ6_XCBH7YnpCHeyKdR+hUmzkGhHAO2Tu@mail.gmail.com>

I am a RabbitMQ beginner. When I just followed the tutorial(
http://www.rabbitmq.com/tutorial-one-python.html) to install pika library
and run the send.py,
but got an exception as follow:

combo at combo-ubt:~$ python send.py
Traceback (most recent call last):
  File "send.py", line 6, in <module>
    channel = connection.channel()
  File "/usr/games/src/pika/pika/connection.py", line 385, in channel
    return channel.Channel(channel.ChannelHandler(self))
  File "/usr/games/src/pika/pika/channel.py", line 205, in __init__
    self.handler._rpc(spec.Channel.Open(), [spec.Channel.OpenOk])
  File "/usr/games/src/pika/pika/channel.py", line 187, in _rpc
    return self.connection._rpc(self.channel_number, method,
acceptable_replies)
  File "/usr/games/src/pika/pika/connection.py", line 324, in _rpc
    channel = self._ensure_channel(channel_number)
  File "/usr/games/src/pika/pika/connection.py", line 287, in
_ensure_channel
    raise ConnectionClosed(self.connection_close)
pika.exceptions.ConnectionClosed: Connection.Close(class_id = 0, method_id =
0, reply_code = 0, reply_text = 'Socket closed')

well ,I have no idea what's wrong with it.So,is there anybody who can tell
how to deal with it?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/6f106b5e/attachment-0001.htm>

From coolchen033 at gmail.com  Thu Jan 13 07:17:48 2011
From: coolchen033 at gmail.com (Kevin Chan)
Date: Thu, 13 Jan 2011 15:17:48 +0800
Subject: [rabbitmq-discuss] about msg_store_persistent folder
Message-ID: <AANLkTinkc22xi=8_6+e=M+H1rBaCkywS5XYZw_w94h7z@mail.gmail.com>

Hi Everyone

  I send msg to rabbbitmq server ,on the server,the folder(
/var/lib/rabbitmq/mnesia/rabbit at localhost/msg_store_transient) size will
became bigger and bigger.how to deal with

it. may i del this folder's file when rabbitmq server running,or is there
any way to limmit the folder growing?  Thanks


-- 
Kevin Chan

XiaMen China
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/b89d1383/attachment.htm>

From simon at rabbitmq.com  Thu Jan 13 10:38:17 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Thu, 13 Jan 2011 10:38:17 +0000
Subject: [rabbitmq-discuss] followed the RabbitMQ tutorial,
 but meet an error
In-Reply-To: <AANLkTimh=ZZvJ6_XCBH7YnpCHeyKdR+hUmzkGhHAO2Tu@mail.gmail.com>
References: <AANLkTimh=ZZvJ6_XCBH7YnpCHeyKdR+hUmzkGhHAO2Tu@mail.gmail.com>
Message-ID: <4D2ED619.9010205@rabbitmq.com>

On 13/01/11 07:07, ??? wrote:
> I am a RabbitMQ beginner. When I just followed the
> tutorial(http://www.rabbitmq.com/tutorial-one-python.html) to install
> pika library and run the send.py,
> but got an exception as follow:

Hmm, that's not a very useful exception. It may be worth looking in the 
server logs (/var/log/rabbitmq/ on Unix).

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From david at rabbitmq.com  Thu Jan 13 11:33:39 2011
From: david at rabbitmq.com (David Wragg)
Date: Thu, 13 Jan 2011 11:33:39 +0000
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>
	(techabc@gmail.com's message of "Thu, 13 Jan 2011 15:01:54 +0800")
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
	<AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
	<AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>
Message-ID: <yrv4cpqs16nsc.fsf@dwragg.eng.vmware.com>

Hi,

techabc <techabc at gmail.com> writes:
> according the official web, the lib is still EXPERIMENTAL, not MATURE!

In scary caps, no less.

librabbitmq is widely used, and you can search this mailing list for
problem reports.  If you don't want to use it because the web site does
not yet describe it as mature, you don't have to.

> I download codegen(http://hg.rabbitmq.com/rabbitmq-codegen<http://hg.rabbitmq.com/rabbitmq-codegen/summary>),
> config well python and simplejson, but got error below:
>
> PYTHONPATH=../codegen python ./codegen.py header
> ../codegen/amqp-rabbitmq-0.9.1.
> json amqp_framing.h
> Traceback (most recent call last):
>   File "./codegen.py", line 636, in <module>
>     do_main(generateHrl, generateErl)
>   File "d:\lib.rabbitmq\rabbitmq-c-16e2faae8a2f\codegen\amqp_codegen.py",
> line 2
> 63, in do_main
>     do_main_dict({"header": header_fn, "body": body_fn})
>   File "d:\lib.rabbitmq\rabbitmq-c-16e2faae8a2f\codegen\amqp_codegen.py",
> line 2
> 98, in do_main_dict
>     execute(funcDict[function], sources, dest)
>   File "d:\lib.rabbitmq\rabbitmq-c-16e2faae8a2f\codegen\amqp_codegen.py",
> line 2
> 79, in execute
>     remove(out_file)
> WindowsError: [Error 32] : 'amqp_framing.h'

Unfortunately, this output doesn't help to understand what the real
problem is.  I've improved the error reporting in rabbitmq-codegen.
Could you pull rabbitmq-codegen and try again?

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From majek04 at gmail.com  Thu Jan 13 11:46:25 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Thu, 13 Jan 2011 11:46:25 +0000
Subject: [rabbitmq-discuss] followed the RabbitMQ tutorial,
	but meet an error
In-Reply-To: <AANLkTimh=ZZvJ6_XCBH7YnpCHeyKdR+hUmzkGhHAO2Tu@mail.gmail.com>
References: <AANLkTimh=ZZvJ6_XCBH7YnpCHeyKdR+hUmzkGhHAO2Tu@mail.gmail.com>
Message-ID: <AANLkTim2SkDrW0sqOPN7qNXp+U4P0uQhv35mfc8SRgRB@mail.gmail.com>

On Thu, Jan 13, 2011 at 07:07, ??? <ycombo at gmail.com> wrote:
> I am a RabbitMQ beginner. When I just followed the
> tutorial(http://www.rabbitmq.com/tutorial-one-python.html) to install pika
> library and run the send.py,
> but got an exception as follow:
>
> combo at combo-ubt:~$ python send.py
> Traceback (most recent call last):
> ? File "send.py", line 6, in <module>
> ??? channel = connection.channel()

I suspect you don't have RabbitMQ server running.
You probably should download and install RabbitMQ server.
Check out the following pages:
http://www.rabbitmq.com/server.html
http://www.rabbitmq.com/install.html

Cheers,
  Marek

From david at rabbitmq.com  Thu Jan 13 11:58:25 2011
From: david at rabbitmq.com (David Wragg)
Date: Thu, 13 Jan 2011 11:58:25 +0000
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <yrv4cpqs16nsc.fsf@dwragg.eng.vmware.com> (David Wragg's message
	of "Thu, 13 Jan 2011 11:33:39 +0000")
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
	<AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
	<AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>
	<yrv4cpqs16nsc.fsf@dwragg.eng.vmware.com>
Message-ID: <yrv4cei8h6mn2.fsf@dwragg.eng.vmware.com>

Ah, it looks like you have got code from the tip of the Mercurial
repository, which is on a development branch.  I think this explains
your build problem.  Instead of downloading from the main repository
page, please download from

http://hg.rabbitmq.com/rabbitmq-c/rev/default

and

http://hg.rabbitmq.com/rabbitmq-codegen/rev/default


David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From techabc at gmail.com  Thu Jan 13 12:34:45 2011
From: techabc at gmail.com (techabc)
Date: Thu, 13 Jan 2011 20:34:45 +0800
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <yrv4cei8h6mn2.fsf@dwragg.eng.vmware.com>
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
	<AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
	<AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>
	<yrv4cpqs16nsc.fsf@dwragg.eng.vmware.com>
	<yrv4cei8h6mn2.fsf@dwragg.eng.vmware.com>
Message-ID: <AANLkTi=LAa6ASYUi32aQnWXC647abS4rZz3zFyg1bN60@mail.gmail.com>

Thanks a lot.

I have try the default branch of rabbitmq-c and codegen just now, and still
report error bellow:

examples/Makefile.am: installing `./depcomp'
+ ./configure CC=cl.exe LD=link.exe CFLAGS=-nologo
checking for a BSD-compatible install... /bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking for style of include used by make... GNU
checking for gcc... cl.exe
checking whether the C compiler works... yes
checking for C compiler default output file name... conftest.exe
checking for suffix of executables... .exe
checking whether we are cross compiling... no
checking for suffix of object files... obj
checking whether we are using the GNU C compiler... no
checking whether cl.exe accepts -g... yes
checking for cl.exe option to accept ISO C89... none needed
checking dependency style of cl.exe... none
checking how to run the C preprocessor... cl.exe -E
checking for grep that handles long lines and -e... /bin/grep
checking for egrep... /bin/grep -E
checking for ANSI C header files... yes
checking for sys/types.h... yes
checking for sys/stat.h... yes
checking for stdlib.h... yes
checking for string.h... yes
checking for memory.h... yes
checking for strings.h... no
checking for inttypes.h... no
checking for stdint.h... yes
checking for unistd.h... no
checking minix/config.h usability... no
checking minix/config.h presence... no
checking for minix/config.h... no
checking whether it is safe to define __EXTENSIONS__... yes
checking for gcc... (cached) cl.exe
checking whether we are using the GNU C compiler... (cached) no
checking whether cl.exe accepts -g... (cached) yes
checking for cl.exe option to accept ISO C89... (cached) none needed
checking dependency style of cl.exe... (cached) none
checking build system type... i686-pc-mingw32
checking host system type... i686-pc-mingw32
checking for as... as
checking for dlltool... dlltool
checking for objdump... objdump
checking how to print strings... printf
checking for a sed that does not truncate output... /bin/sed
checking for fgrep... /bin/grep -F
checking for non-GNU ld... link.exe
checking if the linker (link.exe) is GNU ld... no
checking for BSD- or MS-compatible name lister (nm)... /mingw/bin/nm
checking the name lister (/mingw/bin/nm) interface... BSD nm
checking whether ln -s works... no, using cp -p
checking the maximum length of command line arguments... 8192
checking whether the shell understands some XSI constructs... yes
checking whether the shell understands "+="... yes
checking how to convert i686-pc-mingw32 file names to i686-pc-mingw32
format...
func_convert_file_msys_to_w32
checking how to convert i686-pc-mingw32 file names to toolchain format...
func_c
onvert_file_msys_to_w32
checking for link.exe option to reload object files... -r
checking for objdump... (cached) objdump
checking how to recognize dependent libraries... file_magic ^x86 archive
import|
^x86 DLL
checking for dlltool... (cached) dlltool
checking how to associate runtime and link libraries...
func_cygming_dll_for_imp
lib
checking for ar... ar
checking for archiver @FILE support... @
checking for strip... strip
checking for ranlib... ranlib
checking command to parse /mingw/bin/nm output from cl.exe object... ok
checking for sysroot... no
checking for mt... no
checking if : is a manifest tool... no
checking for dlfcn.h... no
checking for objdir... .libs
checking for cl.exe option to produce PIC... -DDLL_EXPORT -DPIC
checking if cl.exe PIC flag -DDLL_EXPORT -DPIC works... yes
checking if cl.exe static flag  works... yes
checking if cl.exe supports -c -o file.obj... no
checking if cl.exe supports -c -o file.obj... (cached) no
checking if we can lock with hard links... yes
checking whether the cl.exe linker (link.exe) supports shared libraries...
yes
checking dynamic linker characteristics... Win32 link.exe
checking how to hardcode library paths into programs... immediate
checking whether stripping libraries is possible... yes
checking if libtool supports shared libraries... yes
checking whether to build shared libraries... yes
checking whether to build static libraries... yes
checking for ANSI C header files... (cached) yes
checking for inline... __inline
checking location of AMQP codegen directory... codegen
checking finding a python with simplejson installed... python
checking for poptGetContext in -lpopt... no
checking for xmlto... no
configure: creating ./config.status
config.status: creating Makefile
config.status: creating librabbitmq/Makefile
config.status: creating tests/Makefile
config.status: creating examples/Makefile
config.status: creating tools/Makefile
config.status: creating tools/doc/Makefile
config.status: creating config.h
config.status: executing depfiles commands
config.status: executing libtool commands
+ sed -i -e
's/^fix_srcfile_path=.*$/fix_srcfile_path=""/;s/^deplibs_check_metho
d=.*$/deplibs_check_method=pass_all/;/^archive_cmds=/s/-link -dll/&
-implib:\\$l
ibname.\\$libext/' libtool
+ make
make  all-recursive
make[1]: Entering directory `/d/lib.rabbitmq/default/rabbitmq-c'
Making all in librabbitmq
make[2]: Entering directory `/d/lib.rabbitmq/default/rabbitmq-c/librabbitmq'
PYTHONPATH=../codegen python ./codegen.py header
../codegen/amqp-rabbitmq-0.9.1.
json amqp_framing.h
PYTHONPATH=../codegen python ./codegen.py body
../codegen/amqp-rabbitmq-0.9.1.js
on amqp_framing.c
make  all-am
make[3]: Entering directory `/d/lib.rabbitmq/default/rabbitmq-c/librabbitmq'
source='amqp_mem.c' object='amqp_mem.lo' libtool=yes \
        DEPDIR=.deps depmode=none /bin/sh ../depcomp \
        /bin/sh ../libtool --tag=CC   --mode=compile cl.exe -DHAVE_CONFIG_H
-I.
-I..    -I./windows -DBUILDING_LIBRABBITMQ  -I../msinttypes -nologo -c -o
amqp_m
em.lo amqp_mem.c
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_mem.c  -DDLL_EXPORT -DPIC
amqp_mem.c
libtool: compile: mv -f "amqp_mem.obj" ".libs/amqp_mem.obj"
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_mem.c >/dev/null 2>&1
source='amqp_table.c' object='amqp_table.lo' libtool=yes \
        DEPDIR=.deps depmode=none /bin/sh ../depcomp \
        /bin/sh ../libtool --tag=CC   --mode=compile cl.exe -DHAVE_CONFIG_H
-I.
-I..    -I./windows -DBUILDING_LIBRABBITMQ  -I../msinttypes -nologo -c -o
amqp_t
able.lo amqp_table.c
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_table.c  -DDLL_EXPORT -DPIC
amqp_table.c
libtool: compile: mv -f "amqp_table.obj" ".libs/amqp_table.obj"
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_table.c >/dev/null 2>&1
source='amqp_connection.c' object='amqp_connection.lo' libtool=yes \
        DEPDIR=.deps depmode=none /bin/sh ../depcomp \
        /bin/sh ../libtool --tag=CC   --mode=compile cl.exe -DHAVE_CONFIG_H
-I.
-I..    -I./windows -DBUILDING_LIBRABBITMQ  -I../msinttypes -nologo -c -o
amqp_c
onnection.lo amqp_connection.c
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_connection.c  -DDLL_EXPORT -DPIC
amqp_connection.c
libtool: compile: mv -f "amqp_connection.obj" ".libs/amqp_connection.obj"
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_connection.c >/dev/null 2>&1
source='amqp_socket.c' object='amqp_socket.lo' libtool=yes \
        DEPDIR=.deps depmode=none /bin/sh ../depcomp \
        /bin/sh ../libtool --tag=CC   --mode=compile cl.exe -DHAVE_CONFIG_H
-I.
-I..    -I./windows -DBUILDING_LIBRABBITMQ  -I../msinttypes -nologo -c -o
amqp_s
ocket.lo amqp_socket.c
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_socket.c  -DDLL_EXPORT -DPIC
amqp_socket.c
libtool: compile: mv -f "amqp_socket.obj" ".libs/amqp_socket.obj"
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_socket.c >/dev/null 2>&1
source='amqp_api.c' object='amqp_api.lo' libtool=yes \
        DEPDIR=.deps depmode=none /bin/sh ../depcomp \
        /bin/sh ../libtool --tag=CC   --mode=compile cl.exe -DHAVE_CONFIG_H
-I.
-I..    -I./windows -DBUILDING_LIBRABBITMQ  -I../msinttypes -nologo -c -o
amqp_a
pi.lo amqp_api.c
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_api.c  -DDLL_EXPORT -DPIC
amqp_api.c
libtool: compile: mv -f "amqp_api.obj" ".libs/amqp_api.obj"
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_api.c >/dev/null 2>&1
source='windows/socket.c' object='socket.lo' libtool=yes \
        DEPDIR=.deps depmode=none /bin/sh ../depcomp \
        /bin/sh ../libtool  --tag=CC   --mode=compile cl.exe -DHAVE_CONFIG_H
-I.
 -I..    -I./windows -DBUILDING_LIBRABBITMQ  -I../msinttypes -nologo -c -o
socke
t.lo `test -f 'windows/socket.c' || echo './'`windows/socket.c
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c windows/socket.c  -DDLL_EXPORT -DPIC
socket.c
libtool: compile: mv -f "socket.obj" ".libs/socket.obj"
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c windows/socket.c >/dev/null 2>&1
source='amqp_framing.c' object='amqp_framing.lo' libtool=yes \
        DEPDIR=.deps depmode=none /bin/sh ../depcomp \
        /bin/sh ../libtool --tag=CC   --mode=compile cl.exe -DHAVE_CONFIG_H
-I.
-I..    -I./windows -DBUILDING_LIBRABBITMQ  -I../msinttypes -nologo -c -o
amqp_f
raming.lo amqp_framing.c
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_framing.c  -DDLL_EXPORT -DPIC
amqp_framing.c
libtool: compile: mv -f "amqp_framing.obj" ".libs/amqp_framing.obj"
libtool: compile:  cl.exe -DHAVE_CONFIG_H -I. -I.. -I./windows
-DBUILDING_LIBRAB
BITMQ -I../msinttypes -nologo -c amqp_framing.c >/dev/null 2>&1
/bin/sh ../libtool --tag=CC   --mode=link cl.exe -I./windows
-DBUILDING_LIBRABBI
TMQ  -I../msinttypes -nologo -no-undefined  -o librabbitmq.la -rpath
/usr/local/
lib amqp_mem.lo amqp_table.lo amqp_connection.lo amqp_socket.lo amqp_api.lo
sock
et.lo amqp_framing.lo ws2_32.lib

*** Warning: Linking the shared library librabbitmq.la against the
*** static library ws2_32.lib is not portable!
libtool: link: /mingw/bin/nm  .libs/amqp_mem.obj .libs/amqp_table.obj
.libs/amqp
_connection.obj .libs/amqp_socket.obj .libs/amqp_api.obj .libs/socket.obj
.libs/
amqp_framing.obj   | sed -n -e 's/^.*[   ]\([ABCDGIRSTW][ABCDGIRSTW]*\)[ ][
]*_\
([_A-Za-z][_A-Za-z0-9]*\)\{0,1\}$/\1 _\2 \2/p' | sed '/ __gnu_lto/d' |
/bin/sed
-e '/^[BCDGRS][ ]/s/.*[ ]\([^ ]*\)/\1,DATA/' | /bin/sed -e '/^[AITW][
]/s/.*[ ]/
/' | sort | uniq > .libs/rabbitmq.exp
libtool: link: if test "x`/bin/sed 1q .libs/rabbitmq.exp`" = xEXPORTS; then
sed
-n -e s/\\\(.*\\\)/-link\ -EXPORT:\\\1/ -e 1\!p < .libs/rabbitmq.exp >
.libs/rab
bitmq-0.dll.exp; else sed -e s/\\\(.*\\\)/-link\ -EXPORT:\\\1/ <
.libs/rabbitmq.
exp > .libs/rabbitmq-0.dll.exp; fi
libtool: link:  cl.exe -o .libs\\rabbitmq-0.dll  .libs/amqp_mem.obj
.libs/amqp_t
able.obj .libs/amqp_connection.obj .libs/amqp_socket.obj .libs/amqp_api.obj
.lib
s/socket.obj .libs/amqp_framing.obj      ws2_32.lib
"@.libs\\rabbitmq-0.dll.exp"
 -Wl,-DLL,-IMPLIB:".libs\\rabbitmq.dll.lib"
Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 16.00.30319.01 for
80x86
Copyright (C) Microsoft Corporation.  All rights reserved.

cl : Command line warning D9035 : option 'o' has been deprecated and will be
rem
oved in a future release
cl -link -EXPORT:amqp_abort
   -link -EXPORT:amqp_basic_ack
   -link -EXPORT:amqp_basic_consume
   -link -EXPORT:amqp_basic_get
   -link -EXPORT:amqp_basic_publish
   -link -EXPORT:amqp_bytes_free
   -link -EXPORT:amqp_bytes_malloc
   -link -EXPORT:amqp_bytes_malloc_dup
   -link -EXPORT:amqp_channel_close
   -link -EXPORT:amqp_channel_open
   -link -EXPORT:amqp_connection_close
   -link -EXPORT:amqp_constant_is_hard_error
   -link -EXPORT:amqp_constant_name
   -link -EXPORT:amqp_cstring_bytes
   -link -EXPORT:amqp_data_in_buffer
   -link -EXPORT:amqp_decode_method
   -link -EXPORT:amqp_decode_properties
   -link -EXPORT:amqp_decode_table
   -link -EXPORT:amqp_destroy_connection
   -link -EXPORT:amqp_empty_array,DATA
   -link -EXPORT:amqp_empty_bytes,DATA
   -link -EXPORT:amqp_empty_table,DATA
   -link -EXPORT:amqp_encode_method
   -link -EXPORT:amqp_encode_properties
   -link -EXPORT:amqp_encode_table
   -link -EXPORT:amqp_error_string
   -link -EXPORT:amqp_exchange_declare
   -link -EXPORT:amqp_frames_enqueued
   -link -EXPORT:amqp_get_channel_max
   -link -EXPORT:amqp_get_rpc_reply
   -link -EXPORT:amqp_get_sockfd
   -link -EXPORT:amqp_handle_input
   -link -EXPORT:amqp_login
   -link -EXPORT:amqp_maybe_release_buffers
   -link -EXPORT:amqp_method_has_content
   -link -EXPORT:amqp_method_name
   -link -EXPORT:amqp_new_connection
   -link -EXPORT:amqp_open_socket
   -link -EXPORT:amqp_os_error_string
   -link -EXPORT:amqp_pool_alloc
   -link -EXPORT:amqp_pool_alloc_bytes
   -link -EXPORT:amqp_queue_bind
   -link -EXPORT:amqp_queue_declare
   -link -EXPORT:amqp_queue_delete
   -link -EXPORT:amqp_queue_purge
   -link -EXPORT:amqp_queue_unbind
   -link -EXPORT:amqp_release_buffers
   -link -EXPORT:amqp_release_buffers_ok
   -link -EXPORT:amqp_send_frame
   -link -EXPORT:amqp_send_header
   -link -EXPORT:amqp_send_method
   -link -EXPORT:amqp_set_sockfd
   -link -EXPORT:amqp_simple_rpc
   -link -EXPORT:amqp_simple_wait_frame
   -link -EXPORT:amqp_simple_wait_method
   -link -EXPORT:amqp_socket_init
   -link -EXPORT:amqp_table_entry_cmp
   -link -EXPORT:amqp_tune_connection
   -link -EXPORT:amqp_tx_commit
   -link -EXPORT:amqp_tx_rollback
   -link -EXPORT:amqp_tx_select
   -link -EXPORT:amqp_version
   -link -EXPORT:empty_amqp_pool
   -link -EXPORT:init_amqp_pool
   -link -EXPORT:recycle_amqp_pool
cl : Command line error D8021 : invalid numeric argument
'/Wl,-DLL,-IMPLIB:.libs
\rabbitmq.dll.lib'
make[3]: *** [librabbitmq.la] Error 2
make[3]: Leaving directory `/d/lib.rabbitmq/default/rabbitmq-c/librabbitmq'
make[2]: *** [all] Error 2
make[2]: Leaving directory `/d/lib.rabbitmq/default/rabbitmq-c/librabbitmq'
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory `/d/lib.rabbitmq/default/rabbitmq-c'
make: *** [all] Error 2


2011/1/13 David Wragg <david at rabbitmq.com>

> Ah, it looks like you have got code from the tip of the Mercurial
> repository, which is on a development branch.  I think this explains
> your build problem.  Instead of downloading from the main repository
> page, please download from
>
> http://hg.rabbitmq.com/rabbitmq-c/rev/default
>
> and
>
> http://hg.rabbitmq.com/rabbitmq-codegen/rev/default
>
>
> David
>
> --
> David Wragg
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/20542e61/attachment-0001.htm>

From markjreed at gmail.com  Thu Jan 13 12:48:35 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Thu, 13 Jan 2011 07:48:35 -0500
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
Message-ID: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>

I'm running 1.7.2 (because that's what's in the repos for Ubuntu
10.04) and trying to bring up clusters via automated configuration
management, but the nodes are not clustering; they just come up
standalone.

I've read and followed
http://www.rabbitmq.com/clustering.html#auto-config, and it's just not
working for me. I found
http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-November/010104.html,
but didn't see a solution, just a "never mind, it's working now"...

If I manually cluster the nodes, it works fine, so I know that basic
functionality and connectivity between the nodes is there.

I know my rabbitmq.config file is in the right place because I can
change it and see the impact when I restart.

For a simple test, I have two hosts.  I give them both the same
rabbitmq.config file, with nothing in it but this:

[{rabbit, [ {cluster_nodes, [ 'rabbit at rabbit2', 'rabbit at rabbit1' ]} ] } ].

(I've tried both bare node names and FQDNs, BTW.  FQDNs don't work
with the cluster command, either.).

On each host, I perform these steps:

$ sudo rabbitmqctl stop_app
$ sudo rabbitmqctl reset
$ sudo rabbitmqctl stop
$ sudo /etc/init.d/rabbitmqctl-server start

But when I check the status, no clustering:

rabbit1$ sudo rabbitmqctl status
Status of node rabbit at rabbit1 ...
[{running_applications,[{rabbit,"RabbitMQ","1.7.2"},
                        {mnesia,"MNESIA  CXC 138 12","4.4.12"},
                        {os_mon,"CPO  CXC 138 46","2.2.4"},
                        {sasl,"SASL  CXC 138 11","2.1.8"},
                        {stdlib,"ERTS  CXC 138 10","1.16.4"},
                        {kernel,"ERTS  CXC 138 10","2.13.4"}]},
 {nodes,[rabbit at rabbit1]},
 {running_nodes,[rabbit at rabbit1]}]
...done.

As I said, it works fine if I use the cluster command:

rabbit1$ sudo rabbitmqctl stop_app
rabbit1$ sudo rabbitmqctl reset
rabbit1$ sudo rabbitmqctl cluster rabbit at rabbit2
rabbit1$ sudo rabbitmqctl start_app
rabbit1$ sudo rabbitmqctl status
Status of node rabbit at rabbit1 ...
[{running_applications,[{rabbit,"RabbitMQ","1.7.2"},
                        {mnesia,"MNESIA  CXC 138 12","4.4.12"},
                        {os_mon,"CPO  CXC 138 46","2.2.4"},
                        {sasl,"SASL  CXC 138 11","2.1.8"},
                        {stdlib,"ERTS  CXC 138 10","1.16.4"},
                        {kernel,"ERTS  CXC 138 10","2.13.4"}]},
 {nodes,[rabbit at rabbit1,rabbit at rabbit2]},
 {running_nodes,[rabbit at rabbit2,rabbit at rabbit1]}]
...done.

So what are my next steps in troubleshooting this?


-- 
Mark J. Reed <markjreed at gmail.com>

From matthew at rabbitmq.com  Thu Jan 13 12:54:40 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Thu, 13 Jan 2011 12:54:40 +0000
Subject: [rabbitmq-discuss] about msg_store_persistent folder
In-Reply-To: <AANLkTinkc22xi=8_6+e=M+H1rBaCkywS5XYZw_w94h7z@mail.gmail.com>
References: <AANLkTinkc22xi=8_6+e=M+H1rBaCkywS5XYZw_w94h7z@mail.gmail.com>
Message-ID: <20110113125440.GA1694@wellquite.org>

Hi Kevin,

On Thu, Jan 13, 2011 at 03:17:48PM +0800, Kevin Chan wrote:
>   I send msg to rabbbitmq server ,on the server,the folder(
> /var/lib/rabbitmq/mnesia/rabbit at localhost/msg_store_transient) size will
> became bigger and bigger.how to deal with
> it. may i del this folder's file when rabbitmq server running,or is there
> any way to limmit the folder growing?

The way to limit the folder growing is to consume and acknowledge
messages from the broker. Rabbit will only write messages to disk which
have not been consumed and when necessary - either the messages are
being published persistent (delivery_mode = 2) or the broker is under
memory pressure and is thus writing to disk to free up memory.

If you stop the queues from growing (either by not publishing messages,
or by consuming and acknowledging messages from the queues) then Rabbit
will have no reason to write messages to disk.

Matthew

From alexandru at rabbitmq.com  Thu Jan 13 13:12:23 2011
From: alexandru at rabbitmq.com (Alexandru =?utf-8?B?U2N2b3LFo292?=)
Date: Thu, 13 Jan 2011 15:12:23 +0200
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
Message-ID: <20110113131223.GB2339@dakota.eng.vmware.com>

> I'm running 1.7.2 (because that's what's in the repos for Ubuntu
> 10.04) 

That really is ancient and you should upgrade.

> and trying to bring up clusters via automated configuration
> management, but the nodes are not clustering; they just come up
> standalone.

At some point (2.0, I think), we changed the way automatic clustering
works.  We now read the settings from rabbitmq.config.  Before, we had a
separate rabbitmq_cluster.config file.

If I remember correctly, put [ 'rabbit at rabbit2', 'rabbit at rabbit1' ]
in /etc/rabbitmq/rabbitmq_cluster.config.

Cheers,
Alex

On Thu, Jan 13, 2011 at 07:48:35AM -0500, Mark J. Reed wrote:
> I'm running 1.7.2 (because that's what's in the repos for Ubuntu
> 10.04) and trying to bring up clusters via automated configuration
> management, but the nodes are not clustering; they just come up
> standalone.
> 
> I've read and followed
> http://www.rabbitmq.com/clustering.html#auto-config, and it's just not
> working for me. I found
> http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-November/010104.html,
> but didn't see a solution, just a "never mind, it's working now"...
> 
> If I manually cluster the nodes, it works fine, so I know that basic
> functionality and connectivity between the nodes is there.
> 
> I know my rabbitmq.config file is in the right place because I can
> change it and see the impact when I restart.
> 
> For a simple test, I have two hosts.  I give them both the same
> rabbitmq.config file, with nothing in it but this:
> 
> [{rabbit, [ {cluster_nodes, [ 'rabbit at rabbit2', 'rabbit at rabbit1' ]} ] } ].
> 
> (I've tried both bare node names and FQDNs, BTW.  FQDNs don't work
> with the cluster command, either.).
> 
> On each host, I perform these steps:
> 
> $ sudo rabbitmqctl stop_app
> $ sudo rabbitmqctl reset
> $ sudo rabbitmqctl stop
> $ sudo /etc/init.d/rabbitmqctl-server start
> 
> But when I check the status, no clustering:
> 
> rabbit1$ sudo rabbitmqctl status
> Status of node rabbit at rabbit1 ...
> [{running_applications,[{rabbit,"RabbitMQ","1.7.2"},
>                         {mnesia,"MNESIA  CXC 138 12","4.4.12"},
>                         {os_mon,"CPO  CXC 138 46","2.2.4"},
>                         {sasl,"SASL  CXC 138 11","2.1.8"},
>                         {stdlib,"ERTS  CXC 138 10","1.16.4"},
>                         {kernel,"ERTS  CXC 138 10","2.13.4"}]},
>  {nodes,[rabbit at rabbit1]},
>  {running_nodes,[rabbit at rabbit1]}]
> ...done.
> 
> As I said, it works fine if I use the cluster command:
> 
> rabbit1$ sudo rabbitmqctl stop_app
> rabbit1$ sudo rabbitmqctl reset
> rabbit1$ sudo rabbitmqctl cluster rabbit at rabbit2
> rabbit1$ sudo rabbitmqctl start_app
> rabbit1$ sudo rabbitmqctl status
> Status of node rabbit at rabbit1 ...
> [{running_applications,[{rabbit,"RabbitMQ","1.7.2"},
>                         {mnesia,"MNESIA  CXC 138 12","4.4.12"},
>                         {os_mon,"CPO  CXC 138 46","2.2.4"},
>                         {sasl,"SASL  CXC 138 11","2.1.8"},
>                         {stdlib,"ERTS  CXC 138 10","1.16.4"},
>                         {kernel,"ERTS  CXC 138 10","2.13.4"}]},
>  {nodes,[rabbit at rabbit1,rabbit at rabbit2]},
>  {running_nodes,[rabbit at rabbit2,rabbit at rabbit1]}]
> ...done.
> 
> So what are my next steps in troubleshooting this?
> 
> 
> -- 
> Mark J. Reed <markjreed at gmail.com>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From matthew at rabbitmq.com  Thu Jan 13 13:17:04 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Thu, 13 Jan 2011 13:17:04 +0000
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <20110113131223.GB2339@dakota.eng.vmware.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
	<20110113131223.GB2339@dakota.eng.vmware.com>
Message-ID: <20110113131703.GB1694@wellquite.org>

On Thu, Jan 13, 2011 at 03:12:23PM +0200, Alexandru Scvor?ov wrote:
> If I remember correctly, put [ 'rabbit at rabbit2', 'rabbit at rabbit1' ]

It needs a . on the end there.

Matthew

From david at rabbitmq.com  Thu Jan 13 13:41:10 2011
From: david at rabbitmq.com (David Wragg)
Date: Thu, 13 Jan 2011 13:41:10 +0000
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <AANLkTi=LAa6ASYUi32aQnWXC647abS4rZz3zFyg1bN60@mail.gmail.com>
	(techabc@gmail.com's message of "Thu, 13 Jan 2011 20:34:45 +0800")
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
	<AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
	<AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>
	<yrv4cpqs16nsc.fsf@dwragg.eng.vmware.com>
	<yrv4cei8h6mn2.fsf@dwragg.eng.vmware.com>
	<AANLkTi=LAa6ASYUi32aQnWXC647abS4rZz3zFyg1bN60@mail.gmail.com>
Message-ID: <yrv4c62ts7wg9.fsf@dwragg.eng.vmware.com>

techabc <techabc at gmail.com> writes:
> libtool: link:  cl.exe -o .libs\\rabbitmq-0.dll  .libs/amqp_mem.obj
> .libs/amqp_t
> able.obj .libs/amqp_connection.obj .libs/amqp_socket.obj .libs/amqp_api.obj
> .lib
> s/socket.obj .libs/amqp_framing.obj      ws2_32.lib
> "@.libs\\rabbitmq-0.dll.exp"
>  -Wl,-DLL,-IMPLIB:".libs\\rabbitmq.dll.lib"
> Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 16.00.30319.01 for
> 80x86
> Copyright (C) Microsoft Corporation.  All rights reserved.

I think you probably have the wrong version of libtool.  Please check
that you have the right version of libtool, using 'libtool --version'.
It should be 2.2.7a.

Did you install the mingw packages using the install-mingw.sh script?

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From moseley at hank.org  Thu Jan 13 14:42:19 2011
From: moseley at hank.org (Bill Moseley)
Date: Thu, 13 Jan 2011 06:42:19 -0800
Subject: [rabbitmq-discuss] Are queues replicated across a cluster?
Message-ID: <AANLkTik6DTYcEVy+MtiaQ7k397zkCepeRb1TG8+r0snR@mail.gmail.com>

http://www.rabbitmq.com/clustering.html says:

All data/state required for the operation of a RabbitMQ broker is replicated
> across all nodes, for reliability and scaling, with full ACID properties. An
> exception to this are message queues, which currently only reside on the
> node that created them, though they are visible and reachable from all
> nodes. Future releases of RabbitMQ will introduce migration and replication
> of message queues.


I don't understand that sentence that says the queues only reside on the
node that created them -- but they are visible on both.  Is that talking
about replicating *messages* or queues?  Queues and messages are separate
things.  I understand that messages are not duplicated/replicated in the
cluster.

I have two nodes in a cluster node1 and node2 (on same server, different
ports).  I declare an exchange, queue, and binding on node1 only.  Next, I
start consumers on node1 and node2 -- these do not declare the queue, they
only consume.  This succeeds so therefore the queue is accessible from both
node1 and node2.

Next I connect to node1 and send two messages to the queue.  One message
ends up with the consumer on node1 and the consumer on node2 receives the
other message.

What's the distinction between "residing" and "visible"?  Does it mean the
messages are only stored on node1 until consumed (by either node)?  But, I
can declare the same queue on both nodes and see the same behavior.  Can
someone please clear this up for me?


What I have failed to find when reading about clustering is how to connect
to the nodes in a cluster.  If I have node1 and node2 in my cluster and 10
producers (say web servers) and 4 worker machines do I configure 5 producers
to connect to node1 and 5 to node2, and then likewise split the consumer
connections across the two nodes?

To be clear, this is not HA.  So, if node1 fails then 1/2 the producers and
1/2 the consumers can no longer function.  Correct?


Or is the typical approach to use something like HAProxy in front of node1
and node2 and have all consumers and producers connect to HAProxy?  (That
ends up as a single point of failure.)



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/c118e4f0/attachment-0001.htm>

From markjreed at gmail.com  Thu Jan 13 16:16:59 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Thu, 13 Jan 2011 11:16:59 -0500
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <20110113131223.GB2339@dakota.eng.vmware.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
	<20110113131223.GB2339@dakota.eng.vmware.com>
Message-ID: <AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>

On Thu, Jan 13, 2011 at 8:12 AM, Alexandru Scvor?ov
<alexandru at rabbitmq.com> wrote:
>> I'm running 1.7.2 (because that's what's in the repos for Ubuntu 10.04)
>
> That really is ancient and you should upgrade.

It came out what, 11 months ago?  I guess that makes it "ancient" in
Internet time, but in that case we're running an OS that is almost as
ancient.

> At some point (2.0, I think), we changed the way automatic clustering
> works. ?We now read the settings from rabbitmq.config. ?Before, we had a
> separate rabbitmq_cluster.config file.

And that's what I had originally, but it also didn't work.  I changed
it to the new style after RTFM, not realizing it was post- 2.x.  That
removes a lot of the confusion.  Thank you.

I switched back to the old style config and got it working.
Apparently, the problem was the use of FQDNs instead of bare hostnames
in the node list.  If I may ask, what controls that?   It seems mildly
unlikely that I would ever need to cluster two hosts that have
different domain roots, but we do deploy hosts across multiple
domains, so I'd like to understand the rule.

Thanks to everyone for the quick help!
-- 
Mark J. Reed <markjreed at gmail.com>

From markjreed at gmail.com  Thu Jan 13 17:50:56 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Thu, 13 Jan 2011 12:50:56 -0500
Subject: [rabbitmq-discuss] List queues via AMQP?
Message-ID: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>

Perhaps off-topic, as it's more of an AMQP question than a
Rabbit-specific one, but is there any way via AMQP to request a list
of the queues that currently exist on the broker, so a remote client
could get the same data as e.g. rabbitmqctl list_queues?

-- 
Mark J. Reed <markjreed at gmail.com>

From majek04 at gmail.com  Thu Jan 13 18:01:05 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Thu, 13 Jan 2011 18:01:05 +0000
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
Message-ID: <AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>

No, you can't do it over AMQP.

Use rabbitmqctl list_queues or our management plugin.

Cheers,
  Marek


On Thu, Jan 13, 2011 at 17:50, Mark J. Reed <markjreed at gmail.com> wrote:
> Perhaps off-topic, as it's more of an AMQP question than a
> Rabbit-specific one, but is there any way via AMQP to request a list
> of the queues that currently exist on the broker, so a remote client
> could get the same data as e.g. rabbitmqctl list_queues?
>
> --
> Mark J. Reed <markjreed at gmail.com>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From markjreed at gmail.com  Thu Jan 13 18:55:16 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Thu, 13 Jan 2011 13:55:16 -0500
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
Message-ID: <AANLkTikexmkkniqrcF6OpsXuHg9rTzw9HuKJcXi42Zi5@mail.gmail.com>

Thanks for the confirmation.  I'm guessing the management plugin won't
work with 1.7.2?

On Thu, Jan 13, 2011 at 1:01 PM, Marek Majkowski <majek04 at gmail.com> wrote:
> No, you can't do it over AMQP.
>
> Use rabbitmqctl list_queues or our management plugin.
>
> Cheers,
> ?Marek
>
>
> On Thu, Jan 13, 2011 at 17:50, Mark J. Reed <markjreed at gmail.com> wrote:
>> Perhaps off-topic, as it's more of an AMQP question than a
>> Rabbit-specific one, but is there any way via AMQP to request a list
>> of the queues that currently exist on the broker, so a remote client
>> could get the same data as e.g. rabbitmqctl list_queues?
>>
>> --
>> Mark J. Reed <markjreed at gmail.com>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>



-- 
Mark J. Reed <markjreed at gmail.com>

From paul.pearcy at wallst.com  Thu Jan 13 18:59:28 2011
From: paul.pearcy at wallst.com (Paul Pearcy)
Date: Thu, 13 Jan 2011 13:59:28 -0500
Subject: [rabbitmq-discuss] Confusion about location of Windows
	rabbitmq.config
Message-ID: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E407C@IS-EXCHANGEC101.wsod.local>

Hello,
  I have been through the install docs a couple of times and am still baffled about the location of the rabbitmq.config file on Windows. There are two sections:

RABBITMQ_CONFIG_FILE
Defaults to %RABBITMQ_BASE%\rabbitmq. If this file is present it is used by the server to configure RabbitMQ application components. Note that the .config extension is automatically appended by the Erlang runtime. See the section on the configuration file<http://www.rabbitmq.com/install.html#configfile> for details. Note that this file is also used to auto-configure RabbitMQ clusters. See the clustering guide<http://www.rabbitmq.com/clustering.html> for details.


Then in the link for the configuration file, there are the following details:
The location of this configuration file is distribution specific. By default, it is located in the following places on each platform:
*         Windows - %APPDATA%\RabbitMQ\rabbitmq.config
*         Debian - /etc/rabbitmq/rabbitmq.config
*         RPM - /etc/rabbitmq/rabbitmq.config
*         MacOS (Macports) - /opt/local/etc/rabbitmq/rabbitmq.config
*         Generic UNIX - /etc/rabbitmq/rabbitmq.config


Maybe I am missing something obvious, but these seem to disagree.

I have attempted to be explicit instead by setting the following env var:
RABBITMQ_CONFIG_FILE= D:\rabbitmq\rabbitmq

I would then expect this to pick up this config file:
D:\rabbitmq\rabbitmq.config

However, none of my settings are taking effect and I can't figure out how to tell which config file the rabbitmq install is picking up. What is the easiest way for rabbitmq to tell me where it is looking for the config file?

Any help or clarification would be much appreciated.

Thanks,
Paul
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/63419f3f/attachment-0001.htm>

From matthias at rabbitmq.com  Thu Jan 13 19:08:53 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Thu, 13 Jan 2011 19:08:53 +0000
Subject: [rabbitmq-discuss] Execution hangs when redeclaring queue
In-Reply-To: <AANLkTikgMvtCw4FD9Qx_xn-p_9=_Jsp1eG4T6e4xQm6Y@mail.gmail.com>
References: <AANLkTimz3XKgCrXsd9BORxamawnTkG0_T15KA+JEh0Aw@mail.gmail.com>	<20101222165254.GA22090@wellquite.org>
	<AANLkTikgMvtCw4FD9Qx_xn-p_9=_Jsp1eG4T6e4xQm6Y@mail.gmail.com>
Message-ID: <4D2F4DC5.6000508@rabbitmq.com>

Henrik,

Henrik Abrahamsson wrote:
> 2010/12/22 Matthew Sackman <matthew at rabbitmq.com 
> <mailto:matthew at rabbitmq.com>>
> 
>     On Wed, Dec 22, 2010 at 05:42:12PM +0100, Henrik Abrahamsson wrote:
>      > My failover mechanism for my listener works like this: when
>     connection to
>      > node1 goes down, connect to node2 and redeclare the queue q.
> 
>     That cannot be done. It should be returning a 404 error and closing the
>     channel or maybe even the connection... unless the queue is not durable.
>     If the queue is not declared durable, you should be ok.
> 
> It is a non-durable queue.

Did you manage to resolve this? If not then it's possible you are 
running into some clustering related bugs which we discovered recently 
and have since fixed. You may want to try building the server from the 
latest sources in mercurial. Or wait for the next release.

Regards,

Matthias.

From jerryk at vmware.com  Thu Jan 13 19:41:30 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Thu, 13 Jan 2011 11:41:30 -0800
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTikexmkkniqrcF6OpsXuHg9rTzw9HuKJcXi42Zi5@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
	<AANLkTikexmkkniqrcF6OpsXuHg9rTzw9HuKJcXi42Zi5@mail.gmail.com>
Message-ID: <133A89AD-BAB1-4E57-AE49-3827E70867D0@vmware.com>

Alas, I think you'll be limited to Rabbit version 2 and later for the management plugin.  

It is one of many features and improvements that make considering an upgrade worthwhile though.  The management plugin is really very nice to work with and provides a nice way to get a handle on what's going on in your broker.

Best regards,
Jerry

On Jan 13, 2011, at 10:55 AM, Mark J. Reed wrote:

> Thanks for the confirmation.  I'm guessing the management plugin won't
> work with 1.7.2?
> 
> On Thu, Jan 13, 2011 at 1:01 PM, Marek Majkowski <majek04 at gmail.com> wrote:
>> No, you can't do it over AMQP.
>> 
>> Use rabbitmqctl list_queues or our management plugin.
>> 
>> Cheers,
>>  Marek
>> 
>> 
>> On Thu, Jan 13, 2011 at 17:50, Mark J. Reed <markjreed at gmail.com> wrote:
>>> Perhaps off-topic, as it's more of an AMQP question than a
>>> Rabbit-specific one, but is there any way via AMQP to request a list
>>> of the queues that currently exist on the broker, so a remote client
>>> could get the same data as e.g. rabbitmqctl list_queues?
>>> 
>>> --
>>> Mark J. Reed <markjreed at gmail.com>
>>> _______________________________________________
>>> rabbitmq-discuss mailing list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>> 
>> 
> 
> 
> 
> -- 
> Mark J. Reed <markjreed at gmail.com>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


From nehakothari86 at gmail.com  Thu Jan 13 19:46:56 2011
From: nehakothari86 at gmail.com (Neha)
Date: Thu, 13 Jan 2011 11:46:56 -0800 (PST)
Subject: [rabbitmq-discuss] Consumers stops to pick up messages after
	long inactivity
In-Reply-To: <4D2C7BA0.9010508@rabbitmq.com>
References: <02df0bac-c856-4af7-93ee-fbcd600a4fff@j25g2000vbs.googlegroups.com>
	<4D2C7BA0.9010508@rabbitmq.com>
Message-ID: <add8ddd0-50cb-449e-b6f5-e2f04d93b83a@k30g2000vbn.googlegroups.com>

Hi Emile

Thanks for the reply.
I checked the broker logfiles and it has a few
"AutoFailoverConnectionFactory" messages. But it again connects
successfully.
I checked the timeout and that is listed as 0.
To check the clients connected to the broker I'll have to wait for
Monday and see if the brokers considers the consumers to be connected.

Will keep this post updated with the cause of the problem.

Thanks
Neha

On Jan 11, 10:47?am, Emile Joubert <em... at rabbitmq.com> wrote:
> Hi Neha,
>
> On 10/01/11 21:57, Neha wrote:
>
>
>
> > I have an application which uses rabbitmq. It has messages being sent
> > from Monday to Friday and on the weekend there are no messages sent.
>
> > The application works fine on regular days, i.e producers puts the
> > message on the queue and the consumer receives the message. But every
> > Monday, after the weekend the consumer starts behaving strangely. It
> > stops receiving messages even though the queue has messages present.
> > The heartbeat of the consumer all this time is working fine but it
> > still doesn't receive all these messages on the queue. To overcome
> > this problem I have to restart the consumers every Monday, and as soon
> > as I do that, all the messages that are present in the queue starts
> > getting consumed.
>
> > Looking at a problem, I feel it might be due to inactivity during the
> > weekend. I wanted to know if anyone else has faced this problem
> > wherein the consumer stops consuming after a long duration of
> > inactivity? Is there a setting to be tweaked to increase this period?
>
> Long periods of inactivity should have no effect. The problem is almost
> certainly network-related. Here are some things to check.
>
> Is there anything of interest in the broker logfile?
>
> As there any device along the network path that might have caused the
> connections to be reset?
>
> Does the broker consider the clients to be connected on Monday mornings?
> "rabbitmqctl list_connections" and "rabbitmqctl list_consumers" can help
> determine this. The logfile will show when any connections were
> terminated. Also verify the connection timeout (rabbitmqctl
> list_connections timeout).
>
> You may want to try using a different connection heartbeat value and
> check whether the message consumers are able to recover from network
> interruptions automatically.
>
> Regards
>
> Emile
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From jerryk at vmware.com  Thu Jan 13 19:54:59 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Thu, 13 Jan 2011 11:54:59 -0800
Subject: [rabbitmq-discuss] Fwd: Best Practice - Implementing a Consumer
 (subscriber)
References: <B9539037-B268-4BF3-BD23-E7B8B591474B@vmware.com>
Message-ID: <A6690520-5976-4081-8F34-1CE3327F6E61@vmware.com>

Hi, Jerry...

I apologize that you didn't get a response before today.  Many of us were a bit shut down over the winter holiday period.

> The notification broker is subscribed to a queue, reads messages off of the 
> queue and does work to determine how the message content is formatted (based 
> on message type), who the message should be routed to (a person) and by what 
> means the message is routed (email, sms, tweet, etc).
> 
> Ideally, to provide some scalability, several instances of the broker would 
> be running in parallel in some sort of load balanced manner, all reading off 
> of the same queue.

This is a totally reasonable sounding scenario.  Marek Majkowski of the Rabbit team has written a nice tutorial that sketches how a core, Rabbity part of this system might be built:

http://www.rabbitmq.com/tutorial-two-python.html

For the system you describe it seems that you'd want to run multiple instances of your broker/dispatcher entity all subscribed to the same Rabbit queue into which messages are being published.  If you follow the pattern described in the tutorial you'll get a round-robin distribution of work items across your own brokers.

That will give you the ability you desire to handle greater volume on your application's end, and will also let your application continue to get work done even if some instances of your dispatcher/broker app, or the hosts they're running on, go down.

Also, note in particular the discussion of "message acknowledgment" in the tutorial above.  Following those guidelines will protect you against losing work items if your application receives a work item out of a Rabbit queue and then meets some bad fate before finishing its task.  By using the ack mechanism as described, Rabbit will maintain responsibility for keeping your message until such time as you've certified that you've successfully done the work entailed by the message.

> The broker would be running on a pool of application servers or IIS servers. 
> either or, but not both.
> 
> What is the recommend implementation of the broker? A window's service, an 
> application running under IIS, some other WCF/WAS implementation?

On that issue, Rabbit is agnostic.  I'd suggest that you implement your application side creatures in whatever form you find easiest to start, maintain, debug and monitor the health of...  Windows services that run at system boot time might be entirely reasonable for your scenario.  To a large extent it probably depends on what your ops people and developers find most comfortable and cost effective in practice.

Best regards,
Jerry


From jdetreville at vmware.com  Thu Jan 13 23:51:42 2011
From: jdetreville at vmware.com (John DeTreville)
Date: Thu, 13 Jan 2011 15:51:42 -0800
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
	<20110113131223.GB2339@dakota.eng.vmware.com>
	<AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>
Message-ID: <293CE9DD-7911-448E-B4E5-99AAA321153C@vmware.com>

IIRC, there's no good reason that RabbitMQ uses bare hostnames instead of FQDNs. Bare hostnames are simply wired into the invoking shell scripts. We could presumably present an option to the user if that were important.

Cheers,
John DeTreville
RabbitMQ Pacific Rim Officeplex

From markjreed at gmail.com  Fri Jan 14 00:29:55 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Thu, 13 Jan 2011 19:29:55 -0500
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
	<20110113131223.GB2339@dakota.eng.vmware.com>
	<AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>
Message-ID: <AANLkTinfu-fatDNAsaChPv7RuBDQM=vrGRqNLAMmCn_K@mail.gmail.com>

OK, still can't seem to get this working reliably.

I was able to get a fresh install onto two servers to come up fine
clustered together.  Woot!

Tried to do the same thing with four servers and only the first one
comes up; the others complain about bad cookies in table definition.
If I'm interpreting the log output correctly (big if), each node
thinks it's in a cluster by itself; but they all have the same
rabbitmq_cluster.conf file listing all four nodes.  I purged the
rabbitmq-server install to make sure there wasn't any data lingering
around from a previous config, but it still doesn't work.  Sample
startup log below.  Any help appreciated.

Starting all nodes...
Starting node rabbit at rabbit2...

+---+   +---+
|   |   |   |
|   |   |   |
|   |   |   |
|   +---+   +-------+
|                   |
| RabbitMQ  +---+   |
|           |   |   |
|   v1.7.2  +---+   |
|                   |
+-------------------+
AMQP 8-0
Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies
LLC., and Rabb
 Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

node          : rabbit at rabbit2
app descriptor:
/usr/lib/rabbitmq/lib/rabbitmq_server-1.7.2/sbin/../ebin/rabbit.app
home dir      : /var/lib/rabbitmq
cookie hash   : aEuWObzDves/lfh1+WJREQ==
log           : /var/log/rabbitmq/rabbit.log
sasl log      : /var/log/rabbitmq/rabbit-sasl.log
database dir  : /var/lib/rabbitmq/mnesia/rabbit

starting internal event notification system                           ...done
starting logging server                                               ...done
starting database
...{"init ter
boot",{{nocatch,{error,{cannot_start_application,rabbit,{bad_return,{{rabbit,start,
EXIT',{{case_clause,{error,{unable_to_join_cluster,['rabbit at slurps1q1','rabbit at slur
rabbit1','rabbit at rabbit2'],{merge_schema_failed,"Bad cookie in table
definition rab
it at rabbit2 = {cstruct,rabbit_queue,set,[rabbit at rabbit2],[],[],0,read_write,[],[],fa
ame,durable,auto_delete,arguments,pid],[],[],{{1294,952761,578464},rabbit at rabbit2},
bbit at rabbit1 = {cstruct,rabbit_queue,set,[rabbit at rabbit1],[],[],0,read_write,[],[],
[name,durable,auto_delete,arguments,pid],[],[],{{1294,952575,443189},rabbit at rabbit1
"}}}},[{rabbit,'-run_boot_step/1-lc$^1/1-1-',1},{rabbit,run_boot_step,1},{rabbit,'-
-0-',1},{rabbit,start,2},{application_master,start_it_old,4}]}}}}}}},[{init,start_i
t_em,1}]}}

From moseley at hank.org  Fri Jan 14 00:42:42 2011
From: moseley at hank.org (Bill Moseley)
Date: Thu, 13 Jan 2011 16:42:42 -0800
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <AANLkTinfu-fatDNAsaChPv7RuBDQM=vrGRqNLAMmCn_K@mail.gmail.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
	<20110113131223.GB2339@dakota.eng.vmware.com>
	<AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>
	<AANLkTinfu-fatDNAsaChPv7RuBDQM=vrGRqNLAMmCn_K@mail.gmail.com>
Message-ID: <AANLkTi=CihFPYx=wP3yMhYXNac=3ertHxG30rKidLdzN@mail.gmail.com>

Mark,

Guessing, but did you copy the cookies to all machines in the cluster?

BTW -- I'm on an even older Ubuntu (9.10) and installing the 2.2.0 from the
deb on the download page was no problem.

On Thu, Jan 13, 2011 at 4:29 PM, Mark J. Reed <markjreed at gmail.com> wrote:

> OK, still can't seem to get this working reliably.
>
> I was able to get a fresh install onto two servers to come up fine
> clustered together.  Woot!
>
> Tried to do the same thing with four servers and only the first one
> comes up; the others complain about bad cookies in table definition.
> If I'm interpreting the log output correctly (big if), each node
> thinks it's in a cluster by itself; but they all have the same
> rabbitmq_cluster.conf file listing all four nodes.  I purged the
> rabbitmq-server install to make sure there wasn't any data lingering
> around from a previous config, but it still doesn't work.  Sample
> startup log below.  Any help appreciated.
>
> Starting all nodes...
> Starting node rabbit at rabbit2...
>
> +---+   +---+
> |   |   |   |
> |   |   |   |
> |   |   |   |
> |   +---+   +-------+
> |                   |
> | RabbitMQ  +---+   |
> |           |   |   |
> |   v1.7.2  +---+   |
> |                   |
> +-------------------+
> AMQP 8-0
> Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies
> LLC., and Rabb
>  Ltd.
> Licensed under the MPL.  See http://www.rabbitmq.com/
>
> node          : rabbit at rabbit2
> app descriptor:
> /usr/lib/rabbitmq/lib/rabbitmq_server-1.7.2/sbin/../ebin/rabbit.app
> home dir      : /var/lib/rabbitmq
> cookie hash   : aEuWObzDves/lfh1+WJREQ==
> log           : /var/log/rabbitmq/rabbit.log
> sasl log      : /var/log/rabbitmq/rabbit-sasl.log
> database dir  : /var/lib/rabbitmq/mnesia/rabbit
>
> starting internal event notification system
> ...done
> starting logging server
> ...done
> starting database
> ...{"init ter
>
> boot",{{nocatch,{error,{cannot_start_application,rabbit,{bad_return,{{rabbit,start,
> EXIT',{{case_clause,{error,{unable_to_join_cluster,['rabbit at slurps1q1
> ','rabbit at slur
> rabbit1','rabbit at rabbit2'],{merge_schema_failed,"Bad cookie in table
> definition rab
> it at rabbit2 = {cstruct,rabbit_queue,set,[rabbit at rabbit2
> ],[],[],0,read_write,[],[],fa
>
> ame,durable,auto_delete,arguments,pid],[],[],{{1294,952761,578464},rabbit at rabbit2
> },
> bbit at rabbit1 = {cstruct,rabbit_queue,set,[rabbit at rabbit1
> ],[],[],0,read_write,[],[],
>
> [name,durable,auto_delete,arguments,pid],[],[],{{1294,952575,443189},rabbit at rabbit1
>
> "}}}},[{rabbit,'-run_boot_step/1-lc$^1/1-1-',1},{rabbit,run_boot_step,1},{rabbit,'-
>
> -0-',1},{rabbit,start,2},{application_master,start_it_old,4}]}}}}}}},[{init,start_i
> t_em,1}]}}
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110113/0fd79fcb/attachment-0001.htm>

From techabc at gmail.com  Fri Jan 14 01:19:40 2011
From: techabc at gmail.com (techabc)
Date: Fri, 14 Jan 2011 09:19:40 +0800
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <yrv4c62ts7wg9.fsf@dwragg.eng.vmware.com>
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
	<AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
	<AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>
	<yrv4cpqs16nsc.fsf@dwragg.eng.vmware.com>
	<yrv4cei8h6mn2.fsf@dwragg.eng.vmware.com>
	<AANLkTi=LAa6ASYUi32aQnWXC647abS4rZz3zFyg1bN60@mail.gmail.com>
	<yrv4c62ts7wg9.fsf@dwragg.eng.vmware.com>
Message-ID: <AANLkTiknhtdvGn-XJJyQN+OV3FC00AUOuWnwierYfJ4X@mail.gmail.com>

well, my libtool version is 2.7, I install mingw with mingw's latest auto
installer.
Because, I try install-mingw.sh script failed due the tar utility.
I suggest the rabbitmq-c team use the sepecific version of mingw auto
installer instead of cygwin, It's very kindly for all people.

2011/1/13 David Wragg <david at rabbitmq.com>

> techabc <techabc at gmail.com> writes:
> > libtool: link:  cl.exe -o .libs\\rabbitmq-0.dll  .libs/amqp_mem.obj
> > .libs/amqp_t
> > able.obj .libs/amqp_connection.obj .libs/amqp_socket.obj
> .libs/amqp_api.obj
> > .lib
> > s/socket.obj .libs/amqp_framing.obj      ws2_32.lib
> > "@.libs\\rabbitmq-0.dll.exp"
> >  -Wl,-DLL,-IMPLIB:".libs\\rabbitmq.dll.lib"
> > Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 16.00.30319.01 for
> > 80x86
> > Copyright (C) Microsoft Corporation.  All rights reserved.
>
> I think you probably have the wrong version of libtool.  Please check
> that you have the right version of libtool, using 'libtool --version'.
> It should be 2.2.7a.
>
> Did you install the mingw packages using the install-mingw.sh script?
>
> David
>
> --
> David Wragg
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/e3517023/attachment.htm>

From david at rabbitmq.com  Fri Jan 14 01:56:11 2011
From: david at rabbitmq.com (David Wragg)
Date: Fri, 14 Jan 2011 01:56:11 +0000
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <AANLkTiknhtdvGn-XJJyQN+OV3FC00AUOuWnwierYfJ4X@mail.gmail.com>
	(techabc@gmail.com's message of "Fri, 14 Jan 2011 09:19:40 +0800")
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
	<AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
	<AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>
	<yrv4cpqs16nsc.fsf@dwragg.eng.vmware.com>
	<yrv4cei8h6mn2.fsf@dwragg.eng.vmware.com>
	<AANLkTi=LAa6ASYUi32aQnWXC647abS4rZz3zFyg1bN60@mail.gmail.com>
	<yrv4c62ts7wg9.fsf@dwragg.eng.vmware.com>
	<AANLkTiknhtdvGn-XJJyQN+OV3FC00AUOuWnwierYfJ4X@mail.gmail.com>
Message-ID: <yrv4clj2o5jus.fsf@dwragg.eng.vmware.com>

techabc <techabc at gmail.com> writes:
> well, my libtool version is 2.7, I install mingw with mingw's latest auto
> installer.
> Because, I try install-mingw.sh script failed due the tar utility.
> I suggest the rabbitmq-c team use the sepecific version of mingw auto
> installer instead of cygwin, It's very kindly for all people.

Interesting.  Until recently, the mingw installation instructions
recommended against using their own installer, as it had not been
updated in a long time.  But I see they did update it in November, and
go back to recommending its use.

It's probably not possible to make libtool 2.7 work.  We know that the
libtool support for building with the Microsoft tool chain is broken in
some libtool versions after 2.2.7.  Judging from the error you get, 2.7
is one of the versions where it is broken.  If you don't like this, you
may want to send your feedback to the libtool maintainers.

This is why the README.windows file says:

    [...] The GNU build tools have limited support for Microsoft
    toolchain, but the install-mingw.sh script will install versions of
    the packages that are known to be suitable.  In particular, only
    libtool version 2.2.7a is known to work; later versions have been
    reported to introduce problems.

You only need this mingw version while you build librabbitmq.  So you
can install it temporarily, do the build, and then delete it.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From karangill86 at gmail.com  Fri Jan 14 03:10:01 2011
From: karangill86 at gmail.com (karangill86)
Date: Thu, 13 Jan 2011 19:10:01 -0800 (PST)
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTikexmkkniqrcF6OpsXuHg9rTzw9HuKJcXi42Zi5@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
	<AANLkTikexmkkniqrcF6OpsXuHg9rTzw9HuKJcXi42Zi5@mail.gmail.com>
Message-ID: <ceae0212-2c4a-4be3-b04d-46d177b112b7@o14g2000yqe.googlegroups.com>

Is there is any Java method you can call from the API that would list
the message queues that exist?


On Jan 13, 12:55?pm, "Mark J. Reed" <markjr... at gmail.com> wrote:
> Thanks for the confirmation. ?I'm guessing the management plugin won't
> work with 1.7.2?
>
>
>
>
>
>
>
>
>
> On Thu, Jan 13, 2011 at 1:01 PM, Marek Majkowski <maje... at gmail.com> wrote:
> > No, you can't do it over AMQP.
>
> > Use rabbitmqctl list_queues or our management plugin.
>
> > Cheers,
> > ?Marek
>
> > On Thu, Jan 13, 2011 at 17:50, Mark J. Reed <markjr... at gmail.com> wrote:
> >> Perhaps off-topic, as it's more of an AMQP question than a
> >> Rabbit-specific one, but is there any way via AMQP to request a list
> >> of the queues that currently exist on the broker, so a remote client
> >> could get the same data as e.g. rabbitmqctl list_queues?
>
> >> --
> >> Mark J. Reed <markjr... at gmail.com>
> >> _______________________________________________
> >> rabbitmq-discuss mailing list
> >> rabbitmq-disc... at lists.rabbitmq.com
> >>https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
> --
> Mark J. Reed <markjr... at gmail.com>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From jerryk at vmware.com  Fri Jan 14 03:20:08 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Thu, 13 Jan 2011 19:20:08 -0800
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <ceae0212-2c4a-4be3-b04d-46d177b112b7@o14g2000yqe.googlegroups.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
	<AANLkTikexmkkniqrcF6OpsXuHg9rTzw9HuKJcXi42Zi5@mail.gmail.com>
	<ceae0212-2c4a-4be3-b04d-46d177b112b7@o14g2000yqe.googlegroups.com>
Message-ID: <E9F629DC-71CA-46BF-B936-B1744660C677@vmware.com>

There isn't, and the AMQP protocol doesn't support this operation, but you can do this using the management API exposed by the RabbitMQ management plugin. It exposes an HTTP API that your Java, or other language, applications in a web service-ish style. 

Please see:

http://www.rabbitmq.com/management.html

for additional information.  The management plugin is handy in a host of other ways as well. 

Best regards,
Jerry


Sent from my iPhone (Brevity and typos are hopefully the result of 1-fingered typing rather than rudeness or illiteracy).


On Jan 13, 2011, at 7:17 PM, "karangill86" <karangill86 at gmail.com> wrote:

> Is there is any Java method you can call from the API that would list
> the message queues that exist?
> 
> 
> On Jan 13, 12:55 pm, "Mark J. Reed" <markjr... at gmail.com> wrote:
>> Thanks for the confirmation.  I'm guessing the management plugin won't
>> work with 1.7.2?
>> 
>> 
>> 
>> 
>> 
>> 
>> 
>> 
>> 
>> On Thu, Jan 13, 2011 at 1:01 PM, Marek Majkowski <maje... at gmail.com> wrote:
>>> No, you can't do it over AMQP.
>> 
>>> Use rabbitmqctl list_queues or our management plugin.
>> 
>>> Cheers,
>>>  Marek
>> 
>>> On Thu, Jan 13, 2011 at 17:50, Mark J. Reed <markjr... at gmail.com> wrote:
>>>> Perhaps off-topic, as it's more of an AMQP question than a
>>>> Rabbit-specific one, but is there any way via AMQP to request a list
>>>> of the queues that currently exist on the broker, so a remote client
>>>> could get the same data as e.g. rabbitmqctl list_queues?
>> 
>>>> --
>>>> Mark J. Reed <markjr... at gmail.com>
>>>> _______________________________________________
>>>> rabbitmq-discuss mailing list
>>>> rabbitmq-disc... at lists.rabbitmq.com
>>>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>> 
>> --
>> Mark J. Reed <markjr... at gmail.com>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From techabc at gmail.com  Fri Jan 14 05:43:12 2011
From: techabc at gmail.com (techabc)
Date: Fri, 14 Jan 2011 13:43:12 +0800
Subject: [rabbitmq-discuss] Is there any mature C/C++ client for
	rabbitmq?
In-Reply-To: <yrv4clj2o5jus.fsf@dwragg.eng.vmware.com>
References: <tencent_0BCB958774C49336664C9567@qq.com>
	<yrv4cvd1vvh74.fsf@dwragg.eng.vmware.com>
	<AANLkTinqZGQT7SVs_19CA-8cR9qscK1RZVdzpX9d=OzV@mail.gmail.com>
	<yrv4chbdfvamo.fsf@dwragg.eng.vmware.com>
	<AANLkTi=1+RzaDDZ3L6mqOzRFfDeHRGojfD0BT0J7pNX5@mail.gmail.com>
	<AANLkTimSvRQ8Ow-jtnjGt71DPHm2gspe6uc4pXvzKVt4@mail.gmail.com>
	<yrv4cpqs16nsc.fsf@dwragg.eng.vmware.com>
	<yrv4cei8h6mn2.fsf@dwragg.eng.vmware.com>
	<AANLkTi=LAa6ASYUi32aQnWXC647abS4rZz3zFyg1bN60@mail.gmail.com>
	<yrv4c62ts7wg9.fsf@dwragg.eng.vmware.com>
	<AANLkTiknhtdvGn-XJJyQN+OV3FC00AUOuWnwierYfJ4X@mail.gmail.com>
	<yrv4clj2o5jus.fsf@dwragg.eng.vmware.com>
Message-ID: <AANLkTikSyzCAS_QVvOPSut0ESOKj+yfqY96xQZLroSd9@mail.gmail.com>

yes! when use libtool 2.2.7a according the readme.windows as you, I compiled
it successfully.
Thanks again.

2011/1/14 David Wragg <david at rabbitmq.com>

> techabc <techabc at gmail.com> writes:
> > well, my libtool version is 2.7, I install mingw with mingw's latest auto
> > installer.
> > Because, I try install-mingw.sh script failed due the tar utility.
> > I suggest the rabbitmq-c team use the sepecific version of mingw auto
> > installer instead of cygwin, It's very kindly for all people.
>
> Interesting.  Until recently, the mingw installation instructions
> recommended against using their own installer, as it had not been
> updated in a long time.  But I see they did update it in November, and
> go back to recommending its use.
>
> It's probably not possible to make libtool 2.7 work.  We know that the
> libtool support for building with the Microsoft tool chain is broken in
> some libtool versions after 2.2.7.  Judging from the error you get, 2.7
> is one of the versions where it is broken.  If you don't like this, you
> may want to send your feedback to the libtool maintainers.
>
> This is why the README.windows file says:
>
>    [...] The GNU build tools have limited support for Microsoft
>    toolchain, but the install-mingw.sh script will install versions of
>    the packages that are known to be suitable.  In particular, only
>    libtool version 2.2.7a is known to work; later versions have been
>    reported to introduce problems.
>
> You only need this mingw version while you build librabbitmq.  So you
> can install it temporarily, do the build, and then delete it.
>
> David
>
> --
> David Wragg
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/36c1f46f/attachment.htm>

From henrik at beepsend.se  Fri Jan 14 08:56:57 2011
From: henrik at beepsend.se (Henrik Abrahamsson)
Date: Fri, 14 Jan 2011 09:56:57 +0100
Subject: [rabbitmq-discuss] Execution hangs when redeclaring queue
In-Reply-To: <4D2F4DC5.6000508@rabbitmq.com>
References: <AANLkTimz3XKgCrXsd9BORxamawnTkG0_T15KA+JEh0Aw@mail.gmail.com>
	<20101222165254.GA22090@wellquite.org>
	<AANLkTikgMvtCw4FD9Qx_xn-p_9=_Jsp1eG4T6e4xQm6Y@mail.gmail.com>
	<4D2F4DC5.6000508@rabbitmq.com>
Message-ID: <AANLkTimvUqkn6=ZNA6cJfbCArz5+d8x2Hb2U42eneFcA@mail.gmail.com>

2011/1/13 Matthias Radestock <matthias at rabbitmq.com>

> Did you manage to resolve this? If not then it's possible you are running
> into some clustering related bugs which we discovered recently and have
> since fixed. You may want to try building the server from the latest sources
> in mercurial. Or wait for the next release.
>

I got a hint that it could be related to some bugs that were fixed in the
mercurial repo. So I built it from source and this made all my problems go
away. The problems I was seeing were probably caused by the clustering
related bugs you are talking about.

Thanks for the help

/Henrik
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/0071909b/attachment-0001.htm>

From minaev at gmail.com  Fri Jan 14 09:52:45 2011
From: minaev at gmail.com (Dmitri Minaev)
Date: Fri, 14 Jan 2011 12:52:45 +0300
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
Message-ID: <AANLkTi=mrDfiOH042jXo6+871qW1RWPEPYHaqBC7J2up@mail.gmail.com>

On Thu, Jan 13, 2011 at 9:01 PM, Marek Majkowski <majek04 at gmail.com> wrote:
>
> No, you can't do it over AMQP.
>
> Use rabbitmqctl list_queues or our management plugin.
>
> On Thu, Jan 13, 2011 at 17:50, Mark J. Reed <markjreed at gmail.com> wrote:
> > Perhaps off-topic, as it's more of an AMQP question than a
> > Rabbit-specific one, but is there any way via AMQP to request a list
> > of the queues that currently exist on the broker, so a remote client
> > could get the same data as e.g. rabbitmqctl list_queues?

Another option is using Erlang remote shell to call RabbitMQ's
exported function rabbit_amqqueue:info_all.

--
With best regards,
Dmitri Minaev

From majek04 at gmail.com  Fri Jan 14 11:05:11 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 14 Jan 2011 11:05:11 +0000
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <ceae0212-2c4a-4be3-b04d-46d177b112b7@o14g2000yqe.googlegroups.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
	<AANLkTikexmkkniqrcF6OpsXuHg9rTzw9HuKJcXi42Zi5@mail.gmail.com>
	<ceae0212-2c4a-4be3-b04d-46d177b112b7@o14g2000yqe.googlegroups.com>
Message-ID: <AANLkTinOrcL9O7XeBc3_t=et=smYwbrT_wmJ4d_06N6p@mail.gmail.com>

On Fri, Jan 14, 2011 at 03:10, karangill86 <karangill86 at gmail.com> wrote:
> Is there is any Java method you can call from the API that would list
> the message queues that exist?

No. But, as Jerry mentioned, there is a convenient Http API exposed by
management plugin:

http://hg.rabbitmq.com/rabbitmq-management/raw-file/137e87bb3852/priv/www-api/help.html

From markjreed at gmail.com  Fri Jan 14 12:21:14 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Fri, 14 Jan 2011 07:21:14 -0500
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <AANLkTi=CihFPYx=wP3yMhYXNac=3ertHxG30rKidLdzN@mail.gmail.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
	<20110113131223.GB2339@dakota.eng.vmware.com>
	<AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>
	<AANLkTinfu-fatDNAsaChPv7RuBDQM=vrGRqNLAMmCn_K@mail.gmail.com>
	<AANLkTi=CihFPYx=wP3yMhYXNac=3ertHxG30rKidLdzN@mail.gmail.com>
Message-ID: <AANLkTim-q0-1S_KJFazX-U--Wv9AbOow6O+JFB5R4zP5@mail.gmail.com>

They all have the same cookie file, yes.  That's not what it's
complaining about.. I'll see if upgrading helps..

On Thu, Jan 13, 2011 at 7:42 PM, Bill Moseley <moseley at hank.org> wrote:
> Mark,
> Guessing, but did you copy the cookies to all machines in the cluster?
> BTW -- I'm on an even older Ubuntu (9.10) and installing the 2.2.0 from the
> deb on the download page was no problem.

> On Thu, Jan 13, 2011 at 4:29 PM, Mark J. Reed <markjreed at gmail.com> wrote:
>>
>> OK, still can't seem to get this working reliably.
>>
>> I was able to get a fresh install onto two servers to come up fine
>> clustered together. ?Woot!
>>
>> Tried to do the same thing with four servers and only the first one
>> comes up; the others complain about bad cookies in table definition.
>> If I'm interpreting the log output correctly (big if), each node
>> thinks it's in a cluster by itself; but they all have the same
>> rabbitmq_cluster.conf file listing all four nodes. ?I purged the
>> rabbitmq-server install to make sure there wasn't any data lingering
>> around from a previous config, but it still doesn't work. ?Sample
>> startup log below. ?Any help appreciated.
>>
>> Starting all nodes...
>> Starting node rabbit at rabbit2...
>>
>> +---+ ? +---+
>> | ? | ? | ? |
>> | ? | ? | ? |
>> | ? | ? | ? |
>> | ? +---+ ? +-------+
>> | ? ? ? ? ? ? ? ? ? |
>> | RabbitMQ ?+---+ ? |
>> | ? ? ? ? ? | ? | ? |
>> | ? v1.7.2 ?+---+ ? |
>> | ? ? ? ? ? ? ? ? ? |
>> +-------------------+
>> AMQP 8-0
>> Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies
>> LLC., and Rabb
>> ?Ltd.
>> Licensed under the MPL. ?See http://www.rabbitmq.com/
>>
>> node ? ? ? ? ?: rabbit at rabbit2
>> app descriptor:
>> /usr/lib/rabbitmq/lib/rabbitmq_server-1.7.2/sbin/../ebin/rabbit.app
>> home dir ? ? ?: /var/lib/rabbitmq
>> cookie hash ? : aEuWObzDves/lfh1+WJREQ==
>> log ? ? ? ? ? : /var/log/rabbitmq/rabbit.log
>> sasl log ? ? ?: /var/log/rabbitmq/rabbit-sasl.log
>> database dir ?: /var/lib/rabbitmq/mnesia/rabbit
>>
>> starting internal event notification system
>> ...done
>> starting logging server
>> ...done
>> starting database
>> ...{"init ter
>>
>> boot",{{nocatch,{error,{cannot_start_application,rabbit,{bad_return,{{rabbit,start,
>>
>> EXIT',{{case_clause,{error,{unable_to_join_cluster,['rabbit at slurps1q1','rabbit at slur
>> rabbit1','rabbit at rabbit2'],{merge_schema_failed,"Bad cookie in table
>> definition rab
>> it at rabbit2 =
>> {cstruct,rabbit_queue,set,[rabbit at rabbit2],[],[],0,read_write,[],[],fa
>>
>> ame,durable,auto_delete,arguments,pid],[],[],{{1294,952761,578464},rabbit at rabbit2},
>> bbit at rabbit1 =
>> {cstruct,rabbit_queue,set,[rabbit at rabbit1],[],[],0,read_write,[],[],
>>
>> [name,durable,auto_delete,arguments,pid],[],[],{{1294,952575,443189},rabbit at rabbit1
>>
>> "}}}},[{rabbit,'-run_boot_step/1-lc$^1/1-1-',1},{rabbit,run_boot_step,1},{rabbit,'-
>>
>> -0-',1},{rabbit,start,2},{application_master,start_it_old,4}]}}}}}}},[{init,start_i
>> t_em,1}]}}
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
>
> --
> Bill Moseley
> moseley at hank.org
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>



-- 
Mark J. Reed <markjreed at gmail.com>

From markjreed at gmail.com  Fri Jan 14 12:31:40 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Fri, 14 Jan 2011 07:31:40 -0500
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTi=mrDfiOH042jXo6+871qW1RWPEPYHaqBC7J2up@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
	<AANLkTi=mrDfiOH042jXo6+871qW1RWPEPYHaqBC7J2up@mail.gmail.com>
Message-ID: <AANLkTikt5b5+GUFzHMY1wYEvWZwHAXe76WOCp33JyhbJ@mail.gmail.com>

On Fri, Jan 14, 2011 at 4:52 AM, Dmitri Minaev <minaev at gmail.com> wrote:
> Another option is using Erlang remote shell to call RabbitMQ's
> exported function rabbit_amqqueue:info_all.

Per http://www.rabbitmq.com/faq.html#server-api, "the Rabbit server
API is not designed for public consumption."

My understanding is that the RabbitMQ Erlang API is private, and not
meant to be used except by components of Rabbit itself.  So I'd rather
rely on something that's either standardized (like AMQP) or part of
the public API (like rabbitmqctl or the management plugin).

 --
Mark J. Reed <markjreed at gmail.com>

From simon at rabbitmq.com  Fri Jan 14 12:36:22 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Fri, 14 Jan 2011 12:36:22 +0000
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTikt5b5+GUFzHMY1wYEvWZwHAXe76WOCp33JyhbJ@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>	<AANLkTi=mrDfiOH042jXo6+871qW1RWPEPYHaqBC7J2up@mail.gmail.com>
	<AANLkTikt5b5+GUFzHMY1wYEvWZwHAXe76WOCp33JyhbJ@mail.gmail.com>
Message-ID: <4D304346.901@rabbitmq.com>

On 14/01/11 12:31, Mark J. Reed wrote:
> On Fri, Jan 14, 2011 at 4:52 AM, Dmitri Minaev<minaev at gmail.com>  wrote:
>> Another option is using Erlang remote shell to call RabbitMQ's
>> exported function rabbit_amqqueue:info_all.
>
> Per http://www.rabbitmq.com/faq.html#server-api, "the Rabbit server
> API is not designed for public consumption."
>
> My understanding is that the RabbitMQ Erlang API is private, and not
> meant to be used except by components of Rabbit itself.  So I'd rather
> rely on something that's either standardized (like AMQP) or part of
> the public API (like rabbitmqctl or the management plugin).

This is a good idea. We don't promise that rabbitmqctl or the management 
plugin won't change ever, but we try to avoid it and the change rate 
tends to be low. On the other hand internal APIs change all the time.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From matthew at rabbitmq.com  Fri Jan 14 12:38:00 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Fri, 14 Jan 2011 12:38:00 +0000
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTikt5b5+GUFzHMY1wYEvWZwHAXe76WOCp33JyhbJ@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
	<AANLkTi=mrDfiOH042jXo6+871qW1RWPEPYHaqBC7J2up@mail.gmail.com>
	<AANLkTikt5b5+GUFzHMY1wYEvWZwHAXe76WOCp33JyhbJ@mail.gmail.com>
Message-ID: <20110114123800.GD18402@rabbitmq.com>

On Fri, Jan 14, 2011 at 07:31:40AM -0500, Mark J. Reed wrote:
> On Fri, Jan 14, 2011 at 4:52 AM, Dmitri Minaev <minaev at gmail.com> wrote:
> > Another option is using Erlang remote shell to call RabbitMQ's
> > exported function rabbit_amqqueue:info_all.
> 
> Per http://www.rabbitmq.com/faq.html#server-api, "the Rabbit server
> API is not designed for public consumption."
> 
> My understanding is that the RabbitMQ Erlang API is private, and not
> meant to be used except by components of Rabbit itself.  So I'd rather
> rely on something that's either standardized (like AMQP) or part of
> the public API (like rabbitmqctl or the management plugin).

Absolutely - we make zero guarantees about changing such internal APIs
and you are not recommended to rely on them.

Matthew

From markjreed at gmail.com  Fri Jan 14 14:07:06 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Fri, 14 Jan 2011 09:07:06 -0500
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <AANLkTim-q0-1S_KJFazX-U--Wv9AbOow6O+JFB5R4zP5@mail.gmail.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
	<20110113131223.GB2339@dakota.eng.vmware.com>
	<AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>
	<AANLkTinfu-fatDNAsaChPv7RuBDQM=vrGRqNLAMmCn_K@mail.gmail.com>
	<AANLkTi=CihFPYx=wP3yMhYXNac=3ertHxG30rKidLdzN@mail.gmail.com>
	<AANLkTim-q0-1S_KJFazX-U--Wv9AbOow6O+JFB5R4zP5@mail.gmail.com>
Message-ID: <AANLkTikeqCDq9gpdekuDKM4N_UjSL_FR81+twR1R4D1b@mail.gmail.com>

OK, I'm having better luck with 2.2.   But I still have a few
instances where one node can't talk to another, even though TCP
connectivity is there.  Any help diagnosing those?

rabbit1$ rabbitmqctl status
Status of node rabbit at rabbit1 ...
[{running_applications,[{rabbit,"RabbitMQ","2.2.0"},
                        {mnesia,"MNESIA  CXC 138 12","4.4.12"},
                        {os_mon,"CPO  CXC 138 46","2.2.4"},
                        {sasl,"SASL  CXC 138 11","2.1.8"},
                        {stdlib,"ERTS  CXC 138 10","1.16.4"},
                        {kernel,"ERTS  CXC 138 10","2.13.4"}]},
 {nodes,[{disc,[rabbit at rabbit1]}]},
 {running_nodes,[rabbit at rabbit1]}]
...done.

rabbit1$ rabbitmqctl -n rabbit at rabbit2 status  # 1 can see 2
Status of node rabbit at rabbit2 ...
[{running_applications,[{rabbit,"RabbitMQ","2.2.0"},
                        {mnesia,"MNESIA  CXC 138 12","4.4.12"},
                        {os_mon,"CPO  CXC 138 46","2.2.4"},
                        {sasl,"SASL  CXC 138 11","2.1.8"},
                        {stdlib,"ERTS  CXC 138 10","1.16.4"},
                        {kernel,"ERTS  CXC 138 10","2.13.4"}]},
 {nodes,[{disc,[rabbit at rabbit2]}]},
 {running_nodes,[rabbit at rabbit2]}]
...done.


rabbit2$ rabbitmqctl -n rabbit at rabbit1  # but 2 can't connect to 1
Status of node slurp at rabbit1 ...
Error: unable to connect to node slurp at slurpp1refq1: nodedown
diagnostics:
- nodes and their ports on slurpp1refq1: [{rabbit,12635}]
- current node: rabbitmqctl7085 at slurpp1refw1
- current node home dir: /var/lib/rabbitmq
- current node cookie hash: aEuWObzDves/lfh1+WJREQ==

rabbit2$ telnet rabbit1 5672
Trying 10.1.2.3...
Connected to rabbit1.my.domain.
Escape character is '^]'.
Connection closed by foreign host.
rabbit2$

From minaev at gmail.com  Fri Jan 14 14:07:59 2011
From: minaev at gmail.com (Dmitri Minaev)
Date: Fri, 14 Jan 2011 17:07:59 +0300
Subject: [rabbitmq-discuss] List queues via AMQP?
In-Reply-To: <AANLkTikt5b5+GUFzHMY1wYEvWZwHAXe76WOCp33JyhbJ@mail.gmail.com>
References: <AANLkTi=DNGTkT4OZH9AHW=LL=bSGAUiR5XNVCaQetFBK@mail.gmail.com>
	<AANLkTi=9BaDm=u=rrN1shUvCoqSWWsxOBR4rZzz5i3Z2@mail.gmail.com>
	<AANLkTi=mrDfiOH042jXo6+871qW1RWPEPYHaqBC7J2up@mail.gmail.com>
	<AANLkTikt5b5+GUFzHMY1wYEvWZwHAXe76WOCp33JyhbJ@mail.gmail.com>
Message-ID: <AANLkTik_nYAyEaKTT1AFKDOMkOXEigxgVks=k2jTkJUt@mail.gmail.com>

On Fri, Jan 14, 2011 at 3:31 PM, Mark J. Reed <markjreed at gmail.com> wrote:
> On Fri, Jan 14, 2011 at 4:52 AM, Dmitri Minaev <minaev at gmail.com> wrote:
>> Another option is using Erlang remote shell to call RabbitMQ's
>> exported function rabbit_amqqueue:info_all.
>
> Per http://www.rabbitmq.com/faq.html#server-api, "the Rabbit server
> API is not designed for public consumption."

Sure, but as it often happens, internal API discloses a bit more
information than the right way does. info_all displays pid, memory,
messages stats and queue properties. Definitely not the information
source you should rely on, but an informative one :)

-- 
With best regards,
Dmitri Minaev

From markjreed at gmail.com  Fri Jan 14 14:58:11 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Fri, 14 Jan 2011 09:58:11 -0500
Subject: [rabbitmq-discuss] Distributing clients across a cluster
Message-ID: <AANLkTim_vXKJLp6CwsbanWTmBec9UYYGE5xOKVLidH3S@mail.gmail.com>

What do you all do to distribute activity across a cluster?  That is,
given a cluster of rabbitmq brokers and a group of client applications
that each expect to be configured to talk to a single broker, what do
I do?

1. Stand up TCP load-balancer in front of the cluster?
2. Assign a cluster node to each client pseudo-randomly?
3. Set up each client host as an additional rabbitmq broker and point
the applications at localhost?

The recommendation I got from a colleague was #3, but I've had some
trouble getting servers to cluster together when they have different
opinions about the overall set of hosts in the cluster.

I found a couple threads (e.g.
http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-July/008124.html)
that pose similar questions, but no clear (to me) guidance; I guess I
still don't fully grok the AMQP Way.

Any recommendations appreciated.

-- 
Mark J. Reed <markjreed at gmail.com>

From moseley at hank.org  Fri Jan 14 15:01:06 2011
From: moseley at hank.org (Bill Moseley)
Date: Fri, 14 Jan 2011 07:01:06 -0800
Subject: [rabbitmq-discuss] Node hung and not responding to rabbitmqctl
Message-ID: <AANLkTikJqw-js4DyEjh82Vmd7+uRRvh9OieTEtZvDFtZ@mail.gmail.com>

I've been working with clustering (on a single test machine) and I stopped
the 2nd RAM node w/o problem but now the initial disk node seems
unresponsive.  All of the rabbitmqctl commands hang.   Initially, connecting
to the node would also hang, but not Rabbit doesn't seem to be listening to
the port any more.


$ sudo rabbitmqctl stop_app
Stopping node rabbit at bumby2 ...


After a few minutes I abort and "k" for kill and get the following:

^C
BREAK: (a)bort (c)ontinue (p)roc info (i)nfo (l)oaded
       (v)ersion (k)ill (D)b-tables (d)istribution

k

Process Information

--------------------------------------------------
=proc:<0.38.0>
State: Waiting
Name: inet_gethost_native
Spawned as: inet_gethost_native:server_init/2
Spawned by: <0.37.0>
Started: Fri Jan 14 06:38:10 2011
Message queue length: 0
Number of heap fragments: 0
Heap fragment data: 0
Link list: [#Port<0.288>, <0.37.0>]
Dictionary: [{rid,1},{num_requests,0}]
Reductions: 64
Stack+heap: 233
OldHeap: 0
Heap unused: 190
OldHeap unused: 0
Stack dump:
Program counter: 0xb771c718 (inet_gethost_native:main_loop/1 + 20)
CP: 0x00000000 (invalid)
arity = 0

0xb74eeecc Return addr 0x08201594 (<terminate process normally>)
y(0)
{state,#Port<0.288>,8000,12302,16399,<0.37.0>,4,{statistics,0,0,0,0,0,0,0,0}}
(k)ill (n)ext (r)eturn:

Seems to be a lot of these hanging around:


$ ps auxf | grep gethost
rabbitmq  3700  0.0  0.0   1868   436 ?        Ss   Jan13   0:00  \_
inet_gethost 4
rabbitmq  3701  0.0  0.0   1916   540 ?        S    Jan13   0:00  |   \_
inet_gethost 4
rabbitmq  3995  0.0  0.0   1868   436 ?        Ss   Jan13   0:00  \_
inet_gethost 4
rabbitmq  3996  0.0  0.0   1916   536 ?        S    Jan13   0:00      \_
inet_gethost 4
rabbitmq  4370  0.0  0.0   1868   432 ?        Ss   Jan13   0:00  \_
inet_gethost 4
rabbitmq  4371  0.0  0.0   1916   536 ?        S    Jan13   0:00      \_
inet_gethost 4


And logs:

=WARNING REPORT==== 13-Jan-2011::21:39:43 ===
exception on TCP connection <0.30329.54> from 127.0.0.1:50222
connection_closed_abruptly

=INFO REPORT==== 13-Jan-2011::21:39:43 ===
closing TCP connection <0.30329.54> from 127.0.0.1:50222

=ERROR REPORT==== 14-Jan-2011::06:39:16 ===
** Node rabbitmqctl7173 at bumby2 not responding **
** Removing (timedout) connection **



Ubuntu Erlang1:13.b.1-dfsg-2ubuntu1.1 / RabbitMQ 2.2.0-1

Are there any docs that describe debugging techniques for those of us that
have no Erlang experience?   I'm not even sure what to kill -9 if I had to.
;)

-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/8adc523a/attachment.htm>

From moseley at hank.org  Fri Jan 14 15:57:29 2011
From: moseley at hank.org (Bill Moseley)
Date: Fri, 14 Jan 2011 07:57:29 -0800
Subject: [rabbitmq-discuss] Distributing clients across a cluster
In-Reply-To: <AANLkTim_vXKJLp6CwsbanWTmBec9UYYGE5xOKVLidH3S@mail.gmail.com>
References: <AANLkTim_vXKJLp6CwsbanWTmBec9UYYGE5xOKVLidH3S@mail.gmail.com>
Message-ID: <AANLkTikh=bi=A4cSeX2zwo+sKRyo52EHgxu=VQ+dH8Hx@mail.gmail.com>

On Fri, Jan 14, 2011 at 6:58 AM, Mark J. Reed <markjreed at gmail.com> wrote:

> What do you all do to distribute activity across a cluster?  That is,
> given a cluster of rabbitmq brokers and a group of client applications
> that each expect to be configured to talk to a single broker, what do
> I do?
>
> 1. Stand up TCP load-balancer in front of the cluster?
> 2. Assign a cluster node to each client pseudo-randomly?
> 3. Set up each client host as an additional rabbitmq broker and point
> the applications at localhost?
>

I've been spending a lot of time looking for the same answers.  Is there
documentation on actual hardware configuration and management of servers in
a production environment?

To me, it is important that producers (web processes in my case) can always
talk to a broker.  So, I've been looking at #1 with two HAProxy servers (one
as fail-over with Heartbeat) in front of a cluster of nodes.  Only partial
success with that so far.

On the same topic, I'm also curious how clients are suppose to behave.  If I
have workers listening on a queue how should they handle a network failure?
 Do any of the clients manage reconnecting on error?

BTW -- I also looked at the HA docs at
http://www.rabbitmq.com/pacemaker.html -- but that's replicating queue data,
correct? Is there a need for DRDB if willing to accept loss of messages?




-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/3d00d066/attachment.htm>

From matthew at rabbitmq.com  Fri Jan 14 16:00:24 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Fri, 14 Jan 2011 16:00:24 +0000
Subject: [rabbitmq-discuss] RabbitMQ Test case - Possible Memory Leak
 problem
In-Reply-To: <AANLkTimgA6tNpstggKpeKTj2yUC+xdWGpuAD+CvYP9jq@mail.gmail.com>
References: <AANLkTimgA6tNpstggKpeKTj2yUC+xdWGpuAD+CvYP9jq@mail.gmail.com>
Message-ID: <20110114160023.GE18402@rabbitmq.com>

Hi,

On Tue, Jan 11, 2011 at 12:44:54PM +0100, Crisoforo Seccia wrote:
> . Am I adopting a very strange test case which is not well handled by
> RabbitMQ?

Not really, no. However, there are problems with RabbitMQ under Windows,
and you may have to do some tweaking of the configuration. The fact that
you crashed on an eheap allocation suggests that Rabbit tried to
allocate memory that Windows refused it.
http://www.rabbitmq.com/extensions.html#memsup

Rabbit by default assumes that it's the only application running on a
machine, and thus it can expect to be allocated all memory. You may
wish, as suggested in the above page, to try reducing the
vm_memory_high_watermark and repeat the tests.

> . Is there any connection with the solved bug described in the RabbitMQ 2.2
> release notes (?fix memory leak when long-running channels consume and
> cancel on many queues?)?

Nope - that bug would have likely taken months of constant tripping to
actually result in any sizable memory leak.

> . How does RabbitMQ handle message flooding? As stated in ActiveMQ official
> page, the flow control, in the current version means that: ?if the broker
> detects that the memory limit for the destination, or the temp- or
> file-store limits for the broker, have been exceeded, then the flow of
> messages can be slowed down. The producer will be either blocked until
> resources are available or will receive a JMSException?.

Again, the above link will explain it all, but in short, Rabbit uses TCP
back pressure to prevent producers flooding it with too many messages.
Ultimately, you're always limited by the rate at which you can get rid
of messages - whether to clients or to disk. In effect, RAM just acts as
a huge (hopefully!) buffer.

Matthew

From matthew at rabbitmq.com  Fri Jan 14 16:20:24 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Fri, 14 Jan 2011 16:20:24 +0000
Subject: [rabbitmq-discuss] HA between data centers
In-Reply-To: <AANLkTi=s2=M-V_aH-QpMU8Me3fsHBXcbxnTx0O_ZdhSe@mail.gmail.com>
References: <AANLkTi=s2=M-V_aH-QpMU8Me3fsHBXcbxnTx0O_ZdhSe@mail.gmail.com>
Message-ID: <20110114162024.GF18402@rabbitmq.com>

Hi Bill,

On Tue, Jan 11, 2011 at 07:57:19PM -0800, Bill Moseley wrote:
> The High Availablity docs at http://www.rabbitmq.com/pacemaker.html seem
> pretty thorough.  Are there any other approaches commonly used for HA? What
> about for syncing between data centers? Can anyone discuss their HA approach
> if it differs from the link above?

There are a couple of other things to mention. One is that work is
currently been done on active/active HA, but that will provide
"mirrored" queues (think RAID-1) within a cluster only. The other thing
to mention is the shovel plugin, which can be used for a very
rudimentary form of federation between different brokers. The main
limitation with the shovel though is that its configuration can't be
dynamically changed, so it's only really a sensible solution if you're
topology is mainly static.

> We are evaluating messaging systems and the question of HA has come up
> frequently.  The concern is that some items, once entered onto the queue,
> should never be lost -- even if the entire data center goes down.

Right, but is that "lost" as in "provided it's stored on disk, that's
ok, even if it takes us a month to get the data back off disk", or is it
"lost" as it "must always be (near) instantly available"?

> We are comparing RabbitMQ with writing a system in-house.  The in-house
> queue system would use a Postgresql table for the queue with replication
> (currently via Slony) for hot-backup (it's not really HA).  We also
> replicate to a secondary data center with the eventual goal of reasonably
> fast tip-over between data centers.  We are not in the financial or medical
> industry so nobody's life is at risk if we drop a few jobs.  I suspect we
> only need to handle three to five million message a day -- nothing too big.
>  (Oddly, one argument against using RabbitMQ was it was overkill for our
> needs.)

Yeah, rather obviously, we're somewhat biased against building message
brokers on top of databases ;) I guess the things I'd suggest you look
as is whilst you may be fine with postgres at the moment, what happens
in a couple of years time? What will your messaging requirements be
then, and will you have sufficient flexibility in your home-grown system
to be able to cope with those needs?

> Postgresql and replication is what we use for application data currently, so
> it is a familiar technology for us.  Another reason we are considering
> building a custom message queue system is to put more functionality into the
> broker -- such as scheduling and job routing that would be specific to our
> business.  And there's fear that nobody knows Erlang if something broke and
> we needed to try and resolve.

Sure, those are valid concerns. There are ways of extending the
functionality of Rabbit, for example through exchange types, or even
custom plugins, but these do normally require writing in Erlang.

> My opinion is AMQP is very flexible and we should be able to make it meet
> our needs.  We are not doing anything that unusual.  And I suspect building
> something as reliable as RabbitMQ is no easy task -- especially if the point
> is to make a system more complex than what RabbitMQ provides.  Scheduling,
> for example, seems like something a simple database table and cron could
> solve easily with RabbitMQ.

Indeed - use the right tool for the job etc. Job scheduling and such are
probably on the boundary of what we consider pure messaging, and so it
does normally require additional client-side applications to add to
Rabbit to provide such functionality. You might like to look at celery
in this space which does job scheduling on top of Rabbit.

> Another argument for a custom broker was to make better use of workers --
> i.e. the broker would look at load and other factors when determining where
> to send jobs.  My feeling here is resources are limited so it's a matter of
> balancing the number and type of consumers with queue load -- and an
> external process can manage starting and stopping consumers easily as demand
> profile changes (by looking at queue sizes and rates) without having to be
> part of the broker.  Are there common approaches for dynamically adjusting
> workers?

I suspect that's something that falls squarely in the remit of tools
like celery. It's definitely outside the scope of Rabbit itself.

Matthew

From matthew at rabbitmq.com  Fri Jan 14 16:25:40 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Fri, 14 Jan 2011 16:25:40 +0000
Subject: [rabbitmq-discuss] Load Balancing among Producers (devices) and
 Messaging Server ( Apache Qpid or RabbitMQ )
In-Reply-To: <AANLkTimfkOubf8PsQAE-+X_Jnt3Ayn+=pFysgSnBLCaK@mail.gmail.com>
References: <AANLkTimfkOubf8PsQAE-+X_Jnt3Ayn+=pFysgSnBLCaK@mail.gmail.com>
Message-ID: <20110114162539.GG18402@rabbitmq.com>

On Wed, Jan 12, 2011 at 04:42:19PM +0900, Sumit Arora wrote:
> -- >> Is there a way , or some experiments or anything which can provide
> some thing to choose either RabbitMQ or Apache Qpid ?

Yes - the tests and benchmarks that you write yourself will tell you
more than anything else you come across. There don't seem to be too many
recent studies, and you may come across
http://wiki.secondlife.com/wiki/Message_Queue_Evaluation_Notes#Apache_QPID.2FRed_Hat_MRG
which is rather out of date and many of the issues raised there have
since been fixed. (Sadly, they've not recorded which version of Rabbit
they were testing against, but I suspect it was a 1.7 or 1.8 series.)

> -- >> My Overall requirement is related with Load Balancing, as my project
> expects millions of devices connected to Messaging server -- later Messaging
> data to be relayed and major confusion at this time to Select Apache Qpid or
> RabbitMQ, and to me both looks same

If your issue is simply managing connections then any sort of bog
standard TCP load balancer sitting in front of a cluster of RabbitMQ
servers will do the job nicely.

Matthew

From matthew at rabbitmq.com  Fri Jan 14 16:27:25 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Fri, 14 Jan 2011 16:27:25 +0000
Subject: [rabbitmq-discuss] RabbitMQ 2.0 broker crashes
In-Reply-To: <11156081.394.1294839513743.JavaMail.geo-discussion-forums@vbyc22>
References: <20110112113218.GA18402@rabbitmq.com>
	<11156081.394.1294839513743.JavaMail.geo-discussion-forums@vbyc22>
Message-ID: <20110114162724.GH18402@rabbitmq.com>

Hi,

On Wed, Jan 12, 2011 at 05:38:33AM -0800, gus27 wrote:
> Thank you for your prompt reply. Those are very good news. We'll be looking 
> forward to trying the new release as soon as it's available.

There is now an experimental fix for this. You'll have to build from
source and you'll need to be on branch bug23631

http://www.rabbitmq.com/build-server.html
and then before the "make" step, do a "hg up -C bug23631"

Note it is experimental. Reports of success or failure are welcome!

Matthew

From msteele at beringmedia.com  Fri Jan 14 17:06:28 2011
From: msteele at beringmedia.com (Mark Steele)
Date: Fri, 14 Jan 2011 12:06:28 -0500
Subject: [rabbitmq-discuss] Different storage engines... Bitcask?
Message-ID: <AANLkTinKjypxa8qdMrQH0Fz7BHWPGXBcXqF16xs1LG1y@mail.gmail.com>

Just throwing this out there, anyone at rabbit looked into bitcask as a
storage backend for rabbit? (http://www.basho.com/)

Cheers,

Mark Steele
Bering Media Inc.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/6bee4104/attachment.htm>

From matthew at rabbitmq.com  Fri Jan 14 17:08:32 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Fri, 14 Jan 2011 17:08:32 +0000
Subject: [rabbitmq-discuss] Are queues replicated across a cluster?
In-Reply-To: <AANLkTik6DTYcEVy+MtiaQ7k397zkCepeRb1TG8+r0snR@mail.gmail.com>
References: <AANLkTik6DTYcEVy+MtiaQ7k397zkCepeRb1TG8+r0snR@mail.gmail.com>
Message-ID: <20110114170832.GI18402@rabbitmq.com>

Hi Bill,

On Thu, Jan 13, 2011 at 06:42:19AM -0800, Bill Moseley wrote:
> I don't understand that sentence that says the queues only reside on the
> node that created them -- but they are visible on both.  Is that talking
> about replicating *messages* or queues?  Queues and messages are separate
> things.  I understand that messages are not duplicated/replicated in the
> cluster.

Within a cluster, the fact that a queue exists or not is recorded in a
distributed Erlang database, called mnesia. Thus all nodes within the
cluster know that a particular queue exists. Each queue however, only
exists on a single node. I.e. only one node will receive the messages
for that queue, and if that node goes down then the queue, and the
messages it contains, become unavailable.

The fact that the queue's existence is known to all nodes means that any
node that needs to route a message to said queue will be able to do so.

> What's the distinction between "residing" and "visible"?  Does it mean the
> messages are only stored on node1 until consumed (by either node)?

Yes, precisely.

> But, I
> can declare the same queue on both nodes and see the same behavior.  Can
> someone please clear this up for me?

The second declaration is really just an assertion that the queue
exists. Thus the queue will be created on the node to which the
connection which first issues the queue declaration is connected.

> What I have failed to find when reading about clustering is how to connect
> to the nodes in a cluster.  If I have node1 and node2 in my cluster and 10
> producers (say web servers) and 4 worker machines do I configure 5 producers
> to connect to node1 and 5 to node2, and then likewise split the consumer
> connections across the two nodes?

Entirely up to you - resources are visible throughout the cluster and so
any sane load balancing should be just fine. If they all connect to the
same node then you'll likely find that all resources exist solely on
that node and thus the other nodes are not being used at all. Thus
really, you want to make sure that the clients which create resources
(queues in particular) are connected across all the nodes.

The other thing to consider is the inter-node hops required to route
messages. Thus you may wish to make sure that if client 1 is
predominantly sending messages to or consuming messages from queue 1,
that client 1 is connected to the same node on which queue 1 resides.

> To be clear, this is not HA.  So, if node1 fails then 1/2 the producers and
> 1/2 the consumers can no longer function.  Correct?

Well, as explained, it depends where the queues reside, but yes, you
will likely lose some resources, and all the clients connected to the
failed node will need to reconnect to a surviving node.

> Or is the typical approach to use something like HAProxy in front of node1
> and node2 and have all consumers and producers connect to HAProxy?  (That
> ends up as a single point of failure.)

Yup, indeed. Though obviously with enough magic hackery you can even
remove the SPoF with something like an HAProxy. But it does depend on
your precise performance requirements etc.

Matthew

From matthew at rabbitmq.com  Fri Jan 14 17:13:08 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Fri, 14 Jan 2011 17:13:08 +0000
Subject: [rabbitmq-discuss] Distributing clients across a cluster
In-Reply-To: <AANLkTikh=bi=A4cSeX2zwo+sKRyo52EHgxu=VQ+dH8Hx@mail.gmail.com>
References: <AANLkTim_vXKJLp6CwsbanWTmBec9UYYGE5xOKVLidH3S@mail.gmail.com>
	<AANLkTikh=bi=A4cSeX2zwo+sKRyo52EHgxu=VQ+dH8Hx@mail.gmail.com>
Message-ID: <20110114171308.GJ18402@rabbitmq.com>

On Fri, Jan 14, 2011 at 07:57:29AM -0800, Bill Moseley wrote:
> On the same topic, I'm also curious how clients are suppose to behave.  If I
> have workers listening on a queue how should they handle a network failure?
>  Do any of the clients manage reconnecting on error?

Not out of the box, no, but then I think things like Spring-AMQP have
this functionality, or something close to it. You should be able to
fairly easily get notifications back from the client library when the
connection drops in all of our clients, so at that point, reconnect and
ensure any resources you need do exist.

> BTW -- I also looked at the HA docs at
> http://www.rabbitmq.com/pacemaker.html -- but that's replicating queue data,
> correct? Is there a need for DRDB if willing to accept loss of messages?

If you're simply looking for availability of service then a Rabbit
cluster is likely your best bet. The pacemaker stuff is really only
necessary if you want to work towards not losing any messages in the
event of a failure.

Matthew

From markjreed at gmail.com  Fri Jan 14 17:57:47 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Fri, 14 Jan 2011 12:57:47 -0500
Subject: [rabbitmq-discuss] Undefined errors on management interface
Message-ID: <AANLkTim7f6-_u3kNdi6QRxfT7aTR4Msi=aHbnV+OPqs2@mail.gmail.com>

OK, now that I'm on 2.2.0, I set up the management plugin set
(amqp_client, mochiweb, rabbitmq-management,
rabbitmq-management-agent, rabbitmq-mochiweb, and webmachine).  But
when I go to http://rabbit1:55672/mgmt/#/, I get "TypeError: Cannot
read property 'messages_ready' of undefined.".

If I go to the queues tab, I get a list of queues, but the message
counts are all question marks, and the same message appears below the
table.

Permissions issue?   Something else I should look at?

-- 
Mark J. Reed <markjreed at gmail.com>

From justin at basho.com  Fri Jan 14 18:16:09 2011
From: justin at basho.com (Justin Sheehy)
Date: Fri, 14 Jan 2011 13:16:09 -0500
Subject: [rabbitmq-discuss] Different storage engines... Bitcask?
In-Reply-To: <AANLkTinGg-KaKZo-He_deA9Zf=GtL3uxWFZFUYGpiMZG@mail.gmail.com>
References: <AANLkTinKjypxa8qdMrQH0Fz7BHWPGXBcXqF16xs1LG1y@mail.gmail.com>
	<AANLkTinGg-KaKZo-He_deA9Zf=GtL3uxWFZFUYGpiMZG@mail.gmail.com>
Message-ID: <AANLkTi=myXUfYm_1hW0z3icgtipPtrAdVh15q7cOA+nu@mail.gmail.com>

Mark Steele <msteele at beringmedia.com> wrote:

> Just throwing this out there, anyone at rabbit looked into bitcask as a
> storage backend for rabbit? (http://www.basho.com/)

I'm the wrong person to decide if it's the right fit for Rabbit, but
if anyone starts to explore this I would be happy to assist from the
Bitcask side.

-Justin

From parki at whatevernot.com  Fri Jan 14 19:38:03 2011
From: parki at whatevernot.com (Brian Parkinson)
Date: Fri, 14 Jan 2011 14:38:03 -0500
Subject: [rabbitmq-discuss] Cannot start cluster?
Message-ID: <D45FF3C1-7FF3-41B5-A3D4-7906E82A6848@whatevernot.com>

Hello - starting to play with clustering - I am using Rabbit 2.2.0 on Mac.

Running one server (either by 'rabbit-server' or 'rabbit-multi start_all 1') works fine. Trying to start a cluster with 2 nodes fails - see output below.

1. Any ideas?

2. A quick question/confirmation about a cluster. Assume I have a 2-node cluster running, and my client app connects via a ConnectionFactory pointing at host/port of node1. If node1 then goes down, will my client app continue to talk to node2?

Many thanks - appreciated as always.

Cheers,

brian...

--- x8 snip

% sudo /opt/local/sbin/rabbitmq-multi start_all 2
....
broker running
** Found 0 name clashes in code paths 
OK
Starting node rabbit_1 at torparki...
Activating RabbitMQ plugins ...
*WARNING* Undefined function fdsrv:bind_socket/2
*WARNING* Undefined function fdsrv:start/0
*WARNING* Undefined function fdsrv:stop/0
*WARNING* Undefined function webmachine_resource:start_link/2
6 plugins activated:
* amqp_client-2.2.0
* mochiweb-1.3
* rabbit_management-2.2.0
* rabbit_management_agent-2.2.0
* rabbit_mochiweb-2.2.0
* webmachine-1.7.0

{"Kernel pid terminated",application_controller,"{application_start_failure,rabbit_mochiweb,{shutdown,{rabbit_mochiweb_app,start,[normal,[]]}}}"}
Error: {node_start_failed,normal}
torparki:~ parki$ 
Crash dump was written to: erl_crash.dump
Kernel pid terminated (application_controller) ({application_start_failure,rabbit_mochiweb,{shutdown,{rabbit_mochiweb_app,start,[normal,[]]}}})

torparki:~ parki$ sudo /opt/local/sbin/rabbitmq-multi status
Status of all running nodes...
Error: no_nodes_running



From moseley at hank.org  Fri Jan 14 19:51:58 2011
From: moseley at hank.org (Bill Moseley)
Date: Fri, 14 Jan 2011 11:51:58 -0800
Subject: [rabbitmq-discuss] HA between data centers
In-Reply-To: <20110114162024.GF18402@rabbitmq.com>
References: <AANLkTi=s2=M-V_aH-QpMU8Me3fsHBXcbxnTx0O_ZdhSe@mail.gmail.com>
	<20110114162024.GF18402@rabbitmq.com>
Message-ID: <AANLkTik7zq60GQE0ju87M1EKG0fGEhDTAFNTAgAHyK=r@mail.gmail.com>

Matthew, thanks very much for your comments.  I'll just add a brief top-post
note:

After posting the message below and reading your remarks my thinking is a
better design is to just not depend on messages never being "lost". (By lost
I was probably thinking once published that they would be consumed in a few
minutes of time regardless of a server failure.)

If we design with the knowledge that a message could be lost and thus be
prepared to publish again when necessary then our messaging system is much
more simple -- and probably less fragile and more reliable as a result.
 Might not work for all businesses, but likely for ours.

We have a database for recording state.  The messaging system is about
changing state in many cases.  So, for important tasks we should be able to
look at the state and say "this was suppose to be done an hour ago, so queue
it again."  A trickier part is determining if a job was actually lost or is
just still in the queue.

A much more important task is just making sure that clients can publish
messages when needed.

Oh, yes Celery has a lot of nice features that are probably commonly needed
by applications.  I've been testing it for the last week, and even know we
are not a Python shop I suspect we could still use it to fork off other jobs
very easily.

Thanks,



On Fri, Jan 14, 2011 at 8:20 AM, Matthew Sackman <matthew at rabbitmq.com>wrote:

> Hi Bill,
>
> On Tue, Jan 11, 2011 at 07:57:19PM -0800, Bill Moseley wrote:
> > The High Availablity docs at http://www.rabbitmq.com/pacemaker.html seem
> > pretty thorough.  Are there any other approaches commonly used for HA?
> What
> > about for syncing between data centers? Can anyone discuss their HA
> approach
> > if it differs from the link above?
>
> There are a couple of other things to mention. One is that work is
> currently been done on active/active HA, but that will provide
> "mirrored" queues (think RAID-1) within a cluster only. The other thing
> to mention is the shovel plugin, which can be used for a very
> rudimentary form of federation between different brokers. The main
> limitation with the shovel though is that its configuration can't be
> dynamically changed, so it's only really a sensible solution if you're
> topology is mainly static.
>
> > We are evaluating messaging systems and the question of HA has come up
> > frequently.  The concern is that some items, once entered onto the queue,
> > should never be lost -- even if the entire data center goes down.
>
> Right, but is that "lost" as in "provided it's stored on disk, that's
> ok, even if it takes us a month to get the data back off disk", or is it
> "lost" as it "must always be (near) instantly available"?
>
> > We are comparing RabbitMQ with writing a system in-house.  The in-house
> > queue system would use a Postgresql table for the queue with replication
> > (currently via Slony) for hot-backup (it's not really HA).  We also
> > replicate to a secondary data center with the eventual goal of reasonably
> > fast tip-over between data centers.  We are not in the financial or
> medical
> > industry so nobody's life is at risk if we drop a few jobs.  I suspect we
> > only need to handle three to five million message a day -- nothing too
> big.
> >  (Oddly, one argument against using RabbitMQ was it was overkill for our
> > needs.)
>
> Yeah, rather obviously, we're somewhat biased against building message
> brokers on top of databases ;) I guess the things I'd suggest you look
> as is whilst you may be fine with postgres at the moment, what happens
> in a couple of years time? What will your messaging requirements be
> then, and will you have sufficient flexibility in your home-grown system
> to be able to cope with those needs?
>
> > Postgresql and replication is what we use for application data currently,
> so
> > it is a familiar technology for us.  Another reason we are considering
> > building a custom message queue system is to put more functionality into
> the
> > broker -- such as scheduling and job routing that would be specific to
> our
> > business.  And there's fear that nobody knows Erlang if something broke
> and
> > we needed to try and resolve.
>
> Sure, those are valid concerns. There are ways of extending the
> functionality of Rabbit, for example through exchange types, or even
> custom plugins, but these do normally require writing in Erlang.
>
> > My opinion is AMQP is very flexible and we should be able to make it meet
> > our needs.  We are not doing anything that unusual.  And I suspect
> building
> > something as reliable as RabbitMQ is no easy task -- especially if the
> point
> > is to make a system more complex than what RabbitMQ provides.
>  Scheduling,
> > for example, seems like something a simple database table and cron could
> > solve easily with RabbitMQ.
>
> Indeed - use the right tool for the job etc. Job scheduling and such are
> probably on the boundary of what we consider pure messaging, and so it
> does normally require additional client-side applications to add to
> Rabbit to provide such functionality. You might like to look at celery
> in this space which does job scheduling on top of Rabbit.
>
> > Another argument for a custom broker was to make better use of workers --
> > i.e. the broker would look at load and other factors when determining
> where
> > to send jobs.  My feeling here is resources are limited so it's a matter
> of
> > balancing the number and type of consumers with queue load -- and an
> > external process can manage starting and stopping consumers easily as
> demand
> > profile changes (by looking at queue sizes and rates) without having to
> be
> > part of the broker.  Are there common approaches for dynamically
> adjusting
> > workers?
>
> I suspect that's something that falls squarely in the remit of tools
> like celery. It's definitely outside the scope of Rabbit itself.
>
> Matthew
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/6b0fcda6/attachment-0001.htm>

From moseley at hank.org  Fri Jan 14 22:24:44 2011
From: moseley at hank.org (Bill Moseley)
Date: Fri, 14 Jan 2011 14:24:44 -0800
Subject: [rabbitmq-discuss] Are queues replicated across a cluster?
In-Reply-To: <20110114170832.GI18402@rabbitmq.com>
References: <AANLkTik6DTYcEVy+MtiaQ7k397zkCepeRb1TG8+r0snR@mail.gmail.com>
	<20110114170832.GI18402@rabbitmq.com>
Message-ID: <AANLkTi=fkvhKYod5x+inA9nSs73K2eeDEdyZ=dyMbSC8@mail.gmail.com>

On Fri, Jan 14, 2011 at 9:08 AM, Matthew Sackman <matthew at rabbitmq.com>wrote:

>
> Entirely up to you - resources are visible throughout the cluster and so
> any sane load balancing should be just fine. If they all connect to the
> same node then you'll likely find that all resources exist solely on
> that node and thus the other nodes are not being used at all. Thus
> really, you want to make sure that the clients which create resources
> (queues in particular) are connected across all the nodes.
>
> The other thing to consider is the inter-node hops required to route
> messages. Thus you may wish to make sure that if client 1 is
> predominantly sending messages to or consuming messages from queue 1,
> that client 1 is connected to the same node on which queue 1 resides.
>

Hum.  There's always trade-offs.

The top concern is that a producer (and consumer) can connect to a node.
 What looks like a good choice is HAProxy in front of a set of RabbitMQ
nodes.  And maybe a pair of HAProxy machines with Heartbeat to avoid the
single point of failure.  Configuration is easier because workers just talk
to one HAProxy.

But, then there's no control over which node a producer or consumer connects
to.  So, then there's going to be be some (probably half) cross-node
messages.

Perhaps if the point of the second node is for HA then should just configure
HAProxy to only use the second node as a hot-backup and make both nodes disk
nodes.  The nature of a backup is that it must be able to handle all
traffic, anyway.

If we design with the idea messages might get dropped, and always declare
exchanges, queues, and bindings on every connection then maybe there's no
need for a cluster or using the Pacemaker HA example and just run
independent RabbitMQ instances with a method of fail-over.


Thanks very much for the help, Matthew.


Would I be wrong to assume that these configuration issues have been solved
by many people already?


-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/36bea295/attachment.htm>

From moseley at hank.org  Fri Jan 14 23:29:56 2011
From: moseley at hank.org (Bill Moseley)
Date: Fri, 14 Jan 2011 15:29:56 -0800
Subject: [rabbitmq-discuss] Node hung and not responding to rabbitmqctl
In-Reply-To: <AANLkTikJqw-js4DyEjh82Vmd7+uRRvh9OieTEtZvDFtZ@mail.gmail.com>
References: <AANLkTikJqw-js4DyEjh82Vmd7+uRRvh9OieTEtZvDFtZ@mail.gmail.com>
Message-ID: <AANLkTikRntBrhcRwd6aM=gavu=Vbm-qgjg9SZiJM9UU2@mail.gmail.com>

FWIW, I ended up kill -9 anything that looked like a rabbit and renamed the
mnesia directory.

When I first restarted (with the old mnesia db) I could run a status on node
"rabbit" and it would say:

 {nodes,[{disc,[rabbit at bumby2]},{ram,[bumby22 at bumby2]}]},
 {running_nodes,[rabbit at bumby2]}]


I ran stop_app and reset on that node.  I should have tried force_reset,
which I had forgot about.

$ sudo rabbitmqctl start_app -n bumby22
Starting node bumby22 at bumby2 ...
Error: unable to connect to node bumby22 at bumby2: nodedown
diagnostics:
- nodes and their ports on bumby2: [{rabbit,38534},{rabbitmqctl4333,36621}]
- current node: rabbitmqctl4333 at bumby2
- current node home dir: /var/lib/rabbitmq
- current node cookie hash: dtrZjBnJVTn9JkBFcRVBBA==

bumby22 and bumby22 at bumby2 (ya, bad name) are in /etc/hosts.

It would be nice to know how to un-wedge when needed -- and why rabbitmqctl
was hanging.    /etc/init.d/rabbitmq stop even hung.


On Fri, Jan 14, 2011 at 7:01 AM, Bill Moseley <moseley at hank.org> wrote:

> I've been working with clustering (on a single test machine) and I stopped
> the 2nd RAM node w/o problem but now the initial disk node seems
> unresponsive.  All of the rabbitmqctl commands hang.   Initially, connecting
> to the node would also hang, but not Rabbit doesn't seem to be listening to
> the port any more.
>
>
> $ sudo rabbitmqctl stop_app
> Stopping node rabbit at bumby2 ...
>
>
> After a few minutes I abort and "k" for kill and get the following:
>
> ^C
> BREAK: (a)bort (c)ontinue (p)roc info (i)nfo (l)oaded
>        (v)ersion (k)ill (D)b-tables (d)istribution
>
> k
>
> Process Information
>
> --------------------------------------------------
> =proc:<0.38.0>
> State: Waiting
> Name: inet_gethost_native
> Spawned as: inet_gethost_native:server_init/2
> Spawned by: <0.37.0>
> Started: Fri Jan 14 06:38:10 2011
> Message queue length: 0
> Number of heap fragments: 0
> Heap fragment data: 0
> Link list: [#Port<0.288>, <0.37.0>]
> Dictionary: [{rid,1},{num_requests,0}]
> Reductions: 64
> Stack+heap: 233
> OldHeap: 0
> Heap unused: 190
> OldHeap unused: 0
>  Stack dump:
> Program counter: 0xb771c718 (inet_gethost_native:main_loop/1 + 20)
> CP: 0x00000000 (invalid)
> arity = 0
>
> 0xb74eeecc Return addr 0x08201594 (<terminate process normally>)
> y(0)
> {state,#Port<0.288>,8000,12302,16399,<0.37.0>,4,{statistics,0,0,0,0,0,0,0,0}}
> (k)ill (n)ext (r)eturn:
>
> Seems to be a lot of these hanging around:
>
>
> $ ps auxf | grep gethost
> rabbitmq  3700  0.0  0.0   1868   436 ?        Ss   Jan13   0:00  \_
> inet_gethost 4
> rabbitmq  3701  0.0  0.0   1916   540 ?        S    Jan13   0:00  |   \_
> inet_gethost 4
> rabbitmq  3995  0.0  0.0   1868   436 ?        Ss   Jan13   0:00  \_
> inet_gethost 4
> rabbitmq  3996  0.0  0.0   1916   536 ?        S    Jan13   0:00      \_
> inet_gethost 4
> rabbitmq  4370  0.0  0.0   1868   432 ?        Ss   Jan13   0:00  \_
> inet_gethost 4
> rabbitmq  4371  0.0  0.0   1916   536 ?        S    Jan13   0:00      \_
> inet_gethost 4
>
>
> And logs:
>
> =WARNING REPORT==== 13-Jan-2011::21:39:43 ===
> exception on TCP connection <0.30329.54> from 127.0.0.1:50222
> connection_closed_abruptly
>
> =INFO REPORT==== 13-Jan-2011::21:39:43 ===
> closing TCP connection <0.30329.54> from 127.0.0.1:50222
>
> =ERROR REPORT==== 14-Jan-2011::06:39:16 ===
> ** Node rabbitmqctl7173 at bumby2 not responding **
> ** Removing (timedout) connection **
>
>
>
> Ubuntu Erlang1:13.b.1-dfsg-2ubuntu1.1 / RabbitMQ 2.2.0-1
>
> Are there any docs that describe debugging techniques for those of us that
> have no Erlang experience?   I'm not even sure what to kill -9 if I had to.
> ;)
>
> --
> Bill Moseley
> moseley at hank.org
>



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110114/73c15550/attachment.htm>

From simon at rabbitmq.com  Sat Jan 15 11:41:47 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Sat, 15 Jan 2011 11:41:47 +0000
Subject: [rabbitmq-discuss] Cannot start cluster?
In-Reply-To: <D45FF3C1-7FF3-41B5-A3D4-7906E82A6848@whatevernot.com>
References: <D45FF3C1-7FF3-41B5-A3D4-7906E82A6848@whatevernot.com>
Message-ID: <4D3187FB.9090705@rabbitmq.com>

On 14/01/2011 7:38PM, Brian Parkinson wrote:
> Hello - starting to play with clustering - I am using Rabbit 2.2.0 on
> Mac.
>
> Running one server (either by 'rabbit-server' or 'rabbit-multi
> start_all 1') works fine. Trying to start a cluster with 2 nodes
> fails - see output below.
>
> 1. Any ideas?

Hi Brian. If I had to guess I would say this is because you've got the 
management plugin installed. rabbitmq-multi assigns sequential AMQP 
listening ports for the nodes it starts, but it doesn't know anything 
about the port opened by rabbitmq_mochiweb (or any other ports the nodes 
might be configured to open - SSL, STOMP etc).

I think you'll want to start the nodes without using rabbitmq-multi, 
just with multiple invocations of rabbitmq-server, using environment 
variables to configure each node differently. I use a script like:

start-node.sh:
~~~~
#!/bin/sh
RABBITMQ_NODE_PORT=$1 RABBITMQ_NODENAME=$2 \
RABBITMQ_MNESIA_DIR=/tmp/rabbitmq-$2-mnesia \
RABBITMQ_PLUGINS_EXPAND_DIR=/tmp/rabbitmq-$2-plugins-scratch \
RABBITMQ_LOG_BASE=/tmp \
RABBITMQ_SERVER_START_ARGS="-rabbit_mochiweb port 5$1" \
/path/to/rabbitmq-server
~~~~

and then invoke it as

start-node.sh 5672 rabbit
start-node.sh 5673 hare

etc. Note that this will start RabbitMQ in the foreground.

Note that neither rabbitmq-multi nor this approach will actually cluster 
the nodes; you'll need something like:

rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl cluster rabbit at hostname hare at hostname
rabbitmqctl start_app

to form a cluster.

> 2. A quick question/confirmation about a cluster. Assume I have a
2-node cluster running, and my client app connects via a
ConnectionFactory pointing at host/port of node1. If node1 then goes
down, will my client app continue to talk to node2?

No, I'm afraid you need to handle reconnection yourself.

Cheers, Simon

From simon at rabbitmq.com  Sat Jan 15 12:00:15 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Sat, 15 Jan 2011 12:00:15 +0000
Subject: [rabbitmq-discuss] Undefined errors on management interface
In-Reply-To: <AANLkTim7f6-_u3kNdi6QRxfT7aTR4Msi=aHbnV+OPqs2@mail.gmail.com>
References: <AANLkTim7f6-_u3kNdi6QRxfT7aTR4Msi=aHbnV+OPqs2@mail.gmail.com>
Message-ID: <4D318C4F.6000100@rabbitmq.com>

On 14/01/2011 5:57PM, Mark J. Reed wrote:
> OK, now that I'm on 2.2.0, I set up the management plugin set
> (amqp_client, mochiweb, rabbitmq-management,
> rabbitmq-management-agent, rabbitmq-mochiweb, and webmachine).  But
> when I go to http://rabbit1:55672/mgmt/#/, I get "TypeError: Cannot
> read property 'messages_ready' of undefined.".
>
> If I go to the queues tab, I get a list of queues, but the message
> counts are all question marks, and the same message appears below the
> table.
>
> Permissions issue?   Something else I should look at?

Hi Mark.

This sounds quite a lot like the problem described by Ciprian at 
http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2011-January/010611.html 
- you're not starting Rabbit in an unusual way are you?

If not, then this should definitely not be happening. Can you look in 
/var/log/rabbitmq/startup_log and see if the lines:

starting management agent                               ...done
starting management statistics database                 ...done

appear? Also, is there anything that looks error-like in the logs?

Cheers, Simon

From magdysyukvv at yahoo.com  Sat Jan 15 16:39:42 2011
From: magdysyukvv at yahoo.com (Vyacheslav Magdysyuk)
Date: Sat, 15 Jan 2011 08:39:42 -0800 (PST)
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
Message-ID: <566328.13683.qm@web114614.mail.gq1.yahoo.com>

Exist support for custom storage backends (like MySQL) in RabbitMQ 2.2 or not?
If "yes": How can I store my queues in MySQL/PostreSQL/whatever?
If "no": For python applications exist Celery, Kombu, which can solve this 
problem. But what you can recommend for Java applications?



      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110115/87676551/attachment.htm>

From jerryk at vmware.com  Sat Jan 15 17:14:19 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Sat, 15 Jan 2011 09:14:19 -0800
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
In-Reply-To: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
References: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
Message-ID: <281A9A68-45ED-4375-A491-F44F96331052@vmware.com>

Hi Vyacheslav...

Exist support for custom storage backends (like MySQL) in RabbitMQ 2.2 or not?

Storage backends based on MySQL and Mnesia are currently under development.  There has also been some discussion of various NoSQL stores, although no firm plans have been made.  We should have something more to say in the near future.

If "yes": How can I store my queues in MySQL/PostreSQL/whatever?

If a plugin for your store of choice doesn't exist, then one writes a storage plugin, in Erlang, by implementing the rabbit_backing_queue behaviour, which effectively makes up the storage API, and talks to the storage system of your choice.

If "no": For python applications exist Celery, Kombu, which can solve this problem. But what you can recommend for Java applications?

I'm a bit confused and may be misunderstanding your intent.

As I understand it, Celery is a task-dispatching system that uses Rabbit for messaging internally, but as an option can do "messaging through a database" using the other options you mention.  That's a different problem from general purpose messaging.  I've not looked at Kombu, but as I understand it, it's an AMQP client library for Python.  Neither of these strictly has anything to do with changing the storage backend used behind your messaging broker.

Is a task queueing/scheduling system your primary goal here?

Best regards,
Jerry


From harvey.robin at gmail.com  Sat Jan 15 19:46:00 2011
From: harvey.robin at gmail.com (Robin Harvey)
Date: Sat, 15 Jan 2011 19:46:00 +0000
Subject: [rabbitmq-discuss] New open source PHP Amqp implementation
In-Reply-To: <AANLkTi=ALnyw3r5FEhmziDdXg78o1K8OUtV2hL=O5bGA@mail.gmail.com>
References: <AANLkTingoBNPr_9g7REj58EFkihM8x5Bu0jm1m+N_dqK@mail.gmail.com>
	<AANLkTi=ALnyw3r5FEhmziDdXg78o1K8OUtV2hL=O5bGA@mail.gmail.com>
Message-ID: <AANLkTin2UJun+cRRohoD1CYf6POcQBQUwKu2cd2PhYWf@mail.gmail.com>

Hi Mark,

I've just finished implementing SSL support, if you grab the latest code
from code from github (https://github.com/BraveSirRobin/amqphp) and twiddle
with the tests/forker.xml configs a bit it should work.  From my tests,
client certificates and peer verification work fine, there's instructions in
the amqp.php file on PHP specific setup.  The SSL implementation does use
the Stream context API, as you suggested, however the plain sockets
implementation is still there (you can switch these in the forker.xml config
file).

Thanks,
--Robin



On Tue, Jan 11, 2011 at 4:32 PM, Mark Steele <msteele at beringmedia.com>wrote:

> Hi Robin,
>
> A few questions:
>
>    - Is it possible to make your class work with SSL connections? (Use
>    php's stream context api instead of creating plain sockets?).
>    - Will it behave properly in an app that uses signals/alarms?
>
>
> Nice work, looking forward to testing it.
>
> Mark Steele
> Bering Media Inc.
>
>
> On Sat, Jan 8, 2011 at 8:46 AM, Robin Harvey <harvey.robin at gmail.com>wrote:
>
>> Hello Rabbiteers!
>>
>>
>> I hope I'm not being importune by posting this message to let you know
>> about an LGPL Amqp implementation I've recently written for PHP 5.3:
>>
>>  https://github.com/BraveSirRobin/amqphp
>>
>> I've implemented the 0.9.1 Amqp spec using a code-generation approach.  If
>> any of the more experienced Amqp people were able to take a quick look at my
>> code in order to provide feedback, or have any other advice I'd be very
>> grateful.  There's a UML class diagram showing the implementation classes
>> here: https://github.com/BraveSirRobin/amqphp/raw/master/diag/amqp.png
>>
>> Secondly, I have a question regarding using basic.consume on multiple
>> channels.  Is it possible for message frames to be mixed up for
>> basic.consume?  Section 4.2.6 of the spec says this:
>>
>> *Content frames on a specific channel are strictly sequential. That is,
>> they may be mixed with frames for*
>> *other channels, but no two content frames from the same channel may be
>> mixed or overlapped, nor may*
>> *content frames for a single content be mixed with method frames on the
>> same channel.*
>>
>> What I find confusing is that a single "message" consists of a frame
>> header, a content header and one or more content frames, for large messages
>> there can be many content frames; a single message contains many frames.
>>  For example, is it possible to get a content header frame on channel A,
>> then a content header frame on channel B, then the message content for
>> channel A, then the message content for channel B?  The testing I've done so
>> far indicates that RMQ always sends basic.deliver messages sequentially - it
>> sends the content header then all content frames for a single message on a
>> single channel in a non-interleaved fashion.  Is this always the case?  Is
>> this what the spec guarantees?
>>
>>
>> Many thanks,
>> --Robin
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110115/0478cc51/attachment.htm>

From simon at rabbitmq.com  Sun Jan 16 11:51:32 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Sun, 16 Jan 2011 11:51:32 +0000
Subject: [rabbitmq-discuss] Confusion about location of
	Windows	rabbitmq.config
In-Reply-To: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E407C@IS-EXCHANGEC101.wsod.local>
References: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E407C@IS-EXCHANGEC101.wsod.local>
Message-ID: <4D32DBC4.2090200@rabbitmq.com>

On 13/01/2011 6:59PM, Paul Pearcy wrote:
> Hello,
>
> I have been through the install docs a couple of times and am still
> baffled about the location of the rabbitmq.config file on Windows. There
> are two sections:
>
> RABBITMQ_CONFIG_FILE
>
> Defaults to%RABBITMQ_BASE%\rabbitmq.
<snip>
> Then in the link for the configuration file, there are the following
> details:
>
> The location of this configuration file is distribution specific. By
> default, it is located in the following places on each platform:
>
> ?Windows- %APPDATA%\RabbitMQ\rabbitmq.config
<snip>
> Maybe I am missing something obvious, but these seem to disagree.

I don't think they do, since RABBITMQ_BASE defaults to %APPDATA%\RabbitMQ.

> I have attempted to be explicit instead by setting the following env var:
>
> RABBITMQ_CONFIG_FILE= D:\rabbitmq\rabbitmq
>
> I would then expect this to pick up this config file:
>
> D:\rabbitmq\rabbitmq.config

That looks correct.

> However, none of my settings are taking effect and I can?t figure out
> how to tell which config file the rabbitmq install is picking up. What
> is the easiest way for rabbitmq to tell me where it is looking for the
> config file?

Hmm. At the moment, I think you would need to add an echo statement to 
the rabbitmq-server.bat file, something like:

echo CONFIG FILE: !RABBITMQ_CONFIG_FILE!.config

around line 136 or so.

We should probably display this location on startup though.

Cheers, Simon

From matthew at rabbitmq.com  Sun Jan 16 13:06:15 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Sun, 16 Jan 2011 13:06:15 +0000
Subject: [rabbitmq-discuss] Confusion about location of Windows
 rabbitmq.config
In-Reply-To: <4D32DBC4.2090200@rabbitmq.com>
References: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E407C@IS-EXCHANGEC101.wsod.local>
	<4D32DBC4.2090200@rabbitmq.com>
Message-ID: <20110116130615.GA17191@wellquite.org>

Note that if you're using the service rather just starting Rabbit
directly from the -server.bat, then you need to set the config file env
var, and then uninstall and reinstall the Rabbit service. Just stopping
and restarting the service doesn't seem to do the trick.

Matthew

From jon.rowland at isam.com  Mon Jan 17 08:56:17 2011
From: jon.rowland at isam.com (Jon Rowland)
Date: Mon, 17 Jan 2011 02:56:17 -0600
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in Chrome
Message-ID: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>

Hi all,

I left a test app running over the weekend which publishes 1000 msg/sec to a broker. I also left the management plugin page open on the Channels tab running in Chrome.

I happened to notice that Chrome was using an enormous amount of memory - over 1GB and very slowly increasing. As soon as I navigated to another page outside of the management console, without restarting the browser, the memory was released.

No idea if this is 'bug' or 'feature' but thought you may be interested.

Thanks,
Jon

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110117/b48f6abd/attachment.htm>

From vdeepak at yahoo-inc.com  Mon Jan 17 09:26:59 2011
From: vdeepak at yahoo-inc.com (Deepak Vijayvergiy)
Date: Mon, 17 Jan 2011 14:56:59 +0530
Subject: [rabbitmq-discuss] Regarding the non-blocking call of
	"amqp_simple_wait_frame"
Message-ID: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>

Hello,
I am implementing RabbitMQ-C client library in my c++ project and I have a question about the message reading from the queue.
We need to call the function amqp_simple_wait_frame(), and we are blocked here to get the result, and then return  when we get the message.
Question is: Do you also have some other way in which we can read the message without blocking?

Thanks
Regards
Deepak
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110117/03405e25/attachment.htm>

From akalend at mail.ru  Mon Jan 17 09:33:06 2011
From: akalend at mail.ru (Alexandre Kalendarev)
Date: Mon, 17 Jan 2011 12:33:06 +0300
Subject: [rabbitmq-discuss]
	=?windows-1251?q?Regarding_the_non-blocking_ca?=
	=?windows-1251?q?ll_of_=22amqp=5Fsimple=5Fwait=5Fframe=22?=
In-Reply-To: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
References: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
Message-ID: <E1PelSU-0001uY-00.akalend-mail-ru@f231.mail.ru>

the rabbitmq-c client d't have no-blocking i/o. 
I want to realize  (I planed in future ) the non-blocking i/o for amqp in my project  rabbitmq-cpp by using libevent. 


Alexandre

Mon, 17 Jan 2011 14:56:59 +0530 ?????? ?? Deepak Vijayvergiy <vdeepak at yahoo-inc.com>:

Hello,I am implementing RabbitMQ-C client library in my c++ project and I have a question about the message reading from the queue.We need to call the function amqp_simple_wait_frame(), and we are blocked here to get the result, and then return  when we get the message.Question is: Do you also have some other way in which we can read the message without blocking?
ThanksRegardsDeepak_______________________________________________
rabbitmq-discuss mailing list
 rabbitmq-discuss at lists.rabbitmq.com (sentmsg?compose&amp;To=rabbitmq%2ddiscuss at lists.rabbitmq.com) 
 https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss (https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss) 



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110117/b697fa63/attachment.htm>

From david at rabbitmq.com  Mon Jan 17 09:36:43 2011
From: david at rabbitmq.com (David Wragg)
Date: Mon, 17 Jan 2011 09:36:43 +0000
Subject: [rabbitmq-discuss] Regarding the non-blocking call of
	"amqp_simple_wait_frame"
In-Reply-To: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com> (Deepak
	Vijayvergiy's message of "Mon, 17 Jan 2011 14:56:59 +0530")
References: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
Message-ID: <yrv4czkqzx45w.fsf@dwragg.eng.vmware.com>

Hi Deepak,

Deepak Vijayvergiy <vdeepak at yahoo-inc.com> writes:
> I am implementing RabbitMQ-C client library in my c++ project and I
> have a question about the message reading from the queue.  We need to
> call the function amqp_simple_wait_frame(), and we are blocked here to
> get the result, and then return when we get the message.  Question is:
> Do you also have some other way in which we can read the message
> without blocking?

rabbitmq-c does not currently support non-blocking operation.  You could
use threads though: have one thread responsible for AMQP communictions,
which passes recieved messages to other threads for procesing.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From vdeepak at yahoo-inc.com  Mon Jan 17 09:47:58 2011
From: vdeepak at yahoo-inc.com (Deepak Vijayvergiy)
Date: Mon, 17 Jan 2011 15:17:58 +0530
Subject: [rabbitmq-discuss] Regarding the non-blocking call of
 "amqp_simple_wait_frame"
In-Reply-To: <E1PelSU-0001uY-00.akalend-mail-ru@f231.mail.ru>
References: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
	<E1PelSU-0001uY-00.akalend-mail-ru@f231.mail.ru>
Message-ID: <36C8633F-B2FF-4A05-A0A1-422513858CE5@yahoo-inc.com>

Hi Alexandre,
I am planning to then use threads to handle the non-blocking read-message.
How are you going to handle non-blocking i/o?

Thanks
Regards
Deepak

On Jan 17, 2011, at 3:03 PM, Alexandre Kalendarev wrote:

the rabbitmq-c client d't have no-blocking i/o.
I want to realize  (I planed in future ) the non-blocking i/o for amqp in my project  rabbitmq-cpp by using libevent.


Alexandre

Mon, 17 Jan 2011 14:56:59 +0530 ?????? ?? Deepak Vijayvergiy <vdeepak at yahoo-inc.com<mailto:vdeepak at yahoo-inc.com>>:

Hello,
I am implementing RabbitMQ-C client library in my c++ project and I have a question about the message reading from the queue.
We need to call the function amqp_simple_wait_frame(), and we are blocked here to get the result, and then return  when we get the message.
Question is: Do you also have some other way in which we can read the message without blocking?

Thanks
Regards
Deepak
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com<x-msg://94/sentmsg?compose&To=rabbitmq%2ddiscuss at lists.rabbitmq.com>
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110117/37f1d6b3/attachment-0001.htm>

From markrogerhudson at gmail.com  Mon Jan 17 10:20:57 2011
From: markrogerhudson at gmail.com (Mark Hudson)
Date: Mon, 17 Jan 2011 10:20:57 +0000
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate 583848200
	bytes of memory
Message-ID: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>

Hi, I'm experiencing?reproducible?crashes of?Erlang?when running
RabbitMQ 2.20 on a clean install of 64 bit Windows server 2008 R2 box
- a parallels virtual machine with 1024 gig.

They seem to be very similar to the problems here :
http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-December/010443.html

In particular I get
"broker running
Crash dump was written to: erl_crash.dump
eheap_alloc: Cannot allocate 583848200 bytes of memory (of type "old_heap").
This application has requested the Runtime to terminate it in an unusual way.
Please contact the application's support team for more information."
"Cannot allocate 583848200 bytes of memory (of type "old_heap")." is
the same message talked about in the previous discussion.


In my scenario, I load a durable queue with between 110k and 130k
messages -around 900 bytes each- with the consumer off. I then turn on
the consumer -to simulate the consumer being unable to contact the
broker, or consumer being down for a period etc. - the Akka consumer
then starts processing the messages with?erl.exe consuming about 50
meg.

While the durable queue is being consumed, If I enter?rabbitmqctl.bat
list_queues in a console, I find that?rabbitmqctl.bat takes a while to
return there are no queues, then the erl.exe process grows to about
650 meg before erland crashes dumping out
?614,019,533 erl_crash.dump

With an empty durable queue, If I start the consumer, then start my
load test, the queue runs for hours, Akka consumes and erl.exe stays
around 50meg.

It was suggested switching to a Linux environment, this may be
possible later, but currently?Our planned environment is Windows
Server 2008 R2.

There was also talk of an "experimental fix for this". Any idea if
this work, or when this will be part of the next release ?

Prior to this load testing, RabbitMQ worked faultlessly.


Thanks.

From akalend at mail.ru  Mon Jan 17 10:32:23 2011
From: akalend at mail.ru (Alexandre Kalendarev)
Date: Mon, 17 Jan 2011 13:32:23 +0300
Subject: [rabbitmq-discuss]
	=?windows-1251?q?Regarding_the_non-blocking_ca?=
	=?windows-1251?q?ll_of_=22amqp=5Fsimple=5Fwait=5Fframe=22?=
In-Reply-To: <36C8633F-B2FF-4A05-A0A1-422513858CE5@yahoo-inc.com>
References: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
	<E1PelSU-0001uY-00.akalend-mail-ru@f231.mail.ru>
	<36C8633F-B2FF-4A05-A0A1-422513858CE5@yahoo-inc.com>
Message-ID: <E1PemNr-0003jM-00.akalend-mail-ru@f74.mail.ru>

Mon, 17 Jan 2011 15:17:58 +0530 ?????? ?? Deepak Vijayvergiy <vdeepak at yahoo-inc.com>:

Hi Alexandre,I am planning to then use threads to handle the non-blocking read-message.How are you going to handle non-blocking i/o?I want to refactoring net part  ob librabbitmq-c and exchange i/o blocking to non-blocking by libevent.
I think to use the hanldlers for non-blocking, but I don't have real  API. It my plans only. This task is large.


Alexandre




 
ThanksRegardsDeepak
On Jan 17, 2011, at 3:03 PM, Alexandre Kalendarev wrote:the rabbitmq-c client d't have no-blocking i/o. 
I want to realize  (I planed in future ) the non-blocking i/o for amqp in my project  rabbitmq-cpp by using libevent. 


Alexandre

Mon, 17 Jan 2011 14:56:59 +0530 ?????? ?? Deepak Vijayvergiy <vdeepak at yahoo-inc.com>:

Hello,I am implementing RabbitMQ-C client library in my c++ project and I have a question about the message reading from the queue.We need to call the function amqp_simple_wait_frame(), and we are blocked here to get the result, and then return  when we get the message.Question is: Do you also have some other way in which we can read the message without blocking?
ThanksRegardsDeepak_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss





-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110117/bc6449ed/attachment.htm>

From tonygarnockjones+rabbitmq at gmail.com  Mon Jan 17 15:24:10 2011
From: tonygarnockjones+rabbitmq at gmail.com (Tony Garnock-Jones)
Date: Mon, 17 Jan 2011 10:24:10 -0500
Subject: [rabbitmq-discuss] Regarding the non-blocking call of
	"amqp_simple_wait_frame"
In-Reply-To: <E1PelSU-0001uY-00.akalend-mail-ru@f231.mail.ru>
References: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
	<E1PelSU-0001uY-00.akalend-mail-ru@f231.mail.ru>
Message-ID: <AANLkTikiO4m-8kvSqLNKQvex9x0hhgzy_62KJgEZ+QKK@mail.gmail.com>

2011/1/17 Alexandre Kalendarev <akalend at mail.ru>

> the rabbitmq-c client d't have no-blocking i/o.
>

A cheap hack would be to use select() (etc) to wait for some input to become
available, and then call amqp_simple_wait_frame.

I've also experimented with using libevent with librabbitmq, though it's Not
Going To Be Easy To Follow: see read_callback at
https://github.com/tonyg/rais/blob/master/src/connection.c#L384-411, and
check out librabbitmq's amqp_handle_input().

Tony
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110117/c4b926f8/attachment.htm>

From david at rabbitmq.com  Mon Jan 17 17:01:17 2011
From: david at rabbitmq.com (David Wragg)
Date: Mon, 17 Jan 2011 17:01:17 +0000
Subject: [rabbitmq-discuss] Regarding the non-blocking call of
	"amqp_simple_wait_frame"
In-Reply-To: <AANLkTikiO4m-8kvSqLNKQvex9x0hhgzy_62KJgEZ+QKK@mail.gmail.com>
	(Tony Garnock-Jones's message of "Mon, 17 Jan 2011 10:24:10 -0500")
References: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
	<E1PelSU-0001uY-00.akalend-mail-ru@f231.mail.ru>
	<AANLkTikiO4m-8kvSqLNKQvex9x0hhgzy_62KJgEZ+QKK@mail.gmail.com>
Message-ID: <yrv4clj2jtqg2.fsf@dwragg.eng.vmware.com>

Tony Garnock-Jones <tonygarnockjones+rabbitmq at gmail.com> writes:
> 2011/1/17 Alexandre Kalendarev <akalend at mail.ru>
>> the rabbitmq-c client d't have no-blocking i/o.
>
> A cheap hack would be to use select() (etc) to wait for some input to become
> available, and then call amqp_simple_wait_frame.

While it might be possible to make that work in simple consumer cases,
it seems distinctly fragile to me.  If librabbitmq breaks under such
use, you get to keep both parts!

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From scott at beamdog.com  Mon Jan 17 17:20:15 2011
From: scott at beamdog.com (Scott Brooks)
Date: Mon, 17 Jan 2011 10:20:15 -0700
Subject: [rabbitmq-discuss] Regarding the non-blocking call of
	"amqp_simple_wait_frame"
In-Reply-To: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
References: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
Message-ID: <AANLkTimjQs=q5G75bpinPZOW6EzDa9ihT9dQEWnWyGEL@mail.gmail.com>

I used a combination of select() on the socket, and
amqp_frames_enqueued() when working on a ruby/FFI implementation

If there were frames enqueued, call amqp_simple_wait_frame() because
it will just return from that.
If there are no frames enqueued, check the socket with select, and if
there's data, call amqp_simple_wait_frame()

Ruby(1.8) uses green threads, so any blocking IO would block the whole process.

Scott Brooks

On Mon, Jan 17, 2011 at 2:26 AM, Deepak Vijayvergiy
<vdeepak at yahoo-inc.com> wrote:
> Hello,
> I am implementing RabbitMQ-C client library in my c++ project and I have a
> question about the message reading from the queue.
> We need to call the function?amqp_simple_wait_frame(), and we are blocked
> here to get the result, and then return ?when we get the message.
> Question is: Do you also have some other way in which we can read the
> message without blocking?
> Thanks
> Regards
> Deepak
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

From jerryk at vmware.com  Mon Jan 17 20:18:55 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Mon, 17 Jan 2011 12:18:55 -0800
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate
	583848200	bytes of memory
In-Reply-To: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CBF1@EXCH-MBX-3.vmware.com>

Hi, Mark...

Thanks very much for your mail!

> Hi, I'm experiencing reproducible crashes of Erlang when running
> RabbitMQ 2.20 on a clean install of 64 bit Windows server 2008 R2 box
> - a parallels virtual machine with 1024 gig.
>
> They seem to be very similar to the problems here :
> http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-December/010443.html

We've seen what appears to be this problem elsewhere with users
running on Windows.  Unfortunately, I'm not sure that it's related to
the queue memory leak discussed in the thread above, and the problem
I'm thinking of, which looks like yours, occurs even in 2.2.0.  :-(

> In particular I get
> "broker running
> Crash dump was written to: erl_crash.dump
> eheap_alloc: Cannot allocate 583848200 bytes of memory (of type "old_heap").
> This application has requested the Runtime to terminate it in an unusual way.
> Please contact the application's support team for more information."
> "Cannot allocate 583848200 bytes of memory (of type "old_heap")." is
> the same message talked about in the previous discussion.

What's happened here is that the Erlang runtime has run desperately
short of memory, been unable to allocate what it needs for its own
use, and shut down.  We're not sure quite why this happens to Windows
users at this point.  More below...

> In my scenario, I load a durable queue with between 110k and 130k
> messages -around 900 bytes each- with the consumer off. I then turn on
> the consumer -to simulate the consumer being unable to contact the
> broker, or consumer being down for a period etc. - the Akka consumer
> then starts processing the messages with erl.exe consuming about 50
> meg.

This should be an entirely reasonable scenario.  If the broker is
accumulating messages that aren't being consumed, it should page them
to disk if it gets above 0.4 times the calculated memory high
watermark value (which in turn is computed by multipling your high
watermark config setting by the amount of RAM available to the Erlang
process as detected at startup---on present Windows versions of Erlang
this is limited to 2GB regardless of whether your OS is 64-bit or
not).

The paging should relieve memory pain on the broker; also, producers
should be slowed by back-pressure, as the broker will stop reading
from the sockets to which they're publishing when it's pushed into
paging territory.  Ideally, all of these things should resolve and
stabilize once things catch up, modulo catastrophic resource
exhaustion such as a destination disk used for paging filling up.

> With an empty durable queue, If I start the consumer, then start my
> load test, the queue runs for hours, Akka consumes and erl.exe stays
> around 50meg.

So with a nicely balanced, active consumer, everything works fine?

> It was suggested switching to a Linux environment, this may be
> possible later, but currently Our planned environment is Windows
> Server 2008 R2.

That's good information for us.  The other customer we've seen with
this problem was running Vista and I only had 2008 R2 available to me
to try and reproduce it.  Using their test code I was never able to
reproduce the problem, but I was running under virtualization on
Amazon EC2.  Interestingly you're also running under Virtualization,
although on a Mac, using a different hypervisor.  This is interesting
information but it's not totally clear what its implications are at
this point.

> There was also talk of an "experimental fix for this". Any idea if
> this work, or when this will be part of the next release ?

Alas, at this moment we still aren't sure what the problem is, other
than that it appears to be specific to Windows and/or the Windows
release of Erlang.  It's plausible that the throughput and/or
scheduling of I/O under the Windows version of Erlang is different
enough that by the time the paging mechanism engages, it can't get
sufficiently caught up to the unrequited producers, and Rabbit and the
Erlang enter a bad corner of their state space.

Here's a shot in the partially illuminated dark you might try... 

Check out the discussion here of memory-based flow control:

http://www.rabbitmq.com/extensions.html#memsup

Since you have a test case in front of your that crashes reproducibly,
would you mind trying to set your vm_memory_high_watermark to
something lower than the default, say 0.2, following the instructions
presented at the above page?  That would cause the throttling of
producers to kick in earlier?  It might be interesting to see whether
this makes your system more stable under your test load.  If you do
give this a try, please report back your results---they're likely to
be helpful at refining our understanding of the issue.

> Prior to this load testing, RabbitMQ worked faultlessly.

It may be small comfort given that you can't readily switch to running
under Linux just now, but to my knowledge we've never seen this
problem happen with the broker running on Linux.  Erlang seems much
more widely used and deployed atop Linux and other Unixes, and those
releases seem to get more testing, scrutiny and love, and thus present
fewer surprises.

My apologies that we don't have a great answer for you just now...  If
you do try the suggested experiment of lowering the
vm_memory_high_watermark value, I'd be very interested in seeing how
you make out...

Best regards,
Jerry

From jon at jbrisbin.com  Mon Jan 17 20:22:04 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Mon, 17 Jan 2011 14:22:04 -0600
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
In-Reply-To: <281A9A68-45ED-4375-A491-F44F96331052@vmware.com>
References: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
	<281A9A68-45ED-4375-A491-F44F96331052@vmware.com>
Message-ID: <030E9479-2519-4F8C-81AA-B25293DE3093@jbrisbin.com>


On Jan 15, 2011, at 11:14 AM, Jerry Kuch wrote:

> Exist support for custom storage backends (like MySQL) in RabbitMQ 2.2 or not?
> 
> Storage backends based on MySQL and Mnesia are currently under development.  There has also been some discussion of various NoSQL stores, although no firm plans have been made.  We should have something more to say in the near future.

I think it would be cool to have messages stored in K/V stores like Riak, Couch, or Mongo and be able to subscribe to queues based on queries (like SQL views) which is something I've had on my mind recently. I dug into the core RabbitMQ code the other day to see how feasible this would be and it looks reasonably straightforward. I've been using Riak a lot lately, so I'd likely start with that and the protobuff client.

What about metadata? I think that's all stored in mnesia now, right? How hard would it be to keep that data in the same storage backend?


Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110117/f0e4dee5/attachment.htm>

From alexis at rabbitmq.com  Mon Jan 17 20:31:27 2011
From: alexis at rabbitmq.com (Alexis Richardson)
Date: Mon, 17 Jan 2011 20:31:27 +0000
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
In-Reply-To: <030E9479-2519-4F8C-81AA-B25293DE3093@jbrisbin.com>
References: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
	<281A9A68-45ED-4375-A491-F44F96331052@vmware.com>
	<030E9479-2519-4F8C-81AA-B25293DE3093@jbrisbin.com>
Message-ID: <AANLkTi=RVxTgdOJ-97FQ74WegcNGMTRFtFgLzR-d=pVt@mail.gmail.com>

Jon

If you have the appetite for a Riak backend, using the storage API,
that would be interesting to see...

alexis



On Mon, Jan 17, 2011 at 8:22 PM, Jon Brisbin <jon at jbrisbin.com> wrote:
>
> On Jan 15, 2011, at 11:14 AM, Jerry Kuch wrote:
>
> Exist support for custom storage backends (like MySQL) in RabbitMQ 2.2 or
> not?
>
> Storage backends based on MySQL and Mnesia are currently under development.
> ?There has also been some discussion of various NoSQL stores, although no
> firm plans have been made. ?We should have something more to say in the near
> future.
>
> I think it would be cool to have messages stored in K/V stores like Riak,
> Couch, or Mongo and be able to subscribe to queues based on queries (like
> SQL views) which is something I've had on my mind recently. I dug into the
> core RabbitMQ code the other day to see how feasible this would be and it
> looks reasonably straightforward.?I've been using Riak a lot lately, so I'd
> likely start with that and the protobuff client.
> What about metadata? I think that's all stored in mnesia now, right? How
> hard would it be to keep that data in the same storage backend?
>
> Thanks!
> Jon Brisbin
> ?? ? ? ?Web: http://jbrisbin.com/
> ?? ?Twitter: @j_brisbin
> ?? ? ?Skype: jon.brisbin
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

From mlortiz at uci.cu  Mon Jan 17 21:23:00 2011
From: mlortiz at uci.cu (Ing. Marcos Ortiz Valmaseda)
Date: Mon, 17 Jan 2011 16:23:00 -0500 (CST)
Subject: [rabbitmq-discuss] A developer's topic on the main docs
Message-ID: <1943803575.48210351295299380808.JavaMail.root@ucimail4.uci.cu>

Regards to all.
I was talking with Alexis (alexis.richardson at gmail.com) and he said to me
that we can discuss the ideas with you about the modules documentation.

The main idea that I was discussing with Alexis is to add on the modules comments the main
function of it, but he said that comments were not the right place to do that. Instead that,
we could add on the official documentation a developer?s topic explaining the main function
of each module to guide to the new developers to understand the code of them.

What do you think about this?

regards, 

Ing. Marcos Lu?s Ort?z Valmaseda
Linux User # 418229 && PostgreSQL DBA
Centro de Tecnolog?as Gesti?n de Datos (DATEC)
http://postgresql.uci.cu
http://www.postgresql.org
http://it.toolbox.com/blogs/sql-apprentice

From clegnitto at mozilla.com  Mon Jan 17 22:16:03 2011
From: clegnitto at mozilla.com (Christian Legnitto)
Date: Mon, 17 Jan 2011 14:16:03 -0800
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
In-Reply-To: <AANLkTi=RVxTgdOJ-97FQ74WegcNGMTRFtFgLzR-d=pVt@mail.gmail.com>
References: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
	<281A9A68-45ED-4375-A491-F44F96331052@vmware.com>
	<030E9479-2519-4F8C-81AA-B25293DE3093@jbrisbin.com>
	<AANLkTi=RVxTgdOJ-97FQ74WegcNGMTRFtFgLzR-d=pVt@mail.gmail.com>
Message-ID: <48B46D33-5879-4F7C-8028-0DE2006CC70F@mozilla.com>

Would this just store undelivered messages (I think that's what's in the mnesia db currently) or would it be a store of all messages that have entered Rabbit (more like a historical message cache)? I'm interested in the latter, preferably with Riak.

Now that I think about it, probably wouldn't be too hard to write a rabbit plugin that ships all messages from all exchanges over to Riak using the Riak erlang lib. Does something like that already exist?

Thanks,
Christian

On Jan 17, 2011, at 12:31 PM, Alexis Richardson <alexis at rabbitmq.com> wrote:

> Jon
> 
> If you have the appetite for a Riak backend, using the storage API,
> that would be interesting to see...
> 
> alexis
> 
> 
> 
> On Mon, Jan 17, 2011 at 8:22 PM, Jon Brisbin <jon at jbrisbin.com> wrote:
>> 
>> On Jan 15, 2011, at 11:14 AM, Jerry Kuch wrote:
>> 
>> Exist support for custom storage backends (like MySQL) in RabbitMQ 2.2 or
>> not?
>> 
>> Storage backends based on MySQL and Mnesia are currently under development.
>>  There has also been some discussion of various NoSQL stores, although no
>> firm plans have been made.  We should have something more to say in the near
>> future.
>> 
>> I think it would be cool to have messages stored in K/V stores like Riak,
>> Couch, or Mongo and be able to subscribe to queues based on queries (like
>> SQL views) which is something I've had on my mind recently. I dug into the
>> core RabbitMQ code the other day to see how feasible this would be and it
>> looks reasonably straightforward. I've been using Riak a lot lately, so I'd
>> likely start with that and the protobuff client.
>> What about metadata? I think that's all stored in mnesia now, right? How
>> hard would it be to keep that data in the same storage backend?
>> 
>> Thanks!
>> Jon Brisbin
>>         Web: http://jbrisbin.com/
>>     Twitter: @j_brisbin
>>       Skype: jon.brisbin
>> 
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>> 
>> 
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From alexis at rabbitmq.com  Mon Jan 17 22:45:25 2011
From: alexis at rabbitmq.com (Alexis Richardson)
Date: Mon, 17 Jan 2011 22:45:25 +0000
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
In-Reply-To: <48B46D33-5879-4F7C-8028-0DE2006CC70F@mozilla.com>
References: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
	<281A9A68-45ED-4375-A491-F44F96331052@vmware.com>
	<030E9479-2519-4F8C-81AA-B25293DE3093@jbrisbin.com>
	<AANLkTi=RVxTgdOJ-97FQ74WegcNGMTRFtFgLzR-d=pVt@mail.gmail.com>
	<48B46D33-5879-4F7C-8028-0DE2006CC70F@mozilla.com>
Message-ID: <AANLkTimSe7rX6AEN8cBJHL6PViyoPtNgC=c+r=N8XzcA@mail.gmail.com>

Christian

Congrats on Pulse btw!


On Mon, Jan 17, 2011 at 10:16 PM, Christian Legnitto
<clegnitto at mozilla.com> wrote:
> Would this just store undelivered messages (I think that's what's in the mnesia db currently) or would it be a store of all messages that have entered Rabbit (more like a historical message cache)? I'm interested in the latter, preferably with Riak.

The latter.

In fact the former are stored in our own persistent message heap
created by the team:
http://www.rabbitmq.com/blog/2010/08/27/growing-up/

Mnesia is used for things like bindings and other metadata.



> Now that I think about it, probably wouldn't be too hard to write a rabbit plugin that ships all messages from all exchanges over to Riak using the Riak erlang lib. Does something like that already exist?

No but as you point out it would be doable.  But a closer binding, at
the storage API layer, could be more useful - no?

alexis



> Thanks,
> Christian
>
> On Jan 17, 2011, at 12:31 PM, Alexis Richardson <alexis at rabbitmq.com> wrote:
>
>> Jon
>>
>> If you have the appetite for a Riak backend, using the storage API,
>> that would be interesting to see...
>>
>> alexis
>>
>>
>>
>> On Mon, Jan 17, 2011 at 8:22 PM, Jon Brisbin <jon at jbrisbin.com> wrote:
>>>
>>> On Jan 15, 2011, at 11:14 AM, Jerry Kuch wrote:
>>>
>>> Exist support for custom storage backends (like MySQL) in RabbitMQ 2.2 or
>>> not?
>>>
>>> Storage backends based on MySQL and Mnesia are currently under development.
>>> ?There has also been some discussion of various NoSQL stores, although no
>>> firm plans have been made. ?We should have something more to say in the near
>>> future.
>>>
>>> I think it would be cool to have messages stored in K/V stores like Riak,
>>> Couch, or Mongo and be able to subscribe to queues based on queries (like
>>> SQL views) which is something I've had on my mind recently. I dug into the
>>> core RabbitMQ code the other day to see how feasible this would be and it
>>> looks reasonably straightforward. I've been using Riak a lot lately, so I'd
>>> likely start with that and the protobuff client.
>>> What about metadata? I think that's all stored in mnesia now, right? How
>>> hard would it be to keep that data in the same storage backend?
>>>
>>> Thanks!
>>> Jon Brisbin
>>> ? ? ? ? Web: http://jbrisbin.com/
>>> ? ? Twitter: @j_brisbin
>>> ? ? ? Skype: jon.brisbin
>>>
>>> _______________________________________________
>>> rabbitmq-discuss mailing list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>>
>>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From jon.brisbin at npcinternational.com  Mon Jan 17 22:49:12 2011
From: jon.brisbin at npcinternational.com (Jon Brisbin)
Date: Mon, 17 Jan 2011 16:49:12 -0600
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
In-Reply-To: <48B46D33-5879-4F7C-8028-0DE2006CC70F@mozilla.com>
References: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
	<281A9A68-45ED-4375-A491-F44F96331052@vmware.com>
	<030E9479-2519-4F8C-81AA-B25293DE3093@jbrisbin.com>
	<AANLkTi=RVxTgdOJ-97FQ74WegcNGMTRFtFgLzR-d=pVt@mail.gmail.com>
	<48B46D33-5879-4F7C-8028-0DE2006CC70F@mozilla.com>
Message-ID: <C9A10C63-20F2-44DD-A117-6131156538F6@npcinternational.com>

On Jan 17, 2011, at 4:16 PM, Christian Legnitto wrote:

> Would this just store undelivered messages (I think that's what's in the mnesia db currently) or would it be a store of all messages that have entered Rabbit (more like a historical message cache)? I'm interested in the latter, preferably with Riak.

I'd think it would be trivial to do the latter by maintaining some metadata about the message (like setting a "delivered" flag).

> Now that I think about it, probably wouldn't be too hard to write a rabbit plugin that ships all messages from all exchanges over to Riak using the Riak erlang lib. Does something like that already exist?

I've tested the latest version of my webhooks plugin against Riak, so that might work for you if you're not using exclusive queues:

https://github.com/jbrisbin/rabbitmq-webhooks

It uses the HTTP API and forwards messages from queues to Riak (or any other HTTP server, for that matter).

jb


> 
> Thanks,
> Christian
> 
> On Jan 17, 2011, at 12:31 PM, Alexis Richardson <alexis at rabbitmq.com> wrote:
> 
>> Jon
>> 
>> If you have the appetite for a Riak backend, using the storage API,
>> that would be interesting to see...
>> 
>> alexis
>> 
>> 
>> 
>> On Mon, Jan 17, 2011 at 8:22 PM, Jon Brisbin <jon at jbrisbin.com> wrote:
>>> 
>>> On Jan 15, 2011, at 11:14 AM, Jerry Kuch wrote:
>>> 
>>> Exist support for custom storage backends (like MySQL) in RabbitMQ 2.2 or
>>> not?
>>> 
>>> Storage backends based on MySQL and Mnesia are currently under development.
>>> There has also been some discussion of various NoSQL stores, although no
>>> firm plans have been made.  We should have something more to say in the near
>>> future.
>>> 
>>> I think it would be cool to have messages stored in K/V stores like Riak,
>>> Couch, or Mongo and be able to subscribe to queues based on queries (like
>>> SQL views) which is something I've had on my mind recently. I dug into the
>>> core RabbitMQ code the other day to see how feasible this would be and it
>>> looks reasonably straightforward. I've been using Riak a lot lately, so I'd
>>> likely start with that and the protobuff client.
>>> What about metadata? I think that's all stored in mnesia now, right? How
>>> hard would it be to keep that data in the same storage backend?
>>> 
>>> Thanks!
>>> Jon Brisbin
>>>        Web: http://jbrisbin.com/
>>>    Twitter: @j_brisbin
>>>      Skype: jon.brisbin
>>> 
>>> _______________________________________________
>>> rabbitmq-discuss mailing list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>> 
>>> 
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


Jon Brisbin
Portal Webmaster
NPC International, Inc.

Twitter: @j_brisbin
Skype: jon.brisbin


From sameek at arosys.com  Tue Jan 18 04:59:11 2011
From: sameek at arosys.com (sam_mis)
Date: Mon, 17 Jan 2011 20:59:11 -0800 (PST)
Subject: [rabbitmq-discuss]  How to instantiate process from Rabbitmq?
Message-ID: <30693834.post@talk.nabble.com>


Hi
I want to instantiate  process as a message arrives in Rabbitmq queue.
how can i do this?
Thanks
-- 
View this message in context: http://old.nabble.com/How-to-instantiate-process-from-Rabbitmq--tp30693834p30693834.html
Sent from the RabbitMQ mailing list archive at Nabble.com.


From coolchen033 at gmail.com  Tue Jan 18 07:38:25 2011
From: coolchen033 at gmail.com (Kevin Chan)
Date: Tue, 18 Jan 2011 15:38:25 +0800
Subject: [rabbitmq-discuss] about msg_store_persistent folder
In-Reply-To: <20110113125440.GA1694@wellquite.org>
References: <AANLkTinkc22xi=8_6+e=M+H1rBaCkywS5XYZw_w94h7z@mail.gmail.com>
	<20110113125440.GA1694@wellquite.org>
Message-ID: <AANLkTi=RW6-SHuJvtpst5J6Hn7sChZxA7qQ1+JQWCHKT@mail.gmail.com>

Thanks Matthew

    as u say when the message has consumed the messages on disk will be
del,but i'm not sure that the message will be consumer in time,so i need to
keep have enough free disk ,i mount other partition to the rabbitmq folder
,it's success,but  the rabbitmq-server can not start,  is there anythings i
should do?

2011/1/13 Matthew Sackman <matthew at rabbitmq.com>

> Hi Kevin,
>
> On Thu, Jan 13, 2011 at 03:17:48PM +0800, Kevin Chan wrote:
> >   I send msg to rabbbitmq server ,on the server,the folder(
> > /var/lib/rabbitmq/mnesia/rabbit at localhost/msg_store_transient) size will
> > became bigger and bigger.how to deal with
> > it. may i del this folder's file when rabbitmq server running,or is there
> > any way to limmit the folder growing?
>
> The way to limit the folder growing is to consume and acknowledge
> messages from the broker. Rabbit will only write messages to disk which
> have not been consumed and when necessary - either the messages are
> being published persistent (delivery_mode = 2) or the broker is under
> memory pressure and is thus writing to disk to free up memory.
>
> If you stop the queues from growing (either by not publishing messages,
> or by consuming and acknowledging messages from the queues) then Rabbit
> will have no reason to write messages to disk.
>
> Matthew
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Kevin Chan

XiaMen China
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110118/c817125c/attachment-0001.htm>

From david at rabbitmq.com  Tue Jan 18 10:42:50 2011
From: david at rabbitmq.com (David Wragg)
Date: Tue, 18 Jan 2011 10:42:50 +0000
Subject: [rabbitmq-discuss] QoS prefetch and rabbitmq-c
In-Reply-To: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EA0A48EC@IS-EXCHANGEC101.wsod.local>
	(Paul Pearcy's message of "Thu, 16 Dec 2010 17:10:31 -0500")
References: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EA0A48EC@IS-EXCHANGEC101.wsod.local>
Message-ID: <yrv4cwrm2sdat.fsf@dwragg.eng.vmware.com>

Hi Paul,

Paul Pearcy <paul.pearcy at wallst.com> writes:
>   Don't see a direct way via rabbitmq-c to setup QoS prefetch count for a consumer. Searching the lists, I came across this thread, which seemed to have a sample for how to do this:
>
http://old.nabble.com/problem-with-new-persiter-with-1000-topics-queues-td29434516.html#a29476031

We've now updated rabbitmq-c to have full coverage of all the relevant
AMQP methods in its API, including an amqp_basic_qos function.  See the
latest code in hg or on github.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From majek04 at gmail.com  Tue Jan 18 11:40:38 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Tue, 18 Jan 2011 11:40:38 +0000
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate 583848200
 bytes of memory
In-Reply-To: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>
Message-ID: <AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>

On Mon, Jan 17, 2011 at 10:20, Mark Hudson <markrogerhudson at gmail.com> wrote:
> Hi, I'm experiencing?reproducible?crashes of?Erlang?when running
> RabbitMQ 2.20 on a clean install of 64 bit Windows server 2008 R2 box
>
> In particular I get
> "broker running
> Crash dump was written to: erl_crash.dump
> eheap_alloc: Cannot allocate 583848200 bytes of memory (of type "old_heap").
> This application has requested the Runtime to terminate it in an unusual way.
> Please contact the application's support team for more information."
> "Cannot allocate 583848200 bytes of memory (of type "old_heap")." is
> the same message talked about in the previous discussion.
> I find that rabbitmqctl.bat takes a while to
> return there are no queues, then the erl.exe process grows to about
> 650 meg before erland crashes dumping out

The problem is that although you're using 64 bit windows,
there is no 64 bit Erlang for windows.
Erlang in windows runs as 32-bit program.

Looking here:
http://msdn.microsoft.com/en-us/library/aa366778(v=VS.85).aspx
it looks like by default, without IMAGE_FILE_LARGE_ADDRESS_AWARE flag set,
32 bit processes can use only 2 GB of RAM.

Additionally, Erlang garbage collector works like that:
 - allocate a large chunk of continuous memory
 - rewrite data (skipping unused garbage)
 - free old memory

As a result, to run Erlang you need to always stay
below 50% available memory (to have other 50% available
for garbage collector).

As your process is using 650megs, and the virtual memory is limited
to 2GB, we're getting close to the boundary. Add some bad luck
with memory fragmentation, and erlang can easily fail to allocate
big chunk of continuous memory.

That's what happens to you.

Possible solutions:
 - upgrade to erlang >= R13B3
   http://www.lshift.net/blog/2009/12/01/garbage-collection-in-erlang
 - use multiple (smaller) queues (erlang GC should be isolated to
   memory used by one erlang process)
 - Configure 'vm_memory_high_watermark' value (as Jerry suggested).
   The smaller the value, the sooner Rabbit will stop accepting
   new messages and growing memory.
 - Switch to 64-bit operating system supported by Erlang.
 - Play with IMAGE_FILE_LARGE_ADDRESS_AWARE flag.

We're looking forward to see a proper 64-bit erlang release for windows,
but that's Ericsson's job.

Cheers,
   Marek

From majek04 at gmail.com  Tue Jan 18 11:48:33 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Tue, 18 Jan 2011 11:48:33 +0000
Subject: [rabbitmq-discuss] How to instantiate process from Rabbitmq?
In-Reply-To: <30693834.post@talk.nabble.com>
References: <30693834.post@talk.nabble.com>
Message-ID: <AANLkTimnRvp5fq=6n4ok=GH2ApeWa1o7WgEpTMpgd14-@mail.gmail.com>

On Tue, Jan 18, 2011 at 04:59, sam_mis <sameek at arosys.com> wrote:
> I want to instantiate ?process as a message arrives in Rabbitmq queue.
> how can i do this?

You write another program that sits on the queue and when message
arrives it starts your process.

You can start with this snippet:
https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/python/receive.py

Cheers,
  Marek

From majek04 at gmail.com  Tue Jan 18 12:54:33 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Tue, 18 Jan 2011 12:54:33 +0000
Subject: [rabbitmq-discuss] More RabbitMQ tutorials available
In-Reply-To: <AANLkTikA_MQDq+3tykci5dUKXkRQWFLsGLPx+f=6huFd@mail.gmail.com>
References: <AANLkTikA_MQDq+3tykci5dUKXkRQWFLsGLPx+f=6huFd@mail.gmail.com>
Message-ID: <AANLkTi=mJJn9=efMKrj6UrFqsfqa=L6s0iMD79H7g0oy@mail.gmail.com>

On Thu, Jan 6, 2011 at 15:29, Jim Apperly <jim at rabbitmq.com> wrote:
> I am delighted to announce that we have expanded the set of "Getting
> Started" tutorials available on the website.
> We now have:
> 1. "Hello World!" - the simplest thing that does something
> 2. Work queues - distributing tasks amongst workers
> 3. Publish/Subscribe - sending messages to many consumers at once
> 4. Routing *new* - receiving messages selectively
> 5. Topics *new* - receiving messages based on topic
> The tutorials are available at:
> http://www.rabbitmq.com/getstarted.html
> All of the tutorials come with code samples in Python. We are working on
> translating the samples into different languages and adding to the base set
> of subjects covered (I'm told that RPC is next, but don't hold me to that).

RPC tutorial is now published:

http://www.rabbitmq.com/tutorial-six-python.html

Cheers,
  Marek

From simon at rabbitmq.com  Tue Jan 18 13:53:43 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Tue, 18 Jan 2011 13:53:43 +0000
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
 Chrome
In-Reply-To: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
Message-ID: <4D359B67.2030806@rabbitmq.com>

On 17/01/11 08:56, Jon Rowland wrote:
> I left a test app running over the weekend which publishes 1000 msg/sec
> to a broker. I also left the management plugin page open on the Channels
> tab running in Chrome.
>
> I happened to notice that Chrome was using an enormous amount of memory
> ? over 1GB and very slowly increasing. As soon as I navigated to another
> page outside of the management console, without restarting the browser,
> the memory was released.
>
> No idea if this is ?bug? or ?feature? but thought you may be interested.

Hi Jon. I'm sure this is a bug, I'm just not sure if it's in 
rabbitmq-management or in Chrome :(

You're not supposed to be able to do anything to leak memory in 
JavaScript + HTML. In old browsers you're supposed to avoid circular 
references between DOM elements and closures, and AFAICS we do that. So 
if there is some bugfix or workaround I'm not sure how to find it.

At the moment the best advice I can give is to decrease the refresh 
frequency if this is a problem...

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From jon at jbrisbin.com  Tue Jan 18 14:29:57 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Tue, 18 Jan 2011 08:29:57 -0600
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
In-Reply-To: <281A9A68-45ED-4375-A491-F44F96331052@vmware.com>
References: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
	<281A9A68-45ED-4375-A491-F44F96331052@vmware.com>
Message-ID: <6AF334DB-48FA-4B2C-A4B5-E9DD49A7E942@jbrisbin.com>


On Jan 15, 2011, at 11:14 AM, Jerry Kuch wrote:

> If a plugin for your store of choice doesn't exist, then one writes a storage plugin, in Erlang, by implementing the rabbit_backing_queue behaviour, which effectively makes up the storage API, and talks to the storage system of your choice.

A couple quick questions about this:

Should a replacement rabbit_backing_queue be packaged as a regular plugin?

How would I configure the broker to use my own storage module?

Should one start with rabbit_variable_queue.erl and replace only the bits that talk to the message store (leaving the memory management logic intact) as a first step?

It would probably be a good idea to look at the content type of the message to figure out how to store it in the backing store, right (which would open the possibility of working with message data independently of the broker by interrogating its contents)?

Would it be a bad idea to have store-side code as part of the storage system? In particular, I'm thinking about having Erlang-language M/R code or event triggers which would need to be installed into the server (Riak in this case) to manage indexes and metadata. In general, I don't like the idea of having to install things in more than one place. It would probably make some things considerably easier (and more performant), though.


Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110118/688f4b57/attachment.htm>

From jon.rowland at isam.com  Tue Jan 18 14:49:28 2011
From: jon.rowland at isam.com (Jon Rowland)
Date: Tue, 18 Jan 2011 08:49:28 -0600
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
 Chrome
In-Reply-To: <4D359B67.2030806@rabbitmq.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D359B67.2030806@rabbitmq.com>
Message-ID: <985477893245CF449ABD4F01814A9FF65F41CB3D7A@34093-MBX-C06.mex07a.mlsrvr.com>

Thanks - it's no problem for me, but I thought it worth reporting.

I also don't have the required skills/knowledge to probe any deeper unfortunately...

-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Simon MacMullen
Sent: 18 January 2011 13:54
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] RabbitMQ management plugin memory usage in Chrome

On 17/01/11 08:56, Jon Rowland wrote:
> I left a test app running over the weekend which publishes 1000 msg/sec
> to a broker. I also left the management plugin page open on the Channels
> tab running in Chrome.
>
> I happened to notice that Chrome was using an enormous amount of memory
> - over 1GB and very slowly increasing. As soon as I navigated to another
> page outside of the management console, without restarting the browser,
> the memory was released.
>
> No idea if this is 'bug' or 'feature' but thought you may be interested.

Hi Jon. I'm sure this is a bug, I'm just not sure if it's in 
rabbitmq-management or in Chrome :(

You're not supposed to be able to do anything to leak memory in 
JavaScript + HTML. In old browsers you're supposed to avoid circular 
references between DOM elements and closures, and AFAICS we do that. So 
if there is some bugfix or workaround I'm not sure how to find it.

At the moment the best advice I can give is to decrease the refresh 
frequency if this is a problem...

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From mlortiz at uci.cu  Tue Jan 18 15:54:46 2011
From: mlortiz at uci.cu (Ing. Marcos Ortiz Valmaseda)
Date: Tue, 18 Jan 2011 10:54:46 -0500 (CST)
Subject: [rabbitmq-discuss] Advices for new developers to work in RabbitMQ
	Development
In-Reply-To: <AANLkTinR=k_vA7b_O5Bfyd76-TyLdz1LQ57o8e0q397m@mail.gmail.com>
Message-ID: <319721238.48630511295366086885.JavaMail.root@ucimail4.uci.cu>


Regards to all the list
I?m very interested to work on the RabbitMQ development but I need some advices to work on it. For example, I have several questions about:

 - Do you are using a Project Management Platform for it?
 - Do you have a TODO list?
 - Where is the source repository? If you have a Git mirror, is better for me, although I don?t have trouble with another SVC system.
 - How the new developers can include new documents on the official documentation?
 - Is there a mentoring mechanism? It's very useful in many open source projects to work aside a experienced developer to learn and to help 
   on the same time
 - Is there a Milestone for the 2.3 version?
 - Is there a kind of RabbitMQ Developer Summit?
 

Thanks a lot for your time.

Ing. Marcos Lu?s Ort?z Valmaseda
Linux User # 418229 && PostgreSQL DBA
Centro de Tecnolog?as Gesti?n de Datos (DATEC)
http://postgresql.uci.cu
http://www.postgresql.org
http://it.toolbox.com/blogs/sql-apprentice

From aaron at agoragames.com  Tue Jan 18 16:17:27 2011
From: aaron at agoragames.com (Aaron Westendorf)
Date: Tue, 18 Jan 2011 11:17:27 -0500
Subject: [rabbitmq-discuss] 0.9.1, recover-async vs. recover
Message-ID: <AANLkTimogSEEX-s=2GdL3bn+G_+UaTCSm+3WMrAf37R7@mail.gmail.com>

The specification for these two methods is somewhat confusing.  The
descriptions imply that basic.recover is a synchronous method, but it
is not specified as such.  Anyone have insight on this?

-Aaron


1.8.3.15. Method?basic.recover?-async?(ID?100)
Synchronous: No
This?method?asks?the?server?to?redeliver?all?unacknowledged?messages
on?a?specified?channel.?Zero?or
more?messages?may?be?redelivered.?This?method?is?deprecated?in?favour
of?the?synchronous
Recover/Recover?Ok.

1.8.3.16. Method?basic.recover?(ID?110)
Synchronous: No
This?method?asks?the?server?to?redeliver?all?unacknowledged?messages
on?a?specified?channel.?Zero?or
more?messages?may?be?redelivered.?This?method?replaces?the
asynchronous?Recover.


-- 
Aaron Westendorf
Senior Software Engineer
Agora Games
359 Broadway
Troy, NY 12180
Phone: 518.268.1000
aaron at agoragames.com
www.agoragames.com

From simon at rabbitmq.com  Tue Jan 18 16:20:51 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Tue, 18 Jan 2011 16:20:51 +0000
Subject: [rabbitmq-discuss] 0.9.1, recover-async vs. recover
In-Reply-To: <AANLkTimogSEEX-s=2GdL3bn+G_+UaTCSm+3WMrAf37R7@mail.gmail.com>
References: <AANLkTimogSEEX-s=2GdL3bn+G_+UaTCSm+3WMrAf37R7@mail.gmail.com>
Message-ID: <4D35BDE3.8090505@rabbitmq.com>

On 18/01/11 16:17, Aaron Westendorf wrote:
> The specification for these two methods is somewhat confusing.  The
> descriptions imply that basic.recover is a synchronous method, but it
> is not specified as such.  Anyone have insight on this?

Ugh.

recover *is* synchronous, I promise you :)

But it looks like the spec XML file contains an error; it is not marked 
as such.

Cheers, Simon
-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From aaron at agoragames.com  Tue Jan 18 16:25:59 2011
From: aaron at agoragames.com (Aaron Westendorf)
Date: Tue, 18 Jan 2011 11:25:59 -0500
Subject: [rabbitmq-discuss] 0.9.1, recover-async vs. recover
In-Reply-To: <4D35BDE3.8090505@rabbitmq.com>
References: <AANLkTimogSEEX-s=2GdL3bn+G_+UaTCSm+3WMrAf37R7@mail.gmail.com>
	<4D35BDE3.8090505@rabbitmq.com>
Message-ID: <AANLkTimofW76rpyNMESrtHvxXD8ZyXvu4v0p1Ktyvr2T@mail.gmail.com>

Thank you much :)

cheers,
Aaron

On Tue, Jan 18, 2011 at 11:20 AM, Simon MacMullen <simon at rabbitmq.com> wrote:
> On 18/01/11 16:17, Aaron Westendorf wrote:
>>
>> The specification for these two methods is somewhat confusing. ?The
>> descriptions imply that basic.recover is a synchronous method, but it
>> is not specified as such. ?Anyone have insight on this?
>
> Ugh.
>
> recover *is* synchronous, I promise you :)
>
> But it looks like the spec XML file contains an error; it is not marked as
> such.
>
> Cheers, Simon
> --
> Simon MacMullen
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
Aaron Westendorf
Senior Software Engineer
Agora Games
359 Broadway
Troy, NY 12180
Phone: 518.268.1000
aaron at agoragames.com
www.agoragames.com

From moseley at hank.org  Tue Jan 18 16:26:41 2011
From: moseley at hank.org (Bill Moseley)
Date: Tue, 18 Jan 2011 08:26:41 -0800
Subject: [rabbitmq-discuss] RabbitMQ C library + Perl
Message-ID: <AANLkTi=sTXnVXG+8j2Z5v11xSaZbK9HvwsuyN4mKEe-P@mail.gmail.com>

We have C and C++ code that needs to talk to RabbitMQ.  I have a few
questions about the C library.

I hope I have not missed something obvious, but Is there documentation for
librabbitmq, the C library found at http://hg.rabbitmq.com/rabbitmq-c/ ?

I've also been using the Net::RabbitMQ Perl module for some tests.  It's
lacking a number of features available with RabbitMQ (which Emile has helped
resolve). But, I'm a little unclear about the Perl module.  It seems to
included some version of the librabbitmq code -- for example amqp_api.c has
some similarities with librabbitmq:

http://hg.rabbitmq.com/rabbitmq-c/file/68f0c4b68086/librabbitmq/amqp_api.c#l122
http://cpansearch.perl.org/src/JESUS/Net-RabbitMQ-0.1.8/amqp_api.c

Does the Perl module embed the needed librabbitmq code because the library's
API changes over time and would thus break?  I would think a more typical
approach would be for the Perl module to just link to librabbitmq so that
the Perl module and the library can be managed separately.

So, my question (besides about documentation) is if I needed to update the
Perl module for my use (to expose more features of RabbitMQ) would it be
better to remove the embedded library code and instead try and link to
librabbitmq installed separately?

My Perl XS and C skills are pretty rusty, so I suspect I'll need some
additional help.  If anyone is interested in helping with this please let me
know.



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110118/e56eb369/attachment.htm>

From david at rabbitmq.com  Tue Jan 18 16:38:08 2011
From: david at rabbitmq.com (David Wragg)
Date: Tue, 18 Jan 2011 16:38:08 +0000
Subject: [rabbitmq-discuss] Advices for new developers to work in
	RabbitMQ Development
In-Reply-To: <319721238.48630511295366086885.JavaMail.root@ucimail4.uci.cu>
	(Ing. Marcos Ortiz Valmaseda's message of "Tue, 18 Jan 2011 10:54:46
	-0500 (CST)")
References: <319721238.48630511295366086885.JavaMail.root@ucimail4.uci.cu>
Message-ID: <yrv4c8vyirwun.fsf@dwragg.eng.vmware.com>

"Ing. Marcos Ortiz Valmaseda" <mlortiz at uci.cu> writes:
> I?m very interested to work on the RabbitMQ development but I need some advices to work on it. For example, I have several questions about:
>
>  - Do you are using a Project Management Platform for it?

Does bugzilla counts as a Project Management Platform?

>  - Do you have a TODO list?

Does bugzilla counts as a TODO list?

>  - Where is the source repository? If you have a Git mirror, is better
>  for me, although I don?t have trouble with another SVC system.

The primary source repositories are in Mercurial at
<http://hg.rabbitmq.com/>

We also mirror the source code to gitub at
<https://github.com/rabbitmq>.

>  - How the new developers can include new documents on the official
>  documentation?

Some official documentation lives in the source code repos, and we are
happy to take contributions to those docs in the same way as for for
code contributions.

Other official documentation is on the web site.  That content lives in
a private repository (it might not be that way for ever, but there are
reasons it is that way now).  But we're very happy to receive
suggestions and feedback on the web site.

If you want to contribute a new area of documentation, probably the best
way is to put it up on your own web site or blog.  Then, if it makes
sense, we can discuss linking to it from our web site, or even taking it
as a contribution to our web site.

>  - Is there a mentoring mechanism? It's very useful in many open
>  source projects to work aside a experienced developer to learn and to
>  help on the same time

The RabbitMQ developers all read this mailing list, and we're happy to
take questions here.  It's up to individual developers whether they are
available on other channels.

>  - Is there a Milestone for the 2.3 version?

We aim for frequent releases, rather than committing to particular
features in particular releases.

>  - Is there a kind of RabbitMQ Developer Summit?

There hasn't been one yet.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From paul.pearcy at wallst.com  Tue Jan 18 16:52:52 2011
From: paul.pearcy at wallst.com (Paul Pearcy)
Date: Tue, 18 Jan 2011 11:52:52 -0500
Subject: [rabbitmq-discuss] Confusion about location
	of	Windows	rabbitmq.config
In-Reply-To: <4D32DBC4.2090200@rabbitmq.com>
References: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E407C@IS-EXCHANGEC101.wsod.local>
	<4D32DBC4.2090200@rabbitmq.com>
Message-ID: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E41CF@IS-EXCHANGEC101.wsod.local>

Thanks for the details. Not a big deal, but those two values do disagree once you change your RABBITMQ_BASE from the default. 

Matt was able to point me in the right direction:
"you need to set the config file env var, and then uninstall and reinstall the Rabbit service. Just stopping and restarting the service doesn't seem to do the trick."

Thanks!



-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Simon MacMullen
Sent: Sunday, January 16, 2011 4:52 AM
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Confusion about location of Windows rabbitmq.config

On 13/01/2011 6:59PM, Paul Pearcy wrote:
> Hello,
>
> I have been through the install docs a couple of times and am still
> baffled about the location of the rabbitmq.config file on Windows. There
> are two sections:
>
> RABBITMQ_CONFIG_FILE
>
> Defaults to%RABBITMQ_BASE%\rabbitmq.
<snip>
> Then in the link for the configuration file, there are the following
> details:
>
> The location of this configuration file is distribution specific. By
> default, it is located in the following places on each platform:
>
> *Windows- %APPDATA%\RabbitMQ\rabbitmq.config
<snip>
> Maybe I am missing something obvious, but these seem to disagree.

I don't think they do, since RABBITMQ_BASE defaults to %APPDATA%\RabbitMQ.

> I have attempted to be explicit instead by setting the following env var:
>
> RABBITMQ_CONFIG_FILE= D:\rabbitmq\rabbitmq
>
> I would then expect this to pick up this config file:
>
> D:\rabbitmq\rabbitmq.config

That looks correct.

> However, none of my settings are taking effect and I can't figure out
> how to tell which config file the rabbitmq install is picking up. What
> is the easiest way for rabbitmq to tell me where it is looking for the
> config file?

Hmm. At the moment, I think you would need to add an echo statement to 
the rabbitmq-server.bat file, something like:

echo CONFIG FILE: !RABBITMQ_CONFIG_FILE!.config

around line 136 or so.

We should probably display this location on startup though.

Cheers, Simon
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From paul.pearcy at wallst.com  Tue Jan 18 16:53:05 2011
From: paul.pearcy at wallst.com (Paul Pearcy)
Date: Tue, 18 Jan 2011 11:53:05 -0500
Subject: [rabbitmq-discuss] Confusion about location of Windows
 rabbitmq.config
In-Reply-To: <20110116130615.GA17191@wellquite.org>
References: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E407C@IS-EXCHANGEC101.wsod.local>
	<4D32DBC4.2090200@rabbitmq.com> <20110116130615.GA17191@wellquite.org>
Message-ID: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E41D0@IS-EXCHANGEC101.wsod.local>

That was it... Many thanks!!!

-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Matthew Sackman
Sent: Sunday, January 16, 2011 6:06 AM
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Confusion about location of Windows rabbitmq.config

Note that if you're using the service rather just starting Rabbit
directly from the -server.bat, then you need to set the config file env
var, and then uninstall and reinstall the Rabbit service. Just stopping
and restarting the service doesn't seem to do the trick.

Matthew
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From david at rabbitmq.com  Tue Jan 18 16:57:19 2011
From: david at rabbitmq.com (David Wragg)
Date: Tue, 18 Jan 2011 16:57:19 +0000
Subject: [rabbitmq-discuss] RabbitMQ C library + Perl
In-Reply-To: <AANLkTi=sTXnVXG+8j2Z5v11xSaZbK9HvwsuyN4mKEe-P@mail.gmail.com>
	(Bill Moseley's message of "Tue, 18 Jan 2011 08:26:41 -0800")
References: <AANLkTi=sTXnVXG+8j2Z5v11xSaZbK9HvwsuyN4mKEe-P@mail.gmail.com>
Message-ID: <yrv4c4o96rvyo.fsf@dwragg.eng.vmware.com>

Hi Bill,

Bill Moseley <moseley at hank.org> writes:
> We have C and C++ code that needs to talk to RabbitMQ.  I have a few
> questions about the C library.
>
> I hope I have not missed something obvious, but Is there documentation for
> librabbitmq, the C library found at http://hg.rabbitmq.com/rabbitmq-c/
> ?

No, there's no formal documentation for it yet.  Though if you are
familiar with the AMQP 0.8/0.9.1 spec, or one of our client libraries
for another language, the API of librabbitmq should be largely
self-explanatory.  And there is sample code in the "examples" and
"tools" directories.

> I've also been using the Net::RabbitMQ Perl module for some tests.  It's
> lacking a number of features available with RabbitMQ (which Emile has helped
> resolve). But, I'm a little unclear about the Perl module.  It seems to
> included some version of the librabbitmq code -- for example amqp_api.c has
> some similarities with librabbitmq:
>
> http://hg.rabbitmq.com/rabbitmq-c/file/68f0c4b68086/librabbitmq/amqp_api.c#l122
> http://cpansearch.perl.org/src/JESUS/Net-RabbitMQ-0.1.8/amqp_api.c
>
> Does the Perl module embed the needed librabbitmq code because the library's
> API changes over time and would thus break?  I would think a more typical
> approach would be for the Perl module to just link to librabbitmq so that
> the Perl module and the library can be managed separately.

Well, you'll have to ask to author of the Perl module for an official
answer.  But I would guess that it's due to the fact that we have not
done formal versioned releases of rabbitmq-c yet.

> So, my question (besides about documentation) is if I needed to update the
> Perl module for my use (to expose more features of RabbitMQ) would it be
> better to remove the embedded library code and instead try and link to
> librabbitmq installed separately?
>
> My Perl XS and C skills are pretty rusty, so I suspect I'll need some
> additional help.  If anyone is interested in helping with this please let me
> know.

My Perl XS knowledge has rusted away completely, I'm afraid.  Assuming
that the embedded source code is just an old copy of librabbitmq, I
expect that removing it will work, as long as the module build process
can find the librabbitmq headers and library.  But the only way to be
sure is to give it a go.  If you run into problems on the librabbitmq
side, I may be able to help.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From paul.pearcy at wallst.com  Tue Jan 18 17:23:36 2011
From: paul.pearcy at wallst.com (Paul Pearcy)
Date: Tue, 18 Jan 2011 12:23:36 -0500
Subject: [rabbitmq-discuss] QoS prefetch and rabbitmq-c
In-Reply-To: <yrv4cwrm2sdat.fsf@dwragg.eng.vmware.com>
References: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EA0A48EC@IS-EXCHANGEC101.wsod.local>
	<yrv4cwrm2sdat.fsf@dwragg.eng.vmware.com>
Message-ID: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E41DB@IS-EXCHANGEC101.wsod.local>

Sweet, thanks!!!

-----Original Message-----
From: David Wragg [mailto:david at rabbitmq.com] 
Sent: Tuesday, January 18, 2011 3:43 AM
To: Paul Pearcy
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] QoS prefetch and rabbitmq-c

Hi Paul,

Paul Pearcy <paul.pearcy at wallst.com> writes:
>   Don't see a direct way via rabbitmq-c to setup QoS prefetch count for a consumer. Searching the lists, I came across this thread, which seemed to have a sample for how to do this:
>
http://old.nabble.com/problem-with-new-persiter-with-1000-topics-queues-td29434516.html#a29476031

We've now updated rabbitmq-c to have full coverage of all the relevant
AMQP methods in its API, including an amqp_basic_qos function.  See the
latest code in hg or on github.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From robin at digininja.org  Tue Jan 18 20:13:10 2011
From: robin at digininja.org (Robin Wood)
Date: Tue, 18 Jan 2011 20:13:10 +0000
Subject: [rabbitmq-discuss] php talking to ruby
Message-ID: <AANLkTi=-KqsOgr5W2G4qT661=5xZcr10V1poeCC_HGFc@mail.gmail.com>

Hi
I'm trying to get Ruby, using the AMQP gem to talk to PHP using the
php-amqp library. Both on their own work and talk between their own
consumer/publisher but I can't get them to talk cross language.

Before I post my randomly hacked together code does anyone have good
sample code that shows the two languages talking to each other?

I'm new to MQ stuff but roughly what I'm seeing is the channel and
queues are being created OK and messages are being sent but when I
watch them in Wireshark I see the PHP one has a content type of
plain/text but the Ruby message has application/octet.

Any tips?

Robin

From jerryk at vmware.com  Tue Jan 18 20:58:54 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Tue, 18 Jan 2011 12:58:54 -0800
Subject: [rabbitmq-discuss] Custom storage backends for queues (MySQL)
In-Reply-To: <6AF334DB-48FA-4B2C-A4B5-E9DD49A7E942@jbrisbin.com>
References: <566328.13683.qm@web114614.mail.gq1.yahoo.com>
	<281A9A68-45ED-4375-A491-F44F96331052@vmware.com>,
	<6AF334DB-48FA-4B2C-A4B5-E9DD49A7E942@jbrisbin.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC07@EXCH-MBX-3.vmware.com>

Hi, Jon...

> A couple quick questions about this:
>
> Should  a replacement  rabbit_backing_queue be  packaged as  a regular
> plugin?

I don't see why not; this is how I've packaged the skeleton of what
I'm doing with MySQL.  John D plans to do the same but for the moment
is working in place in his server directory since it was convenient to
get started prototyping and exploring that way.  I imagine he'll
consume my packaging into his working branch shortly.

> How would I configure the broker to use my own storage module?

You need to edit your rabbitmq.config file a la:

[
  {rabbit, [{backing_queue_module, rabbit_weirdball_queue}]}
].

...and of course make sure your plugin is appropriately packaged with
your backing queue module and its dependencies in it, and then either
present in, or symlinked from, your broker's plugins directory.  That 
part's pretty easy, modulo potentially some minor Erlang load path 
gremlins.

> Should one start with rabbit_variable_queue.erl and replace only the
> bits that talk to the message store (leaving the memory management
> logic intact) as a first step?

The easy answer there is a bit less obvious, and may depend on what
your objectives are for your storage plugin.  If others watching have
opinions or thoughts, they should jump in.

The rabbit_variable_queue implementation is fairly complex, and
contains a lot of logic for things like monitoring message rates and
tweaking writes to the rabbit_msg_store in response to them.  Your
plugin may or may not want to do that in exactly the same way (or at
all).  One reason, for example, that one might want to write a storage
plugin would be to inherit some reliability or recovery properties
from whatever storage system lies behind it, in which case you might
want to write more things more often than r_v_q does.

John's been hacking on an Mnesia-based backing queue which he started
from a very stripped down r_v_q.  There's also a sort of base case-ish 
"RAM queue" extractable from that which shows a nice path to getting a
working minimal backing_queue implementation that can keep a broker 
running and passing tests etc. while one works from it.  We can chat 
about such things when we talk on the phone.  It might be instructive 
to look at his stuff once he's done a bit more tidying on it.

> It would probably be a good idea to look at the content type of the
> message to figure out how to store it in the backing store, right
> (which would open the possibility of working with message data
> independently of the broker by interrogating its contents)?

Very possibly.  In fact mapping the contents of a stored message to a
representation suitable for a given back end seems like it would
require varying amounts and types of thought tailored to the storage
system in question to minimize awkward impedance mismatches,
performance problems, correctness issues, etc.

> Would it be a bad idea to have store-side code as part of the storage
> system? In particular, I'm thinking about having Erlang-language M/R
> code or event triggers which would need to be installed into the
> server (Riak in this case) to manage indexes and metadata. In general,
> I don't like the idea of having to install things in more than one
> place. It would probably make some things considerably easier (and
> more performant), though.

I'm definitely not sure but very interested in talking further and
learning more about what you have in mind?

I'll dredge up our phone conference info, and get back to you 
separately...

Best regards,
Jerry

From jerryk at vmware.com  Tue Jan 18 21:23:44 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Tue, 18 Jan 2011 13:23:44 -0800
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate 583848200
 bytes of memory
In-Reply-To: <AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>,
	<AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC0C@EXCH-MBX-3.vmware.com>

A couple more small remarks on the somewhat less than optimal Windows
situation...

> Possible solutions:
>  - upgrade to erlang >= R13B3

Be warned that the results of doing so currently appear to be a bit on
the "meh" side.  In some cases we've seen the onset of the problem be
delayed a little bit, but happen anyway, even with version 14B01.

>  - Configure 'vm_memory_high_watermark' value (as Jerry suggested).
>    The smaller the value, the sooner Rabbit will stop accepting
>    new messages and growing memory.

This is probably the most applicable advice we have at this point. If
you do try it with a lower watermark value, say something like 0.2,
we're interested in hearing what results you experience as the
behavior Marek mentions kicks in, and whether they're sufficient to
keep the crashes at bay while not unacceptably compromising
throughput.

>  - Play with IMAGE_FILE_LARGE_ADDRESS_AWARE flag.

Also, be aware that just hacking this bit on the executable doesn't
necessarily mean that the code within the executable is going to do
the right thing, even if you're running a version of Windows that's
been booted with the appropriate settings to induce a 3GB/1GB
user/kernel split rather than the default 2GB/2GB.  Historically, some
32-bit applications under Windows have played funny games with pointer
arithmetic and made assumptions about pointer values that can result
in them misbehaving if user space doesn't end around the usual 2GB
boundary.  I have no idea if the Windows release of Erlang is one of
them.

Best regards,
Jerry

From markjreed at gmail.com  Tue Jan 18 23:20:14 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Tue, 18 Jan 2011 18:20:14 -0500
Subject: [rabbitmq-discuss] Management plugin issues
Message-ID: <AANLkTik1nXYFEzp4ffOf9iroU9kMPD=qtjPi7_VAsj7T@mail.gmail.com>

I'm having a couple problems with the management plugin on
2.2.0/Erlang 13B/Ubuntu 10.04.

First, I have several independent rabbitmq clusters, but they all seem
to wind up reporting back to the same stats database.  I assume this
is some Erlang network service advertising feature, but I'd much
rather have each cluster use its own separate stats db.  How can I
force that?

Second, it keeps dying.  That is, the nodes are running, but the
statistics database goes down, and I have to restart the node that
contains it to get the management API back.  I'm seeing messages like
this in the log:

=CRASH REPORT==== 18-Jan-2011::17:12:02 ===
  crasher:
    initial call: rabbit_mgmt_db:init/1
    pid: <0.289.0>
    registered_name: []
    exception exit: {{badmatch,[]},
                     [{rabbit_mgmt_db,augment_queue_pid,2},
                      {rabbit_mgmt_db,augment,4},
                      {rabbit_mgmt_db,'-augment/3-lc$^0/1-0-',3},
                      {rabbit_mgmt_db,'-augment/3-lc$^0/1-0-',3},
                      {rabbit_mgmt_db,augment,3},
                      {rabbit_mgmt_db,'-handle_call/3-lc$^4/1-4-',4},
                      {rabbit_mgmt_db,'-handle_call/3-fun-2-',4},
                      {rabbit_mgmt_db,handle_call,3}]}
      in function  gen_server:terminate/6
    ancestors: [<0.288.0>,rabbit_sup,<0.122.0>]
    messages: []
    links: [<0.288.0>]
    dictionary: []
    trap_exit: false
    status: running
    heap_size: 377
    stack_size: 24
    reductions: 2235592
  neighbours:

Can anyone advise as to next steps in troubleshooting?



-- 
Mark J. Reed <markjreed at gmail.com>

From akalend at mail.ru  Tue Jan 18 23:43:15 2011
From: akalend at mail.ru (Alexandre Kalendarev)
Date: Wed, 19 Jan 2011 02:43:15 +0300
Subject: [rabbitmq-discuss] =?windows-1251?q?php_talking_to_ruby?=
In-Reply-To: <AANLkTi-KqsOgr5W2G4qT661=5xZcr10V1poeCC_HGFc@mail.gmail.com>
References: <AANLkTi-KqsOgr5W2G4qT661=5xZcr10V1poeCC_HGFc@mail.gmail.com>
Message-ID: <E1PfLCl-0006Hj-00.akalend-mail-ru@f255.mail.ru>

Robin,

You must to use the universal  data  format : JSON or XML, or other conventional dataformat.


Alexandre


Tue, 18 Jan 2011 20:13:10 +0000 ?????? ?? Robin Wood <robin at digininja.org>:

> Hi
> I'm trying to get Ruby, using the AMQP gem to talk to PHP using the
> php-amqp library. Both on their own work and talk between their own
> consumer/publisher but I can't get them to talk cross language.
> 
> Before I post my randomly hacked together code does anyone have good
> sample code that shows the two languages talking to each other?
> 
> I'm new to MQ stuff but roughly what I'm seeing is the channel and
> queues are being created OK and messages are being sent but when I
> watch them in Wireshark I see the PHP one has a content type of
> plain/text but the Ruby message has application/octet.
> 
> Any tips?
> 
> Robin
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


From robin at digininja.org  Tue Jan 18 23:45:19 2011
From: robin at digininja.org (Robin Wood)
Date: Tue, 18 Jan 2011 23:45:19 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <E1PfLCl-0006Hj-00.akalend-mail-ru@f255.mail.ru>
References: <AANLkTi-KqsOgr5W2G4qT661=5xZcr10V1poeCC_HGFc@mail.gmail.com>
	<E1PfLCl-0006Hj-00.akalend-mail-ru@f255.mail.ru>
Message-ID: <AANLkTiknL4G95nsAVMv3mbHEX92yiGVyGe0+UyiJTpBq@mail.gmail.com>

2011/1/18 Alexandre Kalendarev <akalend at mail.ru>:
> Robin,
>
> You must to use the universal ?data ?format : JSON or XML, or other conventional dataformat.
>

I'm completely new to RabbitMQ, any pointers as to where to look for
this? Do you know if both the libraries I've chosen will do this?

Robin

> Alexandre
>
>
> Tue, 18 Jan 2011 20:13:10 +0000 ?????? ?? Robin Wood <robin at digininja.org>:
>
>> Hi
>> I'm trying to get Ruby, using the AMQP gem to talk to PHP using the
>> php-amqp library. Both on their own work and talk between their own
>> consumer/publisher but I can't get them to talk cross language.
>>
>> Before I post my randomly hacked together code does anyone have good
>> sample code that shows the two languages talking to each other?
>>
>> I'm new to MQ stuff but roughly what I'm seeing is the channel and
>> queues are being created OK and messages are being sent but when I
>> watch them in Wireshark I see the PHP one has a content type of
>> plain/text but the Ruby message has application/octet.
>>
>> Any tips?
>>
>> Robin
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From chen650 at yahoo.com  Tue Jan 18 23:48:26 2011
From: chen650 at yahoo.com (alex chen)
Date: Tue, 18 Jan 2011 15:48:26 -0800 (PST)
Subject: [rabbitmq-discuss] Regarding the non-blocking call of
	"amqp_simple_wait_frame"
In-Reply-To: <yrv4czkqzx45w.fsf@dwragg.eng.vmware.com>
References: <8E948648-1545-40DD-94CA-B92DD132B1B3@yahoo-inc.com>
	<yrv4czkqzx45w.fsf@dwragg.eng.vmware.com>
Message-ID: <987029.61239.qm@web31806.mail.mud.yahoo.com>

David,

couple of months ago i submitted a patch to support read_timeout in rabbitmq-c.  

http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-June/007453.html
I remembered getting email from you about adding this patch to the src later.

attached please find the patch again.  it uses select() to timeout on read, so 
the wait_frame() would not block forever.
we have used it in production for 6 months without any problems.
thanks.

-alex



________________________________
From: David Wragg <david at rabbitmq.com>
To: Deepak Vijayvergiy <vdeepak at yahoo-inc.com>
Cc: "rabbitmq-discuss at lists.rabbitmq.com" <rabbitmq-discuss at lists.rabbitmq.com>
Sent: Mon, January 17, 2011 1:36:43 AM
Subject: Re: [rabbitmq-discuss] Regarding the non-blocking call of 
"amqp_simple_wait_frame"

Hi Deepak,

Deepak Vijayvergiy <vdeepak at yahoo-inc.com> writes:
> I am implementing RabbitMQ-C client library in my c++ project and I
> have a question about the message reading from the queue.  We need to
> call the function amqp_simple_wait_frame(), and we are blocked here to
> get the result, and then return when we get the message.  Question is:
> Do you also have some other way in which we can read the message
> without blocking?

rabbitmq-c does not currently support non-blocking operation.  You could
use threads though: have one thread responsible for AMQP communictions,
which passes recieved messages to other threads for procesing.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss



      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110118/010ff33a/attachment-0001.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbitmq-c.patch
Type: text/x-patch
Size: 3998 bytes
Desc: not available
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110118/010ff33a/attachment-0001.bin>

From pdezwart at rubiconproject.com  Wed Jan 19 03:16:40 2011
From: pdezwart at rubiconproject.com (Pieter de Zwart)
Date: Tue, 18 Jan 2011 19:16:40 -0800
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTiknL4G95nsAVMv3mbHEX92yiGVyGe0+UyiJTpBq@mail.gmail.com>
Message-ID: <C95B9798.161BB%pdezwart@rubiconproject.com>

Robin,

There is no reason why you cant do this. We are currently actively using the
PHP PECL extension to read messages published by both a Perl and Python
client. I know I hate it when people ask this of me, but could you cobble
together some very basic sample code and let us know what client versions
you are using? If it's the PHP client's fault, I will be more than happy to
fix it.

me


On 1/18/11 3:45 PM, "Robin Wood" <robin at digininja.org> wrote:

> 2011/1/18 Alexandre Kalendarev <akalend at mail.ru>:
> Robin,
>
> You must to use
> the universal ?data ?format : JSON or XML, or other conventional
> dataformat.
>

I'm completely new to RabbitMQ, any pointers as to where to
> look for
this? Do you know if both the libraries I've chosen will do
> this?

Robin

> Alexandre
>
>
> Tue, 18 Jan 2011 20:13:10 +0000 ?????? ??
> Robin Wood <robin at digininja.org>:
>
>> Hi
>> I'm trying to get Ruby, using the
> AMQP gem to talk to PHP using the
>> php-amqp library. Both on their own work
> and talk between their own
>> consumer/publisher but I can't get them to talk
> cross language.
>>
>> Before I post my randomly hacked together code does
> anyone have good
>> sample code that shows the two languages talking to each
> other?
>>
>> I'm new to MQ stuff but roughly what I'm seeing is the channel
> and
>> queues are being created OK and messages are being sent but when I
>>
> watch them in Wireshark I see the PHP one has a content type of
>> plain/text
> but the Ruby message has application/octet.
>>
>> Any tips?
>>
>> Robin
>>
> _______________________________________________
>> rabbitmq-discuss mailing
> list
>> rabbitmq-discuss at lists.rabbitmq.com
>>
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
> _______________________________________________
> rabbitmq-discuss mailing
> list
> rabbitmq-discuss at lists.rabbitmq.com
>
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
_______
> ________________________________________
rabbitmq-discuss mailing
> list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/ma
> ilman/listinfo/rabbitmq-discuss


-- 
the rubicon project

PIETER DE ZWART | LEAD, INTERFACES TEAM
??? P 310 207 0272 | x224
??? C 408 666 4443
??? F 323 466 7119


1925 S. BUNDY DRIVE
LOS ANGELES, CALIFORNIA 90025

WWW.RUBICONPROJECT.COM <http://www.rubiconproject.com/>


?MOST INNOVATIVE COMPANY? - AMERICAN BUSINESS AWARDS ?10
 REVV IS OPTIMIZING 1.4 MILLION ADS PER MINUTE



From alain.dazzi at gmail.com  Tue Jan 18 22:25:44 2011
From: alain.dazzi at gmail.com (alain)
Date: Tue, 18 Jan 2011 14:25:44 -0800 (PST)
Subject: [rabbitmq-discuss] rabbitq cluster startup errors with managment
	plugin
Message-ID: <7d21f52c-c536-4b4e-926e-f07ce7a8f22b@r16g2000prh.googlegroups.com>

I installed rabbimq server 2.2.0 and installed the management
plugin ...
root at dell:plugins # ls -1 *ez
amqp_client-2.2.0.ez
mochiweb-2.2.0.ez
rabbitmq-management-2.2.0.ez
rabbitmq-management-agent-2.2.0.ez
rabbitmq-mochiweb-2.2.0.ez
webmachine-2.2.0.ez

If I start a single node with /etc/init.d/rabbitmq-server start
everthing works fine, the server comes up, I can
produce consume/data and the http management page works great.

However if I create a local cluster, say 3 nodes on the same machine,
and start the cluster with
rabbimq-mutl start_all 3, the nodes fail to start. If I remove the
management plugin, the 3 node cluster works fine.

here is the log ...

root at dell:plugins # rabbitmq-multi start_all 3
Starting all nodes...
Starting node rabbit at dell...
Activating RabbitMQ plugins ...
*WARNING* Undefined function fdsrv:bind_socket/2
*WARNING* Undefined function fdsrv:start/0
*WARNING* Undefined function fdsrv:stop/0
*WARNING* Undefined function webmachine_resource:start_link/2
6 plugins activated:
* amqp_client-2.2.0
* mochiweb-1.3
* rabbit_management-2.2.0
* rabbit_management_agent-2.2.0
* rabbit_mochiweb-2.2.0
* webmachine-1.7.0


+---+   +---+
|   |   |   |
|   |   |   |
|   |   |   |
|   +---+   +-------+
|                   |
| RabbitMQ  +---+   |
|           |   |   |
|   v2.2.0  +---+   |
|                   |
+-------------------+
AMQP 0-9-1 / 0-9 / 0-8
Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies
LLC., and Rabbit Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

node           : rabbit at dell
app descriptor : /usr/lib/rabbitmq/lib/rabbitmq_server-2.2.0/sbin/../
ebin/rabbit.app
home dir       : /var/lib/rabbitmq
cookie hash    : 9zVr5H5XduihPv89Kzk9oA==
log            : /var/log/rabbitmq/rabbit at dell.log
sasl log       : /var/log/rabbitmq/rabbit at dell-sasl.log
database dir   : /var/lib/rabbitmq/mnesia/rabbit at dell
erlang version : 5.7.4

starting file handle cache
server                                     ...done
starting worker
pool                                                  ...done
starting
database                                                     ...done
starting codec correctness
check                                      ...done
-- external infrastructure ready
starting statistics event
manager                                     ...done
starting logging
server                                               ...done
starting exchange type
registry                                       ...done
starting exchange type
direct                                         ...done
starting exchange type
fanout                                         ...done
starting exchange type
headers                                        ...done
starting exchange type
topic                                          ...done
-- kernel ready
starting alarm
handler                                                ...done
starting node
monitor                                                 ...done
starting cluster
delegate                                             ...done
starting guid
generator                                               ...done
starting memory
monitor                                               ...done
-- core initialized
starting empty DB
check                                               ...done
starting exchange
recovery                                            ...done
starting management
agent                                             ...done
starting management statistics
database                               ...done
starting queue supervisor and queue
recovery                          ...done
-- message delivery logic ready
starting error log
relay                                              ...done
starting
networking                                                   ...done
-- network listeners available

broker running
** Found 0 name clashes in code paths
OK
Starting node rabbit_1 at dell...
Activating RabbitMQ plugins ...
*WARNING* Undefined function fdsrv:bind_socket/2
*WARNING* Undefined function fdsrv:start/0
*WARNING* Undefined function fdsrv:stop/0
*WARNING* Undefined function webmachine_resource:start_link/2
6 plugins activated:
* amqp_client-2.2.0
* mochiweb-1.3
* rabbit_management-2.2.0
* rabbit_management_agent-2.2.0
* rabbit_mochiweb-2.2.0
* webmachine-1.7.0

{"Kernel pid
terminated",application_controller,"{application_start_failure,rabbit_mochiweb,
{shutdown,{rabbit_mochiweb_app,start,[normal,[]]}}}"}
Error: {node_start_failed,normal}
root at dell:plugins #
Crash dump was written to: erl_crash.dump
Kernel pid terminated (application_controller)
({application_start_failure,rabbit_mochiweb,{shutdown,
{rabbit_mochiweb_app,start,[normal,[]]}}})

Help!

From abinesh.s at gmail.com  Wed Jan 19 07:39:38 2011
From: abinesh.s at gmail.com (abinesh s)
Date: Wed, 19 Jan 2011 13:09:38 +0530
Subject: [rabbitmq-discuss] Queue Stalling
Message-ID: <AANLkTim1L-84ej8iJwq3OBTE62vo48O-CRi2ESMQqkAG@mail.gmail.com>

Hi All,

I am using rabbitmq-grails plugin version 0.2. Using that plugin am able to
create queues. Also am placing messages in the queues. The handler classes
too continuously fetching the messages and proceed with further processing.
But, sometimes the handler classes are not fetching the messages properly,
due to that it results the messages are remain in the queue for long time.
Do we need to acknowledge the message after fetching it or else please some
one tell me the reason why the messages are remain in the queue. Also tell
me is it any other way to fetch the message which is remain in the queue for
a long time.
-- 
Thanks in Advance
Abinesh S
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/15e74d6b/attachment.htm>

From matthias at rabbitmq.com  Wed Jan 19 08:14:59 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Wed, 19 Jan 2011 08:14:59 +0000
Subject: [rabbitmq-discuss] [Patch] .NET client: ignored params in
	QueueBind
In-Reply-To: <20101229204616.GA2762@wellquite.org>
References: <AANLkTinxy87jptnB1MnBG9iYyRN6UbuNgx7iEe6KJTmR@mail.gmail.com>
	<20101229204616.GA2762@wellquite.org>
Message-ID: <4D369D83.40009@rabbitmq.com>

Matthew Sackman wrote:
> On Wed, Dec 29, 2010 at 11:30:48AM -0800, Vadim Chekan wrote:
>> So either parameters must be checked for non-null constraint, or (my
>> preference) null should be interpreted as empty parameter.
> 
> Yeah, sadly there are many such cases in both the C# and Java clients of
> this kinda thing. The one that annoys me the most is in the Java client
> in queueDeclare - the queue name must be "" rather than null, but the
> arguments map can be null. Grrrr.

There is a method to the madness...

The AMQP encoding of properties distinguishes between a null string and 
an absent string. While that distinction does not apply to AMQP method 
parameters, for consistency it might be desirable to apply the same 
principle there, and since all method parameters are mandatory a null 
value should not then be permitted. An NPE might not be the best way to 
complain about that though. Also, it does cause a problem for argument 
maps since the literal notation for an empty map is quite cumbersome. So 
as a matter of convenience, equating null with empty might be the better 
option.

> All of these need fixing - there are many such odd idiosyncratic aspects
> to the Java and .Net clients

What other idiosyncratic aspects were you thinking of?


Matthias.

From matthias at rabbitmq.com  Wed Jan 19 08:55:44 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Wed, 19 Jan 2011 08:55:44 +0000
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <AANLkTikeqCDq9gpdekuDKM4N_UjSL_FR81+twR1R4D1b@mail.gmail.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>	<20110113131223.GB2339@dakota.eng.vmware.com>	<AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>	<AANLkTinfu-fatDNAsaChPv7RuBDQM=vrGRqNLAMmCn_K@mail.gmail.com>	<AANLkTi=CihFPYx=wP3yMhYXNac=3ertHxG30rKidLdzN@mail.gmail.com>	<AANLkTim-q0-1S_KJFazX-U--Wv9AbOow6O+JFB5R4zP5@mail.gmail.com>
	<AANLkTikeqCDq9gpdekuDKM4N_UjSL_FR81+twR1R4D1b@mail.gmail.com>
Message-ID: <4D36A710.8040103@rabbitmq.com>

Mark,

Mark J. Reed wrote:
> OK, I'm having better luck with 2.2.   But I still have a few
> instances where one node can't talk to another, even though TCP
> connectivity is there.  Any help diagnosing those?
> [...]
> rabbit2$ rabbitmqctl -n rabbit at rabbit1  # but 2 can't connect to 1
> Status of node slurp at rabbit1 ...
> Error: unable to connect to node slurp at slurpp1refq1: nodedown
> diagnostics:
> - nodes and their ports on slurpp1refq1: [{rabbit,12635}]
> - current node: rabbitmqctl7085 at slurpp1refw1
> - current node home dir: /var/lib/rabbitmq
> - current node cookie hash: aEuWObzDves/lfh1+WJREQ==

That doesn't look like a valid rabbitmqctl command line. It's missing 
the command, i.e. "status". Also, how come the output mentions 
slurp at rabbit1 and slurp at slurpp1refq1?

The "nodes and their ports" line tells you that there is a node called 
'rabbit' running on the slurpp1refq1 machine. So I suspect
   rabbitmqctl -n rabbit at slurpp1refq1 status
would work, except ...

Erlang node names are oblivious to host name aliasing. So if you have a 
machine that can be addressed as both 'slurpp1refq1' and 'rabbit1', and 
rabbit on the machine has a node name of 'rabbit at rabbit1' (check 
rabbit's startup log) then you must refer to that node exactly like 
that; trying to contact it as 'rabbit at slurpp1refq1' will not work.

Regards,

Matthias.

From matthias at rabbitmq.com  Wed Jan 19 09:12:32 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Wed, 19 Jan 2011 09:12:32 +0000
Subject: [rabbitmq-discuss] Node hung and not responding to rabbitmqctl
In-Reply-To: <AANLkTikRntBrhcRwd6aM=gavu=Vbm-qgjg9SZiJM9UU2@mail.gmail.com>
References: <AANLkTikJqw-js4DyEjh82Vmd7+uRRvh9OieTEtZvDFtZ@mail.gmail.com>
	<AANLkTikRntBrhcRwd6aM=gavu=Vbm-qgjg9SZiJM9UU2@mail.gmail.com>
Message-ID: <4D36AB00.2030606@rabbitmq.com>

Bill,

Bill Moseley wrote:
> It would be nice to know how to un-wedge when needed -- and why 
> rabbitmqctl was hanging.    /etc/init.d/rabbitmq stop even hung.

Is this reproducible?

We did fix a bug recently that could result in communication to queues 
within a cluster to block in the event of a cluster node going down. But 
it looks like your rabbit was wedged more solidly than that.

Regards,

Matthias.

From simon at rabbitmq.com  Wed Jan 19 10:09:43 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Wed, 19 Jan 2011 10:09:43 +0000
Subject: [rabbitmq-discuss] rabbitq cluster startup errors with
 managment plugin
In-Reply-To: <7d21f52c-c536-4b4e-926e-f07ce7a8f22b@r16g2000prh.googlegroups.com>
References: <7d21f52c-c536-4b4e-926e-f07ce7a8f22b@r16g2000prh.googlegroups.com>
Message-ID: <4D36B867.2000508@rabbitmq.com>

On 18/01/11 22:25, alain wrote:
> However if I create a local cluster, say 3 nodes on the same machine,
> and start the cluster with
> rabbimq-mutl start_all 3, the nodes fail to start. If I remove the
> management plugin, the 3 node cluster works fine.

Hi Alain.

Please see:

http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2011-January/010703.html

- this sounds like the same problem.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From mabrek at gmail.com  Wed Jan 19 10:14:52 2011
From: mabrek at gmail.com (mabrek)
Date: Wed, 19 Jan 2011 13:14:52 +0300
Subject: [rabbitmq-discuss] SNMP Plugin.
In-Reply-To: <AANLkTi=9EmNW+ePtBZ-xTJtSzYQtby9hGns3vHcycKqu@mail.gmail.com>
References: <18689133d7.133d718689@it-action.com>
	<AANLkTi=9EmNW+ePtBZ-xTJtSzYQtby9hGns3vHcycKqu@mail.gmail.com>
Message-ID: <AANLkTin9B895LVcBAuci7nTBKZ2AmrkiXZ=LQpQN9x0H@mail.gmail.com>

On Wed, Dec 15, 2010 at 7:55 PM, Scott Brooks <scott at beamdog.com> wrote:
> I'm assuming you're using
> https://github.com/epicadvertising/rabbitmq_snmp_plugin
...
> When I was originally working on it, my hope was that someone at
> RabbitMQ would grab the .mib(the hardest part) and integrate it into
> core, but this has not happened yet/I have no clue if they plan on it.

Could you explain what needs to be done? There is a .mib file in your
sources, does it need to be changed/fixed?

Regards,
Anton Lebedevich

From robin at digininja.org  Wed Jan 19 10:24:14 2011
From: robin at digininja.org (Robin Wood)
Date: Wed, 19 Jan 2011 10:24:14 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <C95B9798.161BB%pdezwart@rubiconproject.com>
References: <AANLkTiknL4G95nsAVMv3mbHEX92yiGVyGe0+UyiJTpBq@mail.gmail.com>
	<C95B9798.161BB%pdezwart@rubiconproject.com>
Message-ID: <AANLkTi=Rm8=BNUST7r0T4VygYwedKtkGsYXz=2AmfzDt@mail.gmail.com>

I think I've got a little bit further from where I was when I
originally posted so here are the examples I'm working on now.

This is the Ruby consumer that I've got. It has come directly from the
Gem examples, it just listens for messages:

$:.unshift File.dirname(__FILE__) + '/../../lib'
require 'mq'
require 'pp'

EM.run do

  # connect to the amqp server
  connection = AMQP.connect(:host => 'localhost', :logging => false)

  # open a channel on the AMQP connection
  channel = MQ.new(connection)

  # declare a queue on the channel
  queue = MQ::Queue.new(channel, 'queue1')

  # create a fanout exchange
  exchange = MQ::Exchange.new(channel, :direct, 'direct1')

  # bind the queue to the exchange
  queue.bind(exchange)

  # subscribe to messages in the queue
  queue.subscribe do |headers, msg|
    pp [:got, headers, msg]
    connection.close{ EM.stop_event_loop }
  end

end

If I understand things right I've got it setup to listen for direct
messages in queue1 on an exchange called direct1.

Seeing as you are offering help with PECL I've got the example from
the php site

<?php

// Create a connection
$cnn = new AMQPConnection();
$cnn->connect();

// Declare a new exchange
$ex = new AMQPExchange($cnn);
$ex->declare('direct1', AMQP_EX_TYPE_DIRECT);

// Create a new queue
$q = new AMQPQueue($cnn);
$q->declare('queue1');

// Bind it on the exchange to routing.key
$ex->bind('queue1', 'routing.key');

// Publish a message to the exchange with a routing key
$ex->publish('message', 'routing.key');

// Read from the queue
$msg = $q->consume();

?>

This should be trying to publish a message to queue1 on exchange direct1.

When I run the php I get:

PHP Fatal error:  Uncaught exception 'AMQPQueueException' with message
'Server channel error: 406, message: PRECONDITION_FAILED - parameters
for queue 'queue1' in vhost '/' not equivalent' in
/home/robin/sched/a.php:13
Stack trace:
#0 /home/robin/sched/a.php(13): AMQPQueue->declare('queue1')
#1 {main}
  thrown in /home/robin/sched/a.php on line 13

Don't know if this output will help or not:

scheduler:/etc/php5/cli/conf.d# rabbitmqctl list_queues
Listing queues ...
queue1  0
...done.

scheduler:/etc/php5/cli/conf.d# rabbitmqctl list_vhosts
Listing vhosts ...
/
...done.

scheduler:/etc/php5/cli/conf.d# rabbitmqctl list_exchanges
Listing exchanges ...
amq.rabbitmq.log        topic
amq.match       headers
direct1 direct
amq.headers     headers
amq.topic       topic
amq.direct      direct
amq.fanout      fanout
        direct
...done.


Just in case I'm going about this the wrong way, the aim of all this
is to simply get a php web app to be able to send messages off to a
Ruby scheduler application which then in its own time processes the
request then sends the resulting data back. At the moment it is one to
one communication, that is why I went for direct rather than fanout.

I guess once I get communication going in one direction I hope the
reverse should be fairly simply.

I'd normally prefer to do a lot more reading around a new technology
before shouting for help but I've been given a short deadline and the
communication level is the lowest priority as we could potentially
just do this by calling shell scripts but I'd rather do it the proper
way.

Robin



2011/1/19 Pieter de Zwart <pdezwart at rubiconproject.com>:
> Robin,
>
> There is no reason why you cant do this. We are currently actively using the
> PHP PECL extension to read messages published by both a Perl and Python
> client. I know I hate it when people ask this of me, but could you cobble
> together some very basic sample code and let us know what client versions
> you are using? If it's the PHP client's fault, I will be more than happy to
> fix it.
>
> me
>
>
> On 1/18/11 3:45 PM, "Robin Wood" <robin at digininja.org> wrote:
>
>> 2011/1/18 Alexandre Kalendarev <akalend at mail.ru>:
>> Robin,
>>
>> You must to use
>> the universal  data  format : JSON or XML, or other conventional
>> dataformat.
>>
>
> I'm completely new to RabbitMQ, any pointers as to where to
>> look for
> this? Do you know if both the libraries I've chosen will do
>> this?
>
> Robin
>
>> Alexandre
>>
>>
>> Tue, 18 Jan 2011 20:13:10 +0000 ?????? ??
>> Robin Wood <robin at digininja.org>:
>>
>>> Hi
>>> I'm trying to get Ruby, using the
>> AMQP gem to talk to PHP using the
>>> php-amqp library. Both on their own work
>> and talk between their own
>>> consumer/publisher but I can't get them to talk
>> cross language.
>>>
>>> Before I post my randomly hacked together code does
>> anyone have good
>>> sample code that shows the two languages talking to each
>> other?
>>>
>>> I'm new to MQ stuff but roughly what I'm seeing is the channel
>> and
>>> queues are being created OK and messages are being sent but when I
>>>
>> watch them in Wireshark I see the PHP one has a content type of
>>> plain/text
>> but the Ruby message has application/octet.
>>>
>>> Any tips?
>>>
>>> Robin
>>>
>> _______________________________________________
>>> rabbitmq-discuss mailing
>> list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>>
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
>> _______________________________________________
>> rabbitmq-discuss mailing
>> list
>> rabbitmq-discuss at lists.rabbitmq.com
>>
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
> _______
>> ________________________________________
> rabbitmq-discuss mailing
>> list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/ma
>> ilman/listinfo/rabbitmq-discuss
>
>
> --
> the rubicon project
>
> PIETER DE ZWART | LEAD, INTERFACES TEAM
> *** P 310 207 0272 | x224
> *** C 408 666 4443
> *** F 323 466 7119
>
>
> 1925 S. BUNDY DRIVE
> LOS ANGELES, CALIFORNIA 90025
>
> WWW.RUBICONPROJECT.COM <http://www.rubiconproject.com/>
>
>
> "MOST INNOVATIVE COMPANY" - AMERICAN BUSINESS AWARDS '10
>  REVV IS OPTIMIZING 1.4 MILLION ADS PER MINUTE
>
>
>

From emile at rabbitmq.com  Wed Jan 19 10:35:08 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Wed, 19 Jan 2011 10:35:08 +0000
Subject: [rabbitmq-discuss] Consumers stops to pick up messages after
 long inactivity
In-Reply-To: <add8ddd0-50cb-449e-b6f5-e2f04d93b83a@k30g2000vbn.googlegroups.com>
References: <02df0bac-c856-4af7-93ee-fbcd600a4fff@j25g2000vbs.googlegroups.com>	<4D2C7BA0.9010508@rabbitmq.com>
	<add8ddd0-50cb-449e-b6f5-e2f04d93b83a@k30g2000vbn.googlegroups.com>
Message-ID: <4D36BE5C.6070106@rabbitmq.com>


Hi Neha,

It is possible that the combination of broker restarts and automatic 
connection re-establishment is part of the problem. Are you able to 
repeat the test over a weekend without restarting the broker and see 
whether the outcome is any different?

Regards

Emile

On 18/01/11 18:01, Neha wrote:
 > Hi Emile
 >
 > I tracked the status of the connection by logging the value of
 > 'connection.isOpen()'. I observed that somewhere in between it became
 > false, i.e. the connection was closed. It doesn't give me any
 > exceptions or the reason why the connection was closed. The connection
 > is not null, thus it still exits but is closed. The broker log file
 > shows that after the connection is closed it retries to establish the
 > shared rabbit mq connection and is successful. It restarts the broker
 > too. I have a logic in place where after the broker is restarted it
 > puts the messages back in the queue. Once the connection is
 > reestablished and broker is restarted the 'connection.isOpen()' always
 > remains false. The broker still publishes messages on the queue but
 > the consumer is unable to consume it.
 >
 > I restarted the consumer and it starts picking up the messages on the
 > queue.
 >
 > Is there a way to find out the reason why the connection was closed?
 > Also once the connection is re-established again, is it necessary to
 > restart the consumer as well?


On 13/01/11 19:46, Neha wrote:
> Hi Emile
>
> Thanks for the reply.
> I checked the broker logfiles and it has a few
> "AutoFailoverConnectionFactory" messages. But it again connects
> successfully.
> I checked the timeout and that is listed as 0.
> To check the clients connected to the broker I'll have to wait for
> Monday and see if the brokers considers the consumers to be connected.
>
> Will keep this post updated with the cause of the problem.
>
> Thanks
> Neha
>
> On Jan 11, 10:47 am, Emile Joubert<em... at rabbitmq.com>  wrote:
>> Hi Neha,
>>
>> On 10/01/11 21:57, Neha wrote:
>>
>>
>>
>>> I have an application which uses rabbitmq. It has messages being sent
>>> from Monday to Friday and on the weekend there are no messages sent.
>>
>>> The application works fine on regular days, i.e producers puts the
>>> message on the queue and the consumer receives the message. But every
>>> Monday, after the weekend the consumer starts behaving strangely. It
>>> stops receiving messages even though the queue has messages present.
>>> The heartbeat of the consumer all this time is working fine but it
>>> still doesn't receive all these messages on the queue. To overcome
>>> this problem I have to restart the consumers every Monday, and as soon
>>> as I do that, all the messages that are present in the queue starts
>>> getting consumed.
>>
>>> Looking at a problem, I feel it might be due to inactivity during the
>>> weekend. I wanted to know if anyone else has faced this problem
>>> wherein the consumer stops consuming after a long duration of
>>> inactivity? Is there a setting to be tweaked to increase this period?
>>
>> Long periods of inactivity should have no effect. The problem is almost
>> certainly network-related. Here are some things to check.
>>
>> Is there anything of interest in the broker logfile?
>>
>> As there any device along the network path that might have caused the
>> connections to be reset?
>>
>> Does the broker consider the clients to be connected on Monday mornings?
>> "rabbitmqctl list_connections" and "rabbitmqctl list_consumers" can help
>> determine this. The logfile will show when any connections were
>> terminated. Also verify the connection timeout (rabbitmqctl
>> list_connections timeout).
>>
>> You may want to try using a different connection heartbeat value and
>> check whether the message consumers are able to recover from network
>> interruptions automatically.

From matthew at rabbitmq.com  Wed Jan 19 11:16:16 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Wed, 19 Jan 2011 11:16:16 +0000
Subject: [rabbitmq-discuss] RabbitMQ 2.0 broker crashes
In-Reply-To: <20110114162724.GH18402@rabbitmq.com>
References: <20110112113218.GA18402@rabbitmq.com>
	<11156081.394.1294839513743.JavaMail.geo-discussion-forums@vbyc22>
	<20110114162724.GH18402@rabbitmq.com>
Message-ID: <20110119111616.GF14484@rabbitmq.com>

On Fri, Jan 14, 2011 at 04:27:25PM +0000, Matthew Sackman wrote:
> On Wed, Jan 12, 2011 at 05:38:33AM -0800, gus27 wrote:
> > Thank you for your prompt reply. Those are very good news. We'll be looking 
> > forward to trying the new release as soon as it's available.
> 
> There is now an experimental fix for this. You'll have to build from
> source and you'll need to be on branch bug23631

Note this fix has now been through QA and is on our default branch and
will be part of the next release. Thus if you are suffering this bug,
just compile from source on default.

Matthew

From matthew at rabbitmq.com  Wed Jan 19 11:32:55 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Wed, 19 Jan 2011 11:32:55 +0000
Subject: [rabbitmq-discuss] [Patch] .NET client: ignored params in
 QueueBind
In-Reply-To: <4D369D83.40009@rabbitmq.com>
References: <AANLkTinxy87jptnB1MnBG9iYyRN6UbuNgx7iEe6KJTmR@mail.gmail.com>
	<20101229204616.GA2762@wellquite.org> <4D369D83.40009@rabbitmq.com>
Message-ID: <20110119113254.GG14484@rabbitmq.com>

On Wed, Jan 19, 2011 at 08:14:59AM +0000, Matthias Radestock wrote:
> Matthew Sackman wrote:
> >On Wed, Dec 29, 2010 at 11:30:48AM -0800, Vadim Chekan wrote:
> >>So either parameters must be checked for non-null constraint, or (my
> >>preference) null should be interpreted as empty parameter.
> >
> >Yeah, sadly there are many such cases in both the C# and Java clients of
> >this kinda thing. The one that annoys me the most is in the Java client
> >in queueDeclare - the queue name must be "" rather than null, but the
> >arguments map can be null. Grrrr.
> 
> There is a method to the madness...
> 
> The AMQP encoding of properties distinguishes between a null string
> and an absent string. While that distinction does not apply to AMQP
> method parameters, for consistency it might be desirable to apply
> the same principle there, and since all method parameters are
> mandatory a null value should not then be permitted. An NPE might
> not be the best way to complain about that though.

Right, and I'm not sure it's desirable to reflect such properties of the
binary codec in the Java API.

> >All of these need fixing - there are many such odd idiosyncratic aspects
> >to the Java and .Net clients
> 
> What other idiosyncratic aspects were you thinking of?

Oh things like arrays may not be used for arrays. They have to be lists.
See writeArray in ValueWriter. Somewhat annoying when you have to do
things like

    Map<String, Object> args = new HashMap<String, Object>();
    args.put("my-key", Arrays.asList(new String [] {"foo", "bar", "baz"}));
    String queueName =
            channel.queueDeclare("", true, true, false, args).getQueue();

Matthew

From simon at rabbitmq.com  Wed Jan 19 11:54:11 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Wed, 19 Jan 2011 11:54:11 +0000
Subject: [rabbitmq-discuss] Management plugin issues
In-Reply-To: <AANLkTik1nXYFEzp4ffOf9iroU9kMPD=qtjPi7_VAsj7T@mail.gmail.com>
References: <AANLkTik1nXYFEzp4ffOf9iroU9kMPD=qtjPi7_VAsj7T@mail.gmail.com>
Message-ID: <4D36D0E3.1000607@rabbitmq.com>

On 18/01/11 23:20, Mark J. Reed wrote:
> I'm having a couple problems with the management plugin on
> 2.2.0/Erlang 13B/Ubuntu 10.04.
>
> First, I have several independent rabbitmq clusters, but they all seem
> to wind up reporting back to the same stats database.  I assume this
> is some Erlang network service advertising feature, but I'd much
> rather have each cluster use its own separate stats db.  How can I
> force that?

Gosh, that's quite unexpected (and almost certainly the source of your 
second problem). How are these clusters set up? Do nodes from any two 
clusters end up on the same machine?

> Second, it keeps dying.  That is, the nodes are running, but the
> statistics database goes down, and I have to restart the node that
> contains it to get the management API back.  I'm seeing messages like
> this in the log:

Unfortunately there's a bug in released versions of the management 
plugin that can cause the stats database to die if it sees details from 
a queue it can't find in Mnesia (which would certainly happen in your case).

This is fixed on default, and if you can build from source (either 
default of *everything*, or tag rabbitmq_v2_2_0 of rabbitmq-management 
with the following patch applied)

http://hg.rabbitmq.com/rabbitmq-management/diff/802c2abe4387/src/rabbit_mgmt_db.erl

then this will fix *that* problem, but I'd really like to figure out how 
the stats database is getting shared across clusters.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From matthew at rabbitmq.com  Wed Jan 19 12:56:18 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Wed, 19 Jan 2011 12:56:18 +0000
Subject: [rabbitmq-discuss] about msg_store_persistent folder
In-Reply-To: <AANLkTi=RW6-SHuJvtpst5J6Hn7sChZxA7qQ1+JQWCHKT@mail.gmail.com>
References: <AANLkTinkc22xi=8_6+e=M+H1rBaCkywS5XYZw_w94h7z@mail.gmail.com>
	<20110113125440.GA1694@wellquite.org>
	<AANLkTi=RW6-SHuJvtpst5J6Hn7sChZxA7qQ1+JQWCHKT@mail.gmail.com>
Message-ID: <20110119125617.GH14484@rabbitmq.com>

On Tue, Jan 18, 2011 at 03:38:25PM +0800, Kevin Chan wrote:
>     as u say when the message has consumed the messages on disk will be
> del,but i'm not sure that the message will be consumer in time

Ok, you could investigate the queue message ttl feature. See:
http://www.rabbitmq.com/extensions.html#queue-ttl

> ,so i need to
> keep have enough free disk ,i mount other partition to the rabbitmq folder
> ,it's success,but  the rabbitmq-server can not start,  is there anythings i
> should do?

Check the permissions on the mount and the folders.

Matthew

From michael.s.klishin at gmail.com  Wed Jan 19 13:39:04 2011
From: michael.s.klishin at gmail.com (Michael Klishin)
Date: Wed, 19 Jan 2011 16:39:04 +0300
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTi=Rm8=BNUST7r0T4VygYwedKtkGsYXz=2AmfzDt@mail.gmail.com>
References: <AANLkTiknL4G95nsAVMv3mbHEX92yiGVyGe0+UyiJTpBq@mail.gmail.com>
	<C95B9798.161BB%pdezwart@rubiconproject.com>
	<AANLkTi=Rm8=BNUST7r0T4VygYwedKtkGsYXz=2AmfzDt@mail.gmail.com>
Message-ID: <AANLkTinoUqZMp8duojnDt7rWjnOci9dJdS6ON=riYV0o@mail.gmail.com>

Robin,

What happens here two of your apps declare queue with different attributes
because default values for
parameters like durability seems to differ between that php library and what
amqp gem uses.

Since you only want to consume messages on the Ruby side and publish them on
the PHP side, you
have an option of only declaring one queue in your Ruby app and one exchange
in the PHP app. Then you
can use default exchange that routes messages to queues when routing key
matches queue name.

When queue is declared only in one place, differences in library defaults
won't get in the way. And, default exchange
was added to AMQP spec exactly for simple
cases like yours. This scenario is described at
http://www.rabbitmq.com/tutorial-one-python.html.

Hope this helps.

2011/1/19 Robin Wood <robin at digininja.org>

>
> When I run the php I get:
>
> PHP Fatal error:  Uncaught exception 'AMQPQueueException' with message
> 'Server channel error: 406, message: PRECONDITION_FAILED - parameters
> for queue 'queue1' in vhost '/' not equivalent' in
> /home/robin/sched/a.php:13
> Stack trace:
> #0 /home/robin/sched/a.php(13): AMQPQueue->declare('queue1')
> #1 {main}
>  thrown in /home/robin/sched/a.php on line 13
>
>
-- 
MK
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/ba543734/attachment.htm>

From majek04 at gmail.com  Wed Jan 19 14:06:30 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Wed, 19 Jan 2011 14:06:30 +0000
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
	Chrome
In-Reply-To: <985477893245CF449ABD4F01814A9FF65F41CB3D7A@34093-MBX-C06.mex07a.mlsrvr.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D359B67.2030806@rabbitmq.com>
	<985477893245CF449ABD4F01814A9FF65F41CB3D7A@34093-MBX-C06.mex07a.mlsrvr.com>
Message-ID: <AANLkTimYvJchh6M0wzAE9aNRvprne47yiVGCEXEiv=Sw@mail.gmail.com>

On Tue, Jan 18, 2011 at 14:49, Jon Rowland <jon.rowland at isam.com> wrote:
> Thanks - it's no problem for me, but I thought it worth reporting.
>
> I also don't have the required skills/knowledge to probe any deeper unfortunately...
>
> On 17/01/11 08:56, Jon Rowland wrote:
>> I left a test app running over the weekend which publishes 1000 msg/sec
>> to a broker. I also left the management plugin page open on the Channels
>> tab running in Chrome.
>>
>> I happened to notice that Chrome was using an enormous amount of memory
>> - over 1GB and very slowly increasing. As soon as I navigated to another
>> page outside of the management console, without restarting the browser,
>> the memory was released.
>>
>> No idea if this is 'bug' or 'feature' but thought you may be interested.

Funny thing. I can indeed confirm that Chrome grows insanely. But I
can't reproduce
it on firefox. Can you please try Firefox and see if it also misbehaves?

Cheers,
   Marek



> Hi Jon. I'm sure this is a bug, I'm just not sure if it's in
> rabbitmq-management or in Chrome :(
>
> You're not supposed to be able to do anything to leak memory in
> JavaScript + HTML. In old browsers you're supposed to avoid circular
> references between DOM elements and closures, and AFAICS we do that. So
> if there is some bugfix or workaround I'm not sure how to find it.
>
> At the moment the best advice I can give is to decrease the refresh
> frequency if this is a problem...
>
> Cheers, Simon
>
> --
> Simon MacMullen
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From robin at digininja.org  Wed Jan 19 14:10:48 2011
From: robin at digininja.org (Robin Wood)
Date: Wed, 19 Jan 2011 14:10:48 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTinoUqZMp8duojnDt7rWjnOci9dJdS6ON=riYV0o@mail.gmail.com>
References: <AANLkTiknL4G95nsAVMv3mbHEX92yiGVyGe0+UyiJTpBq@mail.gmail.com>
	<C95B9798.161BB%pdezwart@rubiconproject.com>
	<AANLkTi=Rm8=BNUST7r0T4VygYwedKtkGsYXz=2AmfzDt@mail.gmail.com>
	<AANLkTinoUqZMp8duojnDt7rWjnOci9dJdS6ON=riYV0o@mail.gmail.com>
Message-ID: <AANLkTimdQrWyzSW9VOzt6LC_19r8z+W_Zvi_cQ1rhCKe@mail.gmail.com>

On 19 January 2011 13:39, Michael Klishin <michael.s.klishin at gmail.com> wrote:
> Robin,
> What happens here two of your apps declare queue with different attributes
> because default values for
> parameters like durability seems to differ between that php library and what
> amqp gem uses.

I was hoping that that was the problem rather than a bug in my code.

> Since you only want to consume messages on the Ruby side and publish them on
> the PHP side, you
> have an option of only declaring one queue in your Ruby app and one exchange
> in the PHP app. Then you
> can use default exchange that routes messages to queues when routing key
> matches queue name.
> When queue is declared only in one place, differences in library defaults
> won't get in the way. And, default exchange
> was added to AMQP spec exactly for simple
> cases like yours. This scenario is
> described?at?http://www.rabbitmq.com/tutorial-one-python.html.
> Hope this helps.

I've had a look at the tutorial and from my original code I've removed
the exchange line from the Ruby consumer script which I assume means
it will go to the default one and changed the php exchange declare
line to:

$ex->declare('');

but when I run it I get

PHP Fatal error:  Uncaught exception 'AMQPExchangeException' with
message 'Server channel error: 403, message: ACCESS_REFUSED -
operation not permitted on the default exchange' in
/home/robin/comms/a.php:9
Stack trace:
#0 /home/robin/comms/a.php(9): AMQPExchange->declare('')
#1 {main}
  thrown in /home/robin/comms/a.php on line 9

If I change the empty string to default then I get the same
PRECONDITION_FAILED as before. I've not added any authentication
anywhere.

I want this to be able to work both directions, php tell Ruby to do
something then Ruby tell php when it is finished through a different
message. Will this work with this setup once I get the actual code
working?

Robin

>
> 2011/1/19 Robin Wood?<robin at digininja.org>
>>
>> When I run the php I get:
>>
>> PHP Fatal error: ?Uncaught exception 'AMQPQueueException' with message
>> 'Server channel error: 406, message: PRECONDITION_FAILED - parameters
>> for queue 'queue1' in vhost '/' not equivalent' in
>> /home/robin/sched/a.php:13
>> Stack trace:
>> #0 /home/robin/sched/a.php(13): AMQPQueue->declare('queue1')
>> #1 {main}
>> ?thrown in /home/robin/sched/a.php on line 13
>>
>
> --
> MK

From jon at jbrisbin.com  Wed Jan 19 14:18:05 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Wed, 19 Jan 2011 08:18:05 -0600
Subject: [rabbitmq-discuss] rebar templates for RabbitMQ plugins
Message-ID: <CC59B72A-549D-4DBC-ADD4-91112BEDCA69@jbrisbin.com>

Has anyone taken a crack at creating a rebar template for RabbitMQ plugins?


Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/bd434ae3/attachment.htm>

From markjreed at gmail.com  Wed Jan 19 15:24:18 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Wed, 19 Jan 2011 10:24:18 -0500
Subject: [rabbitmq-discuss] Unable to get automatic clustering to work
In-Reply-To: <4D36A710.8040103@rabbitmq.com>
References: <AANLkTik_3nZHB-R+fDf=eWf=aCFohMDobEqW9y7kKUWR@mail.gmail.com>
	<20110113131223.GB2339@dakota.eng.vmware.com>
	<AANLkTi=wvMOJOrN0t9oVzKZTjODF4Fg7RKrXoRNNUD88@mail.gmail.com>
	<AANLkTinfu-fatDNAsaChPv7RuBDQM=vrGRqNLAMmCn_K@mail.gmail.com>
	<AANLkTi=CihFPYx=wP3yMhYXNac=3ertHxG30rKidLdzN@mail.gmail.com>
	<AANLkTim-q0-1S_KJFazX-U--Wv9AbOow6O+JFB5R4zP5@mail.gmail.com>
	<AANLkTikeqCDq9gpdekuDKM4N_UjSL_FR81+twR1R4D1b@mail.gmail.com>
	<4D36A710.8040103@rabbitmq.com>
Message-ID: <AANLkTimeLeiwWKJqqUuvLgVuWxMF_rvWK92RbjpZJ3-Z@mail.gmail.com>

On Wed, Jan 19, 2011 at 3:55 AM, Matthias Radestock
<matthias at rabbitmq.com> wrote:
> Mark,
> That doesn't look like a valid rabbitmqctl command line. It's missing the
> command, i.e. "status". Also, how come the output mentions slurp@[two different hostnames]?

The missing rabbitmqctl command was just a bad copy/paste; the
hostname difference was just incomplete redaction.  Sorry about that.

I was running the correct command.  And after restarting rabbit, that
same command worked.  I'm just trying to get at the reason why the app
seems to need restarted so frequently.

Based on the other thread, I must have some rogue nodes joining up the
wrong clusters, so I'm going to go across our infrastructure and shut
down and reset everything, then bring the clusters back up and see if
that helped.

-- 
Mark J. Reed <markjreed at gmail.com>

From mail at sebastian-latza.de  Wed Jan 19 16:21:31 2011
From: mail at sebastian-latza.de (Sebastian Latza)
Date: Wed, 19 Jan 2011 17:21:31 +0100
Subject: [rabbitmq-discuss] File descriptor limits in management plugin
Message-ID: <AANLkTikDp8Zc_tS+OkbvoasPxEJzXMMZEZg4VRA+Cgnf@mail.gmail.com>

Hi everybody,

I'm currently running RabbitMQ 2.2.0 with the most recent
(pre-packaged) management plugin. The web console "Nodes and Ports"
section says that I'm using about 800 of 1024 available file
descriptors, which confuses me a bit since my OS limit is set to about
100000. Is this just a bug in the management console or does the
Erlang VM somehow override this system-wide setting?

Regards,
Sebastian

From simon at rabbitmq.com  Wed Jan 19 16:30:36 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Wed, 19 Jan 2011 16:30:36 +0000
Subject: [rabbitmq-discuss] File descriptor limits in management plugin
In-Reply-To: <AANLkTikDp8Zc_tS+OkbvoasPxEJzXMMZEZg4VRA+Cgnf@mail.gmail.com>
References: <AANLkTikDp8Zc_tS+OkbvoasPxEJzXMMZEZg4VRA+Cgnf@mail.gmail.com>
Message-ID: <4D3711AC.6010604@rabbitmq.com>

On 19/01/11 16:21, Sebastian Latza wrote:
> I'm currently running RabbitMQ 2.2.0 with the most recent
> (pre-packaged) management plugin. The web console "Nodes and Ports"
> section says that I'm using about 800 of 1024 available file
> descriptors, which confuses me a bit since my OS limit is set to about
> 100000. Is this just a bug in the management console or does the
> Erlang VM somehow override this system-wide setting?

Erlang does not change anything.

Which OS are you using and how is RabbitMQ installed?

What does "ulimit -n" say when invoked as the user that is running RabbitMQ?

Cheers, Simon
-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From matthew at rabbitmq.com  Wed Jan 19 16:38:20 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Wed, 19 Jan 2011 16:38:20 +0000
Subject: [rabbitmq-discuss] File descriptor limits in management plugin
In-Reply-To: <4D3711AC.6010604@rabbitmq.com>
References: <AANLkTikDp8Zc_tS+OkbvoasPxEJzXMMZEZg4VRA+Cgnf@mail.gmail.com>
	<4D3711AC.6010604@rabbitmq.com>
Message-ID: <20110119163820.GI14484@rabbitmq.com>

Also, please check the broker logs - there should be an entry as Rabbit
boots that says what it found. Something like:

=INFO REPORT==== 18-Jan-2011::17:05:28 ===
Limiting to approx 99900 file handles (89908 sockets)

Matthew

From pdezwart at rubiconproject.com  Wed Jan 19 16:41:14 2011
From: pdezwart at rubiconproject.com (Pieter de Zwart)
Date: Wed, 19 Jan 2011 08:41:14 -0800
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTimdQrWyzSW9VOzt6LC_19r8z+W_Zvi_cQ1rhCKe@mail.gmail.com>
Message-ID: <C95C542A.16225%pdezwart@rubiconproject.com>

It unfortunately sounds like the PHP client is not conforming to the spec,
or that the configuration isnt working. I am not familiar with the default
routing mechanism (adding to my to do list now,) but I see no reason why we
cant shoe horn your original code to work. First, you need to remove the
queue declaration from your PHP code:

// Create a connection
$cnn = new AMQPConnection();
$cnn->connect();

// Declare a new exchange
$ex = new AMQPExchange($cnn);
$ex->declare('direct1', AMQP_EX_TYPE_DIRECT);

// Publish a message to the exchange with a routing key
$ex->publish('message', 'routing.key');

The Ruby client should have already defined the queue and its binding on
which it will be listening. Give that a shot and let us know how it works
out.

me


On 1/19/11 6:10 AM, "Robin Wood" <robin at digininja.org> wrote:

> On 19 January 2011 13:39, Michael Klishin <michael.s.klishin at gmail.com> wrote:
>> Robin,
>> What happens here two of your apps declare queue with different attributes
>> because default values for
>> parameters like durability seems to differ between that php library and what
>> amqp gem uses.
> 
> I was hoping that that was the problem rather than a bug in my code.
> 
>> Since you only want to consume messages on the Ruby side and publish them on
>> the PHP side, you
>> have an option of only declaring one queue in your Ruby app and one exchange
>> in the PHP app. Then you
>> can use default exchange that routes messages to queues when routing key
>> matches queue name.
>> When queue is declared only in one place, differences in library defaults
>> won't get in the way. And, default exchange
>> was added to AMQP spec exactly for simple
>> cases like yours. This scenario is
>> described?at?http://www.rabbitmq.com/tutorial-one-python.html.
>> Hope this helps.
> 
> I've had a look at the tutorial and from my original code I've removed
> the exchange line from the Ruby consumer script which I assume means
> it will go to the default one and changed the php exchange declare
> line to:
> 
> $ex->declare('');
> 
> but when I run it I get
> 
> PHP Fatal error:  Uncaught exception 'AMQPExchangeException' with
> message 'Server channel error: 403, message: ACCESS_REFUSED -
> operation not permitted on the default exchange' in
> /home/robin/comms/a.php:9
> Stack trace:
> #0 /home/robin/comms/a.php(9): AMQPExchange->declare('')
> #1 {main}
>   thrown in /home/robin/comms/a.php on line 9
> 
> If I change the empty string to default then I get the same
> PRECONDITION_FAILED as before. I've not added any authentication
> anywhere.
> 
> I want this to be able to work both directions, php tell Ruby to do
> something then Ruby tell php when it is finished through a different
> message. Will this work with this setup once I get the actual code
> working?
> 
> Robin
> 
>> 
>> 2011/1/19 Robin Wood?<robin at digininja.org>
>>> 
>>> When I run the php I get:
>>> 
>>> PHP Fatal error: ?Uncaught exception 'AMQPQueueException' with message
>>> 'Server channel error: 406, message: PRECONDITION_FAILED - parameters
>>> for queue 'queue1' in vhost '/' not equivalent' in
>>> /home/robin/sched/a.php:13
>>> Stack trace:
>>> #0 /home/robin/sched/a.php(13): AMQPQueue->declare('queue1')
>>> #1 {main}
>>> ?thrown in /home/robin/sched/a.php on line 13
>>> 
>> 
>> --
>> MK
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


From jon at jbrisbin.com  Wed Jan 19 16:48:34 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Wed, 19 Jan 2011 10:48:34 -0600
Subject: [rabbitmq-discuss] rebar-friendly amqp_client and rabbit_common
Message-ID: <F582C179-ABE8-404B-99A1-3F80394A00B3@jbrisbin.com>

I've been able to create a rebar-friendly fork of amqp_client and rabbit_common based on RabbitMQ v2.2.0 sources. I've also created a rebar template that stubs out a basic plugin and uses the rebar-friendly versions of amqp_client and rabbit_common.

What issues do you forsee with putting these up on my github? I use the generated sources from rabbitmq-server/src and  stock rabbitmq-erlang-client/src

I can create a script to build the rebar version of both of these from a public-umbrella to keep it up-to-date and follow the server trunk or specific tags, etc...

Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/8ef52345/attachment.htm>

From alexis at rabbitmq.com  Wed Jan 19 16:51:58 2011
From: alexis at rabbitmq.com (Alexis Richardson)
Date: Wed, 19 Jan 2011 16:51:58 +0000
Subject: [rabbitmq-discuss] rebar-friendly amqp_client and rabbit_common
In-Reply-To: <F582C179-ABE8-404B-99A1-3F80394A00B3@jbrisbin.com>
References: <F582C179-ABE8-404B-99A1-3F80394A00B3@jbrisbin.com>
Message-ID: <AANLkTikZoQ9TdDUCb2c4HGtxePke335ixkJaRDGoBdNC@mail.gmail.com>

Jon

So long as you are clear about licensing.. go for it.

RabbitMQ has a github mirror, which may be the right thing to derive
anything from in this case.

https://github.com/rabbitmq

alexis


On Wed, Jan 19, 2011 at 4:48 PM, Jon Brisbin <jon at jbrisbin.com> wrote:
> I've been able to create a rebar-friendly fork of amqp_client and
> rabbit_common based on RabbitMQ v2.2.0 sources.?I've also created a rebar
> template that stubs out a basic plugin and uses the rebar-friendly versions
> of amqp_client and rabbit_common.
> What issues do you forsee with putting these up on my github? I use the
> generated sources from rabbitmq-server/src and ?stock
> rabbitmq-erlang-client/src
> I can create a script to build the rebar version of both of these from a
> public-umbrella to keep it up-to-date and follow the server trunk or
> specific tags, etc...
>
> Thanks!
> Jon Brisbin
> ?? ? ? ?Web: http://jbrisbin.com/
> ?? ?Twitter: @j_brisbin
> ?? ? ?Skype: jon.brisbin
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

From robin at digininja.org  Wed Jan 19 17:08:11 2011
From: robin at digininja.org (Robin Wood)
Date: Wed, 19 Jan 2011 17:08:11 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <C95C542A.16225%pdezwart@rubiconproject.com>
References: <AANLkTimdQrWyzSW9VOzt6LC_19r8z+W_Zvi_cQ1rhCKe@mail.gmail.com>
	<C95C542A.16225%pdezwart@rubiconproject.com>
Message-ID: <AANLkTi=EQGa43yjgXcYQg_UfqX=Zd374sabwvL4jT9+V@mail.gmail.com>

On 19 January 2011 16:41, Pieter de Zwart <pdezwart at rubiconproject.com> wrote:
> It unfortunately sounds like the PHP client is not conforming to the spec,
> or that the configuration isnt working. I am not familiar with the default
> routing mechanism (adding to my to do list now,) but I see no reason why we
> cant shoe horn your original code to work. First, you need to remove the
> queue declaration from your PHP code:
>
> // Create a connection
> $cnn = new AMQPConnection();
> $cnn->connect();
>
> // Declare a new exchange
> $ex = new AMQPExchange($cnn);
> $ex->declare('direct1', AMQP_EX_TYPE_DIRECT);
>
> // Publish a message to the exchange with a routing key
> $ex->publish('message', 'routing.key');
>
> The Ruby client should have already defined the queue and its binding on
> which it will be listening. Give that a shot and let us know how it works
> out.
>
> me

That has got rid of the errors but the Ruby consumer doesn't appear to
be receiving anything. The consumer I'm using is the one I sent at
10:24 which should display anything that it receives.

I remember having a very similar problem getting php to talk to .net
over SOAP. That took a lot of work to get php to talk nicely but once
it was there it worked fine.

Robin



>
> On 1/19/11 6:10 AM, "Robin Wood" <robin at digininja.org> wrote:
>
>> On 19 January 2011 13:39, Michael Klishin <michael.s.klishin at gmail.com> wrote:
>>> Robin,
>>> What happens here two of your apps declare queue with different attributes
>>> because default values for
>>> parameters like durability seems to differ between that php library and what
>>> amqp gem uses.
>>
>> I was hoping that that was the problem rather than a bug in my code.
>>
>>> Since you only want to consume messages on the Ruby side and publish them on
>>> the PHP side, you
>>> have an option of only declaring one queue in your Ruby app and one exchange
>>> in the PHP app. Then you
>>> can use default exchange that routes messages to queues when routing key
>>> matches queue name.
>>> When queue is declared only in one place, differences in library defaults
>>> won't get in the way. And, default exchange
>>> was added to AMQP spec exactly for simple
>>> cases like yours. This scenario is
>>> described?at?http://www.rabbitmq.com/tutorial-one-python.html.
>>> Hope this helps.
>>
>> I've had a look at the tutorial and from my original code I've removed
>> the exchange line from the Ruby consumer script which I assume means
>> it will go to the default one and changed the php exchange declare
>> line to:
>>
>> $ex->declare('');
>>
>> but when I run it I get
>>
>> PHP Fatal error: ?Uncaught exception 'AMQPExchangeException' with
>> message 'Server channel error: 403, message: ACCESS_REFUSED -
>> operation not permitted on the default exchange' in
>> /home/robin/comms/a.php:9
>> Stack trace:
>> #0 /home/robin/comms/a.php(9): AMQPExchange->declare('')
>> #1 {main}
>> ? thrown in /home/robin/comms/a.php on line 9
>>
>> If I change the empty string to default then I get the same
>> PRECONDITION_FAILED as before. I've not added any authentication
>> anywhere.
>>
>> I want this to be able to work both directions, php tell Ruby to do
>> something then Ruby tell php when it is finished through a different
>> message. Will this work with this setup once I get the actual code
>> working?
>>
>> Robin
>>
>>>
>>> 2011/1/19 Robin Wood?<robin at digininja.org>
>>>>
>>>> When I run the php I get:
>>>>
>>>> PHP Fatal error: ?Uncaught exception 'AMQPQueueException' with message
>>>> 'Server channel error: 406, message: PRECONDITION_FAILED - parameters
>>>> for queue 'queue1' in vhost '/' not equivalent' in
>>>> /home/robin/sched/a.php:13
>>>> Stack trace:
>>>> #0 /home/robin/sched/a.php(13): AMQPQueue->declare('queue1')
>>>> #1 {main}
>>>> ?thrown in /home/robin/sched/a.php on line 13
>>>>
>>>
>>> --
>>> MK
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

From michael.s.klishin at gmail.com  Wed Jan 19 17:18:15 2011
From: michael.s.klishin at gmail.com (Michael Klishin)
Date: Wed, 19 Jan 2011 20:18:15 +0300
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTi=EQGa43yjgXcYQg_UfqX=Zd374sabwvL4jT9+V@mail.gmail.com>
References: <AANLkTimdQrWyzSW9VOzt6LC_19r8z+W_Zvi_cQ1rhCKe@mail.gmail.com>
	<C95C542A.16225%pdezwart@rubiconproject.com>
	<AANLkTi=EQGa43yjgXcYQg_UfqX=Zd374sabwvL4jT9+V@mail.gmail.com>
Message-ID: <AANLkTinHZC20gqTL0tKBXxk79nwUotuuk==mirKNJEwu@mail.gmail.com>

2011/1/19 Robin Wood <robin at digininja.org>

> That has got rid of the errors but the Ruby consumer doesn't appear to
> be receiving anything. The consumer I'm using is the one I sent at
> 10:24 which should display anything that it receives.


Robin,

Can you maybe post code examples you have so far to gist.github.com?
It is a bit difficult to follow what your code looks like after all the
modifications.

Thank you.
-- 
MK
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/8d1204bf/attachment.htm>

From mail at sebastian-latza.de  Wed Jan 19 17:28:33 2011
From: mail at sebastian-latza.de (Sebastian Latza)
Date: Wed, 19 Jan 2011 18:28:33 +0100
Subject: [rabbitmq-discuss] File descriptor limits in management plugin
In-Reply-To: <4D3711AC.6010604@rabbitmq.com>
References: <AANLkTikDp8Zc_tS+OkbvoasPxEJzXMMZEZg4VRA+Cgnf@mail.gmail.com>
	<4D3711AC.6010604@rabbitmq.com>
Message-ID: <AANLkTimjK7Z0uSwTBPnz_AOECqEGiZpKOpeac=9Ni77i@mail.gmail.com>

Simon,

I checked the descriptor limit by cat-ing /proc/sys/fs/files-max and
setting it in /etc/security.conf but actually forgot to invoke ulimit
to set the proper user limit. I did that now and everything works
perfectly. Thanks for helping me figure that out.

Sebastian

2011/1/19 Simon MacMullen <simon at rabbitmq.com>:
> On 19/01/11 16:21, Sebastian Latza wrote:
>>
>> I'm currently running RabbitMQ 2.2.0 with the most recent
>> (pre-packaged) management plugin. The web console "Nodes and Ports"
>> section says that I'm using about 800 of 1024 available file
>> descriptors, which confuses me a bit since my OS limit is set to about
>> 100000. Is this just a bug in the management console or does the
>> Erlang VM somehow override this system-wide setting?
>
> Erlang does not change anything.
>
> Which OS are you using and how is RabbitMQ installed?
>
> What does "ulimit -n" say when invoked as the user that is running RabbitMQ?
>
> Cheers, Simon
> --
> Simon MacMullen
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From robin at digininja.org  Wed Jan 19 17:32:54 2011
From: robin at digininja.org (Robin Wood)
Date: Wed, 19 Jan 2011 17:32:54 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTinHZC20gqTL0tKBXxk79nwUotuuk==mirKNJEwu@mail.gmail.com>
References: <AANLkTimdQrWyzSW9VOzt6LC_19r8z+W_Zvi_cQ1rhCKe@mail.gmail.com>
	<C95C542A.16225%pdezwart@rubiconproject.com>
	<AANLkTi=EQGa43yjgXcYQg_UfqX=Zd374sabwvL4jT9+V@mail.gmail.com>
	<AANLkTinHZC20gqTL0tKBXxk79nwUotuuk==mirKNJEwu@mail.gmail.com>
Message-ID: <AANLkTinzencE_CCW=nsDYCrZ7fnatLxtWYOL3M_bjswS@mail.gmail.com>

On 19 January 2011 17:18, Michael Klishin <michael.s.klishin at gmail.com> wrote:
> 2011/1/19 Robin Wood?<robin at digininja.org>
>>
>> That has got rid of the errors but the Ruby consumer doesn't appear to
>> be receiving anything. The consumer I'm using is the one I sent at
>> 10:24 which should display anything that it receives.
>
> Robin,
> Can you maybe post code examples you have so far to gist.github.com?
> It is a bit difficult to follow what your code looks like after all the
> modifications.
> Thank you.
> --
> MK

Ye, I was getting lost as well, here you go:

https://gist.github.com/786508

Robin

From markjreed at gmail.com  Wed Jan 19 17:40:08 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Wed, 19 Jan 2011 12:40:08 -0500
Subject: [rabbitmq-discuss] Management plugin issues
In-Reply-To: <4D36D0E3.1000607@rabbitmq.com>
References: <AANLkTik1nXYFEzp4ffOf9iroU9kMPD=qtjPi7_VAsj7T@mail.gmail.com>
	<4D36D0E3.1000607@rabbitmq.com>
Message-ID: <AANLkTin-frH7fXC=FyvPr19b81Op1Op_5KLXkh2p+_uz@mail.gmail.com>

On Wed, Jan 19, 2011 at 6:54 AM, Simon MacMullen <simon at rabbitmq.com> wrote:
>> First, I have several independent rabbitmq clusters, but they all seem
>> to wind up reporting back to the same stats database. ?I assume this
>> is some Erlang network service advertising feature, but I'd much
>> rather have each cluster use its own separate stats db. ?How can I
>> force that?
>
> Gosh, that's quite unexpected (and almost certainly the source of your
> second problem). How are these clusters set up? Do nodes from any two
> clusters end up on the same machine?

No.

The clusters are set up via /etc/rabbitmq/rabbitmq.config files
listing the hosts that belong in a cluster together.  There are three
different clusters.  Well, one is a "cluster" of one node on one host,
but regardless.  I've verified that the config files are correct; the
nodes have all been reset (actually, the mnesia directory deleted and
rabbitmq-server package purged and reinstalled).

They all came up in their proper clusters.

dev1: stats db on dev1

refq1 and refq2: stats db on refq1

prod3q1, prod3q2, prods1q1, and prods1q2: stats db on prod3q1

However, then I got these messages on prods1q1:

=WARNING REPORT==== 19-Jan-2011::12:18:16 ===
global: rabbit at prods1q1 failed to connect to rabbit at dev1

=WARNING REPORT==== 19-Jan-2011::12:18:16 ===
global: rabbit at prods1q1 failed to connect to rabbit at refq1

=INFO REPORT==== 19-Jan-2011::12:18:32 ===
    application: mnesia
    exited: stopped
    type: permanent


I tried restarting s1q1 but it hung on "starting management statistics
database".  After 5 minutes I killed the start process,  nuked the
mnesia directory and tried again.  It came up fine. But now the prod
cluster is using the dev box as its statistics database.

So I don't know where the crosstalk is coming from.


-- 
Mark J. Reed <markjreed at gmail.com>

From matthias at rabbitmq.com  Wed Jan 19 18:11:08 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Wed, 19 Jan 2011 18:11:08 +0000
Subject: [rabbitmq-discuss] Management plugin issues
In-Reply-To: <AANLkTin-frH7fXC=FyvPr19b81Op1Op_5KLXkh2p+_uz@mail.gmail.com>
References: <AANLkTik1nXYFEzp4ffOf9iroU9kMPD=qtjPi7_VAsj7T@mail.gmail.com>	<4D36D0E3.1000607@rabbitmq.com>
	<AANLkTin-frH7fXC=FyvPr19b81Op1Op_5KLXkh2p+_uz@mail.gmail.com>
Message-ID: <4D37293C.5050908@rabbitmq.com>

Mark,

On 19/01/11 17:40, Mark J. Reed wrote:
> all came up in their proper clusters.
>
> dev1: stats db on dev1
>
> refq1 and refq2: stats db on refq1
>
> prod3q1, prod3q2, prods1q1, and prods1q2: stats db on prod3q1
>
> However, then I got these messages on prods1q1:
>
> =WARNING REPORT==== 19-Jan-2011::12:18:16 ===
> global: rabbit at prods1q1 failed to connect to rabbit at dev1
>
> =WARNING REPORT==== 19-Jan-2011::12:18:16 ===
> global: rabbit at prods1q1 failed to connect to rabbit at refq1
 >
> [...]
> I don't know where the crosstalk is coming from.

I am pretty sure you are the first person trying to run multiple 
independent rabbit clusters on the same machine.

To do that you'll probably have to change some settings for each of the 
clusters. See http://www.erlang.org/doc/man/epmd.html

ERL_EPMD_PORT
This environment variable can contain the port number epmd will use. The 
default port will work fine in most cases. A different port can be 
specified to allow several instances of epmd, representing independent 
clusters of nodes, to co-exist on the same host. All nodes in a cluster 
must use the same epmd port number.


Giving each cluster a different erlang cookie might be sufficient too, 
though I haven't tried that.


Regards,

Matthias.

From markjreed at gmail.com  Wed Jan 19 18:38:15 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Wed, 19 Jan 2011 13:38:15 -0500
Subject: [rabbitmq-discuss] Management plugin issues
In-Reply-To: <4D37293C.5050908@rabbitmq.com>
References: <AANLkTik1nXYFEzp4ffOf9iroU9kMPD=qtjPi7_VAsj7T@mail.gmail.com>
	<4D36D0E3.1000607@rabbitmq.com>
	<AANLkTin-frH7fXC=FyvPr19b81Op1Op_5KLXkh2p+_uz@mail.gmail.com>
	<4D37293C.5050908@rabbitmq.com>
Message-ID: <AANLkTimDAn2Wvsd+JFQf-pW4qTQrRhSLTq3ydyaCV41B@mail.gmail.com>

On Wed, Jan 19, 2011 at 1:11 PM, Matthias Radestock
<matthias at rabbitmq.com> wrote:
> Mark,
>> I don't know where the crosstalk is coming from.
>
> I am pretty sure you are the first person trying to run multiple independent
> rabbit clusters on the same machine.

They're not on the same machine!

There are seven machines, grouped into three clusters: one of four
nodes, one of two nodes, and one standalone.  Nowhere do I have even
two nodes on the same machine, much less two clusters.

-- 
Mark J. Reed <markjreed at gmail.com>

From matthias at rabbitmq.com  Wed Jan 19 18:43:34 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Wed, 19 Jan 2011 18:43:34 +0000
Subject: [rabbitmq-discuss] Management plugin issues
In-Reply-To: <AANLkTimDAn2Wvsd+JFQf-pW4qTQrRhSLTq3ydyaCV41B@mail.gmail.com>
References: <AANLkTik1nXYFEzp4ffOf9iroU9kMPD=qtjPi7_VAsj7T@mail.gmail.com>	<4D36D0E3.1000607@rabbitmq.com>	<AANLkTin-frH7fXC=FyvPr19b81Op1Op_5KLXkh2p+_uz@mail.gmail.com>	<4D37293C.5050908@rabbitmq.com>
	<AANLkTimDAn2Wvsd+JFQf-pW4qTQrRhSLTq3ydyaCV41B@mail.gmail.com>
Message-ID: <4D3730D6.1050304@rabbitmq.com>

Mark,

On 19/01/11 18:38, Mark J. Reed wrote:
> There are seven machines, grouped into three clusters: one of four
> nodes, one of two nodes, and one standalone.  Nowhere do I have even
> two nodes on the same machine, much less two clusters.

Interesting. Are you using rabbitmqctl across machines from different 
clusters? That might be enough for them to find out about each other.

Try my suggestions from the previous email, i.e. use different cookies 
or ERL_EPMD_PORT settings for each cluster.


Matthias.

From jon at jbrisbin.com  Wed Jan 19 19:04:30 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Wed, 19 Jan 2011 13:04:30 -0600
Subject: [rabbitmq-discuss] rebar-friendly amqp_client and rabbit_common
In-Reply-To: <AANLkTikZoQ9TdDUCb2c4HGtxePke335ixkJaRDGoBdNC@mail.gmail.com>
References: <F582C179-ABE8-404B-99A1-3F80394A00B3@jbrisbin.com>
	<AANLkTikZoQ9TdDUCb2c4HGtxePke335ixkJaRDGoBdNC@mail.gmail.com>
Message-ID: <D12A9C85-9A11-4612-A905-9558D37EECEF@jbrisbin.com>

I've uploaded a rebar-friendly version of the current Erlang AMQP client to my github:

https://github.com/jbrisbin/amqp_client

seems to work in a test project, though I haven't put it through a lot of paces yet.


Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin


On Jan 19, 2011, at 10:51 AM, Alexis Richardson wrote:

> Jon
> 
> So long as you are clear about licensing.. go for it.
> 
> RabbitMQ has a github mirror, which may be the right thing to derive
> anything from in this case.
> 
> https://github.com/rabbitmq
> 
> alexis
> 
> 
> On Wed, Jan 19, 2011 at 4:48 PM, Jon Brisbin <jon at jbrisbin.com> wrote:
>> I've been able to create a rebar-friendly fork of amqp_client and
>> rabbit_common based on RabbitMQ v2.2.0 sources. I've also created a rebar
>> template that stubs out a basic plugin and uses the rebar-friendly versions
>> of amqp_client and rabbit_common.
>> What issues do you forsee with putting these up on my github? I use the
>> generated sources from rabbitmq-server/src and  stock
>> rabbitmq-erlang-client/src
>> I can create a script to build the rebar version of both of these from a
>> public-umbrella to keep it up-to-date and follow the server trunk or
>> specific tags, etc...
>> 
>> Thanks!
>> Jon Brisbin
>>         Web: http://jbrisbin.com/
>>     Twitter: @j_brisbin
>>       Skype: jon.brisbin
>> 
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>> 
>> 



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/b51e7a08/attachment-0001.htm>

From harvey.robin at gmail.com  Wed Jan 19 19:47:50 2011
From: harvey.robin at gmail.com (Robin Harvey)
Date: Wed, 19 Jan 2011 19:47:50 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTinzencE_CCW=nsDYCrZ7fnatLxtWYOL3M_bjswS@mail.gmail.com>
References: <AANLkTimdQrWyzSW9VOzt6LC_19r8z+W_Zvi_cQ1rhCKe@mail.gmail.com>
	<C95C542A.16225%pdezwart@rubiconproject.com>
	<AANLkTi=EQGa43yjgXcYQg_UfqX=Zd374sabwvL4jT9+V@mail.gmail.com>
	<AANLkTinHZC20gqTL0tKBXxk79nwUotuuk==mirKNJEwu@mail.gmail.com>
	<AANLkTinzencE_CCW=nsDYCrZ7fnatLxtWYOL3M_bjswS@mail.gmail.com>
Message-ID: <AANLkTiku5Pw4GY51Z8fZAPXUKaCvjPuP4mp3a9ud_-P8@mail.gmail.com>

Hi Robin,

I've recently released a PHP implementation of Amqp which works OK with
RabbitMQ, you might like to try it.  I've posted an example of how to do a
really simple produce here:

https://gist.github.com/786716

<https://gist.github.com/786716>You can download the code here:

https://github.com/BraveSirRobin/amqphp

<https://github.com/BraveSirRobin/amqphp>HTH,
--Robin

On Wed, Jan 19, 2011 at 5:32 PM, Robin Wood <robin at digininja.org> wrote:

> On 19 January 2011 17:18, Michael Klishin <michael.s.klishin at gmail.com>
> wrote:
> > 2011/1/19 Robin Wood <robin at digininja.org>
> >>
> >> That has got rid of the errors but the Ruby consumer doesn't appear to
> >> be receiving anything. The consumer I'm using is the one I sent at
> >> 10:24 which should display anything that it receives.
> >
> > Robin,
> > Can you maybe post code examples you have so far to gist.github.com?
> > It is a bit difficult to follow what your code looks like after all the
> > modifications.
> > Thank you.
> > --
> > MK
>
> Ye, I was getting lost as well, here you go:
>
> https://gist.github.com/786508
>
> Robin
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/8d9720ba/attachment.htm>

From jon at jbrisbin.com  Wed Jan 19 21:59:31 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Wed, 19 Jan 2011 15:59:31 -0600
Subject: [rabbitmq-discuss] New rebar template for RabbitMQ plugins
Message-ID: <8C848CB4-3684-48CE-A343-B23C0BD82EBD@jbrisbin.com>

Just pushed a rebar template for creating RabbitMQ plugins with Rebar to my GitHub:

https://github.com/jbrisbin/rabbitplugin

The README gives some instructions on usage. It's really pretty simple. The only thing that will need to be kept up-to-date is the port of rabbitmq-erlang-client to a rebar-friendly version I host on my GitHub. I'll write some scripts to automate this to track future updates.

Creating a plugin for RabbitMQ is now as easy as:

rebar create template=rabbitplugin pluginid=my_cool_plugin author="Joe Blow <joe at mydomain.com>"
cd my_cool_plugin
make
export RABBITMQ_HOME=/my/rabbitmq_home/2.2.0
sudo make install

You can use rebar to manage your plugin's dependencies and the Makefile will handle zipping them up for you (and copying them to the plugins directory on the install target, of course).

Truth be told, the name rabbitplugin is maybe a little misleading. This particular template is an Erlang AMQP client app template. Since it's using rebar, you could generate a standalone app using this too. I might add a reltool.config to it and add a template for just this purpose. "amqpapp" or somesuch. That might make creating standalone Erlang-based AMQP apps a little easier.

Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/ee945bf7/attachment.htm>

From jeffh at delasco.com  Wed Jan 19 20:55:13 2011
From: jeffh at delasco.com (Jeff Hinrichs)
Date: Wed, 19 Jan 2011 14:55:13 -0600
Subject: [rabbitmq-discuss] failure on startup
Message-ID: <AANLkTimTAHZ96bc+=6iY6aa+c=RW+Hi=0UV69W7nt5Tb@mail.gmail.com>

jailed FreeBSD 8.x, rabbitmq 2.1.0_1, erlang-lite-r14b01,1

hydra# /usr/local/etc/rc.d/rabbitmq start
{error_logger,{{2011,1,19},{14,40,28}},"Protocol: ~p: register error:
~p~n",["inet_tcp",{{badmatch,{error,epmd_close}},[{inet_tcp_dist,listen,1},{net_kernel,start_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,init,1},{gen_server,init_it,6},{proc_lib,init_p_do_apply,3}]}]}
{error_logger,{{2011,1,19},{14,40,28}},crash_report,[[{initial_call,{net_kernel,init,['Argument__1']}},{pid,<0.19.0>},{registered_name,[]},{error_info,{exit,{error,badarg},[{gen_server,init_it,6},{proc_lib,init_p_do_apply,3}]}},{ancestors,[net_sup,kernel_sup,<0.9.0>]},{messages,[]},{links,[#Port<0.90>,<0.16.0>]},{dictionary,[{longnames,false}]},{trap_exit,true},{status,running},{heap_size,610},{stack_size,24},{reductions,507}],[]]}
{error_logger,{{2011,1,19},{14,40,28}},supervisor_report,[{supervisor,{local,net_sup}},{errorContext,start_error},{reason,{'EXIT',nodistribution}},{offender,[{pid,undefined},{name,net_kernel},{mfargs,{net_kernel,start_link,[[rabbitmq_multi30790,shortnames]]}},{restart_type,permanent},{shutdown,2000},{child_type,worker}]}]}
{error_logger,{{2011,1,19},{14,40,28}},supervisor_report,[{supervisor,{local,kernel_sup}},{errorContext,start_error},{reason,shutdown},{offender,[{pid,undefined},{name,net_sup},{mfargs,{erl_distribution,start_link,[]}},{restart_type,permanent},{shutdown,infinity},{child_type,supervisor}]}]}
{error_logger,{{2011,1,19},{14,40,28}},std_info,[{application,kernel},{exited,{shutdown,{kernel,start,[normal,[]]}}},{type,permanent}]}
{"Kernel pid
terminated",application_controller,"{application_start_failure,kernel,{shutdown,{kernel,start,[normal,[]]}}}"}
Kernel pid terminated (application_controller)
({application_start_failure,kernel,{shutdown,{kernel,start,[normal,[]]}}})

no erl_crash.dump, no logfiles in /var/log/rabbitmq/

Sorry, but I'm a rabbit/erlang newb, so if someone could give me a hand on
where to look first,

Best,

-Jeff
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110119/97877296/attachment.htm>

From jerryk at vmware.com  Thu Jan 20 00:54:06 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Wed, 19 Jan 2011 16:54:06 -0800 (PST)
Subject: [rabbitmq-discuss] Warnings on server startup
In-Reply-To: <985477893245CF449ABD4F01814A9FF65E773AF61D@34093-MBX-C06.mex07a.mlsrvr.com>
References: <58EB0FC59535A343AE555A6794DA7FEF015BCF9B34AD@MBX01.kredinor.no>
	<yrv4cocav901v.fsf@dwragg.eng.vmware.com>
	<985477893245CF449ABD4F01814A9FF65E773AF61D@34093-MBX-C06.mex07a.mlsrvr.com>
Message-ID: <30715405.post@talk.nabble.com>


Jon (and Lars):

Would either of you guys have a canned set of repro steps going from a
freshly downloaded RabbitMQ for Windows to the pesky object code out of date
warnings?  I know some of us have seen these now and again on Windows, but
I've been unable to reproduce them on a fresh download and install of the
2.1.1 Windows complete Rabbit package.  Might some of the files have been
moved around or touched after your initial install?

Best regards,
Jerry


Jon Rowland-2 wrote:
> 
> I had the same problem a month or so ago, see the thread "Plug-in out of
> date warnings when starting the RabbitMQ server on Windows".
> 
> I didn't manage to resolve (moved on to something else).
> 
> Regards,
> Jon
> 
> -----Original Message-----
> From: rabbitmq-discuss-bounces at lists.rabbitmq.com
> [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of David
> Wragg
> Sent: 15 October 2010 12:18
> To: Lars Wilhelmsen
> Cc: rabbitmq-discuss at lists.rabbitmq.com
> Subject: Re: [rabbitmq-discuss] Warnings on server startup
> 
> Hi Lars,
> 
> Lars Wilhelmsen <larsw at kredinor.no> writes:
>> I'm a RabbitMQ newbie with a fresh Erlang (5.8.1.1) and RabbitMQ
>> (2.1.0) installation on my Win7-64 laptop.
>>
>> When I start the server with rabbitmq-server.bat, it reports:
>>
>> *WARNING* rabbit: Object code (delegate) out of date
>> [...]
>> *WARNING* rabbit: Object code (worker_pool_sup) out of date
>>
>> What do I have to do to resolve these warnings?
> 
> I think these warnings result from you having erlang object code files
> (.beam files) and erlang source code files (.erl files), and erlang
> noticing that the source code files have been modified after the
> corresponding object code files, therefore the object code files are out
> of date.
> 
> I'm not sure what might have led up to this situation occuring for you -
> it doesn't seem to have been reported before.  But deleting the source
> files in rabbitmq_server-2.1.0\src should fix it - they are not required
> for rabbitmq-server to function.
> 
>> Can it be that
>> RabbitMQ was built against an earlier version of Erlang (5.8.1
>> perhaps) and because of that it reports the warnings?
> 
> We always build RabbitMQ releases with quite an old version of erlang
> anyway, in order to be able to run on a wide range of erlang releases.
> 
> David
> 
> -- 
> David Wragg
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> 
> 

-- 
View this message in context: http://old.nabble.com/Warnings-on-server-startup-tp29970547p30715405.html
Sent from the RabbitMQ mailing list archive at Nabble.com.


From jerryk at vmware.com  Thu Jan 20 01:20:21 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Wed, 19 Jan 2011 17:20:21 -0800
Subject: [rabbitmq-discuss] failure on startup
In-Reply-To: <AANLkTimTAHZ96bc+=6iY6aa+c=RW+Hi=0UV69W7nt5Tb@mail.gmail.com>
References: <AANLkTimTAHZ96bc+=6iY6aa+c=RW+Hi=0UV69W7nt5Tb@mail.gmail.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC1F@EXCH-MBX-3.vmware.com>

>  jailed FreeBSD 8.x, rabbitmq 2.1.0_1, erlang-lite-r14b01,1 hydra#
> /usr/local/etc/rc.d/rabbitmq start
> {error_logger,{{2011,1,19},{14,40,28}},"Protocol: ~p: register
> error:
> ~p~n",["inet_tcp",{{badmatch,{error,epmd_close}},[{inet_tcp_dist,listen,1},{net>
> _kernel,start_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,init,1},{gen_server,init_it,6},{proc_lib,init_p_do_apply,3}]}]}
>
> [ rest of dump deleted ]
>

It looks like your Rabbit is having trouble connecting to epmd, the
Erlang Port Mapper Daemon.  When an Erlang VM fires up it tries to
register itself with a daemon listening on port 4369 by default, and
starts one if it can't find one.

Can you 'ps' and see if you have an epmd process up and running?  Can
your Erlang node connect to it when running in the jailed
configuration you're in?  If you just try to start up a distributed
Erlang node with a bogus name like so:

erl -name bogusnode

what happens?

If you need to start an epmd up to play with you can see its man page
with:

erl -man epmd

There are reports that Erlang 14B may have a congenital problem with
free BSD jails due to some hardcoding that expects to find epmd at
127.0.0.1.  I gather that jails rewrite connections to localhost with
the IP address that the jail is bound to, which trips up some checks
that Erlang does.  The thread below discusses a patch for this
behavior dating from late last fall.  I don't know what it's release
status is:

http://groups.google.com/group/erlang-programming/msg/244597dd7f874e73

http://groups.google.com/group/mailing.freebsd.ports/browse_thread/thread/1f7210334fc11646

There are claims that switching to a slightly older Erlang, with which
Rabbit ought to still work, may help as well.  My jail knowledge is
super rusty, but it might also be possible to reconfigure your jail's
settings to give Erlang something more akin to the vanilla localhost
it's expecting...

Best regards,
Jerry

From stask312 at gmail.com  Thu Jan 20 06:16:52 2011
From: stask312 at gmail.com (Stas Krichevsky)
Date: Thu, 20 Jan 2011 08:16:52 +0200
Subject: [rabbitmq-discuss] Restarting management plugin without restarting
	the whole server
Message-ID: <62A0AF45-C76F-48D1-AF4F-A3B8BDDF246F@gmail.com>

Hi,
Management plugin stopped working recently on our production system (CentOS 5.5, Erlang R14B, RabbitMQ 2.2.0).
Is there a way to restart just the plugin without restarting the whole server?

Here are the errors from the log file:

=ERROR REPORT==== 19-Jan-2011::06:51:08 ===
** Generic server rabbit_mgmt_db terminating 
** Last message in was {get_overview,all}
** When Server state == {state,[{channel_exchange_stats,1100349497},
                                {channel_queue_exchange_stats,1100353594},
                                {channel_queue_stats,1100345400},
                                {channel_stats,1100341303},
                                {connection_stats,1100337206},
                                {queue_stats,1100333096}]}
** Reason for termination == 
** {{badmatch,[]},
    [{rabbit_mgmt_db,augment_queue_pid,2},
     {rabbit_mgmt_db,augment,4},
     {rabbit_mgmt_db,'-augment/3-lc$^0/1-0-',3},
     {rabbit_mgmt_db,'-augment/3-lc$^0/1-0-',3},
     {rabbit_mgmt_db,augment,3},
     {rabbit_mgmt_db,'-handle_call/3-lc$^4/1-4-',4},
     {rabbit_mgmt_db,'-handle_call/3-lc$^4/1-4-',4},
     {rabbit_mgmt_db,'-handle_call/3-fun-2-',4}]}

=ERROR REPORT==== 19-Jan-2011::06:51:08 ===
webmachine error: path="/api/overview"
{error,{exit,{{{badmatch,[]},
               [{rabbit_mgmt_db,augment_queue_pid,2},
                {rabbit_mgmt_db,augment,4},
                {rabbit_mgmt_db,'-augment/3-lc$^0/1-0-',3},
                {rabbit_mgmt_db,'-augment/3-lc$^0/1-0-',3},
                {rabbit_mgmt_db,augment,3},
                {rabbit_mgmt_db,'-handle_call/3-lc$^4/1-4-',4},
                {rabbit_mgmt_db,'-handle_call/3-lc$^4/1-4-',4},
                {rabbit_mgmt_db,'-handle_call/3-fun-2-',4}]},
              {gen_server,call,
                          [{global,rabbit_mgmt_db},
                           {get_overview,all},
                           infinity]}},
             [{gen_server,call,3},
              {rabbit_mgmt_db,safe_call,2},
              {rabbit_mgmt_wm_overview,to_json,2},
              {webmachine_resource,resource_call,3},
              {webmachine_resource,do,3},
              {webmachine_decision_core,resource_call,1},
              {webmachine_decision_core,decision,1},
              {webmachine_decision_core,handle_request,2}]}}

=INFO REPORT==== 19-Jan-2011::06:51:08 ===
Statistics database already registered at <0.12672.147>.

Thanks,
/stask

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110120/40c4acf7/attachment.htm>

From oyvind at tjervaag.com  Thu Jan 20 08:03:13 2011
From: oyvind at tjervaag.com (=?iso-8859-1?Q?=D8yvind_Tjervaag?=)
Date: Thu, 20 Jan 2011 09:03:13 +0100
Subject: [rabbitmq-discuss] Shovel bug? Consumer hangs after network failure.
Message-ID: <C0DB3E20-AC51-4027-8E5A-860751563E17@tjervaag.com>

Hi!

I don't know if I've found a bug or if there is something in my setup that needs changing..
I have 2 RabbitMQ servers (v2.2.0 of everything, windows 2003 r2, Erlang 5.8.1.1) connected via a very unstable radio link (well.. they're in my development LAN at the moment, but will be moved to an unstable link in not too many weeks...). My test setup is something like this:

Rabbit1 --> Network switch --> Horrible bad network link --> Network switch --> Rabbit2

I needed to move messages in both directions between the rabbit servers. I first installed the shovel plugin on rabbit2 only, and configured that to move messages in both directions. If I consume from a queue on Rabbit1 with the shovel on Rabbit2 and disconnect the network between them, the consumer doesn't seem to be able to reconnect to rabbit1 when the network comes back up, generating errors like this:

=SUPERVISOR REPORT==== 19-Jan-2011::12:57:30 ===
     Supervisor: {<0.1973.0>,amqp_connection_sup}
     Context:    child_terminated
     Reason:     {error,etimedout}
     Offender:   [{pid,<0.1976.0>},
                  {name,connection},
                  {mfa,
                      {amqp_gen_connection,start_link,
                          [amqp_network_connection,
                           {amqp_params,<<"guest">>,<<"guest">>,<<"/">>,
                               "192.168.0.2",5672,0,0,0,none,[]},
                           #Fun<amqp_connection_sup.0.64044238>,
                           #Fun<amqp_connection_sup.2.105785818>,[]]}},
                  {restart_type,intrinsic},
                  {shutdown,brutal_kill},
                  {child_type,worker}]

The shovel that moves messages from Rabbit2 to Rabbit1 however detects that the network was down, and reconnects properly. I've done a temporary workaround by always having my shovel plugin on the same server where I consume messages.

This seems to be the same "issue" I had with the .NET client a while ago where I had to call a passive queue declare in my consumer code to trigger a (channel?-) fault to detect that a connection had gone away.

.. So I suppose the question is: Is there any way to configure the shovel plugin differently to get it to detect that a connection to a remote rabbit server has gone away?

thanks,

?yvind

From majek04 at gmail.com  Thu Jan 20 10:42:24 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Thu, 20 Jan 2011 10:42:24 +0000
Subject: [rabbitmq-discuss] Restarting management plugin without
 restarting the whole server
In-Reply-To: <62A0AF45-C76F-48D1-AF4F-A3B8BDDF246F@gmail.com>
References: <62A0AF45-C76F-48D1-AF4F-A3B8BDDF246F@gmail.com>
Message-ID: <AANLkTimoy=qjxq4EYzZW93Mk5fvzKr7OqcLKV0sai1Pv@mail.gmail.com>

On Thu, Jan 20, 2011 at 06:16, Stas Krichevsky <stask312 at gmail.com> wrote:
> Management plugin stopped working recently on our production system (CentOS
> 5.5, Erlang R14B, RabbitMQ 2.2.0).
> Is there a way to restart just the plugin without restarting the whole
> server?

Good question. I'm not an expert, but this worked for me:
application:loaded_applications().
application:stop(rabbit_management).
application:stop(webmachine).
application:stop(rabbit_mochiweb).
application:stop(mochiweb).

application:start(rabbit_mochiweb).
application:start(webmachine).
application:start(rabbit_management).

But beware it can probably make things even worse.

Chers,
  Marek

From stask312 at gmail.com  Thu Jan 20 14:48:50 2011
From: stask312 at gmail.com (Stas Krichevsky)
Date: Thu, 20 Jan 2011 16:48:50 +0200
Subject: [rabbitmq-discuss] Restarting management plugin without
	restarting the whole server
In-Reply-To: <AANLkTimoy=qjxq4EYzZW93Mk5fvzKr7OqcLKV0sai1Pv@mail.gmail.com>
References: <62A0AF45-C76F-48D1-AF4F-A3B8BDDF246F@gmail.com>
	<AANLkTimoy=qjxq4EYzZW93Mk5fvzKr7OqcLKV0sai1Pv@mail.gmail.com>
Message-ID: <7D07D1E4-9783-43DA-B971-8B700B96ED89@gmail.com>

Thanks Marek,

I tried to run it, and while the plugin itself restarts, it's still not working (it doesn't show any statistics).
I think it's related to 'statistics_db_node' -- i'm getting following as part of /api/overview response:
"statistics_db_node":"not_running"
Is there a way to restart 'statistics_db_node'?

Thanks,

/stask

On Jan 20, 2011, at 12:42 PM, Marek Majkowski wrote:

> On Thu, Jan 20, 2011 at 06:16, Stas Krichevsky <stask312 at gmail.com> wrote:
>> Management plugin stopped working recently on our production system (CentOS
>> 5.5, Erlang R14B, RabbitMQ 2.2.0).
>> Is there a way to restart just the plugin without restarting the whole
>> server?
> 
> Good question. I'm not an expert, but this worked for me:
> application:loaded_applications().
> application:stop(rabbit_management).
> application:stop(webmachine).
> application:stop(rabbit_mochiweb).
> application:stop(mochiweb).
> 
> application:start(rabbit_mochiweb).
> application:start(webmachine).
> application:start(rabbit_management).
> 
> But beware it can probably make things even worse.
> 
> Chers,
>  Marek

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110120/c311c940/attachment.htm>

From markjreed at gmail.com  Thu Jan 20 15:33:36 2011
From: markjreed at gmail.com (Mark J. Reed)
Date: Thu, 20 Jan 2011 10:33:36 -0500
Subject: [rabbitmq-discuss] Management plugin issues
In-Reply-To: <4D3730D6.1050304@rabbitmq.com>
References: <AANLkTik1nXYFEzp4ffOf9iroU9kMPD=qtjPi7_VAsj7T@mail.gmail.com>
	<4D36D0E3.1000607@rabbitmq.com>
	<AANLkTin-frH7fXC=FyvPr19b81Op1Op_5KLXkh2p+_uz@mail.gmail.com>
	<4D37293C.5050908@rabbitmq.com>
	<AANLkTimDAn2Wvsd+JFQf-pW4qTQrRhSLTq3ydyaCV41B@mail.gmail.com>
	<4D3730D6.1050304@rabbitmq.com>
Message-ID: <AANLkTi=duBo=_MkujymtSZifmSXWMADpRqO1hexfPijV@mail.gmail.com>

On Wed, Jan 19, 2011 at 1:43 PM, Matthias Radestock
<matthias at rabbitmq.com> wrote:
> Interesting. Are you using rabbitmqctl across machines from different
> clusters? That might be enough for them to find out about each other.

Nope.

The clusters were all using the same Erlang cookie; that's the only
connection between them.  Giving them distinct cookie values has
resolved the issue.

I thought the cookie was just an authentication key; I didn't realize
that the stats module went door-to-door trying the key out and walking
through whichever ones opened. :)

Anyway, my issues are resolved.  Thanks!

-- 
Mark J. Reed <markjreed at gmail.com>

From Joel.Grandin at mathworks.com  Thu Jan 20 15:59:19 2011
From: Joel.Grandin at mathworks.com (Joel Grandin)
Date: Thu, 20 Jan 2011 15:59:19 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
Message-ID: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>

How do you use rabbitmqctl for a remote host?

Thx
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110120/ccf1f2ec/attachment.htm>

From matthew at rabbitmq.com  Thu Jan 20 16:09:38 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Thu, 20 Jan 2011 16:09:38 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>
Message-ID: <20110120160938.GM14484@rabbitmq.com>

On Thu, Jan 20, 2011 at 03:59:19PM +0000, Joel Grandin wrote:
> How do you use rabbitmqctl for a remote host?

rabbitmqctl -n $NODE ...

Matthew

From matthew at rabbitmq.com  Thu Jan 20 16:29:33 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Thu, 20 Jan 2011 16:29:33 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>
	<20110120160938.GM14484@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
Message-ID: <20110120162933.GN14484@rabbitmq.com>

Joel,

Please keep the mailing list CC'd - then others can benefit from the
discussion.

On Thu, Jan 20, 2011 at 04:21:25PM +0000, Joel Grandin wrote:
> When I did that I got an error message so perhaps I am not defining the $NODE correctly. 
> 
> If I look at the server management console I see that the node is defined by
> 
> Erlang Nodename	rabbit at my-server-name
> Operating System PID	32506
> Bound To	0.0.0.0:5672
> File Descriptors	30 / 2560 (used/available)
> Erlang Processes	202 / 1048576 (used/available)
> Memory		31.6MB / 4.6GB (used/available)
> 
> If I ping "my-server-name" I get a valid response.
> 
> If I then use it in this format I get
> 
> rabbitmqctl -n rabbit at my-server-name list_consumers
> Listing consumers ...
> Error: {'EXIT',{{case_clause,{{badrpc,nodedown}}},
>                 [{rabbit_control,'-action/5-lc$^0/1-0-',1},
>                  {rabbit_control,action,5},
>                  {rabbit_control,start,0},
>                  {init,start_it,1},
>                  {init,start_em,1}]}}
> 
> How would you define the port too?

5672 is merely the AMQP port. You need to make sure that it can access
epmd on my-server-name which should be port 4369. See the man page for
epmd if you need to change that.

If you have no firewall between these machines at all then it would
likely be some sort of DNS resolution issue, but seeing as you can ping
the server, that seems unlikely.

Matthew

From matthias at rabbitmq.com  Thu Jan 20 16:34:32 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Thu, 20 Jan 2011 16:34:32 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <20110120162933.GN14484@rabbitmq.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>	<20110120160938.GM14484@rabbitmq.com>	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
	<20110120162933.GN14484@rabbitmq.com>
Message-ID: <4D386418.1020003@rabbitmq.com>

Matthew Sackman wrote:
> On Thu, Jan 20, 2011 at 04:21:25PM +0000, Joel Grandin wrote:
>> rabbitmqctl -n rabbit at my-server-name list_consumers
>> Listing consumers ...
>> Error: {'EXIT',{{case_clause,{{badrpc,nodedown}}},
>>                 [{rabbit_control,'-action/5-lc$^0/1-0-',1},
>>                  {rabbit_control,action,5},
>>                  {rabbit_control,start,0},
>>                  {init,start_it,1},
>>                  {init,start_em,1}]}}
>>
>> How would you define the port too?
> 
> 5672 is merely the AMQP port. You need to make sure that it can access
> epmd on my-server-name which should be port 4369. See the man page for
> epmd if you need to change that.
> 
> If you have no firewall between these machines at all then it would
> likely be some sort of DNS resolution issue, but seeing as you can ping
> the server, that seems unlikely.

Try 'rabbitmqctl -n rabbit at my-server-name status'

That will provide better diagnostics.


Matthias.

From simon at rabbitmq.com  Thu Jan 20 16:39:22 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Thu, 20 Jan 2011 16:39:22 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <20110120162933.GN14484@rabbitmq.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>	<20110120160938.GM14484@rabbitmq.com>	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
	<20110120162933.GN14484@rabbitmq.com>
Message-ID: <4D38653A.3070202@rabbitmq.com>

On 20/01/11 16:29, Matthew Sackman wrote:
 > On Thu, Jan 20, 2011 at 04:21:25PM +0000, Joel Grandin wrote:
>> If I look at the server management console I see that the node is defined by

If you're running management already then you could look at 
rabbitmqadmin. This is a command line tool that talks http to the 
management plugin.

rabbitmqadmin won't let you start / stop / reset / cluster but it will 
do most other things.

 From your mail it looks like you're running an older version of 
RabbitMQ where the management plugin did not come with rabbitmqadmin - 
but the HTTP API is fairly constant so just grabbing the latest version 
from hg should work pretty well:

http://hg.rabbitmq.com/rabbitmq-management/raw-file/default/bin/rabbitmqadmin

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From Joel.Grandin at mathworks.com  Thu Jan 20 16:45:01 2011
From: Joel.Grandin at mathworks.com (Joel Grandin)
Date: Thu, 20 Jan 2011 16:45:01 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <4D386418.1020003@rabbitmq.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>
	<20110120160938.GM14484@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
	<20110120162933.GN14484@rabbitmq.com> <4D386418.1020003@rabbitmq.com>
Message-ID: <CD78003D3DEB444F87AE18120CA751B60223FF@exmb-01-ah.ad.mathworks.com>

This is the results from "status"

rabbitmqctl -n rabbit at my-server-name
Status of node 'rabbit at my-server-name' ...
Error: unable to connect to node 'rabbit at my-server-name': nodedown
diagnostics:
- nodes and their ports on my-server-name: [{rabbit,64066}]
- current node: 'rabbitmqctl at my-localhost'
- current node home dir: H:\
- current node cookie hash: HKx1IftG6awfKfr7YEqB1Q==

If I run "telnet my-server-name 4369", it connects.

Joel

-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Matthias Radestock
Sent: Thursday, January 20, 2011 11:35 AM
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] rabbitmqctl help

Matthew Sackman wrote:
> On Thu, Jan 20, 2011 at 04:21:25PM +0000, Joel Grandin wrote:
>> rabbitmqctl -n rabbit at my-server-name list_consumers
>> Listing consumers ...
>> Error: {'EXIT',{{case_clause,{{badrpc,nodedown}}},
>>                 [{rabbit_control,'-action/5-lc$^0/1-0-',1},
>>                  {rabbit_control,action,5},
>>                  {rabbit_control,start,0},
>>                  {init,start_it,1},
>>                  {init,start_em,1}]}}
>>
>> How would you define the port too?
> 
> 5672 is merely the AMQP port. You need to make sure that it can access
> epmd on my-server-name which should be port 4369. See the man page for
> epmd if you need to change that.
> 
> If you have no firewall between these machines at all then it would
> likely be some sort of DNS resolution issue, but seeing as you can ping
> the server, that seems unlikely.

Try 'rabbitmqctl -n rabbit at my-server-name status'

That will provide better diagnostics.


Matthias.
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From Joel.Grandin at mathworks.com  Thu Jan 20 16:49:46 2011
From: Joel.Grandin at mathworks.com (Joel Grandin)
Date: Thu, 20 Jan 2011 16:49:46 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <4D38653A.3070202@rabbitmq.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>
	<20110120160938.GM14484@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
	<20110120162933.GN14484@rabbitmq.com> <4D38653A.3070202@rabbitmq.com>
Message-ID: <CD78003D3DEB444F87AE18120CA751B602240E@exmb-01-ah.ad.mathworks.com>

I will take a look. We are using the web management console but I hadn't noticed a way to get consumer information like you can with "rabbitmqctl list_consumers"

The management console is on the remote machine that I am trying to connect to using rabbitmqctl. We are using the following versions.

Name	Version
amqp_client	2.1.1
crypto	2.0.2
inets	5.5.1
kernel	2.14.2
mnesia	4.4.16
mochiweb	1.3
os_mon	2.2.5
rabbit	2.1.1
rabbit_jsonrpc	2.1.1
rabbit_jsonrpc_channel	2.1.1
rabbit_management	2.1.1
rabbit_mochiweb	2.1.1
rfc4627_jsonrpc	0.01
sasl	2.1.9.2
stdlib	1.17.2


webmachine	1.7.0
-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Simon MacMullen
Sent: Thursday, January 20, 2011 11:39 AM
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] rabbitmqctl help

On 20/01/11 16:29, Matthew Sackman wrote:
 > On Thu, Jan 20, 2011 at 04:21:25PM +0000, Joel Grandin wrote:
>> If I look at the server management console I see that the node is defined by

If you're running management already then you could look at 
rabbitmqadmin. This is a command line tool that talks http to the 
management plugin.

rabbitmqadmin won't let you start / stop / reset / cluster but it will 
do most other things.

 From your mail it looks like you're running an older version of 
RabbitMQ where the management plugin did not come with rabbitmqadmin - 
but the HTTP API is fairly constant so just grabbing the latest version 
from hg should work pretty well:

http://hg.rabbitmq.com/rabbitmq-management/raw-file/default/bin/rabbitmqadmin

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From simon at rabbitmq.com  Thu Jan 20 16:51:22 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Thu, 20 Jan 2011 16:51:22 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <CD78003D3DEB444F87AE18120CA751B602240E@exmb-01-ah.ad.mathworks.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>	<20110120160938.GM14484@rabbitmq.com>	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>	<20110120162933.GN14484@rabbitmq.com>
	<4D38653A.3070202@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B602240E@exmb-01-ah.ad.mathworks.com>
Message-ID: <4D38680A.4020503@rabbitmq.com>

On 20/01/11 16:49, Joel Grandin wrote:
> I will take a look. We are using the web management console but I
> hadn't noticed a way to get consumer information like you can with
> "rabbitmqctl list_consumers"

Ah, sorry. I think that's not in 2.1.1, but I read your mail as saying 
"list_connections" somehow.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From matthew at rabbitmq.com  Thu Jan 20 16:52:16 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Thu, 20 Jan 2011 16:52:16 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <CD78003D3DEB444F87AE18120CA751B60223FF@exmb-01-ah.ad.mathworks.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>
	<20110120160938.GM14484@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
	<20110120162933.GN14484@rabbitmq.com>
	<4D386418.1020003@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223FF@exmb-01-ah.ad.mathworks.com>
Message-ID: <20110120165216.GO14484@rabbitmq.com>

On Thu, Jan 20, 2011 at 04:45:01PM +0000, Joel Grandin wrote:
> This is the results from "status"
> 
> rabbitmqctl -n rabbit at my-server-name
> Status of node 'rabbit at my-server-name' ...
> Error: unable to connect to node 'rabbit at my-server-name': nodedown
> diagnostics:
> - nodes and their ports on my-server-name: [{rabbit,64066}]
> - current node: 'rabbitmqctl at my-localhost'
> - current node home dir: H:\
> - current node cookie hash: HKx1IftG6awfKfr7YEqB1Q==
> 
> If I run "telnet my-server-name 4369", it connects.

Ok, so our best guess now is that you've got different cookies on both
machines. The erlang cookies must be the same - it's an authentication
token of sorts.

http://www.rabbitmq.com/install.html#running-windows-service
explains where the cookie is stored under windows. You need to make sure
the cookie files on both my-server-name and my-localhost are the same.

Matthew

From Joel.Grandin at mathworks.com  Thu Jan 20 18:17:09 2011
From: Joel.Grandin at mathworks.com (Joel Grandin)
Date: Thu, 20 Jan 2011 18:17:09 +0000
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <20110120165216.GO14484@rabbitmq.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>
	<20110120160938.GM14484@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
	<20110120162933.GN14484@rabbitmq.com>	<4D386418.1020003@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223FF@exmb-01-ah.ad.mathworks.com>
	<20110120165216.GO14484@rabbitmq.com>
Message-ID: <CD78003D3DEB444F87AE18120CA751B6022478@exmb-01-ah.ad.mathworks.com>

The cookie was the problem. Thanks to all for your help. Any opinions on good resources to read etc for a team not familiar to erlang.



-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Matthew Sackman
Sent: Thursday, January 20, 2011 11:52 AM
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] rabbitmqctl help

On Thu, Jan 20, 2011 at 04:45:01PM +0000, Joel Grandin wrote:
> This is the results from "status"
> 
> rabbitmqctl -n rabbit at my-server-name
> Status of node 'rabbit at my-server-name' ...
> Error: unable to connect to node 'rabbit at my-server-name': nodedown
> diagnostics:
> - nodes and their ports on my-server-name: [{rabbit,64066}]
> - current node: 'rabbitmqctl at my-localhost'
> - current node home dir: H:\
> - current node cookie hash: HKx1IftG6awfKfr7YEqB1Q==
> 
> If I run "telnet my-server-name 4369", it connects.

Ok, so our best guess now is that you've got different cookies on both
machines. The erlang cookies must be the same - it's an authentication
token of sorts.

http://www.rabbitmq.com/install.html#running-windows-service
explains where the cookie is stored under windows. You need to make sure
the cookie files on both my-server-name and my-localhost are the same.

Matthew
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From jerryk at vmware.com  Thu Jan 20 18:23:50 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Thu, 20 Jan 2011 10:23:50 -0800
Subject: [rabbitmq-discuss] rabbitmqctl help
In-Reply-To: <CD78003D3DEB444F87AE18120CA751B6022478@exmb-01-ah.ad.mathworks.com>
References: <CD78003D3DEB444F87AE18120CA751B60223A9@exmb-01-ah.ad.mathworks.com>
	<20110120160938.GM14484@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223D4@exmb-01-ah.ad.mathworks.com>
	<20110120162933.GN14484@rabbitmq.com>	<4D386418.1020003@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B60223FF@exmb-01-ah.ad.mathworks.com>
	<20110120165216.GO14484@rabbitmq.com>
	<CD78003D3DEB444F87AE18120CA751B6022478@exmb-01-ah.ad.mathworks.com>
Message-ID: <37BE08C9-345C-4671-9B39-185D0485128C@vmware.com>

There's a brand new book from Manning that's quite decent, and has the added advantage of spending a bit more time and care on the OTP libraries than many past Erlang sources have:

http://www.manning.com/logan/

The Erlang language is quite small and can be picked up pretty quickly.  The OTP standard libraries are much less small, and some of the official documentation could be better, despite the usefulness of OTP in building systems.  This book helps fill that gap a bit.

Armstrong's book from Pragmatic Programmers is also good and quite popular:

http://www.pragprog.com/titles/jaerlang/programming-erlang

Best regards,
Jerry

On Jan 20, 2011, at 10:17 AM, Joel Grandin wrote:

> The cookie was the problem. Thanks to all for your help. Any opinions on good resources to read etc for a team not familiar to erlang.
> 
> 
> 
> -----Original Message-----
> From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Matthew Sackman
> Sent: Thursday, January 20, 2011 11:52 AM
> To: rabbitmq-discuss at lists.rabbitmq.com
> Subject: Re: [rabbitmq-discuss] rabbitmqctl help
> 
> On Thu, Jan 20, 2011 at 04:45:01PM +0000, Joel Grandin wrote:
>> This is the results from "status"
>> 
>> rabbitmqctl -n rabbit at my-server-name
>> Status of node 'rabbit at my-server-name' ...
>> Error: unable to connect to node 'rabbit at my-server-name': nodedown
>> diagnostics:
>> - nodes and their ports on my-server-name: [{rabbit,64066}]
>> - current node: 'rabbitmqctl at my-localhost'
>> - current node home dir: H:\
>> - current node cookie hash: HKx1IftG6awfKfr7YEqB1Q==
>> 
>> If I run "telnet my-server-name 4369", it connects.
> 
> Ok, so our best guess now is that you've got different cookies on both
> machines. The erlang cookies must be the same - it's an authentication
> token of sorts.
> 
> http://www.rabbitmq.com/install.html#running-windows-service
> explains where the cookie is stored under windows. You need to make sure
> the cookie files on both my-server-name and my-localhost are the same.
> 
> Matthew
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


From jerryk at vmware.com  Thu Jan 20 18:56:57 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Thu, 20 Jan 2011 10:56:57 -0800
Subject: [rabbitmq-discuss] failure on startup
In-Reply-To: <AANLkTinpe4wCpc=MmmfX8NeaXnCR1z7X6CN9Lqbm2Jxn@mail.gmail.com>
References: <AANLkTimTAHZ96bc+=6iY6aa+c=RW+Hi=0UV69W7nt5Tb@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC1F@EXCH-MBX-3.vmware.com>,
	<AANLkTinpe4wCpc=MmmfX8NeaXnCR1z7X6CN9Lqbm2Jxn@mail.gmail.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC27@EXCH-MBX-3.vmware.com>

> ps -ax reveals that epmd is in fact running.  I googled even harder
> after mailing the list and have also seen that it appears to be
> related to erlang (epmd specifically) for the exact problem you are
> talking about.
>
> I killed epmd and started it up in debugging mode
> (epmd -d -d -d) and then issued the requested command line, erl
> -name bogusnode
>
> the command line reported the following:
> [jlh at hydra ~]$ erl -name bogusnode
> {error_logger,{{2011,1,19},{22,46,41}},"Protocol: ~p: register
> error:
> ~p~n",["inet_tcp",{{badmatch,{error,epmd_close}},[{inet_tcp_dist,listen,1},{net_kernel,start_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,init,1},{gen_server,init_it,6},{proc_lib,init_p_do_apply,3}]}]}
> Crash dump was written to: erl_crash.dump Kernel pid terminated
> (application_controller)
> ({application_start_failure,kernel,{shutdown,{kernel,start,[normal,[]]}}})
>
> Which is the same type of error, badmatch,{error,epmd_close} as when
> I try to start RabbitMQ
>
> I'll start following up on the erlang
> forums, I'd rather not start off using an old version of erlang.
>
> Thank you so much for getting me pointed in the proper direction!

Hi, Jeff...

Glad it helped get you make some headway, and sorry you've had trouble.

BTW, if you wouldn't mind copying this list with your results, whether
from applying the aforementioned patch to a built-from-source Erlang
of your own, or upgrading to a specific newer one that already
incorporates it (if such a thing currently exists---I'm not sure it
does yet), that would be great.  That way there's a Google-able record
of the problem and a solution for other folks who may encounter it to
come across...

Best regards,
Jerry

From matthew at rabbitmq.com  Thu Jan 20 22:45:02 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Thu, 20 Jan 2011 22:45:02 +0000
Subject: [rabbitmq-discuss] Shovel bug? Consumer hangs after network
 failure.
In-Reply-To: <C0DB3E20-AC51-4027-8E5A-860751563E17@tjervaag.com>
References: <C0DB3E20-AC51-4027-8E5A-860751563E17@tjervaag.com>
Message-ID: <20110120224502.GA13371@rabbitmq.com>

Hi,

On Thu, Jan 20, 2011 at 09:03:13AM +0100, ?yvind Tjervaag wrote:
> I needed to move messages in both directions between the rabbit
> servers. I first installed the shovel plugin on rabbit2 only, and
> configured that to move messages in both directions. If I consume from
> a queue on Rabbit1 with the shovel on Rabbit2 and disconnect the
> network between them, the consumer doesn't seem to be able to
> reconnect to rabbit1 when the network comes back up, generating errors
> like this:
> 
> The shovel that moves messages from Rabbit2 to Rabbit1 however detects
> that the network was down, and reconnects properly. I've done a
> temporary workaround by always having my shovel plugin on the same
> server where I consume messages.

Yes, this is largely to be expected. Consuming is an asynchronous
activity and the Rabbit1 -> Rabbit2 shovel is just consuming from queues
on Rabbit1. Until the socket is closed by the kernel, it won't
necessarily notice that Rabbit1 has gone down. TCP timeouts can
sometimes be quite long. So, I would recommend that you turn on
heartbeats on that shovel. Unfortunately, looking through the source, I
see there is no way to turn on heartbeats. Sigh. I'll file a bug and get
that added.

Writing to a socket rather than reading from it is much more likely to
prompt an error quickly. Thus if you make your Rabbit1 -> Rabbit2 shovel
a shovel running in Rabbit1 (i.e. Rabbit1 is pushing to Rabbit2 rather
than Rabbit2 pulling from Rabbit1 as it is currently) then you should
find that's more reliable and copes without the addition of heartbeats.

Best wishes,

Matthew

From paul.pearcy at wallst.com  Thu Jan 20 23:49:38 2011
From: paul.pearcy at wallst.com (Paul Pearcy)
Date: Thu, 20 Jan 2011 18:49:38 -0500
Subject: [rabbitmq-discuss] Errors on latest mgmt plug-in
Message-ID: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E43EF@IS-EXCHANGEC101.wsod.local>

Hello,
  I am attempting to get by the bug mentioned in this thread that is causing me some pain:
http://old.nabble.com/Management-plugin-issues-td30705395.html

In order to do this, I have rebuilt the management plugin from source based on these directions:
http://hg.rabbitmq.com/rabbitmq-management/file/132edbdcaaa9/BUILDING

This was all clear and straight forward. In order to update, I stop rabbitmq, remove the old plugins files and place the ones built by me (except rabbit_common.ez) in the plugins directory.

RabbitMQ starts up fine, but I am getting the error below when attempting to use the mgmt interface. Any ideas where I have gone wrong?

Thanks,
Paul


Here is the error:
{error,
    {error,function_clause,
        [{rabbit_mgmt_wm_overview,to_json,
             [{wm_reqdata,'GET',
                  {1,1},
                  "10.2.123.16",
                  {wm_reqstate,#Port<0.4131>,
                      {dict,3,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                          {{[],[],[],[],[],
                            [[resource_module|rabbit_mgmt_wm_overview],
                             ['content-type',97,112,112,108,105,99,97,116,105,
                              111,110,47,106,115,111,110]],
                            [],
                            [['content-encoding',105,100,101,110,116,105,116,
                              121]],
                            [],[],[],[],[],[],[],[]}}},
                      undefined,"10.2.123.16",'REQDATA',undefined,undefined,
                      {wm_log_data,undefined,
                          {1295,566931,800397},
                          'GET',
                          {10,
                           {"host",
                            {'Host',"dm-essearchd101:55672"},
                            {"connection",
                             {'Connection',"keep-alive"},
                             {"authorization",
                              {'Authorization',"Basic Z3Vlc3Q6Z3Vlc3Q="},
                              {"accept",
                               {'Accept',"*/*"},
                               nil,
                               {"accept-encoding",
                                {'Accept-Encoding',"gzip,deflate,sdch"},
                                {"accept-charset",
                                 {'Accept-Charset',
                                     "ISO-8859-1,utf-8;q=0.7,*;q=0.3"},
                                 nil,nil},
                                {"accept-language",
                                 {'Accept-Language',"en-US,en;q=0.8"},
                                 nil,nil}}},
                              nil},
                             {"content-type",
                              {'Content-Type',"application/json"},
                              nil,nil}},
                            {"referer",
                             {'Referer',"http://dm-essearchd101:55672/mgmt/"},
                             nil,
                             {"user-agent",
                              {'User-Agent',
                                  "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.13 (KHTML, like Gecko) Chrome/9.0.597.67 Safari/534.13"},
                              nil,nil}}}},
                          "10.2.123.16","/api/overview",
                          {1,1},
                          404,0,undefined,undefined}},
                  [],"/api/overview","/api/overview",
                  {dict,0,16,16,8,80,48,
                      {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                      {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},
                  [],"../..",500,1073741824,67108864,[],[],
                  {10,
                   {"host",
                    {'Host',"dm-essearchd101:55672"},
                    {"connection",
                     {'Connection',"keep-alive"},
                     {"authorization",
                      {'Authorization',"Basic Z3Vlc3Q6Z3Vlc3Q="},
                      {"accept",
                       {'Accept',"*/*"},
                       nil,
                      {"accept-encoding",
                        {'Accept-Encoding',"gzip,deflate,sdch"},
                        {"accept-charset",
                         {'Accept-Charset',"ISO-8859-1,utf-8;q=0.7,*;q=0.3"},
                         nil,nil},
                        {"accept-language",
                         {'Accept-Language',"en-US,en;q=0.8"},
                         nil,nil}}},
                      nil},
                     {"content-type",
                      {'Content-Type',"application/json"},
                      nil,nil}},
                    {"referer",
                     {'Referer',"http://dm-essearchd101:55672/mgmt/"},
                     nil,
                     {"user-agent",
                      {'User-Agent',
                         "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.13 (KHTML, like Gecko) Chrome/9.0.597.67 Safari/534.13"},
                      nil,nil}}}},
                  not_fetched_yet,false,
                  {1,
                   {"content-type",
                    {"Content-Type","application/json"},
                    nil,nil}},
                  <<>>,
                  ["dm-essearchd101"],
                  55672},
              {context,
                  {user,<<"guest">>,
                      <<234,121,247,186,255,0,101,109,78,202,155,11,253,146,
                        176,230,62,9,99,64>>,
                      true},
                  <<"guest">>}]},
         {webmachine_resource,resource_call,3},
         {webmachine_resource,do,3},
         {webmachine_decision_core,resource_call,1},
         {webmachine_decision_core,decision,1},
         {webmachine_decision_core,handle_request,2},
         {webmachine_mochiweb,loop,1},
         {mochiweb_http,headers,5}]}}

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110120/614ae135/attachment-0001.htm>

From jerryk at vmware.com  Fri Jan 21 02:05:08 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Thu, 20 Jan 2011 18:05:08 -0800
Subject: [rabbitmq-discuss] Queue Stalling
In-Reply-To: <AANLkTim1L-84ej8iJwq3OBTE62vo48O-CRi2ESMQqkAG@mail.gmail.com>
References: <AANLkTim1L-84ej8iJwq3OBTE62vo48O-CRi2ESMQqkAG@mail.gmail.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC2F@EXCH-MBX-3.vmware.com>

Hi, Abinesh...

> I am using rabbitmq-grails plugin version 0.2. Using that plugin am
> able to create queues. Also am placing messages in the queues. The
> handler classes too continuously fetching the messages and proceed
> with further processing. But, sometimes the handler classes are not
> fetching the messages properly, due to that it results the messages
> are remain in the queue for long time. Do we need to acknowledge the
> message after fetching it or else please some one tell me the reason
> why the messages are remain in the queue. Also tell me is it any other
> way to fetch the message which is remain in the queue for a long time.

This should be straightforward to take care of.  An AMQP broker bears
responsibility for maintaining the existence of a message until it
knows that a client has taken responsibility for it.  Thus, if a
message is delivered to your client, a copy of the message
nevertheless remains behind on the broker until such time as the
delivery is ACKed.  You can do this either by explicitly using the
AMQP basic.ack method yourself, or by setting your consumer up to
auto-ACK, in which case it will ACK for you when messages are
received.

The intent of this handoff is to handle the case where your consumer
might have work to do in response to a delivered message, but where it
might crash before completing that work.  If your consumer goes away
with a delivered, but un-ACKed message, the broker will then re-queue
the message and attempt to redeliver it later.

Best regards,
Jerry

From abinesh.s at gmail.com  Fri Jan 21 05:04:52 2011
From: abinesh.s at gmail.com (abinesh s)
Date: Fri, 21 Jan 2011 10:34:52 +0530
Subject: [rabbitmq-discuss] Queue Stalling
In-Reply-To: <F78BCF638F95D74A99D036114107EDB5023948CC2F@EXCH-MBX-3.vmware.com>
References: <AANLkTim1L-84ej8iJwq3OBTE62vo48O-CRi2ESMQqkAG@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC2F@EXCH-MBX-3.vmware.com>
Message-ID: <AANLkTi=7hPdbHvgkA+A=+m4KAC_ar1f15DS04hz-V5rT@mail.gmail.com>

Hi Jerry,

Thanks for your reply. Am understanding your answer. The another problem for
me is If one message get stayed in a queue makes other incoming messages to
stay in the queue. Am placing messages in the queue continuously. If one
message start to stay makes other messages to stay some times the handler
classes fetching the messages one by one sometimes it wont, and results more
than 500 messages to stay in the queue. Is there any problem with the
rabbitmq-grails plugin ver 0.2 or am doing anything wrong. Please help me to
get rid of this.

Thanks & Regards
Abinesh S
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/228fe652/attachment.htm>

From simon at rabbitmq.com  Fri Jan 21 10:29:24 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Fri, 21 Jan 2011 10:29:24 +0000
Subject: [rabbitmq-discuss] Errors on latest mgmt plug-in
In-Reply-To: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E43EF@IS-EXCHANGEC101.wsod.local>
References: <5C3F8D74DE0D8344AF4E68E53DAB10DD05EE8E43EF@IS-EXCHANGEC101.wsod.local>
Message-ID: <4D396004.5030806@rabbitmq.com>

On 20/01/11 23:49, Paul Pearcy wrote:
> Hello,
>
> I am attempting to get by the bug mentioned in this thread that is
> causing me some pain:
>
> http://old.nabble.com/Management-plugin-issues-td30705395.html
>
> In order to do this, I have rebuilt the management plugin from source
> based on these directions:
>
> http://hg.rabbitmq.com/rabbitmq-management/file/132edbdcaaa9/BUILDING
>
> This was all clear and straight forward. In order to update, I stop
> rabbitmq, remove the old plugins files and place the ones built by me
> (except rabbit_common.ez) in the plugins directory.
>
> RabbitMQ starts up fine, but I am getting the error below when
> attempting to use the mgmt interface. Any ideas where I have gone wrong?

Yes, you've built the plugins from default, and you're running them 
against the 2.2.0 broker. You can either start running the broker from 
default, or build the plugins from the "rabbitmq_v2_2_0" tag. You 
probably want to do the latter.

Cleaning the public umbrella and switching branches can be a bit fiddly, 
so I suggest you start again, and do something like:

hg clone http://hg.rabbitmq.com/rabbitmq-public-umbrella
cd rabbitmq-public-umbrella
hg update rabbitmq_v2_2_0
make checkout
make BRANCH=rabbitmq_v2_2_0 named_update
(apply the patch)
make

I'll update the rabbit-management README to make the thing about tags 
more explicit.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From robin at digininja.org  Fri Jan 21 10:41:03 2011
From: robin at digininja.org (Robin Wood)
Date: Fri, 21 Jan 2011 10:41:03 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTiku5Pw4GY51Z8fZAPXUKaCvjPuP4mp3a9ud_-P8@mail.gmail.com>
References: <AANLkTimdQrWyzSW9VOzt6LC_19r8z+W_Zvi_cQ1rhCKe@mail.gmail.com>
	<C95C542A.16225%pdezwart@rubiconproject.com>
	<AANLkTi=EQGa43yjgXcYQg_UfqX=Zd374sabwvL4jT9+V@mail.gmail.com>
	<AANLkTinHZC20gqTL0tKBXxk79nwUotuuk==mirKNJEwu@mail.gmail.com>
	<AANLkTinzencE_CCW=nsDYCrZ7fnatLxtWYOL3M_bjswS@mail.gmail.com>
	<AANLkTiku5Pw4GY51Z8fZAPXUKaCvjPuP4mp3a9ud_-P8@mail.gmail.com>
Message-ID: <AANLkTimqH18Usgt1nVrd-tnNEfGc+deQYVLzG4XjENEJ@mail.gmail.com>

On 19 January 2011 19:47, Robin Harvey <harvey.robin at gmail.com> wrote:
> Hi Robin,
> I've recently released a PHP implementation of Amqp which works OK with
> RabbitMQ, you might like to try it. ?I've posted an example of how to do a
> really simple produce here:
> https://gist.github.com/786716
> You can download the code here:
> https://github.com/BraveSirRobin/amqphp
> HTH,

I still can't get this to talk to the Ruby. The Ruby consumer is in here

https://gist.github.com/786508

Can you get your libraries to talk to it?

Robin


> --Robin
>
> On Wed, Jan 19, 2011 at 5:32 PM, Robin Wood <robin at digininja.org> wrote:
>>
>> On 19 January 2011 17:18, Michael Klishin <michael.s.klishin at gmail.com>
>> wrote:
>> > 2011/1/19 Robin Wood?<robin at digininja.org>
>> >>
>> >> That has got rid of the errors but the Ruby consumer doesn't appear to
>> >> be receiving anything. The consumer I'm using is the one I sent at
>> >> 10:24 which should display anything that it receives.
>> >
>> > Robin,
>> > Can you maybe post code examples you have so far to gist.github.com?
>> > It is a bit difficult to follow what your code looks like after all the
>> > modifications.
>> > Thank you.
>> > --
>> > MK
>>
>> Ye, I was getting lost as well, here you go:
>>
>> https://gist.github.com/786508
>>
>> Robin
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

From oyvind at tjervaag.com  Fri Jan 21 11:00:41 2011
From: oyvind at tjervaag.com (=?iso-8859-1?Q?=D8yvind_Tjervaag?=)
Date: Fri, 21 Jan 2011 12:00:41 +0100
Subject: [rabbitmq-discuss] Shovel bug? Consumer hangs after network
	failure.
In-Reply-To: <20110120224502.GA13371@rabbitmq.com>
References: <C0DB3E20-AC51-4027-8E5A-860751563E17@tjervaag.com>
	<20110120224502.GA13371@rabbitmq.com>
Message-ID: <A353E0E0-8D9C-4985-B413-B2E8D54A35A3@tjervaag.com>

Hi!

On Jan 20, 2011, at 11:45 PM, Matthew Sackman wrote:

> 
> Yes, this is largely to be expected. Consuming is an asynchronous
> activity and the Rabbit1 -> Rabbit2 shovel is just consuming from queues
> on Rabbit1. Until the socket is closed by the kernel, it won't
> necessarily notice that Rabbit1 has gone down. TCP timeouts can
> sometimes be quite long. So, I would recommend that you turn on
> heartbeats on that shovel. Unfortunately, looking through the source, I
> see there is no way to turn on heartbeats. Sigh. I'll file a bug and get
> that added.

Thanks! Figured something like this was happening.

> Writing to a socket rather than reading from it is much more likely to
> prompt an error quickly. Thus if you make your Rabbit1 -> Rabbit2 shovel
> a shovel running in Rabbit1 (i.e. Rabbit1 is pushing to Rabbit2 rather
> than Rabbit2 pulling from Rabbit1 as it is currently) then you should
> find that's more reliable and copes without the addition of heartbeats.

Yep, that's what I've done to work around the problem, and it seems to be 
working nicely :)

Also, the shovel doesn't seem to recreate the queue it was subscribing to if 
someone deletes it (for example from the management plugin). Should it?

?yvind

From matthew at rabbitmq.com  Fri Jan 21 11:06:08 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Fri, 21 Jan 2011 11:06:08 +0000
Subject: [rabbitmq-discuss] Shovel bug? Consumer hangs after network
 failure.
In-Reply-To: <A353E0E0-8D9C-4985-B413-B2E8D54A35A3@tjervaag.com>
References: <C0DB3E20-AC51-4027-8E5A-860751563E17@tjervaag.com>
	<20110120224502.GA13371@rabbitmq.com>
	<A353E0E0-8D9C-4985-B413-B2E8D54A35A3@tjervaag.com>
Message-ID: <20110121110607.GA28952@rabbitmq.com>

On Fri, Jan 21, 2011 at 12:00:41PM +0100, ?yvind Tjervaag wrote:
> Also, the shovel doesn't seem to recreate the queue it was subscribing to if 
> someone deletes it (for example from the management plugin). Should it?

Nope. Don't delete queues you don't want to be deleted ;)

Matthew

From oyvind at tjervaag.com  Fri Jan 21 11:08:51 2011
From: oyvind at tjervaag.com (=?iso-8859-1?Q?=D8yvind_Tjervaag?=)
Date: Fri, 21 Jan 2011 12:08:51 +0100
Subject: [rabbitmq-discuss] Shovel bug? Consumer hangs after network
	failure.
In-Reply-To: <20110121110607.GA28952@rabbitmq.com>
References: <C0DB3E20-AC51-4027-8E5A-860751563E17@tjervaag.com>
	<20110120224502.GA13371@rabbitmq.com>
	<A353E0E0-8D9C-4985-B413-B2E8D54A35A3@tjervaag.com>
	<20110121110607.GA28952@rabbitmq.com>
Message-ID: <8A9A4AB2-E6E6-4B00-930A-915D31DF2430@tjervaag.com>


On Jan 21, 2011, at 12:06 PM, Matthew Sackman wrote:
> 
> Nope. Don't delete queues you don't want to be deleted ;)
> 
> Matthew

Okay then :) I'll try not too!

?yvind

From cristofer.seccia at gmail.com  Fri Jan 21 11:44:16 2011
From: cristofer.seccia at gmail.com (Crisoforo Seccia)
Date: Fri, 21 Jan 2011 12:44:16 +0100
Subject: [rabbitmq-discuss] RabbitMQ Test case - Possible Memory Leak
	problem
In-Reply-To: <20110114160023.GE18402@rabbitmq.com>
References: <AANLkTimgA6tNpstggKpeKTj2yUC+xdWGpuAD+CvYP9jq@mail.gmail.com>
	<20110114160023.GE18402@rabbitmq.com>
Message-ID: <AANLkTi=dDJLJrf67+KrA1Y6TxFYEs48_oisjyyeo-mwX@mail.gmail.com>

Hi,

I've fallowed your instructions and configured my RabbitMQ server under
windows to use different configuration setup:

1) [{rabbit, [{vm_memory_high_watermark, 0.80}]}].
2) [{rabbit, [{vm_memory_high_watermark, 0.40}]}].
3) [{rabbit, [{vm_memory_high_watermark, 0.25}]}].
4) [{rabbit, [{vm_memory_high_watermark, 0.20}]}].
5) [{rabbit, [{vm_memory_high_watermark, 0.10}]}].

Every time I've started RabbiitMQ server with one of the previous
configuration and then started my Test application but every time the
RabbitMQ server crashed down after a few minutes.I don't sincerly find any
problem in my application's code and, as I've stated in previous e-mail the
test is very simple. Anyway I've attached my project and hope someone can
test my application under different machine then window because for the
moment I'm unable to operate this kind of test. Hope to have a response.
Thanks, best regards

P.S. (How to use the project):

The attached file is a MAVEN project (platform independent) which produces
as output an executable project. The project is composed by two sub-modules,
one is use to test ActiveMQ and another one is used to test RabbitMQ.
Basically the project is a ready to go for running, just configure the
properties file (server connection, login, etc.). The configuration files
are respectively placed under
"${broker_type}mq/publisher/data/publisher.properties". Both the two
sub-modules (and both publisher or subscriber applications) produces as
output a .csv file under the folder
"${broker_type}mq/${application_type}/results" where are printed some test
results. Also the messages number and the size of the message can be
configured to the publishers by using the file located under the folder
"${broker_type}mq/${application_type}/data/${broker_type}MQTesterPublisher.txt"
(an example is already provided).

Cristoforo.

2011/1/14 Matthew Sackman <matthew at rabbitmq.com>

> Hi,
>
> On Tue, Jan 11, 2011 at 12:44:54PM +0100, Crisoforo Seccia wrote:
> > . Am I adopting a very strange test case which is not well handled by
> > RabbitMQ?
>
> Not really, no. However, there are problems with RabbitMQ under Windows,
> and you may have to do some tweaking of the configuration. The fact that
> you crashed on an eheap allocation suggests that Rabbit tried to
> allocate memory that Windows refused it.
> http://www.rabbitmq.com/extensions.html#memsup
>
> Rabbit by default assumes that it's the only application running on a
> machine, and thus it can expect to be allocated all memory. You may
> wish, as suggested in the above page, to try reducing the
> vm_memory_high_watermark and repeat the tests.
>
> > . Is there any connection with the solved bug described in the RabbitMQ
> 2.2
> > release notes (?fix memory leak when long-running channels consume and
> > cancel on many queues?)?
>
> Nope - that bug would have likely taken months of constant tripping to
> actually result in any sizable memory leak.
>
> > . How does RabbitMQ handle message flooding? As stated in ActiveMQ
> official
> > page, the flow control, in the current version means that: ?if the broker
> > detects that the memory limit for the destination, or the temp- or
> > file-store limits for the broker, have been exceeded, then the flow of
> > messages can be slowed down. The producer will be either blocked until
> > resources are available or will receive a JMSException?.
>
> Again, the above link will explain it all, but in short, Rabbit uses TCP
> back pressure to prevent producers flooding it with too many messages.
> Ultimately, you're always limited by the rate at which you can get rid
> of messages - whether to clients or to disk. In effect, RAM just acts as
> a huge (hopefully!) buffer.
>
> Matthew
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/3099811d/attachment-0001.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: MQTester.rar
Type: application/rar
Size: 41564 bytes
Desc: not available
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/3099811d/attachment-0001.rar>

From stastny at 101ideas.cz  Fri Jan 21 12:09:19 2011
From: stastny at 101ideas.cz (=?UTF-8?B?SmFrdWIgxaDFpWFzdG7DvQ==?=)
Date: Fri, 21 Jan 2011 12:09:19 +0000
Subject: [rabbitmq-discuss] php talking to ruby
Message-ID: <AANLkTikwJPVV7jMDEeaS=jii-s3A4Lzc0roYsFkkX6rH@mail.gmail.com>

Robin,

It's easy to make Ruby publish in text/plain:
https://gist.github.com/789576Also, as you can see from the example,
Ruby doesn't have any problems with
receiving messages in text/plain whatsoever. I'm going to add this
functionality to the client, because this sounds like a useful thing to
have. If you'll have any problems which should be fixed on the Ruby part,
I'll be more than happy to do so.

Jakub

http://www.flickr.com/photos/jakub-stastny
http://twitter.com/botanicus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/1c82bcb3/attachment.htm>

From tontondimsum at gmail.com  Fri Jan 21 13:21:55 2011
From: tontondimsum at gmail.com (Dimitri del Marmol)
Date: Fri, 21 Jan 2011 14:21:55 +0100
Subject: [rabbitmq-discuss] Reordering messages
Message-ID: <AANLkTikBAZZJwf88PrBaUaq3MJ9723XZ3ARka12OidtG@mail.gmail.com>

Hi everyone,

I am facing the following problem: I have to process messages from a
queue but messages can be of either high or low priority.
Messages have to be processed FIFO except that all high priority
messages must be processed before the oldest low priority message is
processed.

The 'dumb' solution would be to reorder the list before processing
each message. I could do that by acking all the messages and reposting
them to the queue in the right order I guess...

Is there an established pattern for this?

Dimitri

From david at rabbitmq.com  Fri Jan 21 13:43:50 2011
From: david at rabbitmq.com (David Wragg)
Date: Fri, 21 Jan 2011 13:43:50 +0000
Subject: [rabbitmq-discuss] Reordering messages
In-Reply-To: <AANLkTikBAZZJwf88PrBaUaq3MJ9723XZ3ARka12OidtG@mail.gmail.com>
	(Dimitri del Marmol's message of "Fri, 21 Jan 2011 14:21:55 +0100")
References: <AANLkTikBAZZJwf88PrBaUaq3MJ9723XZ3ARka12OidtG@mail.gmail.com>
Message-ID: <yrv4clj2epe21.fsf@dwragg.eng.vmware.com>

Dimitri del Marmol <tontondimsum at gmail.com> writes:
> I am facing the following problem: I have to process messages from a
> queue but messages can be of either high or low priority.
> Messages have to be processed FIFO except that all high priority
> messages must be processed before the oldest low priority message is
> processed.
>
> The 'dumb' solution would be to reorder the list before processing
> each message. I could do that by acking all the messages and reposting
> them to the queue in the right order I guess...
>
> Is there an established pattern for this?

Put the two categories of messages onto two separate queues, and write
your application to preferentially consume from the higher priority
queue.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From jeffh at delasco.com  Fri Jan 21 14:01:36 2011
From: jeffh at delasco.com (Jeff Hinrichs)
Date: Fri, 21 Jan 2011 08:01:36 -0600
Subject: [rabbitmq-discuss] failure on startup
In-Reply-To: <F78BCF638F95D74A99D036114107EDB5023948CC27@EXCH-MBX-3.vmware.com>
References: <AANLkTimTAHZ96bc+=6iY6aa+c=RW+Hi=0UV69W7nt5Tb@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC1F@EXCH-MBX-3.vmware.com>
	<AANLkTinpe4wCpc=MmmfX8NeaXnCR1z7X6CN9Lqbm2Jxn@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC27@EXCH-MBX-3.vmware.com>
Message-ID: <AANLkTik5Ng7926RmYMapDYB9VqoJ+WvAFyDGh1ejkBGY@mail.gmail.com>

On Thu, Jan 20, 2011 at 12:56 PM, Jerry Kuch <jerryk at vmware.com> wrote:

> > ps -ax reveals that epmd is in fact running.  I googled even harder
> > after mailing the list and have also seen that it appears to be
> > related to erlang (epmd specifically) for the exact problem you are
> > talking about.
> >
> > I killed epmd and started it up in debugging mode
> > (epmd -d -d -d) and then issued the requested command line, erl
> > -name bogusnode
> >
> > the command line reported the following:
> > [jlh at hydra ~]$ erl -name bogusnode
> > {error_logger,{{2011,1,19},{22,46,41}},"Protocol: ~p: register
> > error:
> >
> ~p~n",["inet_tcp",{{badmatch,{error,epmd_close}},[{inet_tcp_dist,listen,1},{net_kernel,start_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,init,1},{gen_server,init_it,6},{proc_lib,init_p_do_apply,3}]}]}
> > Crash dump was written to: erl_crash.dump Kernel pid terminated
> > (application_controller)
> >
> ({application_start_failure,kernel,{shutdown,{kernel,start,[normal,[]]}}})
> >
> > Which is the same type of error, badmatch,{error,epmd_close} as when
> > I try to start RabbitMQ
> >
> > I'll start following up on the erlang
> > forums, I'd rather not start off using an old version of erlang.
> >
> > Thank you so much for getting me pointed in the proper direction!
>
> Hi, Jeff...
>
> Glad it helped get you make some headway, and sorry you've had trouble.
>
> BTW, if you wouldn't mind copying this list with your results, whether
> from applying the aforementioned patch to a built-from-source Erlang
> of your own, or upgrading to a specific newer one that already
> incorporates it (if such a thing currently exists---I'm not sure it
> does yet), that would be great.  That way there's a Google-able record
> of the problem and a solution for other folks who may encounter it to
> come across...
>
> Best regards,
> Jerry
>
I emailed the maintainer for the FreeBSD port but haven't heard back from
them as yet.  For now, I've implemented the work around @
http://erlang.2086793.n4.nabble.com/crash-dump-at-ejabberd-startup-td3044533.html
..
 However, I wouldn't call this a "patch" as the current FreeBSD port is
suppose to recognize a connection from an ip that matches the local ip, as
being a true "Local".

I'll follow up on this post when I hear back from the official port
maintainer.

Best,

Jeff
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/205ab53d/attachment.htm>

From tontondimsum at gmail.com  Fri Jan 21 14:36:27 2011
From: tontondimsum at gmail.com (Dimitri del Marmol)
Date: Fri, 21 Jan 2011 15:36:27 +0100
Subject: [rabbitmq-discuss] Reordering messages
In-Reply-To: <yrv4clj2epe21.fsf@dwragg.eng.vmware.com>
References: <AANLkTikBAZZJwf88PrBaUaq3MJ9723XZ3ARka12OidtG@mail.gmail.com>
	<yrv4clj2epe21.fsf@dwragg.eng.vmware.com>
Message-ID: <AANLkTi=izkQZ+vMmAD4uZ88gxzWKNqM42b2dQDxxt6_T@mail.gmail.com>

> Put the two categories of messages onto two separate queues, and write
> your application to preferentially consume from the higher priority
> queue.

I actually toyed with the idea but I have trouble imagining what the
listener(s) would look like: should one listener subscribe to both
queues? If so, it will have to know when to ignore the low priority
callback (because the high priority queue is not empty)

From david at rabbitmq.com  Fri Jan 21 15:37:03 2011
From: david at rabbitmq.com (David Wragg)
Date: Fri, 21 Jan 2011 15:37:03 +0000
Subject: [rabbitmq-discuss] Reordering messages
In-Reply-To: <AANLkTi=izkQZ+vMmAD4uZ88gxzWKNqM42b2dQDxxt6_T@mail.gmail.com>
	(Dimitri del Marmol's message of "Fri, 21 Jan 2011 15:36:27 +0100")
References: <AANLkTikBAZZJwf88PrBaUaq3MJ9723XZ3ARka12OidtG@mail.gmail.com>
	<yrv4clj2epe21.fsf@dwragg.eng.vmware.com>
	<AANLkTi=izkQZ+vMmAD4uZ88gxzWKNqM42b2dQDxxt6_T@mail.gmail.com>
Message-ID: <yrv4caaiup8tc.fsf@dwragg.eng.vmware.com>

Hi Dimitri,

Dimitri del Marmol <tontondimsum at gmail.com> writes:
>> Put the two categories of messages onto two separate queues, and write
>> your application to preferentially consume from the higher priority
>> queue.
>
> I actually toyed with the idea but I have trouble imagining what the
> listener(s) would look like: should one listener subscribe to both
> queues? If so, it will have to know when to ignore the low priority
> callback (because the high priority queue is not empty)

The details of how you achieve this depend on which client library you
are using, and how your application is organized.  So with more
information someone might be able to give more specific advice.  But
here is the general idea.

As you suggest, your listener should consume from both queues.  You
should consume with no-ack=False (i.e. explicit acks).

In your code, you'll need a data structure to hold pending high-priority
messages (those that have arrived, but not yet been processed), and
another to hold pending low-prority messages.  The basic logic is then
as follows:

When a message arrives (from either queue):
  If a message is already being processed:
    Add the new message to the approprite pending messages data structure
  Else:
    Start processing the message

When processing of a message completes:
  Ack the processed message
  If there are any pending high-priority messages
    Remove one and start processing it
  Else, if there are any pending low-priority messages
    Remove one and start processing it
  Else:
    Nothing to do, so wait until another message arrives

So we obey the priorities because we always look for the high-priority
messages before looking in the low-priority slot.  If there are always
high-priority messages coming in, then we never look at the low-priority
messages, though we may have many of them sitting there un-acked.

How you would code this up depends upon the client library, and whether you
are in a multi-threaded or event-driven environment.

Things are a bit more complicated if you want to have multiple workers,
all obeying the priorities.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From robin at digininja.org  Fri Jan 21 16:07:17 2011
From: robin at digininja.org (Robin Wood)
Date: Fri, 21 Jan 2011 16:07:17 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTikwJPVV7jMDEeaS=jii-s3A4Lzc0roYsFkkX6rH@mail.gmail.com>
References: <AANLkTikwJPVV7jMDEeaS=jii-s3A4Lzc0roYsFkkX6rH@mail.gmail.com>
Message-ID: <AANLkTiksJZHUYDVq-SAUA0w9sNgRo5F2vWHfYjU9X863@mail.gmail.com>

I've just tried with your Ruby and my php from gist and get the following

PHP Fatal error:  Uncaught exception 'AMQPQueueException' with message
'Server channel error: 406, message: PRECONDITION_FAILED - parameters
for queue 'queue1' in vhost '/' not equivalent' in
/home/robin/comms/gist.php:13
Stack trace:
#0 /home/robin/comms/gist.php(13): AMQPQueue->declare('queue1')
#1 {main}
  thrown in /home/robin/comms/gist.php on line 13

which means the default connection settings in php are different to
the ones in Ruby. Are you able to get the two talking and if so how
hard is it to get it working in the other direction?

Robin


2011/1/21 Jakub ??astn? <stastny at 101ideas.cz>:
> Robin,
> It's easy to make Ruby publish in text/plain: https://gist.github.com/789576
> Also, as you can see from the example, Ruby doesn't have any problems with
> receiving messages in text/plain whatsoever. I'm going to add this
> functionality to the client, because this sounds like a useful thing to
> have. If you'll have any problems which should be fixed on the Ruby part,
> I'll be more than happy to do so.
> Jakub
> http://www.flickr.com/photos/jakub-stastny
> http://twitter.com/botanicus
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>

From scott at beamdog.com  Fri Jan 21 16:50:00 2011
From: scott at beamdog.com (Scott Brooks)
Date: Fri, 21 Jan 2011 09:50:00 -0700
Subject: [rabbitmq-discuss] SNMP Plugin.
In-Reply-To: <AANLkTin9B895LVcBAuci7nTBKZ2AmrkiXZ=LQpQN9x0H@mail.gmail.com>
References: <18689133d7.133d718689@it-action.com>
	<AANLkTi=9EmNW+ePtBZ-xTJtSzYQtby9hGns3vHcycKqu@mail.gmail.com>
	<AANLkTin9B895LVcBAuci7nTBKZ2AmrkiXZ=LQpQN9x0H@mail.gmail.com>
Message-ID: <AANLkTi=bL_TtNamK8Ra2OwjpZY-7KvO=kZZeBdtreFSf@mail.gmail.com>

The mib is at
https://github.com/epicadvertising/rabbitmq_snmp_plugin/blob/master/snmp/RABBITMQ-MIB.mib

Right now it's using a fake enterprise number of 12346, so that would
need to be fixed.

Then it would be a case of integrating with the management plugin to
pull from the same stats DB rather then all the tracing work that is
being done now.

Scott



On Wed, Jan 19, 2011 at 3:14 AM, mabrek <mabrek at gmail.com> wrote:
> On Wed, Dec 15, 2010 at 7:55 PM, Scott Brooks <scott at beamdog.com> wrote:
>> I'm assuming you're using
>> https://github.com/epicadvertising/rabbitmq_snmp_plugin
> ...
>> When I was originally working on it, my hope was that someone at
>> RabbitMQ would grab the .mib(the hardest part) and integrate it into
>> core, but this has not happened yet/I have no clue if they plan on it.
>
> Could you explain what needs to be done? There is a .mib file in your
> sources, does it need to be changed/fixed?
>
> Regards,
> Anton Lebedevich
>

From peter at cacoethes.co.uk  Fri Jan 21 17:48:53 2011
From: peter at cacoethes.co.uk (Peter Ledbrook)
Date: Fri, 21 Jan 2011 17:48:53 +0000
Subject: [rabbitmq-discuss] Cleaning up unhandled messages
Message-ID: <AANLkTimbD1nFK+SKzxSv2PDodMA64mhBDeK7EPm1OL11@mail.gmail.com>

Hi,

What techniques do people use in dealing with messages that remain
unhandled on a queue, for example if no consumer can process them
successfully (perhaps because there's something wrong with the
message)?

The specific situation that this question derives from is this:

    * A message causes an exception in the message handler;
    * the message is hence not acked;
    * the message never gets picked up again.

Now, the last item is really a result of a bug in the consumer, but
there is still a problem of messages that get left on the queue.

One suggestion that springs to mind is that the consumer should catch
the exception, ack the message and report it as bad in some way (if
that is in fact the case). I was also thinking of having a scavenger
consumer that deals with messages that get left like this, but that
would probably pick up messages that should be processed by the normal
consumer (and won't cause an exception).

Anyone have any other ideas?

Thanks,

Peter

From peter at cacoethes.co.uk  Fri Jan 21 17:50:42 2011
From: peter at cacoethes.co.uk (Peter Ledbrook)
Date: Fri, 21 Jan 2011 17:50:42 +0000
Subject: [rabbitmq-discuss] Queue Stalling
In-Reply-To: <AANLkTi=7hPdbHvgkA+A=+m4KAC_ar1f15DS04hz-V5rT@mail.gmail.com>
References: <AANLkTim1L-84ej8iJwq3OBTE62vo48O-CRi2ESMQqkAG@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC2F@EXCH-MBX-3.vmware.com>
	<AANLkTi=7hPdbHvgkA+A=+m4KAC_ar1f15DS04hz-V5rT@mail.gmail.com>
Message-ID: <AANLkTik9sa=ryyeqKt4YrmVQrjdXWH_7+ahETQM7qjRk@mail.gmail.com>

>
> Thanks for your reply. Am understanding your answer. The another problem
> for me is If one message get stayed in a queue makes other incoming messages
> to stay in the queue. Am placing messages in the queue continuously. If one
> message start to stay makes other messages to stay some times the handler
> classes fetching the messages one by one sometimes it wont, and results more
> than 500 messages to stay in the queue. Is there any problem with the
> rabbitmq-grails plugin ver 0.2 or am doing anything wrong. Please help me to
> get rid of this.


See this thread for more details:


http://grails.1312388.n4.nabble.com/RabbitMQ-plugin-Unhandled-messages-stuck-in-the-queue-td3221664.html

Peter
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/1929de97/attachment.htm>

From scott at beamdog.com  Fri Jan 21 18:03:25 2011
From: scott at beamdog.com (Scott Brooks)
Date: Fri, 21 Jan 2011 11:03:25 -0700
Subject: [rabbitmq-discuss] Cleaning up unhandled messages
In-Reply-To: <AANLkTimbD1nFK+SKzxSv2PDodMA64mhBDeK7EPm1OL11@mail.gmail.com>
References: <AANLkTimbD1nFK+SKzxSv2PDodMA64mhBDeK7EPm1OL11@mail.gmail.com>
Message-ID: <AANLkTint7dneqXceSBdtFBp4B=Fgt9u=+RUJSSPe-HCz@mail.gmail.com>

I've implemented the following before.

* Consumer gets a message
* Consumer throws exception
* Consumer stores md5sum of message in array of "bad messages"
* Consumer gets the message again
* Consumer throws exception
* Consumer checks bad messages array
* Bad message exists already, ack it, and publish the message to an
errors exchange.
* Errors exchange has a queue/consumer that logs to disk, sends alerts, etc.

Scott Brooks

On Fri, Jan 21, 2011 at 10:48 AM, Peter Ledbrook <peter at cacoethes.co.uk> wrote:
> Hi,
>
> What techniques do people use in dealing with messages that remain
> unhandled on a queue, for example if no consumer can process them
> successfully (perhaps because there's something wrong with the
> message)?
>
> The specific situation that this question derives from is this:
>
> ? ?* A message causes an exception in the message handler;
> ? ?* the message is hence not acked;
> ? ?* the message never gets picked up again.
>
> Now, the last item is really a result of a bug in the consumer, but
> there is still a problem of messages that get left on the queue.
>
> One suggestion that springs to mind is that the consumer should catch
> the exception, ack the message and report it as bad in some way (if
> that is in fact the case). I was also thinking of having a scavenger
> consumer that deals with messages that get left like this, but that
> would probably pick up messages that should be processed by the normal
> consumer (and won't cause an exception).
>
> Anyone have any other ideas?
>
> Thanks,
>
> Peter
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From pdezwart at rubiconproject.com  Fri Jan 21 17:54:44 2011
From: pdezwart at rubiconproject.com (Pieter de Zwart)
Date: Fri, 21 Jan 2011 09:54:44 -0800
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTiksJZHUYDVq-SAUA0w9sNgRo5F2vWHfYjU9X863@mail.gmail.com>
Message-ID: <C95F0864.1649D%pdezwart@rubiconproject.com>

Your problem isnt the two talking together. It is getting them to agree on a
queue definition. I still don't understand why you are trying to declare the
queue in PHP. If PHP is the publisher, then remove the queue definition
portion and see how it runs. If you need the queue definition, I would
suggest deleting the queue entirely, and then let PHP define the queue
first, and run Ruby afterwards.

Pieter


On 1/21/11 8:07 AM, "Robin Wood" <robin at digininja.org> wrote:

> I've just tried with your Ruby and my php from gist and get the following
PHP
> Fatal error:  Uncaught exception 'AMQPQueueException' with message
'Server
> channel error: 406, message: PRECONDITION_FAILED - parameters
for queue
> 'queue1' in vhost '/' not equivalent' in
/home/robin/comms/gist.php:13
Stack
> trace:
#0 /home/robin/comms/gist.php(13): AMQPQueue->declare('queue1')
#1
> {main}
  thrown in /home/robin/comms/gist.php on line 13

which means the
> default connection settings in php are different to
the ones in Ruby. Are you
> able to get the two talking and if so how
hard is it to get it working in the
> other direction?

Robin


2011/1/21 Jakub ??astn? <stastny at 101ideas.cz>:
>
> Robin,
> It's easy to make Ruby publish in text/plain:
> https://gist.github.com/789576
> Also, as you can see from the example, Ruby
> doesn't have any problems with
> receiving messages in text/plain whatsoever.
> I'm going to add this
> functionality to the client, because this sounds like
> a useful thing to
> have. If you'll have any problems which should be fixed on
> the Ruby part,
> I'll be more than happy to do so.
> Jakub
>
> http://www.flickr.com/photos/jakub-stastny
> http://twitter.com/botanicus
>
> _______________________________________________
> rabbitmq-discuss mailing
> list
> rabbitmq-discuss at lists.rabbitmq.com
>
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
_____
> __________________________________________
rabbitmq-discuss mailing
> list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/ma
> ilman/listinfo/rabbitmq-discuss



From jerryk at vmware.com  Fri Jan 21 18:53:16 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Fri, 21 Jan 2011 10:53:16 -0800
Subject: [rabbitmq-discuss] Cleaning up unhandled messages
In-Reply-To: <AANLkTint7dneqXceSBdtFBp4B=Fgt9u=+RUJSSPe-HCz@mail.gmail.com>
References: <AANLkTimbD1nFK+SKzxSv2PDodMA64mhBDeK7EPm1OL11@mail.gmail.com>,
	<AANLkTint7dneqXceSBdtFBp4B=Fgt9u=+RUJSSPe-HCz@mail.gmail.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC35@EXCH-MBX-3.vmware.com>

> I've implemented the following before.
>
> * Consumer gets a message
> * Consumer throws exception
> * Consumer stores md5sum of message in array of "bad messages"
> * Consumer gets the message again
> * Consumer throws exception
> * Consumer checks bad messages array
> * Bad message exists already, ack it, and publish the message to an
errors exchange.
> * Errors exchange has a queue/consumer that logs to disk, sends alerts, etc.

This is a viable sounding scheme, although I wonder...  Would the
semantics of AMQP's basic.reject, as described here:

http://www.rabbitmq.com/blog/2010/08/03/well-ill-let-you-go-basicreject-in-rabbitmq/

...do what you want?

This method allows your consumer to, rather than basic.ack-ing a
message that has been delivered to it, to sort of "anti-ACK" it,
declaring that it can't be processed.  If you basic.reject a method
with the 'requeue' parameter set to false, the message will be
discarded rather than put back into the queue for future redelivery.

As described in the post I link above, there's some modestly
Mephistophelean details in what the AMQP spec says about the
basic.reject method and how it should work, but what RabbitMQ has
chosen to implement aims to be the most straightforward thing that is
actually useful.  Modulo a special circumstance such as you having
multiple consumers on a queue, with only some of them for some reason
unable to cope with the so called "bad message," it seems it should handle
your needs.

Best regards,
Jerry

From matthias at rabbitmq.com  Fri Jan 21 19:02:34 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 21 Jan 2011 19:02:34 +0000
Subject: [rabbitmq-discuss] Cleaning up unhandled messages
In-Reply-To: <F78BCF638F95D74A99D036114107EDB5023948CC35@EXCH-MBX-3.vmware.com>
References: <AANLkTimbD1nFK+SKzxSv2PDodMA64mhBDeK7EPm1OL11@mail.gmail.com>,
	<AANLkTint7dneqXceSBdtFBp4B=Fgt9u=+RUJSSPe-HCz@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC35@EXCH-MBX-3.vmware.com>
Message-ID: <4D39D84A.9060203@rabbitmq.com>

On 21/01/11 18:53, Jerry Kuch wrote:
> This method allows your consumer to, rather than basic.ack-ing a
> message that has been delivered to it, to sort of "anti-ACK" it,
> declaring that it can't be processed.  If you basic.reject a method
> with the 'requeue' parameter set to false, the message will be
> discarded rather than put back into the queue for future redelivery.

The eagle-eyed will spot that basic.reject{requeue=false} does exactly 
the same as basic.ack. The difference is one of declared intent. But 
that difference may become more significant, e.g. we have a feature on 
our todo list to add the ability to for the broker to re-publish 
rejected messages to a configurable "dead-letter" exchange.

Regards,

Matthias.

From matthias at rabbitmq.com  Fri Jan 21 20:02:24 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 21 Jan 2011 20:02:24 +0000
Subject: [rabbitmq-discuss] Java client: channel shutdown notification
 while closing connection
In-Reply-To: <20110111115028.11234me7qyqi7pc0@webmail.active24.cz>
References: <20110111115028.11234me7qyqi7pc0@webmail.active24.cz>
Message-ID: <4D39E650.8000808@rabbitmq.com>

Jiri,

On 11/01/11 10:50, jiri at krutil.com wrote:
> I have a synchronized method registered as a shutdown listener on both
> the channel and the connection.
>
> One of our theads got stuck while trying to close the connection inside
> a method synchronized on the same lock as the shutdown listener.
>
> The thread was executing this code:
>
> private synchronized void closeConnection() throws IOException {
> connection.removeShutdownListener(this);
> if (connection.isOpen())
> connection.close();
> }
> [...]
> Apparently I am doing something wrong, but I'm not sure what is the
> correct way how to do these things.

The shutdown listeners get called in the main connection thread. That 
means they should not perform any possibly blocking AMQP operations. If 
they do then a deadlock can ensue.

> It seems Connection.close() is synchronous. Should I make my shutdown
> listener asynchronous? (not sure how I would do that)

Why are you calling connection.close() at all? The connection will 
already have been closed. After all, you are in the connection shutdown 
handler code.

Regards,

Matthias.

From michael.s.klishin at gmail.com  Fri Jan 21 20:23:40 2011
From: michael.s.klishin at gmail.com (Michael Klishin)
Date: Fri, 21 Jan 2011 23:23:40 +0300
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTiksJZHUYDVq-SAUA0w9sNgRo5F2vWHfYjU9X863@mail.gmail.com>
References: <AANLkTikwJPVV7jMDEeaS=jii-s3A4Lzc0roYsFkkX6rH@mail.gmail.com>
	<AANLkTiksJZHUYDVq-SAUA0w9sNgRo5F2vWHfYjU9X863@mail.gmail.com>
Message-ID: <AANLkTimBg0kz11p1dSWWy+BX5DRtjzWEtUh-kwPFszid@mail.gmail.com>

2011/1/21 Robin Wood <robin at digininja.org>

> which means the default connection settings in php are different to
> the ones in Ruby.
>

You don't have to use default queue parameters. Just specify them
explicitly.
Here are defaults amqp gem uses:

durable = false
nowait  = true
exclusive = false
auto_delete = false

Or you can look up PHP library defaults and make sure Ruby app uses
same parameters set when queue is created.


> Are you able to get the two talking and if so how
> hard is it to get it working in the other direction?
>

Equally easy.

-- 
MK
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/421390cb/attachment.htm>

From matthias at rabbitmq.com  Fri Jan 21 20:37:04 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Fri, 21 Jan 2011 20:37:04 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <AANLkTimBg0kz11p1dSWWy+BX5DRtjzWEtUh-kwPFszid@mail.gmail.com>
References: <AANLkTikwJPVV7jMDEeaS=jii-s3A4Lzc0roYsFkkX6rH@mail.gmail.com>	<AANLkTiksJZHUYDVq-SAUA0w9sNgRo5F2vWHfYjU9X863@mail.gmail.com>
	<AANLkTimBg0kz11p1dSWWy+BX5DRtjzWEtUh-kwPFszid@mail.gmail.com>
Message-ID: <4D39EE70.8030104@rabbitmq.com>

On 21/01/11 20:23, Michael Klishin wrote:
> You don't have to use default queue parameters. Just specify them
> explicitly.
> Here are defaults amqp gem uses:
>
> durable = false
> nowait  = true
> exclusive = false
> auto_delete = false

As an aside, no-wait is *not* a queue parameter. It is a general 
modifier present in most AMQP commands. See 
http://www.rabbitmq.com/amqp-0-9-1-reference.html#domain.no-wait


Matthias.

From jeffh at delasco.com  Fri Jan 21 22:59:28 2011
From: jeffh at delasco.com (Jeff Hinrichs)
Date: Fri, 21 Jan 2011 16:59:28 -0600
Subject: [rabbitmq-discuss] failure on startup
In-Reply-To: <AANLkTik5Ng7926RmYMapDYB9VqoJ+WvAFyDGh1ejkBGY@mail.gmail.com>
References: <AANLkTimTAHZ96bc+=6iY6aa+c=RW+Hi=0UV69W7nt5Tb@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC1F@EXCH-MBX-3.vmware.com>
	<AANLkTinpe4wCpc=MmmfX8NeaXnCR1z7X6CN9Lqbm2Jxn@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC27@EXCH-MBX-3.vmware.com>
	<AANLkTik5Ng7926RmYMapDYB9VqoJ+WvAFyDGh1ejkBGY@mail.gmail.com>
Message-ID: <AANLkTikhT3tztNzSNLd1ScE2dpZiPSj1g4TCdWzX9MCf@mail.gmail.com>

Problem resolution:

My ports were not current, I had erlang-lite-r14b01,1 installed  but after
updating my ports,  erlang-lite-r14b01_1,1 was current.
So the moral of the story for FreeBSD in a jail users, make sure you
have erlang-lite-r14b01_1,1
or greater installed.

So the problem is now solved and I am reporting success for rabbitmq-2.2.0
on a FreeBSD 8.x jail.

Thanks for the help.

Best,

-Jeff

p.s. this revision patches epmd, so that it recognizes a host whose IP
address is the same as the epmd's as a local client.

On Fri, Jan 21, 2011 at 8:01 AM, Jeff Hinrichs <jeffh at delasco.com> wrote:

> On Thu, Jan 20, 2011 at 12:56 PM, Jerry Kuch <jerryk at vmware.com> wrote:
>
>> > ps -ax reveals that epmd is in fact running.  I googled even harder
>> > after mailing the list and have also seen that it appears to be
>> > related to erlang (epmd specifically) for the exact problem you are
>> > talking about.
>> >
>> > I killed epmd and started it up in debugging mode
>> > (epmd -d -d -d) and then issued the requested command line, erl
>> > -name bogusnode
>> >
>> > the command line reported the following:
>> > [jlh at hydra ~]$ erl -name bogusnode
>> > {error_logger,{{2011,1,19},{22,46,41}},"Protocol: ~p: register
>> > error:
>> >
>> ~p~n",["inet_tcp",{{badmatch,{error,epmd_close}},[{inet_tcp_dist,listen,1},{net_kernel,start_protos,4},{net_kernel,start_protos,3},{net_kernel,init_node,2},{net_kernel,init,1},{gen_server,init_it,6},{proc_lib,init_p_do_apply,3}]}]}
>> > Crash dump was written to: erl_crash.dump Kernel pid terminated
>> > (application_controller)
>> >
>> ({application_start_failure,kernel,{shutdown,{kernel,start,[normal,[]]}}})
>> >
>> > Which is the same type of error, badmatch,{error,epmd_close} as when
>> > I try to start RabbitMQ
>> >
>> > I'll start following up on the erlang
>> > forums, I'd rather not start off using an old version of erlang.
>> >
>> > Thank you so much for getting me pointed in the proper direction!
>>
>> Hi, Jeff...
>>
>> Glad it helped get you make some headway, and sorry you've had trouble.
>>
>> BTW, if you wouldn't mind copying this list with your results, whether
>> from applying the aforementioned patch to a built-from-source Erlang
>> of your own, or upgrading to a specific newer one that already
>> incorporates it (if such a thing currently exists---I'm not sure it
>> does yet), that would be great.  That way there's a Google-able record
>> of the problem and a solution for other folks who may encounter it to
>> come across...
>>
>> Best regards,
>> Jerry
>>
> I emailed the maintainer for the FreeBSD port but haven't heard back from
> them as yet.  For now, I've implemented the work around @
> http://erlang.2086793.n4.nabble.com/crash-dump-at-ejabberd-startup-td3044533.html ..
>  However, I wouldn't call this a "patch" as the current FreeBSD port is
> suppose to recognize a connection from an ip that matches the local ip, as
> being a true "Local".
>
> I'll follow up on this post when I hear back from the official port
> maintainer.
>
> Best,
>
> Jeff
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/a9c72293/attachment.htm>

From dtenenba at fhcrc.org  Sat Jan 22 00:06:23 2011
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Fri, 21 Jan 2011 16:06:23 -0800
Subject: [rabbitmq-discuss] pika and node.amqp interop
Message-ID: <AANLkTikocGWJG1hSA4VsfgDP=9wKOJwd9V3MmFkN4QL1@mail.gmail.com>

Hi,

I am new to rabbitmq. I got the python "getting started" examples to work
just fine.
I would like to be able to send messages between node.js (using node.amqp)
and python/pika.

I can successfully receive a message in node.js using this code:

[receiver - node.js]
var sys = require('sys');
var amqp = require('./amqp');

var connection = amqp.createConnection({ host: 'localhost' });

// Wait for connection to become established.
connection.addListener('ready', function () {
  // Create a queue and bind to all messages.
  // Use the default 'amq.topic' exchange

  var q = connection.queue('my-queue');
  // Catch all messages
  q.bind('#');


  // Receive messages
  q.subscribe(function (message) {
    // Print messages to stdout
    sys.puts(sys.inspect(message));
  });
});

[sender - python/pika]
#!/usr/bin/env python
import pika

connection = pika.AsyncoreConnection(pika.ConnectionParameters(
        host='localhost'))
channel = connection.channel()


channel.basic_publish(exchange='',
                      routing_key='my-queue',
                      body='Hello World!')
print " [x] Sent 'Hello World!'"
connection.close()

But I can't go the other way. I'm not sure that the message sent by node.js
is going anywhere. I've looked at the unit tests for node.amqp (they all
pass) but there is something I am missing, probably to do with exchanges or
something. I'd like to do something like this:

[sender - node.js]
var sys = require('sys');
var amqp = require('./amqp');

var connection = amqp.createConnection({ host: 'localhost' });

// Wait for connection to become established.
connection.addListener('ready', function () {
  // Create a queue and bind to all messages.
  // Use the default 'amq.topic' exchange
  connection.publish("my-queue", {random_key:"this is my message"});
  connection.end();

});

[receiver - python/pika]
#!/usr/bin/env python
import pika
import sys

connection = pika.AsyncoreConnection(pika.ConnectionParameters(
        host='localhost'))
channel = connection.channel()

print ' [*] Waiting for messages. To exit press CTRL+C'

def callback(ch, method, properties, body):
    print body,
    sys.stdout.flush()

channel.basic_consume(callback,
                      queue='my-queue',
                      no_ack=True)

pika.asyncore_loop()

But nothing happens.

Another thing (possibly related?) that I run into is if I create a queue in
python using, e.g.:

channel.queue_declare(queue='hello')

Then, in node.js, when I do:

  var q = connection.queue('hello');

I get this:

Unhandled channel error: PRECONDITION_FAILED - parameters for queue 'hello'
in vhost '/' not equivalent

events:12
        throw arguments[1];
                       ^
Error: PRECONDITION_FAILED - parameters for queue 'hello' in vhost '/' not
equivalent
    at Queue._onMethod
(/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:1390:15)
    at Connection._onMethod
(/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:784:28)
    at AMQPParser.onMethod
(/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:698:12)
    at AMQPParser._parseMethodFrame
(/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:415:10)
    at AMQPParser.execute
(/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:196:20)
    at Connection.<anonymous>
(/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:731:12)
    at Connection.emit (events:31:17)
    at IOWatcher.callback (net:489:16)
    at node.js:773:9

It appears that python's idea of a 'hello' queue is different from that of
node.amqp's. How can I do this so that I don't receive this error?
Hope this is the right place for this question. If not please tell me where
I should post it.
Thanks
Dan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/33d06889/attachment-0001.htm>

From lgreg.meredith at gmail.com  Sat Jan 22 01:45:31 2011
From: lgreg.meredith at gmail.com (Meredith Gregory)
Date: Fri, 21 Jan 2011 17:45:31 -0800
Subject: [rabbitmq-discuss] Missing erlang functions?
Message-ID: <AANLkTin6hHAL0W-PEv3=abrSyeKoQ_RYbZ7TYqyBjJvQ@mail.gmail.com>

Dear Rabbitters,

Out of the blue my rabbitmq installation has started complaining about
missing erlang functions. i tried updating both the erlang and the rabbit
installations. i'm still getting the same complaint. i suspect this has
something to do with RabbitMQ now throwing an exception in a code stack that
was working. Any clues?

Best wishes,

--greg

bash-3.2$ sudo rabbitmq-server
Activating RabbitMQ plugins ...
*WARNING* Undefined function crypto:des3_cbc_decrypt/5
*WARNING* Undefined function crypto:start/0
*WARNING* Undefined function ssl:close/1
*WARNING* Undefined function ssl:controlling_process/2
*WARNING* Undefined function ssl:peercert/1
*WARNING* Undefined function ssl:peername/1
*WARNING* Undefined function ssl:recv/3
*WARNING* Undefined function ssl:send/2
*WARNING* Undefined function ssl:sockname/1
*WARNING* Undefined function ssl:ssl_accept/3
0 plugins activated:


+---+   +---+
|   |   |   |
|   |   |   |
|   |   |   |
|   +---+   +-------+
|                   |
| RabbitMQ  +---+   |
|           |   |   |
|   v2.2.0  +---+   |
|                   |
+-------------------+
AMQP 0-9-1 / 0-9 / 0-8
Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies LLC.,
and Rabbit Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

node           : rabbit at BiosimiMac1-2
app descriptor :
/Users/lgm/work/src/devtools/rabbit/rabbitmq_server-2.2.0/sbin/../ebin/rabbit.app
home dir       : /Users/lgm
cookie hash    : 7vyF5kbCgbq9jjMP2sUa3w==
log            : /var/log/rabbitmq/rabbit at BiosimiMac1-2.log
sasl log       : /var/log/rabbitmq/rabbit at BiosimiMac1-2-sasl.log
database dir   : /var/lib/rabbitmq/mnesia/rabbit at BiosimiMac1-2
erlang version : 5.8.2

starting file handle cache server
...done
starting worker pool
 ...done
starting database
...done
starting codec correctness check
 ...done
-- external infrastructure ready
starting statistics event manager
...done
starting logging server
...done
starting exchange type registry
...done
starting exchange type direct
...done
starting exchange type fanout
...done
starting exchange type headers
 ...done
starting exchange type topic
 ...done
-- kernel ready
starting alarm handler
 ...done
starting node monitor
...done
starting cluster delegate
...done
starting guid generator
...done
starting memory monitor
...done
-- core initialized
starting empty DB check
...done
starting exchange recovery
 ...done
starting queue supervisor and queue recovery
 ...done
-- message delivery logic ready
starting error log relay
 ...done
starting networking
...done
-- network listeners available

broker running


-- 
L.G. Meredith
Managing Partner
Biosimilarity LLC
7329 39th Ave SW
Seattle, WA 98136

+1 206.650.3740

http://biosimilarity.blogspot.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/7165fb5d/attachment.htm>

From jerryk at vmware.com  Sat Jan 22 01:51:01 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Fri, 21 Jan 2011 17:51:01 -0800
Subject: [rabbitmq-discuss] Missing erlang functions?
In-Reply-To: <AANLkTin6hHAL0W-PEv3=abrSyeKoQ_RYbZ7TYqyBjJvQ@mail.gmail.com>
References: <AANLkTin6hHAL0W-PEv3=abrSyeKoQ_RYbZ7TYqyBjJvQ@mail.gmail.com>
Message-ID: <88C3727C-AACA-4121-B2CC-E36467BD8D9A@vmware.com>

Hi, Greg...  Did you install using Darwin ports on a Mac by any chance?  You'll want to use the '+ssl' port variant if so...

Jerry

On Jan 21, 2011, at 5:45 PM, Meredith Gregory wrote:

> Dear Rabbitters,
> 
> Out of the blue my rabbitmq installation has started complaining about missing erlang functions. i tried updating both the erlang and the rabbit installations. i'm still getting the same complaint. i suspect this has something to do with RabbitMQ now throwing an exception in a code stack that was working. Any clues?
> 
> Best wishes,
> 
> --greg
> 
> bash-3.2$ sudo rabbitmq-server
> Activating RabbitMQ plugins ...
> *WARNING* Undefined function crypto:des3_cbc_decrypt/5
> *WARNING* Undefined function crypto:start/0
> *WARNING* Undefined function ssl:close/1
> *WARNING* Undefined function ssl:controlling_process/2
> *WARNING* Undefined function ssl:peercert/1
> *WARNING* Undefined function ssl:peername/1
> *WARNING* Undefined function ssl:recv/3
> *WARNING* Undefined function ssl:send/2
> *WARNING* Undefined function ssl:sockname/1
> *WARNING* Undefined function ssl:ssl_accept/3
> 0 plugins activated:
> 
> 
> +---+   +---+
> |   |   |   |
> |   |   |   |
> |   |   |   |
> |   +---+   +-------+
> |                   |
> | RabbitMQ  +---+   |
> |           |   |   |
> |   v2.2.0  +---+   |
> |                   |
> +-------------------+
> AMQP 0-9-1 / 0-9 / 0-8
> Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies LLC., and Rabbit Technologies Ltd.
> Licensed under the MPL.  See http://www.rabbitmq.com/
> 
> node           : rabbit at BiosimiMac1-2
> app descriptor : /Users/lgm/work/src/devtools/rabbit/rabbitmq_server-2.2.0/sbin/../ebin/rabbit.app
> home dir       : /Users/lgm
> cookie hash    : 7vyF5kbCgbq9jjMP2sUa3w==
> log            : /var/log/rabbitmq/rabbit at BiosimiMac1-2.log
> sasl log       : /var/log/rabbitmq/rabbit at BiosimiMac1-2-sasl.log
> database dir   : /var/lib/rabbitmq/mnesia/rabbit at BiosimiMac1-2
> erlang version : 5.8.2
> 
> starting file handle cache server                                     ...done
> starting worker pool                                                  ...done
> starting database                                                     ...done
> starting codec correctness check                                      ...done
> -- external infrastructure ready
> starting statistics event manager                                     ...done
> starting logging server                                               ...done
> starting exchange type registry                                       ...done
> starting exchange type direct                                         ...done
> starting exchange type fanout                                         ...done
> starting exchange type headers                                        ...done
> starting exchange type topic                                          ...done
> -- kernel ready
> starting alarm handler                                                ...done
> starting node monitor                                                 ...done
> starting cluster delegate                                             ...done
> starting guid generator                                               ...done
> starting memory monitor                                               ...done
> -- core initialized
> starting empty DB check                                               ...done
> starting exchange recovery                                            ...done
> starting queue supervisor and queue recovery                          ...done
> -- message delivery logic ready
> starting error log relay                                              ...done
> starting networking                                                   ...done
> -- network listeners available
> 
> broker running
> 
> 
> -- 
> L.G. Meredith
> Managing Partner
> Biosimilarity LLC
> 7329 39th Ave SW
> Seattle, WA 98136
> 
> +1 206.650.3740
> 
> http://biosimilarity.blogspot.com
> 
> <ATT00001..txt>


From lgreg.meredith at gmail.com  Sat Jan 22 01:55:54 2011
From: lgreg.meredith at gmail.com (Meredith Gregory)
Date: Fri, 21 Jan 2011 17:55:54 -0800
Subject: [rabbitmq-discuss] Missing erlang functions?
In-Reply-To: <88C3727C-AACA-4121-B2CC-E36467BD8D9A@vmware.com>
References: <AANLkTin6hHAL0W-PEv3=abrSyeKoQ_RYbZ7TYqyBjJvQ@mail.gmail.com>
	<88C3727C-AACA-4121-B2CC-E36467BD8D9A@vmware.com>
Message-ID: <AANLkTimGLEks-V24ZZTNCSuHcGRFQivrpUc3UjdPiTys@mail.gmail.com>

Dear Jerry,

Is the port now called something else?

bash-3.2$ sudo port variants rabbitmq-server
Password:
rabbitmq-server has no variants
bash-3.2$

Best wishes,

--greg

On Fri, Jan 21, 2011 at 5:51 PM, Jerry Kuch <jerryk at vmware.com> wrote:

> Hi, Greg...  Did you install using Darwin ports on a Mac by any chance?
>  You'll want to use the '+ssl' port variant if so...
>
> Jerry
>
> On Jan 21, 2011, at 5:45 PM, Meredith Gregory wrote:
>
> > Dear Rabbitters,
> >
> > Out of the blue my rabbitmq installation has started complaining about
> missing erlang functions. i tried updating both the erlang and the rabbit
> installations. i'm still getting the same complaint. i suspect this has
> something to do with RabbitMQ now throwing an exception in a code stack that
> was working. Any clues?
> >
> > Best wishes,
> >
> > --greg
> >
> > bash-3.2$ sudo rabbitmq-server
> > Activating RabbitMQ plugins ...
> > *WARNING* Undefined function crypto:des3_cbc_decrypt/5
> > *WARNING* Undefined function crypto:start/0
> > *WARNING* Undefined function ssl:close/1
> > *WARNING* Undefined function ssl:controlling_process/2
> > *WARNING* Undefined function ssl:peercert/1
> > *WARNING* Undefined function ssl:peername/1
> > *WARNING* Undefined function ssl:recv/3
> > *WARNING* Undefined function ssl:send/2
> > *WARNING* Undefined function ssl:sockname/1
> > *WARNING* Undefined function ssl:ssl_accept/3
> > 0 plugins activated:
> >
> >
> > +---+   +---+
> > |   |   |   |
> > |   |   |   |
> > |   |   |   |
> > |   +---+   +-------+
> > |                   |
> > | RabbitMQ  +---+   |
> > |           |   |   |
> > |   v2.2.0  +---+   |
> > |                   |
> > +-------------------+
> > AMQP 0-9-1 / 0-9 / 0-8
> > Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies
> LLC., and Rabbit Technologies Ltd.
> > Licensed under the MPL.  See http://www.rabbitmq.com/
> >
> > node           : rabbit at BiosimiMac1-2
> > app descriptor :
> /Users/lgm/work/src/devtools/rabbit/rabbitmq_server-2.2.0/sbin/../ebin/rabbit.app
> > home dir       : /Users/lgm
> > cookie hash    : 7vyF5kbCgbq9jjMP2sUa3w==
> > log            : /var/log/rabbitmq/rabbit at BiosimiMac1-2.log
> > sasl log       : /var/log/rabbitmq/rabbit at BiosimiMac1-2-sasl.log
> > database dir   : /var/lib/rabbitmq/mnesia/rabbit at BiosimiMac1-2
> > erlang version : 5.8.2
> >
> > starting file handle cache server
> ...done
> > starting worker pool
>  ...done
> > starting database
> ...done
> > starting codec correctness check
>  ...done
> > -- external infrastructure ready
> > starting statistics event manager
> ...done
> > starting logging server
> ...done
> > starting exchange type registry
> ...done
> > starting exchange type direct
> ...done
> > starting exchange type fanout
> ...done
> > starting exchange type headers
>  ...done
> > starting exchange type topic
>  ...done
> > -- kernel ready
> > starting alarm handler
>  ...done
> > starting node monitor
> ...done
> > starting cluster delegate
> ...done
> > starting guid generator
> ...done
> > starting memory monitor
> ...done
> > -- core initialized
> > starting empty DB check
> ...done
> > starting exchange recovery
>  ...done
> > starting queue supervisor and queue recovery
>  ...done
> > -- message delivery logic ready
> > starting error log relay
>  ...done
> > starting networking
> ...done
> > -- network listeners available
> >
> > broker running
> >
> >
> > --
> > L.G. Meredith
> > Managing Partner
> > Biosimilarity LLC
> > 7329 39th Ave SW
> > Seattle, WA 98136
> >
> > +1 206.650.3740
> >
> > http://biosimilarity.blogspot.com
> >
> > <ATT00001..txt>
>
>


-- 
L.G. Meredith
Managing Partner
Biosimilarity LLC
7329 39th Ave SW
Seattle, WA 98136

+1 206.650.3740

http://biosimilarity.blogspot.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/3a753b4a/attachment-0001.htm>

From lgreg.meredith at gmail.com  Sat Jan 22 02:34:32 2011
From: lgreg.meredith at gmail.com (Meredith Gregory)
Date: Fri, 21 Jan 2011 18:34:32 -0800
Subject: [rabbitmq-discuss] Missing erlang functions?
In-Reply-To: <AANLkTimGLEks-V24ZZTNCSuHcGRFQivrpUc3UjdPiTys@mail.gmail.com>
References: <AANLkTin6hHAL0W-PEv3=abrSyeKoQ_RYbZ7TYqyBjJvQ@mail.gmail.com>
	<88C3727C-AACA-4121-B2CC-E36467BD8D9A@vmware.com>
	<AANLkTimGLEks-V24ZZTNCSuHcGRFQivrpUc3UjdPiTys@mail.gmail.com>
Message-ID: <AANLkTik++JPKzp96xUgChx63A0RqDYgvYwnB+Uk6VQ0i@mail.gmail.com>

Dear Jerry,

Thanks for the tip -- i see i was being dense before and you were referring
to the erlang port.

Best wishes,

--greg

On Fri, Jan 21, 2011 at 5:55 PM, Meredith Gregory
<lgreg.meredith at gmail.com>wrote:

> Dear Jerry,
>
> Is the port now called something else?
>
> bash-3.2$ sudo port variants rabbitmq-server
> Password:
> rabbitmq-server has no variants
> bash-3.2$
>
> Best wishes,
>
> --greg
>
>
> On Fri, Jan 21, 2011 at 5:51 PM, Jerry Kuch <jerryk at vmware.com> wrote:
>
>> Hi, Greg...  Did you install using Darwin ports on a Mac by any chance?
>>  You'll want to use the '+ssl' port variant if so...
>>
>> Jerry
>>
>> On Jan 21, 2011, at 5:45 PM, Meredith Gregory wrote:
>>
>> > Dear Rabbitters,
>> >
>> > Out of the blue my rabbitmq installation has started complaining about
>> missing erlang functions. i tried updating both the erlang and the rabbit
>> installations. i'm still getting the same complaint. i suspect this has
>> something to do with RabbitMQ now throwing an exception in a code stack that
>> was working. Any clues?
>> >
>> > Best wishes,
>> >
>> > --greg
>> >
>> > bash-3.2$ sudo rabbitmq-server
>> > Activating RabbitMQ plugins ...
>> > *WARNING* Undefined function crypto:des3_cbc_decrypt/5
>> > *WARNING* Undefined function crypto:start/0
>> > *WARNING* Undefined function ssl:close/1
>> > *WARNING* Undefined function ssl:controlling_process/2
>> > *WARNING* Undefined function ssl:peercert/1
>> > *WARNING* Undefined function ssl:peername/1
>> > *WARNING* Undefined function ssl:recv/3
>> > *WARNING* Undefined function ssl:send/2
>> > *WARNING* Undefined function ssl:sockname/1
>> > *WARNING* Undefined function ssl:ssl_accept/3
>> > 0 plugins activated:
>> >
>> >
>> > +---+   +---+
>> > |   |   |   |
>> > |   |   |   |
>> > |   |   |   |
>> > |   +---+   +-------+
>> > |                   |
>> > | RabbitMQ  +---+   |
>> > |           |   |   |
>> > |   v2.2.0  +---+   |
>> > |                   |
>> > +-------------------+
>> > AMQP 0-9-1 / 0-9 / 0-8
>> > Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies
>> LLC., and Rabbit Technologies Ltd.
>> > Licensed under the MPL.  See http://www.rabbitmq.com/
>> >
>> > node           : rabbit at BiosimiMac1-2
>> > app descriptor :
>> /Users/lgm/work/src/devtools/rabbit/rabbitmq_server-2.2.0/sbin/../ebin/rabbit.app
>> > home dir       : /Users/lgm
>> > cookie hash    : 7vyF5kbCgbq9jjMP2sUa3w==
>> > log            : /var/log/rabbitmq/rabbit at BiosimiMac1-2.log
>> > sasl log       : /var/log/rabbitmq/rabbit at BiosimiMac1-2-sasl.log
>> > database dir   : /var/lib/rabbitmq/mnesia/rabbit at BiosimiMac1-2
>> > erlang version : 5.8.2
>> >
>> > starting file handle cache server
>> ...done
>> > starting worker pool
>>  ...done
>> > starting database
>> ...done
>> > starting codec correctness check
>>  ...done
>> > -- external infrastructure ready
>> > starting statistics event manager
>> ...done
>> > starting logging server
>> ...done
>> > starting exchange type registry
>> ...done
>> > starting exchange type direct
>> ...done
>> > starting exchange type fanout
>> ...done
>> > starting exchange type headers
>>  ...done
>> > starting exchange type topic
>>  ...done
>> > -- kernel ready
>> > starting alarm handler
>>  ...done
>> > starting node monitor
>> ...done
>> > starting cluster delegate
>> ...done
>> > starting guid generator
>> ...done
>> > starting memory monitor
>> ...done
>> > -- core initialized
>> > starting empty DB check
>> ...done
>> > starting exchange recovery
>>  ...done
>> > starting queue supervisor and queue recovery
>>  ...done
>> > -- message delivery logic ready
>> > starting error log relay
>>  ...done
>> > starting networking
>> ...done
>> > -- network listeners available
>> >
>> > broker running
>> >
>> >
>> > --
>> > L.G. Meredith
>> > Managing Partner
>> > Biosimilarity LLC
>> > 7329 39th Ave SW
>> > Seattle, WA 98136
>> >
>> > +1 206.650.3740
>> >
>> > http://biosimilarity.blogspot.com
>> >
>> > <ATT00001..txt>
>>
>>
>
>
> --
> L.G. Meredith
> Managing Partner
> Biosimilarity LLC
> 7329 39th Ave SW
> Seattle, WA 98136
>
> +1 206.650.3740
>
> http://biosimilarity.blogspot.com
>
>


-- 
L.G. Meredith
Managing Partner
Biosimilarity LLC
7329 39th Ave SW
Seattle, WA 98136

+1 206.650.3740

http://biosimilarity.blogspot.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110121/8e776059/attachment.htm>

From mikeb at rabbitmq.com  Sat Jan 22 10:46:48 2011
From: mikeb at rabbitmq.com (Michael Bridgen)
Date: Sat, 22 Jan 2011 10:46:48 +0000
Subject: [rabbitmq-discuss] pika and node.amqp interop
In-Reply-To: <AANLkTikocGWJG1hSA4VsfgDP=9wKOJwd9V3MmFkN4QL1@mail.gmail.com>
References: <AANLkTikocGWJG1hSA4VsfgDP=9wKOJwd9V3MmFkN4QL1@mail.gmail.com>
Message-ID: <4D3AB598.5030200@rabbitmq.com>

Hi Dan,

> I am new to rabbitmq. I got the python "getting started" examples to
> work just fine.
> I would like to be able to send messages between node.js (using
> node.amqp) and python/pika.
 >
> I can successfully receive a message in node.js using this code:
>
> [receiver - node.js]
> var sys = require('sys');
> var amqp = require('./amqp');
>
> var connection = amqp.createConnection({ host: 'localhost' });
>
> // Wait for connection to become established.
> connection.addListener('ready', function () {
>    // Create a queue and bind to all messages.
>    // Use the default 'amq.topic' exchange
>
>    var q = connection.queue('my-queue');
>    // Catch all messages
>    q.bind('#');
>
>    // Receive messages
>    q.subscribe(function (message) {
>      // Print messages to stdout
>      sys.puts(sys.inspect(message));
>    });
> });
>
> [sender - python/pika]
> #!/usr/bin/env python
> import pika
>
> connection = pika.AsyncoreConnection(pika.ConnectionParameters(
>          host='localhost'))
> channel = connection.channel()
>
>
> channel.basic_publish(exchange='',
>                        routing_key='my-queue',
>                        body='Hello World!')
> print " [x] Sent 'Hello World!'"
> connection.close()

You should be aware that node-amqp, at least Ryan's original and most 
forks of it, make some unorthodox choices for parameter defaults and 
behaviour, which to be fair are probably inherited from the EventMachine 
AMQP client.

In particular, the exchange that's published or bound to, if none is 
given, is "amq.topic".  This is directly at odds with AMQP, for which an 
empty exchange name means the "default exchange" defined in the 
specification; that is, route directly to the queue named in the routing 
key.

So your example above is working by coincidence -- you don't need to 
bind the queue in the node.js code, since your Python code is 
effectively sending straight to the queue.  I.e., the node.js code sets up

(amq.topic) --"#"--> [ | | my-queue | | ]

but the message sent in the Python code actually follows

(default) --"my-queue"--> [ | | my-queue | | ]

> But I can't go the other way. I'm not sure that the message sent by
> node.js is going anywhere. I've looked at the unit tests for node.amqp
> (they all pass) but there is something I am missing, probably to do with
> exchanges or something. I'd like to do something like this:
>
> [sender - node.js]
> var sys = require('sys');
> var amqp = require('./amqp');
>
> var connection = amqp.createConnection({ host: 'localhost' });
>
> // Wait for connection to become established.
> connection.addListener('ready', function () {
>    // Create a queue and bind to all messages.
>    // Use the default 'amq.topic' exchange
>    connection.publish("my-queue", {random_key:"this is my message"});
>    connection.end();
> });
>
> [receiver - python/pika]
> #!/usr/bin/env python
> import pika
> import sys
>
> connection = pika.AsyncoreConnection(pika.ConnectionParameters(
>          host='localhost'))
> channel = connection.channel()
>
> print ' [*] Waiting for messages. To exit press CTRL+C'
>
> def callback(ch, method, properties, body):
>      print body,
>      sys.stdout.flush()
> channel.basic_consume(callback,
>                        queue='my-queue',
>                        no_ack=True)
>
> pika.asyncore_loop()

This way around (presuming there's a restart in-between runs), node.js 
sends to amq.topic, but nothing is bound there, so the message is discarded.

You might try binding the queue, in the Python, to the exchange 
"amq.topic".  You should probably also declare it.

If you actually don't want to use "amq.topic", and you probably don't if 
you can help it, you might declare your own exchange and use that.

I'm not sure there's a way to send to the default exchange in node-amqp. 
  I fixed this, and some other things, in my fork, but it's a bit behind 
the curve at the minute.
http://github.com/squaremo/node-amqp

> But nothing happens.
>
> Another thing (possibly related?) that I run into is if I create a queue
> in python using, e.g.:
>
> channel.queue_declare(queue='hello')
>
> Then, in node.js, when I do:
>
>    var q = connection.queue('hello');
>
> I get this:
>
> Unhandled channel error: PRECONDITION_FAILED - parameters for queue
> 'hello' in vhost '/' not equivalent
>
> events:12
>          throw arguments[1];
>                         ^
> Error: PRECONDITION_FAILED - parameters for queue 'hello' in vhost '/'
> not equivalent
>      at Queue._onMethod
> (/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:1390:15)
>      at Connection._onMethod
> (/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:784:28)
>      at AMQPParser.onMethod
> (/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:698:12)
>      at AMQPParser._parseMethodFrame
> (/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:415:10)
>      at AMQPParser.execute
> (/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:196:20)
>      at Connection.<anonymous>
> (/Users/dtenenba/dev/dev-amqp/node-amqp/amqp.js:731:12)
>      at Connection.emit (events:31:17)
>      at IOWatcher.callback (net:489:16)
>      at node.js:773:9
>
> It appears that python's idea of a 'hello' queue is different from that
> of node.amqp's. How can I do this so that I don't receive this error?

You can provide explicit values for the other parameters; that is (with 
parameter names from memory ..),

[node.js]
var q = connection.queue("hello",
           { autoDelete: true, durable: false, exclusive: false });

[Python]
q = channel.queue_declare(queue='hello',
                           auto_delete=true,
                           durable=false,
                           exclusive=false)


I suspect the libraries differ only in the default value for 
auto-delete, so supplying that may be enough.

> Hope this is the right place for this question. If not please tell me
> where I should post it.

This is a good place.

Regards,
Michael

From dtenenba at fhcrc.org  Sat Jan 22 20:56:04 2011
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Sat, 22 Jan 2011 12:56:04 -0800
Subject: [rabbitmq-discuss] pika and node.amqp interop
In-Reply-To: <5393_1295693253_4D3AB5C5_5393_489464_1_4D3AB598.5030200@rabbitmq.com>
References: <AANLkTikocGWJG1hSA4VsfgDP=9wKOJwd9V3MmFkN4QL1@mail.gmail.com>
	<5393_1295693253_4D3AB5C5_5393_489464_1_4D3AB598.5030200@rabbitmq.com>
Message-ID: <AANLkTimQyPwzT5pat43eqMV5axHrPcWtz1ss6HzB0C9o@mail.gmail.com>

On Sat, Jan 22, 2011 at 2:46 AM, Michael Bridgen <mikeb at rabbitmq.com> wrote:

> Hi Dan,
>
>
>  I am new to rabbitmq. I got the python "getting started" examples to
>> work just fine.
>> I would like to be able to send messages between node.js (using
>> node.amqp) and python/pika.
>>
> >
>
>> I can successfully receive a message in node.js using this code:
>>
>> [receiver - node.js]
>> var sys = require('sys');
>> var amqp = require('./amqp');
>>
>> var connection = amqp.createConnection({ host: 'localhost' });
>>
>> // Wait for connection to become established.
>> connection.addListener('ready', function () {
>>   // Create a queue and bind to all messages.
>>   // Use the default 'amq.topic' exchange
>>
>>   var q = connection.queue('my-queue');
>>   // Catch all messages
>>   q.bind('#');
>>
>>   // Receive messages
>>   q.subscribe(function (message) {
>>     // Print messages to stdout
>>     sys.puts(sys.inspect(message));
>>   });
>> });
>>
>> [sender - python/pika]
>> #!/usr/bin/env python
>> import pika
>>
>> connection = pika.AsyncoreConnection(pika.ConnectionParameters(
>>         host='localhost'))
>> channel = connection.channel()
>>
>>
>> channel.basic_publish(exchange='',
>>                       routing_key='my-queue',
>>                       body='Hello World!')
>> print " [x] Sent 'Hello World!'"
>> connection.close()
>>
>
> You should be aware that node-amqp, at least Ryan's original and most forks
> of it, make some unorthodox choices for parameter defaults and behaviour,
> which to be fair are probably inherited from the EventMachine AMQP client.
>
> In particular, the exchange that's published or bound to, if none is given,
> is "amq.topic".  This is directly at odds with AMQP, for which an empty
> exchange name means the "default exchange" defined in the specification;
> that is, route directly to the queue named in the routing key.
>
> So your example above is working by coincidence -- you don't need to bind
> the queue in the node.js code, since your Python code is effectively sending
> straight to the queue.  I.e., the node.js code sets up
>
> (amq.topic) --"#"--> [ | | my-queue | | ]
>
> but the message sent in the Python code actually follows
>
> (default) --"my-queue"--> [ | | my-queue | | ]
>
>
>  But I can't go the other way. I'm not sure that the message sent by
>> node.js is going anywhere. I've looked at the unit tests for node.amqp
>> (they all pass) but there is something I am missing, probably to do with
>> exchanges or something. I'd like to do something like this:
>>
>> [sender - node.js]
>> var sys = require('sys');
>> var amqp = require('./amqp');
>>
>> var connection = amqp.createConnection({ host: 'localhost' });
>>
>> // Wait for connection to become established.
>> connection.addListener('ready', function () {
>>   // Create a queue and bind to all messages.
>>   // Use the default 'amq.topic' exchange
>>   connection.publish("my-queue", {random_key:"this is my message"});
>>   connection.end();
>> });
>>
>> [receiver - python/pika]
>> #!/usr/bin/env python
>> import pika
>> import sys
>>
>> connection = pika.AsyncoreConnection(pika.ConnectionParameters(
>>         host='localhost'))
>> channel = connection.channel()
>>
>> print ' [*] Waiting for messages. To exit press CTRL+C'
>>
>> def callback(ch, method, properties, body):
>>     print body,
>>     sys.stdout.flush()
>> channel.basic_consume(callback,
>>                       queue='my-queue',
>>                       no_ack=True)
>>
>> pika.asyncore_loop()
>>
>
> This way around (presuming there's a restart in-between runs), node.js
> sends to amq.topic, but nothing is bound there, so the message is discarded.
>
> You might try binding the queue, in the Python, to the exchange
> "amq.topic".  You should probably also declare it.
>
> If you actually don't want to use "amq.topic", and you probably don't if
> you can help it, you might declare your own exchange and use that.
>
>
OK, I am trying this approach, with the following sender:


var sys = require('sys');
var amqp = require('./amqp');

var connection = amqp.createConnection({ host: 'localhost' });

// Wait for connection to become established.
connection.addListener('ready', function () {
  // Create a queue and bind to all messages.
  // Use the default 'amq.topic' exchange
  var exchange = connection.exchange("my-exchange");
  exchange.publish("my-queue", {random_key:"this is my message"});
  connection.end();

});

and receiver:

#!/usr/bin/env python
import pika
import sys


connection = pika.AsyncoreConnection(pika.ConnectionParameters(
        host='localhost'))
channel = connection.channel()
result = channel.queue_declare('my-queue')
channel.exchange_declare(exchange='my-exchange')
channel.queue_bind(exchange='my-exchange', queue=result.queue)


print ' [*] Waiting for messages. To exit press CTRL+C'

def callback(ch, method, properties, body):
    print body,
    sys.stdout.flush()

channel.basic_consume(callback,
                      queue='my-queue',
                      no_ack=True)

pika.asyncore_loop()

When I run the receiver, I get:

% python receiver.py
Traceback (most recent call last):
  File "receiver.py", line 9, in <module>
    result = channel.queue_declare('my-queue')
  File "build/bdist.macosx-10.6-universal/egg/pika/spec.py", line 3003, in
queue_declare
  File "build/bdist.macosx-10.6-universal/egg/pika/channel.py", line 187, in
_rpc
  File "build/bdist.macosx-10.6-universal/egg/pika/connection.py", line 325,
in _rpc
  File "build/bdist.macosx-10.6-universal/egg/pika/connection.py", line 301,
in send_method
  File "build/bdist.macosx-10.6-universal/egg/pika/connection.py", line 295,
in send_frame
  File "build/bdist.macosx-10.6-universal/egg/pika/codec.py", line 74, in
marshal
  File "build/bdist.macosx-10.6-universal/egg/pika/spec.py", line 673, in
encode
TypeError: unsupported operand type(s) for &: 'str' and 'long'

What am I doing wrong?
Thanks very much for your help.
Dan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110122/485c1949/attachment.htm>

From jon at jbrisbin.com  Sat Jan 22 22:45:28 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Sat, 22 Jan 2011 16:45:28 -0600
Subject: [rabbitmq-discuss] Question on internal guid or hashing msg content
Message-ID: <E6B47DDE-6C42-4FE3-B888-8837EF224FBC@jbrisbin.com>

I've been hacking on a rabbit_riak_queue.erl implementation today and I'm starting to get into storing messages in Riak.

I think in the recent blog post (that was excellent info, BTW) you mentioned some things to keep in mind, namely that the message body shouldn't be stored more than once, given it could go to multiple queues.

Can I use the guid property of #basic_message{} for this or would I still get unnecessary duplication (I guess I'm wondering if the same message content can have different guids for sending to multiple queues)?

Or should I hash the message content and use that as the key?

Or should I use some other method?

Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110122/24bdccd6/attachment.htm>

From matthew at rabbitmq.com  Sat Jan 22 22:52:33 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Sat, 22 Jan 2011 22:52:33 +0000
Subject: [rabbitmq-discuss] Question on internal guid or hashing msg
 content
In-Reply-To: <E6B47DDE-6C42-4FE3-B888-8837EF224FBC@jbrisbin.com>
References: <E6B47DDE-6C42-4FE3-B888-8837EF224FBC@jbrisbin.com>
Message-ID: <20110122225232.GA5962@wellquite.org>

Hi Jon,

On Sat, Jan 22, 2011 at 04:45:28PM -0600, Jon Brisbin wrote:
> Can I use the guid property of #basic_message{} for this

Yes, that's what we do. Check the type sigs of msg_store - the key there
is always the guid.

> or would I still get unnecessary duplication (I guess I'm wondering if the same message content can have different guids for sending to multiple queues)?

The guid is created and applied in the channel on basic.publish. Then it
is routed to various queues. Thus every queue receiving said msg sees it
in the same #basic_message record with the same guid.

> Or should I hash the message content and use that as the key?

Agh! don't do that - for one thing it'll be slow. But much worse than
that is that many many messages will have the same content but will not
be from the same basic.publish. So hashing them to the same thing is a
very bad idea.

Matthew

From denny.swindle at gmail.com  Sat Jan 22 23:36:04 2011
From: denny.swindle at gmail.com (Denny Swindle)
Date: Sat, 22 Jan 2011 17:36:04 -0600
Subject: [rabbitmq-discuss] Newbie: unable to run rabbitmqctl
Message-ID: <5913281A-7A88-4196-9EFE-95BAFFAC891B@gmail.com>

Hello -

Today I've been trying to get RabbitMQ running on my mac (Mac OS X 10.6.6).  I've downloaded and installed Erlang (R13B04).  I then downloaded the generic Unix version of RabbitMQ: rabbitmq-server-generic-unix-2.2.0.tar.gz.

When I start up the server, it all appears to start up just fine.  But running rabbitmqctl to perform any command results in an error.  Any guidance would be much appreciated!

Starting the server:

nemo:/usr/src/rabbitmq_server-2.2.0/sbin dswindle$ sudo ./rabbitmq-server 
Activating RabbitMQ plugins ...
0 plugins activated:


+---+   +---+
|   |   |   |
|   |   |   |
|   |   |   |
|   +---+   +-------+
|                   |
| RabbitMQ  +---+   |
|           |   |   |
|   v2.2.0  +---+   |
|                   |
+-------------------+
AMQP 0-9-1 / 0-9 / 0-8
Copyright (C) 2007-2010 LShift Ltd., Cohesive Financial Technologies LLC., and Rabbit Technologies Ltd.
Licensed under the MPL.  See http://www.rabbitmq.com/

node           : rabbit at nemo
app descriptor : /usr/src/rabbitmq_server-2.2.0/sbin/../ebin/rabbit.app
home dir       : /Volumes/Drive2/Users/dswindle
cookie hash    : 02o5DxVQC04jRptvAasHUg==
log            : /var/log/rabbitmq/rabbit at nemo.log
sasl log       : /var/log/rabbitmq/rabbit at nemo-sasl.log
database dir   : /var/lib/rabbitmq/mnesia/rabbit at nemo
erlang version : 5.8.2

starting file handle cache server                                     ...done
starting worker pool                                                  ...done
starting database                                                     ...done
starting codec correctness check                                      ...done
-- external infrastructure ready
starting statistics event manager                                     ...done
starting logging server                                               ...done
starting exchange type registry                                       ...done
starting exchange type direct                                         ...done
starting exchange type fanout                                         ...done
starting exchange type headers                                        ...done
starting exchange type topic                                          ...done
-- kernel ready
starting alarm handler                                                ...done
starting node monitor                                                 ...done
starting cluster delegate                                             ...done
starting guid generator                                               ...done
starting memory monitor                                               ...done
-- core initialized
starting empty DB check                                               ...done
starting exchange recovery                                            ...done
starting queue supervisor and queue recovery                          ...done
-- message delivery logic ready
starting error log relay                                              ...done
starting networking                                                   ...done
-- network listeners available

broker running


However, when I attempt to check the status of the server, I get the following:

nemo:/usr/src/rabbitmq_server-2.2.0/sbin dswindle$ sudo ./rabbitmqctl status
Status of node rabbit at nemo ...
Error: unable to connect to node rabbit at nemo: nodedown
diagnostics:
- unable to connect to epmd on nemo: address
- current node: rabbitmqctl68597 at nemo
- current node home dir: /Volumes/Drive2/Users/dswindle
- current node cookie hash: 02o5DxVQC04jRptvAasHUg==


Contents of /var/log/rabbitmq/rabbit at nemo.log:

=INFO REPORT==== 22-Jan-2011::17:14:40 ===
Limiting to approx 156 file handles (138 sockets)

=INFO REPORT==== 22-Jan-2011::17:14:40 ===
Memory limit set to 1638MB.

=INFO REPORT==== 22-Jan-2011::17:14:40 ===
msg_store_transient: using rabbit_msg_store_ets_index to provide index

=INFO REPORT==== 22-Jan-2011::17:14:40 ===
msg_store_persistent: using rabbit_msg_store_ets_index to provide index

=WARNING REPORT==== 22-Jan-2011::17:14:40 ===
msg_store_persistent: rebuilding indices from scratch

=INFO REPORT==== 22-Jan-2011::17:14:40 ===
started TCP Listener on 0.0.0.0:5672


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110122/98ff01f6/attachment.htm>

From jerryk at vmware.com  Sun Jan 23 02:12:55 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Sat, 22 Jan 2011 18:12:55 -0800
Subject: [rabbitmq-discuss] Newbie: unable to run rabbitmqctl
In-Reply-To: <01E9A5FC-E6CC-4D0A-B2EF-AF284C553D5D@gmail.com>
References: <5913281A-7A88-4196-9EFE-95BAFFAC891B@gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC44@EXCH-MBX-3.vmware.com>
	<01E9A5FC-E6CC-4D0A-B2EF-AF284C553D5D@gmail.com>
Message-ID: <A8160A87-5F14-4A13-91AB-05B78F719EFB@vmware.com>

No problem!  Happy to help.

Jerry

Sent from my iPhone (Brevity and typos are hopefully the result of 1-fingered typing rather than rudeness or illiteracy).


On Jan 22, 2011, at 6:04 PM, "Denny Swindle" <denny.swindle at gmail.com> wrote:

> Oh geeesh, that's exactly what it was!  (argh)
> 
> Thanks so much!  ;-)
> 
> 
> On Jan 22, 2011, at 5:59 PM, Jerry Kuch wrote:
> 
>> Hi, Denny...
>> 
>>> nemo:/usr/src/rabbitmq_server-2.2.0/sbin dswindle$ sudo ./rabbitmqctl status
>>> Status of node rabbit at nemo ...
>>> Error: unable to connect to node rabbit at nemo: nodedown
>>> diagnostics:
>>> - unable to connect to epmd on nemo: address
>>> - current node: rabbitmqctl68597 at nemo
>>> - current node home dir: /Volumes/Drive2/Users/dswindle
>>> - current node cookie hash: 02o5DxVQC04jRptvAasHUg==
>> 
>> Does 'nemo' actually resolve to your local machine's address?  
>> 
>> You might want to add an entry to your /etc/hosts file to be sure.  I had to do this on one of my Macs, which exhibited the same behavior one of the first times I tried to run rabbit/rabbitmqctl.
>> 
>> Best regards,
>> Jerry
>> 
> 

From dtenenba at fhcrc.org  Sun Jan 23 05:00:01 2011
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Sat, 22 Jan 2011 21:00:01 -0800
Subject: [rabbitmq-discuss] pika and node.amqp interop
In-Reply-To: <AANLkTimQyPwzT5pat43eqMV5axHrPcWtz1ss6HzB0C9o@mail.gmail.com>
References: <AANLkTikocGWJG1hSA4VsfgDP=9wKOJwd9V3MmFkN4QL1@mail.gmail.com>
	<5393_1295693253_4D3AB5C5_5393_489464_1_4D3AB598.5030200@rabbitmq.com>
	<AANLkTimQyPwzT5pat43eqMV5axHrPcWtz1ss6HzB0C9o@mail.gmail.com>
Message-ID: <AANLkTike-MRnwS72fFO2DpK_7WYwAFm-Z4uhbF+9bOzj@mail.gmail.com>

On Sat, Jan 22, 2011 at 12:56 PM, Dan Tenenbaum <dtenenba at fhcrc.org> wrote:

>
>
> On Sat, Jan 22, 2011 at 2:46 AM, Michael Bridgen <mikeb at rabbitmq.com>wrote:
>
>> Hi Dan,
>>
>>
>>  I am new to rabbitmq. I got the python "getting started" examples to
>>> work just fine.
>>> I would like to be able to send messages between node.js (using
>>> node.amqp) and python/pika.
>>>
>> >
>>
>>> I can successfully receive a message in node.js using this code:
>>>
>>> [receiver - node.js]
>>> var sys = require('sys');
>>> var amqp = require('./amqp');
>>>
>>> var connection = amqp.createConnection({ host: 'localhost' });
>>>
>>> // Wait for connection to become established.
>>> connection.addListener('ready', function () {
>>>   // Create a queue and bind to all messages.
>>>   // Use the default 'amq.topic' exchange
>>>
>>>   var q = connection.queue('my-queue');
>>>   // Catch all messages
>>>   q.bind('#');
>>>
>>>   // Receive messages
>>>   q.subscribe(function (message) {
>>>     // Print messages to stdout
>>>     sys.puts(sys.inspect(message));
>>>   });
>>> });
>>>
>>> [sender - python/pika]
>>> #!/usr/bin/env python
>>> import pika
>>>
>>> connection = pika.AsyncoreConnection(pika.ConnectionParameters(
>>>         host='localhost'))
>>> channel = connection.channel()
>>>
>>>
>>> channel.basic_publish(exchange='',
>>>                       routing_key='my-queue',
>>>                       body='Hello World!')
>>> print " [x] Sent 'Hello World!'"
>>> connection.close()
>>>
>>
>> You should be aware that node-amqp, at least Ryan's original and most
>> forks of it, make some unorthodox choices for parameter defaults and
>> behaviour, which to be fair are probably inherited from the EventMachine
>> AMQP client.
>>
>> In particular, the exchange that's published or bound to, if none is
>> given, is "amq.topic".  This is directly at odds with AMQP, for which an
>> empty exchange name means the "default exchange" defined in the
>> specification; that is, route directly to the queue named in the routing
>> key.
>>
>> So your example above is working by coincidence -- you don't need to bind
>> the queue in the node.js code, since your Python code is effectively sending
>> straight to the queue.  I.e., the node.js code sets up
>>
>> (amq.topic) --"#"--> [ | | my-queue | | ]
>>
>> but the message sent in the Python code actually follows
>>
>> (default) --"my-queue"--> [ | | my-queue | | ]
>>
>>
>>  But I can't go the other way. I'm not sure that the message sent by
>>> node.js is going anywhere. I've looked at the unit tests for node.amqp
>>> (they all pass) but there is something I am missing, probably to do with
>>> exchanges or something. I'd like to do something like this:
>>>
>>> [sender - node.js]
>>> var sys = require('sys');
>>> var amqp = require('./amqp');
>>>
>>> var connection = amqp.createConnection({ host: 'localhost' });
>>>
>>> // Wait for connection to become established.
>>> connection.addListener('ready', function () {
>>>   // Create a queue and bind to all messages.
>>>   // Use the default 'amq.topic' exchange
>>>   connection.publish("my-queue", {random_key:"this is my message"});
>>>   connection.end();
>>> });
>>>
>>> [receiver - python/pika]
>>> #!/usr/bin/env python
>>> import pika
>>> import sys
>>>
>>> connection = pika.AsyncoreConnection(pika.ConnectionParameters(
>>>         host='localhost'))
>>> channel = connection.channel()
>>>
>>> print ' [*] Waiting for messages. To exit press CTRL+C'
>>>
>>> def callback(ch, method, properties, body):
>>>     print body,
>>>     sys.stdout.flush()
>>> channel.basic_consume(callback,
>>>                       queue='my-queue',
>>>                       no_ack=True)
>>>
>>> pika.asyncore_loop()
>>>
>>
>> This way around (presuming there's a restart in-between runs), node.js
>> sends to amq.topic, but nothing is bound there, so the message is discarded.
>>
>> You might try binding the queue, in the Python, to the exchange
>> "amq.topic".  You should probably also declare it.
>>
>> If you actually don't want to use "amq.topic", and you probably don't if
>> you can help it, you might declare your own exchange and use that.
>>
>>
> OK, I am trying this approach, with the following sender:
>
>
> var sys = require('sys');
> var amqp = require('./amqp');
>
> var connection = amqp.createConnection({ host: 'localhost' });
>
> // Wait for connection to become established.
> connection.addListener('ready', function () {
>   // Create a queue and bind to all messages.
>   // Use the default 'amq.topic' exchange
>   var exchange = connection.exchange("my-exchange");
>   exchange.publish("my-queue", {random_key:"this is my message"});
>   connection.end();
>
> });
>
> and receiver:
>
> #!/usr/bin/env python
> import pika
> import sys
>
>
> connection = pika.AsyncoreConnection(pika.ConnectionParameters(
>         host='localhost'))
> channel = connection.channel()
> result = channel.queue_declare('my-queue')
> channel.exchange_declare(exchange='my-exchange')
> channel.queue_bind(exchange='my-exchange', queue=result.queue)
>
>
> print ' [*] Waiting for messages. To exit press CTRL+C'
>
> def callback(ch, method, properties, body):
>     print body,
>     sys.stdout.flush()
>
> channel.basic_consume(callback,
>                       queue='my-queue',
>                       no_ack=True)
>
> pika.asyncore_loop()
>
> When I run the receiver, I get:
>
> % python receiver.py
> Traceback (most recent call last):
>   File "receiver.py", line 9, in <module>
>     result = channel.queue_declare('my-queue')
>   File "build/bdist.macosx-10.6-universal/egg/pika/spec.py", line 3003, in
> queue_declare
>   File "build/bdist.macosx-10.6-universal/egg/pika/channel.py", line 187,
> in _rpc
>   File "build/bdist.macosx-10.6-universal/egg/pika/connection.py", line
> 325, in _rpc
>   File "build/bdist.macosx-10.6-universal/egg/pika/connection.py", line
> 301, in send_method
>   File "build/bdist.macosx-10.6-universal/egg/pika/connection.py", line
> 295, in send_frame
>   File "build/bdist.macosx-10.6-universal/egg/pika/codec.py", line 74, in
> marshal
>   File "build/bdist.macosx-10.6-universal/egg/pika/spec.py", line 673, in
> encode
> TypeError: unsupported operand type(s) for &: 'str' and 'long'
>
> What am I doing wrong?
> Thanks very much for your help.
> Dan
>
>
Thanks a lot to you (and to James who replied off-list). I finally got
python to receive a message from node.js.
I used Michael's fork and the following sender and receiver:
[sender]
var sys = require('sys');
var amqp = require('./amqp');

var connection = amqp.createConnection({ host: 'localhost' });

// Wait for connection to become established.
connection.addListener('ready', function () {
    var x = connection.exchange()
    var q = connection.queue("aqueuename",
             { autoDelete: true, durable: false, exclusive: false });
    x.publish('aqueuename', {foo: "bar"});
});

[receiver]
#!/usr/bin/env python
import pika

connection = pika.AsyncoreConnection(pika.ConnectionParameters(
        host='localhost'))
channel = connection.channel()

q = channel.queue_declare(queue='aqueuename',
                         auto_delete=True,
                         durable=False,
                         exclusive=False)

print ' [*] Waiting for messages. To exit press CTRL+C'

def callback(ch, method, properties, body):
    print " [x] Received %r" % (body,)

channel.basic_consume(callback,
                      queue='aqueuename',
                      no_ack=True)

pika.asyncore_loop()

One of the issues seemed to be the connection.end() that I had in the
sender. Having that in made this not work, but taking it out means the
sender doesn't exit after sending. But that's ok....I just wanted that so I
could have a simple test program; my real implementation will not exit
either, it will be a process that is always running, listening for messages
and sending them sometimes.

Now I have to actually learn rabbitmq and figure out what sort of messaging
strategies I want to use, but now I know it's possible to use node.js and
python together, so I'm ready to continue my project.

Thanks again
Dan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110122/d3c66878/attachment-0001.htm>

From jon at jbrisbin.com  Sun Jan 23 14:02:53 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Sun, 23 Jan 2011 08:02:53 -0600
Subject: [rabbitmq-discuss] Question on internal guid or hashing msg
	content
In-Reply-To: <20110122225232.GA5962@wellquite.org>
References: <E6B47DDE-6C42-4FE3-B888-8837EF224FBC@jbrisbin.com>
	<20110122225232.GA5962@wellquite.org>
Message-ID: <5F564C56-5C5A-4839-A6E5-518E9FB89A88@jbrisbin.com>


On Jan 22, 2011, at 4:52 PM, Matthew Sackman wrote:

> Hi Jon,
> 
> On Sat, Jan 22, 2011 at 04:45:28PM -0600, Jon Brisbin wrote:
>> Can I use the guid property of #basic_message{} for this
> 
> Yes, that's what we do. Check the type sigs of msg_store - the key there
> is always the guid.
> 
>> or would I still get unnecessary duplication (I guess I'm wondering if the same message content can have different guids for sending to multiple queues)?
> 
> The guid is created and applied in the channel on basic.publish. Then it
> is routed to various queues. Thus every queue receiving said msg sees it
> in the same #basic_message record with the same guid.

Another question: since non-clustered nodes will have no visibility of guids from other nodes, is it necessary to store messages separately (i.e. one bucket per cluster or node)? Maybe storing all messages in a single bucket would be easier for out-of-band processing?


Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110123/6e8878f3/attachment.htm>

From matthias at rabbitmq.com  Sun Jan 23 14:27:50 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Sun, 23 Jan 2011 14:27:50 +0000
Subject: [rabbitmq-discuss] Question on internal guid or hashing
	msg	content
In-Reply-To: <5F564C56-5C5A-4839-A6E5-518E9FB89A88@jbrisbin.com>
References: <E6B47DDE-6C42-4FE3-B888-8837EF224FBC@jbrisbin.com>	<20110122225232.GA5962@wellquite.org>
	<5F564C56-5C5A-4839-A6E5-518E9FB89A88@jbrisbin.com>
Message-ID: <4D3C3AE6.9090604@rabbitmq.com>

Jon Brisbin wrote:
> since non-clustered nodes will have no visibility of 
> guids from other nodes, is it necessary to store messages separately 
> (i.e. one bucket per cluster or node)?

guids are unique within a cluster. No guarantees beyond that.


Matthias.

From ushai at packtpub.com  Sun Jan 23 15:09:51 2011
From: ushai at packtpub.com (Usha Iyer)
Date: Sun, 23 Jan 2011 20:39:51 +0530
Subject: [rabbitmq-discuss] A cookbook on RabbitMQ
Message-ID: <4D3C44BF.20009@packtpub.com>

Hi,

My name is Usha Iyer and I am working as an Acquisition Editor at PACKT 
publishing. I would like to know your opinion about publishing a 
cookbook on RabbitMQ. This book will contain recipes for developers 
already familiar with the basics of RabbitMQ. What is your opinion about 
the book? I know that Manning is already going to publish a RabbitMQ 
book, but the basic difference is that our book assumes basic knowledge 
of RabbitMQ for readers whereas the Manning book is for a beginner.

Any comments are welcome.

Thanks,
Usha

From david at rabbitmq.com  Sun Jan 23 16:48:21 2011
From: david at rabbitmq.com (David Wragg)
Date: Sun, 23 Jan 2011 16:48:21 +0000
Subject: [rabbitmq-discuss] A cookbook on RabbitMQ
In-Reply-To: <4D3C44BF.20009@packtpub.com> (Usha Iyer's message of "Sun, 23
	Jan 2011 20:39:51 +0530")
References: <4D3C44BF.20009@packtpub.com>
Message-ID: <yrv4cwrlvefca.fsf@dwragg.eng.vmware.com>

Hi Usha,

Usha Iyer <ushai at packtpub.com> writes:
> My name is Usha Iyer and I am working as an Acquisition Editor at
> PACKT publishing. I would like to know your opinion about publishing a
> cookbook on RabbitMQ. This book will contain recipes for developers
> already familiar with the basics of RabbitMQ. What is your opinion
> about the book? I know that Manning is already going to publish a
> RabbitMQ book, but the basic difference is that our book assumes basic
> knowledge of RabbitMQ for readers whereas the Manning book is for a
> beginner.

This mailing list is for discussion about RabbitMQ, and it's the right
place if you want opinions from the RabbitMQ community.  But if you want
an official response from RabbitMQ headquarters at VMware, you should
send your email to info at rabbitmq.com.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From jasonjwwilliams at gmail.com  Sun Jan 23 17:38:54 2011
From: jasonjwwilliams at gmail.com (Jason J. W. Williams)
Date: Sun, 23 Jan 2011 10:38:54 -0700
Subject: [rabbitmq-discuss] A cookbook on RabbitMQ
In-Reply-To: <4D3C44BF.20009@packtpub.com>
References: <4D3C44BF.20009@packtpub.com>
Message-ID: <A43A045F-6C55-4AD5-B273-665F65B576FB@gmail.com>

Hi Usha,

I think a cookbook/patterns book would be great. Just as an FYI though, RabbitMQ in Action is meant to be both tutorial and reference for folks at all levels of Rabbit. 

-J

Sent via iPhone

Is your e-mail Premiere?

On Jan 23, 2011, at 8:09, Usha Iyer <ushai at packtpub.com> wrote:

> Hi,
> 
> My name is Usha Iyer and I am working as an Acquisition Editor at PACKT publishing. I would like to know your opinion about publishing a cookbook on RabbitMQ. This book will contain recipes for developers already familiar with the basics of RabbitMQ. What is your opinion about the book? I know that Manning is already going to publish a RabbitMQ book, but the basic difference is that our book assumes basic knowledge of RabbitMQ for readers whereas the Manning book is for a beginner.
> 
> Any comments are welcome.
> 
> Thanks,
> Usha
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From D.Rotondi at Computer.Org  Sun Jan 23 18:23:21 2011
From: D.Rotondi at Computer.Org (Dom54)
Date: Sun, 23 Jan 2011 10:23:21 -0800 (PST)
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate 583848200
	bytes of memory
In-Reply-To: <F78BCF638F95D74A99D036114107EDB5023948CC0C@EXCH-MBX-3.vmware.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>,
	<AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC0C@EXCH-MBX-3.vmware.com>
Message-ID: <c61b3c40-2bcf-4532-9630-969512668aba@f30g2000yqa.googlegroups.com>

On Jan 18, 10:23 pm, Jerry Kuch <jer... at vmware.com> wrote:
Hi,
we have a similar problem that can be summarised as follows.
Our goal is to compare RabbitMQ (the last stable version) to ActiveMQ.
To this end we set up two minimal and similar testing environments
having both 1 publisher, 1 subscriber and 1 message broker (RabbitMQ/
ActiveMQ) server.
In both testing environments the message broker runs under a Windows
Hyper-V virtual machine (hosted on a Windows Server 23008 64 bits)
that has as OS a 32 bit Windows Server 2008 (if I'm correct we
allocated 2 GB, perhpas 4 GB, to the VM and 1 CPU).
The publishers/subscribers are run under Windows  XP/Vista and are on
the same LAN as the broker VM.

The publisher (whose code and details are reported on this thread
"http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2011-January/
010818.html") has a config file that specifies how many chunks of
messages have to be sent. For each chunk the config specifies how many
messages have to be published and of what size (our tests use a range
between 512 and 2K bytes).
For each chunk the publisher publishes an initial message that informs
the subscriber a new chunk has been started. This initial message
contains a timestamp of the chunk start. Immediately afterwards the
publisher sends the envisaged number of messages and then a final
message informing the subscriber the chunk is finished. Then the
publisher process the next chunk as specified in the config file.

On the subscriber side it connects to the broker waiting for messages.
When a new chuck started message is received, it saves the received
timestamp and then counts how many messages it has received till the
indication of the chunk end message. At this point it reads the system
clock and calculates how much time has elapsed since the chunck start
on the publisher side (as reported in the received timestamp) and the
arrival on the chunk end message on the subscriber side.
The subscriber then logs all these data (start timestamp, end
timestamp, elapsed time, number of messages), and is ready to process
a new message chunk.
Anyway further details and the Java code is available in the indicated
RabbitMQ newsgroup's message.
In our testing environment, therefore, there are no durable queues, no
permanent messages, a single subscriber, ...

What we experienced are crashes of the RabbitMQ server due to the
memory allocation issues. Indeed, the Windows Task Manager shows the
RabbitMQ process increasing memory, until it crashes.
On the RabbitMQ forum someone suggested to my colleague Cristoforo to
reduce the vm_memory_high_watermark value from its default 0.40 value.
We tried with 0.25, 0.20 and 0.10. The crash problem doesn't disappear
unless the subscriber runs on a fast machine (e.g. putting the
subscriber on the same VM as the message broker seems to have less
crashing issues).
With ActiveMQ we don't experience similar issues at all.
We are not using Erlnag under a 64 bit OS (our VM, as stated, is a 32
bit Windows Server 2008), and the vm_memory_high_watermark has been
lowered enough (we think).

Our conclusion is that the Windows Erlang implementation has some
serious issues on memory management under Windows, or that we have not
configured Erlang/RabbitMQ in a proper way.
Of course we need to run RabbitmQ under Windows (Server 2008 is not a
real constraint, any Windows OS could be OK, even if having Windows
Server 2008 would be preferrable).
So if someone has experience running RabbitMQ under Windows, please
help us in spotting where we are wrong.

Sorry for the long comment, but I think it was necessary to describe a
testing scenario that, in my opinion, can shed some lights on the
flagged issue.
Regards
    Dom
> A couple more small remarks on the somewhat less than optimal Windows
> situation...
>
> > Possible solutions:
> > ?- upgrade to erlang >= R13B3
>
> Be warned that the results of doing so currently appear to be a bit on
> the "meh" side. ?In some cases we've seen the onset of the problem be
> delayed a little bit, but happen anyway, even with version 14B01.
>
> > ?- Configure 'vm_memory_high_watermark' value (as Jerry suggested).
> > ? ?The smaller the value, the sooner Rabbit will stop accepting
> > ? ?new messages and growing memory.
>
> This is probably the most applicable advice we have at this point. If
> you do try it with a lower watermark value, say something like 0.2,
> we're interested in hearing what results you experience as the
> behavior Marek mentions kicks in, and whether they're sufficient to
> keep the crashes at bay while not unacceptably compromising
> throughput.
>
> > ?- Play with IMAGE_FILE_LARGE_ADDRESS_AWARE flag.
>
> Also, be aware that just hacking this bit on the executable doesn't
> necessarily mean that the code within the executable is going to do
> the right thing, even if you're running a version of Windows that's
> been booted with the appropriate settings to induce a 3GB/1GB
> user/kernel split rather than the default 2GB/2GB. ?Historically, some
> 32-bit applications under Windows have played funny games with pointer
> arithmetic and made assumptions about pointer values that can result
> in them misbehaving if user space doesn't end around the usual 2GB
> boundary. ?I have no idea if the Windows release of Erlang is one of
> them.
>
> Best regards,
> Jerry
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From moseley at hank.org  Mon Jan 24 06:11:21 2011
From: moseley at hank.org (Bill Moseley)
Date: Sun, 23 Jan 2011 22:11:21 -0800
Subject: [rabbitmq-discuss] Exchange and queue naming conventions
Message-ID: <AANLkTikB3T8BPUDkrvRPd7OwrOQVX8fLrK0LAn-Ab3xZ@mail.gmail.com>

Are there any good conventions to follow when naming queues, exchanges, and
bindings?  As I'm adding more queues I'm starting to think some type of
naming convention would be very smart.  Just curious what other's do.

For now I'm only using a direct exchange type.  When should I be declaring
additional exchanges vs. using the same (or even the default) exchange?

A pattern I'm seeing is I have an app-specific producer than sends a message
to a generic consumer (used by multiple apps) but then that consumer sends a
message to another app-specific consumer.  What I'm doing is passing the
return queue name in the reply_to attribute.  I'm not passing in the
exchange name -- so I'm just using the same exchange for every binding.

I also declare the exchange, queue, and binding in every component (the
producer and both consumers).  I assume that's typical as it allows starting
the components in any order.  Is that appropriate?

Finally, I have been naming queue and bindings with the same name.  Is there
a reason that should not be done?

Thanks,

-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110123/5fe02421/attachment-0001.htm>

From Dennis.Wiemann at akquinet.de  Mon Jan 24 10:05:26 2011
From: Dennis.Wiemann at akquinet.de (Wiemann, Dennis)
Date: Mon, 24 Jan 2011 10:05:26 +0000
Subject: [rabbitmq-discuss] error during make of rabbitmq-erlang-client
Message-ID: <6AF1ACEB033E0A469C8A47FE17C73D1EE2E33C@akqhpwpex04.akquinet.de>

hi guys,

i'm trying to make the erlang client for rabbit mq.

I am fulfilling the prerequisites, which means i installed erlang R14B01 and put the rabbitmq-server in a sibling dir
called rabbitmq-server. I also tried several versions of the server (1.4, 1.8, 2.2), but the make process (after a while) stops with

Src/amqp_channel.erl:407: record 'confirm.selected' undefined

Any ideas on this one?

Best regards,
dw


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110124/c206516a/attachment.htm>

From simon at rabbitmq.com  Mon Jan 24 10:12:50 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Mon, 24 Jan 2011 10:12:50 +0000
Subject: [rabbitmq-discuss] error during make of rabbitmq-erlang-client
In-Reply-To: <6AF1ACEB033E0A469C8A47FE17C73D1EE2E33C@akqhpwpex04.akquinet.de>
References: <6AF1ACEB033E0A469C8A47FE17C73D1EE2E33C@akqhpwpex04.akquinet.de>
Message-ID: <4D3D50A2.7060705@rabbitmq.com>

On 24/01/11 10:05, Wiemann, Dennis wrote:
> I am fulfilling the prerequisites, which means i installed erlang R14B01
> and put the rabbitmq-server in a sibling dir
>
> called rabbitmq-server. I also tried several versions of the server
> (1.4, 1.8, 2.2), but the make process (after a while) stops with
>
> Src/amqp_channel.erl:407: record ?confirm.selected? undefined

Hi Dennis. confirm.select is a new feature that hasn't made it into any 
released version yet. Therefore I deduce that you're compiling the 
Erlang client from default against the 2.2.0(?) broker. That won't work.

If you want to switch the Erlang client to the version which compiles 
against 2.2.0, do "hg update -r rabbitmq_v2_2_0", then make clean, then 
make.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From Dennis.Wiemann at akquinet.de  Mon Jan 24 10:46:51 2011
From: Dennis.Wiemann at akquinet.de (Wiemann, Dennis)
Date: Mon, 24 Jan 2011 10:46:51 +0000
Subject: [rabbitmq-discuss] error during make of rabbitmq-erlang-client
Message-ID: <6AF1ACEB033E0A469C8A47FE17C73D1EE2E363@akqhpwpex04.akquinet.de>

Hi Simon,

that did the trick! Thank you for your quick response.

Best regards,
Dennis

>>On 24/01/11 10:05, Wiemann, Dennis wrote:
>> I am fulfilling the prerequisites, which means i installed erlang R14B01
>> and put the rabbitmq-server in a sibling dir
>>
>> called rabbitmq-server. I also tried several versions of the server
>> (1.4, 1.8, 2.2), but the make process (after a while) stops with
>>
>> Src/amqp_channel.erl:407: record 'confirm.selected' undefined
>
>Hi Dennis. confirm.select is a new feature that hasn't made it into any
>released version yet. Therefore I deduce that you're compiling the
>Erlang client from default against the 2.2.0(?) broker. That won't work.
>
>If you want to switch the Erlang client to the version which compiles
>against 2.2.0, do "hg update -r rabbitmq_v2_2_0", then make clean, then
>make.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110124/d1360084/attachment.htm>

From majek04 at gmail.com  Mon Jan 24 12:33:42 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Mon, 24 Jan 2011 12:33:42 +0000
Subject: [rabbitmq-discuss] Restarting management plugin without
 restarting the whole server
In-Reply-To: <7D07D1E4-9783-43DA-B971-8B700B96ED89@gmail.com>
References: <62A0AF45-C76F-48D1-AF4F-A3B8BDDF246F@gmail.com>
	<AANLkTimoy=qjxq4EYzZW93Mk5fvzKr7OqcLKV0sai1Pv@mail.gmail.com>
	<7D07D1E4-9783-43DA-B971-8B700B96ED89@gmail.com>
Message-ID: <AANLkTimWA-79ad+NnXULL5wHWemJX8TxGGNdoYprQcbu@mail.gmail.com>

On Thu, Jan 20, 2011 at 14:48, Stas Krichevsky <stask312 at gmail.com> wrote:
> I tried to run it, and while the plugin itself restarts, it's still not
> working (it doesn't show any statistics).
> I think it's related to 'statistics_db_node' -- i'm getting following as
> part of /api/overview response:
>
> "statistics_db_node":"not_running"
>
> Is there a way to restart 'statistics_db_node'?

That's pretty bad. It looks like you need to restart the "rabbit" application
got that running again. Which means restarting the broker. Sorry.

Marek

> On Jan 20, 2011, at 12:42 PM, Marek Majkowski wrote:
>
> On Thu, Jan 20, 2011 at 06:16, Stas Krichevsky <stask312 at gmail.com> wrote:
>
> Management plugin stopped working recently on our production system (CentOS
>
> 5.5, Erlang R14B, RabbitMQ 2.2.0).
>
> Is there a way to restart just the plugin without restarting the whole
>
> server?
>
> Good question. I'm not an expert, but this worked for me:
> application:loaded_applications().
> application:stop(rabbit_management).
> application:stop(webmachine).
> application:stop(rabbit_mochiweb).
> application:stop(mochiweb).
>
> application:start(rabbit_mochiweb).
> application:start(webmachine).
> application:start(rabbit_management).
>
> But beware it can probably make things even worse.
>
> Chers,
> ?Marek
>
>

From jon at jbrisbin.com  Mon Jan 24 13:13:21 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Mon, 24 Jan 2011 07:13:21 -0600
Subject: [rabbitmq-discuss] internal sequence ID
Message-ID: <B867A8C1-C104-4B10-8F0E-755EF974B04D@jbrisbin.com>

I'm able to persist messages to Riak now but I'm trying to figure out how to return a proper sequence ID from publish/3.

What's the easiest way to implement this sequence ID that won't cause things to explode? :) Would an in-memory counter that starts at 1 all the time be sufficient? Or do I need to keep track of that by persisting some kind of metadata? It looks like variable_queue uses rabbit_queue_index, which I wasn't sure if I would be able to simply scab onto.

Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110124/27febf37/attachment.htm>

From matthew at rabbitmq.com  Mon Jan 24 15:41:24 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Mon, 24 Jan 2011 15:41:24 +0000
Subject: [rabbitmq-discuss] internal sequence ID
In-Reply-To: <B867A8C1-C104-4B10-8F0E-755EF974B04D@jbrisbin.com>
References: <B867A8C1-C104-4B10-8F0E-755EF974B04D@jbrisbin.com>
Message-ID: <20110124154123.GB11337@rabbitmq.com>

On Mon, Jan 24, 2011 at 07:13:21AM -0600, Jon Brisbin wrote:
> I'm able to persist messages to Riak now but I'm trying to figure out how to return a proper sequence ID from publish/3.
> 
> What's the easiest way to implement this sequence ID that won't cause things to explode? :) Would an in-memory counter that starts at 1 all the time be sufficient? Or do I need to keep track of that by persisting some kind of metadata? It looks like variable_queue uses rabbit_queue_index, which I wasn't sure if I would be able to simply scab onto.

The seqid is a pure number. The purpose of queue_index is that at best,
without it, you'll end up with a queue of elements where each element
probably looks like {Guid, IsDelivered}. In order to avoid the memory
costs of queues of millions of such items, you need to be able to store
such queues on disk. If you assign each element a seqid then you'll be
able to compress down to what's helpfully called a ? in vq - i.e. a
start seqid, an end seqid and a count. And of course, there can be gaps
which is why you may need the count. At that point you can just lift off
disk the relevant records you need to be able to then rehydrate them to
{Guid, IsDelivered} elements, and from there get back to the whole msg.

How you achieve this in riak or elsewhere is of course entirely up to
you!

Matthew

From alfonso.pantoja at gmail.com  Mon Jan 24 16:47:17 2011
From: alfonso.pantoja at gmail.com (Alfonso Pantoja)
Date: Mon, 24 Jan 2011 17:47:17 +0100
Subject: [rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET API:
	How it works?
Message-ID: <AANLkTim_hB0XJ6C-4ZBtWifWvZtpmt5n+J1HvOe-3_wr@mail.gmail.com>

Hi,

I've developed an application that consumes messages from a queue ("events
queue") and depending on their data
it publishes (per received message) a message to another queue ("results
queue")

The logic that checks the content of the received messages is publishing
messages using BasicPublish (with mandatory=2, immediate=false and setting
deliveryMode=2 to the messages to be sent)
My concern is that BasicPublish is asynchronous  and the only exception I
can get is when there is no connection to RabbitMQ or the destination
exchange does not exist.

Since the application logic at this point is synchronous I can't use
BasicReturn in order to use a handler when messages can't be delivered.

I've been googling a lot and some people suggested using this schema:

ch.TxSelect()
ch.BasicPublish(.....)
ch.TxCommit()

and also is suggested that "commit-ok" will be returned if the message has
been published safely to the broker.

Reading the API user guide I've found that this is called "transfer
responsibility".

Copy & paste follows:

--
To transfer responsibility for delivery of a message to a broker
? ensure (ahead of time) that the target queue exists and is durable,
? select Tx mode using IModel.TxSelect,
? publish the message with the "mandatory" flag set and DeliveryMode set
equal to 2, and
? commit the Tx transaction using IModel.TxCommit.

Once a broker replies with CommitOk (i.e. the TxCommit() call returns to the
caller), it has taken
responsibility for keeping the message on disk and on the target queue until
some other application
retrieves and acknowledges the message.
A commit is not required after every message: batching of publications may
be done, depending on the
precise delivery guarantees the publishing application requires.
Responsibility can also be placed with an external database, even further
along the chain - see the section
on interaction with external resources below
---

My question is:

Being TxCommit a void function I tested this block of code using a
non-existing routing key and I didn't get any exception.
Since safe publishing would be highly desiderable non routed messages should
be detected because the application ACKs the messages of "events queue"
when after evaluating its content has successfully sent another message to
the "results queue" (currently if a a routing key is not being routed to a
queue the messages are silently dropped and I have no way to detect the
failure so the application ACKs the messages from "events queue")

Please, can someone tell me how I can't get that "CommitOK" responses?


Thank you in advance.


Alfonso

PS: I'm using the API version 1.7.2 and RabbitMQ server is the same version.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110124/6268f02b/attachment.htm>

From david at rabbitmq.com  Mon Jan 24 18:14:18 2011
From: david at rabbitmq.com (David Wragg)
Date: Mon, 24 Jan 2011 18:14:18 +0000
Subject: [rabbitmq-discuss] Exchange and queue naming conventions
In-Reply-To: <AANLkTikB3T8BPUDkrvRPd7OwrOQVX8fLrK0LAn-Ab3xZ@mail.gmail.com>
	(Bill Moseley's message of "Sun, 23 Jan 2011 22:11:21 -0800")
References: <AANLkTikB3T8BPUDkrvRPd7OwrOQVX8fLrK0LAn-Ab3xZ@mail.gmail.com>
Message-ID: <yrv4cbp36np8l.fsf@dwragg.eng.vmware.com>

Hi Bill,

Bill Moseley <moseley at hank.org> writes:
> Are there any good conventions to follow when naming queues, exchanges, and
> bindings?  As I'm adding more queues I'm starting to think some type of
> naming convention would be very smart.  Just curious what other's do.

I don't think there is any one right way.  When choosing names for
queues, exchanges, and keys, the use of dotted paths is widespread.  But
your questions are more about usage than naming.

> For now I'm only using a direct exchange type.  When should I be declaring
> additional exchanges vs. using the same (or even the default)
> exchange?

It depends on your message exchange patterns.

Generally, you should arrange your application to take full advantage of
the facilities AMQP presents.  If your application ends up dispatching
or filtering messages in a way that could be delegated to RabbitMQ, then
you should do.

Also, consider where you might later want to add new producers and
consumers - even if just for debugging purposes.  The ability to easily
add additional parties into message exchanges is one of the major
advantages of a messaging-based approach as opposed to point-to-point
mechanisms such as web services.

> A pattern I'm seeing is I have an app-specific producer than sends a message
> to a generic consumer (used by multiple apps) but then that consumer sends a
> message to another app-specific consumer.  What I'm doing is passing the
> return queue name in the reply_to attribute.  I'm not passing in the
> exchange name -- so I'm just using the same exchange for every
> binding.

For a request-response pattern, this seems fine.

One variation is to make the exchange a topic exchange rather than a
direct exchange.  This allows you to intercept all replies with a
wildcard binding (e.g. for debugging).

> I also declare the exchange, queue, and binding in every component (the
> producer and both consumers).  I assume that's typical as it allows starting
> the components in any order.  Is that appropriate?

Yes, this kind of thing is perfectly normal with AMQP.

Typically, both the producers and consumers will declare the exchanges
of interest.  But only consumers will declare and bind the queues,
because they know which messages they wish to receive.

> Finally, I have been naming queue and bindings with the same name.  Is there
> a reason that should not be done?

By naming bindings, I assume you are referring to the binding key.
There's nothing wrong with what you describe, except that this sounds
very close to what the AMQP nameless exchange does implicitly.  So
perhaps you could take advantage of that, and so avoid the need to
declare an exchange and explicitly bind your queues.


David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From PRYD at mach.com  Mon Jan 24 19:33:16 2011
From: PRYD at mach.com (Prashant Yadav)
Date: Tue, 25 Jan 2011 01:03:16 +0530
Subject: [rabbitmq-discuss] Alternate Exchange Configuration Issue
Message-ID: <11EC96EC521B304EA05595E6F2987FC202A46124@EXCHBAN.machcorp.lan>

Hi ,

 

Am experiencing trouble when configuring alternate exchange for my
broker. I am following the docs present in rabbitmq site. The error am
getting is



Caused by: com.rabbitmq.client.ShutdownSignalException: channel error;
reason:
{#method<channel.close>(reply-code=406,reply-text=PRECONDITION_FAILED -
inequivalent arg 'alternate-exchange' for exchange 'exchange' in vhost
'/':  required {longstr,<<97,101>>}, received
undefined,class-id=40,method-id=10),null,""}

                             at
com.rabbitmq.client.impl.ChannelN.processAsync(ChannelN.java:230)

                             at
com.rabbitmq.client.impl.AMQChannel.handleCompleteInboundCommand(AMQChan
nel.java:165)

                             at
com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:110)

                             at
com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:4
37)

Caught: com.rabbitmq.client.AlreadyClosedException: clean connection
shutdown; reason: Attempt to use closed channel

 

As you can see in the Stack Trace, am defining alternate exchange and
looks like it does not like it. This is my rfrence from RabbitMQ Site

Map<String, Object> args = new HashMap<String, Object>();

args.put("alternate-exchange", "my-ae");

channel.exchangeDeclare("my-direct", "direct", false, false, args);

channel.exchangeDeclare("my-ae", "fanout");

channel.queueDeclare("routed");

channel.queueBind("routed", "my-direct", "key1");

channel.queueDeclare("unrouted");

channel.queueBind("unrouted", "my-ae", "");

 

Regds

Prashant  

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/26c6c8ad/attachment-0001.htm>

From simon at rabbitmq.com  Mon Jan 24 19:55:01 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Mon, 24 Jan 2011 19:55:01 +0000
Subject: [rabbitmq-discuss] Alternate Exchange Configuration Issue
In-Reply-To: <11EC96EC521B304EA05595E6F2987FC202A46124@EXCHBAN.machcorp.lan>
References: <11EC96EC521B304EA05595E6F2987FC202A46124@EXCHBAN.machcorp.lan>
Message-ID: <4D3DD915.4040102@rabbitmq.com>

On 24/01/2011 7:33PM, Prashant Yadav wrote:
 > Am experiencing trouble when configuring alternate exchange for my
 > broker. I am following the docs present in rabbitmq site. The error am
 > getting is
 >
 > Caused by: com.rabbitmq.client.ShutdownSignalException: channel error;
 > reason:
 > {#method<channel.close>(reply-code=406,reply-text=PRECONDITION_FAILED -
 > inequivalent arg 'alternate-exchange' for exchange 'exchange' in vhost
 > '/': required {longstr,<<97,101>>}, received
 > undefined,class-id=40,method-id=10),null,""}

Did you previously declare the exchange with a different alternate 
exchange? (Or none?) Every declaration of an exchange needs to have the 
same arguments.

BTW I note that your error message references an exchange called 
"exchange" but your code references "my-direct".

Cheers, Simon

From mrkafk at gmail.com  Mon Jan 24 20:17:20 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Mon, 24 Jan 2011 21:17:20 +0100
Subject: [rabbitmq-discuss] Extremely slow responses
Message-ID: <4D3DDE50.4070108@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hello everyone,

I'm getting weird problem with very slow transfers of messages to reply
queue.

The setup: cluster of 3 nodes, with fanout-type exchange, with 3 queues
bound, one per each node.

This part works without problems (tested separately) - messages sent
from client get delivered quickly to each queue and are then read by
servers on each node.

However, when I add callback queue (with exclusive=True) for responses
from each server, I'm getting responses back very slowly - like after a
minute!

(the callback queue gets created by client with
channel.queue_declare(exclusive=True) )

Basically, I combined solutions from tutorial on fanout
(http://www.rabbitmq.com/tutorial-three-python.html) with code from
tutorial on RPC (http://www.rabbitmq.com/tutorial-six-python.html) and
used it in a cluster.

1. Might it be that temporary queues get propagated across cluster very
slowly?

2. Or is it a problem that I do not bind the reply temp queue to any
exchange? (ch.basic_publish(exchange='', routing_key=props.reply_to,
    body = result))

I'm using pika for both server and client.

Rationale for the whole thing: I need to replicate the same JSON-RPC
call across several nodes. At best, I would like to be able to read all
the produced responses back.


Complete code:

Server:

http://pastie.org/pastes/1493724/text

Client:

http://pastie.org/pastes/1493732/text




- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNPd5QAAoJEFMgHzhQQ7hO+9UH/jhK9wz4dkkKnH1z2soHQ8q8
VXeMZ7l7oI+fmm8Njl+ZCIh3VooF/DsU9AI0I370hW0ycSMDEgfmehytxMFwrZer
WpABoOde7sj/WDBE46zfi/6/Iso6URzkdy+IxjfJa+dCDV4O28rApQUO2BFCHgrb
EkEMH0gQ5g88AOotE2NIyXsg8EL0UDceVIfGk9ObkXY3OYyI/v/gSyo8FmWkZqjA
lLtBQCK/RrxAzsH9MGu9Jymihmv7mp740VLXc2CPtQvFt6v6bpTKlpzu053iaQav
TWdGdth+N7aohhyiIuwZJNZInXdsQwqhwystMTfIgwsSEH6gkzbKKlFkL156kXU=
=latj
-----END PGP SIGNATURE-----

From mrkafk at gmail.com  Mon Jan 24 20:26:45 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Mon, 24 Jan 2011 21:26:45 +0100
Subject: [rabbitmq-discuss] pika - dealing with exceptions
Message-ID: <4D3DE085.4030208@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

(I'm not sure there is dedicated mailing list for pika, so I'm posting
this here in hope that somebody solved this issue)

Suppose you have a temp callback queue and (RPC) client disconnects
before server can reply and send in the message back to the queue.

Server:

ch.basic_publish(exchange='', routing_key=props.reply_to,
      body = result)

Client:

result = self.channel.queue_declare(exclusive=True)
self.callback_queue = result.queue
self.channel.basic_consume(self.on_response, no_ack=True,
queue=self.callback_queue)


I'm getting exceptions in server like this, probably in such a situation:

error: uncaptured python exception, closing channel
<pika.asyncore_adapter.RabbitDispatcher connected at 0x7f79653106c8>
(<type 'exceptions.KeyError'>:1 [/usr/lib/python2.5/asyncore.py|read|68]
[/usr/lib/python2.5/asyncore.py|handle_read_event|390]
[/usr/local/bin/src/pika/pika/asyncore_adapter.py|handle_read|91]
[/usr/local/bin/src/pika/pika/connection.py|on_data_available|268]
[/usr/local/bin/src/pika/pika/connection.py|_generic_frame_handler|416])

Is there a way of addressing this problem?




- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNPeCFAAoJEFMgHzhQQ7hOPcMH/0Ldho1YKjqSm+Ulnw8ovizG
FD/vQZ2CY85PcNNbffRZE2DVUVzx5sK0PF+1/ICa0yjo15+4bXTGqUqQeat+l1mJ
djKjABsFTkjPqYbA1je6A2DnKYT0w4ELmLTJUD9KzSRApgRadXDSIUK89NjmWN6z
N6G0MB5oIF8Ejr/n8HK/oS2ynBC+XhnwFt1qim8IfYhhabb8Ocn4iEFrbUprjOLL
YyxN1XqMgcuDVgCTejcCKEj4bNoWQJE4oPJ9GI6posbDlAGe3zIgquAtG/d3PruD
vcBfTcO5X0O7kBqJ4eyeCqQGECAqtVX5/FcwZZGQFnhGlUbAfhT+A5O6MNa1L1Y=
=0hzb
-----END PGP SIGNATURE-----

From mrkafk at gmail.com  Mon Jan 24 20:35:13 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Mon, 24 Jan 2011 21:35:13 +0100
Subject: [rabbitmq-discuss] pika - dealing with exceptions
Message-ID: <4D3DE281.7080903@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1



Suppose you have a temp callback queue and (RPC) client disconnects
before server can reply and send in the message back to the queue.

P.S. I'm quessing that the temp queue gets deleted?



Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNPeKBAAoJEFMgHzhQQ7hOilMIAJQBHBy4kUEhDquNWjJ4vRkU
LQ/M8fCyDa/BQ+OnqRMBb+jTtdD/66X2zeZEML1YdHxfbvehgMY8aICwulyZ+7N+
Zemt3OPC3h+HKu0KsDVa0ybmmLsLmKw/2UU/5+eS61d5IC2WOKUTmQuVZ1+1Ju/8
0zW5J0Tdeu5JyXYk2qq1Wv0BPy+cma0/Qa5YVfyvKOLpn3QCITzJzrhRRu0F4BWL
MC6IBqQl4mfXqoUbC16+RCncDVhHcfCMwjOPMTz33xfbcLapdtBHHGhqCQkNWAuX
UmfwlSNdIqgepg/DqHLkW24Xm8PzK3vNWVRJ+m2+VkmxC/6Rk6lpWu3g01eS2sM=
=03og
-----END PGP SIGNATURE-----

From jerryk at vmware.com  Mon Jan 24 20:36:18 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Mon, 24 Jan 2011 12:36:18 -0800
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate
	583848200	bytes of memory
In-Reply-To: <c61b3c40-2bcf-4532-9630-969512668aba@f30g2000yqa.googlegroups.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>,
	<AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC0C@EXCH-MBX-3.vmware.com>,
	<c61b3c40-2bcf-4532-9630-969512668aba@f30g2000yqa.googlegroups.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC4F@EXCH-MBX-3.vmware.com>

Hi, Dom...

> we have a similar problem that can be summarised as follows.  Our goal
> is to compare RabbitMQ (the last stable version) to ActiveMQ.  To this
> end we set up two minimal and similar testing environments having both
> 1 publisher, 1 subscriber and 1 message broker (RabbitMQ/ ActiveMQ)
> server.  In both testing environments the message broker runs under a
> Windows Hyper-V virtual machine (hosted on a Windows Server 23008 64
> bits) that has as OS a 32 bit Windows Server 2008 (if I'm correct we
> allocated 2 GB, perhpas 4 GB, to the VM and 1 CPU).  The
> publishers/subscribers are run under Windows XP/Vista and are on the
> same LAN as the broker VM.

This ought to be an entirely reasonable set up.  Apologies that you're
having trouble with it.  There's definitely something awry here and
current evidence points toward it not being yiour fault.

> On the subscriber side it connects to the broker waiting for messages.
> When a new chuck started message is received, it saves the received
> timestamp and then counts how many messages it has received till the
> indication of the chunk end message. At this point it reads the system
> clock and calculates how much time has elapsed since the chunck start
> on the publisher side (as reported in the received timestamp) and the
> arrival on the chunk end message on the subscriber side.  The
> subscriber then logs all these data (start timestamp, end timestamp,
> elapsed time, number of messages), and is ready to process a new
> message chunk.  Anyway further details and the Java code is available
> in the indicated RabbitMQ newsgroup's message.  In our testing
> environment, therefore, there are no durable queues, no permanent
> messages, a single subscriber, ...

Our of curiosity when and how is your consumer ACK-ing the messages it
gets?  Do you have auto-ACK set?  Or are you explicitly ACK-ing them,
either individually or as a range?

> What we experienced are crashes of the RabbitMQ server due to the
> memory allocation issues. Indeed, the Windows Task Manager shows the
> RabbitMQ process increasing memory, until it crashes.  On the RabbitMQ
> forum someone suggested to my colleague Cristoforo to reduce the
> vm_memory_high_watermark value from its default 0.40 value.  We tried
> with 0.25, 0.20 and 0.10. The crash problem doesn't disappear unless
> the subscriber runs on a fast machine (e.g. putting the subscriber on
> the same VM as the message broker seems to have less crashing issues).
> With ActiveMQ we don't experience similar issues at all.  We are not
> using Erlnag under a 64 bit OS (our VM, as stated, is a 32 bit Windows
> Server 2008), and the vm_memory_high_watermark has been lowered enough
> (we think).

So your observations are that when you have a fast consumer, your
broker fares better?

> Our conclusion is that the Windows Erlang implementation has some
> serious issues on memory management under Windows, or that we have not
> configured Erlang/RabbitMQ in a proper way.

At the moment, it looks like the former is very likely true.  Some on
the Rabbit team have had some interaction with Erlang's maintainers on
the issue, but we don't have a good answer for you yet.

> Sorry for the long comment, but I think it was necessary to describe a
> testing scenario that, in my opinion, can shed some lights on the
> flagged issue.

No apologies necessary...  your feedback is helpful, and has helped us
confirm that something is awry on Windows.  The Rabbit user base seems
rather tilted toward Unix so when there are problems specific to
running on Windows, we don't always find out as quickly as we might
like...

Best regards,
Jerry

From jerryk at vmware.com  Mon Jan 24 21:30:49 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Mon, 24 Jan 2011 13:30:49 -0800
Subject: [rabbitmq-discuss] RabbitMQ Test case - Possible Memory
	Leak	problem
In-Reply-To: <AANLkTi=dDJLJrf67+KrA1Y6TxFYEs48_oisjyyeo-mwX@mail.gmail.com>
References: <AANLkTimgA6tNpstggKpeKTj2yUC+xdWGpuAD+CvYP9jq@mail.gmail.com>
	<20110114160023.GE18402@rabbitmq.com>,
	<AANLkTi=dDJLJrf67+KrA1Y6TxFYEs48_oisjyyeo-mwX@mail.gmail.com>
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC50@EXCH-MBX-3.vmware.com>

Hi, Cristoforo...

> I've fallowed your instructions and configured my RabbitMQ server
> under windows to use different configuration setup:
>
> 1) [{rabbit, [{vm_memory_high_watermark, 0.80}]}].
> 2) [{rabbit, [{vm_memory_high_watermark, 0.40}]}].
> 3) [{rabbit, [{vm_memory_high_watermark, 0.25}]}].
> 4) [{rabbit, [{vm_memory_high_watermark, 0.20}]}].
> 5) [{rabbit, [{vm_memory_high_watermark, 0.10}]}].

A good set of values to try...  I assume you were able to confirm in
your Rabbit log at startup that the changed watermark value was being
reflected?  The messages announcing the broker's configured memory
limit should look roughly like...

=INFO REPORT==== 24-Jan-2011::13:16:22 ===
Memory limit set to 2779MB.

...and you should see this value dropping as you decrease the
watermark setting in the manner you describe.  I ask only because
we've had a couple of cases (they seem a bit more common on Windows
for some reason), where the setting was changed incorrectly and didn't
get picked up by the broker at startup, and want to make sure you
didn't encounter that pitfall, and are in fact trying out the broker
with different watermark values.

> Every time I've started RabbiitMQ server with one of the previous
> configuration and then started my Test application but every time the
> RabbitMQ server crashed down after a few minutes.I don't sincerly find
> any problem in my application's code and, as I've stated in previous
> e-mail the test is very simple. Anyway I've attached my project and
> hope someone can test my application under different machine then
> window because for the moment I'm unable to operate this kind of
> test. Hope to have a response. Thanks, best regards

I just tried running it on Mac OS X and it was able to run to
completion.  I did notice that as it ran Unix 'top' showed the RPRVT
value for the Erlang BEAM process in which the broker was running
bouncing steadily around 2GB, a value that could be strenuous on a
32-bit Windows system where only 2GB of user space are available to a
single process, assuming the same sort of memory loading occurs there.

I expect I'll be able to give it a try on a Windows system later today
once I put one together with Maven, a JVM, etc. to run your stress
test.

> The attached file is a MAVEN project (platform independent) which
> produces as output an executable project.

Thanks for providing such a clean, well packaged and easy to run repro
case.  This is always helpful...  I'll mail the list once I've had a
chance to exercise it under Windows myself...

Best regards,
Jerry

From moseley at hank.org  Mon Jan 24 21:34:22 2011
From: moseley at hank.org (Bill Moseley)
Date: Mon, 24 Jan 2011 13:34:22 -0800
Subject: [rabbitmq-discuss] Exchange and queue naming conventions
In-Reply-To: <yrv4cbp36np8l.fsf@dwragg.eng.vmware.com>
References: <AANLkTikB3T8BPUDkrvRPd7OwrOQVX8fLrK0LAn-Ab3xZ@mail.gmail.com>
	<yrv4cbp36np8l.fsf@dwragg.eng.vmware.com>
Message-ID: <AANLkTikOj3sbPq5_dwjD7B2TCgaW6=m0OHrgihg-bnV1@mail.gmail.com>

On Mon, Jan 24, 2011 at 10:14 AM, David Wragg <david at rabbitmq.com> wrote:

> Hi Bill,
>
> Bill Moseley <moseley at hank.org> writes:
> > Are there any good conventions to follow when naming queues, exchanges,
> and
> > bindings?  As I'm adding more queues I'm starting to think some type of
> > naming convention would be very smart.  Just curious what other's do.
>
> I don't think there is any one right way.  When choosing names for
> queues, exchanges, and keys, the use of dotted paths is widespread.  But
> your questions are more about usage than naming.
>

Hi David,

I do think it makes sense to use the dotted notation, and then use topic
queues as that makes for very flexible routing options.  I was wondering if
anyone had worked out some "best practices" over time that would be useful
as we start to add more tasks.

I'm trying to break up some of our existing processes that are very tightly
coupled - the workers know quite a bit about the producers.  For example, a
worker might be configured to handle just one application in "QA" mode, and
another in "production" mode.  And likewise, the producer (in our current
system) must know where to send the message ("I'm in QA mode so I need to
send to the QA worker").

So, as an example I'm wondering about schemes where an app might use a
routing key of "app1.qa.rotate_image" which would allow us to configure
consumers that handles all image rotation for all apps and all modes, or
separate consumers based on the mode.

BTW -- in that case can I configure binding for three queues:
 *.qa.rotate_image. *.production.rotate_image, and then a third for all
except "qa" a and "production"?


Finally, I'm still a bit confused when to create new exchanges (assuming all
the same type).  Just trying to get some basic guidelines.  Is there any
overhead with using more exchanges vs. just more bindings on the same
exchange?  Is is common to use separate exchanges for grouping consumers
(i.e. an exchange for report queues and another exchange for image
manipulation queues)?

Thanks very much for your help,



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110124/7c9ff237/attachment-0001.htm>

From dtenenba at fhcrc.org  Mon Jan 24 23:00:05 2011
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Mon, 24 Jan 2011 15:00:05 -0800
Subject: [rabbitmq-discuss] Making sure a message gets to every consumer
Message-ID: <AANLkTinPU2EhHXhCUm+Wkzj4gKBH4zir-p7GY77X1_wm@mail.gmail.com>

Hi,
Still trying to migrate my head over from JMS concepts to RabbitMQ.

I have a situation that I want to be like this:

App1 sends a message to anyone who is listening to a certain queue.
I want ALL consumers of that queue to get every message sent by App1, I
don't want it dispatched in a round-robin fashion. At the same time, I don't
think I want to use a fanout exchange because I don't want all consumers in
the vhost to get the message, just the ones that are subscribed to by
instances of:

App2
There are several instances of App2.
When App2 gets a message, it does some work and sends progress messages back
to App1. There is presently only one instance of App1 but I might like to
have other consumers in future for the messages that App1 receives.

The problem:
I can't figure out the right combination of exchange types, queues, and
routing keys to get this to work.

It seems that if I use either 'direct' or 'topic' as my exchange type, the
messages that app1 sends are dispatched in a round-robin fashion (that is,
not all listeners get every message).

If I set the exchange type to fanout, then app2 keeps sending the same
message back to app1 over and over. It could be that I have created an
infinite loop of messages back and forth.


Anyway....in JMS headspace I would simply have 2 topics, call them
"fromapp1" and "fromapp2" and subscribe each app to the appropriate topic,
and it would Just Work....maybe I was doing something wrong back then?
Certainly I'm doing something wrong now.

If someone can suggest the pattern I might want to use, that would be great.

Thanks
Dan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110124/6192e33c/attachment.htm>

From sduncan at wetafx.co.nz  Mon Jan 24 23:06:32 2011
From: sduncan at wetafx.co.nz (Sam Duncan)
Date: Tue, 25 Jan 2011 12:06:32 +1300
Subject: [rabbitmq-discuss] Making sure a message gets to every consumer
In-Reply-To: <AANLkTinPU2EhHXhCUm+Wkzj4gKBH4zir-p7GY77X1_wm@mail.gmail.com>
References: <AANLkTinPU2EhHXhCUm+Wkzj4gKBH4zir-p7GY77X1_wm@mail.gmail.com>
Message-ID: <4D3E05F8.10509@wetafx.co.nz>

Does it need to be one queue? If you use a topic exchange and create a 
queue for each consumer, you get a copy of each message in each queue 
filtered by your queue bindings. You could even have a shared queue for 
each consumer type so the messages are not duplicated in context.

Sam


On 25/01/11 12:00, Dan Tenenbaum wrote:
> Hi,
> Still trying to migrate my head over from JMS concepts to RabbitMQ.
>
> I have a situation that I want to be like this:
>
> App1 sends a message to anyone who is listening to a certain queue.
> I want ALL consumers of that queue to get every message sent by App1, 
> I don't want it dispatched in a round-robin fashion. At the same time, 
> I don't think I want to use a fanout exchange because I don't want all 
> consumers in the vhost to get the message, just the ones that are 
> subscribed to by instances of:
>
> App2
> There are several instances of App2.
> When App2 gets a message, it does some work and sends progress 
> messages back to App1. There is presently only one instance of App1 
> but I might like to have other consumers in future for the messages 
> that App1 receives.
>
> The problem:
> I can't figure out the right combination of exchange types, queues, 
> and routing keys to get this to work.
>
> It seems that if I use either 'direct' or 'topic' as my exchange type, 
> the messages that app1 sends are dispatched in a round-robin fashion 
> (that is, not all listeners get every message).
>
> If I set the exchange type to fanout, then app2 keeps sending the same 
> message back to app1 over and over. It could be that I have created an 
> infinite loop of messages back and forth.
>
>
> Anyway....in JMS headspace I would simply have 2 topics, call them 
> "fromapp1" and "fromapp2" and subscribe each app to the appropriate 
> topic, and it would Just Work....maybe I was doing something wrong 
> back then? Certainly I'm doing something wrong now.
>
> If someone can suggest the pattern I might want to use, that would be 
> great.
>
> Thanks
> Dan
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>    
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/882a7b9c/attachment.htm>

From matthias at rabbitmq.com  Mon Jan 24 23:17:25 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Mon, 24 Jan 2011 23:17:25 +0000
Subject: [rabbitmq-discuss] Making sure a message gets to every consumer
In-Reply-To: <4D3E05F8.10509@wetafx.co.nz>
References: <AANLkTinPU2EhHXhCUm+Wkzj4gKBH4zir-p7GY77X1_wm@mail.gmail.com>
	<4D3E05F8.10509@wetafx.co.nz>
Message-ID: <4D3E0885.2060506@rabbitmq.com>

Sam Duncan wrote:
> If you use a topic exchange and create a 
> queue for each consumer, you get a copy of each message in each queue 
> filtered by your queue bindings.

A direct exchange would probably work too, unless you need bindings with 
wildcards.

If you haven't done so already, I recommend reading 
http://www.rabbitmq.com/tutorial-three-python.html

Regards,

Matthias.

From arun.suresh at gmail.com  Tue Jan 25 00:56:55 2011
From: arun.suresh at gmail.com (Arun Suresh)
Date: Mon, 24 Jan 2011 16:56:55 -0800
Subject: [rabbitmq-discuss] regarding supervisor2
Message-ID: <AANLkTimRBijLV8YhqBG_YCh=BbpuHUNVmZcycftdeyst@mail.gmail.com>

Hello

Ive been playing around with supervisor2 which you guys ship with rabbitmq
server. The delayed restart is seriously a life saver.

The only minor issue ive had with it is:
Once the process has exceeded MaxT and MaxR, you guys spawn a timer thread
to restart the process after the specified delay.. During this period, the
process is actually dead. but supervisor:which_children still returns a
stale Pid. Any reason why inside the do_restart method, once the restart1
method returns a {terminate, NState} , state_del_child() is NOT called ?

Regards
-Arun
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110124/5e9b31d3/attachment.htm>

From michael.s.klishin at gmail.com  Tue Jan 25 07:19:17 2011
From: michael.s.klishin at gmail.com (Michael Klishin)
Date: Tue, 25 Jan 2011 10:19:17 +0300
Subject: [rabbitmq-discuss] pika - dealing with exceptions
In-Reply-To: <4D3DE281.7080903@gmail.com>
References: <4D3DE281.7080903@gmail.com>
Message-ID: <AANLkTim-28sjTnNQJtitaVVt-9K5xHFV=zQzm-b9niVO@mail.gmail.com>

2011/1/24 Marcin Krol <mrkafk at gmail.com>

> P.S. I'm quessing that the temp queue gets deleted?


Sounds like it. Just curious, does the client
disconnect because of a failure or it is considered normal for it to do so?
-- 
MK
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/f53a5091/attachment.htm>

From michael.s.klishin at gmail.com  Tue Jan 25 07:50:24 2011
From: michael.s.klishin at gmail.com (Michael Klishin)
Date: Tue, 25 Jan 2011 10:50:24 +0300
Subject: [rabbitmq-discuss] Exchange and queue naming conventions
In-Reply-To: <AANLkTikOj3sbPq5_dwjD7B2TCgaW6=m0OHrgihg-bnV1@mail.gmail.com>
References: <AANLkTikB3T8BPUDkrvRPd7OwrOQVX8fLrK0LAn-Ab3xZ@mail.gmail.com>
	<yrv4cbp36np8l.fsf@dwragg.eng.vmware.com>
	<AANLkTikOj3sbPq5_dwjD7B2TCgaW6=m0OHrgihg-bnV1@mail.gmail.com>
Message-ID: <AANLkTimBXprF+Q=VtAd=W+-V1LaYwW-gmW3S8htPk7j4@mail.gmail.com>

2011/1/25 Bill Moseley <moseley at hank.org>

> I do think it makes sense to use the dotted notation, and then use topic
> queues as that makes for very flexible routing options.  I was wondering if
> anyone had worked out some "best practices" over time that would be useful
> as we start to add more tasks.
>

1+ year and several apps later I see the following pattern developing on my
team:

1. Exchanges are declared by producers.
2. Queues are declared and bound by consumers.
3. In vast majority of cases, consumers are "smart" and producers are very
dumb: they just put messages in well-known places. Consumers
    are "smart" in a sense that they almost always keep some persistent
state (in Redis, for example), while producers are just monitored in case
they crash.
4. Exchanges are named using the following pattern
$prefix.$applications_group.$app.$environment. For example,
megacorp.mail_delivery.shaper.qa or
megacorp.search.online_indexer.production. It works well with multiple
installations and if you want to route some data to your
customers/partners/archive.

Also, it becomes increasingly obvious that many exchanges and bindings would
be unnecessary if we begin to use default exchange more.



> BTW -- in that case can I configure binding for three queues:
>  *.qa.rotate_image. *.production.rotate_image, and then a third for all
> except "qa" a and "production"?
>

"Except" case is not handled by AMQP very well (not in 0.9.1 I am most
familiar with, anyway). Maybe *.other.rotate_image would be good enough?


Finally, I'm still a bit confused when to create new exchanges (assuming all
> the same type).  Just trying to get some basic guidelines.  Is there any
> overhead with using more exchanges vs. just more bindings on the same
> exchange?  Is is common to use separate exchanges for grouping consumers
> (i.e. an exchange for report queues and another exchange for image
> manipulation queues)?
>


Unless you have thousands of them on a small box, it probably does not make
much difference. For support cases, dealing with apps that use 150 exchanges
may be significantly more difficult than if they were using just 3, though.

Hope this helps.
-- 
MK
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/faee74e5/attachment-0001.htm>

From jon.rowland at isam.com  Tue Jan 25 09:14:51 2011
From: jon.rowland at isam.com (Jon Rowland)
Date: Tue, 25 Jan 2011 03:14:51 -0600
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
 Chrome
In-Reply-To: <611FB1B444670A41A06F4C91C40041C75D049AB2A1@34093-MBX-C06.mex07a.mlsrvr.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D359B67.2030806@rabbitmq.com>
	<611FB1B444670A41A06F4C91C40041C75D049AB2A1@34093-MBX-C06.mex07a.mlsrvr.com>
Message-ID: <985477893245CF449ABD4F01814A9FF65F41EE5541@34093-MBX-C06.mex07a.mlsrvr.com>

I don't have Firefox but I tried this in IE 8.0 and get the same behaviour (1GB usage after leaving running overnight).

Thanks,
Jon

-----Original Message-----
From: Jon Rowland 
Sent: 18 January 2011 14:49
To: Simon MacMullen; rabbitmq-discuss at lists.rabbitmq.com
Subject: RE: [rabbitmq-discuss] RabbitMQ management plugin memory usage in Chrome

Thanks - it's no problem for me, but I thought it worth reporting.

I also don't have the required skills/knowledge to probe any deeper unfortunately...

-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Simon MacMullen
Sent: 18 January 2011 13:54
To: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] RabbitMQ management plugin memory usage in Chrome

On 17/01/11 08:56, Jon Rowland wrote:
> I left a test app running over the weekend which publishes 1000 msg/sec
> to a broker. I also left the management plugin page open on the Channels
> tab running in Chrome.
>
> I happened to notice that Chrome was using an enormous amount of memory
> - over 1GB and very slowly increasing. As soon as I navigated to another
> page outside of the management console, without restarting the browser,
> the memory was released.
>
> No idea if this is 'bug' or 'feature' but thought you may be interested.

Hi Jon. I'm sure this is a bug, I'm just not sure if it's in 
rabbitmq-management or in Chrome :(

You're not supposed to be able to do anything to leak memory in 
JavaScript + HTML. In old browsers you're supposed to avoid circular 
references between DOM elements and closures, and AFAICS we do that. So 
if there is some bugfix or workaround I'm not sure how to find it.

At the moment the best advice I can give is to decrease the refresh 
frequency if this is a problem...

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From mrkafk at gmail.com  Tue Jan 25 10:22:59 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Tue, 25 Jan 2011 11:22:59 +0100
Subject: [rabbitmq-discuss] pika - dealing with exceptions
In-Reply-To: <AANLkTim-28sjTnNQJtitaVVt-9K5xHFV=zQzm-b9niVO@mail.gmail.com>
References: <4D3DE281.7080903@gmail.com>
	<AANLkTim-28sjTnNQJtitaVVt-9K5xHFV=zQzm-b9niVO@mail.gmail.com>
Message-ID: <4D3EA483.4090408@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Michael Klishin wrote:
> 
> 
> 2011/1/24 Marcin Krol <mrkafk at gmail.com <mailto:mrkafk at gmail.com>>
> 
>     P.S. I'm quessing that the temp queue gets deleted?
> 
> 
> Sounds like it. Just curious, does the client
> disconnect because of a failure or it is considered normal for it to do so?

I tested it that way: client sent the message and disconnected
immediately. After all, there is no guarantee that in production use
some client won't do smth like this, and if it creates uncatcheable
exception in server, that's a problem.

- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNPqSCAAoJEFMgHzhQQ7hOXwIH/jumwIKCq1ojA2OIgn4JSBb0
CPMYl7NtDZDSTi6iUSOHfsH270T495trGIA9pff18G+N2NuEOeL/MrYU2YiOHB5l
Rjum19NAQEUVdN7+I6v3aSy+A4kg5XKHl0hL5QXo9hW53hANzxmyyfGRGYkIRbeV
pw1kjEa7mD3yjYM6aNLI1qemMtpvAuyrjiSaSe01e9lwZSgdI/Rz1aILX96hmywF
0qr6/kqk+Mb9y+2hpRVIWC7YM+0baTbgYKz1GKkdGLWDj5nt0PrqzIpOlxZzmJaW
+HoF4814ErV0RBq+ZZtcf/baETF9G8M4QLsYopQx0U9jeQw3hPAOT2IfLDmVKwM=
=7S0x
-----END PGP SIGNATURE-----

From D.Rotondi at Computer.Org  Tue Jan 25 10:30:42 2011
From: D.Rotondi at Computer.Org (Dom54)
Date: Tue, 25 Jan 2011 02:30:42 -0800 (PST)
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate 583848200
	bytes of memory
In-Reply-To: <F78BCF638F95D74A99D036114107EDB5023948CC4F@EXCH-MBX-3.vmware.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>,
	<AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC0C@EXCH-MBX-3.vmware.com>,
	<c61b3c40-2bcf-4532-9630-969512668aba@f30g2000yqa.googlegroups.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC4F@EXCH-MBX-3.vmware.com>
Message-ID: <0409a620-98fb-45e6-901f-a412d4dd4205@y2g2000prf.googlegroups.com>


On Jan 24, 9:36?pm, Jerry Kuch <jer... at vmware.com> wrote:
Thanks Jerry for the reply.
My answers/comments inline.
Ciao
    Dom

> Hi, Dom...
>
> > we have a similar problem that can be summarised as follows. ?Our goal
> > is to compare RabbitMQ (the last stable version) to ActiveMQ. ?To this
> > end we set up two minimal and similar testing environments having both
> > 1 publisher, 1 subscriber and 1 message broker (RabbitMQ/ ActiveMQ)
> > server. ?In both testing environments the message broker runs under a
> > Windows Hyper-V virtual machine (hosted on a Windows Server 23008 64
> > bits) that has as OS a 32 bit Windows Server 2008 (if I'm correct we
> > allocated 2 GB, perhpas 4 GB, to the VM and 1 CPU). ?The
> > publishers/subscribers are run under Windows XP/Vista and are on the
> > same LAN as the broker VM.
>
> This ought to be an entirely reasonable set up. ?Apologies that you're
> having trouble with it. ?There's definitely something awry here and
> current evidence points toward it not being yiour fault.
>
> > On the subscriber side it connects to the broker waiting for messages.
> > When a new chuck started message is received, it saves the received
> > timestamp and then counts how many messages it has received till the
> > indication of the chunk end message. At this point it reads the system
> > clock and calculates how much time has elapsed since the chunck start
> > on the publisher side (as reported in the received timestamp) and the
> > arrival on the chunk end message on the subscriber side. ?The
> > subscriber then logs all these data (start timestamp, end timestamp,
> > elapsed time, number of messages), and is ready to process a new
> > message chunk. ?Anyway further details and the Java code is available
> > in the indicated RabbitMQ newsgroup's message. ?In our testing
> > environment, therefore, there are no durable queues, no permanent
> > messages, a single subscriber, ...
>
> Our of curiosity when and how is your consumer ACK-ing the messages it
> gets? ?Do you have auto-ACK set? ?Or are you explicitly ACK-ing them,
> either individually or as a range?

We tried both using auto-ACK and explicit ACK on each received
message. The result was exactly the same.
BTW our VM has a 2 GB RAM. The RbbitMQ exchange type is a direct one,
and there only 1 consumer queue bound to that exchange.
You can find all our test code here (http://lists.rabbitmq.com/
pipermail/rabbitmq-discuss/2011-January/
010818.html).

>
> > What we experienced are crashes of the RabbitMQ server due to the
> > memory allocation issues. Indeed, the Windows Task Manager shows the
> > RabbitMQ process increasing memory, until it crashes. ?On the RabbitMQ
> > forum someone suggested to my colleague Cristoforo to reduce the
> > vm_memory_high_watermark value from its default 0.40 value. ?We tried
> > with 0.25, 0.20 and 0.10. The crash problem doesn't disappear unless
> > the subscriber runs on a fast machine (e.g. putting the subscriber on
> > the same VM as the message broker seems to have less crashing issues).
> > With ActiveMQ we don't experience similar issues at all. ?We are not
> > using Erlnag under a 64 bit OS (our VM, as stated, is a 32 bit Windows
> > Server 2008), and the vm_memory_high_watermark has been lowered enough
> > (we think).
>
> So your observations are that when you have a fast consumer, your
> broker fares better?

Yes. To our understanding the RabbitMQ broker (and its supporting
Erlang environment) keeps to be delivered messages in memory; if the
consumer is not fast enough the Erlang memory footprint grows till the
broker crash.

>
> > Our conclusion is that the Windows Erlang implementation has some
> > serious issues on memory management under Windows, or that we have not
> > configured Erlang/RabbitMQ in a proper way.
>
> At the moment, it looks like the former is very likely true. ?Some on
> the Rabbit team have had some interaction with Erlang's maintainers on
> the issue, but we don't have a good answer for you yet.
>
> > Sorry for the long comment, but I think it was necessary to describe a
> > testing scenario that, in my opinion, can shed some lights on the
> > flagged issue.
>
> No apologies necessary... ?your feedback is helpful, and has helped us
> confirm that something is awry on Windows. ?The Rabbit user base seems
> rather tilted toward Unix so when there are problems specific to
> running on Windows, we don't always find out as quickly as we might
> like...
>
> Best regards,
> Jerry
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From michael.s.klishin at gmail.com  Tue Jan 25 10:38:28 2011
From: michael.s.klishin at gmail.com (Michael Klishin)
Date: Tue, 25 Jan 2011 13:38:28 +0300
Subject: [rabbitmq-discuss] pika - dealing with exceptions
In-Reply-To: <4D3EA483.4090408@gmail.com>
References: <4D3DE281.7080903@gmail.com>
	<AANLkTim-28sjTnNQJtitaVVt-9K5xHFV=zQzm-b9niVO@mail.gmail.com>
	<4D3EA483.4090408@gmail.com>
Message-ID: <AANLkTikkQTRoonu-S-wLgrO4hEtvqNmD+6Lbo3gin_zV@mail.gmail.com>

2011/1/25 Marcin Krol <mrkafk at gmail.com>

> I tested it that way: client sent the message and disconnected
> immediately. After all, there is no guarantee that in production use
> some client won't do smth like this, and if it creates uncatcheable
> exception in server, that's a problem.
>

I completely agree. This is an excellent test case for applications.
However,
from the protocol point of view, it's just a wrong use of auto-deleted
queues.
So I am not sure what libraries behavior should be. This is relevant to all
clients and worth mentioning in tutorials that demonstrate uses of
auto-deled queues.
-- 
MK
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/f86f2dcd/attachment.htm>

From matthias at rabbitmq.com  Tue Jan 25 10:44:38 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Tue, 25 Jan 2011 10:44:38 +0000
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate 583848200
 bytes of memory
In-Reply-To: <0409a620-98fb-45e6-901f-a412d4dd4205@y2g2000prf.googlegroups.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>,
	<AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>	<F78BCF638F95D74A99D036114107EDB5023948CC0C@EXCH-MBX-3.vmware.com>,
	<c61b3c40-2bcf-4532-9630-969512668aba@f30g2000yqa.googlegroups.com>	<F78BCF638F95D74A99D036114107EDB5023948CC4F@EXCH-MBX-3.vmware.com>
	<0409a620-98fb-45e6-901f-a412d4dd4205@y2g2000prf.googlegroups.com>
Message-ID: <4D3EA996.7090704@rabbitmq.com>

Dom,

Dom54 wrote:
> To our understanding the RabbitMQ broker (and its supporting
> Erlang environment) keeps to be delivered messages in memory; if the
> consumer is not fast enough the Erlang memory footprint grows till the
> broker crash.

The rabbit code does not hold on to messages in memory when it has 
delivered them to consumers and it is under memory pressure.

But we do rely on the underlying erlang network stack and O/S to tell us 
when it can't send messages to the consumers. Rather than, say, blindly 
buffering them. It's possible that therein lies the problem on Windows.

Btw, when you tweaked the vm_memory_high_watermark settings, did you 
check that they were actually taking effect? There is a message near the 
beginning of the rabbit log file indicating how much memory it is trying 
to limit itself to.

Regards,

Matthias.

From majek04 at gmail.com  Tue Jan 25 10:46:17 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Tue, 25 Jan 2011 10:46:17 +0000
Subject: [rabbitmq-discuss] pika - dealing with exceptions
In-Reply-To: <4D3DE085.4030208@gmail.com>
References: <4D3DE085.4030208@gmail.com>
Message-ID: <AANLkTi=kU8GeDD3=-JJErA-Dc2VVKcBL0swtHNtci+Mv@mail.gmail.com>

Hi,

On Mon, Jan 24, 2011 at 20:26, Marcin Krol <mrkafk at gmail.com> wrote:
> (I'm not sure there is dedicated mailing list for pika, so I'm posting
> this here in hope that somebody solved this issue)

This mailing list is okay. Tony (the author of pika) is reading
this list, and we also have quite a few Pika users here.

> Suppose you have a temp callback queue and (RPC) client disconnects
> before server can reply and send in the message back to the queue.
>
> Server:
>
> ch.basic_publish(exchange='', routing_key=props.reply_to,
> ? ? ?body = result)
>
> Client:
>
> result = self.channel.queue_declare(exclusive=True)
> self.callback_queue = result.queue
> self.channel.basic_consume(self.on_response, no_ack=True,
> queue=self.callback_queue)
>
>
> I'm getting exceptions in server like this, probably in such a situation:
>
> error: uncaptured python exception, closing channel
> <pika.asyncore_adapter.RabbitDispatcher connected at 0x7f79653106c8>

Right. You should not see a 'channel exception' when you're publishing to
a non-existing queue - ie: wrong routing key. Test code:
   https://github.com/majek/dump/blob/master/puka/rpctest.py

On the other hand the 'channel error' while publishing will be triggered
when you're publishing to non-existing *exchange*.

Please check if the exchange exists.

Cheers,
  Marek

From matthias at rabbitmq.com  Tue Jan 25 10:51:06 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Tue, 25 Jan 2011 10:51:06 +0000
Subject: [rabbitmq-discuss] pika - dealing with exceptions
In-Reply-To: <AANLkTikkQTRoonu-S-wLgrO4hEtvqNmD+6Lbo3gin_zV@mail.gmail.com>
References: <4D3DE281.7080903@gmail.com>	<AANLkTim-28sjTnNQJtitaVVt-9K5xHFV=zQzm-b9niVO@mail.gmail.com>	<4D3EA483.4090408@gmail.com>
	<AANLkTikkQTRoonu-S-wLgrO4hEtvqNmD+6Lbo3gin_zV@mail.gmail.com>
Message-ID: <4D3EAB1A.4040604@rabbitmq.com>

Michael Klishin wrote:
> 2011/1/25 Marcin Krol <mrkafk at gmail.com <mailto:mrkafk at gmail.com>>
> 
>     I tested it that way: client sent the message and disconnected
>     immediately. After all, there is no guarantee that in production use
>     some client won't do smth like this, and if it creates uncatcheable
>     exception in server, that's a problem.
> 
> 
> I completely agree. This is an excellent test case for applications. 
> However,
> from the protocol point of view, it's just a wrong use of auto-deleted 
> queues.
> So I am not sure what libraries behavior should be. This is relevant to all
> clients and worth mentioning in tutorials that demonstrate uses of 
> auto-deled queues.

There is nothing wrong with using exclusive queues for replies. In fact 
they are nearly always the right choice, which is why our RPC tutorial 
(http://www.rabbitmq.com/tutorial-six-python.html) employs them.

Publish operations do not fail just because a queue doesn't exist. 
Marcin, please inspect the error you get in your rpc server. It should 
tell you what the problem is. Or look in the server logs.


Regards,

Matthias.

From majek04 at gmail.com  Tue Jan 25 10:53:48 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Tue, 25 Jan 2011 10:53:48 +0000
Subject: [rabbitmq-discuss] Extremely slow responses
In-Reply-To: <4D3DDE50.4070108@gmail.com>
References: <4D3DDE50.4070108@gmail.com>
Message-ID: <AANLkTin_pF5uDHb6tiF6LBU7V4kBx3pYHqaFy6eEL1TJ@mail.gmail.com>

Hi,

> I'm getting weird problem with very slow transfers of messages to reply
> queue.
>
> The setup: cluster of 3 nodes, with fanout-type exchange, with 3 queues
> bound, one per each node.
>
> This part works without problems (tested separately) - messages sent
> from client get delivered quickly to each queue and are then read by
> servers on each node.
>
> However, when I add callback queue (with exclusive=True) for responses
> from each server, I'm getting responses back very slowly - like after a
> minute!
>
> (the callback queue gets created by client with
> channel.queue_declare(exclusive=True) )
>
> Basically, I combined solutions from tutorial on fanout
> (http://www.rabbitmq.com/tutorial-three-python.html) with code from
> tutorial on RPC (http://www.rabbitmq.com/tutorial-six-python.html) and
> used it in a cluster.
>
> 1. Might it be that temporary queues get propagated across cluster very
> slowly?
>
> 2. Or is it a problem that I do not bind the reply temp queue to any
> exchange? (ch.basic_publish(exchange='', routing_key=props.reply_to,
> ? ?body = result))
>
> I'm using pika for both server and client.
>
> Rationale for the whole thing: I need to replicate the same JSON-RPC
> call across several nodes. At best, I would like to be able to read all
> the produced responses back.

In the server code you're not using acks:
    chan.basic_consume(on_request, queue=mynode, no_ack=True)
but later on you call basic_ack:
    ch.basic_ack(delivery_tag = method.delivery_tag)

That's rather bad.

Also, rate limit using basic_qos, doesn't make much sense with no_ack=True:
  chan.basic_qos(prefetch_count=1)


And the last thing: clustering != HA.
Clustering doesn't mean that the messages are replicated.
Every queue 'lives' on a single node, if that node goes down,
that queue goes down.

Cheers!
  Marek

From matthew at rabbitmq.com  Tue Jan 25 11:00:41 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Tue, 25 Jan 2011 11:00:41 +0000
Subject: [rabbitmq-discuss] regarding supervisor2
In-Reply-To: <AANLkTimRBijLV8YhqBG_YCh=BbpuHUNVmZcycftdeyst@mail.gmail.com>
References: <AANLkTimRBijLV8YhqBG_YCh=BbpuHUNVmZcycftdeyst@mail.gmail.com>
Message-ID: <20110125110040.GB8077@rabbitmq.com>

Howdy,

On Mon, Jan 24, 2011 at 04:56:55PM -0800, Arun Suresh wrote:
> Ive been playing around with supervisor2 which you guys ship with rabbitmq
> server. The delayed restart is seriously a life saver.

Glad you like it.

> The only minor issue ive had with it is:
> Once the process has exceeded MaxT and MaxR, you guys spawn a timer thread
> to restart the process after the specified delay.. During this period, the
> process is actually dead. but supervisor:which_children still returns a
> stale Pid. Any reason why inside the do_restart method, once the restart1
> method returns a {terminate, NState} , state_del_child() is NOT called ?

>From memory, no reason at all, and I think it would be an improvement
for it to do the del_child sooner rather than later and thus not return
the stale pid. Slight complexities with simple_* supervisors possibly -
can't remember - it's been a while since I looked at that code. I'll
take a look and most likely file a bug.

Best wishes,

Matthew

From D.Rotondi at Computer.Org  Tue Jan 25 11:44:17 2011
From: D.Rotondi at Computer.Org (Dom54)
Date: Tue, 25 Jan 2011 03:44:17 -0800 (PST)
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate 583848200
	bytes of memory
In-Reply-To: <4D3EA996.7090704@rabbitmq.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>,
	<AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC0C@EXCH-MBX-3.vmware.com>,
	<c61b3c40-2bcf-4532-9630-969512668aba@f30g2000yqa.googlegroups.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC4F@EXCH-MBX-3.vmware.com>
	<0409a620-98fb-45e6-901f-a412d4dd4205@y2g2000prf.googlegroups.com>
	<4D3EA996.7090704@rabbitmq.com>
Message-ID: <6afff39e-c2b7-4308-9f0e-08f1c6ad95ee@i32g2000pri.googlegroups.com>



On Jan 25, 11:44?am, Matthias Radestock <matth... at rabbitmq.com> wrote:
Hi Matthias,
> Dom,
>
> Dom54 wrote:
> > To our understanding the RabbitMQ broker (and its supporting
> > Erlang environment) keeps to be delivered messages in memory; if the
> > consumer is not fast enough the Erlang memory footprint grows till the
> > broker crash.
>
> The rabbit code does not hold on to messages in memory when it has
> delivered them to consumers and it is under memory pressure.

Thats what I stated above. In memory seems to be buffered only
messages that have not been delivered.

>
> But we do rely on the underlying erlang network stack and O/S to tell us
> when it can't send messages to the consumers. Rather than, say, blindly
> buffering them. It's possible that therein lies the problem on Windows.
>
> Btw, when you tweaked the vm_memory_high_watermark settings, did you
> check that they were actually taking effect? There is a message near the
> beginning of the rabbit log file indicating how much memory it is trying
> to limit itself to.

Yes we checked the tweak effect in the log file and the log file
reflects the setting.
BTW we have just completed another test using a Windows Server 2008 R2
64 bit version on a vM with 4 BG RAM, and the problem is still there.
We are now trying using the last Erlang release (R14B01) instead of
the R13B03 included in the RabbitMQ distribution, hoping this release
has fixed some of the problems.
Thanks, ciao
   Dom

>
> Regards,
>
> Matthias.
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From michael.s.klishin at gmail.com  Tue Jan 25 11:45:31 2011
From: michael.s.klishin at gmail.com (Michael Klishin)
Date: Tue, 25 Jan 2011 14:45:31 +0300
Subject: [rabbitmq-discuss] pika - dealing with exceptions
In-Reply-To: <4D3EAB1A.4040604@rabbitmq.com>
References: <4D3DE281.7080903@gmail.com>
	<AANLkTim-28sjTnNQJtitaVVt-9K5xHFV=zQzm-b9niVO@mail.gmail.com>
	<4D3EA483.4090408@gmail.com>
	<AANLkTikkQTRoonu-S-wLgrO4hEtvqNmD+6Lbo3gin_zV@mail.gmail.com>
	<4D3EAB1A.4040604@rabbitmq.com>
Message-ID: <AANLkTimQDbNG5_kpRczW2tfguDwYE8JQPBiV3BopK638@mail.gmail.com>

2011/1/25 Matthias Radestock <matthias at rabbitmq.com>

> There is nothing wrong with using exclusive queues for replies. In fact
> they are nearly always the right choice, which is why our RPC tutorial (
> http://www.rabbitmq.com/tutorial-six-python.html) employs them.
>
>
I did not mean to say that exclusive queues aren't the right choice for
replies.


>  Publish operations do not fail just because a queue doesn't exist
>

Right, because exclusive queue is deleted soon after last consumer
disconnects.
If responses may take some time in a particular app and client disconnection
is probable,
maybe using auto-deleted queues is not such a good idea.
-- 
MK
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/5302fa03/attachment.htm>

From matthias at rabbitmq.com  Tue Jan 25 11:51:40 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Tue, 25 Jan 2011 11:51:40 +0000
Subject: [rabbitmq-discuss] pika - dealing with exceptions
In-Reply-To: <AANLkTimQDbNG5_kpRczW2tfguDwYE8JQPBiV3BopK638@mail.gmail.com>
References: <4D3DE281.7080903@gmail.com>
	<AANLkTim-28sjTnNQJtitaVVt-9K5xHFV=zQzm-b9niVO@mail.gmail.com>
	<4D3EA483.4090408@gmail.com>
	<AANLkTikkQTRoonu-S-wLgrO4hEtvqNmD+6Lbo3gin_zV@mail.gmail.com>
	<4D3EAB1A.4040604@rabbitmq.com>
	<AANLkTimQDbNG5_kpRczW2tfguDwYE8JQPBiV3BopK638@mail.gmail.com>
Message-ID: <4D3EB94C.9070405@rabbitmq.com>

On 25/01/11 11:45, Michael Klishin wrote:
> 2011/1/25 Matthias Radestock <matthias at rabbitmq.com
>     Publish operations do not fail just because a queue doesn't exist
>
>
> Right, because exclusive queue is deleted soon after last consumer
> disconnects.
> If responses may take some time in a particular app and client
> disconnection is probable,
> maybe using auto-deleted queues is not such a good idea.

What should happen to the responses when the intended recipient is no 
longer there? Usually discarding them is the right thing to do. Which is 
exactly what will happen when the reply queue disappears. Btw, it's 
*exclusive* queues you want for reply queues, not auto-delete.

Matthias.

From PRYD at mach.com  Tue Jan 25 11:53:41 2011
From: PRYD at mach.com (Prashant Yadav)
Date: Tue, 25 Jan 2011 17:23:41 +0530
Subject: [rabbitmq-discuss] Slow consumer disconnect availability on RAbbitMQ
Message-ID: <11EC96EC521B304EA05595E6F2987FC202A8AA4B@EXCHBAN.machcorp.lan>

Hello,

 

Do we have slow consumer detection available in RabbitMQ like we have in
Apache qpid ( Slow Consumer Disconnect (SCD) is a new feature in Qpid
that provides a configurable mechanism to prevent a single slow consumer
from causing a back up of unconsumed messages on the broker )

 

This is a very nice feature wherein we could identify and take
corrective actions against the consumer. Please suggest any alternative
method to achieve this behavior. Also when we identify SCD  can we defer
the queue for some time( timed defer) before it comes back to service
something like suspend Queue for 5 mins and try again.

 

Regds

Prashant

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/1825669e/attachment-0001.htm>

From prayadav at gmail.com  Tue Jan 25 13:30:23 2011
From: prayadav at gmail.com (Prashant)
Date: Tue, 25 Jan 2011 05:30:23 -0800 (PST)
Subject: [rabbitmq-discuss] Alternate Exchange Configuration Issue
In-Reply-To: <4D3DD915.4040102@rabbitmq.com>
References: <11EC96EC521B304EA05595E6F2987FC202A46124@EXCHBAN.machcorp.lan>
	<4D3DD915.4040102@rabbitmq.com>
Message-ID: <27c766c6-5925-4eae-8253-87c75fdec708@u18g2000prh.googlegroups.com>

Hi ,

the snippet you see is what I was referring to( from rabbitMQ site). I
have defined an exchange called 'exchange' and declared it with
arguments as in the code snippet.(groovy)

	exchangeName = 'exchange'; queueName = 'myQueue'
	args = new HashMap<String,Object>()
	args.put("alternate-exchange", "my-ae")
	channel.exchangeDeclare exchangeName, 'direct',false,false,args
	channel.exchangeDeclare "my-ae", "fanout"
	channel.queueDeclare "unrouted",false,false,false,null
	channel.queueDeclare queueName,false,false,false,null
	channel.queueBind "unrouted" , "my-ae" , ""
	channel.queueBind queueName, exchangeName, 'rKey'
Regds
Prashant

On Jan 24, 7:55?pm, Simon MacMullen <si... at rabbitmq.com> wrote:
> On 24/01/2011 7:33PM, Prashant Yadav wrote:
> ?> Am experiencing trouble when configuring alternate exchange for my
> ?> broker. I am following the docs present in rabbitmq site. The error am
> ?> getting is
> ?>
> ?> Caused by: com.rabbitmq.client.ShutdownSignalException: channel error;
> ?> reason:
> ?> {#method<channel.close>(reply-code=406,reply-text=PRECONDITION_FAILED -
> ?> inequivalent arg 'alternate-exchange' for exchange 'exchange' in vhost
> ?> '/': required {longstr,<<97,101>>}, received
> ?> undefined,class-id=40,method-id=10),null,""}
>
> Did you previously declare the exchange with a different alternate
> exchange? (Or none?) Every declaration of an exchange needs to have the
> same arguments.
>
> BTW I note that your error message references an exchange called
> "exchange" but your code references "my-direct".
>
> Cheers, Simon
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From D.Rotondi at Computer.Org  Tue Jan 25 14:03:45 2011
From: D.Rotondi at Computer.Org (Dom54)
Date: Tue, 25 Jan 2011 06:03:45 -0800 (PST)
Subject: [rabbitmq-discuss] Erlang crashes trying to allocate 583848200
	bytes of memory
In-Reply-To: <6afff39e-c2b7-4308-9f0e-08f1c6ad95ee@i32g2000pri.googlegroups.com>
References: <AANLkTi=g3xnOs5dyrMn2bopHLWNKuUrw2D4zfDiMS_n1@mail.gmail.com>,
	<AANLkTikN8jS=TM7jct5hQZQADTLWzTxg7Y_4LnmdggZC@mail.gmail.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC0C@EXCH-MBX-3.vmware.com>,
	<c61b3c40-2bcf-4532-9630-969512668aba@f30g2000yqa.googlegroups.com>
	<F78BCF638F95D74A99D036114107EDB5023948CC4F@EXCH-MBX-3.vmware.com>
	<0409a620-98fb-45e6-901f-a412d4dd4205@y2g2000prf.googlegroups.com>
	<4D3EA996.7090704@rabbitmq.com>
	<6afff39e-c2b7-4308-9f0e-08f1c6ad95ee@i32g2000pri.googlegroups.com>
Message-ID: <a6e30b5f-e859-4e7f-b507-68fd5e5f00b2@v31g2000pri.googlegroups.com>



On Jan 25, 12:44?pm, Dom54 <D.Roto... at Computer.Org> wrote:
Hi,
perhaps a good news. As announced we are trying to use the same
RabbitMQ version (the last stable one) with the last R14B01 Erlang
release.
The first stress tests seem to work.
We made 2 sets of tests (always using the same test code as indicated
in my previous replies and posted on the RabbitMQ forum), the 1st one
with vm_memory_high_watermark set to 0.25 and the 2nd one at its
default value 0.40.
Both tests seem to work (we run them under Windows Server 2008 R2 64
bit with a 4 GB VM).
In the 1st set we saw a used memory raising up to 512MB (0.25 of 2GB;
I think Erlang is always a 32 bit process, so its max usable address
space is always 2 GB) and them quickly dropping to around 200 MB. I
think the RabbitMQ flow-control mechanism was started and reduced the
pace of the subscriber.
In the 2nd case the memory raised till around 700 MB.

We will due further tests (and compare their speed with similar tests
using ActiveMQ) to finally check if the new Erlang release actually
solve the issue we repoterd.
Thanks to all for their hints and support.
Ciao
   Domenico

> On Jan 25, 11:44?am, Matthias Radestock <matth... at rabbitmq.com> wrote:
> Hi Matthias,
>
> > Dom,
>
> > Dom54 wrote:
> > > To our understanding the RabbitMQ broker (and its supporting
> > > Erlang environment) keeps to be delivered messages in memory; if the
> > > consumer is not fast enough the Erlang memory footprint grows till the
> > > broker crash.
>
> > The rabbit code does not hold on to messages in memory when it has
> > delivered them to consumers and it is under memory pressure.
>
> Thats what I stated above. In memory seems to be buffered only
> messages that have not been delivered.
>
>
>
> > But we do rely on the underlying erlang network stack and O/S to tell us
> > when it can't send messages to the consumers. Rather than, say, blindly
> > buffering them. It's possible that therein lies the problem on Windows.
>
> > Btw, when you tweaked the vm_memory_high_watermark settings, did you
> > check that they were actually taking effect? There is a message near the
> > beginning of the rabbit log file indicating how much memory it is trying
> > to limit itself to.
>
> Yes we checked the tweak effect in the log file and the log file
> reflects the setting.
> BTW we have just completed another test using a Windows Server 2008 R2
> 64 bit version on a vM with 4 BG RAM, and the problem is still there.
> We are now trying using the last Erlang release (R14B01) instead of
> the R13B03 included in the RabbitMQ distribution, hoping this release
> has fixed some of the problems.
> Thanks, ciao
> ? ?Dom
>
>
>
> > Regards,
>
> > Matthias.
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From prayadav at gmail.com  Tue Jan 25 14:24:02 2011
From: prayadav at gmail.com (Prashant)
Date: Tue, 25 Jan 2011 06:24:02 -0800 (PST)
Subject: [rabbitmq-discuss] Alternate Exchange Configuration Issue
In-Reply-To: <27c766c6-5925-4eae-8253-87c75fdec708@u18g2000prh.googlegroups.com>
References: <11EC96EC521B304EA05595E6F2987FC202A46124@EXCHBAN.machcorp.lan>
	<4D3DD915.4040102@rabbitmq.com>
	<27c766c6-5925-4eae-8253-87c75fdec708@u18g2000prh.googlegroups.com>
Message-ID: <3641b25c-8f42-4c8f-8b9d-f886e67911a1@k21g2000prb.googlegroups.com>

Hi ,

My bad . I had declared the exchange in the producer and did not
declare my alternate exchange there. Once I declared the exchange
properly unroutable messages were pushed to Alternate exchange.
I have a generic question though. In this scenario where I know all un
routable messages are in exchange ,can I somehow publish it back to my
original exchange( guess I need to simply use basicPublish with the
exchange name ) after a latency of somet time ?

My requirement as my earlier question in the forum is to tackle slow
consumers ( consumer that needs to perform some logic with remote
servers and there may be several reasons why the consumer can be
slow). I could either perform some checks to see if my remote server
is alive and then process the messages or use Lease Queue
approach.What I understood from the documentation is
1) Lease Queues
2) Per Queue TTL

Both of these approach  times out queue and message ( does that mean
all my  messages are lost or are they requed back in exchange ).
Please suggest.

Regds
Prashant

On Jan 25, 1:30?pm, Prashant <praya... at gmail.com> wrote:
> Hi ,
>
> the snippet you see is what I was referring to( from rabbitMQ site). I
> have defined an exchange called 'exchange' and declared it with
> arguments as in the code snippet.(groovy)
>
> ? ? ? ? exchangeName = 'exchange'; queueName = 'myQueue'
> ? ? ? ? args = new HashMap<String,Object>()
> ? ? ? ? args.put("alternate-exchange", "my-ae")
> ? ? ? ? channel.exchangeDeclare exchangeName, 'direct',false,false,args
> ? ? ? ? channel.exchangeDeclare "my-ae", "fanout"
> ? ? ? ? channel.queueDeclare "unrouted",false,false,false,null
> ? ? ? ? channel.queueDeclare queueName,false,false,false,null
> ? ? ? ? channel.queueBind "unrouted" , "my-ae" , ""
> ? ? ? ? channel.queueBind queueName, exchangeName, 'rKey'
> Regds
> Prashant
>
> On Jan 24, 7:55?pm, Simon MacMullen <si... at rabbitmq.com> wrote:
>
> > On 24/01/2011 7:33PM, Prashant Yadav wrote:
> > ?> Am experiencing trouble when configuring alternate exchange for my
> > ?> broker. I am following the docs present in rabbitmq site. The error am
> > ?> getting is
> > ?>
> > ?> Caused by: com.rabbitmq.client.ShutdownSignalException: channel error;
> > ?> reason:
> > ?> {#method<channel.close>(reply-code=406,reply-text=PRECONDITION_FAILED -
> > ?> inequivalent arg 'alternate-exchange' for exchange 'exchange' in vhost
> > ?> '/': required {longstr,<<97,101>>}, received
> > ?> undefined,class-id=40,method-id=10),null,""}
>
> > Did you previously declare the exchange with a different alternate
> > exchange? (Or none?) Every declaration of an exchange needs to have the
> > same arguments.
>
> > BTW I note that your error message references an exchange called
> > "exchange" but your code references "my-direct".
>
> > Cheers, Simon
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From cameron at cameronharris.org  Tue Jan 25 14:42:53 2011
From: cameron at cameronharris.org (Cameron Harris)
Date: Tue, 25 Jan 2011 14:42:53 +0000
Subject: [rabbitmq-discuss] Low message publish throughput
Message-ID: <AANLkTimvjJAKf4xKGtCYKRHrkLjKm+rCWFzADnOs=Ghf@mail.gmail.com>

Hi all,

I'm having problems achieving a high publish throughput with RabbitMQ 2.2.

I am using the .NET client on two Win7/64 desktops with Core 2 duos, and the
broker is running on RHEL5.6 (OTP R14B01) on a quad core Xeon blade, and the
link between the blade and the desktops is 1Gb/s ethernet.

I created a minimal publisher and consumer in .NET and ran one on each
machine. The consumer was able to receive more than 50 000 empty messages
per second, however the publisher was only able to publish 5000 empty
messages per second before maxing out my desktop's CPU. I ported the
publisher to Java, and that went up to 10 000 per second, which is better
but still not great. The network utilization is almost insignificant and the
broker's CPU usage was around 10% on one core. The bottleneck appears to be
CPU usage inside the RabbitMQ .NET library. I achieve at least 45MB/s
throughput in a single plain TCP connection from Win7 to the blade, so the
link is definitely not the problem.

I attached a profiler to my publisher and I found that more than 90% of the
CPU time was spent calling Flush in WriteFrame (called by BasicPublish). I
created an alternate non-flushing code path in the RabbitMQ for
BasicPublish, and the publishing speed went up to between 35 000 and 45 000
messages per second, and the messages still got to the client quickly.

Am I doing something incorrect? I presume the client flushes as soon as
possible to reduce latency, but in this case, I don't mind giving up some
latency to get better throughput, such as by only explicitly flushing once
every 50ms or something along these lines. Is there a way to support my
requirements with the RabbitMQ .NET library?

Thanks!
Cameron Harris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/b709fbc3/attachment.htm>

From jeffh at delasco.com  Tue Jan 25 15:55:05 2011
From: jeffh at delasco.com (Jeff Hinrichs)
Date: Tue, 25 Jan 2011 09:55:05 -0600
Subject: [rabbitmq-discuss] Exchange and queue naming conventions
In-Reply-To: <AANLkTimBXprF+Q=VtAd=W+-V1LaYwW-gmW3S8htPk7j4@mail.gmail.com>
References: <AANLkTikB3T8BPUDkrvRPd7OwrOQVX8fLrK0LAn-Ab3xZ@mail.gmail.com>
	<yrv4cbp36np8l.fsf@dwragg.eng.vmware.com>
	<AANLkTikOj3sbPq5_dwjD7B2TCgaW6=m0OHrgihg-bnV1@mail.gmail.com>
	<AANLkTimBXprF+Q=VtAd=W+-V1LaYwW-gmW3S8htPk7j4@mail.gmail.com>
Message-ID: <AANLkTikCrqKzFDG4sn2kEGa7M4mgsJ=Jho1kmMPtqa8b@mail.gmail.com>

On Tue, Jan 25, 2011 at 1:50 AM, Michael Klishin <
michael.s.klishin at gmail.com> wrote:

> 2011/1/25 Bill Moseley <moseley at hank.org>
>
>> I do think it makes sense to use the dotted notation, and then use topic
>> queues as that makes for very flexible routing options.  I was wondering if
>> anyone had worked out some "best practices" over time that would be useful
>> as we start to add more tasks.
>>
>
> 1+ year and several apps later I see the following pattern developing on my
> team:
>
> 1. Exchanges are declared by producers.
> 2. Queues are declared and bound by consumers.
> 3. In vast majority of cases, consumers are "smart" and producers are very
> dumb: they just put messages in well-known places. Consumers
>     are "smart" in a sense that they almost always keep some persistent
> state (in Redis, for example), while producers are just monitored in case
> they crash.
> 4. Exchanges are named using the following pattern
> $prefix.$applications_group.$app.$environment. For example,
> megacorp.mail_delivery.shaper.qa or
> megacorp.search.online_indexer.production. It works well with multiple
> installations and if you want to route some data to your
> customers/partners/archive.
>
> Also, it becomes increasingly obvious that many exchanges and bindings
> would be unnecessary if we begin to use default exchange more.
>
>
>
>> BTW -- in that case can I configure binding for three queues:
>>  *.qa.rotate_image. *.production.rotate_image, and then a third for all
>> except "qa" a and "production"?
>>
>
> "Except" case is not handled by AMQP very well (not in 0.9.1 I am most
> familiar with, anyway). Maybe *.other.rotate_image would be good enough?
>
>
> Finally, I'm still a bit confused when to create new exchanges (assuming
>> all the same type).  Just trying to get some basic guidelines.  Is there any
>> overhead with using more exchanges vs. just more bindings on the same
>> exchange?  Is is common to use separate exchanges for grouping consumers
>> (i.e. an exchange for report queues and another exchange for image
>> manipulation queues)?
>>
>
>
> Unless you have thousands of them on a small box, it probably does not make
> much difference. For support cases, dealing with apps that use 150 exchanges
> may be significantly more difficult than if they were using just 3, though.
>
> Hope this helps.
> --
> MK
>
>
That was very helpful, thank you.  I am very interested if others concur or
have differing wisdom?

Best,

Jeff
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/3e1ac7cc/attachment-0001.htm>

From dtenenba at fhcrc.org  Tue Jan 25 18:22:44 2011
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Tue, 25 Jan 2011 10:22:44 -0800
Subject: [rabbitmq-discuss] Making sure a message gets to every consumer
In-Reply-To: <5393_1295911102_4D3E08BE_5393_533944_1_4D3E0885.2060506@rabbitmq.com>
References: <AANLkTinPU2EhHXhCUm+Wkzj4gKBH4zir-p7GY77X1_wm@mail.gmail.com>
	<4D3E05F8.10509@wetafx.co.nz>
	<5393_1295911102_4D3E08BE_5393_533944_1_4D3E0885.2060506@rabbitmq.com>
Message-ID: <AANLkTi=fdgwKizYDcmQ=P=-xGgbn9ajc2fBh-RX05O=s@mail.gmail.com>

On Mon, Jan 24, 2011 at 3:17 PM, Matthias Radestock
<matthias at rabbitmq.com>wrote:

> Sam Duncan wrote:
>
>> If you use a topic exchange and create a queue for each consumer, you get
>> a copy of each message in each queue filtered by your queue bindings.
>>
>
I tried this, but it still didn't seem to work.


>
> A direct exchange would probably work too, unless you need bindings with
> wildcards.
>
> If you haven't done so already, I recommend reading
> http://www.rabbitmq.com/tutorial-three-python.html
>
>
I have read this, thanks.

Here is an attempt that uses two fanout exchanges and two queues, one bound
to each exchange with '#'. You would think (well, I would think) that any
message sent to either of these fanout exchanges is going to go to every
consumer of every queue bound to the appropriate exchange.

However, what happens in practice is only one receiver at a time gets a
message.

Fire up two (or more) instances of app2.py and then run app1.py (which
currently just sends a message and exits). How can I change this so that all
the instances of app2.py receive all messages sent through the
'from_web_exchange'?

app1.py:
#!/usr/bin/env python
import pika

connection = pika.AsyncoreConnection(pika.ConnectionParameters(
        host='localhost'))
channel = connection.channel()


from_web_exchange =
channel.exchange_declare(exchange="from_web_exchange",type="fanout")
from_worker_exchange =
channel.exchange_declare(exchange="from_worker_exchange", type='fanout')

from_builders_queue = channel.queue_declare(queue='frombuilders',
auto_delete=True)
from_web_queue = channel.queue_declare(queue='fromweb', auto_delete=True)
channel.queue_bind(exchange='from_web_exchange', queue=from_web_queue.queue,
routing_key="#")
channel.queue_bind(exchange='from_worker_exchange',
queue=from_builders_queue.queue, routing_key="#")

channel.basic_publish(exchange='from_web_exchange',
                      routing_key='does_it_matter',
                      body='Hello World!')
print " [x] Sent 'Hello World!'"
connection.close()

app2.py:
#!/usr/bin/env python
import pika
import sys

connection = pika.AsyncoreConnection(pika.ConnectionParameters(
        host='localhost'))
channel = connection.channel()



from_web_exchange =
channel.exchange_declare(exchange="from_web_exchange",type="fanout")
from_worker_exchange =
channel.exchange_declare(exchange="from_worker_exchange", type='fanout')

from_builders_queue = channel.queue_declare(queue='frombuilders',
auto_delete=True)
from_web_queue = channel.queue_declare(queue='fromweb', auto_delete=True)
channel.queue_bind(exchange='from_web_exchange', queue=from_web_queue.queue,
routing_key="#")
channel.queue_bind(exchange='from_worker_exchange',
queue=from_builders_queue.queue, routing_key="#")


#channel.queue_declare(queue='hello')

print ' [*] Waiting for messages. To exit press CTRL+C'

arg = "No-arg"
#print len(sys.argv)
if (len(sys.argv) == 2):
    arg = sys.argv[1]


def callback(ch, method, properties, body):
    print " [x] Received %r" % (body,)
    channel.basic_publish(exchange='from_worker_exchange',
                          routing_key="#", # key.frombuilders
                          body= arg + " python approves of " + body)


channel.basic_consume(callback,
                      queue=from_web_queue.queue,
                      no_ack=True)

pika.asyncore_loop()


Thanks in advance,
Dan

Regards,
>
> Matthias.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/3b5ecbc6/attachment.htm>

From majek04 at gmail.com  Tue Jan 25 18:35:28 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Tue, 25 Jan 2011 18:35:28 +0000
Subject: [rabbitmq-discuss] Making sure a message gets to every consumer
In-Reply-To: <AANLkTi=fdgwKizYDcmQ=P=-xGgbn9ajc2fBh-RX05O=s@mail.gmail.com>
References: <AANLkTinPU2EhHXhCUm+Wkzj4gKBH4zir-p7GY77X1_wm@mail.gmail.com>
	<4D3E05F8.10509@wetafx.co.nz>
	<5393_1295911102_4D3E08BE_5393_533944_1_4D3E0885.2060506@rabbitmq.com>
	<AANLkTi=fdgwKizYDcmQ=P=-xGgbn9ajc2fBh-RX05O=s@mail.gmail.com>
Message-ID: <AANLkTi=Ajr3LG7PrD7C9MT=ecgMzQJDC_XUO+GrzVmgv@mail.gmail.com>

On Tue, Jan 25, 2011 at 18:22, Dan Tenenbaum <dtenenba at fhcrc.org> wrote:
>> If you haven't done so already, I recommend reading
>> http://www.rabbitmq.com/tutorial-three-python.html
>>
>
> I have read this, thanks.
> Here is an attempt that uses two fanout exchanges and two queues, one bound
> to each exchange with '#'. You would think (well, I would think) that any
> message sent to either of these fanout exchanges is going to go to every
> consumer of every queue bound to the appropriate exchange.

If N messages go to the queue, exactly N messages will go out, no
matter how many consumers are hanging on that queue.

If N messages go to the exchange, any number may go out, depending on bindings.

Exchanges - broadcast.
Queues - buffering.

> However, what happens in practice is only one receiver at a time gets a
> message.

You need to have exactly as many queues as many copies of the message
you'd like to receive.

Once again: a message distributed to queue will not be copied to
multiple consumers. It will
be distributed to a single consumer only.

Cheers,
 Marek

From dtenenba at fhcrc.org  Tue Jan 25 18:45:26 2011
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Tue, 25 Jan 2011 10:45:26 -0800
Subject: [rabbitmq-discuss] Making sure a message gets to every consumer
In-Reply-To: <AANLkTi=Ajr3LG7PrD7C9MT=ecgMzQJDC_XUO+GrzVmgv@mail.gmail.com>
References: <AANLkTinPU2EhHXhCUm+Wkzj4gKBH4zir-p7GY77X1_wm@mail.gmail.com>
	<4D3E05F8.10509@wetafx.co.nz>
	<5393_1295911102_4D3E08BE_5393_533944_1_4D3E0885.2060506@rabbitmq.com>
	<AANLkTi=fdgwKizYDcmQ=P=-xGgbn9ajc2fBh-RX05O=s@mail.gmail.com>
	<AANLkTi=Ajr3LG7PrD7C9MT=ecgMzQJDC_XUO+GrzVmgv@mail.gmail.com>
Message-ID: <AANLkTikj2H=z2rE9NqNfj7EB1EkLYtSJvNjewNaep21t@mail.gmail.com>

On Tue, Jan 25, 2011 at 10:35 AM, Marek Majkowski <majek04 at gmail.com> wrote:

> On Tue, Jan 25, 2011 at 18:22, Dan Tenenbaum <dtenenba at fhcrc.org> wrote:
> >> If you haven't done so already, I recommend reading
> >> http://www.rabbitmq.com/tutorial-three-python.html
> >>
> >
> > I have read this, thanks.
> > Here is an attempt that uses two fanout exchanges and two queues, one
> bound
> > to each exchange with '#'. You would think (well, I would think) that any
> > message sent to either of these fanout exchanges is going to go to every
> > consumer of every queue bound to the appropriate exchange.
>
> If N messages go to the queue, exactly N messages will go out, no
> matter how many consumers are hanging on that queue.
>
> If N messages go to the exchange, any number may go out, depending on
> bindings.
>
> Exchanges - broadcast.
> Queues - buffering.
>
>
I think I understand this. That's why in my code, I publish messages to an
exchange, not a queue.

I am looking at the python example 3 code on the rabbitmq site (
http://www.rabbitmq.com/tutorial-three-python.html). If I run this code on
my own machine, with multiple instances of receive_logs.py, it works as I
would like my own code to work: each instance of receive_logs.py gets a copy
of each message sent by emit_logs.py.

I got my code to work by using an un-named exclusive queue in each receiver:

from_builders_queue = channel.queue_declare(exclusive=True)
from_builders_queue_name = from_builders_queue.queue

from_web_queue = channel.queue_declare(exclusive=True)
from_web_queue_name = from_web_queue.queue

channel.queue_bind(exchange='from_web_exchange', queue=from_web_queue_name)
channel.queue_bind(exchange='from_worker_exchange',
queue=from_builders_queue_name)




> > However, what happens in practice is only one receiver at a time gets a
> > message.
>
> You need to have exactly as many queues as many copies of the message
> you'd like to receive.
>
> Once again: a message distributed to queue will not be copied to
> multiple consumers. It will
> be distributed to a single consumer only.
>
>
Thanks for your help.
Dan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/8d44229e/attachment-0001.htm>

From mrkafk at gmail.com  Tue Jan 25 20:25:59 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Tue, 25 Jan 2011 21:25:59 +0100
Subject: [rabbitmq-discuss] Extremely slow responses
In-Reply-To: <AANLkTin_pF5uDHb6tiF6LBU7V4kBx3pYHqaFy6eEL1TJ@mail.gmail.com>
References: <4D3DDE50.4070108@gmail.com>
	<AANLkTin_pF5uDHb6tiF6LBU7V4kBx3pYHqaFy6eEL1TJ@mail.gmail.com>
Message-ID: <4D3F31D7.7090008@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Marek Majkowski wrote:

Thanks to everyone for replies!

I rewrote rpc server and client from scrach, accounting for feedback I
received it mostly works now.

> And the last thing: clustering != HA.
> Clustering doesn't mean that the messages are replicated.
> Every queue 'lives' on a single node, if that node goes down,
> that queue goes down.

Absolutely, this is why I will implement my own (Postgres) serial
transaction id in RPC server to know when the node has its data out of
sync with other nodes.

(disclosure: you may view it as strange, but all I needed really was RPC
+ basic multi-master replication for PG for data redundancy, not
performance, and in testing I found that unfortunately none of the
existing solutions fits the bill for production-readiness, including
pgpool-II unfortunately).


- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNPzHXAAoJEFMgHzhQQ7hOqH0H/Agrcbmqj2Ttfs5q7YOCl5W1
9I4FNSeZ62a11Wf8qhP0ITGsnba1PzO9zmdYN2EWreZzW/mtzI9RO7D7jn8LzpIU
pt+EvmiPTurSDhvab/KcOs5h5/z0fp2dUSUK5X4F99wYmizGfh8CVWo118TJghGn
J5QKrCxao/NEmNoFEu99p3L1kBelHF9A0TpdMoxY1G1uvJ7vQ/S8L4bbedKU1fR3
TE91uMjaujG2gSxakGOZFinA+oaMFeb7Y0fvL1sZtjzXLT90B8nvklINX5UrdnOR
48t5Z81jcrENYZYyFrSFji+L034adqWn9yxyX5fNM4T176QFohSHPvsnedARKlU=
=haU3
-----END PGP SIGNATURE-----

From mrkafk at gmail.com  Tue Jan 25 20:36:58 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Tue, 25 Jan 2011 21:36:58 +0100
Subject: [rabbitmq-discuss] (pika) slow asyncore loop?
Message-ID: <4D3F346A.2030106@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


Apparently I'm having RPC responses coming back to client before
asyncore loop in pika can react. It reacts later, but slowly, like 20-30
seconds later than callbacks happen.

Setup: rpc client sends a message to fanout exchange, gets 3 replies
from 3 servers back. That is not a problem.

The thing is, callbacks apparently happen before asyncore loop can do
another iteration.

Loop:

while respnum < servnum:
        pika.asyncore_loop(count=1)
        respnum += 1
        print 'respnum', respnum, 'at',
datetime.datetime.now().strftime('%H:%S')


Output from client:
 . sending  hello 20:23 at 20:23
#### (below is callback output ####
 . recvd  echo: hello 20:23 at 20:23
 . recvd  echo: hello 20:23 at 20:23
 . recvd  echo: hello 20:23 at 20:23
#### below there's output produced while exiting and entering asyncore
loop ####
respnum 1 at 20:23
respnum 2 at 20:53
respnum 3 at 20:23

2nd iteration of asyncore loop happened 20 seconds later than callback
(. recvd) happened.

Is there any way to deal with it, other than rather naive solutions like
delaying basic_publish in server?



Server code:

http://pastie.org/pastes/1497146/text

Client code:

http://pastie.org/pastes/1497144/text

- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNPzRqAAoJEFMgHzhQQ7hO/IQH/3F6LtLungt7tj3j5DD8tICe
CYr7LppIFPUrWiVialnhai2OaQNzM217Fexd7SGAhW90ixX7Bl3n5n7Rq0CgjyGn
h92/N4AlyqeXxQvhefgBtt54TXHMpgMhJcyqzOBh6B/pxEia5MjeNLIWf6KwJwmH
aiv4FjJsN3Ba6GrVhhM2r2WoYj17mTN9jZg+RA29KrMINW3q9isJUy005uMJ+kn2
Liy4Fs/iOctMH0npdQaANL8zjfYbd5i7DGbn4Z/u1i5dvZ5ZHH4oJiswzqRPlxSz
P8k0n0F8xSCLWxWUBOx6sWO2p7L+0tG4cGkWrSjI4/dELUKbEbwmSukS60+bXWY=
=vzB/
-----END PGP SIGNATURE-----

From arun.suresh at gmail.com  Tue Jan 25 20:41:03 2011
From: arun.suresh at gmail.com (Arun Suresh)
Date: Tue, 25 Jan 2011 12:41:03 -0800
Subject: [rabbitmq-discuss] regarding supervisor2
In-Reply-To: <20110125110040.GB8077@rabbitmq.com>
References: <AANLkTimRBijLV8YhqBG_YCh=BbpuHUNVmZcycftdeyst@mail.gmail.com>
	<20110125110040.GB8077@rabbitmq.com>
Message-ID: <AANLkTi=w7YKa4uFoOFKQzQN0bQ0-Xf-H98uJiVRx-Rcn@mail.gmail.com>

Thanks Matthew..

In the meantime.. i guess ill make local modifications and plop it in my
codebase..

-Arun

On Tue, Jan 25, 2011 at 3:00 AM, Matthew Sackman <matthew at rabbitmq.com>wrote:

> Howdy,
>
> On Mon, Jan 24, 2011 at 04:56:55PM -0800, Arun Suresh wrote:
> > Ive been playing around with supervisor2 which you guys ship with
> rabbitmq
> > server. The delayed restart is seriously a life saver.
>
> Glad you like it.
>
> > The only minor issue ive had with it is:
> > Once the process has exceeded MaxT and MaxR, you guys spawn a timer
> thread
> > to restart the process after the specified delay.. During this period,
> the
> > process is actually dead. but supervisor:which_children still returns a
> > stale Pid. Any reason why inside the do_restart method, once the restart1
> > method returns a {terminate, NState} , state_del_child() is NOT called ?
>
> From memory, no reason at all, and I think it would be an improvement
> for it to do the del_child sooner rather than later and thus not return
> the stale pid. Slight complexities with simple_* supervisors possibly -
> can't remember - it's been a while since I looked at that code. I'll
> take a look and most likely file a bug.
>
> Best wishes,
>
> Matthew
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110125/94ab43cf/attachment.htm>

From mrkafk at gmail.com  Tue Jan 25 20:44:41 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Tue, 25 Jan 2011 21:44:41 +0100
Subject: [rabbitmq-discuss] publish to empty exchange works,
 while publish to correct exchange doesn't
Message-ID: <4D3F3639.1090301@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hello everyone,

Yes, it's RPC time again. ;-)

In client:

chan.exchange_declare(exchange = rpc_res_exch,type='direct')
chan.queue_declare(queue = myqueue)
chan.queue_bind(exchange = rpc_res_exch, queue = myqueue)


Now, when I do in server:

ch.basic_publish(
    exchange = '',
    properties = pika.BasicProperties(correlation_id =
props.correlation_id + '_' + mynode),
    routing_key = props.reply_to,
    body = str(response))

... messages get delivered to 'myqueue'.

But when I do:

ch.basic_publish(
    exchange = rpc_res_exch,
    properties = pika.BasicProperties(correlation_id =
props.correlation_id + '_' + mynode),
    routing_key = props.reply_to,
    body = str(response))

... messages do NOT get delivered to the queue.

I checked with rabbitmqctl list_queues (it should show number of
messages in queue next to queue name, right?)


Can anyone please explain this mystery to me?




Server code:

http://pastie.org/pastes/1497146/text

Client code:

http://pastie.org/pastes/1497144/text





- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNPzY5AAoJEFMgHzhQQ7hOPukH/1b/vgYnUh0raxBZI7iBSJVe
dJqGQIU2thBGKoklNVvVqGU8CBs706q3mgf53Fpxx8QMBUle9TyeJ3jdVuPKRnP7
Nvy+XL6Jqtg9FbWXThim/pgLcvBs1FgVxwlPs/kRnK6B/b0IyyUzrqDUoWBxzKBN
Epenj62QCyOPwOvGeCcAlbwba2O0ds7IuOinj7nFkbFu+PojP1DPvj5eQ4UUoI/h
GXqlbJbxi3+Rt3b4pR7hx/Jf3/Ya4TYIM4sxGikMpl6nNHV8y7cqQyikZ1iBoeJU
+0+BXFj/DEEcjnMTi8aty+/tY4xB7G/osYsBURfWprHg9OE8EoNYpor3/M7JdKU=
=y55B
-----END PGP SIGNATURE-----

From kaiduanx at gmail.com  Wed Jan 26 04:24:52 2011
From: kaiduanx at gmail.com (Kaiduan Xie)
Date: Tue, 25 Jan 2011 23:24:52 -0500
Subject: [rabbitmq-discuss] Massive distributed pub/sub system
Message-ID: <AANLkTikD2fMdS_sdc8cRvEWCQeyL2PyP7KVFf5ncwXme@mail.gmail.com>

Hi,

I am a newbie on AMQP and RabbitMQ, and have a distributed pub/sub
problem to be solved with the following requirements,

1) Any user can subscribe to the interested topic, but only topic
owner can publish message to the group. There is no limit on the
number of subscribers in each group. Potentially it can be huge, for
example, the fans of U2 around the world.

2) User including subscriber and publisher is not always connected to
the system, and not always connected to the same node in the system,
and the message delivery should be guaranteed. When publisher
publishes a message, the system should deliver the message to all
subscribers. If the subscriber is connected to the system, the message
should be delivered immediately. If the subscriber is not connected,
system should hold the message, and the next time the user comes
connected, system will deliver the message to the user. Just imagine
the user can be any mobile user and moves out of cellular coverage.

3) The system should be able to support tens to hundreds of millions
users spreading around the world, so the system will consist hundred
of nodes located in different physical locations.

4) The number of topics/groups in the system is unlimited.

5) As to the latency, it should be in the range of 1 minute if
subscriber is connected.

It looks like RabbitMQ already has functionalities to meet the above
requirement, for example, fan out exchange, and persistent message.
The following is my understanding on how to build the above system
with RabbitMQ,

a) Publisher creates an exchange. For example, U2 creates an exchange
noted as "U2" for "U2's next world wide tour" on Node 1.

b) Each subscriber creates a queue in the system. For example, Alice
creates a queue noted as "Alice" on Node 2 and binds to exchange U2;
and Bob creates a queue noted as "Bob" on Node 3 and binds to exchange
"U2" on Node 2.

c) U2 publishes a message, m1 on Node 1 to exchange "U2"; and RabbitMQ
will deliver the message m1 to queue "Alice" on Node 2 and to queue
"Bob" on Node 3.

How we handles the following scenarios?

1) When U2 wants to publish a message, but Node 1 is done.

2) When message m1 is delivered to queue "Alice" on Node 2, Node 2
crashed or the network link between Node 1 (publisher's node) is
disconnected? Will exchange "U2" on Node 1 persist the message?

3) After message m1 is arrived on queue "Alice", but the connection
between Alice and Node 2 is gone, the message will be stored on Node
2, right? Next time, Alice connects to the system, but she is
connected to Node n instead of Node 2, how to handle this?

4) What is the multi-cast technology used in RabbitMQ to deliver the
message to queues located on different locations spreading around
different countries?

My understanding of AMQP and RabbitMQ is very limited, so please
forgive me if something is wrong or naive. Please share your thought
and experience on this, thanks a lot for helping out.

Best regards,

/Kaiduan

From emile at rabbitmq.com  Wed Jan 26 11:36:43 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Wed, 26 Jan 2011 11:36:43 +0000
Subject: [rabbitmq-discuss] Low message publish throughput
In-Reply-To: <AANLkTimvjJAKf4xKGtCYKRHrkLjKm+rCWFzADnOs=Ghf@mail.gmail.com>
References: <AANLkTimvjJAKf4xKGtCYKRHrkLjKm+rCWFzADnOs=Ghf@mail.gmail.com>
Message-ID: <4D40074B.1020608@rabbitmq.com>


Hi Cameron,

On 25/01/11 14:42, Cameron Harris wrote:

> I attached a profiler to my publisher and I found that more than 90% of
> the CPU time was spent calling Flush in WriteFrame (called by
> BasicPublish). I created an alternate non-flushing code path in the
> RabbitMQ for BasicPublish, and the publishing speed went up to between
> 35 000 and 45 000 messages per second, and the messages still got to the
> client quickly.

I would advise caution when removing the flush. Synchronous methods 
during AMQP connection establishment can timeout and cause failure 
unless the stream is flushed.

I'd be interested to know whether disabling the socket nodelay option 
has any impact on your test. This would be another way of obtaining a 
different latency/throughput trade-off.


Regards

Emile


From majek04 at gmail.com  Wed Jan 26 11:52:34 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Wed, 26 Jan 2011 11:52:34 +0000
Subject: [rabbitmq-discuss] (pika) slow asyncore loop?
In-Reply-To: <4D3F346A.2030106@gmail.com>
References: <4D3F346A.2030106@gmail.com>
Message-ID: <AANLkTi=5pzuFQK=4rjoXZWGOFef7Uy3h82jq87OaKssF@mail.gmail.com>

> The thing is, callbacks apparently happen before asyncore loop can do
> another iteration.
>
> Loop:
>
> while respnum < servnum:
> ? ? ? ?pika.asyncore_loop(count=1)
> ? ? ? ?respnum += 1
> ? ? ? ?print 'respnum', respnum, 'at',
> datetime.datetime.now().strftime('%H:%S')

This loop is plain wrong. During one asyncore_loop anything can happen.
You can't assume that you received a message. You could
have received a single packet, or a timeout, or yet something
else.

I'm afraid the only way to check if you really received a message
is to create some side effet in basic_consume callback.
And use this side effect as a condition for this loop.
Just like the 6th tutorial does.

> 2nd iteration of asyncore loop happened 20 seconds later than callback
> (. recvd) happened.

Sounds like some kind of timeout, isn't it?

> Is there any way to deal with it, other than rather naive solutions like
> delaying basic_publish in server?

Somehow the 6th tutorial works.

Cheers,
   Marek

From cameron at cameronharris.org  Wed Jan 26 12:27:01 2011
From: cameron at cameronharris.org (Cameron Harris)
Date: Wed, 26 Jan 2011 12:27:01 +0000
Subject: [rabbitmq-discuss] Low message publish throughput
In-Reply-To: <4D40074B.1020608@rabbitmq.com>
References: <AANLkTimvjJAKf4xKGtCYKRHrkLjKm+rCWFzADnOs=Ghf@mail.gmail.com>
	<4D40074B.1020608@rabbitmq.com>
Message-ID: <AANLkTimQ922xyE_zprmCk4ND0X3vtcejWHnX=KCpE0ML@mail.gmail.com>

Hi Emile,

When I removed the flush, I added an alternate code path so that flushing
would only be disabled when called via BasicPublish, and that initiation
would still explicitly flush. I initially just commented out the flush, but
as you suggested, the connection initiation just failed due to a timeout.
Unfortunatey, the problem with just hacking out publish flushing is that
sometimes messages will just sit there forever until something forces them
out, which could clearly cause a deadlock if your systems ended up waiting
on each other. It also caused problems when closing the connection to the
broker. I'm guessing that all publish messages need to have been flushed
before the library tries to do something else (e.g. a TxCommit or other
control messages)? Plus, manually hacking up the RabbitMQ library isn't
really a path I want to go down, since it'll make upgrading it far more
difficult.

I just commented out the line where it sets socket nodelay, and it increased
publish to about 9-10k messages per second on the Win7 system, which is a
nice improvement. Is there anywhere I can configure this with the standard
client library, rather than building my own with it hacked out? The Java
client had a way of overriding the socket factory function.

I think the throughput is still being held back significantly by the
explicit flushing. It'd still be nice if we could not flush after every
publish or manually take control over when publish flushes occur while still
maintaining stability of the library/connection. Are there any plans
regarding the flushing behavior, or is Rabbit's primary focus going to be
strictly low latency over high throughput?

Thanks for your help,
Cameron Harris


On 26 January 2011 11:36, Emile Joubert <emile at rabbitmq.com> wrote:

>
> Hi Cameron,
>
>
> On 25/01/11 14:42, Cameron Harris wrote:
>
>  I attached a profiler to my publisher and I found that more than 90% of
>> the CPU time was spent calling Flush in WriteFrame (called by
>> BasicPublish). I created an alternate non-flushing code path in the
>> RabbitMQ for BasicPublish, and the publishing speed went up to between
>> 35 000 and 45 000 messages per second, and the messages still got to the
>> client quickly.
>>
>
> I would advise caution when removing the flush. Synchronous methods during
> AMQP connection establishment can timeout and cause failure unless the
> stream is flushed.
>
> I'd be interested to know whether disabling the socket nodelay option has
> any impact on your test. This would be another way of obtaining a different
> latency/throughput trade-off.
>
>
> Regards
>
> Emile
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110126/a1d24c5d/attachment.htm>

From emile at rabbitmq.com  Wed Jan 26 12:51:02 2011
From: emile at rabbitmq.com (Emile Joubert)
Date: Wed, 26 Jan 2011 12:51:02 +0000
Subject: [rabbitmq-discuss] Low message publish throughput
In-Reply-To: <AANLkTimQ922xyE_zprmCk4ND0X3vtcejWHnX=KCpE0ML@mail.gmail.com>
References: <AANLkTimvjJAKf4xKGtCYKRHrkLjKm+rCWFzADnOs=Ghf@mail.gmail.com>	<4D40074B.1020608@rabbitmq.com>
	<AANLkTimQ922xyE_zprmCk4ND0X3vtcejWHnX=KCpE0ML@mail.gmail.com>
Message-ID: <4D4018B6.7090403@rabbitmq.com>


Hi Cameron,

On 26/01/11 12:27, Cameron Harris wrote:

> I just commented out the line where it sets socket nodelay, and it
> increased publish to about 9-10k messages per second on the Win7 system,
> which is a nice improvement. Is there anywhere I can configure this with
> the standard client library, rather than building my own with it hacked
> out? The Java client had a way of overriding the socket factory function.

Not at present. We plan to improve the library so that setting socket 
options becomes easy, but until then you will need to modify the sources.

> I think the throughput is still being held back significantly by the
> explicit flushing. It'd still be nice if we could not flush after every
> publish or manually take control over when publish flushes occur while
> still maintaining stability of the library/connection. Are there any
> plans regarding the flushing behavior, or is Rabbit's primary focus
> going to be strictly low latency over high throughput?

Your use-case will probably benefit if flushes only occurred for 
synchronous AMQP methods. The current behaviour was motivated more by 
reliability than latency. It should be possible to maintain that 
reliability by restricting flushing to synchronous methods though. I 
will file a bug for this.


Regards

Emile

From matthew at rabbitmq.com  Wed Jan 26 13:10:22 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Wed, 26 Jan 2011 13:10:22 +0000
Subject: [rabbitmq-discuss] regarding supervisor2
In-Reply-To: <AANLkTi=w7YKa4uFoOFKQzQN0bQ0-Xf-H98uJiVRx-Rcn@mail.gmail.com>
References: <AANLkTimRBijLV8YhqBG_YCh=BbpuHUNVmZcycftdeyst@mail.gmail.com>
	<20110125110040.GB8077@rabbitmq.com>
	<AANLkTi=w7YKa4uFoOFKQzQN0bQ0-Xf-H98uJiVRx-Rcn@mail.gmail.com>
Message-ID: <20110126131022.GA19295@rabbitmq.com>

On Tue, Jan 25, 2011 at 12:41:03PM -0800, Arun Suresh wrote:
> In the meantime.. i guess ill make local modifications and plop it in my
> codebase..

Sure. My modifications for this can be found at:

http://hg.rabbitmq.com/rabbitmq-server/file/bug23748/src/supervisor2.erl

Matthew

From robin at digininja.org  Wed Jan 26 16:44:42 2011
From: robin at digininja.org (Robin Wood)
Date: Wed, 26 Jan 2011 16:44:42 +0000
Subject: [rabbitmq-discuss] php talking to ruby
In-Reply-To: <4D39EE70.8030104@rabbitmq.com>
References: <AANLkTikwJPVV7jMDEeaS=jii-s3A4Lzc0roYsFkkX6rH@mail.gmail.com>
	<AANLkTiksJZHUYDVq-SAUA0w9sNgRo5F2vWHfYjU9X863@mail.gmail.com>
	<AANLkTimBg0kz11p1dSWWy+BX5DRtjzWEtUh-kwPFszid@mail.gmail.com>
	<4D39EE70.8030104@rabbitmq.com>
Message-ID: <AANLkTi=ah6nWiMsTNW_JT_QLjG+FuB-QjJTxuF-dwWdK@mail.gmail.com>

On 21 January 2011 20:37, Matthias Radestock <matthias at rabbitmq.com> wrote:
> On 21/01/11 20:23, Michael Klishin wrote:
>>
>> You don't have to use default queue parameters. Just specify them
>> explicitly.
>> Here are defaults amqp gem uses:
>>
>> durable = false
>> nowait ?= true
>> exclusive = false
>> auto_delete = false
>
> As an aside, no-wait is *not* a queue parameter. It is a general modifier
> present in most AMQP commands. See
> http://www.rabbitmq.com/amqp-0-9-1-reference.html#domain.no-wait
>

Been off on another project for a while so not going to get to look at
this again till next week. Thanks for the ideas and I'll go through
them properly when I have time.

Its a high priority job that has never made itself that high up.

Robin

From Sumit.Agarwal at ge.com  Wed Jan 26 17:33:53 2011
From: Sumit.Agarwal at ge.com (Agarwal, Sumit (GE Healthcare))
Date: Wed, 26 Jan 2011 12:33:53 -0500
Subject: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
Message-ID: <C5504C24B97DD448ACB994A683F011F60D4447C9@ALPMLVEM15.e2k.ad.ge.com>

Hi Alexis,
  Please let me know if you have any documentation on RabbitMQ
clustering across different M/C and using the HaProxy to do the load
balance and failover.
Regards
Sumit

From majek04 at gmail.com  Wed Jan 26 17:50:00 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Wed, 26 Jan 2011 17:50:00 +0000
Subject: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
In-Reply-To: <C5504C24B97DD448ACB994A683F011F60D4447C9@ALPMLVEM15.e2k.ad.ge.com>
References: <C5504C24B97DD448ACB994A683F011F60D4447C9@ALPMLVEM15.e2k.ad.ge.com>
Message-ID: <AANLkTimXS7PvfR8pXvNRHwzWMhj1eQc=PDtmDZbsgJob@mail.gmail.com>

On Wed, Jan 26, 2011 at 17:33, Agarwal, Sumit (GE Healthcare)
<Sumit.Agarwal at ge.com> wrote:
> ?Please let me know if you have any documentation on RabbitMQ
> clustering across different M/C and using the HaProxy to do the load
> balance and failover.

Hi,

I played with HaProxy some time ago and as far as I remember
it worked just fine with RabbitMQ.

The configuration I used was straightforward.
You need to make sure that the mode is
set to tcp (not http) and that timeouts are sane.

Cheers,
  Marek

From Sumit.Agarwal at ge.com  Wed Jan 26 17:50:56 2011
From: Sumit.Agarwal at ge.com (Agarwal, Sumit (GE Healthcare))
Date: Wed, 26 Jan 2011 12:50:56 -0500
Subject: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
In-Reply-To: <AANLkTimXS7PvfR8pXvNRHwzWMhj1eQc=PDtmDZbsgJob@mail.gmail.com>
References: <C5504C24B97DD448ACB994A683F011F60D4447C9@ALPMLVEM15.e2k.ad.ge.com>
	<AANLkTimXS7PvfR8pXvNRHwzWMhj1eQc=PDtmDZbsgJob@mail.gmail.com>
Message-ID: <C5504C24B97DD448ACB994A683F011F60D444808@ALPMLVEM15.e2k.ad.ge.com>

Thx I will try it out. 

-----Original Message-----
From: Marek Majkowski [mailto:majek04 at gmail.com] 
Sent: Wednesday, January 26, 2011 11:50 AM
To: Agarwal, Sumit (GE Healthcare)
Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy

On Wed, Jan 26, 2011 at 17:33, Agarwal, Sumit (GE Healthcare) <Sumit.Agarwal at ge.com> wrote:
> ?Please let me know if you have any documentation on RabbitMQ 
> clustering across different M/C and using the HaProxy to do the load 
> balance and failover.

Hi,

I played with HaProxy some time ago and as far as I remember it worked just fine with RabbitMQ.

The configuration I used was straightforward.
You need to make sure that the mode is
set to tcp (not http) and that timeouts are sane.

Cheers,
  Marek

From majek04 at gmail.com  Wed Jan 26 19:00:39 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Wed, 26 Jan 2011 19:00:39 +0000
Subject: [rabbitmq-discuss] publish to empty exchange works,
 while publish to correct exchange doesn't
In-Reply-To: <4D3F3639.1090301@gmail.com>
References: <4D3F3639.1090301@gmail.com>
Message-ID: <AANLkTi=nkAHiZ8UR5RXPOZ7a0gQcThmK_7C4n_OfrR_=@mail.gmail.com>

On Tue, Jan 25, 2011 at 20:44, Marcin Krol <mrkafk at gmail.com> wrote:
> Yes, it's RPC time again. ;-)
>
> In client:
>
> chan.exchange_declare(exchange = rpc_res_exch,type='direct')
> chan.queue_declare(queue = myqueue)
> chan.queue_bind(exchange = rpc_res_exch, queue = myqueue)
>
>
> Now, when I do in server:
>
> ch.basic_publish(
> ? ?exchange = '',
> ? ?properties = pika.BasicProperties(correlation_id =
> props.correlation_id + '_' + mynode),
> ? ?routing_key = props.reply_to,
> ? ?body = str(response))
>
> ... messages get delivered to 'myqueue'.
>
> But when I do:
>
> ch.basic_publish(
> ? ?exchange = rpc_res_exch,
> ? ?properties = pika.BasicProperties(correlation_id =
> props.correlation_id + '_' + mynode),
> ? ?routing_key = props.reply_to,
> ? ?body = str(response))
>
> ... messages do NOT get delivered to the queue.
>
> I checked with rabbitmqctl list_queues (it should show number of
> messages in queue next to queue name, right?)
>
>
> Can anyone please explain this mystery to me?

    chan.exchange_declare(exchange = rpc_res_exch,type='direct')
    chan.queue_declare(queue = myqueue)
    chan.queue_bind(exchange = rpc_res_exch, queue = myqueue)

When you bind to an exchange that is "direct" you must supply
a sane routing key (aka: binding key). More here:
http://www.rabbitmq.com/tutorial-four-python.html

Cheers,
  Marek

From Sumit.Agarwal at ge.com  Wed Jan 26 19:08:30 2011
From: Sumit.Agarwal at ge.com (Agarwal, Sumit (GE Healthcare))
Date: Wed, 26 Jan 2011 14:08:30 -0500
Subject: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
In-Reply-To: <C5504C24B97DD448ACB994A683F011F60D444808@ALPMLVEM15.e2k.ad.ge.com>
References: <C5504C24B97DD448ACB994A683F011F60D4447C9@ALPMLVEM15.e2k.ad.ge.com><AANLkTimXS7PvfR8pXvNRHwzWMhj1eQc=PDtmDZbsgJob@mail.gmail.com>
	<C5504C24B97DD448ACB994A683F011F60D444808@ALPMLVEM15.e2k.ad.ge.com>
Message-ID: <C5504C24B97DD448ACB994A683F011F60D444963@ALPMLVEM15.e2k.ad.ge.com>

Hi Marek,
 Do let me know if there is any problem with windows based cluster setup for RabbitMQ with the hostname contains "-" in the name like "32322-CDKS"?
Regards
Sumit

-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Agarwal, Sumit (GE Healthcare)
Sent: Wednesday, January 26, 2011 11:51 AM
To: Marek Majkowski
Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy

Thx I will try it out. 

-----Original Message-----
From: Marek Majkowski [mailto:majek04 at gmail.com]
Sent: Wednesday, January 26, 2011 11:50 AM
To: Agarwal, Sumit (GE Healthcare)
Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy

On Wed, Jan 26, 2011 at 17:33, Agarwal, Sumit (GE Healthcare) <Sumit.Agarwal at ge.com> wrote:
> ?Please let me know if you have any documentation on RabbitMQ 
> clustering across different M/C and using the HaProxy to do the load 
> balance and failover.

Hi,

I played with HaProxy some time ago and as far as I remember it worked just fine with RabbitMQ.

The configuration I used was straightforward.
You need to make sure that the mode is
set to tcp (not http) and that timeouts are sane.

Cheers,
  Marek
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From jon at jbrisbin.com  Wed Jan 26 19:16:10 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Wed, 26 Jan 2011 13:16:10 -0600
Subject: [rabbitmq-discuss] weird timeout declaring queue
Message-ID: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>

In testing the new Riak-based message persister I've been working on, I'm seeing a strange timeout happening that I'm not terribly sure how to troubleshoot.

When I start the broker and publish a message, everything goes through fine. I see all the functions being called like I'd expect (init, fetch, et al). When I re-run the Python script that publishes the test message, it appears to hang on the declare_queue step. I have to kill it with Ctl-C. The only function I see being called in my backing queue module is delete_and_terminate. I suspect I'm not returning something correctly but I'm not sure what that is.

I don't suppose there's a flowchart or somesuch on the internal path of publishing a message is there?

Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110126/00a9d900/attachment.htm>

From mark.geib at echostar.com  Wed Jan 26 21:00:11 2011
From: mark.geib at echostar.com (Mark Geib)
Date: Wed, 26 Jan 2011 14:00:11 -0700
Subject: [rabbitmq-discuss] client libraries compatibility
In-Reply-To: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>
Message-ID: <4D408B5B.7050403@echostar.com>


-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

We are currently running mostly 1.6.x rabbitmq brokers with 1.6.x
client libraries, both java and .net.

You are looking to migrate to the current broker, 2.2.x, but need some
suggestions on how to handle the client libraries.

We understand there are issues with 1.6.x clients working with 2.2.x
brokers, mostly .net. Also we have issues with the 2.2.x client
libraries working with the old 1.6.x brokers.

So, can we upgrade the clients to use later libraries that will work
with both 1.6.0 and 2.2.0 brokers.? Like 1.8.x ??

We are also hopping that we do not need to upgrade the brokers and
clients all at once, but rather upgrade clients, one at a time, then
the brokers....

All suggestions will be appreciated.
Mark.

- -- 
Principal Engineer
Cheyenne Software Engineering
mark.geib at echostar.com / 35-215

PGP fingerprint:6DFC 389D 9796 0188 92E5 58F5 34C5 6B47 D091 76FD
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iEYEARECAAYFAk1Ai1sACgkQNMVrR9CRdv0LXACeK+ran6d4PM3oRVbiMkgH6fWv
SU8An2497gmIu2p/KikyX04BOmc/xng8
=h+TA
-----END PGP SIGNATURE-----



From ronald at lomathan.de  Wed Jan 26 21:26:51 2011
From: ronald at lomathan.de (Ronald Fischer)
Date: Wed, 26 Jan 2011 22:26:51 +0100
Subject: [rabbitmq-discuss] Management Plugin and HTTPS
Message-ID: <DA59B75E81B3405FAD3FBA480C910088@Eremit>

I'm currently trying to have the management plugin be available via https
but can't get it running.

This is what I've tried so far:

[
        {rabbit, [
                {tcp_listeners, []},
                {ssl_listeners, [{"0.0.0.0",5672}]},
                {ssl_options, [{cacertfile,"/path/to/cacert.pem"},
                                {certfile,"/path/to/cert.pem"},
                                {keyfile,"/path/to/key.pem"},
                                {verify,verify_none},
                                {fail_if_no_peer_cert,false}]}
        ]},
        {rabbit_mochiweb, [
                {port,  55672},
                {ssl, true},
                {ssl_opts, [
                        {certfile,"/path/to/cert.pem"},
                        {keyfile,"/path/to/key.pem"}
                ]}
        ]}
].

That configuration is found at
https://github.com/mochi/mochiweb/blob/master/examples/https/https_store.erl
which refers to mochiweb, but doesn't seem to work with rabbit_mochiweb.
So is there a way to achieve access via https?

Kind regards
Ronald Fischer
 


From matthias at rabbitmq.com  Wed Jan 26 21:27:54 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Wed, 26 Jan 2011 21:27:54 +0000
Subject: [rabbitmq-discuss] client libraries compatibility
In-Reply-To: <4D408B5B.7050403@echostar.com>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>
	<4D408B5B.7050403@echostar.com>
Message-ID: <4D4091DA.8060902@rabbitmq.com>

Mark,

Mark Geib wrote:
> We are currently running mostly 1.6.x rabbitmq brokers with 1.6.x
> client libraries, both java and .net.
> 
> You are looking to migrate to the current broker, 2.2.x, but need some
> suggestions on how to handle the client libraries.
> 
> We understand there are issues with 1.6.x clients working with 2.2.x
> brokers, mostly .net. Also we have issues with the 2.2.x client
> libraries working with the old 1.6.x brokers.
> 
> So, can we upgrade the clients to use later libraries that will work
> with both 1.6.0 and 2.2.0 brokers.? Like 1.8.x ??

See http://www.rabbitmq.com/specification.html#release-version-mapping

In short:

- any version of any client we have ever released should work with a 
broker >= 2.2.0

- clients >= 2.2.0 will only work with brokers >= 2.2.0, except for the 
.net client which can speak to older brokers if configured to speak AMQP 
0-8.

I am curious what issues you are referring to regarding the 1.6.x .net 
client and 2.2.x brokers.


Regards,

Matthias.

From Sumit.Agarwal at ge.com  Wed Jan 26 21:29:34 2011
From: Sumit.Agarwal at ge.com (Agarwal, Sumit (GE Healthcare))
Date: Wed, 26 Jan 2011 16:29:34 -0500
Subject: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
In-Reply-To: <C5504C24B97DD448ACB994A683F011F60D444963@ALPMLVEM15.e2k.ad.ge.com>
References: <C5504C24B97DD448ACB994A683F011F60D4447C9@ALPMLVEM15.e2k.ad.ge.com><AANLkTimXS7PvfR8pXvNRHwzWMhj1eQc=PDtmDZbsgJob@mail.gmail.com><C5504C24B97DD448ACB994A683F011F60D444808@ALPMLVEM15.e2k.ad.ge.com>
	<C5504C24B97DD448ACB994A683F011F60D444963@ALPMLVEM15.e2k.ad.ge.com>
Message-ID: <C5504C24B97DD448ACB994A683F011F60D444B9C@ALPMLVEM15.e2k.ad.ge.com>

Hi Marek,
 I found the issue is with the different version of Erlang I installed on those m/c.
Thanks
Sumit

-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Agarwal, Sumit (GE Healthcare)
Sent: Wednesday, January 26, 2011 1:09 PM
To: Marek Majkowski
Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy

Hi Marek,
 Do let me know if there is any problem with windows based cluster setup for RabbitMQ with the hostname contains "-" in the name like "32322-CDKS"?
Regards
Sumit

-----Original Message-----
From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Agarwal, Sumit (GE Healthcare)
Sent: Wednesday, January 26, 2011 11:51 AM
To: Marek Majkowski
Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy

Thx I will try it out. 

-----Original Message-----
From: Marek Majkowski [mailto:majek04 at gmail.com]
Sent: Wednesday, January 26, 2011 11:50 AM
To: Agarwal, Sumit (GE Healthcare)
Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy

On Wed, Jan 26, 2011 at 17:33, Agarwal, Sumit (GE Healthcare) <Sumit.Agarwal at ge.com> wrote:
> ?Please let me know if you have any documentation on RabbitMQ 
> clustering across different M/C and using the HaProxy to do the load 
> balance and failover.

Hi,

I played with HaProxy some time ago and as far as I remember it worked just fine with RabbitMQ.

The configuration I used was straightforward.
You need to make sure that the mode is
set to tcp (not http) and that timeouts are sane.

Cheers,
  Marek
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com
https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From jerryk at vmware.com  Wed Jan 26 22:45:50 2011
From: jerryk at vmware.com (Jerry Kuch)
Date: Wed, 26 Jan 2011 14:45:50 -0800
Subject: [rabbitmq-discuss] Slow consumer disconnect availability on
	RAbbitMQ
Message-ID: <F78BCF638F95D74A99D036114107EDB5023948CC70@EXCH-MBX-3.vmware.com>

Hi, Prashant...

> Do we have slow consumer detection available in RabbitMQ like we have
> in Apache qpid ( Slow Consumer Disconnect (SCD) is a new feature in
> Qpid that provides a configurable mechanism to prevent a single slow
> consumer from causing a back up of unconsumed messages on the broker )

Possibly, but can I ask a couple of questions about your actual use
case?  First, are you actually seeing cases where your consumers are
so slow that the broker's own self defense mechanisms like paging
messages to disk and memory-based producer flow control either aren't
engaging, or are being overwhelmed in some way?  Second, are you sure
you actually want to disconnect clients that are consuming slowly, but
whose connections are otherwise alive and healthy?

> This is a very nice feature wherein we could identify and take
> corrective actions against the consumer. Please suggest any
> alternative method to achieve this behavior. Also when we identify SCD
> can we defer the queue for some time( timed defer) before it comes
> back to service something like suspend Queue for 5 mins and try
> again.

I presume that one of the requirements of the behavior you desire
would be that you discard messages from a queue whose consumers aren't
keeping up to its load since simply disconnecting a slow consumer
without some ability to replace it by one or more less slow ones isn't
going to help.  In that case, you could try the per-queue message TTL
extension that Rabbit supports.  It's documented here:

http://www.rabbitmq.com/extensions.html#queue-ttl

This lets you declare queues with a limit on how long a message
published to a queue can remain there before it is discarded.  This
would let you escape the back up of unconsumed messages that you're
concerned about and, for many types of message flows, is a sensible
behavior in any event since the relevance of ancient messages that
have been languishing unconsumed in queues probably degrades with time
anyway.

Best regards,
Jerry

From simon at rabbitmq.com  Wed Jan 26 22:56:21 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Wed, 26 Jan 2011 22:56:21 +0000
Subject: [rabbitmq-discuss] Management Plugin and HTTPS
In-Reply-To: <DA59B75E81B3405FAD3FBA480C910088@Eremit>
References: <DA59B75E81B3405FAD3FBA480C910088@Eremit>
Message-ID: <4D40A695.4090505@rabbitmq.com>

On 26/01/2011 9:26PM, Ronald Fischer wrote:
> I'm currently trying to have the management plugin be available via https
> but can't get it running.

<snip>

> That configuration is found at
> https://github.com/mochi/mochiweb/blob/master/examples/https/https_store.erl
>
> which refers to mochiweb, but doesn't seem to work with rabbit_mochiweb.
> So is there a way to achieve access via https?

No, sorry, there's no way to get SSL via rabbit_mochiweb at the moment.

Cheers, Simon

From simon at rabbitmq.com  Wed Jan 26 22:58:50 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Wed, 26 Jan 2011 22:58:50 +0000
Subject: [rabbitmq-discuss] client libraries compatibility
In-Reply-To: <4D4091DA.8060902@rabbitmq.com>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>	<4D408B5B.7050403@echostar.com>
	<4D4091DA.8060902@rabbitmq.com>
Message-ID: <4D40A72A.7040909@rabbitmq.com>

On 26/01/2011 9:27PM, Matthias Radestock wrote:
> - clients >= 2.2.0 will only work with brokers >= 2.2.0, except for the
> .net client which can speak to older brokers if configured to speak AMQP
> 0-8.

I think you mean ">= 2.0.0" here. The Java and Erlang clients switched 
to AMQP 0-9-1 at version 2.0.0.

Cheers, Simon

From matthias at rabbitmq.com  Wed Jan 26 23:02:05 2011
From: matthias at rabbitmq.com (Matthias Radestock)
Date: Wed, 26 Jan 2011 23:02:05 +0000
Subject: [rabbitmq-discuss] client libraries compatibility
In-Reply-To: <4D40A72A.7040909@rabbitmq.com>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>	<4D408B5B.7050403@echostar.com>	<4D4091DA.8060902@rabbitmq.com>
	<4D40A72A.7040909@rabbitmq.com>
Message-ID: <4D40A7ED.4060800@rabbitmq.com>

Simon MacMullen wrote:
> On 26/01/2011 9:27PM, Matthias Radestock wrote:
>> - clients >= 2.2.0 will only work with brokers >= 2.2.0, except for the
>> .net client which can speak to older brokers if configured to speak AMQP
>> 0-8.
> 
> I think you mean ">= 2.0.0" here. The Java and Erlang clients switched 
> to AMQP 0-9-1 at version 2.0.0.

Argh, indeed. So, once more, for the record...

- any version of any client we have ever released should work with a 
broker >= 2.0.0

- clients >= 2.0.0 will only work with brokers >= 2.0.0, except for the 
.net client which can speak to older brokers if configured to speak AMQP 
0-8.


Matthias.

From mark.geib at echostar.com  Wed Jan 26 23:10:52 2011
From: mark.geib at echostar.com (Mark Geib)
Date: Wed, 26 Jan 2011 16:10:52 -0700
Subject: [rabbitmq-discuss] client libraries compatibility
In-Reply-To: <4D40A7ED.4060800@rabbitmq.com>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>	<4D408B5B.7050403@echostar.com>	<4D4091DA.8060902@rabbitmq.com>	<4D40A72A.7040909@rabbitmq.com>
	<4D40A7ED.4060800@rabbitmq.com>
Message-ID: <4D40A9FC.6020804@echostar.com>


-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Exactly what I needed. Thanks for the quick responses.
Mark.

On 01/26/2011 04:02 PM, Matthias Radestock wrote:
> Simon MacMullen wrote:
>> On 26/01/2011 9:27PM, Matthias Radestock wrote:
>>> - clients >= 2.2.0 will only work with brokers >= 2.2.0, except
>>> for the .net client which can speak to older brokers if
>>> configured to speak AMQP 0-8.
>>
>> I think you mean ">= 2.0.0" here. The Java and Erlang clients
>> switched to AMQP 0-9-1 at version 2.0.0.
>
> Argh, indeed. So, once more, for the record...
>
> - any version of any client we have ever released should work with
> a broker >= 2.0.0
>
> - clients >= 2.0.0 will only work with brokers >= 2.0.0, except for
> the .net client which can speak to older brokers if configured to
> speak AMQP 0-8.
>
>
> Matthias. _______________________________________________
> rabbitmq-discuss mailing list rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

- --
>
Principal Engineer
Cheyenne Software Engineering
mark.geib at echostar.com / 35-215

PGP fingerprint:6DFC 389D 9796 0188 92E5 58F5 34C5 6B47 D091 76FD
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iEYEARECAAYFAk1AqfsACgkQNMVrR9CRdv0bcwCeJjEdjVk20ohth1QUZ/j2v/sn
xLIAn3FMtd90g0gCTy5jizIqSKw3Sq9V
=uV5w
-----END PGP SIGNATURE-----



From simon at rabbitmq.com  Wed Jan 26 23:15:16 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Wed, 26 Jan 2011 23:15:16 +0000
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
 Chrome
In-Reply-To: <985477893245CF449ABD4F01814A9FF65F41EE5541@34093-MBX-C06.mex07a.mlsrvr.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D359B67.2030806@rabbitmq.com>
	<611FB1B444670A41A06F4C91C40041C75D049AB2A1@34093-MBX-C06.mex07a.mlsrvr.com>
	<985477893245CF449ABD4F01814A9FF65F41EE5541@34093-MBX-C06.mex07a.mlsrvr.com>
Message-ID: <4D40AB04.8050709@rabbitmq.com>

On 25/01/2011 9:14AM, Jon Rowland wrote:
> I don't have Firefox but I tried this in IE 8.0 and get the same
> behaviour (1GB usage after leaving running overnight).

Hmm. Not sure IE counts as much evidence for the bug being in the plugin :)

But seeing the same problem in two browsers is a concern.

But I still have no idea how to debug this kind of problem.

But I'll have a look anyway.

But I'm not promising anything.

Cheers, Simon

From matthew at rabbitmq.com  Wed Jan 26 23:20:16 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Wed, 26 Jan 2011 23:20:16 +0000
Subject: [rabbitmq-discuss] weird timeout declaring queue
In-Reply-To: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>
Message-ID: <20110126232015.GA15568@wellquite.org>

On Wed, Jan 26, 2011 at 01:16:10PM -0600, Jon Brisbin wrote:
> In testing the new Riak-based message persister I've been working on, I'm seeing a strange timeout happening that I'm not terribly sure how to troubleshoot.
> 
> When I start the broker and publish a message, everything goes through fine. I see all the functions being called like I'd expect (init, fetch, et al). When I re-run the Python script that publishes the test message, it appears to hang on the declare_queue step. I have to kill it with Ctl-C. The only function I see being called in my backing queue module is delete_and_terminate. I suspect I'm not returning something correctly but I'm not sure what that is.

I strongly suspect your delete_and_terminate function is crashing, which
can then cause a subsequent declare of the same queue to loop forever.
Because this is called as part of the queue's deletion/termination,
errors in here tend not to show up in the logs. This is something of a
problem! So, maybe very carefully debug your delete_and_terminate
function? Construct the state directly in the erlang shell and pass it
around? We have lots of tests (as you'll find in rabbit_tests) that
directly construct vq states and mutilate them for testing purposes -
I'd suggest doing the same - get your BQ state out of the queue process
and test it in isolation.

Matthew


From PRYD at mach.com  Wed Jan 26 23:45:50 2011
From: PRYD at mach.com (Prashant Yadav)
Date: Thu, 27 Jan 2011 05:15:50 +0530
Subject: [rabbitmq-discuss] Slow consumer disconnect availability on
	RAbbitMQ
References: <F78BCF638F95D74A99D036114107EDB5023948CC70@EXCH-MBX-3.vmware.com>
Message-ID: <11EC96EC521B304EA05595E6F2987FC20234DE3B@EXCHBAN.machcorp.lan>

Hi Jerry,

Thanks for getting back. 

Actually we do have a requirement where I want consumer to stop getting message once I know that its slow( my consumption logic connects to remote server and if server is not responding or is slow for any reason I dont want my queue to get clogged), I would want to stop queue from populating.

The catch here is , I too dont want to purge all the messages or drop it . I too tried to use TTL and queue lease , but am not sure about messages resisding in the queue i.e whether they are requed or silently dropped( in my case I want them to by returned back to exchange and make the queue alive after some duration)

N.B: I guess suspending the queue can be little tricky , let me know yout thoughts

Regds
Prashant


-----Original Message-----
From: Jerry Kuch [mailto:jerryk at vmware.com]
Sent: Wed 1/26/2011 11:45 PM
To: Prashant Yadav; rabbitmq-discuss at lists.rabbitmq.com
Subject: RE: Slow consumer disconnect availability on RAbbitMQ
 
Hi, Prashant...

> Do we have slow consumer detection available in RabbitMQ like we have
> in Apache qpid ( Slow Consumer Disconnect (SCD) is a new feature in
> Qpid that provides a configurable mechanism to prevent a single slow
> consumer from causing a back up of unconsumed messages on the broker )

Possibly, but can I ask a couple of questions about your actual use
case?  First, are you actually seeing cases where your consumers are
so slow that the broker's own self defense mechanisms like paging
messages to disk and memory-based producer flow control either aren't
engaging, or are being overwhelmed in some way?  Second, are you sure
you actually want to disconnect clients that are consuming slowly, but
whose connections are otherwise alive and healthy?

> This is a very nice feature wherein we could identify and take
> corrective actions against the consumer. Please suggest any
> alternative method to achieve this behavior. Also when we identify SCD
> can we defer the queue for some time( timed defer) before it comes
> back to service something like suspend Queue for 5 mins and try
> again.

I presume that one of the requirements of the behavior you desire
would be that you discard messages from a queue whose consumers aren't
keeping up to its load since simply disconnecting a slow consumer
without some ability to replace it by one or more less slow ones isn't
going to help.  In that case, you could try the per-queue message TTL
extension that Rabbit supports.  It's documented here:

http://www.rabbitmq.com/extensions.html#queue-ttl

This lets you declare queues with a limit on how long a message
published to a queue can remain there before it is discarded.  This
would let you escape the back up of unconsumed messages that you're
concerned about and, for many types of message flows, is a sensible
behavior in any event since the relevance of ancient messages that
have been languishing unconsumed in queues probably degrades with time
anyway.

Best regards,
Jerry

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110127/792f2061/attachment-0001.htm>

From jasonjwwilliams at gmail.com  Thu Jan 27 01:52:18 2011
From: jasonjwwilliams at gmail.com (Jason J. W. Williams)
Date: Wed, 26 Jan 2011 18:52:18 -0700
Subject: [rabbitmq-discuss] Headers Exchange
Message-ID: <AANLkTinBJu3CB5=7ZKpwbpowc1b+CL54UQJ-rrFGF-Ob@mail.gmail.com>

Hi Y'all,

Is the headers exchange still supported? Seems to be from the RabbitMQ
AMQP compatibility chart but it's hard to find any concrete
information on using it. What is the advantage if any over topic?

-J

From jdetreville at vmware.com  Thu Jan 27 03:28:43 2011
From: jdetreville at vmware.com (John DeTreville)
Date: Wed, 26 Jan 2011 19:28:43 -0800
Subject: [rabbitmq-discuss] weird timeout declaring queue
In-Reply-To: <20110126232015.GA15568@wellquite.org>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>
	<20110126232015.GA15568@wellquite.org>
Message-ID: <11B9AFFC-78DD-426D-AF82-9FB6C701D294@vmware.com>

Jerry and I spoke with Jon today, and we agreed that this is a hard area to work in. I'm sending him a few very simple, special-purpose new queue implementation of mine (rabbit_ram_queue, rabbit_mnesia_queue, and the upcoming rabbit_disk_queue) to try building on. This might be easier for the moment than building on the more complicated rabbit_variable_queue, as Jon is doing now. 

(Golly, it's hard to type underscores on an iPhone!)

Oh, and today is my younger son's birthday. Everyone please wish him Happy Birthday, and I'll pass your wishes along!

Cheers,
John


On Jan 26, 2011, at 15:20, "Matthew Sackman" <matthew at rabbitmq.com> wrote:

> On Wed, Jan 26, 2011 at 01:16:10PM -0600, Jon Brisbin wrote:
>> In testing the new Riak-based message persister I've been working on, I'm seeing a strange timeout happening that I'm not terribly sure how to troubleshoot.
>> 
>> When I start the broker and publish a message, everything goes through fine. I see all the functions being called like I'd expect (init, fetch, et al). When I re-run the Python script that publishes the test message, it appears to hang on the declare_queue step. I have to kill it with Ctl-C. The only function I see being called in my backing queue module is delete_and_terminate. I suspect I'm not returning something correctly but I'm not sure what that is.
> 
> I strongly suspect your delete_and_terminate function is crashing, which
> can then cause a subsequent declare of the same queue to loop forever.
> Because this is called as part of the queue's deletion/termination,
> errors in here tend not to show up in the logs. This is something of a
> problem! So, maybe very carefully debug your delete_and_terminate
> function? Construct the state directly in the erlang shell and pass it
> around? We have lots of tests (as you'll find in rabbit_tests) that
> directly construct vq states and mutilate them for testing purposes -
> I'd suggest doing the same - get your BQ state out of the queue process
> and test it in isolation.
> 
> Matthew
> 
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From alexandru at rabbitmq.com  Thu Jan 27 04:34:55 2011
From: alexandru at rabbitmq.com (Alexandru =?utf-8?B?U2N2b3LFo292?=)
Date: Thu, 27 Jan 2011 06:34:55 +0200
Subject: [rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET
 API: How it works?
In-Reply-To: <AANLkTim_hB0XJ6C-4ZBtWifWvZtpmt5n+J1HvOe-3_wr@mail.gmail.com>
References: <AANLkTim_hB0XJ6C-4ZBtWifWvZtpmt5n+J1HvOe-3_wr@mail.gmail.com>
Message-ID: <20110127043455.GC2357@dakota>

Hi Alfonso,

> I've been googling a lot and some people suggested using this schema:
> 
> ch.TxSelect()
> ch.BasicPublish(.....)
> ch.TxCommit()
...
> Reading the API user guide I've found that this is called "transfer
> responsibility".

That's correct.  The only way right now to transfer responsibility for
a message to the broker is using transactions.

That said, I don't think it's exactly what you want.  The TxCommit will
succeed if messages are lost during routing (due to non-existing
queues).


> My question is:
> 
> Being TxCommit a void function I tested this block of code using a
> non-existing routing key and I didn't get any exception.
> Since safe publishing would be highly desiderable non routed messages should
> be detected because the application ACKs the messages of "events queue"
> when after evaluating its content has successfully sent another message to
> the "results queue" (currently if a a routing key is not being routed to a
> queue the messages are silently dropped and I have no way to detect the
> failure so the application ACKs the messages from "events queue")
> 
> Please, can someone tell me how I can't get that "CommitOK" responses?

As far as I know, there's no way cause the broker to throw an exception
for unroutable messages.

What you could do instead is this:
  - as you've suggested, publish with mandatory, immediate, and
    persistent set;
  - do publishes to persistent queues;
  - wrap publishes in that tx code;
  - have the publisher watch for basic.returns and handle somehow lost
    messages (maybe rollback the transaction, republish to a different
    and commit).

The message flags and the transactions should ensure that the broker
either save the messages to disk or send it to a consumer.  The
ReturnHandler should allow you to republish or somehow handle lost
messages.

Basic.publish/basic.return aren't synchronous out of the box and aren't
meant to be used like that.  For unroutable messages, the broker sends
the basic.return immediately after processing the basic.publish, so if
you publish to a non-existent queue, you should expect the basic.return
soonish; you could use this to make publishes/returns somewhat
synchronous, but I wouldn't recommend it.

BTW, the AMQP spec says you shouldn't rely on the broker's behaviour
when publishing mandatory/immediate messages inside transactions, but I
think there are any pitfalls doing this with rabbit.


As you may have guessed by now, the scenario you described isn't handled
very nicely by AMQP.  We're introducing publisher confirms to remedy
this.  The code's on default now, and should be in the next release.
The basic idea is that the broker sends a basic.ack back to the
publisher when it's dealt with a message.  In addition, the basic.return
would always be sent before the basic.ack, so the publisher would know
when the message is no longer its responsibility.  Of course, this
isn't synchronous, but it is fast, and the logic is a lot simpler than
trying to do the same thing with transactions.


> PS: I'm using the API version 1.7.2 and RabbitMQ server is the same version.

You really should upgrade.  Since 1.7.2, we've fixed lots of bugs
(including a few serious ones), introduced a new persister (which is
quite relevant if you care about transfer of responsibility) and added some
very nice management and monitoring features (including a web UI).
Publisher confirms are on default now, and should be in the next
release.


Hope this helps,

Cheers,
Alex

On Mon, Jan 24, 2011 at 05:47:17PM +0100, Alfonso Pantoja wrote:
> Hi,
> 
> I've developed an application that consumes messages from a queue ("events
> queue") and depending on their data
> it publishes (per received message) a message to another queue ("results
> queue")
> 
> The logic that checks the content of the received messages is publishing
> messages using BasicPublish (with mandatory=2, immediate=false and setting
> deliveryMode=2 to the messages to be sent)
> My concern is that BasicPublish is asynchronous  and the only exception I
> can get is when there is no connection to RabbitMQ or the destination
> exchange does not exist.
> 
> Since the application logic at this point is synchronous I can't use
> BasicReturn in order to use a handler when messages can't be delivered.
> 
> I've been googling a lot and some people suggested using this schema:
> 
> ch.TxSelect()
> ch.BasicPublish(.....)
> ch.TxCommit()
> 
> and also is suggested that "commit-ok" will be returned if the message has
> been published safely to the broker.
> 
> Reading the API user guide I've found that this is called "transfer
> responsibility".
> 
> Copy & paste follows:
> 
> --
> To transfer responsibility for delivery of a message to a broker
> ? ensure (ahead of time) that the target queue exists and is durable,
> ? select Tx mode using IModel.TxSelect,
> ? publish the message with the "mandatory" flag set and DeliveryMode set
> equal to 2, and
> ? commit the Tx transaction using IModel.TxCommit.
> 
> Once a broker replies with CommitOk (i.e. the TxCommit() call returns to the
> caller), it has taken
> responsibility for keeping the message on disk and on the target queue until
> some other application
> retrieves and acknowledges the message.
> A commit is not required after every message: batching of publications may
> be done, depending on the
> precise delivery guarantees the publishing application requires.
> Responsibility can also be placed with an external database, even further
> along the chain - see the section
> on interaction with external resources below
> ---
> 
> My question is:
> 
> Being TxCommit a void function I tested this block of code using a
> non-existing routing key and I didn't get any exception.
> Since safe publishing would be highly desiderable non routed messages should
> be detected because the application ACKs the messages of "events queue"
> when after evaluating its content has successfully sent another message to
> the "results queue" (currently if a a routing key is not being routed to a
> queue the messages are silently dropped and I have no way to detect the
> failure so the application ACKs the messages from "events queue")
> 
> Please, can someone tell me how I can't get that "CommitOK" responses?
> 
> 
> Thank you in advance.
> 
> 
> Alfonso
> 
> PS: I'm using the API version 1.7.2 and RabbitMQ server is the same version.

> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


From majek04 at gmail.com  Thu Jan 27 08:59:07 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Thu, 27 Jan 2011 08:59:07 +0000
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
	Chrome
In-Reply-To: <4D40AB04.8050709@rabbitmq.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D359B67.2030806@rabbitmq.com>
	<611FB1B444670A41A06F4C91C40041C75D049AB2A1@34093-MBX-C06.mex07a.mlsrvr.com>
	<985477893245CF449ABD4F01814A9FF65F41EE5541@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D40AB04.8050709@rabbitmq.com>
Message-ID: <AANLkTinLwKRVQ-Nd7bnG_92G5jjwcoQExpUj5vVYkwU_@mail.gmail.com>

On Wed, Jan 26, 2011 at 23:15, Simon MacMullen <simon at rabbitmq.com> wrote:
> On 25/01/2011 9:14AM, Jon Rowland wrote:
>>
>> I don't have Firefox but I tried this in IE 8.0 and get the same
>> behaviour (1GB usage after leaving running overnight).
>
> Hmm. Not sure IE counts as much evidence for the bug being in the plugin :)
>
> But seeing the same problem in two browsers is a concern.
>
> But I still have no idea how to debug this kind of problem.
>
> But I'll have a look anyway.
>
> But I'm not promising anything.

Simon,

There definitely is a memory leak. Actually, not a memory
leak - it's just the document that is growing, the
elements aren't leaked, they are referenced somewhere.

I did some debugging and I have some results.
Though, there is probably still much to be said.

1. in main.js we use innerHTML in one place, it's helpful to
    zero the element out before that:
http://javascript.crockford.com/memory/leak.html

2. I modified the purge() function above to unlink all childs,
   and it seems to work a bit better. (ie: explicitly unlink all
   elements of the tree)

3. The single biggest thing is IMO broken element caching
    in jQuery. Check out jQuery.fragments. It's growing...
    Removing this cache by hacking jQuery brought
    wonderful results. (there is also jQuery.cache, but
    I haven't played with that).
    Basically, in one of the tests I noticed that Dom nodes
    "document-fragment" were using the majority of memory.

4. In the queue view  there is a gc-cycle in the <form>
    responsible for adding a queue. I'm not sure what
    can be done about that.

5. In some other test I noticed that "slideUp/Down" and
    "toggleUp/Down" methods were increasing memory
    usage significantly, but that may be a false lead,
    as it may have something to do with the 'document-fragment'
    issue mentioned above.

6. For debugging I used 'sieve' for IE.
      http://home.wanadoo.nl/jsrosman/
    It's a simple tool but allows traversing the DOM and looking
    at what contains what. It would be nice to find a similar
    tool for chrome and firefox.


Cheers,
  Marek

From majek04 at gmail.com  Thu Jan 27 11:28:51 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Thu, 27 Jan 2011 11:28:51 +0000
Subject: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
In-Reply-To: <C5504C24B97DD448ACB994A683F011F60D444963@ALPMLVEM15.e2k.ad.ge.com>
References: <C5504C24B97DD448ACB994A683F011F60D4447C9@ALPMLVEM15.e2k.ad.ge.com>
	<AANLkTimXS7PvfR8pXvNRHwzWMhj1eQc=PDtmDZbsgJob@mail.gmail.com>
	<C5504C24B97DD448ACB994A683F011F60D444808@ALPMLVEM15.e2k.ad.ge.com>
	<C5504C24B97DD448ACB994A683F011F60D444963@ALPMLVEM15.e2k.ad.ge.com>
Message-ID: <AANLkTinDvmhNV4djjkJ=Deky1Fagmg6XEHT8Z7WxWqRQ@mail.gmail.com>

On Wed, Jan 26, 2011 at 19:08, Agarwal, Sumit (GE Healthcare)
<Sumit.Agarwal at ge.com> wrote:
> ?Do let me know if there is any problem with windows based cluster setup for RabbitMQ with the hostname contains "-" in the name like "32322-CDKS"?
> Regards

I'm afraid I don't have much experience with clustering. For sure
the node names must be resolvable. ie: ping <nodename> must work.



>
> -----Original Message-----
> From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Agarwal, Sumit (GE Healthcare)
> Sent: Wednesday, January 26, 2011 11:51 AM
> To: Marek Majkowski
> Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
> Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
>
> Thx I will try it out.
>
> -----Original Message-----
> From: Marek Majkowski [mailto:majek04 at gmail.com]
> Sent: Wednesday, January 26, 2011 11:50 AM
> To: Agarwal, Sumit (GE Healthcare)
> Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
> Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
>
> On Wed, Jan 26, 2011 at 17:33, Agarwal, Sumit (GE Healthcare) <Sumit.Agarwal at ge.com> wrote:
>> ?Please let me know if you have any documentation on RabbitMQ
>> clustering across different M/C and using the HaProxy to do the load
>> balance and failover.
>
> Hi,
>
> I played with HaProxy some time ago and as far as I remember it worked just fine with RabbitMQ.
>
> The configuration I used was straightforward.
> You need to make sure that the mode is
> set to tcp (not http) and that timeouts are sane.
>
> Cheers,
> ?Marek
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From majek04 at gmail.com  Thu Jan 27 11:29:31 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Thu, 27 Jan 2011 11:29:31 +0000
Subject: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
In-Reply-To: <C5504C24B97DD448ACB994A683F011F60D444B9C@ALPMLVEM15.e2k.ad.ge.com>
References: <C5504C24B97DD448ACB994A683F011F60D4447C9@ALPMLVEM15.e2k.ad.ge.com>
	<AANLkTimXS7PvfR8pXvNRHwzWMhj1eQc=PDtmDZbsgJob@mail.gmail.com>
	<C5504C24B97DD448ACB994A683F011F60D444808@ALPMLVEM15.e2k.ad.ge.com>
	<C5504C24B97DD448ACB994A683F011F60D444963@ALPMLVEM15.e2k.ad.ge.com>
	<C5504C24B97DD448ACB994A683F011F60D444B9C@ALPMLVEM15.e2k.ad.ge.com>
Message-ID: <AANLkTik6PSrBEZJEzmYnZXXu-gLOyWNGcgn-w_+HOR-0@mail.gmail.com>

On Wed, Jan 26, 2011 at 21:29, Agarwal, Sumit (GE Healthcare)
<Sumit.Agarwal at ge.com> wrote:
> Hi Marek,
> ?I found the issue is with the different version of Erlang I installed on those m/c.

To make clustering work you need exactly the same Erlang version on every node.

>
> -----Original Message-----
> From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Agarwal, Sumit (GE Healthcare)
> Sent: Wednesday, January 26, 2011 1:09 PM
> To: Marek Majkowski
> Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
> Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
>
> Hi Marek,
> ?Do let me know if there is any problem with windows based cluster setup for RabbitMQ with the hostname contains "-" in the name like "32322-CDKS"?
> Regards
> Sumit
>
> -----Original Message-----
> From: rabbitmq-discuss-bounces at lists.rabbitmq.com [mailto:rabbitmq-discuss-bounces at lists.rabbitmq.com] On Behalf Of Agarwal, Sumit (GE Healthcare)
> Sent: Wednesday, January 26, 2011 11:51 AM
> To: Marek Majkowski
> Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
> Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
>
> Thx I will try it out.
>
> -----Original Message-----
> From: Marek Majkowski [mailto:majek04 at gmail.com]
> Sent: Wednesday, January 26, 2011 11:50 AM
> To: Agarwal, Sumit (GE Healthcare)
> Cc: Alexis Richardson; rabbitmq-discuss at lists.rabbitmq.com
> Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster and Haproxy
>
> On Wed, Jan 26, 2011 at 17:33, Agarwal, Sumit (GE Healthcare) <Sumit.Agarwal at ge.com> wrote:
>> ?Please let me know if you have any documentation on RabbitMQ
>> clustering across different M/C and using the HaProxy to do the load
>> balance and failover.
>
> Hi,
>
> I played with HaProxy some time ago and as far as I remember it worked just fine with RabbitMQ.
>
> The configuration I used was straightforward.
> You need to make sure that the mode is
> set to tcp (not http) and that timeouts are sane.
>
> Cheers,
> ?Marek
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From matthew at rabbitmq.com  Thu Jan 27 11:40:35 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Thu, 27 Jan 2011 11:40:35 +0000
Subject: [rabbitmq-discuss] weird timeout declaring queue
In-Reply-To: <11B9AFFC-78DD-426D-AF82-9FB6C701D294@vmware.com>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>
	<20110126232015.GA15568@wellquite.org>
	<11B9AFFC-78DD-426D-AF82-9FB6C701D294@vmware.com>
Message-ID: <20110127114034.GD19295@rabbitmq.com>

On Wed, Jan 26, 2011 at 07:28:43PM -0800, John DeTreville wrote:
> Jerry and I spoke with Jon today, and we agreed that this is a hard area to work in. I'm sending him a few very simple, special-purpose new queue implementation of mine (rabbit_ram_queue, rabbit_mnesia_queue, and the upcoming rabbit_disk_queue) to try building on. This might be easier for the moment than building on the more complicated rabbit_variable_queue, as Jon is doing now. 

Ahh, yes. It's an astonishingly bad idea to try and modify vq - that
beast is complex. The backing_queue interface is hopefully well enough
documented that it should be possible to build directly from there - the
specs are there too after all.

If the documentation is not good enough for this purpose then we should
fix that.

Matthew

From david at rabbitmq.com  Thu Jan 27 11:55:42 2011
From: david at rabbitmq.com (David Wragg)
Date: Thu, 27 Jan 2011 11:55:42 +0000
Subject: [rabbitmq-discuss] Headers Exchange
In-Reply-To: <AANLkTinBJu3CB5=7ZKpwbpowc1b+CL54UQJ-rrFGF-Ob@mail.gmail.com>
	(Jason J. W. Williams's message of "Wed, 26 Jan 2011 18:52:18 -0700")
References: <AANLkTinBJu3CB5=7ZKpwbpowc1b+CL54UQJ-rrFGF-Ob@mail.gmail.com>
Message-ID: <yrv4c62tav9vl.fsf@dwragg.eng.vmware.com>

"Jason J. W. Williams" <jasonjwwilliams at gmail.com> writes:
> Is the headers exchange still supported?

Yes.

> Seems to be from the RabbitMQ
> AMQP compatibility chart but it's hard to find any concrete
> information on using it. What is the advantage if any over topic?

Short and fairly useless answer: Headers exchanges route based on the
headers of the message.  Topic exchanges route based on the routing key
usd to publish the mesage.

Longer answer:

- Headers exchanges can express an "any field matches" or an "all fields
  match" condition.  Topic exchanges can only express an "all words
  match" (e.g. a binding key of "*.x.*.y.*" will only match routing keys
  where the second word is "x" and the fourth word is "y"; OTOH multiple
  bindings provide a way to express disjunctions - you could bind a
  queue twice to a topic exchange, once with binding key "*.x.*.*.*" and
  once with "*.*.*.y.*").

- Topic exchanges can do hierarchical matching via the "#" operator
  (e.g. a binding key of "a.b.#" matches any routing keys beginning with
  "a.b").

The headers exchange is quite limited in terms of the queries it can
express: It can only do equality and presence matching on fields.  It
can only express an "and" and "or" combination over a set of field
conditions, not more elaborate boolean expressions (and no negation).
So while the header exchang might appear to offer a lot, in practice its
uses are restricted to a fairly small niche.  A more general variant
would be a lot more interesting.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From jon at jbrisbin.com  Thu Jan 27 12:39:14 2011
From: jon at jbrisbin.com (Jon Brisbin)
Date: Thu, 27 Jan 2011 06:39:14 -0600
Subject: [rabbitmq-discuss] weird timeout declaring queue
In-Reply-To: <20110127114034.GD19295@rabbitmq.com>
References: <22A35397-158E-4AF2-AFF3-97E29E7D45AA@jbrisbin.com>
	<20110126232015.GA15568@wellquite.org>
	<11B9AFFC-78DD-426D-AF82-9FB6C701D294@vmware.com>
	<20110127114034.GD19295@rabbitmq.com>
Message-ID: <0336BE39-33AD-4BF0-A6FA-3E6FA919A835@jbrisbin.com>


On Jan 27, 2011, at 5:40 AM, Matthew Sackman wrote:

> On Wed, Jan 26, 2011 at 07:28:43PM -0800, John DeTreville wrote:
>> Jerry and I spoke with Jon today, and we agreed that this is a hard area to work in. I'm sending him a few very simple, special-purpose new queue implementation of mine (rabbit_ram_queue, rabbit_mnesia_queue, and the upcoming rabbit_disk_queue) to try building on. This might be easier for the moment than building on the more complicated rabbit_variable_queue, as Jon is doing now. 
> 
> Ahh, yes. It's an astonishingly bad idea to try and modify vq - that
> beast is complex. The backing_queue interface is hopefully well enough
> documented that it should be possible to build directly from there - the
> specs are there too after all.
> 
> If the documentation is not good enough for this purpose then we should
> fix that.


It would be great to see a flowchart or something of expected input and output (that's easier to grok than the specs). The specs are helpful, but inadequate to fully understand what's going on because there's no explanation of why something is important or what the reason is of doing it that way. Like sending back a queue length. A doc explaining why that's important and how its used would be better for the developer than trying to follow it all the way through the code and infer it from how its being used.

I do think some documentation beyond what's currently available is needed if there's any expectation of community involvement on this front. New persisters to different backing stores in the future, etc...


Thanks!

Jon Brisbin

        Web: http://jbrisbin.com/
    Twitter: @j_brisbin
      Skype: jon.brisbin

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110127/10c79205/attachment.htm>

From mikeb at rabbitmq.com  Thu Jan 27 15:06:28 2011
From: mikeb at rabbitmq.com (Michael Bridgen)
Date: Thu, 27 Jan 2011 15:06:28 +0000
Subject: [rabbitmq-discuss] Massive distributed pub/sub system
In-Reply-To: <AANLkTikD2fMdS_sdc8cRvEWCQeyL2PyP7KVFf5ncwXme@mail.gmail.com>
References: <AANLkTikD2fMdS_sdc8cRvEWCQeyL2PyP7KVFf5ncwXme@mail.gmail.com>
Message-ID: <4D4189F4.6010609@rabbitmq.com>

Hi Kaiduan,

Your questions suggest you're attempting something very interesting, 
which I would love to hear more about.  Federation and distribution are 
very much on our minds here at Rabbit Towers, as you might imagine.

In the meantime ---

> 1) Any user can subscribe to the interested topic, but only topic
> owner can publish message to the group. There is no limit on the
> number of subscribers in each group. Potentially it can be huge, for
> example, the fans of U2 around the world.

Is there anything that determines who can own topics?  For example, is 
it just the first person to declare a topic that is the exclusive 
publisher to that topic?  Can the publishing rights, so to speak, be 
handed to another publisher?

> 2) User including subscriber and publisher is not always connected to
> the system, and not always connected to the same node in the system,
> and the message delivery should be guaranteed. When publisher
> publishes a message, the system should deliver the message to all
> subscribers. If the subscriber is connected to the system, the message
> should be delivered immediately. If the subscriber is not connected,
> system should hold the message, and the next time the user comes
> connected, system will deliver the message to the user. Just imagine
> the user can be any mobile user and moves out of cellular coverage.

So far as I know, this is still an area of active research.  Typically, 
distributed pub/sub systems like Scribe and Hermes give rather weak 
guarantees of delivery and ordering and so on.

In particular, "If the subscriber is not connected, system should hold 
the message, and the next time the user comes connected, system will 
deliver the message to the user" is difficult if the subscriber can 
connect to any node, and I don't think most pub/sub systems would allow 
that.

> 3) The system should be able to support tens to hundreds of millions
> users spreading around the world, so the system will consist hundred
> of nodes located in different physical locations.

This is rather ambitious.  But systems on this kind of scale are indeed 
being built: http://ci.oceanobservatories.org/ for instance.

> 4) The number of topics/groups in the system is unlimited.
>
> 5) As to the latency, it should be in the range of 1 minute if
> subscriber is connected.
>
> It looks like RabbitMQ already has functionalities to meet the above
> requirement, for example, fan out exchange, and persistent message.
> The following is my understanding on how to build the above system
> with RabbitMQ,

Perhaps, in the sense that it can be a building block.  But it doesn't 
fulfill all the requirements you've given above, "out of the box".  In 
other words, you (or we) would have to invent a substantial part of the 
technology.

> a) Publisher creates an exchange. For example, U2 creates an exchange
> noted as "U2" for "U2's next world wide tour" on Node 1.
>
> b) Each subscriber creates a queue in the system. For example, Alice
> creates a queue noted as "Alice" on Node 2 and binds to exchange U2;
> and Bob creates a queue noted as "Bob" on Node 3 and binds to exchange
> "U2" on Node 2.
>
> c) U2 publishes a message, m1 on Node 1 to exchange "U2"; and RabbitMQ
> will deliver the message m1 to queue "Alice" on Node 2 and to queue
> "Bob" on Node 3.
>
> How we handles the following scenarios?
>
> 1) When U2 wants to publish a message, but Node 1 is done.
>
> 2) When message m1 is delivered to queue "Alice" on Node 2, Node 2
> crashed or the network link between Node 1 (publisher's node) is
> disconnected? Will exchange "U2" on Node 1 persist the message?

No; the message will be lost so far as Alice is concerned.  In AMQP 
terms, you're asking for queues to be replicated.  Rabbit doesn't do 
this, yet.

(Actually, we are working on queue replication right now.  I think you 
would need both replication and some kind of queue migration or 
distribution.)

> 3) After message m1 is arrived on queue "Alice", but the connection
> between Alice and Node 2 is gone, the message will be stored on Node
> 2, right? Next time, Alice connects to the system, but she is
> connected to Node n instead of Node 2, how to handle this?

In Rabbit's clustering as it works now, the messages will be delivered 
across the cluster to Node n.

> 4) What is the multi-cast technology used in RabbitMQ to deliver the
> message to queues located on different locations spreading around
> different countries?

There isn't any right now.  Clustering is really for nodes that are 
co-located and have reliable connections.  It uses Erlang's distribution 
mechanism, which essentially forms a fully-connected graph of nodes.  It 
doesn't really scale beyond a handful of nodes.

There /is/ a plugin called the "shovel", which will relay messages from 
one broker to another.  However, it is statically configured, and 
constrained by using AMQP to do the relaying (i.e., you cannot tell it 
to relay all messages from a direct exchange; only to relay, e.g., 
messages with a particular routing key).


Regards,
Michael

From simon at rabbitmq.com  Thu Jan 27 17:30:39 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Thu, 27 Jan 2011 17:30:39 +0000
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
 Chrome
In-Reply-To: <4D40AB04.8050709@rabbitmq.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>	<4D359B67.2030806@rabbitmq.com>	<611FB1B444670A41A06F4C91C40041C75D049AB2A1@34093-MBX-C06.mex07a.mlsrvr.com>	<985477893245CF449ABD4F01814A9FF65F41EE5541@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D40AB04.8050709@rabbitmq.com>
Message-ID: <4D41ABBF.4030209@rabbitmq.com>

On 26/01/11 23:15, Simon MacMullen wrote:
> Hmm. Not sure IE counts as much evidence for the bug being in the plugin :)
>
> But seeing the same problem in two browsers is a concern.
>
> But I still have no idea how to debug this kind of problem.
>
> But I'll have a look anyway.
>
> But I'm not promising anything.

FTR we'll at least have a mitigation strategy against this (full refresh 
the page after 200 partial updates without user interaction) in the next 
release. And we're still seeing if we can fix the real problem.

Cheers, Simon

-- 
Simon MacMullen
Staff Engineer, RabbitMQ
SpringSource, a division of VMware


From jasonjwwilliams at gmail.com  Thu Jan 27 17:45:38 2011
From: jasonjwwilliams at gmail.com (Jason J. W. Williams)
Date: Thu, 27 Jan 2011 10:45:38 -0700
Subject: [rabbitmq-discuss] Headers Exchange
In-Reply-To: <yrv4c62tav9vl.fsf@dwragg.eng.vmware.com>
References: <AANLkTinBJu3CB5=7ZKpwbpowc1b+CL54UQJ-rrFGF-Ob@mail.gmail.com>
	<yrv4c62tav9vl.fsf@dwragg.eng.vmware.com>
Message-ID: <1059A8A5-573A-4C38-B178-95ED1B560DCD@gmail.com>

Hi David,

Thank you for the explanation. Are there any docs on how to construct the bind string? 

Also, is the performance better than topic?

Thank you in advance. 

-J

Sent via iPhone

Is your e-mail Premiere?

On Jan 27, 2011, at 4:55, David Wragg <david at rabbitmq.com> wrote:

> "Jason J. W. Williams" <jasonjwwilliams at gmail.com> writes:
>> Is the headers exchange still supported?
> 
> Yes.
> 
>> Seems to be from the RabbitMQ
>> AMQP compatibility chart but it's hard to find any concrete
>> information on using it. What is the advantage if any over topic?
> 
> Short and fairly useless answer: Headers exchanges route based on the
> headers of the message.  Topic exchanges route based on the routing key
> usd to publish the mesage.
> 
> Longer answer:
> 
> - Headers exchanges can express an "any field matches" or an "all fields
>  match" condition.  Topic exchanges can only express an "all words
>  match" (e.g. a binding key of "*.x.*.y.*" will only match routing keys
>  where the second word is "x" and the fourth word is "y"; OTOH multiple
>  bindings provide a way to express disjunctions - you could bind a
>  queue twice to a topic exchange, once with binding key "*.x.*.*.*" and
>  once with "*.*.*.y.*").
> 
> - Topic exchanges can do hierarchical matching via the "#" operator
>  (e.g. a binding key of "a.b.#" matches any routing keys beginning with
>  "a.b").
> 
> The headers exchange is quite limited in terms of the queries it can
> express: It can only do equality and presence matching on fields.  It
> can only express an "and" and "or" combination over a set of field
> conditions, not more elaborate boolean expressions (and no negation).
> So while the header exchang might appear to offer a lot, in practice its
> uses are restricted to a fairly small niche.  A more general variant
> would be a lot more interesting.
> 
> David
> 
> -- 
> David Wragg
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware

From jon.rowland at isam.com  Thu Jan 27 17:46:16 2011
From: jon.rowland at isam.com (Jon Rowland)
Date: Thu, 27 Jan 2011 11:46:16 -0600
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
 Chrome
In-Reply-To: <4D41ABBF.4030209@rabbitmq.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D359B67.2030806@rabbitmq.com>
	<611FB1B444670A41A06F4C91C40041C75D049AB2A1@34093-MBX-C06.mex07a.mlsrvr.com>
	<985477893245CF449ABD4F01814A9FF65F41EE5541@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D40AB04.8050709@rabbitmq.com> <4D41ABBF.4030209@rabbitmq.com>
Message-ID: <14F40395-B39E-4255-8052-5418AC74BC1E@isamfunds.com>

Thanks for the attention!



On 27 Jan 2011, at 17:31, "Simon MacMullen" <simon at rabbitmq.com> wrote:

> On 26/01/11 23:15, Simon MacMullen wrote:
>> Hmm. Not sure IE counts as much evidence for the bug being in the  
>> plugin :)
>>
>> But seeing the same problem in two browsers is a concern.
>>
>> But I still have no idea how to debug this kind of problem.
>>
>> But I'll have a look anyway.
>>
>> But I'm not promising anything.
>
> FTR we'll at least have a mitigation strategy against this (full  
> refresh
> the page after 200 partial updates without user interaction) in the  
> next
> release. And we're still seeing if we can fix the real problem.
>
> Cheers, Simon
>
> -- 
> Simon MacMullen
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From david at rabbitmq.com  Thu Jan 27 18:16:09 2011
From: david at rabbitmq.com (David Wragg)
Date: Thu, 27 Jan 2011 18:16:09 +0000
Subject: [rabbitmq-discuss] Headers Exchange
In-Reply-To: <1059A8A5-573A-4C38-B178-95ED1B560DCD@gmail.com> (Jason
	J. W. Williams's message of "Thu, 27 Jan 2011 10:45:38 -0700")
References: <AANLkTinBJu3CB5=7ZKpwbpowc1b+CL54UQJ-rrFGF-Ob@mail.gmail.com>
	<yrv4c62tav9vl.fsf@dwragg.eng.vmware.com>
	<1059A8A5-573A-4C38-B178-95ED1B560DCD@gmail.com>
Message-ID: <yrv4coc72tdp2.fsf@dwragg.eng.vmware.com>

"Jason J. W. Williams" <jasonjwwilliams at gmail.com> writes:
> Thank you for the explanation. Are there any docs on how to construct
> the bind string?

For topic exchanges, this is covered at
<http://www.rabbitmq.com/tutorial-five-python.html>.

> Also, is the performance better than topic?

Currently RabbitMQ implements both topic and header exchanges by doing a
linear scan through the bindings.

One day soon, RabbitMQ will optimise the matching involved in topic
exchanges.  But this is designed to improve their performance when used
for typical hierarchical routing situations, and I suspect it will not
give a consistent improvement in cases such as the example I suggested
when comparing topic exchanges to headers exchanges.

There are algorithms to efficiently implement schemes such as the AMQP
headers exchange.  But I don't think we've heard a lot of requests for
us to implement such a thing (perhaps because anyone who did care about
the performance of the headers exchange might also find the constraints
on its functionality to be a problem).

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From jasonjwwilliams at gmail.com  Thu Jan 27 18:19:44 2011
From: jasonjwwilliams at gmail.com (Jason J. W. Williams)
Date: Thu, 27 Jan 2011 11:19:44 -0700
Subject: [rabbitmq-discuss] Headers Exchange
In-Reply-To: <yrv4coc72tdp2.fsf@dwragg.eng.vmware.com>
References: <AANLkTinBJu3CB5=7ZKpwbpowc1b+CL54UQJ-rrFGF-Ob@mail.gmail.com>
	<yrv4c62tav9vl.fsf@dwragg.eng.vmware.com>
	<1059A8A5-573A-4C38-B178-95ED1B560DCD@gmail.com>
	<yrv4coc72tdp2.fsf@dwragg.eng.vmware.com>
Message-ID: <AANLkTi=kebGM-MtgwzJ0Or3ijpdN2NH_go5VoHgYZ-36@mail.gmail.com>

Hi David,

I know how to construct topic bind strings. :) There's no docs I can
find on Header bind. Help there would be appreciated.

-J

On Thu, Jan 27, 2011 at 11:16 AM, David Wragg <david at rabbitmq.com> wrote:
> "Jason J. W. Williams" <jasonjwwilliams at gmail.com> writes:
>> Thank you for the explanation. Are there any docs on how to construct
>> the bind string?
>
> For topic exchanges, this is covered at
> <http://www.rabbitmq.com/tutorial-five-python.html>.
>
>> Also, is the performance better than topic?
>
> Currently RabbitMQ implements both topic and header exchanges by doing a
> linear scan through the bindings.
>
> One day soon, RabbitMQ will optimise the matching involved in topic
> exchanges. ?But this is designed to improve their performance when used
> for typical hierarchical routing situations, and I suspect it will not
> give a consistent improvement in cases such as the example I suggested
> when comparing topic exchanges to headers exchanges.
>
> There are algorithms to efficiently implement schemes such as the AMQP
> headers exchange. ?But I don't think we've heard a lot of requests for
> us to implement such a thing (perhaps because anyone who did care about
> the performance of the headers exchange might also find the constraints
> on its functionality to be a problem).
>
> David
>
> --
> David Wragg
> Staff Engineer, RabbitMQ
> SpringSource, a division of VMware
>

From matthew at rabbitmq.com  Thu Jan 27 18:30:23 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Thu, 27 Jan 2011 18:30:23 +0000
Subject: [rabbitmq-discuss] Shovel bug? Consumer hangs after network
 failure.
In-Reply-To: <A353E0E0-8D9C-4985-B413-B2E8D54A35A3@tjervaag.com>
References: <C0DB3E20-AC51-4027-8E5A-860751563E17@tjervaag.com>
	<20110120224502.GA13371@rabbitmq.com>
	<A353E0E0-8D9C-4985-B413-B2E8D54A35A3@tjervaag.com>
Message-ID: <20110127183023.GJ19295@rabbitmq.com>

On Fri, Jan 21, 2011 at 12:00:41PM +0100, ?yvind Tjervaag wrote:
> > Yes, this is largely to be expected. Consuming is an asynchronous
> > activity and the Rabbit1 -> Rabbit2 shovel is just consuming from queues
> > on Rabbit1. Until the socket is closed by the kernel, it won't
> > necessarily notice that Rabbit1 has gone down. TCP timeouts can
> > sometimes be quite long. So, I would recommend that you turn on
> > heartbeats on that shovel. Unfortunately, looking through the source, I
> > see there is no way to turn on heartbeats. Sigh. I'll file a bug and get
> > that added.
> 
> Thanks! Figured something like this was happening.

This bug has now been fixed. If you compile the shovel from the latest
source from our repos, then you'll find that you can now specify
?heartbeat=5 at the end of the broker URI (amongst other parameters).
This will be in the next release if you're not comfortable with
compiling from source.

Matthew

From david at rabbitmq.com  Thu Jan 27 18:44:28 2011
From: david at rabbitmq.com (David Wragg)
Date: Thu, 27 Jan 2011 18:44:28 +0000
Subject: [rabbitmq-discuss] Headers Exchange
In-Reply-To: <AANLkTi=kebGM-MtgwzJ0Or3ijpdN2NH_go5VoHgYZ-36@mail.gmail.com>
	(Jason J. W. Williams's message of "Thu, 27 Jan 2011 11:19:44 -0700")
References: <AANLkTinBJu3CB5=7ZKpwbpowc1b+CL54UQJ-rrFGF-Ob@mail.gmail.com>
	<yrv4c62tav9vl.fsf@dwragg.eng.vmware.com>
	<1059A8A5-573A-4C38-B178-95ED1B560DCD@gmail.com>
	<yrv4coc72tdp2.fsf@dwragg.eng.vmware.com>
	<AANLkTi=kebGM-MtgwzJ0Or3ijpdN2NH_go5VoHgYZ-36@mail.gmail.com>
Message-ID: <yrv4ck4hqtcdv.fsf@dwragg.eng.vmware.com>

"Jason J. W. Williams" <jasonjwwilliams at gmail.com> writes:
> I know how to construct topic bind strings. :) There's no docs I can
> find on Header bind. Help there would be appreciated.

Ah, ok.

The binding key is not used for headers exchanges; the matching
critieria are expressed in the arguments table that is passed to the
basic.bind method (most client libraries make this an optional parameter
to the bind call; see the docs for the client library you are using to
see how it gets exposed).

I'm afraid that I don't recall a description of header exchanges that is
better than the one in the AMQP 0-9-1 spec.  Though that section
(3.1.3.4) is quite readable and short (half a page), and if you are
familiar with RabbitMQ concepts you won't have to read the rest of the
spec to understand it.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware

From irrer at umich.edu  Thu Jan 27 19:25:07 2011
From: irrer at umich.edu (Jim Irrer)
Date: Thu, 27 Jan 2011 14:25:07 -0500
Subject: [rabbitmq-discuss] Massive distributed pub/sub system
In-Reply-To: <4D4189F4.6010609@rabbitmq.com>
References: <AANLkTikD2fMdS_sdc8cRvEWCQeyL2PyP7KVFf5ncwXme@mail.gmail.com>
	<4D4189F4.6010609@rabbitmq.com>
Message-ID: <AANLkTimCxsRP4ceCGbErPpr0W3n_MOM7j5MFiMHz4SNp@mail.gmail.com>

Would XMPP be more appropriate for this application?  I'm not real
familiar with it but I've heard that it has different strengths than AMQP.
I'm interested in the pros and cons.

Thanks,

- Jim

Jim Irrer     irrer at umich.edu       (734) 647-4409
University of Michigan Hospital Radiation Oncology
519 W. William St.             Ann Arbor, MI 48103


On Thu, Jan 27, 2011 at 10:06 AM, Michael Bridgen <mikeb at rabbitmq.com>wrote:

> Hi Kaiduan,
>
> Your questions suggest you're attempting something very interesting, which
> I would love to hear more about.  Federation and distribution are very much
> on our minds here at Rabbit Towers, as you might imagine.
>
> In the meantime ---
>
>
>  1) Any user can subscribe to the interested topic, but only topic
>> owner can publish message to the group. There is no limit on the
>> number of subscribers in each group. Potentially it can be huge, for
>> example, the fans of U2 around the world.
>>
>
> Is there anything that determines who can own topics?  For example, is it
> just the first person to declare a topic that is the exclusive publisher to
> that topic?  Can the publishing rights, so to speak, be handed to another
> publisher?
>
>
>  2) User including subscriber and publisher is not always connected to
>> the system, and not always connected to the same node in the system,
>> and the message delivery should be guaranteed. When publisher
>> publishes a message, the system should deliver the message to all
>> subscribers. If the subscriber is connected to the system, the message
>> should be delivered immediately. If the subscriber is not connected,
>> system should hold the message, and the next time the user comes
>> connected, system will deliver the message to the user. Just imagine
>> the user can be any mobile user and moves out of cellular coverage.
>>
>
> So far as I know, this is still an area of active research.  Typically,
> distributed pub/sub systems like Scribe and Hermes give rather weak
> guarantees of delivery and ordering and so on.
>
> In particular, "If the subscriber is not connected, system should hold the
> message, and the next time the user comes connected, system will deliver the
> message to the user" is difficult if the subscriber can connect to any node,
> and I don't think most pub/sub systems would allow that.
>
>
>  3) The system should be able to support tens to hundreds of millions
>> users spreading around the world, so the system will consist hundred
>> of nodes located in different physical locations.
>>
>
> This is rather ambitious.  But systems on this kind of scale are indeed
> being built: http://ci.oceanobservatories.org/ for instance.
>
>
>  4) The number of topics/groups in the system is unlimited.
>>
>> 5) As to the latency, it should be in the range of 1 minute if
>> subscriber is connected.
>>
>> It looks like RabbitMQ already has functionalities to meet the above
>> requirement, for example, fan out exchange, and persistent message.
>> The following is my understanding on how to build the above system
>> with RabbitMQ,
>>
>
> Perhaps, in the sense that it can be a building block.  But it doesn't
> fulfill all the requirements you've given above, "out of the box".  In other
> words, you (or we) would have to invent a substantial part of the
> technology.
>
>
>  a) Publisher creates an exchange. For example, U2 creates an exchange
>> noted as "U2" for "U2's next world wide tour" on Node 1.
>>
>> b) Each subscriber creates a queue in the system. For example, Alice
>> creates a queue noted as "Alice" on Node 2 and binds to exchange U2;
>> and Bob creates a queue noted as "Bob" on Node 3 and binds to exchange
>> "U2" on Node 2.
>>
>> c) U2 publishes a message, m1 on Node 1 to exchange "U2"; and RabbitMQ
>> will deliver the message m1 to queue "Alice" on Node 2 and to queue
>> "Bob" on Node 3.
>>
>> How we handles the following scenarios?
>>
>> 1) When U2 wants to publish a message, but Node 1 is done.
>>
>> 2) When message m1 is delivered to queue "Alice" on Node 2, Node 2
>> crashed or the network link between Node 1 (publisher's node) is
>> disconnected? Will exchange "U2" on Node 1 persist the message?
>>
>
> No; the message will be lost so far as Alice is concerned.  In AMQP terms,
> you're asking for queues to be replicated.  Rabbit doesn't do this, yet.
>
> (Actually, we are working on queue replication right now.  I think you
> would need both replication and some kind of queue migration or
> distribution.)
>
>
>  3) After message m1 is arrived on queue "Alice", but the connection
>> between Alice and Node 2 is gone, the message will be stored on Node
>> 2, right? Next time, Alice connects to the system, but she is
>> connected to Node n instead of Node 2, how to handle this?
>>
>
> In Rabbit's clustering as it works now, the messages will be delivered
> across the cluster to Node n.
>
>
>  4) What is the multi-cast technology used in RabbitMQ to deliver the
>> message to queues located on different locations spreading around
>> different countries?
>>
>
> There isn't any right now.  Clustering is really for nodes that are
> co-located and have reliable connections.  It uses Erlang's distribution
> mechanism, which essentially forms a fully-connected graph of nodes.  It
> doesn't really scale beyond a handful of nodes.
>
> There /is/ a plugin called the "shovel", which will relay messages from one
> broker to another.  However, it is statically configured, and constrained by
> using AMQP to do the relaying (i.e., you cannot tell it to relay all
> messages from a direct exchange; only to relay, e.g., messages with a
> particular routing key).
>
>
> Regards,
> Michael
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110127/2b8ef413/attachment.htm>

From paolo.losi at gmail.com  Thu Jan 27 18:36:58 2011
From: paolo.losi at gmail.com (Paolo Losi)
Date: Thu, 27 Jan 2011 19:36:58 +0100
Subject: [rabbitmq-discuss] ANN stormed-amqp 0.1 released [Python]
Message-ID: <ihse0b$2q6$1@dough.gmane.org>

Hi all,

I'm happy to announce the first release of stormed-amqp [0]

Stormed-amqp is an AMQP client library that is:

* AMQP 0-9-1 fully compliant
* tornado [1] native (IOLoop/IOStream) fully async
* compatible with tornado 1.0, 1.1 and upcoming 1.2 versions
* "certified" to work with Rabbitmq 2.0 or later versions

Feedback, patches and any help are really welcome.

Thanks

Paolo

[0] http://pypi.python.org/pypi/stormed-amqp/0.1
[1] http://www.tornadoweb.org/


From mrkafk at gmail.com  Thu Jan 27 19:46:33 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Thu, 27 Jan 2011 20:46:33 +0100
Subject: [rabbitmq-discuss] publish to empty exchange works,
 while publish to correct exchange doesn't
In-Reply-To: <AANLkTi=nkAHiZ8UR5RXPOZ7a0gQcThmK_7C4n_OfrR_=@mail.gmail.com>
References: <4D3F3639.1090301@gmail.com>
	<AANLkTi=nkAHiZ8UR5RXPOZ7a0gQcThmK_7C4n_OfrR_=@mail.gmail.com>
Message-ID: <4D41CB99.60408@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Marek Majkowski wrote:

> When you bind to an exchange that is "direct" you must supply
> a sane routing key (aka: binding key). More here:

Thanks! that was it. Hmm I should probably RTFM.


- --

Regards,
mk

- --
Premature optimization is the root of all fun.

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNQcuZAAoJEFMgHzhQQ7hOccwH/RWW07/xjQR2RA/4xuGFEt5H
MUYfmQyZXoceFmYj282+YVUiuPTMxd7SWhxEP9BLMptYQ7GQiX0xJu0K/HhBz9yc
nZFRtijLcXh+hXN4ydP63QQr2GRHWix2frHkp3qGZdozfrYO1WnAghGvQ/oMSlp3
ZfZwUdnziKKvPSrLuh/TgkvKjyfcoghAT+g8s6dfNLoXWAPVq6utDEUUlFFAalKB
wP2eaknh4iGAJRk9LpKBSuFInX8UFED7iMntl4nA2wqQaYqTAcsd0CeTtMwhrPRA
WJ71OZdCGjjXMcMuHuwgRZcWESfGabDjUVpxY4DheFAHakZUA2VyMDWhZJdDdws=
=QwXx
-----END PGP SIGNATURE-----

From mrkafk at gmail.com  Thu Jan 27 19:52:16 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Thu, 27 Jan 2011 20:52:16 +0100
Subject: [rabbitmq-discuss] pika.channel.basic_consume
Message-ID: <4D41CCF0.6090608@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hello everyone,

Can channel.basic_consume handle more than 1 callback?

Reading channel.py would suggest so:

def basic_consume(self, consumer, queue = '', no_ack = False, exclusive
= False, consumer_tag = None):
    tag = consumer_tag
...
    self.callbacks[tag] = consumer

But when I use more than one callback (both on exclusive queues), only
one of them works.

def setup_distrib(node):
    global chan, conn, myqueue, rpc_res_exch, rpc_send_exch
    chan.exchange_declare(exchange = rpc_send_exch,type='fanout')
    chan.exchange_declare(exchange = rpc_res_exch,type='direct')
    res = chan.queue_declare(exclusive = True)
    myqueue = res.queue
    print 'myqueue', myqueue
    # important! when binding queue to direct exchange, a proper routing
key must be given!
    chan.queue_bind(exchange = rpc_res_exch, queue = myqueue,
routing_key = myqueue)
    chan.basic_consume(on_response_distrib, no_ack=True, queue=myqueue)


def setup_rdonly(node):
    global chan, conn, myqueue, rpc_rdonly_res_exch,
rpc_rdonly_send_exch, rdonlysendqueue
    chan.exchange_declare(exchange = rpc_rdonly_send_exch, type='direct')
    chan.exchange_declare(exchange = rpc_rdonly_res_exch, type='direct')
    rdonlysendqueue = node + '_rdonly'
    chan.queue_declare(queue=rdonlysendqueue)
    chan.queue_bind(exchange=rpc_rdonly_send_exch,
queue=rdonlysendqueue, routing_key=rdonlysendqueue)
    res = chan.queue_declare(exclusive=True)
    myqueue = res.queue
    print 'myqueue', myqueue
    chan.queue_bind(exchange=rpc_rdonly_res_exch, queue=myqueue,
routing_key=myqueue)
    chan.basic_consume(on_response_rdonly, no_ack=True, queue=myqueue)


When I do setup_distrib(node) AND setup_rdonly(node), only rdonly queues
work.

When I do one or the other, either works.

Anybody?



- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNQczwAAoJEFMgHzhQQ7hOdQEH/ia0zoybB6WDiaxXO/KRib6c
xemppCBnYUq0oJvLxkwpPSIyMNjVPgML7klXS02ecVVJ+S69e6ztWJuiESL2jHo+
Uarz+TxlRKrFlHoRST1gQlIIwloJURFcdlX26yPocBYfSayJH8sGxFFsE9XUh2Yj
N361XYkETc20xr0+LwpY2BRXT/8/WtH/xBw+1KGCOkvnF0hbOFw0YD/zHsT4UnIT
kdI0zNy0/+6kGg/IhrSwBwc+EKT6O/b7o08s0/Ov3M+i4mYrd23JR+CB55EW6spe
d/hbAdUu8hZaS634iNOMsZG8XHH5Ztv+MjOEhPe/99dPxxLQVJaNxz2C+IsUl44=
=ePoS
-----END PGP SIGNATURE-----

From gmr at myyearbook.com  Thu Jan 27 21:36:28 2011
From: gmr at myyearbook.com (Gavin M. Roy)
Date: Thu, 27 Jan 2011 16:36:28 -0500
Subject: [rabbitmq-discuss] pika.channel.basic_consume
In-Reply-To: <4D41CCF0.6090608@gmail.com>
References: <4D41CCF0.6090608@gmail.com>
Message-ID: <AANLkTimAs5udmDEu1xeBXzY_yRw2NjyVQtjXJkMafA=J@mail.gmail.com>

On Thu, Jan 27, 2011 at 2:52 PM, Marcin Krol <mrkafk at gmail.com> wrote:

> Can channel.basic_consume handle more than 1 callback?

It can't right now, but I am working on the next version and would
consider adding it for good reason. Is there a reason you want to do
this? I could see from a not delivering the same message twice but you
could just use a fanout exchange and bind both consumers to this.

Gavin

From gmr at myyearbook.com  Thu Jan 27 21:37:06 2011
From: gmr at myyearbook.com (Gavin M. Roy)
Date: Thu, 27 Jan 2011 16:37:06 -0500
Subject: [rabbitmq-discuss] pika.channel.basic_consume
In-Reply-To: <AANLkTimAs5udmDEu1xeBXzY_yRw2NjyVQtjXJkMafA=J@mail.gmail.com>
References: <4D41CCF0.6090608@gmail.com>
	<AANLkTimAs5udmDEu1xeBXzY_yRw2NjyVQtjXJkMafA=J@mail.gmail.com>
Message-ID: <AANLkTi=qwHTXa3kvnxQ80k_JR8PMnGyORC8woXExhKSp@mail.gmail.com>

On Thu, Jan 27, 2011 at 4:36 PM, Gavin M. Roy <gmr at myyearbook.com> wrote:
> On Thu, Jan 27, 2011 at 2:52 PM, Marcin Krol <mrkafk at gmail.com> wrote:
>
>> Can channel.basic_consume handle more than 1 callback?
>
> It can't right now, but I am working on the next version and would
> consider adding it for good reason. Is there a reason you want to do
> this? I could see from a not delivering the same message twice but you
> could just use a fanout exchange and bind both consumers to this.

Alternatively you could just make the callback a function of your own
and have it call your two functions with the content.

From root at localdomain.pl  Thu Jan 27 23:06:06 2011
From: root at localdomain.pl (Grzegorz Nosek)
Date: Fri, 28 Jan 2011 00:06:06 +0100
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
Message-ID: <4D41FA5E.8030602@localdomain.pl>

Hi,

While googling for "rabbitmq redelivery order" I found this gem:

http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-October/005078.html

> Those who rely on the broker preserving perfect [...] ordering are kind of doomed.

so I'm not keeping my hopes too high, but still, it shouldn't hurt too 
much to ask ;)

Is there a setup (of exchanges, queues etc.) that tries to preserve 
ordering of messages when faced with consumer failure? I have a very 
simple setup consisting of a bunch of producers feeding data via a 
single queue to a consumer that stuffs it into RRD files (which must be 
updated in order or require deeper surgery involving dump/restore). At 
one time the consumer happened to fail and RabbitMQ started to buffer 
the messages, which then got redelivered in (apparently) totally random 
order, so RRD dropped most of them anyway.

So, is there anything I can do to at least increase the chance of 
messages being delivered in order? I don't need a 100% guarantee and the 
data isn't mission-critical so the solution need not be absolutely 
bulletproof (nor extremely scalable as the load is basically nil).

I'm currently on 1.7.x (1.7.2 IIRC) but I can upgrade if that helps 
anything.

Best regards,
  Grzegorz Nosek

From alfonso.pantoja at gmail.com  Thu Jan 27 23:40:35 2011
From: alfonso.pantoja at gmail.com (Alfonso Pantoja)
Date: Fri, 28 Jan 2011 00:40:35 +0100
Subject: [rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET
 API: How it works?
In-Reply-To: <20110127043455.GC2357@dakota>
References: <AANLkTim_hB0XJ6C-4ZBtWifWvZtpmt5n+J1HvOe-3_wr@mail.gmail.com>
	<20110127043455.GC2357@dakota>
Message-ID: <AANLkTimuWUTRGv8azj2NqLnuuaZZhh1JRA9N039ivzjG@mail.gmail.com>

Hi Alex,


Firstly, thank you very much for your answer. You've really helped me.
As you suggested we'll update RabbitMQ to version 2.2.0 as soon as possible.
It is great you are introducing publisher confirms in next release because
it will offer more fine control to message publishing.


Regarding transfer responsibility I have one more doubt.
As you said, "TxCommit will succeed if messages are lost during routing (due
to non-existing queues)",
so does it mean that TxCommit launches an exception when it fails?

In this case in my code I should handle unexpected exceptions (txSelect,
basic.publish, txCommit) and also basic.return in cause immediate and/or
mandatory message can't be delivered, right?



Regards,

Alfonso




2011/1/27 Alexandru Scvor?ov <alexandru at rabbitmq.com>

> Hi Alfonso,
>
> > I've been googling a lot and some people suggested using this schema:
> >
> > ch.TxSelect()
> > ch.BasicPublish(.....)
> > ch.TxCommit()
> ...
> > Reading the API user guide I've found that this is called "transfer
> > responsibility".
>
> That's correct.  The only way right now to transfer responsibility for
> a message to the broker is using transactions.
>
> That said, I don't think it's exactly what you want.  The TxCommit will
> succeed if messages are lost during routing (due to non-existing
> queues).
>
>
> > My question is:
> >
> > Being TxCommit a void function I tested this block of code using a
> > non-existing routing key and I didn't get any exception.
> > Since safe publishing would be highly desiderable non routed messages
> should
> > be detected because the application ACKs the messages of "events queue"
> > when after evaluating its content has successfully sent another message
> to
> > the "results queue" (currently if a a routing key is not being routed to
> a
> > queue the messages are silently dropped and I have no way to detect the
> > failure so the application ACKs the messages from "events queue")
> >
> > Please, can someone tell me how I can't get that "CommitOK" responses?
>
> As far as I know, there's no way cause the broker to throw an exception
> for unroutable messages.
>
> What you could do instead is this:
>  - as you've suggested, publish with mandatory, immediate, and
>    persistent set;
>  - do publishes to persistent queues;
>  - wrap publishes in that tx code;
>  - have the publisher watch for basic.returns and handle somehow lost
>    messages (maybe rollback the transaction, republish to a different
>    and commit).
>
> The message flags and the transactions should ensure that the broker
> either save the messages to disk or send it to a consumer.  The
> ReturnHandler should allow you to republish or somehow handle lost
> messages.
>
> Basic.publish/basic.return aren't synchronous out of the box and aren't
> meant to be used like that.  For unroutable messages, the broker sends
> the basic.return immediately after processing the basic.publish, so if
> you publish to a non-existent queue, you should expect the basic.return
> soonish; you could use this to make publishes/returns somewhat
> synchronous, but I wouldn't recommend it.
>
> BTW, the AMQP spec says you shouldn't rely on the broker's behaviour
> when publishing mandatory/immediate messages inside transactions, but I
> think there are any pitfalls doing this with rabbit.
>
>
> As you may have guessed by now, the scenario you described isn't handled
> very nicely by AMQP.  We're introducing publisher confirms to remedy
> this.  The code's on default now, and should be in the next release.
> The basic idea is that the broker sends a basic.ack back to the
> publisher when it's dealt with a message.  In addition, the basic.return
> would always be sent before the basic.ack, so the publisher would know
> when the message is no longer its responsibility.  Of course, this
> isn't synchronous, but it is fast, and the logic is a lot simpler than
> trying to do the same thing with transactions.
>
>
> > PS: I'm using the API version 1.7.2 and RabbitMQ server is the same
> version.
>
> You really should upgrade.  Since 1.7.2, we've fixed lots of bugs
> (including a few serious ones), introduced a new persister (which is
> quite relevant if you care about transfer of responsibility) and added some
> very nice management and monitoring features (including a web UI).
> Publisher confirms are on default now, and should be in the next
> release.
>
>
> Hope this helps,
>
> Cheers,
> Alex
>
> On Mon, Jan 24, 2011 at 05:47:17PM +0100, Alfonso Pantoja wrote:
> > Hi,
> >
> > I've developed an application that consumes messages from a queue
> ("events
> > queue") and depending on their data
> > it publishes (per received message) a message to another queue ("results
> > queue")
> >
> > The logic that checks the content of the received messages is publishing
> > messages using BasicPublish (with mandatory=2, immediate=false and
> setting
> > deliveryMode=2 to the messages to be sent)
> > My concern is that BasicPublish is asynchronous  and the only exception I
> > can get is when there is no connection to RabbitMQ or the destination
> > exchange does not exist.
> >
> > Since the application logic at this point is synchronous I can't use
> > BasicReturn in order to use a handler when messages can't be delivered.
> >
> > I've been googling a lot and some people suggested using this schema:
> >
> > ch.TxSelect()
> > ch.BasicPublish(.....)
> > ch.TxCommit()
> >
> > and also is suggested that "commit-ok" will be returned if the message
> has
> > been published safely to the broker.
> >
> > Reading the API user guide I've found that this is called "transfer
> > responsibility".
> >
> > Copy & paste follows:
> >
> > --
> > To transfer responsibility for delivery of a message to a broker
> > ? ensure (ahead of time) that the target queue exists and is durable,
> > ? select Tx mode using IModel.TxSelect,
> > ? publish the message with the "mandatory" flag set and DeliveryMode set
> > equal to 2, and
> > ? commit the Tx transaction using IModel.TxCommit.
> >
> > Once a broker replies with CommitOk (i.e. the TxCommit() call returns to
> the
> > caller), it has taken
> > responsibility for keeping the message on disk and on the target queue
> until
> > some other application
> > retrieves and acknowledges the message.
> > A commit is not required after every message: batching of publications
> may
> > be done, depending on the
> > precise delivery guarantees the publishing application requires.
> > Responsibility can also be placed with an external database, even further
> > along the chain - see the section
> > on interaction with external resources below
> > ---
> >
> > My question is:
> >
> > Being TxCommit a void function I tested this block of code using a
> > non-existing routing key and I didn't get any exception.
> > Since safe publishing would be highly desiderable non routed messages
> should
> > be detected because the application ACKs the messages of "events queue"
> > when after evaluating its content has successfully sent another message
> to
> > the "results queue" (currently if a a routing key is not being routed to
> a
> > queue the messages are silently dropped and I have no way to detect the
> > failure so the application ACKs the messages from "events queue")
> >
> > Please, can someone tell me how I can't get that "CommitOK" responses?
> >
> >
> > Thank you in advance.
> >
> >
> > Alfonso
> >
> > PS: I'm using the API version 1.7.2 and RabbitMQ server is the same
> version.
>
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-discuss at lists.rabbitmq.com
> > https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110128/64fe947c/attachment-0001.htm>

From alexandru at rabbitmq.com  Fri Jan 28 00:13:36 2011
From: alexandru at rabbitmq.com (Alexandru =?utf-8?B?U2N2b3LFo292?=)
Date: Fri, 28 Jan 2011 02:13:36 +0200
Subject: [rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET
 API: How it works?
In-Reply-To: <AANLkTimuWUTRGv8azj2NqLnuuaZZhh1JRA9N039ivzjG@mail.gmail.com>
References: <AANLkTim_hB0XJ6C-4ZBtWifWvZtpmt5n+J1HvOe-3_wr@mail.gmail.com>
	<20110127043455.GC2357@dakota>
	<AANLkTimuWUTRGv8azj2NqLnuuaZZhh1JRA9N039ivzjG@mail.gmail.com>
Message-ID: <20110128001336.GA2352@dakota.doc.ic.ac.uk>

Alfonso,

> In this case in my code I should handle unexpected exceptions (txSelect,
> basic.publish, txCommit) and also basic.return in cause immediate and/or
> mandatory message can't be delivered, right?

Ah, you're right; I forgot about the exceptions.  So, yes, you need to
take into account both exceptions (failed commits) and basic.returns
(unroutable messages).

Cheers,
Alex


On Fri, Jan 28, 2011 at 12:40:35AM +0100, Alfonso Pantoja wrote:
> Hi Alex,
> 
> 
> Firstly, thank you very much for your answer. You've really helped me.
> As you suggested we'll update RabbitMQ to version 2.2.0 as soon as possible.
> It is great you are introducing publisher confirms in next release because
> it will offer more fine control to message publishing.
> 
> 
> Regarding transfer responsibility I have one more doubt.
> As you said, "TxCommit will succeed if messages are lost during routing (due
> to non-existing queues)",
> so does it mean that TxCommit launches an exception when it fails?
> 
> In this case in my code I should handle unexpected exceptions (txSelect,
> basic.publish, txCommit) and also basic.return in cause immediate and/or
> mandatory message can't be delivered, right?
> 
> 
> 
> Regards,
> 
> Alfonso
> 
> 
> 
> 
> 2011/1/27 Alexandru Scvor?ov <alexandru at rabbitmq.com>
> 
> > Hi Alfonso,
> >
> > > I've been googling a lot and some people suggested using this schema:
> > >
> > > ch.TxSelect()
> > > ch.BasicPublish(.....)
> > > ch.TxCommit()
> > ...
> > > Reading the API user guide I've found that this is called "transfer
> > > responsibility".
> >
> > That's correct.  The only way right now to transfer responsibility for
> > a message to the broker is using transactions.
> >
> > That said, I don't think it's exactly what you want.  The TxCommit will
> > succeed if messages are lost during routing (due to non-existing
> > queues).
> >
> >
> > > My question is:
> > >
> > > Being TxCommit a void function I tested this block of code using a
> > > non-existing routing key and I didn't get any exception.
> > > Since safe publishing would be highly desiderable non routed messages
> > should
> > > be detected because the application ACKs the messages of "events queue"
> > > when after evaluating its content has successfully sent another message
> > to
> > > the "results queue" (currently if a a routing key is not being routed to
> > a
> > > queue the messages are silently dropped and I have no way to detect the
> > > failure so the application ACKs the messages from "events queue")
> > >
> > > Please, can someone tell me how I can't get that "CommitOK" responses?
> >
> > As far as I know, there's no way cause the broker to throw an exception
> > for unroutable messages.
> >
> > What you could do instead is this:
> >  - as you've suggested, publish with mandatory, immediate, and
> >    persistent set;
> >  - do publishes to persistent queues;
> >  - wrap publishes in that tx code;
> >  - have the publisher watch for basic.returns and handle somehow lost
> >    messages (maybe rollback the transaction, republish to a different
> >    and commit).
> >
> > The message flags and the transactions should ensure that the broker
> > either save the messages to disk or send it to a consumer.  The
> > ReturnHandler should allow you to republish or somehow handle lost
> > messages.
> >
> > Basic.publish/basic.return aren't synchronous out of the box and aren't
> > meant to be used like that.  For unroutable messages, the broker sends
> > the basic.return immediately after processing the basic.publish, so if
> > you publish to a non-existent queue, you should expect the basic.return
> > soonish; you could use this to make publishes/returns somewhat
> > synchronous, but I wouldn't recommend it.
> >
> > BTW, the AMQP spec says you shouldn't rely on the broker's behaviour
> > when publishing mandatory/immediate messages inside transactions, but I
> > think there are any pitfalls doing this with rabbit.
> >
> >
> > As you may have guessed by now, the scenario you described isn't handled
> > very nicely by AMQP.  We're introducing publisher confirms to remedy
> > this.  The code's on default now, and should be in the next release.
> > The basic idea is that the broker sends a basic.ack back to the
> > publisher when it's dealt with a message.  In addition, the basic.return
> > would always be sent before the basic.ack, so the publisher would know
> > when the message is no longer its responsibility.  Of course, this
> > isn't synchronous, but it is fast, and the logic is a lot simpler than
> > trying to do the same thing with transactions.
> >
> >
> > > PS: I'm using the API version 1.7.2 and RabbitMQ server is the same
> > version.
> >
> > You really should upgrade.  Since 1.7.2, we've fixed lots of bugs
> > (including a few serious ones), introduced a new persister (which is
> > quite relevant if you care about transfer of responsibility) and added some
> > very nice management and monitoring features (including a web UI).
> > Publisher confirms are on default now, and should be in the next
> > release.
> >
> >
> > Hope this helps,
> >
> > Cheers,
> > Alex
> >
> > On Mon, Jan 24, 2011 at 05:47:17PM +0100, Alfonso Pantoja wrote:
> > > Hi,
> > >
> > > I've developed an application that consumes messages from a queue
> > ("events
> > > queue") and depending on their data
> > > it publishes (per received message) a message to another queue ("results
> > > queue")
> > >
> > > The logic that checks the content of the received messages is publishing
> > > messages using BasicPublish (with mandatory=2, immediate=false and
> > setting
> > > deliveryMode=2 to the messages to be sent)
> > > My concern is that BasicPublish is asynchronous  and the only exception I
> > > can get is when there is no connection to RabbitMQ or the destination
> > > exchange does not exist.
> > >
> > > Since the application logic at this point is synchronous I can't use
> > > BasicReturn in order to use a handler when messages can't be delivered.
> > >
> > > I've been googling a lot and some people suggested using this schema:
> > >
> > > ch.TxSelect()
> > > ch.BasicPublish(.....)
> > > ch.TxCommit()
> > >
> > > and also is suggested that "commit-ok" will be returned if the message
> > has
> > > been published safely to the broker.
> > >
> > > Reading the API user guide I've found that this is called "transfer
> > > responsibility".
> > >
> > > Copy & paste follows:
> > >
> > > --
> > > To transfer responsibility for delivery of a message to a broker
> > > ? ensure (ahead of time) that the target queue exists and is durable,
> > > ? select Tx mode using IModel.TxSelect,
> > > ? publish the message with the "mandatory" flag set and DeliveryMode set
> > > equal to 2, and
> > > ? commit the Tx transaction using IModel.TxCommit.
> > >
> > > Once a broker replies with CommitOk (i.e. the TxCommit() call returns to
> > the
> > > caller), it has taken
> > > responsibility for keeping the message on disk and on the target queue
> > until
> > > some other application
> > > retrieves and acknowledges the message.
> > > A commit is not required after every message: batching of publications
> > may
> > > be done, depending on the
> > > precise delivery guarantees the publishing application requires.
> > > Responsibility can also be placed with an external database, even further
> > > along the chain - see the section
> > > on interaction with external resources below
> > > ---
> > >
> > > My question is:
> > >
> > > Being TxCommit a void function I tested this block of code using a
> > > non-existing routing key and I didn't get any exception.
> > > Since safe publishing would be highly desiderable non routed messages
> > should
> > > be detected because the application ACKs the messages of "events queue"
> > > when after evaluating its content has successfully sent another message
> > to
> > > the "results queue" (currently if a a routing key is not being routed to
> > a
> > > queue the messages are silently dropped and I have no way to detect the
> > > failure so the application ACKs the messages from "events queue")
> > >
> > > Please, can someone tell me how I can't get that "CommitOK" responses?
> > >
> > >
> > > Thank you in advance.
> > >
> > >
> > > Alfonso
> > >
> > > PS: I'm using the API version 1.7.2 and RabbitMQ server is the same
> > version.
> >
> > > _______________________________________________
> > > rabbitmq-discuss mailing list
> > > rabbitmq-discuss at lists.rabbitmq.com
> > > https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> >
> >

From majek04 at gmail.com  Fri Jan 28 10:23:33 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 28 Jan 2011 10:23:33 +0000
Subject: [rabbitmq-discuss] pika.channel.basic_consume
In-Reply-To: <4D41CCF0.6090608@gmail.com>
References: <4D41CCF0.6090608@gmail.com>
Message-ID: <AANLkTi=JA+FGvi9MJdy-R6dy8pqS-qWcwA5PDZj9qvrv@mail.gmail.com>

On Thu, Jan 27, 2011 at 19:52, Marcin Krol <mrkafk at gmail.com> wrote:
> Can channel.basic_consume handle more than 1 callback?
>
> But when I use more than one callback (both on exclusive queues), only
> one of them works.
>
> ? ?chan.basic_consume(on_response_distrib, no_ack=True, queue=myqueue)
>
> ? ?chan.basic_consume(on_response_rdonly, no_ack=True, queue=myqueue)
>
> When I do setup_distrib(node) AND setup_rdonly(node), only rdonly queues
> work.
>
> When I do one or the other, either works.

As far as I can tell this is the correct behaviour. If you want the same
message to be delivered to multiple destinations use multiple queues.

Cheers,
  Marek

From majek04 at gmail.com  Fri Jan 28 11:58:27 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 28 Jan 2011 11:58:27 +0000
Subject: [rabbitmq-discuss] RabbitMQ management plugin memory usage in
	Chrome
In-Reply-To: <AANLkTinLwKRVQ-Nd7bnG_92G5jjwcoQExpUj5vVYkwU_@mail.gmail.com>
References: <985477893245CF449ABD4F01814A9FF65F41CB39E9@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D359B67.2030806@rabbitmq.com>
	<611FB1B444670A41A06F4C91C40041C75D049AB2A1@34093-MBX-C06.mex07a.mlsrvr.com>
	<985477893245CF449ABD4F01814A9FF65F41EE5541@34093-MBX-C06.mex07a.mlsrvr.com>
	<4D40AB04.8050709@rabbitmq.com>
	<AANLkTinLwKRVQ-Nd7bnG_92G5jjwcoQExpUj5vVYkwU_@mail.gmail.com>
Message-ID: <AANLkTi=NHab_Q2rUfR1w00sjpqt4kvPdL1Cp=rRw-QbR@mail.gmail.com>

Don't listen to me. I was completely wrong. Simple .innerHTML fix
solves the problem. IE still leaks and is completely useless.

Marek

On Thu, Jan 27, 2011 at 08:59, Marek Majkowski <majek04 at gmail.com> wrote:
> On Wed, Jan 26, 2011 at 23:15, Simon MacMullen <simon at rabbitmq.com> wrote:
>> On 25/01/2011 9:14AM, Jon Rowland wrote:
>>>
>>> I don't have Firefox but I tried this in IE 8.0 and get the same
>>> behaviour (1GB usage after leaving running overnight).
>>
>> Hmm. Not sure IE counts as much evidence for the bug being in the plugin :)
>>
>> But seeing the same problem in two browsers is a concern.
>>
>> But I still have no idea how to debug this kind of problem.
>>
>> But I'll have a look anyway.
>>
>> But I'm not promising anything.
>
> Simon,
>
> There definitely is a memory leak. Actually, not a memory
> leak - it's just the document that is growing, the
> elements aren't leaked, they are referenced somewhere.
>
> I did some debugging and I have some results.
> Though, there is probably still much to be said.
>
> 1. in main.js we use innerHTML in one place, it's helpful to
> ? ?zero the element out before that:
> http://javascript.crockford.com/memory/leak.html
>
> 2. I modified the purge() function above to unlink all childs,
> ? and it seems to work a bit better. (ie: explicitly unlink all
> ? elements of the tree)
>
> 3. The single biggest thing is IMO broken element caching
> ? ?in jQuery. Check out jQuery.fragments. It's growing...
> ? ?Removing this cache by hacking jQuery brought
> ? ?wonderful results. (there is also jQuery.cache, but
> ? ?I haven't played with that).
> ? ?Basically, in one of the tests I noticed that Dom nodes
> ? ?"document-fragment" were using the majority of memory.
>
> 4. In the queue view ?there is a gc-cycle in the <form>
> ? ?responsible for adding a queue. I'm not sure what
> ? ?can be done about that.
>
> 5. In some other test I noticed that "slideUp/Down" and
> ? ?"toggleUp/Down" methods were increasing memory
> ? ?usage significantly, but that may be a false lead,
> ? ?as it may have something to do with the 'document-fragment'
> ? ?issue mentioned above.
>
> 6. For debugging I used 'sieve' for IE.
> ? ? ?http://home.wanadoo.nl/jsrosman/
> ? ?It's a simple tool but allows traversing the DOM and looking
> ? ?at what contains what. It would be nice to find a similar
> ? ?tool for chrome and firefox.
>
>
> Cheers,
> ?Marek
>

From jim at rabbitmq.com  Fri Jan 28 12:51:19 2011
From: jim at rabbitmq.com (Jim Apperly)
Date: Fri, 28 Jan 2011 12:51:19 +0000
Subject: [rabbitmq-discuss] Massive distributed pub/sub system
In-Reply-To: <AANLkTimCxsRP4ceCGbErPpr0W3n_MOM7j5MFiMHz4SNp@mail.gmail.com>
References: <AANLkTikD2fMdS_sdc8cRvEWCQeyL2PyP7KVFf5ncwXme@mail.gmail.com>
	<4D4189F4.6010609@rabbitmq.com>
	<AANLkTimCxsRP4ceCGbErPpr0W3n_MOM7j5MFiMHz4SNp@mail.gmail.com>
Message-ID: <AANLkTi=dUObt7azQRystVBOGLEk=_69NczfoceOKeCO8@mail.gmail.com>

On 27 January 2011 19:25, Jim Irrer <irrer at umich.edu> wrote:

> Would XMPP be more appropriate for this application?  I'm not real
> familiar with it but I've heard that it has different strengths than AMQP.
> I'm interested in the pros and cons.
>

This may help shed some light:
http://www.opensourcery.co.za/2009/04/19/to-amqp-or-to-xmpp-that-is-the-question/

Jim



Thanks,
>
> - Jim
>
> Jim Irrer     irrer at umich.edu       (734) 647-4409
> University of Michigan Hospital Radiation Oncology
> 519 W. William St.             Ann Arbor, MI 48103
>
>
>
> On Thu, Jan 27, 2011 at 10:06 AM, Michael Bridgen <mikeb at rabbitmq.com>wrote:
>
>> Hi Kaiduan,
>>
>> Your questions suggest you're attempting something very interesting, which
>> I would love to hear more about.  Federation and distribution are very much
>> on our minds here at Rabbit Towers, as you might imagine.
>>
>> In the meantime ---
>>
>>
>>  1) Any user can subscribe to the interested topic, but only topic
>>> owner can publish message to the group. There is no limit on the
>>> number of subscribers in each group. Potentially it can be huge, for
>>> example, the fans of U2 around the world.
>>>
>>
>> Is there anything that determines who can own topics?  For example, is it
>> just the first person to declare a topic that is the exclusive publisher to
>> that topic?  Can the publishing rights, so to speak, be handed to another
>> publisher?
>>
>>
>>  2) User including subscriber and publisher is not always connected to
>>> the system, and not always connected to the same node in the system,
>>> and the message delivery should be guaranteed. When publisher
>>> publishes a message, the system should deliver the message to all
>>> subscribers. If the subscriber is connected to the system, the message
>>> should be delivered immediately. If the subscriber is not connected,
>>> system should hold the message, and the next time the user comes
>>> connected, system will deliver the message to the user. Just imagine
>>> the user can be any mobile user and moves out of cellular coverage.
>>>
>>
>> So far as I know, this is still an area of active research.  Typically,
>> distributed pub/sub systems like Scribe and Hermes give rather weak
>> guarantees of delivery and ordering and so on.
>>
>> In particular, "If the subscriber is not connected, system should hold the
>> message, and the next time the user comes connected, system will deliver the
>> message to the user" is difficult if the subscriber can connect to any node,
>> and I don't think most pub/sub systems would allow that.
>>
>>
>>  3) The system should be able to support tens to hundreds of millions
>>> users spreading around the world, so the system will consist hundred
>>> of nodes located in different physical locations.
>>>
>>
>> This is rather ambitious.  But systems on this kind of scale are indeed
>> being built: http://ci.oceanobservatories.org/ for instance.
>>
>>
>>  4) The number of topics/groups in the system is unlimited.
>>>
>>> 5) As to the latency, it should be in the range of 1 minute if
>>> subscriber is connected.
>>>
>>> It looks like RabbitMQ already has functionalities to meet the above
>>> requirement, for example, fan out exchange, and persistent message.
>>> The following is my understanding on how to build the above system
>>> with RabbitMQ,
>>>
>>
>> Perhaps, in the sense that it can be a building block.  But it doesn't
>> fulfill all the requirements you've given above, "out of the box".  In other
>> words, you (or we) would have to invent a substantial part of the
>> technology.
>>
>>
>>  a) Publisher creates an exchange. For example, U2 creates an exchange
>>> noted as "U2" for "U2's next world wide tour" on Node 1.
>>>
>>> b) Each subscriber creates a queue in the system. For example, Alice
>>> creates a queue noted as "Alice" on Node 2 and binds to exchange U2;
>>> and Bob creates a queue noted as "Bob" on Node 3 and binds to exchange
>>> "U2" on Node 2.
>>>
>>> c) U2 publishes a message, m1 on Node 1 to exchange "U2"; and RabbitMQ
>>> will deliver the message m1 to queue "Alice" on Node 2 and to queue
>>> "Bob" on Node 3.
>>>
>>> How we handles the following scenarios?
>>>
>>> 1) When U2 wants to publish a message, but Node 1 is done.
>>>
>>> 2) When message m1 is delivered to queue "Alice" on Node 2, Node 2
>>> crashed or the network link between Node 1 (publisher's node) is
>>> disconnected? Will exchange "U2" on Node 1 persist the message?
>>>
>>
>> No; the message will be lost so far as Alice is concerned.  In AMQP terms,
>> you're asking for queues to be replicated.  Rabbit doesn't do this, yet.
>>
>> (Actually, we are working on queue replication right now.  I think you
>> would need both replication and some kind of queue migration or
>> distribution.)
>>
>>
>>  3) After message m1 is arrived on queue "Alice", but the connection
>>> between Alice and Node 2 is gone, the message will be stored on Node
>>> 2, right? Next time, Alice connects to the system, but she is
>>> connected to Node n instead of Node 2, how to handle this?
>>>
>>
>> In Rabbit's clustering as it works now, the messages will be delivered
>> across the cluster to Node n.
>>
>>
>>  4) What is the multi-cast technology used in RabbitMQ to deliver the
>>> message to queues located on different locations spreading around
>>> different countries?
>>>
>>
>> There isn't any right now.  Clustering is really for nodes that are
>> co-located and have reliable connections.  It uses Erlang's distribution
>> mechanism, which essentially forms a fully-connected graph of nodes.  It
>> doesn't really scale beyond a handful of nodes.
>>
>> There /is/ a plugin called the "shovel", which will relay messages from
>> one broker to another.  However, it is statically configured, and
>> constrained by using AMQP to do the relaying (i.e., you cannot tell it to
>> relay all messages from a direct exchange; only to relay, e.g., messages
>> with a particular routing key).
>>
>>
>> Regards,
>> Michael
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110128/6a6703b0/attachment.htm>

From majek04 at gmail.com  Fri Jan 28 13:26:18 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 28 Jan 2011 13:26:18 +0000
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <4D41FA5E.8030602@localdomain.pl>
References: <4D41FA5E.8030602@localdomain.pl>
Message-ID: <AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>

On Thu, Jan 27, 2011 at 23:06, Grzegorz Nosek <root at localdomain.pl> wrote:
> While googling for "rabbitmq redelivery order" I found this gem:
>
> http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-October/005078.html
>
>> Those who rely on the broker preserving perfect [...] ordering are kind of
>> doomed.
>
> so I'm not keeping my hopes too high, but still, it shouldn't hurt too much
> to ask ;)
>
> Is there a setup (of exchanges, queues etc.) that tries to preserve ordering
> of messages when faced with consumer failure? I have a very simple setup
> consisting of a bunch of producers feeding data via a single queue to a
> consumer that stuffs it into RRD files (which must be updated in order or
> require deeper surgery involving dump/restore). At one time the consumer
> happened to fail and RabbitMQ started to buffer the messages, which then got
> redelivered in (apparently) totally random order, so RRD dropped most of
> them anyway.
>
> So, is there anything I can do to at least increase the chance of messages
> being delivered in order? I don't need a 100% guarantee and the data isn't
> mission-critical so the solution need not be absolutely bulletproof (nor
> extremely scalable as the load is basically nil).

When a message is delivered to the consumer, with acks (no_ack=False),
and the consumer goes away, the message will be redelivered as
to the queue. It will appear as "last" element.

So yes, in the event of a failure the ordering gets broken.

You can reduce number of messages that will be delivered
to the consumer by setting basic.qos(prefetch_count=1).

That way the consumer will at any given moment have
at most 1 unacknowledged message.

But you pay the latency costs - a new message
will be send only after the ack will be delivered to server.

Cheers,
  Marek

From root at localdomain.pl  Fri Jan 28 13:41:44 2011
From: root at localdomain.pl (Grzegorz Nosek)
Date: Fri, 28 Jan 2011 14:41:44 +0100
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>
References: <4D41FA5E.8030602@localdomain.pl>
	<AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>
Message-ID: <4D42C798.5020106@localdomain.pl>

W dniu 28.01.2011 14:26, Marek Majkowski pisze:
> When a message is delivered to the consumer, with acks (no_ack=False),
> and the consumer goes away, the message will be redelivered as
> to the queue. It will appear as "last" element.
>
> So yes, in the event of a failure the ordering gets broken.
>
> You can reduce number of messages that will be delivered
> to the consumer by setting basic.qos(prefetch_count=1).
>
> That way the consumer will at any given moment have
> at most 1 unacknowledged message.

Thanks for your response.

I'm not sure I understand correctly, so please confirm or correct me in 
the following.

The messages were all considered delivered_but_not_yet_acked, even 
though the consumer wasn't even connected, so after the consumer 
returned, all the messages were REdelivered from RabbitMQ's perspective, 
which broke the ordering.

If prefetch_count=1 had been set, there would be at most one message in 
this state, so the reordering would happen only to it (so, no effect).

Right?

 > But you pay the latency costs - a new message
 > will be send only after the ack will be delivered to server.

Not a problem for me. In any case, I suppose I could set the 
prefetch_count to something comparable to the number of independent RRD 
archives as they're updated at roughly the same intervals so I'd get low 
latency and minimal risk of data loss.

Best regards,
  Grzegorz Nosek

From majek04 at gmail.com  Fri Jan 28 14:00:45 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 28 Jan 2011 14:00:45 +0000
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <4D42C798.5020106@localdomain.pl>
References: <4D41FA5E.8030602@localdomain.pl>
	<AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>
	<4D42C798.5020106@localdomain.pl>
Message-ID: <AANLkTim7dkZeTEzx3NJkbqrwTm9YMZ9SRQQ0eU5G0NTr@mail.gmail.com>

On Fri, Jan 28, 2011 at 13:41, Grzegorz Nosek <root at localdomain.pl> wrote:
> W dniu 28.01.2011 14:26, Marek Majkowski pisze:
>> When a message is delivered to the consumer, with acks (no_ack=False),
>> and the consumer goes away, the message will be redelivered as
>> to the queue. It will appear as "last" element.
>>
>> So yes, in the event of a failure the ordering gets broken.
>>
>> You can reduce number of messages that will be delivered
>> to the consumer by setting basic.qos(prefetch_count=1).
>>
>> That way the consumer will at any given moment have
>> at most 1 unacknowledged message.
>
> The messages were all considered delivered_but_not_yet_acked, even though
> the consumer wasn't even connected, so after the consumer returned, all the
> messages were REdelivered from RabbitMQ's perspective, which broke the
> ordering.

Yes. The messages which are delivered-but-not-yet-acked will be redelivered
when the consumer disconnects. That breaks the ordering.

> If prefetch_count=1 had been set, there would be at most one message in this
> state, so the reordering would happen only to it (so, no effect).

Correct.

>> But you pay the latency costs - a new message
>> will be send only after the ack will be delivered to server.
>
> Not a problem for me. In any case, I suppose I could set the prefetch_count
> to something comparable to the number of independent RRD archives as they're
> updated at roughly the same intervals so I'd get low latency and minimal
> risk of data loss.

Sounds reasonable.

Cheers,
  Marek

From mrkafk at gmail.com  Fri Jan 28 14:03:29 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Fri, 28 Jan 2011 15:03:29 +0100
Subject: [rabbitmq-discuss] pika.channel.basic_consume
In-Reply-To: <AANLkTimAs5udmDEu1xeBXzY_yRw2NjyVQtjXJkMafA=J@mail.gmail.com>
References: <4D41CCF0.6090608@gmail.com>
	<AANLkTimAs5udmDEu1xeBXzY_yRw2NjyVQtjXJkMafA=J@mail.gmail.com>
Message-ID: <4D42CCB1.20505@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Gavin M. Roy wrote:
> On Thu, Jan 27, 2011 at 2:52 PM, Marcin Krol <mrkafk at gmail.com> wrote:
> 
>> Can channel.basic_consume handle more than 1 callback?
> 
> It can't right now, but I am working on the next version and would
> consider adding it for good reason. Is there a reason you want to do
> this? 

Well, basically I need to do 2 kinds of RPC using the same client and
server: read-write kind of RPC is distributed among all the servers in a
cluster ("data safety through redundancy" reason), while another
(read-only) kind of RPC executes only in the server that the client
connected to.

I could see from a not delivering the same message twice but you
> could just use a fanout exchange and bind both consumers to this.

I need to run one or the other, not both, as consumers are somewhat
different. That's why I used 2 different exchanges for 2 callback queues.


- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNQsywAAoJEFMgHzhQQ7hOcvoH/3KCTURl+2kGDyWcxm9yrKHC
s8e+h81YH5/tUPFZT4Bpo7aOOho/z4yWwOGe8ZSNQGakorhgChpt3IVQvANkXgGM
wji6nEExbXOH47XW7qmsaI0HeYAknQHOB/tCdHZXrMLl/TDTYeUPwoa60gmDfGVn
zPlZeX/eNAUaBjvhhvTWcvigk5K5NCRxlsUHFYhxQxqpL1NyVj/qUnbGT3M/oKPo
cMTrcdqNVVNlvCJT1csDC8SScHIZ2AO1WtwDJeooXhWxRkeY7XQOFR86PoHcFI2h
BmBcxwSl1Equ+B/pUU2ZEXuWsLWxT5LLpRfoBA2Il4fh3dP7wb5kWLgdz3XClJA=
=zOUH
-----END PGP SIGNATURE-----

From majek04 at gmail.com  Fri Jan 28 14:15:13 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 28 Jan 2011 14:15:13 +0000
Subject: [rabbitmq-discuss] pika.channel.basic_consume
In-Reply-To: <4D42CCB1.20505@gmail.com>
References: <4D41CCF0.6090608@gmail.com>
	<AANLkTimAs5udmDEu1xeBXzY_yRw2NjyVQtjXJkMafA=J@mail.gmail.com>
	<4D42CCB1.20505@gmail.com>
Message-ID: <AANLkTincNC94HB2YGw7ijO6WoFs_NtM73X3XUZsq+H0g@mail.gmail.com>

On Fri, Jan 28, 2011 at 14:03, Marcin Krol <mrkafk at gmail.com> wrote:
> Gavin M. Roy wrote:
>> On Thu, Jan 27, 2011 at 2:52 PM, Marcin Krol <mrkafk at gmail.com> wrote:
>>
>>> Can channel.basic_consume handle more than 1 callback?
>>
>> It can't right now, but I am working on the next version and would
>> consider adding it for good reason. Is there a reason you want to do
>> this?
>
> Well, basically I need to do 2 kinds of RPC using the same client and
> server: read-write kind of RPC is distributed among all the servers in a
> cluster ("data safety through redundancy" reason), while another
> (read-only) kind of RPC executes only in the server that the client
> connected to.
>
> I could see from a not delivering the same message twice but you
>> could just use a fanout exchange and bind both consumers to this.
>
> I need to run one or the other, not both, as consumers are somewhat
> different. That's why I used 2 different exchanges for 2 callback queues.

Right. Now I can see it, you indeed use two different queues,
reusing the same variable name confused me.

In such case when you enter asyncore.loop()
one callback should be called when message
arrives to one queue and the other callback should
be called on message arrives in the other queue.

Marek

From root at localdomain.pl  Fri Jan 28 14:29:59 2011
From: root at localdomain.pl (Grzegorz Nosek)
Date: Fri, 28 Jan 2011 15:29:59 +0100
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <AANLkTim7dkZeTEzx3NJkbqrwTm9YMZ9SRQQ0eU5G0NTr@mail.gmail.com>
References: <4D41FA5E.8030602@localdomain.pl>	<AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>	<4D42C798.5020106@localdomain.pl>
	<AANLkTim7dkZeTEzx3NJkbqrwTm9YMZ9SRQQ0eU5G0NTr@mail.gmail.com>
Message-ID: <4D42D2E7.3010403@localdomain.pl>

W dniu 28.01.2011 15:00, Marek Majkowski pisze:
> Yes. The messages which are delivered-but-not-yet-acked will be redelivered
> when the consumer disconnects. That breaks the ordering.

So "delivered" means to a queue, not to a consumer, right (there was no 
consumer present at that time to be delivered to)?

>> If prefetch_count=1 had been set, there would be at most one message in this
>> state, so the reordering would happen only to it (so, no effect).
>
> Correct.

Thanks a lot.

Best regards,
  Grzegorz Nosek

From majek04 at gmail.com  Fri Jan 28 15:01:36 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 28 Jan 2011 15:01:36 +0000
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <4D42D2E7.3010403@localdomain.pl>
References: <4D41FA5E.8030602@localdomain.pl>
	<AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>
	<4D42C798.5020106@localdomain.pl>
	<AANLkTim7dkZeTEzx3NJkbqrwTm9YMZ9SRQQ0eU5G0NTr@mail.gmail.com>
	<4D42D2E7.3010403@localdomain.pl>
Message-ID: <AANLkTin69vHdj=aGD=YAOfrP+A4qhZYZ0dmJw=dbB9_R@mail.gmail.com>

On Fri, Jan 28, 2011 at 14:29, Grzegorz Nosek <root at localdomain.pl> wrote:
> W dniu 28.01.2011 15:00, Marek Majkowski pisze:
>>
>> Yes. The messages which are delivered-but-not-yet-acked will be
>> redelivered
>> when the consumer disconnects. That breaks the ordering.
>
> So "delivered" means to a queue, not to a consumer,

Both, depending on context :)

> right (there was no consumer present at that time to be delivered to)?

When you "publish" a message, it's going to be delivered to the queue.

A queue is a FIFO structure.

When you do "basic_consume" or "basic_get", from your
program (let's call this program a "consumer"), a message
gets send over the wire from the server to the consumer,
and it's delivered to your "consumer".

At that point two things can happen:
 a) your consumer send "basic_ack" back to the server,
     and server gets rid of the message.
 b) your consumer may die. In which case the server
    will notice it, and "redeliver" the unacknowledged message(s)
    back to the queue.




>>> If prefetch_count=1 had been set, there would be at most one message in
>>> this
>>> state, so the reordering would happen only to it (so, no effect).
>>
>> Correct.
>
> Thanks a lot.
>
> Best regards,
> ?Grzegorz Nosek
>

From root at localdomain.pl  Fri Jan 28 15:16:18 2011
From: root at localdomain.pl (Grzegorz Nosek)
Date: Fri, 28 Jan 2011 16:16:18 +0100
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <AANLkTin69vHdj=aGD=YAOfrP+A4qhZYZ0dmJw=dbB9_R@mail.gmail.com>
References: <4D41FA5E.8030602@localdomain.pl>	<AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>	<4D42C798.5020106@localdomain.pl>	<AANLkTim7dkZeTEzx3NJkbqrwTm9YMZ9SRQQ0eU5G0NTr@mail.gmail.com>	<4D42D2E7.3010403@localdomain.pl>
	<AANLkTin69vHdj=aGD=YAOfrP+A4qhZYZ0dmJw=dbB9_R@mail.gmail.com>
Message-ID: <4D42DDC2.5090509@localdomain.pl>

W dniu 28.01.2011 16:01, Marek Majkowski pisze:
>> So "delivered" means to a queue, not to a consumer,
>
> Both, depending on context :)

Oh. ;)

> A queue is a FIFO structure.
>
> When you do "basic_consume" or "basic_get", from your
> program (let's call this program a "consumer"), a message
> gets send over the wire from the server to the consumer,
> and it's delivered to your "consumer".
>
> At that point two things can happen:

(...)

Well, we didn't even get to that point as the only consumer disconnected 
a few seconds earlier leaving an empty, non-autodelete queue. Does the 
first consumer binding to a queue trigger:

a) _delivery_ of the accumulated messages (with ordering preserved)

or

b) _redelivery_ (with no ordering guarantees)

?

If a) is true, then I screwed up somewhere else and need to find out 
where but if b) is the case, then it explains what I have seen even if 
it's not intuitive (who was the original delivery to, if this new 
consumer is the first one these messages have ever seen?)

Apologies for probably dumb questions but I'd rather grok the issue.

Best regards,
  Grzegorz Nosek

From majek04 at gmail.com  Fri Jan 28 15:32:45 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 28 Jan 2011 15:32:45 +0000
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <4D42DDC2.5090509@localdomain.pl>
References: <4D41FA5E.8030602@localdomain.pl>
	<AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>
	<4D42C798.5020106@localdomain.pl>
	<AANLkTim7dkZeTEzx3NJkbqrwTm9YMZ9SRQQ0eU5G0NTr@mail.gmail.com>
	<4D42D2E7.3010403@localdomain.pl>
	<AANLkTin69vHdj=aGD=YAOfrP+A4qhZYZ0dmJw=dbB9_R@mail.gmail.com>
	<4D42DDC2.5090509@localdomain.pl>
Message-ID: <AANLkTima6n=j4Qr682tfsZmRWb9kLGJFZwJn+o_MtdM0@mail.gmail.com>

On Fri, Jan 28, 2011 at 15:16, Grzegorz Nosek <root at localdomain.pl> wrote:
>>> So "delivered" means to a queue, not to a consumer,
>>
>> Both, depending on context :)
>
> Oh. ;)
>
>> A queue is a FIFO structure.
>>
>> When you do "basic_consume" or "basic_get", from your
>> program (let's call this program a "consumer"), a message
>> gets send over the wire from the server to the consumer,
>> and it's delivered to your "consumer".
>>
>> At that point two things can happen:
>
> (...)
>
> Well, we didn't even get to that point as the only consumer disconnected a
> few seconds earlier leaving an empty, non-autodelete queue. Does the first
> consumer binding to a queue trigger:
>
> a) _delivery_ of the accumulated messages (with ordering preserved)
>
> or
>
> b) _redelivery_ (with no ordering guarantees)
>
> ?
>
> If a) is true, then I screwed up somewhere else and need to find out where
> but if b) is the case, then it explains what I have seen even if it's not
> intuitive (who was the original delivery to, if this new consumer is the
> first one these messages have ever seen?)

Rather a). I guess you forgot to call "basic_ack" after a message.
Check out the "forgotten acknowledgement" box here:
  http://www.rabbitmq.com/tutorial-two-python.html

When first consumer "subscribes" to a queue (using basic_consume),
messages will be just delivered to it. Without 'basic_qos(prefetch_count)'
*all* the messages will be immediately delivered to that consumer.
(note: that's not exactly true).

Nothing else happens on subscription.

The "redelivery of unacked messages back to the queue" happens when
consumer gets *disconnected*.

From root at localdomain.pl  Fri Jan 28 15:44:08 2011
From: root at localdomain.pl (Grzegorz Nosek)
Date: Fri, 28 Jan 2011 16:44:08 +0100
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <AANLkTima6n=j4Qr682tfsZmRWb9kLGJFZwJn+o_MtdM0@mail.gmail.com>
References: <4D41FA5E.8030602@localdomain.pl>	<AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>	<4D42C798.5020106@localdomain.pl>	<AANLkTim7dkZeTEzx3NJkbqrwTm9YMZ9SRQQ0eU5G0NTr@mail.gmail.com>	<4D42D2E7.3010403@localdomain.pl>	<AANLkTin69vHdj=aGD=YAOfrP+A4qhZYZ0dmJw=dbB9_R@mail.gmail.com>	<4D42DDC2.5090509@localdomain.pl>
	<AANLkTima6n=j4Qr682tfsZmRWb9kLGJFZwJn+o_MtdM0@mail.gmail.com>
Message-ID: <4D42E448.4030501@localdomain.pl>

W dniu 28.01.2011 16:32, Marek Majkowski pisze:
> Rather a). I guess you forgot to call "basic_ack" after a message.

I do call chan.basic_ack() after processing the message, otherwise the 
messages would accumulate in the broker forever (or the messages would 
be auto acked so shouldn't ever trigger redelivery). Or am I severely 
mistaken here?

 > Check out the "forgotten acknowledgement" box here:
 >    http://www.rabbitmq.com/tutorial-two-python.html

Nope, no unacknowledged messages here.

> When first consumer "subscribes" to a queue (using basic_consume),
> messages will be just delivered to it. Without 'basic_qos(prefetch_count)'
> *all* the messages will be immediately delivered to that consumer.
> (note: that's not exactly true).
>
> Nothing else happens on subscription.
>
> The "redelivery of unacked messages back to the queue" happens when
> consumer gets *disconnected*.

OK but that still does not explain what I have observed. The messages in 
the queue have never been delivered (successfully or otherwise) to 
anybody before, because they were published after the original consumer 
was gone (and before the new one that eventually got them connected).

Best regards,
  Grzegorz Nosek

From majek04 at gmail.com  Fri Jan 28 16:32:40 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Fri, 28 Jan 2011 16:32:40 +0000
Subject: [rabbitmq-discuss] Ordering of redelivered messages?
In-Reply-To: <4D42E448.4030501@localdomain.pl>
References: <4D41FA5E.8030602@localdomain.pl>
	<AANLkTimvrfdf+b6J6qLJcNrJQQ9-4rPeNEaJbHbBTMor@mail.gmail.com>
	<4D42C798.5020106@localdomain.pl>
	<AANLkTim7dkZeTEzx3NJkbqrwTm9YMZ9SRQQ0eU5G0NTr@mail.gmail.com>
	<4D42D2E7.3010403@localdomain.pl>
	<AANLkTin69vHdj=aGD=YAOfrP+A4qhZYZ0dmJw=dbB9_R@mail.gmail.com>
	<4D42DDC2.5090509@localdomain.pl>
	<AANLkTima6n=j4Qr682tfsZmRWb9kLGJFZwJn+o_MtdM0@mail.gmail.com>
	<4D42E448.4030501@localdomain.pl>
Message-ID: <AANLkTinR=sg6rgom25=B=NinWTyWkdHYOqNPabfGgydf@mail.gmail.com>

On Fri, Jan 28, 2011 at 15:44, Grzegorz Nosek <root at localdomain.pl> wrote:
> W dniu 28.01.2011 16:32, Marek Majkowski pisze:
>>
>> Rather a). I guess you forgot to call "basic_ack" after a message.
>
> I do call chan.basic_ack() after processing the message, otherwise the
> messages would accumulate in the broker forever (or the messages would be
> auto acked so shouldn't ever trigger redelivery). Or am I severely mistaken
> here?
>
>> Check out the "forgotten acknowledgement" box here:
>> ? ?http://www.rabbitmq.com/tutorial-two-python.html
>
> Nope, no unacknowledged messages here.

Okay.

>> When first consumer "subscribes" to a queue (using basic_consume),
>> messages will be just delivered to it. Without 'basic_qos(prefetch_count)'
>> *all* the messages will be immediately delivered to that consumer.
>> (note: that's not exactly true).
>>
>> Nothing else happens on subscription.
>>
>> The "redelivery of unacked messages back to the queue" happens when
>> consumer gets *disconnected*.
>
> OK but that still does not explain what I have observed. The messages in the
> queue have never been delivered (successfully or otherwise) to anybody
> before,

In such case they will be delivered to the consumer in the same order they
were delivered to the queue.

> because they were published after the original consumer was gone
> (and before the new one that eventually got them connected).

From taylste at gmail.com  Fri Jan 28 18:29:15 2011
From: taylste at gmail.com (Steven Taylor)
Date: Fri, 28 Jan 2011 18:29:15 +0000
Subject: [rabbitmq-discuss] Massive distributed pub/sub system
In-Reply-To: <AANLkTi=dUObt7azQRystVBOGLEk=_69NczfoceOKeCO8@mail.gmail.com>
References: <AANLkTikD2fMdS_sdc8cRvEWCQeyL2PyP7KVFf5ncwXme@mail.gmail.com>
	<4D4189F4.6010609@rabbitmq.com>
	<AANLkTimCxsRP4ceCGbErPpr0W3n_MOM7j5MFiMHz4SNp@mail.gmail.com>
	<AANLkTi=dUObt7azQRystVBOGLEk=_69NczfoceOKeCO8@mail.gmail.com>
Message-ID: <AANLkTin6HdbBRy850+MiTQtNxBGRPBisjCxEV9tJb+XH@mail.gmail.com>

 I know it's off topic, but

On that link, apparently he uses Ruot for workflow... and Rackspace are a
user.
 "
http://www.opensourcery.co.za/2009/04/19/to-amqp-or-to-xmpp-that-is-the-question/
"

Is Ruot any good? The comment "it's not a state machine" has me curious.

thanks,
-Steven


On 28 January 2011 12:51, Jim Apperly <jim at rabbitmq.com> wrote:

>  On 27 January 2011 19:25, Jim Irrer <irrer at umich.edu> wrote:
>
>> Would XMPP be more appropriate for this application?  I'm not real
>> familiar with it but I've heard that it has different strengths than AMQP.
>> I'm interested in the pros and cons.
>>
>
> This may help shed some light:
>
> http://www.opensourcery.co.za/2009/04/19/to-amqp-or-to-xmpp-that-is-the-question/
>
> Jim
>
>
>
> Thanks,
>>
>> - Jim
>>
>> Jim Irrer     irrer at umich.edu       (734) 647-4409
>> University of Michigan Hospital Radiation Oncology
>> 519 W. William St.             Ann Arbor, MI 48103
>>
>>
>>
>> On Thu, Jan 27, 2011 at 10:06 AM, Michael Bridgen <mikeb at rabbitmq.com>wrote:
>>
>>> Hi Kaiduan,
>>>
>>> Your questions suggest you're attempting something very interesting,
>>> which I would love to hear more about.  Federation and distribution are very
>>> much on our minds here at Rabbit Towers, as you might imagine.
>>>
>>> In the meantime ---
>>>
>>>
>>> 1) Any user can subscribe to the interested topic, but only topic
>>>> owner can publish message to the group. There is no limit on the
>>>> number of subscribers in each group. Potentially it can be huge, for
>>>> example, the fans of U2 around the world.
>>>>
>>>
>>> Is there anything that determines who can own topics?  For example, is it
>>> just the first person to declare a topic that is the exclusive publisher to
>>> that topic?  Can the publishing rights, so to speak, be handed to another
>>> publisher?
>>>
>>>
>>> 2) User including subscriber and publisher is not always connected to
>>>> the system, and not always connected to the same node in the system,
>>>> and the message delivery should be guaranteed. When publisher
>>>> publishes a message, the system should deliver the message to all
>>>> subscribers. If the subscriber is connected to the system, the message
>>>> should be delivered immediately. If the subscriber is not connected,
>>>> system should hold the message, and the next time the user comes
>>>> connected, system will deliver the message to the user. Just imagine
>>>> the user can be any mobile user and moves out of cellular coverage.
>>>>
>>>
>>> So far as I know, this is still an area of active research.  Typically,
>>> distributed pub/sub systems like Scribe and Hermes give rather weak
>>> guarantees of delivery and ordering and so on.
>>>
>>> In particular, "If the subscriber is not connected, system should hold
>>> the message, and the next time the user comes connected, system will deliver
>>> the message to the user" is difficult if the subscriber can connect to any
>>> node, and I don't think most pub/sub systems would allow that.
>>>
>>>
>>> 3) The system should be able to support tens to hundreds of millions
>>>> users spreading around the world, so the system will consist hundred
>>>> of nodes located in different physical locations.
>>>>
>>>
>>> This is rather ambitious.  But systems on this kind of scale are indeed
>>> being built: http://ci.oceanobservatories.org/ for instance.
>>>
>>>
>>> 4) The number of topics/groups in the system is unlimited.
>>>>
>>>> 5) As to the latency, it should be in the range of 1 minute if
>>>> subscriber is connected.
>>>>
>>>> It looks like RabbitMQ already has functionalities to meet the above
>>>> requirement, for example, fan out exchange, and persistent message.
>>>> The following is my understanding on how to build the above system
>>>> with RabbitMQ,
>>>>
>>>
>>> Perhaps, in the sense that it can be a building block.  But it doesn't
>>> fulfill all the requirements you've given above, "out of the box".  In other
>>> words, you (or we) would have to invent a substantial part of the
>>> technology.
>>>
>>>
>>> a) Publisher creates an exchange. For example, U2 creates an exchange
>>>> noted as "U2" for "U2's next world wide tour" on Node 1.
>>>>
>>>> b) Each subscriber creates a queue in the system. For example, Alice
>>>> creates a queue noted as "Alice" on Node 2 and binds to exchange U2;
>>>> and Bob creates a queue noted as "Bob" on Node 3 and binds to exchange
>>>> "U2" on Node 2.
>>>>
>>>> c) U2 publishes a message, m1 on Node 1 to exchange "U2"; and RabbitMQ
>>>> will deliver the message m1 to queue "Alice" on Node 2 and to queue
>>>> "Bob" on Node 3.
>>>>
>>>> How we handles the following scenarios?
>>>>
>>>> 1) When U2 wants to publish a message, but Node 1 is done.
>>>>
>>>> 2) When message m1 is delivered to queue "Alice" on Node 2, Node 2
>>>> crashed or the network link between Node 1 (publisher's node) is
>>>> disconnected? Will exchange "U2" on Node 1 persist the message?
>>>>
>>>
>>> No; the message will be lost so far as Alice is concerned.  In AMQP
>>> terms, you're asking for queues to be replicated.  Rabbit doesn't do this,
>>> yet.
>>>
>>> (Actually, we are working on queue replication right now.  I think you
>>> would need both replication and some kind of queue migration or
>>> distribution.)
>>>
>>>
>>> 3) After message m1 is arrived on queue "Alice", but the connection
>>>> between Alice and Node 2 is gone, the message will be stored on Node
>>>> 2, right? Next time, Alice connects to the system, but she is
>>>> connected to Node n instead of Node 2, how to handle this?
>>>>
>>>
>>> In Rabbit's clustering as it works now, the messages will be delivered
>>> across the cluster to Node n.
>>>
>>>
>>> 4) What is the multi-cast technology used in RabbitMQ to deliver the
>>>> message to queues located on different locations spreading around
>>>> different countries?
>>>>
>>>
>>> There isn't any right now.  Clustering is really for nodes that are
>>> co-located and have reliable connections.  It uses Erlang's distribution
>>> mechanism, which essentially forms a fully-connected graph of nodes.  It
>>> doesn't really scale beyond a handful of nodes.
>>>
>>> There /is/ a plugin called the "shovel", which will relay messages from
>>> one broker to another.  However, it is statically configured, and
>>> constrained by using AMQP to do the relaying (i.e., you cannot tell it to
>>> relay all messages from a direct exchange; only to relay, e.g., messages
>>> with a particular routing key).
>>>
>>>
>>> Regards,
>>> Michael
>>>
>>> _______________________________________________
>>> rabbitmq-discuss mailing list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>>
>>
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110128/1a4850e7/attachment.htm>

From jiri at krutil.com  Sat Jan 29 10:45:37 2011
From: jiri at krutil.com (Jiri Krutil)
Date: Sat, 29 Jan 2011 11:45:37 +0100
Subject: [rabbitmq-discuss] Java client: channel shutdown notification
 while closing connection
In-Reply-To: <4D39E650.8000808@rabbitmq.com>
References: <20110111115028.11234me7qyqi7pc0@webmail.active24.cz>
	<4D39E650.8000808@rabbitmq.com>
Message-ID: <4D43EFD1.10202@krutil.com>

Matthias,

> The shutdown listeners get called in the main connection thread. That 
> means they should not perform any possibly blocking AMQP operations. 
> If they do then a deadlock can ensue.
...
> Why are you calling connection.close() at all? The connection will 
> already have been closed. After all, you are in the connection 
> shutdown handler code.

To achieve some kind of resiliency to short network and broker downtimes 
in our application, we have a synchronized disconnect-and-start-over 
method that is used as both connection and channel shutdown listener. If 
this fails we retry in regular periods. The goal is to make sure that 
the application will reconnect and re-register its consumers as soon as 
possible.

This is used in part due to the (in my opinion unfortunate) feature of 
AMQP that an error in an operation on a channel closes that channel.

To keep things simple, we close the connection in this method, in case 
it would be invoked by a channel shutdown. And that's where our problems 
seem to appear: when closing the connection, channels are closed and 
their shutdown listeners invoked, which in turn attempt to acquire the 
same lock, resulting in a deadlock.

We seem to have solved the problem by explicitly unregistering the 
channel shutdown listeners before closing the connection.

Cheers
Jiri

From mrkafk at gmail.com  Sat Jan 29 18:18:39 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Sat, 29 Jan 2011 19:18:39 +0100
Subject: [rabbitmq-discuss] exceptions on fast opening a number of
 connections / exception on TCP connection
Message-ID: <4D4459FF.4090404@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


I wrote a "stress test" function that (relatively) quickly does the
following: it creates a number of threads that open a new connection to
Rabbit, do RPC call over Rabbit, close the connection, sleep some
milliseconds and iterate again.

I'm getting following exceptions in Rabbit log:

=ERROR REPORT==== 29-Jan-2011::18:06:04 ===
exception on TCP connection <0.22244.4> from 10.0.0.234:54501
{inet_error,enomem}

=WARNING REPORT==== 29-Jan-2011::18:06:07 ===
exception on TCP connection <0.22240.4> from 10.0.0.234:54500
connection_closed_abruptly


pika throws following exception:

Exception in thread Thread-6:
Traceback (most recent call last):
  File "/usr/lib/python2.5/threading.py", line 486, in __bootstrap_inner
    self.run()
  File "./rc_mt2.py", line 167, in run
    self.testfun(*self.args, **self.kwargs)
  File "./rc_mt2.py", line 176, in rpc_testcall
    rc = RPCClient(node, servnum, rdonly)
  File "./rc_mt2.py", line 66, in __init__
    self.setup_conn(self.node)
  File "./rc_mt2.py", line 82, in setup_conn
    self.chan = self.conn.channel()
  File "/usr/local/bin/src/pika/pika/connection.py", line 385, in channel
    return channel.Channel(channel.ChannelHandler(self))
  File "/usr/local/bin/src/pika/pika/channel.py", line 205, in __init__
    self.handler._rpc(spec.Channel.Open(), [spec.Channel.OpenOk])
  File "/usr/local/bin/src/pika/pika/channel.py", line 187, in _rpc
    return self.connection._rpc(self.channel_number, method,
acceptable_replies)
  File "/usr/local/bin/src/pika/pika/connection.py", line 324, in _rpc
    channel = self._ensure_channel(channel_number)
  File "/usr/local/bin/src/pika/pika/connection.py", line 287, in
_ensure_channel
    raise ConnectionClosed(self.connection_close)
ConnectionClosed: Connection.Close(class_id = 0, method_id = 0,
reply_code = 0, reply_text = 'Socket closed')


If I add some time.sleep between the calls, the problem disappears (see
class TestThread and function stress_test in code below), but that's
kind of not the point, right?


Code:

http://pastie.org/pastes/1509383/text




- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNRFn+AAoJEFMgHzhQQ7hOQ3AH/0ydNs1RRTsCAi4Cx9stPDuA
r3OMWnW1/scq6WcqpswIZTCe7a/2pAu/UbDkPgZxRPb0/pclqxAOwGud/Uij6ivq
63B8kuAZKVsXqHnel2ED/yGXRkm65ot0/wASRZR+38abUhMC88tvLP4XinqF9hnt
umCxMiF4tPUDspj7d1MF0Bwk9RjqT0rnmPHfNsrO10P4Ob8Ithm53rknfn3tHYNu
c8WeuzMVS+wth4SMQilqqyzVESy8Gpr8k9Ghn1GuEAhQrFzDE4+q960jbbhaKuH+
1KY4XKYMR1jDn+8C1BPm1eSbANGetpZb5gCcxHMRhtIJjOhEXX628dFArtinlls=
=uc7b
-----END PGP SIGNATURE-----

From mrkafk at gmail.com  Sat Jan 29 18:28:31 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Sat, 29 Jan 2011 19:28:31 +0100
Subject: [rabbitmq-discuss] pika exceptions
Message-ID: <4D445C4F.5060904@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hello everyone,

Re "stress test" I wrote about in another mail - even if I increase
time.sleep pika starts throwing exceptions after a while:


Exception in thread Thread-1:
Traceback (most recent call last):
  File "/usr/lib/python2.5/threading.py", line 486, in __bootstrap_inner
    self.run()
  File "./rc_mt2.py", line 167, in run
    self.testfun(*self.args, **self.kwargs)
  File "./rc_mt2.py", line 179, in rpc_testcall
    repl = rc.call(hello, servnum, rdonly=rdonly)
  File "./rc_mt2.py", line 133, in call
    self.setup_distrib(self.node)
  File "./rc_mt2.py", line 88, in setup_distrib
    self.res = self.chan.queue_declare(exclusive = True)
  File "/usr/local/bin/src/pika/pika/spec.py", line 3003, in queue_declare
    [Queue.DeclareOk])
  File "/usr/local/bin/src/pika/pika/channel.py", line 186, in _rpc
    self._ensure()
  File "/usr/local/bin/src/pika/pika/channel.py", line 84, in _ensure
    raise ChannelClosed(self.channel_close)
ChannelClosed: Connection.Close(class_id = 0, method_id = 0, reply_code
= 540, reply_text = 'Pika: method not implemented: Exchange.DeclareOk')




Exception in thread Thread-4:
Traceback (most recent call last):
  File "/usr/lib/python2.5/threading.py", line 486, in __bootstrap_inner
    self.run()
  File "./rc_mt2.py", line 167, in run
    self.testfun(*self.args, **self.kwargs)
  File "./rc_mt2.py", line 176, in rpc_testcall
    rc = RPCClient(node, servnum, rdonly)
  File "./rc_mt2.py", line 66, in __init__
    self.setup_conn(self.node)
  File "./rc_mt2.py", line 81, in setup_conn
    self.conn = pika.AsyncoreConnection(pika.ConnectionParameters(node))
  File "/usr/local/bin/src/pika/pika/connection.py", line 154, in __init__
    self.wait_for_open()
  File "/usr/local/bin/src/pika/pika/connection.py", line 390, in
wait_for_open
    self.drain_events()
  File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 119, in
drain_events
    loop(count = 1, timeout = timeout)
  File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 169, in loop
    loop1(map, timeout)
  File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 157, in
loop1
    asyncore.loop(timeout = next_event_timeout(timeout), map = map,
count = 1)
  File "/usr/lib/python2.5/asyncore.py", line 195, in loop
    poll_fun(timeout, map)
  File "/usr/lib/python2.5/asyncore.py", line 121, in poll
    r, w, e = select.select(r, w, e, timeout)
error: (9, 'Bad file descriptor')


- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNRFxPAAoJEFMgHzhQQ7hOeecH/jDgdWoaodWWJToKOft9A1I9
zv69d/rneamUL0l1pWqScaCQormqlWS3lnIKAz5xclDPPja45YA6RDcWoTM8xjJX
lO0oe/u5HZ1+tnqautAFvQiN9Rn2YfaQ6b58sRTwGcWNqgjn4Xsq9/LfXeRIvA1h
wltNPPK/AgupZ5DqDiZIBYorp6FvPNRohB5YPMVhB9osXom7HLU6AaSAQ7JLSi62
IG/Q7/Z3H0vLhQX9Breob0nC7nTYUVoA6Xmd8qjfPDhU2qwA9Wqeu+4cSVDPSMte
w2RNqVXG7L8E0Ccu449X7Z4RHLBtsPJ0d/6IhzacupTaLjzZ635GTJ0rOD12M0c=
=FCP4
-----END PGP SIGNATURE-----

From bugs at almad.net  Sat Jan 29 18:43:32 2011
From: bugs at almad.net (Almad)
Date: Sat, 29 Jan 2011 19:43:32 +0100
Subject: [rabbitmq-discuss] How to break RabbitMQ cluster
Message-ID: <201101291943.32653.bugs@almad.net>

Hi,

our OPs are trying to install and use rabbit in cluster mode and discovered 
two bad "how-to"s, described here:

https://gist.github.com/798431

Any idea how to prevent them, or what configuration could cause it?

Thanks,

Almad

From gmr at myyearbook.com  Sat Jan 29 19:37:29 2011
From: gmr at myyearbook.com (Gavin M. Roy)
Date: Sat, 29 Jan 2011 14:37:29 -0500
Subject: [rabbitmq-discuss] pika exceptions
In-Reply-To: <4D445C4F.5060904@gmail.com>
References: <4D445C4F.5060904@gmail.com>
Message-ID: <AANLkTim6kxqjY5MqPep4ZR+xmDF-zrWzJkXe0YACGZ14@mail.gmail.com>

Can you send me your stress test app? I'd like to test it.

On Sat, Jan 29, 2011 at 1:28 PM, Marcin Krol <mrkafk at gmail.com> wrote:
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA1
>
> Hello everyone,
>
> Re "stress test" I wrote about in another mail - even if I increase
> time.sleep pika starts throwing exceptions after a while:
>
>
> Exception in thread Thread-1:
> Traceback (most recent call last):
> ?File "/usr/lib/python2.5/threading.py", line 486, in __bootstrap_inner
> ? ?self.run()
> ?File "./rc_mt2.py", line 167, in run
> ? ?self.testfun(*self.args, **self.kwargs)
> ?File "./rc_mt2.py", line 179, in rpc_testcall
> ? ?repl = rc.call(hello, servnum, rdonly=rdonly)
> ?File "./rc_mt2.py", line 133, in call
> ? ?self.setup_distrib(self.node)
> ?File "./rc_mt2.py", line 88, in setup_distrib
> ? ?self.res = self.chan.queue_declare(exclusive = True)
> ?File "/usr/local/bin/src/pika/pika/spec.py", line 3003, in queue_declare
> ? ?[Queue.DeclareOk])
> ?File "/usr/local/bin/src/pika/pika/channel.py", line 186, in _rpc
> ? ?self._ensure()
> ?File "/usr/local/bin/src/pika/pika/channel.py", line 84, in _ensure
> ? ?raise ChannelClosed(self.channel_close)
> ChannelClosed: Connection.Close(class_id = 0, method_id = 0, reply_code
> = 540, reply_text = 'Pika: method not implemented: Exchange.DeclareOk')
>
>
>
>
> Exception in thread Thread-4:
> Traceback (most recent call last):
> ?File "/usr/lib/python2.5/threading.py", line 486, in __bootstrap_inner
> ? ?self.run()
> ?File "./rc_mt2.py", line 167, in run
> ? ?self.testfun(*self.args, **self.kwargs)
> ?File "./rc_mt2.py", line 176, in rpc_testcall
> ? ?rc = RPCClient(node, servnum, rdonly)
> ?File "./rc_mt2.py", line 66, in __init__
> ? ?self.setup_conn(self.node)
> ?File "./rc_mt2.py", line 81, in setup_conn
> ? ?self.conn = pika.AsyncoreConnection(pika.ConnectionParameters(node))
> ?File "/usr/local/bin/src/pika/pika/connection.py", line 154, in __init__
> ? ?self.wait_for_open()
> ?File "/usr/local/bin/src/pika/pika/connection.py", line 390, in
> wait_for_open
> ? ?self.drain_events()
> ?File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 119, in
> drain_events
> ? ?loop(count = 1, timeout = timeout)
> ?File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 169, in loop
> ? ?loop1(map, timeout)
> ?File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 157, in
> loop1
> ? ?asyncore.loop(timeout = next_event_timeout(timeout), map = map,
> count = 1)
> ?File "/usr/lib/python2.5/asyncore.py", line 195, in loop
> ? ?poll_fun(timeout, map)
> ?File "/usr/lib/python2.5/asyncore.py", line 121, in poll
> ? ?r, w, e = select.select(r, w, e, timeout)
> error: (9, 'Bad file descriptor')
>
>
> - --
>
> Regards,
> mk
>
> - --
> Premature optimization is the root of all fun.
> -----BEGIN PGP SIGNATURE-----
> Version: GnuPG v1.4.9 (MingW32)
> Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/
>
> iQEcBAEBAgAGBQJNRFxPAAoJEFMgHzhQQ7hOeecH/jDgdWoaodWWJToKOft9A1I9
> zv69d/rneamUL0l1pWqScaCQormqlWS3lnIKAz5xclDPPja45YA6RDcWoTM8xjJX
> lO0oe/u5HZ1+tnqautAFvQiN9Rn2YfaQ6b58sRTwGcWNqgjn4Xsq9/LfXeRIvA1h
> wltNPPK/AgupZ5DqDiZIBYorp6FvPNRohB5YPMVhB9osXom7HLU6AaSAQ7JLSi62
> IG/Q7/Z3H0vLhQX9Breob0nC7nTYUVoA6Xmd8qjfPDhU2qwA9Wqeu+4cSVDPSMte
> w2RNqVXG7L8E0Ccu449X7Z4RHLBtsPJ0d/6IhzacupTaLjzZ635GTJ0rOD12M0c=
> =FCP4
> -----END PGP SIGNATURE-----
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>

From gmr at myyearbook.com  Sat Jan 29 19:38:23 2011
From: gmr at myyearbook.com (Gavin M. Roy)
Date: Sat, 29 Jan 2011 14:38:23 -0500
Subject: [rabbitmq-discuss] pika exceptions
In-Reply-To: <AANLkTim6kxqjY5MqPep4ZR+xmDF-zrWzJkXe0YACGZ14@mail.gmail.com>
References: <4D445C4F.5060904@gmail.com>
	<AANLkTim6kxqjY5MqPep4ZR+xmDF-zrWzJkXe0YACGZ14@mail.gmail.com>
Message-ID: <AANLkTineKUwna0nM6_6+mqTDvJG7vhiqCt8Arn+e0k2v@mail.gmail.com>

Nevermind, I see you sent it in the other thread. I'll look into this
and get back to you.

On Sat, Jan 29, 2011 at 2:37 PM, Gavin M. Roy <gmr at myyearbook.com> wrote:
> Can you send me your stress test app? I'd like to test it.
>
> On Sat, Jan 29, 2011 at 1:28 PM, Marcin Krol <mrkafk at gmail.com> wrote:
>> -----BEGIN PGP SIGNED MESSAGE-----
>> Hash: SHA1
>>
>> Hello everyone,
>>
>> Re "stress test" I wrote about in another mail - even if I increase
>> time.sleep pika starts throwing exceptions after a while:
>>
>>
>> Exception in thread Thread-1:
>> Traceback (most recent call last):
>> ?File "/usr/lib/python2.5/threading.py", line 486, in __bootstrap_inner
>> ? ?self.run()
>> ?File "./rc_mt2.py", line 167, in run
>> ? ?self.testfun(*self.args, **self.kwargs)
>> ?File "./rc_mt2.py", line 179, in rpc_testcall
>> ? ?repl = rc.call(hello, servnum, rdonly=rdonly)
>> ?File "./rc_mt2.py", line 133, in call
>> ? ?self.setup_distrib(self.node)
>> ?File "./rc_mt2.py", line 88, in setup_distrib
>> ? ?self.res = self.chan.queue_declare(exclusive = True)
>> ?File "/usr/local/bin/src/pika/pika/spec.py", line 3003, in queue_declare
>> ? ?[Queue.DeclareOk])
>> ?File "/usr/local/bin/src/pika/pika/channel.py", line 186, in _rpc
>> ? ?self._ensure()
>> ?File "/usr/local/bin/src/pika/pika/channel.py", line 84, in _ensure
>> ? ?raise ChannelClosed(self.channel_close)
>> ChannelClosed: Connection.Close(class_id = 0, method_id = 0, reply_code
>> = 540, reply_text = 'Pika: method not implemented: Exchange.DeclareOk')
>>
>>
>>
>>
>> Exception in thread Thread-4:
>> Traceback (most recent call last):
>> ?File "/usr/lib/python2.5/threading.py", line 486, in __bootstrap_inner
>> ? ?self.run()
>> ?File "./rc_mt2.py", line 167, in run
>> ? ?self.testfun(*self.args, **self.kwargs)
>> ?File "./rc_mt2.py", line 176, in rpc_testcall
>> ? ?rc = RPCClient(node, servnum, rdonly)
>> ?File "./rc_mt2.py", line 66, in __init__
>> ? ?self.setup_conn(self.node)
>> ?File "./rc_mt2.py", line 81, in setup_conn
>> ? ?self.conn = pika.AsyncoreConnection(pika.ConnectionParameters(node))
>> ?File "/usr/local/bin/src/pika/pika/connection.py", line 154, in __init__
>> ? ?self.wait_for_open()
>> ?File "/usr/local/bin/src/pika/pika/connection.py", line 390, in
>> wait_for_open
>> ? ?self.drain_events()
>> ?File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 119, in
>> drain_events
>> ? ?loop(count = 1, timeout = timeout)
>> ?File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 169, in loop
>> ? ?loop1(map, timeout)
>> ?File "/usr/local/bin/src/pika/pika/asyncore_adapter.py", line 157, in
>> loop1
>> ? ?asyncore.loop(timeout = next_event_timeout(timeout), map = map,
>> count = 1)
>> ?File "/usr/lib/python2.5/asyncore.py", line 195, in loop
>> ? ?poll_fun(timeout, map)
>> ?File "/usr/lib/python2.5/asyncore.py", line 121, in poll
>> ? ?r, w, e = select.select(r, w, e, timeout)
>> error: (9, 'Bad file descriptor')
>>
>>
>> - --
>>
>> Regards,
>> mk
>>
>> - --
>> Premature optimization is the root of all fun.
>> -----BEGIN PGP SIGNATURE-----
>> Version: GnuPG v1.4.9 (MingW32)
>> Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/
>>
>> iQEcBAEBAgAGBQJNRFxPAAoJEFMgHzhQQ7hOeecH/jDgdWoaodWWJToKOft9A1I9
>> zv69d/rneamUL0l1pWqScaCQormqlWS3lnIKAz5xclDPPja45YA6RDcWoTM8xjJX
>> lO0oe/u5HZ1+tnqautAFvQiN9Rn2YfaQ6b58sRTwGcWNqgjn4Xsq9/LfXeRIvA1h
>> wltNPPK/AgupZ5DqDiZIBYorp6FvPNRohB5YPMVhB9osXom7HLU6AaSAQ7JLSi62
>> IG/Q7/Z3H0vLhQX9Breob0nC7nTYUVoA6Xmd8qjfPDhU2qwA9Wqeu+4cSVDPSMte
>> w2RNqVXG7L8E0Ccu449X7Z4RHLBtsPJ0d/6IhzacupTaLjzZ635GTJ0rOD12M0c=
>> =FCP4
>> -----END PGP SIGNATURE-----
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>

From eric at trueblade.com  Sun Jan 30 02:12:47 2011
From: eric at trueblade.com (Eric Smith)
Date: Sat, 29 Jan 2011 21:12:47 -0500
Subject: [rabbitmq-discuss] SASL configuration example?
Message-ID: <4D44C91F.2000202@trueblade.com>

I've tried to find examples of configuring RabbitMQ and SASL, but no 
joy. I have other SASL aware applications running, but I'm not sure how 
to configure RabbitMQ.

Does anyone have any pointers? The documentation is very light on this 
subject, or at least I can't figure out how to search for it.

Thanks in advance.
Eric.


From ciprian.craciun at gmail.com  Sun Jan 30 09:25:53 2011
From: ciprian.craciun at gmail.com (Ciprian Dorin Craciun)
Date: Sun, 30 Jan 2011 11:25:53 +0200
Subject: [rabbitmq-discuss] SASL configuration example?
In-Reply-To: <4D44C91F.2000202@trueblade.com>
References: <4D44C91F.2000202@trueblade.com>
Message-ID: <AANLkTi=1VN3P_s0qvjpU2gNCD_36b+oTfwmSj9mUets-@mail.gmail.com>

On Sun, Jan 30, 2011 at 04:12, Eric Smith <eric at trueblade.com> wrote:
> I've tried to find examples of configuring RabbitMQ and SASL, but no joy. I
> have other SASL aware applications running, but I'm not sure how to
> configure RabbitMQ.
>
> Does anyone have any pointers? The documentation is very light on this
> subject, or at least I can't figure out how to search for it.
>
> Thanks in advance.
> Eric.


    I don't think this will help you too much, but it could be a
starting point...

   By <<configuring RabbitMQ and SASL>> I assume you're referring to
writing `.config` files used when starting Erlang applications. In
this case I've `grep`-ed the source code of the 2.2.0 release for
`application:get_env` or `application:set_env`, and found some
configuration options that can be tweaked in the `.config` file. I've
started documenting them at the link below, but never finished...

    http://wiki.volution.ro/CiprianDorinCraciun/Notes/RabbitMq

    Ciprian.

From simon at rabbitmq.com  Sun Jan 30 09:59:03 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Sun, 30 Jan 2011 09:59:03 +0000
Subject: [rabbitmq-discuss] SASL configuration example?
In-Reply-To: <4D44C91F.2000202@trueblade.com>
References: <4D44C91F.2000202@trueblade.com>
Message-ID: <4D453667.3040508@rabbitmq.com>

On 30/01/2011 2:12AM, Eric Smith wrote:
> I've tried to find examples of configuring RabbitMQ and SASL, but no
> joy. I have other SASL aware applications running, but I'm not sure how
> to configure RabbitMQ.

Hi Eric. All released versions of RabbitMQ only support PLAIN (and its 
weird cousin AMQPLAIN), so there's not much to configure.

The upcoming 2.3.0 release will be rather more flexible, at which point 
documentation will appear :)

Cheers, Simon

From eric at trueblade.com  Sun Jan 30 10:59:18 2011
From: eric at trueblade.com (Eric Smith)
Date: Sun, 30 Jan 2011 05:59:18 -0500
Subject: [rabbitmq-discuss] SASL configuration example?
In-Reply-To: <4D453667.3040508@rabbitmq.com>
References: <4D44C91F.2000202@trueblade.com> <4D453667.3040508@rabbitmq.com>
Message-ID: <4D454486.8000901@trueblade.com>

On 1/30/2011 4:59 AM, Simon MacMullen wrote:
> On 30/01/2011 2:12AM, Eric Smith wrote:
>> I've tried to find examples of configuring RabbitMQ and SASL, but no
>> joy. I have other SASL aware applications running, but I'm not sure how
>> to configure RabbitMQ.
>
> Hi Eric. All released versions of RabbitMQ only support PLAIN (and its
> weird cousin AMQPLAIN), so there's not much to configure.
>
> The upcoming 2.3.0 release will be rather more flexible, at which point
> documentation will appear :)

Thanks, Simon. I understand there's not much to configure with PLAIN, 
but when I do try to authenticate I get an "access_refused" error in 
rabbit.log, and nothing written to rabbit-sasl.log. So I'm not really 
sure where to look next. Running without any authentication works okay.

I'm running an older version of Fedora (F8) with rabbmq-server 1.7.0, so 
it wouldn't surprise me if the problem is related to the old rabbitmq. 
I'm using Python and pika, if that makes any difference.

Thanks.
Eric.

From eric at trueblade.com  Sun Jan 30 11:01:09 2011
From: eric at trueblade.com (Eric Smith)
Date: Sun, 30 Jan 2011 06:01:09 -0500
Subject: [rabbitmq-discuss] SASL configuration example?
In-Reply-To: <AANLkTi=1VN3P_s0qvjpU2gNCD_36b+oTfwmSj9mUets-@mail.gmail.com>
References: <4D44C91F.2000202@trueblade.com>
	<AANLkTi=1VN3P_s0qvjpU2gNCD_36b+oTfwmSj9mUets-@mail.gmail.com>
Message-ID: <4D4544F5.7000907@trueblade.com>

On 1/30/2011 4:25 AM, Ciprian Dorin Craciun wrote:
> On Sun, Jan 30, 2011 at 04:12, Eric Smith<eric at trueblade.com>  wrote:
>> I've tried to find examples of configuring RabbitMQ and SASL, but no joy. I
>> have other SASL aware applications running, but I'm not sure how to
>> configure RabbitMQ.
>>
>> Does anyone have any pointers? The documentation is very light on this
>> subject, or at least I can't figure out how to search for it.
>>
>> Thanks in advance.
>> Eric.
>
>
>      I don't think this will help you too much, but it could be a
> starting point...
>
>     By<<configuring RabbitMQ and SASL>>  I assume you're referring to
> writing `.config` files used when starting Erlang applications. In
> this case I've `grep`-ed the source code of the 2.2.0 release for
> `application:get_env` or `application:set_env`, and found some
> configuration options that can be tweaked in the `.config` file. I've
> started documenting them at the link below, but never finished...
>
>      http://wiki.volution.ro/CiprianDorinCraciun/Notes/RabbitMq
>
>      Ciprian.
>

That's very helpful, Ciprian. Thanks for doing this work. I'll look 
through it and see what I can glean, both for this problem and in general.

Eric.


From simon at rabbitmq.com  Sun Jan 30 11:07:42 2011
From: simon at rabbitmq.com (Simon MacMullen)
Date: Sun, 30 Jan 2011 11:07:42 +0000
Subject: [rabbitmq-discuss] SASL configuration example?
In-Reply-To: <4D454486.8000901@trueblade.com>
References: <4D44C91F.2000202@trueblade.com> <4D453667.3040508@rabbitmq.com>
	<4D454486.8000901@trueblade.com>
Message-ID: <4D45467E.6000609@rabbitmq.com>

On 30/01/2011 10:59AM, Eric Smith wrote:
> Thanks, Simon. I understand there's not much to configure with PLAIN,
> but when I do try to authenticate I get an "access_refused" error in
> rabbit.log, and nothing written to rabbit-sasl.log. So I'm not really
> sure where to look next. Running without any authentication works okay.

rabbit-sasl.log has nothing to do with SASL. No, really.

At least, not *that* SASL. It's for Erlang's "System Application Support 
Libraries": http://www.erlang.org/doc/apps/sasl/index.html

Yes, the naming is very unfortunate.

You can't run AMQP without any authentication - it's just that 
everything defaults to guest/guest, and that user exists by default. All 
you should need to do is:

1) Create another user with rabbitmqctl add_user
2) Grant that user permissions to the vhost it'll access with 
rabbitmqctl set_permissions
3) Configure your client to use the new user

> I'm running an older version of Fedora (F8) with rabbmq-server 1.7.0, so
> it wouldn't surprise me if the problem is related to the old rabbitmq.
> I'm using Python and pika, if that makes any difference.

That should still work. Of course, you should upgrade anyway :)

Cheers, Simon

From eric at trueblade.com  Sun Jan 30 11:12:04 2011
From: eric at trueblade.com (Eric Smith)
Date: Sun, 30 Jan 2011 06:12:04 -0500
Subject: [rabbitmq-discuss] SASL configuration example?
In-Reply-To: <4D45467E.6000609@rabbitmq.com>
References: <4D44C91F.2000202@trueblade.com>
	<4D453667.3040508@rabbitmq.com>	<4D454486.8000901@trueblade.com>
	<4D45467E.6000609@rabbitmq.com>
Message-ID: <4D454784.1000408@trueblade.com>

On 1/30/2011 6:07 AM, Simon MacMullen wrote:
> On 30/01/2011 10:59AM, Eric Smith wrote:
>> Thanks, Simon. I understand there's not much to configure with PLAIN,
>> but when I do try to authenticate I get an "access_refused" error in
>> rabbit.log, and nothing written to rabbit-sasl.log. So I'm not really
>> sure where to look next. Running without any authentication works okay.
>
> rabbit-sasl.log has nothing to do with SASL. No, really.
>
> At least, not *that* SASL. It's for Erlang's "System Application Support
> Libraries": http://www.erlang.org/doc/apps/sasl/index.html
>
> Yes, the naming is very unfortunate.

Heh. How true! Thanks for the clarification.

> You can't run AMQP without any authentication - it's just that
> everything defaults to guest/guest, and that user exists by default. All
> you should need to do is:
>
> 1) Create another user with rabbitmqctl add_user
> 2) Grant that user permissions to the vhost it'll access with
> rabbitmqctl set_permissions
> 3) Configure your client to use the new user

Thanks. That worked perfectly. I hadn't thought to check rabbitmqctl.

Eric.

From mrkafk at gmail.com  Sun Jan 30 12:50:41 2011
From: mrkafk at gmail.com (Marcin Krol)
Date: Sun, 30 Jan 2011 13:50:41 +0100
Subject: [rabbitmq-discuss] timeout on pika.asyncore_loop
Message-ID: <4D455EA1.2000200@gmail.com>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hello everyone,

Apparently if pika.asyncore_loop() times out, there's no way of knowing
that for now:

def loop(map = None, count = None, timeout=None):
    if map is None:
        map = asyncore.socket_map
    if count is None:
        while (map or timer_heap):
            loop1(map, timeout)
    else:
        while (map or timer_heap) and count > 0:
            loop1(map, timeout)
            count = count - 1
        run_timers_internal()

Hint: it could be useful for asyncore_loop to return some info, e.g.
like whether timeout happened, specifically while calling like
asyncore_loop(count=something).


- --

Regards,
mk

- --
Premature optimization is the root of all fun.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (MingW32)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iQEcBAEBAgAGBQJNRV6hAAoJEFMgHzhQQ7hOpPoIAII6tAf9b31hzBvWkW6EY+Y/
GVuF9dW9KiAMA2St7pK1DCfELNCl6J5Y8dHIXump2YBGvTmb4PDiy6RbS4dHCS4f
SEpQqwRbAZJiYhgNEMR1HHSLOmmfISoR+Vk76nAqOjlJtounWPFyQ6lA6yBr2pO1
KMjDFAZxOm1+i1JV2gxW+LOWaD0qwYuKdN/ZlRRmvJeRDo4u4EUaiCsKQWJfYj7/
02RTqD0tU3Ye/5nfoSJrJYa23IvnaLAkqFzP6XHqHnrnPWjc5N1+FLcnz4aONja1
ncCYLqXbOAwUN3K/r9ZN09eJmn0eOgnIgw5z9dmcdnizTTdBYiokXH29cP9iD1U=
=Rjx5
-----END PGP SIGNATURE-----

From alfonso.pantoja at gmail.com  Sun Jan 30 14:14:28 2011
From: alfonso.pantoja at gmail.com (Alfonso Pantoja)
Date: Sun, 30 Jan 2011 15:14:28 +0100
Subject: [rabbitmq-discuss] Responsibility Transfer using RabbitMQ .NET
 API: How it works?
In-Reply-To: <20110128001336.GA2352@dakota.doc.ic.ac.uk>
References: <AANLkTim_hB0XJ6C-4ZBtWifWvZtpmt5n+J1HvOe-3_wr@mail.gmail.com>
	<20110127043455.GC2357@dakota>
	<AANLkTimuWUTRGv8azj2NqLnuuaZZhh1JRA9N039ivzjG@mail.gmail.com>
	<20110128001336.GA2352@dakota.doc.ic.ac.uk>
Message-ID: <AANLkTimC+ecDCAF+LSRnqgwStt=cCHYtD-0yQpGWB4B3@mail.gmail.com>

Great, thank you very much Alex.


Regards,

Alfonso

2011/1/28 Alexandru Scvor?ov <alexandru at rabbitmq.com>

> Alfonso,
>
> > In this case in my code I should handle unexpected exceptions (txSelect,
> > basic.publish, txCommit) and also basic.return in cause immediate and/or
> > mandatory message can't be delivered, right?
>
> Ah, you're right; I forgot about the exceptions.  So, yes, you need to
> take into account both exceptions (failed commits) and basic.returns
> (unroutable messages).
>
> Cheers,
> Alex
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110130/8a14b7fe/attachment.htm>

From jeffh at delasco.com  Mon Jan 31 00:42:47 2011
From: jeffh at delasco.com (Jeff Hinrichs)
Date: Sun, 30 Jan 2011 18:42:47 -0600
Subject: [rabbitmq-discuss] What is an Exchange?
Message-ID: <AANLkTimy2HW4ZmdS0RbHSgrzA5C6EDdkbMs3xL8=G3M3@mail.gmail.com>

Being new to enterprise mq's, rabbit in particular, is there a definition
for what an exchange does/is?  The tutorial talks about how use use an
exchange, and the 3 different types of exchanges but is there more
conceptually to an exchange than functioning as a logical abstraction for
segmenting queues and routing per virtual host and/or server?

>From what I've read so far, it doesn't appear to be possible for an exchange
to span servers, true?

Where do vhosts fit in this model?    server -> vhost -> exchange -> queue?
 Are they just another logical abstraction that sits on top of exchanges?
 Is segmenting security the main/only reason?

Links are always welcome, I've attempted to search for this information but
get pages of code examples for results.  So now I'm asking.

Best,


-Jeff
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110130/25b25d2f/attachment.htm>

From eshioji at gmail.com  Mon Jan 31 09:40:16 2011
From: eshioji at gmail.com (Enno Shioji)
Date: Mon, 31 Jan 2011 18:40:16 +0900
Subject: [rabbitmq-discuss] What is the best option for work sharing that
 needs topic like selective message receival?
Message-ID: <AANLkTinPPog61Qgt-xFNvn-UFeYkrMUhH3xuwM-Xdvvx@mail.gmail.com>

Hi,


I have an app. I would like to migrate to AMQP based architecture. The
main component/functionality of this app. is to distribute work based
on some rules.

After learning a little bit about AMQP, I concluded that the way to
achieve this is to have the producer send "jobs" to a direct exchange
with routing keys that indicate the nature of the jobs (let's call it
"job category"), and having queues that binds to each unique routing
key, and then having consumers listening on these queues. Multiple
consumers may listen to the same queue. One job should only be
performed once system-wide (but is not strictly required as long as
performance loss is not significant).


My problem is that the number of such "job category" increases
overtime. E.g. if in the beginning there is only one routing keys such
as "key.stuff.1.A", overtime keys like "key.stuff.2.A" or
"key.stuff.2.B" will start to emerge and eventually such categories
will reach a large number. However, older categories will eventually
become obsolete so at a given time I would have at most something like
20K different "job categories". But overtime I would have a LOT of job
categories. (Lifetime of each "job category" depends and can be
anything from 1 day to 1 seconds etc..)

I'm wondering if there is a better way to achieve what I want.

If this helps, everything can be transient and non durable. Message
loss can be tolerated as long as it's not too frequent (e.g. once per
10K msgs etc.)

Thank you very much in advance!




Regards,
Enno

From alexandru at rabbitmq.com  Mon Jan 31 10:25:44 2011
From: alexandru at rabbitmq.com (Alexandru =?utf-8?B?U2N2b3LFo292?=)
Date: Mon, 31 Jan 2011 10:25:44 +0000
Subject: [rabbitmq-discuss] What is an Exchange?
In-Reply-To: <AANLkTimy2HW4ZmdS0RbHSgrzA5C6EDdkbMs3xL8=G3M3@mail.gmail.com>
References: <AANLkTimy2HW4ZmdS0RbHSgrzA5C6EDdkbMs3xL8=G3M3@mail.gmail.com>
Message-ID: <20110131102544.GA5110@dakota.eng.vmware.com>

Hi Jeff,

> Being new to enterprise mq's, rabbit in particular, is there a definition
> for what an exchange does/is?  The tutorial talks about how use use an
> exchange, and the 3 different types of exchanges but is there more
> conceptually to an exchange than functioning as a logical abstraction for
> segmenting queues and routing per virtual host and/or server?

An exchange is a message router.  Clients publish messages to exchanges,
and the exchanges route the messages to other exchanges or to queues.
Exchanges do not modify messages and do not store messages.

> From what I've read so far, it doesn't appear to be possible for an exchange
> to span servers, true?

RabbitMQ nodes can be clustered together to form one large "logical"
broker.  I.e. clients connecting to any node in the cluster will see the
same broker.  So, a client can declare an exchange on one node, another
can publish to the exchange on a different node and the exchange may
route messages to queues declared on yet another node.

> Where do vhosts fit in this model?    server -> vhost -> exchange -> queue?
>  Are they just another logical abstraction that sits on top of exchanges?
>  Is segmenting security the main/only reason?

Exchanges and queues are declared in the context of vhosts.  So, you can
have two different exchanges with the same name, but in different
vhosts.  It's just a convenient way to group exchanges, queues and
bindings.

> Links are always welcome, I've attempted to search for this information but
> get pages of code examples for results.  So now I'm asking.

You already know about:
  http://www.rabbitmq.com/documentation.html

The spec is the definitive guide, and the tutorial and the Java Client API
Guide give a hands-on introduction to RabbitMQ.

Hope this helps.

Cheers,
Alex


On Sun, Jan 30, 2011 at 06:42:47PM -0600, Jeff Hinrichs wrote:
> Being new to enterprise mq's, rabbit in particular, is there a definition
> for what an exchange does/is?  The tutorial talks about how use use an
> exchange, and the 3 different types of exchanges but is there more
> conceptually to an exchange than functioning as a logical abstraction for
> segmenting queues and routing per virtual host and/or server?
> 
> From what I've read so far, it doesn't appear to be possible for an exchange
> to span servers, true?
> 
> Where do vhosts fit in this model?    server -> vhost -> exchange -> queue?
>  Are they just another logical abstraction that sits on top of exchanges?
>  Is segmenting security the main/only reason?
> 
> Links are always welcome, I've attempted to search for this information but
> get pages of code examples for results.  So now I'm asking.
> 
> Best,
> 
> 
> -Jeff

> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss


From prayadav at gmail.com  Mon Jan 31 11:35:10 2011
From: prayadav at gmail.com (Prashant)
Date: Mon, 31 Jan 2011 03:35:10 -0800 (PST)
Subject: [rabbitmq-discuss] Installing Manamgemt plugin fails
Message-ID: <e935869a-3005-4f3e-9243-84a506f8a354@p16g2000vbs.googlegroups.com>

Hello
I updated my rabbitmq server and erlang and installed management
plugin ( following rabbitmq plugins docs). I run into error when am
starting rabbitmq server. it seems like management-agent is unable to
start. Doesn't give me any error that can help me diagnose the issue.
Am attaching logs

=INFO REPORT==== 31-Jan-2011::12:30:39 ===
started TCP Listener on 0.0.0.0:5672

=INFO REPORT==== 31-Jan-2011::12:30:39 ===
Management agent started.

=INFO REPORT==== 31-Jan-2011::12:30:39 ===
    application: rabbit_management_agent
    exited: {shutdown,{rabbit_mgmt_agent_app,start,[normal,[]]}}
    type: permanent

=INFO REPORT==== 31-Jan-2011::12:30:39 ===
stopped TCP Listener on 0.0.0.0:5672


=CRASH REPORT==== 31-Jan-2011::12:30:39 ===
  crasher:
    initial call: rabbit_mgmt_external_stats:init/1
    pid: <0.238.0>
    registered_name: []
    exception exit: {undef,[{rabbit_misc,now_ms,[]},
 
{rabbit_mgmt_external_stats,internal_update,1},
                            {rabbit_mgmt_external_stats,init,1},
                            {gen_server,init_it,6},
                            {proc_lib,init_p_do_apply,3}]}
      in function  gen_server:init_it/6
    ancestors: [rabbit_mgmt_agent_sup,<0.236.0>]
    messages: []
    links: [<0.237.0>]
    dictionary: []
    trap_exit: false
    status: running
    heap_size: 377
    stack_size: 24
    reductions: 127
  neighbours:

=SUPERVISOR REPORT==== 31-Jan-2011::12:30:39 ===
     Supervisor: {local,rabbit_mgmt_agent_sup}
     Context:    start_error
     Reason:     {undef,[{rabbit_misc,now_ms,[]},
                         {rabbit_mgmt_external_stats,internal_update,
1},
                         {rabbit_mgmt_external_stats,init,1},
                         {gen_server,init_it,6},
                         {proc_lib,init_p_do_apply,3}]}
     Offender:   [{pid,undefined},
                  {name,rabbit_mgmt_external_stats},
                  {mfargs,{rabbit_mgmt_external_stats,start_link,[]}},
                  {restart_type,permanent},
                  {shutdown,5000},
                  {child_type,worker}]

finally .....

starting error log
relay                                              ...done
starting
networking                                                   ...done
-- network listeners available

broker running
{"Kernel pid
terminated",application_controller,"{application_start_failure,rabbit_management_agent,
{shutdown,{rabbit_mgmt_agent_app,start,[normal,[]]}}}"}

Crash dump was written to: erl_crash.dump
Kernel pid terminated (application_controller)
({application_start_failure,rabbit_management_agent,{shutdown,
{rabbit_mgmt_agent_app,start,[normal,[]]}}})


From matthew at rabbitmq.com  Mon Jan 31 11:39:13 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Mon, 31 Jan 2011 11:39:13 +0000
Subject: [rabbitmq-discuss] Installing Manamgemt plugin fails
In-Reply-To: <e935869a-3005-4f3e-9243-84a506f8a354@p16g2000vbs.googlegroups.com>
References: <e935869a-3005-4f3e-9243-84a506f8a354@p16g2000vbs.googlegroups.com>
Message-ID: <20110131113912.GA16743@rabbitmq.com>

On Mon, Jan 31, 2011 at 03:35:10AM -0800, Prashant wrote:
> I updated my rabbitmq server and erlang and installed management
> plugin ( following rabbitmq plugins docs).
> 
>     exception exit: {undef,[{rabbit_misc,now_ms,[]},

Very likely your versions don't match up. I suspect you're using a newer
version of the Management plugin with an older version of Rabbit. It's
possible you have multiple bits of versions of Rabbit installed which
can create confusion as to which modules are being used when. Please
make sure you've removed all traces of your previos installation.

Matthew

From prayadav at gmail.com  Mon Jan 31 12:28:50 2011
From: prayadav at gmail.com (Prashant)
Date: Mon, 31 Jan 2011 04:28:50 -0800 (PST)
Subject: [rabbitmq-discuss] Installing Manamgemt plugin fails
In-Reply-To: <20110131113912.GA16743@rabbitmq.com>
References: <e935869a-3005-4f3e-9243-84a506f8a354@p16g2000vbs.googlegroups.com>
	<20110131113912.GA16743@rabbitmq.com>
Message-ID: <376d5251-58dd-4f4b-bd19-c7cb9f66732f@y12g2000prf.googlegroups.com>

Thanks a lot matthew. you are right it was version mismatch.

Regds


On Jan 31, 11:39?am, Matthew Sackman <matt... at rabbitmq.com> wrote:
> On Mon, Jan 31, 2011 at 03:35:10AM -0800, Prashant wrote:
> > I updated my rabbitmq server and erlang and installed management
> > plugin ( following rabbitmq plugins docs).
>
> > ? ? exception exit: {undef,[{rabbit_misc,now_ms,[]},
>
> Very likely your versions don't match up. I suspect you're using a newer
> version of the Management plugin with an older version of Rabbit. It's
> possible you have multiple bits of versions of Rabbit installed which
> can create confusion as to which modules are being used when. Please
> make sure you've removed all traces of your previos installation.
>
> Matthew
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttps://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

From jbrisbin at vmware.com  Mon Jan 31 14:22:18 2011
From: jbrisbin at vmware.com (Jonathan Brisbin)
Date: Mon, 31 Jan 2011 06:22:18 -0800
Subject: [rabbitmq-discuss] errors with new rabbit_riak_queue
Message-ID: <79A7C8AB-3BFC-465E-95FB-7DC21BD7EA14@vmware.com>

I was getting some errors over the weekend on this new message persister to Riak I've been hacking on in the random moments that I have free time (which is getting scarcer and scarcer). The gist is here:

https://gist.github.com/804058#file_requeue_errors.txt

<https://gist.github.com/804058#file_requeue_errors.txt>The .erl file is right above it. It looks like I'm not sending something correctly, but I can't quite figure out what it is I'm missing.

Any help tracking this down would be appreciated! :)


Jon Brisbin

Twitter: @j_brisbin
Skype: jon.brisbin



From majek04 at gmail.com  Mon Jan 31 14:36:43 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Mon, 31 Jan 2011 14:36:43 +0000
Subject: [rabbitmq-discuss] What is the best option for work sharing
 that needs topic like selective message receival?
In-Reply-To: <AANLkTinPPog61Qgt-xFNvn-UFeYkrMUhH3xuwM-Xdvvx@mail.gmail.com>
References: <AANLkTinPPog61Qgt-xFNvn-UFeYkrMUhH3xuwM-Xdvvx@mail.gmail.com>
Message-ID: <AANLkTikdyn33xfu+FZjKVTo+X=9BhN_gNqCLzBk4Xp=i@mail.gmail.com>

On Mon, Jan 31, 2011 at 09:40, Enno Shioji <eshioji at gmail.com> wrote:
> I have an app. I would like to migrate to AMQP based architecture. The
> main component/functionality of this app. is to distribute work based
> on some rules.
>
> After learning a little bit about AMQP, I concluded that the way to
> achieve this is to have the producer send "jobs" to a direct exchange
> with routing keys that indicate the nature of the jobs (let's call it
> "job category"), and having queues that binds to each unique routing
> key, and then having consumers listening on these queues. Multiple
> consumers may listen to the same queue. One job should only be
> performed once system-wide (but is not strictly required as long as
> performance loss is not significant).
>
> My problem is that the number of such "job category" increases
> overtime. E.g. if in the beginning there is only one routing keys such
> as "key.stuff.1.A", overtime keys like "key.stuff.2.A" or
> "key.stuff.2.B" will start to emerge and eventually such categories
> will reach a large number. However, older categories will eventually
> become obsolete so at a given time I would have at most something like
> 20K different "job categories". But overtime I would have a LOT of job
> categories. (Lifetime of each "job category" depends and can be
> anything from 1 day to 1 seconds etc..)
>
> I'm wondering if there is a better way to achieve what I want.
>
> If this helps, everything can be transient and non durable. Message
> loss can be tolerated as long as it's not too frequent (e.g. once per
> 10K msgs etc.)

I'm afraid the problem needs some more explanation.
 - what's wrong with just one fat queue that is shared between workers?
 - are all the tasks going to take roughly the same time?
 - do you need to prioritize the tasks?

Cheers,
  Marek

From majek04 at gmail.com  Mon Jan 31 14:38:46 2011
From: majek04 at gmail.com (Marek Majkowski)
Date: Mon, 31 Jan 2011 14:38:46 +0000
Subject: [rabbitmq-discuss] timeout on pika.asyncore_loop
In-Reply-To: <4D455EA1.2000200@gmail.com>
References: <4D455EA1.2000200@gmail.com>
Message-ID: <AANLkTiku4WC4oqDa3K4Zi7P85tjc0s-QbUEn+0iDCYN7@mail.gmail.com>

On Sun, Jan 30, 2011 at 12:50, Marcin Krol <mrkafk at gmail.com> wrote:
> Apparently if pika.asyncore_loop() times out, there's no way of knowing
> that for now:

That's a perfect candidate for a feature request in Pika issue tracker:
  https://github.com/tonyg/pika/issues

Cheers,
  Marek

From moseley at hank.org  Mon Jan 31 15:01:13 2011
From: moseley at hank.org (Bill Moseley)
Date: Mon, 31 Jan 2011 07:01:13 -0800
Subject: [rabbitmq-discuss] Consumer management
Message-ID: <AANLkTikAo-Gic97bst2oz1t=JQW3DORRoS9DFJzFH3RG@mail.gmail.com>

How do you manage your consumer/worker processes?  Does anyone look at the
queue lengths and automatically adjust the number of consumers?

Is anyone using http://supervisord.org/ for managing consumer processes?



I have a pool of servers to run a small collection of consumers that do
different tasks.  As load dictates (by looking at messages waiting in
queues) I'd like to be able to dynamically re-balance the mixture of
consumers.  For example, if a lot of requests come in for report generation
and I have a lot of idle consumers that do image manipulation I'd like to
reduce the number of image processing consumers and add more report
generation consumers.

(Many of my consumers are pretty simple in that they just run some command
line tool.)

What's your approach?


And do you tend to write consumers that are small stand-alone programs
(something easy for Supervisor to manage) or write larger (perhaps more
complex) stand-alone apps that listen to a queue and fork (or threads)
workers do handle incoming messages?



-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110131/db248cb6/attachment.htm>

From moseley at hank.org  Mon Jan 31 15:26:34 2011
From: moseley at hank.org (Bill Moseley)
Date: Mon, 31 Jan 2011 07:26:34 -0800
Subject: [rabbitmq-discuss] Pulling RabbitMQ out of service
Message-ID: <AANLkTimfiszCWbmvTXDP+aksewghMm9OffvVuk0puExj@mail.gmail.com>

For those of you running multiple RabbitMQ servers in a cluster, what is
your procedure when you want to shut one of the servers down (e.g. for
maintenance) but not disrupt overall service?   Queues only live on one
server so I'm wondering how (or if) you do something to flush out the queue
before stopping the machine.

Now, this is a bit tougher: How about catastrophic failures?  I'm wondering
about using the complexity of Pacemaker and DRBD vs. tracking incomplete
jobs and resubmitting after some time.






-- 
Bill Moseley
moseley at hank.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110131/640046a6/attachment.htm>

From matthew at rabbitmq.com  Mon Jan 31 15:30:49 2011
From: matthew at rabbitmq.com (Matthew Sackman)
Date: Mon, 31 Jan 2011 15:30:49 +0000
Subject: [rabbitmq-discuss] Slow consumer disconnect availability on
 RAbbitMQ
In-Reply-To: <11EC96EC521B304EA05595E6F2987FC20234DE3B@EXCHBAN.machcorp.lan>
References: <F78BCF638F95D74A99D036114107EDB5023948CC70@EXCH-MBX-3.vmware.com>
	<11EC96EC521B304EA05595E6F2987FC20234DE3B@EXCHBAN.machcorp.lan>
Message-ID: <20110131153049.GC16743@rabbitmq.com>

Hi Prashant,

On Thu, Jan 27, 2011 at 05:15:50AM +0530, Prashant Yadav wrote:
> Actually we do have a requirement where I want consumer to stop getting message once I know that its slow( my consumption logic connects to remote server and if server is not responding or is slow for any reason I dont want my queue to get clogged), I would want to stop queue from populating.

Why?

In general, it seems to me that slow consumer detection is solving the
problem the wrong way.

Rabbit and message brokers in general are there to decouple components.
Rabbit is pretty good these days at coping with receiving messages
faster than they're being sent out, buffering messages in RAM and on
disk and generally absorbing such pressure.

It seems odd to me that because you have pressure downstream (slow
responding server) you want to address that upstream by throwing away
the queue and its messages. If your messages are of transient value then
I'd have thought that the per-queue message TTL would be ideal: that
will silently drop messages from the queue once they have resided in the
queue for more than the specified time.

> The catch here is , I too dont want to purge all the messages or drop it . I too tried to use TTL and queue lease , but am not sure about messages resisding in the queue i.e whether they are requed or silently dropped( in my case I want them to by returned back to exchange and make the queue alive after some duration)

What you seem to be asking for is that the broker buffers
(store+forward) messages whenever things are going fine, but that once
the consumer starts going slowly, the back pressure is passed all the
way back up to the producer. This negates one of the key purposes of the
broker - if you want this level of direct connection between the
producer and consumer then why not connect them directly together - why
are you using RabbitMQ at all in the middle?

You may also like to look at the "immediate" flag on basic.publish which
might do what you want.

Best wishes,

Matthew

From minaev at gmail.com  Mon Jan 31 19:12:18 2011
From: minaev at gmail.com (Dmitri Minaev)
Date: Mon, 31 Jan 2011 22:12:18 +0300
Subject: [rabbitmq-discuss] Consumer management
In-Reply-To: <AANLkTikAo-Gic97bst2oz1t=JQW3DORRoS9DFJzFH3RG@mail.gmail.com>
References: <AANLkTikAo-Gic97bst2oz1t=JQW3DORRoS9DFJzFH3RG@mail.gmail.com>
Message-ID: <AANLkTikMm41F6Vs4K6ozyyUL4fW5rPiiZpMmL3tNbu4W@mail.gmail.com>

On Mon, Jan 31, 2011 at 6:01 PM, Bill Moseley <moseley at hank.org> wrote:
> How do you manage your consumer/worker processes? ?Does anyone look at the
> queue lengths and automatically adjust the number of consumers?
> Is anyone using?http://supervisord.org/?for managing consumer processes?

I wrote a simple plugin for Munin (available at Munin-Exchange:
http://exchange.munin-monitoring.org/plugins/rabbitmq_list_queues/details),
which lists all available queues and draws a graph of the number of
messages in these queues. When a queue gets longer than, say, 100k
messages, I fling a pencil into the author of the corresponding
consumers.

-- 
With best regards,
Dmitri Minaev

From eshioji at gmail.com  Mon Jan 31 19:39:34 2011
From: eshioji at gmail.com (Enno Shioji)
Date: Tue, 1 Feb 2011 04:39:34 +0900
Subject: [rabbitmq-discuss] What is the best option for work sharing
 that needs topic like selective message receival?
In-Reply-To: <AANLkTikdyn33xfu+FZjKVTo+X=9BhN_gNqCLzBk4Xp=i@mail.gmail.com>
References: <AANLkTinPPog61Qgt-xFNvn-UFeYkrMUhH3xuwM-Xdvvx@mail.gmail.com>
	<AANLkTikdyn33xfu+FZjKVTo+X=9BhN_gNqCLzBk4Xp=i@mail.gmail.com>
Message-ID: <AANLkTinmxAPKvjz1eg=ByV23X9xJgBsqYQmOjbMbqD3X@mail.gmail.com>

Hi Marek,

Thanks for the reply!

> I'm afraid the problem needs some more explanation.
> ?- what's wrong with just one fat queue that is shared between workers?
Some workers can perform certain categories of jobs, while some
workers can perform other categories of job. I.e. workers cannot
perform all category of jobs. They can only perform a subset of job
category. So, if there is a fat queue, many consumers will pull
messages that they cannot consume and would have to put those back
into the queue (which I think would be very inefficient).

> ?- are all the tasks going to take roughly the same time?
At the current moment, yes.

> ?- do you need to prioritize the tasks?
It would be nice to roughly prioritize the tasks (it doesn't have to
be strict), but it'd be more of a "nice to have" requirement...



Regards,
Enno





On Mon, Jan 31, 2011 at 11:36 PM, Marek Majkowski <majek04 at gmail.com> wrote:
> On Mon, Jan 31, 2011 at 09:40, Enno Shioji <eshioji at gmail.com> wrote:
>> I have an app. I would like to migrate to AMQP based architecture. The
>> main component/functionality of this app. is to distribute work based
>> on some rules.
>>
>> After learning a little bit about AMQP, I concluded that the way to
>> achieve this is to have the producer send "jobs" to a direct exchange
>> with routing keys that indicate the nature of the jobs (let's call it
>> "job category"), and having queues that binds to each unique routing
>> key, and then having consumers listening on these queues. Multiple
>> consumers may listen to the same queue. One job should only be
>> performed once system-wide (but is not strictly required as long as
>> performance loss is not significant).
>>
>> My problem is that the number of such "job category" increases
>> overtime. E.g. if in the beginning there is only one routing keys such
>> as "key.stuff.1.A", overtime keys like "key.stuff.2.A" or
>> "key.stuff.2.B" will start to emerge and eventually such categories
>> will reach a large number. However, older categories will eventually
>> become obsolete so at a given time I would have at most something like
>> 20K different "job categories". But overtime I would have a LOT of job
>> categories. (Lifetime of each "job category" depends and can be
>> anything from 1 day to 1 seconds etc..)
>>
>> I'm wondering if there is a better way to achieve what I want.
>>
>> If this helps, everything can be transient and non durable. Message
>> loss can be tolerated as long as it's not too frequent (e.g. once per
>> 10K msgs etc.)
>
> I'm afraid the problem needs some more explanation.
> ?- what's wrong with just one fat queue that is shared between workers?
> ?- are all the tasks going to take roughly the same time?
> ?- do you need to prioritize the tasks?
>
> Cheers,
> ?Marek
>

From yoavglazner at gmail.com  Mon Jan 31 19:59:35 2011
From: yoavglazner at gmail.com (yoav glazner)
Date: Mon, 31 Jan 2011 21:59:35 +0200
Subject: [rabbitmq-discuss] Blocking queue.get() in python?
Message-ID: <AANLkTinVO8XSRg4TLEVxJzauu=qtwoS0=T0dxyB_c5oG@mail.gmail.com>

Hi,

I'm trying to implement a priority queue over Rabbit with python, and this
is my idea
each batch of tasks has its own queue, each worker knows about all the
batches and their priorities.
now the part where I don't understand:
  how does a worker tries a take a task from a batch(queue)  but if its
empty it passes to the next batch?

I need somthing like:

for q in queuesSortedByPriority:
  t = q.get()
  if t: break
else: raise NoTaskFound()

Many thanks,

Yoav Glazner.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110131/435ab182/attachment.htm>

