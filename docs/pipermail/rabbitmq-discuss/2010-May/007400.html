<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Java client problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Java%20client%20problem&In-Reply-To=28693038.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007397.html">
   <LINK REL="Next"  HREF="007402.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Java client problem</H1>
    <B>Emile Joubert</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Java%20client%20problem&In-Reply-To=28693038.post%40talk.nabble.com"
       TITLE="[rabbitmq-discuss] Java client problem">emile at rabbitmq.com
       </A><BR>
    <I>Thu May 27 14:52:32 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007397.html">[rabbitmq-discuss]  Java client problem
</A></li>
        <LI>Next message: <A HREF="007402.html">[rabbitmq-discuss] Java client problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7400">[ date ]</a>
              <a href="thread.html#7400">[ thread ]</a>
              <a href="subject.html#7400">[ subject ]</a>
              <a href="author.html#7400">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Jacek,

You are correct that the heartbeat only starts after the connection 
tuning phase of the protocol negotiation so that both peers agree on the 
frequency. It would not make sense to throw a heartbeat exception until 
both peers agreed on a frequency and the heartbeat has started. So I 
don't think it makes sense to set the value any earlier as you suggest.

Can you please confirm what connection retry logic you are referring to 
- is that logic in the com.rabbitmq.client namespace?

Regards

Emile



jacek_ wrote:
&gt;<i> Hi, 
</I>&gt;<i> 
</I>&gt;<i> I am testing currently the Java RabbitMQ client. I want to make sure that
</I>&gt;<i> any problems that can occur with connection to RabbitMQ server will be
</I>&gt;<i> handled properly. To test if everything is working fine I stopped rabbitmq
</I>&gt;<i> server proces (using kill -s SIGSTOP command). This imitate more or less
</I>&gt;<i> problems which can occur in the future. I specified the heartbeat in Java
</I>&gt;<i> client and want to get exceptions when the server does not respond.
</I>&gt;<i> Unfortunatelly when the client tries to connect it enters into endless loop.
</I>&gt;<i> The socket timeout exception is thrown by standard Java socket mechanism but
</I>&gt;<i> RabbitMQ client catch this exception and retry.  No MissedHeartbeatException
</I>&gt;<i> exception is thrown. I have looked into source code of AMQConnection class
</I>&gt;<i> and found that method: 
</I>&gt;<i> 
</I>&gt;<i>     public void handleSocketTimeout() throws MissedHeartbeatException { 
</I>&gt;<i>         if (_heartbeat == 0) { 
</I>&gt;<i>             // No heartbeating. Go back and wait some more. 
</I>&gt;<i>             return; 
</I>&gt;<i>         } 
</I>&gt;<i> 
</I>&gt;<i>         _missedHeartbeats++; 
</I>&gt;<i> 
</I>&gt;<i>         // We check against 8 = 2 * 4 because we need to wait for at 
</I>&gt;<i>         // least two complete heartbeat setting intervals before 
</I>&gt;<i>         // complaining, and we've set the socket timeout to a quarter 
</I>&gt;<i>         // of the heartbeat setting in setHeartbeat above. 
</I>&gt;<i>         if (_missedHeartbeats &gt; (2 * 4)) { 
</I>&gt;<i>             throw new MissedHeartbeatException(&quot;Heartbeat missing with
</I>&gt;<i> heartbeat == &quot; + 
</I>&gt;<i>                                                _heartbeat + &quot; seconds&quot;); 
</I>&gt;<i>         } 
</I>&gt;<i>     } 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The problem is that _heartbeat field is filled with data after connection is
</I>&gt;<i> created (not before). The initial value is 0. Until connection is
</I>&gt;<i> successfully made client will try to connect again and again. Exception will
</I>&gt;<i> never be thrown, so my application will have no information about server
</I>&gt;<i> problems. In my opinion only minor changes are required to make this thing
</I>&gt;<i> work - _hearbeat field should be filled before making the connection. Please
</I>&gt;<i> correct me if I am wrong. 
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance, 
</I>&gt;<i> Jacek 
</I>

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007397.html">[rabbitmq-discuss]  Java client problem
</A></li>
	<LI>Next message: <A HREF="007402.html">[rabbitmq-discuss] Java client problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7400">[ date ]</a>
              <a href="thread.html#7400">[ thread ]</a>
              <a href="subject.html#7400">[ subject ]</a>
              <a href="author.html#7400">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
