<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Java client problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Java%20client%20problem&In-Reply-To=4BFE7920.9040309%40rabbitmq.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007400.html">
   <LINK REL="Next"  HREF="007406.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Java client problem</H1>
    <B>Jacek Olszak</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Java%20client%20problem&In-Reply-To=4BFE7920.9040309%40rabbitmq.com"
       TITLE="[rabbitmq-discuss] Java client problem">jacekolszak at gmail.com
       </A><BR>
    <I>Thu May 27 15:17:16 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007400.html">[rabbitmq-discuss] Java client problem
</A></li>
        <LI>Next message: <A HREF="007406.html">[rabbitmq-discuss] Java client problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7402">[ date ]</a>
              <a href="thread.html#7402">[ thread ]</a>
              <a href="subject.html#7402">[ subject ]</a>
              <a href="author.html#7402">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

first of all thanks for quick reply :) I use classes from
&quot;com.rabbitmq.client&quot; package. The code I pasted here is from class
com.rabbitmq.client.impl.AMQConnection. My problem is that the client
will never throw an exception and will hangs indefinitely until the
server socket is closed or the process will continue to work. My idea
is that the Java client should throw some exception in such case,
because it is possible that under very heavy load or network problems
rabbitmq server will not reply in reasonable amount of time. In such
case I want to connect to another MQ server.

Best regards,
Jacek

On Thu, May 27, 2010 at 3:52 PM, Emile Joubert &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hi Jacek,
</I>&gt;<i>
</I>&gt;<i> You are correct that the heartbeat only starts after the connection tuning
</I>&gt;<i> phase of the protocol negotiation so that both peers agree on the frequency.
</I>&gt;<i> It would not make sense to throw a heartbeat exception until both peers
</I>&gt;<i> agreed on a frequency and the heartbeat has started. So I don't think it
</I>&gt;<i> makes sense to set the value any earlier as you suggest.
</I>&gt;<i>
</I>&gt;<i> Can you please confirm what connection retry logic you are referring to - is
</I>&gt;<i> that logic in the com.rabbitmq.client namespace?
</I>&gt;<i>
</I>&gt;<i> Regards
</I>&gt;<i>
</I>&gt;<i> Emile
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> jacek_ wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> I am testing currently the Java RabbitMQ client. I want to make sure that
</I>&gt;&gt;<i> any problems that can occur with connection to RabbitMQ server will be
</I>&gt;&gt;<i> handled properly. To test if everything is working fine I stopped rabbitmq
</I>&gt;&gt;<i> server proces (using kill -s SIGSTOP command). This imitate more or less
</I>&gt;&gt;<i> problems which can occur in the future. I specified the heartbeat in Java
</I>&gt;&gt;<i> client and want to get exceptions when the server does not respond.
</I>&gt;&gt;<i> Unfortunatelly when the client tries to connect it enters into endless
</I>&gt;&gt;<i> loop.
</I>&gt;&gt;<i> The socket timeout exception is thrown by standard Java socket mechanism
</I>&gt;&gt;<i> but
</I>&gt;&gt;<i> RabbitMQ client catch this exception and retry. &#160;No
</I>&gt;&gt;<i> MissedHeartbeatException
</I>&gt;&gt;<i> exception is thrown. I have looked into source code of AMQConnection class
</I>&gt;&gt;<i> and found that method:
</I>&gt;&gt;<i> &#160; &#160;public void handleSocketTimeout() throws MissedHeartbeatException {
</I>&gt;&gt;<i> &#160; &#160; if (_heartbeat == 0) { &#160; &#160; &#160; &#160; &#160; &#160; // No heartbeating. Go back and wait
</I>&gt;&gt;<i> some more. &#160; &#160; &#160; &#160; &#160; &#160; return; &#160; &#160; &#160; &#160; }
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160;_missedHeartbeats++;
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160;// We check against 8 = 2 * 4 because we need to wait for at
</I>&gt;&gt;<i> &#160; // least two complete heartbeat setting intervals before &#160; &#160; &#160; &#160; //
</I>&gt;&gt;<i> complaining, and we've set the socket timeout to a quarter &#160; &#160; &#160; &#160; // of the
</I>&gt;&gt;<i> heartbeat setting in setHeartbeat above. &#160; &#160; &#160; &#160; if (_missedHeartbeats &gt; (2
</I>&gt;&gt;<i> * 4)) { &#160; &#160; &#160; &#160; &#160; &#160; throw new MissedHeartbeatException(&quot;Heartbeat missing
</I>&gt;&gt;<i> with
</I>&gt;&gt;<i> heartbeat == &quot; + &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;_heartbeat
</I>&gt;&gt;<i> + &quot; seconds&quot;); &#160; &#160; &#160; &#160; } &#160; &#160; }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem is that _heartbeat field is filled with data after connection
</I>&gt;&gt;<i> is
</I>&gt;&gt;<i> created (not before). The initial value is 0. Until connection is
</I>&gt;&gt;<i> successfully made client will try to connect again and again. Exception
</I>&gt;&gt;<i> will
</I>&gt;&gt;<i> never be thrown, so my application will have no information about server
</I>&gt;&gt;<i> problems. In my opinion only minor changes are required to make this thing
</I>&gt;&gt;<i> work - _hearbeat field should be filled before making the connection.
</I>&gt;&gt;<i> Please
</I>&gt;&gt;<i> correct me if I am wrong.
</I>&gt;&gt;<i> Thanks in advance, Jacek
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007400.html">[rabbitmq-discuss] Java client problem
</A></li>
	<LI>Next message: <A HREF="007406.html">[rabbitmq-discuss] Java client problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7402">[ date ]</a>
              <a href="thread.html#7402">[ thread ]</a>
              <a href="subject.html#7402">[ subject ]</a>
              <a href="author.html#7402">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
