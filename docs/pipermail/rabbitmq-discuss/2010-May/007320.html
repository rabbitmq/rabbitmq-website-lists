<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer stop to receive messages but	continue listening queue problem.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Consumer%20stop%20to%20receive%20messages%0A%20but%09continue%20listening%20queue%20problem.&In-Reply-To=AANLkTinOPDsuowNkBRE9SIhtuEB_LYrBViYOf46-8H0m%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007319.html">
   <LINK REL="Next"  HREF="007336.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer stop to receive messages but	continue listening queue problem.</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Consumer%20stop%20to%20receive%20messages%0A%20but%09continue%20listening%20queue%20problem.&In-Reply-To=AANLkTinOPDsuowNkBRE9SIhtuEB_LYrBViYOf46-8H0m%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Consumer stop to receive messages but	continue listening queue problem.">matthias at rabbitmq.com
       </A><BR>
    <I>Wed May 19 05:20:10 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007319.html">[rabbitmq-discuss] Consumer stop to receive messages but	continue listening queue problem.
</A></li>
        <LI>Next message: <A HREF="007336.html">[rabbitmq-discuss] Consumer stop to receive messages but	continue listening queue problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7320">[ date ]</a>
              <a href="thread.html#7320">[ thread ]</a>
              <a href="subject.html#7320">[ subject ]</a>
              <a href="author.html#7320">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Gustavo,

Gustavo Aquino wrote:
&gt;<i> We put test to run for 1 hour, and monitoring queue size with 
</I>&gt;<i> rabbitmqctl list_queues, all the time list have 0 size, so consumer are 
</I>&gt;<i> getting all on the fly, and now we stop publisher and here is the BIG 
</I>&gt;<i> PROBLEM, consumer continue to consume messages from queue... and it's 
</I>&gt;<i> remain for 20 minutes after stop publisher......
</I>&gt;<i> 
</I>&gt;<i> If we stop consumer we can see the queue growing for long time..., 
</I>&gt;<i> therefore looking for it's we can conclude that our consumer are 20 
</I>&gt;<i> minutes late behind publisher and it's a f... problem last message from 
</I>&gt;<i> publisher will be received by consumer just 20 minutes after.
</I>
How are the messages being consumed? Using basic.consume? If so then the 
above observation is consistent with messages getting buffered in the 
network and/or consumers.

How are you monitoring the queue lengths? The default output of 
'rabbitmqctl list_queues' will give a figure that is the sum of ready, 
unacknowledged and uncommitted messages. You can get a more detailed 
breakdown with s.t. like 'rabbitmqctl list_queues name messages_ready 
messages_unacknowledged messages_uncommitted' - see 
<A HREF="http://www.rabbitmq.com/admin-guide.html#list_queues.">http://www.rabbitmq.com/admin-guide.html#list_queues.</A>

If my above analysis is correct then for the total to be zero the 
clients would have to be consuming messages in no-ack mode, since 
otherwise the messages_unacknowledged count would go up. Are they?

&gt;<i> So can anyone help me ? Its's a common problem in Rabbit ? anybody here 
</I>&gt;<i> have this same problem ? We have talked about a possible exchange buffer 
</I>&gt;<i> cause and etc in this way, but to be sincerely in my thoughts ~3000 m/s 
</I>&gt;<i> is a bit easy to be processed for one message server.
</I>
It looks like rabbit is handling the load just fine, but the consumers 
are struggling to keep up and are just buffering the messages. This can 
happen easily if the consumer code is employing s.t. like the 
QueueingConsumer in our Java client library - 
<A HREF="http://www.rabbitmq.com/releases/rabbitmq-java-client/v1.7.2/rabbitmq-java-client-javadoc-1.7.2/com/rabbitmq/client/QueueingConsumer.html">http://www.rabbitmq.com/releases/rabbitmq-java-client/v1.7.2/rabbitmq-java-client-javadoc-1.7.2/com/rabbitmq/client/QueueingConsumer.html</A>

But it can also happen just through buffering in the network layers.

To avoid a large backlog building up, probably the easiest solution is 
to set a prefetch limit with basic.qos. But for that to be effective the 
consumers must be consuming in ack mode.


Regards,

Matthias.

</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007319.html">[rabbitmq-discuss] Consumer stop to receive messages but	continue listening queue problem.
</A></li>
	<LI>Next message: <A HREF="007336.html">[rabbitmq-discuss] Consumer stop to receive messages but	continue listening queue problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7320">[ date ]</a>
              <a href="thread.html#7320">[ thread ]</a>
              <a href="subject.html#7320">[ subject ]</a>
              <a href="author.html#7320">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
