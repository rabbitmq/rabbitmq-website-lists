<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmq recovery, channelflow, and clients
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20rabbitmq%20recovery%2C%20channelflow%2C%20and%20clients&In-Reply-To=8B49B6A4-FB50-4250-9820-D198C6A68662%40echonest.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007365.html">
   <LINK REL="Next"  HREF="007393.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmq recovery, channelflow, and clients</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20rabbitmq%20recovery%2C%20channelflow%2C%20and%20clients&In-Reply-To=8B49B6A4-FB50-4250-9820-D198C6A68662%40echonest.com"
       TITLE="[rabbitmq-discuss] rabbitmq recovery, channelflow, and clients">matthew at rabbitmq.com
       </A><BR>
    <I>Sun May 23 09:32:45 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007365.html">[rabbitmq-discuss] rabbitmq recovery, channelflow, and clients
</A></li>
        <LI>Next message: <A HREF="007393.html">[rabbitmq-discuss] rabbitmq recovery, channelflow, and clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7367">[ date ]</a>
              <a href="thread.html#7367">[ thread ]</a>
              <a href="subject.html#7367">[ subject ]</a>
              <a href="author.html#7367">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Tyler,

On Sat, May 22, 2010 at 09:21:32AM -0400, Tyler Williams wrote:
&gt;<i> I've been playing with the 21673 branch of rabbitmq, and I have a few questions. 
</I>&gt;<i> 
</I>&gt;<i> How does rabbitmq handle bumping up against ulimit -n?
</I>
The long answer is read my blog post about it here:
<A HREF="http://www.lshift.net/blog/2010/03/23/the-fine-art-of-holding-a-file-descriptor">http://www.lshift.net/blog/2010/03/23/the-fine-art-of-holding-a-file-descriptor</A>

The short answer is &quot;it copes magically and seemlessly&quot;. At least
probabilistically.

&gt;<i> After overwhelming rabbitmq with what I think is a misbehaving client, and then restarting it, rabbitmq recovers some of my queues, and none of the messages that were in them. Is this the expected behavior? I see messages like this in rabbit.log for the unrecovered queues:
</I>
Durable queues will survive a broker crash/restart. Persistent messages
inside durable queues will too. However, due to buffering in various
places you may lose some of the persistent messages inside durable
queues, unless you happen to be using transactions.

&gt;<i> ** Reason for termination == 
</I>&gt;<i> ** {{badmatch,{error,emfile}},
</I>
Hmm, you really have run out of file descriptors. This is not meant to
happen! On Thursday and Friday we added a few fixes to try and prevent
some mis-behaving clients from overwhelming Rabbit from the connection
point of view (rapidly opening new sockets etc). I've just merged all
that into bug21673 so if you pull and try again, I'd be interested to
see if things have improved there.

But in general, what kinds of things were your misbehaving clients doing
to cause this to happen?

&gt;<i> With respect to ChannelFlow, when rabbit gets a high mem watermark event and sends out the channelflow command to producers, will it disconnect producers who don't honor this?
</I>
Not yet, but soon, yes. This is likely to be implemented next week.

&gt;<i> I've been playing with both pika and amqplib clients. With pika, I see the watermark get set, the flow exception thrown in my producer, and then eventually the watermark gets cleared. With amqplib I see the watermark set but never cleared. I see what looks like some support for flow in amqplib, but I can't tell how it's being used.
</I>
There is no support for flow in amqplib. Tony has produced an
experimental patch for it (search this list), but I've no idea how fully
tested it is.

The watermark will eventually get cleared - the goal of the bug21673
branch is to ensure that eventually, Rabbit will always be able to
accept another message. Now hard disks aren't as fast as RAM, so from
time to time, when we run out of space in RAM, we have no choice but to
use flow to stop clients from publishing so as to give ourselves some
breathing room to flush out to disk. But the high watermark should
always drop, eventually.

Best wishes,

Matthew

</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007365.html">[rabbitmq-discuss] rabbitmq recovery, channelflow, and clients
</A></li>
	<LI>Next message: <A HREF="007393.html">[rabbitmq-discuss] rabbitmq recovery, channelflow, and clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7367">[ date ]</a>
              <a href="thread.html#7367">[ thread ]</a>
              <a href="subject.html#7367">[ subject ]</a>
              <a href="author.html#7367">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
