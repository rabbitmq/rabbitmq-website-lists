<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmq-discuss Digest, Vol 36, Issue 56
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20rabbitmq-discuss%20Digest%2C%20Vol%2036%2C%20Issue%2056&In-Reply-To=mailman.149.1274471884.2521.rabbitmq-discuss%40lists.rabbitmq.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007366.html">
   <LINK REL="Next"  HREF="007364.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmq-discuss Digest, Vol 36, Issue 56</H1>
    <B>Radha Krishnan D</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20rabbitmq-discuss%20Digest%2C%20Vol%2036%2C%20Issue%2056&In-Reply-To=mailman.149.1274471884.2521.rabbitmq-discuss%40lists.rabbitmq.com"
       TITLE="[rabbitmq-discuss] rabbitmq-discuss Digest, Vol 36, Issue 56">RadhakrishnanD at ivycomptech.com
       </A><BR>
    <I>Sat May 22 06:07:18 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007366.html">[rabbitmq-discuss] help: simple web application integration and	testing
</A></li>
        <LI>Next message: <A HREF="007364.html">[rabbitmq-discuss] RabbitMQ failover and message loss
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7363">[ date ]</a>
              <a href="thread.html#7363">[ thread ]</a>
              <a href="subject.html#7363">[ subject ]</a>
              <a href="author.html#7363">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matthew,

&gt;<i> Ok, that's not a usual setup. If you actually have the two rabbit
</I>nodes
&gt;<i> clustered together then you should have no need for the load balancer
</I>-
&gt;<i> all clients can connect to either node and still reach every resource
</I>in
&gt;<i> the broker.
</I>
We want to do graceful failover from one rabbitmq broker to another
rabbitmq broker. So only we used HA proxy.
Even though we used HA proxy, the two brokers B1 and B2 are in a cluster
only. I achieved that using rabbitmqctl command.

I have another doubt matthew ,

The queue is lost when the node is crashed. So all the messages in the
queue at that point are lost. Will those messages be returned to the
producer by using channel.setReturnListener ? I mean, will that listener
be called.





Thanks and Regards,

D.Radhakrishnan
Trainee Engineer-Architecture

IVY Comptech Private Limited
Cyber Spazio,Road No 2, Banjara Hills, 
Hyderabad-500034, Andhra Pradesh. 

Phone + 91 (40) 66721000 - 4638
Mobile + 91 (0) 9030842104

This email and any attachments are confidential, legally privileged and
protected by copyright. If you are not the intended recipient,
dissemination or copying this email is prohibited. If you have received
this in error, please notify the sender by replying by email and then
delete the email completely from your system.

Any views or opinions are solely those of  the sender. This
communication is not intended to form a binding contract unless
expressly indicated to the contrary and properly authorized. Any actions
taken on the basis of this email are at recipient's own risk. 




Message: 1
Date: Fri, 21 May 2010 18:55:57 +0530
From: &quot;Radha Krishnan D&quot; &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">RadhakrishnanD at ivycomptech.com</A>&gt;
Subject: [rabbitmq-discuss] RabbitMQ failover and message loss
To: &quot;RabbitMQ Discuss&quot; &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
Message-ID:
	
&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">49A7BA114AAC6A48B9C44CB06B7B987E0A4AC1D4 at HYDSVWIN004X.ivycomptech.party</A>
gaming.local&gt;
	
Content-Type: text/plain; charset=&quot;us-ascii&quot;
 
 

Hi,

 

I have 2 brokers clustered with each other.  They are load balanced by
having a HA proxy before them.

Let us call the brokers as B1 and B2.

 

The HAproxy is in the same machine as B1.

 

The producer P1 and consumer C1 are on different machines.

 

The model we are using is amq.direct  and all the messages are non
persistent. All our  messages are mandatory=true and immediate=false.

 

Initially we start the broker B1 alone.  The broker B2 is down.

We start P1 and C1. They are now connected to the broker B1. 

We start C1 and then P1. after 3-4 seconds, we start B2.

After B2 starts, We immediately crash B1. 

Now both P1 and C1 get connected to B2 and the test continues till we
stop all three.

 

Now, during the failover time we find message losses.

 

Is it expected  or can we make sure that no message gets lost.

 

 

Also, when will be  channel.setReturnListener  called ? 

Will it be called when the message does not reach the queue from the
exchange or when the message does reach the consumer from the queue ?

 

 

In the clustered mode, exchanges are global across rabbitmq nodes .. are
the queues also global ?

Please clear us. We are confused about the global nature of queues !! 

 

 

 

 

Thanks and Regards,

D.Radhakrishnan
Trainee Engineer-Architecture

IVY Comptech Private Limited
Cyber Spazio,Road No 2, Banjara Hills, 
Hyderabad-500034, Andhra Pradesh. 

Phone + 91 (40) 66721000 - 4638
Mobile + 91 (0) 9030842104

This email and any attachments are confidential, legally privileged and
protected by copyright. If you are not the intended recipient,
dissemination or copying this email is prohibited. If you have received
this in error, please notify the sender by replying by email and then
delete the email completely from your system.

Any views or opinions are solely those of  the sender. This
communication is not intended to form a binding contract unless
expressly indicated to the contrary and properly authorized. Any actions
taken on the basis of this email are at recipient's own risk. 

 



Message: 2
Date: Fri, 21 May 2010 15:50:26 +0100
From: Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at rabbitmq.com</A>&gt;
Subject: Re: [rabbitmq-discuss] RabbitMQ failover and message loss
To: <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Message-ID: &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">20100521145026.GA26867 at mrnibble.lshift.net</A>&gt;
Content-Type: text/plain; charset=us-ascii

On Fri, May 21, 2010 at 06:55:57PM +0530, Radha Krishnan D wrote:
&gt;<i> I have 2 brokers clustered with each other.  They are load balanced by
</I>&gt;<i> having a HA proxy before them.
</I>
Ok, that's not a usual setup. If you actually have the two rabbit nodes
clustered together then you should have no need for the load balancer -
all clients can connect to either node and still reach every resource in
the broker.

&gt;<i> Now both P1 and C1 get connected to B2 and the test continues till we
</I>&gt;<i> stop all three.
</I>&gt;<i> 
</I>&gt;<i> Now, during the failover time we find message losses.
</I>&gt;<i> 
</I>&gt;<i> Is it expected  or can we make sure that no message gets lost.
</I>
That is expected. Queues are located on the node of the connection which
created the queue. When the node goes down, you'll lose that queue. When
your clients (re)connect to the broker and reach the other node, they
are recreating the queues and other resources, but are creating fresh,
empty queues at that point.

If you need to be able to withstand node failures then currently your
best bet is to use the Pacemaker Active/Passive guide at:
<A HREF="http://www.rabbitmq.com/pacemaker.html">http://www.rabbitmq.com/pacemaker.html</A>
You will need to publish all messages persistent to durable queues. You
should not need the load balancer and pacemaker will correctly ensure
that the two nodes are not both up at the same time.

&gt;<i> Also, when will be  channel.setReturnListener  called ? 
</I>
Well, you set it yourself. The ReturnListener is invoked as soon as any
Basic.Return method is read off the socket.

&gt;<i> Will it be called when the message does not reach the queue from the
</I>&gt;<i> exchange or when the message does reach the consumer from the queue ?
</I>
This is the difference between immediate and mandatory. Mandatory says
&quot;blow up if the msg doesn't make it to a queue&quot;. Immediate says &quot;blow up
if the msg doesn't make it through a queue to a consumer&quot;.

&gt;<i> In the clustered mode, exchanges are global across rabbitmq nodes ..
</I>are
&gt;<i> the queues also global ?
</I>
They are visible globally within the cluster, but they are located in a
node.

Matthew



------------------------------

Message: 3
Date: Fri, 21 May 2010 10:52:59 -0600
From: &quot;Jason J. W. Williams&quot; &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jasonjwwilliams at gmail.com</A>&gt;
Subject: Re: [rabbitmq-discuss] RabbitMQ failover and message loss
To: <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Message-ID:
	&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">AANLkTikEyNKK6TFFlo6TVnCnyWcoRqBtnuYsiJSYlb6- at mail.gmail.com</A>&gt;
Content-Type: text/plain; charset=ISO-8859-1

Great use case for an auto-replay option when dead nodes return. ;)

-J

On Fri, May 21, 2010 at 8:50 AM, Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at rabbitmq.com</A>&gt;
wrote:
&gt;<i> On Fri, May 21, 2010 at 06:55:57PM +0530, Radha Krishnan D wrote:
</I>&gt;&gt;<i> I have 2 brokers clustered with each other. ?They are load balanced
</I>by
&gt;&gt;<i> having a HA proxy before them.
</I>&gt;<i>
</I>&gt;<i> Ok, that's not a usual setup. If you actually have the two rabbit
</I>nodes
&gt;<i> clustered together then you should have no need for the load balancer
</I>-
&gt;<i> all clients can connect to either node and still reach every resource
</I>in
&gt;<i> the broker.
</I>&gt;<i>
</I>&gt;&gt;<i> Now both P1 and C1 get connected to B2 and the test continues till we
</I>&gt;&gt;<i> stop all three.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now, during the failover time we find message losses.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is it expected ?or can we make sure that no message gets lost.
</I>&gt;<i>
</I>&gt;<i> That is expected. Queues are located on the node of the connection
</I>which
&gt;<i> created the queue. When the node goes down, you'll lose that queue.
</I>When
&gt;<i> your clients (re)connect to the broker and reach the other node, they
</I>&gt;<i> are recreating the queues and other resources, but are creating fresh,
</I>&gt;<i> empty queues at that point.
</I>&gt;<i>
</I>&gt;<i> If you need to be able to withstand node failures then currently your
</I>&gt;<i> best bet is to use the Pacemaker Active/Passive guide at:
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/pacemaker.html">http://www.rabbitmq.com/pacemaker.html</A>
</I>&gt;<i> You will need to publish all messages persistent to durable queues.
</I>You
&gt;<i> should not need the load balancer and pacemaker will correctly ensure
</I>&gt;<i> that the two nodes are not both up at the same time.
</I>&gt;<i>
</I>&gt;&gt;<i> Also, when will be ?channel.setReturnListener ?called ?
</I>&gt;<i>
</I>&gt;<i> Well, you set it yourself. The ReturnListener is invoked as soon as
</I>any
&gt;<i> Basic.Return method is read off the socket.
</I>&gt;<i>
</I>&gt;&gt;<i> Will it be called when the message does not reach the queue from the
</I>&gt;&gt;<i> exchange or when the message does reach the consumer from the queue ?
</I>&gt;<i>
</I>&gt;<i> This is the difference between immediate and mandatory. Mandatory says
</I>&gt;<i> &quot;blow up if the msg doesn't make it to a queue&quot;. Immediate says &quot;blow
</I>up
&gt;<i> if the msg doesn't make it through a queue to a consumer&quot;.
</I>&gt;<i>
</I>&gt;&gt;<i> In the clustered mode, exchanges are global across rabbitmq nodes ..
</I>are
&gt;&gt;<i> the queues also global ?
</I>&gt;<i>
</I>&gt;<i> They are visible globally within the cluster, but they are located in
</I>a
&gt;<i> node.
</I>&gt;<i>
</I>&gt;<i> Matthew
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>



This email is sent for and on behalf of Ivy Comptech Private Limited. Ivy Comptech Private Limited is a limited liability company.  

This email and any attachments are confidential, and may be legally privileged and protected by copyright. If you are not the intended recipient dissemination or copying of this email is prohibited. If you have received this in error, please notify the sender by replying by email and then delete the email completely from your system. 
Any views or opinions are solely those of the sender.  This communication is not intended to form a binding contract on behalf of Ivy Comptech Private Limited unless expressly indicated to the contrary and properly authorised. Any actions taken on the basis of this email are at the recipient's own risk.

Registered office:
Ivy Comptech Private Limited, Cyber Spazio, Road No. 2, Banjara Hills, Hyderabad 500 033, Andhra Pradesh, India. Registered number: 37994. Registered in India. A list of members' names is available for inspection at the registered office.


</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007366.html">[rabbitmq-discuss] help: simple web application integration and	testing
</A></li>
	<LI>Next message: <A HREF="007364.html">[rabbitmq-discuss] RabbitMQ failover and message loss
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7363">[ date ]</a>
              <a href="thread.html#7363">[ thread ]</a>
              <a href="subject.html#7363">[ subject ]</a>
              <a href="author.html#7363">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
