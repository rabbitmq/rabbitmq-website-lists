<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] lost message due to binding delay
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20lost%20message%20due%20to%20binding%20delay&In-Reply-To=4BFD415A.9070400%40rabbitmq.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007392.html">
   <LINK REL="Next"  HREF="007395.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] lost message due to binding delay</H1>
    <B>Aaron Westendorf</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20lost%20message%20due%20to%20binding%20delay&In-Reply-To=4BFD415A.9070400%40rabbitmq.com"
       TITLE="[rabbitmq-discuss] lost message due to binding delay">aaron at agoragames.com
       </A><BR>
    <I>Wed May 26 20:16:16 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007392.html">[rabbitmq-discuss] lost message due to binding delay
</A></li>
        <LI>Next message: <A HREF="007395.html">[rabbitmq-discuss] lost message due to binding delay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7394">[ date ]</a>
              <a href="thread.html#7394">[ thread ]</a>
              <a href="subject.html#7394">[ subject ]</a>
              <a href="author.html#7394">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Simon,

Thank you for the reply.  Responses inline.

On Wed, May 26, 2010 at 11:42 AM, Simon MacMullen &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> I'm not completely sure I understand but if you're saying that your
</I>&gt;<i> driver pipelines synchronous methods (e.g. sends queue.bind in the
</I>&gt;<i> dialogue below before receiving queue.declare-ok from the broker) then
</I>&gt;<i> that's very bad. We don't attempt to detect this in the broker (as any
</I>&gt;<i> such detection would be very racy) but it violates the spec and could
</I>&gt;<i> cause any sort of weird behaviour. So that's possibility #1.
</I>
Your understanding is correct, and a year ago we implemented a pending
queue for basic.consume after running into problems when multiple
consume requests were pending.  From what you're saying, this scope
needs to be expanded to anything with a corresponding &quot;_ok&quot; method,
correct?  Is there another rule on which methods are synchronous and
which are not?  For instance, we wrote basic.publish_synchronous to
abstract the basic.publish and tx.commit behavior, and that also
needed to implement a pending queue of basic.publish calls that is
drained as we receive tx.commit_oks, even though basic.publish itself
is not a synchronous call.

The drivers speed and resource requirements benefit mostly from the
evented IO and timers, so we can implement queuing without much
overall impact.  It seems that much of the spec is written with the
expectation of synchronous request-response, which makes an
asynchronous driver a bit challenging at times.  It does allow our
highest-trafficked applications, the protocol bridges (HTTP - Rabbit)
to have very high throughput with low overhead.  To date, the
buffering of data hasn't adversely impacted memory usage because
Rabbit kindly works fast enough to not keep data buffered in our
clients for long.

&gt;<i> I note you don't talk about channels here. In AMQP the only real
</I>&gt;<i> ordering guarantees are within channels. So if each service is using
</I>&gt;<i> more than one channel in the dialogue above then that's possibility #2.
</I>
In the context of the transaction taking place, we're using a single
channel.  We can make use of multiple channels, but not in this case,
and we're always using a single channel for a transaction (in the app
sense, not tx.* sense).

&gt;<i> We have recently found and fixed a bug which could cause messages
</I>&gt;<i> (internal to Rabbit, so they could be basic.publish, tx.commit or
</I>&gt;<i> various other things) to overtake each other in certain (we thought)
</I>&gt;<i> theoretical circumstances. So this could be possibility #3.
</I>&gt;<i>
</I>&gt;<i> *However*, queue.bind is not one of the messages that could be
</I>&gt;<i> overtaken. And I'm afraid binding to a queue is in fact a synchronous
</I>&gt;<i> operation anyway. So the explanation as presented can't be quite right.
</I>&gt;<i> And I can't immediately see any other way for something to get overtaken
</I>&gt;<i> and cause the results you're seeing, although it would help to see the
</I>&gt;<i> dialogue expanded to show the bit where serviceB replies.
</I>
ServiceB would call basic.publish and tx.commit only, having already
set up its outbound channel.

&gt;<i> But you might want to try compiling from hg (default branch) and see if
</I>&gt;<i> that fixes your problem.
</I>
Will give it a try, but our main cluster is now in production so we
will have to spin up our test hosts and an isolated test case.

Please let us know what you think of the synchronous vs. pipelining
question, i.e. how to know when we should buffer a request.

cheers,
Aaron

-- 
Aaron Westendorf
Senior Software Engineer
Agora Games
359 Broadway
Troy, NY 12180
Phone: 518.268.1000
<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">aaron at agoragames.com</A>
www.agoragames.com

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007392.html">[rabbitmq-discuss] lost message due to binding delay
</A></li>
	<LI>Next message: <A HREF="007395.html">[rabbitmq-discuss] lost message due to binding delay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7394">[ date ]</a>
              <a href="thread.html#7394">[ thread ]</a>
              <a href="subject.html#7394">[ subject ]</a>
              <a href="author.html#7394">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
