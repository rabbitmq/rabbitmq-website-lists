<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbit disk_mode branch eating up all RAM, including swap, dying
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20rabbit%20disk_mode%20branch%20eating%20up%20all%20RAM%2C%0A%20including%20swap%2C%20dying&In-Reply-To=dbd9700a0910040603y2c3392b3jd663843080daf0f3%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005019.html">
   <LINK REL="Next"  HREF="005034.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbit disk_mode branch eating up all RAM, including swap, dying</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20rabbit%20disk_mode%20branch%20eating%20up%20all%20RAM%2C%0A%20including%20swap%2C%20dying&In-Reply-To=dbd9700a0910040603y2c3392b3jd663843080daf0f3%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] rabbit disk_mode branch eating up all RAM, including swap, dying">matthew at lshift.net
       </A><BR>
    <I>Mon Oct  5 11:04:21 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005019.html">[rabbitmq-discuss] rabbit disk_mode branch eating up all RAM,	including swap, dying
</A></li>
        <LI>Next message: <A HREF="005034.html">[rabbitmq-discuss] rabbit disk_mode branch eating up all RAM,	including swap, dying
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5024">[ date ]</a>
              <a href="thread.html#5024">[ thread ]</a>
              <a href="subject.html#5024">[ subject ]</a>
              <a href="author.html#5024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Brian,

On Sun, Oct 04, 2009 at 09:03:28AM -0400, Brian Whitman wrote:
&gt;<i> Hi, we're using 184cb96f7846+ (bug20980) and our host alerted us that rabbit
</I>&gt;<i> was eating up all available swap on a 16GB real + 8GB swap machine.
</I>
20980 stopped getting development work some time ago. As per my recent
email to the list, development work is currently focussed on moving away
from using mnesia. I wouldn't really recommend using 20980 any more -
the branches that it grew into which then went through QA did catch some
bugs which will be present in 20980.

&gt;<i> 
</I>&gt;<i> &quot;&quot;&quot;
</I>&gt;<i> PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  SWAP COMMAND
</I>&gt;<i> 18445 rabbitmq  18   0 24.7g  14g 1696 S 1087.1 91.7   2268:18  10g beam.smp
</I>&gt;<i> 
</I>&gt;<i> In an effort to prevent kernel panic, we restarted the rabbitmq service,
</I>&gt;<i> freeing up a considerable amount of swap:
</I>&gt;<i> 
</I>&gt;<i> However, the rabbitmq server is not starting again as expected, due to the
</I>&gt;<i> following exception:
</I>&gt;<i> 
</I>&gt;<i> 2009-10-04 06:26:29.797201500 {&quot;init terminating in
</I>&gt;<i> do_boot&quot;,{{nocatch,{error,{cannot_start_application,rabbit,{{timeout_waiting_for_tables,[rabbit_disk_queue]},{rabbit,start,[normal,[]]}}}}},[{init,start_it,1},{init,start_em,1}]}}
</I>&gt;<i> &quot;&quot;&quot;
</I>
Hmm, interesting. Is this in a clustered setup, or unclustered?

&gt;<i> They had to delete the mnesia folder (losing all our disk-backed queues) and
</I>&gt;<i> restart\, now it's fine. I would guess that this breakage coincided with us
</I>&gt;<i> storing quite a large number of unacked messages in the queues (job
</I>&gt;<i> instructions for a very large batch)
</I>
How many messages did you have in there, and do you know the average
size?

&gt;<i> a) Would upgrading this branch fix this? We were avoiding doing so because
</I>&gt;<i> things were relatively stable.
</I>
The work in 20980 went onto other branches but has not gone onto default
yet because of issues we uncovered in the persister design. Thus the
default branch has the same persister as in v1.6. You would probably be
better off using branch bug21444, which has had the benefit of a lot of
QA attention and bug fixes. That said, all the usual warnings about
using unreleased code do apply.

&gt;<i> b) is there anything else I can look at to debug? The logs don't have
</I>&gt;<i> anything of importance.
</I>
Not really - the clustering code was wrong in 20980 for a long time, so
if you were in a clustered setup, I'd blame that - and the error that
you've got would support that too. However, if you just had billions of
messages in there, then even in a non clustered setup, I could believe
mnesia would be taking a long time to start up and that might cause the
above error.

Best wishes,

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005019.html">[rabbitmq-discuss] rabbit disk_mode branch eating up all RAM,	including swap, dying
</A></li>
	<LI>Next message: <A HREF="005034.html">[rabbitmq-discuss] rabbit disk_mode branch eating up all RAM,	including swap, dying
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5024">[ date ]</a>
              <a href="thread.html#5024">[ thread ]</a>
              <a href="subject.html#5024">[ subject ]</a>
              <a href="author.html#5024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
