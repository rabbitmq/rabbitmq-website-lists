<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ crashes hard when it runs out of	memory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20crashes%20hard%20when%20it%20runs%20out%20of%0A%09memory&In-Reply-To=4AE01D24.8020704%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005235.html">
   <LINK REL="Next"  HREF="005207.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of	memory</H1>
    <B>Stephen Day</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20crashes%20hard%20when%20it%20runs%20out%20of%0A%09memory&In-Reply-To=4AE01D24.8020704%40lshift.net"
       TITLE="[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of	memory">sjaday at gmail.com
       </A><BR>
    <I>Thu Oct 22 19:03:56 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005235.html">[rabbitmq-discuss] Java API V1.6.0 - Performance problem with basicConsume and dynamic bindings
</A></li>
        <LI>Next message: <A HREF="005207.html">[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of	memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5204">[ date ]</a>
              <a href="thread.html#5204">[ thread ]</a>
              <a href="subject.html#5204">[ subject ]</a>
              <a href="author.html#5204">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>From your suggestions, it looks like I was on the right track. Output is
</I>inline.

Moved to rabbitmq-discuss.

And again, your guidance is greatly appreciated.

-Stephen

On Thu, Oct 22, 2009 at 1:51 AM, Matthias Radestock &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt;wrote:

&gt;<i> Stephen,
</I>&gt;<i>
</I>&gt;<i> Stephen Day wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> After running for few days, limiting queue size on producer side (no
</I>&gt;&gt;<i> memory backpressure), I have noticed that RabbitMQ has restarted several
</I>&gt;&gt;<i> times due to out of memory errors. Currently, I have about 150,000
</I>&gt;&gt;<i> persistent messages being consumed by 16 clients with qos. Over about 2-6
</I>&gt;&gt;<i> hours, the RSS and VM size of the erlang process grows unbounded, without
</I>&gt;&gt;<i> the producers adding any messages to the queue (externally limited to
</I>&gt;&gt;<i> 100,000), and the erlang process crashes. I am running version 1.7.0.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Memory consumption can increase due to gc effects, but not without bounds.
</I>&gt;<i>
</I>&gt;<i> How many messages does rabbit think there are in the queues - check with
</I>&gt;<i> 'rabbitmqctl list_queues' - and how big are the messages?
</I>&gt;<i>
</I>
$ ~/rabbitmq/sbin/rabbitmqctl list_queues name messages
messages_unacknowledged consumers memory
Listing queues ...
&lt;redacted&gt;    0    0    0    2376
&lt;redacted&gt;    27    0    0    27572
&lt;redacted&gt;    0    0    1    2992
&lt;redacted&gt;    149917    16    16    71106232

The messages are no bigger than 512 bytes, but vary in size.


&gt;<i>
</I>&gt;<i> How large is the persister log?
</I>

$ du -b mnesia/rabbit/*
162    mnesia/rabbit/DECISION_TAB.LOG
98    mnesia/rabbit/LATEST.LOG
8    mnesia/rabbit/rabbit_config.DCD
995    mnesia/rabbit/rabbit_durable_exchange.DCD
606    mnesia/rabbit/rabbit_durable_queue.DCD
976    mnesia/rabbit/rabbit_durable_queue.DCL
1396    mnesia/rabbit/rabbit_durable_route.DCD
16720    mnesia/rabbit/rabbit_durable_route.DCL
82515919    mnesia/rabbit/rabbit_persister.LOG
82526910    mnesia/rabbit/rabbit_persister.LOG.previous
4    mnesia/rabbit/rabbit_serial
134    mnesia/rabbit/rabbit_user.DCD
192    mnesia/rabbit/rabbit_user_permission.DCD
133    mnesia/rabbit/rabbit_vhost.DCD
12383    mnesia/rabbit/schema.DAT


&gt;<i>
</I>&gt;<i>  Now, I was under the impression that this memory problem was due to the
</I>&gt;&gt;<i> number of messages being added, but this may not be the case. What
</I>&gt;&gt;<i> information do you need to troubleshoot this? Are there any erlang tools,
</I>&gt;&gt;<i> similar to valgrind, that can track down this memory usage?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> There are plenty of tools to figure out what's going on in a running Erlang
</I>&gt;<i> system. You need to know a fair bit about Erlang to use them though.
</I>&gt;<i>
</I>&gt;<i> As a starting point, remsh into rabbit with &quot;erl -sname sh -remsh rabbit@&lt;host&gt;&quot;
</I>&gt;<i> (you'll need to run this as the 'rabbitmq' user in a typical rabbit
</I>&gt;<i> installation) and on the prompt type
</I>&gt;<i>  memory().
</I>&gt;<i> which will tell you at a coarse-grain level where the memory has gone.
</I>&gt;<i>
</I>
Here is the memory() output:

(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vs-dfw-ctl11</A>)1&gt; memory().
[{total,1015558480},
 {processes,161498128},
 {processes_used,161494240},
 {system,854060352},
 {atom,516217},
 {atom_used,492146},
 {binary,778446312},
 {code,3860276},
 {ets,70066180}]

Right now, the system is using around 1GB of memory, mostly concentrated in
binary allocation. I was looking at this yesterday as well, and the process
memory hasn't changed much.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i> PS: could we move this discussion onto rabbitmq-discuss, please?
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20091022/eed2a2e9/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20091022/eed2a2e9/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005235.html">[rabbitmq-discuss] Java API V1.6.0 - Performance problem with basicConsume and dynamic bindings
</A></li>
	<LI>Next message: <A HREF="005207.html">[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of	memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5204">[ date ]</a>
              <a href="thread.html#5204">[ thread ]</a>
              <a href="subject.html#5204">[ subject ]</a>
              <a href="author.html#5204">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
