<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Orphaned channels after connection close in Rabbit 3.1.4
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Orphaned%20channels%20after%20connection%20close%20in%0A%20Rabbit%203.1.4&In-Reply-To=%3CCAFS6ge%3DKjm_5h5TmCLVaYvUNM6LdvJbwujXHNT%2BXMFWWuQ0CJQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029297.html">
   <LINK REL="Next"  HREF="029321.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Orphaned channels after connection close in Rabbit 3.1.4</H1>
    <B>Paul Bowsher</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Orphaned%20channels%20after%20connection%20close%20in%0A%20Rabbit%203.1.4&In-Reply-To=%3CCAFS6ge%3DKjm_5h5TmCLVaYvUNM6LdvJbwujXHNT%2BXMFWWuQ0CJQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Orphaned channels after connection close in Rabbit 3.1.4">paul.bowsher at gmail.com
       </A><BR>
    <I>Thu Aug 15 10:50:32 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029297.html">[rabbitmq-discuss] Orphaned channels after connection close in Rabbit 3.1.4
</A></li>
        <LI>Next message: <A HREF="029321.html">[rabbitmq-discuss] Orphaned channels after connection close in Rabbit 3.1.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29320">[ date ]</a>
              <a href="thread.html#29320">[ thread ]</a>
              <a href="subject.html#29320">[ subject ]</a>
              <a href="author.html#29320">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matthias,

Thanks for the reply. When you say resource alarms, do you mean on the
server or from the clients? We don't have any issues whatsoever there.
We've been running the same workload, and this issue only occurs since the
upgrade to 3.1.4.

We've performed some further experimentation since - we've configured
clients to only connect to node B. This has resolved the problem entirely.
The queues are still mirrored but we have no &quot;stuck&quot; connections. It seems
that we have a sick rabbit on node A. How can we help diagnose this?

Thanks,

Paul

Paul Bowsher


On Wed, Aug 14, 2013 at 10:23 PM, Matthias Radestock
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;wrote:

&gt;<i> Paul,
</I>&gt;<i>
</I>&gt;<i> On 14/08/13 10:41, Paul Bowsher wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> After the upgrade to RabbitMQ 3.1.4 we're seeing a large number of
</I>&gt;&gt;<i> linearly-increasing channels which seem to hang around after the
</I>&gt;&gt;<i> connection is closed.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This is very unlikely to be related to the upgrade...
</I>&gt;<i>
</I>&gt;<i>  - Initially, larger than expected consumer count on queue from our
</I>&gt;&gt;<i> monitoring
</I>&gt;&gt;<i> - Stopping all expected consumers on that channel removes the expected
</I>&gt;&gt;<i> number of consumers, leaving orphans (700+ at present)
</I>&gt;&gt;<i> - Each orphaned consumer's channel is reachable using Management tool
</I>&gt;&gt;<i> - Each connection for the channel is reachable, is in either a &quot;flow&quot; or
</I>&gt;&gt;<i> &quot;blocked&quot; state with zero data flow. Timeout is set to 600s (count
</I>&gt;&gt;<i> doesn't decrease after 10 minutes)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The above is all consistent with connections being blocked due to resource
</I>&gt;<i> alarms. Blocked connections do not get closed until they are unblocked.
</I>&gt;<i> Check the server logs for alarm warnings.
</I>&gt;<i>
</I>&gt;<i>  - Forcing a stuck connection closed through the management interface
</I>&gt;&gt;<i> results in a 500:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     The server encountered an error while processing this request:
</I>&gt;&gt;<i>     {exit,{normal,{gen_server,**call,
</I>&gt;&gt;<i>                                [&lt;0.16806.1347&gt;,
</I>&gt;&gt;<i>                                 {shutdown,&quot;Closed via management plugin&quot;},
</I>&gt;&gt;<i>                                 infinity]}},
</I>&gt;&gt;<i>            [{gen_server,call,3,[{file,&quot;**gen_server.erl&quot;},{line,188}]},
</I>&gt;&gt;<i>             {rabbit_mgmt_wm_connection,**delete_resource,2,[]},
</I>&gt;&gt;<i>             {webmachine_resource,resource_**call,3,[]},
</I>&gt;&gt;<i>             {webmachine_resource,do,3,[]},
</I>&gt;&gt;<i>             {webmachine_decision_core,**resource_call,1,[]},
</I>&gt;&gt;<i>             {webmachine_decision_core,**decision,1,[]},
</I>&gt;&gt;<i>             {webmachine_decision_core,**handle_request,2,[]},
</I>&gt;&gt;<i>             {rabbit_webmachine,'-makeloop/**1-fun-0-',2,[]}]}
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That looks like a bug. Alas I cannot see anything obviously wrong in the
</I>&gt;<i> code and I cannot reproduce it :( Is this easily reproducible for you?
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130815/1cea71c0/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130815/1cea71c0/attachment.htm</A>&gt;
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029297.html">[rabbitmq-discuss] Orphaned channels after connection close in Rabbit 3.1.4
</A></li>
	<LI>Next message: <A HREF="029321.html">[rabbitmq-discuss] Orphaned channels after connection close in Rabbit 3.1.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29320">[ date ]</a>
              <a href="thread.html#29320">[ thread ]</a>
              <a href="subject.html#29320">[ subject ]</a>
              <a href="author.html#29320">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
