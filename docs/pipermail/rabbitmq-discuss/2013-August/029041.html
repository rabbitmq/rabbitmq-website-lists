<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ Clustering with Federation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Clustering%20with%20Federation&In-Reply-To=%3C51FA84E1.4000408%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029040.html">
   <LINK REL="Next"  HREF="029043.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ Clustering with Federation</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Clustering%20with%20Federation&In-Reply-To=%3C51FA84E1.4000408%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ Clustering with Federation">simon at rabbitmq.com
       </A><BR>
    <I>Thu Aug  1 16:55:13 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029040.html">[rabbitmq-discuss] RabbitMQ Clustering with Federation
</A></li>
        <LI>Next message: <A HREF="029043.html">[rabbitmq-discuss] New install problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29041">[ date ]</a>
              <a href="thread.html#29041">[ thread ]</a>
              <a href="subject.html#29041">[ subject ]</a>
              <a href="author.html#29041">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>No, at the moment that's only for federation. This may change in future.

Cheers, Simon

On 01/08/2013 4:53PM, Robert Parker wrote:
&gt;<i> Ah, so is there a way to alleviate the need for both the publisher (in
</I>&gt;<i> our case, mass transit) or the consumer (a .net reporting app) to use
</I>&gt;<i> load balancer VIP for client connections to any cluster using a compound
</I>&gt;<i> connection string via the .NET API?  That is, is it possible to use
</I>&gt;<i> something similar to
</I>&gt;<i>   '{&quot;uri&quot;:[&quot;<A HREF="amqp://remote1-__node1&quot;,&quot;amqp://remote1-node2&quot;]}'">amqp://remote1-__node1&quot;,&quot;amqp://remote1-node2&quot;]}'</A> on the
</I>&gt;<i> client side for either publishing or consuming such that we don't need
</I>&gt;<i> an external load balancer at all to achieve high availability for BOTH
</I>&gt;<i> client connections and federation connections?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Robert
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Aug 1, 2013 at 10:34 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     On 31/07/2013 5:35PM, Robert Parker wrote:
</I>&gt;<i>
</I>&gt;<i>         I'm having some trouble getting the right architecture configured to
</I>&gt;<i>         support rabbitmq federation in a clustered high availability
</I>&gt;<i>         environment.  Our basic setup is four clusters of two nodes each
</I>&gt;<i>         which
</I>&gt;<i>         are separated by a WAN.
</I>&gt;<i>
</I>&gt;<i>         &quot;home&quot; is the &quot;home&quot; cluster and &quot;remote1&quot;, &quot;remote2&quot; and
</I>&gt;<i>         &quot;remote3&quot; are
</I>&gt;<i>         remote clusters.  There are a lot of queues being created and
</I>&gt;<i>         published
</I>&gt;<i>         to via the API identically on all clusters but I only want to
</I>&gt;<i>         federate
</I>&gt;<i>         ONE of the queues, which is called &quot;EventListener&quot; back to the
</I>&gt;<i>         &quot;home&quot;
</I>&gt;<i>         cluster from all the &quot;remote&quot; clusters.  I want messages
</I>&gt;<i>         published to
</I>&gt;<i>         this queue on each remote cluster to be federated to the home
</I>&gt;<i>         cluster to
</I>&gt;<i>         be consumed by a separate event listener service that only lives
</I>&gt;<i>         at the
</I>&gt;<i>         &quot;home&quot; site.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     Just to be clear: you are aware that (currently) it's only
</I>&gt;<i>     *exchanges* which can be federated, not queues?
</I>&gt;<i>
</I>&gt;<i>         Each cluster is configured with:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     &lt;snip&gt;
</I>&gt;<i>
</I>&gt;<i>         We have configured three hardware load balancer VIPs that load
</I>&gt;<i>         balance
</I>&gt;<i>         connections on port 5672 between both nodes in each cluster, and
</I>&gt;<i>         have
</I>&gt;<i>         configured federation upstreams to use these and also configured our
</I>&gt;<i>         application to use these VIPs for queue/exchange creation and for
</I>&gt;<i>         publishing messages.  Here's our federation config script thats
</I>&gt;<i>         run on
</I>&gt;<i>         node1 of the home cluster only:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     &lt;snip&gt;
</I>&gt;<i>
</I>&gt;<i>         However I am noticing that the &quot;rabbitmqctl eval
</I>&gt;<i>         'rabbit_federation_status:__status().&quot; command only shows federation
</I>&gt;<i>         config on node2 of the home cluster despite having been
</I>&gt;<i>         configured on node1:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     Federation works by establishing link(s) from the downstream to the
</I>&gt;<i>     upstream(s). You can define the upstreams on any node in the
</I>&gt;<i>     downstream cluster (the configuration is cluster-wide) and the
</I>&gt;<i>     cluster will arbitrarily start the link processes on any node (and
</I>&gt;<i>     will migrate them around the cluster if nodes go down).
</I>&gt;<i>
</I>&gt;<i>     *However*, rabbit_federation_status:__status() will only report
</I>&gt;<i>     links that are running on the local node. This is probably not well
</I>&gt;<i>     documented. Hmm. Let's fix that.
</I>&gt;<i>
</I>&gt;<i>     (The HTTP API exported by rabbitmq_federation_management will report
</I>&gt;<i>     links on all nodes.)
</I>&gt;<i>
</I>&gt;<i>     &lt;snip&gt;
</I>&gt;<i>
</I>&gt;<i>         And I'm noticing that messages published to the queues via the load
</I>&gt;<i>         balancer VIPs to the remote clusters are not showing up in the
</I>&gt;<i>         &quot;EventListener&quot; queue of the home cluster.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     Note that you have federated an exchange called &quot;EventListener&quot;, not
</I>&gt;<i>     a queue. So if you bind a queue to the exchange &quot;EventListener&quot; on
</I>&gt;<i>     home, and publish to the exchange &quot;EventListener&quot; on remote1/2/3
</I>&gt;<i>     then you should see messages turning up in the queue on home. Is
</I>&gt;<i>     that what you're doing?
</I>&gt;<i>
</I>&gt;<i>         Is this not the right way to set this up?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     It sounds like you're basically right, apart from the exchange vs
</I>&gt;<i>     queue thing.
</I>&gt;<i>
</I>&gt;<i>         Is it possible to configure
</I>&gt;<i>         this without using an external load balancer and still achieve high
</I>&gt;<i>         availability?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     Since 3.1.0, yes. You can specify multiple URIs in a single
</I>&gt;<i>     upstream, and federation will connect to a randomly chosen one (and
</I>&gt;<i>     keep retrying different ones if that one goes down). Use something like:
</I>&gt;<i>
</I>&gt;<i>     rabbitmqctl set_parameter federation-upstream remote1-upstream
</I>&gt;<i>     '{&quot;uri&quot;:[&quot;<A HREF="amqp://remote1-__node1&quot;,&quot;amqp://remote1-node2&quot;]__,&quot;expires&quot;:3600000}'">amqp://remote1-__node1&quot;,&quot;amqp://remote1-node2&quot;]__,&quot;expires&quot;:3600000}'</A>
</I>&gt;<i>
</I>&gt;<i>         If I federate to a single node of a cluster directly,
</I>&gt;<i>         what happens if that node goes down?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     If you only specify one URI, it will keep retrying until that node
</I>&gt;<i>     comes back up.
</I>&gt;<i>
</I>&gt;<i>         Do I have to configure redundant
</I>&gt;<i>         federation between every node of home cluster to every node of each
</I>&gt;<i>         remote cluster?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     No - since the config is shared across the cluster. So you can set
</I>&gt;<i>     up the upstreams on one node of the home cluster, pointing to all
</I>&gt;<i>     nodes of the remote clusters.
</I>&gt;<i>
</I>&gt;<i>         If I don't use a load balancer VIP to publish to from my
</I>&gt;<i>         application, if the single node of the cluster I've configured goes
</I>&gt;<i>         down, it wont help me that the other node is still available.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     Not sure what you mean here. Hopefully I've explained enough now.
</I>&gt;<i>
</I>&gt;<i>     Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>     --
</I>&gt;<i>     Simon MacMullen
</I>&gt;<i>     RabbitMQ, Pivotal
</I>&gt;<i>
</I>&gt;<i>
</I>
-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029040.html">[rabbitmq-discuss] RabbitMQ Clustering with Federation
</A></li>
	<LI>Next message: <A HREF="029043.html">[rabbitmq-discuss] New install problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29041">[ date ]</a>
              <a href="thread.html#29041">[ thread ]</a>
              <a href="subject.html#29041">[ subject ]</a>
              <a href="author.html#29041">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
