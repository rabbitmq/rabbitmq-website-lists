<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Fwd: Duplicated message and unknown delivery tag after ack
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fwd%3A%20Duplicated%20message%20and%20unknown%20delivery%20tag%0A%20after%20ack&In-Reply-To=%3CCAMsy_NiY4DqtpqcZ0GciDvL-yua%3DjdurJTeoBp6Do6M3qimVtw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029247.html">
   <LINK REL="Next"  HREF="029181.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Fwd: Duplicated message and unknown delivery tag after ack</H1>
    <B>Tim Robertson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fwd%3A%20Duplicated%20message%20and%20unknown%20delivery%20tag%0A%20after%20ack&In-Reply-To=%3CCAMsy_NiY4DqtpqcZ0GciDvL-yua%3DjdurJTeoBp6Do6M3qimVtw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Fwd: Duplicated message and unknown delivery tag after ack">timrobertson100 at gmail.com
       </A><BR>
    <I>Thu Aug  8 14:21:58 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029247.html">[rabbitmq-discuss] fail upgrade from 3.1.3 to 3.1.4
</A></li>
        <LI>Next message: <A HREF="029181.html">[rabbitmq-discuss] Duplicated message and unknown delivery tag after ack
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29179">[ date ]</a>
              <a href="thread.html#29179">[ thread ]</a>
              <a href="subject.html#29179">[ subject ]</a>
              <a href="author.html#29179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>[stupidly I replied only to Matthias without noticing]

Ok - attached a really quick hack which I believe shows 3.1.3 to behave as
expected with 1 production thread, and 10 consuming threads.  This is a
durable exchange and queue, and it is using explicit ack'ing.  It uses 1
connection for publishing, and 1 connection for all the consuming threads.
 Each consuming thread gets a channel.

If someone familiar with the Java API could cast an eye over that and
confirm that it is give or take the expected usage (I'm not closing
resources properly here), I'll then try and work out why I see rabbiteasy
does not operate the same.

Curiously, when I ran the rabbiteasy version through Tracer I got the
following:
<A HREF="http://pastebin.aquilenet.fr/?a91d27418ddaade5#8e6MBLhOR+ISSPEtg2QoR0iqURsGgBjBfCbH2dTaj9o=">http://pastebin.aquilenet.fr/?a91d27418ddaade5#8e6MBLhOR+ISSPEtg2QoR0iqURsGgBjBfCbH2dTaj9o=</A>
I figured I was using Tracer wrongly, but perhaps that is correct and
rabbiteasy does indeed do a reconnect and then does not recover connections
properly.  Still more to follow.


On Thu, Aug 8, 2013 at 3:14 PM, Matthias Radestock &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;wrote:

&gt;<i> Tim, please keep the list in the loop on your investigation.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 08/08/13 13:44, Tim Robertson wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Thanks Matthias,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm going to craft a vanilla consumer and try it.  I *don't think* this
</I>&gt;&gt;<i> is related to the connection retrying, as this happens consistently and
</I>&gt;&gt;<i> immediately when there is more than 1 thread registered with a channel.
</I>&gt;&gt;<i>   The first consumer ACKs, but I *think* rabbit redelivers it anyway -
</I>&gt;&gt;<i> more to follow on that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I only just started investigations, and came across this thread
</I>&gt;&gt;<i> immediately.  It is curious we're both using totally different libraries
</I>&gt;&gt;<i> (spring, rabbiteasy) and seeing the same behavior though.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Thu, Aug 8, 2013 at 12:47 PM, Matthias Radestock
</I>&gt;&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;**&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Tim,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     On 08/08/13 11:39, Tim Robertson wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Were there any further insights into this?
</I>&gt;&gt;<i>         I am seeing the same behavior on 3.1.3 on my mac (homebrew
</I>&gt;&gt;<i>         install) and
</I>&gt;&gt;<i>         using rabbiteasy (1.2.0) and amqp java libraries 3.1.3.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     rabbiteasy claims to provide &quot;managed consumers that recover from
</I>&gt;&gt;<i>     connection loss and re-attach to the broker&quot;. I strongly suspect
</I>&gt;&gt;<i>     that recovery logic is too naive, allowing acks for messages to be
</I>&gt;&gt;<i>     span channel recreation, which would result exactly in the error you
</I>&gt;&gt;<i>     are seeing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Regards,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Matthias.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130808/df4108fb/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130808/df4108fb/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: RabbitTest.java
Type: application/octet-stream
Size: 3575 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130808/df4108fb/attachment.obj">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130808/df4108fb/attachment.obj</A>&gt;
</PRE>







































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029247.html">[rabbitmq-discuss] fail upgrade from 3.1.3 to 3.1.4
</A></li>
	<LI>Next message: <A HREF="029181.html">[rabbitmq-discuss] Duplicated message and unknown delivery tag after ack
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29179">[ date ]</a>
              <a href="thread.html#29179">[ thread ]</a>
              <a href="subject.html#29179">[ subject ]</a>
              <a href="author.html#29179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
