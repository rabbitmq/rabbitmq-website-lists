<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] A weird case of &quot;PRECONDITION_FAILED - unknown	delivery tag&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20A%20weird%20case%20of%20%22PRECONDITION_FAILED%20-%20unknown%0A%09delivery%20tag%22&In-Reply-To=%3C14c94f91-d0b8-467a-9f03-c72b2e9ad7f5%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029733.html">
   <LINK REL="Next"  HREF="029653.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] A weird case of &quot;PRECONDITION_FAILED - unknown	delivery tag&quot;</H1>
    <B>Razvan Dinu</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20A%20weird%20case%20of%20%22PRECONDITION_FAILED%20-%20unknown%0A%09delivery%20tag%22&In-Reply-To=%3C14c94f91-d0b8-467a-9f03-c72b2e9ad7f5%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] A weird case of &quot;PRECONDITION_FAILED - unknown	delivery tag&quot;">drazvan at gmail.com
       </A><BR>
    <I>Wed Aug 28 13:30:32 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029733.html">[rabbitmq-discuss] RabbitMQ consumer rebind in .net
</A></li>
        <LI>Next message: <A HREF="029653.html">[rabbitmq-discuss] A weird case of &quot;PRECONDITION_FAILED - unknown delivery tag&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29651">[ date ]</a>
              <a href="thread.html#29651">[ thread ]</a>
              <a href="subject.html#29651">[ subject ]</a>
              <a href="author.html#29651">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello guys,

I've been using RabbitMQ for a while, but this time I have an error which I 
did not manage to track down:  &quot;PRECONDITION_FAILED - unknown delivery tag 
XXX&quot;  (where XXX varies).

Now, I've done my research and I know it's usually because of double 
ack-ing, ack-ing on wrong channels or ack-ing messages that should not be 
ack-ed. I've checked at least a dozen times, and it doesn't seem to be the 
case for me. 

I've simplified the scenario to the minimum required to reproduce the error 
(I'm running RabbitMQ 3.0.3 Erlang R15B01; the code is written in python 
using pika 0.9.10p0). 

I have one working agent which has two threads:
 - thread one that fetches tasks continuously and puts them in a list
 - a worker thread that continuously takes tasks from the list and performs 
them

See code here: <A HREF="http://pastebin.com/PG8quVSw">http://pastebin.com/PG8quVSw</A>

Here's what happens (see example output here: <A HREF="http://pastebin.com/6f1sWsYa">http://pastebin.com/6f1sWsYa</A> ): 
the agent starts by initializing, pre-fetches 10 tasks (the prefech_count 
is set to 10) and then tasks are executed one by one. We can see that as 
soon as one task is ACK-ed, a new one is fetched so that the prefetch queue 
is staying at 10 items. However, as we can see at line 52 in the example 
output, the error message (406, 'PRECONDITION_FAILED - unknown delivery tag 
12') is returned. The channel is closed, and when the next 10 tasks from 
the prefetch queue try to send the ACK they get the error that the channel 
is closed. The tasks are prefetched again on the new channel that was 
opened automatically and then everything continues fine till the end (there 
were 60 tasks in total in the queue). 

THE PROBLEM: why did ACK 12 failed?

I managed to reproduce this consistently, but always at at different 
message, sometimes 42, 34 etc. One weird thing is that the error about the 
unknown delivery tag is not returned on the call to basic_ack (line 13 in 
the code), but on the code that consumes the queue (line 45). My guess is 
that there's a race somewhere, but can't figure where. In pika maybe? If I 
uncomment lines 34 and 35 from the code, it happens a lot less, but it 
still happens 1-2 times on 1000 messages. I think it has something to do 
with ACK-ing from one thread using the same channel that is used for 
listening on another thread. But I see no other way of implementing this 
scenario, with an internal pre-fetch queue on the consumer side. And to 
answer the question, why do I need this, it's because I need the worker to 
be able to take a peak at some of the tasks in the queues.

Any ideas? 

Thanks,
Raz



-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130828/f8f0c91a/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130828/f8f0c91a/attachment.htm</A>&gt;
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029733.html">[rabbitmq-discuss] RabbitMQ consumer rebind in .net
</A></li>
	<LI>Next message: <A HREF="029653.html">[rabbitmq-discuss] A weird case of &quot;PRECONDITION_FAILED - unknown delivery tag&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29651">[ date ]</a>
              <a href="thread.html#29651">[ thread ]</a>
              <a href="subject.html#29651">[ subject ]</a>
              <a href="author.html#29651">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
