<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Duplicated message and unknown delivery tag after ack
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Duplicated%20message%20and%20unknown%20delivery%20tag%0A%20after%20ack&In-Reply-To=%3CCAMsy_NipHR%2BCtoxDag2_H7b8q6P1dZSXN4yE5vZ0UXcChEoytg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029179.html">
   <LINK REL="Next"  HREF="029182.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Duplicated message and unknown delivery tag after ack</H1>
    <B>Tim Robertson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Duplicated%20message%20and%20unknown%20delivery%20tag%0A%20after%20ack&In-Reply-To=%3CCAMsy_NipHR%2BCtoxDag2_H7b8q6P1dZSXN4yE5vZ0UXcChEoytg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Duplicated message and unknown delivery tag after ack">timrobertson100 at gmail.com
       </A><BR>
    <I>Thu Aug  8 15:27:26 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029179.html">[rabbitmq-discuss] Fwd: Duplicated message and unknown delivery tag after ack
</A></li>
        <LI>Next message: <A HREF="029182.html">[rabbitmq-discuss] Duplicated message and unknown delivery tag after ack
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29181">[ date ]</a>
              <a href="thread.html#29181">[ thread ]</a>
              <a href="subject.html#29181">[ subject ]</a>
              <a href="author.html#29181">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok, to update this list on my findings.  The issue is indeed isolated in
rabbiteasy, and how it incorrectly manages channels with multiple consuming
instances.  I'm going to log an issue there, and provide a small sample
showing the problem - it only happens when you register multiple listeners.
 The vanilla version attached early demonstrates that rabbitmq 3.1.3 server
and client libraries work as expected.  We're ripping out our rabbiteasy
dependency and reverting to vanilla API, which is actually easier to
understand in our system.

Sorry for the noise, and thanks Matthias for the quick answers



On Thu, Aug 8, 2013 at 3:21 PM, Tim Robertson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">timrobertson100 at gmail.com</A>&gt;wrote:

&gt;<i> [stupidly I replied only to Matthias without noticing]
</I>&gt;<i>
</I>&gt;<i> Ok - attached a really quick hack which I believe shows 3.1.3 to behave as
</I>&gt;<i> expected with 1 production thread, and 10 consuming threads.  This is a
</I>&gt;<i> durable exchange and queue, and it is using explicit ack'ing.  It uses 1
</I>&gt;<i> connection for publishing, and 1 connection for all the consuming threads.
</I>&gt;<i>  Each consuming thread gets a channel.
</I>&gt;<i>
</I>&gt;<i> If someone familiar with the Java API could cast an eye over that and
</I>&gt;<i> confirm that it is give or take the expected usage (I'm not closing
</I>&gt;<i> resources properly here), I'll then try and work out why I see rabbiteasy
</I>&gt;<i> does not operate the same.
</I>&gt;<i>
</I>&gt;<i> Curiously, when I ran the rabbiteasy version through Tracer I got the
</I>&gt;<i> following:
</I>&gt;<i> <A HREF="http://pastebin.aquilenet.fr/?a91d27418ddaade5#8e6MBLhOR+ISSPEtg2QoR0iqURsGgBjBfCbH2dTaj9o=">http://pastebin.aquilenet.fr/?a91d27418ddaade5#8e6MBLhOR+ISSPEtg2QoR0iqURsGgBjBfCbH2dTaj9o=</A>
</I>&gt;<i> I figured I was using Tracer wrongly, but perhaps that is correct and
</I>&gt;<i> rabbiteasy does indeed do a reconnect and then does not recover connections
</I>&gt;<i> properly.  Still more to follow.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Aug 8, 2013 at 3:14 PM, Matthias Radestock &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Tim, please keep the list in the loop on your investigation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 08/08/13 13:44, Tim Robertson wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks Matthias,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm going to craft a vanilla consumer and try it.  I *don't think* this
</I>&gt;&gt;&gt;<i> is related to the connection retrying, as this happens consistently and
</I>&gt;&gt;&gt;<i> immediately when there is more than 1 thread registered with a channel.
</I>&gt;&gt;&gt;<i>   The first consumer ACKs, but I *think* rabbit redelivers it anyway -
</I>&gt;&gt;&gt;<i> more to follow on that.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I only just started investigations, and came across this thread
</I>&gt;&gt;&gt;<i> immediately.  It is curious we're both using totally different libraries
</I>&gt;&gt;&gt;<i> (spring, rabbiteasy) and seeing the same behavior though.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Thu, Aug 8, 2013 at 12:47 PM, Matthias Radestock
</I>&gt;&gt;&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;**&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Tim,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     On 08/08/13 11:39, Tim Robertson wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         Were there any further insights into this?
</I>&gt;&gt;&gt;<i>         I am seeing the same behavior on 3.1.3 on my mac (homebrew
</I>&gt;&gt;&gt;<i>         install) and
</I>&gt;&gt;&gt;<i>         using rabbiteasy (1.2.0) and amqp java libraries 3.1.3.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     rabbiteasy claims to provide &quot;managed consumers that recover from
</I>&gt;&gt;&gt;<i>     connection loss and re-attach to the broker&quot;. I strongly suspect
</I>&gt;&gt;&gt;<i>     that recovery logic is too naive, allowing acks for messages to be
</I>&gt;&gt;&gt;<i>     span channel recreation, which would result exactly in the error you
</I>&gt;&gt;&gt;<i>     are seeing.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Regards,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Matthias.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130808/7c96194d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130808/7c96194d/attachment.htm</A>&gt;
</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029179.html">[rabbitmq-discuss] Fwd: Duplicated message and unknown delivery tag after ack
</A></li>
	<LI>Next message: <A HREF="029182.html">[rabbitmq-discuss] Duplicated message and unknown delivery tag after ack
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29181">[ date ]</a>
              <a href="thread.html#29181">[ thread ]</a>
              <a href="subject.html#29181">[ subject ]</a>
              <a href="author.html#29181">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
