<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Enabling publisher confirms damages performance by a factor of 10x
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Enabling%20publisher%20confirms%20damages%0A%20performance%20by%20a%20factor%20of%2010x&In-Reply-To=%3C52172890.9090401%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029419.html">
   <LINK REL="Next"  HREF="029622.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Enabling publisher confirms damages performance by a factor of 10x</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Enabling%20publisher%20confirms%20damages%0A%20performance%20by%20a%20factor%20of%2010x&In-Reply-To=%3C52172890.9090401%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Enabling publisher confirms damages performance by a factor of 10x">matthias at rabbitmq.com
       </A><BR>
    <I>Fri Aug 23 10:17:04 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029419.html">[rabbitmq-discuss] Enabling publisher confirms damages performance	by a factor of 10x
</A></li>
        <LI>Next message: <A HREF="029622.html">[rabbitmq-discuss] Enabling publisher confirms damages performance by a factor of 10x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29546">[ date ]</a>
              <a href="thread.html#29546">[ thread ]</a>
              <a href="subject.html#29546">[ subject ]</a>
              <a href="author.html#29546">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/08/13 10:35, ModronMaze wrote:
&gt;<i> I tried to use publisher confirms to ensure my messages are not lost, but
</I>&gt;<i> encountered a performance issue. My test case is as follows:
</I>&gt;<i>
</I>&gt;<i> 1. One publisher sends 200.000 messages in a loop and asynchronously marks
</I>&gt;<i> them as confirmed.
</I>&gt;<i> 2. One consumer reads messages from queue, executes some work (db access,
</I>&gt;<i> sends other messages etc)
</I>&gt;<i> 3. Prefetch is set to 512.
</I>&gt;<i> 4. Queue and messages are durable/persistent.
</I>&gt;<i> 5. I tried using versions 3.0.2, 3.1.4, 3.1.5
</I>&gt;<i>
</I>&gt;<i> Without using publisher confirms I publish at least *250 msg/s* (and ack
</I>&gt;<i> with the same speed). Queue contains only prefetched messages.
</I>&gt;<i>
</I>&gt;<i> When I enable confirms (separate channel and connection - only for sending
</I>&gt;<i> messages that require it) speed drops to *15-25 msg/s*. Using management API
</I>&gt;<i> I found out that publisher's connection is constantly blocked by flow
</I>&gt;<i> control.
</I>&gt;<i> I think it is strange, because all messages are consumed as soon as they
</I>&gt;<i> enter a queue.
</I>
The messages still need to be written to disk (modulo any internal 
optimisations) since the broker needs to take responsibility for them 
until they get acknowledged.

The performance you are seeing is what I'd expect when publishers wait 
for confirmation after every single message. But you say above that 
publishers mark messages as confirmed &quot;asynchronously&quot;, so presumably 
you are not doing that.

Here's a test using MulticastMain (which ships with the Java client), 
which I believe reproduces your test case exactly, except that the 
consumer is not doing any work and the messages are 1k in size (you 
didn't indicate how large the messages are, so I just guessed).

$ runjava.sh com.rabbitmq.examps.MulticastMain -f persistent -c 1000 -q 
512 -C 200000 -s 1024 -i 10
starting consumer #0
starting producer #0
...
time: 50.493s, sent: 1999 msg/s, confirmed: 2000 msg/s, nacked: 0 msg/s, 
received: 1546 msg/s, min/avg/max latency: 9165385/11000052/11717636 
microseconds
...
time: 70.532s, sent: 1954 msg/s, confirmed: 1979 msg/s, nacked: 0 msg/s, 
received: 1559 msg/s, min/avg/max latency: 13392164/15317946/16613307 
microseconds
...

As you can see, this results in a sending rate of about 2kHz and a 
receiving rate of about 1.5kHz.

Running the same test with &quot;synchronous&quot; confirm, i.e. waiting for a 
confirm after every message (&quot;-c 1&quot;), drops the rate to about 10Hz.


Regards,

Matthias.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029419.html">[rabbitmq-discuss] Enabling publisher confirms damages performance	by a factor of 10x
</A></li>
	<LI>Next message: <A HREF="029622.html">[rabbitmq-discuss] Enabling publisher confirms damages performance by a factor of 10x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29546">[ date ]</a>
              <a href="thread.html#29546">[ thread ]</a>
              <a href="subject.html#29546">[ subject ]</a>
              <a href="author.html#29546">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
