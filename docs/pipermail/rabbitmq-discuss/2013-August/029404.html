<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] High load average with rabbitmq-server 3.1.x
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20High%20load%20average%20with%20rabbitmq-server%203.1.x&In-Reply-To=%3C1376881132556-28899.post%40n5.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029403.html">
   <LINK REL="Next"  HREF="029406.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] High load average with rabbitmq-server 3.1.x</H1>
    <B>Dan_b</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20High%20load%20average%20with%20rabbitmq-server%203.1.x&In-Reply-To=%3C1376881132556-28899.post%40n5.nabble.com%3E"
       TITLE="[rabbitmq-discuss] High load average with rabbitmq-server 3.1.x">daniel.bason at telogis.com
       </A><BR>
    <I>Mon Aug 19 03:58:52 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029403.html">[rabbitmq-discuss] ANN Langohr documentation updates
</A></li>
        <LI>Next message: <A HREF="029406.html">[rabbitmq-discuss] High load average with rabbitmq-server 3.1.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29404">[ date ]</a>
              <a href="thread.html#29404">[ thread ]</a>
              <a href="subject.html#29404">[ subject ]</a>
              <a href="author.html#29404">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

We have recently upgraded from rabbitmq-server 2.6.1 to 3.1.x (we have one
cluster running 3.1.5 and one running 3.1.3).  On both servers we have seen
the load average increase significantly, with it peaking up to 2x the number
cores.  The CPU utilization and IO wait aren't affected and it seems to be
down to internal locks.

Status is as follows (this is off peak):
Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A> ...
[{pid,1535},
 {running_applications,
     [{rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;3.1.5&quot;},
      {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;3.1.5&quot;},
      {rabbit,&quot;RabbitMQ&quot;,&quot;3.1.5&quot;},
      {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.7&quot;},
      {rabbitmq_web_dispatch,&quot;RabbitMQ Web Dispatcher&quot;,&quot;3.1.5&quot;},
      {webmachine,&quot;webmachine&quot;,&quot;1.10.3-rmq3.1.5-gite9359c7&quot;},
      {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;2.7.0-rmq3.1.5-git680dba8&quot;},
      {xmerl,&quot;XML parser&quot;,&quot;1.2.10&quot;},
      {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.7.1&quot;},
      {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.5&quot;},
      {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;3.1.5&quot;},
      {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.10&quot;},
      {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.17.5&quot;},
      {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.14.5&quot;}]},
 {os,{unix,linux}},
 {erlang_version,
     &quot;Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:4:4] [rq:4]
[async-threads:30] [kernel-poll:true]\n&quot;},
 {memory,
     [{total,157967560},
      {connection_procs,27074824},
      {queue_procs,59850832},
      {plugins,675680},
      {other_proc,10585832},
      {mnesia,1378504},
      {mgmt_db,10234568},
      {msg_index,4895480},
      {other_ets,8947648},
      {binary,10826584},
      {code,17261222},
      {atom,1552881},
      {other_system,4683505}]},
 {vm_memory_high_watermark,0.6},
 {vm_memory_limit,6442450944},
 {disk_free_limit,1000000000},
 {disk_free,18919137280},
 {file_descriptors,
     [{total_limit,3996},
      {total_used,611},
      {sockets_limit,3594},
      {sockets_used,391}]},
 {processes,[{limit,1048576},{used,4727}]},
 {run_queue,0},
 {uptime,607}]
...done.

Running an strace on one of the beam.smp sub-processes produces the
following:
Process 1595 attached - interrupt to quit
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235505, NULL) = 0
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
write(27,
&quot;\0\0\0\0\0\3\324:\341\v\324\2345\204y\370\377c\23ry5\16\234\0\0\0\0\0\0\0\0&quot;...,
48) = 48
futex(0x182324a0, FUTEX_WAKE_PRIVATE, 1) = 1
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235507, NULL) = -1 EAGAIN
(Resource temporarily unavailable)
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
fsync(27)                               = 0
write(99,
&quot;\0\0\0\0\0\0\307\303c&gt;\254\336\2268x\346\36\206\235\300\243\317\331\255\0\0\0\0\0\0\0\0&quot;...,
48) = 48
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235509, NULL) = -1 EAGAIN
(Resource temporarily unavailable)
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
fsync(99)                               = 0
write(4, &quot;!&quot;, 1)                        = 1
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235511, NULL) = 0
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
write(27,
&quot;\0\0\0\0\0\3\324;I\236\257\221u\350\\\353\16\6\232\1XH\214D\0\0\0\0\0\0\0\0&quot;...,
48) = 48
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235513, NULL) = -1 EAGAIN
(Resource temporarily unavailable)
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
fsync(27)                               = 0
futex(0x182324a0, FUTEX_WAKE_PRIVATE, 1) = 1
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235515, NULL) = 0
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
write(27,
&quot;\0\0\0\0\0\3\324&lt;}\235\263^\350w!\306A\334y\270P\232\37F\0\0\0\0\0\0\0\0&quot;...,
48) = 48
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235517, NULL) = -1 EAGAIN
(Resource temporarily unavailable)
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
fsync(27)                               = 0
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235519, NULL) = 0
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
write(27,
&quot;\0\0\0\0\0\3\324=\226(\16\265\355\200\307\7J\34b\4\240\&quot;\355)\0\0\0\0\0\0\0\0&quot;...,
48) = 48
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235521, NULL) = -1 EAGAIN
(Resource temporarily unavailable)
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
fsync(27)                               = 0
write(56,
&quot;\0\0\0\0\0\0\3105X\22\252\\n\210\364&amp;\300\1\331M~\227D!\0\0\0\0\0\0\0\0&quot;...,
48) = 48
futex(0x18232420, FUTEX_WAKE_PRIVATE, 1) = 1
futex(0x2aaaab594524, FUTEX_WAIT_PRIVATE, 235523, NULL) = 0
futex(0x2aaaab5944f8, FUTEX_WAKE_PRIVATE, 1) = 0
fsync(56)                               = 0
futex(0x18232420, FUTEX_WAKE_PRIVATE, 1) = 1


Any ideas on what is causing the locks?  Is there any further information I
can provide?

Regards
Dan



--
View this message in context: <A HREF="http://rabbitmq.1065348.n5.nabble.com/High-load-average-with-rabbitmq-server-3-1-x-tp28899.html">http://rabbitmq.1065348.n5.nabble.com/High-load-average-with-rabbitmq-server-3-1-x-tp28899.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029403.html">[rabbitmq-discuss] ANN Langohr documentation updates
</A></li>
	<LI>Next message: <A HREF="029406.html">[rabbitmq-discuss] High load average with rabbitmq-server 3.1.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29404">[ date ]</a>
              <a href="thread.html#29404">[ thread ]</a>
              <a href="subject.html#29404">[ subject ]</a>
              <a href="author.html#29404">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
