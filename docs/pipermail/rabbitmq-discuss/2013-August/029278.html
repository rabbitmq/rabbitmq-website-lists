<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Orphaned channels after connection close in	Rabbit 3.1.4
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Orphaned%20channels%20after%20connection%20close%20in%0A%09Rabbit%203.1.4&In-Reply-To=%3Cf2d4d37c-efaa-4c5f-95c2-c8d893abaad6%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029279.html">
   <LINK REL="Next"  HREF="029280.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Orphaned channels after connection close in	Rabbit 3.1.4</H1>
    <B>Paul Bowsher</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Orphaned%20channels%20after%20connection%20close%20in%0A%09Rabbit%203.1.4&In-Reply-To=%3Cf2d4d37c-efaa-4c5f-95c2-c8d893abaad6%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Orphaned channels after connection close in	Rabbit 3.1.4">paul.bowsher at gmail.com
       </A><BR>
    <I>Wed Aug 14 10:41:13 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029279.html">[rabbitmq-discuss] Reg:Heartbeat Lost Error
</A></li>
        <LI>Next message: <A HREF="029280.html">[rabbitmq-discuss] Orphaned channels after connection close in	Rabbit 3.1.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29278">[ date ]</a>
              <a href="thread.html#29278">[ thread ]</a>
              <a href="subject.html#29278">[ subject ]</a>
              <a href="author.html#29278">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

After the upgrade to RabbitMQ 3.1.4 we're seeing a large number of 
linearly-increasing channels which seem to hang around after the connection 
is closed. This doesn't happen on every queue (even those processed by the 
same software), only on a particular queue. The orphaned channels leave 20 
messages (the prefetch count) unacked.

Symptoms:

- Initially, larger than expected consumer count on queue from our 
monitoring
- Stopping all expected consumers on that channel removes the expected 
number of consumers, leaving orphans (700+ at present)
- Each orphaned consumer's channel is reachable using Management tool
- Each connection for the channel is reachable, is in either a &quot;flow&quot; or 
&quot;blocked&quot; state with zero data flow. Timeout is set to 600s (count doesn't 
decrease after 10 minutes)
- Forcing a stuck connection closed through the management interface 
results in a 500:

&gt;<i> The server encountered an error while processing this request:
</I>&gt;<i> {exit,{normal,{gen_server,call,
</I>&gt;<i>                           [&lt;0.16806.1347&gt;,
</I>&gt;<i>                            {shutdown,&quot;Closed via management plugin&quot;},
</I>&gt;<i>                            infinity]}},
</I>&gt;<i>       [{gen_server,call,3,[{file,&quot;gen_server.erl&quot;},{line,188}]},
</I>&gt;<i>        {rabbit_mgmt_wm_connection,delete_resource,2,[]},
</I>&gt;<i>        {webmachine_resource,resource_call,3,[]},
</I>&gt;<i>        {webmachine_resource,do,3,[]},
</I>&gt;<i>        {webmachine_decision_core,resource_call,1,[]},
</I>&gt;<i>        {webmachine_decision_core,decision,1,[]},
</I>&gt;<i>        {webmachine_decision_core,handle_request,2,[]},
</I>&gt;<i>        {rabbit_webmachine,'-makeloop/1-fun-0-',2,[]}]}
</I>

- The connection closure does actually succeed, and the count drops. 
- Forcing a normal connection closed still works correctly.
- Doing a netstat on both the client and server shows that the port 
associated with the connection is indeed completely closed, and not in any 
sort of TIME_WAIT or FIN_WAIT state

This issue occurred over the weekend, but as it was unchecked it eventually 
exhausted the server of socket descriptors, and we had to restart RabbitMQ 
to recover. It's happened again over night. We can't see anything in our 
client or server logs that give any indication as to the cause of it. We 
upgraded from 3.1.0 so unfortunately are unable to determine which version 
is responsible for the bug, if indeed it is a bug.

If anyone has seen this behaviour or has any suggestions, please let us 
know. Also, if we can provide any debug data let us know.

Thanks,

Paul Bowsher
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130814/e9807b5e/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130814/e9807b5e/attachment.htm</A>&gt;
</PRE>












































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029279.html">[rabbitmq-discuss] Reg:Heartbeat Lost Error
</A></li>
	<LI>Next message: <A HREF="029280.html">[rabbitmq-discuss] Orphaned channels after connection close in	Rabbit 3.1.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29278">[ date ]</a>
              <a href="thread.html#29278">[ thread ]</a>
              <a href="subject.html#29278">[ subject ]</a>
              <a href="author.html#29278">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
