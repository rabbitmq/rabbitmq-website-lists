<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Delay between minority detected and stopped server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Delay%20between%20minority%20detected%20and%20stopped%0A%20server&In-Reply-To=%3C520A5494.7050409%40crosscan.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029260.html">
   <LINK REL="Next"  HREF="029295.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Delay between minority detected and stopped server</H1>
    <B>Malte Schirmacher</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Delay%20between%20minority%20detected%20and%20stopped%0A%20server&In-Reply-To=%3C520A5494.7050409%40crosscan.com%3E"
       TITLE="[rabbitmq-discuss] Delay between minority detected and stopped server">mas at crosscan.com
       </A><BR>
    <I>Tue Aug 13 16:45:24 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029260.html">[rabbitmq-discuss] Delay between minority detected and stopped server
</A></li>
        <LI>Next message: <A HREF="029295.html">[rabbitmq-discuss] Delay between minority detected and stopped server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29261">[ date ]</a>
              <a href="thread.html#29261">[ thread ]</a>
              <a href="subject.html#29261">[ subject ]</a>
              <a href="author.html#29261">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/08/13 16:20, Simon MacMullen wrote:
&gt;<i> Hi.
</I>
Hi Simon,

&gt;<i> It can happen when a node gets two nodedown notifications in rapid
</I>&gt;<i> succession, both of which push it into a minority.
</I>
Shouldn't this behavior be fixed quickly?
Suppose the publisher is running on the same machine as the broker and 
someone pulls the network-cable out of this box.
Then it is pushed into minority instantaneously but would possibly still 
accept messages via 127.0.0.1 leading to inconsistency between the 
mirrored queues what we tried to prevent by using pause_minority...

&gt;<i> I'm not able to say what happened to make it take that long to pause,
</I>&gt;<i> but be aware that the pause is (nearly) a complete shutdown so it's not
</I>&gt;<i> inconceivable it could take some time. Was there anything in the logs
</I>&gt;<i> between 13-Aug-2013::11:02:31 and 13-Aug-2013::11:03:46?
</I>
Nope, the log was complete.
While do not know a way ti reproduce this behavior it happend again this 
afternoon and i made sure i still could publish messages via 127.0.0.1 
as this log shows:

=WARNING REPORT==== 13-Aug-2013::13:37:20 ===
Cluster minority status detected - awaiting recovery

=ERROR REPORT==== 13-Aug-2013::13:37:20 ===
Error in process &lt;0.872.0&gt; on node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-test-1</A>' with exit 
value: 
{badarg,[{erlang,register,[rabbit_outside_app_process,&lt;0.872.0&gt;],[]},{rabbit_node_monitor,'-run_outside_applications/1-fun-0-',1,[{file,&quot;src/rabbit_node_monitor.erl&quot;},{line,391}]}]}


=INFO REPORT==== 13-Aug-2013::13:37:53 ===
accepting AMQP connection &lt;0.989.0&gt; (127.0.0.1:45364 -&gt; 127.0.0.1:5672)

=WARNING REPORT==== 13-Aug-2013::13:38:06 ===
closing AMQP connection &lt;0.989.0&gt; (127.0.0.1:45364 -&gt; 127.0.0.1:5672):
connection_closed_abruptly

=INFO REPORT==== 13-Aug-2013::13:38:38 ===
stopped STOMP TCP Listener on [::]:61613

=INFO REPORT==== 13-Aug-2013::13:38:38 ===
stopped TCP Listener on 127.0.0.1:5672

=INFO REPORT==== 13-Aug-2013::13:38:38 ===
stopped TCP Listener on 192.168.123.136:5672


Again this log is complete


&gt;<i> When you say &quot;the aforementioned bug&quot; which are you talking about?
</I>
I meant the bug fixed by the patch i linked:
<A HREF="http://hg.rabbitmq.com/rabbitmq-server/rev/be0b06386a8c">http://hg.rabbitmq.com/rabbitmq-server/rev/be0b06386a8c</A>
Its tag suggests it belongs to bug #25700


&gt;<i> Cheers, Simon
</I>
&gt;<i>
</I>&gt;<i> On 13/08/2013 10:29AM, Malte Schirmacher wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> we are using rabbitmq 3.1.4 with this bugfix [1] applied.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Playing around with the clustering features i came across the following
</I>&gt;&gt;<i> situation.
</I>&gt;&gt;<i> I killed 2 out of 3 machines from the cluster. As expected the remaining
</I>&gt;&gt;<i> machine detected its minority and due to the patch it stopped itself.
</I>&gt;&gt;<i> But there was a delay between the minority detection and stopping the
</I>&gt;&gt;<i> server as the following log entries show:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =WARNING REPORT==== 13-Aug-2013::11:02:31 ===
</I>&gt;&gt;<i> Cluster minority status detected - awaiting recovery
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =ERROR REPORT==== 13-Aug-2013::11:02:31 ===
</I>&gt;&gt;<i> Error in process&lt;0.2836.0&gt;  on node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-test-3</A>' with exit
</I>&gt;&gt;<i> value:
</I>&gt;&gt;<i> {badarg,[{erlang,register,[rabbit_outside_app_process,&lt;0.2836.0&gt;],[]},{rabbit_node_monitor,'-run_outside_applications/1-fun-0-',1,[{fil
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> e,&quot;src/rabbit_node_monitor.erl&quot;},{line,391}]}]}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =INFO REPORT==== 13-Aug-2013::11:03:46 ===
</I>&gt;&gt;<i> stopped STOMP TCP Listener on [::]:61613
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =INFO REPORT==== 13-Aug-2013::11:03:46 ===
</I>&gt;&gt;<i> stopped TCP Listener on [::]:5672
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yet i was unable to reproduce this situation again. But still i'm
</I>&gt;&gt;<i> worried as i kind of lost confidence in the clustering abilities of
</I>&gt;&gt;<i> rabbitmq due to the aforementioned bug (lost messages, lost queues, lost
</I>&gt;&gt;<i> HA-policies, you name it)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Anyone able to tell me what went wrong here?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks in advance
</I>&gt;&gt;<i>     malte
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [1] <A HREF="http://hg.rabbitmq.com/rabbitmq-server/rev/be0b06386a8c">http://hg.rabbitmq.com/rabbitmq-server/rev/be0b06386a8c</A>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Geschaeftsanschrift/Business Address: crosscan GmbH | Ruhrstra&#223;e 48 |
</I>&gt;&gt;<i> 58452 Witten | Germany
</I>&gt;&gt;<i> Support: +49.2302.28232-22 Phone: +49.2302.28232-00 Fax:
</I>&gt;&gt;<i> +49.2302.28232-09 Geschaeftsfuehrung/Management Board: Philip Lehmann,
</I>&gt;&gt;<i> Erwin Berg, Ulrich Kellner
</I>&gt;&gt;<i> Sitz Witten, Amtsgericht Bochum, HRB 8036/Registered Office Witten,
</I>&gt;&gt;<i> Commercial Register of the Bochum County Court, HRB 8036
</I>&gt;&gt;<i> UST-ID-Nr./VAT-IdNo.: DE234398770
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>
--
Geschaeftsanschrift/Business Address: crosscan GmbH | Ruhrstra&#223;e 48 | 58452 Witten | Germany
Support: +49.2302.28232-22 Phone: +49.2302.28232-00 Fax: +49.2302.28232-09 
Geschaeftsfuehrung/Management Board: Philip Lehmann, Erwin Berg, Ulrich Kellner
Sitz Witten, Amtsgericht Bochum, HRB 8036/Registered Office Witten, Commercial Register of the Bochum County Court, HRB 8036
UST-ID-Nr./VAT-IdNo.: DE234398770

</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029260.html">[rabbitmq-discuss] Delay between minority detected and stopped server
</A></li>
	<LI>Next message: <A HREF="029295.html">[rabbitmq-discuss] Delay between minority detected and stopped server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29261">[ date ]</a>
              <a href="thread.html#29261">[ thread ]</a>
              <a href="subject.html#29261">[ subject ]</a>
              <a href="author.html#29261">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
