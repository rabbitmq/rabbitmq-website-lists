<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Question on RabbitMQ and file I/O	characteristics
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Question%20on%20RabbitMQ%20and%20file%20I/O%0A%09characteristics&In-Reply-To=%3CCACLE7iyDFtqS7ZWUr5TNmU-Ou-fE7CUBru3owpekRtLYWk0U%3DA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029083.html">
   <LINK REL="Next"  HREF="029115.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Question on RabbitMQ and file I/O	characteristics</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Question%20on%20RabbitMQ%20and%20file%20I/O%0A%09characteristics&In-Reply-To=%3CCACLE7iyDFtqS7ZWUr5TNmU-Ou-fE7CUBru3owpekRtLYWk0U%3DA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Question on RabbitMQ and file I/O	characteristics">mpietrek at skytap.com
       </A><BR>
    <I>Mon Aug  5 18:11:37 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029083.html">[rabbitmq-discuss] Question on RabbitMQ and file I/O	characteristics
</A></li>
        <LI>Next message: <A HREF="029115.html">[rabbitmq-discuss] Question on RabbitMQ and file I/O	characteristics
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29087">[ date ]</a>
              <a href="thread.html#29087">[ thread ]</a>
              <a href="subject.html#29087">[ subject ]</a>
              <a href="author.html#29087">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the background Simon.

One statement caught my attention though:

&gt;<i> At 40 msg/s you are publishing slowly enough that RabbitMQ probably won't
</I>start to coalesce these events together.

In my original message I didn't lay out all my results - I was trying to
keep the question simple. That said, the 4 write/sec pattern held up at
higher rates. For instance, on a machine with a faster disk, the same test
could do 400 messages/sec, and per tools like sar, were seeing 1600 disk
writes/sec.

As you can imagine, at those I/O rater we're rapidly coming close to the
disk's ability to keep up, thus the question about the writes/message rates.

So with this additional context, any additional insight?

Thanks,

Matt


On Mon, Aug 5, 2013 at 2:59 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i> That filename is typical of those of a queue index journal. That's the
</I>&gt;<i> file that records the state of messages in the queue - when a message has
</I>&gt;<i> been published, when it's been confirmed (transactional publish is
</I>&gt;<i> internally implemented in terms of confirms), when it's been delivered, and
</I>&gt;<i> when it's been acknowledged (I assume you are using acks).
</I>&gt;<i>
</I>&gt;<i> So it is very possible to get four disk writes to the journal per message
</I>&gt;<i> for publish / confirm / deliver / ack.
</I>&gt;<i>
</I>&gt;<i> At 40 msg/s you are publishing slowly enough that RabbitMQ probably won't
</I>&gt;<i> start to coalesce these events together. So as you start to publish faster
</I>&gt;<i> you should start to see fewer writes per message - eventually you should
</I>&gt;<i> see many messages per write.
</I>&gt;<i>
</I>&gt;<i> Therefore I wouldn't try to scale the numbers you're seeing up to predict
</I>&gt;<i> anything - you're likely to be much better off running some benchmark with
</I>&gt;<i> MulticastMain or similar.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 03/08/2013 01:08, Matt Pietrek wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Just want to run this past the RabbitMQ devs and see if this jibes with
</I>&gt;&gt;<i> their expectations.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Our typical cluster runs RabbitMQ 3.02 on Ubuntu 10.04 on two nodes.
</I>&gt;&gt;<i> All queues are mirrored. All our channels are opened in transactional
</I>&gt;&gt;<i> mode. (We know, this causes things to go slower - That's OK with us, we
</I>&gt;&gt;<i> really want to avoid message loss.)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What I'm seeing is that for each message written to the broker, we see
</I>&gt;&gt;<i> approximately four disk writes. That is, if the broker is doing 40
</I>&gt;&gt;<i> messages/sec, we see ~160 disk writes. We're getting these number from
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is this about what should be expected when running this way?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If it helps, I dug in a bit more to see what the files were. The vast
</I>&gt;&gt;<i> majority of the activity seems to be to files like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> msg_store_persistent/743.rdq
</I>&gt;&gt;<i> queues/**E10F54B1OGM7M4LTRX5Z3L4K0/**journal.jif
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any insight would be very valuable for our planning processes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Matt
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ______________________________**_________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.</A>**rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130805/a359d1b1/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130805/a359d1b1/attachment.htm</A>&gt;
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029083.html">[rabbitmq-discuss] Question on RabbitMQ and file I/O	characteristics
</A></li>
	<LI>Next message: <A HREF="029115.html">[rabbitmq-discuss] Question on RabbitMQ and file I/O	characteristics
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29087">[ date ]</a>
              <a href="thread.html#29087">[ thread ]</a>
              <a href="subject.html#29087">[ subject ]</a>
              <a href="author.html#29087">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
