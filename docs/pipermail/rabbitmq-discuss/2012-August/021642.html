<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mnesia corrupting after node joining cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mnesia%20corrupting%20after%20node%20joining%20cluster&In-Reply-To=%3CC9A9D46BD1CE455E9DF136DB4308D59D%40lakehp165%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021641.html">
   <LINK REL="Next"  HREF="021643.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mnesia corrupting after node joining cluster</H1>
    <B>David Brown</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mnesia%20corrupting%20after%20node%20joining%20cluster&In-Reply-To=%3CC9A9D46BD1CE455E9DF136DB4308D59D%40lakehp165%3E"
       TITLE="[rabbitmq-discuss] Mnesia corrupting after node joining cluster">dbrown at prmllc.com
       </A><BR>
    <I>Wed Aug  1 18:20:44 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021641.html">[rabbitmq-discuss] after enable management, rabbitMQ cant work
</A></li>
        <LI>Next message: <A HREF="021643.html">[rabbitmq-discuss] Mnesia corrupting after node joining cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21642">[ date ]</a>
              <a href="thread.html#21642">[ thread ]</a>
              <a href="subject.html#21642">[ subject ]</a>
              <a href="author.html#21642">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Francesco,

has there been any work on this issue (i.e. errors when doing admin work on 
a cluster)?  I've got a tiny, two node development cluster.  Removing the 
ram node caused the remaining (disc) node to fail on startup with a mnesia 
related error when I restarted it.  Eventually, the remaining (disc) node 
started up, but it still thinks the other node is clustered with it.  I've 
tried everything to try and get this node to realize it is the only node 
left in the cluster, nothing works.  FWIW the removed node does realize it 
is no longer part of the two node cluster.

I was very careful in terms of following the exact steps in the 'Breaking up 
a cluster' section on the rabbitmq web site.  At this point, I'm a bit 
concerned about basing our production systems around rabbitmq (we're a small 
hedge fund) when it seems to fail on the simplest of tasks.  The only thing 
I can think of to solve this problem would be to reinstall rabbitmq on all 
nodes in the cluster (similar to what Eli had to do) which is from a 
production point of view unacceptible.

Well any help/insight woudl be greatly appreciated

Thanks in advance
David

----- Original Message ----- 
From: &quot;Francesco Mazzoli&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">francesco at rabbitmq.com</A>&gt;
To: &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
Sent: Tuesday, April 24, 2012 12:30 PM
Subject: Re: [rabbitmq-discuss] Mnesia corrupting after node joining cluster


&gt;<i> Hi Eli,
</I>&gt;<i>
</I>&gt;&gt;<i> That left the new node thinking it was not a member of the
</I>&gt;&gt;<i> cluster, but the existing cluster still thought it was a RAM node.
</I>&gt;<i>
</I>&gt;<i> Uhm, if you mean that the cluster still thought that the reseted node was 
</I>&gt;<i> still part of the cluster, than that is weird and shouldn't happen. Can 
</I>&gt;<i> you reproduce this?
</I>&gt;<i>
</I>&gt;<i> If you force_reseted the node, than that behavior is to be expected.
</I>&gt;<i>
</I>&gt;&gt;<i> We figured we could try taking down each node in the existing cluster
</I>&gt;&gt;<i> one at a time, reseting it, and having it rejoin the cluster, hoping
</I>&gt;&gt;<i> that it would clear whatever issue it had.  So long as we kept at least
</I>&gt;&gt;<i> one disk node in the existing cluster our state should be maintained
</I>&gt;&gt;<i> (mines any non-HA queues and messages in them).  Apparently we choose
</I>&gt;&gt;<i> the wrong node.  When we tried to have it rejoin the remaining node in
</I>&gt;&gt;<i> the existing cluster it failed.  It seems Mnesia on the remaining node
</I>&gt;&gt;<i> was corrupted somehow.
</I>&gt;<i>
</I>&gt;<i> If the cluster doesn't know that the other node left (which seems to be 
</I>&gt;<i> the case here) than it will try to sync its tables with the node it thinks 
</I>&gt;<i> is still in the cluster. However since the other node has been reset its 
</I>&gt;<i> tables will have different cookies and Mnesia will blow up. Posting the 
</I>&gt;<i> specific error would help in confirming that this was the problem.
</I>&gt;<i>
</I>&gt;&gt;<i> Can we please have a command that allows you to remove a node from a
</I>&gt;&gt;<i> cluster from a node other than the node you a trying to remove? Bring
</I>&gt;&gt;<i> back up a node just to remove it from the cluster is time consuming and
</I>&gt;&gt;<i> potentially error prone.
</I>&gt;<i>
</I>&gt;<i> This is definitely a feature we're planning to implement. In general we 
</I>&gt;<i> want to make clustering more user friendly, and part of the work will be 
</I>&gt;<i> more clustering rabbitmqctl commands (&quot;join_cluster&quot;, &quot;depart_cluster&quot;, 
</I>&gt;<i> etc.).
</I>&gt;<i>
</I>&gt;&gt;<i> Can we please have some tools that will analyze Mnesia on each node and
</I>&gt;&gt;<i> give us an idea of its health?  Whether its corrupted or somehow out of
</I>&gt;&gt;<i> sync with other nodes in the cluster.
</I>&gt;<i>
</I>&gt;<i> If I understood correctly in this case the problem wasn't corrupted Mnesia 
</I>&gt;<i> tables, but the cluster not being aware of which nodes were part of the 
</I>&gt;<i> cluster. What's definitely needed is better error reporting when this kind 
</I>&gt;<i> of things happen, since right now the Mnesia error are particularly ugly. 
</I>&gt;<i> Again, we're working on that.
</I>&gt;<i>
</I>&gt;<i> Francesco.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> 
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: MnesiaCore.zip
Type: application/x-zip-compressed
Size: 20702 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120801/caa18fc0/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120801/caa18fc0/attachment.bin</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021641.html">[rabbitmq-discuss] after enable management, rabbitMQ cant work
</A></li>
	<LI>Next message: <A HREF="021643.html">[rabbitmq-discuss] Mnesia corrupting after node joining cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21642">[ date ]</a>
              <a href="thread.html#21642">[ thread ]</a>
              <a href="subject.html#21642">[ subject ]</a>
              <a href="author.html#21642">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
