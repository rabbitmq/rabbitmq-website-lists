<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Excessive memory consumption of one server in cluster setup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Excessive%20memory%20consumption%20of%20one%20server%0A%20in%20cluster%20setup&In-Reply-To=%3CCAJ1JW0f0MWwfBaPXKX%2BsrNZ9CSfbxQmvkt78%2BasN0aV_QdA57g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022104.html">
   <LINK REL="Next"  HREF="022124.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Excessive memory consumption of one server in cluster setup</H1>
    <B>Matthias Reik</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Excessive%20memory%20consumption%20of%20one%20server%0A%20in%20cluster%20setup&In-Reply-To=%3CCAJ1JW0f0MWwfBaPXKX%2BsrNZ9CSfbxQmvkt78%2BasN0aV_QdA57g%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Excessive memory consumption of one server in cluster setup">matthias.reik at gmail.com
       </A><BR>
    <I>Mon Aug 27 10:26:19 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022104.html">[rabbitmq-discuss] Excessive memory consumption of one server in	cluster setup
</A></li>
        <LI>Next message: <A HREF="022124.html">[rabbitmq-discuss] Excessive memory consumption of one server in cluster setup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22123">[ date ]</a>
              <a href="thread.html#22123">[ thread ]</a>
              <a href="subject.html#22123">[ subject ]</a>
              <a href="author.html#22123">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I just upgraded to 2.8.6, and I see the same effect with the latest version
:<i>-(
</I>(not really unexpected, since nothing was fixed in that regard in 2.8.6).

Already after about 10 minutes server2 consumes 200% more memory than
server1,
even though all clients are connected to server1, and there are no queues
with TTL anymore.

(removing the other queues is unfortunately not possible, since it's a
production
server :-(, and I haven't seen this effect on any of our other
(development) servers)

Cheers
Matthias

On Fri, Aug 24, 2012 at 2:25 PM, Matthias Reik &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">maze at reik.se</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> 2 days ago I have upgraded our RabbitMQ cluster (2 machines running in HA
</I>&gt;<i> mode) from 2.8.1 to 2.8.5.
</I>&gt;<i> Mainly to get those OOD fixes in, since we experienced those exact issues.
</I>&gt;<i>
</I>&gt;<i> The upgrade went very smooth, but at some point one of the machines
</I>&gt;<i> (server2) started to allocate more
</I>&gt;<i> and more memory (even though all queues are more or less at 0 with almost
</I>&gt;<i> no outstanding acks)
</I>&gt;<i>
</I>&gt;<i> server 1 uses ~200Mb
</I>&gt;<i> server 2 (at the point where I took it down) used ~6Gb
</I>&gt;<i>
</I>&gt;<i> I run a rabbitmqctl report... but it didn't give me any insights
</I>&gt;<i> I run a rabbitmqctl eval 'erlang:memory().' but that didn't tell me too
</I>&gt;<i> much more (but I will attach that at the end)
</I>&gt;<i>
</I>&gt;<i> I found people with similar problems:
</I>&gt;<i> <A HREF="http://grokbase.com/t/**rabbitmq/rabbitmq-discuss/**">http://grokbase.com/t/**rabbitmq/rabbitmq-discuss/**</A>
</I>&gt;<i> 1223qcx3gg/rabbitmq-memory-**usage-in-two-node-cluster&lt;<A HREF="http://grokbase.com/t/rabbitmq/rabbitmq-discuss/1223qcx3gg/rabbitmq-memory-usage-in-two-node-cluster">http://grokbase.com/t/rabbitmq/rabbitmq-discuss/1223qcx3gg/rabbitmq-memory-usage-in-two-node-cluster</A>&gt;
</I>&gt;<i> but that's a while back so many things might have changed since then. Also
</I>&gt;<i> the memory difference was
</I>&gt;<i> rather minimal, whereas here the difference is _very_ significant,
</I>&gt;<i> especially since the node with less load
</I>&gt;<i> has the increased memory footprint.
</I>&gt;<i>
</I>&gt;<i> I can upgrade to 2.8.6 (unfortunately I upgraded just before it was
</I>&gt;<i> released :-(), but I only want to do that if
</I>&gt;<i> there is some hope that the problem is solved.
</I>&gt;<i> I can bring server2 back online and try to investigate what is consuming
</I>&gt;<i> that much memory, but my
</I>&gt;<i> RabbitMQ/Erlang knowledge is not good enough, therefore reaching out for
</I>&gt;<i> some help.
</I>&gt;<i>
</I>&gt;<i> So any help would be much appreciated.
</I>&gt;<i>
</I>&gt;<i> Thx
</I>&gt;<i> Matthias
</I>&gt;<i>
</I>&gt;<i> Our setup is something like the following:
</I>&gt;<i>       2 servers exclusively running RabbitMQ on CentOS 5.x (high watermark
</I>&gt;<i> ~22Gb),
</I>&gt;<i>             - both with web-console enabled
</I>&gt;<i>             - both defined as disk nodes
</I>&gt;<i>             - both running RabbitMQ 2.8.5 on Erlang R15B01 (after the
</I>&gt;<i> upgrade, Erlang was already at R15 before)
</I>&gt;<i>     10 queues configured with mirroring
</I>&gt;<i>       3 queues configured (without mirroring) only on server1 with a TTL
</I>&gt;<i>     Most consumers are connecting to server1, server2 only in case of
</I>&gt;<i> failover
</I>&gt;<i>
</I>&gt;<i> We get about 1k messages/sec (with peaks much higher than that) into the
</I>&gt;<i> system, and each message is
</I>&gt;<i> passed through several queues for processing.
</I>&gt;<i>
</I>&gt;<i> -bash-3.2$ sbin/rabbitmqctl eval 'erlang:memory().'
</I>&gt;<i> [{total,5445584424},
</I>&gt;<i>  {processes,2184155418},
</I>&gt;<i>  {processes_used,2184122352},
</I>&gt;<i>  {system,3261429006},
</I>&gt;<i>  {atom,703377},
</I>&gt;<i>  {atom_used,678425},
</I>&gt;<i>  {binary,3216386480},
</I>&gt;<i>  {code,17978535},
</I>&gt;<i>  {ets,4142048}]
</I>&gt;<i> ...done.
</I>&gt;<i> ______________________________**_________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.</A>**rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120827/2e741165/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120827/2e741165/attachment.htm</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022104.html">[rabbitmq-discuss] Excessive memory consumption of one server in	cluster setup
</A></li>
	<LI>Next message: <A HREF="022124.html">[rabbitmq-discuss] Excessive memory consumption of one server in cluster setup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22123">[ date ]</a>
              <a href="thread.html#22123">[ thread ]</a>
              <a href="subject.html#22123">[ subject ]</a>
              <a href="author.html#22123">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
