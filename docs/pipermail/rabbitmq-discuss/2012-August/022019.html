<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.Net%20RabbitMQ.Client%20Issue%3A%20Deadlock%20on%0A%09ConnectionShutdown&In-Reply-To=%3CCAAzMECnZXCsFFurezzxeLNkagz%2Bf9-_onNq1KX2Nd7eG5Zpc5Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022018.html">
   <LINK REL="Next"  HREF="022021.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown</H1>
    <B>Derek Greer</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.Net%20RabbitMQ.Client%20Issue%3A%20Deadlock%20on%0A%09ConnectionShutdown&In-Reply-To=%3CCAAzMECnZXCsFFurezzxeLNkagz%2Bf9-_onNq1KX2Nd7eG5Zpc5Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown">dbgreer at gmail.com
       </A><BR>
    <I>Tue Aug 21 16:38:36 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022018.html">[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
</A></li>
        <LI>Next message: <A HREF="022021.html">[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22019">[ date ]</a>
              <a href="thread.html#22019">[ thread ]</a>
              <a href="subject.html#22019">[ subject ]</a>
              <a href="author.html#22019">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm trying to deal with connection shutdown logic as an atomic operation.
 Here's the scenario I'm trying to implement:

   - An application has 25 subscriptions to different queues on different
   threads
   - The rabbitmq Windows service is restarted
   - The application detects a connection shutdown has occurred and
   performs the following actions:
      - re-establish the connection once available
      - refresh each subscription with the new connection


The problem with using ModelShutdown rather than ConnectionShutdown to
detect connectoin shutdowns (aside from the obvious reason) is that it
doesn't really allow a client to deal with connection shutdown logic
atomically.  Thinking through what I'd need to do to use ModelShutdown for
this scenario seems convoluted at best.  My particular design issues aside,
don't you agree that ConnectionShutdown should be the event you should
subscribe to when you want to know about connection shutdowns?

As far as the blocking, I'm perplexed as to why we wouldn't be seeing the
same results.  Obviously, having someone on your team be able to reproduce
the issue is key to getting it fixed.  To make sure we're actually using
the same bits, I've uploaded the project I'm testing with to
<A HREF="http://aspiringcraftsman.com/downloads/rabbitmq/.">http://aspiringcraftsman.com/downloads/rabbitmq/.</A>  If you wouldn't mind,
please try with this and see if you get the same results.  I'm assuming you
don't have the API installed into your GAC.


Derek

On Tue, Aug 21, 2012 at 9:38 AM, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:

&gt;<i> Hi Derek,
</I>&gt;<i>
</I>&gt;<i> On 21/08/12 15:10, Derek Greer wrote:
</I>&gt;<i> &gt; My apologizes, I should have included the version number.  I see this
</I>&gt;<i> &gt; behavior using version 2.8.4 from NuGet.  Perhaps you're testing with a
</I>&gt;<i> &gt; different version?
</I>&gt;<i>
</I>&gt;<i> I tested with the latest version, but there have been no changes in that
</I>&gt;<i> area since 2.8.4.
</I>&gt;<i>
</I>&gt;<i> &gt; That aside, there should never be a case when a client of the
</I>&gt;<i> &gt; .Net rabbitmq client should be able to call .Close() and cause the API
</I>&gt;<i> &gt; to block indefinitely.
</I>&gt;<i>
</I>&gt;<i> I'm not able to reproduce the deadlock, as I said, I see an exception
</I>&gt;<i> (see attached).
</I>&gt;<i>
</I>&gt;<i> &gt; I appreciate your pointing me to the use of the IModel.ModelShutdown.  I
</I>&gt;<i> &gt; would have thought that event would be raised any time the model was
</I>&gt;<i> &gt; closed rather than being raised exclusively due to a connection
</I>&gt;<i> &gt; shutdown.  I'll use that if I have to, but wouldn't you agree that
</I>&gt;<i> &gt; clients of the API should be able to subscribe to the
</I>&gt;<i> &gt; IConnection.ConnectionShutdown event to be alerted to connection
</I>&gt;<i> &gt; shutdowns?
</I>&gt;<i>
</I>&gt;<i> Yes, ModelShutdown is raised when the channel shuts down for any reason,
</I>&gt;<i> including due to a network interruption. Clients that need notification
</I>&gt;<i> of the network connection shutting down should subscribe to
</I>&gt;<i> ConnectionShutdown, as your example illustrates. The library also
</I>&gt;<i> includes an example (RabbitMQ.Client.Examples.ExceptionTest) that shows
</I>&gt;<i> how to go about this.
</I>&gt;<i>
</I>&gt;<i> What is the problem you are trying to solve that the alleged deadlock is
</I>&gt;<i> preventing you from solving? If the problem is to ensure that channels
</I>&gt;<i> are closed when connections shut down, then you don't need to do that,
</I>&gt;<i> since the library already takes care of it.
</I>&gt;<i>
</I>&gt;<i> -Emile
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
___________________________________________
Derek Greer
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dbgreer at gmail.com</A>     | @derekgreer &lt;<A HREF="http://twitter.com/derekgreer">http://twitter.com/derekgreer</A>&gt;
lostechies.com &lt;<A HREF="http://derekgreer.lostechies.com/">http://derekgreer.lostechies.com/</A>&gt; |
freshbrewedcode.com&lt;<A HREF="http://derekgreer.freshbrewedcode.com">http://derekgreer.freshbrewedcode.com</A>&gt;
 | aspiringcraftsman.com
___________________________________________
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120821/27c84c75/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120821/27c84c75/attachment.htm</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022018.html">[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
</A></li>
	<LI>Next message: <A HREF="022021.html">[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22019">[ date ]</a>
              <a href="thread.html#22019">[ thread ]</a>
              <a href="subject.html#22019">[ subject ]</a>
              <a href="author.html#22019">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
