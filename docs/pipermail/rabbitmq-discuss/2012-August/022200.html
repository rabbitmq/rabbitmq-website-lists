<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Help pinpointing an error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Help%20pinpointing%20an%20error&In-Reply-To=%3CE7A072CA-7E70-4BCF-86C3-88366D9C268D%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022198.html">
   <LINK REL="Next"  HREF="022201.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Help pinpointing an error</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Help%20pinpointing%20an%20error&In-Reply-To=%3CE7A072CA-7E70-4BCF-86C3-88366D9C268D%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Help pinpointing an error">tim at rabbitmq.com
       </A><BR>
    <I>Fri Aug 31 10:56:00 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022198.html">[rabbitmq-discuss] Help pinpointing an error
</A></li>
        <LI>Next message: <A HREF="022201.html">[rabbitmq-discuss] Help pinpointing an error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22200">[ date ]</a>
              <a href="thread.html#22200">[ thread ]</a>
              <a href="subject.html#22200">[ subject ]</a>
              <a href="author.html#22200">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

On 31 Aug 2012, at 10:35, Jaime Herazo B. wrote:

&gt;<i> Hi.
</I>&gt;<i> 
</I>&gt;<i> Today a rabbit instance went down. I restarted the service only to be
</I>&gt;<i> greeted by screams as apparently many messages were lost in the process
</I>&gt;<i> (as far as i understood, once queues were marked as &quot;Durable&quot; this
</I>&gt;<i> couldn't happen, but it happened).
</I>&gt;<i> 
</I>
This shouldn't happen, so let's try and figure out what went wrong.


&gt;<i> The &quot;Reason for termination&quot; was:
</I>&gt;<i> 
</I>&gt;<i> {{badmatch,[{file_summary,2064936,4810835,2064935,2064937,16780759,true,1}]},                                                                                                             
</I>&gt;<i> [
</I>&gt;<i>  {rabbit_msg_store,combine_files,3},
</I>&gt;<i>  {rabbit_msg_store_gc,attempt_action,3},
</I>&gt;<i>  {rabbit_msg_store_gc,handle_cast,2},
</I>&gt;<i>  {gen_server2,handle_msg,2},
</I>&gt;<i>  {proc_lib,wake_up,3}
</I>&gt;<i> ]
</I>&gt;<i> }
</I>&gt;<i> 
</I>
The rabbit_msg_store module handles persisting the contents (i.e., data) for durable queues on disk. The badmatch (which means we didn't see the data we expected to see when assigning something) occurs because the 'readers' field for the file_summary is expected to be 0, not 1. This routine is called when compacting the data (e.g., during a garbage collection-esque process) and is called when the message store is initialising, so my reading thus far is that we've somehow ended up with a process trying to read from the message store before it's properly initialised.

&gt;<i> I'm having trouble even identifying what does this mean, let alone
</I>&gt;<i> preventing it from happening again. It started just fine, so it was
</I>&gt;<i> probably a transient error, but the fact that it took with it all the
</I>&gt;<i> messages in the queue is troubling.
</I>&gt;<i> 
</I>
Indeed. We must stop this from happening.

&gt;<i> Can you please point me towards more resources to handle these kinds of
</I>&gt;<i> problems in the future that don't involve loss of data? What did i do
</I>&gt;<i> wrong?
</I>&gt;<i> 
</I>&gt;<i> Also, do you see a hint of what went wrong there, or do i need to give
</I>&gt;<i> more info for this?
</I>&gt;<i> 
</I>
Someone better versed in the mechanics of the message store may chime in with a good explanation, but for my part I'd like to understand a few more things:

1. how did your rabbit go down (crashed, accidentally restarted, etc)?
2. exactly what steps did you take to restart it
3. what kind of configuration do you have (is it clustered, any HA queues, etc)

And if you could please send over the logs and sasl-logs (stripped of any private data if needs be) that would be very helpful indeed.


</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022198.html">[rabbitmq-discuss] Help pinpointing an error
</A></li>
	<LI>Next message: <A HREF="022201.html">[rabbitmq-discuss] Help pinpointing an error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22200">[ date ]</a>
              <a href="thread.html#22200">[ thread ]</a>
              <a href="subject.html#22200">[ subject ]</a>
              <a href="author.html#22200">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
