<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Rabbitmq server crash.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rabbitmq%20server%20crash.&In-Reply-To=%3CDD6D95D3-B7C2-4B17-8288-D311A7AC786B%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022199.html">
   <LINK REL="Next"  HREF="022175.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Rabbitmq server crash.</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rabbitmq%20server%20crash.&In-Reply-To=%3CDD6D95D3-B7C2-4B17-8288-D311A7AC786B%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Rabbitmq server crash.">tim at rabbitmq.com
       </A><BR>
    <I>Fri Aug 31 15:50:30 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022199.html">[rabbitmq-discuss] Rabbitmq server crash.
</A></li>
        <LI>Next message: <A HREF="022175.html">[rabbitmq-discuss] Publisher Confirms stop occurring when Consumer is present and queue is large
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22213">[ date ]</a>
              <a href="thread.html#22213">[ thread ]</a>
              <a href="subject.html#22213">[ subject ]</a>
              <a href="author.html#22213">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

On further investigation, this error condition (verified by the presence of '{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mnesia_locker,rabbit at MyTimes160</A>,granted}' in the gm process mailbox) is indeed the result of a netsplit. In RabbitMQ, clustering (and by association, HA/mirror queues) are not partition tolerant, and therefore netsplits *will* cause errors like this to occur. If you cannot rely on the network links between your clustered nodes then you should consider another approach to distribution, such as federation.

For more details about this, see the distribution guide (<A HREF="http://www.rabbitmq.com/distributed.html">http://www.rabbitmq.com/distributed.html</A>) and in particular note these comments from the 'Summary' section:

Federation / Shovel	Clustering

Chooses Availability and Partition Tolerance from the CAP theorem.         	 Chooses Consistency and Availability from the CAP theorem.         

So if you want Consistency (guarantees) and Availability, you should go with clustering and HA, but if you want Availability *and* Partition tolerance, then Clustering/HA is not the right setup for you. Also if this is happening once a month, then I'd suggest looking at what the network admin team is doing around that time, to see if some kit (or software) is being changed, reconfigured and/or taken offline for maintenance during this time period.

Cheers,
Tim 

On 31 Aug 2012, at 10:46, Tim Watson wrote:

&gt;<i> Hi
</I>&gt;<i> 
</I>&gt;<i> On 29 Aug 2012, at 13:12, Pankaj Mishra wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> We experienced a strange problem with rabbitmq server running in cluster. Actually according to
</I>&gt;&gt;<i> Log file the master of the server crashed. Post that all my publishers continue to send message without
</I>&gt;&gt;<i> Throwing any exception but all those messages were dropped silently by rabbitmq server. Consumer were not able
</I>&gt;&gt;<i> To get any of those messages until we restarted the rabbitmq server again.
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> I have attached with this mail the server crash log for master as well as for slave.
</I>&gt;<i> 
</I>&gt;<i> According to the master log, the mnesia database has become inconsistent, which is not a good sign. It looks very much like a network partition has occurred here:
</I>&gt;<i> 
</I>&gt;<i> %% from master.log
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 7-Aug-2012::18:42:24 ===
</I>&gt;<i> rabbit on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes160</A> down
</I>&gt;<i> 
</I>&gt;<i> %% from slave.log
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 7-Aug-2012::18:42:25 ===
</I>&gt;<i> rabbit on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes159</A> down
</I>&gt;<i> 
</I>&gt;<i> According to the logs, both the master and the slave observed the other node disappear, which seems consistent with the network partition theory.
</I>&gt;<i> 
</I>&gt;<i> %% from master.log
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 7-Aug-2012::18:42:25 ===
</I>&gt;<i> Mirrored-queue (queue 'cms' in vhost '/'): Master &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes159.3.444.0</A>&gt; saw deaths of mirrors &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes160.2.595.0</A>&gt; 
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 7-Aug-2012::18:42:25 ===
</I>&gt;<i> Mirrored-queue (queue 'mytimes' in vhost '/'): Master &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes159.3.437.0</A>&gt; saw deaths of mirrors &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes160.2.591.0</A>&gt; 
</I>&gt;<i> 
</I>&gt;<i> %% from slave.log
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 7-Aug-2012::18:42:25 ===
</I>&gt;<i> Mirrored-queue (queue 'mytimes' in vhost '/'): Slave &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes160.2.591.0</A>&gt; saw deaths of mirrors &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes159.3.437.0</A>&gt; 
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 7-Aug-2012::18:42:25 ===
</I>&gt;<i> Mirrored-queue (queue 'cms' in vhost '/'): Slave &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes160.2.595.0</A>&gt; saw deaths of mirrors &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at MyTimes159.3.444.0</A>&gt; 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Rabbit is not partition tolerant, so I would expect things might go wrong under such circumstances, but I would not expect messages to be silently dropped. My reading of the logs so far is that when the partitioned database state is reached, a message is sent to the gm ring on the 'master' node (the {<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mnesia_locker,rabbit at MyTimes160</A>,granted} message) which isn't handled, thereby crashing the gm handling process. Once that is down, other things start to go wrong. The parent supervisor will have restarted the failed process to get things back into a consistent state, but it looks as though because mnesia has its knickers in a twist about the partitioned database, that the recovery can't take place properly.
</I>&gt;<i> 
</I>&gt;<i> We will look into this asap, but can you confirm that a net split did in fact take place around the time this problem started appearing?
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120831/6ee2a9a2/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120831/6ee2a9a2/attachment.htm</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022199.html">[rabbitmq-discuss] Rabbitmq server crash.
</A></li>
	<LI>Next message: <A HREF="022175.html">[rabbitmq-discuss] Publisher Confirms stop occurring when Consumer is present and queue is large
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22213">[ date ]</a>
              <a href="thread.html#22213">[ thread ]</a>
              <a href="subject.html#22213">[ subject ]</a>
              <a href="author.html#22213">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
