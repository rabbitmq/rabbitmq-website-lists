<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.Net%20RabbitMQ.Client%20Issue%3A%20Deadlock%20on%0A%09ConnectionShutdown&In-Reply-To=%3CCAAzMECkDMm0crNEX979%2BAvpbP0oJHM6BygNbUHpdfRGT2-ET1w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022012.html">
   <LINK REL="Next"  HREF="022018.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown</H1>
    <B>Derek Greer</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.Net%20RabbitMQ.Client%20Issue%3A%20Deadlock%20on%0A%09ConnectionShutdown&In-Reply-To=%3CCAAzMECkDMm0crNEX979%2BAvpbP0oJHM6BygNbUHpdfRGT2-ET1w%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown">dbgreer at gmail.com
       </A><BR>
    <I>Tue Aug 21 15:10:43 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022012.html">[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
</A></li>
        <LI>Next message: <A HREF="022018.html">[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22015">[ date ]</a>
              <a href="thread.html#22015">[ thread ]</a>
              <a href="subject.html#22015">[ subject ]</a>
              <a href="author.html#22015">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>My apologizes, I should have included the version number.  I see this
behavior using version 2.8.4 from NuGet.  Perhaps you're testing with a
different version?  The issue appears to be related to the use of the
BlockingCell class used as part of the ShutdownContinuation.

Concerning the example, you're correct that this example poses a race
condition and should be using a try/catch rather than checking for
IsOpen().  That aside, there should never be a case when a client of the
.Net rabbitmq client should be able to call .Close() and cause the API to
block indefinitely.

I appreciate your pointing me to the use of the IModel.ModelShutdown.  I
would have thought that event would be raised any time the model was closed
rather than being raised exclusively due to a connection shutdown.  I'll
use that if I have to, but wouldn't you agree that clients of the API
should be able to subscribe to the IConnection.ConnectionShutdown event to
be alerted to connection shutdowns?

On Tue, Aug 21, 2012 at 5:49 AM, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:

&gt;<i> Hi Derek,
</I>&gt;<i>
</I>&gt;<i> On 20/08/12 19:29, Derek Greer wrote:
</I>&gt;<i> &gt; There appears to be a deadlock if you attempt to dispose, close, or
</I>&gt;<i> &gt; abort a channel within the context of an IConnection.ConnectionShutdown
</I>&gt;<i> &gt; event.
</I>&gt;<i>
</I>&gt;<i> Instead of deadlock I get an IO exception. An attempt to close the
</I>&gt;<i> channel requires network access, but it is no longer possible for the
</I>&gt;<i> channel to communicate over the network.
</I>&gt;<i>
</I>&gt;<i> System.IO.IOException:
</I>&gt;<i>  Unable to write data to the transport connection:
</I>&gt;<i>  An existing connection was forcibly closed by the remote host.
</I>&gt;<i> System.Net.Sockets.SocketException:
</I>&gt;<i>  An existing connection was forcibly closed by the remote host
</I>&gt;<i>
</I>&gt;<i> &gt; if (channel != null &amp;&amp; channel.IsOpen)
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt; Console.WriteLine(&quot;Closing channel ...&quot;);
</I>&gt;<i> &gt; channel.Close(); // &lt;- Never returns
</I>&gt;<i> &gt; Console.WriteLine(&quot;Channel closed.&quot;);
</I>&gt;<i> &gt; }
</I>&gt;<i>
</I>&gt;<i> This code is flawed, because the state of the channel could change
</I>&gt;<i> between the query and the action. There is no need to explicitly shut
</I>&gt;<i> down the channel when the connection shuts down as this will be done by
</I>&gt;<i> the library. Parties can register their interest in channel shutdown
</I>&gt;<i> using IModel.ModelShutdown.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -Emile
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
___________________________________________
Derek Greer
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dbgreer at gmail.com</A>     | @derekgreer &lt;<A HREF="http://twitter.com/derekgreer">http://twitter.com/derekgreer</A>&gt;
lostechies.com &lt;<A HREF="http://derekgreer.lostechies.com/">http://derekgreer.lostechies.com/</A>&gt; |
freshbrewedcode.com&lt;<A HREF="http://derekgreer.freshbrewedcode.com">http://derekgreer.freshbrewedcode.com</A>&gt;
 | aspiringcraftsman.com
___________________________________________
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120821/8e679c41/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120821/8e679c41/attachment.htm</A>&gt;
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022012.html">[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
</A></li>
	<LI>Next message: <A HREF="022018.html">[rabbitmq-discuss] .Net RabbitMQ.Client Issue: Deadlock on	ConnectionShutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22015">[ date ]</a>
              <a href="thread.html#22015">[ thread ]</a>
              <a href="subject.html#22015">[ subject ]</a>
              <a href="author.html#22015">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
