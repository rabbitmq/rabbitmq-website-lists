<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] tx_commit() semantics with async connections	(e.g Pika SelectConnection)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20tx_commit%28%29%20semantics%20with%20async%20connections%0A%09%28e.g%20Pika%20SelectConnection%29&In-Reply-To=%3CCACLE7iy%3D_3LaW2Q6Eoy-c_PSy9kX03Cmidzmc_bK2930L%3DXt4Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021955.html">
   <LINK REL="Next"  HREF="021958.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] tx_commit() semantics with async connections	(e.g Pika SelectConnection)</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20tx_commit%28%29%20semantics%20with%20async%20connections%0A%09%28e.g%20Pika%20SelectConnection%29&In-Reply-To=%3CCACLE7iy%3D_3LaW2Q6Eoy-c_PSy9kX03Cmidzmc_bK2930L%3DXt4Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] tx_commit() semantics with async connections	(e.g Pika SelectConnection)">mpietrek at skytap.com
       </A><BR>
    <I>Fri Aug 17 20:13:07 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021955.html">[rabbitmq-discuss] Computer authentication/authorisation
</A></li>
        <LI>Next message: <A HREF="021958.html">[rabbitmq-discuss] tx_commit() semantics with async connections (e.g Pika SelectConnection)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21957">[ date ]</a>
              <a href="thread.html#21957">[ thread ]</a>
              <a href="subject.html#21957">[ subject ]</a>
              <a href="author.html#21957">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've been drilling into an issue for a few days where my Pika channel is
abruptly closed. I'm pretty sure I've found either:

   - A large gap in my understanding
   - A misuse of the Rabbit/Pika APIs
   - A serious bug in Pika.

My original understanding about transactions is that calling tx_select() is
a synchronous operation, and that when it returns, whatever actions you've
sent to the broker are committed.

However, in stepping through the Pika tx_commit() code, it seems like it
all it does is add the Tx.Commit message to an outgoing buffer, and that
the tx_commit() call returns without anything actually sent to the broker.
(I've set breakpoints in the debugger at strategic points to verify this.)

In my message handler, I'm writing a reply to the incoming message, using
the same channel. What I'm seeing (verified via WireShark) is that the
Tx.Commit message is followed by some number of Basic.Publish,
Content-Header, and Content-Body records corresponding to my reply message
writes. This violates the AMQP standard, which says that nothing should be
sent to the broker after sending a Tx.Commit and before receiving a
Tx.Commit-Ok reply. (If it helps understanding, my incoming message queue
has a few messages in it already, so I see a series of incoming messages
immediately after starting.)

I see that the tx_commit() method takes a callback method, but if I were to
simply block in my message handler, waiting for the callback to be invoked,
I'd deadlock because Pika's buffer processing code doesn't get a chance to
run.
So given the above, is it me? Is it Pika?

My code looks like this:

def echo_on_connected(connection):
    &quot;&quot;&quot;Called when we are fully connected to RabbitMQ&quot;&quot;&quot;
    # Open a channel
    connection.channel(echo_on_channel_open)

# Step #3
def echo_on_channel_open(channel):
    channel.queue_declare(queue=echo_queue_name, durable=True,
arguments={&quot;x-ha-policy&quot;: &quot;all&quot;})
    channel.tx_select()
    channel.basic_consume(echo_handle_delivery, queue=echo_queue_name)

def echo_handle_delivery(channel, method, header, body):
    print &quot;Received message %s&quot; % (body)

    # Write a reply message on the same channel
    channel.basic_publish(exchange='',
        routing_key='reply_queue',
        body=&quot;replying to %s&quot; % (body),
        properties=BasicProperties(delivery_mode=2))

    # Ack the incoming message, then force the write to be flushed.
    channel.basic_ack(delivery_tag=method.delivery_tag)
    channel.tx_commit()

def echo_thread():
    connection_parameters = ConnectionParameters(host=broker_host)
    echo_connection = SelectConnection(connection_parameters,
echo_on_connected)
    echo_connection.ioloop.start()
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120817/dc5e34c6/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120817/dc5e34c6/attachment.htm</A>&gt;
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021955.html">[rabbitmq-discuss] Computer authentication/authorisation
</A></li>
	<LI>Next message: <A HREF="021958.html">[rabbitmq-discuss] tx_commit() semantics with async connections (e.g Pika SelectConnection)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21957">[ date ]</a>
              <a href="thread.html#21957">[ thread ]</a>
              <a href="subject.html#21957">[ subject ]</a>
              <a href="author.html#21957">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
