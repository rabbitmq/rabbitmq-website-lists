<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Queue disappears during high volume federation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20disappears%20during%20high%20volume%20federation&In-Reply-To=%3CCACLE7iwUNu37g-7hTL-OY3-L1WK-7zrKnZK0H6XvhJvn1C6ixA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021855.html">
   <LINK REL="Next"  HREF="021866.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Queue disappears during high volume federation</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20disappears%20during%20high%20volume%20federation&In-Reply-To=%3CCACLE7iwUNu37g-7hTL-OY3-L1WK-7zrKnZK0H6XvhJvn1C6ixA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Queue disappears during high volume federation">mpietrek at skytap.com
       </A><BR>
    <I>Tue Aug 14 01:25:42 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021855.html">[rabbitmq-discuss] How to determine originator of a message?
</A></li>
        <LI>Next message: <A HREF="021866.html">[rabbitmq-discuss] Queue disappears during high volume	federation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21840">[ date ]</a>
              <a href="thread.html#21840">[ thread ]</a>
              <a href="subject.html#21840">[ subject ]</a>
              <a href="author.html#21840">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm hitting an issue where a queue disappears from underneath me in a high
volume federated scenario.

Background: I'm on RabbitMQ 2.8.5 on top of Ubuntu 10.04.

I have three brokers bi-directionally federated similarly to the &quot;Small
complete Graph&quot; example in <A HREF="http://www.rabbitmq.com/federation.html.">http://www.rabbitmq.com/federation.html.</A> My
exchange is called &quot;Skytap&quot;, and is a topic exchange. One of the routing
key 'words' directs messages to the appropriate broker.

In my example, I have a single master sending &quot;requests&quot; to two slaves
which reply back to the master, simulating an RPC scenario. A client app on
the 'master' broker reads from an exclusive queue called 'master&quot;, while
client apps on the slave brokers read from an exclusive queue called
&quot;slave'.

In the low volume case, everything works as expected: A steady stream of
request messages seen on the slaves and a steady stream of reply messages
seen on the master.

However, if I write &quot;request&quot; messages as fast as possible, in short order
I see the 'master' queue disappear. (I know this because I have mnesia
logging turned on.)

Here's the mnesia trace from the master client app startup:

--------
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16820,&lt;0.154.0&gt;} on record:
    {rabbit_queue,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                      false,false,&lt;0.3392.0&gt;,[],&lt;0.3398.0&gt;,[],undefined}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16820,&lt;0.154.0&gt;} on record:
    {rabbit_route,{binding,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&gt;&gt;},
                               &lt;&lt;&quot;master&quot;&gt;&gt;,
                               {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                               []},
                      const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16820,&lt;0.154.0&gt;} on record:
    {rabbit_reverse_route,
            {reverse_binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                &lt;&lt;&quot;master&quot;&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&gt;&gt;},
                []},
            const}

Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16821,&lt;0.153.0&gt;} on record:
    {rabbit_topic_trie_node,
            {trie_node,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},

&lt;&lt;167,162,233,102,38,77,235,139,202,148,84,98,202,70,145,209&gt;&gt;},
            0,3}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16821,&lt;0.153.0&gt;} on record:
    {rabbit_exchange_serial,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},16}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16821,&lt;0.153.0&gt;} on record:
    {rabbit_reverse_route,
            {reverse_binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                &lt;&lt;&quot;master.mgt&quot;&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},
                []},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16821,&lt;0.153.0&gt;} on record:
    {rabbit_topic_trie_binding,
            {trie_binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},

&lt;&lt;167,162,233,102,38,77,235,139,202,148,84,98,202,70,145,209&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;}},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16821,&lt;0.153.0&gt;} on record:
    {rabbit_route,{binding,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},
                               &lt;&lt;&quot;master.mgt&quot;&gt;&gt;,
                               {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                               []},
                      const}
--------


And then some time later, after a bunch of successful requests/replies, I
get this:

--------
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16822,&lt;0.154.0&gt;} on record:
    {rabbit_topic_trie_node,
            {trie_node,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},

&lt;&lt;167,162,233,102,38,77,235,139,202,148,84,98,202,70,145,209&gt;&gt;},
            0,2}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_semi_durable_route,
            {binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&gt;&gt;},
                &lt;&lt;&quot;master&quot;&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                []},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): write performed by {tid,16822,&lt;0.154.0&gt;} on record:
    {rabbit_exchange_serial,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},17}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete performed by {tid,16822,&lt;0.154.0&gt;} on record:
    {rabbit_queue,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;}}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_reverse_route,
            {reverse_binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                &lt;&lt;&quot;master.mgt&quot;&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},
                []},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_topic_trie_binding,
            {trie_binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},

&lt;&lt;167,162,233,102,38,77,235,139,202,148,84,98,202,70,145,209&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;}},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_semi_durable_route,
            {binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},
                &lt;&lt;&quot;master.mgt&quot;&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                []},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_route,{binding,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&gt;&gt;},
                               &lt;&lt;&quot;master&quot;&gt;&gt;,
                               {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                               []},
                      const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_route,{binding,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},
                               &lt;&lt;&quot;master.mgt&quot;&gt;&gt;,
                               {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                               []},
                      const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_reverse_route,
            {reverse_binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                &lt;&lt;&quot;master&quot;&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&gt;&gt;},
                []},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_durable_route,
            {binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;skytap&quot;&gt;&gt;},
                &lt;&lt;&quot;master.mgt&quot;&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                []},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete_object performed by {tid,16822,&lt;0.154.0&gt;} on
record:
    {rabbit_durable_route,
            {binding,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&gt;&gt;},
                &lt;&lt;&quot;master&quot;&gt;&gt;,
                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;},
                []},
            const}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>): delete performed by {tid,16822,&lt;0.154.0&gt;} on record:
    {rabbit_durable_queue,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;master&quot;&gt;&gt;}}
--------

The <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1.log</A> file shows nothing of any interest. Just the expected
AMQP connection accepting/closing.

Anything else useful I can provide?

Matt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120813/bf2e6449/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120813/bf2e6449/attachment.htm</A>&gt;
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021855.html">[rabbitmq-discuss] How to determine originator of a message?
</A></li>
	<LI>Next message: <A HREF="021866.html">[rabbitmq-discuss] Queue disappears during high volume	federation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21840">[ date ]</a>
              <a href="thread.html#21840">[ thread ]</a>
              <a href="subject.html#21840">[ subject ]</a>
              <a href="author.html#21840">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
