<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] TCP/SSL Listeners stuck, not responding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20TCP/SSL%20Listeners%20stuck%2C%20not%20responding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005659.html">
   <LINK REL="Next"  HREF="005665.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] TCP/SSL Listeners stuck, not responding</H1>
    <B>Mark Steele</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20TCP/SSL%20Listeners%20stuck%2C%20not%20responding&In-Reply-To="
       TITLE="[rabbitmq-discuss] TCP/SSL Listeners stuck, not responding">msteele at beringmedia.com
       </A><BR>
    <I>Tue Dec 15 16:38:22 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005659.html">[rabbitmq-discuss] Cluster failover behaviour
</A></li>
        <LI>Next message: <A HREF="005665.html">[rabbitmq-discuss] TCP/SSL Listeners stuck, not responding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5663">[ date ]</a>
              <a href="thread.html#5663">[ thread ]</a>
              <a href="subject.html#5663">[ subject ]</a>
              <a href="author.html#5663">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi folks,

I'm trying to troubleshoot an issue I'm having. For unknown reasons
after a certain amount of time the SSL listener just seems to stop
working. The logs have:

=ERROR REPORT==== 15-Dec-2009::09:31:00 ===
Error in process &lt;0.55.0&gt; on node '<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at d1750-1</A>' with exit value:
{{badmatch,{error,system_limit}},[{cpu_sup,get_uint32_measurement,2},{cpu_sup,measurement_server_loop,1}]}

=INFO REPORT==== 15-Dec-2009::09:31:00 ===
closing TCP connection &lt;0.19037.10&gt; from 1.2.3.4:44437

=INFO REPORT==== 15-Dec-2009::09:31:00 ===
closing TCP connection &lt;0.18940.10&gt; from 1.2.3.4:44433

=INFO REPORT==== 15-Dec-2009::09:31:00 ===
closing TCP connection &lt;0.18962.10&gt; from 1.2.3.4:44434

=INFO REPORT==== 15-Dec-2009::09:31:00 ===
closing TCP connection &lt;0.19156.10&gt; from 1.2.3.4:44442

=INFO REPORT==== 15-Dec-2009::09:31:00 ===
closing TCP connection &lt;0.19178.10&gt; from 1.2.3.4:44443

=INFO REPORT==== 15-Dec-2009::09:31:00 ===
closing TCP connection &lt;0.19059.10&gt; from 1.2.3.4:44438

=INFO REPORT==== 15-Dec-2009::09:31:00 ===
closing TCP connection &lt;0.19081.10&gt; from 1.2.3.4:44439

=INFO REPORT==== 15-Dec-2009::09:31:00 ===
closing TCP connection &lt;0.19245.10&gt; from 1.2.3.4:44446
&lt;snip&gt;

# cat /etc/rabbitmq/rabbitmq.conf
SERVER_START_ARGS='-rabbit ssl_listeners [{&quot;2.3.4.5&quot;,9000}] -rabbit
ssl_options [{cacertfile,&quot;/etc/rabbitmq/ca.crt&quot;},{certfile,&quot;/etc/rabbitmq/cert.crt&quot;},{keyfile,&quot;/etc/rabbitmq/cert.key&quot;},{fail_if_no_peer_cert,true}]'
NODE_IP_ADDRESS=127.0.0.1
CONSOLE_LOG=reuse

# netstat -nlp
Proto Recv-Q Send-Q Local Address &#160; &#160; &#160; &#160; &#160; Foreign Address
State &#160; &#160; &#160; PID/Program name
tcp &#160; &#160; &#160; &#160;3 &#160; &#160; &#160;0 2.3.4.5:9000 &#160; &#160; &#160; 0.0.0.0:* &#160; &#160; &#160; &#160; &#160; &#160; &#160; LISTEN
 &#160; &#160;7943/beam.smp
tcp&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160; 0 127.0.0.1:5672&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0.0.0:*
LISTEN&#160;&#160;&#160;&#160;&#160; 7943/beam.smp
tcp&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160; 0 0.0.0.0:54160&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0.0.0:*
LISTEN&#160;&#160;&#160;&#160;&#160; 7943/beam.smp
tcp&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160; 0 0.0.0.0:4369&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0.0.0:*
LISTEN&#160;&#160;&#160;&#160;&#160; 11107/epmd
&lt;snip&gt;

Looking at what's going on with strace doesn't seem to help either:

# strace -p 7943
Process 7943 attached - interrupt to quit
select(0, NULL, NULL, NULL, NULL
&lt;no more output, stuck here&gt;

# tcpdump 'tcp src port 9000 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) -
((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)' -A -s 0 -vv -i eth1
tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size
65535 bytes
^C &lt;no output...&gt;
0 packets captured
0 packets received by filter
0 packets dropped by kernel


# tcpdump 'tcp dst port 9000 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) -
((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)' -A -s 0 -vv -i eth1
tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size
65535 bytes
11:06:54.496422 IP (tos 0x0, ttl 50, id 61746, offset 0, flags [DF],
proto TCP (6), length 113)
    68.230.240.91.58871 &gt; 208.94.50.28.9000: Flags [P.], cksum 0x4897
(correct), seq 620713031:620713092, ack 967624400, win 114, options
[nop,nop,TS val 69409028 ecr 404972440], length 61
&lt;snip, lots of output&gt;
..s7..B..')8.p..&gt;b.O...Vd............Y.3WT....I.&amp;C...Q....:c....g'...$........4.....
................}.s........Z.pp.h.7..D.J..,..s
....c.b6&lt;U...73oB.W...H.E.A.....$P..S..E.]...6!j...[D....I.2......o1.&gt;.
^C
5 packets captured
5 packets received by filter
0 packets dropped by kernel

There are clients trying to connect to the server, and there is no
response being sent to the clients.

However when I connect to the localhost (non-ssl) interface, it works fine.

# erl -version
Erlang (SMP,ASYNC_THREADS,HIPE) (BEAM) emulator version 5.7.4

# rabbitmqctl status
Status of node '<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at d1750-1</A>' ...
[{running_applications,[{rabbit,&quot;RabbitMQ&quot;,&quot;1.7.0&quot;},
                        {ssl,&quot;Erlang/OTP SSL application&quot;,&quot;3.10.7&quot;},
                        {crypto,&quot;CRYPTO version 1&quot;,&quot;1.6.3&quot;},
                        {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.4.12&quot;},
                        {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.4&quot;},
                        {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.8&quot;},
                        {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.16.4&quot;},
                        {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.13.4&quot;}]},
 {nodes,['<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at d1750-1</A>']},
 {running_nodes,['<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at d1750-1</A>']}]
...done.

# openssl
OpenSSL&gt; version
OpenSSL 0.9.8l 5 Nov 2009

# uname -a
Linux D1750-1 2.6.31-gentoo-r6 #1 SMP Thu Nov 26 16:30:46 EST 2009
i686 Intel(R) Xeon(TM) CPU 3.20GHz GenuineIntel GNU/Linux

We're running this on Gentoo and have tried various combinations of
compile time options (without hipe, without SMP, without kpoll) with
the same results.

Does anyone have an idea on how we can go about to troubleshoot this?
The amount of time it stays up appears to be random (sometimes hours,
sometime minutes). I'm guessing it's SSL related otherwise I'd imagine
it would have been caught by other users already.

When it does crash, I get this on the console:

Erlang has closed

Cheers,

--
Mark Steele
Director of development
Bering Media Inc.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005659.html">[rabbitmq-discuss] Cluster failover behaviour
</A></li>
	<LI>Next message: <A HREF="005665.html">[rabbitmq-discuss] TCP/SSL Listeners stuck, not responding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5663">[ date ]</a>
              <a href="thread.html#5663">[ thread ]</a>
              <a href="subject.html#5663">[ subject ]</a>
              <a href="author.html#5663">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
