<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Channel.Close w/ subscribed consumers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Channel.Close%20w/%20subscribed%20consumers&In-Reply-To=4B14C7FF.3090607%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005573.html">
   <LINK REL="Next"  HREF="005575.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Channel.Close w/ subscribed consumers</H1>
    <B>Aman Gupta</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Channel.Close%20w/%20subscribed%20consumers&In-Reply-To=4B14C7FF.3090607%40lshift.net"
       TITLE="[rabbitmq-discuss] Channel.Close w/ subscribed consumers">rabbitmq at tmm1.net
       </A><BR>
    <I>Tue Dec  1 09:04:08 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005573.html">[rabbitmq-discuss] Channel.Close w/ subscribed consumers
</A></li>
        <LI>Next message: <A HREF="005575.html">[rabbitmq-discuss] Bleeding edge persister and Erlang R13B03
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5574">[ date ]</a>
              <a href="thread.html#5574">[ thread ]</a>
              <a href="subject.html#5574">[ subject ]</a>
              <a href="author.html#5574">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Dec 1, 2009 at 2:38 AM, Matthias Radestock &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt; wrote:
&gt;<i> Aman,
</I>&gt;<i>
</I>&gt;<i> Matthias Radestock wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm not sure when I will find time to look into this.
</I>&gt;<i>
</I>&gt;<i> Have done so now. I cannot reproduce the problem.
</I>&gt;<i>
</I>&gt;<i> With two terminals, one running 'ruby subscriber.rb' and the other running
</I>&gt;<i> 'ruby publisher.rb', I can ^C the subscriber and the program terminates
</I>&gt;<i> almost instantly.
</I>&gt;<i>
</I>&gt;<i> I have tried this with both ruby 1.8 and 1.9.1, and versions 0.6.5 of the
</I>&gt;<i> amqp gem and 0-12.10 of em, all running against the head of 'default' of the
</I>&gt;<i> rabbitmq-server.
</I>
Thanks for taking the time to test this. I tried on linux with R12 and
R13 and you're right, it stops almost instantaneously. On my mac, it
takes a bit longer but still stops within 5-10 seconds.

The original bug report came with the 'sleep 1' which was commented
out in my version of subscriber.rb. The sleep exposes the issue, but
some digging shows the cause to be EventMachine and not rabbitmq.

The problem is that EM reads up to 16k from the socket during each
reactor tick. This can account for several hundred messages, each of
which is passed to the subscribe block. If each message causes a
sleep(1), the reactor is essentially blocked for several seconds. Once
all 16k worth of messages are processed, the reactor finally has a
chance to flush its outbound buffers, which contain the Channel.Close
command.

The solution to this problem is to set a prefetch window on the
channel, such that the reactor is not flooded with incoming messages.

  Aman

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005573.html">[rabbitmq-discuss] Channel.Close w/ subscribed consumers
</A></li>
	<LI>Next message: <A HREF="005575.html">[rabbitmq-discuss] Bleeding edge persister and Erlang R13B03
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5574">[ date ]</a>
              <a href="thread.html#5574">[ thread ]</a>
              <a href="subject.html#5574">[ subject ]</a>
              <a href="author.html#5574">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
