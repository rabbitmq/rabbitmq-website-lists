<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] persistent messages can't survive restart with new persister b6324e288cfd (bug21673)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20persistent%20messages%20can%27t%20survive%20restart%0A%20with%20new%20persister%20b6324e288cfd%20%28bug21673%29&In-Reply-To=c26271fb0912110504w4216ddd9gb0311c417cf2fa96%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005633.html">
   <LINK REL="Next"  HREF="005635.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] persistent messages can't survive restart with new persister b6324e288cfd (bug21673)</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20persistent%20messages%20can%27t%20survive%20restart%0A%20with%20new%20persister%20b6324e288cfd%20%28bug21673%29&In-Reply-To=c26271fb0912110504w4216ddd9gb0311c417cf2fa96%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] persistent messages can't survive restart with new persister b6324e288cfd (bug21673)">matthew at lshift.net
       </A><BR>
    <I>Fri Dec 11 14:20:18 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005633.html">[rabbitmq-discuss] persistent messages can't survive restart with	new persister b6324e288cfd (bug21673)
</A></li>
        <LI>Next message: <A HREF="005635.html">[rabbitmq-discuss] persistent messages can't survive restart	with new persister b6324e288cfd (bug21673)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5634">[ date ]</a>
              <a href="thread.html#5634">[ thread ]</a>
              <a href="subject.html#5634">[ subject ]</a>
              <a href="author.html#5634">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Anton,

This is entirely correct. When you publish a message with delivery
mode 2 you are *not* _guaranteed_ that it hits disk. Publishing is an
async operation and you get no confirmation that it goes to disk. The
new persister does very aggressive caching in order to avoid doing lots
of tiny and expensive writes. As such, there will frequently be times
where if you restart the broker, you will lose several (maybe hundreds)
of messages.

If you really want a guarantee that the message has hit disk then you
must, as with the old persister, use a transaction. When you receive the
tx.commit-ok back from the broke, you have a guarantee that the messages
have been flushed to disk and appropriate fsync's called.

Whilst this behaviour may seem different from the old persister, it is
in fact not different, it's simply that the window of time in which a
message now waits before being sent to disk is probably bigger. There is
certainly no concerted effort in either the new or old persister to
offer any sort of guarantee that messages published outside of a
transaction, with delivery mode 2, are &quot;promptly&quot; written to disk.

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005633.html">[rabbitmq-discuss] persistent messages can't survive restart with	new persister b6324e288cfd (bug21673)
</A></li>
	<LI>Next message: <A HREF="005635.html">[rabbitmq-discuss] persistent messages can't survive restart	with new persister b6324e288cfd (bug21673)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5634">[ date ]</a>
              <a href="thread.html#5634">[ thread ]</a>
              <a href="subject.html#5634">[ subject ]</a>
              <a href="author.html#5634">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
