<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Alternative Python AMQP client library
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Alternative%20Python%20AMQP%20client%20library&In-Reply-To=15192757.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000458.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Alternative Python AMQP client library</H1>
    <B>Barry Pederson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Alternative%20Python%20AMQP%20client%20library&In-Reply-To=15192757.post%40talk.nabble.com"
       TITLE="[rabbitmq-discuss] Alternative Python AMQP client library">bp at barryp.org
       </A><BR>
    <I>Thu Jan 31 00:37:47 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000458.html">[rabbitmq-discuss] Alternative Python AMQP client library
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#460">[ date ]</a>
              <a href="thread.html#460">[ thread ]</a>
              <a href="subject.html#460">[ subject ]</a>
              <a href="author.html#460">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>kyles wrote:
&gt;<i> Hi Barry,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Barry Pederson wrote:
</I>&gt;&gt;<i> I've seen a few Python users on this list, so I thought I'd mention that 
</I>&gt;&gt;<i> I've been working on a Python AMQP client library as an alternative to 
</I>&gt;&gt;<i> Qpid, and have a Mercurial repository and initial tarball available at:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    <A HREF="http://barryp.org/software/py-amqplib/">http://barryp.org/software/py-amqplib/</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The library is a bit rough, but I've been using it with RabbitMQ for a 
</I>&gt;&gt;<i> while now.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> I've been unable to get the amqplib client working when I'm running 2 or
</I>&gt;<i> more nodes in a RabbitMQ cluster. Using a single node (local or remote)
</I>&gt;<i> works fine. The error I'm getting is:
</I>&gt;<i> 
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>   File &quot;demo_send.py&quot;, line 56, in &lt;module&gt;
</I>&gt;<i>     main()
</I>&gt;<i>   File &quot;demo_send.py&quot;, line 41, in main
</I>&gt;<i>     conn = amqp.Connection(options.host, userid=options.userid,
</I>&gt;<i> password=options.password, ssl=options.ssl)
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line
</I>&gt;<i> 180, in __init__
</I>&gt;<i>     self.close()
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line
</I>&gt;<i> 420, in close
</I>&gt;<i>     (10, 61),    # Connection.close_ok
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line
</I>&gt;<i> 356, in wait
</I>&gt;<i>     frame_type, payload = self._wait_channel(0)
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line
</I>&gt;<i> 298, in _wait_channel
</I>&gt;<i>     frame_type, frame_channel, payload = self._wait_frame()
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line
</I>&gt;<i> 273, in _wait_frame
</I>&gt;<i>     frame_type = self.input.read_octet()
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/amqplib/util_0_8.py&quot;, line
</I>&gt;<i> 96, in read_octet
</I>&gt;<i>     return unpack('B', self.input.read(1))[0]
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/struct.py&quot;, line 87, in unpack
</I>&gt;<i>     return o.unpack(s)
</I>&gt;<i> struct.error: unpack requires a string argument of length 1
</I>&gt;<i> Exception socket.error: (32, 'Broken pipe') in &lt;bound method
</I>&gt;<i> Connection.__del__ of &lt;amqplib.client_0_8.Connection object at 0xb7c7470c&gt;&gt;
</I>&gt;<i> ignored
</I>&gt;<i> 
</I>&gt;<i> Is this something you've seen before?
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> Kyle
</I>
Sorry, I haven't had a multi-node RabbitMQ setup to try anything like
that particular setup, so haven't seen that particular error.

It looks like the node you're connecting to is maybe trying to redirect
you to the other node, and then closing the socket without waiting for
the client to send a &quot;close&quot; message and then responding with &quot;close-ok&quot;.

(Does the server initiate the exchange of &quot;close&quot;/&quot;close-ok&quot; messages
after a redirect?  It wasn't clear to me from the specs.)

Anyhow, an easy workaround would be to wrap the call to self.close() in
line 180 of amqplib/client_0_8.py in a try/except block - so try
changing this:

--------
             # we were redirected, close the socket, loop and try again
             self.close()
--------

to this:

---------
             # we were redirected, close the socket, loop and try again
             try:
                 self.close()
             except:
                 pass
---------

that might do the trick.

	Barry




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000458.html">[rabbitmq-discuss] Alternative Python AMQP client library
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#460">[ date ]</a>
              <a href="thread.html#460">[ thread ]</a>
              <a href="subject.html#460">[ subject ]</a>
              <a href="author.html#460">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
