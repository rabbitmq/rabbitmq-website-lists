<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Persistent message in perl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Persistent%20message%20in%20perl&In-Reply-To=%3C4D0F876E.1020800%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010445.html">
   <LINK REL="Next"  HREF="010449.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Persistent message in perl</H1>
    <B>Emile Joubert</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Persistent%20message%20in%20perl&In-Reply-To=%3C4D0F876E.1020800%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Persistent message in perl">emile at rabbitmq.com
       </A><BR>
    <I>Mon Dec 20 16:42:22 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010445.html">[rabbitmq-discuss] Persistent message in perl
</A></li>
        <LI>Next message: <A HREF="010449.html">[rabbitmq-discuss] Persistent message in perl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10446">[ date ]</a>
              <a href="thread.html#10446">[ thread ]</a>
              <a href="subject.html#10446">[ subject ]</a>
              <a href="author.html#10446">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Fab,

If you ran publish.pl before consume.pl then the messages will be 
discarded, because there is no queue for messages to be delivered to and 
no binding for messages to get there.

As Alexandru explained, the binding and queue have to exist first. You 
could either launch the consumer in the background before starting the 
publisher, or declare the queue and binding in the publisher as well.

Regards

Emile



Op 20/12/2010 16:11, het Alexandru Scvor&#355;ov geskryf:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Queues and exchanges don't work like that.
</I>&gt;<i>
</I>&gt;<i> An exchange is just a router, it doesn't store messages.  That's the
</I>&gt;<i> queues' job.
</I>&gt;<i>
</I>&gt;<i> What you want to do is this:
</I>&gt;<i>    - publisher declares a durable queue with a known name and binds it to an
</I>&gt;<i>      exchange (by default it's bound the default exchange with its name
</I>&gt;<i>      as routing key; the default exchange is &quot;amq.default&quot; or &quot;&quot;)
</I>&gt;<i>    - publisher publishes a persistent message to the exchange, which
</I>&gt;<i>      routes it to the queue (the routing key should be the queue's name,
</I>&gt;<i>      or whatever you bound the queue with)
</I>&gt;<i>
</I>&gt;<i>    - consumer declares a durable queue with the same name (this is just
</I>&gt;<i>      to make sure that it exists; it's effectively a no-op)
</I>&gt;<i>    - consumer consumes or gets from the queue.
</I>&gt;<i>
</I>&gt;<i> Hope this helps.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;<i> On Mon, Dec 20, 2010 at 03:38:11PM +0000, underattack7 wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am struggling with persistent message in perl.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What I am trying to achieve is :
</I>&gt;&gt;<i> - publish message to a direct exchange
</I>&gt;&gt;<i> - the exchange stores the message
</I>&gt;&gt;<i> - a consumer creates a queue, binds it to the exchange, and get all the
</I>&gt;&gt;<i> stored messages
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a durable exchange, and apparently I would need to publish message
</I>&gt;&gt;<i> using &quot;delivery_mode = 2&quot; for the exchange to store the message until a
</I>&gt;&gt;<i> queue is bound to it....is that right ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem I have is that when my consumer creates a queue and bind it to
</I>&gt;&gt;<i> the exchange, it does not get all the message sent.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My publisher code :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #!/usr/bin/perl
</I>&gt;&gt;<i> use Net::RabbitMQ;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $myexchange=$ARGV[0];
</I>&gt;&gt;<i> my $rkey=$ARGV[1];
</I>&gt;&gt;<i> my $text=$ARGV[2];
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $mq = Net::RabbitMQ-&gt;new();
</I>&gt;&gt;<i> $mq-&gt;connect(&quot;rabbitmqserver&quot;, { vhost=&gt;&quot;chat&quot;, user =&gt;  &quot;guest&quot;, password =&gt;
</I>&gt;&gt;<i> &quot;guest&quot; });
</I>&gt;&gt;<i> $mq-&gt;channel_open(1);
</I>&gt;&gt;<i> $mq-&gt;publish(1, $rkey, $text, {exchange =&gt;  $myexchange}, { content_type =&gt;
</I>&gt;&gt;<i> 'text/plain', delivery_mode =&gt;  2});
</I>&gt;&gt;<i> mqdisconnect;
</I>&gt;&gt;<i> exit 0;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I execute it with for example :
</I>&gt;&gt;<i> ./publish.pl &quot;exchangechat&quot; &quot;toto&quot; &quot;hi toto1&quot;
</I>&gt;&gt;<i> ./publish.pl &quot;exchangechat&quot; &quot;toto&quot; &quot;hi toto2&quot;
</I>&gt;&gt;<i> ./publish.pl &quot;exchangechat&quot; &quot;toto&quot; &quot;hi toto3&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The consumer code is :
</I>&gt;&gt;<i> #!/usr/bin/perl
</I>&gt;&gt;<i> use Net::RabbitMQ;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $exchange=$ARGV[0];
</I>&gt;&gt;<i> my $rkey=$ARGV[1];
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my $mq = Net::RabbitMQ-&gt;new();
</I>&gt;&gt;<i> $mq-&gt;connect(&quot;rabbitmqserver&quot;, { vhost =&gt;  &quot;chat&quot;, user =&gt;  &quot;guest&quot;, password
</I>&gt;&gt;<i> =&gt;  &quot;guest&quot; });
</I>&gt;&gt;<i> $mq-&gt;channel_open(1);
</I>&gt;&gt;<i> my $queuename = $mq-&gt;queue_declare(1, '', {exclusive =&gt;  1, durable =&gt;  0,
</I>&gt;&gt;<i> auto_delete =&gt;  1});
</I>&gt;&gt;<i> $mq-&gt;queue_bind(1, &quot;$queue&quot;, &quot;$exchange&quot;, &quot;$rkey&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> while(1) {
</I>&gt;&gt;<i>      my $message = $mq-&gt;get(1, $queuename);
</I>&gt;&gt;<i>      if ( defined($message) ) {
</I>&gt;&gt;<i>          print $message-&gt;{'routing_key'} . &quot;\n&quot;;
</I>&gt;&gt;<i>          print $message-&gt;{'body'} . &quot;\n&quot;;
</I>&gt;&gt;<i>          print &quot;\n\n&quot;;
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i>      sleep(1);
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> exit 0;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And I run it with :
</I>&gt;&gt;<i> ./consume.pl exchangechat &quot;toto&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> but I do not get the message &quot;hi toto1&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any idea what's wrong here ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Fab
</I></PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010445.html">[rabbitmq-discuss] Persistent message in perl
</A></li>
	<LI>Next message: <A HREF="010449.html">[rabbitmq-discuss] Persistent message in perl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10446">[ date ]</a>
              <a href="thread.html#10446">[ thread ]</a>
              <a href="subject.html#10446">[ subject ]</a>
              <a href="author.html#10446">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
