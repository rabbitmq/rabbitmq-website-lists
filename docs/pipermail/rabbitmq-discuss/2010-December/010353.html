<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Handling network reliability problems on the	publisher side
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Handling%20network%20reliability%20problems%20on%20the%0A%09publisher%20side&In-Reply-To=%3CC92BF782.1BCCB%25stefan.kaes%40xing.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010352.html">
   <LINK REL="Next"  HREF="010356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Handling network reliability problems on the	publisher side</H1>
    <B>Stefan Kaes</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Handling%20network%20reliability%20problems%20on%20the%0A%09publisher%20side&In-Reply-To=%3CC92BF782.1BCCB%25stefan.kaes%40xing.com%3E"
       TITLE="[rabbitmq-discuss] Handling network reliability problems on the	publisher side">Stefan.Kaes at xing.com
       </A><BR>
    <I>Mon Dec 13 15:17:06 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010352.html">[rabbitmq-discuss] How to Show my List_Queues in .net
</A></li>
        <LI>Next message: <A HREF="010356.html">[rabbitmq-discuss] Handling network reliability problems on the publisher side
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10353">[ date ]</a>
              <a href="thread.html#10353">[ thread ]</a>
              <a href="subject.html#10353">[ subject ]</a>
              <a href="author.html#10353">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone,

as some of you may know, we&#8217;ve aimed at building a highly reliable messaging infrastructure around the idea of publishing messages redundantly to a number of identical rabbitmq instances along with deduplicating messages on the receiver side. (see <A HREF="http://xing.github.com/beetle/,">http://xing.github.com/beetle/,</A> <A HREF="https://github.com/xing/beetle">https://github.com/xing/beetle</A> and <A HREF="https://github.com/xing/perl-beetle">https://github.com/xing/perl-beetle</A>).

The system has been in use in our production environment since April, and we were quite happy with it.

However, we recently had an incident which points to a weakness of our solution: we experienced a temporary network routing problem, which separated at least one of the rabbitmq servers from the publishing processes (mainly or web application). The separation lasted several minutes and lead to parts of our web application blocking in socket writes. In the end, our administrators restarted the web app.

It turned out that we lost quite a few messages, and here&#8217;s why: the publisher blocks only after the TCP buffers have been filled completely (even though TCP_NODELAY and SO_SNDTIMEO are set on the socket).

It looks like no programming cleverness on our side can achieve what we want: have the publisher block as soon as a message cannot be accepted by the intended rabbitmq server, because, as far as we understand the amqp protocol, no protocol level acknowledgements are sent which the publisher could wait for (and optionally timeout), before sending the next message.

This is all fine to achieve high throughput on the publisher side, but doesn&#8217;t quite fit our use case. For some messages, we really need to make reasonably sure the message has been received by a rabbitmq server, before we continue. We could then use timeouts to detect network partitioning and buffer messages locally until they can be sent (only if none of our three redundant servers can be reached, of course).

Turning on heartbeats can improve the situation somewhat, in that failures can be detected earlier, but since heartbeats are asynchronous in nature, they don&#8217;t fully solve our problem.

It currently seems as if the only way to get what we want is to switch our publishers to use the JSON-RPC plugin for rabbitmq.

I&#8217;d be interested to here what you think about the problem:


 *   is the analysis correct?
 *   is the JSON-RPC plugin stable enough to be used in production?
 *   maybe there&#8217;s a better solution available?


Regards,

-- stefan



Dr. Stefan Kaes
Principal System Architect

XING AG
Gaensemarkt 43, 20354 Hamburg, Germany
Tel. +49 40 419131-801, Fax +49 40 419131-11

Commercial Reg. (Registergericht): Amtsgericht Hamburg, HRB 98807
Exec. Board (Vorstand): Dr. Stefan Gro&#223;-Selbeck (Vorsitzender), Ingo Chu, Burkhard Blum, Michael Otto, Dr. Helmut Becker
Chairman of the Supervisory Board (Aufsichtsratsvorsitzender): Dr. Neil Sunderland

Please join my network on XING: <A HREF="http://www.xing.com/go/invite/Stefan.Kaes">http://www.xing.com/go/invite/Stefan.Kaes</A>

This email may contain confidential and/or privileged information. If you are not the intended recipient (or have received this email in error) please notify the sender immediately and destroy this email. Any unauthorized copying, disclosure or distribution of the material in this email is strictly forbidden and may be unlawful.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20101213/19b030e2/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20101213/19b030e2/attachment.htm</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010352.html">[rabbitmq-discuss] How to Show my List_Queues in .net
</A></li>
	<LI>Next message: <A HREF="010356.html">[rabbitmq-discuss] Handling network reliability problems on the publisher side
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10353">[ date ]</a>
              <a href="thread.html#10353">[ thread ]</a>
              <a href="subject.html#10353">[ subject ]</a>
              <a href="author.html#10353">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
