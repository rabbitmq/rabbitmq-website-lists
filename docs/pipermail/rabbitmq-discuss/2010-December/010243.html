<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] using a topic exchange to route to	multiple	queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20using%20a%20topic%20exchange%20to%20route%20to%0A%09multiple%09queues&In-Reply-To=%3C6EBF04E7-D88E-4651-AC63-95C3E32CCF6F%40vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010240.html">
   <LINK REL="Next"  HREF="010244.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] using a topic exchange to route to	multiple	queues</H1>
    <B>Jerry Kuch</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20using%20a%20topic%20exchange%20to%20route%20to%0A%09multiple%09queues&In-Reply-To=%3C6EBF04E7-D88E-4651-AC63-95C3E32CCF6F%40vmware.com%3E"
       TITLE="[rabbitmq-discuss] using a topic exchange to route to	multiple	queues">jerryk at vmware.com
       </A><BR>
    <I>Mon Dec  6 18:33:48 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010240.html">[rabbitmq-discuss] using a topic exchange to route to multiple	queues
</A></li>
        <LI>Next message: <A HREF="010244.html">[rabbitmq-discuss] using a topic exchange to route to	multiple	queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10243">[ date ]</a>
              <a href="thread.html#10243">[ thread ]</a>
              <a href="subject.html#10243">[ subject ]</a>
              <a href="author.html#10243">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Dec 5, 2010, at 8:08 PM, Daniel Oppenheimer wrote:

Hi, Daniel...

I am writing a java rabbitmq client.  And I am trying to write code that will publish messages to topic exchanges such that they get delivered to multiple queues.  Following is the code that I am using:

Channel channel = conn.createChannel();
channel.exchangeDeclare(my_exchange, &quot;topic&quot;, true);
channel.queueDeclare(company.my_queue, true, false, false, null);
channel.queueBind(company.my_queue, my_exchange, &#8220;company.#&#8221; );

This binding would result in your queue receiving messages, for example, with routing keys &quot;company.MSFT&quot; and &quot;company.VMW&quot; and also &quot;company&quot;.

channel.basicPublish(my_exchange, &#8220;company.#&#8221;, null, messageBodyBytes);

I would like this code to publish to all queues under company.  That is, I would like it to publish to company.my_queue and company.another_queue.  My understanding is that the wild card in the routing key should route any message published to my_exchange to any queue prefixed with company.  Is this correct?  If not, what is the correct way to do what I am trying to accomplish?  Should there be a wild card in the routing key in both the queueBind and basicPublish method calls?

For topic exchanges, messages published to that exchange will be delivered to all queues whose binding pattern matches the routing key of the message.

You only need the wild card in the routing key for the queueBind.  Any subsequent basicPublish'es that occur with routing keys that match the pattern that you used to bind your queues to the exchange will then receive those messages.  Doing:

channel.basicPublish(my_exchange, &#8220;company&#8221;, null, messageBodyBytes);

would suffice to hit all of the queues that you've attached to the exchange using your binding of the form:

channel.queueBind(company.my_queue, my_exchange, &#8220;company.#&#8221; );

Here's a transcript of an interactive session done with the Erlang client (it should be fairly easy to pattern match what's going on against the Java equivalent even if Erlang's new to you), along with example invocations of rabbitmqctl (indented with the effects of interest highlighted) to see the effects of what we've done.

Eshell V5.8  (abort with ^G)

1&gt; rr(&quot;include/amqp_client.hrl&quot;). %% read headers for record types
['P_access', BLAHBLAHBLAH deleted]

2&gt; {ok, Conn} = amqp_connection:start(network). %% start connection
{ok,&lt;0.48.0&gt;}
3&gt; {ok, Chan} = amqp_connection:open_channel(Conn). %% open channel
{ok,&lt;0.58.0&gt;}

4&gt; ED = #'exchange.declare'{exchange= &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,type= &lt;&lt;&quot;topic&quot;&gt;&gt;}. %% declare topic exchange
#'exchange.declare'{ticket = 0,exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,
                    type = &lt;&lt;&quot;topic&quot;&gt;&gt;,passive = false,durable = false,
                    auto_delete = false,internal = false,nowait = false,
                    arguments = []}
5&gt; amqp_channel:call(Chan,ED).
#'exchange.declare_ok'{}

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_exchanges
Listing exchanges ...
amq.direct
direct
amq.topic
topic
my_exchange
topic
amq.rabbitmq.log
topic
amq.fanout
fanout
amq.headers
headers
direct
amq.match
headers
...done.


6&gt; QD1 = #'queue.declare'{queue = &lt;&lt;&quot;queue_1&quot;&gt;&gt;}. %% One queue...
#'queue.declare'{ticket = 0,queue = &lt;&lt;&quot;queue_1&quot;&gt;&gt;,
                 passive = false,durable = false,exclusive = false,
                 auto_delete = false,nowait = false,arguments = []}
7&gt; QD2 = #'queue.declare'{queue = &lt;&lt;&quot;queue_2&quot;&gt;&gt;}. %% Another queue...
#'queue.declare'{ticket = 0,queue = &lt;&lt;&quot;queue_2&quot;&gt;&gt;,
                 passive = false,durable = false,exclusive = false,
                 auto_delete = false,nowait = false,arguments = []}
8&gt; amqp_channel:call(Chan, QD1). %% Create first queue...
#'queue.declare_ok'{queue = &lt;&lt;&quot;queue_1&quot;&gt;&gt;,message_count = 0,
                    consumer_count = 0}
9&gt; amqp_channel:call(Chan, QD2). %% Create second queue...
#'queue.declare_ok'{queue = &lt;&lt;&quot;queue_2&quot;&gt;&gt;,message_count = 0,
                    consumer_count = 0}

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queues
Listing queues ...
queue_2 0
queue_1 0
...done.


10&gt; B1 = #'queue.bind'{queue= &lt;&lt;&quot;queue_1&quot;&gt;&gt;, exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;, routing_key = &lt;&lt;&quot;company.#&quot;&gt;&gt;}. %% Bind first queue to exchange...
#'queue.bind'{ticket = 0,queue = &lt;&lt;&quot;queue_1&quot;&gt;&gt;,
              exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,routing_key = &lt;&lt;&quot;company.#&quot;&gt;&gt;,
              nowait = false,arguments = []}
11&gt; B2 = #'queue.bind'{queue= &lt;&lt;&quot;queue_2&quot;&gt;&gt;, exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;, routing_key = &lt;&lt;&quot;company.#&quot;&gt;&gt;}. %% Bind second queue to exchange...
#'queue.bind'{ticket = 0,queue = &lt;&lt;&quot;queue_2&quot;&gt;&gt;,
              exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,routing_key = &lt;&lt;&quot;company.#&quot;&gt;&gt;,
              nowait = false,arguments = []}
12&gt; amqp_channel:call(Chan,B1). amqp_channel:call(Chan,B2).
#'queue.bind_ok'{}

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_bindings
Listing bindings ...
exchange queue_1 queue queue_1 []
exchange queue_2 queue queue_2 []
my_exchange exchange queue_1 queue company.# []
my_exchange exchange queue_2 queue company.# []
...done.

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queuesListing queues ...
queue_2 0  &lt;--  NOTE NO MESSAGES IN THESE QUEUES!
queue_1 0  &lt;--/
...done.


14&gt; Payload = &lt;&lt;&quot;foobar&quot;&gt;&gt;. %% Bogus message payload
&lt;&lt;&quot;foobar&quot;&gt;&gt;
15&gt; Publish = #'basic.publish'{exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;, routing_key = &lt;&lt;&quot;company.MSFT&quot;&gt;&gt;}.
#'basic.publish'{ticket = 0,exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,
                 routing_key = &lt;&lt;&quot;company.MSFT&quot;&gt;&gt;,mandatory = false,
                 immediate = false}
16&gt; amqp_channel:cast(Chan, Publish, #amqp_msg{payload=Payload}). %% Publish to the exchange, should go to both bound queues...
ok

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queues
Listing queues ...
queue_2 1  &lt;-- OUR MESSAGE ARRIVED...
queue_1 1  &lt;-- ...IN BOTH QUEUES.
...done.


17&gt; amqp_channel:cast(Chan, Publish, #amqp_msg{payload=Payload}). %% Publish to exchange again, should also go to both bound queues...
ok

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queuesListing queues ...
queue_2 2  &lt;-- SECOND PUBLISHED MESSAGE ARRIVED...
queue_1 2  &lt;-- ...ALSO IN BOTH QUEUES.
...done.

22&gt; WPZ = #'basic.publish'{exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;, routing_key = &lt;&lt;&quot;company&quot;&gt;&gt;}.
#'basic.publish'{ticket = 0,exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,
                 routing_key = &lt;&lt;&quot;company&quot;&gt;&gt;,mandatory = false,
                 immediate = false}
23&gt; amqp_channel:cast(Chan, WPZ, #amqp_msg{payload = &lt;&lt;&quot;Payload&quot;&gt;&gt;}).

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queuesListing queues ...
queue_2 3  &lt;-- SECOND PUBLISHED MESSAGE ARRIVED...
queue_1 3  &lt;-- ...ALSO IN BOTH QUEUES.
...done.


</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010240.html">[rabbitmq-discuss] using a topic exchange to route to multiple	queues
</A></li>
	<LI>Next message: <A HREF="010244.html">[rabbitmq-discuss] using a topic exchange to route to	multiple	queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10243">[ date ]</a>
              <a href="thread.html#10243">[ thread ]</a>
              <a href="subject.html#10243">[ subject ]</a>
              <a href="author.html#10243">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
