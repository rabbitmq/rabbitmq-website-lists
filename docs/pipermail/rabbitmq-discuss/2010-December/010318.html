<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] client connect problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20client%20connect%20problems&In-Reply-To=%3CF89764B1-9DD8-4421-B519-1706A6C5CC79%40vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010317.html">
   <LINK REL="Next"  HREF="010230.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] client connect problems</H1>
    <B>Jerry Kuch</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20client%20connect%20problems&In-Reply-To=%3CF89764B1-9DD8-4421-B519-1706A6C5CC79%40vmware.com%3E"
       TITLE="[rabbitmq-discuss] client connect problems">jerryk at vmware.com
       </A><BR>
    <I>Fri Dec 10 17:06:13 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010317.html">[rabbitmq-discuss] client connect problems
</A></li>
        <LI>Next message: <A HREF="010230.html">[rabbitmq-discuss] Connection managment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10318">[ date ]</a>
              <a href="thread.html#10318">[ thread ]</a>
              <a href="subject.html#10318">[ subject ]</a>
              <a href="author.html#10318">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, Robert...

Glad to hear the problem's resolved.  Please let us know if you need anything else!

Best regards,
Jerry

On Dec 10, 2010, at 9:05 AM, Robert Fuller wrote:

&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I found the hadoop task processes hanging around because my code did
</I>&gt;<i> not always close the rabbitmq connection. I fixed the bug in my code
</I>&gt;<i> and now, voila, no more client connect problems.
</I>&gt;<i> 
</I>&gt;<i> Thanks again!
</I>&gt;<i> Rob.
</I>&gt;<i> 
</I>&gt;<i> On 3 December 2010 18:25, Robert Fuller &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">fullergalway at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> Thanks Jerry,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I used `rabbitmqctl list_connections` to find 436 connections. Hmmn.
</I>&gt;&gt;<i> More than I expected.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I logged into one of the (hadoop map/reduce) servers, and I can see
</I>&gt;&gt;<i> that some processes for old hadoop task attempts are hanging around,
</I>&gt;&gt;<i> so yes it looks like i'm not playing nicely.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I'll look into it further on Monday.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Rob
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 3 December 2010 18:11, Jerry Kuch &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at vmware.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> Hi, Robert.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> With a broker version this new, these things are often either a misbehaving client, or the broker running in an environment where there's a resource limit configuration problem, e.g. running out of file descriptors.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Here are a few things to investigate in such circumstances (derived from a support incident on an older Rabbit version, but most of this remains sensible stuff to check).
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Please let us know how it goes.  If none of the above yield meaningful clues, would you feel comfortable sharing some snippets of your client code with which you're encountering the problem?
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Jerry
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ==============
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  Here's a quick laundry list of things to investigate when one
</I>&gt;&gt;&gt;<i>  encounters problems of this flavor.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  - check `ulimit -n` as whichever user is being used to run rabbit;
</I>&gt;&gt;&gt;<i>   depending on your system this may be the 'rabbitmq' user.  Be wary
</I>&gt;&gt;&gt;<i>   of raised limits not making it to the user/shell/process one
</I>&gt;&gt;&gt;<i>   wanted them to.  Again, newer Rabbits will announce at startup
</I>&gt;&gt;&gt;<i>   time what sort of file handle limits they think they're working under
</I>&gt;&gt;&gt;<i>   with a log message something like:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>           =INFO REPORT==== 2-Dec-2010::14:37:38 ===
</I>&gt;&gt;&gt;<i>        Limiting to approx 156 file handles (138 sockets)
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  This example is from my desktop machine where by default 'ulimit -n'
</I>&gt;&gt;&gt;<i>  gives 256, a value that's likely rather too low for a broker that's going
</I>&gt;&gt;&gt;<i>  to be serving a lot of clients.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  - check the logs for memory alarms; severe memory pressure can cause
</I>&gt;&gt;&gt;<i>   Rabbit to start refusing connections.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  - check that Rabbit hasn't run out of sockets; to do this use
</I>&gt;&gt;&gt;<i>   `rabbitmqctl list_connections` and netstat to see if there are
</I>&gt;&gt;&gt;<i>   suspiciously large numbers of existing connections.  Client
</I>&gt;&gt;&gt;<i>   misbehavior may cause this on an otherwise healthy Rabbit.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  - check the rabbit-sasl.log and the main rabbit.log for any sign
</I>&gt;&gt;&gt;<i>   that the tcp listener/acceptor process has crashed or misbehaved.
</I>&gt;&gt;&gt;<i>   Look for 'CRASH REPORT' entries in the logs and mentions of
</I>&gt;&gt;&gt;<i>   'tcp_acceptor', 'cannot_accept' , &quot;{error,emfile}&quot; and similar.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  - is Rabbit spinning frantically?  Check 'top' and your preferred
</I>&gt;&gt;&gt;<i>   process monitoring tools to see if you have Rabbit beam.smp
</I>&gt;&gt;&gt;<i>   processes consuming large amounts of CPU while the problem is
</I>&gt;&gt;&gt;<i>   manifesting. [ In your current case it seems you've ruled this out
</I>&gt;&gt;&gt;<i>   already]
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  - generally scour rabbit.log and rabbit-sasl.log for suspicious errors.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  - use 'rabbitmqctl list_WHATEVER' for WHATEVERs including connections,
</I>&gt;&gt;&gt;<i>   channels, exchanges, queues, bindings, etc. to see if there are
</I>&gt;&gt;&gt;<i>   unexpectedly massive quantities of anything.  Also check your
</I>&gt;&gt;&gt;<i>   queues to see if any have absurd numbers of messages languishing
</I>&gt;&gt;&gt;<i>   in them, as this could indicate a misbehaving client application.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On Dec 3, 2010, at 4:03 AM, Robert Fuller wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I had an issue for several hours where clients from many hosts were
</I>&gt;&gt;&gt;&gt;<i> not able to connect to a running rabbitmq server (2.2.0). list_queues
</I>&gt;&gt;&gt;&gt;<i> showed only a small number of items in the queues. Eventually after
</I>&gt;&gt;&gt;&gt;<i> restarting rabbitmq server everything returned immediately to normal.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> client stack seems to be sometimes this:
</I>&gt;&gt;&gt;&gt;<i> java.net.ConnectException: Connection timed out
</I>&gt;&gt;&gt;&gt;<i>       at java.net.PlainSocketImpl.socketConnect(Native Method)
</I>&gt;&gt;&gt;&gt;<i>       at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:333)
</I>&gt;&gt;&gt;&gt;<i>       at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:195)
</I>&gt;&gt;&gt;&gt;<i>       at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:182)
</I>&gt;&gt;&gt;&gt;<i>       at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:366)
</I>&gt;&gt;&gt;&gt;<i>       at java.net.Socket.connect(Socket.java:529)
</I>&gt;&gt;&gt;&gt;<i>       at java.net.Socket.connect(Socket.java:478)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.ConnectionFactory.createFrameHandler(ConnectionFactory.java:338)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:376)
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> and sometimes this:
</I>&gt;&gt;&gt;&gt;<i> java.io.IOException
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.impl.AMQChannel.wrap(AMQChannel.java:121)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.impl.AMQConnection.start(AMQConnection.java:274)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:379)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:399)
</I>&gt;&gt;&gt;&gt;<i> ...
</I>&gt;&gt;&gt;&gt;<i> Caused by: com.rabbitmq.client.ShutdownSignalException: connection
</I>&gt;&gt;&gt;&gt;<i> error; reason: java.net.SocketException: Connection reset
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.utility.ValueOrException.getValue(ValueOrException.java:81)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.utility.BlockingValueOrException.uninterruptibleGetValue(BlockingValueOrException.java:47)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.impl.AMQChannel$BlockingRpcContinuation.getReply(AMQChannel.java:342)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.impl.AMQConnection.start(AMQConnection.java:258)
</I>&gt;&gt;&gt;&gt;<i>       ... 39 more
</I>&gt;&gt;&gt;&gt;<i> Caused by: java.net.SocketException: Connection reset
</I>&gt;&gt;&gt;&gt;<i>       at java.net.SocketInputStream.read(SocketInputStream.java:168)
</I>&gt;&gt;&gt;&gt;<i>       at java.io.BufferedInputStream.fill(BufferedInputStream.java:218)
</I>&gt;&gt;&gt;&gt;<i>       at java.io.BufferedInputStream.read(BufferedInputStream.java:237)
</I>&gt;&gt;&gt;&gt;<i>       at java.io.DataInputStream.readUnsignedByte(DataInputStream.java:271)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.impl.Frame.readFrom(Frame.java:118)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.impl.SocketFrameHandler.readFrame(SocketFrameHandler.java:155)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.impl.AMQConnection.readFrame(AMQConnection.java:393)
</I>&gt;&gt;&gt;&gt;<i>       at com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:421)
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I could see nothing unusual on the server using top (memory and cpu
</I>&gt;&gt;&gt;&gt;<i> usage ok), or in the rabbitmq logs.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> What can I do to produce you a log on the server should this situation re-occur?
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;&gt;<i> Rob.
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010317.html">[rabbitmq-discuss] client connect problems
</A></li>
	<LI>Next message: <A HREF="010230.html">[rabbitmq-discuss] Connection managment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10318">[ date ]</a>
              <a href="thread.html#10318">[ thread ]</a>
              <a href="subject.html#10318">[ subject ]</a>
              <a href="author.html#10318">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
