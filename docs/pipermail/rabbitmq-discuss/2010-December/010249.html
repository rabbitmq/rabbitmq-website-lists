<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] using a topic exchange to route	to	multiple	queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20using%20a%20topic%20exchange%20to%20route%0A%09to%09multiple%09queues&In-Reply-To=%3CEBD47A52-6A73-43A9-B128-FDE4BFA68C3A%40vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010247.html">
   <LINK REL="Next"  HREF="010238.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] using a topic exchange to route	to	multiple	queues</H1>
    <B>John DeTreville</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20using%20a%20topic%20exchange%20to%20route%0A%09to%09multiple%09queues&In-Reply-To=%3CEBD47A52-6A73-43A9-B128-FDE4BFA68C3A%40vmware.com%3E"
       TITLE="[rabbitmq-discuss] using a topic exchange to route	to	multiple	queues">jdetreville at vmware.com
       </A><BR>
    <I>Tue Dec  7 00:39:24 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010247.html">[rabbitmq-discuss] using a topic exchange to route to	multiple queues
</A></li>
        <LI>Next message: <A HREF="010238.html">[rabbitmq-discuss] PHP app needs amqp statistics for reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10249">[ date ]</a>
              <a href="thread.html#10249">[ thread ]</a>
              <a href="subject.html#10249">[ subject ]</a>
              <a href="author.html#10249">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Also, to quote the FAQ:

&gt;<i> The routing key must be absolute whilst the binding key can contain
</I>&gt;<i> a wildcard.
</I>
This might be an interesting extension, but it's not possible at this time.

Cheers,
John DeTreville
RabbitMQ Pacific Rim office

On Dec 6, 2010, at 11:50 AM, Christian Legnitto wrote:

&gt;<i> I think Daniel was asking if it is possible to create automatic bindings based on queue name. From my reading, it sounds like he wants all messages that match &quot;company.#&quot; to be routed to any queue which has a name that starts with &quot;company.&quot; (feel free to correct me Daniel).
</I>&gt;<i> 
</I>&gt;<i> I don't think a mechanism like this exists (automatic binding rules) and like Jerry says you likely need to specify the bindings manually for each queue. I would be interested of learning about this functionality if it exists though.
</I>&gt;<i> 
</I>&gt;<i> Christian
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Dec 6, 2010, at 10:33 AM, Jerry Kuch wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Dec 5, 2010, at 8:08 PM, Daniel Oppenheimer wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Hi, Daniel...
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I am writing a java rabbitmq client.  And I am trying to write code that will publish messages to topic exchanges such that they get delivered to multiple queues.  Following is the code that I am using:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Channel channel = conn.createChannel();
</I>&gt;&gt;<i> channel.exchangeDeclare(my_exchange, &quot;topic&quot;, true);
</I>&gt;&gt;<i> channel.queueDeclare(company.my_queue, true, false, false, null);
</I>&gt;&gt;<i> channel.queueBind(company.my_queue, my_exchange, &#8220;company.#&#8221; );
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> This binding would result in your queue receiving messages, for example, with routing keys &quot;company.MSFT&quot; and &quot;company.VMW&quot; and also &quot;company&quot;.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> channel.basicPublish(my_exchange, &#8220;company.#&#8221;, null, messageBodyBytes);
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I would like this code to publish to all queues under company.  That is, I would like it to publish to company.my_queue and company.another_queue.  My understanding is that the wild card in the routing key should route any message published to my_exchange to any queue prefixed with company.  Is this correct?  If not, what is the correct way to do what I am trying to accomplish?  Should there be a wild card in the routing key in both the queueBind and basicPublish method calls?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> For topic exchanges, messages published to that exchange will be delivered to all queues whose binding pattern matches the routing key of the message.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> You only need the wild card in the routing key for the queueBind.  Any subsequent basicPublish'es that occur with routing keys that match the pattern that you used to bind your queues to the exchange will then receive those messages.  Doing:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> channel.basicPublish(my_exchange, &#8220;company&#8221;, null, messageBodyBytes);
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> would suffice to hit all of the queues that you've attached to the exchange using your binding of the form:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> channel.queueBind(company.my_queue, my_exchange, &#8220;company.#&#8221; );
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Here's a transcript of an interactive session done with the Erlang client (it should be fairly easy to pattern match what's going on against the Java equivalent even if Erlang's new to you), along with example invocations of rabbitmqctl (indented with the effects of interest highlighted) to see the effects of what we've done.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Eshell V5.8  (abort with ^G)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1&gt; rr(&quot;include/amqp_client.hrl&quot;). %% read headers for record types
</I>&gt;&gt;<i> ['P_access', BLAHBLAHBLAH deleted]
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 2&gt; {ok, Conn} = amqp_connection:start(network). %% start connection
</I>&gt;&gt;<i> {ok,&lt;0.48.0&gt;}
</I>&gt;&gt;<i> 3&gt; {ok, Chan} = amqp_connection:open_channel(Conn). %% open channel
</I>&gt;&gt;<i> {ok,&lt;0.58.0&gt;}
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 4&gt; ED = #'exchange.declare'{exchange= &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,type= &lt;&lt;&quot;topic&quot;&gt;&gt;}. %% declare topic exchange
</I>&gt;&gt;<i> #'exchange.declare'{ticket = 0,exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,
</I>&gt;&gt;<i>                   type = &lt;&lt;&quot;topic&quot;&gt;&gt;,passive = false,durable = false,
</I>&gt;&gt;<i>                   auto_delete = false,internal = false,nowait = false,
</I>&gt;&gt;<i>                   arguments = []}
</I>&gt;&gt;<i> 5&gt; amqp_channel:call(Chan,ED).
</I>&gt;&gt;<i> #'exchange.declare_ok'{}
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_exchanges
</I>&gt;&gt;<i> Listing exchanges ...
</I>&gt;&gt;<i> amq.direct
</I>&gt;&gt;<i> direct
</I>&gt;&gt;<i> amq.topic
</I>&gt;&gt;<i> topic
</I>&gt;&gt;<i> my_exchange
</I>&gt;&gt;<i> topic
</I>&gt;&gt;<i> amq.rabbitmq.log
</I>&gt;&gt;<i> topic
</I>&gt;&gt;<i> amq.fanout
</I>&gt;&gt;<i> fanout
</I>&gt;&gt;<i> amq.headers
</I>&gt;&gt;<i> headers
</I>&gt;&gt;<i> direct
</I>&gt;&gt;<i> amq.match
</I>&gt;&gt;<i> headers
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 6&gt; QD1 = #'queue.declare'{queue = &lt;&lt;&quot;queue_1&quot;&gt;&gt;}. %% One queue...
</I>&gt;&gt;<i> #'queue.declare'{ticket = 0,queue = &lt;&lt;&quot;queue_1&quot;&gt;&gt;,
</I>&gt;&gt;<i>                passive = false,durable = false,exclusive = false,
</I>&gt;&gt;<i>                auto_delete = false,nowait = false,arguments = []}
</I>&gt;&gt;<i> 7&gt; QD2 = #'queue.declare'{queue = &lt;&lt;&quot;queue_2&quot;&gt;&gt;}. %% Another queue...
</I>&gt;&gt;<i> #'queue.declare'{ticket = 0,queue = &lt;&lt;&quot;queue_2&quot;&gt;&gt;,
</I>&gt;&gt;<i>                passive = false,durable = false,exclusive = false,
</I>&gt;&gt;<i>                auto_delete = false,nowait = false,arguments = []}
</I>&gt;&gt;<i> 8&gt; amqp_channel:call(Chan, QD1). %% Create first queue...
</I>&gt;&gt;<i> #'queue.declare_ok'{queue = &lt;&lt;&quot;queue_1&quot;&gt;&gt;,message_count = 0,
</I>&gt;&gt;<i>                   consumer_count = 0}
</I>&gt;&gt;<i> 9&gt; amqp_channel:call(Chan, QD2). %% Create second queue...
</I>&gt;&gt;<i> #'queue.declare_ok'{queue = &lt;&lt;&quot;queue_2&quot;&gt;&gt;,message_count = 0,
</I>&gt;&gt;<i>                   consumer_count = 0}
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queues
</I>&gt;&gt;<i> Listing queues ...
</I>&gt;&gt;<i> queue_2 0
</I>&gt;&gt;<i> queue_1 0
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 10&gt; B1 = #'queue.bind'{queue= &lt;&lt;&quot;queue_1&quot;&gt;&gt;, exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;, routing_key = &lt;&lt;&quot;company.#&quot;&gt;&gt;}. %% Bind first queue to exchange...
</I>&gt;&gt;<i> #'queue.bind'{ticket = 0,queue = &lt;&lt;&quot;queue_1&quot;&gt;&gt;,
</I>&gt;&gt;<i>             exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,routing_key = &lt;&lt;&quot;company.#&quot;&gt;&gt;,
</I>&gt;&gt;<i>             nowait = false,arguments = []}
</I>&gt;&gt;<i> 11&gt; B2 = #'queue.bind'{queue= &lt;&lt;&quot;queue_2&quot;&gt;&gt;, exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;, routing_key = &lt;&lt;&quot;company.#&quot;&gt;&gt;}. %% Bind second queue to exchange...
</I>&gt;&gt;<i> #'queue.bind'{ticket = 0,queue = &lt;&lt;&quot;queue_2&quot;&gt;&gt;,
</I>&gt;&gt;<i>             exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,routing_key = &lt;&lt;&quot;company.#&quot;&gt;&gt;,
</I>&gt;&gt;<i>             nowait = false,arguments = []}
</I>&gt;&gt;<i> 12&gt; amqp_channel:call(Chan,B1). amqp_channel:call(Chan,B2).
</I>&gt;&gt;<i> #'queue.bind_ok'{}
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_bindings
</I>&gt;&gt;<i> Listing bindings ...
</I>&gt;&gt;<i> exchange queue_1 queue queue_1 []
</I>&gt;&gt;<i> exchange queue_2 queue queue_2 []
</I>&gt;&gt;<i> my_exchange exchange queue_1 queue company.# []
</I>&gt;&gt;<i> my_exchange exchange queue_2 queue company.# []
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queuesListing queues ...
</I>&gt;&gt;<i> queue_2 0  &lt;--  NOTE NO MESSAGES IN THESE QUEUES!
</I>&gt;&gt;<i> queue_1 0  &lt;--/
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 14&gt; Payload = &lt;&lt;&quot;foobar&quot;&gt;&gt;. %% Bogus message payload
</I>&gt;&gt;<i> &lt;&lt;&quot;foobar&quot;&gt;&gt;
</I>&gt;&gt;<i> 15&gt; Publish = #'basic.publish'{exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;, routing_key = &lt;&lt;&quot;company.MSFT&quot;&gt;&gt;}.
</I>&gt;&gt;<i> #'basic.publish'{ticket = 0,exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,
</I>&gt;&gt;<i>                routing_key = &lt;&lt;&quot;company.MSFT&quot;&gt;&gt;,mandatory = false,
</I>&gt;&gt;<i>                immediate = false}
</I>&gt;&gt;<i> 16&gt; amqp_channel:cast(Chan, Publish, #amqp_msg{payload=Payload}). %% Publish to the exchange, should go to both bound queues...
</I>&gt;&gt;<i> ok
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queues
</I>&gt;&gt;<i> Listing queues ...
</I>&gt;&gt;<i> queue_2 1  &lt;-- OUR MESSAGE ARRIVED...
</I>&gt;&gt;<i> queue_1 1  &lt;-- ...IN BOTH QUEUES.
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 17&gt; amqp_channel:cast(Chan, Publish, #amqp_msg{payload=Payload}). %% Publish to exchange again, should also go to both bound queues...
</I>&gt;&gt;<i> ok
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queuesListing queues ...
</I>&gt;&gt;<i> queue_2 2  &lt;-- SECOND PUBLISHED MESSAGE ARRIVED...
</I>&gt;&gt;<i> queue_1 2  &lt;-- ...ALSO IN BOTH QUEUES.
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 22&gt; WPZ = #'basic.publish'{exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;, routing_key = &lt;&lt;&quot;company&quot;&gt;&gt;}.
</I>&gt;&gt;<i> #'basic.publish'{ticket = 0,exchange = &lt;&lt;&quot;my_exchange&quot;&gt;&gt;,
</I>&gt;&gt;<i>                routing_key = &lt;&lt;&quot;company&quot;&gt;&gt;,mandatory = false,
</I>&gt;&gt;<i>                immediate = false}
</I>&gt;&gt;<i> 23&gt; amqp_channel:cast(Chan, WPZ, #amqp_msg{payload = &lt;&lt;&quot;Payload&quot;&gt;&gt;}).
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jerryk at strongmad</A> .../co/rabbitmq-umbrella/rabbitmq-server]$ ./scripts/rabbitmqctl list_queuesListing queues ...
</I>&gt;&gt;<i> queue_2 3  &lt;-- SECOND PUBLISHED MESSAGE ARRIVED...
</I>&gt;&gt;<i> queue_1 3  &lt;-- ...ALSO IN BOTH QUEUES.
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010247.html">[rabbitmq-discuss] using a topic exchange to route to	multiple queues
</A></li>
	<LI>Next message: <A HREF="010238.html">[rabbitmq-discuss] PHP app needs amqp statistics for reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10249">[ date ]</a>
              <a href="thread.html#10249">[ thread ]</a>
              <a href="subject.html#10249">[ subject ]</a>
              <a href="author.html#10249">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
