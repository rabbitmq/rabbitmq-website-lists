<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] STOMP plugin, changes, usage example in python
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20STOMP%20plugin%2C%20changes%2C%20usage%20example%20in%20python&In-Reply-To=%3C1999435382.1606.1292525892922.JavaMail.root%40zimbra%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010410.html">
   <LINK REL="Next"  HREF="010421.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] STOMP plugin, changes, usage example in python</H1>
    <B>Matt Miller</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20STOMP%20plugin%2C%20changes%2C%20usage%20example%20in%20python&In-Reply-To=%3C1999435382.1606.1292525892922.JavaMail.root%40zimbra%3E"
       TITLE="[rabbitmq-discuss] STOMP plugin, changes, usage example in python">matt at mydomedia.com
       </A><BR>
    <I>Thu Dec 16 18:58:12 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010410.html">[rabbitmq-discuss] error: &quot;Pipelining of requests forbidden&quot; on C# client
</A></li>
        <LI>Next message: <A HREF="010421.html">[rabbitmq-discuss] STOMP plugin, changes,	usage example in python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10411">[ date ]</a>
              <a href="thread.html#10411">[ thread ]</a>
              <a href="subject.html#10411">[ subject ]</a>
              <a href="author.html#10411">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Greetings,

I have been using the STOMP gateway plugin for RabbitMQ 2.1.1 for some time, and it works great. The only hurdles I had in the past was a lack of documentation and usage examples. I believe part of the reason is the volatility of the protocol specification itself..?

That being said, the most recent upgrade I preformed borked my implementation. Of course this was just testing and thank goodness this update was not preformed on my production environment. 

I am currently using the stomp python script from codehaus. My python source for the wrapper is at the bottom of this email.

The code runs as is 2.1.1, and will receive broadcast style messages. The code does not function correctly against the 2.2.0 release, I receive a:

ListenerException: Error received headers:{'message': 'Unknown destination', 'content-type': 'text/plain', 'content-length': '86'}, message:'' is not a valid destination.
Valid exchange types are: /exchange, /topic or /queue.
 
To remedy the error I changed my subscription line to include '/topic' as the destination. 

My only concern is that this may change again in the future. Why did this change? 

Thanks,
Matt 



&quot;&quot;&quot; Heleper function for listening to an update via STOMP
&quot;&quot;&quot;
import json
import stomp
import logging

from uuid import uuid1

LOG_FILENAME = 'stomp.log'
logging.basicConfig(filename=LOG_FILENAME,level=logging.DEBUG)

stomp_logger = logging.getLogger('stomp')

class ListenerException(Exception):
    pass

class MsgReceiver(stomp.ConnectionListener):
    def __init__(self, callback=None):
        if callback is not None:
            self.callback = callback
    def on_error(self, headers, message):
        raise ListenerException(&quot;Error received headers:%s, message:%s &quot; % (headers, message))
    def on_message(self, headers, message):
        #self.callback(headers, message) 
        stomp_logger.info(&quot;Message received: (headers:%s) %s&quot; % (headers, message))

class Listener (object):

    host = &quot;localhost&quot;
    port = 61613
    user = &quot;guest&quot;
    passw = &quot;guest&quot;


    def __init__(self, callback=None, *args, **kwargs):
        
        if hasattr(self, 'conn'):
            if self.conn.is_connected():
                self.conn.disconnect()
        if not callback:
            raise Exception(&quot;Please specify a callback function&quot;)

        self.host = kwargs.get('host') if kwargs.get('host') else self.host
        self.user = kwargs.get('user') if kwargs.get('user') else self.user
        self.passw = kwargs.get('passw') if kwargs.get('passw') else self.passw
        self.port = kwargs.get('port') if kwargs.get('port') else self.port

        # build the stomp connection XXX: Add error handling 
        self.conn = stomp.Connection(
                [(self.host, self.port)], 
                self.user, self.passw
                )

        self.conn.set_listener('callback-%s' % uuid1(), MsgReceiver(callback))
        self.conn.start()
        self.conn.connect()

    def add_thing(self):
        if self.conn.is_connected():
            self.conn.subscribe(
                    destination=&quot;&quot;,
                    exchange=&quot;amq.topic&quot;, 
                    routing_key=&quot;#&quot;)

    def close(self):
        if self.conn.is_connected():
            self.conn.disconnect()
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010410.html">[rabbitmq-discuss] error: &quot;Pipelining of requests forbidden&quot; on C# client
</A></li>
	<LI>Next message: <A HREF="010421.html">[rabbitmq-discuss] STOMP plugin, changes,	usage example in python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10411">[ date ]</a>
              <a href="thread.html#10411">[ thread ]</a>
              <a href="subject.html#10411">[ subject ]</a>
              <a href="author.html#10411">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
