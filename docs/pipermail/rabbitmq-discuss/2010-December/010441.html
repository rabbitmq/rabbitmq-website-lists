<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 2.0 broker crashes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%202.0%20broker%20crashes&In-Reply-To=%3CAANLkTi%3DK62vn%2Btue35MfHyGzjpbmNxOJrNnkkzP5%3DnF2%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010439.html">
   <LINK REL="Next"  HREF="010442.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 2.0 broker crashes</H1>
    <B>Scott Dupoy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%202.0%20broker%20crashes&In-Reply-To=%3CAANLkTi%3DK62vn%2Btue35MfHyGzjpbmNxOJrNnkkzP5%3DnF2%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ 2.0 broker crashes">scottdupoy at gmail.com
       </A><BR>
    <I>Mon Dec 20 13:28:16 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010439.html">[rabbitmq-discuss] Question: where is the file when the messages are saved to disk.
</A></li>
        <LI>Next message: <A HREF="010442.html">[rabbitmq-discuss] RabbitMQ 2.0 broker crashes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10441">[ date ]</a>
              <a href="thread.html#10441">[ thread ]</a>
              <a href="subject.html#10441">[ subject ]</a>
              <a href="author.html#10441">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

My broker is crashing in a reproducible way.  I'm running RabbitMQ 2.0 on a
32-bit version of Erlang on a 64-bit Windows Server 2008 R2 installation.

The management and webhooks plugins are installed.  I also have some code
periodically checking the broker internals via OTP.

The broker crashes if a queue builds up to the extent that messages have to
be persisted to msg_store_transient, and then a consumer quickly starts
consuming all the messages from that queue.  It's as if the broker is still
near the limit of its available memory then tries to reload a large chunk of
the cached messages from msg_store_transient.  This pushes it over some hard
limit and down it goes.

I've turned on memory alarms and for the purposes of debugging reduced the
memory high watermark to 0.05 (the system has 2gb).  With these settings a
cache of ~30,000 relatively small messages is sufficient to cause the
problem.

The main log messages are as follows.  I can send the dump log if necessary
too.

I've seen the release notes for 2.2 and wondered if the &quot;fix queue memory
leak when using the management plugin or other consumers of queue
statistics&quot; might be a related issue?

<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-November/010172.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-November/010172.html</A>

Any help would be much appreciated!

Thanks,
Scott



debug log:

Crash dump was written to: c:/rabbit/erl_crash.dump
eheap_alloc: Cannot allocate 583848200 bytes of memory (of type &quot;heap&quot;).



node log (<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at whatever.log</A>):


=INFO REPORT==== 20-Dec-2010::12:52:13 ===
vm_memory_high_watermark set. Memory used:108708800 allowed:107350835

=INFO REPORT==== 20-Dec-2010::12:52:13 ===
    alarm_handler: {set,{vm_memory_high_watermark,[]}}

=INFO REPORT==== 20-Dec-2010::12:52:14 ===
vm_memory_high_watermark clear. Memory used:94399608 allowed:107350835

=INFO REPORT==== 20-Dec-2010::12:52:14 ===
    alarm_handler: {clear,vm_memory_high_watermark}

=ERROR REPORT==== 20-Dec-2010::12:52:20 ===
** Generic server msg_store_transient terminating
** Last message in was {'$gen_cast',
                           {remove,
                               [&lt;&lt;207,102,51,195,33,4,26,173,150,95,132,22,
                                  186,26,230,252&gt;&gt;]}}
** When Server state == {msstate,
                            &quot;c:/rabbit/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">RabbitMQ at VMRMQ1-mnesia</A>
/msg_store_transient&quot;,
                            rabbit_msg_store_ets_index,
                            {state,151612,
                                &quot;c:/rabbit/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">RabbitMQ at VMRMQ1-mnesia</A>
/msg_store_transient&quot;},
                            6,#Ref&lt;0.0.0.7537&gt;,
                            {dict,0,16,16,8,80,48,

{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            [],undefined,85671623,103928228,[],false,
                            &lt;0.237.0&gt;,159806,147515,155709,163903,
                            {set,2,16,16,8,80,48,

{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},

{{[&lt;&lt;76,144,119,142,103,20,191,166,92,52,177,
                                     137,37,253,53,198&gt;&gt;],
                                  [],[],[],[],[],[],[],[],
                                  [&lt;&lt;97,19,25,60,105,158,160,68,116,178,239,
                                     127,59,191,208,161&gt;&gt;],
                                  [],[],[],[],[],[]}}},
                            false,16777216}
** Reason for termination ==
** {{badmatch,{error,eacces}},
    [{rabbit_msg_store,delete_file_if_empty,2},
     {rabbit_msg_store,remove_message,2},
     {lists,foldl,3},
     {rabbit_msg_store,handle_cast,2},
     {gen_server2,handle_msg,7},
     {proc_lib,wake_up,3}]}

=INFO REPORT==== 20-Dec-2010::12:52:26 ===
stopped TCP Listener on 0.0.0.0:5672

=INFO REPORT==== 20-Dec-2010::12:52:26 ===
closing TCP connection &lt;0.6768.0&gt; from 172.20.5.35:55230

=INFO REPORT==== 20-Dec-2010::12:52:26 ===
closing TCP connection &lt;0.521.0&gt; from 172.20.5.35:55101

=INFO REPORT==== 20-Dec-2010::12:52:26 ===
closing TCP connection &lt;0.309.0&gt; from 172.22.1.5:56205

=INFO REPORT==== 20-Dec-2010::12:52:26 ===
vm_memory_high_watermark set. Memory used:177922856 allowed:107350835

=INFO REPORT==== 20-Dec-2010::12:52:26 ===
    alarm_handler: {set,{vm_memory_high_watermark,[]}}



sasl log:


=CRASH REPORT==== 20-Dec-2010::12:52:23 ===
  crasher:
    initial call: gen:init_it/7
    pid: &lt;0.235.0&gt;
    registered_name: msg_store_transient
    exception exit: {{badmatch,{error,eacces}},
                     [{rabbit_msg_store,delete_file_if_empty,2},
                      {rabbit_msg_store,remove_message,2},
                      {lists,foldl,3},
                      {rabbit_msg_store,handle_cast,2},
                      {gen_server2,handle_msg,7},
                      {proc_lib,wake_up,3}]}
      in function  gen_server2:terminate/6
    ancestors: [rabbit_sup,&lt;0.186.0&gt;]
    messages: [{'$gen_cast',
                      {remove,
                          [&lt;&lt;116,2,44,89,198,13,221,58,18,13,147,52,79,55,
                             101,76&gt;&gt;]}},
                  {'$gen_cast',
                      {remove,
                          [&lt;&lt;93,225,245,186,89,105,207,141,190,8,167,133,
                             251,196,229,169&gt;&gt;]}},
                  {'$gen_cast',
                      {remove,
                          [&lt;&lt;36,45,179,241,82,8,235,59,130,71,81,223,19,89,
                             23,159&gt;&gt;]}},
[...]
                  {'$gen_cast',
                      {remove,

[&lt;&lt;93,226,119,14,115,208,16,0,35,241,8,153,128,173,
                             33,46&gt;&gt;,

&lt;&lt;102,18,229,215,103,192,214,80,241,21,240,138,35,
                             33,210,8&gt;&gt;,

&lt;&lt;144,39,170,218,61,5,23,24,234,156,43,154,63,104,
                             46,233&gt;&gt;,
                           &lt;&lt;201,4,128,74,48,234,192,77,11,64,58,124,146,64,
                             196,108&gt;&gt;,

&lt;&lt;103,56,91,19,0,9,57,136,201,83,73,171,214,48,76,
                             227&gt;&gt;,
[...]
                           &lt;&lt;28,5,2,76,231,115,160,56,192,101,127,47,74,105,
                             103,102&gt;&gt;,

&lt;&lt;49,236,73,20,167,156,137,55,109,184,47,56,116,237,
                             53,9&gt;&gt;,
                           &lt;&lt;&quot;&#205;&#191;&#229;&#250;|&#162;&#220;&#182;1&#225;%\b4 ,%&quot;&gt;&gt;]}}]
    links: [&lt;0.187.0&gt;]
    dictionary: [{fhc_age_tree,{0,nil}}]
    trap_exit: true
    status: running
    heap_size: 121393
    stack_size: 24
    reductions: 19087946
  neighbours:

=SUPERVISOR REPORT==== 20-Dec-2010::12:52:26 ===
     Supervisor: {local,rabbit_sup}
     Context:    child_terminated
     Reason:     {{badmatch,{error,eacces}},
                  [{rabbit_msg_store,delete_file_if_empty,2},
                   {rabbit_msg_store,remove_message,2},
                   {lists,foldl,3},
                   {rabbit_msg_store,handle_cast,2},
                   {gen_server2,handle_msg,7},
                   {proc_lib,wake_up,3}]}
     Offender:   [{pid,&lt;0.235.0&gt;},
                  {name,msg_store_transient},
                  {mfa,
                      {rabbit_msg_store,start_link,
                          [msg_store_transient,
                           &quot;c:/rabbit/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">RabbitMQ at VMRMQ1-mnesia</A>&quot;,undefined,
                           {#Fun&lt;rabbit_variable_queue.0.52678393&gt;,ok}]}},
                  {restart_type,transient},
                  {shutdown,4294967295},
                  {child_type,worker}]


=SUPERVISOR REPORT==== 20-Dec-2010::12:52:26 ===
     Supervisor: {local,rabbit_sup}
     Context:    shutdown
     Reason:     reached_max_restart_intensity
     Offender:   [{pid,&lt;0.235.0&gt;},
                  {name,msg_store_transient},
                  {mfa,
                      {rabbit_msg_store,start_link,
                          [msg_store_transient,
                           &quot;c:/rabbit/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">RabbitMQ at VMRMQ1-mnesia</A>&quot;,undefined,
                           {#Fun&lt;rabbit_variable_queue.0.52678393&gt;,ok}]}},
                  {restart_type,transient},
                  {shutdown,4294967295},
                  {child_type,worker}]
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20101220/c118d218/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20101220/c118d218/attachment.htm</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010439.html">[rabbitmq-discuss] Question: where is the file when the messages are saved to disk.
</A></li>
	<LI>Next message: <A HREF="010442.html">[rabbitmq-discuss] RabbitMQ 2.0 broker crashes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10441">[ date ]</a>
              <a href="thread.html#10441">[ thread ]</a>
              <a href="subject.html#10441">[ subject ]</a>
              <a href="author.html#10441">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
