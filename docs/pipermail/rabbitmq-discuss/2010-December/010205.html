<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Routing key questions/suggestions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Routing%20key%20questions/suggestions&In-Reply-To=%3C7BBB84E4-688D-41C5-AFD7-E7A18313546F%40mozilla.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010204.html">
   <LINK REL="Next"  HREF="010212.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Routing key questions/suggestions</H1>
    <B>Christian Legnitto</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Routing%20key%20questions/suggestions&In-Reply-To=%3C7BBB84E4-688D-41C5-AFD7-E7A18313546F%40mozilla.com%3E"
       TITLE="[rabbitmq-discuss] Routing key questions/suggestions">clegnitto at mozilla.com
       </A><BR>
    <I>Wed Dec  1 17:32:59 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010204.html">[rabbitmq-discuss] Routing key questions/suggestions
</A></li>
        <LI>Next message: <A HREF="010212.html">[rabbitmq-discuss] Routing key questions/suggestions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10205">[ date ]</a>
              <a href="thread.html#10205">[ thread ]</a>
              <a href="subject.html#10205">[ subject ]</a>
              <a href="author.html#10205">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>(meant to send this yesterday but it didn't go through)

On Nov 30, 2010, at 10:06 AM, Matthew Sackman wrote:

&gt;<i> On Tue, Nov 30, 2010 at 09:43:49AM -0800, Christian Legnitto wrote:
</I>&gt;&gt;<i> 1. Why use &quot;.&quot; as the routing token separator?
</I>&gt;<i> 
</I>&gt;<i> Well, something has to be chosen, and whatever is chosen is going to be
</I>&gt;<i> inconvenient for someone. I don't know whether there was some reason to
</I>&gt;<i> choose . over anything else.
</I>
Yeah, I guess this was inspiration from jms stuff?

&gt;<i> 
</I>&gt;&gt;<i> Can we make it configurable on the broker?
</I>&gt;<i> 
</I>&gt;<i> Well, it's only code. Having had a quick look through, it seems like the
</I>&gt;<i> splitting is currently only done at the use point. So I reckon maybe the
</I>&gt;<i> only change that's needed is in rabbit_exchange_type_topic.erl, change
</I>&gt;<i> the split_topic_key/1 fun to split on whatever you want.
</I>
Ok, this might be a way to go. Of course, it would lock me into one implementation and is getting away from the AMQP standard.

&gt;<i> 
</I>&gt;&gt;<i> Can we support sending a magic X-AMQP-ROUTING-SEPERATOR or something
</I>&gt;&gt;<i> header with the message so it can be anything and vary by message?
</I>&gt;<i> 
</I>&gt;<i> Erm that would be substantially more complex.
</I>
Yep, but it seems like an interesting way go. That way the publisher can alter the separator based on data. If any routing key tokens have a &quot;.&quot;, pick a character that doesn't exist in any of them. When specifying a binding, perhaps use something ugly like foo[:split:]bar[:split:]baz or foo&gt;&gt;bar&gt;&gt;baz or [foo][bar][baz]...or have a way to escape &quot;.&quot; and translate any real &quot;.&quot; separator into the message specified one. (Note that Matthew had a better suggestion)

I don't know, just throwing cold medicine infused ideas out there ha.

&gt;<i> 
</I>&gt;&gt;<i> 	* It seems like an odd choice to use a character that will show
</I>&gt;&gt;<i> 	up in data a lot
</I>&gt;<i> 
</I>&gt;<i> True. Maybe , would be a better choice given most programming languages
</I>&gt;<i> use , to separate list elements anyway.
</I>
For my data this would definitely have been a better choice, though other data sets would likely have a problem. I think it's best to let people choose (I'd actually probably choose one of &gt;~| if it had to be one character). (Note that Matthew had a better suggestion)

&gt;<i> 
</I>&gt;&gt;<i> Example:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I'm listening to commit messages from GitHub. My binding is
</I>&gt;&gt;<i> github.push.*.mycoolproject, which means I want to listen to all push
</I>&gt;&gt;<i> messages by anyone for a project named mycoolproject. If someone's
</I>&gt;&gt;<i> github username has a period in it though, I won't see the messages
</I>&gt;&gt;<i> (github.push.john.smith.mycoolproject). If I bound with
</I>&gt;&gt;<i> github.push.#.mycoolproject I would see the previous message, but I
</I>&gt;&gt;<i> might also get messages for other projects with GitHub users that have
</I>&gt;&gt;<i> mycoolproject in their username
</I>&gt;&gt;<i> (github.push.this.is.mycoolproject.user.project2). I know this isn't
</I>&gt;&gt;<i> the best example, but I'm sick and my head is a bit murky ha.
</I>&gt;<i> 
</I>&gt;<i> Yeah, I know the feeling :/ As I said, _any_ choice is ultimately going
</I>&gt;<i> to collide with something else so you're always going to have to do some
</I>&gt;<i> sort of encoding / escaping yourself. It looks like AMQP doesn't support
</I>&gt;<i> any sort of escaping to prevent the . being interpreted as a semantic .
</I>&gt;<i> so you really are going to have to do translation to something other
</I>&gt;<i> than .
</I>&gt;<i> 
</I>&gt;<i> If, in your case, there is no character that cannot appear in a github
</I>&gt;<i> username (and I'd hope not - surely the whole web supports every unicode
</I>&gt;<i> code point by now...) then you're just not going to be able to solve
</I>&gt;<i> this. This possibly points to AMQP needing to change to support escaping
</I>&gt;<i> of . with a \
</I>
Yeah, I figured that was the case. Unfortunately translation ties binding specification to a particular producer/consumer escape mechanism. That is, if my producer escapes &quot;.&quot; by replacing it with &quot;[:dot:]&quot;, when I bind to &quot;github.push.jim.bob.mycoolproject&quot; I would have to use &quot;github.push.jim[:dot:]bob.mycoolproject&quot;. If later I wanted to change this on the producer side (or say I use a 3rd party producer like gitub that doesn't escape the same way) I'd have to modify all the bindings. This is probably an acceptable tradeoff though.

&gt;<i> 
</I>&gt;&gt;<i> 2. Are there are future plans to publish a message with multiple routing keys?
</I>&gt;<i> 
</I>&gt;<i> Not that I'm aware of.
</I>&gt;<i> 
</I>&gt;&gt;<i> 	* I know I can publish the same message multiple times with different routing keys, seems inefficient
</I>&gt;<i> 
</I>&gt;<i> Indeed.
</I>&gt;<i> 
</I>&gt;&gt;<i> For bugzilla messages, when someone changes a bug I send a
</I>&gt;&gt;<i> bug.changed.[field] message. Many tools want to pivot on specific
</I>&gt;&gt;<i> users though. It'd be nice to publish them also as
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">bzuser at example.com.changed.bug</A> so those tools don't have to listen to
</I>&gt;&gt;<i> all changes and group by user themselves, which seems very
</I>&gt;&gt;<i> inefficient.
</I>&gt;<i> 
</I>&gt;<i> You could put _everything_ in the routing key.
</I>&gt;<i> $USER.$BUG_NUMBER.$FIELD
</I>&gt;<i> and then the different tools just need to choose where to put # and *.
</I>&gt;<i> If you prefix each field value with the field name then it ensures that
</I>&gt;<i> such binding keys can anchor in the right place which is useful when the
</I>&gt;<i> range of fields overlap. Eg QA and Assign fields - if you were trying to
</I>&gt;<i> match changes by me to bugs, you'd be ill-advised to just do #.matthew.#
</I>&gt;<i> given that that would match changes _not_ by me but for bugs where I'm
</I>&gt;<i> the QA or assignee. Thus a key of:
</I>&gt;<i> 
</I>&gt;<i> user.matthew.bug.12345.qa.matthew.assignee.matthew.field.status
</I>&gt;<i> 
</I>&gt;<i> then allows a much more precise match of #.qa.matthew.# for example.
</I>
Ah, I never really thought of this as I have been trying to treat the routing keys as hierarchical constructs. This feels a bit hacky but will likely work. Do you see other use cases that would support sending multiple routing keys with a given message?

Looks like what I want is a way for consumers to listen to certain key/value pairs in the message. Of course, AMQP isn't set up for that and the broker would need to know about the message formats to do the routing. Using multiple routing keys is pretty much just approximating k/v lookup w/o the broker needing to know about the message payload:

* user.matthew  -&gt; key = user, value = matthew
* bug.12345 -&gt; key = bug, value = 12345
* status.changed -&gt; key = status, value =changed

 I'll play around with your suggestion. Of course, the more data I put in the key the more I come back to my question #1 above :-)

Thanks for the quick response!

Christian


</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010204.html">[rabbitmq-discuss] Routing key questions/suggestions
</A></li>
	<LI>Next message: <A HREF="010212.html">[rabbitmq-discuss] Routing key questions/suggestions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10205">[ date ]</a>
              <a href="thread.html#10205">[ thread ]</a>
              <a href="subject.html#10205">[ subject ]</a>
              <a href="author.html#10205">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
