<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] opposite of basicAck?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20opposite%20of%20basicAck%3F&In-Reply-To=84fb38e30906250957od213dfl139022812d19a57a%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003914.html">
   <LINK REL="Next"  HREF="003919.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] opposite of basicAck?</H1>
    <B>Valentino Volonghi</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20opposite%20of%20basicAck%3F&In-Reply-To=84fb38e30906250957od213dfl139022812d19a57a%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] opposite of basicAck?">dialtone at gmail.com
       </A><BR>
    <I>Thu Jun 25 20:20:04 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="003914.html">[rabbitmq-discuss] opposite of basicAck?
</A></li>
        <LI>Next message: <A HREF="003919.html">[rabbitmq-discuss] Thank You
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3915">[ date ]</a>
              <a href="thread.html#3915">[ thread ]</a>
              <a href="subject.html#3915">[ subject ]</a>
              <a href="author.html#3915">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Jun 25, 2009, at 9:57 AM, tsuraan wrote:

&gt;<i> If I have a message that I know that I don't want to handle right now,
</I>&gt;<i> is there something like basicAck that rejects a deliveryTag instead of
</I>&gt;<i> acking it?  IIRC, after some timeout, or a channel close, the message
</I>&gt;<i> will be queued for redelivery, but I have a case where I know that a
</I>&gt;<i> message I received isn't useful for me yet, so I'd like to immediately
</I>&gt;<i> reject it so I can pick it up later.  Is that possible?
</I>

Not really I suppose. Unless some exchange is created that delivers
messages in a future date.

This incidentally is a problem that I'm dealing with in quebert.

<A HREF="http://bitbucket.org/adroll/quebert/src/tip/quebert/amqp.py#cl-140">http://bitbucket.org/adroll/quebert/src/tip/quebert/amqp.py#cl-140</A>

There are a bunch of ways in which you could try to deal with the  
problem,
and I still haven't figured out which one is the best one... But  
essentially
you could (with your wanted variations):

If there is a prefetch count set to X:
   Option A:
       - Only after an exception raise X to X+1
       - Backoff an arbitrary delay (exponentially or fixed)
       - call basic_recover (with requeue=True if you want it  
redelivered
                                            potentially to any queue)
       - decrease X+1 back to X

   Option B:
      - After &quot;timeout&quot; time passed raise X to X+1
      - When the message that is taking the timeout has finished
         waiting call basic_recover (same options as above)
     - decrease X+1 to X

If there's no prefetch simply hold the message unackd for your preferred
delay.

Currently in quebert I implemented option B. But that's suboptimal for
tasks that actually take long because they are heavy and increasing
the number of prefetches might not be good because with few machines
it might end up clogging those few workers and grow indefinitely (if all
tasks in the worst case go to timeout).

If I can find a clean way in my code to implement Option A I would go  
for
it... But a simple exception might not be good enough... I dunno, plus  
it's
hard to keep the &quot;event handler&quot; fully separated from amqp when, in  
order
to increase/decrease the prefetch window it needs access to the  
channel...

Agh... My head is already hurting...

--
Valentino Volonghi aka Dialtone
Now running MacOS X 10.5
Home Page: <A HREF="http://www.twisted.it">http://www.twisted.it</A>
<A HREF="http://www.adroll.com">http://www.adroll.com</A>

-------------- next part --------------
A non-text attachment was scrubbed...
Name: PGP.sig
Type: application/pgp-signature
Size: 194 bytes
Desc: This is a digitally signed message part
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090625/2efa48a1/attachment.pgp">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090625/2efa48a1/attachment.pgp</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003914.html">[rabbitmq-discuss] opposite of basicAck?
</A></li>
	<LI>Next message: <A HREF="003919.html">[rabbitmq-discuss] Thank You
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3915">[ date ]</a>
              <a href="thread.html#3915">[ thread ]</a>
              <a href="subject.html#3915">[ subject ]</a>
              <a href="author.html#3915">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
