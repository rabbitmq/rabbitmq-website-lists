<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Looking for some clarification on mirrored queue implementation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Looking%20for%20some%20clarification%20on%20mirrored%0A%20queue%20implementation&In-Reply-To=%3C4F315CFE.5010004%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017957.html">
   <LINK REL="Next"  HREF="017999.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Looking for some clarification on mirrored queue implementation</H1>
    <B>Emile Joubert</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Looking%20for%20some%20clarification%20on%20mirrored%0A%20queue%20implementation&In-Reply-To=%3C4F315CFE.5010004%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Looking for some clarification on mirrored queue implementation">emile at rabbitmq.com
       </A><BR>
    <I>Tue Feb  7 17:18:54 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017957.html">[rabbitmq-discuss] Looking for some clarification on mirrored queue	implementation
</A></li>
        <LI>Next message: <A HREF="017999.html">[rabbitmq-discuss] Looking for some clarification on mirrored queue implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17996">[ date ]</a>
              <a href="thread.html#17996">[ thread ]</a>
              <a href="subject.html#17996">[ subject ]</a>
              <a href="author.html#17996">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matt,

On 06/02/12 19:27, Matt Pietrek wrote:
&gt;<i> &quot;The slaves apply the operations that occur to the master in exactly the
</I>&gt;<i> same order as the master and thus maintain the same state. All actions
</I>&gt;<i> other than publishes go only to the master, and the master then
</I>&gt;<i> broadcasts the effect of the actions to the slaves. Thus clients
</I>&gt;<i> consuming from a mirrored queue are in fact consuming from the master.&quot;
</I>&gt;<i> 
</I>&gt;<i> and
</I>&gt;<i> 
</I>&gt;<i> &quot;messages published to a mirrored-queue are always published directly to
</I>&gt;<i> the master and all slaves.&quot;
</I>&gt;<i> --
</I>&gt;<i> 
</I>&gt;<i> One interpretation of the 2nd quote above (&quot;published directly to...&quot;)
</I>&gt;<i> is that clients are responsible for writing their messages to the master
</I>&gt;<i> *as well as* to all slaves. Perhaps there's some mechanism where at
</I>&gt;<i> connect time, the master sends a list of servers to the connecting
</I>&gt;<i> client, and the client writes to all instances in the list.
</I>
No, that won't work because the number of slaves can change over the
lifetime of the queue. Publishing clients are not required to alter
their behaviour if their messages are routed to mirrored queues.

&gt;<i> Other people have a different interpretation of how this works, which is
</I>&gt;<i> that publishes to *any* broker instances are forwarded by the receiving
</I>&gt;<i> slave to the master instance, which in turn pushes the publish requests
</I>&gt;<i> to all slaves. (Of course, if the master received the message initially,
</I>&gt;<i> there's no need for forwarding.)
</I>&gt;<i> 
</I>&gt;<i> Simple question: Which of the above interpretations is correct?
</I>
Neither. RabbitMQ uses a separate Erlang process per channel and this
channel process is responsible for sending publish messages to each
slave as well as the master. The slaves and master make use of a
separate fault-tolerant framework (Guaranteed Multicast) to communicate.
The master uses GM to communicate all messages (including publish
messages) to slaves. Slaves therefore receive publish messages from the
channel as well as GM, and all other messages from GM only.

&gt;<i> Follow up question: What is the exact flow for a publish that goes to a
</I>&gt;<i> slave? Does the slave do anything other than push the message to the
</I>&gt;<i> master, which in turn handles the message as if it came to the master in
</I>&gt;<i> the first place? Perhaps it writes the message to the local store first,
</I>&gt;<i> then pushes it to the master? (Like I said, spirited debate.)
</I>
Slaves do not push messages to the master. Slaves simply mimic the
actions of the master in order to have an identical copy of the queue.
The messages from the master over GM impose a consistent ordering across
all the queues.


The sources contain some further detail which may be of interest:
<A HREF="http://hg.rabbitmq.com/rabbitmq-server/file/default/src/rabbit_mirror_queue_coordinator.erl">http://hg.rabbitmq.com/rabbitmq-server/file/default/src/rabbit_mirror_queue_coordinator.erl</A>
<A HREF="http://hg.rabbitmq.com/rabbitmq-server/file/default/src/gm.erl">http://hg.rabbitmq.com/rabbitmq-server/file/default/src/gm.erl</A>



-Emile
</PRE>













































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017957.html">[rabbitmq-discuss] Looking for some clarification on mirrored queue	implementation
</A></li>
	<LI>Next message: <A HREF="017999.html">[rabbitmq-discuss] Looking for some clarification on mirrored queue implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17996">[ date ]</a>
              <a href="thread.html#17996">[ thread ]</a>
              <a href="subject.html#17996">[ subject ]</a>
              <a href="author.html#17996">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
