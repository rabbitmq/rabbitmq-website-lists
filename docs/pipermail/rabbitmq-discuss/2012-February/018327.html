<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Shovel config example with declare.queue with a x-ha-policy argument?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Shovel%20config%20example%20with%20declare.queue%0A%20with%20a%20x-ha-policy%20argument%3F&In-Reply-To=%3C33368593.post%40talk.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017998.html">
   <LINK REL="Next"  HREF="017904.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Shovel config example with declare.queue with a x-ha-policy argument?</H1>
    <B>Jerry Kuch</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Shovel%20config%20example%20with%20declare.queue%0A%20with%20a%20x-ha-policy%20argument%3F&In-Reply-To=%3C33368593.post%40talk.nabble.com%3E"
       TITLE="[rabbitmq-discuss] Shovel config example with declare.queue with a x-ha-policy argument?">jerryk at vmware.com
       </A><BR>
    <I>Wed Feb 22 03:24:43 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017998.html">[rabbitmq-discuss] Shovel config example with declare.queue with a x-ha-policy argument?
</A></li>
        <LI>Next message: <A HREF="017904.html">[rabbitmq-discuss] questions about rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18327">[ date ]</a>
              <a href="thread.html#18327">[ thread ]</a>
              <a href="subject.html#18327">[ subject ]</a>
              <a href="author.html#18327">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi, Lance and Elias...

As you've surmised, the access_refused errors you're seeing are to be
expected when you try to declare an already existing queue or exchange
whose properties don't 100% match what you're now asking for.  To
avoid the problem, you'll need to make sure all of the easy fields in
the Shovel config's declaration of the queue are exactly equal and
then deal with the optional arguments list which requires a bit of
care to encode.

The arguments list can be a bit tricky since it ultimately gets passed
through to the RabbitMQ Erlang client under the covers and I'm not
sure we document how to properly populate the arguments list with the
appropriate structures and type annotations anywhere.

Here are a couple of examples corresponding to x-ha-policy settings of
&quot;all&quot; and &quot;nodes&quot;.  In the case of the latter you also need a list of
nodes in the &quot;x-ha-policy-params&quot; argument.  The &quot;nodes&quot; example here
has a single node, but with a bit of care you can complete the pattern
using your own cluster's node names...  Snippets of the forms below
will replace the 'queue.declare' sections in your Shovel config:

Example 1:  &quot;all&quot; mirroring

        [{'queue.declare',
            [{queue, &lt;&lt;&quot;backup_orders&quot;&gt;&gt;},
             durable,
             {arguments, [{&lt;&lt;&quot;x-ha-policy&quot;&gt;&gt;,longstr,&lt;&lt;&quot;all&quot;&gt;&gt;}]}]},

Example 2: specified &quot;nodes&quot; mirroring

        [{'queue.declare',
          [{queue, &lt;&lt;&quot;backup_orders&quot;&gt;&gt;},
           durable,
           arguments, [{&lt;&lt;&quot;x-ha-policy-params&quot;&gt;&gt;,
                        array,
                        [{longstr,&lt;&lt;&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at StrongMad</A>&quot;&gt;&gt;}]},
                        {&lt;&lt;&quot;x-ha-policy&quot;&gt;&gt;,longstr,&lt;&lt;&quot;nodes&quot;&gt;&gt;}]}}]},

The key thing to note in the &quot;nodes&quot; case is that the we encode the
node's names as Erlang binaries, wrap the binaries up in tuples with 
the atom-label longstr in first position, and then store them in a list,
tagged with the atom array.

While looking at this I also noticed that the &quot;working shovel config&quot;
example we refer to on our website probably isn't all that working
anymore due to the auto_ack and tx_size settings it contains.  I've
let the authors of that file (and the book in which it will appear)
know that things may have changed and that they might want to
sanity check it...

Best regards,
Jerry



Lance-9 wrote:
&gt;<i> 
</I>&gt;<i> Hello all, I'm also looking for an example of Shovel with x-ha-policy.
</I>&gt;<i>  Looks like I'm getting access_refused errors connecting to the
</I>&gt;<i> destination
</I>&gt;<i> queue because I'm missing this parameter.  Is this a supported
</I>&gt;<i> configuration?
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>-- 
View this message in context: <A HREF="http://old.nabble.com/Shovel-config-example-with-declare.queue-with-a-x-ha-policy-argument--tp33258095p33368593.html">http://old.nabble.com/Shovel-config-example-with-declare.queue-with-a-x-ha-policy-argument--tp33258095p33368593.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017998.html">[rabbitmq-discuss] Shovel config example with declare.queue with a x-ha-policy argument?
</A></li>
	<LI>Next message: <A HREF="017904.html">[rabbitmq-discuss] questions about rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18327">[ date ]</a>
              <a href="thread.html#18327">[ thread ]</a>
              <a href="subject.html#18327">[ subject ]</a>
              <a href="author.html#18327">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
