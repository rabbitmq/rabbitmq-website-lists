<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Lost messages in HA tests in a cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lost%20messages%20in%20HA%20tests%20in%20a%20cluster&In-Reply-To=%3CCANVSfp%2BJbyp1%3DQF5KBXuQw2Nov2ibt26CxWDSzG4yM7vb3p6RA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="017833.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Lost messages in HA tests in a cluster</H1>
    <B>Pablo Molnar</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lost%20messages%20in%20HA%20tests%20in%20a%20cluster&In-Reply-To=%3CCANVSfp%2BJbyp1%3DQF5KBXuQw2Nov2ibt26CxWDSzG4yM7vb3p6RA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Lost messages in HA tests in a cluster">pablomolnar at gmail.com
       </A><BR>
    <I>Wed Feb  1 00:27:04 GMT 2012</I>
    <P><UL>
        
        <LI>Next message: <A HREF="017833.html">[rabbitmq-discuss] Lost messages in HA tests in a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17829">[ date ]</a>
              <a href="thread.html#17829">[ thread ]</a>
              <a href="subject.html#17829">[ subject ]</a>
              <a href="author.html#17829">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok...so I'm maybe confused. Basically I follow this example:

<A HREF="http://hg.rabbitmq.com/rabbitmq-java-client/file/default/test/src/com/rabbitmq/examples/ConfirmDontLoseMessages.java">http://hg.rabbitmq.com/rabbitmq-java-client/file/default/test/src/com/rabbitmq/examples/ConfirmDontLoseMessages.java</A>

Using the sentences ch.confirmSelect(); and ch.waitForConfirmsOrDie();  all
in a durable queue.

This example doesn't cover republishing nacks? Do you have an example? I
have to implement a ConfirmListener?

Thanks for helping Simone!

On Tue, Jan 31, 2012 at 8:43 PM, Simone Busoli &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simone.busoli at gmail.com</A>&gt;wrote:

&gt;<i> Hi Pablo, looking at your code I can't see where you are republishing
</I>&gt;<i> messages which have not been confirmed by the broker. If you want to make
</I>&gt;<i> sure that publishes will eventually be delivered you have to keep track of
</I>&gt;<i> them and re-issue them in case an ack doesn't arrive from the broker, which
</I>&gt;<i> usually happens when the broker dies.
</I>&gt;<i> On Jan 31, 2012 11:52 PM, &quot;Pablo Molnar&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pablomolnar at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi all!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm doing some HA tests stressing my cluster and I'm experimenting lost
</I>&gt;&gt;<i> messages ONLY when the publisher lost the connection due a kill -9.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *Test OK*: Kill node while consuming:
</I>&gt;&gt;<i> 1 - Setup a clean 3 node's cluster
</I>&gt;&gt;<i> 2 - Execute producer with 10.000 messages connected to node A
</I>&gt;&gt;<i> 3 - Wait producer to finish
</I>&gt;&gt;<i> 4 - Execute consumer connected to node A
</I>&gt;&gt;<i> 5 - While consumer is running kill node A
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Result: The consumer reconnects to another node and consume the rest of
</I>&gt;&gt;<i> messages ok. All 10.000 messages were consumed ok.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *Test FAILED*: Kill node while producing:
</I>&gt;&gt;<i> 1 - Setup a clean 3 node's cluster
</I>&gt;&gt;<i> 2 - Execute consumer to start listening connected node A
</I>&gt;&gt;<i> 3 - Execute producer with 10.000 messages connected to node A
</I>&gt;&gt;<i> 4 - While producer is running kill node A
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Result: The producer reconnects fine (the consumer too) and keep
</I>&gt;&gt;<i> publishing but some of the messages* already published* to node A are
</I>&gt;&gt;<i> lost.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These are my settings:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbitmqctl status
</I>&gt;&gt;<i> Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>' ...
</I>&gt;&gt;<i> [{pid,11339},
</I>&gt;&gt;<i>  {running_applications,
</I>&gt;&gt;<i>      [{rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>       {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>       {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>       {rabbit,&quot;RabbitMQ&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>       {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.4&quot;},
</I>&gt;&gt;<i>       {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.8&quot;},
</I>&gt;&gt;<i>       {rabbitmq_mochiweb,&quot;RabbitMQ Mochiweb Embedding&quot;,&quot;2.7.1&quot;},
</I>&gt;&gt;<i>       {webmachine,&quot;webmachine&quot;,&quot;1.7.0-rmq2.7.1-hg&quot;},
</I>&gt;&gt;<i>       {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;1.3-rmq2.7.1-git&quot;},
</I>&gt;&gt;<i>       {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.2&quot;},
</I>&gt;&gt;<i>       {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.4.12&quot;},
</I>&gt;&gt;<i>       {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.16.4&quot;},
</I>&gt;&gt;<i>       {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.13.4&quot;}]},
</I>&gt;&gt;<i>  {os,{unix,linux}},
</I>&gt;&gt;<i>  {erlang_version,
</I>&gt;&gt;<i>      &quot;Erlang R13B03 (erts-5.7.4) [source] [64-bit] [smp:2:2] [rq:2]
</I>&gt;&gt;<i> [async-threads:0] [hipe] [kernel-poll:false]\n&quot;},
</I>&gt;&gt;<i>  {memory,
</I>&gt;&gt;<i>      [{total,92565608},
</I>&gt;&gt;<i>       {processes,4004968},
</I>&gt;&gt;<i>       {processes_used,3996224},
</I>&gt;&gt;<i>       {system,88560640},
</I>&gt;&gt;<i>       {atom,1322033},
</I>&gt;&gt;<i>       {atom_used,1291462},
</I>&gt;&gt;<i>       {binary,32496},
</I>&gt;&gt;<i>       {code,15264387},
</I>&gt;&gt;<i>       {ets,1174192}]},
</I>&gt;&gt;<i>  {vm_memory_high_watermark,0.3999999999362281},
</I>&gt;&gt;<i>  {vm_memory_limit,2508940902}]
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbitmqctl cluster_status
</I>&gt;&gt;<i> Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>' ...
</I>&gt;&gt;<i> [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-0000001a-zsm</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>']},
</I>&gt;&gt;<i>          {ram,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000009-asm</A>']}]},
</I>&gt;&gt;<i>  {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-0000001a-zsm</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-00000007-asm</A>']}]
</I>&gt;&gt;<i> ...done.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *
</I>&gt;&gt;<i> Java amqp-client 2.7.1*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Producer.groovy (java amqp-client 2.7.1)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> import com.rabbitmq.client.*
</I>&gt;&gt;<i> try{
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> // Get rabbitmq config
</I>&gt;&gt;<i> def config = new ConfigSlurper().parse(new
</I>&gt;&gt;<i> File('../rabbitmq.properties').toURL())
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> def rabbit = new RabbitHA(config)
</I>&gt;&gt;<i> rabbit.init = { channel -&gt;
</I>&gt;&gt;<i>   channel.exchangeDeclare('myExchange', &quot;direct&quot;, true) // Durable
</I>&gt;&gt;<i> exchange
</I>&gt;&gt;<i>   channel.queueDeclare('myQueue', true, false, false, [&quot;x-ha-policy&quot;:
</I>&gt;&gt;<i> &quot;all&quot;]) // Durable exchange and HA policy
</I>&gt;&gt;<i>   channel.queueBind('myQueue', 'myExchange', '')
</I>&gt;&gt;<i>   channel.confirmSelect()
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 10000.times { idx -&gt;
</I>&gt;&gt;<i>   rabbit.publish { channel -&gt;
</I>&gt;&gt;<i>     def properties = new
</I>&gt;&gt;<i> AMQP.BasicProperties.Builder().deliveryMode(2).build() // Delivery mode 2:
</I>&gt;&gt;<i> persistent
</I>&gt;&gt;<i>     def msg = &quot;Message $idx&quot;
</I>&gt;&gt;<i>     channel.basicPublish('myExchange', '', properties, msg.getBytes())
</I>&gt;&gt;<i>     println msg
</I>&gt;&gt;<i>   }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbit.close()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> } catch(e){e.printStackTrace()}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Consumer.groovy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> import com.rabbitmq.client.*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> try{
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   // Get rabbitmq config
</I>&gt;&gt;<i>   def config = new ConfigSlurper().parse(new
</I>&gt;&gt;<i> File('../rabbitmq.properties').toURL())
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   // Connect
</I>&gt;&gt;<i>   def rabbit = new RabbitHA(config)
</I>&gt;&gt;<i>   rabbit.onDelivery('myQueue'){ delivery, channel -&gt;
</I>&gt;&gt;<i>   def msg = new String(delivery.body)
</I>&gt;&gt;<i>   println msg
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   // Manual ack
</I>&gt;&gt;<i>   channel.basicAck(delivery.envelope.deliveryTag, false)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> } catch(e){e.printStackTrace()}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - RabbitHA.groovy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> import com.rabbitmq.client.*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> /**
</I>&gt;&gt;<i>  *
</I>&gt;&gt;<i>  * RabbitMQ highly available proxy.
</I>&gt;&gt;<i>  * Basic implementation of a basic suscriber/publisher with reconnect
</I>&gt;&gt;<i> logic.
</I>&gt;&gt;<i>  *
</I>&gt;&gt;<i>  */
</I>&gt;&gt;<i> class RabbitHA {
</I>&gt;&gt;<i>     ConnectionFactory connectionFactory
</I>&gt;&gt;<i>     Address[] addresses
</I>&gt;&gt;<i>     Closure init
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Connection connection
</I>&gt;&gt;<i>     Channel channel
</I>&gt;&gt;<i>     QueueingConsumer consumer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     public RabbitHA(Map config) {
</I>&gt;&gt;<i>         this(config, null)
</I>&gt;&gt;<i>     }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     public RabbitHA(Map config, Closure init){
</I>&gt;&gt;<i>         this.connectionFactory = new ConnectionFactory([username:
</I>&gt;&gt;<i> config.username, password: config.password, virtualHost:
</I>&gt;&gt;<i> config.virtualHost])
</I>&gt;&gt;<i>         this.addresses = Address.parseAddresses(config.addresses)
</I>&gt;&gt;<i>         this.init = init
</I>&gt;&gt;<i>         connectChannel()
</I>&gt;&gt;<i>     }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     void onDelivery(String queueName, Closure closure) {
</I>&gt;&gt;<i>         basicConsume(queueName)
</I>&gt;&gt;<i>         int i = 0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         while(true) {
</I>&gt;&gt;<i>             try {
</I>&gt;&gt;<i>                 QueueingConsumer.Delivery delivery =
</I>&gt;&gt;<i> consumer.nextDelivery()
</I>&gt;&gt;<i>                 closure(delivery, channel)
</I>&gt;&gt;<i>                 i = 0
</I>&gt;&gt;<i>             } catch(e) {
</I>&gt;&gt;<i>                 // Only handle exceptions
</I>&gt;&gt;<i>                 if(!(e in ShutdownSignalException || e in IOException ||
</I>&gt;&gt;<i> e in AlreadyClosedException)) throw e
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>                 i++
</I>&gt;&gt;<i>                 e.printStackTrace()
</I>&gt;&gt;<i>                 println &quot;ShutdownSignalException recieved! Reconnection
</I>&gt;&gt;<i> attempt #$i&quot;
</I>&gt;&gt;<i>                 connectChannel()
</I>&gt;&gt;<i>                 basicConsume(queueName)
</I>&gt;&gt;<i>             }
</I>&gt;&gt;<i>         }
</I>&gt;&gt;<i>     }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     void publish(Closure closure) {
</I>&gt;&gt;<i>         int i = 0
</I>&gt;&gt;<i>         boolean retry = true
</I>&gt;&gt;<i>         while(retry) {
</I>&gt;&gt;<i>             try {
</I>&gt;&gt;<i>                 closure(channel)
</I>&gt;&gt;<i>                 i = 0
</I>&gt;&gt;<i>                 retry = false
</I>&gt;&gt;<i>             } catch(e) {
</I>&gt;&gt;<i>                 // Only handle exceptions
</I>&gt;&gt;<i>                 if(!(e in ShutdownSignalException || e in IOException ||
</I>&gt;&gt;<i> e in AlreadyClosedException)) throw e
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>                 i++
</I>&gt;&gt;<i>                 retry = true
</I>&gt;&gt;<i>                 e.printStackTrace()
</I>&gt;&gt;<i>                 println &quot;ShutdownSignalException recieved! Reconnection
</I>&gt;&gt;<i> attempt #$i&quot;
</I>&gt;&gt;<i>                 connectChannel()
</I>&gt;&gt;<i>             }
</I>&gt;&gt;<i>         }
</I>&gt;&gt;<i>     }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     void connectChannel() {
</I>&gt;&gt;<i>         connection = connectionFactory.newConnection(addresses)
</I>&gt;&gt;<i>         channel = connection.createChannel()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         println &quot;Succesfully connected to $connection.address&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         if(init) {
</I>&gt;&gt;<i>             init(channel)
</I>&gt;&gt;<i>         }
</I>&gt;&gt;<i>     }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     void basicConsume(queueName) {
</I>&gt;&gt;<i>         consumer = new QueueingConsumer(channel)
</I>&gt;&gt;<i>         channel.basicConsume(queueName, false, consumer)
</I>&gt;&gt;<i>     }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     void close() {
</I>&gt;&gt;<i>         channel.waitForConfirmsOrDie()
</I>&gt;&gt;<i>         channel.close()
</I>&gt;&gt;<i>         connection.close()
</I>&gt;&gt;<i>     }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Output:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cat consumer-output.txt |grep Message | wc
</I>&gt;&gt;<i>    9957   19914  128330
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cat producer-output.txt | grep Message | wc
</I>&gt;&gt;<i>   10000   20000  128890
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *Note that consumer lost 43 messages*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Output from producer :
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> Message 1466
</I>&gt;&gt;<i> Message 1467
</I>&gt;&gt;<i> Message 1468
</I>&gt;&gt;<i> Message 1469
</I>&gt;&gt;<i> Message 1470
</I>&gt;&gt;<i> ShutdownSignalException recieved! Reconnection attempt #1
</I>&gt;&gt;<i> Succesfully connected to i-0000001a-zsm/172.16.158.46
</I>&gt;&gt;<i> Message 1471
</I>&gt;&gt;<i> Message 1472
</I>&gt;&gt;<i> Message 1473
</I>&gt;&gt;<i> Message 1474
</I>&gt;&gt;<i> Message 1475
</I>&gt;&gt;<i> Message 1476
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *
</I>&gt;&gt;<i> Note messages [1471..1476] were consumed ok, but [1466..1470] are missing
</I>&gt;&gt;<i> in consumer output.*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The complete outputs are in
</I>&gt;&gt;<i> <A HREF="https://github.com/pablomolnar/rabbitmq_samples/tree/master/out.">https://github.com/pablomolnar/rabbitmq_samples/tree/master/out.</A> There
</I>&gt;&gt;<i> you can see reconnection log of both parts.
</I>&gt;&gt;<i> I've a strong feeling the publisher confirms is not well configured.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please anyone could shed some light on the issue?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i> Pablo Molnar
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> PD: Also I take the opportunity to share a lot of groovy examples I've
</I>&gt;&gt;<i> been working in the last days:
</I>&gt;&gt;<i> <A HREF="https://github.com/pablomolnar/rabbitmq_samples">https://github.com/pablomolnar/rabbitmq_samples</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120131/c142b975/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120131/c142b975/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="017833.html">[rabbitmq-discuss] Lost messages in HA tests in a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17829">[ date ]</a>
              <a href="thread.html#17829">[ thread ]</a>
              <a href="subject.html#17829">[ subject ]</a>
              <a href="author.html#17829">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
