<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [help] [beginner] server stops sending messages; publish (in transaction) hangs on commit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5Bhelp%5D%20%5Bbeginner%5D%20server%20stops%20sending%0A%20messages%3B%20publish%20%28in%20transaction%29%20hangs%20on%20commit&In-Reply-To=%3C4F4776A0.6020801%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018403.html">
   <LINK REL="Next"  HREF="018425.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [help] [beginner] server stops sending messages; publish (in transaction) hangs on commit</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5Bhelp%5D%20%5Bbeginner%5D%20server%20stops%20sending%0A%20messages%3B%20publish%20%28in%20transaction%29%20hangs%20on%20commit&In-Reply-To=%3C4F4776A0.6020801%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] [help] [beginner] server stops sending messages; publish (in transaction) hangs on commit">simon at rabbitmq.com
       </A><BR>
    <I>Fri Feb 24 11:38:08 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018403.html">[rabbitmq-discuss] [help] [beginner] server stops sending messages; publish (in transaction) hangs on commit
</A></li>
        <LI>Next message: <A HREF="018425.html">[rabbitmq-discuss] [help] [beginner] server stops sending messages; publish (in transaction) hangs on commit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18404">[ date ]</a>
              <a href="thread.html#18404">[ thread ]</a>
              <a href="subject.html#18404">[ subject ]</a>
              <a href="author.html#18404">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/02/12 20:00, Alistair Bayley wrote:
&gt;<i> Just ran this:
</I>&gt;<i>
</I>&gt;<i> $ sudo rabbitmqctl eval
</I>&gt;<i> 'lists:sublist(lists:reverse(lists:sort([{process_info(Pid,memory),
</I>&gt;<i> Pid, process_info(Pid)} || Pid&lt;- processes()])), 10).'
</I>&gt;<i>
</I>&gt;<i> (wait for a bit - about 30s or so...)
</I>&gt;<i>
</I>&gt;<i> Crash dump was written to: erl_crash.dump
</I>&gt;<i> eheap_alloc: Cannot allocate 153052320 bytes of memory (of type &quot;old_heap&quot;).
</I>&gt;<i> Aborted
</I>&gt;<i> $
</I>&gt;<i>
</I>&gt;<i> hmmm....
</I>
Hmm indeed. If it ran out of memory doing that, then that implies you 
might have a ton of processes hanging around for some reason. Either 
that or you were very close to the edge anyway.

rabbitmqctl eval 'length(processes()).' will tell you how many processes 
are in use in total.

So you may want to try the second rabbitmqctl eval command above, and 
then the first one with more memory available to the server.

&gt;&gt;<i> Having said that, 100Mb for an idle server does not seem totally
</I>&gt;&gt;<i> unreasonable - RabbitMQ is not optimised for small memory use when idle.
</I>&gt;<i>
</I>&gt;<i> OK. Can I have some guidance as to how much memory we should allocate?
</I>
This is a real how-long-is-a-piece-of-string question I'm afraid. 512M 
would already be a significant step towards the comfort zone though.

&gt;<i> Also, I see from the tcpdump capture that the server does not send
</I>&gt;<i> back a response to the Tx.Commit, which presumably makes it difficult
</I>&gt;<i> for the client to detect that the message has not been accepted (other
</I>&gt;<i> than timeout). Indeed, the basic_publish returns nothing immediately,
</I>&gt;<i> although that could be a feature of the amqplib library. Is there an
</I>&gt;<i> option to get the server to return something that says that it is not
</I>&gt;<i> accepting messages?
</I>
In ancient history we used to do this; there's a method in AMQP 0-9-1 
called channel.flow which the server should be able to use to tell a 
client to shut up. In practice it was unreliable (client may not support 
it, or may take too long to take notice of it).

We could just send channel.flows informationally but again this would 
require client support.

I am currently wondering about modifying our clients so they have a 
non-blocking publish (see the thread &quot;Ensuring low latency for 
publishers&quot;). This should not be too hard to do. However, this might not 
help when using transactions. OTOH blocking in such a way that we don't 
send back a tx.commit is unhelpful; I'll see how easy it would be to 
change this.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>


















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018403.html">[rabbitmq-discuss] [help] [beginner] server stops sending messages; publish (in transaction) hangs on commit
</A></li>
	<LI>Next message: <A HREF="018425.html">[rabbitmq-discuss] [help] [beginner] server stops sending messages; publish (in transaction) hangs on commit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18404">[ date ]</a>
              <a href="thread.html#18404">[ thread ]</a>
              <a href="subject.html#18404">[ subject ]</a>
              <a href="author.html#18404">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
