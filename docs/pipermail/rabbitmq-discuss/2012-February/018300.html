<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Bug: Java ConnectionFactory can hangs	forever in network packet loss cases
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bug%3A%20Java%20ConnectionFactory%20can%20hangs%0A%09forever%20in%20network%20packet%20loss%20cases&In-Reply-To=%3C3604F970-51BD-4443-AFB9-1A709619269C%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018202.html">
   <LINK REL="Next"  HREF="017967.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Bug: Java ConnectionFactory can hangs	forever in network packet loss cases</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bug%3A%20Java%20ConnectionFactory%20can%20hangs%0A%09forever%20in%20network%20packet%20loss%20cases&In-Reply-To=%3C3604F970-51BD-4443-AFB9-1A709619269C%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Bug: Java ConnectionFactory can hangs	forever in network packet loss cases">steve at rabbitmq.com
       </A><BR>
    <I>Tue Feb 21 10:50:35 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018202.html">[rabbitmq-discuss] Bug: Java ConnectionFactory can hangs	forever in network packet loss cases
</A></li>
        <LI>Next message: <A HREF="017967.html">[rabbitmq-discuss] Regd: Publish Many Scenarios
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18300">[ date ]</a>
              <a href="thread.html#18300">[ thread ]</a>
              <a href="subject.html#18300">[ subject ]</a>
              <a href="author.html#18300">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ildar,

Just a note to confirm that this bug is now fixed and will be in the next release.

Steve Powell  (a funny bunny)
----------some more definitions from the SPD----------
vermin (v.) Treating the dachshund for roundworm.
chinchilla (n.) Cooling device for the lower jaw.
socialcast (n.) Someone to whom everyone is speaking but nobody likes.

On 16 Feb 2012, at 13:27, Steve Powell wrote:

&gt;<i> Dear Ildar,
</I>&gt;<i> 
</I>&gt;<i> First, may I apologise for not getting back to you sooner. It seems that you
</I>&gt;<i> have clearly identified a bug, and have helped to narrow it down for us.
</I>&gt;<i> 
</I>&gt;<i> Thank you very much. I have raised a problem for us to fix and track this
</I>&gt;<i> (24747).
</I>&gt;<i> 
</I>&gt;<i> I have a few comments regarding your settings: it seems to me that a heartbeat
</I>&gt;<i> of 30s is not unreasonable, but you should be aware that anything up to a minute
</I>&gt;<i> may pass before noticing that a heartbeat is missed, so you must not rely on
</I>&gt;<i> this interval.
</I>&gt;<i> 
</I>&gt;<i> The ConnectionTimeout will only affect waiting for the socket connection so is
</I>&gt;<i> not involved in this. I think your interval here is again quite large, but not
</I>&gt;<i> unreasonable in unreliable networks. I would expect the herartbeat to be about
</I>&gt;<i> half of this (see note above).
</I>&gt;<i> 
</I>&gt;<i> We'll get on to this bug asap.
</I>&gt;<i> Steve Powell
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">steve at rabbitmq.com</A>
</I>&gt;<i> [wrk: +44-2380-111-528] [mob: +44-7815-838-558]
</I>&gt;<i> 
</I>&gt;<i> On 13 Feb 2012, at 09:28, &#1048;&#1083;&#1100;&#1076;&#1072;&#1088; &#1053;&#1091;&#1088;&#1080;&#1089;&#1083;&#1072;&#1084;&#1086;&#1074; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Can anybody help with this problem or prove that i'm wrong?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 2012/2/7 &#1048;&#1083;&#1100;&#1076;&#1072;&#1088; &#1053;&#1091;&#1088;&#1080;&#1089;&#1083;&#1072;&#1084;&#1086;&#1074; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">absorbb at gmail.com</A>&gt;
</I>&gt;&gt;<i> Hello.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> We have rabbitMQ 2.7.1 java clients remotely connected to the server.
</I>&gt;&gt;<i> We started experience short-term bad network scenarios and serious problem occurred:
</I>&gt;&gt;<i> 1. factory.setRequestedHeartbeat set to 30s
</I>&gt;&gt;<i> 2. factory.setConnectionTimeout set to 30000ms
</I>&gt;&gt;<i> client properly closes connection after missing 30 seconds of heartbeats.
</I>&gt;&gt;<i> But sometimes it hangs completely when tries to open a new connection.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I tried to analyze java client code and what is result:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> AMQConnection.java:286 :
</I>&gt;&gt;<i>          _frameHandler.setTimeout(HANDSHAKE_TIMEOUT); - socket.soTimeout is set to 10s here
</I>&gt;&gt;<i> then it starts the MainLoop at line 294
</I>&gt;&gt;<i> and blocks till get a reply for a handshake at line 300:
</I>&gt;&gt;<i>     connStart =
</I>&gt;&gt;<i>                (AMQP.Connection.Start) connStartBlocker.getReply().getMethod();
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> problem is that it's possible that it'll never get a reply. Because MainLoop relies on heartbeats functional to handle such situation which is not enabled yet. It happens only at line 368:
</I>&gt;&gt;<i>            setHeartbeat(heartbeat);
</I>&gt;&gt;<i> MainLoop endlessly runs at 492:              
</I>&gt;&gt;<i>    Frame frame = _frameHandler.readFrame();
</I>&gt;&gt;<i> which returns null every 10s (this is how SocketTimeoutException handled in Frame.readFrom..)
</I>&gt;&gt;<i> and handleSocketTimeout() do nothing because _heartbeat is not set yet.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018202.html">[rabbitmq-discuss] Bug: Java ConnectionFactory can hangs	forever in network packet loss cases
</A></li>
	<LI>Next message: <A HREF="017967.html">[rabbitmq-discuss] Regd: Publish Many Scenarios
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18300">[ date ]</a>
              <a href="thread.html#18300">[ thread ]</a>
              <a href="subject.html#18300">[ subject ]</a>
              <a href="author.html#18300">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
