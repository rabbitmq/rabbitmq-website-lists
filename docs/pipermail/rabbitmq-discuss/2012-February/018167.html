<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03	performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Looking%20for%20guidance%20on%20R14B04%20vs.%20R13B03%0A%09performance&In-Reply-To=%3CCACLE7iyaxmc0pJZ%2BgzNXa93da13s1iiStApp-A58BYPmmHkejw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018165.html">
   <LINK REL="Next"  HREF="018228.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03	performance</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Looking%20for%20guidance%20on%20R14B04%20vs.%20R13B03%0A%09performance&In-Reply-To=%3CCACLE7iyaxmc0pJZ%2BgzNXa93da13s1iiStApp-A58BYPmmHkejw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03	performance">mpietrek at skytap.com
       </A><BR>
    <I>Wed Feb 15 19:18:54 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018165.html">[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03 performance
</A></li>
        <LI>Next message: <A HREF="018228.html">[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03 performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18167">[ date ]</a>
              <a href="thread.html#18167">[ thread ]</a>
              <a href="subject.html#18167">[ subject ]</a>
              <a href="author.html#18167">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>|<i> So I think this is really the key point. OK, I accept your use case :)
</I>
Yeah, I figured I would have to go into some detail to get past the
(usually reasonable) &quot;don't do that&quot; round of responses. :-)

Regardless, thank you much for accepting the use case and plowing forward
with the perf question.


|<i> I assume that this is not how you plan to go into production, you are
</I>just testing how fast you can go if disk speed is not an issue?

Correct. :-)


|<i> The real issue though is going to be latency from client to server. What
</I>does that look like?

I'm still poking at this, trying to get a concrete answer from the maze of
available tools. All the VMs are using VMXNET3 and exhibit amazing perf
between each other using netperf.

HOWEVER... one data point tends to take client/broker latency out of the
question:

If I remove the clustering, so as to just hit a single broker, the rate
goes up to 900 message/sec. Thus, I'm directed back to looking for latency
between the master/slaves.

One other potentially interesting data point: With 2 slaves, the message
rate is only very slightly degraded from 1 slave, i.e. 37/second with 1
slave, and 36/sec with two. I assume the slave synchronization is done in
parallel, so this isn't totally surprising.

Matt


On Wed, Feb 15, 2012 at 9:36 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i> On 15/02/12 17:15, Matt Pietrek wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Thanks Simon. The 5% figure is useful for me.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers. Bear in mind that's just my guess, and it's also dependent on your
</I>&gt;<i> situation being CPU-bound - which it sounds like you aren't.
</I>&gt;<i>
</I>&gt;<i>  Let me give you a more precise description of what I'm doing to get the
</I>&gt;&gt;<i> 36 message/sec.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    * RabbitMQ 2.71 on a 3-node cluster with mirrored queues, durable on
</I>&gt;&gt;<i>      all nodes.
</I>&gt;&gt;<i>    * Client is Python 2.6/Pika 0.9.5.
</I>&gt;&gt;<i>    * Each message publish occurs in a transaction so that we can be
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      sure it's safely in RabbitMQ.
</I>&gt;&gt;<i>    * All nodes are Ubuntu 10.04 VMs with 4GB RAM and 2 or 4 vCPUs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At the heart of things, we're driving a highly complex state machine
</I>&gt;&gt;<i> that manages thousands of VMs and their associated state. Losing track
</I>&gt;&gt;<i> of any state is prohibitively expensive to clean up manually. As such,
</I>&gt;&gt;<i> all state is modeled in clustered databases and/or persistent messages
</I>&gt;&gt;<i> in the message queue. We have to assume that a given client app instance
</I>&gt;&gt;<i> (our management code) may be ungracefully terminated at any moment, so
</I>&gt;&gt;<i> enough state must be modeled to let a new instance pick up and recover.
</I>&gt;&gt;<i> If our database record indicates that a message has been sent, it better
</I>&gt;&gt;<i> darn well be in the hands of the RabbitMQ broker, and not sitting in
</I>&gt;&gt;<i> some Pika client-side queue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For this reasons, publisher-confirms are not particularly helpful - They
</I>&gt;&gt;<i> assume that the client app will be around to resend the message if the
</I>&gt;&gt;<i> message doesn't get confirmed. Similar story for batching messages. We
</I>&gt;&gt;<i> have to know they've been sent, and
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> OK.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  we can't stall our state machine
</I>&gt;&gt;<i> waiting for enough message to accumulate to publish multiple messages at
</I>&gt;&gt;<i> once.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So I think this is really the key point. OK, I accept your use case :)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  My goal in my latest round of experiments is to see what the maximum
</I>&gt;&gt;<i> throughput of a highly available system is in optimal circumstances.
</I>&gt;&gt;<i> We're perfectly willing to spend the money on high end SSDs and
</I>&gt;&gt;<i> networking equipment as necessary.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To prototype what this perf level is, I've configured RabbitMQ with the
</I>&gt;&gt;<i> MNESIA directory pointing to a ramdisk (/tmp).
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I assume that this is not how you plan to go into production, you are just
</I>&gt;<i> testing how fast you can go if disk speed is not an issue?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  I've configured all the
</I>&gt;&gt;<i> VMs with VMXNET3 networking, am with 16K blocks, are seeing bandwidth of
</I>&gt;&gt;<i> 130MB/sec between VMs in the cluster.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The real issue though is going to be latency from client to server. What
</I>&gt;<i> does that look like?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  My test app simply writes 6 byte message, one at a time, as quickly as
</I>&gt;&gt;<i> it can. In monitoring the cluster nodes, I'm seeing very low CPU usage,
</I>&gt;&gt;<i> very few writes to the physical disk, and network operation rates of
</I>&gt;&gt;<i> about 700/sec for the master node and 350/sec for the client node.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In short, there's a bottleneck somewhere and it's not obvious where.
</I>&gt;&gt;<i> I'll try your suggestion about replacing tx.commit. Any other insight or
</I>&gt;&gt;<i> guidance would of course be very much appreciated. :-)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It sounds like you have already almost eliminated disk writes in practice,
</I>&gt;<i> so my working assumption would be that it's client -&gt; server latency that
</I>&gt;<i> is your issue.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, VMware
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120215/d72b7d74/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120215/d72b7d74/attachment.htm</A>&gt;
</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018165.html">[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03 performance
</A></li>
	<LI>Next message: <A HREF="018228.html">[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03 performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18167">[ date ]</a>
              <a href="thread.html#18167">[ thread ]</a>
              <a href="subject.html#18167">[ subject ]</a>
              <a href="author.html#18167">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
