<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Possibly latency issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Possibly%20latency%20issues&In-Reply-To=%3C4F3A607A.7070207%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018127.html">
   <LINK REL="Next"  HREF="018143.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Possibly latency issues</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Possibly%20latency%20issues&In-Reply-To=%3C4F3A607A.7070207%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Possibly latency issues">simon at rabbitmq.com
       </A><BR>
    <I>Tue Feb 14 13:24:10 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018127.html">[rabbitmq-discuss] Possibly latency issues
</A></li>
        <LI>Next message: <A HREF="018143.html">[rabbitmq-discuss] Possibly latency issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18134">[ date ]</a>
              <a href="thread.html#18134">[ thread ]</a>
              <a href="subject.html#18134">[ subject ]</a>
              <a href="author.html#18134">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/02/12 02:47, Sam Crawley wrote:
&gt;<i> Running this, I always get an average time (and I'm obviously only
</I>&gt;<i> timing the reading of messages) of 0.04s. (FWIW, I get the same with our
</I>&gt;<i> home grown client).
</I>&gt;<i>
</I>&gt;<i> Does it seem like there's something wrong here?
</I>
Yes. Very much so. I replicated your problem.

The problem is that the old version of librabbitmq that is embedded in 
Net::RabbitMQ does not disable Nagle's algorithm. (I assume your 
homebrew client also does not.)

Looking in wireshark we see that almost all of the delay happens after 
the basic.publish, when the TCP stack waits 0.04s (on my machine) for 
more data before *actually* sending the publish. Everything else is very 
fast in comparison, giving an almost perfect 25 msg/s for me.

I hacked in a call to setsockopt() to set TCP_NODELAY in amqp_socket.c, 
and now I get:

Longest request: 0.000537, Shortest Request: 0.000146
Mean Req time: 0

Which I think is more the performance you might be looking for. 
(Presumably the &quot;mean req time&quot; suffered underflow.)

The current version of librabbitmq sets TCP_NODELAY, so maybe 
Net::RabbitMQ should be updated? (CCing maintainer...)

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018127.html">[rabbitmq-discuss] Possibly latency issues
</A></li>
	<LI>Next message: <A HREF="018143.html">[rabbitmq-discuss] Possibly latency issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18134">[ date ]</a>
              <a href="thread.html#18134">[ thread ]</a>
              <a href="subject.html#18134">[ subject ]</a>
              <a href="author.html#18134">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
