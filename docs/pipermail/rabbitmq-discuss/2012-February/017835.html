<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20RabbitMQ%20Java%20Client%20%28Memory%0A%09leak%29&In-Reply-To=%3C4C8B808C-80D4-40BB-9C99-98609675EB9C%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017882.html">
   <LINK REL="Next"  HREF="017837.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20RabbitMQ%20Java%20Client%20%28Memory%0A%09leak%29&In-Reply-To=%3C4C8B808C-80D4-40BB-9C99-98609675EB9C%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)">steve at rabbitmq.com
       </A><BR>
    <I>Wed Feb  1 10:42:23 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017882.html">[rabbitmq-discuss] ShutdownSignalException second 'channel.open'
</A></li>
        <LI>Next message: <A HREF="017837.html">[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17835">[ date ]</a>
              <a href="thread.html#17835">[ thread ]</a>
              <a href="subject.html#17835">[ subject ]</a>
              <a href="author.html#17835">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yogesh,

Thank you for this problem report. First point: each connection defines a
(hidden) channel zero, so that explains why there are 20001 of some objects and
20000 of others.

As to why these are not garbage collected, we must be holding a reference
somewhere (probably in the Connection).

We will investigate. I have raised a bug (24723).

Steve Powell  (a happy bunny)
----------some more definitions from the SPD----------
vermin (v.) Treating the dachshund for roundworm.
chinchilla (n.) Cooling device for the lower jaw.
socialcast (n.) Someone to whom everyone is speaking but nobody likes.

On 31 Jan 2012, at 17:49, Yogesh Ketkar wrote:

&gt;<i> I am using rabbitmq-java-client-bin-2.7.1/rabbitmq-client.jar with
</I>&gt;<i> RabbitMQ 2.7.1 Server.
</I>&gt;<i> 
</I>&gt;<i> Just run this code
</I>&gt;<i> 
</I>&gt;<i> public static void main(String[] argv) throws IOException {
</I>&gt;<i>    ConnectionFactory f = new ConnectionFactory();
</I>&gt;<i>    Connection c = f.newConnection();
</I>&gt;<i>    for(int i = 0; i &lt; 20000; ++i) {
</I>&gt;<i>        Channel ch = c.createChannel();
</I>&gt;<i>        ch.close();
</I>&gt;<i>    }
</I>&gt;<i>    System.gc();
</I>&gt;<i>    while(true) {}
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> While program is running, observe the memory usage, it keeps on
</I>&gt;<i> increasing
</I>&gt;<i> Get process id and do following
</I>&gt;<i> jmap -dump:format=b,file=yo.bin  &lt;pid&gt;
</I>&gt;<i> jhat jhat -J-mx768m -stack false yo.bin
</I>&gt;<i> Once jhat brings up http server, go here
</I>&gt;<i> <A HREF="http://localhost:7000/showInstanceCounts/">http://localhost:7000/showInstanceCounts/</A>
</I>&gt;<i> 
</I>&gt;<i> 20001 instances of class com.rabbitmq.client.impl.AMQCommand
</I>&gt;<i> 20001 instances of class com.rabbitmq.client.impl.CommandAssembler
</I>&gt;<i> 20000 instances of class com.rabbitmq.client.ShutdownSignalException
</I>&gt;<i> 20000 instances of class com.rabbitmq.client.impl.AMQImpl$Channel
</I>&gt;<i> $Close
</I>&gt;<i> 20000 instances of class com.rabbitmq.client.impl.ChannelN
</I>&gt;<i> 20000 instances of class com.rabbitmq.client.impl.ConsumerDispatcher
</I>&gt;<i> 
</I>&gt;<i> In-spite of closing all the channels, not only channels but associated
</I>&gt;<i> objects (ShutdownSignalException, ChannelClose) continue to consume
</I>&gt;<i> memory.
</I>&gt;<i> For sure, knowing this now, I will use channelCreate call sparingly.
</I>&gt;<i> 
</I>&gt;<i> Is there a way to remedy this situation?
</I>&gt;<i> What is also worrying is instances of AMQCommand, so would this be the
</I>&gt;<i> case for each and every call of client library?
</I>&gt;<i> 
</I>&gt;<i> regards, Yogesh
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017882.html">[rabbitmq-discuss] ShutdownSignalException second 'channel.open'
</A></li>
	<LI>Next message: <A HREF="017837.html">[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17835">[ date ]</a>
              <a href="thread.html#17835">[ thread ]</a>
              <a href="subject.html#17835">[ subject ]</a>
              <a href="author.html#17835">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
