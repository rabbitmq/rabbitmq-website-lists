<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmqctl stall/hang when leaving a cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20stall/hang%20when%20leaving%20a%20cluster&In-Reply-To=%3C4F462871.4070602%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018351.html">
   <LINK REL="Next"  HREF="018389.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmqctl stall/hang when leaving a cluster</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20stall/hang%20when%20leaving%20a%20cluster&In-Reply-To=%3C4F462871.4070602%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmqctl stall/hang when leaving a cluster">simon at rabbitmq.com
       </A><BR>
    <I>Thu Feb 23 11:52:17 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018351.html">[rabbitmq-discuss] rabbitmqctl stall/hang when leaving a cluster
</A></li>
        <LI>Next message: <A HREF="018389.html">[rabbitmq-discuss] rabbitmqctl stall/hang when leaving a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18362">[ date ]</a>
              <a href="thread.html#18362">[ thread ]</a>
              <a href="subject.html#18362">[ subject ]</a>
              <a href="author.html#18362">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I *think* the stats database is a red herring. You say this happens when 
restarting?

On 23/02/12 00:30, Matt Pietrek wrote:
&gt;<i> Let me add some additional information, and re-summarize what I'm seeing.
</I>&gt;<i>
</I>&gt;<i> In our startup script for RabbitMQ we do the following;
</I>&gt;<i>
</I>&gt;<i> rabbitmq-server -detached
</I>&gt;<i> rabbitmqctl status
</I>&gt;<i> &lt;Extract the PID from rabbitmqctl status, write to our PIDFILE&gt;
</I>
There's a potential race here if an old server is running (maybe about 
to shut down?). rabbitmqctl status could pick up the old pid.

&gt;<i> rabbitmqctl wait PIDFILE
</I>
However, rabbitmqctl wait should then detect that the pid has died and 
fail. Unless the pid gets reused by the OS but that is presumably unlikely.

But rabbitmqctl wait will wait indefinitely as long as the pid is alive 
and not a fully functional rabbit node. So I'd check two things:

1) You should fix that race, it can be done safely:

Do not use rabbitmq-server -detached and rabbitmqctl status to get the 
pid. Instead set RABBITMQ_PID_FILE and background the rabbitmq-server 
script. You will then *definitely* get the right pid since the script 
writes its own pid then execs - no race possible.

2) Capture the stdout of rabbitmq-server when you start it - if 
rabbitmqctl wait still hangs, see how far it's got / what it's doing.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>


















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018351.html">[rabbitmq-discuss] rabbitmqctl stall/hang when leaving a cluster
</A></li>
	<LI>Next message: <A HREF="018389.html">[rabbitmq-discuss] rabbitmqctl stall/hang when leaving a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18362">[ date ]</a>
              <a href="thread.html#18362">[ thread ]</a>
              <a href="subject.html#18362">[ subject ]</a>
              <a href="author.html#18362">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
