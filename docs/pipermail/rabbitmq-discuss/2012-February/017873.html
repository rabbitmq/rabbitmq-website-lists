<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20RabbitMQ%20Java%20Client%20%28Memory%0A%09leak%29&In-Reply-To=%3C1b453046-9e07-4fa9-b883-ed64575f9b46%40lr19g2000pbb.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017842.html">
   <LINK REL="Next"  HREF="018112.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)</H1>
    <B>Yogesh Ketkar</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20RabbitMQ%20Java%20Client%20%28Memory%0A%09leak%29&In-Reply-To=%3C1b453046-9e07-4fa9-b883-ed64575f9b46%40lr19g2000pbb.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)">yogimogi at gmail.com
       </A><BR>
    <I>Thu Feb  2 17:32:42 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017842.html">[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
</A></li>
        <LI>Next message: <A HREF="018112.html">[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17873">[ date ]</a>
              <a href="thread.html#17873">[ thread ]</a>
              <a href="subject.html#17873">[ subject ]</a>
              <a href="author.html#17873">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Steve,

Now that I am reusing the channels, memory problem with channels is
not an issue, but there seems to be some more problem with memory
leak.
I had a program which pumped 100000 messages on a queue.

Then this program kicked in and created certain queues on the fly and
distributed these messages across them and
eventually all the messages got consumed.

Now when all queues in the system are empty, here is the object dump
and I again see a lot of memory used by
these objects.

96449 instances of class com.rabbitmq.client.AMQP$BasicProperties
96428 instances of class com.rabbitmq.client.Envelope
96399 instances of class com.rabbitmq.client.impl.ConsumerDispatcher
$4

I created BasicProperties object like this, while routing the messages
to appropriate queue.
    BasicProperties bp = new BasicProperties();
    bp.setTimestamp(Calendar.getInstance().getTime());
    bp.setType(MessageProperties.PERSISTENT_TEXT_PLAIN.toString());
This was then used in basicPublish method.

regards, Yogesh

On Feb 1, 10:37&#160;pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
&gt;<i> The fix (which we have coded) will be in the next release,
</I>&gt;<i> but I don't know precisely when that will be.
</I>&gt;<i>
</I>&gt;<i> Steve Powell &#160;(a happy bunny)
</I>&gt;<i> ----------some more definitions from the SPD----------
</I>&gt;<i> vermin (v.) Treating the dachshund for roundworm.
</I>&gt;<i> chinchilla (n.) Cooling device for the lower jaw.
</I>&gt;<i> socialcast (n.) Someone to whom everyone is speaking but nobody likes.
</I>&gt;<i>
</I>&gt;<i> On 1 Feb 2012, at 11:21, Yogesh Ketkar wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Thanks Steve.
</I>&gt;<i> &gt; Can you give me some idea about date of next Java Client release (with
</I>&gt;<i> &gt; this bug-fix)?
</I>&gt;<i>
</I>&gt;<i> &gt; regards, Yogesh
</I>&gt;<i>
</I>&gt;<i> &gt; On Feb 1, 3:42 pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; Yogesh,
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; Thank you for this problem report. First point: each connection defines a
</I>&gt;<i> &gt;&gt; (hidden) channel zero, so that explains why there are 20001 of some objects and
</I>&gt;<i> &gt;&gt; 20000 of others.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; As to why these are not garbage collected, we must be holding a reference
</I>&gt;<i> &gt;&gt; somewhere (probably in the Connection).
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; We will investigate. I have raised a bug (24723).
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; Steve Powell &#160;(a happy bunny)
</I>&gt;<i> &gt;&gt; ----------some more definitions from the SPD----------
</I>&gt;<i> &gt;&gt; vermin (v.) Treating the dachshund for roundworm.
</I>&gt;<i> &gt;&gt; chinchilla (n.) Cooling device for the lower jaw.
</I>&gt;<i> &gt;&gt; socialcast (n.) Someone to whom everyone is speaking but nobody likes.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; On 31 Jan 2012, at 17:49, Yogesh Ketkar wrote:
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; I am using rabbitmq-java-client-bin-2.7.1/rabbitmq-client.jar with
</I>&gt;<i> &gt;&gt;&gt; RabbitMQ 2.7.1 Server.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; Just run this code
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; public static void main(String[] argv) throws IOException {
</I>&gt;<i> &gt;&gt;&gt; &#160; &#160;ConnectionFactory f = new ConnectionFactory();
</I>&gt;<i> &gt;&gt;&gt; &#160; &#160;Connection c = f.newConnection();
</I>&gt;<i> &gt;&gt;&gt; &#160; &#160;for(int i = 0; i &lt; 20000; ++i) {
</I>&gt;<i> &gt;&gt;&gt; &#160; &#160; &#160; &#160;Channel ch = c.createChannel();
</I>&gt;<i> &gt;&gt;&gt; &#160; &#160; &#160; &#160;ch.close();
</I>&gt;<i> &gt;&gt;&gt; &#160; &#160;}
</I>&gt;<i> &gt;&gt;&gt; &#160; &#160;System.gc();
</I>&gt;<i> &gt;&gt;&gt; &#160; &#160;while(true) {}
</I>&gt;<i> &gt;&gt;&gt; }
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; While program is running, observe the memory usage, it keeps on
</I>&gt;<i> &gt;&gt;&gt; increasing
</I>&gt;<i> &gt;&gt;&gt; Get process id and do following
</I>&gt;<i> &gt;&gt;&gt; jmap -dump:format=b,file=yo.bin &#160;&lt;pid&gt;
</I>&gt;<i> &gt;&gt;&gt; jhat jhat -J-mx768m -stack false yo.bin
</I>&gt;<i> &gt;&gt;&gt; Once jhat brings up http server, go here
</I>&gt;<i> &gt;&gt;&gt;<A HREF="http://localhost:7000/showInstanceCounts/">http://localhost:7000/showInstanceCounts/</A>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; 20001 instances of class com.rabbitmq.client.impl.AMQCommand
</I>&gt;<i> &gt;&gt;&gt; 20001 instances of class com.rabbitmq.client.impl.CommandAssembler
</I>&gt;<i> &gt;&gt;&gt; 20000 instances of class com.rabbitmq.client.ShutdownSignalException
</I>&gt;<i> &gt;&gt;&gt; 20000 instances of class com.rabbitmq.client.impl.AMQImpl$Channel
</I>&gt;<i> &gt;&gt;&gt; $Close
</I>&gt;<i> &gt;&gt;&gt; 20000 instances of class com.rabbitmq.client.impl.ChannelN
</I>&gt;<i> &gt;&gt;&gt; 20000 instances of class com.rabbitmq.client.impl.ConsumerDispatcher
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; In-spite of closing all the channels, not only channels but associated
</I>&gt;<i> &gt;&gt;&gt; objects (ShutdownSignalException, ChannelClose) continue to consume
</I>&gt;<i> &gt;&gt;&gt; memory.
</I>&gt;<i> &gt;&gt;&gt; For sure, knowing this now, I will use channelCreate call sparingly.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; Is there a way to remedy this situation?
</I>&gt;<i> &gt;&gt;&gt; What is also worrying is instances of AMQCommand, so would this be the
</I>&gt;<i> &gt;&gt;&gt; case for each and every call of client library?
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; regards, Yogesh
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt;&gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt;&gt;&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;&gt;&gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt;&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017842.html">[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
</A></li>
	<LI>Next message: <A HREF="018112.html">[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17873">[ date ]</a>
              <a href="thread.html#17873">[ thread ]</a>
              <a href="subject.html#17873">[ subject ]</a>
              <a href="author.html#17873">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
