<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03 performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Looking%20for%20guidance%20on%20R14B04%20vs.%20R13B03%0A%20performance&In-Reply-To=%3C4F3BED29.6050602%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018164.html">
   <LINK REL="Next"  HREF="018167.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03 performance</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Looking%20for%20guidance%20on%20R14B04%20vs.%20R13B03%0A%20performance&In-Reply-To=%3C4F3BED29.6050602%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03 performance">simon at rabbitmq.com
       </A><BR>
    <I>Wed Feb 15 17:36:41 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018164.html">[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03	performance
</A></li>
        <LI>Next message: <A HREF="018167.html">[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03	performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18165">[ date ]</a>
              <a href="thread.html#18165">[ thread ]</a>
              <a href="subject.html#18165">[ subject ]</a>
              <a href="author.html#18165">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/02/12 17:15, Matt Pietrek wrote:
&gt;<i> Thanks Simon. The 5% figure is useful for me.
</I>
Cheers. Bear in mind that's just my guess, and it's also dependent on 
your situation being CPU-bound - which it sounds like you aren't.

&gt;<i> Let me give you a more precise description of what I'm doing to get the
</I>&gt;<i> 36 message/sec.
</I>&gt;<i>
</I>&gt;<i>     * RabbitMQ 2.71 on a 3-node cluster with mirrored queues, durable on
</I>&gt;<i>       all nodes.
</I>&gt;<i>     * Client is Python 2.6/Pika 0.9.5.
</I>&gt;<i>     * Each message publish occurs in a transaction so that we can be
</I>&gt;<i>       sure it's safely in RabbitMQ.
</I>&gt;<i>     * All nodes are Ubuntu 10.04 VMs with 4GB RAM and 2 or 4 vCPUs.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> At the heart of things, we're driving a highly complex state machine
</I>&gt;<i> that manages thousands of VMs and their associated state. Losing track
</I>&gt;<i> of any state is prohibitively expensive to clean up manually. As such,
</I>&gt;<i> all state is modeled in clustered databases and/or persistent messages
</I>&gt;<i> in the message queue. We have to assume that a given client app instance
</I>&gt;<i> (our management code) may be ungracefully terminated at any moment, so
</I>&gt;<i> enough state must be modeled to let a new instance pick up and recover.
</I>&gt;<i> If our database record indicates that a message has been sent, it better
</I>&gt;<i> darn well be in the hands of the RabbitMQ broker, and not sitting in
</I>&gt;<i> some Pika client-side queue.
</I>&gt;<i>
</I>&gt;<i> For this reasons, publisher-confirms are not particularly helpful - They
</I>&gt;<i> assume that the client app will be around to resend the message if the
</I>&gt;<i> message doesn't get confirmed. Similar story for batching messages. We
</I>&gt;<i> have to know they've been sent, and
</I>
OK.

&gt;<i> we can't stall our state machine
</I>&gt;<i> waiting for enough message to accumulate to publish multiple messages at
</I>&gt;<i> once.
</I>
So I think this is really the key point. OK, I accept your use case :)

&gt;<i> My goal in my latest round of experiments is to see what the maximum
</I>&gt;<i> throughput of a highly available system is in optimal circumstances.
</I>&gt;<i> We're perfectly willing to spend the money on high end SSDs and
</I>&gt;<i> networking equipment as necessary.
</I>&gt;<i>
</I>&gt;<i> To prototype what this perf level is, I've configured RabbitMQ with the
</I>&gt;<i> MNESIA directory pointing to a ramdisk (/tmp).
</I>
I assume that this is not how you plan to go into production, you are 
just testing how fast you can go if disk speed is not an issue?

&gt;<i> I've configured all the
</I>&gt;<i> VMs with VMXNET3 networking, am with 16K blocks, are seeing bandwidth of
</I>&gt;<i> 130MB/sec between VMs in the cluster.
</I>
The real issue though is going to be latency from client to server. What 
does that look like?

&gt;<i> My test app simply writes 6 byte message, one at a time, as quickly as
</I>&gt;<i> it can. In monitoring the cluster nodes, I'm seeing very low CPU usage,
</I>&gt;<i> very few writes to the physical disk, and network operation rates of
</I>&gt;<i> about 700/sec for the master node and 350/sec for the client node.
</I>&gt;<i>
</I>&gt;<i> In short, there's a bottleneck somewhere and it's not obvious where.
</I>&gt;<i> I'll try your suggestion about replacing tx.commit. Any other insight or
</I>&gt;<i> guidance would of course be very much appreciated. :-)
</I>
It sounds like you have already almost eliminated disk writes in 
practice, so my working assumption would be that it's client -&gt; server 
latency that is your issue.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018164.html">[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03	performance
</A></li>
	<LI>Next message: <A HREF="018167.html">[rabbitmq-discuss] Looking for guidance on R14B04 vs. R13B03	performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18165">[ date ]</a>
              <a href="thread.html#18165">[ thread ]</a>
              <a href="subject.html#18165">[ subject ]</a>
              <a href="author.html#18165">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
