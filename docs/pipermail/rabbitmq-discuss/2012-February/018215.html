<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Performance of &quot;blocking publisher-confirms&quot; vs. transactions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Performance%20of%20%22blocking%20publisher-confirms%22%0A%20vs.%20transactions&In-Reply-To=%3CCAOn7oW85LewjFWCt049xxTDms9zE-ZXxekfo_uJ8Gue-E84O2w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018212.html">
   <LINK REL="Next"  HREF="018243.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Performance of &quot;blocking publisher-confirms&quot; vs. transactions</H1>
    <B>Simone Busoli</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Performance%20of%20%22blocking%20publisher-confirms%22%0A%20vs.%20transactions&In-Reply-To=%3CCAOn7oW85LewjFWCt049xxTDms9zE-ZXxekfo_uJ8Gue-E84O2w%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Performance of &quot;blocking publisher-confirms&quot; vs. transactions">simone.busoli at gmail.com
       </A><BR>
    <I>Thu Feb 16 23:06:38 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018212.html">[rabbitmq-discuss] Performance of &quot;blocking publisher-confirms&quot; vs. transactions
</A></li>
        <LI>Next message: <A HREF="018243.html">[rabbitmq-discuss] Performance of &quot;blocking publisher-confirms&quot; vs. transactions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18215">[ date ]</a>
              <a href="thread.html#18215">[ thread ]</a>
              <a href="subject.html#18215">[ subject ]</a>
              <a href="author.html#18215">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Matt, thanks for the explanation and sorry for not reading the
previous thread carefully, I did now.

I can't tell you what differences you should expect between using a
blocking publisher confirms model and transactions as I've never used
transactions before, but allow me to insist a bit more on why the first may
fit your scenario by describing mine. I'm using RabbitMQ in an environment
where high reliability, together with strict ordering of messages and
exactly-once quality of service are needed. We're using asynchronous
publisher confirms to achieve that.

You seem to be worried about a scenario in which you believe some messages
to be in the hands of the server while instead they aren't due to the
asynchronous nature of publisher confirms, and especially that the
publishers may not be there to republish them in case something goes wrong.
Without knowing much about your system I would suggest that you don't
consider the messages as &quot;delivered&quot; until you receive the asynchronous
confirm from the broker, and just pretend they were never published until
this happens. The problem you describe seems to arise because you consider
published messages as &quot;delivered&quot;, which is not true until you receive a
confirm.
So what's worst case scenario difference between publisher confirms used in
this way compared to transactions? If a publisher dies, in the first case
you would consider as published only the messages that have been confirmed,
thus pretending the unconfirmed ones to have never existed, in the second
case an hypothetical ongoing transaction is rolled back. I think the
difference here lies only in the number of messages you have tried to
publish which may not have reached the broker. In the case of transactions
it is at most 1, with async publisher confirms it may be more than 1 (it
will be 1 with synchronous publisher confirms), but I don't think this
number changes the nature of the problem.

On Thu, Feb 16, 2012 at 22:44, Matt Pietrek &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mpietrek at skytap.com</A>&gt; wrote:

&gt;<i> Hi Simone,
</I>&gt;<i>
</I>&gt;<i> | Can you describe why you think publisher confirms are not appropriate in
</I>&gt;<i> your scenario?
</I>&gt;<i>
</I>&gt;<i> I think if you read the paragraph that starts with &quot;At the heart of
</I>&gt;<i> things&quot; it describes the scenario in enough detail. In a follow up, Simon
</I>&gt;<i> MacMullen appears to agree that publisher confirms aren't ideal for us.
</I>&gt;<i>
</I>&gt;<i> In short, when we publish a message, we must know that the broker safely
</I>&gt;<i> has it. With transactions, OR a blocking publisher-confirm model, the
</I>&gt;<i> client is assured it has it.
</I>&gt;<i>
</I>&gt;<i> HOWEVER, all the publisher-confirm descriptions/examples I've seen assume
</I>&gt;<i> an async model: Publish a message and some time later you'll be told that
</I>&gt;<i> the message is safely in the broker's hands. However, that window between
</I>&gt;<i> those two events is the crux of the problem in our environment.
</I>&gt;<i>
</I>&gt;<i> Assume we went with the async publisher-confirm model as suggested. What
</I>&gt;<i> if our client dies and is not around to re-send the message? Or what if the
</I>&gt;<i> client dies, and milliseconds later the broker dies? No publisher confirm
</I>&gt;<i> would be forthcoming, and hence, lost messages.
</I>&gt;<i>
</I>&gt;<i> Top level problem for us: Our state machine, which persists every critical
</I>&gt;<i> change of state to a database, will be incorrect. We will have recorded
</I>&gt;<i> &quot;Yup, that message was sent&quot;, when in reality it might not have made it to
</I>&gt;<i> broker, or the broker died before the confirm could be sent.
</I>&gt;<i>
</I>&gt;<i> By not recording that we've sent the message until AFTER a
</I>&gt;<i> transaction/publisher-confirm completes, we can guarantee the integrity of
</I>&gt;<i> our state-machine. However, as we've all seen, transactions impose a limit
</I>&gt;<i> on message throughput. I'm simply trying to understand if there's any
</I>&gt;<i> non-trivial message rate difference expected between using a transaction
</I>&gt;<i> vs. waiting in my publish routine for the confirm.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> | If you happen to be using the .NET API this is already implemented, the
</I>&gt;<i> WaitForConfirms and WaitForConfirmsOrDie on the IModel interface provide
</I>&gt;<i> this behavior.
</I>&gt;<i>
</I>&gt;<i> Unfortunately, I'm not on a .NET client. I'm using Python/Pika. I'd
</I>&gt;<i> consider going to the c-library (wrapped from Python) if there's some
</I>&gt;<i> non-trivial benefit to using a synchronous publisher-confirm.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Matt
</I>&gt;<i>
</I>&gt;<i> On Thu, Feb 16, 2012 at 1:08 PM, Simone Busoli &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simone.busoli at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Matt, I've gone through the old thread very quickly so forgive me if
</I>&gt;&gt;<i> I'm missing something. Your first sentence leaves me with some doubts:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  As I've detailed in other posts to this DL (<A HREF="http://bit.ly/zf6sKC">http://bit.ly/zf6sKC</A>), we
</I>&gt;&gt;&gt;<i> have situation where straightforward publisher-confirms aren't appropriate
</I>&gt;&gt;&gt;<i> in our scenario. We need to know the broker has received the message, and
</I>&gt;&gt;&gt;<i> we have to assume our client can die at any moment, so retransmitting
</I>&gt;&gt;&gt;<i> messages is not an option for us.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Publisher confirms guarantee that the broker has taken care of the
</I>&gt;&gt;<i> message and it has been either delivered to a queue or to a consumer. This
</I>&gt;&gt;<i> is a strong delivery guarantee, even if the client dies. Coupled with
</I>&gt;&gt;<i> persistent messages and durable exchange/queues, it guarantees
</I>&gt;&gt;<i> at-least-once delivery. Can you describe why you think publisher confirms
</I>&gt;&gt;<i> are not appropriate in your scenario?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What I'd like to know is: Is there any benefit to creating our own
</I>&gt;&gt;&gt;<i> &quot;blocking publisher-confirm publishing&quot;? That is, we'd do the following:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Publish a single message
</I>&gt;&gt;&gt;<i> Block on an event 'X'
</I>&gt;&gt;&gt;<i> When the publisher confirm comes in, signal 'X'
</I>&gt;&gt;&gt;<i> Return from the publish call
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you happen to be using the .NET API this is already implemented, the
</I>&gt;&gt;<i> WaitForConfirms and WaitForConfirmsOrDie on the IModel interface provide
</I>&gt;&gt;<i> this behavior.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In a mirrored queue scenario, is there any advantage to doing this vs.
</I>&gt;&gt;&gt;<i> using straight-up transactions?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Matt
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> p.s. I realize in the above pseudocode that multiple threads would be
</I>&gt;&gt;&gt;<i> necessary - One to block and the other to listen for the publisher-confirm.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120217/30f08d9a/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120217/30f08d9a/attachment.htm</A>&gt;
</PRE>










































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018212.html">[rabbitmq-discuss] Performance of &quot;blocking publisher-confirms&quot; vs. transactions
</A></li>
	<LI>Next message: <A HREF="018243.html">[rabbitmq-discuss] Performance of &quot;blocking publisher-confirms&quot; vs. transactions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18215">[ date ]</a>
              <a href="thread.html#18215">[ thread ]</a>
              <a href="subject.html#18215">[ subject ]</a>
              <a href="author.html#18215">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
