<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Strange message loss behavior with mirrored	queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Strange%20message%20loss%20behavior%20with%20mirrored%0A%09queues&In-Reply-To=%3CCB516E06.2B8AB%25mpietrek%40skytap.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017907.html">
   <LINK REL="Next"  HREF="017935.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Strange message loss behavior with mirrored	queues</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Strange%20message%20loss%20behavior%20with%20mirrored%0A%09queues&In-Reply-To=%3CCB516E06.2B8AB%25mpietrek%40skytap.com%3E"
       TITLE="[rabbitmq-discuss] Strange message loss behavior with mirrored	queues">mpietrek at skytap.com
       </A><BR>
    <I>Fri Feb  3 18:57:10 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017907.html">[rabbitmq-discuss] Presence Exchange Related Question
</A></li>
        <LI>Next message: <A HREF="017935.html">[rabbitmq-discuss] Strange message loss behavior with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17908">[ date ]</a>
              <a href="thread.html#17908">[ thread ]</a>
              <a href="subject.html#17908">[ subject ]</a>
              <a href="author.html#17908">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm writing some basic throughput tests to verify that RabbitMQ will scale
to our needs in HA environments. In one scenario I'm finding substantial
message loss. It may be Pika clientlib behavior, but even if so, it's very
odd what I'm seeing.

My environment:
* Ubuntu 10.04 with RabbitMQ 2.71.
* Broker instances are all disk nodes.
* Queues are declared as durable and x-ha-policy:all
* Clients are written in Python using Pika 0.9.5.
* For this test, no transactions or publisher-confirms are used.
The test code is extremely simple. It simply reads or writes messages (up to
100,000) as quickly as it can, and shows the throughput rate at 1000 message
intervals.

If I run my &quot;write&quot; test against a single broker instance, I rapidly write
all the messages and after the app exits, I see 100,000 messages in the
queue, as expected.

However, if I add two more brokers to the cluster (such that the queue is
now mirrored), the identical write test yields only ~25K messages in the
queue. (They are the first 25K messages written, FWIW.)

My app calls channel.disconnect() after doing all the writes, so I'd expect
that it would flush its internal buffers before exiting.

I can supply my entire app (about 150 lines of Python) if desired, but for
now, here are the relevant pieces:

def do_write(clientlib):
    for i in range(100000):
        clientlib.write_message(QUEUENAME, &quot;abc_%s&quot; % (i))
    clientlib.disconnect()


class Clientlib(object):
    def connect(self, hostname, use_transactions):
        self.connection = pika.BlockingConnection(
            pika.ConnectionParameters(host=hostname, port=5672))
        self.channel = self.connection.channel()
        self.use_transactions = use_transactions  # This is False for this
test

    def write_message(self, queue_name, json_string):
        self.channel.basic_publish(exchange='',
            routing_key=queue_name,
            body=json_string,
            properties=pika.BasicProperties(delivery_mode=2))

    def disconnect(self):
        self.connection.close()





-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120203/6fc368d8/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120203/6fc368d8/attachment.htm</A>&gt;
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017907.html">[rabbitmq-discuss] Presence Exchange Related Question
</A></li>
	<LI>Next message: <A HREF="017935.html">[rabbitmq-discuss] Strange message loss behavior with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17908">[ date ]</a>
              <a href="thread.html#17908">[ thread ]</a>
              <a href="subject.html#17908">[ subject ]</a>
              <a href="author.html#17908">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
