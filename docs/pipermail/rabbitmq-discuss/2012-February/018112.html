<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20RabbitMQ%20Java%20Client%20%28Memory%0A%09leak%29&In-Reply-To=%3C0BBFDCEB-83D5-4652-909B-D7518F033F70%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017873.html">
   <LINK REL="Next"  HREF="017836.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20RabbitMQ%20Java%20Client%20%28Memory%0A%09leak%29&In-Reply-To=%3C0BBFDCEB-83D5-4652-909B-D7518F033F70%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)">steve at rabbitmq.com
       </A><BR>
    <I>Mon Feb 13 15:47:07 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="017873.html">[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
</A></li>
        <LI>Next message: <A HREF="017836.html">[rabbitmq-discuss] [announce] New maintainer for the rabbitmq-c	library
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18112">[ date ]</a>
              <a href="thread.html#18112">[ thread ]</a>
              <a href="subject.html#18112">[ subject ]</a>
              <a href="author.html#18112">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yogesh,
Sorry not to get back to you sooner.

I'm not at all sure what is causing your leak this time.

Are you using QueueingConsumer? How are your messages being consumed?

From the list of objects I am particularly interested in the ConsumerDispatcher
objects.

These ought to be created one per Channel, and can only be created when calling
the createChannel() method on the Connection interface. So please can you check
that you are not creating lots of channels.

If it is possible, can you construct a small program to demonstrate the leak,
like last time?

Steve Powell  (a happy bunny)
----------some more definitions from the SPD----------
vermin (v.) Treating the dachshund for roundworm.
chinchilla (n.) Cooling device for the lower jaw.
socialcast (n.) Someone to whom everyone is speaking but nobody likes.

On 2 Feb 2012, at 17:32, Yogesh Ketkar wrote:

&gt;<i> Hi Steve,
</I>&gt;<i> 
</I>&gt;<i> Now that I am reusing the channels, memory problem with channels is
</I>&gt;<i> not an issue, but there seems to be some more problem with memory
</I>&gt;<i> leak.
</I>&gt;<i> I had a program which pumped 100000 messages on a queue.
</I>&gt;<i> 
</I>&gt;<i> Then this program kicked in and created certain queues on the fly and
</I>&gt;<i> distributed these messages across them and
</I>&gt;<i> eventually all the messages got consumed.
</I>&gt;<i> 
</I>&gt;<i> Now when all queues in the system are empty, here is the object dump
</I>&gt;<i> and I again see a lot of memory used by
</I>&gt;<i> these objects.
</I>&gt;<i> 
</I>&gt;<i> 96449 instances of class com.rabbitmq.client.AMQP$BasicProperties
</I>&gt;<i> 96428 instances of class com.rabbitmq.client.Envelope
</I>&gt;<i> 96399 instances of class com.rabbitmq.client.impl.ConsumerDispatcher
</I>&gt;<i> $4
</I>&gt;<i> 
</I>&gt;<i> I created BasicProperties object like this, while routing the messages
</I>&gt;<i> to appropriate queue.
</I>&gt;<i>    BasicProperties bp = new BasicProperties();
</I>&gt;<i>    bp.setTimestamp(Calendar.getInstance().getTime());
</I>&gt;<i>    bp.setType(MessageProperties.PERSISTENT_TEXT_PLAIN.toString());
</I>&gt;<i> This was then used in basicPublish method.
</I>&gt;<i> 
</I>&gt;<i> regards, Yogesh
</I>&gt;<i> 
</I>&gt;<i> On Feb 1, 10:37 pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
</I>&gt;&gt;<i> The fix (which we have coded) will be in the next release,
</I>&gt;&gt;<i> but I don't know precisely when that will be.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Steve Powell  (a happy bunny)
</I>&gt;&gt;<i> ----------some more definitions from the SPD----------
</I>&gt;&gt;<i> vermin (v.) Treating the dachshund for roundworm.
</I>&gt;&gt;<i> chinchilla (n.) Cooling device for the lower jaw.
</I>&gt;&gt;<i> socialcast (n.) Someone to whom everyone is speaking but nobody likes.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 1 Feb 2012, at 11:21, Yogesh Ketkar wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Thanks Steve.
</I>&gt;&gt;&gt;<i> Can you give me some idea about date of next Java Client release (with
</I>&gt;&gt;&gt;<i> this bug-fix)?
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> regards, Yogesh
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On Feb 1, 3:42 pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> Yogesh,
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Thank you for this problem report. First point: each connection defines a
</I>&gt;&gt;&gt;&gt;<i> (hidden) channel zero, so that explains why there are 20001 of some objects and
</I>&gt;&gt;&gt;&gt;<i> 20000 of others.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> As to why these are not garbage collected, we must be holding a reference
</I>&gt;&gt;&gt;&gt;<i> somewhere (probably in the Connection).
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> We will investigate. I have raised a bug (24723).
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Steve Powell  (a happy bunny)
</I>&gt;&gt;&gt;&gt;<i> ----------some more definitions from the SPD----------
</I>&gt;&gt;&gt;&gt;<i> vermin (v.) Treating the dachshund for roundworm.
</I>&gt;&gt;&gt;&gt;<i> chinchilla (n.) Cooling device for the lower jaw.
</I>&gt;&gt;&gt;&gt;<i> socialcast (n.) Someone to whom everyone is speaking but nobody likes.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> On 31 Jan 2012, at 17:49, Yogesh Ketkar wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> I am using rabbitmq-java-client-bin-2.7.1/rabbitmq-client.jar with
</I>&gt;&gt;&gt;&gt;&gt;<i> RabbitMQ 2.7.1 Server.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Just run this code
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> public static void main(String[] argv) throws IOException {
</I>&gt;&gt;&gt;&gt;&gt;<i>    ConnectionFactory f = new ConnectionFactory();
</I>&gt;&gt;&gt;&gt;&gt;<i>    Connection c = f.newConnection();
</I>&gt;&gt;&gt;&gt;&gt;<i>    for(int i = 0; i &lt; 20000; ++i) {
</I>&gt;&gt;&gt;&gt;&gt;<i>        Channel ch = c.createChannel();
</I>&gt;&gt;&gt;&gt;&gt;<i>        ch.close();
</I>&gt;&gt;&gt;&gt;&gt;<i>    }
</I>&gt;&gt;&gt;&gt;&gt;<i>    System.gc();
</I>&gt;&gt;&gt;&gt;&gt;<i>    while(true) {}
</I>&gt;&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> While program is running, observe the memory usage, it keeps on
</I>&gt;&gt;&gt;&gt;&gt;<i> increasing
</I>&gt;&gt;&gt;&gt;&gt;<i> Get process id and do following
</I>&gt;&gt;&gt;&gt;&gt;<i> jmap -dump:format=b,file=yo.bin  &lt;pid&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> jhat jhat -J-mx768m -stack false yo.bin
</I>&gt;&gt;&gt;&gt;&gt;<i> Once jhat brings up http server, go here
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://localhost:7000/showInstanceCounts/">http://localhost:7000/showInstanceCounts/</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> 20001 instances of class com.rabbitmq.client.impl.AMQCommand
</I>&gt;&gt;&gt;&gt;&gt;<i> 20001 instances of class com.rabbitmq.client.impl.CommandAssembler
</I>&gt;&gt;&gt;&gt;&gt;<i> 20000 instances of class com.rabbitmq.client.ShutdownSignalException
</I>&gt;&gt;&gt;&gt;&gt;<i> 20000 instances of class com.rabbitmq.client.impl.AMQImpl$Channel
</I>&gt;&gt;&gt;&gt;&gt;<i> $Close
</I>&gt;&gt;&gt;&gt;&gt;<i> 20000 instances of class com.rabbitmq.client.impl.ChannelN
</I>&gt;&gt;&gt;&gt;&gt;<i> 20000 instances of class com.rabbitmq.client.impl.ConsumerDispatcher
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> In-spite of closing all the channels, not only channels but associated
</I>&gt;&gt;&gt;&gt;&gt;<i> objects (ShutdownSignalException, ChannelClose) continue to consume
</I>&gt;&gt;&gt;&gt;&gt;<i> memory.
</I>&gt;&gt;&gt;&gt;&gt;<i> For sure, knowing this now, I will use channelCreate call sparingly.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Is there a way to remedy this situation?
</I>&gt;&gt;&gt;&gt;&gt;<i> What is also worrying is instances of AMQCommand, so would this be the
</I>&gt;&gt;&gt;&gt;&gt;<i> case for each and every call of client library?
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> regards, Yogesh
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017873.html">[rabbitmq-discuss] Problem with RabbitMQ Java Client (Memory	leak)
</A></li>
	<LI>Next message: <A HREF="017836.html">[rabbitmq-discuss] [announce] New maintainer for the rabbitmq-c	library
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18112">[ date ]</a>
              <a href="thread.html#18112">[ thread ]</a>
              <a href="subject.html#18112">[ subject ]</a>
              <a href="author.html#18112">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
