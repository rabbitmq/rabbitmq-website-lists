<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Load%20balancing%20with%20multiple%20consumers%20on%20a%0A%09single%20queue&In-Reply-To=6c2563b20807301052t69687f26p5219e4a5f568b759%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001107.html">
   <LINK REL="Next"  HREF="001110.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue</H1>
    <B>Edwin Fine</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Load%20balancing%20with%20multiple%20consumers%20on%20a%0A%09single%20queue&In-Reply-To=6c2563b20807301052t69687f26p5219e4a5f568b759%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue">rabbitmq-discuss_efine at usa.net
       </A><BR>
    <I>Wed Jul 30 19:08:25 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001107.html">[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
</A></li>
        <LI>Next message: <A HREF="001110.html">[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1108">[ date ]</a>
              <a href="thread.html#1108">[ thread ]</a>
              <a href="subject.html#1108">[ subject ]</a>
              <a href="author.html#1108">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I just noticed David is using Java, so my Erlang-related comments won't be
helpful. Timers and processes have much lower overhead in Erlang than in
other languages so what works for Erlang probably won't work as well in
these languages. I also noticed that things ground to a halt when using 500
consumers doing basic.get in a polling fashion. I'd be very curious to know
what polling interval was used to get RabbitMQ to grind to a halt with 500
consumers.

On Wed, Jul 30, 2008 at 1:52 PM, Edwin Fine
&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss_efine at usa.net</A>&gt;wrote:

&gt;<i> I think I was the one with the basic.qos problem because in stress testing,
</I>&gt;<i> my consumers (started with basic.consume) were being flooded with messages
</I>&gt;<i> and could not keep up, so their Erlang message queues became huge and
</I>&gt;<i> eventually there were memory problems. What I eventually wound up doing was,
</I>&gt;<i> indeed, changing the code to use basic.get with a short timeout. This keeps
</I>&gt;<i> the messages in RabbitMQ's camp. Since they are persistent I imagine they
</I>&gt;<i> will be stored on disk and not take too much memory. Essentially, when I
</I>&gt;<i> receive a basic.get_empty, I call erlang.send_after() to kick off a new
</I>&gt;<i> basic.get in a short while. When the queues are busy, there will be no
</I>&gt;<i> overhead; it's only when idle that there will be a number of timers
</I>&gt;<i> expiring.
</I>&gt;<i>
</I>&gt;<i> So far I have not seen significant performance hits, but then again, I am
</I>&gt;<i> only using 50 queues and and aggregate of 140 messages/second. Maybe
</I>&gt;<i> Matthias's suggestion will work for you.
</I>&gt;<i>
</I>&gt;<i> Hope this helps.
</I>&gt;<i>
</I>&gt;<i> Edwin
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, Jul 30, 2008 at 1:26 PM, Matthias Radestock &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">David.Corcoran at edftrading.com</A> wrote:
</I>&gt;&gt;<i> &gt; I'm not sure how message delivery credits work but having read through a
</I>&gt;&gt;<i> &gt; little it looks like it might be size oriented.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> basic.qos can do count based windows too. So with a window size of one
</I>&gt;&gt;<i> you can guarantee that at most one message is &quot;in flight&quot; or being
</I>&gt;&gt;<i> processed by the consumer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This has come up before, and basic.qos is on our todo list. As with
</I>&gt;&gt;<i> basic.reject, and perhaps more so, there are quite a few challenges in
</I>&gt;&gt;<i> implementing it, which is why it hasn't been done yet. One difficulty is
</I>&gt;&gt;<i> that basic.qos operates on an entire channel (or, optionally, even an
</I>&gt;&gt;<i> entire connection). Since a single channel can consume messages from
</I>&gt;&gt;<i> multiple queues, and these queues can have consumers on other channels
</I>&gt;&gt;<i> (with consumption possibly limited by basic.qos) we basically have a
</I>&gt;&gt;<i> nice little optimisation &amp; consensus problem at our hands: figuring out
</I>&gt;&gt;<i> which queues should send which messages to which channels such that the
</I>&gt;&gt;<i> maximum number of messages gets delivered while staying inside the
</I>&gt;&gt;<i> configured qos limits. And all that in a distributed setting. And the
</I>&gt;&gt;<i> limits change all the time outside the brokers control - clients ack
</I>&gt;&gt;<i> messages whenever they please, the topology may change, etc, etc. Great
</I>&gt;&gt;<i> fun :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Matthias.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> For every expert there is an equal and opposite expert - Arthur C. Clarke
</I>&gt;<i>
</I>


-- 
For every expert there is an equal and opposite expert - Arthur C. Clarke
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080730/990d848d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080730/990d848d/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001107.html">[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
</A></li>
	<LI>Next message: <A HREF="001110.html">[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1108">[ date ]</a>
              <a href="thread.html#1108">[ thread ]</a>
              <a href="subject.html#1108">[ subject ]</a>
              <a href="author.html#1108">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
