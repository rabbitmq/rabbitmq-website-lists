<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Load%20balancing%20with%20multiple%20consumers%20on%20a%0A%09single%20queue&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001095.html">
   <LINK REL="Next"  HREF="001097.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue</H1>
    <B>Nathan Oorloff</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Load%20balancing%20with%20multiple%20consumers%20on%20a%0A%09single%20queue&In-Reply-To="
       TITLE="[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue">nathan at comvine.com
       </A><BR>
    <I>Wed Jul 30 09:33:19 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001095.html">[rabbitmq-discuss] ACK modes in the STOMP adapter
</A></li>
        <LI>Next message: <A HREF="001097.html">[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1096">[ date ]</a>
              <a href="thread.html#1096">[ thread ]</a>
              <a href="subject.html#1096">[ subject ]</a>
              <a href="author.html#1096">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,

I've searched and not seen this issue talked about on the mailing list so I
wanted to generate some discussion regarding the round-robin nature of
having multiple consumers on a single queue.

The scenario I'm using Rabbit-MQ for is as follows:
 - Many producers send messages to a direct exchange that end up in a &quot;job&quot;
queue
 - Many single-threaded consumers are listening on a single job queue using
basic_consume
 - When a consumer receives a job from the queue, they process it, put the
result on a reply queue then ack the message

The round-robin nature of message deliveries is great for load balancing if
all our jobs require equal processing time but this is not the case.. jobs
can range anywhere from a few seconds to a minute worth of processing.

I did up an artificial test where 3 consumers were using basic.consume on a
single queue. Two consumers processed their jobs immediately, however the
final consumer slept for 30 seconds to simulate getting a &quot;big job&quot; before
ack'ing the message and consuming the next one. The result (which I believe
is due to the round-robin nature specified by AMQP) was two consumers
pumping through their jobs and sitting idle, even though there were plenty
of jobs remaining on the queue and the third consumer left busy &quot;processing&quot;
all the &quot;big jobs&quot;.
This was done using Barry Pederson's amqplib-0.3 library in Python.

I don't know erlang well enough to check the source but I assume RabbitMQ
does something like assigning jobs as they come in to each consumer on an
amqp queue? If this is the case, I think the desired behaviour would be
rather than assigning the jobs to a particular consumer immediately, assign
the job to the consumer when it sends an ack for the last message it
received to signify that it is ready to process a new job. This would work
too in the multi-threaded scenario where people wanted to ack the message
immediately before processing it so one thread can process the message
contents whilst the other downloads the next message.

As a work-around at the moment I am ack'ing a message after I receive it and
cancelling the consume before processing the job so other jobs will be
delivered to other consumers however, this means if the job fails for
whatever reason it will not be delivered to another consumer for processing.

I'm happy to put the test code up if anyone is interested in trying this for
themselves.

Nathan.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080730/e0a28f7c/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080730/e0a28f7c/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001095.html">[rabbitmq-discuss] ACK modes in the STOMP adapter
</A></li>
	<LI>Next message: <A HREF="001097.html">[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1096">[ date ]</a>
              <a href="thread.html#1096">[ thread ]</a>
              <a href="subject.html#1096">[ subject ]</a>
              <a href="author.html#1096">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
