<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Load%20balancing%20with%20multiple%20consumers%20on%20a%0A%09single%20queue&In-Reply-To=4890A452.9050300%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001105.html">
   <LINK REL="Next"  HREF="001108.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue</H1>
    <B>Edwin Fine</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Load%20balancing%20with%20multiple%20consumers%20on%20a%0A%09single%20queue&In-Reply-To=4890A452.9050300%40lshift.net"
       TITLE="[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue">rabbitmq-discuss_efine at usa.net
       </A><BR>
    <I>Wed Jul 30 18:52:22 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001105.html">[rabbitmq-discuss] Load balancing with multiple consumers on a single queue
</A></li>
        <LI>Next message: <A HREF="001108.html">[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1107">[ date ]</a>
              <a href="thread.html#1107">[ thread ]</a>
              <a href="subject.html#1107">[ subject ]</a>
              <a href="author.html#1107">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I think I was the one with the basic.qos problem because in stress testing,
my consumers (started with basic.consume) were being flooded with messages
and could not keep up, so their Erlang message queues became huge and
eventually there were memory problems. What I eventually wound up doing was,
indeed, changing the code to use basic.get with a short timeout. This keeps
the messages in RabbitMQ's camp. Since they are persistent I imagine they
will be stored on disk and not take too much memory. Essentially, when I
receive a basic.get_empty, I call erlang.send_after() to kick off a new
basic.get in a short while. When the queues are busy, there will be no
overhead; it's only when idle that there will be a number of timers
expiring.

So far I have not seen significant performance hits, but then again, I am
only using 50 queues and and aggregate of 140 messages/second. Maybe
Matthias's suggestion will work for you.

Hope this helps.

Edwin

On Wed, Jul 30, 2008 at 1:26 PM, Matthias Radestock &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt;wrote:

&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">David.Corcoran at edftrading.com</A> wrote:
</I>&gt;<i> &gt; I'm not sure how message delivery credits work but having read through a
</I>&gt;<i> &gt; little it looks like it might be size oriented.
</I>&gt;<i>
</I>&gt;<i> basic.qos can do count based windows too. So with a window size of one
</I>&gt;<i> you can guarantee that at most one message is &quot;in flight&quot; or being
</I>&gt;<i> processed by the consumer.
</I>&gt;<i>
</I>&gt;<i> This has come up before, and basic.qos is on our todo list. As with
</I>&gt;<i> basic.reject, and perhaps more so, there are quite a few challenges in
</I>&gt;<i> implementing it, which is why it hasn't been done yet. One difficulty is
</I>&gt;<i> that basic.qos operates on an entire channel (or, optionally, even an
</I>&gt;<i> entire connection). Since a single channel can consume messages from
</I>&gt;<i> multiple queues, and these queues can have consumers on other channels
</I>&gt;<i> (with consumption possibly limited by basic.qos) we basically have a
</I>&gt;<i> nice little optimisation &amp; consensus problem at our hands: figuring out
</I>&gt;<i> which queues should send which messages to which channels such that the
</I>&gt;<i> maximum number of messages gets delivered while staying inside the
</I>&gt;<i> configured qos limits. And all that in a distributed setting. And the
</I>&gt;<i> limits change all the time outside the brokers control - clients ack
</I>&gt;<i> messages whenever they please, the topology may change, etc, etc. Great
</I>&gt;<i> fun :)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
For every expert there is an equal and opposite expert - Arthur C. Clarke
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080730/46fc6813/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080730/46fc6813/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001105.html">[rabbitmq-discuss] Load balancing with multiple consumers on a single queue
</A></li>
	<LI>Next message: <A HREF="001108.html">[rabbitmq-discuss] Load balancing with multiple consumers on a	single queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1107">[ date ]</a>
              <a href="thread.html#1107">[ thread ]</a>
              <a href="subject.html#1107">[ subject ]</a>
              <a href="author.html#1107">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
