<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Publisher confirms when the unexpected happens
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Publisher%20confirms%20when%20the%20unexpected%20happens&In-Reply-To=%3C50F1502A.8090406%40frugalit.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024901.html">
   <LINK REL="Next"  HREF="024891.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Publisher confirms when the unexpected happens</H1>
    <B>Chris Duncan</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Publisher%20confirms%20when%20the%20unexpected%20happens&In-Reply-To=%3C50F1502A.8090406%40frugalit.co.uk%3E"
       TITLE="[rabbitmq-discuss] Publisher confirms when the unexpected happens">chris.d at frugalit.co.uk
       </A><BR>
    <I>Sat Jan 12 11:59:38 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="024901.html">[rabbitmq-discuss] Server restart and now Rabbit's	behaving	strangely?!
</A></li>
        <LI>Next message: <A HREF="024891.html">[rabbitmq-discuss] Publisher confirms when the unexpected	happens
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24889">[ date ]</a>
              <a href="thread.html#24889">[ thread ]</a>
              <a href="subject.html#24889">[ subject ]</a>
              <a href="author.html#24889">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I am publishing persistent messages which get routed via a durable 
direct exchange to a durable queue. The channel that I'm using is in 
confirmation mode. There are no consumers subscribed to the queue.

What I would like to understand is what happens if my publisher loses 
its AMQP connection and channels after it has sent all of its messages 
but before it can receive any confirmations. I'm testing this in two ways:

1. My publisher sends its messages and then exits immediately.
2. My publisher sends its messages, closes the connection/channels in a 
controlled manner and then exits.

No. 2 above always results in all of the messages appearing in the 
target queue. I don't have any issues with this behaviour.

However, when I perform No. 1 above, I am observing inconsistent 
behaviour. Sometimes all of the messages appear in the target queue, but 
at other times only some of the messages appear. There are always some 
messages in the queue - never zero.

In the case of No. 1 above, I have observed that when I run my script 
and only some messages appear in the queue, the last TCP frame sent to 
RabbitMQ always contains multiple AMQP basic.publish framesets. Every 
time that the last TCP frame sent contains a single AMQP basic.publish 
frameset, all messages appear in the target queue. This may have no 
bearing on what's happening in RabbitMQ, but the results are always 
predictable based on what I'm seeing going across the wire using Wireshark.

What I was hoping for was an 'all or nothing' outcome for No. 1 as in 
No. 2. So what I'd like to know is - is the behaviour that I'm seeing 
expected from a RabbitMQ point of view?

If anybody wants to run my publisher code then it's here - 
<A HREF="http://gist.github.com/4512337">http://gist.github.com/4512337</A>

My test environments are using Ubuntu 12.04 LTS 32 and 64-bit, Erlang 
R14B04, Ruby gem Bunny 0.9.0.pre5 and Ruby 1.9.3-p362. The Bunny gem can 
be installed by running -

gem install bunny --pre

Regards,

Chris

</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024901.html">[rabbitmq-discuss] Server restart and now Rabbit's	behaving	strangely?!
</A></li>
	<LI>Next message: <A HREF="024891.html">[rabbitmq-discuss] Publisher confirms when the unexpected	happens
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24889">[ date ]</a>
              <a href="thread.html#24889">[ thread ]</a>
              <a href="subject.html#24889">[ subject ]</a>
              <a href="author.html#24889">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
