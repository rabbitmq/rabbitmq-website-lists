<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ and Camel : route interrupted due to &quot;Message dropped on recovery&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20and%20Camel%20%3A%20route%20interrupted%20due%20to%0A%20%22Message%20dropped%20on%20recovery%22&In-Reply-To=%3C11126d73-8df0-40f4-9c4e-d627b8c05028%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024887.html">
   <LINK REL="Next"  HREF="024883.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ and Camel : route interrupted due to &quot;Message dropped on recovery&quot;</H1>
    <B>Andrea Girardi</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20and%20Camel%20%3A%20route%20interrupted%20due%20to%0A%20%22Message%20dropped%20on%20recovery%22&In-Reply-To=%3C11126d73-8df0-40f4-9c4e-d627b8c05028%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ and Camel : route interrupted due to &quot;Message dropped on recovery&quot;">andrea.girardi at gmail.com
       </A><BR>
    <I>Fri Jan 11 13:34:25 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="024887.html">[rabbitmq-discuss] log with rabbitmq-client
</A></li>
        <LI>Next message: <A HREF="024883.html">[rabbitmq-discuss] RabbitMQ and Camel : route interrupted due to &quot;Message dropped on recovery&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24876">[ date ]</a>
              <a href="thread.html#24876">[ thread ]</a>
              <a href="subject.html#24876">[ subject ]</a>
              <a href="author.html#24876">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Hi there,



I'm having a frustrating issue with RabbitMQ and sprimg-amqp, maybe someone 
could help me.


I need to send a message to a queue from an external process (a JUnit class 
just to test if routing works well). This is my camel-context.xml file:


 &lt;camelContext xmlns=&quot;<A HREF="http://camel.apache.org/schema/spring&quot;">http://camel.apache.org/schema/spring&quot;</A>&gt;

&lt;route&gt; 

&lt;from uri=
&quot;spring-amqp:KipcastDirect:KipcastQueue:KipcastRouting?type=direct&amp;amp;autodelete=true&amp;amp;durable=true&quot; 
/&gt;

&lt;log message=&quot;Message received!!! &quot;/&gt; 

&lt;to   uri=
&quot;spring-amqp:KipcastDirect2:TestQueue:KipcastRouting2?type=direct&amp;amp;autodelete=false&amp;amp;durable=true&quot; 
/&gt;

&lt;/route&gt;

&lt;/camelContext&gt;


when I started it using maven camel:run it works fine. The exchange is 
available and also queue in RabbitMQ Management. The problem happens when I 
try to send a message to that Exchange:


ConnectionFactory factory = new ConnectionFactory();

factory.setHost(&quot;10.211.55.20&quot;);

factory.setPort(5672);

factory.setVirtualHost(&quot;/&quot;);

factory.setUsername(&quot;guest&quot;);

factory.setPassword(&quot;guest&quot;);

Connection connection = factory.newConnection();

Channel channel = connection.createChannel();


channel.exchangeDeclare(&quot;KipcastDirect&quot;, &quot;direct&quot;, 

   true, /* durable */

   true, /* autodelete */

   null); /* */

   

byte[] messageBodyBytes = &quot;Hello, world!&quot;.getBytes();

  

AMQP.BasicProperties.Builder bob = new AMQP.BasicProperties.Builder();

AMQP.BasicProperties minBasic = bob.build();

minBasic = bob.priority(0).messageId(&quot;Test&quot;).build(); 

minBasic = bob.priority(0).deliveryMode(1).build(); 


while (true) {


    channel.basicPublish(&quot;KipcastDirect&quot;, &quot;KipcastRouting&quot;, minBasic, 
messageBodyBytes);

    System.out.println(&quot; [x] Sent &quot;);

    

}


Messages are correctly sent to queue (I can see them on log) but an 
exception is raised and the route is stopped:


[     SimpleAsyncTaskExecutor-1] SpringAMQPConsumer             WARN  
Caused by: [
org.springframework.amqp.rabbit.listener.ListenerExecutionFailedException - 
Listener threw exception]

org.springframework.amqp.rabbit.listener.ListenerExecutionFailedException: 
Listener threw exception

at 
org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.wrapToListenerExecutionFailedExceptionIfNeeded(
AbstractMessageListenerContainer.java:590)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.doInvokeListener(
AbstractMessageListenerContainer.java:529)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.invokeListener(
AbstractMessageListenerContainer.java:472)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.access$001(
SimpleMessageListenerContainer.java:56)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer$1.invokeListener(
SimpleMessageListenerContainer.java:103)[spring-rabbit-1.0.0.RELEASE.jar:]

at sun.reflect.GeneratedMethodAccessor21.invoke(Unknown Source)

at sun.reflect.DelegatingMethodAccessorImpl.invoke(
DelegatingMethodAccessorImpl.java:25)[:1.6.0_37]

at java.lang.reflect.Method.invoke(Method.java:597)[:1.6.0_37]

at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(
AopUtils.java:309)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at 
org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(
ReflectiveMethodInvocation.java:183
)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(
ReflectiveMethodInvocation.java:150
)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at 
org.springframework.retry.interceptor.StatefulRetryOperationsInterceptor$MethodInvocationRetryCallback.doWithRetry(
StatefulRetryOperationsInterceptor.java:173
)[spring-retry-1.0.0.RELEASE.jar:]

at org.springframework.retry.support.RetryTemplate.doExecute(
RetryTemplate.java:239)[spring-retry-1.0.0.RELEASE.jar:]

at org.springframework.retry.support.RetryTemplate.execute(
RetryTemplate.java:186)[spring-retry-1.0.0.RELEASE.jar:]

at 
org.springframework.retry.interceptor.StatefulRetryOperationsInterceptor.invoke(
StatefulRetryOperationsInterceptor.java:145
)[spring-retry-1.0.0.RELEASE.jar:]

at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(
ReflectiveMethodInvocation.java:172
)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(
JdkDynamicAopProxy.java:202)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at $Proxy46.invokeListener(Unknown Source)[:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.invokeListener(
SimpleMessageListenerContainer.java:560)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.executeListener(
AbstractMessageListenerContainer.java:452)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.doReceiveAndExecute(
SimpleMessageListenerContainer.java:436)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.receiveAndExecute(
SimpleMessageListenerContainer.java:420)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.access$200(
SimpleMessageListenerContainer.java:56)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer$AsyncMessageProcessingConsumer.run(
SimpleMessageListenerContainer.java:505)[spring-rabbit-1.0.0.RELEASE.jar:]

at java.lang.Thread.run(Thread.java:680)[:1.6.0_37]

[     SimpleAsyncTaskExecutor-1] erationsInterceptorFactoryBean WARN  
Message dropped on recovery: (Body:'Hello, world!'; ID:Test; 
Content:text/plain; Headers:{}; Exchange:KipcastDirect; 
RoutingKey:KipcastRouting; Reply:null; DeliveryMode:NON_PERSISTENT; 
DeliveryTag:2)

org.springframework.amqp.rabbit.listener.ListenerExecutionFailedException: 
Listener threw exception

at 
org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.wrapToListenerExecutionFailedExceptionIfNeeded(
AbstractMessageListenerContainer.java:590)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.doInvokeListener(
AbstractMessageListenerContainer.java:529)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.invokeListener(
AbstractMessageListenerContainer.java:472)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.access$001(
SimpleMessageListenerContainer.java:56)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer$1.invokeListener(
SimpleMessageListenerContainer.java:103)[spring-rabbit-1.0.0.RELEASE.jar:]

at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)[:1.6.0_37]

at sun.reflect.NativeMethodAccessorImpl.invoke(
NativeMethodAccessorImpl.java:39)[:1.6.0_37]

at sun.reflect.DelegatingMethodAccessorImpl.invoke(
DelegatingMethodAccessorImpl.java:25)[:1.6.0_37]

at java.lang.reflect.Method.invoke(Method.java:597)[:1.6.0_37]

at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(
AopUtils.java:309)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at 
org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(
ReflectiveMethodInvocation.java:183
)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(
ReflectiveMethodInvocation.java:150
)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at 
org.springframework.retry.interceptor.StatefulRetryOperationsInterceptor$MethodInvocationRetryCallback.doWithRetry(
StatefulRetryOperationsInterceptor.java:173
)[spring-retry-1.0.0.RELEASE.jar:]

at org.springframework.retry.support.RetryTemplate.doExecute(
RetryTemplate.java:239)[spring-retry-1.0.0.RELEASE.jar:]

at org.springframework.retry.support.RetryTemplate.execute(
RetryTemplate.java:186)[spring-retry-1.0.0.RELEASE.jar:]

at 
org.springframework.retry.interceptor.StatefulRetryOperationsInterceptor.invoke(
StatefulRetryOperationsInterceptor.java:145
)[spring-retry-1.0.0.RELEASE.jar:]

at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(
ReflectiveMethodInvocation.java:172
)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(
JdkDynamicAopProxy.java:202)[spring-aop-3.0.7.RELEASE.jar:3.0.7.RELEASE]

at $Proxy46.invokeListener(Unknown Source)[:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.invokeListener(
SimpleMessageListenerContainer.java:560)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.executeListener(
AbstractMessageListenerContainer.java:452)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.doReceiveAndExecute(
SimpleMessageListenerContainer.java:436)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.receiveAndExecute(
SimpleMessageListenerContainer.java:420)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.access$200(
SimpleMessageListenerContainer.java:56)[spring-rabbit-1.0.0.RELEASE.jar:]

at 
org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer$AsyncMessageProcessingConsumer.run(
SimpleMessageListenerContainer.java:505)[spring-rabbit-1.0.0.RELEASE.jar:]

at java.lang.Thread.run(Thread.java:680)[:1.6.0_37]


What's wrong with that? What's the reason for which I must generate the 
Message ID?


thanks for your time, I really appreciate that.


Andrea
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130111/457257ed/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130111/457257ed/attachment.htm</A>&gt;
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024887.html">[rabbitmq-discuss] log with rabbitmq-client
</A></li>
	<LI>Next message: <A HREF="024883.html">[rabbitmq-discuss] RabbitMQ and Camel : route interrupted due to &quot;Message dropped on recovery&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24876">[ date ]</a>
              <a href="thread.html#24876">[ thread ]</a>
              <a href="subject.html#24876">[ subject ]</a>
              <a href="author.html#24876">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
