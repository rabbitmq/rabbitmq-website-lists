<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RMQ performance between high MHz/low core vs lower MHz/high core servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RMQ%20performance%20between%20high%20MHz/low%20core%20vs%0A%20lower%20MHz/high%20core%20servers&In-Reply-To=%3CCAEnikB558pu10v0FZ%2BEKDwpUjoyd2MUPaHHswAQy3iu5%2Bw0HvA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024793.html">
   <LINK REL="Next"  HREF="024791.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RMQ performance between high MHz/low core vs lower MHz/high core servers</H1>
    <B>Chris Schmidt</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RMQ%20performance%20between%20high%20MHz/low%20core%20vs%0A%20lower%20MHz/high%20core%20servers&In-Reply-To=%3CCAEnikB558pu10v0FZ%2BEKDwpUjoyd2MUPaHHswAQy3iu5%2Bw0HvA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RMQ performance between high MHz/low core vs lower MHz/high core servers">cischmidt77 at gmail.com
       </A><BR>
    <I>Fri Jan  4 23:08:04 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="024793.html">[rabbitmq-discuss] .NET client: intermittentAlreadyClosedException - connected host has failed to respond
</A></li>
        <LI>Next message: <A HREF="024791.html">[rabbitmq-discuss] RMQ performance between high MHz/low core vs lower MHz/high core servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24790">[ date ]</a>
              <a href="thread.html#24790">[ thread ]</a>
              <a href="subject.html#24790">[ subject ]</a>
              <a href="author.html#24790">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the pointers Matthias, I wasn't able to do a lot of changes
before the holidays, but I've done a few things since the last email.

I've updated to RMQ 3.0.1 and R15B03 of Erlang. I noticed a slight
improvement in performance but not much. Increasing the number of queues
also didn't seem to make a large impact. One thing that I'm noticing while
running in HIPE mode is the amount of system utilization on the server.
System utilization is at 85-90% while user processes are only at 8%. I went
to the stock Erlang configuration and just changed the +swt setting. I
noticed that setting it to very_high caused a dip in performance while
very_low was about the same as not modifying the setting.

The server has 4 NUMA nodes configured (one for each 10 core CPU).
Interestingly, running against a single NUMA node by wrapping the start of
RMQ with numactl almost doubles performance. Kernel utilization drops to
15% and user utilization is about the same. As soon as I run RMQ across
more than one NUMA node performance suffers. Is there anything within the
Erlang settings that would allow me to run RMQ across more cores but keep
the kernel utilization down? I'm guessing that schedulers are spawning
across NUMA nodes and passing data back and forth between them, causing the
kernel time to increase. If there is some way to localize the schedulers
that work together within the same node that will be ideal. I tried a few
+sbt options again but that didn't seem to make a difference.

Thanks,

 Chris


On Fri, Dec 21, 2012 at 10:46 AM, Matthias Radestock
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;wrote:

&gt;<i> Chris,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 20/12/12 17:27, Chris Schmidt wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> RHEL 6.2 doesn't seem to have the latest version of Erlang available
</I>&gt;&gt;<i> in the repositories. Does anyone have experience with manually
</I>&gt;&gt;<i> building Erlang on that platform with success? We're on R14B04 right
</I>&gt;&gt;<i> now. There are a huge number of erlang related rpms that get
</I>&gt;&gt;<i> installed I'm not certain if a single Erlang version for CentOS
</I>&gt;&gt;<i> would work properly or not.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You may want to give
</I>&gt;<i> <A HREF="https://my.vmware.com/web/**vmware/details?downloadGroup=**">https://my.vmware.com/web/**vmware/details?downloadGroup=**</A>
</I>&gt;<i> VFEL_15B02&amp;productId=267&lt;<A HREF="https://my.vmware.com/web/vmware/details?downloadGroup=VFEL_15B02&amp;productId=267">https://my.vmware.com/web/vmware/details?downloadGroup=VFEL_15B02&amp;productId=267</A>&gt;
</I>&gt;<i> a try - it's R15B02 (so not quite the latest but close enough) with
</I>&gt;<i> &quot;batteries included&quot;, i.e. no dependencies.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  I had +K true -smp enable +native +sbtps plus the other RMQ defaults
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &quot;+K true&quot; is already part of the standard config. So is &quot;-smp auto&quot;,
</I>&gt;<i> which enables smp when there is more than one core. &quot;+native&quot; is a
</I>&gt;<i> compile-time option and I would not recommend using it. As for +sbtps, I
</I>&gt;<i> suggest you leave that out and stick with the default.
</I>&gt;<i>
</I>&gt;<i> As I said in my earlier email, playing with the +swt option may yield
</I>&gt;<i> some benefits.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  I also had 15 consumers running against the initial queue that was
</I>&gt;&gt;<i> having problems.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Increasing the number of consumers only helps when the consumers, rather
</I>&gt;<i> than the queue, are the bottleneck.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  I also tried sending the data into 2 - 40 exchanges (and updated the
</I>&gt;&gt;<i> queue to read from those exchanges) in order to see if I could spread
</I>&gt;&gt;<i> the load that way.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Exchanges are not represented by processes, so you don't gain anything
</I>&gt;<i> by spreading the load over them. Increasing the number of producers can
</I>&gt;<i> increase the message ingestion rate, but only if the messages get routed to
</I>&gt;<i> different queues.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Does a single process manage each queue?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> yes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  If so I can see that being a potential bottleneck due to the core's
</I>&gt;&gt;<i> speed difference.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Exactly.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Is there an erlang or rabbitmqctl command that I can run against the
</I>&gt;&gt;<i> RMQ server to determine if the queues themselves are the bottleneck?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If the queues are growing then the bottleneck is on the outbound side
</I>&gt;<i> (rabbit's AMQP encoding, network, consumers).
</I>&gt;<i>
</I>&gt;<i> If the queues stay short/empty then the bottleneck is on the inbound side
</I>&gt;<i> (producer, network, rabbit's AMQP decoding, routing, the queue). If
</I>&gt;<i> connections get blocked due to flow control then the bottleneck is in the
</I>&gt;<i> latter three. Narrowing it down any further is tricky.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130104/c1cbea97/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130104/c1cbea97/attachment.htm</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024793.html">[rabbitmq-discuss] .NET client: intermittentAlreadyClosedException - connected host has failed to respond
</A></li>
	<LI>Next message: <A HREF="024791.html">[rabbitmq-discuss] RMQ performance between high MHz/low core vs lower MHz/high core servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24790">[ date ]</a>
              <a href="thread.html#24790">[ thread ]</a>
              <a href="subject.html#24790">[ subject ]</a>
              <a href="author.html#24790">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
