<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Rate limiting queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rate%20limiting%20queues&In-Reply-To=%3C3386E40C-1034-4912-B2D5-D67900C511B9%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024952.html">
   <LINK REL="Next"  HREF="024953.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Rate limiting queues</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rate%20limiting%20queues&In-Reply-To=%3C3386E40C-1034-4912-B2D5-D67900C511B9%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Rate limiting queues">tim at rabbitmq.com
       </A><BR>
    <I>Wed Jan 16 09:53:22 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="024952.html">[rabbitmq-discuss] Rate limiting queues
</A></li>
        <LI>Next message: <A HREF="024953.html">[rabbitmq-discuss] Implementing User Messaging Using RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24954">[ date ]</a>
              <a href="thread.html#24954">[ thread ]</a>
              <a href="subject.html#24954">[ subject ]</a>
              <a href="author.html#24954">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

On 16 Jan 2013, at 00:36, Pedro Werneck wrote:

&gt;<i> I'm running RabbitMQ 3.0.1 with celery 3.0.11 for a stack of applications based on the Python framework Flask, with a demand for a dozen million messages a day.
</I>&gt;<i> 
</I>&gt;<i> The problem is, some queues have to be rate limited dynamically during the day. We had a lot of problems with rate limiting the workers, using the rate_limit provided by celery and other client side solutions, and decided to look for some limiting on the deliver rate by the broker itself. I searched a lot and couldn't find anything like that, which surprised me, nor a reason why something like that isn't implemented.
</I>
Rabbit *does* rate limiting with regards flow control, so if the broker is struggling (e.g., consumers cannot keep up with producers) then back pressure will be exerted on the producers. There's nothing in place right now to rate limit based on other factors, though it's possible such a feature might be useful. How would you envisage something like that working? 

&gt;<i> I found a plugin that implements throttling between the exchange and the queue, but I'm not sure how reliable it is. <A HREF="https://github.com/flopezluis/rabbitmq-throttling-exchange">https://github.com/flopezluis/rabbitmq-throttling-exchange</A>
</I>&gt;<i> 
</I>
I would be cautious about using that. The exchange will be called in the reader process, and I'm pretty certain that performing a blocking receive doesn't make sense there.

&gt;<i> I'm not familiar with Erlang and the RabbitMQ internals, so we adopted an ugly hackish solution for now, which is to have an input queue, an output queue, and a background process using a token bucket algorithm and amqp to get the messages from the input queue and send them back to the exchange and the output queue with the given rate. It isn't pretty, but is working reliably and we know everything that's going on.
</I>&gt;<i> 
</I>
That sounds reasonably sensible to me. I assume you've read <A HREF="http://dougbarth.github.com/2011/06/10/keeping-the-rabbit-on-a-leash.html">http://dougbarth.github.com/2011/06/10/keeping-the-rabbit-on-a-leash.html</A> ??

&gt;<i> Is there any reliable solution I missed? If not, is there any way to improve this solution we adopted?
</I>&gt;<i> 
</I>
It might be more efficient to run the rate limiting process inside the broker using the direct Erlang client to avoid the overhead of serialising data and transmitting it over the network. That's probably a half-way house to just doing this in the broker though.

The broker does have an effective credit-based flow control mechanism already. It might be possible to add additional 'sensors' to the broker which could be used to trigger changes in available credit and cause the flow control mechanism to kick in, though I'm not sure whether this is something that would be considered desirable. It certainly *sounds* interesting, but I suspect it might fall into the category of 'one too many knobs to twiddle' though. Rabbit has been made deliberately minimal with regards knob twiddling.

The *other* thing you might consider is rate limiting at the network level. Decent commercially available load balancers that handle non HTTP traffic can do this for you, though I've not seen any AMQP-aware offerings and this might impact negatively on performance if you can't configure the traffic manager to handle frame sizes correctly.

Cheers,
T

</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024952.html">[rabbitmq-discuss] Rate limiting queues
</A></li>
	<LI>Next message: <A HREF="024953.html">[rabbitmq-discuss] Implementing User Messaging Using RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24954">[ date ]</a>
              <a href="thread.html#24954">[ thread ]</a>
              <a href="subject.html#24954">[ subject ]</a>
              <a href="author.html#24954">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
