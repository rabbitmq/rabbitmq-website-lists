<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] How to debug queue memory leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20to%20debug%20queue%20memory%20leak&In-Reply-To=%3C5106349E.6010208%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025181.html">
   <LINK REL="Next"  HREF="025182.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] How to debug queue memory leak</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20to%20debug%20queue%20memory%20leak&In-Reply-To=%3C5106349E.6010208%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] How to debug queue memory leak">matthias at rabbitmq.com
       </A><BR>
    <I>Mon Jan 28 08:19:42 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025181.html">[rabbitmq-discuss] The message size will slow down the speed of RabbitMQ C library
</A></li>
        <LI>Next message: <A HREF="025182.html">[rabbitmq-discuss] How to debug queue memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25180">[ date ]</a>
              <a href="thread.html#25180">[ thread ]</a>
              <a href="subject.html#25180">[ subject ]</a>
              <a href="author.html#25180">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/01/13 00:53, Max Kuznecov wrote:
&gt;<i> rabbitmqctl report output: <A HREF="http://pastebin.com/7xuebg84">http://pastebin.com/7xuebg84</A>
</I>&gt;<i>
</I>&gt;<i> And the process_info of the queue with highest memory usage:
</I>
Do you remember what the pid was of that queue? So I can correlate that 
with the report output.

Anyway, it looks like all the queues with a high memory usage are 
slow-moving. Since garbage collection is triggered based on the 
reduction count, that means they can hold on to a fair amount of memory. 
By contrast, idle queues go into hibernation, which compacts their memory.

We introduced a background gc in 3.0.0, which should control the memory 
consumption of slow moving queues and other lightly-used processes. 
However, it runs at most once per minute, less frequently if gc takes a 
long of time. I wonder whether that is too infrequent for your usage 
pattern.

This may be particularly an issue when the messages are large. What's 
the average message size passing through the queues?

One way to check whether (lack of) gc is an issue, is to perform an 
explicit gc on the process with

rabbitmqctl eval 'garbage_collect(rabbit_misc:string_to_pid(&quot;&lt;ThePid&gt;&quot;)).'

and see whether that drops the memory usage significantly.

Regards,

Matthias.
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025181.html">[rabbitmq-discuss] The message size will slow down the speed of RabbitMQ C library
</A></li>
	<LI>Next message: <A HREF="025182.html">[rabbitmq-discuss] How to debug queue memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25180">[ date ]</a>
              <a href="thread.html#25180">[ thread ]</a>
              <a href="subject.html#25180">[ subject ]</a>
              <a href="author.html#25180">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
