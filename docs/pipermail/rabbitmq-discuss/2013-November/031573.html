<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] How do you handle recovering from a faulty connection using RabbitMQ java client library?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20do%20you%20handle%20recovering%20from%20a%20faulty%0A%20connection%20using%20RabbitMQ%20java%20client%20library%3F&In-Reply-To=%3CCA%2Bes_-xtQTeSKMo8njPR0BxY7uzyzHE%3DPbo5Ccardg4_PAxNqw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031610.html">
   <LINK REL="Next"  HREF="031580.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] How do you handle recovering from a faulty connection using RabbitMQ java client library?</H1>
    <B>Jonathan Halterman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20do%20you%20handle%20recovering%20from%20a%20faulty%0A%20connection%20using%20RabbitMQ%20java%20client%20library%3F&In-Reply-To=%3CCA%2Bes_-xtQTeSKMo8njPR0BxY7uzyzHE%3DPbo5Ccardg4_PAxNqw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] How do you handle recovering from a faulty connection using RabbitMQ java client library?">jhalterman at gmail.com
       </A><BR>
    <I>Fri Nov  1 04:13:51 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031610.html">[rabbitmq-discuss] messages stuck using shovel
</A></li>
        <LI>Next message: <A HREF="031580.html">[rabbitmq-discuss] How do you handle recovering from a faulty connection using RabbitMQ java client library?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31573">[ date ]</a>
              <a href="thread.html#31573">[ thread ]</a>
              <a href="subject.html#31573">[ subject ]</a>
              <a href="author.html#31573">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Peter,

Solution C is actually pretty reasonable. There's not much to gain from
using multiple connections to the same server if you're trying to guard
against network failures or cluster partitions. If one connection dies,
they all likely will. Wrapping and recovering connections/channels works
fine, and as Michael mentioned, you might also check out Lyra since it
handles the various corner cases involved in recovering resources for you.

Cheers,
Jonathan


On Thu, Oct 31, 2013 at 10:28 AM, Peter Moberg &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">moberg.peter at gmail.com</A>&gt;wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm interested in knowing how other people handle recovering from a faulty
</I>&gt;<i> connection using the official RabbitMQ java client library. We are using it
</I>&gt;<i> to connect our application servers to our RabbitMQ cluster and we have
</I>&gt;<i> implemented a few different ways to recover from a connection failure, but
</I>&gt;<i> non of them feel quite right.
</I>&gt;<i>
</I>&gt;<i> Imagine this pseudo application:
</I>&gt;<i>
</I>&gt;<i> public class OurClassThatStartsConsumers {
</I>&gt;<i>     Connection conn;
</I>&gt;<i>
</I>&gt;<i>     public void start() {
</I>&gt;<i>         ConnectionFactory factory = new ConnectionFactory();
</I>&gt;<i>         factory.setUsername(&quot;someusername&quot;);
</I>&gt;<i>         factory.setPassword(&quot;somepassword&quot;);
</I>&gt;<i>         factory.setHost(&quot;somehost&quot;);
</I>&gt;<i>         conn = factory.newConnection();
</I>&gt;<i>
</I>&gt;<i>         new Thread(new Consumer(conn.createChannel())).start();
</I>&gt;<i>     }
</I>&gt;<i>   }
</I>&gt;<i> class Consumer1 implements Runnable {
</I>&gt;<i>     public Consumer1(Channel channel) {
</I>&gt;<i>          this.channel = channel;
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     @Override
</I>&gt;<i>     public void run() {
</I>&gt;<i>         while (true) {
</I>&gt;<i>              ... consume incoming messages on the channel...
</I>&gt;<i>             // How do we handle that the connection dies?
</I>&gt;<i>         }
</I>&gt;<i>     }}
</I>&gt;<i>
</I>&gt;<i> In the real world we have several hundreds of consumers. So what happens
</I>&gt;<i> if the connection dies? In the above example Consumer1 can not recover,
</I>&gt;<i> when the connection closes, the Channel also closes, a state from which we
</I>&gt;<i> can not recover. So lets look at some ways to solve this:
</I>&gt;<i>
</I>&gt;<i> Solution A)
</I>&gt;<i>
</I>&gt;<i> Let every consumer have their own connection and register the events that
</I>&gt;<i> triggers when the connection dies and then handle reconnecting.
</I>&gt;<i>
</I>&gt;<i> Pros: It works
</I>&gt;<i>
</I>&gt;<i> Cons:
</I>&gt;<i>
</I>&gt;<i>    - Since we have a lot of consumers, we probably do not want that many
</I>&gt;<i>    connections.
</I>&gt;<i>    - We might possible have a lot of duplicated code for reconnecting to
</I>&gt;<i>    rabbit and handle reconnecting
</I>&gt;<i>
</I>&gt;<i> Solution B)
</I>&gt;<i>
</I>&gt;<i> Have each consumer use the same connection and subscribe to its connection
</I>&gt;<i> failure events.
</I>&gt;<i>
</I>&gt;<i> Pros: Less connections than in Solution A
</I>&gt;<i>
</I>&gt;<i> Cons: Since the connection is closed we need to reopen/replace it. The
</I>&gt;<i> java client library doesn't seem to provide a way to reopen the connection,
</I>&gt;<i> so we would have to replace it with a new connection and then somehow
</I>&gt;<i> notify all the consumers about this new connection and they would have to
</I>&gt;<i> recreate the channels and the consumers. Once again, a lot of logic that i
</I>&gt;<i> don't want to see in the consumer ends up there.
</I>&gt;<i>
</I>&gt;<i> Solution C)
</I>&gt;<i>
</I>&gt;<i> Wrap Connection and Channel classes is classes that handle the
</I>&gt;<i> re-connection logic, the consumer only needs to know about the
</I>&gt;<i> WrappedChannel class. On a connection failure the WrappedConnection with
</I>&gt;<i> deal with re-establishing the connection and once connected the
</I>&gt;<i> WrappedConnection will automatically create new Channels and register
</I>&gt;<i> consumers.
</I>&gt;<i>
</I>&gt;<i> Pros: It work - this is actually the solution we are using today.
</I>&gt;<i>
</I>&gt;<i> Cons: It feels like a hack, I think this is something that should be
</I>&gt;<i> handled more elegantly by the underlying library.
</I>&gt;<i>
</I>&gt;<i> Maybe there is a much better way? The API documentation does not talk that
</I>&gt;<i> much about recovering from a faulty connection. Any input is appreciated :)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Peter
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131031/e7ead1b7/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131031/e7ead1b7/attachment.htm</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031610.html">[rabbitmq-discuss] messages stuck using shovel
</A></li>
	<LI>Next message: <A HREF="031580.html">[rabbitmq-discuss] How do you handle recovering from a faulty connection using RabbitMQ java client library?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31573">[ date ]</a>
              <a href="thread.html#31573">[ thread ]</a>
              <a href="subject.html#31573">[ subject ]</a>
              <a href="author.html#31573">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
