<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Outage%20with%203-node%20RabbitMQ%203.1.3%20Cluster&In-Reply-To=%3C144763A1-EDC3-4185-BCE1-01B67E0BB14F%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031740.html">
   <LINK REL="Next"  HREF="031704.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Outage%20with%203-node%20RabbitMQ%203.1.3%20Cluster&In-Reply-To=%3C144763A1-EDC3-4185-BCE1-01B67E0BB14F%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster">watson.timothy at gmail.com
       </A><BR>
    <I>Thu Nov  7 11:47:52 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031740.html">[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster
</A></li>
        <LI>Next message: <A HREF="031704.html">[rabbitmq-discuss] How to backup the queues/messages data on the	fly?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31767">[ date ]</a>
              <a href="thread.html#31767">[ thread ]</a>
              <a href="subject.html#31767">[ subject ]</a>
              <a href="author.html#31767">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matt,

On 6 Nov 2013, at 16:02, Matt Wise wrote:
&gt;<i> &quot;Note that the cluster configuration is applied only to fresh nodes. A fresh nodes is a node which has just been reset or is being start for the first time. Thus, the automatic clustering won't take place after restarts of nodes. This means that any change to the clustering via rabbitmqctl will take precedence over the automatic clustering configuration.&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So far we've taken the approach that clustering configuration should be hard-coded into the rabbitmq.config files. This works well in explicitly defining all of the hosts in a cluster on every machine, but it also means that adding a 4th node to a 3-node cluster will cause the 3 running live nodes to do a full service restart, which is bad.
</I>
That's not strictly necessary - you can add nodes to a cluster without 

&gt;<i> Our rabbitmq.config though is identical on all of the machines (other than the server-list, which may have been in-flux when Puppet was restarting these services)
</I>&gt;<i> 
</I>&gt;<i> [
</I>&gt;<i>         {rabbit, [
</I>&gt;<i>                 {log_levels, [{connection, warning}]},
</I>&gt;<i>                 {cluster_partition_handling,pause_minority},
</I>&gt;<i>                 {tcp_listeners, [ 5672 ] },
</I>&gt;<i>                 {ssl_listeners, [ 5673 ] },
</I>&gt;<i>                 {ssl_options, [{cacertfile,&quot;/etc/rabbitmq/ssl/cacert.pem&quot;},
</I>&gt;<i>                         {certfile,&quot;/etc/rabbitmq/ssl/cert.pem&quot;},
</I>&gt;<i>                         {keyfile,&quot;/etc/rabbitmq/ssl/key.pem&quot;},
</I>&gt;<i>                         {verify,verify_peer},
</I>&gt;<i>                         {fail_if_no_peer_cert,true}
</I>&gt;<i>                 ]},
</I>&gt;<i>                 {cluster_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-23cf477b</A>', '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-07d8bc5f</A>', '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-a3291cf8</A>']}
</I>&gt;<i>         ]}
</I>&gt;<i> ].
</I>&gt;<i>  
</I>&gt;<i> &gt; Questions:
</I>&gt;<i> &gt;   1. We only had ~2500 messages in the queues (they are HA'd and durable). The policy is { 'ha-mode': 'all' }. When serverA and serverB restarted, why did they never come up? Unfortunately in the restart process, they blew away their log files as well which makes this really tough to troubleshoot.
</I>&gt;<i> 
</I>&gt;<i> It's nigh on impossible to guess what might've gone wrong without any log files to verify against. We could sit and stare at all the relevant code for weeks and not spot a bug that's been triggered here, since if it were obvious we would've fixed it already.
</I>&gt;<i> 
</I>&gt;<i> If you can give us a very precise set of steps (and timings) that led to this situation, I can try and replicate what you've seen, but I don't fancy my chances to be honest.
</I>&gt;<i> 
</I>&gt;<i> Its a tough one for us to reproduce.. but I think the closest steps would be:
</I>&gt;<i> 
</I>&gt;<i>   1. Create a 3-node cluster... configured with similar config to the one I pasted above.
</I>&gt;<i>   2. Create enough publishers and subscribers that you have a few hundred messages/sec going through the three machines.
</I>&gt;<i>   3. On MachineA and MachineC, remove MachineB from the config file.
</I>&gt;<i>   4. Restart MachineA's rabbitmq daemon using init script
</I>&gt;<i>   5. Wait 3 minutes... theoretically #4 is still in process.. now issue the same restart to MachineC.
</I>&gt;<i> 
</I>&gt;<i>   Fail.
</I>&gt;<i> 
</I>
We will take a look at that.

&gt;<i> Thats our best guess right now.. but agreed, the logs are a problem. Can we configure RabbitMQ to log through syslog for the future?
</I>&gt;<i> 
</I>
Yes, by replacing the standard OTP logging mechanism with lager, and open source logging framework from Basho Technologies. I have developed a simple plugin (see <A HREF="https://github.com/hyperthunk/rabbitmq-lager">https://github.com/hyperthunk/rabbitmq-lager</A>) that does this for you. See the README for that repository for further details, and README at <A HREF="https://github.com/basho/lager">https://github.com/basho/lager</A> for information on routing to syslog. You can get a binary of the plugin, compiled against R14B03 from <A HREF="https://raw.github.com/hyperthunk/rabbitmq-lager/binary-dist/lager-2.0.0.ez,">https://raw.github.com/hyperthunk/rabbitmq-lager/binary-dist/lager-2.0.0.ez,</A> though you'll need to compile from source if you're running a newer erlang than that. 

&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   2. I know that restarting serverA and serverB at nearly the same time is obviously a bad idea -- we'll be implementing some changes so this doesn't happen again -- but could this have lead to data corruption?
</I>&gt;<i> 
</I>&gt;<i> It's possible, though obviously that shouldn't really happen. How close were the restarts to one another? How many HA queues were mirrored across these nodes, and were they all very busy (as your previous comment about load seems to suggest)? We could try replicating that scenario in our tests, though it's not easy to get the timing right and obviously the existence of network infrastructure on which the nodes are running won't be the same (and that can make a surprisingly big difference IME).
</I>&gt;<i> 
</I>&gt;<i> The restarts were within a few minutes of each other. There are 5 queues, and all 5 queues are set to mirror to 'all' nodes in the cluster. They were busy, but no more than maybe 100 messages/sec coming in/out. 
</I>&gt;<i>  
</I>
I'll take that into account when trying to reproduce - thanks.

&gt;<i> 
</I>&gt;<i> &gt; Once the entire RabbitMQ farm was shut down, we actually were forced to move the rabbitmq data directory out of the way and start up the farm completely with blank databases. It seemed that RabbitMQ 3.1.3 really did not want to recover from this failure. Any thoughts?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   3. Lastly .. in the event of future failures, what tools are there for recovering our Mnesia databases? Is there any way we can dump out the data into some raw form, and then import it back into a new fresh cluster?
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> I'm afraid there are not, at least not &quot;off the shelf&quot; ones anyway. If you are desperate to recover important production data however, I'm sure we could explore the possibility of trying to help with that somehow. Let me know and I'll make some enquiries at this end.
</I>&gt;<i> 
</I>&gt;<i> At this point we can move on from the data loss... but it does make for an interesting issue. Having tools to analyze the Mnesia DB and get &quot;most of&quot; the messages out in some format where they could be re-injected into a fresh cluster would be an incredibly useful tool. I wonder how hard it is to do?
</I>
The messages are not stored in mnesia - we have a &quot;proprietary&quot; on-disk message store. There is a tool that can be used to interact with an offline message store, but it's bit-rotted now and was never fully supported anyway. If a customer does encounter message loss in production, we can offer commercial support to try and resolve the issue, though obviously we're trying very hard to ensure this never happens.

Cheers,
Tim

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131107/af51c695/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131107/af51c695/attachment.htm</A>&gt;
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031740.html">[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster
</A></li>
	<LI>Next message: <A HREF="031704.html">[rabbitmq-discuss] How to backup the queues/messages data on the	fly?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31767">[ date ]</a>
              <a href="thread.html#31767">[ thread ]</a>
              <a href="subject.html#31767">[ subject ]</a>
              <a href="author.html#31767">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
