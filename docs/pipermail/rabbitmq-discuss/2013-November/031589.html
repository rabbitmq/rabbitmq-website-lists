<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Rabbit Cluster &quot;hangs&quot; on consumer disconnects
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rabbit%20Cluster%20%22hangs%22%20on%20consumer%20disconnects&In-Reply-To=%3C0B8CD6850421B745BE39BC5C76019232A683F5F6%40DDCEP50016.na.corp.mckesson.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031588.html">
   <LINK REL="Next"  HREF="031628.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Rabbit Cluster &quot;hangs&quot; on consumer disconnects</H1>
    <B>Cordell, Ron</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rabbit%20Cluster%20%22hangs%22%20on%20consumer%20disconnects&In-Reply-To=%3C0B8CD6850421B745BE39BC5C76019232A683F5F6%40DDCEP50016.na.corp.mckesson.com%3E"
       TITLE="[rabbitmq-discuss] Rabbit Cluster &quot;hangs&quot; on consumer disconnects">Ron.Cordell at RelayHealth.com
       </A><BR>
    <I>Fri Nov  1 17:45:27 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031588.html">[rabbitmq-discuss] rabbitmq nodedown - nodedown - Generic	server rabbit_disk_monitor terminating
</A></li>
        <LI>Next message: <A HREF="031628.html">[rabbitmq-discuss] Rabbit Cluster &quot;hangs&quot; on consumer	disconnects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31589">[ date ]</a>
              <a href="thread.html#31589">[ thread ]</a>
              <a href="subject.html#31589">[ subject ]</a>
              <a href="author.html#31589">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I&#8217;m seeing a strange issue with the Rabbit cluster when we shut down the applications that connect to the cluster.

Here is the setup:

Rabbit 3.1.5 Erlang 16B02 running as a 2-node cluster behind an F5 load balancer
The F5 is currently set to send connections to ONLY the 01 node, but provides a virtual IP to the application.
The application consists of a 5 Windows services running on 4 servers each &#8211; all 5 services connect to the Rabbit cluster and those services are duplicated across 4 servers.

What seems to happen (but not always) is the following sequence of events:


  1.  Issue commands to shut down Windows Services, Windows Services begin shutting down
  2.  At some point during the shutdown process we see the following in the Rabbit logs (truncated for brevity) - there is nothing in the logs before this event, by the way

=WARNING REPORT==== 31-Oct-2013::13:35:57 ===
closing AMQP connection &lt;0.3379.0&gt; (10.100.193.10:50234 -&gt; 10.100.193.80:5672):
connection_closed_abruptly

=WARNING REPORT==== 31-Oct-2013::13:35:57 ===
closing AMQP connection &lt;0.3383.0&gt; (10.100.193.10:50235 -&gt; 10.100.193.80:5672):
connection_closed_abruptly

=WARNING REPORT==== 31-Oct-2013::13:35:57 ===
closing AMQP connection &lt;0.3926.0&gt; (10.100.193.10:50264 -&gt; 10.100.193.80:5672):
connection_closed_abruptly

  1.  The Windows Services that are trying to shut down hang, unable to shut down cleanly
  2.  The F5 load balancer is using a monitor to check to see if the Rabbit nodes are up via the HTTP API, and it shows that both are not responding, so the F5 stops routing traffic to either Rabbit node in the cluster
  3.  Logging onto the rabbit node,
     *   we are able to use the Erlang ping/pong to verify connectivity between nodes
     *   The management plugin UI is unresponsive
     *   We issue a rabbitmqctl stop_app command to node 01, which responds, and we see the following in the rabbit log file:

=INFO REPORT==== 31-Oct-2013::13:56:58 ===
Stopping RabbitMQ

=ERROR REPORT==== 31-Oct-2013::13:57:00 ===
** Generic server &lt;0.6855.0&gt; terminating
** Last message in was {'$gen_cast',
                           {method,
                               {'exchange.unbind',0,
                                   &lt;&lt;&quot;ha-execute_suppressmessagedeliveryactivity&quot;&gt;&gt;,
                                   &lt;&lt;&quot;MassTransit.Diagnostics.Tracing:GetMessageTraceList&quot;&gt;&gt;,
                                   &lt;&lt;&gt;&gt;,false,[]},
                               none,noflow}}
** When Server state == {ch,running,rabbit_framing_amqp_0_9_1,1,&lt;0.4073.0&gt;,
                            &lt;0.6853.0&gt;,&lt;0.4073.0&gt;,
                            &lt;&lt;&quot;10.100.193.10:50286 -&gt; 10.100.193.80:5672&quot;&gt;&gt;,
                            {lstate,&lt;0.6854.0&gt;,false,false},
                            none,1,
                            {[],[]},
                            {user,&lt;&lt;&quot;SJINRMQVORTEXWRITE&quot;&gt;&gt;,[],
                                rabbit_auth_backend_ldap,
                                {impl,
                                    &quot;CN=SJINRMQ VORTEXWRITE,OU=INRMQ,OU=INTEGRATION,OU=Environments,OU=Servers,DC=RHB,DC=AD&quot;,
                                    &lt;&lt;&quot;sQ*4~j5Ca9F_7G&quot;&gt;&gt;}},
                            &lt;&lt;&quot;vortex&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {set,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {set,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            &lt;0.4070.0&gt;,
                            {state,fine,5000,undefined},
                            false,1,
                            {{0,nil},{0,nil}},
                            [],
                            [{&lt;&lt;&quot;publisher_confirms&quot;&gt;&gt;,bool,true},
                             {&lt;&lt;&quot;exchange_exchange_bindings&quot;&gt;&gt;,bool,true},
                             {&lt;&lt;&quot;consumer_cancel_notify&quot;&gt;&gt;,bool,true},
                             {&lt;&lt;&quot;basic.nack&quot;&gt;&gt;,bool,true}],
                            none}
** Reason for termination ==
** {{shutdown,
        {gen_server,call,
            [rabbit_auth_backend_ldap,
             {check_resource,
                 [{username,&lt;&lt;&quot;SJINRMQVORTEXWRITE&quot;&gt;&gt;},
                  {user_dn,
                      &quot;CN=SJINRMQ VORTEXWRITE,OU=INRMQ,OU=INTEGRATION,OU=Environments,OU=Servers,DC=RHB,DC=AD&quot;},
                  {vhost,&lt;&lt;&quot;vortex&quot;&gt;&gt;},
                  {resource,exchange},
                  {name,&lt;&lt;&quot;ha-execute_suppressmessagedeliveryactivity&quot;&gt;&gt;},
                  {permission,write}],
                 {user,&lt;&lt;&quot;SJINRMQVORTEXWRITE&quot;&gt;&gt;,[],rabbit_auth_backend_ldap,
                     {impl,
                         &quot;CN=SJINRMQ VORTEXWRITE,OU=INRMQ,OU=INTEGRATION,OU=Environments,OU=Servers,DC=RHB,DC=AD&quot;,
                         &lt;&lt;&quot;sQ*4~j5Ca9F_7G&quot;&gt;&gt;}}},
             infinity]}},
    [{gen_server,call,3,[{file,&quot;gen_server.erl&quot;},{line,188}]},
     {rabbit_access_control,check_access,5,[]},
     {rabbit_channel,check_resource_access,3,[]},
     {rabbit_channel,binding_action,9,[]},
     {rabbit_channel,handle_cast,2,[]},
     {gen_server2,handle_msg,2,[]},
     {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,249}]}]}

=ERROR REPORT==== 31-Oct-2013::13:57:00 ===
** Generic server &lt;0.16344.0&gt; terminating
** Last message in was {'$gen_cast',
                           {method,
                               {'basic.publish',0,
                                   &lt;&lt;&quot;RelayHealth.MessageExchange.Core.Configuration.Events:MessageSubscribersLoaded&quot;&gt;&gt;,
                                   &lt;&lt;&gt;&gt;,false,false},
                               {content,60,none,
                                   &lt;&lt;48,128,0,0,0,50,12,67,111,110,116,101,110,
                                     116,45,84,121,112,101,83,0,0,0,32,97,112,
                                     112,108,105,99,97,116,105,111,110,47,118,
                                     110,100,46,109,97,115,115,116,114,97,110,
                                     115,105,116,43,106,115,111,110,2,36,49,97,
                                     102,100,48,48,48,48,45,53,50,97,102,45,
                                     100,52,97,101,45,50,56,50,57,45,48,56,100,
                                     48,97,48,52,56,50,53,102,102&gt;&gt;,
                                   rabbit_framing_amqp_0_9_1,
                                   [&lt;&lt;&quot;{\r\n  \&quot;destinationAddress\&quot;: \&quot;<A HREF="rabbitmq://rabbit.integration.rhb.ad/vortex/RelayHealth.MessageExchange.Core.Configuration.Events:MessageSubscribersLoaded\&quot;,\r\n">rabbitmq://rabbit.integration.rhb.ad/vortex/RelayHealth.MessageExchange.Core.Configuration.Events:MessageSubscribersLoaded\&quot;,\r\n</A>  \&quot;headers\&quot;: {},\r\n  \&quot;message\&quot;: {\r\n    \&quot;eventId\&quot;: \&quot;1afd0000-52af-d4ae-dcd2-08d0a04825fe\&quot;,\r\n    \&quot;timeCompleted\&quot;: \&quot;2013-10-31T08:56:47.178316Z\&quot;,\r\n    \&quot;duration\&quot;: \&quot;00:00:00.0624004\&quot;,\r\n    \&quot;initiatingEventId\&quot;: \&quot;1afd0000-52af-d4ae-6927-08d0a04825fc\&quot;,\r\n    \&quot;machineName\&quot;: \&quot;SJINWEB03\&quot;,\r\n    \&quot;processName\&quot;: \&quot;RelayHealth.Services.SubscriberActivityService\&quot;,\r\n    \&quot;messageSubscriberCount\&quot;: 264\r\n  },\r\n  \&quot;messageType\&quot;: [\r\n    \&quot;urn:message:RelayHealth.MessageExchange.Core.Configuration.MessageSubscribers:MessageSubscriberCache+MessageSubscribersLoadedImpl\&quot;,\r\n    \&quot;urn:message:RelayHealth.MessageExchange.Core.Configuration.Events:MessageSubscribersLoaded\&quot;\r\n  ],\r\n  \&quot;sourceAddress\&quot;: \&quot;<A HREF="rabbitmq://rabbit.integration.rhb.ad/vortex/ha-subscriber_activity_service_control_sjinweb03?ha=true&amp;prefetch=1\&quot;\r\n}&quot;">rabbitmq://rabbit.integration.rhb.ad/vortex/ha-subscriber_activity_service_control_sjinweb03?ha=true&amp;prefetch=1\&quot;\r\n}&quot;</A>&gt;&gt;]},
                               flow}}
** When Server state == {ch,running,rabbit_framing_amqp_0_9_1,1,&lt;0.16335.0&gt;,
                            &lt;0.16342.0&gt;,&lt;0.16335.0&gt;,
                            &lt;&lt;&quot;10.100.193.10:54839 -&gt; 10.100.193.80:5672&quot;&gt;&gt;,
                            {lstate,&lt;0.16343.0&gt;,false,false},
                            none,1,
                            {[],[]},
                            {user,&lt;&lt;&quot;SJINRMQVORTEXWRITE&quot;&gt;&gt;,[],
                                rabbit_auth_backend_ldap,
                                {impl,
                                    &quot;CN=SJINRMQ VORTEXWRITE,OU=INRMQ,OU=INTEGRATION,OU=Environments,OU=Servers,DC=RHB,DC=AD&quot;,
                                    &lt;&lt;&quot;sQ*4~j5Ca9F_7G&quot;&gt;&gt;}},
                            &lt;&lt;&quot;vortex&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {set,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {set,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            &lt;0.16333.0&gt;,
                            {state,fine,5000,undefined},
                            true,233,
                            {{0,nil},{0,nil}},
                            [],
                            [{&lt;&lt;&quot;publisher_confirms&quot;&gt;&gt;,bool,true},
                             {&lt;&lt;&quot;exchange_exchange_bindings&quot;&gt;&gt;,bool,true},
                             {&lt;&lt;&quot;consumer_cancel_notify&quot;&gt;&gt;,bool,true},
                             {&lt;&lt;&quot;basic.nack&quot;&gt;&gt;,bool,true}],
                            none}
** Reason for termination ==
** {{shutdown,
        {gen_server,call,
            [rabbit_auth_backend_ldap,
             {check_resource,
                 [{username,&lt;&lt;&quot;SJINRMQVORTEXWRITE&quot;&gt;&gt;},
                  {user_dn,
                      &quot;CN=SJINRMQ VORTEXWRITE,OU=INRMQ,OU=INTEGRATION,OU=Environments,OU=Servers,DC=RHB,DC=AD&quot;},
                  {vhost,&lt;&lt;&quot;vortex&quot;&gt;&gt;},
                  {resource,exchange},
                  {name,
                      &lt;&lt;&quot;RelayHealth.MessageExchange.Core.Configuration.Events:MessageSubscribersLoaded&quot;&gt;&gt;},
                  {permission,write}],
                 {user,&lt;&lt;&quot;SJINRMQVORTEXWRITE&quot;&gt;&gt;,[],rabbit_auth_backend_ldap,
                     {impl,
                         &quot;CN=SJINRMQ VORTEXWRITE,OU=INRMQ,OU=INTEGRATION,OU=Environments,OU=Servers,DC=RHB,DC=AD&quot;,
                         &lt;&lt;&quot;sQ*4~j5Ca9F_7G&quot;&gt;&gt;}}},
             infinity]}},
    [{gen_server,call,3,[{file,&quot;gen_server.erl&quot;},{line,188}]},
     {rabbit_access_control,check_access,5,[]},
     {rabbit_channel,check_resource_access,3,[]},
     {rabbit_channel,handle_method,3,[]},
     {rabbit_channel,handle_cast,2,[]},
     {gen_server2,handle_msg,2,[]},
     {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,249}]}]}

=ERROR REPORT==== 31-Oct-2013::13:57:00 ===
** Generic server &lt;0.7275.0&gt; terminating
** Last message in was {'$gen_cast&#8217;,

. . . Omitting the rest for brevity as there is one of these for every exchange


  1.  We also issue the stop-app on Rabbit node 02 of the cluster
  2.  Then we issue rabbitmqctl start_app on Node 01, and rabbit starts. The F5 sees that the node is available, adds it to the pool of available nodes and begins routing traffic to it, and the Windows services are able to complete shut down.

I&#8217;ve verified that the application code is shutting down connections cleanly. We also don&#8217;t see this behavior with the same application in environments where no rabbit cluster is setup, just a single instance.
This appears to be something that happens to Rabbit itself &#8211; the Erlang portion of things seems to be working OK.

I&#8217;m attempting to replicate this behavior in other environments so I can try to isolate it but haven&#8217;t had a chance to do so thus far, but it does happen in every environment where we have a rabbit cluster.

Any ideas of what I might be missing?

Cheers,

Ron


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131101/1c070404/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131101/1c070404/attachment.htm</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031588.html">[rabbitmq-discuss] rabbitmq nodedown - nodedown - Generic	server rabbit_disk_monitor terminating
</A></li>
	<LI>Next message: <A HREF="031628.html">[rabbitmq-discuss] Rabbit Cluster &quot;hangs&quot; on consumer	disconnects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31589">[ date ]</a>
              <a href="thread.html#31589">[ thread ]</a>
              <a href="subject.html#31589">[ subject ]</a>
              <a href="author.html#31589">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
