<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Outage%20with%203-node%20RabbitMQ%203.1.3%20Cluster&In-Reply-To=%3CCAJbhyRGxcOU8sKH_fJmg9oXhqLuvaJJtRNBa6sA2ZjZGjzo42g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031738.html">
   <LINK REL="Next"  HREF="031740.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster</H1>
    <B>Frank Shearar</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Outage%20with%203-node%20RabbitMQ%203.1.3%20Cluster&In-Reply-To=%3CCAJbhyRGxcOU8sKH_fJmg9oXhqLuvaJJtRNBa6sA2ZjZGjzo42g%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster">frank.shearar at gmail.com
       </A><BR>
    <I>Wed Nov  6 16:18:29 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031738.html">[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster
</A></li>
        <LI>Next message: <A HREF="031740.html">[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31739">[ date ]</a>
              <a href="thread.html#31739">[ thread ]</a>
              <a href="subject.html#31739">[ subject ]</a>
              <a href="author.html#31739">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6 November 2013 16:02, Matt Wise &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matt at nextdoor.com</A>&gt; wrote:
&gt;<i> See comments inline.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, Nov 6, 2013 at 2:37 AM, Tim Watson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Matt,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sorry to hear you've been running into problems.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 5 Nov 2013, at 22:05, Matt Wise wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; (sorry if this gets posted twice.. first email never seemed to make it
</I>&gt;&gt;<i> &gt; to the list)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Hey... I had a pretty rough time today with a 3-node RabbitMQ 3.1.3
</I>&gt;&gt;<i> &gt; cluster thats under pretty heavy use (6-7 million messages per day -- 100MB
</I>&gt;&gt;<i> &gt; peak bandwidth per node). I want to pose a few questions here. First off,
</I>&gt;&gt;<i> &gt; here's the basic configuration though.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Configuration:
</I>&gt;&gt;<i> &gt;   serverA, serverB and serverC are all configured with RabbitMQ 3.1.3.
</I>&gt;&gt;<i> &gt; They each are configured via Puppet ... and Puppet uses a dynamic node
</I>&gt;&gt;<i> &gt; discovery plugin (zookeeper) to find the nodes. The node lists are
</I>&gt;&gt;<i> &gt; hard-coded into the rabbitmq.config file. A dynamic server list generator
</I>&gt;&gt;<i> &gt; supplies Puppet with this list of servers (and is not really necessary to
</I>&gt;&gt;<i> &gt; describe here in this email).
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Scenario:
</I>&gt;&gt;<i> &gt;   A momentary configuration blip caused serverA and serverB to begin
</I>&gt;&gt;<i> &gt; reconfiguring their rabbitmq.config files... when they did this, they also
</I>&gt;&gt;<i> &gt; both issued a 'service rabbitmq restart' command. This command took
</I>&gt;&gt;<i> &gt; 40+minutes and ultimately failed. During this failure, RabbitMQ was
</I>&gt;&gt;<i> &gt; technically running and accepting connections to the TCP ports ... but it
</I>&gt;&gt;<i> &gt; would not actually answer any queries. Commands like list_queues would hang
</I>&gt;&gt;<i> &gt; indefinitely.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What ha recovery policy (if any) do you have set up? A and B might get a
</I>&gt;&gt;<i> different &quot;view of the world&quot; set up in their respective rabbitmq.config
</I>&gt;&gt;<i> files (either to each other and/or to C) and then get restarted, but this
</I>&gt;&gt;<i> should affect their view of the cluster, because as per
</I>&gt;&gt;<i> <A HREF="http://www.rabbitmq.com/clustering.html:">http://www.rabbitmq.com/clustering.html:</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;Note that the cluster configuration is applied only to fresh nodes. A
</I>&gt;&gt;<i> fresh nodes is a node which has just been reset or is being start for the
</I>&gt;&gt;<i> first time. Thus, the automatic clustering won't take place after restarts
</I>&gt;&gt;<i> of nodes. This means that any change to the clustering via rabbitmqctl will
</I>&gt;&gt;<i> take precedence over the automatic clustering configuration.&quot;
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So far we've taken the approach that clustering configuration should be
</I>&gt;<i> hard-coded into the rabbitmq.config files. This works well in explicitly
</I>&gt;<i> defining all of the hosts in a cluster on every machine, but it also means
</I>&gt;<i> that adding a 4th node to a 3-node cluster will cause the 3 running live
</I>&gt;<i> nodes to do a full service restart, which is bad. Our rabbitmq.config though
</I>&gt;<i> is identical on all of the machines (other than the server-list, which may
</I>&gt;<i> have been in-flux when Puppet was restarting these services)
</I>&gt;<i>
</I>&gt;&gt;<i> [
</I>&gt;&gt;<i>         {rabbit, [
</I>&gt;&gt;<i>                 {log_levels, [{connection, warning}]},
</I>&gt;&gt;<i>                 {cluster_partition_handling,pause_minority},
</I>&gt;&gt;<i>                 {tcp_listeners, [ 5672 ] },
</I>&gt;&gt;<i>                 {ssl_listeners, [ 5673 ] },
</I>&gt;&gt;<i>                 {ssl_options,
</I>&gt;&gt;<i> [{cacertfile,&quot;/etc/rabbitmq/ssl/cacert.pem&quot;},
</I>&gt;&gt;<i>                         {certfile,&quot;/etc/rabbitmq/ssl/cert.pem&quot;},
</I>&gt;&gt;<i>                         {keyfile,&quot;/etc/rabbitmq/ssl/key.pem&quot;},
</I>&gt;&gt;<i>                         {verify,verify_peer},
</I>&gt;&gt;<i>                         {fail_if_no_peer_cert,true}
</I>&gt;&gt;<i>                 ]},
</I>&gt;&gt;<i>                 {cluster_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-23cf477b</A>', '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-07d8bc5f</A>',
</I>&gt;&gt;<i> '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at i-a3291cf8</A>']}
</I>&gt;&gt;<i>         ]}
</I>&gt;&gt;<i> ].
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Questions:
</I>&gt;&gt;<i> &gt;   1. We only had ~2500 messages in the queues (they are HA'd and
</I>&gt;&gt;<i> &gt; durable). The policy is { 'ha-mode': 'all' }. When serverA and serverB
</I>&gt;&gt;<i> &gt; restarted, why did they never come up? Unfortunately in the restart process,
</I>&gt;&gt;<i> &gt; they blew away their log files as well which makes this really tough to
</I>&gt;&gt;<i> &gt; troubleshoot.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It's nigh on impossible to guess what might've gone wrong without any log
</I>&gt;&gt;<i> files to verify against. We could sit and stare at all the relevant code for
</I>&gt;&gt;<i> weeks and not spot a bug that's been triggered here, since if it were
</I>&gt;&gt;<i> obvious we would've fixed it already.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you can give us a very precise set of steps (and timings) that led to
</I>&gt;&gt;<i> this situation, I can try and replicate what you've seen, but I don't fancy
</I>&gt;&gt;<i> my chances to be honest.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Its a tough one for us to reproduce.. but I think the closest steps would
</I>&gt;<i> be:
</I>&gt;<i>
</I>&gt;<i>   1. Create a 3-node cluster... configured with similar config to the one I
</I>&gt;<i> pasted above.
</I>&gt;<i>   2. Create enough publishers and subscribers that you have a few hundred
</I>&gt;<i> messages/sec going through the three machines.
</I>&gt;<i>   3. On MachineA and MachineC, remove MachineB from the config file.
</I>&gt;<i>   4. Restart MachineA's rabbitmq daemon using init script
</I>&gt;<i>   5. Wait 3 minutes... theoretically #4 is still in process.. now issue the
</I>&gt;<i> same restart to MachineC.
</I>&gt;<i>
</I>&gt;<i>   Fail.
</I>&gt;<i>
</I>&gt;<i> Thats our best guess right now.. but agreed, the logs are a problem. Can we
</I>&gt;<i> configure RabbitMQ to log through syslog for the future?
</I>
Syslog-ng can tail logs, dumping the logs in some arbitrary
destination (another file, Papertrail, etc.)

frank

&gt;&gt;<i> &gt;   2. I know that restarting serverA and serverB at nearly the same time
</I>&gt;&gt;<i> &gt; is obviously a bad idea -- we'll be implementing some changes so this
</I>&gt;&gt;<i> &gt; doesn't happen again -- but could this have lead to data corruption?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It's possible, though obviously that shouldn't really happen. How close
</I>&gt;&gt;<i> were the restarts to one another? How many HA queues were mirrored across
</I>&gt;&gt;<i> these nodes, and were they all very busy (as your previous comment about
</I>&gt;&gt;<i> load seems to suggest)? We could try replicating that scenario in our tests,
</I>&gt;&gt;<i> though it's not easy to get the timing right and obviously the existence of
</I>&gt;&gt;<i> network infrastructure on which the nodes are running won't be the same (and
</I>&gt;&gt;<i> that can make a surprisingly big difference IME).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The restarts were within a few minutes of each other. There are 5 queues,
</I>&gt;<i> and all 5 queues are set to mirror to 'all' nodes in the cluster. They were
</I>&gt;<i> busy, but no more than maybe 100 messages/sec coming in/out.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Once the entire RabbitMQ farm was shut down, we actually were forced to
</I>&gt;&gt;<i> &gt; move the rabbitmq data directory out of the way and start up the farm
</I>&gt;&gt;<i> &gt; completely with blank databases. It seemed that RabbitMQ 3.1.3 really did
</I>&gt;&gt;<i> &gt; not want to recover from this failure. Any thoughts?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;   3. Lastly .. in the event of future failures, what tools are there for
</I>&gt;&gt;<i> &gt; recovering our Mnesia databases? Is there any way we can dump out the data
</I>&gt;&gt;<i> &gt; into some raw form, and then import it back into a new fresh cluster?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm afraid there are not, at least not &quot;off the shelf&quot; ones anyway. If you
</I>&gt;&gt;<i> are desperate to recover important production data however, I'm sure we
</I>&gt;&gt;<i> could explore the possibility of trying to help with that somehow. Let me
</I>&gt;&gt;<i> know and I'll make some enquiries at this end.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> At this point we can move on from the data loss... but it does make for an
</I>&gt;<i> interesting issue. Having tools to analyze the Mnesia DB and get &quot;most of&quot;
</I>&gt;<i> the messages out in some format where they could be re-injected into a fresh
</I>&gt;<i> cluster would be an incredibly useful tool. I wonder how hard it is to do?
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i> Tim
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I></PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031738.html">[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster
</A></li>
	<LI>Next message: <A HREF="031740.html">[rabbitmq-discuss] Outage with 3-node RabbitMQ 3.1.3 Cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31739">[ date ]</a>
              <a href="thread.html#31739">[ thread ]</a>
              <a href="subject.html#31739">[ subject ]</a>
              <a href="author.html#31739">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
