<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ Crashed!  HA queue disappeared, all messages with delivery_mode=2 are gone!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Crashed%21%20%20HA%20queue%20disappeared%2C%0A%20all%20messages%20with%20delivery_mode%3D2%20are%20gone%21&In-Reply-To=%3C8b2170a1-fa46-45a7-a256-a60a0ae18aa5%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031734.html">
   <LINK REL="Next"  HREF="031744.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ Crashed!  HA queue disappeared, all messages with delivery_mode=2 are gone!</H1>
    <B>Sergey Dobrovolskiy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Crashed%21%20%20HA%20queue%20disappeared%2C%0A%20all%20messages%20with%20delivery_mode%3D2%20are%20gone%21&In-Reply-To=%3C8b2170a1-fa46-45a7-a256-a60a0ae18aa5%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ Crashed!  HA queue disappeared, all messages with delivery_mode=2 are gone!">sergey at openbridge.com
       </A><BR>
    <I>Wed Nov  6 16:23:20 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031734.html">[rabbitmq-discuss] Channel Name
</A></li>
        <LI>Next message: <A HREF="031744.html">[rabbitmq-discuss] RabbitMQ Crashed!  HA queue disappeared, all messages with delivery_mode=2 are gone!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31741">[ date ]</a>
              <a href="thread.html#31741">[ thread ]</a>
              <a href="subject.html#31741">[ subject ]</a>
              <a href="author.html#31741">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everybody,

I'm testing RabbitMQ and can't get it to work properly! 

So that's what I have: 

two c1.xlarge nodes running on EC2. One Ram node and one Disk node. 

I created a test queue. setted up it as a HA mirrored queue like this:

rabbitmqctl set_policy -p / HA &quot;^ha.*&quot; '{&quot;ha-mode&quot;:&quot;all&quot;, 
&gt;<i> &quot;ha-sync-mode&quot;:&quot;automatic&quot;}'
</I>&gt;<i>
</I>
Then ran this command to see if everything worked well:

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbita</A> ~]$ rabbitmqctl list_queues name messages pid slave_pids 
synchronised_slave_pids
Listing queues ...
ha.api.postworker    0    &lt;'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-master</A>'.1.853.0&gt;    
[&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbita.2.1122.0</A>&gt;]    [&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbita.2.1122.0</A>&gt;]


After this I was expecting that all the messages that will get to the queue 
will be automatically synchronised (mirrored) between all nodes. In my case 
there is only one additional node. So I would expect that even if one node 
goes down for some reason, another node would have this queue defined and 
all the messages will still be there. NOTE, I was sending messages with 
delivery_mode set to 2. Meaning they are durable and will be saved to 
disk!!!!

Than the actual test:

1 producer - was sending messages messages at a rate about 2000 msgs/s. 
Each message is about 1kB long. 

Saw that Rabbit setted &quot;Flow control&quot; periodically.

I tried to fill up the queue up to some point. So at the time when I added 
consumers, I had about 200 k msgs in the queue

had 6 consumers:

Each where using basic_consume() 
with prefetch count = 3000

There where about 4k unacknowledged messages  constantly.

THEN BOOM!

RAM node went down and ALL THE MESSAGES and even Queue where deleted, they 
just disappeared. 
here is the screenshot from UI:

You can see that there where 150K messages and then suddenly, 0. + all 
consumers are gone, because they can't connect to the Q.
Also NOTE that even that Disk node  (rabbita) is Red, it will be 
functioning after crash, but the node above, RAM node, will crash.

&lt;<A HREF="https://lh6.googleusercontent.com/-z0jfOUTy5eA/UnpsY_34yHI/AAAAAAAAABA/EJQLb5ou7wA/s1600/rabbitmq.png">https://lh6.googleusercontent.com/-z0jfOUTy5eA/UnpsY_34yHI/AAAAAAAAABA/EJQLb5ou7wA/s1600/rabbitmq.png</A>&gt;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131106/bcb240d2/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131106/bcb240d2/attachment.htm</A>&gt;
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031734.html">[rabbitmq-discuss] Channel Name
</A></li>
	<LI>Next message: <A HREF="031744.html">[rabbitmq-discuss] RabbitMQ Crashed!  HA queue disappeared, all messages with delivery_mode=2 are gone!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31741">[ date ]</a>
              <a href="thread.html#31741">[ thread ]</a>
              <a href="subject.html#31741">[ subject ]</a>
              <a href="author.html#31741">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
