<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Stats node getting slow
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stats%20node%20getting%20slow&In-Reply-To=%3C5280A71C.5050102%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031816.html">
   <LINK REL="Next"  HREF="031831.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Stats node getting slow</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stats%20node%20getting%20slow&In-Reply-To=%3C5280A71C.5050102%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Stats node getting slow">simon at rabbitmq.com
       </A><BR>
    <I>Mon Nov 11 09:45:00 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031816.html">[rabbitmq-discuss] Stats node getting slow
</A></li>
        <LI>Next message: <A HREF="031831.html">[rabbitmq-discuss] Stats node getting slow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31830">[ date ]</a>
              <a href="thread.html#31830">[ thread ]</a>
              <a href="subject.html#31830">[ subject ]</a>
              <a href="author.html#31830">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/11/2013 5:32PM, Pierpaolo Baccichet wrote:
&gt;<i> Things have been working great for almost a year but recently we see,
</I>&gt;<i> unfortunately quite frequently, the stats node all of a sudden starting
</I>&gt;<i> consuming considerable amount of memory munching to death. Last night we
</I>&gt;<i> had again one of these events and the stat node consumed more than 10GB
</I>&gt;<i> of RAM in a matter of 2 hours until I caught it and restart it, which
</I>&gt;<i> brought the cluster back into normal state. We started observing this
</I>&gt;<i> issue a few weeks back (not very frequently) while on 3.1.3 and we still
</I>&gt;<i> see it on 3.2.0. If it helps narrowing down the problem, I don't think I
</I>&gt;<i> ever saw this problem with the 3.0.x series so I am considering to go
</I>&gt;<i> back to those versions but i would like to get an opinion first
</I>
Hmm, the stats DB was more or less rewritten between 3.0.x and 3.1.0 (to 
keep stats histories). If there's a memory leak in there I'd very much 
like to get to the bottom of it.

So to get started, would you be able to send me the output of

$ rabbitmqctl eval '[{T, [KV || KV = {K, _} &lt;- I, lists:member(K, [size, 
memory])]} || T &lt;- ets:all(), I &lt;- [ets:info(T)], 
proplists:get_value(name, I) =:= rabbit_mgmt_db].'

along with

$ rabbitmqctl report

when in this state?

In terms of mitigating this problem:

$ rabbitmqctl eval 'exit(global:whereis_name(rabbit_mgmt_db), die).'

will kill / restart the mgmt DB, so you don't need to restart the entire 
stats node.

It might also be worth setting the force_fine_statistics configuration 
item to false for the rabbitmq_management_agent application (would need 
to be done on every node). This will disable calculation / display of 
message rates, which stands a good chance of disabling whatever code is 
causing the problem.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031816.html">[rabbitmq-discuss] Stats node getting slow
</A></li>
	<LI>Next message: <A HREF="031831.html">[rabbitmq-discuss] Stats node getting slow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31830">[ date ]</a>
              <a href="thread.html#31830">[ thread ]</a>
              <a href="subject.html#31830">[ subject ]</a>
              <a href="author.html#31830">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
