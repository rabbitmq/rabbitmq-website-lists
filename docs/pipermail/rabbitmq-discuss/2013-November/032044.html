<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Excessive RabbitMQ memory consumption
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Excessive%20RabbitMQ%20memory%20consumption&In-Reply-To=%3CCACLE7ixT-ECtXxq8uOeDbuK9L_0Cw2A%3Dfpeae1S1ZqJWUsv%2B0w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032037.html">
   <LINK REL="Next"  HREF="032046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Excessive RabbitMQ memory consumption</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Excessive%20RabbitMQ%20memory%20consumption&In-Reply-To=%3CCACLE7ixT-ECtXxq8uOeDbuK9L_0Cw2A%3Dfpeae1S1ZqJWUsv%2B0w%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Excessive RabbitMQ memory consumption">mpietrek at skytap.com
       </A><BR>
    <I>Thu Nov 21 02:47:25 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="032037.html">[rabbitmq-discuss] Does SSD improve rabbitmq's performance
</A></li>
        <LI>Next message: <A HREF="032046.html">[rabbitmq-discuss] Excessive RabbitMQ memory consumption
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32044">[ date ]</a>
              <a href="thread.html#32044">[ thread ]</a>
              <a href="subject.html#32044">[ subject ]</a>
              <a href="author.html#32044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We have a RabbitMQ cluster in production that seems to be using an
excessive amount of memory. I'm trying to figure out what sort of
diagnostics are available to us.

Background: RabbitMQ 3.0.2, Erlang R15B01 on Ubuntu 10.04 (64-bit).

Yes, we'd love to upgrade to 3.2.1 and the latest Erlang, but this is in
production, and we can't just throw something untested (by us, in our
scenario) into production. So we need to understand what's wrong now, and
then we can test on newer releases to validate things are better.

We've now upped our VM to 8GB, and RabbitMQ/Erlang seem more than happy to
just eat up more memory and keep going. Earlier today a node crashed when
the VM had 4GB, and Rabbit tried to allocate 2.2GB (this was the last entry
in our logs). Nothing else of consequence is running on this VM.

Currently the story looks like this:

Roughly 300 queues. Traffic is about 50 messages/second, although at peak
times it goes to 400/second. However, message rates and memory consumption
seem unrelated. Messages are at most 1KB in size. Connections are steady at
600, with 800 channels. We use message acks. Most messages are unacked for
a few milliseconds before they're acked.

Currently Rabbit is consuming in the neighborhood of 1.8GB (via the web ui)
on average. Here's a breakdown of the node reported memory usage details
from the UI:

Connections 154.9MB
Queues 16.2MB
Plugins 89.6kB
Other process memory 14.2MB
Mnesia 2.6MB
Message store index 2.2MB
Management database  1.3GB
Other ETS tables 6.9MB
Binaries 115.9MB
Code 17.5MB
Atoms 654.9kB
Other system 36.1MB

The management database at 1.3GB seems excessive.

Watching the memory consumption over time, it might drop down to 1 GB, then
peak at 2.4GB. It seems to randomly wander between those values over time.
We have our watermark set at 60%, so 4.7GB there.

Needless to say, this is baffling and concerning.

Are their known issues with this configuration? How can we pin down what's
happening?

Thanks,

Matt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131120/d6b5caf1/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131120/d6b5caf1/attachment.htm</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032037.html">[rabbitmq-discuss] Does SSD improve rabbitmq's performance
</A></li>
	<LI>Next message: <A HREF="032046.html">[rabbitmq-discuss] Excessive RabbitMQ memory consumption
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32044">[ date ]</a>
              <a href="thread.html#32044">[ thread ]</a>
              <a href="subject.html#32044">[ subject ]</a>
              <a href="author.html#32044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
