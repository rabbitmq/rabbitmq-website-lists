<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Feature Req / Bug list
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Feature%20Req%20/%20Bug%20list&In-Reply-To=%3CCAJ4uuZbYqXov-uPYT2evAq8rcCZhRX5wYM7Fmb6OSCMgcyMDoQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032172.html">
   <LINK REL="Next"  HREF="032222.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Feature Req / Bug list</H1>
    <B>Graeme N</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Feature%20Req%20/%20Bug%20list&In-Reply-To=%3CCAJ4uuZbYqXov-uPYT2evAq8rcCZhRX5wYM7Fmb6OSCMgcyMDoQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Feature Req / Bug list">graeme at sudo.ca
       </A><BR>
    <I>Tue Nov 26 22:23:31 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="032172.html">[rabbitmq-discuss] Feature Req / Bug list
</A></li>
        <LI>Next message: <A HREF="032222.html">[rabbitmq-discuss] Feature Req / Bug list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32176">[ date ]</a>
              <a href="thread.html#32176">[ thread ]</a>
              <a href="subject.html#32176">[ subject ]</a>
              <a href="author.html#32176">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hmmm... So, about 1/4 of the queues were approaching being balanced, and
then all of the hosts dropped out of the test cluster.

Looking at the system, only the second instance is even listening on any
network ports, but the beam.smp processes for all instances are still
running:

# netstat -tlpn | grep beam
tcp        0      0 0.0.0.0:44442               0.0.0.0:*
LISTEN      20303/beam.smp
tcp        0      0 0.0.0.0:16639               0.0.0.0:*
LISTEN      20303/beam.smp
tcp        0      0 :::5672                     :::*
LISTEN      20303/beam.smp

# ps axf
12449 ?        S      0:08 /usr/lib64/erlang/erts-5.8.5/bin/epmd -daemon
20183 ?        Sl    13:50 /usr/lib64/erlang/erts-5.8.5/bin/beam.smp -W w
-K true -A30 -P 1048576 -- -root /usr/lib64/erlang -progname erl -- -home
/var/lib/rabbitmq -- -p
20303 ?        Sl    21:31 /usr/lib64/erlang/erts-5.8.5/bin/beam.smp -W w
-K true -A30 -P 1048576 -- -root /usr/lib64/erlang -progname erl -- -home
/var/lib/rabbitmq -- -p
20739 ?        Ss     0:04  \_ inet_gethost 4
20740 ?        S      0:04      \_ inet_gethost 4
20423 ?        Sl    11:24 /usr/lib64/erlang/erts-5.8.5/bin/beam.smp -W w
-K true -A30 -P 1048576 -- -root /usr/lib64/erlang -progname erl -- -home
/var/lib/rabbitmq -- -p
20543 ?        Sl    11:41 /usr/lib64/erlang/erts-5.8.5/bin/beam.smp -W w
-K true -A30 -P 1048576 -- -root /usr/lib64/erlang -progname erl -- -home
/var/lib/rabbitmq -- -p
20663 ?        Sl    10:18 /usr/lib64/erlang/erts-5.8.5/bin/beam.smp -W w
-K true -A30 -P 1048576 -- -root /usr/lib64/erlang -progname erl -- -home
/var/lib/rabbitmq -- -p

I killed them all and started them back up again, the spent a long time
rescanning all their queues, and when the main node (which the queues were
created on) re-entered the cluster, they all crashed again. I blew away the
test cluster, and re-ran the following steps, and had the main node where
all the queues were created and the data loaded stop listening on all its
ports and disconnect from the rest of the cluster. Killing it and
restarting it caused it to reread all its queues, and then drop all its
network listeners and connections to the cluster again.

./create_cluster.sh &amp;&amp; ./setup_queues.sh &amp;&amp; ./populate_queues.sh
./rebalance_cluster.sh

Looking at the logs for instances which drop their network connections
shows some pretty big erlang stack dumps, so I've compressed and uploaded a
sample log file here for you:
<A HREF="https://mega.co.nz/#!31JCGSxa!LdxuhXeX_HN_px8lnQcp63RkFcRY_dW9Z_x9C7qv2aE">https://mega.co.nz/#!31JCGSxa!LdxuhXeX_HN_px8lnQcp63RkFcRY_dW9Z_x9C7qv2aE</A>

Here's my latest set of scripts for reproduction at your end:
<A HREF="https://mega.co.nz/#!Th5UCBZS!eQe9_SmOS5qdv0tP8nUZmnjj7h1QhtOG1i4GrtoYeMU">https://mega.co.nz/#!Th5UCBZS!eQe9_SmOS5qdv0tP8nUZmnjj7h1QhtOG1i4GrtoYeMU</A>

Graeme

On Tue, Nov 26, 2013 at 1:28 PM, Graeme N &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">graeme at sudo.ca</A>&gt; wrote:

&gt;<i> On Tue, Nov 26, 2013 at 1:13 PM, Graeme N &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">graeme at sudo.ca</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, Nov 25, 2013 at 9:39 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Graeme: we recently merged a few fixes to bugs that we found as a result
</I>&gt;&gt;&gt;<i> of running your test scripts; these can be picked up in the latest
</I>&gt;&gt;&gt;<i> nightlies. I am now able to run rebalance_cluster.sh and toggle_nodes.sh
</I>&gt;&gt;&gt;<i> indefinitely without anything breaking.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks for producing these scripts!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131126/e2ccbe88/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131126/e2ccbe88/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032172.html">[rabbitmq-discuss] Feature Req / Bug list
</A></li>
	<LI>Next message: <A HREF="032222.html">[rabbitmq-discuss] Feature Req / Bug list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32176">[ date ]</a>
              <a href="thread.html#32176">[ thread ]</a>
              <a href="subject.html#32176">[ subject ]</a>
              <a href="author.html#32176">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
