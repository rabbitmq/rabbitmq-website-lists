<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] 21673 never recovers from emfile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%2021673%20never%20recovers%20from%20emfile&In-Reply-To=20100115122416.GB2710%40mrnibble.lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005900.html">
   <LINK REL="Next"  HREF="005908.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] 21673 never recovers from emfile</H1>
    <B>tsuraan</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%2021673%20never%20recovers%20from%20emfile&In-Reply-To=20100115122416.GB2710%40mrnibble.lshift.net"
       TITLE="[rabbitmq-discuss] 21673 never recovers from emfile">tsuraan at gmail.com
       </A><BR>
    <I>Fri Jan 15 15:57:00 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="005900.html">[rabbitmq-discuss] 21673 never recovers from emfile
</A></li>
        <LI>Next message: <A HREF="005908.html">[rabbitmq-discuss] 21673 never recovers from emfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5907">[ date ]</a>
              <a href="thread.html#5907">[ thread ]</a>
              <a href="subject.html#5907">[ subject ]</a>
              <a href="author.html#5907">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Hmmm, interesting find. I don't think that this is related to the file
</I>&gt;<i> descriptor management that's going on in the new persister, but I'll
</I>&gt;<i> certainly test and see if I can reproduce.
</I>
Ok, some better test conditions:

Start with a blank rabbit, updated as of this morning (latest
changeset is 2520:4e8508283ca5). Wipe out everything in the
/var/lib/rabbitmq/..., and started rabbit.  Run the following python
program (assuming that amqplib is installed):

from amqplib.client_0_8 import Connection
import sys

def main():
  conns = []
  while True:
    conns.append(Connection('localhost', 'guest', 'guest'))
    sys.stdout.write(&quot;.&quot;)
    sys.stdout.flush()

if __name__ == &quot;__main__&quot;:
  main()

That will run for a while and then hang; I get about 12.5 lines of
output.  At this point, rabbit will print &quot;Erlang has closed&quot;, and the
bottom of the <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node at host.log</A> file will say something like:

=ERROR REPORT==== 15-Jan-2010::09:43:58 ===
** Generic server &lt;0.198.0&gt; terminating
** Last message in was {inet_async,#Port&lt;0.2423&gt;,9030,{ok,#Port&lt;0.9952&gt;}}
** When Server state == none
** Reason for termination ==
** {cannot_accept,{error,emfile}}

At this point, you can never connect again, even if you kill the hog
process that has all of erlang's file descriptors tied up.  Actually,
the last time I ran this test, I also got the following errors:

=ERROR REPORT==== 15-Jan-2010::09:46:08 ===
Mnesia(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mqueue at master</A>): ** ERROR ** (core dumped to file:
&quot;.../<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">MnesiaCore.mqueue at master_1263_570368_405389</A>&quot;)
 ** FATAL ** Cannot open log file &quot;.../rabbit_durable_exchange.DCL&quot;:
{file_error,

                       &quot;.../rabbit_durable_exchange.DCL&quot;,

                       emfile}

=ERROR REPORT==== 15-Jan-2010::09:46:08 ===
** gen_event handler rabbit_error_logger crashed.
** Was installed in error_logger
** Last event was: {error,&lt;0.92.0&gt;,
                       {&lt;0.95.0&gt;,
                        &quot;Mnesia(~p): ** ERROR ** (core dumped to file:
~p)~n ** FATAL ** Cannot open log file ~p: ~p~n&quot;,
                        [<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mqueue at master</A>,
                         &quot;.../<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">MnesiaCore.mqueue at master_1263_570368_405389</A>&quot;,
                         &quot;.../rabbit_durable_exchange.DCL&quot;,
                         {file_error,
                             &quot;.../rabbit_durable_exchange.DCL&quot;,
                             emfile}]}}
** When handler state == {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;amq.rabbitmq.log&quot;&gt;&gt;}
** Reason == {aborted,
                 {no_exists,
                     [rabbit_exchange,
                      {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;amq.rabbitmq.log&quot;&gt;&gt;}]}}

=INFO REPORT==== 15-Jan-2010::09:46:08 ===
    application: mnesia
    exited: shutdown
    type: temporary

So I guess running out of file descriptors is just plain bad.  I think
that the tcp acceptor needs to start rejecting connection attempts one
rabbit only has a dozen or so file descriptors remaining.  It doesn't
look like erlang has a getrlimit function, but there should be some
way to do it.  Anyhow, I hope that helps.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005900.html">[rabbitmq-discuss] 21673 never recovers from emfile
</A></li>
	<LI>Next message: <A HREF="005908.html">[rabbitmq-discuss] 21673 never recovers from emfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5907">[ date ]</a>
              <a href="thread.html#5907">[ thread ]</a>
              <a href="subject.html#5907">[ subject ]</a>
              <a href="author.html#5907">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
