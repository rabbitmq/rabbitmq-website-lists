<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] MulticastMain Java client causes Erlang error eheap_alloc: Cannot allocate 467078560 bytes of memory (of	type &quot;heap&quot;) (with RabbitMQ 1.7.1)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20MulticastMain%20Java%20client%20causes%20Erlang%0A%20error%20eheap_alloc%3A%20Cannot%20allocate%20467078560%20bytes%20of%20memory%20%28of%09type%0A%20%22heap%22%29%20%28with%20RabbitMQ%201.7.1%29&In-Reply-To=173a1edc1001251027i75137559xb52cb561b26c3c58%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005998.html">
   <LINK REL="Next"  HREF="006031.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] MulticastMain Java client causes Erlang error eheap_alloc: Cannot allocate 467078560 bytes of memory (of	type &quot;heap&quot;) (with RabbitMQ 1.7.1)</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20MulticastMain%20Java%20client%20causes%20Erlang%0A%20error%20eheap_alloc%3A%20Cannot%20allocate%20467078560%20bytes%20of%20memory%20%28of%09type%0A%20%22heap%22%29%20%28with%20RabbitMQ%201.7.1%29&In-Reply-To=173a1edc1001251027i75137559xb52cb561b26c3c58%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] MulticastMain Java client causes Erlang error eheap_alloc: Cannot allocate 467078560 bytes of memory (of	type &quot;heap&quot;) (with RabbitMQ 1.7.1)">matthias at lshift.net
       </A><BR>
    <I>Mon Jan 25 19:18:31 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="005998.html">[rabbitmq-discuss] MulticastMain Java client causes Erlang error	eheap_alloc: Cannot allocate 467078560 bytes of memory (of	type &quot;heap&quot;) (with RabbitMQ 1.7.1)
</A></li>
        <LI>Next message: <A HREF="006031.html">[rabbitmq-discuss] MulticastMain Java client causes Erlang	error eheap_alloc: Cannot allocate 467078560 bytes of memory	(of type &quot;heap&quot;) (with RabbitMQ 1.7.1)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6002">[ date ]</a>
              <a href="thread.html#6002">[ thread ]</a>
              <a href="subject.html#6002">[ subject ]</a>
              <a href="author.html#6002">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>John,

John Apps wrote:
&gt;<i> I have installed 1.7.1 in a new directory, recompiled the Java client 
</I>&gt;<i> and tried this test again.
</I>&gt;<i> 
</I>&gt;<i> This is the contents of rabbitmq.config
</I>&gt;<i> [
</I>&gt;<i>   {rabbit, [{vm_memory_high_watermark, 3}]},
</I>&gt;<i>   {rabbit, [{memory_alarms, true}]},
</I>&gt;<i>   {mnesia, [{dump_log_write_threshold, 1000}]},
</I>&gt;<i>   {rabbit, []}
</I>&gt;<i> ].
</I>&gt;<i> I have tried various options with the above vm_memory_high_watermark, 
</I>&gt;<i> e.g., .4, .6 and so forth, the 3 above being from the last try. Perhaps 
</I>&gt;<i> there more options that I missed? It would not surprise me.
</I>
&quot;3&quot; would mean 300% of system memory, which is probably not what you 
want. I'd stick with the default of &quot;0.4&quot; or lower. I also recommend 
checking what limit is being set by looking in the rabbit.log file for 
the line &quot;Memory limit is set to ...&quot;, and to watch out for any memory 
related log messages in general while running your tests.

&gt;<i> Running the MulticastMain (Java) test against RabbitMQ with the 
</I>&gt;<i> parameters shown, leads to an Erlang crash after some time.
</I>&gt;<i> The data below is from a Windows 7 X64 machine running JDK 6 X64.
</I>&gt;<i> 
</I>&gt;<i> &quot;Cannot allocate 467078560 bytes&quot; is the error message.
</I>&gt;<i> 
</I>&gt;<i> C:\AMQP\RabbitMQ\rabbitmq-java-client-1.7.1\test\src&gt;java -server ^
</I>&gt;<i> com.rabbitmq.examples.MulticastMain ^
</I>&gt;<i> -hlocalhost -p5672 -tdirect -eex1 -i10 -m1024 ^
</I>&gt;<i> -n1024 -q20 -r1000 -s100 -x1 -y1
</I>
That actually exposes an area of uncertainty in the AMQP spec: At what 
point do transactional acks affect qos? At the time the ack is received 
by the server, or at the time the commit is received? RabbitMQ currently 
takes the latter view, which means with the above settings the consumer 
will not receive more than 20 messages. I have filed a bug to figure out 
whether that's the correct answer.

Anyway, let that not distract us from figuring out why rabbit runs out 
of memory for you... I tried a slightly modified version of the above, 
removing the rate limit and increasing the size to 1000, in order to put 
the server under memory pressure sooner (since at a rate limit of 1000 
and a message size of 100 it would have take several hours). That did 
cause the memory alarms to go off and the producer to be throttled. What 
do you see on your machine when running with these settings?


Regards,

Matthias.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005998.html">[rabbitmq-discuss] MulticastMain Java client causes Erlang error	eheap_alloc: Cannot allocate 467078560 bytes of memory (of	type &quot;heap&quot;) (with RabbitMQ 1.7.1)
</A></li>
	<LI>Next message: <A HREF="006031.html">[rabbitmq-discuss] MulticastMain Java client causes Erlang	error eheap_alloc: Cannot allocate 467078560 bytes of memory	(of type &quot;heap&quot;) (with RabbitMQ 1.7.1)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6002">[ date ]</a>
              <a href="thread.html#6002">[ thread ]</a>
              <a href="subject.html#6002">[ subject ]</a>
              <a href="author.html#6002">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
