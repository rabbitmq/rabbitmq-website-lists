<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Erlang Client - Unable to Subscribe with basic.consume
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Erlang%20Client%20-%20Unable%20to%20Subscribe%20with%0A%20basic.consume&In-Reply-To=20100109145137.GA5236%40wellquite.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005824.html">
   <LINK REL="Next"  HREF="005829.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Erlang Client - Unable to Subscribe with basic.consume</H1>
    <B>Schlomer, Loren</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Erlang%20Client%20-%20Unable%20to%20Subscribe%20with%0A%20basic.consume&In-Reply-To=20100109145137.GA5236%40wellquite.org"
       TITLE="[rabbitmq-discuss] Erlang Client - Unable to Subscribe with basic.consume">Loren.Schlomer at echostar.com
       </A><BR>
    <I>Mon Jan 11 15:03:16 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="005824.html">[rabbitmq-discuss] Erlang Client - Unable to Subscribe with basic.consume
</A></li>
        <LI>Next message: <A HREF="005829.html">[rabbitmq-discuss] Fwd:  running rabbitmq on a laptop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5837">[ date ]</a>
              <a href="thread.html#5837">[ thread ]</a>
              <a href="subject.html#5837">[ subject ]</a>
              <a href="author.html#5837">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthew, thank you for your help!  The only documentation I could find for subscribing a queue to a pid using basic.consume was here:

<A HREF="http://hopper.squarespace.com/blog/2008/1/12/introducing-the-erlang-amqp-client.html">http://hopper.squarespace.com/blog/2008/1/12/introducing-the-erlang-amqp-client.html</A>

So, it appeared that the only API changes made was the way connection to the broker was established.  Thanks again!

________________________________________
From: <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A> [<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>] On Behalf Of Matthew Sackman [<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at lshift.net</A>]
Sent: Saturday, January 09, 2010 7:51 AM
To: <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Subject: Re: [rabbitmq-discuss] Erlang Client - Unable to Subscribe with basic.consume

Hi Loren,

It depends which version of the Erlang client you're using, because this
has recently changed.

The version that is tagged with rabbitmq_v1_7_0 has a &quot;subscribe&quot;
function. This should be used as:

#'basic.consume_ok'{ consumer_tag = Tag } =
        amqp_channel:subscribe(Chan, #'basic.consume'{ queue = Q }, Pid),

However, I decided that I really didn't like this as it's non obvious
and doesn't match the rest of the API. Thus on default, consume exists
as a normal call. However, there is no Pid argument: instead you should
pass the Chan to the pid that needs to receive the msgs and get it to do
the consumer itself:

#'basic.consume_ok'{ consumer_tag = Tag } =
        amqp_channel:call(Chan, #'basic.consume'{ queue = Q }),

By using the 3-arg version of call, the client thinks that the consume
method has content, which is why it's exploding, as it can't encode
it. This is why we don't want to have the situation where for consumer,
the 3rd-arg is treated as a Pid, whereas for all other methods it's
treated as method content.

Hopefully the API is now more consistent.

Matthew

On Fri, Jan 08, 2010 at 04:01:00PM -0700, Schlomer, Loren wrote:
&gt;<i> I am trying to subscribe a queue to a Pid using:
</I>&gt;<i>
</I>&gt;<i> amqp_channel:call(Channel, #'basic.consume'{queue=QueueName}, Pid)
</I>&gt;<i>
</I>&gt;<i> and using all other default settings in the #'basic.consume' record.  I
</I>&gt;<i> get the following exception stack and have been unable to discover why.
</I>&gt;<i> Any help would be greatly appreciated!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 8-Jan-2010::13:52:43 ===
</I>&gt;<i> ** Generic server &lt;0.44.0&gt; terminating
</I>&gt;<i> ** Last message in was {call,
</I>&gt;<i>                            {'basic.consume',1,
</I>&gt;<i>                                &lt;&lt;&quot;amq.gen-JKETIEiVgO9bzH5ZKfghkA==&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,
</I>&gt;<i>                                false,false,false,false},
</I>&gt;<i>                            &lt;0.47.0&gt;}
</I>&gt;<i> ** When Server state == {c_state,1,&lt;0.37.0&gt;,&lt;0.45.0&gt;,&lt;0.46.0&gt;,network,
</I>&gt;<i>                             {[],[]},
</I>&gt;<i>                             {[],[]},
</I>&gt;<i>                             {dict,0,16,16,8,80,48,
</I>&gt;<i>
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                  []},
</I>&gt;<i>                                 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                   [],[]}}},
</I>&gt;<i>                             false,none,false,none,
</I>&gt;<i>                             {dict,0,16,16,8,80,48,
</I>&gt;<i>
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                  []},
</I>&gt;<i>                                 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                   [],[]}}}}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** {function_clause,[{amqp_channel,build_content,[&lt;0.47.0&gt;]},
</I>&gt;<i>                      {amqp_channel,handle_call,3},
</I>&gt;<i>                      {gen_server,handle_msg,5},
</I>&gt;<i>                      {proc_lib,init_p_do_apply,3}]}
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 8-Jan-2010::13:52:43 ===
</I>&gt;<i> Connection (&lt;0.37.0&gt;) closing: channel (&lt;0.44.0&gt;) died. Reason:
</I>&gt;<i> {function_clause,
</I>&gt;<i>
</I>&gt;<i> [{amqp_channel,
</I>&gt;<i>
</I>&gt;<i> build_content,
</I>&gt;<i>
</I>&gt;<i> [&lt;0.47.0&gt;]},
</I>&gt;<i>
</I>&gt;<i> {amqp_channel,
</I>&gt;<i>
</I>&gt;<i> handle_call,
</I>&gt;<i>                                                                    3},
</I>&gt;<i>
</I>&gt;<i> {gen_server,
</I>&gt;<i>
</I>&gt;<i> handle_msg,
</I>&gt;<i>                                                                    5},
</I>&gt;<i>                                                                   {proc_lib,
</I>&gt;<i>
</I>&gt;<i> init_p_do_apply,
</I>&gt;<i>                                                                    3}]}
</I>&gt;<i> ** exception exit:
</I>&gt;<i> {{function_clause,[{amqp_channel,build_content,[&lt;0.47.0&gt;]},
</I>&gt;<i>                                       {amqp_channel,handle_call,3},
</I>&gt;<i>                                       {gen_server,handle_msg,5},
</I>&gt;<i>                                       {proc_lib,init_p_do_apply,3}]},
</I>&gt;<i>                     {gen_server,call,
</I>&gt;<i>                                 [&lt;0.44.0&gt;,
</I>&gt;<i>                                  {call,{'basic.consume',1,
</I>&gt;<i>
</I>&gt;<i> &lt;&lt;&quot;amq.gen-JKETIEiVgO9bzH5ZKfghkA==&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,false,false,
</I>&gt;<i>                                                         false,false},
</I>&gt;<i>                                        &lt;0.47.0&gt;},
</I>&gt;<i>                                  infinity]}}
</I>&gt;<i>      in function  gen_server:call/3
</I>&gt;<i>      in call from rabbitmq_test:consume/0
</I>&gt;<i> 2&gt;
</I>&gt;<i> =ERROR REPORT==== 8-Jan-2010::13:52:43 ===
</I>&gt;<i> ** Generic server &lt;0.37.0&gt; terminating
</I>&gt;<i> ** Last message in was {'$gen_cast',{method,{'connection.close_ok'},none}}
</I>&gt;<i> ** When Server state == {nc_state,
</I>&gt;<i>
</I>&gt;<i> {amqp_params,&lt;&lt;&quot;guest&quot;&gt;&gt;,&lt;&lt;&quot;guest&quot;&gt;&gt;,&lt;&lt;&quot;/test&quot;&gt;&gt;,
</I>&gt;<i>                                 &quot;localhost&quot;,5672,0,0,0,none},
</I>&gt;<i>                             #Port&lt;0.530&gt;,&lt;0.42.0&gt;,&lt;0.41.0&gt;,&lt;0.40.0&gt;,0,0,
</I>&gt;<i>                             {nc_closing,internal_error,
</I>&gt;<i>                                 {'connection.close',541,&lt;&lt;&gt;&gt;,0,0},
</I>&gt;<i>                                 none,wait_close_ok},
</I>&gt;<i>                             {{0,nil},
</I>&gt;<i>                              {dict,0,16,16,8,80,48,
</I>&gt;<i>                                  {[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                   [],[]},
</I>&gt;<i>
</I>&gt;<i> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                    [],[]}}}}}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** {internal_error,541,&lt;&lt;&gt;&gt;}
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
_______________________________________________
rabbitmq-discuss mailing list
<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005824.html">[rabbitmq-discuss] Erlang Client - Unable to Subscribe with basic.consume
</A></li>
	<LI>Next message: <A HREF="005829.html">[rabbitmq-discuss] Fwd:  running rabbitmq on a laptop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5837">[ date ]</a>
              <a href="thread.html#5837">[ thread ]</a>
              <a href="subject.html#5837">[ subject ]</a>
              <a href="author.html#5837">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
