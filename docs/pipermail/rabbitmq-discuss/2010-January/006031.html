<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] MulticastMain Java client causes Erlang	error eheap_alloc: Cannot allocate 467078560 bytes of memory	(of type &quot;heap&quot;) (with RabbitMQ 1.7.1)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20MulticastMain%20Java%20client%20causes%20Erlang%0A%09error%20eheap_alloc%3A%20Cannot%20allocate%20467078560%20bytes%20of%20memory%0A%09%28of%20type%20%22heap%22%29%20%28with%20RabbitMQ%201.7.1%29&In-Reply-To=4B5DEE87.1090700%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006002.html">
   <LINK REL="Next"  HREF="006033.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] MulticastMain Java client causes Erlang	error eheap_alloc: Cannot allocate 467078560 bytes of memory	(of type &quot;heap&quot;) (with RabbitMQ 1.7.1)</H1>
    <B>John Apps</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20MulticastMain%20Java%20client%20causes%20Erlang%0A%09error%20eheap_alloc%3A%20Cannot%20allocate%20467078560%20bytes%20of%20memory%0A%09%28of%20type%20%22heap%22%29%20%28with%20RabbitMQ%201.7.1%29&In-Reply-To=4B5DEE87.1090700%40lshift.net"
       TITLE="[rabbitmq-discuss] MulticastMain Java client causes Erlang	error eheap_alloc: Cannot allocate 467078560 bytes of memory	(of type &quot;heap&quot;) (with RabbitMQ 1.7.1)">johndapps at gmail.com
       </A><BR>
    <I>Tue Jan 26 15:32:01 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006002.html">[rabbitmq-discuss] MulticastMain Java client causes Erlang error eheap_alloc: Cannot allocate 467078560 bytes of memory (of	type &quot;heap&quot;) (with RabbitMQ 1.7.1)
</A></li>
        <LI>Next message: <A HREF="006033.html">[rabbitmq-discuss] MulticastMain Java client causes Erlang error eheap_alloc: Cannot allocate 467078560 bytes of memory (of type &quot;heap&quot;) (with RabbitMQ 1.7.1)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6031">[ date ]</a>
              <a href="thread.html#6031">[ thread ]</a>
              <a href="subject.html#6031">[ subject ]</a>
              <a href="author.html#6031">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthias,

This is rabbit.log after starting the server:
=INFO REPORT==== 26-Jan-2010::16:09:34 ===
Memory limit set to 1634MB.
=INFO REPORT==== 26-Jan-2010::16:09:34 ===
Rolling persister log to
&quot;c:/AMQP/RabbitMQ/rabbitmq_server-1.7.0/db/rabbit-mnesi
a/rabbit_persister.LOG.previous&quot;
=INFO REPORT==== 26-Jan-2010::16:09:35 ===
started TCP Listener on 0.0.0.0:5672
__________________
These are the parameters, which I hope match what you mean:
java -server ^
com.rabbitmq.examples.MulticastMain ^
-hlocalhost -p5672 -tdirect -eex1 -i10 -m1024 ^
-n1024 -q20 -s1000 -x1 -y1

here we go at 16:19:47.60 2010-01-26
starting consumer #0
starting producer #0
sending rate: 10376 msg/s
sending rate: 10506 msg/s
sending rate: 10141 msg/s
sending rate: 9718 msg/s
sending rate: 8954 msg/s
Exception in thread &quot;Thread-3&quot; java.lang.RuntimeException:
java.io.IOException
        at
com.rabbitmq.examples.MulticastMain$Producer.run(MulticastMain.java:255)
        at java.lang.Thread.run(Unknown Source)
Caused by: java.io.IOException
        at com.rabbitmq.client.impl.AMQChannel.wrap(AMQChannel.java:121)
        at
com.rabbitmq.client.impl.AMQChannel.exnWrappingRpc(AMQChannel.java:139)
        at com.rabbitmq.client.impl.ChannelN.txCommit(ChannelN.java:689)
        at com.rabbitmq.client.impl.ChannelN.txCommit(ChannelN.java:70)
        at
com.rabbitmq.examples.MulticastMain$Producer.run(MulticastMain.java:249)
all done at 16:21:17.15 2010-01-26
...
...

The good news is that it crashes very quickly now, so I do not need to wait
long;)

Which is less than before. The dump is not that big, so I have attached a
ZIPped version:

687,358 erl_crash.dump.

First few lines of the dump (the amount of memory being allocated is a good
bit less than in the last crashes):

Slogan: eheap_alloc: Cannot allocate 298930300 bytes of memory (of type
&quot;heap&quot;).
System version: Erlang R13B03 (erts-5.7.4) [smp:2:2] [rq:2]
[async-threads:30]
Compiled: Tue Nov 24 11:12:28 2009

Cheers, John
_____________________________________________
On Mon, Jan 25, 2010 at 20:18, Matthias Radestock &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt;wrote:

&gt;<i> John,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> John Apps wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I have installed 1.7.1 in a new directory, recompiled the Java client and
</I>&gt;&gt;<i> tried this test again.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is the contents of rabbitmq.config
</I>&gt;&gt;<i> [
</I>&gt;&gt;<i>  {rabbit, [{vm_memory_high_watermark, 3}]},
</I>&gt;&gt;<i>  {rabbit, [{memory_alarms, true}]},
</I>&gt;&gt;<i>  {mnesia, [{dump_log_write_threshold, 1000}]},
</I>&gt;&gt;<i>  {rabbit, []}
</I>&gt;&gt;<i> ].
</I>&gt;&gt;<i> I have tried various options with the above vm_memory_high_watermark,
</I>&gt;&gt;<i> e.g., .4, .6 and so forth, the 3 above being from the last try. Perhaps
</I>&gt;&gt;<i> there more options that I missed? It would not surprise me.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &quot;3&quot; would mean 300% of system memory, which is probably not what you want.
</I>&gt;<i> I'd stick with the default of &quot;0.4&quot; or lower. I also recommend checking what
</I>&gt;<i> limit is being set by looking in the rabbit.log file for the line &quot;Memory
</I>&gt;<i> limit is set to ...&quot;, and to watch out for any memory related log messages
</I>&gt;<i> in general while running your tests.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Running the MulticastMain (Java) test against RabbitMQ with the parameters
</I>&gt;&gt;<i> shown, leads to an Erlang crash after some time.
</I>&gt;&gt;<i> The data below is from a Windows 7 X64 machine running JDK 6 X64.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;Cannot allocate 467078560 bytes&quot; is the error message.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> C:\AMQP\RabbitMQ\rabbitmq-java-client-1.7.1\test\src&gt;java -server ^
</I>&gt;&gt;<i> com.rabbitmq.examples.MulticastMain ^
</I>&gt;&gt;<i> -hlocalhost -p5672 -tdirect -eex1 -i10 -m1024 ^
</I>&gt;&gt;<i> -n1024 -q20 -r1000 -s100 -x1 -y1
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That actually exposes an area of uncertainty in the AMQP spec: At what
</I>&gt;<i> point do transactional acks affect qos? At the time the ack is received by
</I>&gt;<i> the server, or at the time the commit is received? RabbitMQ currently takes
</I>&gt;<i> the latter view, which means with the above settings the consumer will not
</I>&gt;<i> receive more than 20 messages. I have filed a bug to figure out whether
</I>&gt;<i> that's the correct answer.
</I>&gt;<i>
</I>&gt;<i> Anyway, let that not distract us from figuring out why rabbit runs out of
</I>&gt;<i> memory for you... I tried a slightly modified version of the above, removing
</I>&gt;<i> the rate limit and increasing the size to 1000, in order to put the server
</I>&gt;<i> under memory pressure sooner (since at a rate limit of 1000 and a message
</I>&gt;<i> size of 100 it would have take several hours). That did cause the memory
</I>&gt;<i> alarms to go off and the producer to be throttled. What do you see on your
</I>&gt;<i> machine when running with these settings?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>


-- 
---
John Apps
(49) 171 869 1813
Sent from Traunstein, Bavaria, Germany
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100126/822228bf/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100126/822228bf/attachment.htm</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: erl_crash.zip
Type: application/zip
Size: 116926 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100126/822228bf/attachment.zip">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100126/822228bf/attachment.zip</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006002.html">[rabbitmq-discuss] MulticastMain Java client causes Erlang error eheap_alloc: Cannot allocate 467078560 bytes of memory (of	type &quot;heap&quot;) (with RabbitMQ 1.7.1)
</A></li>
	<LI>Next message: <A HREF="006033.html">[rabbitmq-discuss] MulticastMain Java client causes Erlang error eheap_alloc: Cannot allocate 467078560 bytes of memory (of type &quot;heap&quot;) (with RabbitMQ 1.7.1)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6031">[ date ]</a>
              <a href="thread.html#6031">[ thread ]</a>
              <a href="subject.html#6031">[ subject ]</a>
              <a href="author.html#6031">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
