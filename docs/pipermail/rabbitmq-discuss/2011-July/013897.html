<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ HA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20HA&In-Reply-To=%3C20110714135146.GC29337%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013843.html">
   <LINK REL="Next"  HREF="013844.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ HA</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20HA&In-Reply-To=%3C20110714135146.GC29337%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ HA">matthew at rabbitmq.com
       </A><BR>
    <I>Thu Jul 14 14:51:48 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013843.html">[rabbitmq-discuss] RabbitMQ HA
</A></li>
        <LI>Next message: <A HREF="013844.html">[rabbitmq-discuss] OpenAMQ JMS client and RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13897">[ date ]</a>
              <a href="thread.html#13897">[ thread ]</a>
              <a href="subject.html#13897">[ subject ]</a>
              <a href="author.html#13897">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Lucian-Paul,

On Tue, Jul 12, 2011 at 07:54:18PM +0300, Lucian-Paul Torje wrote:
&gt;<i> I'm trying to configure rabbit mq with HA but starting/stopping ($
</I>&gt;<i> /usr/sbin/crm_resource --meta -t primitive -r res_rabbitmq-server_1
</I>&gt;<i> -p target-role -v started) the rabbit mq ogc has no effect, rabbit
</I>&gt;<i> mq is not started/stopped, there is nothing on /var/log/rabbitmq,
</I>&gt;<i> just like the rabbitmq didn't received the command - please advice.
</I>
What about the syslog? pacemaker is normally very noisy about what it's
doing and puts lots of entries into syslog.

&gt;<i> I've added an exit 0 line in /etc/init.d/rabbitmq-server just as
</I>&gt;<i> described in <A HREF="http://www.rabbitmq.com/pacemaker.html">http://www.rabbitmq.com/pacemaker.html</A>
</I>
Ok, and you've checked that rabbit isn't actually running before you
start up pacemaker / corosync?


&gt;<i> Here is my configuration  (I'm using a mounted shared folder and
</I>&gt;<i> already tested starting manually rabbitmq with that mnesia folder -
</I>&gt;<i> /mnt/rabbit_mnesia and it works):
</I>&gt;<i> 
</I>&gt;<i> node ha-node1
</I>&gt;<i> node ha-node2
</I>&gt;<i> primitive res_rabbitmq-server_1 ocf:rabbitmq:rabbitmq-server \
</I>&gt;<i>     params ip=&quot;10.41.0.158&quot; port=&quot;5672&quot;
</I>&gt;<i> config_file=&quot;/etc/rabbitmq/rabbitmq&quot;
</I>&gt;<i> mnesia_base=&quot;/mnt/rabbit_mnesia&quot; \
</I>&gt;<i>     operations $id=&quot;res_rabbitmq-server_1-operations&quot; \
</I>&gt;<i>     op start interval=&quot;0&quot; timeout=&quot;600&quot; \
</I>&gt;<i>     op stop interval=&quot;0&quot; timeout=&quot;120&quot; \
</I>&gt;<i>     op monitor interval=&quot;10&quot; timeout=&quot;20&quot; start-delay=&quot;0&quot; \
</I>&gt;<i>     meta target-role=&quot;started&quot; allow-migrate=&quot;true&quot;
</I>&gt;<i> ms ms_rabbitmq-server_1 res_rabbitmq-server_1 \
</I>&gt;<i>     meta clone-max=&quot;2&quot; notify=&quot;true&quot;
</I>&gt;<i> property $id=&quot;cib-bootstrap-options&quot; \
</I>&gt;<i>     expected-quorum-votes=&quot;2&quot; \
</I>&gt;<i>     dc-version=&quot;1.0.8-042548a451fce8400660f6031f4da6f0223dd5dd&quot; \
</I>&gt;<i>     cluster-infrastructure=&quot;openais&quot; \
</I>&gt;<i>     last-lrm-refresh=&quot;1310489170&quot;
</I>
Here's mine:

virt-debian-4:~# crm configure show
node virt-debian-3
node virt-debian-4
primitive bunny ocf:rabbitmq:rabbitmq-server \
        params mnesia_base=&quot;/media/drbd1&quot; ip=&quot;192.168.122.100&quot; log_base=&quot;/media/drbd1/rabbitmq_logs&quot; config_file=&quot;/etc/rabbitmq/rabbitmq&quot; \
        meta target-role=&quot;Started&quot; is-managed=&quot;true&quot;
primitive drbd ocf:linbit:drbd \
        params drbd_resource=&quot;r0&quot; \
        op monitor interval=&quot;60s&quot;
primitive drbd_fs ocf:heartbeat:Filesystem \
        params device=&quot;/dev/drbd1&quot; directory=&quot;/media/drbd1&quot; fstype=&quot;ext3&quot;
primitive ip ocf:heartbeat:IPaddr2 \
        params ip=&quot;192.168.122.100&quot; cidr_netmask=&quot;24&quot;
ms drbd_ms drbd \
        meta master-max=&quot;1&quot; master-node-max=&quot;1&quot; clone-max=&quot;2&quot; clone-node-max=&quot;1&quot; notify=&quot;true&quot; target-role=&quot;Started&quot;
colocation bunny_on_fs inf: bunny drbd_fs
colocation bunny_on_ip inf: bunny ip
colocation fs_on_drbd inf: drbd_fs drbd_ms:Master
order bunny_after_fs inf: drbd_fs bunny
order bunny_after_ip inf: ip bunny
order fs_after_drbd inf: drbd_ms:promote drbd_fs:start
property $id=&quot;cib-bootstrap-options&quot; \
        dc-version=&quot;1.0.9-74392a28b7f31d7ddc86689598bd23114f58978b&quot; \
        cluster-infrastructure=&quot;openais&quot; \
        expected-quorum-votes=&quot;2&quot; \
        stonith-enabled=&quot;false&quot; \
        no-quorum-policy=&quot;ignore&quot; \
        resource-stickiness=&quot;100&quot; \
        last-lrm-refresh=&quot;1310651109&quot;
rsc_defaults $id=&quot;rsc-options&quot; \
        resource-stickiness=&quot;100&quot;

Differences that appear possibly relevant to me are:

is-managed

I've turned off the no-quorum-policy - if you're doing this with a
cluster of just 2, and you've got one down then it'll never do anything
because it won't be able to reach quorate.

resource-stickiness - this shouldn't affect things starting, but it's
useful to have it set.

stonith-enabled - I have a feeling you may have to set that unless you
actually have STONITH devices lying around.

It should work - the above config works fine for me. I'm afraid you may
just have to dig around the syslogs to try and figure out what the
problem is that is stopping pacemaker from starting up your rabbit.

Matthew
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013843.html">[rabbitmq-discuss] RabbitMQ HA
</A></li>
	<LI>Next message: <A HREF="013844.html">[rabbitmq-discuss] OpenAMQ JMS client and RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13897">[ date ]</a>
              <a href="thread.html#13897">[ thread ]</a>
              <a href="subject.html#13897">[ subject ]</a>
              <a href="author.html#13897">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
