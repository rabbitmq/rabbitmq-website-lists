<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Persistent connections with Amqphp
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Persistent%20connections%20with%20Amqphp&In-Reply-To=%3CCAOvN6FC-tC%2BgV_ysT54RaZR-3P5zeXHNNDE%3DmwOMNTnc1enMTw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013704.html">
   <LINK REL="Next"  HREF="013728.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Persistent connections with Amqphp</H1>
    <B>Robin Harvey</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Persistent%20connections%20with%20Amqphp&In-Reply-To=%3CCAOvN6FC-tC%2BgV_ysT54RaZR-3P5zeXHNNDE%3DmwOMNTnc1enMTw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Persistent connections with Amqphp">harvey.robin at gmail.com
       </A><BR>
    <I>Wed Jul  6 19:24:15 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013704.html">[rabbitmq-discuss] rabbitmq-c amqp_exchange_declare missing	parameter?
</A></li>
        <LI>Next message: <A HREF="013728.html">[rabbitmq-discuss] Persistent connections with Amqphp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13705">[ date ]</a>
              <a href="thread.html#13705">[ thread ]</a>
              <a href="subject.html#13705">[ subject ]</a>
              <a href="author.html#13705">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

A couple of people recently asked about support for persistent connections,
after a bit of hacking around I've uploaded an update which has basic
persistent connection support:
<A HREF="https://github.com/BraveSirRobin/amqphp(check">https://github.com/BraveSirRobin/amqphp(check</A> the 0.9.1 tag)


The implementation turned out to be fairly straightforward, I only had to
add the STREAM_CLIENT_PERSIST flag to the existing stream_socket_client()
call, so the changes weren't too invasive.  I've created a new &quot;Connection&quot;
object called PConnection, and set up a simple framework to persist amqp
connection parameters between web requests.  The amqp connection setup
process is only run the first time the PConnection is opened, so both the
Amqp &quot;session&quot; and TCP connection remain after the web request and are
re-used by subsequent requests to that process.  My plan is to add support
for persisting Channels as well, possibly by having API calls use
channel.flow to inform the broker during the web request wakeup / sleep
routines.

I'd be interested to hear what the RabbitMQ people think about the likely
behavior of PHP &quot;persistent connections&quot;, which may include:

 * If the web server is restarted, all open client connections are dropped
without going through the amqp shutdown sequence, so you get lots of &quot;closed
abruptly&quot; errors in the log.
 * If a web server has no web requests to process then the persistent client
can't respond to any messages the broker sends; the client will &quot;go quiet&quot;.

In case you don't know what PHP persistent connections are, they're
basically a socket re-use method for web servers, the idea is that the
socket remains open between web requests in order to avoid TCP setup /
teardown overheads on busy sites.

If you'd like to test this then check out the demo-multi-producer.php
script, I've run this inside a PHP-FPM / Nginx setup and it seems to work
fine.

Thanks,
--Robin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110706/2bd318c5/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110706/2bd318c5/attachment.htm</A>&gt;
</PRE>








































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013704.html">[rabbitmq-discuss] rabbitmq-c amqp_exchange_declare missing	parameter?
</A></li>
	<LI>Next message: <A HREF="013728.html">[rabbitmq-discuss] Persistent connections with Amqphp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13705">[ date ]</a>
              <a href="thread.html#13705">[ thread ]</a>
              <a href="subject.html#13705">[ subject ]</a>
              <a href="author.html#13705">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
