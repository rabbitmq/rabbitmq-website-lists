<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] precondition_failed error with amqp_client	for erlang
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20precondition_failed%20error%20with%20amqp_client%0A%09for%20erlang&In-Reply-To=%3CCAApCF45mYRGXzz1BcpTxd0cLC7EQrZ%2BpMui%2B%3D5Giq6QZxfzVaw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013635.html">
   <LINK REL="Next"  HREF="013820.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] precondition_failed error with amqp_client	for erlang</H1>
    <B>Max Warnock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20precondition_failed%20error%20with%20amqp_client%0A%09for%20erlang&In-Reply-To=%3CCAApCF45mYRGXzz1BcpTxd0cLC7EQrZ%2BpMui%2B%3D5Giq6QZxfzVaw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] precondition_failed error with amqp_client	for erlang">maxjwarnock at gmail.com
       </A><BR>
    <I>Tue Jul  5 16:28:46 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013635.html">[rabbitmq-discuss] precondition_failed error with amqp_client for erlang
</A></li>
        <LI>Next message: <A HREF="013820.html">[rabbitmq-discuss] precondition_failed error with amqp_client for erlang
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13664">[ date ]</a>
              <a href="thread.html#13664">[ thread ]</a>
              <a href="subject.html#13664">[ subject ]</a>
              <a href="author.html#13664">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry about the ambiguity,

For the sake of clarity here is the glossary of terms I used in my last
email (which probably clashes with the erlang/amqp_client context you're
coming from):

Server - I'm referring to my long running process in erlang that I have
given a registered name and passed as the 3rd argument to
amqp_client:subscribe/3.
Listener - the process created by the amqp_client library when a connection
and channel are opened
Subscribe - calling of amqp_client:subscribe/3
My - I'm using this pronoun to distinguish code written by me from code
written by you cats at rabbitmq (client library, rabbitmq server, etc)

I've attached a diagram (approximation/abstraction) of how I'm interacting
with the amqp_client library. (sorry to the mailing list if attaching a 40K
diagram breaks etiquette).

I'm using the amqp_client library in network mode, i.e.,
amqp_client:start(network, #amqp_params{host = Host, heartbeat=60000})

Yes a list of messages that the amqp_client process sends to a subscriber,
particularly pertaining to errors in amqp_client land, would be very
helpful.  I'd like to be able to handle all {'DOWN',Etc} messages with my
long running process (server).  I'm hoping to handle all hard errors so that
a restart from either supervisor (my long running process or the
amqp_client's) won't break the communication between the two.

But I get the impression that I'm missing something about how I'm supposed
to treat the amqp_client library with regard to amqp_client:start/2.  Should
I be treating the amqp_client connection like mnesia (an application
entirely independent of mine), add it to my existing supervision tree and
share one connection throughout my application, or, what I'm currently
doing, let each part of my application that needs to talk to amqp spin up
and close their own connection/channel?

Thanks,
-Max

On Mon, Jul 4, 2011 at 12:16 PM, Alexandru Scvor&#355;ov
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexandru at rabbitmq.com</A>&gt;wrote:

&gt;<i> Hi Max,
</I>&gt;<i>
</I>&gt;<i> I'm trying to run through the steps you provided, but I'm having a bit
</I>&gt;<i> of trouble following.
</I>&gt;<i>
</I>&gt;<i> Are you using a network or a direct connection? (I assume network, but
</I>&gt;<i> it probably doesn't matter)
</I>&gt;<i>
</I>&gt;<i> By server, do you mean the actual RabbitMQ server, or you application?
</I>&gt;<i> (I'm guessing your long-running application)
</I>&gt;<i>
</I>&gt;<i> By subscribe, do you mean calling amqp_channel:subscribe/3?  If so, do
</I>&gt;<i> you still need a list of the messages the channel may send its
</I>&gt;<i> subscriber?
</I>&gt;<i>
</I>&gt;<i> Or do you mean that your application is sending messages to its
</I>&gt;<i> subscribers?
</I>&gt;<i>
</I>&gt;<i> &gt; 6.) The server supervisor restarts the server which creates a new
</I>&gt;<i> listener,
</I>&gt;<i> &gt; but the old listener is still hanging around trying to send the the
</I>&gt;<i> &gt; registered name
</I>&gt;<i>
</I>&gt;<i> What's a listener?  Is it a process that receives messages from the
</I>&gt;<i> erlang client because it's the endpoint of a subscription to a queue?
</I>&gt;<i>
</I>&gt;<i> Can't you link listeners to the server so that when the server goes
</I>&gt;<i> down, it takes the listeners with it?
</I>&gt;<i>
</I>&gt;<i> &gt; So my question then is how should I kill the amqp_client?
</I>&gt;<i>
</I>&gt;<i> What do you mean by amqp_client?  If it's an amqp_connection process,
</I>&gt;<i> you can just send it an shutdown exit.
</I>&gt;<i>
</I>&gt;<i> Thanks for the information.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;<i> On Fri, Jul 01, 2011 at 01:51:10PM -0400, Max Warnock wrote:
</I>&gt;<i> &gt; Problem found.  Thanks for your help.  The problem is a strange one and
</I>&gt;<i> has
</I>&gt;<i> &gt; to do with me not shutting my amqp_client listener down properly if my
</I>&gt;<i> &gt; server dies.  Here is how it manifests:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1.) Server starts up and starts up a amqp client connection and channel
</I>&gt;<i> &gt; 2.) The server binds to that channel and starts the subscription using a
</I>&gt;<i> &gt; registered name name as the process to which messages will be sent
</I>&gt;<i> &gt; 3.) Messages start coming in and are ack-ing fine
</I>&gt;<i> &gt; 4.) Poor error handling in farming out processes brings the server down
</I>&gt;<i> &gt; 5.) The server does no close the amqp_client connection
</I>&gt;<i> &gt; 6.) The server supervisor restarts the server which creates a new
</I>&gt;<i> listener,
</I>&gt;<i> &gt; but the old listener is still hanging around trying to send the the
</I>&gt;<i> &gt; registered name
</I>&gt;<i> &gt; 7.) The older listener sends a message to the server
</I>&gt;<i> &gt; 8.) The server tries to ack to the new listener which did not send the
</I>&gt;<i> &gt; message
</I>&gt;<i> &gt; 9.) The new server pukes because it never sent a message with that tag
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So my question then is how should I kill the amqp_client? If I send it an
</I>&gt;<i> &gt; exit its supervisor will restart it.  This is what I was getting at with
</I>&gt;<i> my
</I>&gt;<i> &gt; tangential questions in the last email.  How should I shut down the
</I>&gt;<i> &gt; amqp_client without shutting down all the other servers' amqp client
</I>&gt;<i> &gt; listeners?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks for all the help,
</I>&gt;<i> &gt; -Max
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, Jun 30, 2011 at 9:23 AM, Max Warnock &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">maxjwarnock at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Thanks, that's very helpful from both the possible issues to chase and
</I>&gt;<i> &gt; &gt; sanity check perspectives.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I'm using erlang R13B04 with a rabbitmq server installed via gentoo's
</I>&gt;<i> &gt; &gt; portage at version 2.4.1. I pulled the client library from github (tag
</I>&gt;<i> &gt; &gt; 2.3.0, commit: 844738f9b56d34104c1ea2ac5700d0898126c5b4).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I'm going to write some debug code to store all the tags I try to ack
</I>&gt;<i> on
</I>&gt;<i> &gt; &gt; and see if I can get this error to where it's easily reproducible.
</I>&gt;<i> Thanks
</I>&gt;<i> &gt; &gt; for narrowing my search, it's very helpful.  I'll keep you updated. I
</I>&gt;<i> must
</I>&gt;<i> &gt; &gt; be doing something wrong somewhere.  I have a hard time believing such
</I>&gt;<i> a
</I>&gt;<i> &gt; &gt; widely used library could fail so hard myself.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; One thing that would be extremely helpful is if you could point me to
</I>&gt;<i> some
</I>&gt;<i> &gt; &gt; documentation which I haven't been able to find:  I'm looking for a
</I>&gt;<i> listing
</I>&gt;<i> &gt; &gt; of all the events/messages that are sent out by the amqp client to a
</I>&gt;<i> &gt; &gt; subscriber.  What does it send when it goes down, what other soft
</I>&gt;<i> errors
</I>&gt;<i> &gt; &gt; will it send out, etc.  Additionally, is there a doc somewhere for best
</I>&gt;<i> &gt; &gt; practices in connecting a listener to another server/long-running
</I>&gt;<i> process?
</I>&gt;<i> &gt; &gt;  Not having either of those there has been some struggle to know how to
</I>&gt;<i> &gt; &gt; restart the subscription/listening process if my server dies.  The
</I>&gt;<i> &gt; &gt; amqp_client tutorial has been a great help, but when it comes to error
</I>&gt;<i> &gt; &gt; handling from the listening module perspective it doesn't tell me what
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; library is expecting me to do.  I don't want to have to do a bunch of
</I>&gt;<i> &gt; &gt; engineering because I'm square peg, round hole-ing the library.  The
</I>&gt;<i> primary
</I>&gt;<i> &gt; &gt; issues I'm concerned with are when my server dies hard and is destined
</I>&gt;<i> to be
</I>&gt;<i> &gt; &gt; restarted by its supervisor what should I send to the amqp client
</I>&gt;<i> process?
</I>&gt;<i> &gt; &gt; Should I send it close messages and then start a new one? Or should I
</I>&gt;<i> &gt; &gt; reconnect to the client library.  This wouldn't be as big of an issue
</I>&gt;<i> but I
</I>&gt;<i> &gt; &gt; need to use durable/persistent queues and if I still have a listener
</I>&gt;<i> hanging
</I>&gt;<i> &gt; &gt; around with the same bindings on the same queue it will eat all my
</I>&gt;<i> messages
</I>&gt;<i> &gt; &gt; and send them nowhere.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Thanks,
</I>&gt;<i> &gt; &gt; -Max
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On Thu, Jun 30, 2011 at 7:48 AM, Matthew Sackman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at rabbitmq.com</A>
</I>&gt;<i> &gt;wrote:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;&gt; Hi Max,
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; On Wed, Jun 29, 2011 at 06:28:59PM -0400, Max Warnock wrote:
</I>&gt;<i> &gt; &gt;&gt; &gt; I've built a behavior in erlang to subscribe to a given topic
</I>&gt;<i> exchange
</I>&gt;<i> &gt; &gt;&gt; and
</I>&gt;<i> &gt; &gt;&gt; &gt; farm out message handling.  I'm using the rabbitmq amqp_client
</I>&gt;<i> library
</I>&gt;<i> &gt; &gt;&gt; for
</I>&gt;<i> &gt; &gt;&gt; &gt; erlang and when I put the system under heavy load I get, on
</I>&gt;<i> occasion,
</I>&gt;<i> &gt; &gt;&gt; the
</I>&gt;<i> &gt; &gt;&gt; &gt; following error:
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; Could you let us know which version of Rabbit, Erlang and the Erlang
</I>&gt;<i> &gt; &gt;&gt; client you're using?
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; &gt; =ERROR REPORT==== 29-Jun-2011::18:02:18 ===
</I>&gt;<i> &gt; &gt;&gt; &gt; ** Generic server &lt;0.1117.0&gt; terminating
</I>&gt;<i> &gt; &gt;&gt; &gt; ** Last message in was {'$gen_cast',
</I>&gt;<i> &gt; &gt;&gt; &gt;                            {method,
</I>&gt;<i> &gt; &gt;&gt; &gt;                                {'channel.close',406,
</I>&gt;<i> &gt; &gt;&gt; &gt;                                    &lt;&lt;&quot;PRECONDITION_FAILED - unknown
</I>&gt;<i> &gt; &gt;&gt; delivery
</I>&gt;<i> &gt; &gt;&gt; &gt; tag 856&quot;&gt;&gt;,
</I>&gt;<i> &gt; &gt;&gt; &gt;                                    60,80},
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; That's a double-ack (probably). Sadly, the AMQP 0-9-1 spec says that
</I>&gt;<i> &gt; &gt;&gt; acking is not idempotent, thus it's a fault to ack the same message
</I>&gt;<i> &gt; &gt;&gt; multiple times...
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; &gt; The server receive loop where the ack happens looks like this:
</I>&gt;<i> &gt; &gt;&gt; &gt; receive
</I>&gt;<i> &gt; &gt;&gt; &gt; ...
</I>&gt;<i> &gt; &gt;&gt; &gt; {#'basic.deliver'{delivery_tag = Tag, routing_key = RoutingKey},
</I>&gt;<i> &gt; &gt;&gt; &gt; #amqp_msg{payload = Payload}} -&gt;
</I>&gt;<i> &gt; &gt;&gt; &gt;     amqp_channel:cast(get(amqp_channel_pid),
</I>&gt;<i> #'basic.ack'{delivery_tag =
</I>&gt;<i> &gt; &gt;&gt; &gt; Tag}),
</I>&gt;<i> &gt; &gt;&gt; &gt;     spawn_and_queue(spawn_handle_message, Module, RoutingKey,
</I>&gt;<i> Payload),
</I>&gt;<i> &gt; &gt;&gt; &gt;     loop(Module);
</I>&gt;<i> &gt; &gt;&gt; &gt; ...
</I>&gt;<i> &gt; &gt;&gt; &gt; end
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; ...hmmm, which is so simple that I can't see how it could go wrong: if
</I>&gt;<i> &gt; &gt;&gt; you're not double acking then something else must be going on to make
</I>&gt;<i> &gt; &gt;&gt; the broker think that it's not expecting an ack for that message,
</I>&gt;<i> hence
</I>&gt;<i> &gt; &gt;&gt; the error. If you're doing some sort of reject operation - either
</I>&gt;<i> &gt; &gt;&gt; basic.nack or basic.reject on messages and you then subsequently ack
</I>&gt;<i> one
</I>&gt;<i> &gt; &gt;&gt; of those messages then that would also cause this error. There may be
</I>&gt;<i> &gt; &gt;&gt; other cases as well.
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; &gt; The amqp_client_sup can't seem to bring back the the client either
</I>&gt;<i> and
</I>&gt;<i> &gt; &gt;&gt; dies
</I>&gt;<i> &gt; &gt;&gt; &gt; from the retry intensity being reached.  I've done a hefty amount of
</I>&gt;<i> &gt; &gt;&gt; &gt; googling and can't seem to find where things could be going wrong.
</I>&gt;<i> &gt; &gt;&gt;  Before
</I>&gt;<i> &gt; &gt;&gt; &gt; jumping into the amqp_client code I thought I'd ask the mailing list
</I>&gt;<i> if
</I>&gt;<i> &gt; &gt;&gt; they
</I>&gt;<i> &gt; &gt;&gt; &gt; have any ideas.  The only thing I can think is that there is a race
</I>&gt;<i> &gt; &gt;&gt; &gt; condition within the client library.  I will be double checking my
</I>&gt;<i> code
</I>&gt;<i> &gt; &gt;&gt; to
</I>&gt;<i> &gt; &gt;&gt; &gt; be sure it isn't sending the ack twice, but given the simplicity of
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt;&gt; ack
</I>&gt;<i> &gt; &gt;&gt; &gt; the only way it could is if it receives the same message (with
</I>&gt;<i> identical
</I>&gt;<i> &gt; &gt;&gt; &gt; delivery tag) from the amqp_client library twice.
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; It could be a bug in the client library, but I'd be a little surprised
</I>&gt;<i> &gt; &gt;&gt; if we're managing to duplicate messages somehow - that would be a new
</I>&gt;<i> &gt; &gt;&gt; level of fail for us. ;) However, the fact that the entire connection
</I>&gt;<i> &gt; &gt;&gt; dies is alarming and almost certainly a bug: PRECONDITION_FAILED is a
</I>&gt;<i> &gt; &gt;&gt; soft error and should only tear down the channel, not the whole
</I>&gt;<i> &gt; &gt;&gt; connection. After that, all you should have to do is create a new
</I>&gt;<i> &gt; &gt;&gt; channel and everything else should be ok. If that's not the case
</I>&gt;<i> please
</I>&gt;<i> &gt; &gt;&gt; let us know.
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; Best wishes,
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; Matthew
</I>&gt;<i> &gt; &gt;&gt; _______________________________________________
</I>&gt;<i> &gt; &gt;&gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; &gt;&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; &gt;&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i>
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110705/2da3e2ee/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110705/2da3e2ee/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: gen_amqp_subscriberinteractionwithamqp_client.png
Type: image/png
Size: 40314 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110705/2da3e2ee/attachment.png">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110705/2da3e2ee/attachment.png</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013635.html">[rabbitmq-discuss] precondition_failed error with amqp_client for erlang
</A></li>
	<LI>Next message: <A HREF="013820.html">[rabbitmq-discuss] precondition_failed error with amqp_client for erlang
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13664">[ date ]</a>
              <a href="thread.html#13664">[ thread ]</a>
              <a href="subject.html#13664">[ subject ]</a>
              <a href="author.html#13664">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
