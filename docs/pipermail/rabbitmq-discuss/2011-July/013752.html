<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Reproducible error for remote client -- was Re:	Distributed queue setup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Reproducible%20error%20for%20remote%20client%20--%20was%20Re%3A%0A%09Distributed%20queue%20setup&In-Reply-To=%3CCAG7cANS%3DrfOfuRbvSGJ0ez3Kchd%3D2aqqzmbUWrQJss5RNvBQKA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013751.html">
   <LINK REL="Next"  HREF="013759.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Reproducible error for remote client -- was Re:	Distributed queue setup</H1>
    <B>Meredith Gregory</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Reproducible%20error%20for%20remote%20client%20--%20was%20Re%3A%0A%09Distributed%20queue%20setup&In-Reply-To=%3CCAG7cANS%3DrfOfuRbvSGJ0ez3Kchd%3D2aqqzmbUWrQJss5RNvBQKA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Reproducible error for remote client -- was Re:	Distributed queue setup">lgreg.meredith at gmail.com
       </A><BR>
    <I>Fri Jul  8 02:17:33 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013751.html">[rabbitmq-discuss] How do heartbeats work? (was Heartbeat	timeout)
</A></li>
        <LI>Next message: <A HREF="013759.html">[rabbitmq-discuss] Reproducible error for remote client -- was Re:	Distributed queue setup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13752">[ date ]</a>
              <a href="thread.html#13752">[ thread ]</a>
              <a href="subject.html#13752">[ subject ]</a>
              <a href="author.html#13752">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear Rabbitters,

It turns out our problem is even simpler. If we have a client from machine B
connect to the RabbitMQ broker on machine A and then begin sending messages,
the broker closes the connection unless we fire up a client to connect to
the broker on machine A to begin reading the messages. The number of
messages before closure depends on the size of the message. i have a trace
below. i will endeavor to get you a much smaller piece of code for repro.

We have been able to reproduce this error with virtually every java client
version from 1.4 to the current 2.5.1. All tests are conducted on Mac OS X
Snow Leopard.

Best wishes,

--greg

Welcome to Scala version 2.9.0.1 (Java HotSpot(TM) 64-Bit Server VM, Java
1.6.0_24).
Type in expressions to have them evaluated.
Type :help for more information.

scala&gt; :load
/Users/lgm/work/src/projex/stellar/mdp4tw/SpecialK.moniker/scripts/rabbit-connectivity.scala
rabbit-connectivity.scala
Loading
/Users/lgm/work/src/projex/stellar/mdp4tw/SpecialK.moniker/scripts/rabbit-connectivity.scala...
import com.biosimilarity.lift.model.store._
import com.biosimilarity.lift.model.store.usage._
import com.biosimilarity.lift.lib._
import com.biosimilarity.lift.lib.usage._
import scala.util.continuations._
defined module RabbitMQConnectivityTest

scala&gt; import RabbitMQConnectivityTest._
import RabbitMQConnectivityTest._
import RabbitMQConnectivityTest._

scala&gt; import AMQPDefaults._
import AMQPDefaults._
import AMQPDefaults._

scala&gt; import MonadicAMQPUnitTest._
import MonadicAMQPUnitTest._
import MonadicAMQPUnitTest._

scala&gt; import scala.collection.mutable.HashMap
import scala.collection.mutable.HashMap
import scala.collection.mutable.HashMap

scala&gt; val fqn1 = freshQueueName
val fqn1 = freshQueueName
fqn1: String = amqp_db6b2925-23cb-46d3-af1a-8b1ffdc0639b

scala&gt; val ( sma1, jsdnr, jsdsp, msgs ) = setupConnectionApparatus( fqn1,
&quot;10.0.1.9&quot;, &quot;10.0.1.5&quot;, 100, new HashMap[String,List[Msg]]() )
1.9&quot;, &quot;10.0.1.5&quot;, 100, new HashMap[String,List[Msg]]() )
sma1:
com.biosimilarity.lift.lib.SMJATwistedPair[com.biosimilarity.lift.lib.usage.MonadicAMQPUnitTest.Msg]
= <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">com.biosimilarity.lift.lib.SMJATwistedPair at 4c900608</A>
jsdnr: net.liftweb.amqp.JSONAMQPSender =
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">net.liftweb.amqp.JSONAMQPSender at 37c1e7d</A>
jsdsp:
com.biosimilarity.lift.lib.StdMonadicJSONAMQPDispatcher[com.biosimilarity.lift.lib.usage.MonadicAMQPUnitTest.Msg]
= <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">com.biosimilarity.lift.lib.StdMonadicJSONAMQPDispatcher at 49b5a254</A>
msgs:
scala.collection.immutable.Stream[com.biosimilarity.lift.lib.usage.MonadicAMQPUnitTest.Msg]
= Stream(Msg(msg0,0,true,None), ?)

scala&gt; sma1.send( msgs( 89 ) )
sma1.send( msgs( 89 ) )

scala&gt; sma1.send( msgs( 88 ) )
sma1.send( msgs( 88 ) )

scala&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">net.liftweb.amqp.JSONAMQPSender at 37c1e7d</A>: caught
com.rabbitmq.client.AlreadyClosedException: clean connection shutdown;
reason: Attempt to use closed channel
com.rabbitmq.client.AlreadyClosedException: clean connection shutdown;
reason: Attempt to use closed channel
at com.rabbitmq.client.impl.AMQChannel.ensureIsOpen(AMQChannel.java:181)
at com.rabbitmq.client.impl.AMQChannel.transmit(AMQChannel.java:276)
at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:521)
at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:507)
at net.liftweb.amqp.AMQPSender.send(AMQPSender.scala:30)
at net.liftweb.amqp.AMQPSender$$anonfun$loop$1.apply(AMQPSender.scala:37)
at net.liftweb.amqp.AMQPSender$$anonfun$loop$1.apply(AMQPSender.scala:36)
at scala.actors.ReactorTask.run(ReactorTask.scala:31)
at scala.actors.Reactor$class.resumeReceiver(Reactor.scala:129)
at
net.liftweb.amqp.AMQPSender.scala$actors$ReplyReactor$$super$resumeReceiver(AMQPSender.scala:15)
at scala.actors.ReplyReactor$class.resumeReceiver(ReplyReactor.scala:68)
at net.liftweb.amqp.AMQPSender.resumeReceiver(AMQPSender.scala:15)
at scala.actors.Actor$class.searchMailbox(Actor.scala:500)
at net.liftweb.amqp.AMQPSender.searchMailbox(AMQPSender.scala:15)
at
scala.actors.Reactor$$anonfun$startSearch$1$$anonfun$apply$mcV$sp$1.apply$mcV$sp(Reactor.scala:117)
at
scala.actors.Reactor$$anonfun$startSearch$1$$anonfun$apply$mcV$sp$1.apply(Reactor.scala:114)
at
scala.actors.Reactor$$anonfun$startSearch$1$$anonfun$apply$mcV$sp$1.apply(Reactor.scala:114)
at scala.actors.ReactorTask.run(ReactorTask.scala:33)
at
scala.concurrent.forkjoin.ForkJoinPool$AdaptedRunnable.exec(ForkJoinPool.java:611)
at scala.concurrent.forkjoin.ForkJoinTask.quietlyExec(ForkJoinTask.java:422)
at
scala.concurrent.forkjoin.ForkJoinWorkerThread.mainLoop(ForkJoinWorkerThread.java:340)
at
scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:325)


On Tue, Jul 5, 2011 at 10:10 AM, Meredith Gregory
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">lgreg.meredith at gmail.com</A>&gt;wrote:

&gt;<i> Dear Rabbitters,
</I>&gt;<i>
</I>&gt;<i> We've got a situation -- it must be quite common -- where, in the simplest
</I>&gt;<i> case, we have two application nodes, call them A and B. RabbitMQ server is
</I>&gt;<i> running on the machines for both A and B. The B node has established it's
</I>&gt;<i> connection to exchange and queue, but does not know whether A has. In the
</I>&gt;<i> case that A has, all is well in the world. When B sends a message to A over
</I>&gt;<i> RabbitMQ, A happily processes it and returns a response message. However, if
</I>&gt;<i> A has not established it's connection to exchange and queue, then if B has
</I>&gt;<i> sent a message to A on this exchange and queue, then when A establishes it's
</I>&gt;<i> connection -- not only does it not see the pending message, the next message
</I>&gt;<i> B sends causes a Java exception to be thrown (see below). Now, we can
</I>&gt;<i> arrange a bit of a handshake to work around this, and have done so. However,
</I>&gt;<i> we'd like to know if there's a better or Rabbitier way of doing this.
</I>&gt;<i>
</I>&gt;<i> Best wishes,
</I>&gt;<i>
</I>&gt;<i> --greg
</I>&gt;<i>
</I>&gt;<i> com.rabbitmq.client.AlreadyClosedException: clean connection shutdown; reason: Attempt to use closed channelscala&gt;
</I>&gt;<i>         at com.rabbitmq.client.impl.AMQChannel.ensureIsOpen(AMQChannel.java:181)
</I>&gt;<i>         at com.rabbitmq.client.impl.AMQChannel.transmit(AMQChannel.java:276)
</I>&gt;<i>         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:521)
</I>&gt;<i>         at com.rabbitmq.client.impl.ChannelN.basicPublish(ChannelN.java:507)
</I>&gt;<i>         at net.liftweb.amqp.AMQPSender.send(AMQPSender.scala:25)
</I>&gt;<i>         at net.liftweb.amqp.AMQPSender$$anonfun$loop$1.apply(AMQPSender.scala:32)
</I>&gt;<i>         at net.liftweb.amqp.AMQPSender$$anonfun$loop$1.apply(AMQPSender.scala:31)
</I>&gt;<i>         at scala.actors.ReactorTask.run(ReactorTask.scala:31)
</I>&gt;<i>         at scala.actors.Reactor$class.resumeReceiver(Reactor.scala:129)
</I>&gt;<i>         at net.liftweb.amqp.AMQPSender.scala$actors$ReplyReactor$$super$resumeReceiver(AMQPSender.scala:15)
</I>&gt;<i>         at scala.actors.ReplyReactor$class.resumeReceiver(ReplyReactor.scala:68)
</I>&gt;<i>         at net.liftweb.amqp.AMQPSender.resumeReceiver(AMQPSender.scala:15)
</I>&gt;<i>         at scala.actors.Actor$class.searchMailbox(Actor.scala:500)
</I>&gt;<i>         at net.liftweb.amqp.AMQPSender.searchMailbox(AMQPSender.scala:15)
</I>&gt;<i>         at scala.actors.Reactor$$anonfun$startSearch$1$$anonfun$apply$mcV$sp$1.apply$mcV$sp(Reactor.scala:117)
</I>&gt;<i>         at scala.actors.Reactor$$anonfun$startSearch$1$$anonfun$apply$mcV$sp$1.apply(Reactor.scala:114)
</I>&gt;<i>         at scala.actors.Reactor$$anonfun$startSearch$1$$anonfun$apply$mcV$sp$1.apply(Reactor.scala:114)
</I>&gt;<i>         at scala.actors.ReactorTask.run(ReactorTask.scala:33)
</I>&gt;<i>         at scala.concurrent.forkjoin.ForkJoinPool$AdaptedRunnable.exec(ForkJoinPool.java:611)
</I>&gt;<i>         at scala.concurrent.forkjoin.ForkJoinTask.quietlyExec(ForkJoinTask.java:422)
</I>&gt;<i>         at scala.concurrent.forkjoin.ForkJoinWorkerThread.mainLoop(ForkJoinWorkerThread.java:340)
</I>&gt;<i>         at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:325)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> L.G. Meredith
</I>&gt;<i> Managing Partner
</I>&gt;<i> Biosimilarity LLC
</I>&gt;<i> 7329 39th Ave SW
</I>&gt;<i> Seattle, WA 98136
</I>&gt;<i>
</I>&gt;<i> +1 206.650.3740
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://biosimilarity.blogspot.com">http://biosimilarity.blogspot.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
L.G. Meredith
Managing Partner
Biosimilarity LLC
7329 39th Ave SW
Seattle, WA 98136

+1 206.650.3740

<A HREF="http://biosimilarity.blogspot.com">http://biosimilarity.blogspot.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110707/8cbc5655/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110707/8cbc5655/attachment.htm</A>&gt;
</PRE>





















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013751.html">[rabbitmq-discuss] How do heartbeats work? (was Heartbeat	timeout)
</A></li>
	<LI>Next message: <A HREF="013759.html">[rabbitmq-discuss] Reproducible error for remote client -- was Re:	Distributed queue setup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13752">[ date ]</a>
              <a href="thread.html#13752">[ thread ]</a>
              <a href="subject.html#13752">[ subject ]</a>
              <a href="author.html#13752">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
