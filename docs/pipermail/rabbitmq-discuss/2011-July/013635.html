<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] precondition_failed error with amqp_client for erlang
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20precondition_failed%20error%20with%20amqp_client%0A%20for%20erlang&In-Reply-To=%3C20110704161643.GF6403%40dakota.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013606.html">
   <LINK REL="Next"  HREF="013664.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] precondition_failed error with amqp_client for erlang</H1>
    <B>Alexandru Scvor&#355;ov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20precondition_failed%20error%20with%20amqp_client%0A%20for%20erlang&In-Reply-To=%3C20110704161643.GF6403%40dakota.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] precondition_failed error with amqp_client for erlang">alexandru at rabbitmq.com
       </A><BR>
    <I>Mon Jul  4 17:16:43 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013606.html">[rabbitmq-discuss] precondition_failed error with amqp_client	for erlang
</A></li>
        <LI>Next message: <A HREF="013664.html">[rabbitmq-discuss] precondition_failed error with amqp_client	for erlang
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13635">[ date ]</a>
              <a href="thread.html#13635">[ thread ]</a>
              <a href="subject.html#13635">[ subject ]</a>
              <a href="author.html#13635">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Max,

I'm trying to run through the steps you provided, but I'm having a bit
of trouble following.

Are you using a network or a direct connection? (I assume network, but
it probably doesn't matter)

By server, do you mean the actual RabbitMQ server, or you application?
(I'm guessing your long-running application)

By subscribe, do you mean calling amqp_channel:subscribe/3?  If so, do
you still need a list of the messages the channel may send its
subscriber?

Or do you mean that your application is sending messages to its
subscribers?

&gt;<i> 6.) The server supervisor restarts the server which creates a new listener,
</I>&gt;<i> but the old listener is still hanging around trying to send the the
</I>&gt;<i> registered name
</I>
What's a listener?  Is it a process that receives messages from the
erlang client because it's the endpoint of a subscription to a queue?

Can't you link listeners to the server so that when the server goes
down, it takes the listeners with it?

&gt;<i> So my question then is how should I kill the amqp_client?
</I>
What do you mean by amqp_client?  If it's an amqp_connection process,
you can just send it an shutdown exit.

Thanks for the information.

Cheers,
Alex

On Fri, Jul 01, 2011 at 01:51:10PM -0400, Max Warnock wrote:
&gt;<i> Problem found.  Thanks for your help.  The problem is a strange one and has
</I>&gt;<i> to do with me not shutting my amqp_client listener down properly if my
</I>&gt;<i> server dies.  Here is how it manifests:
</I>&gt;<i> 
</I>&gt;<i> 1.) Server starts up and starts up a amqp client connection and channel
</I>&gt;<i> 2.) The server binds to that channel and starts the subscription using a
</I>&gt;<i> registered name name as the process to which messages will be sent
</I>&gt;<i> 3.) Messages start coming in and are ack-ing fine
</I>&gt;<i> 4.) Poor error handling in farming out processes brings the server down
</I>&gt;<i> 5.) The server does no close the amqp_client connection
</I>&gt;<i> 6.) The server supervisor restarts the server which creates a new listener,
</I>&gt;<i> but the old listener is still hanging around trying to send the the
</I>&gt;<i> registered name
</I>&gt;<i> 7.) The older listener sends a message to the server
</I>&gt;<i> 8.) The server tries to ack to the new listener which did not send the
</I>&gt;<i> message
</I>&gt;<i> 9.) The new server pukes because it never sent a message with that tag
</I>&gt;<i> 
</I>&gt;<i> So my question then is how should I kill the amqp_client? If I send it an
</I>&gt;<i> exit its supervisor will restart it.  This is what I was getting at with my
</I>&gt;<i> tangential questions in the last email.  How should I shut down the
</I>&gt;<i> amqp_client without shutting down all the other servers' amqp client
</I>&gt;<i> listeners?
</I>&gt;<i> 
</I>&gt;<i> Thanks for all the help,
</I>&gt;<i> -Max
</I>&gt;<i> 
</I>&gt;<i> On Thu, Jun 30, 2011 at 9:23 AM, Max Warnock &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">maxjwarnock at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Thanks, that's very helpful from both the possible issues to chase and
</I>&gt;<i> &gt; sanity check perspectives.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm using erlang R13B04 with a rabbitmq server installed via gentoo's
</I>&gt;<i> &gt; portage at version 2.4.1. I pulled the client library from github (tag
</I>&gt;<i> &gt; 2.3.0, commit: 844738f9b56d34104c1ea2ac5700d0898126c5b4).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm going to write some debug code to store all the tags I try to ack on
</I>&gt;<i> &gt; and see if I can get this error to where it's easily reproducible. Thanks
</I>&gt;<i> &gt; for narrowing my search, it's very helpful.  I'll keep you updated. I must
</I>&gt;<i> &gt; be doing something wrong somewhere.  I have a hard time believing such a
</I>&gt;<i> &gt; widely used library could fail so hard myself.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; One thing that would be extremely helpful is if you could point me to some
</I>&gt;<i> &gt; documentation which I haven't been able to find:  I'm looking for a listing
</I>&gt;<i> &gt; of all the events/messages that are sent out by the amqp client to a
</I>&gt;<i> &gt; subscriber.  What does it send when it goes down, what other soft errors
</I>&gt;<i> &gt; will it send out, etc.  Additionally, is there a doc somewhere for best
</I>&gt;<i> &gt; practices in connecting a listener to another server/long-running process?
</I>&gt;<i> &gt;  Not having either of those there has been some struggle to know how to
</I>&gt;<i> &gt; restart the subscription/listening process if my server dies.  The
</I>&gt;<i> &gt; amqp_client tutorial has been a great help, but when it comes to error
</I>&gt;<i> &gt; handling from the listening module perspective it doesn't tell me what the
</I>&gt;<i> &gt; library is expecting me to do.  I don't want to have to do a bunch of
</I>&gt;<i> &gt; engineering because I'm square peg, round hole-ing the library.  The primary
</I>&gt;<i> &gt; issues I'm concerned with are when my server dies hard and is destined to be
</I>&gt;<i> &gt; restarted by its supervisor what should I send to the amqp client process?
</I>&gt;<i> &gt; Should I send it close messages and then start a new one? Or should I
</I>&gt;<i> &gt; reconnect to the client library.  This wouldn't be as big of an issue but I
</I>&gt;<i> &gt; need to use durable/persistent queues and if I still have a listener hanging
</I>&gt;<i> &gt; around with the same bindings on the same queue it will eat all my messages
</I>&gt;<i> &gt; and send them nowhere.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt; -Max
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, Jun 30, 2011 at 7:48 AM, Matthew Sackman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at rabbitmq.com</A>&gt;wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Hi Max,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On Wed, Jun 29, 2011 at 06:28:59PM -0400, Max Warnock wrote:
</I>&gt;<i> &gt;&gt; &gt; I've built a behavior in erlang to subscribe to a given topic exchange
</I>&gt;<i> &gt;&gt; and
</I>&gt;<i> &gt;&gt; &gt; farm out message handling.  I'm using the rabbitmq amqp_client library
</I>&gt;<i> &gt;&gt; for
</I>&gt;<i> &gt;&gt; &gt; erlang and when I put the system under heavy load I get, on occasion,
</I>&gt;<i> &gt;&gt; the
</I>&gt;<i> &gt;&gt; &gt; following error:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Could you let us know which version of Rabbit, Erlang and the Erlang
</I>&gt;<i> &gt;&gt; client you're using?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt; =ERROR REPORT==== 29-Jun-2011::18:02:18 ===
</I>&gt;<i> &gt;&gt; &gt; ** Generic server &lt;0.1117.0&gt; terminating
</I>&gt;<i> &gt;&gt; &gt; ** Last message in was {'$gen_cast',
</I>&gt;<i> &gt;&gt; &gt;                            {method,
</I>&gt;<i> &gt;&gt; &gt;                                {'channel.close',406,
</I>&gt;<i> &gt;&gt; &gt;                                    &lt;&lt;&quot;PRECONDITION_FAILED - unknown
</I>&gt;<i> &gt;&gt; delivery
</I>&gt;<i> &gt;&gt; &gt; tag 856&quot;&gt;&gt;,
</I>&gt;<i> &gt;&gt; &gt;                                    60,80},
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; That's a double-ack (probably). Sadly, the AMQP 0-9-1 spec says that
</I>&gt;<i> &gt;&gt; acking is not idempotent, thus it's a fault to ack the same message
</I>&gt;<i> &gt;&gt; multiple times...
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt; The server receive loop where the ack happens looks like this:
</I>&gt;<i> &gt;&gt; &gt; receive
</I>&gt;<i> &gt;&gt; &gt; ...
</I>&gt;<i> &gt;&gt; &gt; {#'basic.deliver'{delivery_tag = Tag, routing_key = RoutingKey},
</I>&gt;<i> &gt;&gt; &gt; #amqp_msg{payload = Payload}} -&gt;
</I>&gt;<i> &gt;&gt; &gt;     amqp_channel:cast(get(amqp_channel_pid), #'basic.ack'{delivery_tag =
</I>&gt;<i> &gt;&gt; &gt; Tag}),
</I>&gt;<i> &gt;&gt; &gt;     spawn_and_queue(spawn_handle_message, Module, RoutingKey, Payload),
</I>&gt;<i> &gt;&gt; &gt;     loop(Module);
</I>&gt;<i> &gt;&gt; &gt; ...
</I>&gt;<i> &gt;&gt; &gt; end
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ...hmmm, which is so simple that I can't see how it could go wrong: if
</I>&gt;<i> &gt;&gt; you're not double acking then something else must be going on to make
</I>&gt;<i> &gt;&gt; the broker think that it's not expecting an ack for that message, hence
</I>&gt;<i> &gt;&gt; the error. If you're doing some sort of reject operation - either
</I>&gt;<i> &gt;&gt; basic.nack or basic.reject on messages and you then subsequently ack one
</I>&gt;<i> &gt;&gt; of those messages then that would also cause this error. There may be
</I>&gt;<i> &gt;&gt; other cases as well.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt; The amqp_client_sup can't seem to bring back the the client either and
</I>&gt;<i> &gt;&gt; dies
</I>&gt;<i> &gt;&gt; &gt; from the retry intensity being reached.  I've done a hefty amount of
</I>&gt;<i> &gt;&gt; &gt; googling and can't seem to find where things could be going wrong.
</I>&gt;<i> &gt;&gt;  Before
</I>&gt;<i> &gt;&gt; &gt; jumping into the amqp_client code I thought I'd ask the mailing list if
</I>&gt;<i> &gt;&gt; they
</I>&gt;<i> &gt;&gt; &gt; have any ideas.  The only thing I can think is that there is a race
</I>&gt;<i> &gt;&gt; &gt; condition within the client library.  I will be double checking my code
</I>&gt;<i> &gt;&gt; to
</I>&gt;<i> &gt;&gt; &gt; be sure it isn't sending the ack twice, but given the simplicity of the
</I>&gt;<i> &gt;&gt; ack
</I>&gt;<i> &gt;&gt; &gt; the only way it could is if it receives the same message (with identical
</I>&gt;<i> &gt;&gt; &gt; delivery tag) from the amqp_client library twice.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; It could be a bug in the client library, but I'd be a little surprised
</I>&gt;<i> &gt;&gt; if we're managing to duplicate messages somehow - that would be a new
</I>&gt;<i> &gt;&gt; level of fail for us. ;) However, the fact that the entire connection
</I>&gt;<i> &gt;&gt; dies is alarming and almost certainly a bug: PRECONDITION_FAILED is a
</I>&gt;<i> &gt;&gt; soft error and should only tear down the channel, not the whole
</I>&gt;<i> &gt;&gt; connection. After that, all you should have to do is create a new
</I>&gt;<i> &gt;&gt; channel and everything else should be ok. If that's not the case please
</I>&gt;<i> &gt;&gt; let us know.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Best wishes,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Matthew
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt;&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>
&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013606.html">[rabbitmq-discuss] precondition_failed error with amqp_client	for erlang
</A></li>
	<LI>Next message: <A HREF="013664.html">[rabbitmq-discuss] precondition_failed error with amqp_client	for erlang
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13635">[ date ]</a>
              <a href="thread.html#13635">[ thread ]</a>
              <a href="subject.html#13635">[ subject ]</a>
              <a href="author.html#13635">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
