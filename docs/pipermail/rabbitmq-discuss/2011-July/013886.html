<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Unable to share fanned out queue between two	cosnumers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unable%20to%20share%20fanned%20out%20queue%20between%20two%0A%09cosnumers&In-Reply-To=%3CCAKGgVGs3Aj-U6RqskZ3YDsOYtFHCBbkaEB%2BEp3txs3Jzs62Urg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013935.html">
   <LINK REL="Next"  HREF="013890.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Unable to share fanned out queue between two	cosnumers</H1>
    <B>Uday Mitra</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unable%20to%20share%20fanned%20out%20queue%20between%20two%0A%09cosnumers&In-Reply-To=%3CCAKGgVGs3Aj-U6RqskZ3YDsOYtFHCBbkaEB%2BEp3txs3Jzs62Urg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Unable to share fanned out queue between two	cosnumers">udaymitra4u at gmail.com
       </A><BR>
    <I>Thu Jul 14 06:01:56 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013935.html">[rabbitmq-discuss] Unable to connect multiple consumers to a queue bound to fanned out exchange
</A></li>
        <LI>Next message: <A HREF="013890.html">[rabbitmq-discuss] How Should a Messaging Client Handle Errors?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13886">[ date ]</a>
              <a href="thread.html#13886">[ thread ]</a>
              <a href="subject.html#13886">[ subject ]</a>
              <a href="author.html#13886">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi All,

I have a fanout exchange and I am binding different queues to this exchange.
When I send data to this exchange each queue that is bound to this exchange
is getting data as expected. But when I try to connect multiple consumers to
one of these fanned out queues, I get the following message:
&quot;Queue message_queue1 has an exclusive consumer. No more consumers allowed.&quot;

Here is the properties file that has the configuration:

fanout.properties:
--------------------
java.naming.factory.initial =
org.apache.qpid.jndi.PropertiesFileInitialContextFactory
connectionfactory.qpidConnectionfactory = <A HREF="amqp://guest:guest@xxxxxxx">amqp://guest:guest@xxxxxxx</A>
/?brokerlist='<A HREF="tcp://xxxxx:5672'">tcp://xxxxx:5672'</A>

# for producer
destination.fanoutQueue =
BURL:<A HREF="fanout://testcollector.fanout//message_queue?durable='false'&amp;autodelete='true'&amp;exclusive='false'">fanout://testcollector.fanout//message_queue?durable='false'&amp;autodelete='true'&amp;exclusive='false'</A>

# for consumers
destination.fanoutQueue1 =
BURL:<A HREF="fanout://testcollector.fanout//message_queue1?durable='false'&amp;autodelete='true'&amp;exclusive='false'">fanout://testcollector.fanout//message_queue1?durable='false'&amp;autodelete='true'&amp;exclusive='false'</A>

destination.fanoutQueue2 =
BURL:<A HREF="fanout://testcollector.fanout//message_queue2?durable='false'&amp;autodelete='true'&amp;exclusive='false'">fanout://testcollector.fanout//message_queue2?durable='false'&amp;autodelete='true'&amp;exclusive='false'</A>

destination.fanoutQueue3 =
BURL:<A HREF="fanout://testcollector.fanout//message_queue3?durable='false'&amp;autodelete='true'&amp;exclusive='false'">fanout://testcollector.fanout//message_queue3?durable='false'&amp;autodelete='true'&amp;exclusive='false'</A>
-------------------------

I tried to connect two consumers to message_queue1 and I get the following
error:
INFO org.apache.qpid.client.AMQConnection - Closing AMQConnection due to
:<i>org.apache.qpid.AMQException: ch=0 id=0
</I>ExecutionException(errorCode=RESOURCE_LOCKED, commandId=6, classCode=4,
commandCode=7, fieldIndex=0, description=resource-locked: Queue
message_queue1 has an exclusive consumer. No more consumers allowed.
(qpid/broker/Queue.cpp:385), errorInfo={}) [error code 405: Already exists]

I checked the configuration on AMQP Server and it says that message_queue1
is a non-exclusive queue.
-bash-4.1$ qpid-stat -q
Queues
  queue                                  dur  autoDel  excl  msg   msgIn
msgOut  bytes  bytesIn  bytesOut  cons  bind
  message_queue1                              Y                 1    22
21      15    324      309         1     2


Here is the code I am using.

Producer.java: (queueName=fanoutQueue)
----------------
                Properties properties = new Properties();

properties.load(this.getClass().getResourceAsStream(&quot;fanout.properties&quot;));

        //Create the initial context
        Context ctx = new InitialContext(properties);

        // look up destination and connection factory
        Destination destination = (Destination)ctx.lookup(queueName);
        ConnectionFactory conFac =
(ConnectionFactory)ctx.lookup(&quot;qpidConnectionfactory&quot;);

        Connection connection = conFac.createConnection();
        Session session = connection.createSession(false,
Session.AUTO_ACKNOWLEDGE);

        MessageProducer messageProducer =
session.createProducer(destination);
        TextMessage message;

        // Send a series of messages in a loop
        int i=0;
        while(true) {
            message = session.createTextMessage(&quot;Hello world! &quot;+i);
            messageProducer.send(message, DeliveryMode.NON_PERSISTENT,
Message.DEFAULT_PRIORITY, 60*1000);
            i++;
            Thread.sleep(1000);
        }
-------------------

Consumer.java: (queueName=fanoutQueue1)
-----------------
                Properties properties = new Properties();

properties.load(this.getClass().getResourceAsStream(&quot;fanout.properties&quot;));

        //Create the initial context
        Context ctx = new InitialContext(properties);

        // look up destination and connection factory
        Destination destination = (Destination)ctx.lookup(queueName);
        ConnectionFactory conFac =
(ConnectionFactory)ctx.lookup(&quot;qpidConnectionfactory&quot;);

        Connection connection = conFac.createConnection();
        connection.setExceptionListener(new ExceptionListener()
        {
            public void onException(JMSException jmse)
            {
                System.err.println(CLASS + &quot;: The sample received an
exception through the ExceptionListener&quot;);
                System.exit(0);
            }
        });

        System.out.println(CLASS + &quot;: Creating a non-transacted,
auto-acknowledged session&quot;);
        Session session = connection.createSession(false,
Session.AUTO_ACKNOWLEDGE);

        MessageConsumer messageConsumer =
session.createConsumer(destination);
        connection.start();

        while(true) {
            TextMessage message =
(TextMessage)messageConsumer.receive(1000);
            if(message != null)
                System.out.println(message.getText());
        }
-----------------

I am using QPID, but I figured if this is doable in RabbitMQ, then it should
be possible in QPID too.
Am I missing something here?

I really appreciate your help.

Thanks,
Uday
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110713/50a63a4d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110713/50a63a4d/attachment.htm</A>&gt;
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013935.html">[rabbitmq-discuss] Unable to connect multiple consumers to a queue bound to fanned out exchange
</A></li>
	<LI>Next message: <A HREF="013890.html">[rabbitmq-discuss] How Should a Messaging Client Handle Errors?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13886">[ date ]</a>
              <a href="thread.html#13886">[ thread ]</a>
              <a href="subject.html#13886">[ subject ]</a>
              <a href="author.html#13886">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
