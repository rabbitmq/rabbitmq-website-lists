<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Unable to connect multiple consumers to a queue bound to fanned out exchange
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unable%20to%20connect%20multiple%20consumers%20to%20a%20queue%0A%20bound%20to%20fanned%20out%20exchange&In-Reply-To=%3C32058027.post%40talk.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013885.html">
   <LINK REL="Next"  HREF="013894.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Unable to connect multiple consumers to a queue bound to fanned out exchange</H1>
    <B>Mitra77</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unable%20to%20connect%20multiple%20consumers%20to%20a%20queue%0A%20bound%20to%20fanned%20out%20exchange&In-Reply-To=%3C32058027.post%40talk.nabble.com%3E"
       TITLE="[rabbitmq-discuss] Unable to connect multiple consumers to a queue bound to fanned out exchange">udaymitra4u at gmail.com
       </A><BR>
    <I>Thu Jul 14 01:12:40 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013885.html">[rabbitmq-discuss] Rabbit 2.2 does not report connected	consumers
</A></li>
        <LI>Next message: <A HREF="013894.html">[rabbitmq-discuss] Unable to connect multiple consumers to a queue bound to fanned out exchange
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13889">[ date ]</a>
              <a href="thread.html#13889">[ thread ]</a>
              <a href="subject.html#13889">[ subject ]</a>
              <a href="author.html#13889">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi All,

I have a fanout exchange and I am binding different queues to this exchange.
When I send data to this exchange each queue that is bound to this exchange
is getting data as expected. But when I try to connect multiple consumers to
one of these fanned out queues, I get the following message:
&quot;Queue message_queue1 has an exclusive consumer. No more consumers allowed.&quot;

Here is the properties file that has the configuration:

fanout.properties:
--------------------
java.naming.factory.initial =
org.apache.qpid.jndi.PropertiesFileInitialContextFactory
connectionfactory.qpidConnectionfactory =
<A HREF="amqp://guest:guest@xxxxxxx/?brokerlist='tcp://xxxxx:5672'">amqp://guest:guest@xxxxxxx/?brokerlist='tcp://xxxxx:5672'</A>

# for producer
destination.fanoutQueue =
BURL:<A HREF="fanout://testcollector.fanout//message_queue?durable='false'&amp;autodelete='true'&amp;exclusive='false'">fanout://testcollector.fanout//message_queue?durable='false'&amp;autodelete='true'&amp;exclusive='false'</A>

# for consumers
destination.fanoutQueue1 =
BURL:<A HREF="fanout://testcollector.fanout//message_queue1?durable='false'&amp;autodelete='true'&amp;exclusive='false'">fanout://testcollector.fanout//message_queue1?durable='false'&amp;autodelete='true'&amp;exclusive='false'</A>

destination.fanoutQueue2 =
BURL:<A HREF="fanout://testcollector.fanout//message_queue2?durable='false'&amp;autodelete='true'&amp;exclusive='false'">fanout://testcollector.fanout//message_queue2?durable='false'&amp;autodelete='true'&amp;exclusive='false'</A>

destination.fanoutQueue3 =
BURL:<A HREF="fanout://testcollector.fanout//message_queue3?durable='false'&amp;autodelete='true'&amp;exclusive='false'">fanout://testcollector.fanout//message_queue3?durable='false'&amp;autodelete='true'&amp;exclusive='false'</A>
-------------------------

I tried to connect two consumers to message_queue1 and I get the following
error:
INFO org.apache.qpid.client.AMQConnection - Closing AMQConnection due to
:<i>org.apache.qpid.AMQException: ch=0 id=0
</I>ExecutionException(errorCode=RESOURCE_LOCKED, commandId=6, classCode=4,
commandCode=7, fieldIndex=0, description=resource-locked: Queue
message_queue1 has an exclusive consumer. No more consumers allowed.
(qpid/broker/Queue.cpp:385), errorInfo={}) [error code 405: Already exists]

I checked the configuration on AMQP Server and it says that message_queue1
is a non-exclusive queue.
-bash-4.1$ qpid-stat -q
Queues
  queue                                  dur  autoDel  excl  msg   msgIn 
msgOut  bytes  bytesIn  bytesOut  cons  bind
  message_queue1                              Y                 1    22    
21      15    324      309         1     2


Here is the code I am using.

Producer.java: (queueName=fanoutQueue)
----------------
                Properties properties = new Properties();
		properties.load(this.getClass().getResourceAsStream(&quot;fanout.properties&quot;));

		//Create the initial context
		Context ctx = new InitialContext(properties);

		// look up destination and connection factory
		Destination destination = (Destination)ctx.lookup(queueName);
		ConnectionFactory conFac =
(ConnectionFactory)ctx.lookup(&quot;qpidConnectionfactory&quot;);
		
		Connection connection = conFac.createConnection();
		Session session = connection.createSession(false,
Session.AUTO_ACKNOWLEDGE);
		
		MessageProducer messageProducer = session.createProducer(destination);
		TextMessage message;

		// Send a series of messages in a loop
		int i=0;
		while(true) {
			message = session.createTextMessage(&quot;Hello world! &quot;+i);
		    messageProducer.send(message, DeliveryMode.NON_PERSISTENT,   
Message.DEFAULT_PRIORITY, 60*1000);
			i++;
			Thread.sleep(1000);
		}
-------------------

Consumer.java: (queueName=fanoutQueue1)
-----------------
                Properties properties = new Properties();
		properties.load(this.getClass().getResourceAsStream(&quot;fanout.properties&quot;));

		//Create the initial context
		Context ctx = new InitialContext(properties);

		// look up destination and connection factory
		Destination destination = (Destination)ctx.lookup(queueName);
		ConnectionFactory conFac =
(ConnectionFactory)ctx.lookup(&quot;qpidConnectionfactory&quot;);
		
		Connection connection = conFac.createConnection();
		connection.setExceptionListener(new ExceptionListener()
		{
		    public void onException(JMSException jmse)
		    {
		        System.err.println(CLASS + &quot;: The sample received an exception
through the ExceptionListener&quot;);
		        System.exit(0);
		    }
		});

		System.out.println(CLASS + &quot;: Creating a non-transacted, auto-acknowledged
session&quot;);
		Session session = connection.createSession(false,
Session.AUTO_ACKNOWLEDGE);
		
		MessageConsumer messageConsumer = session.createConsumer(destination);
		connection.start();
		
		while(true) {
			TextMessage message = (TextMessage)messageConsumer.receive(1000);
			if(message != null)
				System.out.println(message.getText());
		}
-----------------

I am using QPID, but I figured if this is doable in RabbitMQ, then it should
be possible in QPID too.
Am I missing something here?

I really appreciate your help.

Thanks,
Uday

-- 
View this message in context: <A HREF="http://old.nabble.com/Unable-to-connect-multiple-consumers-to-a-queue-bound-to-fanned-out-exchange-tp32058027p32058027.html">http://old.nabble.com/Unable-to-connect-multiple-consumers-to-a-queue-bound-to-fanned-out-exchange-tp32058027p32058027.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.

</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013885.html">[rabbitmq-discuss] Rabbit 2.2 does not report connected	consumers
</A></li>
	<LI>Next message: <A HREF="013894.html">[rabbitmq-discuss] Unable to connect multiple consumers to a queue bound to fanned out exchange
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13889">[ date ]</a>
              <a href="thread.html#13889">[ thread ]</a>
              <a href="subject.html#13889">[ subject ]</a>
              <a href="author.html#13889">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
