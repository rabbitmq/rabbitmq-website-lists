<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ-C: amqp_simple_rpc blocks waiting	for frames already received
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ-C%3A%20amqp_simple_rpc%20blocks%20waiting%0A%09for%20frames%20already%20received&In-Reply-To=%3Cyrv4coc0hrs6v.fsf%40dwragg.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014093.html">
   <LINK REL="Next"  HREF="014177.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ-C: amqp_simple_rpc blocks waiting	for frames already received</H1>
    <B>David Wragg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ-C%3A%20amqp_simple_rpc%20blocks%20waiting%0A%09for%20frames%20already%20received&In-Reply-To=%3Cyrv4coc0hrs6v.fsf%40dwragg.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ-C: amqp_simple_rpc blocks waiting	for frames already received">david at rabbitmq.com
       </A><BR>
    <I>Tue Jul 26 16:13:12 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014093.html">[rabbitmq-discuss] RabbitMQ-C: amqp_simple_rpc blocks waiting	for frames already received
</A></li>
        <LI>Next message: <A HREF="014177.html">[rabbitmq-discuss] RabbitMQ-C: amqp_simple_rpc blocks waiting	for frames already received
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14176">[ date ]</a>
              <a href="thread.html#14176">[ thread ]</a>
              <a href="subject.html#14176">[ subject ]</a>
              <a href="author.html#14176">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Clint,

Clint Miller &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">clint at rtcreativegroup.com</A>&gt; writes:
&gt;<i> OK, here's the basic example. It shows how the basic.consume method of
</I>&gt;<i> the C++ library is not functioning correctly, but the basic.get works
</I>&gt;<i> correctly.
</I>&gt;<i>
</I>&gt;<i> There's a basic Makefile that will probably require a little tweaking to get it working. It also depends on the 2 following libraries:
</I>&gt;<i>
</I>&gt;<i> - RabbitMQ-C (from the official repository, I built it at rev/changeset ef4df46cc0db)
</I>&gt;<i> - AMQPcpp (from <A HREF="https://github.com/akalend/amqpcpp.git">https://github.com/akalend/amqpcpp.git</A> I built it at
</I>&gt;<i> rev/changeset 80b17375f5bed6965acc07477499285b6851c92f)
</I>
Thanks, I got it building quite easily.  I'm not sure if I'm able to
reproduce the problem that you described in your original mail, but I
can confirm that it doesn't work for me.

This isn't primarily due to the use of librabbitmq in amqpcpp.  That
looks basically sound (there are some calls to amqp_release_buffers in
AMQPQueue.cpp that should be amqp_maybe_release_buffers, but otherwise I
haven't found anything specifically wrong).

But when I run the program, it aborts.  Running it inside gdb, I get
double free errors reported.  So I ran it under valgrind.  And valgrind
finds many problems in amqpcpp.  (In fairness, it also complains about
some things in librabbitmq, but they are about the use of uninitialized
data, and may be harmless.)

The critical issue is a double free of the message buffer in
AMQPQueue::sendConsumeCommand: At AMQPQueue.cpp#L512, buf is handed to
the AMQPMessage object, and then freed.  But AMQPMessage holds on to
this pointer, and frees it again in its destructor (called via the
message auto_ptr).

valgrind also revealed a lot of cases of amqpcpp trying to use freed
data (e.g. by passing a char* to AMQPQueue::setConsumerTag, you invoke
the implicit conversion to string, and the string data is freed after
the call; but setConsumerTag then uses c_str to get a pointer to the
string data, which is saved in consumer_tag and only used later in
sendConsumeCommand).

I think amqpcpp needs cleaning up with valgrind in order to work
reliably.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
VMware, Inc.
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014093.html">[rabbitmq-discuss] RabbitMQ-C: amqp_simple_rpc blocks waiting	for frames already received
</A></li>
	<LI>Next message: <A HREF="014177.html">[rabbitmq-discuss] RabbitMQ-C: amqp_simple_rpc blocks waiting	for frames already received
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14176">[ date ]</a>
              <a href="thread.html#14176">[ thread ]</a>
              <a href="subject.html#14176">[ subject ]</a>
              <a href="author.html#14176">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
