<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Tutorial%20example%20suggestion%3A%20work%20queues%0A%20tutorial%20could%20have%20a%20description%20of%20hierarchical%20shutdown%20logic&In-Reply-To=%3C8A1A883E3F171B42A81817DEC138352C1DB514BA63%40MX06A.corp.emc.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013761.html">
   <LINK REL="Next"  HREF="013769.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic</H1>
    <B>Lowell.Boggs at emc.com</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Tutorial%20example%20suggestion%3A%20work%20queues%0A%20tutorial%20could%20have%20a%20description%20of%20hierarchical%20shutdown%20logic&In-Reply-To=%3C8A1A883E3F171B42A81817DEC138352C1DB514BA63%40MX06A.corp.emc.com%3E"
       TITLE="[rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic">Lowell.Boggs at emc.com
       </A><BR>
    <I>Fri Jul  8 15:17:56 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013761.html">[rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic
</A></li>
        <LI>Next message: <A HREF="013769.html">[rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13763">[ date ]</a>
              <a href="thread.html#13763">[ thread ]</a>
              <a href="subject.html#13763">[ subject ]</a>
              <a href="author.html#13763">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Ann,

I understand that you folks have a plan for your tutorials and I respect that.  I am really delighted with the quality of the tutorials and wish to thank you very much for the hard work that you have put in to make them useful.  Even though you don't have a C language tutorial, I was able to quickly and easily create test programs using the C language interfaces based on the contents of the python and java tutorials as examples.

I like the way that the tutorials were activity oriented -- that is, rather than putting in a lot of theory up front, the tutorials jump right in with real world examples and build on top of one another.  This is sort of the Stephen King novel version of tutorials.  He always starts with some sort interesting event and then later goes back fills in the details.  

To carry this metaphor forward, I think that the existing tutorials are great but would benefit from the addition of web links at strategic places in the tutorials to &quot;big picture&quot; theory pages.  For example, one such page might be titled &quot;Exchanges vs Queues&quot;.   That page could be structured not as a tutorial but as a reference and practical advice on designing applications to take advantage of the contrasting features of exchanges and queues.  Links to these pages could appear as &quot;see also&quot; links in the other tutorials or as highlighted words, linked to the theory pages, within the existing text (my preference).

Thanks for listening and thanks again for doing such a great job on the tutorials.

Lowell

 

-----Original Message-----
From: Ann Witbrock (c) [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">awitbrock at vmware.com</A>] 
Sent: Friday, July 08, 2011 6:24 AM
To: Boggs Jr., Lowell
Cc: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">david at rabbitmq.com</A>
Subject: Re: [rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic

Hi Lowell,
thanks for the suggestion.
I agree that a tutorial on this (shutdown, auto-delete and similar parameters, and related matters) would be useful, but I don't agree that tutorial is the right place for it. I already have that in as a proposed work item. This example could well be helpful in it.

Ann

----- Original Message -----
From: &quot;Lowell Boggs&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">Lowell.Boggs at emc.com</A>&gt;
To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">david at rabbitmq.com</A>
Cc: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Sent: Thursday, 7 July, 2011 4:00:47 PM
Subject: [rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic

Thanks for this great advice.  

I looked for an example of how to handle shutdown and other system commands in this tutorial:

   <A HREF="http://www.rabbitmq.com/tutorials/tutorial-two-python.html">http://www.rabbitmq.com/tutorials/tutorial-two-python.html</A>

But not finding any advice there, I tried to come up with my own idea based on concepts that I gleaned from the rabbitmq-c interfaces themselves and the tutorial examples.  I see the benefits of your suggestion below.

I would like to suggest that the work queues tutorial is a great place to insert the important information you provided in the attached email about exchange hierarchies.

Note that it would not be necessary to provide example code for this to be a helpful addition.  If you understand the work queues logic, you can understand a description of the shutdown logic without seeing it worked out.  

Also, I have not found (maybe I just haven't looked hard enough) a good explanation of why I should prefer one exchange type over the other.  Direct seems to be doing everything I need.  I am a bit concerned about the performance impact of of using topic name patterns.  The shutdown example you give below would be a nice place in the tutorials to comment on which exchange type is best suited for what.

Thanks again!

Lowell


-----Original Message-----
From: David Wragg [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">david at rabbitmq.com</A>] 
Sent: Wednesday, July 06, 2011 5:35 PM
To: Boggs Jr., Lowell
Cc: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Subject: Re: [rabbitmq-discuss] rabbitmq-c: amqp_exchange_declare() always sets auto-delete to no

Hi Lowell,

&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">Lowell.Boggs at emc.com</A>&gt; writes:
&gt;<i> Is there a reason that you cannot create an exchange with the
</I>&gt;<i> auto_delete property == true?
</I>
Auto-delete on exchanges is a AMQP 0-8 feature that is deprecated in
AMQP 0-9-1.  This is why the amqp_exchange_declare function does not
expose it (ever since it was converted to AMQP 0-9-1).

&gt;<i> Is it safe for me as an application devloper to create a clone of this
</I>&gt;<i> function that has the auto_delete property passed in?  Does the
</I>&gt;<i> rabbitmq team have plans to change the way the underlying functions
</I>&gt;<i> work?
</I>
It is safe, but not a good idea.

rabbitmq-server still supports AMQP 0-8, including the auto-delete
property on exchanges.  So if you copy amqp_exchange_declare and add
that parameter, it will work today.  But at some point, rabbitmq-server
may drop AMQP 0-8 compatibility, and then it would stop working.

&gt;<i> Is a temporary exchange even a good idea?
</I>
Not really.

&gt;<i> I am trying to simplify the shutdown logic of a multi-threaded
</I>&gt;<i> application.  I don't want to have to invent a way of signaling my
</I>&gt;<i> worker threads to shut down.  Instead, I want to send them a message
</I>&gt;<i> that they can read like normal but have a quick way of identifying
</I>&gt;<i> that this is a shutdown command. I am currently writing code for my
</I>&gt;<i> threads that work like this:
</I>&gt;<i>
</I>&gt;<i> void Thread()
</I>&gt;<i> {
</I>&gt;<i>
</I>&gt;<i>     // create the connection
</I>&gt;<i>     // declare the primary command exchange
</I>&gt;<i>     // declare the qrimary queue
</I>&gt;<i>     // declare a &quot;stop command&quot; exchange
</I>&gt;<i>     // declare a &quot;stop command&quot; queue
</I>&gt;<i>     // bind everyone up and call basic_consume on the queues
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     for(;;)
</I>&gt;<i>      {
</I>&gt;<i>         string exchangeName;
</I>&gt;<i>         string topicName;
</I>&gt;<i>         string messageBody;
</I>&gt;<i>
</I>&gt;<i>          int error = readMessage(exchangeName, topicName, messageBody);
</I>&gt;<i>
</I>&gt;<i>          if(error) break;
</I>&gt;<i>
</I>&gt;<i>         if(exchangeName == &quot;stop&quot;)
</I>&gt;<i>            break;
</I>&gt;<i>
</I>&gt;<i>        processMesage(messageBody);
</I>&gt;<i>
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> Note that I am having multiple threads in multiple executables on
</I>&gt;<i> multiple machines all reading from the same primary command exchange
</I>&gt;<i> for performance and redundancy reasons -- so I can't really use the
</I>&gt;<i> topic to indicate shutdown.  I might want to shutdown a given
</I>&gt;<i> executable on a given host, not the entire system.
</I>&gt;<i>
</I>&gt;<i> The above logic is working fine, but when I kill a process, I have to
</I>&gt;<i> remember to delete the exchanges because they don't have an autoDelete
</I>&gt;<i> flag.
</I>&gt;<i>
</I>&gt;<i> Is there a better way to handle this shutdown logic?
</I>
It sounds like you have a hierarchy of threads, processes, and machines.
And you want to send command messages (including shutdown messages) to
the various levels in that hierarchy: To a thread, to all the threads
in a process, to all the threads in all processes on a host, and to all
threads everywhere.

You can accomplish this by declaring four exchanges. Let's call them
&quot;per-thread&quot;, &quot;per-process&quot;, &quot;per-host&quot; and &quot;everything&quot;.

Each thread declares an auto-delete queue for itself, and binds this
queue to all four exchanges, but with different binding keys.

&quot;per-thread&quot; should be a direct exchange.  A thread binds its queue to
this exchange  with a binding key of the form &quot;&lt;host_id&gt;.&lt;process_id&gt;.&lt;thread_id&gt;&quot;.

&quot;per-process&quot; should be a direct exchange.  A thread binds its queue to
this exchange with with a binding key of the form
&quot;&lt;host_id&gt;.&lt;process_id&gt;&quot;.

&quot;per-host&quot; should be a direct exchange.  A thread binds its queue to
this exchange with with a binding key of the form &quot;&lt;host_id&gt;&quot;

Finally, &quot;everything&quot; can just be a fanout exchange (and so the binding
key is not used).

In order to send a command, use the exchange for the appropriate level
in the hierarchy, and the corresponding routing key.

Because all four exchanges are long lived, your code should not need to
delete any of them.

-- 
David Wragg
Staff Engineer, RabbitMQ
VMware, Inc.
_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</PRE>


































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013761.html">[rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic
</A></li>
	<LI>Next message: <A HREF="013769.html">[rabbitmq-discuss] Tutorial example suggestion: work queues tutorial could have a description of hierarchical shutdown logic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13763">[ date ]</a>
              <a href="thread.html#13763">[ thread ]</a>
              <a href="subject.html#13763">[ subject ]</a>
              <a href="author.html#13763">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
