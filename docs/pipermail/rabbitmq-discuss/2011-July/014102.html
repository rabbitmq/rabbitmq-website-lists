<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Slow shutdown issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Slow%20shutdown%20issue&In-Reply-To=%3C20110722113838.GA22073%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014139.html">
   <LINK REL="Next"  HREF="014129.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Slow shutdown issue</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Slow%20shutdown%20issue&In-Reply-To=%3C20110722113838.GA22073%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Slow shutdown issue">matthew at rabbitmq.com
       </A><BR>
    <I>Fri Jul 22 12:38:38 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014139.html">[rabbitmq-discuss] Slow shutdown issue
</A></li>
        <LI>Next message: <A HREF="014129.html">[rabbitmq-discuss] Slow shutdown issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14102">[ date ]</a>
              <a href="thread.html#14102">[ thread ]</a>
              <a href="subject.html#14102">[ subject ]</a>
              <a href="author.html#14102">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Ray,

On Thu, Jul 21, 2011 at 03:18:11PM -0400, Raymond Murthi wrote:
&gt;<i> I am pretty new on RabbitMQ and I am trying to do a stress test on
</I>&gt;<i> RabbitMQ (v. 2.5.1) using the following properties: 1kb persistent
</I>&gt;<i> message, nondurable queue, and without any ready consumer (that is,
</I>&gt;<i> just writing to the queue). However, every time I overload the RAM
</I>&gt;<i> (13.7GB high watermark) and force RabbitMQ to write to disk, I always
</I>&gt;<i> experience a very long wait time whenever I want to shutdown the
</I>&gt;<i> server/stopping the app/purging the queue. The wait time could be over
</I>&gt;<i> an hour depending on the number of messages I sent (I sent over 5
</I>&gt;<i> millions messages). I  also notice that RabbitMQ tries to dump the
</I>&gt;<i> messages from the memory to the disk (under /msg_store_transient) -
</I>&gt;<i> since nothing is consumed.
</I>
Regardless of whether a persistent msg is written to a transient or
durable queue, it will eventually get written to disk. If you don't want
msgs to be written to disk by default then don't publish persistent
msgs. That way, they'll only get written to disk when you run low on
memory.

The test you're running results in many GB of msgs in RAM pending being
written to disk. On shutdown, Rabbit is trying to write those msgs to
disk, and thus your disk is the bottleneck.

If you declared the queue exclusive then we have some logic in there
that should make the shutdown of the queue and broker much faster. I'll
checker later today but I've a feeling that the same logic doesn't apply
to transient queues, though I can't think of a good reason why not.

Repeat your test but declare the queue as exclusive. You should find
that the shutdown of the broker is then much much faster.

&gt;<i> I read the documentation and it looks like it is (but isn't it too
</I>&gt;<i> long?).
</I>
Writing 14GB of data to disk is likely to take a while.

&gt;<i> How to kill the process immediately?
</I>
kill -9, pull the power chord etc. But you'll lose messages. That said,
your test probably isnt concerned with msgs surviving restart.

&gt;<i> And why are messages
</I>&gt;<i> stored under /msg_store_transient instead of /msg_store_persistent?
</I>
Because they're msgs going to a transient queue.

&gt;<i> What  is the difference between the two directories?
</I>
transient is for msgs sent to transient queues. This directory is blown
away on startup because no transient queues survive broker restart.

persistent is fro msgs sent to durable queues.

Matthew
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014139.html">[rabbitmq-discuss] Slow shutdown issue
</A></li>
	<LI>Next message: <A HREF="014129.html">[rabbitmq-discuss] Slow shutdown issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14102">[ date ]</a>
              <a href="thread.html#14102">[ thread ]</a>
              <a href="subject.html#14102">[ subject ]</a>
              <a href="author.html#14102">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
