<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Unable to get Federation connection established
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unable%20to%20get%20Federation%20connection%20established&In-Reply-To=%3CCACLE7iw1XL1o5_CxHe6qEEfq7Tjw5gvP%2BzBWuy7arQOxyUq%2Byg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023907.html">
   <LINK REL="Next"  HREF="023852.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Unable to get Federation connection established</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unable%20to%20get%20Federation%20connection%20established&In-Reply-To=%3CCACLE7iw1XL1o5_CxHe6qEEfq7Tjw5gvP%2BzBWuy7arQOxyUq%2Byg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Unable to get Federation connection established">mpietrek at skytap.com
       </A><BR>
    <I>Wed Nov 14 20:01:52 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023907.html">[rabbitmq-discuss] RabbitMQ as communication server for mobile	devices
</A></li>
        <LI>Next message: <A HREF="023852.html">[rabbitmq-discuss] Unable to get Federation connection	established
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23851">[ date ]</a>
              <a href="thread.html#23851">[ thread ]</a>
              <a href="subject.html#23851">[ subject ]</a>
              <a href="author.html#23851">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've got a head scratcher here with regards to federation.

We have two brokers running 2.8.6. I want to establish bidirectional
federated topic exchanges between the brokers. However, when I start up all
the brokers the federation tab in the Web UI shows &quot;starting&quot; indefinitely.

Looking at the logs, I see a stream of messages like this from each broker:

&lt;&lt;&lt; from host util1 &gt;&gt;&gt;
=WARNING REPORT==== 14-Nov-2012::11:49:19 ===
Federation exchange 'skytap' in vhost '/' did not connect to
west1util1:55672:/:skytap
{error,handshake_receive_timed_out}


&lt;&lt;&lt; from host west1util1 &gt;&gt;&gt;
=WARNING REPORT==== 14-Nov-2012::10:41:41 ===
Federation exchange 'skytap' in vhost '/' did not connect to
util1:55672:/:skytap
{error,handshake_receive_timed_out}


Using Wireshark, I've verified that traffic on port 55672 is going back and
forth between the two machines, corresponding to the 1 minute connection
retry intervals. See very end of this message for packet summary.

Both brokers appear otherwise healthy and the &quot;Exchanges&quot; tab shows &quot;skytap
x-federation D Args&quot; on both brokers.

This exact same setup has worked previously on several different testbeds.
My rabbitmq.config file is generated programmatically and has worked
reliably in other federation scenarios, so I'm reasonably sure it's not
just a fat-fingered rabbitmq.config file. That said, the config file looks
like this:

[
{rabbit, [{cluster_nodes, [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util1</A>]}, {disk_free_limit, 104857600}]},
{mnesia, [{debug, none}]},
{rabbitmq_federation, [{exchanges, [[{type, &quot;topic&quot;}, {upstream_set,
&quot;skytap_upstreams&quot;}, {virtual_host, &quot;/&quot;}, {exchange, &quot;skytap&quot;}]]},
{upstream_sets, [{connection, &quot;upstream-abc123-cloud/west1&quot;}, {max_hops,
1}, {exchange, &quot;skytap&quot;}]]}]},
{connections, [{&quot;upstream-abc123-cloud/west1&quot;, [{username, &quot;foo&quot;}, {host,
&quot;west1util1&quot;}, {password, &quot;foo&quot;}, {port, 55672}]}]}]}

I don't see anything else interesting in the other log files. Any hints on
how I can track this down?

Thanks,

Matt

Packet summary:

No.     Time        Source                Destination           Protocol
Info
      1 0.000000    10.1.208.5            10.1.208.39           TCP
40729 &gt; 55672 [FIN, ACK] Seq=1 Ack=1 Win=92 Len=0 TSV=466020877
TSER=354966603
      2 0.001593    10.1.208.39           10.1.208.5            TCP
55672 &gt; 40729 [FIN, ACK] Seq=1 Ack=2 Win=91 Len=0 TSV=354972603
TSER=466020877
      3 0.001607    10.1.208.5            10.1.208.39           TCP
40729 &gt; 55672 [ACK] Seq=2 Ack=2 Win=92 Len=0 TSV=466020878 TSER=354972603
      4 0.020673    10.1.208.5            10.1.208.39           TCP
42451 &gt; 55672 [SYN] Seq=0 Win=5840 Len=0 MSS=1460 TSV=466020880 TSER=0 WS=6
      5 0.022202    10.1.208.39           10.1.208.5            TCP
55672 &gt; 42451 [SYN, ACK] Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 TSV=354972605
TSER=466020880 WS=6
      6 0.022215    10.1.208.5            10.1.208.39           TCP
42451 &gt; 55672 [ACK] Seq=1 Ack=1 Win=5888 Len=0 TSV=466020880 TSER=354972605
      7 0.022280    10.1.208.5            10.1.208.39           TCP
42451 &gt; 55672 [PSH, ACK] Seq=1 Ack=1 Win=5888 Len=8 TSV=466020880
TSER=354972605
      8 0.023274    10.1.208.39           10.1.208.5            TCP
55672 &gt; 42451 [ACK] Seq=1 Ack=9 Win=5824 Len=0 TSV=354972605 TSER=466020880
     14 57.211788   10.1.208.39           10.1.208.5            TCP
56169 &gt; 55672 [FIN, ACK] Seq=1 Ack=1 Win=92 Len=0 TSV=354978324
TSER=466020599
     15 57.211854   10.1.208.5            10.1.208.39           TCP
55672 &gt; 56169 [FIN, ACK] Seq=1 Ack=2 Win=91 Len=0 TSV=466026599
TSER=354978324
     16 57.212561   10.1.208.39           10.1.208.5            TCP
56169 &gt; 55672 [ACK] Seq=2 Ack=2 Win=92 Len=0 TSV=354978324 TSER=466026599
     17 57.231459   10.1.208.39           10.1.208.5            TCP
33070 &gt; 55672 [SYN] Seq=0 Win=5840 Len=0 MSS=1460 TSV=354978326 TSER=0 WS=6
     18 57.231491   10.1.208.5            10.1.208.39           TCP
55672 &gt; 33070 [SYN, ACK] Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 TSV=466026601
TSER=354978326 WS=6
     19 57.232238   10.1.208.39           10.1.208.5            TCP
33070 &gt; 55672 [ACK] Seq=1 Ack=1 Win=5888 Len=0 TSV=354978326 TSER=466026601
     20 57.232266   10.1.208.39           10.1.208.5            TCP
33070 &gt; 55672 [PSH, ACK] Seq=1 Ack=1 Win=5888 Len=8 TSV=354978326
TSER=466026601
     21 57.232273   10.1.208.5            10.1.208.39           TCP
55672 &gt; 33070 [ACK] Seq=1 Ack=9 Win=5824 Len=0 TSV=466026601 TSER=354978326
     22 60.023027   10.1.208.5            10.1.208.39           TCP
42451 &gt; 55672 [FIN, ACK] Seq=9 Ack=1 Win=5888 Len=0 TSV=466026880
TSER=354972605
     23 60.024243   10.1.208.39           10.1.208.5            TCP
55672 &gt; 42451 [FIN, ACK] Seq=1 Ack=10 Win=5824 Len=0 TSV=354978605
TSER=466026880
     24 60.024259   10.1.208.5            10.1.208.39           TCP
42451 &gt; 55672 [ACK] Seq=10 Ack=2 Win=5888 Len=0 TSV=466026880 TSER=354978605
     25 60.054155   10.1.208.5            10.1.208.39           TCP
43254 &gt; 55672 [SYN] Seq=0 Win=5840 Len=0 MSS=1460 TSV=466026883 TSER=0 WS=6
     26 60.055619   10.1.208.39           10.1.208.5            TCP
55672 &gt; 43254 [SYN, ACK] Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 TSV=354978608
TSER=466026883 WS=6
     27 60.055637   10.1.208.5            10.1.208.39           TCP
43254 &gt; 55672 [ACK] Seq=1 Ack=1 Win=5888 Len=0 TSV=466026883 TSER=354978608
     28 60.055699   10.1.208.5            10.1.208.39           TCP
43254 &gt; 55672 [PSH, ACK] Seq=1 Ack=1 Win=5888 Len=8 TSV=466026883
TSER=354978608
     29 60.056525   10.1.208.39           10.1.208.5            TCP
55672 &gt; 43254 [ACK] Seq=1 Ack=9 Win=5824 Len=0 TSV=354978608 TSER=466026883
     35 117.235482  10.1.208.39           10.1.208.5            TCP
33070 &gt; 55672 [FIN, ACK] Seq=9 Ack=1 Win=5888 Len=0 TSV=354984326
TSER=466026601
     36 117.235554  10.1.208.5            10.1.208.39           TCP
55672 &gt; 33070 [FIN, ACK] Seq=1 Ack=10 Win=5824 Len=0 TSV=466032601
TSER=354984326
     37 117.236376  10.1.208.39           10.1.208.5            TCP
33070 &gt; 55672 [ACK] Seq=10 Ack=2 Win=5888 Len=0 TSV=354984326 TSER=466032601
     38 117.257662  10.1.208.39           10.1.208.5            TCP
55930 &gt; 55672 [SYN] Seq=0 Win=5840 Len=0 MSS=1460 TSV=354984329 TSER=0 WS=6
     39 117.257693  10.1.208.5            10.1.208.39           TCP
55672 &gt; 55930 [SYN, ACK] Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 TSV=466032603
TSER=354984329 WS=6
     40 117.258899  10.1.208.39           10.1.208.5            TCP
55930 &gt; 55672 [ACK] Seq=1 Ack=1 Win=5888 Len=0 TSV=354984329 TSER=466032603
     41 117.258924  10.1.208.39           10.1.208.5            TCP
55930 &gt; 55672 [PSH, ACK] Seq=1 Ack=1 Win=5888 Len=8 TSV=354984329
TSER=466032603
     42 117.258931  10.1.208.5            10.1.208.39           TCP
55672 &gt; 55930 [ACK] Seq=1 Ack=9 Win=5824 Len=0 TSV=466032603 TSER=354984329
     43 120.056005  10.1.208.5            10.1.208.39           TCP
43254 &gt; 55672 [FIN, ACK] Seq=9 Ack=1 Win=5888 Len=0 TSV=466032883
TSER=354978608
     44 120.057752  10.1.208.39           10.1.208.5            TCP
55672 &gt; 43254 [FIN, ACK] Seq=1 Ack=10 Win=5824 Len=0 TSV=354984609
TSER=466032883
     45 120.057781  10.1.208.5            10.1.208.39           TCP
43254 &gt; 55672 [ACK] Seq=10 Ack=2 Win=5888 Len=0 TSV=466032883 TSER=354984609
     46 120.077268  10.1.208.5            10.1.208.39           TCP
33297 &gt; 55672 [SYN] Seq=0 Win=5840 Len=0 MSS=1460 TSV=466032885 TSER=0 WS=6
     47 120.079009  10.1.208.39           10.1.208.5            TCP
55672 &gt; 33297 [SYN, ACK] Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 TSV=354984611
TSER=466032885 WS=6
     48 120.079030  10.1.208.5            10.1.208.39           TCP
33297 &gt; 55672 [ACK] Seq=1 Ack=1 Win=5888 Len=0 TSV=466032885 TSER=354984611
     49 120.079096  10.1.208.5            10.1.208.39           TCP
33297 &gt; 55672 [PSH, ACK] Seq=1 Ack=1 Win=5888 Len=8 TSV=466032885
TSER=354984611
     50 120.079884  10.1.208.39           10.1.208.5            TCP
55672 &gt; 33297 [ACK] Seq=1 Ack=9 Win=5824 Len=0 TSV=354984611 TSER=466032885
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121114/d63a2bcb/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121114/d63a2bcb/attachment.htm</A>&gt;
</PRE>

















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023907.html">[rabbitmq-discuss] RabbitMQ as communication server for mobile	devices
</A></li>
	<LI>Next message: <A HREF="023852.html">[rabbitmq-discuss] Unable to get Federation connection	established
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23851">[ date ]</a>
              <a href="thread.html#23851">[ thread ]</a>
              <a href="subject.html#23851">[ subject ]</a>
              <a href="author.html#23851">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
