<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Memory leak with file_io_server, server_loop?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20leak%20with%20file_io_server%2C%20server_loop%3F&In-Reply-To=%3CCAChq9g1Cr993U1KtUcfO_sWZfNyX3%2B6E6%3D%2BEgfe4R0X3d4ZPwQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023612.html">
   <LINK REL="Next"  HREF="023651.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Memory leak with file_io_server, server_loop?</H1>
    <B>Travis</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20leak%20with%20file_io_server%2C%20server_loop%3F&In-Reply-To=%3CCAChq9g1Cr993U1KtUcfO_sWZfNyX3%2B6E6%3D%2BEgfe4R0X3d4ZPwQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Memory leak with file_io_server, server_loop?">hcoyote at ghostar.org
       </A><BR>
    <I>Tue Nov  6 17:39:40 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023612.html">[rabbitmq-discuss] Memory leak with file_io_server, server_loop?
</A></li>
        <LI>Next message: <A HREF="023651.html">[rabbitmq-discuss] Memory leak with file_io_server, server_loop?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23627">[ date ]</a>
              <a href="thread.html#23627">[ thread ]</a>
              <a href="subject.html#23627">[ subject ]</a>
              <a href="author.html#23627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Nov 5, 2012 at 6:23 PM, Matthias Radestock
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt; wrote:
&gt;<i> Travis,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 05/11/12 23:38, Travis wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hmm. forcing a gc of the file_io_server process *should* drop the memory
</I>&gt;<i> usage. What exactly did you try?
</I>
I tried various forms of the following which didn't work (because of
ERL syntax issues)

sudo rabbitmqctl eval 'erlang:garbage_collect(whereis(file_io_server)).'
sudo rabbitmqctl eval 'erlang:garbage_collect(whereis(server_loop)).'

and then attempted

sudo rabbitmqctl eval 'erlang:garbage_collect().'

which returned true, but doesn't appear to have done anything.

I'm basically poking around in the dark here with ERL so I'm not
exactly sure if that does what I intend it to do (force an overall GC
to occur ... guessing no).

&gt;<i>
</I>&gt;<i> rabbitmqctl eval '[garbage_collect(P) || {P, _} &lt;-
</I>&gt;<i> ets:tab2list(file_io_servers)].'
</I>&gt;<i>
</I>&gt;<i> should do the trick.
</I>&gt;<i>
</I>
That did it.  Usage dropped by 400MB.  Then I found that error_logger
was chewing up ~200MB, so I ran the garbage_collect version y'all gave
me previously to handle that:

rabbitmqctl eval 'erlang:garbage_collect(whereis(error_logger)).'

and things dropped further.

&gt;<i> It is quite possible that the file_io_servers in question deal with log
</I>&gt;<i> files. Do you have particularly large log files on those machines? You may
</I>&gt;<i> want to reduce the connection log level - see
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/configure.html#config-items">http://www.rabbitmq.com/configure.html#config-items</A> - and/or rotate the logs
</I>&gt;<i> with <A HREF="http://www.rabbitmq.com/man/rabbitmqctl.1.man.html#rotate_logs">http://www.rabbitmq.com/man/rabbitmqctl.1.man.html#rotate_logs</A>
</I>&gt;<i>
</I>
I wouldn't call them appreciably large.  We're using the standard
logrotate.d config that comes with the RPMs which rotates weekly.

On one server, last week's log file was 54MB, where as this week's
(with ~3 days of logs) is 19MB.

The log from this week breaks down with:

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tcampbell at host</A> rabbitmq]$ grep REPORT rabbit\@host.log | awk -F====
'{print $1}' | sort | uniq -c
    116 =ERROR REPORT
  93656 =INFO REPORT
  40792 =WARNING REPORT

of which, all of the warnings are just errors about connections
closing abruptly.

closing AMQP connection &lt;0.2945.6&gt; (127.0.0.1:57242 -&gt; 127.0.0.1:5672):
connection_closed_abruptly

and the info reports are the logs for accepting or closing connections
from localhost.

Travis


-- 
Travis Campbell
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">travis at ghostar.org</A>
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023612.html">[rabbitmq-discuss] Memory leak with file_io_server, server_loop?
</A></li>
	<LI>Next message: <A HREF="023651.html">[rabbitmq-discuss] Memory leak with file_io_server, server_loop?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23627">[ date ]</a>
              <a href="thread.html#23627">[ thread ]</a>
              <a href="subject.html#23627">[ subject ]</a>
              <a href="author.html#23627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
