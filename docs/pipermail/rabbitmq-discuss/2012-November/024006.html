<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 3.0 Policy ha-all delete issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%203.0%20Policy%20ha-all%20delete%20issue&In-Reply-To=%3C50ABBBC9.9000303%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024068.html">
   <LINK REL="Next"  HREF="024007.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 3.0 Policy ha-all delete issue</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%203.0%20Policy%20ha-all%20delete%20issue&In-Reply-To=%3C50ABBBC9.9000303%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ 3.0 Policy ha-all delete issue">simon at rabbitmq.com
       </A><BR>
    <I>Tue Nov 20 17:20:09 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024068.html">[rabbitmq-discuss] RabbitMQ 3.0 Policy ha-all delete issue
</A></li>
        <LI>Next message: <A HREF="024007.html">[rabbitmq-discuss] queue/exchange creation/deletion replication	serialization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24006">[ date ]</a>
              <a href="thread.html#24006">[ thread ]</a>
              <a href="subject.html#24006">[ subject ]</a>
              <a href="author.html#24006">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi. Thanks for the bug report.

So it seems like there's a race involving queues being deleted and 
having the message sent to them to start / stop mirroring. Hopefully 
this shouldn't be too big a deal to fix. I'll keep you informed.

Cheers, Simon

On 20/11/12 17:02, Mark Ward wrote:
&gt;<i> I should note that my testing clients are actively sending messages in 4
</I>&gt;<i> static queues.  but for each message sent they are creating a dynamic queue
</I>&gt;<i> and then later deleting the queue.  I think the issue could be happening
</I>&gt;<i> wile the cluster is handling some of the more volatile queues that are
</I>&gt;<i> created/deleted by the clients.
</I>&gt;<i>
</I>&gt;<i> What else I noticed.  I deleted the previous queue that was still tied to a
</I>&gt;<i> policy that didn't exist.  Began running my test again with no policies.
</I>&gt;<i> During the testing I created the policy to mirror the queues and received
</I>&gt;<i> another error.  then after a few moments of I deleted the policy.  An error
</I>&gt;<i> again.
</I>&gt;<i>
</I>&gt;<i> Now one of my more static queues was lost. It does not show up in the
</I>&gt;<i> management anymore.   I think the queue &quot;crashed&quot;
</I>&gt;<i>
</I>&gt;<i> Some of my errors from the logs
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 20-Nov-2012::10:33:30 ===
</I>&gt;<i> Adding mirror of queue 'dcf.action.status' in vhost 'MoBunnyMoProblems.DCF'
</I>&gt;<i> on node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at CUST1-MASTER</A>': &lt;2756.5031.0&gt;
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 20-Nov-2012::10:33:30 ===
</I>&gt;<i> Adding mirror of queue 'dcf.action.status' in vhost 'MoBunnyMoProblems.DCF'
</I>&gt;<i> on node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOBARON-1</A>': &lt;2754.13177.4&gt;
</I>&gt;<i>
</I>&gt;<i> =WARNING REPORT==== 20-Nov-2012::10:46:47 ===
</I>&gt;<i> closing AMQP connection &lt;0.32767.3&gt; (192.168.10.104:37880 -&gt;
</I>&gt;<i> 192.168.10.57:5672):
</I>&gt;<i> connection_closed_abruptly
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 20-Nov-2012::10:49:28 ===
</I>&gt;<i> ** Generic server &lt;0.6.4&gt; terminating
</I>&gt;<i> ** Last message in was stop_mirroring
</I>&gt;<i> ** When Server state == {q,
</I>&gt;<i>                           {amqqueue,
</I>&gt;<i>                            {resource,&lt;&lt;&quot;MoBunnyMoProblems.DCF&quot;&gt;&gt;,queue,
</I>&gt;<i>                             &lt;&lt;&quot;dcf.action.status&quot;&gt;&gt;},
</I>&gt;<i>                            true,false,none,
</I>&gt;<i>                            [{&lt;&lt;&quot;x-expires&quot;&gt;&gt;,signedint,100800000}],
</I>&gt;<i>                            &lt;0.6.4&gt;,[],[],
</I>&gt;<i>                            [{vhost,&lt;&lt;&quot;MoBunnyMoProblems.DCF&quot;&gt;&gt;},
</I>&gt;<i>                             {name,&lt;&lt;&quot;ha-all&quot;&gt;&gt;},
</I>&gt;<i>                             {pattern,&lt;&lt;&quot;^dcf&quot;&gt;&gt;},
</I>&gt;<i>                             {definition,[{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;}]},
</I>&gt;<i>                             {priority,0}],
</I>&gt;<i>                            []},
</I>&gt;<i>                           none,true,rabbit_variable_queue,
</I>&gt;<i>                           {vqstate,
</I>&gt;<i>                            {0,{[],[]}},
</I>&gt;<i>                            {0,{[],[]}},
</I>&gt;<i>                            {delta,undefined,0,undefined},
</I>&gt;<i>                            {0,{[],[]}},
</I>&gt;<i>                            {0,{[],[]}},
</I>&gt;<i>                            10885,
</I>&gt;<i>                            {0,nil},
</I>&gt;<i>                            undefined,
</I>&gt;<i>                            {0,nil},
</I>&gt;<i>                            {qistate,
</I>&gt;<i>
</I>&gt;<i> &quot;c:/rabbitmq.hold/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOOVERLORD-1-mnesia</A>/queues/CTMLPLO20JY4AIHN3GGESPI7D&quot;,
</I>&gt;<i>                             {{dict,0,16,16,8,80,48,
</I>&gt;<i>
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
</I>&gt;<i>                               {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                 []}}},
</I>&gt;<i>                              [{segment,0,
</I>&gt;<i>
</I>&gt;<i> &quot;c:/rabbitmq.hold/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOOVERLORD-1-mnesia</A>/queues/CTMLPLO20JY4AIHN3GGESPI7D/0.idx&quot;,
</I>&gt;<i>                                {array,16384,0,undefined,
</I>&gt;<i>                                 {{1000,1000,1000,1000,1000,1000,
</I>&gt;<i>                                   {100,100,100,100,100,100,100,100,
</I>&gt;<i>                                    {10,10,10,10,10,10,
</I>&gt;<i>                                     {undefined,undefined,undefined,
</I>&gt;<i>
</I>&gt;<i> {{&lt;&lt;240,91,13,230,237,230,42,174,76,54,117,
</I>&gt;<i>                                          111,236,199,4,71&gt;&gt;,
</I>&gt;<i>                                        {message_properties,undefined,true,
</I>&gt;<i>                                         false},
</I>&gt;<i>                                        true},
</I>&gt;<i>                                       del,ack},
</I>&gt;<i>
</I>&gt;<i> ..................... deleted bunch of stuff ......................
</I>&gt;<i>
</I>&gt;<i>                                     10,10},
</I>&gt;<i>                                    100,100},
</I>&gt;<i>
</I>&gt;<i> 1000,1000,1000,1000,1000,1000,1000,1000,1000,
</I>&gt;<i>                                   1000},
</I>&gt;<i>                                  10000,10000,10000,10000,10000,10000,10000,
</I>&gt;<i>                                  10000,10000}},
</I>&gt;<i>                                0}]},
</I>&gt;<i>                             #Ref&lt;0.0.7.158837&gt;,12066,262144,
</I>&gt;<i>                             #Fun&lt;rabbit_variable_queue.2.41635915&gt;,
</I>&gt;<i>                             {0,nil}},
</I>&gt;<i>                            {{client_msstate,msg_store_persistent,
</I>&gt;<i>
</I>&gt;<i> &lt;&lt;158,88,38,57,48,220,55,115,72,72,33,241,89,104,
</I>&gt;<i>                                106,124&gt;&gt;,
</I>&gt;<i>                              {dict,0,16,16,8,80,48,
</I>&gt;<i>
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
</I>&gt;<i>                               {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                 []}}},
</I>&gt;<i>                              {state,344140,
</I>&gt;<i>
</I>&gt;<i> &quot;c:/rabbitmq.hold/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOOVERLORD-1-mnesia</A>/msg_store_persistent&quot;},
</I>&gt;<i>                              rabbit_msg_store_ets_index,
</I>&gt;<i>
</I>&gt;<i> &quot;c:/rabbitmq.hold/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOOVERLORD-1-mnesia</A>/msg_store_persistent&quot;,
</I>&gt;<i>                              &lt;0.267.0&gt;,348237,340043,352334,356431},
</I>&gt;<i>                             {client_msstate,msg_store_transient,
</I>&gt;<i>
</I>&gt;<i> &lt;&lt;83,30,50,235,43,138,36,105,58,170,111,228,99,194,
</I>&gt;<i>                                5,152&gt;&gt;,
</I>&gt;<i>                              {dict,0,16,16,8,80,48,
</I>&gt;<i>
</I>&gt;<i> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
</I>&gt;<i>                               {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                 []}}},
</I>&gt;<i>                              {state,323655,
</I>&gt;<i>
</I>&gt;<i> &quot;c:/rabbitmq.hold/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOOVERLORD-1-mnesia</A>/msg_store_transient&quot;},
</I>&gt;<i>                              rabbit_msg_store_ets_index,
</I>&gt;<i>
</I>&gt;<i> &quot;c:/rabbitmq.hold/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RIOOVERLORD-1-mnesia</A>/msg_store_transient&quot;,
</I>&gt;<i>                              &lt;0.262.0&gt;,327752,319551,331849,335946}},
</I>&gt;<i>
</I>&gt;<i> true,0,#Fun&lt;rabbit_amqqueue_process.5.77104289&gt;,0,0,
</I>&gt;<i>                            infinity,0,0,0,95,95,
</I>&gt;<i>                            {rates,
</I>&gt;<i>                             {{1353,430160,19630},155},
</I>&gt;<i>                             {{1353,430160,19630},155},
</I>&gt;<i>                             32.34796456653727,32.34796456653727,
</I>&gt;<i>                             {1353,430165,27630}},
</I>&gt;<i>                            {0,nil},
</I>&gt;<i>                            {0,nil},
</I>&gt;<i>                            {0,nil},
</I>&gt;<i>                            {0,nil},
</I>&gt;<i>                            95,95,
</I>&gt;<i>                            {rates,
</I>&gt;<i>                             {{1353,430160,19630},155},
</I>&gt;<i>                             {{1353,430160,19630},155},
</I>&gt;<i>                             32.34796456653727,32.34796456653727,
</I>&gt;<i>                             {1353,430165,27630}}},
</I>&gt;<i>                           {[{&lt;2756.5629.0&gt;,
</I>&gt;<i>                              {consumer,&lt;&lt;&quot;amq.ctag-ZHZP5Ybp_xZxsi5kvmuVfw&quot;&gt;&gt;,
</I>&gt;<i>                               true}}],
</I>&gt;<i>                            []},
</I>&gt;<i>                           100800000,undefined,#Ref&lt;0.0.8.36505&gt;,
</I>&gt;<i>                           #Ref&lt;0.0.8.1338&gt;,
</I>&gt;<i>                           {state,fine,5000,#Ref&lt;0.0.8.36524&gt;},
</I>&gt;<i>                           {0,nil},
</I>&gt;<i>                           undefined,undefined,undefined,
</I>&gt;<i>                           {dict,3,16,16,8,80,48,
</I>&gt;<i>                            {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
</I>&gt;<i>                            {{[[&lt;2756.5690.0&gt;|#Ref&lt;0.0.8.1812&gt;],
</I>&gt;<i>                               [&lt;2754.15277.4&gt;|#Ref&lt;0.0.8.1819&gt;]],
</I>&gt;<i>                              [],[],[],[],[],[],[],
</I>&gt;<i>                              [[&lt;2754.15269.4&gt;|#Ref&lt;0.0.8.1825&gt;]],
</I>&gt;<i>                              [],[],[],[],[],[],[]}}},
</I>&gt;<i>                           1,
</I>&gt;<i>                           {{0,nil},{0,nil}},
</I>&gt;<i>                           undefined,
</I>&gt;<i>                           {dict,0,16,16,8,80,48,
</I>&gt;<i>                            {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
</I>&gt;<i>
</I>&gt;<i> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},
</I>&gt;<i>                           undefined,undefined}
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** {{badmatch,rabbit_mirror_queue_master},
</I>&gt;<i>      [{rabbit_amqqueue_process,handle_call,3,[]},
</I>&gt;<i>       {gen_server2,handle_msg,2,[]},
</I>&gt;<i>       {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,237}]}]}
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> View this message in context: <A HREF="http://rabbitmq.1065348.n5.nabble.com/RabbitMQ-3-0-Policy-ha-all-delete-issue-tp23527p23530.html">http://rabbitmq.1065348.n5.nabble.com/RabbitMQ-3-0-Policy-ha-all-delete-issue-tp23527p23530.html</A>
</I>&gt;<i> Sent from the RabbitMQ mailing list archive at Nabble.com.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024068.html">[rabbitmq-discuss] RabbitMQ 3.0 Policy ha-all delete issue
</A></li>
	<LI>Next message: <A HREF="024007.html">[rabbitmq-discuss] queue/exchange creation/deletion replication	serialization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24006">[ date ]</a>
              <a href="thread.html#24006">[ thread ]</a>
              <a href="subject.html#24006">[ subject ]</a>
              <a href="author.html#24006">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
