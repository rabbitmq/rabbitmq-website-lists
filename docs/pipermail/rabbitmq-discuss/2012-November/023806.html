<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] The rabbitmq-server stop command hangs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20The%20rabbitmq-server%20stop%20command%20hangs&In-Reply-To=%3C640C384F-B664-4C8A-9228-DFDED5E197D8%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023753.html">
   <LINK REL="Next"  HREF="023807.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] The rabbitmq-server stop command hangs</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20The%20rabbitmq-server%20stop%20command%20hangs&In-Reply-To=%3C640C384F-B664-4C8A-9228-DFDED5E197D8%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] The rabbitmq-server stop command hangs">tim at rabbitmq.com
       </A><BR>
    <I>Tue Nov 13 11:34:39 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023753.html">[rabbitmq-discuss] The rabbitmq-server stop command hangs
</A></li>
        <LI>Next message: <A HREF="023807.html">[rabbitmq-discuss] The rabbitmq-server stop command hangs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23806">[ date ]</a>
              <a href="thread.html#23806">[ thread ]</a>
              <a href="subject.html#23806">[ subject ]</a>
              <a href="author.html#23806">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Elizabeth

The timeout indicates that the shutdown sequence is stuck, which is expected, although it is clearly not stuck shutting down the channels which is good to know. The reason you can't connect using suptree_inspect is less clear. Are you using the same account to launch both executables? The cookie (usually stored in $HOME/.erlang.cookie file) needs to be the same. When the test2 node is online, can you execute *this* command successfully

$ erl_call -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">test2 at test2</A> -a 'erlang get_cookie []'

? If so then suptree_inspect *should* work - we can try this out in the console like so, making sure that suptree_inspect.beam is in the current directory. First we'll make sure that connectivity works (you'll see an error if it doesn't)

$ erl -sname debug -s init stop -eval 'true = net_kernel:connect(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iske</A>).' -noshell

then we can run suptree_inspect manually (this *shouldn't* be required)

$ erl
Erlang R15B01 (erts-5.9.1) [source] [64-bit] [smp:4:4] [async-threads:0] [hipe] [kernel-poll:false] [lock-counting]

Eshell V5.9.1  (abort with ^G)
1&gt; code:ensure_loaded(suptree_inspect).
{module,suptree_inspect}
2&gt; suptree_inspect:main([&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">test2 at test2</A>&quot;, &quot;rabbit_sup&quot;]).

Whichever way you do this, the stuck node needs to be running and contactable over rpc (the cookies need to be the same).

Let me know how you get on please.

Cheers,
Tim

On 9 Nov 2012, at 19:07, Elizabeth Liao wrote:

&gt;<i> Tim,
</I>&gt;<i> 
</I>&gt;<i> Here's what I got:
</I>&gt;<i> 
</I>&gt;<i> # rabbitmqctl status
</I>&gt;<i> Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">test2 at test2</A> ...
</I>&gt;<i> 
</I>&gt;<i> # rabbitmqctl eval 'process_info(whereis(rabbit_channel_sup_sup)).'
</I>&gt;<i> Error: {badarg,[{erlang,process_info,[undefined],[]},
</I>&gt;<i>                {erl_eval,do_apply,6,[{file,&quot;erl_eval.erl&quot;},{line,572}]},
</I>&gt;<i>                {rpc,'-handle_call_call/6-fun-0-',5,
</I>&gt;<i>                     [{file,&quot;rpc.erl&quot;},{line,203}]}]}
</I>&gt;<i> 
</I>&gt;<i> # rabbitmqctl eval 'application:which_applications().'
</I>&gt;<i> Error: {timeout,{gen_server,call,[application_controller,which_applications]}}
</I>&gt;<i> 
</I>&gt;<i> #  escript suptree_inspect.beam <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">test2 at test2</A> rabbit_sup | tee output.log
</I>&gt;<i> ERROR: unable to contact <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">test2 at test2</A>
</I>&gt;<i> 
</I>&gt;<i> #  escript suptree_inspect.beam <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at test2</A> rabbit_sup | tee output.log
</I>&gt;<i> ERROR: unable to contact <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at test2</A>
</I>&gt;<i> 
</I>&gt;<i> Liz
</I>&gt;<i> 
</I>&gt;<i> ________________________________________
</I>&gt;<i> From: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>] on behalf of Tim Watson [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>]
</I>&gt;<i> Sent: Thursday, November 08, 2012 8:04 PM
</I>&gt;<i> To: Discussions about RabbitMQ
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] The rabbitmq-server stop command hangs
</I>&gt;<i> 
</I>&gt;<i> Liz,
</I>&gt;<i> 
</I>&gt;<i> Ok - what does `rabbitmqctl eval 'application:which_applications().' look like?
</I>&gt;<i> 
</I>&gt;<i> Also, can you grab <A HREF="https://github.com/downloads/hyperthunk/suptree_inspect/suptree_inspect.beam">https://github.com/downloads/hyperthunk/suptree_inspect/suptree_inspect.beam</A> and run it like so:
</I>&gt;<i> 
</I>&gt;<i>  $ escript suptree_inspect.beam <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at host</A> rabbit_sup | tee output.log
</I>&gt;<i> 
</I>&gt;<i> Obviously replacing <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at host</A> with the correct node name. This should put a bunch of noise into output.log which I'd like to see! Please feel free to scrub any sensitive data before posting, though I very much doubt there will be any.
</I>&gt;<i> 
</I>&gt;<i> That tool btw was hacked together very quickly and compiled against R15B01, so it *may* bomb out on you, in which case we'll fall back to doing some more 'eval' until we can figure out why your rabbit is stuck.
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> Tim
</I>&gt;<i> 
</I>&gt;<i> On 8 Nov 2012, at 18:42, Elizabeth Liao wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Hi Tim,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I finally reproduced an instance where rabbitmq-server appears to hang.  Here's the the output of the command:
</I>&gt;&gt;<i> #  rabbitmqctl eval 'process_info(whereis(rabbit_channel_sup_sup)).'
</I>&gt;&gt;<i> Error: {badarg,[{erlang,process_info,[undefined],[]},
</I>&gt;&gt;<i>               {erl_eval,do_apply,6,[{file,&quot;erl_eval.erl&quot;},{line,572}]},
</I>&gt;&gt;<i>               {rpc,'-handle_call_call/6-fun-0-',5,
</I>&gt;&gt;<i>                    [{file,&quot;rpc.erl&quot;},{line,203}]}]}
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Liz
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ________________________________________
</I>&gt;&gt;<i> From: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>] on behalf of Tim Watson [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>]
</I>&gt;&gt;<i> Sent: Thursday, November 08, 2012 3:34 AM
</I>&gt;&gt;<i> To: Discussions about RabbitMQ
</I>&gt;&gt;<i> Subject: Re: [rabbitmq-discuss] The rabbitmq-server stop command hangs
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Liz,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 7 Nov 2012, at 18:55, Tim Watson wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Hi Liz,
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On 11/07/2012 02:49 PM, Elizabeth Liao wrote:
</I>&gt;&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I still haven't been able to get this working.  Anyone have any suggests to diagnose the problem?
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Sorry we haven't got back to you sooner. I think some investigation on a stuck node will be necessary. If you can give me ssh access to the machine where the shutdown is hanging then I can do this for you, otherwise I'll write up a module you can compile and execute using escript and send it to you. I have actually started on that latter idea anyway, but it's getting a bit late now so I'll probably finish it off in the morning! :)
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Actually come to think of it, we could check a couple of things briefly using rabbitmqctl first. Can you send the output of this please: rabbitmqctl eval 'process_info(whereis(rabbit_channel_sup_sup)).'
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Cheers,
</I>&gt;&gt;&gt;<i> Tim
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Thanks a lot!
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Liz
</I>&gt;&gt;&gt;&gt;<i> ________________________________________
</I>&gt;&gt;&gt;&gt;<i> From: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>] on behalf of Elizabeth Liao [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">eliao at seegrid.com</A>]
</I>&gt;&gt;&gt;&gt;<i> Sent: Monday, November 05, 2012 3:48 PM
</I>&gt;&gt;&gt;&gt;<i> To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;<i> Subject: [rabbitmq-discuss] rabbitmq-server stop hangs
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I am currently running rabbitmq-server-2.8.7 and erlang-R15B on FC11.  I'm having a problem where rabbit sometimes hangs on this command:
</I>&gt;&gt;&gt;&gt;<i> /etc/init.d/rabbitmq-server stop such that rabbitmqctl status hangs as well with this output:
</I>&gt;&gt;&gt;&gt;<i> Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at test1</A> ...
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> The only error report that I see in in the <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at test1.log</A> file is:
</I>&gt;&gt;&gt;&gt;<i> =ERROR REPORT==== 5-Nov-2012::16:23:51 ===
</I>&gt;&gt;&gt;&gt;<i> connection&lt;0.526.0&gt;, channel 5 - error:
</I>&gt;&gt;&gt;&gt;<i> {amqp_error,channel_error,&quot;expected 'channel.open'&quot;,'basic.ack'}
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I don't see anything logged in the <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at test1-sasl.log</A> file.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I realize that this isn't very much information to go on so if anyone could offer more insight into this problem, it would be greatly appreciated!
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Thanks.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Liz
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Email Confidentiality Notice
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> The information contained in this transmission is confidential, proprietary or privileged and may be subject to protection under the law. This message is intended for the sole use of the individual or entity to whom it's addressed. If you are not the intended recipient, you are notified that any use, distribution or copying of the message is strictly prohibited and may subject you to criminal or civil penalties. If you received this transmission in error, please contact the sender immediately by replying to this email and delete the material from any computer.
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;&gt;<i> Email Confidentiality Notice
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> The information contained in this transmission is confidential, proprietary or privileged and may be subject to protection under the law. This message is intended for the sole use of the individual or entity to whom it's addressed. If you are not the intended recipient, you are notified that any use, distribution or copying of the message is strictly prohibited and may subject you to criminal or civil penalties. If you received this transmission in error, please contact the sender immediately by replying to this email and delete the material from any computer.
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> Email Confidentiality Notice
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The information contained in this transmission is confidential, proprietary or privileged and may be subject to protection under the law. This message is intended for the sole use of the individual or entity to whom it's addressed. If you are not the intended recipient, you are notified that any use, distribution or copying of the message is strictly prohibited and may subject you to criminal or civil penalties. If you received this transmission in error, please contact the sender immediately by replying to this email and delete the material from any computer.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> Email Confidentiality Notice
</I>&gt;<i> 
</I>&gt;<i> The information contained in this transmission is confidential, proprietary or privileged and may be subject to protection under the law. This message is intended for the sole use of the individual or entity to whom it's addressed. If you are not the intended recipient, you are notified that any use, distribution or copying of the message is strictly prohibited and may subject you to criminal or civil penalties. If you received this transmission in error, please contact the sender immediately by replying to this email and delete the material from any computer.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023753.html">[rabbitmq-discuss] The rabbitmq-server stop command hangs
</A></li>
	<LI>Next message: <A HREF="023807.html">[rabbitmq-discuss] The rabbitmq-server stop command hangs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23806">[ date ]</a>
              <a href="thread.html#23806">[ thread ]</a>
              <a href="subject.html#23806">[ subject ]</a>
              <a href="author.html#23806">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
