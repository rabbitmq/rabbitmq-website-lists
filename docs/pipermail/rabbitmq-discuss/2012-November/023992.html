<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 3.0.0 &amp; Expiration &amp; STOMP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%203.0.0%20%26%20Expiration%20%26%20STOMP&In-Reply-To=%3CE1B38688-B506-483C-878F-281F2EAD1114%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023985.html">
   <LINK REL="Next"  HREF="023987.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 3.0.0 &amp; Expiration &amp; STOMP</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%203.0.0%20%26%20Expiration%20%26%20STOMP&In-Reply-To=%3CE1B38688-B506-483C-878F-281F2EAD1114%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ 3.0.0 &amp; Expiration &amp; STOMP">tim at rabbitmq.com
       </A><BR>
    <I>Tue Nov 20 14:11:42 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023985.html">[rabbitmq-discuss] RabbitMQ 3.0.0 &amp; Expiration &amp; STOMP
</A></li>
        <LI>Next message: <A HREF="023987.html">[rabbitmq-discuss] is RabbitMQ a good choice for a	small-scale multiplayer game server?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23992">[ date ]</a>
              <a href="thread.html#23992">[ thread ]</a>
              <a href="subject.html#23992">[ subject ]</a>
              <a href="author.html#23992">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Lionel,

This is, in fact, a bug in the per-message TTL implementation (and has nothing to do with STOMP specifically). We've logged an issue and are actively fixing it at the moment. Currently we only expire messages when consuming *starts*, but since we generally dequeue messages faster than enqueue them, the problem you've stumbled upon was hardly noticeable in the past. A fix for this will be made available in the next bugfix release.

Thanks for reporting this!

Cheers,
Tim

On 20 Nov 2012, at 09:19, Lionel Cons wrote:

&gt;<i> Reading <A HREF="http://www.rabbitmq.com/ttl.html">http://www.rabbitmq.com/ttl.html</A> and <A HREF="http://www.rabbitmq.com/stomp.html,">http://www.rabbitmq.com/stomp.html,</A>
</I>&gt;<i> it seems that per-message TTL is now supported, even with STOMP.
</I>&gt;<i> 
</I>&gt;<i> I've tried to use expiration but it does not work as expected. Here is my
</I>&gt;<i> test case (see attached):
</I>&gt;<i> - send two messages in a queue, one with 3s TTL, the other one with 30s
</I>&gt;<i> - wait 5s
</I>&gt;<i> - connect and drain the queue
</I>&gt;<i> 
</I>&gt;<i> In my test I receive both messages, even the one which should have expired.
</I>&gt;<i> 
</I>&gt;<i> Any hint on why it does not work as expected?
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> 
</I>&gt;<i> Lionel
</I>&gt;<i> 
</I>&gt;<i> #!/usr/bin/perl
</I>&gt;<i> 
</I>&gt;<i> use strict;
</I>&gt;<i> use warnings;
</I>&gt;<i> use Net::STOMP::Client qw();
</I>&gt;<i> 
</I>&gt;<i> use constant HOST        =&gt; &quot;localhost&quot;;
</I>&gt;<i> use constant PORT        =&gt; 6163;
</I>&gt;<i> use constant DESTINATION =&gt; &quot;/queue/test&quot;;
</I>&gt;<i> use constant USER        =&gt; &quot;guest&quot;;
</I>&gt;<i> use constant PASSWORD    =&gt; &quot;guest&quot;;
</I>&gt;<i> 
</I>&gt;<i> # uncomment the next line to see more...
</I>&gt;<i> #$Net::STOMP::Client::Debug::Flags = -1;
</I>&gt;<i> 
</I>&gt;<i> sub stomp () {
</I>&gt;<i>    my($stomp);
</I>&gt;<i> 
</I>&gt;<i>    $stomp = Net::STOMP::Client-&gt;new(host =&gt; HOST, port =&gt; PORT);
</I>&gt;<i>    $stomp-&gt;connect(login =&gt; USER, passcode =&gt; PASSWORD, host =&gt; &quot;/&quot;);
</I>&gt;<i>    return($stomp);
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> sub test () {
</I>&gt;<i>    my($prod, $cons, $frame, $count);
</I>&gt;<i> 
</I>&gt;<i>    # connect
</I>&gt;<i>    $prod = stomp();
</I>&gt;<i> 
</I>&gt;<i>    # send test messages
</I>&gt;<i>    $prod-&gt;send(
</I>&gt;<i> 	destination =&gt; DESTINATION,
</I>&gt;<i> 	body =&gt; &quot;Hello ancient world (30s)&quot;,
</I>&gt;<i> 	expiration =&gt; 30000,
</I>&gt;<i>    );
</I>&gt;<i>    $prod-&gt;send(
</I>&gt;<i> 	destination =&gt; DESTINATION,
</I>&gt;<i> 	body =&gt; &quot;Hello ancient world (3s)&quot;,
</I>&gt;<i> 	expiration =&gt; 3000,
</I>&gt;<i>    );
</I>&gt;<i> 
</I>&gt;<i>    # disconnect
</I>&gt;<i>    $prod-&gt;disconnect(receipt =&gt; $prod-&gt;uuid());
</I>&gt;<i> 
</I>&gt;<i>    # sleep a bit
</I>&gt;<i>    sleep(5);
</I>&gt;<i> 
</I>&gt;<i>    # connect
</I>&gt;<i>    $cons = stomp();
</I>&gt;<i> 
</I>&gt;<i>    # subscribe
</I>&gt;<i>    $cons-&gt;message_callback(sub { return(1) });
</I>&gt;<i>    $cons-&gt;subscribe(
</I>&gt;<i> 	destination =&gt; DESTINATION,
</I>&gt;<i> 	id          =&gt; $cons-&gt;uuid(),
</I>&gt;<i> 	receipt     =&gt; $cons-&gt;uuid(),
</I>&gt;<i>    );
</I>&gt;<i>    $cons-&gt;wait_for_receipts(timeout =&gt; 3);
</I>&gt;<i>    die(&quot;no receipts received!&quot;) if $cons-&gt;receipts();
</I>&gt;<i> 
</I>&gt;<i>    # wait for messages
</I>&gt;<i>    $count = 0;
</I>&gt;<i>    while (1) {
</I>&gt;<i>        $frame = $cons-&gt;wait_for_frames(timeout =&gt; 3);
</I>&gt;<i>        last unless $frame;
</I>&gt;<i>        $count++;
</I>&gt;<i>    }
</I>&gt;<i>    printf(&quot;received %d: %s\n&quot;, $count, $count == 1 ? &quot;OK&quot; : &quot;BAD&quot;);
</I>&gt;<i> 
</I>&gt;<i>    # disconnect
</I>&gt;<i>    $cons-&gt;disconnect();
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> test();
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023985.html">[rabbitmq-discuss] RabbitMQ 3.0.0 &amp; Expiration &amp; STOMP
</A></li>
	<LI>Next message: <A HREF="023987.html">[rabbitmq-discuss] is RabbitMQ a good choice for a	small-scale multiplayer game server?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23992">[ date ]</a>
              <a href="thread.html#23992">[ thread ]</a>
              <a href="subject.html#23992">[ subject ]</a>
              <a href="author.html#23992">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
