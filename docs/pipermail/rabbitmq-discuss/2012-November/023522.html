<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pub/Sub -- block publisher until all acks received from subscribers?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pub/Sub%20--%20block%20publisher%20until%20all%20acks%0A%20received%20from%20subscribers%3F&In-Reply-To=%3C50925221.9080500%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023521.html">
   <LINK REL="Next"  HREF="023528.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pub/Sub -- block publisher until all acks received from subscribers?</H1>
    <B>Emile Joubert</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pub/Sub%20--%20block%20publisher%20until%20all%20acks%0A%20received%20from%20subscribers%3F&In-Reply-To=%3C50925221.9080500%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Pub/Sub -- block publisher until all acks received from subscribers?">emile at rabbitmq.com
       </A><BR>
    <I>Thu Nov  1 10:42:41 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023521.html">[rabbitmq-discuss] cluster reboot of death
</A></li>
        <LI>Next message: <A HREF="023528.html">[rabbitmq-discuss] Pub/Sub -- block publisher until all acks received from subscribers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23522">[ date ]</a>
              <a href="thread.html#23522">[ thread ]</a>
              <a href="subject.html#23522">[ subject ]</a>
              <a href="author.html#23522">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Nick,

This page has more detail and you may find some of your answers:
<A HREF="http://www.rabbitmq.com/confirms.html">http://www.rabbitmq.com/confirms.html</A>

On 31/10/12 22:10, Nick Martin wrote:
&gt;<i> Wait until all messages published since the last call have been
</I>&gt;<i> either ack'd or nack'd by the broker.
</I>
A message being ack'd by the broker is different from being ack'd by a 
consumer. If the broker acknowledges a messages it means that the broker 
has taken responsibility for it by writing it to disk or successfully 
handed it off. Handing off could mean returning the messages to the 
publisher (unroutable mandatory msg) or successfully delivering to 
consumer. The publisher cannot choose how the broker discharges this 
responsibility. In your case you would like a broker acknowledgement 
only when the message is successfully delivered to a consumer, but the 
broker may decide to write the message to disk and acknowledge when the 
OS guarantees that the disk write succeeded.

&gt;<i> It seems to me that the publisher is
</I>&gt;<i> supposed to block until all of the messages are ack'd via its call to
</I>&gt;<i> waitForConfirmsOrDie(). Is this what this is really supposed to do?
</I>
Yes, waitForConfirmsOrDie() will block until an ack is received from the 
broker.

&gt;<i> This example code seemed like it matched up perfectly with what I was
</I>&gt;<i> trying to do. But, it doesn't seem to work the way I thought it did. In
</I>&gt;<i> fact, if, in the consumer thread, I turn off auto-acking messages, then
</I>&gt;<i> waitForConfirmsOrDie() still returns immediately.
</I>
This is because the broker has taken responsibility for the message by 
writing it to disk.

&gt;<i> So what does waitForConfirmsOrDie() actually do? When would it block?
</I>
It could block e.g. as a result of attempting to perform an fsync operation.

&gt;<i> If waitForConfirmsOrDie doesn't do what I want, is there a way to make a
</I>&gt;<i> publisher wait until all subscribers ack a message before proceeding?
</I>
An alternative approach would be to declare a return queue for the 
consumers to report their progress to the publisher. The publisher can 
subscribe to this queue and use this to wait until the subscribers are 
ready before proceeding. The publisher would need to know how many 
subscribers to expect replies from.

If your design allows it you should avoid coupling producers and 
consumers as tightly as you seem to need here. What is the reason for 
forcing producers and consumers in lockstep? Can the same aim be 
achieved in another way by taking a larger view of the system?




-Emile










</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023521.html">[rabbitmq-discuss] cluster reboot of death
</A></li>
	<LI>Next message: <A HREF="023528.html">[rabbitmq-discuss] Pub/Sub -- block publisher until all acks received from subscribers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23522">[ date ]</a>
              <a href="thread.html#23522">[ thread ]</a>
              <a href="subject.html#23522">[ subject ]</a>
              <a href="author.html#23522">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
