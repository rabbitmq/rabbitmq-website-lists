<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cluster issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20issues&In-Reply-To=%3CBB36AA5C-2573-4504-93F9-2E738034B056%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024077.html">
   <LINK REL="Next"  HREF="024120.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cluster issues</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20issues&In-Reply-To=%3CBB36AA5C-2573-4504-93F9-2E738034B056%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Cluster issues">tim at rabbitmq.com
       </A><BR>
    <I>Fri Nov 23 17:09:21 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024077.html">[rabbitmq-discuss] Cluster issues
</A></li>
        <LI>Next message: <A HREF="024120.html">[rabbitmq-discuss] Cluster issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24116">[ date ]</a>
              <a href="thread.html#24116">[ thread ]</a>
              <a href="subject.html#24116">[ subject ]</a>
              <a href="author.html#24116">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Carl,

On 22 Nov 2012, at 05:01, Carl H&#246;rberg wrote:

&gt;<i> I have a 3 machine cluster, 1 disc node and 2 ram nodes.
</I>&gt;<i> 
</I>&gt;<i> I stopped (soft, no crash or kill) the disc node.
</I>&gt;<i> 
</I>
It's best *not* to leave a cluster with no disk nodes, as that represents an inherent risk if the ram nodes die whilst the disk node is out of action (for maintenance or whatever). Better to have 2 disk and 1 ram nodes if possible.

&gt;<i> One of the RAM nodes reports:
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 19-Nov-2012::08:29:32 ===
</I>&gt;<i> ** Generic server &lt;0.865.329&gt; terminating 
</I>&gt;<i> ** Last message in was {'$gen_cast',
</I>&gt;<i> {event,
</I>&gt;<i> {event,channel_stats,
</I>&gt;<i> [{pid,&lt;24148.17585.32&gt;},
</I>&gt;<i> {transactional,false},
</I>&gt;<i> {confirm,false},
</I>&gt;<i> {consumer_count,1},
</I>&gt;<i> {messages_unacknowledged,0},
</I>&gt;<i> {messages_unconfirmed,0},
</I>&gt;<i> {messages_uncommitted,0},
</I>&gt;<i> {acks_uncommitted,0},
</I>&gt;<i> {prefetch_count,16},
</I>&gt;<i> {client_flow_blocked,false},
</I>&gt;<i> {channel_queue_stats,[{&lt;6988.1853.0&gt;,[{ack,7}]}]},
</I>&gt;<i> {channel_exchange_stats,
</I>&gt;<i> [{{resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,exchange,
</I>&gt;<i> &lt;&lt;&quot;queue1&quot;&gt;&gt;},
</I>&gt;<i> [{publish,34649}]}]},
</I>&gt;<i> {channel_queue_exchange_stats,[]}],
</I>&gt;<i> {1353,313843,894086}}}}
</I>&gt;<i> ** When Server state == {state,[{channel_exchange_stats,2244223060},
</I>&gt;<i> {channel_queue_exchange_stats,2244227157},
</I>&gt;<i> {channel_queue_stats,2244218963},
</I>&gt;<i> {channel_stats,2244210768},
</I>&gt;<i> {connection_stats,2244206619},
</I>&gt;<i> {consumers,2244214866},
</I>&gt;<i> {queue_stats,2244202517}],
</I>&gt;<i> 5000}
</I>&gt;<i> ** Reason for termination == 
</I>&gt;<i> ** {badarith,[{rabbit_mgmt_db,rate,5},
</I>&gt;<i> {rabbit_mgmt_db,'-rates/5-lc$^0/1-0-',5},
</I>&gt;<i> {rabbit_mgmt_db,'-rates/5-lc$^1/1-1-',6},
</I>&gt;<i> {rabbit_mgmt_db,rates,5},
</I>&gt;<i> {rabbit_mgmt_db,handle_fine_stat,7},
</I>&gt;<i> {rabbit_mgmt_db,'-handle_fine_stats/4-lc$^1/1-1-',4},
</I>&gt;<i> {rabbit_mgmt_db,'-handle_event/2-lc$^1/1-0-',4},
</I>&gt;<i> {rabbit_mgmt_db,handle_event,2}]}
</I>&gt;<i> 
</I>
This is a known bug I'm afraid. See <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-November/023538.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-November/023538.html</A> for another instance. We're working to resolve it at the moment and hope to get a fix out asap.

&gt;<i> The disc node was started (with a new IP), and it logs this:
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 19-Nov-2012::22:55:27 ===
</I>&gt;<i> msg_store_persistent: recovery terms differ from present
</I>&gt;<i> rebuilding indices from scratch
</I>&gt;<i> 
</I>&gt;<i> 
</I>
I would not expect a node stopped with `rabbitmqctl stop` to exhibit this behaviour, however the fact that you've recycled the IP address could be a factor - though it shouldn't. We'll spend some time looking into that.

&gt;<i> 
</I>&gt;<i> And it takes about 10-15min before it starts.
</I>&gt;<i> 
</I>
It is not unusual for a message store containing a large volume of messages to take 'quite some time' to completely recover.

&gt;<i> But the other nodes never recognized the node, may it be due to that the DNS wasn't updated? It took about 1min before the DNS resolved correctly, that is the disc node's hostname resolved to the new ip, but I waited longer than that. 
</I>&gt;<i> 
</I>&gt;<i> Meanwhile the disc node reported a lot of these messages:
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 19-Nov-2012::23:06:55 ===
</I>&gt;<i> Discarding message {'$gen_call',{&lt;0.2291.0&gt;,#Ref&lt;0.0.5.101573&gt;},{notify_down,&lt;5145.1671.3&gt;}} from &lt;0.2291.0&gt; to &lt;0.1733.0&gt; in an old incarnation (3) of this node (2)
</I>&gt;<i> 
</I>&gt;<i> 
</I>
This could be indicative of a bug, as it indicates a channel close notification being sent to a queue record that should've been deleted (or replaced). We will investigate that.

&gt;<i> 
</I>&gt;<i> So I restarted the RAM nodes too, now all cluster nodes could communicate again, but the mgmt interface reported:
</I>&gt;<i> 
</I>&gt;<i> &quot;Statistics database could not be contacted. Message rates and queue lengths will not be shown.&quot;
</I>&gt;<i> 
</I>&gt;<i> So stopped all nodes (first ram nodes and the disc node last), and then brought the back up again (disc node first) and now the cluster functioned as normal. 
</I>&gt;<i> 
</I>
Well I'm glad you got it under control eventually.

&gt;<i> Any idea what was going on? 
</I>&gt;<i> 
</I>&gt;<i> RabbitMQ 2.8.7
</I>&gt;<i> Erlang R14B4
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Could you clarify one or two other details about your environment please? Firstly, do you have HA (mirrorred) queues set up in this cluster? Secondly, was the disk node designated the 'master' when you shut it down? And just to confirm that you shut the disk node down by issuing `rabbitmqctl stop` or an equivalent (such as `service rabbitmqctl stop` or similar) right? If you could provide any of the node's rabbit and rabbit-sasl logs, that would be very useful.

Thanks for reporting this - I will try to keep the list informed of any developments in tracking it down!

Cheers,
Tim

</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024077.html">[rabbitmq-discuss] Cluster issues
</A></li>
	<LI>Next message: <A HREF="024120.html">[rabbitmq-discuss] Cluster issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24116">[ date ]</a>
              <a href="thread.html#24116">[ thread ]</a>
              <a href="subject.html#24116">[ subject ]</a>
              <a href="author.html#24116">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
