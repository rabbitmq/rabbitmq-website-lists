<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Per Connection Flow Control Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Per%20Connection%20Flow%20Control%20Issue&In-Reply-To=%3CCAHZsVQY9b5rh3MFqmv%3DVm-8KcdjH0VbZbBhicqFm9T8Up9cgqA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023977.html">
   <LINK REL="Next"  HREF="023988.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Per Connection Flow Control Issue</H1>
    <B>Brendan Hay</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Per%20Connection%20Flow%20Control%20Issue&In-Reply-To=%3CCAHZsVQY9b5rh3MFqmv%3DVm-8KcdjH0VbZbBhicqFm9T8Up9cgqA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Per Connection Flow Control Issue">brendan at soundcloud.com
       </A><BR>
    <I>Tue Nov 20 06:44:23 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="023977.html">[rabbitmq-discuss] Poor performance when sending specific	characters
</A></li>
        <LI>Next message: <A HREF="023988.html">[rabbitmq-discuss] Per Connection Flow Control Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23983">[ date ]</a>
              <a href="thread.html#23983">[ thread ]</a>
              <a href="subject.html#23983">[ subject ]</a>
              <a href="author.html#23983">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just to follow up with this, the issue was due to
GRO&lt;<A HREF="http://lwn.net/Articles/358910/">http://lwn.net/Articles/358910/</A>&gt; being
turned on the NIC for our load balancers, which are running an older
version of LVS (prior to
2.6.39&lt;<A HREF="http://archive.linuxvirtualserver.org/html/lvs-users/2011-11/msg00024.html">http://archive.linuxvirtualserver.org/html/lvs-users/2011-11/msg00024.html</A>&gt;
).

In essence, this caused the high throughput publishers to have their data
streams fragmented and they fell further behind with the observed send
queue overflow on the clients. We'd previously seen something similar with
large HTTP streaming uploads.

GRO can be turned off using: ethtool -K &lt;NIC&gt; gro off

Cheers,
Brendan

(It's not the flow control, I know, I know ..)




On Fri, Oct 26, 2012 at 2:41 PM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i> On 26/10/12 11:23, Brendan Hay wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Yes, so what should the expected observation be - the client code
</I>&gt;&gt;<i> carries on publishing into a black hole,
</I>&gt;&gt;<i> which means the send queue on the client/peer socket should keep
</I>&gt;&gt;<i> growing,
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Well, the send queue is limited in size. So the publisher should block
</I>&gt;<i> fairly quickly.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  and when the rabbit reader is
</I>&gt;&gt;<i> issued new credits, it will lap it all up?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  It just seems the 'flow' status in the UI stays on permanently, it
</I>&gt;&gt;<i> doesn't seem to be toggling at high speed, just locked.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Well, the flow status *in the UI* is designed not to toggle at high speed,
</I>&gt;<i> since that would not be very readable - it shows &quot;flow&quot; if the connection
</I>&gt;<i> has been blocked in the last 5 seconds. This is driven by
</I>&gt;<i> &quot;last_blocked_age&quot; and &quot;last_blocked_by&quot;.
</I>&gt;<i>
</I>&gt;<i> The rabbitmqctl command results you posted show some connections which had
</I>&gt;<i> blocked some time in the past, all more than 5 seconds ago. Unfortunately I
</I>&gt;<i> forgot to ask you to add &quot;state&quot; to the list of columns, to determine if
</I>&gt;<i> they were blocked now. If we see any connections that were blocked by flow
</I>&gt;<i> control a long time ago, and are still blocked, then I'm concerned.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, VMware
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121120/3f728d7f/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121120/3f728d7f/attachment.htm</A>&gt;
</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023977.html">[rabbitmq-discuss] Poor performance when sending specific	characters
</A></li>
	<LI>Next message: <A HREF="023988.html">[rabbitmq-discuss] Per Connection Flow Control Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23983">[ date ]</a>
              <a href="thread.html#23983">[ thread ]</a>
              <a href="subject.html#23983">[ subject ]</a>
              <a href="author.html#23983">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
