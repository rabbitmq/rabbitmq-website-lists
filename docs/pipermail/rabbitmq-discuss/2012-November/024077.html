<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cluster issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20issues&In-Reply-To=%3C416D3B2E4A1946E4BC8F75B32CE4E415%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024079.html">
   <LINK REL="Next"  HREF="024116.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cluster issues</H1>
    <B>Carl H&#246;rberg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20issues&In-Reply-To=%3C416D3B2E4A1946E4BC8F75B32CE4E415%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Cluster issues">carl.hoerberg at gmail.com
       </A><BR>
    <I>Thu Nov 22 05:01:42 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024079.html">[rabbitmq-discuss] Stomp client examples
</A></li>
        <LI>Next message: <A HREF="024116.html">[rabbitmq-discuss] Cluster issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24077">[ date ]</a>
              <a href="thread.html#24077">[ thread ]</a>
              <a href="subject.html#24077">[ subject ]</a>
              <a href="author.html#24077">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a 3 machine cluster, 1 disc node and 2 ram nodes.

I stopped (soft, no crash or kill) the disc node.

One of the RAM nodes reports:

=ERROR REPORT==== 19-Nov-2012::08:29:32 ===
** Generic server &lt;0.865.329&gt; terminating 
** Last message in was {'$gen_cast',
{event,
{event,channel_stats,
[{pid,&lt;24148.17585.32&gt;},
{transactional,false},
{confirm,false},
{consumer_count,1},
{messages_unacknowledged,0},
{messages_unconfirmed,0},
{messages_uncommitted,0},
{acks_uncommitted,0},
{prefetch_count,16},
{client_flow_blocked,false},
{channel_queue_stats,[{&lt;6988.1853.0&gt;,[{ack,7}]}]},
{channel_exchange_stats,
[{{resource,&lt;&lt;&quot;vhost1&quot;&gt;&gt;,exchange,
&lt;&lt;&quot;queue1&quot;&gt;&gt;},
[{publish,34649}]}]},
{channel_queue_exchange_stats,[]}],
{1353,313843,894086}}}}
** When Server state == {state,[{channel_exchange_stats,2244223060},
{channel_queue_exchange_stats,2244227157},
{channel_queue_stats,2244218963},
{channel_stats,2244210768},
{connection_stats,2244206619},
{consumers,2244214866},
{queue_stats,2244202517}],
5000}
** Reason for termination == 
** {badarith,[{rabbit_mgmt_db,rate,5},
{rabbit_mgmt_db,'-rates/5-lc$^0/1-0-',5},
{rabbit_mgmt_db,'-rates/5-lc$^1/1-1-',6},
{rabbit_mgmt_db,rates,5},
{rabbit_mgmt_db,handle_fine_stat,7},
{rabbit_mgmt_db,'-handle_fine_stats/4-lc$^1/1-1-',4},
{rabbit_mgmt_db,'-handle_event/2-lc$^1/1-0-',4},
{rabbit_mgmt_db,handle_event,2}]}

The disc node was started (with a new IP), and it logs this:

=WARNING REPORT==== 19-Nov-2012::22:55:27 ===
msg_store_persistent: recovery terms differ from present
rebuilding indices from scratch



And it takes about 10-15min before it starts.

But the other nodes never recognized the node, may it be due to that the DNS wasn't updated? It took about 1min before the DNS resolved correctly, that is the disc node's hostname resolved to the new ip, but I waited longer than that. 

Meanwhile the disc node reported a lot of these messages:

=ERROR REPORT==== 19-Nov-2012::23:06:55 ===
Discarding message {'$gen_call',{&lt;0.2291.0&gt;,#Ref&lt;0.0.5.101573&gt;},{notify_down,&lt;5145.1671.3&gt;}} from &lt;0.2291.0&gt; to &lt;0.1733.0&gt; in an old incarnation (3) of this node (2)



So I restarted the RAM nodes too, now all cluster nodes could communicate again, but the mgmt interface reported:

&quot;Statistics database could not be contacted. Message rates and queue lengths will not be shown.&quot;

So stopped all nodes (first ram nodes and the disc node last), and then brought the back up again (disc node first) and now the cluster functioned as normal. 

Any idea what was going on? 

RabbitMQ 2.8.7
Erlang R14B4



</PRE>









































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024079.html">[rabbitmq-discuss] Stomp client examples
</A></li>
	<LI>Next message: <A HREF="024116.html">[rabbitmq-discuss] Cluster issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24077">[ date ]</a>
              <a href="thread.html#24077">[ thread ]</a>
              <a href="subject.html#24077">[ subject ]</a>
              <a href="author.html#24077">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
