<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Disk/Memory%20Usage%20with%20RabbitMQ&In-Reply-To=476C21DC.7050502%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000390.html">
   <LINK REL="Next"  HREF="000406.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ</H1>
    <B>Barry Pederson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Disk/Memory%20Usage%20with%20RabbitMQ&In-Reply-To=476C21DC.7050502%40lshift.net"
       TITLE="[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ">bp at barryp.org
       </A><BR>
    <I>Thu Dec 27 21:29:24 GMT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000390.html">[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
</A></li>
        <LI>Next message: <A HREF="000406.html">[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#405">[ date ]</a>
              <a href="thread.html#405">[ thread ]</a>
              <a href="subject.html#405">[ subject ]</a>
              <a href="author.html#405">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthias Radestock wrote:

&gt;<i> How are you consuming messages from the queues? Delivered messages 
</I>&gt;<i> (persistent or not) need to be acknowledged explicitly with basic.ack 
</I>&gt;<i> unless the noAck flag for basic.get/basic.consume was set to true.
</I>
Yes, I've been trying both basic.ack and the noAck flag - so that part 
sounds OK.




&gt;<i> Also, what happens when you do one of the following:
</I>&gt;<i> - close and re-open the channel on which messages have been consumed
</I>&gt;<i> - close and re-open the connection on which messages have been consumed
</I>&gt;<i> - restart the server
</I>&gt;<i> and then start consuming messages from the same queues? Do you get 
</I>&gt;<i> messages back that you have received before? If so that would be an 
</I>&gt;<i> indication that you are not sending acknowledgments.
</I>
Haven't seen any repeated messages, so I guess that messages that were 
consumed were acked.  For the most part though, I don't have any queues 
at all bound to the exchange to which the persistent messages are being 
published.

After restarting the server just now, memory usage was back down, and 
the rabbit_persister.LOG file was fairly small (62k), where the 
rabbit_persister.LOG.previous is about 2.1mb

I'm fairly certain though that on another occasion a week or so ago, a 
restarted server came back up with large memory usage and a big 
rabbit_persister.LOG - I ended up wiping out the mnesia directory to get 
things back to square one.




&gt;&gt;<i> Are there any other Erlang commands for examining the system to see
</I>&gt;&gt;<i> where any logjams may be?
</I>&gt;<i> 
</I>&gt;<i> Try
</I>&gt;<i> 
</I>&gt;<i> [process_info(P) || P &lt;- processes(),
</I>&gt;<i>                     process_info(P, memory) &gt; {memory, 100000}].
</I>&gt;<i> 
</I>&gt;<i> which will list the details of all processes with a memory consumption 
</I>&gt;<i> greater than 100000 bytes.
</I>

On first startup, the above bit just returns []

trying again after things grow for a while results in

------------------
[[{registered_name,rabbit_gc_persist},
   {current_function,{gen_server,loop,6}},
   {initial_call,{proc_lib,init_p,5}},
   {status,waiting},
   {message_queue_len,0},
   {messages,[]},
   {links,[&lt;0.168.0&gt;]},
   {dictionary,[{'$ancestors',[&lt;0.168.0&gt;,rabbit_sup,&lt;0.103.0&gt;]},
                {'$initial_call',{gen,init_it,
                                      [gen_server,
                                       &lt;0.168.0&gt;,
                                       &lt;0.168.0&gt;,
                                       {local,rabbit_gc_persist},
                                       rabbit_gc_persist,
                                       [],
                                       []]}}]},
   {trap_exit,false},
   {error_handler,error_handler},
   {priority,normal},
   {group_leader,&lt;0.102.0&gt;},
   {heap_size,121393},
   {stack_size,12},
   {reductions,74294},
   {garbage_collection,[{fullsweep_after,65535}]}]]
-------------------

And somewhat later on

--------------------
[[{registered_name,rabbit_gc_persist},
   {current_function,{gen_server,loop,6}},
   {initial_call,{proc_lib,init_p,5}},
   {status,waiting},
   {message_queue_len,0},
   {messages,[]},
   {links,[&lt;0.168.0&gt;]},
   {dictionary,[{'$ancestors',[&lt;0.168.0&gt;,rabbit_sup,&lt;0.103.0&gt;]},
                {'$initial_call',{gen,init_it,
                                      [gen_server,
                                       &lt;0.168.0&gt;,
                                       &lt;0.168.0&gt;,
                                       {local,rabbit_gc_persist},
                                       rabbit_gc_persist,
                                       [],
                                       []]}}]},
   {trap_exit,false},
   {error_handler,error_handler},
   {priority,normal},
   {group_leader,&lt;0.102.0&gt;},
   {heap_size,514229},
   {stack_size,12},
   {reductions,118305},
   {garbage_collection,[{fullsweep_after,65535}]}]]
----------------------

Looks like &quot;heap_size&quot; and &quot;reductions&quot; are growing.




&gt;&gt;<i> Would publishing persistent messages to a durable exchange with no 
</I>&gt;&gt;<i> queues bound to it at all (yet) cause the messages to stick around?
</I>&gt;<i> 
</I>&gt;<i> You might be on to something there. My own testing shows a surprising 
</I>&gt;<i> growth in memory and the persister log in this scenario. I will do some 
</I>&gt;<i> more digging.
</I>
Ah good, I'm glad it's not just me.  Not knowing much Erlang I'm at a 
bit of a loss when it comes to troubleshooting this.

	Barry



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000390.html">[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
</A></li>
	<LI>Next message: <A HREF="000406.html">[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#405">[ date ]</a>
              <a href="thread.html#405">[ thread ]</a>
              <a href="subject.html#405">[ subject ]</a>
              <a href="author.html#405">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
