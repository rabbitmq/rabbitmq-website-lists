<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Disk/Memory%20Usage%20with%20RabbitMQ&In-Reply-To=476A8EF7.2040503%40barryp.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000389.html">
   <LINK REL="Next"  HREF="000405.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Disk/Memory%20Usage%20with%20RabbitMQ&In-Reply-To=476A8EF7.2040503%40barryp.org"
       TITLE="[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ">matthias at lshift.net
       </A><BR>
    <I>Fri Dec 21 20:28:12 GMT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000389.html">[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
</A></li>
        <LI>Next message: <A HREF="000405.html">[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#390">[ date ]</a>
              <a href="thread.html#390">[ thread ]</a>
              <a href="subject.html#390">[ subject ]</a>
              <a href="author.html#390">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Barry,

Barry Pederson wrote:
&gt;<i> I've been experimenting with RabbitMQ 1.2.0 on a FreeBSD 6.2 box, 
</I>&gt;<i> installed using the Generic Unix instructions from 
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/install.html">http://www.rabbitmq.com/install.html</A> - (not doing any clustering), and 
</I>&gt;<i> am seeing my memory and disk usage growing pretty steadily as I'm 
</I>&gt;<i> starting to make use of persistent messages and durable queues.  I 
</I>&gt;<i> should also mention I'm using my alternate Python client library.
</I>&gt;<i> 
</I>&gt;<i> In my mnesia/rabbit directory, rabbit_persister.LOG has grown to 23Mb, 
</I>&gt;<i> and &quot;top&quot; shows the SIZE of the process to be 113M, up from about 18M 
</I>&gt;<i> when the daemon first starts.
</I>
How are you consuming messages from the queues? Delivered messages 
(persistent or not) need to be acknowledged explicitly with basic.ack 
unless the noAck flag for basic.get/basic.consume was set to true.

Also, what happens when you do one of the following:
- close and re-open the channel on which messages have been consumed
- close and re-open the connection on which messages have been consumed
- restart the server
and then start consuming messages from the same queues? Do you get 
messages back that you have received before? If so that would be an 
indication that you are not sending acknowledgments.

&gt;<i> I found some earlier messages in Google about rabbit memory usage, for 
</I>&gt;<i> example:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://www.nabble.com/beam-instances-and-growing-memory-usage-td13805341.html">http://www.nabble.com/beam-instances-and-growing-memory-usage-td13805341.html</A>
</I>&gt;<i> 
</I>&gt;<i> and used
</I>&gt;<i> 
</I>&gt;<i> 	rabbit_amqqueue:stat_all().
</I>&gt;<i> 
</I>&gt;<i> To look at the queues, and just see
</I>&gt;<i> 
</I>&gt;<i> 	[{ok,{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;syslog_interpret&quot;&gt;&gt;},0,1}]
</I>&gt;<i> 
</I>&gt;<i> Which I take to mean just one queue named 'syslog_interpret' with zero 
</I>&gt;<i> messages and 1 consumer?
</I>
Correct, though the message count does not include unacknowledged 
delivered messages.

&gt;<i> Does having a large and growing rabbit_persister.LOG file indicate 
</I>&gt;<i> messages are piling up somewhere?
</I>
Yes.

&gt;<i> Are there any other Erlang commands for examining the system to see
</I>&gt;<i> where any logjams may be?
</I>
Try

[process_info(P) || P &lt;- processes(),
                     process_info(P, memory) &gt; {memory, 100000}].

which will list the details of all processes with a memory consumption 
greater than 100000 bytes.

&gt;<i> Would publishing persistent messages to a durable exchange with no 
</I>&gt;<i> queues bound to it at all (yet) cause the messages to stick around?
</I>
You might be on to something there. My own testing shows a surprising 
growth in memory and the persister log in this scenario. I will do some 
more digging.


Matthias.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000389.html">[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
</A></li>
	<LI>Next message: <A HREF="000405.html">[rabbitmq-discuss] Disk/Memory Usage with RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#390">[ date ]</a>
              <a href="thread.html#390">[ thread ]</a>
              <a href="subject.html#390">[ subject ]</a>
              <a href="author.html#390">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
