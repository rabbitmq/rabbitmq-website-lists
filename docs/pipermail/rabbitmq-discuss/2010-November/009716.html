<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Lose messages between restarts of broker
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lose%20messages%20between%20restarts%20of%20broker&In-Reply-To=%3C4CCEC5CD.4020701%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010082.html">
   <LINK REL="Next"  HREF="009723.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Lose messages between restarts of broker</H1>
    <B>Emile Joubert</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lose%20messages%20between%20restarts%20of%20broker&In-Reply-To=%3C4CCEC5CD.4020701%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Lose messages between restarts of broker">emile at rabbitmq.com
       </A><BR>
    <I>Mon Nov  1 13:51:09 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="010082.html">[rabbitmq-discuss] Understanding RabbitMQ clustering
</A></li>
        <LI>Next message: <A HREF="009723.html">[rabbitmq-discuss] Lose messages between restarts of broker
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9716">[ date ]</a>
              <a href="thread.html#9716">[ thread ]</a>
              <a href="subject.html#9716">[ subject ]</a>
              <a href="author.html#9716">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Rudi,

Op 28/10/2010 19:50, het Rudi Wirth geskryf:
&gt;&gt;<i> If you really need messages to go safely to disk, then you should
</I>&gt;&gt;<i> put the channel into transactional mode (tx.select), and issue a
</I>&gt;&gt;<i> tx.commit
</I>&gt;<i>
</I>&gt;<i> What about unacknowledged messages?
</I>&gt;<i>
</I>&gt;<i> A Producer (rabbit 2.1.1 java client, not Spring Rabbit AMQP) commits
</I>&gt;<i> some persistent messages on a durable queue/exchange.
</I>&gt;<i>
</I>&gt;<i> The Consumer is neither ack'ing nor rejecting the message to leave it
</I>&gt;<i> on the queue (and let recovery retry it later), but I am committing
</I>&gt;<i> periodically, e.g.:
</I>&gt;<i>
</I>&gt;<i> QueueingConsumer.Delivery delivery = consumer.nextDelivery(); //
</I>&gt;<i> neither channel.basicReject or Ack channel.txCommit();
</I>&gt;<i>
</I>&gt;<i> Per ctl:
</I>&gt;<i>
</I>&gt;<i> $ rabbitmqctl list_queues name messages messages_unacknowledged
</I>&gt;<i> messages_ready Listing queues ... testQueue       5       5       0
</I>&gt;<i>
</I>&gt;<i> Using a soft &quot;rabbitmqctl stop&quot;, a Broker restart will make the
</I>&gt;<i> unacknowledged messages ready again (as expected). testQueue       5
</I>&gt;<i> 0       5
</I>&gt;<i>
</I>&gt;<i> With a Broker hardkill, the unack'd messages disappear. testQueue
</I>&gt;<i> 0       0       0
</I>&gt;<i>
</I>&gt;<i> For our implementation, I was going to rely on unacknowledged
</I>&gt;<i> messages, flow control (qos) and periodic channel.basicRecover() to
</I>&gt;<i> implement a crude, controlled &quot;delayed retry&quot; behavior, without using
</I>&gt;<i> a temporary parking queue or application-provided intermediate
</I>&gt;<i> storage. Not that anyone would kill the broker but is there a way to
</I>&gt;<i> flush unack'd messages to disk?
</I>
The advice that Matthew gave applies to unacknowledged message too. If 
the publisher commits on a transacted channel then persistent messages 
in a durable queue are guaranteed to be on disk up to the point when 
they get removed from the queue. This includes any period that messages 
spend in an unacknowledged state.

In your example, had the publisher made the channel transactional and 
committed the messages, all unacknowledged messaged would be in the 
ready list after a hardkill.

There is no direct way for a consumer to affect the persistence of a 
published message other than to republish it as a new message with 
different parameters.

Regards

Emile
</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010082.html">[rabbitmq-discuss] Understanding RabbitMQ clustering
</A></li>
	<LI>Next message: <A HREF="009723.html">[rabbitmq-discuss] Lose messages between restarts of broker
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9716">[ date ]</a>
              <a href="thread.html#9716">[ thread ]</a>
              <a href="subject.html#9716">[ subject ]</a>
              <a href="author.html#9716">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
