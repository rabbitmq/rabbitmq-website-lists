<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Is it safe to interrupt nextDelivery() ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Is%20it%20safe%20to%20interrupt%20nextDelivery%28%29%20%3F&In-Reply-To=%3CAC7FFC20-3A5E-4B3F-83FC-2D5859AE2BE6%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009812.html">
   <LINK REL="Next"  HREF="009766.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Is it safe to interrupt nextDelivery() ?</H1>
    <B>Rob Harrop</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Is%20it%20safe%20to%20interrupt%20nextDelivery%28%29%20%3F&In-Reply-To=%3CAC7FFC20-3A5E-4B3F-83FC-2D5859AE2BE6%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Is it safe to interrupt nextDelivery() ?">rob at rabbitmq.com
       </A><BR>
    <I>Fri Nov  5 11:08:50 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009812.html">[rabbitmq-discuss] Is it safe to interrupt nextDelivery() ?
</A></li>
        <LI>Next message: <A HREF="009766.html">[rabbitmq-discuss] Ubuntu 10.04 installation troubles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9811">[ date ]</a>
              <a href="thread.html#9811">[ thread ]</a>
              <a href="subject.html#9811">[ subject ]</a>
              <a href="author.html#9811">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 3 Nov 2010, at 15:12, Philippe Blayo wrote:

&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> For our fitnesse tests, we have a thread that consumes messages and is
</I>&gt;<i> interrupted after a time out. It is interrupted most of the time in
</I>&gt;<i> the blocking call to QueuingConsummer.nextDelivery(). We observe that
</I>&gt;<i> there is a pending message that is not taken and not acknowledged :
</I>
Is this timeout triggered by your fitnesse tests? Presumably you are looking to limit the time a test takes in the case of failure.

&gt;<i> 
</I>&gt;<i> $ rabbitmqctl list_queues name messages_ready messages_unacknowledged
</I>&gt;<i> Listing queues ...
</I>&gt;<i> STAT_PRINCIPALE 1       1
</I>&gt;<i> ...done.
</I>&gt;<i> 
</I>&gt;<i> Our consumer receive an InterruptedException via
</I>&gt;<i> ExecutorService.shutdownNow() in queue.take() in the QueuingConsummer.
</I>&gt;<i> We reuse channels on the same connection but not on two concurrent
</I>&gt;<i> threads at a time.
</I>
This is to be expected. When using shutdownNow() all worker threads are interrupted and queue.take() is a perfectly interruptible operation. This isn't necessarily a problem because interruption is intended to be a cooperative process between threads. The interruption itself doesn't actually leave the consumer or the server in any bad state. In fact, after the ES has shutdown, you can happily take that same QueueingConsumer and start calling nextDelivery on other threads and it will continue to work.

&gt;<i> 
</I>&gt;<i> Is there a better way to close the QueuingConsummer.nextDelivery() ?
</I>
That depends on your definition of better :) You could call ExecutorServer.shutdown followed by ExecutorService.waitForTermination(). This will give the worker threads in the ES some time to drain what is left in the queue and exit gracefully.

&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Philippe Blayo &amp; Bruno Thomas
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20101105/7267c02e/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20101105/7267c02e/attachment.htm</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009812.html">[rabbitmq-discuss] Is it safe to interrupt nextDelivery() ?
</A></li>
	<LI>Next message: <A HREF="009766.html">[rabbitmq-discuss] Ubuntu 10.04 installation troubles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9811">[ date ]</a>
              <a href="thread.html#9811">[ thread ]</a>
              <a href="subject.html#9811">[ subject ]</a>
              <a href="author.html#9811">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
