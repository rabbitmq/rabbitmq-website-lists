<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Weird behaviour with mirrored queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Weird%20behaviour%20with%20mirrored%20queues&In-Reply-To=%3C6A6C1C37-F212-462E-A62E-24CA113FAA66%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029759.html">
   <LINK REL="Next"  HREF="029765.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Weird behaviour with mirrored queues</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Weird%20behaviour%20with%20mirrored%20queues&In-Reply-To=%3C6A6C1C37-F212-462E-A62E-24CA113FAA66%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Weird behaviour with mirrored queues">tim at rabbitmq.com
       </A><BR>
    <I>Mon Sep  2 08:50:03 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029759.html">[rabbitmq-discuss] Weird behaviour with mirrored queues
</A></li>
        <LI>Next message: <A HREF="029765.html">[rabbitmq-discuss] Weird behaviour with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29763">[ date ]</a>
              <a href="thread.html#29763">[ thread ]</a>
              <a href="subject.html#29763">[ subject ]</a>
              <a href="author.html#29763">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Dan,

Some questions and points of clarification (inline, below) are in order first, I think...

On 2 Sep 2013, at 02:07, Dan_b wrote:
&gt;<i> We have a 4 node rabbitmq cluster with 2 master/slave pairs.
</I>
RabbitMQ nodes do not exhibit master/slave characteristics - those apply only to individual queues (where the master process resides on a specific node, and replicas/slaves on others).

&gt;<i>  We have our
</I>&gt;<i> queues set up using a nodes policy, and we use priorities to have a catch
</I>&gt;<i> all mirror policy, e.g:
</I>&gt;<i> 
</I>&gt;<i> ha_appx        ^.+appx_.+    
</I>&gt;<i> {&quot;ha-mode&quot;:&quot;nodes&quot;,&quot;ha-params&quot;:[&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq3</A>&quot;,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq4</A>&quot;],&quot;ha-sync-mode&quot;:&quot;manual&quot;}    
</I>&gt;<i> 10
</I>&gt;<i> ha_appcatchall        ^.+    
</I>&gt;<i> {&quot;ha-mode&quot;:&quot;nodes&quot;,&quot;ha-params&quot;:[&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>&quot;,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2</A>&quot;],&quot;ha-sync-mode&quot;:&quot;manual&quot;}    
</I>&gt;<i> 1
</I>&gt;<i> 
</I>
Just to clarify then, any queue (name) that matches the `appx_' regex will be mirrored over the nodes on mq3 and mq4, whereas everything else will be mirrored across those on hosts mq1 and mq1.

&gt;<i> If we then add another policy for app_y with priority 10 the majority of the
</I>&gt;<i> queues for app_y disappear(from rabbitmqctl list_queues).
</I>
To be clear - you are saying that you already have some (existing) queues that have names of the form app_y* that were declared on one of your nodes. You add another ha-mode policy that matches names of that form, and subsequently when running rabbitmqctl, you can no longer see these in list_queues - is that right? What exactly does the app_y policy that you're setting look like?

&gt;<i>  The bindings
</I>&gt;<i> still exist
</I>
I would expect that if the bindings exist then the queues are still there, if not visible.

&gt;<i> ... stopping and restarting the consumers (which create the
</I>&gt;<i> queues if they don't exist) doesn't help.
</I>
That's not really telling us much, since queue.declare is idempotent and won't fail even if the queue already exists.

&gt;<i>  The consumers still connect fine,
</I>&gt;<i> even for the queues that don't exist.
</I>
Have you determined in any other way (besides `rabbitmqctl list_queues') that these queues no longer exist? Do you have the management plugin installed and if so, can you see them in the web UI? If your consumers have consumer cancel notifications enabled, are they getting fired at all?

&gt;<i>  If the queue does exist the consumer
</I>&gt;<i> doesn't consume from that queue.  It almost seems like the queue is bouncing
</I>&gt;<i> around between the policies somehow.
</I>&gt;<i> 
</I>
That seems very unlikely. What exactly does the policy matching regex look like, and can you give a specific example of one of the queue names that you expect to match, which is also exhibiting this behaviour?

&gt;<i> If we create the priority 10 policies first there are no problems (all the
</I>&gt;<i> queues are created on <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A> so the master is still being moved in that
</I>&gt;<i> scenario).
</I>
Hmn. Perhaps there is some bug at work here that only presents itself when the policy is created after the queue is declared. Are publishers and/or consumers already using the queue when the policy is introduced (at runtime) or not? You mention &quot;... so the master is still being moved in that scenario...&quot; - what exactly do you mean by this? Are you saying that at the point when the policy is introduced, the queue process is running on a node which is *not* part of the app_y policy's ha-params array? That is the only reason why a queue process that's already running (i.e., has been declared on a certain node) would be re-located if/when a policy is added or changed. If that is the case, how did you identify where the queue process (which will become the master) was originally running?  

&gt;<i>  We can obviously work around by deleting the priority 1 policy
</I>&gt;<i> if we want to move queues, but after the issue has occurred the only way I
</I>&gt;<i> can find to fix it is to completely reset the cluster.
</I>
Why do you want to &quot;move queues&quot; at all? What exactly are you trying to achieve here? Are you deliberately using these policies to relocate queues that were running on a node that is not part of the ha-params for a new policy? Why would you want to do that? Not that I'm saying there's nothing wrong here - when the `nodes' policy is introduced, if the existing (and previously non-mirrored) queue is running elsewhere, the mirrors ought to be synchronised *first* and then the master will migrate once we're sure no message loss will ensue. 

&gt;<i>  The nodes do not
</I>&gt;<i> shutdown cleanly, they just hang without stopping rabbit.
</I>&gt;<i> 
</I>
That sounds worrying. Can you provide log files (both the rabbit log *and* the sasl logs) from all of the nodes involved in these operations please?

Cheers,
Tim
 

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029759.html">[rabbitmq-discuss] Weird behaviour with mirrored queues
</A></li>
	<LI>Next message: <A HREF="029765.html">[rabbitmq-discuss] Weird behaviour with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29763">[ date ]</a>
              <a href="thread.html#29763">[ thread ]</a>
              <a href="subject.html#29763">[ subject ]</a>
              <a href="author.html#29763">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
