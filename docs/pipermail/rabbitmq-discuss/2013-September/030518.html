<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] problem with increasing response times
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20with%20increasing%20response%20times&In-Reply-To=%3CCAFztWssT_zoE-K-MHemfQWm0fxguco8ftOne_M6_bG9KcrsA0Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030517.html">
   <LINK REL="Next"  HREF="030519.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] problem with increasing response times</H1>
    <B>tgv amni</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20with%20increasing%20response%20times&In-Reply-To=%3CCAFztWssT_zoE-K-MHemfQWm0fxguco8ftOne_M6_bG9KcrsA0Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] problem with increasing response times">tgvt53 at gmail.com
       </A><BR>
    <I>Sun Sep 29 21:24:52 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030517.html">[rabbitmq-discuss] problem with ncreasing response times
</A></li>
        <LI>Next message: <A HREF="030519.html">[rabbitmq-discuss] problem with increasing response times
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30518">[ date ]</a>
              <a href="thread.html#30518">[ thread ]</a>
              <a href="subject.html#30518">[ subject ]</a>
              <a href="author.html#30518">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We are new to rabbitMQ. We use rabbitmq 3.1.5 in our test environment. This
is installed on a red hat linux server (6.4), the same server where our
application is also running. The database (postgresql) is on a separate
server.
We are using rabbitMQ default configuration.
I ran a test where concurrent users post to a rest service (say R). This
service basically expects  two UUIDs (UUID_A and UUID_B), that identify two
database entities  A and B. Once the service is called with these two
values, it publishes to the default exchange.
There are two durable queues bound to this exchange. QueueA and QueueB. Two
services,  Service A and Service B, each listen on QueueA and QueueB
respectively.  There are no other consumers to these queues. Service A
picks up the message and validates  UUID_A exists in the database. Service
B validates UUID_B exists. If they are both valid, an entry is made to the
db, mapping these two values. So each valid post results in an entry in a
table in the db.

I find as the test progresses, response  time of this post increases.  A
lot of the time is being spent in  Unsafe.park (boolean,long)  in sun.misc
package.

Here is the call stack that shows classes where this Unsafe.park() is being
involved from. It appears to be called from spring framework&#8217;s
RabbitTemplate class.

Unsafe.park

 LockSupportparkNanos(Object,Long)

  * **AbstractQueuedSynchronizer$ConditionObject.awaitNanos(long)*

     ArrayBlockingQueue.poll(long, TimeUnit)

        RabbitTemplate$3.doInRabbit(Channel)

           RabbitTemplate$3.doInRabbit(Channel)

RabbitTemplate.execute(ChannelCallback)

  * **RabbitTemplate.doSendAndReceiveWithTemporary(String,String,Message)*

      RabbitTemplate.doSendAndReceive(String,String,Message)

         RabbitTemplate.convertSendAndReceive(String,String,Object,
MessagePostProcessor)


RabbitTemplate.convertSendAndReceive(String,Object)

&#8230;

           &#8230;

As the test progresses where the load increases from 50 users to 200 users
over a period of 20 mins, this response time increases from 50 ms to almost
2 seconds. 99% of the response time is spent in Unsafe.park (waiting).  At
the end of 20 mins, roughly 100,000 entries are made into the db.That is
roughly 83 Posts (i.e messages) per second. Each message contains a couple
of UUIDs and a couple of dates. There is no other activity on this server.
Why is there so mcuh time being spent in Unsafe.park() ? It looks like
there is a wait for some resource lock. How can we reduce this wait ?
Overall CPU is about 40-45% on this box (a 12 core server). 2/3rds of this
time is being spent in the rabbitMQ server.
Is there a plug-in to monitor cpu usage on the server? How can we determine
where time is being spent within the broker ?

Thanks,

tgv
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130929/5d094484/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130929/5d094484/attachment.htm</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030517.html">[rabbitmq-discuss] problem with ncreasing response times
</A></li>
	<LI>Next message: <A HREF="030519.html">[rabbitmq-discuss] problem with increasing response times
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30518">[ date ]</a>
              <a href="thread.html#30518">[ thread ]</a>
              <a href="subject.html#30518">[ subject ]</a>
              <a href="author.html#30518">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
