<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Lower delivery rate than publish rate - why?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lower%20delivery%20rate%20than%20publish%20rate%20-%20why%3F&In-Reply-To=%3C4b7f0d8f-e8dd-4b2a-82c7-a332b69f56f4%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029762.html">
   <LINK REL="Next"  HREF="029849.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Lower delivery rate than publish rate - why?</H1>
    <B>Zhibo Wei</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lower%20delivery%20rate%20than%20publish%20rate%20-%20why%3F&In-Reply-To=%3C4b7f0d8f-e8dd-4b2a-82c7-a332b69f56f4%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Lower delivery rate than publish rate - why?">uglytrollx at gmail.com
       </A><BR>
    <I>Fri Sep 27 08:49:46 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029762.html">[rabbitmq-discuss] Lower delivery rate than publish rate - why?
</A></li>
        <LI>Next message: <A HREF="029849.html">[rabbitmq-discuss] Lower delivery rate than publish rate - why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30465">[ date ]</a>
              <a href="thread.html#30465">[ thread ]</a>
              <a href="subject.html#30465">[ subject ]</a>
              <a href="author.html#30465">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm seeing the same issue. Has anyone found out the reason why?

On Sunday, September 1, 2013 1:11:57 PM UTC-7, Tyson Stewart wrote:
&gt;<i>
</I>&gt;<i> I have yet more details to add in case they help.
</I>&gt;<i>
</I>&gt;<i>    - Technically, it's a 3-node cluster, but we took one of the nodes 
</I>&gt;<i>    down last week and have not added it back in because we've had some 
</I>&gt;<i>    problems with RabbitMQ becoming unresponsive when making those kinds of 
</I>&gt;<i>    changes to an active cluster. So we have two reporting nodes and one down 
</I>&gt;<i>    node.
</I>&gt;<i>    - This morning, all 15 consumers maintained 30 messages per second 
</I>&gt;<i>    pretty constantly, but then we hit some delivery threshold (I'm not exactly 
</I>&gt;<i>    sure where), and they started the sawtooth behavior again and has been that 
</I>&gt;<i>    way since. 
</I>&gt;<i>    - We see publish spikes of 2-3x the normal rate every other minute, 
</I>&gt;<i>    but the consumers bounce from 40 messages/second to 0 four to five times 
</I>&gt;<i>    per minute, so it's not a direct correlation between the publish spikes and 
</I>&gt;<i>    delivery drops.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Saturday, August 31, 2013 6:30:24 PM UTC-5, Tyson Stewart wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hello everyone!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We've been experiencing some behavior that I don't understand, and none 
</I>&gt;&gt;<i> of my searching or documentation-reading has been fruitful, so I'm here to 
</I>&gt;&gt;<i> ask you all for expert knowledge.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Broadly, we're seeing a lower delivery rate than publish rate. I've 
</I>&gt;&gt;<i> attached an image to this message that shows how we're able to keep up when 
</I>&gt;&gt;<i> the publish rate is less than 600 messages/second, but above that, 
</I>&gt;&gt;<i> consumption falls behind publication. Around 16:00 on that chart, we 
</I>&gt;&gt;<i> doubled the number of consumers, and it made no difference that we could 
</I>&gt;&gt;<i> tell. The erratic behavior of the publish rate is us turning off publishes 
</I>&gt;&gt;<i> of the most active queue because we were falling far enough behind that we 
</I>&gt;&gt;<i> became worried. When the backlog would get low enough, we would turn it 
</I>&gt;&gt;<i> back on, and we did that a few times.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here are some vitals to our cluster:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - 2 nodes
</I>&gt;&gt;<i>    - Each node is a m1.xlarge instance hosted in EC2
</I>&gt;&gt;<i>    - We have 133 queues in the cluster (see note below)
</I>&gt;&gt;<i>    - All queues are mirrored (they all use a policy that makes them 
</I>&gt;&gt;<i>    highly available)
</I>&gt;&gt;<i>    - All queues are durable; we use AWS provisioned IOPS to guarantee 
</I>&gt;&gt;<i>    enough throughput
</I>&gt;&gt;<i>    - We only use the direct exchange
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regarding the number of queues, there are four kinds: the &quot;main&quot; queues, 
</I>&gt;&gt;<i> retry-a queues, retry-b queues, and poison queues. Messages that fail for 
</I>&gt;&gt;<i> whatever reason during consumption will get put into the retry queues, and 
</I>&gt;&gt;<i> if they fail long enough, they'll wind up in the poison queue where they 
</I>&gt;&gt;<i> will stay until we do something with them manually much later. The main 
</I>&gt;&gt;<i> queues then see the majority of activity.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The average message size is less than 1MB. At nearly one million 
</I>&gt;&gt;<i> messages, we were still under 1GB of memory usage, and our high watermark 
</I>&gt;&gt;<i> is 5.9GB. 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Disk IOPS don't appear to be the problem. Metrics indicated we still had 
</I>&gt;&gt;<i> plenty of headroom. Furthermore, if IOPS were the limitation, I would have 
</I>&gt;&gt;<i> expected the delivery rate to increase as the publish rate decreased while 
</I>&gt;&gt;<i> the consumers worked through the queue. It did not, however, as shown on 
</I>&gt;&gt;<i> the chart.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My question primarily is: *What do you think is limiting our consumption 
</I>&gt;&gt;<i> rate?* I'm curious about what affects consumption rate in general, 
</I>&gt;&gt;<i> though. Any advice would be appreciated at this point. Questions for 
</I>&gt;&gt;<i> clarification are also welcome!
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130927/8caeab8e/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130927/8caeab8e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029762.html">[rabbitmq-discuss] Lower delivery rate than publish rate - why?
</A></li>
	<LI>Next message: <A HREF="029849.html">[rabbitmq-discuss] Lower delivery rate than publish rate - why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30465">[ date ]</a>
              <a href="thread.html#30465">[ thread ]</a>
              <a href="subject.html#30465">[ subject ]</a>
              <a href="author.html#30465">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
