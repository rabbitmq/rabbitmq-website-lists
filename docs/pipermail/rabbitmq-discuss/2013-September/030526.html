<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20slows%20down%20%28a%20lot%29%20after%20producer%0A%20exceeds%20a%20certain%20publish%20rate%2C%20why%3F&In-Reply-To=%3C5249415D.6070207%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030507.html">
   <LINK REL="Next"  HREF="030527.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20slows%20down%20%28a%20lot%29%20after%20producer%0A%20exceeds%20a%20certain%20publish%20rate%2C%20why%3F&In-Reply-To=%3C5249415D.6070207%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?">simon at rabbitmq.com
       </A><BR>
    <I>Mon Sep 30 10:16:13 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030507.html">[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?
</A></li>
        <LI>Next message: <A HREF="030527.html">[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30526">[ date ]</a>
              <a href="thread.html#30526">[ thread ]</a>
              <a href="subject.html#30526">[ subject ]</a>
              <a href="author.html#30526">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>While you say that CPU usage is fine, bear in mind that a single queue 
can only use one CPU core at once.

It is quite possible that you are simply giving the queue too much work 
to do. (And you're not hitting its limit when testing on your own 
machine because that's faster than a large EC2 instance.)

Unfortunately when a queue is CPU-limited we don't guarantee that it 
will prioritise delivering messages to consumers over accepting messages 
from publishers. We used to, but this can have undesirable consequences 
in other contexts (a large queue which suddenly got consumers could use 
100% of its CPU draining, thus blocking publishers for potentially a 
long time). So in particular if you have a decent number of publishers 
it's possible to just overwhelm the queue.

If you are able to split your work up across several queues I suspect 
that would help a lot.

Cheers, Simon

On 27/09/2013 23:43, Zhibo Wei wrote:
&gt;<i> Here is a very interesting chart.
</I>&gt;<i>
</I>&gt;<i> Before 22:10, both publisher and consumer were both running in a stable
</I>&gt;<i> state (13000msgs/sec);
</I>&gt;<i> 22:11, I increased the publish rate to 17000msgs/sec;
</I>&gt;<i> deliver rate went down while publish rate went up;
</I>&gt;<i> 22:12, I shut down the publisher, the deliver rate went up high and
</I>&gt;<i> drained the all the messages left in queue in seconds.
</I>&gt;<i>
</I>&gt;<i> I know it must be bound by something but I don't know what's that yet.
</I>&gt;<i> CPU and memory usage are just fine, and I put queue and consumer in the
</I>&gt;<i> same machine so probably bandwidth is not the root cause. Local I/O
</I>&gt;<i> utilization was low as well. What else could be the root cause? Any hint
</I>&gt;<i> will be appreciated.
</I>&gt;<i>
</I>&gt;<i> btw, Everything looked good when I tested on my local machine
</I>&gt;<i> (20000+msgs/sec on both sides without any problem), but when I put them
</I>&gt;<i> onto EC2, this thing happens.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Zhibo
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Sep 27, 2013 at 3:05 PM, Zhibo Wei &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">zweicmu at gmail.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">zweicmu at gmail.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     Hi Alvaro,
</I>&gt;<i>
</I>&gt;<i>     Thanks for pointing out this.
</I>&gt;<i>
</I>&gt;<i>     But when I checked the connection status from management plugin,
</I>&gt;<i>     only publisher connections were in 'Flow/Blocked' states, all
</I>&gt;<i>     consumers' connections were still 'running' but in a very low rate.
</I>&gt;<i>
</I>&gt;<i>     And, as far as I know, 15000 msgs/sec is still far from the ceiling
</I>&gt;<i>     (Based on
</I>&gt;<i>     <A HREF="http://www.rabbitmq.com/blog/2012/04/25/rabbitmq-performance-measurements-part-2/">http://www.rabbitmq.com/blog/2012/04/25/rabbitmq-performance-measurements-part-2/</A>).
</I>&gt;<i>
</I>&gt;<i>     Did I miss anything?
</I>&gt;<i>
</I>&gt;<i>     Thanks,
</I>&gt;<i>     Zhibo
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     On Fri, Sep 27, 2013 at 2:52 PM, Alvaro Videla
</I>&gt;<i>     &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">videlalvaro at gmail.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">videlalvaro at gmail.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>         Hi,
</I>&gt;<i>
</I>&gt;<i>         Take a look at the flow control mechanism:
</I>&gt;<i>         <A HREF="http://www.rabbitmq.com/memory.html">http://www.rabbitmq.com/memory.html</A>
</I>&gt;<i>
</I>&gt;<i>         &quot;A per-connection mechanism that prevents messages being
</I>&gt;<i>         published faster than they can be routed to queues.&quot; Perhaps
</I>&gt;<i>         your publishers are hitting that.
</I>&gt;<i>
</I>&gt;<i>         Regards,
</I>&gt;<i>
</I>&gt;<i>         Alvaro
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         On Fri, Sep 27, 2013 at 2:44 AM, Zhibo Wei &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">zweicmu at gmail.com</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">zweicmu at gmail.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>             3.15 rabbitmq-server
</I>&gt;<i>             3.15 java-client (consumer)
</I>&gt;<i>             3.04 erlang (producer)
</I>&gt;<i>             ec2 m1.large
</I>&gt;<i>             1 durable queue. no exchange.
</I>&gt;<i>             Producer has 5 connections, each connection holds 20 channels.
</I>&gt;<i>             Consumer has only 1 connection, who holds 20 channels,
</I>&gt;<i>             autoack = true.
</I>&gt;<i>
</I>&gt;<i>             If the publish rate is equal or below 15000msgs/sec, then
</I>&gt;<i>             the consumer can hold it up (Queue never grows). However, if
</I>&gt;<i>             the publish rate exceeds 15,000, say 18,000 msgs/sec, then
</I>&gt;<i>             the delivery rate will drop to 400~2000/sec, then queue
</I>&gt;<i>             starts paging, blocks producer, and then everything crashes.
</I>&gt;<i>
</I>&gt;<i>             The CPU and memory usages are just fine, but I'm not sure
</I>&gt;<i>             what else could cause such problem. Bandwidth? Socket buffer
</I>&gt;<i>             size?
</I>&gt;<i>
</I>&gt;<i>             Anyone saw this kind of issue before? Any clues? Any other
</I>&gt;<i>             things I should check?
</I>&gt;<i>
</I>&gt;<i>             Thanks,
</I>&gt;<i>             Zhibo
</I>&gt;<i>
</I>&gt;<i>             _______________________________________________
</I>&gt;<i>             rabbitmq-discuss mailing list
</I>&gt;<i>             <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i>             &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i>             <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         _______________________________________________
</I>&gt;<i>         rabbitmq-discuss mailing list
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030507.html">[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?
</A></li>
	<LI>Next message: <A HREF="030527.html">[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30526">[ date ]</a>
              <a href="thread.html#30526">[ thread ]</a>
              <a href="subject.html#30526">[ subject ]</a>
              <a href="author.html#30526">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
