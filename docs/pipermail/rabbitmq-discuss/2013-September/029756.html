<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Lower delivery rate than publish rate - why?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lower%20delivery%20rate%20than%20publish%20rate%20-%20why%3F&In-Reply-To=%3C5c2eb6d8-f60d-497e-9b90-6937b5841fc6%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029752.html">
   <LINK REL="Next"  HREF="029762.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Lower delivery rate than publish rate - why?</H1>
    <B>Tyson Stewart</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lower%20delivery%20rate%20than%20publish%20rate%20-%20why%3F&In-Reply-To=%3C5c2eb6d8-f60d-497e-9b90-6937b5841fc6%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Lower delivery rate than publish rate - why?">tjstewart.nbc at gmail.com
       </A><BR>
    <I>Sun Sep  1 21:11:57 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029752.html">[rabbitmq-discuss] Lower delivery rate than publish rate - why?
</A></li>
        <LI>Next message: <A HREF="029762.html">[rabbitmq-discuss] Lower delivery rate than publish rate - why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29756">[ date ]</a>
              <a href="thread.html#29756">[ thread ]</a>
              <a href="subject.html#29756">[ subject ]</a>
              <a href="author.html#29756">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have yet more details to add in case they help.

   - Technically, it's a 3-node cluster, but we took one of the nodes down 
   last week and have not added it back in because we've had some problems 
   with RabbitMQ becoming unresponsive when making those kinds of changes to 
   an active cluster. So we have two reporting nodes and one down node.
   - This morning, all 15 consumers maintained 30 messages per second 
   pretty constantly, but then we hit some delivery threshold (I'm not exactly 
   sure where), and they started the sawtooth behavior again and has been that 
   way since. 
   - We see publish spikes of 2-3x the normal rate every other minute, but 
   the consumers bounce from 40 messages/second to 0 four to five times per 
   minute, so it's not a direct correlation between the publish spikes and 
   delivery drops.


On Saturday, August 31, 2013 6:30:24 PM UTC-5, Tyson Stewart wrote:
&gt;<i>
</I>&gt;<i> Hello everyone!
</I>&gt;<i>
</I>&gt;<i> We've been experiencing some behavior that I don't understand, and none of 
</I>&gt;<i> my searching or documentation-reading has been fruitful, so I'm here to ask 
</I>&gt;<i> you all for expert knowledge.
</I>&gt;<i>
</I>&gt;<i> Broadly, we're seeing a lower delivery rate than publish rate. I've 
</I>&gt;<i> attached an image to this message that shows how we're able to keep up when 
</I>&gt;<i> the publish rate is less than 600 messages/second, but above that, 
</I>&gt;<i> consumption falls behind publication. Around 16:00 on that chart, we 
</I>&gt;<i> doubled the number of consumers, and it made no difference that we could 
</I>&gt;<i> tell. The erratic behavior of the publish rate is us turning off publishes 
</I>&gt;<i> of the most active queue because we were falling far enough behind that we 
</I>&gt;<i> became worried. When the backlog would get low enough, we would turn it 
</I>&gt;<i> back on, and we did that a few times.
</I>&gt;<i>
</I>&gt;<i> Here are some vitals to our cluster:
</I>&gt;<i>
</I>&gt;<i>    - 2 nodes
</I>&gt;<i>    - Each node is a m1.xlarge instance hosted in EC2
</I>&gt;<i>    - We have 133 queues in the cluster (see note below)
</I>&gt;<i>    - All queues are mirrored (they all use a policy that makes them 
</I>&gt;<i>    highly available)
</I>&gt;<i>    - All queues are durable; we use AWS provisioned IOPS to guarantee 
</I>&gt;<i>    enough throughput
</I>&gt;<i>    - We only use the direct exchange
</I>&gt;<i>
</I>&gt;<i> Regarding the number of queues, there are four kinds: the &quot;main&quot; queues, 
</I>&gt;<i> retry-a queues, retry-b queues, and poison queues. Messages that fail for 
</I>&gt;<i> whatever reason during consumption will get put into the retry queues, and 
</I>&gt;<i> if they fail long enough, they'll wind up in the poison queue where they 
</I>&gt;<i> will stay until we do something with them manually much later. The main 
</I>&gt;<i> queues then see the majority of activity.
</I>&gt;<i>
</I>&gt;<i> The average message size is less than 1MB. At nearly one million messages, 
</I>&gt;<i> we were still under 1GB of memory usage, and our high watermark is 5.9GB. 
</I>&gt;<i>
</I>&gt;<i> Disk IOPS don't appear to be the problem. Metrics indicated we still had 
</I>&gt;<i> plenty of headroom. Furthermore, if IOPS were the limitation, I would have 
</I>&gt;<i> expected the delivery rate to increase as the publish rate decreased while 
</I>&gt;<i> the consumers worked through the queue. It did not, however, as shown on 
</I>&gt;<i> the chart.
</I>&gt;<i>
</I>&gt;<i> My question primarily is: *What do you think is limiting our consumption 
</I>&gt;<i> rate?* I'm curious about what affects consumption rate in general, 
</I>&gt;<i> though. Any advice would be appreciated at this point. Questions for 
</I>&gt;<i> clarification are also welcome!
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130901/1f6114ef/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130901/1f6114ef/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029752.html">[rabbitmq-discuss] Lower delivery rate than publish rate - why?
</A></li>
	<LI>Next message: <A HREF="029762.html">[rabbitmq-discuss] Lower delivery rate than publish rate - why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29756">[ date ]</a>
              <a href="thread.html#29756">[ thread ]</a>
              <a href="subject.html#29756">[ subject ]</a>
              <a href="author.html#29756">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
