<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20slows%20down%20%28a%20lot%29%20after%20producer%0A%20exceeds%20a%20certain%20publish%20rate%2C%20why%3F&In-Reply-To=%3CCABMzP9M%2Bw9PX3PE%2Bo_xx-O2CRz%3DvCgYwuFdaig%3DJR-vd%3DAWBAg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030526.html">
   <LINK REL="Next"  HREF="030466.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?</H1>
    <B>Zhibo Wei</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20slows%20down%20%28a%20lot%29%20after%20producer%0A%20exceeds%20a%20certain%20publish%20rate%2C%20why%3F&In-Reply-To=%3CCABMzP9M%2Bw9PX3PE%2Bo_xx-O2CRz%3DvCgYwuFdaig%3DJR-vd%3DAWBAg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?">zweicmu at gmail.com
       </A><BR>
    <I>Mon Sep 30 10:22:52 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030526.html">[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?
</A></li>
        <LI>Next message: <A HREF="030466.html">[rabbitmq-discuss] How to change RabbitMQ default listening port?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30527">[ date ]</a>
              <a href="thread.html#30527">[ thread ]</a>
              <a href="subject.html#30527">[ subject ]</a>
              <a href="author.html#30527">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ah....Maybe that's why

I will do more investigations on the CPU usage for each core and split all
msgs into several different queues to see if that will help.

Thanks a lot Simon, It's really helpful.


On Mon, Sep 30, 2013 at 2:16 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i> While you say that CPU usage is fine, bear in mind that a single queue can
</I>&gt;<i> only use one CPU core at once.
</I>&gt;<i>
</I>&gt;<i> It is quite possible that you are simply giving the queue too much work to
</I>&gt;<i> do. (And you're not hitting its limit when testing on your own machine
</I>&gt;<i> because that's faster than a large EC2 instance.)
</I>&gt;<i>
</I>&gt;<i> Unfortunately when a queue is CPU-limited we don't guarantee that it will
</I>&gt;<i> prioritise delivering messages to consumers over accepting messages from
</I>&gt;<i> publishers. We used to, but this can have undesirable consequences in other
</I>&gt;<i> contexts (a large queue which suddenly got consumers could use 100% of its
</I>&gt;<i> CPU draining, thus blocking publishers for potentially a long time). So in
</I>&gt;<i> particular if you have a decent number of publishers it's possible to just
</I>&gt;<i> overwhelm the queue.
</I>&gt;<i>
</I>&gt;<i> If you are able to split your work up across several queues I suspect that
</I>&gt;<i> would help a lot.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 27/09/2013 23:43, Zhibo Wei wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Here is a very interesting chart.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Before 22:10, both publisher and consumer were both running in a stable
</I>&gt;&gt;<i> state (13000msgs/sec);
</I>&gt;&gt;<i> 22:11, I increased the publish rate to 17000msgs/sec;
</I>&gt;&gt;<i> deliver rate went down while publish rate went up;
</I>&gt;&gt;<i> 22:12, I shut down the publisher, the deliver rate went up high and
</I>&gt;&gt;<i> drained the all the messages left in queue in seconds.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I know it must be bound by something but I don't know what's that yet.
</I>&gt;&gt;<i> CPU and memory usage are just fine, and I put queue and consumer in the
</I>&gt;&gt;<i> same machine so probably bandwidth is not the root cause. Local I/O
</I>&gt;&gt;<i> utilization was low as well. What else could be the root cause? Any hint
</I>&gt;&gt;<i> will be appreciated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> btw, Everything looked good when I tested on my local machine
</I>&gt;&gt;<i> (20000+msgs/sec on both sides without any problem), but when I put them
</I>&gt;&gt;<i> onto EC2, this thing happens.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Zhibo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Fri, Sep 27, 2013 at 3:05 PM, Zhibo Wei &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">zweicmu at gmail.com</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">zweicmu at gmail.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Hi Alvaro,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Thanks for pointing out this.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     But when I checked the connection status from management plugin,
</I>&gt;&gt;<i>     only publisher connections were in 'Flow/Blocked' states, all
</I>&gt;&gt;<i>     consumers' connections were still 'running' but in a very low rate.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     And, as far as I know, 15000 msgs/sec is still far from the ceiling
</I>&gt;&gt;<i>     (Based on
</I>&gt;&gt;<i>     <A HREF="http://www.rabbitmq.com/blog/**2012/04/25/rabbitmq-**">http://www.rabbitmq.com/blog/**2012/04/25/rabbitmq-**</A>
</I>&gt;&gt;<i> performance-measurements-part-**2/&lt;<A HREF="http://www.rabbitmq.com/blog/2012/04/25/rabbitmq-performance-measurements-part-2/">http://www.rabbitmq.com/blog/2012/04/25/rabbitmq-performance-measurements-part-2/</A>&gt;
</I>&gt;&gt;<i> ).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Did I miss anything?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Thanks,
</I>&gt;&gt;<i>     Zhibo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     On Fri, Sep 27, 2013 at 2:52 PM, Alvaro Videla
</I>&gt;&gt;<i>     &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">videlalvaro at gmail.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">videlalvaro at gmail.com</A>&gt;**&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Take a look at the flow control mechanism:
</I>&gt;&gt;<i>         <A HREF="http://www.rabbitmq.com/**memory.html&lt;http://www.rabbitmq.com/memory.html">http://www.rabbitmq.com/**memory.html&lt;http://www.rabbitmq.com/memory.html</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         &quot;A per-connection mechanism that prevents messages being
</I>&gt;&gt;<i>         published faster than they can be routed to queues.&quot; Perhaps
</I>&gt;&gt;<i>         your publishers are hitting that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Regards,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Alvaro
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         On Fri, Sep 27, 2013 at 2:44 AM, Zhibo Wei &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">zweicmu at gmail.com</A>
</I>&gt;&gt;<i>         &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">zweicmu at gmail.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             3.15 rabbitmq-server
</I>&gt;&gt;<i>             3.15 java-client (consumer)
</I>&gt;&gt;<i>             3.04 erlang (producer)
</I>&gt;&gt;<i>             ec2 m1.large
</I>&gt;&gt;<i>             1 durable queue. no exchange.
</I>&gt;&gt;<i>             Producer has 5 connections, each connection holds 20 channels.
</I>&gt;&gt;<i>             Consumer has only 1 connection, who holds 20 channels,
</I>&gt;&gt;<i>             autoack = true.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             If the publish rate is equal or below 15000msgs/sec, then
</I>&gt;&gt;<i>             the consumer can hold it up (Queue never grows). However, if
</I>&gt;&gt;<i>             the publish rate exceeds 15,000, say 18,000 msgs/sec, then
</I>&gt;&gt;<i>             the delivery rate will drop to 400~2000/sec, then queue
</I>&gt;&gt;<i>             starts paging, blocks producer, and then everything crashes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             The CPU and memory usages are just fine, but I'm not sure
</I>&gt;&gt;<i>             what else could cause such problem. Bandwidth? Socket buffer
</I>&gt;&gt;<i>             size?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             Anyone saw this kind of issue before? Any clues? Any other
</I>&gt;&gt;<i>             things I should check?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             Thanks,
</I>&gt;&gt;<i>             Zhibo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             ______________________________**_________________
</I>&gt;&gt;<i>             rabbitmq-discuss mailing list
</I>&gt;&gt;<i>             <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.</A>**rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i>             &lt;mailto:rabbitmq-discuss@**lists.rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             <A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**</A>
</I>&gt;&gt;<i> rabbitmq-discuss&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         ______________________________**_________________
</I>&gt;&gt;<i>         rabbitmq-discuss mailing list
</I>&gt;&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.</A>**rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i>         &lt;mailto:rabbitmq-discuss@**lists.rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         <A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**</A>
</I>&gt;&gt;<i> rabbitmq-discuss&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ______________________________**_________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.</A>**rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130930/0e6fab12/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130930/0e6fab12/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030526.html">[rabbitmq-discuss] Consumer slows down (a lot) after producer exceeds a certain publish rate, why?
</A></li>
	<LI>Next message: <A HREF="030466.html">[rabbitmq-discuss] How to change RabbitMQ default listening port?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30527">[ date ]</a>
              <a href="thread.html#30527">[ thread ]</a>
              <a href="subject.html#30527">[ subject ]</a>
              <a href="author.html#30527">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
