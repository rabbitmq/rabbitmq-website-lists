<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] problem with increasing response times
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20with%20increasing%20response%20times&In-Reply-To=%3CCADtU9_spg8J6VRtvxVUcah0fqfg_KebAosFnHnTd2jQ%2BtRJzJw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030518.html">
   <LINK REL="Next"  HREF="030520.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] problem with increasing response times</H1>
    <B>Gary Russell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20with%20increasing%20response%20times&In-Reply-To=%3CCADtU9_spg8J6VRtvxVUcah0fqfg_KebAosFnHnTd2jQ%2BtRJzJw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] problem with increasing response times">grussell at gopivotal.com
       </A><BR>
    <I>Sun Sep 29 21:47:59 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030518.html">[rabbitmq-discuss] problem with increasing response times
</A></li>
        <LI>Next message: <A HREF="030520.html">[rabbitmq-discuss] Suggestion for enabling users view data in queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30519">[ date ]</a>
              <a href="thread.html#30519">[ thread ]</a>
              <a href="subject.html#30519">[ subject ]</a>
              <a href="author.html#30519">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>By default, the RabbitTemplate.*sendAndReceive() operations create a
temporary reply queue for each request. This is not particularly efficient
for high volume situations.

Consider using a fixed reply queue in these situations.

<A HREF="http://docs.spring.io/spring-amqp/reference/html/amqp.html#request-reply">http://docs.spring.io/spring-amqp/reference/html/amqp.html#request-reply</A>


On Sun, Sep 29, 2013 at 4:24 PM, tgv amni &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tgvt53 at gmail.com</A>&gt; wrote:

&gt;<i> We are new to rabbitMQ. We use rabbitmq 3.1.5 in our test
</I>&gt;<i> environment. This is installed on a red hat linux server (6.4), the same
</I>&gt;<i> server where our application is also running. The database (postgresql) is
</I>&gt;<i> on a separate server.
</I>&gt;<i> We are using rabbitMQ default configuration.
</I>&gt;<i> I ran a test where concurrent users post to a rest service (say R). This
</I>&gt;<i> service basically expects  two UUIDs (UUID_A and UUID_B), that identify
</I>&gt;<i> two database entities  A and B. Once the service is called with these two
</I>&gt;<i> values, it publishes to the default exchange.
</I>&gt;<i> There are two durable queues bound to this exchange. QueueA and QueueB.
</I>&gt;<i> Two services,  Service A and Service B, each listen on QueueA and QueueB
</I>&gt;<i> respectively.  There are no other consumers to these queues. Service A
</I>&gt;<i> picks up the message and validates  UUID_A exists in the database.
</I>&gt;<i> Service B validates UUID_B exists. If they are both valid, an entry is made
</I>&gt;<i> to the db, mapping these two values. So each valid post results in an entry
</I>&gt;<i> in a table in the db.
</I>&gt;<i>
</I>&gt;<i> I find as the test progresses, response  time of this post increases.  A
</I>&gt;<i> lot of the time is being spent in  Unsafe.park (boolean,long)  in
</I>&gt;<i> sun.misc package.
</I>&gt;<i>
</I>&gt;<i> Here is the call stack that shows classes where this Unsafe.park() is
</I>&gt;<i> being involved from. It appears to be called from spring framework&#8217;s
</I>&gt;<i> RabbitTemplate class.
</I>&gt;<i>
</I>&gt;<i> Unsafe.park
</I>&gt;<i>
</I>&gt;<i>  LockSupportparkNanos(Object,Long)
</I>&gt;<i>
</I>&gt;<i>   * **AbstractQueuedSynchronizer$ConditionObject.awaitNanos(long)*
</I>&gt;<i>
</I>&gt;<i>      ArrayBlockingQueue.poll(long, TimeUnit)
</I>&gt;<i>
</I>&gt;<i>         RabbitTemplate$3.doInRabbit(Channel)
</I>&gt;<i>
</I>&gt;<i>            RabbitTemplate$3.doInRabbit(Channel)
</I>&gt;<i>
</I>&gt;<i> RabbitTemplate.execute(ChannelCallback)
</I>&gt;<i>
</I>&gt;<i>   * **RabbitTemplate.doSendAndReceiveWithTemporary(String,String,Message)*
</I>&gt;<i>
</I>&gt;<i>       RabbitTemplate.doSendAndReceive(String,String,Message)
</I>&gt;<i>
</I>&gt;<i>          RabbitTemplate.convertSendAndReceive(String,String,Object,
</I>&gt;<i> MessagePostProcessor)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> RabbitTemplate.convertSendAndReceive(String,Object)
</I>&gt;<i>
</I>&gt;<i> &#8230;
</I>&gt;<i>
</I>&gt;<i>            &#8230;
</I>&gt;<i>
</I>&gt;<i> As the test progresses where the load increases from 50 users to 200 users
</I>&gt;<i> over a period of 20 mins, this response time increases from 50 ms to almost
</I>&gt;<i> 2 seconds. 99% of the response time is spent in Unsafe.park (waiting).  At
</I>&gt;<i> the end of 20 mins, roughly 100,000 entries are made into the db.That is
</I>&gt;<i> roughly 83 Posts (i.e messages) per second. Each message contains a couple
</I>&gt;<i> of UUIDs and a couple of dates. There is no other activity on this server.
</I>&gt;<i> Why is there so mcuh time being spent in Unsafe.park() ? It looks like
</I>&gt;<i> there is a wait for some resource lock. How can we reduce this wait ?
</I>&gt;<i> Overall CPU is about 40-45% on this box (a 12 core server). 2/3rds of this
</I>&gt;<i> time is being spent in the rabbitMQ server.
</I>&gt;<i> Is there a plug-in to monitor cpu usage on the server? How can we
</I>&gt;<i> determine where time is being spent within the broker ?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> tgv
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130929/ae849e7d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130929/ae849e7d/attachment.htm</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030518.html">[rabbitmq-discuss] problem with increasing response times
</A></li>
	<LI>Next message: <A HREF="030520.html">[rabbitmq-discuss] Suggestion for enabling users view data in queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30519">[ date ]</a>
              <a href="thread.html#30519">[ thread ]</a>
              <a href="subject.html#30519">[ subject ]</a>
              <a href="author.html#30519">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
