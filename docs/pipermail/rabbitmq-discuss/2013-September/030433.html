<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ - strange synchronization behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20-%20strange%20synchronization%20behavior&In-Reply-To=%3C52441FDA.6040005%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030439.html">
   <LINK REL="Next"  HREF="030438.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ - strange synchronization behavior</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20-%20strange%20synchronization%20behavior&In-Reply-To=%3C52441FDA.6040005%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ - strange synchronization behavior">simon at rabbitmq.com
       </A><BR>
    <I>Thu Sep 26 12:51:54 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030439.html">[rabbitmq-discuss] can a consumer listen to two different queues at a time
</A></li>
        <LI>Next message: <A HREF="030438.html">[rabbitmq-discuss] memory leak rabbitmq 3.1.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30433">[ date ]</a>
              <a href="thread.html#30433">[ thread ]</a>
              <a href="subject.html#30433">[ subject ]</a>
              <a href="author.html#30433">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please keep rabbitmq-discuss on CC.

I have just synced 2M x 512 byte messages in 50 seconds on my 
workstation with paging disabled. So the sync mechanism itself is not 
necessarily slow.

But that's with a) a fast network b) all messages in RAM on both nodes. 
Once the queue is big enough that it's paged out, synchronisation slows 
right down. On a slower machine (2010 MBP), the same test took 9 min 36 
sec with much paging.

Obviously paging will slow things down, although it does look like the 
slowdown is disproportionate (it took 3min to load the messages in the 
first place, which also required paging). So there might be room for 
improvement there.

But 7 hours is way too much! Are you sure the messages were 512 bytes? 
Were there any unacknowledged messages? Is your disk particularly slow?

Cheers, Simon

On 26/09/2013 9:55AM, Peter Sokolowski wrote:
&gt;<i> I have made a few tests [the same hardware/software configuration as earlier]:
</I>&gt;<i> a) synchronization of 200.000 messages: takes about 1 minute
</I>&gt;<i> b) synchronization of 1.000.000 messages: takes about 1 hour
</I>&gt;<i> c) synchronization of 2.000.000 messages: takes about 7 hours
</I>&gt;<i>
</I>&gt;<i> During these tests I observed CPU utilization about 100% (on restarted
</I>&gt;<i> node[Slave], the other[Master] had only 1-2%)
</I>&gt;<i>
</I>&gt;<i> I don't understand why synchronization of 2.000.000 takes so long
</I>&gt;<i> [each message=512 bytes]? Is this behavior normal too? Is there any
</I>&gt;<i> chance to speed up synchronization?
</I>&gt;<i>
</I>&gt;<i> 2013/9/26, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;:
</I>&gt;&gt;<i> On 25/09/2013 9:34PM, Peter Sokolowski wrote:
</I>&gt;&gt;&gt;<i> When I restart one of the nodes(by &quot;stop_app&quot; and &quot;start_app&quot; from the
</I>&gt;&gt;&gt;<i> commandline)  the whole cluster is blocked. It doesn't accept any
</I>&gt;&gt;&gt;<i> publish and receive operations during synchronization stage. When
</I>&gt;&gt;&gt;<i> synchronization is finished everything get back to normal - cluster
</I>&gt;&gt;&gt;<i> accepts publish and receive operations.
</I>&gt;&gt;&gt;<i> Is this behavior normal?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;If a queue is set to automatically synchronise it will synchronise
</I>&gt;&gt;<i> whenever a new slave joins - becoming unresponsive until it has done so.&quot;
</I>&gt;&gt;<i>      -- <A HREF="http://www.rabbitmq.com/ha.html#unsynchronised-slaves">http://www.rabbitmq.com/ha.html#unsynchronised-slaves</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> While any given queue is (explicitly) syncing it will not do anything
</I>&gt;&gt;<i> else; publishes to it will block. Therefore it's a reasonable idea to
</I>&gt;&gt;<i> only explicitly sync queues that are not busy, if a queue is being
</I>&gt;&gt;<i> actively published to and consumed from then it will become synchronised
</I>&gt;&gt;<i> after a while anyway, explicit syncing is not needed. We envisaged
</I>&gt;&gt;<i> explicit syncing being used more for queues that are not very active.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And yes, it would be nice if explicit syncing could happen in the
</I>&gt;&gt;<i> background while other things happened. Let's just say that it would be
</I>&gt;&gt;<i> complicated to do that...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Simon MacMullen
</I>&gt;&gt;<i> RabbitMQ, Pivotal
</I>&gt;&gt;<i>
</I>
-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030439.html">[rabbitmq-discuss] can a consumer listen to two different queues at a time
</A></li>
	<LI>Next message: <A HREF="030438.html">[rabbitmq-discuss] memory leak rabbitmq 3.1.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30433">[ date ]</a>
              <a href="thread.html#30433">[ thread ]</a>
              <a href="subject.html#30433">[ subject ]</a>
              <a href="author.html#30433">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
