<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ - Erlang AMQP client - mutual SSL	authentication problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20-%20Erlang%20AMQP%20client%20-%20mutual%20SSL%0A%09authentication%20problem&In-Reply-To=%3CABBDC9D7002EB54AB98BA60DA16D269333FEA9CD%40FR44EX3003.global.ds.honeywell.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030219.html">
   <LINK REL="Next"  HREF="030210.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ - Erlang AMQP client - mutual SSL	authentication problem</H1>
    <B>Skorepa, Michal</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20-%20Erlang%20AMQP%20client%20-%20mutual%20SSL%0A%09authentication%20problem&In-Reply-To=%3CABBDC9D7002EB54AB98BA60DA16D269333FEA9CD%40FR44EX3003.global.ds.honeywell.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ - Erlang AMQP client - mutual SSL	authentication problem">Michal.Skorepa at Honeywell.com
       </A><BR>
    <I>Tue Sep 17 10:02:32 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030219.html">[rabbitmq-discuss] Sometimes RabbitMQ sends RST packets
</A></li>
        <LI>Next message: <A HREF="030210.html">[rabbitmq-discuss] RabbitMQ - Erlang AMQP client - mutual SSL	authentication problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30208">[ date ]</a>
              <a href="thread.html#30208">[ thread ]</a>
              <a href="subject.html#30208">[ subject ]</a>
              <a href="author.html#30208">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I have a problem with establishing SSL connections between Erlang AMQP client (v. 3.0.2) and RabbitMQ server (v. 3.1.3). I need to use mutual authentication, i.e. I need to authenticate the server to the client with the server certificate as well as the client to the server with the client certificate. Authenticating the server to the client works fine (ssl_fail_if_no_peer_cert set to &quot;true&quot; at the client and to &quot;false&quot; at the server), but I am not able to make the client-to-servet authentication work (&quot;true at both sides&quot;).

My SSL configs are the following:
RabbitMQ:
---------
{rabbit, [
        {ssl_listeners, [5677]},
        {ssl_options, [ {cacertfile, &quot;/etc/ssl/xxx/ca_cert.pem&quot;},
                                        {certfile, &quot;/etc/ssl/xxx/cert.pem&quot;},
                                        {keyfile, &quot;/etc/ssl/xxx/key.pem&quot;},
                                        {fail_if_no_peer_cert, true},
                                        {verify, verify_peer}
                ]
        }
        ]
},

Client:
--------
{port, 5677},
{ssl_cert_ca, &quot;/etc/ssl/xxx/swim-ca_cert.pem&quot;},
{ssl_cert, &quot;/etc/ssl/xxx/cert.pem&quot;},
{ssl_key, &quot;/etc/ssl/xxx/key.pem&quot;},
{ssl_verify, verify_peer},
{ssl_fail_if_no_peer_cert, true},
{username, &lt;&lt;&quot;aaa&quot;&gt;&gt;},
{password, &lt;&lt;&quot;aaa&quot;&gt;&gt;},
-----------------

I tried everyting that was suggested on the troubleshooting website (<A HREF="http://www.rabbitmq.com/troubleshooting-ssl.html">http://www.rabbitmq.com/troubleshooting-ssl.html</A>) - check SSL support in Erlang, check the client and server certificates using OpenSSL, check broker listenning on SSL port, attempt SSL connection to broker using OpenSSL, validate client connections with stunnel.. I did not get any errors! I even tried to connect with the Erlang AMQP client to the OpenSSL server - this also worked! (I just got AMQP connection setup timeout after the SSL connection setup - which is not suprprising)

The error I am getting on the client side is:
---------------------------------------------------
{error, esslconnect}

The broker log says:
-------------------------
=ERROR REPORT==== 17-Sep-2013::10:39:40 ===
error on AMQP connection &lt;0.9012.1&gt;: {ssl_upgrade_error,esslaccept} (unknown POSIX error)

=INFO REPORT==== 17-Sep-2013::10:39:40 ===
accepting AMQP connection &lt;0.9027.1&gt; (xxx.xxx.138.17:56035 -&gt; xxx.xxx.0.21:5677)

=ERROR REPORT==== 17-Sep-2013::10:39:40 ===
SSL: certify: ssl_connection.erl:496:Fatal error: handshake failure
---------------------------


Do you have any idea what could be wrong and how to fix it?

Thank you for any thaughts!
Michal



-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130917/2d5f5003/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130917/2d5f5003/attachment.htm</A>&gt;
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030219.html">[rabbitmq-discuss] Sometimes RabbitMQ sends RST packets
</A></li>
	<LI>Next message: <A HREF="030210.html">[rabbitmq-discuss] RabbitMQ - Erlang AMQP client - mutual SSL	authentication problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30208">[ date ]</a>
              <a href="thread.html#30208">[ thread ]</a>
              <a href="subject.html#30208">[ subject ]</a>
              <a href="author.html#30208">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
