<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Weird behaviour with mirrored queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Weird%20behaviour%20with%20mirrored%20queues&In-Reply-To=%3C1378084056075-29254.post%40n5.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029755.html">
   <LINK REL="Next"  HREF="029758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Weird behaviour with mirrored queues</H1>
    <B>Dan_b</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Weird%20behaviour%20with%20mirrored%20queues&In-Reply-To=%3C1378084056075-29254.post%40n5.nabble.com%3E"
       TITLE="[rabbitmq-discuss] Weird behaviour with mirrored queues">daniel.bason at telogis.com
       </A><BR>
    <I>Mon Sep  2 02:07:36 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029755.html">[rabbitmq-discuss] ReferenceError: filter_ui is not defined	(after upgrade)
</A></li>
        <LI>Next message: <A HREF="029758.html">[rabbitmq-discuss] Weird behaviour with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29757">[ date ]</a>
              <a href="thread.html#29757">[ thread ]</a>
              <a href="subject.html#29757">[ subject ]</a>
              <a href="author.html#29757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

We have a 4 node rabbitmq cluster with 2 master/slave pairs.  We have our
queues set up using a nodes policy, and we use priorities to have a catch
all mirror policy, e.g:

ha_appx        ^.+appx_.+    
{&quot;ha-mode&quot;:&quot;nodes&quot;,&quot;ha-params&quot;:[&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq3</A>&quot;,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq4</A>&quot;],&quot;ha-sync-mode&quot;:&quot;manual&quot;}    
10
ha_appcatchall        ^.+    
{&quot;ha-mode&quot;:&quot;nodes&quot;,&quot;ha-params&quot;:[&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>&quot;,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq2</A>&quot;],&quot;ha-sync-mode&quot;:&quot;manual&quot;}    
1

If we then add another policy for app_y with priority 10 the majority of the
queues for app_y disappear(from rabbitmqctl list_queues).  The bindings
still exist and stopping and restarting the consumers (which create the
queues if they don't exist) doesn't help.  The consumers still connect fine,
even for the queues that don't exist.  If the queue does exist the consumer
doesn't consume from that queue.  It almost seems like the queue is bouncing
around between the policies somehow.

If we create the priority 10 policies first there are no problems (all the
queues are created on <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A> so the master is still being moved in that
scenario).  We can obviously work around by deleting the priority 1 policy
if we want to move queues, but after the issue has occurred the only way I
can find to fix it is to completely reset the cluster.  The nodes do not
shutdown cleanly, they just hang without stopping rabbit.

Cheers
Dan



--
View this message in context: <A HREF="http://rabbitmq.1065348.n5.nabble.com/Weird-behaviour-with-mirrored-queues-tp29254.html">http://rabbitmq.1065348.n5.nabble.com/Weird-behaviour-with-mirrored-queues-tp29254.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029755.html">[rabbitmq-discuss] ReferenceError: filter_ui is not defined	(after upgrade)
</A></li>
	<LI>Next message: <A HREF="029758.html">[rabbitmq-discuss] Weird behaviour with mirrored queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29757">[ date ]</a>
              <a href="thread.html#29757">[ thread ]</a>
              <a href="subject.html#29757">[ subject ]</a>
              <a href="author.html#29757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
