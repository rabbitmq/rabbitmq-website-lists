<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Channel storms
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Channel%20storms&In-Reply-To=%3C1378450216588-29395.post%40n5.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029897.html">
   <LINK REL="Next"  HREF="029956.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Channel storms</H1>
    <B>carlhoerberg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Channel%20storms&In-Reply-To=%3C1378450216588-29395.post%40n5.nabble.com%3E"
       TITLE="[rabbitmq-discuss] Channel storms">carl.hoerberg at gmail.com
       </A><BR>
    <I>Fri Sep  6 07:50:16 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="029897.html">[rabbitmq-discuss] Fwd: How manually sync queue after reboot of	the master node with existing queues
</A></li>
        <LI>Next message: <A HREF="029956.html">[rabbitmq-discuss] Channel storms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29898">[ date ]</a>
              <a href="thread.html#29898">[ thread ]</a>
              <a href="subject.html#29898">[ subject ]</a>
              <a href="author.html#29898">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We sometimes see node-amqp clients creating thousands and yet thousands of
channels, bringing a whole cluster to a halt. Normally we detect high
channel counts by polling the /api/connections endpoint, but when this
happens, the channels doesn't even belong to a connection, only if you can
poll /api/channels can you see all the channels (and when the CPU usage is
100% and you have 20000 channels this takes hours), but the connection is
then &quot;unknown&quot;/null. 

<A HREF="https://www.dropbox.com/s/e0koajldzxkuqlo/channelstorm.png">https://www.dropbox.com/s/e0koajldzxkuqlo/channelstorm.png</A>

When the cluster is overloaded like that it responds to nothing, not even
rabbitmqctl status or rabbitmqctl delete_user, so a full cluster restart is
required and then we can block the misbehaving client. 

This shows up a lot in the logs when this is happening: 

=ERROR REPORT==== 6-Sep-2013::00:25:52 ===
** Generic server &lt;0.22899.21&gt; terminating
** Last message in was {'$gen_cast',
                           {method,
                              
{'queue.declare',0,&lt;&lt;&gt;&gt;,false,false,true,true,
                                   false,[]},
                               none,noflow}}
** When Server state == {ch,running,rabbit_framing_amqp_0_9_1,158,
                            &lt;0.22259.21&gt;,&lt;0.22897.21&gt;,&lt;0.22259.21&gt;,
                            &lt;&lt;&quot;54.208.167.186:42852 -&gt; 10.64.29.128:5672&quot;&gt;&gt;,
                            {token,&lt;0.22898.21&gt;,false},
                            none,1,
                            {[],[]},
                            {[],[]},
                            [],[],
                            {user,&lt;&lt;&quot;urhyfncz&quot;&gt;&gt;,
                                [management],
                                rabbit_auth_backend_internal,
                                {internal_user,&lt;&lt;&quot;urhyfncz&quot;&gt;&gt;,
                                   
&lt;&lt;229,2,91,60,213,201,95,103,146,3,49,108,
                                      66,173,123,15,172,181,119,97&gt;&gt;,
                                    [management]}},
                            &lt;&lt;&quot;urhyfncz&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,
                            {dict,0,16,16,8,80,48,
                               
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,0,16,16,8,80,48,
                               
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {set,0,16,16,8,80,48,
                               
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {dict,0,16,16,8,80,48,
                               
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            {set,0,16,16,8,80,48,
                               
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            &lt;0.22257.21&gt;,
                            {state,fine,5000,#Ref&lt;0.0.9.213050&gt;},
                            false,1,
                            {{0,nil},{0,nil}},
                            [],[],none}
** Reason for termination == 
** {{case_clause,not_found},
    [{rabbit_channel,handle_method,3},
     {rabbit_channel,handle_cast,2},
     {gen_server2,handle_msg,2},
     {proc_lib,init_p_do_apply,3}]}

=WARNING REPORT==== 6-Sep-2013::00:25:52 ===
Queue {resource,&lt;&lt;&quot;urhyfncz&quot;&gt;&gt;,queue,&lt;&lt;&quot;amq.gen-FQZtyp6mpRdmm3-on_LAOQ&quot;&gt;&gt;}
exclusive owner went away

So the problem is two fold, the node-amqp lib obvisouly has a bug, I think
it doesn't closes channels after it self by default, but also, RabbitMQ
allows this kind of behavior and doesnt report the high channel count on
connections so we can't automatically detect it either :(  



--
View this message in context: <A HREF="http://rabbitmq.1065348.n5.nabble.com/Channel-storms-tp29395.html">http://rabbitmq.1065348.n5.nabble.com/Channel-storms-tp29395.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.
</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029897.html">[rabbitmq-discuss] Fwd: How manually sync queue after reboot of	the master node with existing queues
</A></li>
	<LI>Next message: <A HREF="029956.html">[rabbitmq-discuss] Channel storms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29898">[ date ]</a>
              <a href="thread.html#29898">[ thread ]</a>
              <a href="subject.html#29898">[ subject ]</a>
              <a href="author.html#29898">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
