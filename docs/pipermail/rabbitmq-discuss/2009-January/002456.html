<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ timing out under small load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20timing%20out%20under%20small%20load&In-Reply-To=49652C31.5000608%40cohesiveft.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002455.html">
   <LINK REL="Next"  HREF="002457.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ timing out under small load</H1>
    <B>gfodor</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20timing%20out%20under%20small%20load&In-Reply-To=49652C31.5000608%40cohesiveft.com"
       TITLE="[rabbitmq-discuss] RabbitMQ timing out under small load">gfodor at gmail.com
       </A><BR>
    <I>Wed Jan  7 22:56:04 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002455.html">[rabbitmq-discuss] RabbitMQ timing out under small load
</A></li>
        <LI>Next message: <A HREF="002457.html">[rabbitmq-discuss] RabbitMQ timing out under small load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2456">[ date ]</a>
              <a href="thread.html#2456">[ thread ]</a>
              <a href="subject.html#2456">[ subject ]</a>
              <a href="author.html#2456">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> Do you see timeouts in rabbit.log on the instance which had many
</I>connections during the 
&gt;<i> incident, on the instance which had almost no connections during the
</I>&gt;<i> incident, or on both?
</I>
There are timeouts on both machines, unfortunately.

&gt;<i> How many connections does each broker have right now?
</I>There's 3 on one and about 7 on the other, they're theoretically supposed to
be even but in practice it's just spread over the two of them round robin. 

&gt;<i> Essentially, I think we can get some useful insight into the problem if we
</I>&gt;<i> understand why 
</I>&gt;<i> one node during the incident had no connections and another had all of
</I>&gt;<i> them (provided this 
</I>&gt;<i> is not how you guys usually run it).
</I>I agree -- the problem is I vaguely only remember running list_connections
once or twice, the second node always was empty and the first node had 2 or
3 connections. Basically it may or may not have been a coincedence, since
both nodes may have been dropping connections but I snapshotted the thing
using list_connections at a point in time where it just so happened the
second node had none. In hindsight I wish I had done a better job of
monitoring the connections to see if the first node was behaving more sane. 

That said, I was having connectivity problems on both of them for sure, from
running consumers through list_queues. At the end of the day the thing I
would have been able to determine is basically if one node was dropping them
less frequently than others (ie, node 2 may have just simply been
terminating them upon connection, whereas the other one may only have
terminated them once the connection tried to access a queue on node 2.)

&gt;<i> Also, to confirm info from your original report: you saw the problem was
</I>&gt;<i> resolved when you 
</I>&gt;<i> attached a consumer to 2 non-important queues and drained them by
</I>&gt;<i> consuming all messages 
</I>&gt;<i> from them. Did you do it on the node with connections or node without
</I>&gt;<i> connections, and on 
</I>&gt;<i> which nodes did those queues live?
</I>Honestly I am not sure where the queues lived, since I don't think RabbitMQ
can really tell you directly. We basically created them round robin on the
machines before bringing the system up. 

I was not able to drain them by performing get operations due to the
constant timeouts and the fact that the get operations were taking 2-3
seconds a piece. I ended up fixing it by performing a delete queue
operations and then creating the queue over again.

I should have done a bit more documentation of the incident, in retrospect
there's basically some semi-conclusive evidence that it was a single node
breaking and contraevidence that it was a cluster wide phenomenon. For
example, I seem to recall trying to drain the queues first (by basilally
just calling get a number of times), and it seemed that if I went through
the second node I was unable to get anywhere (no get operations ever
completed) but if i went through the first node I could perform get
operations, albeit at a 2-3 second pace. That makes me feel like it was a
node acting weird but it was having an effect on the entire cluster. Next
time this happens (hopefully never) I will try removing the node that
appears to be the troublesome node from the cluster and see if things
improve. 

Here's a potentially more productive question: if I am able to get to the
point where I am sure that rabbitMQ is causing the problem and not some
external TCP factors, is there any other way to see what RabbitMQ is doing
internally other than by looking at the log? 

-- 
View this message in context: <A HREF="http://www.nabble.com/RabbitMQ-timing-out-under-small-load-tp21315520p21342279.html">http://www.nabble.com/RabbitMQ-timing-out-under-small-load-tp21315520p21342279.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002455.html">[rabbitmq-discuss] RabbitMQ timing out under small load
</A></li>
	<LI>Next message: <A HREF="002457.html">[rabbitmq-discuss] RabbitMQ timing out under small load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2456">[ date ]</a>
              <a href="thread.html#2456">[ thread ]</a>
              <a href="subject.html#2456">[ subject ]</a>
              <a href="author.html#2456">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
