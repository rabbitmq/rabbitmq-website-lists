<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ timing out under small load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20timing%20out%20under%20small%20load&In-Reply-To=4963B27C.2060407%40cohesiveft.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002429.html">
   <LINK REL="Next"  HREF="002432.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ timing out under small load</H1>
    <B>gfodor</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20timing%20out%20under%20small%20load&In-Reply-To=4963B27C.2060407%40cohesiveft.com"
       TITLE="[rabbitmq-discuss] RabbitMQ timing out under small load">gfodor at gmail.com
       </A><BR>
    <I>Tue Jan  6 20:21:56 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002429.html">[rabbitmq-discuss] RabbitMQ timing out under small load
</A></li>
        <LI>Next message: <A HREF="002432.html">[rabbitmq-discuss] RabbitMQ timing out under small load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2431">[ date ]</a>
              <a href="thread.html#2431">[ thread ]</a>
              <a href="subject.html#2431">[ subject ]</a>
              <a href="author.html#2431">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hey Dmitriy,

&gt;<i> Was there anything to suggest overall network latency or connection
</I>&gt;<i> timeouts or connection 
</I>&gt;<i> issues to other services running on the hosts where rabbitmq was running?
</I>&gt;<i> In other words, 
</I>&gt;<i> is it possible that the issues were related to the host and/or OS?
</I>
No, I was ssh'ed in and there was no odd latency on my connection.
Additionally, the rabbitmqctl list_queues command was timing out, so I'm
pretty sure it wasn't some external network latency. Beyond that, as soon as
I purged the larger queues the problem fixed itself so it definitely seemed
coupled with the backlogged queues. To purge the queues I basically just
deleted them and re-created them using the java client API.

&gt;<i> Also, to confirm, you are running 2 rabbitmq brokers on 2 different EC2
</I>&gt;<i> instances (1 
</I>&gt;<i> broker per instance) and the problem happened on both instances, both
</I>&gt;<i> brokers at the same 
</I>&gt;<i> time and brokers are not in a rabbitmq cluster, right?
</I>
Yes, they are on two instances but they are in fact clustered. Now that you
mention it, I remember that one of the nodes seemed to have no connections
to it while the other had a handful -- I also noticed that one node was more
responsive than the other. I'm wondering if perhaps it was a node-localized
issue but the effects were propagated due to the clustering?

&gt;<i> Can you replay your deployment scenario (maybe not in production, of
</I>&gt;<i> course) and check if 
</I>&gt;<i> you get the same problem? Alternatively, if I were to recreate an edge
</I>&gt;<i> case of your 
</I>&gt;<i> scenario, I assume I'll need N producers sending messages with size=1K to
</I>&gt;<i> the same queue 
</I>&gt;<i> (say amq.direct exchange, routing_key=foo) at aggregate rate 60 messages
</I>&gt;<i> per second for 1 
</I>&gt;<i> hour without consuming, and the expected result is that broker will enter
</I>&gt;<i> the bad state? 
</I>&gt;<i> What value corresponds to N in your situation?
</I>
The number at the time of the failure were that we had approximately 100k
items in aggregate in the queues and the total amount of data on disk was
50MB across both nodes, so the average message size was probably between 512
bytes and 1024 bytes. There were 5 producers running at the time -- once the
problems started occuring we noticed that the producers were still getting
messages through (the client library we wrote does a retry with a buffer of
pending messages) but they were trickling in at a much lower rate than
normal. (5-10 tps instead of 40-60.) 

Which version of rabbitmq were you running and on which erlang?

1.5.0/R11B

&gt;<i> Did you have a chance to capture any system runtime info (netstat,
</I>&gt;<i> tcpdump, etc) while 
</I>&gt;<i> this was happening?
</I>
Unfortunately not, I'm not a sysadmin wiz so I'm not positive how to grab
this type of TCP info.

Thanks again!
-- 
View this message in context: <A HREF="http://www.nabble.com/RabbitMQ-timing-out-under-small-load-tp21315520p21318246.html">http://www.nabble.com/RabbitMQ-timing-out-under-small-load-tp21315520p21318246.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002429.html">[rabbitmq-discuss] RabbitMQ timing out under small load
</A></li>
	<LI>Next message: <A HREF="002432.html">[rabbitmq-discuss] RabbitMQ timing out under small load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2431">[ date ]</a>
              <a href="thread.html#2431">[ thread ]</a>
              <a href="subject.html#2431">[ subject ]</a>
              <a href="author.html#2431">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
