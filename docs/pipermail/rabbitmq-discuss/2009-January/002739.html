<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Channel Cost
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Channel%20Cost&In-Reply-To=05C03F18-72E2-4969-A0D4-5E67C11C7BCA%40pobox.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002733.html">
   <LINK REL="Next"  HREF="002732.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Channel Cost</H1>
    <B>Ben Hyde</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Channel%20Cost&In-Reply-To=05C03F18-72E2-4969-A0D4-5E67C11C7BCA%40pobox.com"
       TITLE="[rabbitmq-discuss] Channel Cost">bhyde at pobox.com
       </A><BR>
    <I>Wed Jan 28 01:01:49 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002733.html">[rabbitmq-discuss] Channel Cost
</A></li>
        <LI>Next message: <A HREF="002732.html">[rabbitmq-discuss] Channel Cost
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2739">[ date ]</a>
              <a href="thread.html#2739">[ thread ]</a>
              <a href="subject.html#2739">[ subject ]</a>
              <a href="author.html#2739">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The code below has a flaw.  It worked only by virtue of dumb luck.
The ping should be changed to check for an exchange your sure
exists.  Passive is spec'd to close the connection if the exchange
doesn't exist (which RANDOMTEXT doesn't).  That failure is masked
in the example because the err. r. the bogus exchange came first.

On Jan 27, 2009, at 3:54 PM, Ben Hyde wrote:

&gt;<i>
</I>&gt;<i> On Jan 27, 2009, at 2:34 PM, Jason J. W. Williams wrote:
</I>&gt;&gt;<i> Hi Barry,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> chan_send
</I>&gt;&gt;<i> .basic_publish
</I>&gt;&gt;<i> (msg,exchange=args.exchange,routing_key=args.routing_key)
</I>&gt;&gt;<i> to an exchange that doesn't exist.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sometime ago, as Dmitriy had pointed out, Matthias suggested that a
</I>&gt;<i> synchronous call to RabbitMQ is a good way to see if it has consumed
</I>&gt;<i> the frames we previously dispatched to it.  And presumably that also
</I>&gt;<i> allows amqplib a chance to see any errors that consumption sent back.
</I>&gt;<i> Dmitriy suggested using declare_exchange as possible choice for a
</I>&gt;<i> synchronous call to the broker, and Matthias made some other
</I>&gt;<i> suggestions.
</I>&gt;<i>
</I>&gt;<i> So in the following ping_channel does a meaningless exchange_declare.
</I>&gt;<i>
</I>&gt;<i> Jason's example of how to get basic_publish to have an error:
</I>&gt;<i>
</I>&gt;<i> On Jan 27, 2009, at 2:34 PM, Jason J. W. Williams wrote:
</I>&gt;&gt;<i> ...chan_send
</I>&gt;&gt;<i> .basic_publish
</I>&gt;&gt;<i> (msg,exchange=args.exchange,routing_key=args.routing_key)
</I>&gt;&gt;<i> to an exchange that doesn't exist. ..
</I>&gt;<i>
</I>&gt;<i> So the following code does that, followed by calling ping_channel.
</I>&gt;<i> The transcript below shows amqplib reporting the error as soon as it
</I>&gt;<i> reads off that the channel is closing.
</I>&gt;<i>
</I>&gt;<i> The source:
</I>&gt;<i>
</I>&gt;<i> #!/usr/bin/env python
</I>&gt;<i> import amqplib.client_0_8 as amqp
</I>&gt;<i> import logging
</I>&gt;<i> from os import environ
</I>&gt;<i>
</I>&gt;<i> def ping_channel(channel):
</I>&gt;<i>     channel.exchange_declare(&quot;RANDOMTEXT&quot;,type='topic', passive=True)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> if __name__ == '__main__':
</I>&gt;<i>     logger = logging.getLogger('amqplib')
</I>&gt;<i>     logger.addHandler(logging.StreamHandler())
</I>&gt;<i>     logger.setLevel(logging.DEBUG)
</I>&gt;<i>     def trace(m): logger.debug('TRACE: ' + m)
</I>&gt;<i>     vhost=environ.get('AMQP_USERID','/')
</I>&gt;<i>     trace('create connection')
</I>&gt;<i>     connection = conn =
</I>&gt;<i> amqp.Connection(environ.get('AMQP_SERVER','localhost'),
</I>&gt;<i>
</I>&gt;<i> userid=environ.get('AMQP_USERID','guest'),
</I>&gt;<i>
</I>&gt;<i> password=environ.get('AMQP_USERID','guest'),
</I>&gt;<i>                                              virtual_host=vhost)
</I>&gt;<i>     trace('create channel')
</I>&gt;<i>     channel = connection.channel()
</I>&gt;<i>     trace('access_request')
</I>&gt;<i>     channel.access_request(vhost, active=True, write=True)
</I>&gt;<i>     exchange_name = environ.get('AMQP_EXCHANGE','ampq.topic')
</I>&gt;<i> #    exchange = channel.exchange_declare(exchange_name,
</I>&gt;<i> #
</I>&gt;<i> environ.get('AMQP_EXCHANGE_KIND','topic'))
</I>&gt;<i>     trace('make message')
</I>&gt;<i>     msg = amqp.Message(&quot;Hi there&quot;, content_type='text/plain')
</I>&gt;<i>     trace('basic_publish')
</I>&gt;<i>     channel.basic_publish(msg, exchange_name,
</I>&gt;<i> routing_key=environ.get('AMQP_ROUTING_KEY',''))
</I>&gt;<i>     trace('ping')
</I>&gt;<i>     ping_channel(channel)
</I>&gt;<i>     trace('done')
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The transcript:
</I>&gt;<i> bash-3.2$ env - PATH=$PATH AMQP_SERVER=192.168.1.2 AMQP_EXCHANGE=bogus
</I>&gt;<i> bin/foo.py
</I>&gt;<i> TRACE: create connection
</I>&gt;&gt;<i> (10, 10): Connection.start
</I>&gt;<i> Start from server, version: 8.0, properties: {u'platform': 'Erlang/
</I>&gt;<i> OTP', u'product': 'RabbitMQ', u'version': '1.5.0', u'copyright':
</I>&gt;<i> 'Copyright (C) 2007-2009 LShift Ltd., Cohesive Financial Technologies
</I>&gt;<i> LLC., and Rabbit Technologies Ltd.', u'information': 'Licensed under
</I>&gt;<i> the MPL.  See <A HREF="http://www.rabbitmq.com/'},">http://www.rabbitmq.com/'},</A> mechanisms: ['PLAIN',
</I>&gt;<i> 'AMQPLAIN'], locales: ['en_US']
</I>&gt;<i> &lt; (10, 11): Connection.start_ok
</I>&gt;&gt;<i> (10, 30): Connection.tune
</I>&gt;<i> &lt; (10, 31): Connection.tune_ok
</I>&gt;<i> &lt; (10, 40): Connection.open
</I>&gt;&gt;<i> (10, 41): Connection.open_ok
</I>&gt;<i> Open OK! known_hosts [elm.cozy.org:5672]
</I>&gt;<i> TRACE: create channel
</I>&gt;<i> using channel_id: 1
</I>&gt;<i> &lt; (20, 10): Channel.open
</I>&gt;&gt;<i> (20, 11): Channel.open_ok
</I>&gt;<i> Channel open
</I>&gt;<i> TRACE: access_request
</I>&gt;<i> &lt; (30, 10): Channel.access_request
</I>&gt;&gt;<i> (30, 11): Channel.access_request_ok
</I>&gt;<i> TRACE: make message
</I>&gt;<i> TRACE: basic_publish
</I>&gt;<i> &lt; (60, 40): Channel.basic_publish
</I>&gt;<i> TRACE: ping
</I>&gt;<i> &lt; (40, 10): Channel.exchange_declare
</I>&gt;&gt;<i> (20, 40): Channel.close
</I>&gt;<i> &lt; (20, 41): Channel.close_ok
</I>&gt;<i> Closed channel #1
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>   File &quot;bin/foo.py&quot;, line 34, in &lt;module&gt;
</I>&gt;<i>     ping_channel(channel)
</I>&gt;<i>   File &quot;bin/foo.py&quot;, line 8, in ping_channel
</I>&gt;<i>     channel.exchange_declare(&quot;RANDOMTEXT&quot;,type='topic', passive=True)
</I>&gt;<i>   File &quot;/opt/local/lib/python2.5/site-packages/amqplib/
</I>&gt;<i> client_0_8.py&quot;, line 1814, in exchange_declare
</I>&gt;<i>     (40, 11),    # Channel.exchange_declare_ok
</I>&gt;<i>   File &quot;/opt/local/lib/python2.5/site-packages/amqplib/
</I>&gt;<i> client_0_8.py&quot;, line 203, in wait
</I>&gt;<i>     return self._dispatch(method_sig, args, content)
</I>&gt;<i>   File &quot;/opt/local/lib/python2.5/site-packages/amqplib/
</I>&gt;<i> client_0_8.py&quot;, line 115, in _dispatch
</I>&gt;<i>     return amqp_method(self, args)
</I>&gt;<i>   File &quot;/opt/local/lib/python2.5/site-packages/amqplib/
</I>&gt;<i> client_0_8.py&quot;, line 1244, in _close
</I>&gt;<i>     raise AMQPChannelException(reply_code, reply_text, (class_id,
</I>&gt;<i> method_id))
</I>&gt;<i> amqplib.client_0_8.AMQPChannelException: (404, u&quot;NOT_FOUND - no
</I>&gt;<i> exchange 'bogus' in vhost '/'&quot;, (60, 40), 'Channel.basic_publish')
</I>&gt;<i> bash-3.2$
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002733.html">[rabbitmq-discuss] Channel Cost
</A></li>
	<LI>Next message: <A HREF="002732.html">[rabbitmq-discuss] Channel Cost
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2739">[ date ]</a>
              <a href="thread.html#2739">[ thread ]</a>
              <a href="subject.html#2739">[ subject ]</a>
              <a href="author.html#2739">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
