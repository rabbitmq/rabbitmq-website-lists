<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problems With OCF Script - Race between start and wait
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problems%20With%20OCF%20Script%20-%20Race%20between%0A%20start%20and%20wait&In-Reply-To=%3C20110509155434.GG32738%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012748.html">
   <LINK REL="Next"  HREF="012758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problems With OCF Script - Race between start and wait</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problems%20With%20OCF%20Script%20-%20Race%20between%0A%20start%20and%20wait&In-Reply-To=%3C20110509155434.GG32738%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Problems With OCF Script - Race between start and wait">matthew at rabbitmq.com
       </A><BR>
    <I>Mon May  9 16:54:34 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012748.html">[rabbitmq-discuss] Problems With OCF Script - Race between start and wait
</A></li>
        <LI>Next message: <A HREF="012758.html">[rabbitmq-discuss] Problems With OCF Script - Race between start and wait
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12749">[ date ]</a>
              <a href="thread.html#12749">[ thread ]</a>
              <a href="subject.html#12749">[ subject ]</a>
              <a href="author.html#12749">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Chris,

On Fri, May 06, 2011 at 04:27:40PM +0000, Chris Chew wrote:
&gt;<i> Doing some testing on 2.4.1 towards upgrading from 2.2, I've noticed an odd behavior when using the OCF scripts to start Rabbit ala the Pacemaker guide.
</I>&gt;<i> 
</I>&gt;<i> There seems to be a race condition in the time I call `rabbitmq-server...` and then call `rabbitmqctl -n &lt;host&gt; wait`:  If the erlang node hasn't started up yet, then `rabbitmqctl -n &lt;host&gt; wait` will fail saying the node is down.  This failure causes the OCF process to fail and then falsely report that Rabbit is not running (rabbit still starts up just fine).
</I>&gt;<i> 
</I>&gt;<i> I fixed this temporarily on my installation by adding `sleep 2` in the rabbit_start() method of the rabbitmq-server OCF script between the lines where the server is started and the rabbit_wait function is invoked.
</I>&gt;<i> 
</I>&gt;<i> Interesting, and this through off the path for a while, the race condition is only lost when I install the management plugin &amp;&amp; set mnesia_base to a shared (network-attached) volume.  Just one or the other is not enough to lose the race, but both are.  This might also helps explain why this might not have been seen before.
</I>
Having thought about this some more, I'm now puzzled. ctl -n &lt;host&gt; wait
should wait for a minimum of 5 seconds before giving up on the host.
This should be enough time for the rabbit erlang node to start (if not
fully boot). As long as the erlang node is contactable in some form
within 5 seconds then the wait will then wait forever for the erlang
node to fully boot and then report if rabbit's managed to start up ok or
not.

What you're reporting seems to be the inverse: i.e. if the server starts
too quickly then you encounter a problem.

Could you clarify?

Matthew
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012748.html">[rabbitmq-discuss] Problems With OCF Script - Race between start and wait
</A></li>
	<LI>Next message: <A HREF="012758.html">[rabbitmq-discuss] Problems With OCF Script - Race between start and wait
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12749">[ date ]</a>
              <a href="thread.html#12749">[ thread ]</a>
              <a href="subject.html#12749">[ subject ]</a>
              <a href="author.html#12749">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
