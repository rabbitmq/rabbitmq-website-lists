<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] WG:  Message Aggregating Queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20WG%3A%20%20Message%20Aggregating%20Queue&In-Reply-To=%3C9C37154E143FE14CBA656B2D2232745F080CACC1E145%40popeye.gebaschtel.bnet%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012671.html">
   <LINK REL="Next"  HREF="012646.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] WG:  Message Aggregating Queue</H1>
    <B>Josh Geisser</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20WG%3A%20%20Message%20Aggregating%20Queue&In-Reply-To=%3C9C37154E143FE14CBA656B2D2232745F080CACC1E145%40popeye.gebaschtel.bnet%3E"
       TITLE="[rabbitmq-discuss] WG:  Message Aggregating Queue">josh at gebaschtel.ch
       </A><BR>
    <I>Tue May  3 06:26:31 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012671.html">[rabbitmq-discuss] Reconnect logic for C library
</A></li>
        <LI>Next message: <A HREF="012646.html">[rabbitmq-discuss] WG: Message Aggregating Queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12645">[ date ]</a>
              <a href="thread.html#12645">[ thread ]</a>
              <a href="subject.html#12645">[ subject ]</a>
              <a href="author.html#12645">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Let me quickly try to understand that:

You want to get the most accurate instrument-data. As long as you're not overloaded, the sequential message processing is fine (queue size &lt;=1). The Problem occurs if you can't keep up with the producers (&gt;1). Then you have the case of consuming <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">UBS at 12.3</A> although the very latest information (12.8) is already in the queue, but not yet processed, right?

A na&#239;ve way to overcome that would be a Stack/FILO instead of a queue, not? Instead of consuming the next message, you'd consume the most recent one.
This way you get 12.8 before 12.3.

Of coarse this imposes that you have to take care of which tick is which (they are time stamped, not?) when you working down the stack. 

The further problem of starving messages could be reduced if the broker could kind of match and remove out-dated messages on a same pattern.

afaik not possible with rabbit :(

My 2 cents :)

Cheers
Josh


-----Urspr&#252;ngliche Nachricht-----
Von: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A> [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>] Im Auftrag von Jason Zaugg
Gesendet: Donnerstag, 28. April 2011 16:18
An: Irmo Manie
Cc: Alexis Richardson; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Betreff: Re: [rabbitmq-discuss] Message Aggregating Queue

On Thu, Apr 28, 2011 at 3:44 PM, Irmo Manie &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irmo.manie at gmail.com</A>&gt; wrote:
&gt;<i> The problem is actually a bit more tricky than this. When it comes to
</I>&gt;<i> market data you would route all the data to a client specific
</I>&gt;<i> exclusive queue based on a subscription because every client has its
</I>&gt;<i> own authorization, authentication and quality of service. (real-time,
</I>&gt;<i> delayed, only eu stocks, tick by tick, tick only every minute, etc,
</I>&gt;<i> etc).
</I>
But each client specific queue could implement the 'obsolete tick'
discarding in the broker, right?

&gt;<i> So the easy way is still just to have the consumer do the filtering
</I>&gt;<i> itself by storing all messages in a key value store and empty this
</I>&gt;<i> based on a ordered queue of ids to process.
</I>&gt;<i> That way the consumer can 'consume' as fast as it can put the values
</I>&gt;<i> in the K/V store which probably always is fast enough :-)
</I>
I would feel more comfortable knowing that the number of messages in
the broker is naturally bounded, even if the consumer misbehaves. It
would also be nice to have the possibility to have a pool of consumers
processing from a single queue, be able to restart the consumers
without losing unprocessed messages etc. Anyway, we should discuss
this some more internally; as always these sort of cats are amenable
to being skinned in multitude of ways :)

&gt;<i> Only if you can process the data (ticks) independently from each other
</I>&gt;<i> it makes sense to have this filtering on the broker because then it
</I>&gt;<i> would be useful for a cluster of consumers apps processing the data.
</I>&gt;<i> But 9 out of 10 times you need the ticks of more than one instrument
</I>&gt;<i> to do your business logic so you'd already keep a cache with the last
</I>&gt;<i> values anyway.
</I>
&gt;<i> Still there could be other usecases of course where having this
</I>&gt;<i> functionality at the broker can be really useful and powerful.
</I>
&gt;<i> /2cents
</I>
And well worth both of them :)

-jason
_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>


-----Urspr&#252;ngliche Nachricht-----

Among other things, we're using RabbitMQ to distribute market data ticks. The interesting characteristic about this stream of messages is that a new tick for a obsoletes previous, unprocessed, ticks for the same stock.

After a little brainstorming last night with Alvaro Videla, I'm curious to discuss how this could be modeled with an extension to RabbitMQ.

It seems a similar problem to the Queue Based TTL [1], however TTL isn't quite right for this case, as the validity period of a tick depends on the liquidity of the stock. We really just want the
*latest* tick.

Assume a message stream:

1. Tick { stock = &quot;UBS&quot;, bid = 12.3 }   RK=&quot;tick.UBS&quot;
2. Tick { stock = &quot;ABB&quot;, bid = 15.3 }  RK=&quot;tick.ABB&quot;
3. Tick { stock = &quot;UBS&quot;, bid = 12.28 } RK=&quot;tick.UBS&quot;

These are sent to a fanout exchange, and on to a queue(s) for a Consumer(s). Assume that consumer is slow, and the messages are not processed immediately. Rather than just en queuing message #3, I would like to insert it in place of message #1.

This has the nice property that the broker won't overrun with messages if the consumer can't keep up; and that the consumer doesn't do work that is obsolete.

What would be the suitable way to identify that #1 and #3 refer to the same stock? Is the routing key of message #1 retained after it has been en queued?

An generalization of this would be to provide a function that takes the old and new message and combines them into an aggregated message.
For example, we might want to track the latest, min and max:

  AggregatedTick { stock = &quot;UBS&quot;, latestBid = 12.28 minBid=12.28 maxBid=12.30 }

So, does this sound sensible and possible?

-jason

[1] <A HREF="http://www.rabbitmq.com/extensions.html#queue-ttl">http://www.rabbitmq.com/extensions.html#queue-ttl</A>
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012671.html">[rabbitmq-discuss] Reconnect logic for C library
</A></li>
	<LI>Next message: <A HREF="012646.html">[rabbitmq-discuss] WG: Message Aggregating Queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12645">[ date ]</a>
              <a href="thread.html#12645">[ thread ]</a>
              <a href="subject.html#12645">[ subject ]</a>
              <a href="author.html#12645">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
