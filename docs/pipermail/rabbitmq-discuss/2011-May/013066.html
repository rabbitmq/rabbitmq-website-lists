<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Perl%20Net%3A%3ARabbitMQ%20and%20failure%20conditions&In-Reply-To=%3CBANLkTimz4P1H%2BNgiAkdhQ_C3CNCjbmum7Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013046.html">
   <LINK REL="Next"  HREF="012941.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions</H1>
    <B>Ronald J Kimball</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Perl%20Net%3A%3ARabbitMQ%20and%20failure%20conditions&In-Reply-To=%3CBANLkTimz4P1H%2BNgiAkdhQ_C3CNCjbmum7Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions">rkimball at pangeamedia.com
       </A><BR>
    <I>Tue May 31 18:34:27 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013046.html">[rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions
</A></li>
        <LI>Next message: <A HREF="012941.html">[rabbitmq-discuss] RPC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13066">[ date ]</a>
              <a href="thread.html#13066">[ thread ]</a>
              <a href="subject.html#13066">[ subject ]</a>
              <a href="author.html#13066">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, thanks for the response.  Unfortunately, I haven't really found an
answer.

We upgraded RabbitMQ to 2.4.1, after which Net::RabbitMQ no longer hangs
when the remote server is up but the remote app is down.

However, Net::RabbitMQ still returns a false success when the remote server
or app goes down after the publisher connects to the local node.  (The queue
is located on the remote app.)

For now, we've switched to having a single node.  This decreases our
throughput slightly, but at least we don't risk dropping messages.

I think we must be doing something wrong, but I don't know what...

Ronald


On Tue, May 31, 2011 at 7:41 AM, Alexis Richardson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexis at rabbitmq.com</A>&gt;wrote:

&gt;<i> Ronald
</I>&gt;<i>
</I>&gt;<i> Were you able to find an answer to this?
</I>&gt;<i>
</I>&gt;<i> alexis
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, May 19, 2011 at 9:44 PM, Ronald J Kimball
</I>&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rkimball at pangeamedia.com</A>&gt; wrote:
</I>&gt;<i> &gt; I'm trying to understand how RabbitMQ behaves under failure conditions,
</I>&gt;<i> &gt; specifically when using the Net::RabbitMQ Perl module.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We have RabbitMQ set up with three nodes, one on the backend, which holds
</I>&gt;<i> &gt; the actual queues, and two on the frontend, which receive publish
</I>&gt;<i> requests.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; RabbitMQ 2.2.0
</I>&gt;<i> &gt; Net::RabbitMQ 0.1.8
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Below is the chart of behaviors that I have observed.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &quot;+&quot; means the behavior is as I expected: either the message is
</I>&gt;<i> successfully
</I>&gt;<i> &gt; queued, or an error is thrown.
</I>&gt;<i> &gt; &quot;-&quot; means the behavior is not as I expected, but can be managed:
</I>&gt;<i> &gt; specifically, the process receives a SIGPIPE, which I can trap and
</I>&gt;<i> recover
</I>&gt;<i> &gt; from.
</I>&gt;<i> &gt; &quot;!&quot; means the behavior is not as I expected, and cannot be managed: the
</I>&gt;<i> &gt; message is not queued but no error is thrown and/or the process hangs.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &quot;App down&quot; means I ran `rabbitmqctl stop_app`.  &quot;Daemon down&quot; means I ran
</I>&gt;<i> &gt; `rabbitmqctl stop`.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   As publishing process starts up:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Remote daemon up, app up
</I>&gt;<i> &gt;       + Everything okay
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Remote daemon up, app down
</I>&gt;<i> &gt;       ! Net::RabbitMQ hangs when declaring queue
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Remote daemon down
</I>&gt;<i> &gt;       + Net::RabbitMQ throws error when declaring queue
</I>&gt;<i> &gt;         &quot;Declaring queue: server channel error 404, message: NOT_FOUND -
</I>&gt;<i> no
</I>&gt;<i> &gt; queue 'test' in vhost '/'&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Local daemon up, app down
</I>&gt;<i> &gt;       + Net::RabbitMQ throws error when connecting
</I>&gt;<i> &gt;         &quot;Opening socket: Connection refused&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Local daemon down
</I>&gt;<i> &gt;       + Net::RabbitMQ throws error when connecting
</I>&gt;<i> &gt;         &quot;Opening socket: Connection refused&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   After publishing process starts up:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Local app goes down
</I>&gt;<i> &gt;       - Process receives SIGPIPE
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Local daemon goes down
</I>&gt;<i> &gt;       - Process receives SIGPIPE
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Remote app goes down
</I>&gt;<i> &gt;       ! Net::RabbitMQ falsely indicates success when publishing, then
</I>&gt;<i> hangs
</I>&gt;<i> &gt; (in DESTROY?)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Remote daemon goes down
</I>&gt;<i> &gt;       ! Net::RabbitMQ falsely indicates success when publishing
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Local app goes down, comes back up
</I>&gt;<i> &gt;       - Process receives SIGPIPE
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Local daemon goes down, comes back up
</I>&gt;<i> &gt;       - Process receives SIGPIPE
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Remote app goes down, comes back up
</I>&gt;<i> &gt;       + Everything okay
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Remote daemon goes down, comes back up
</I>&gt;<i> &gt;       + Everything okay
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Have other people had these problems with Net::RabbitMQ?  Can we resolve
</I>&gt;<i> &gt; these issues by changing something in our RabbitMQ configuration?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; thanks,
</I>&gt;<i> &gt; Ronald
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; P.S. Here's my script.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #!/usr/local/bin/perl
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; use strict;
</I>&gt;<i> &gt; use warnings;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; use Net::RabbitMQ;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; $| = 1;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; $SIG{'PIPE'} = sub { die &quot;SIGPIPE\n&quot; };
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; my $mq = Net::RabbitMQ-&gt;new();
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; alarm(10);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; print &quot;Connecting\n&quot;;
</I>&gt;<i> &gt; $mq-&gt;connect('localhost', { user =&gt; 'engagement', password =&gt; '********'
</I>&gt;<i> })
</I>&gt;<i> &gt;   or die &quot;Can't connect to RabbitMQ\n&quot;;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; print &quot;Opening channel\n&quot;;
</I>&gt;<i> &gt; $mq-&gt;channel_open(1);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; print &quot;Declaring exchange\n&quot;;
</I>&gt;<i> &gt; $mq-&gt;exchange_declare(1, 'ee_exchange', { durable =&gt; 1 });
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; print &quot;Declaring queue\n&quot;;
</I>&gt;<i> &gt; $mq-&gt;queue_declare(1, 'test', { durable =&gt; 1 });
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; print &quot;Binding queue\n&quot;;
</I>&gt;<i> &gt; $mq-&gt;queue_bind(1, 'test', 'ee_exchange', 'ee_test');
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; alarm(0);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; print &quot;&gt; &quot;;
</I>&gt;<i> &gt; &lt;&gt;;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; alarm(10);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; print &quot;Publishing message\n&quot;;
</I>&gt;<i> &gt; my $rc =
</I>&gt;<i> &gt;   $mq-&gt;publish(1, 'ee_test', 'hello world!',
</I>&gt;<i> &gt;                { exchange =&gt; 'ee_exchange', mandatory =&gt; 1, immediate =&gt;
</I>&gt;<i> 0
</I>&gt;<i> &gt; },
</I>&gt;<i> &gt;                { delivery_mode =&gt; 2 });
</I>&gt;<i> &gt; print &quot;Result: $rc\n&quot;;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; __END__
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110531/d9ba7523/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110531/d9ba7523/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013046.html">[rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions
</A></li>
	<LI>Next message: <A HREF="012941.html">[rabbitmq-discuss] RPC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13066">[ date ]</a>
              <a href="thread.html#13066">[ thread ]</a>
              <a href="subject.html#13066">[ subject ]</a>
              <a href="author.html#13066">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
