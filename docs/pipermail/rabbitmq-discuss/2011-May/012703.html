<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Published message not queued after	publish-ok received when connection quickly closed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Published%20message%20not%20queued%20after%0A%09publish-ok%20received%20when%20connection%20quickly%20closed&In-Reply-To=%3Cyrv4coc3gt7bt.fsf%40dwragg.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012701.html">
   <LINK REL="Next"  HREF="012698.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Published message not queued after	publish-ok received when connection quickly closed</H1>
    <B>David Wragg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Published%20message%20not%20queued%20after%0A%09publish-ok%20received%20when%20connection%20quickly%20closed&In-Reply-To=%3Cyrv4coc3gt7bt.fsf%40dwragg.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] Published message not queued after	publish-ok received when connection quickly closed">david at rabbitmq.com
       </A><BR>
    <I>Fri May  6 12:08:22 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012701.html">[rabbitmq-discuss] Published message not queued after publish-ok received when connection quickly closed
</A></li>
        <LI>Next message: <A HREF="012698.html">[rabbitmq-discuss] JSON-RPC Channel Plugin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12703">[ date ]</a>
              <a href="thread.html#12703">[ thread ]</a>
              <a href="subject.html#12703">[ subject ]</a>
              <a href="author.html#12703">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; writes:
&gt;<i> On 05/05/11 22:33, Elias Levy wrote:
</I>&gt;&gt;<i> While writing some code using the Ruby AMQP gem against RabbitMQ, I've
</I>&gt;&gt;<i> noticed that if I publish a message and quickly close the connection,
</I>&gt;&gt;<i> even though I've received a publish-ok response from the server, the
</I>&gt;&gt;<i> message fails to be queued by the broker.
</I>&gt;<i>
</I>&gt;<i> I'm not at all familiar with the Ruby client, but I should point out
</I>&gt;<i> that unlike many of the other AMQP methods, basic.publish does not
</I>&gt;<i> have a corresponding basic.publish-ok method; it's always
</I>&gt;<i> asynchronous. So I imagine the post-publish callback fires
</I>&gt;<i> immediately.
</I>&gt;<i>
</I>&gt;<i> In order to be able to know when the broker has taken responsibility
</I>&gt;<i> for a message you can either wrap the publish in a transaction (when
</I>&gt;<i> you see tx.commit-ok you know the server has the message) or use the
</I>&gt;<i> rather more lightweight publish confirms:
</I>o&gt;
&gt;<i> <A HREF="http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/">http://www.rabbitmq.com/blog/2011/02/10/introducing-publisher-confirms/</A>
</I>
Another way to solve the problem is to do a synchronous AMQP method
rather than abruptly closing the connection.  If this the sync method
completes successfully, you can be sure that your published messages
have reached the broker (it doesn't give you all the guarantees of
transactions, but it is much lighter weight).

An easy way to do this with all versions of the AMQP gem (even 0.6.7) is
to use the AMQP#close callback.  E.g., add something like this to your
code:

  client.close { puts &quot;Closed ok&quot; ; EM.stop }

David

-- 
David Wragg
Staff Engineer, RabbitMQ
VMware, Inc.
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012701.html">[rabbitmq-discuss] Published message not queued after publish-ok received when connection quickly closed
</A></li>
	<LI>Next message: <A HREF="012698.html">[rabbitmq-discuss] JSON-RPC Channel Plugin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12703">[ date ]</a>
              <a href="thread.html#12703">[ thread ]</a>
              <a href="subject.html#12703">[ subject ]</a>
              <a href="author.html#12703">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
