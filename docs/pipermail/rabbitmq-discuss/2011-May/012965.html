<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] trying to figure out erlando
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20trying%20to%20figure%20out%20erlando&In-Reply-To=%3C20110523165122.GF5914%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012962.html">
   <LINK REL="Next"  HREF="012951.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] trying to figure out erlando</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20trying%20to%20figure%20out%20erlando&In-Reply-To=%3C20110523165122.GF5914%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] trying to figure out erlando">matthew at rabbitmq.com
       </A><BR>
    <I>Mon May 23 17:51:23 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012962.html">[rabbitmq-discuss] trying to figure out erlando
</A></li>
        <LI>Next message: <A HREF="012951.html">[rabbitmq-discuss] Memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12965">[ date ]</a>
              <a href="thread.html#12965">[ thread ]</a>
              <a href="subject.html#12965">[ subject ]</a>
              <a href="author.html#12965">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jon,

I'm afraid most of my replies on this thread have been riddled with
errors one way or another.

Firstly, error_t strips of the {ok, ...} in bind. So you should be
writing &quot;X &lt;- foo()&quot; rather than &quot;{ok, X} &lt;- foo()&quot;.

Secondly, you are right - it should be ErrorT:run(M), not error_t:run(M)
(I'm rapidly losing any enthusiasm for parameterised modules...).

Thirdly, if your function just returns 'ok' then you're in trouble as
each and every function must return something of the form {ok, X} or
{error, X}. So the amqp_channel:close(Chan) becomes a problem. About the
only way around is to change that to:

case amqp_channel:close(Chan) of
    ok  -&gt; return(ok);
    Err -&gt; fail(Err)
end

Fourthly (slight repeat of 1st point), don't match {ok, X} against a
return - again, the {ok,..} gets stripped.

So, in summary, I think you want:

ErrorT = error_t:new(identity_m),
M = do([ErrorT ||
        Chan &lt;- amqp_connection:open_channel(AMQP),
        Resp &lt;- return(Publish(Channel)),
        case amqp_channel:close(Channel) of
            ok           -&gt; return(ok);
            {error, Err} -&gt; fail(Err)
        end,
        Resp]),
ErrorT:run(M).

I *think* that should work!

Matthew
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012962.html">[rabbitmq-discuss] trying to figure out erlando
</A></li>
	<LI>Next message: <A HREF="012951.html">[rabbitmq-discuss] Memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12965">[ date ]</a>
              <a href="thread.html#12965">[ thread ]</a>
              <a href="subject.html#12965">[ subject ]</a>
              <a href="author.html#12965">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
