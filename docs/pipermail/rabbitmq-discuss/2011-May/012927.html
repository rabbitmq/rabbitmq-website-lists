<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] exessive memory usage and blocked connection, even when no messages left
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20exessive%20memory%20usage%20and%20blocked%20connection%2C%0A%20even%20when%20no%20messages%20left&In-Reply-To=%3C4DD4E2BD.3050206%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012924.html">
   <LINK REL="Next"  HREF="012930.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] exessive memory usage and blocked connection, even when no messages left</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20exessive%20memory%20usage%20and%20blocked%20connection%2C%0A%20even%20when%20no%20messages%20left&In-Reply-To=%3C4DD4E2BD.3050206%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] exessive memory usage and blocked connection, even when no messages left">matthias at rabbitmq.com
       </A><BR>
    <I>Thu May 19 10:28:29 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012924.html">[rabbitmq-discuss] exessive memory usage and blocked connection, even when no messages left
</A></li>
        <LI>Next message: <A HREF="012930.html">[rabbitmq-discuss] exessive memory usage and blocked connection, even when no messages left
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12927">[ date ]</a>
              <a href="thread.html#12927">[ thread ]</a>
              <a href="subject.html#12927">[ subject ]</a>
              <a href="author.html#12927">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Theo,

On 19/05/11 06:35, Theo wrote:
&gt;<i> I rewrote my test code in Java, just to make sure there's nothing with
</I>&gt;<i> the Ruby driver that is causing the problem, here is the code:
</I>&gt;<i> <A HREF="https://gist.github.com/980238">https://gist.github.com/980238</A>
</I>&gt;<i>
</I>&gt;<i> I ran that with more or less the same result. After a few minutes at
</I>&gt;<i> 20K publishes/deliveries/acks per second the cluster rotted and all
</I>&gt;<i> connections got blocked. What's more, this time I saw that if I turned
</I>&gt;<i> off my producers the web UI still reported messages being published
</I>&gt;<i> for several minutes -- no producers were running (I'm absolutely sure
</I>&gt;<i> the processes were terminated) but there were still messages being
</I>&gt;<i> published.
</I>
The figure you see reported in the management UI is the rate at which 
rabbit processes these messages. The publisher code publishes messages 
as fast as it can, which is a far higher rate than rabbit can process 
them. Hence rabbit is buffering the messages in order to try to keep up. 
That way rabbit can handle brief periods of high publishing rate.

However, if publishing continues at a high rate then eventually the 
buffers fill up all memory. At that point rabbit blocks further 
publishes until the buffers have been drained sufficiently to allow 
publishing to resume. This can take a while since rabbit has to page the 
messages to disk in order to free up space.

Moreover, as soon as the publishers are unblocked, if they resume 
publishing at the high rate, as is the case in your test, the memory 
limit will be hit again quickly. Hence you will see rabbit &quot;bouncing off 
the limiter&quot;, where publishers get unblocked briefly and then blocked again.


This is all quite normal.


Regards,

Matthias.
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012924.html">[rabbitmq-discuss] exessive memory usage and blocked connection, even when no messages left
</A></li>
	<LI>Next message: <A HREF="012930.html">[rabbitmq-discuss] exessive memory usage and blocked connection, even when no messages left
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12927">[ date ]</a>
              <a href="thread.html#12927">[ thread ]</a>
              <a href="subject.html#12927">[ subject ]</a>
              <a href="author.html#12927">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
