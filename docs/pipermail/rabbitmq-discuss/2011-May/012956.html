<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] queue hands - timeout
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20queue%20hands%20-%20timeout&In-Reply-To=%3C6969F969-EE84-404C-A574-23D32631F5D7%40digitalriver.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012939.html">
   <LINK REL="Next"  HREF="012984.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] queue hands - timeout</H1>
    <B>Thomas Stagl</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20queue%20hands%20-%20timeout&In-Reply-To=%3C6969F969-EE84-404C-A574-23D32631F5D7%40digitalriver.com%3E"
       TITLE="[rabbitmq-discuss] queue hands - timeout">tstagl at digitalriver.com
       </A><BR>
    <I>Mon May 23 13:07:34 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012939.html">[rabbitmq-discuss] queue hands - timeout
</A></li>
        <LI>Next message: <A HREF="012984.html">[rabbitmq-discuss] queue hands - timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12956">[ date ]</a>
              <a href="thread.html#12956">[ thread ]</a>
              <a href="subject.html#12956">[ subject ]</a>
              <a href="author.html#12956">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Emile,

thanks a lot for your very quick reply. Please find enclosed the requested details

This morning I have seen a response on this mailing list, where I assume, that this could be the case:
&gt;&gt;<i> If you have a fast producer running constantly, accompanied by a slow consumer then the number of queued messages will grow. To prevent this from causing out of memory problems, Rabbit will throttle the producer once the memory high watermark is hit.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The throttling works by simply blocking the producer from sending any more data over the TCP socket. Once memory drops below the high watermark, due to the consumer catching up or messages being flushed to disk, the producer can send data again.
</I>
regards, tom

On May 20, 2011, at 1:02 PM, Emile Joubert wrote:

&gt;<i> Hi Thomas,
</I>&gt;<i> 
</I>&gt;<i> On 19/05/11 13:35, Thomas Stagl wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> we are running a queue in our test environment with different vhosts.
</I>&gt;&gt;<i> When we do a long running perf test, we recognise that the responses
</I>&gt;&gt;<i> from the queue are timing out and from that moment on, it is not
</I>&gt;&gt;<i> possible to connect to the queue again. Neither with the java lib
</I>&gt;&gt;<i> (which we use in our application) nor with celery (which I use for
</I>&gt;&gt;<i> testing purposes.)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> We have recognised that beam.smp is running on 30% CPU time from that
</I>&gt;&gt;<i> moment on.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> When we trace a connection, we see this with tcpdump: 12:23:52.700093
</I>&gt;&gt;<i> IP CLIENT.43248&gt;  RABBIT.amqp: Flags [P.], seq 2421288989:2421289002,
</I>&gt;&gt;<i> ack 2617563671, win 54, options [nop,nop,TS val 2047452 ecr
</I>&gt;&gt;<i> 1377663677], length 13 12:23:52.700124 IP RABBIT.amqp&gt;  CLIENT.43248:
</I>&gt;&gt;<i> Flags [.], ack 13, win 62, options [nop,nop,TS val 1377881158 ecr
</I>&gt;&gt;<i> 2047452], length 0
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> From that moment on, the connection is hanging.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> After a restart of the rabbitmq server, everything is running fine
</I>&gt;&gt;<i> again, for a certain amount of time.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> We also have a second test stack and we switched to the second
</I>&gt;&gt;<i> rabbitmq test server, same behaviour here. It worked fine and after a
</I>&gt;&gt;<i> couple of hours it stopped responding.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Any ideas? Any though about where we can start debugging would be
</I>&gt;&gt;<i> very much appreciated.
</I>&gt;<i> 
</I>&gt;<i> We have brokers that have been running for weeks without exhibiting the behaviour you describe. Can you help us to emulate your test environment more closely?
</I>&gt;<i> 
</I>&gt;<i> What version of Erlang, OS and rabbit are you using?
</I>RabbitMQ 2.3.1 / R14A running on Debian Squeeze

&gt;<i> What is the contents of the rabbit config file?
</I>We do not use the config file

&gt;<i> What exactly does the perf test doing?
</I>We are creating new users on our application and we issue the new profile to another application, we use the queue to send the message asynchronously.


&gt;<i> What is the rate and size of messsages, number of producers, consumers, are the messages persistent?
</I>&gt;<i> If you have the management plugin installed then a copy of the broker configuration may be useful.
</I>We use persistent queues and we send ~500 messages per second, there is one producer active and one consumer. Where the consumer is definitly much slower than the producer.
&gt;<i> 
</I>&gt;<i> Does rabbitmqctl still work when the problem occurs? The output of all the list_* commands at the time of failure will be useful.
</I>No, we can connect, but we can not send anything to the queue

&gt;<i> 
</I>&gt;<i> The broker logfile entries around the onset of the problem will also help.
</I>

&gt;<i> 
</I>&gt;<i> Were there any other applications running on the same OS as rabbit?
</I>No, there are no other applications running instead of rabbitmq
&gt;<i> 
</I>&gt;<i> Were the consumers (if any) keeping up with producers at or just before the onset of the problem?
</I>&gt;<i> 
</I>&gt;<i> What was the memory consumption reported by the management plugin at this time?
</I>1.6GB
&gt;<i> 
</I>&gt;<i> If you can help us to narrow this down to a specific set of conditions that reliably trigger the problem that will be a big step towards a solution.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i> Emile
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012939.html">[rabbitmq-discuss] queue hands - timeout
</A></li>
	<LI>Next message: <A HREF="012984.html">[rabbitmq-discuss] queue hands - timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12956">[ date ]</a>
              <a href="thread.html#12956">[ thread ]</a>
              <a href="subject.html#12956">[ subject ]</a>
              <a href="author.html#12956">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
