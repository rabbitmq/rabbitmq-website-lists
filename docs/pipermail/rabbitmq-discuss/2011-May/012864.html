<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Stress testing RabbitMQ
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stress%20testing%20RabbitMQ&In-Reply-To=%3C20110514113240.GB11419%40wellquite.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012863.html">
   <LINK REL="Next"  HREF="012865.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Stress testing RabbitMQ</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stress%20testing%20RabbitMQ&In-Reply-To=%3C20110514113240.GB11419%40wellquite.org%3E"
       TITLE="[rabbitmq-discuss] Stress testing RabbitMQ">matthew at rabbitmq.com
       </A><BR>
    <I>Sat May 14 12:32:41 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012863.html">[rabbitmq-discuss] Stress testing RabbitMQ
</A></li>
        <LI>Next message: <A HREF="012865.html">[rabbitmq-discuss] Stress testing RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12864">[ date ]</a>
              <a href="thread.html#12864">[ thread ]</a>
              <a href="subject.html#12864">[ subject ]</a>
              <a href="author.html#12864">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, May 14, 2011 at 01:07:49PM +0200, Alvaro Videla wrote:
&gt;<i> I tried creating an alternate_fanout exchange, storing the bindings in
</I>&gt;<i> a gb_tree, dicts, and plain lists&#8230; still I can see much improvement
</I>&gt;<i> compared to the default fanout exchange. My goal was to avoid the
</I>&gt;<i> mnesia:dirty_select() done at rabbit_router:match_routing_key.
</I>
Have you tried benchmarking mnesia:dirty_select? I think you'll find
it's actually pretty quick.

Also, in the context of a fanout exchange with many thousands of
bindings, you're basically going to be reading the entire binding table
anyway, so it make no difference whether you're able to use indices or
not.

Also rabbit_route is an orderedset table. The key of #route is #binding.
#binding is (obviously) just a tuple, and we fill as much as possible
from left to right in the tuple as the matchhead:

-record(binding, {source, key, destination, args = []}).

match_routing_key(SrcName, [RoutingKey]) -&gt;
    MatchHead = #route{binding = #binding{source      = SrcName,
                                          destination = '$1',
                                          key         = RoutingKey,
                                          _           = '_'}},

So we will have {binding, SrcName, RoutingKey, '$1', '_'} as the key to
query on an orderedset table. That's not inefficient.

mnesia:dirty_read is very fast indeed. Please benchmark it. I think
you'll find it's basically the same speed as ets:match_object which is
actually what it'll be doing under the bonnet.


I have not looked into your benchmark, however, what size msgs are you
using? I suspect that if the binary fragments end up under 64 bytes then
that is the cause of memory explosion: each msg is being _copied_ rather
than reference counted to each queue. If you try with msgs with a bigger
payload, I wonder whether you see the same behaviour.

Matthew
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012863.html">[rabbitmq-discuss] Stress testing RabbitMQ
</A></li>
	<LI>Next message: <A HREF="012865.html">[rabbitmq-discuss] Stress testing RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12864">[ date ]</a>
              <a href="thread.html#12864">[ thread ]</a>
              <a href="subject.html#12864">[ subject ]</a>
              <a href="author.html#12864">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
