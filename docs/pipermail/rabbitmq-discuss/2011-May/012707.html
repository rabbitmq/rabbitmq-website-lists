<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problems With OCF Script - Race between start	and wait
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problems%20With%20OCF%20Script%20-%20Race%20between%20start%0A%09and%20wait&In-Reply-To=%3C1C7E61787A08F34BBBBD9E7A7CBC368B0A2F848D%40EXMB02OSG.eclg.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012843.html">
   <LINK REL="Next"  HREF="012748.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problems With OCF Script - Race between start	and wait</H1>
    <B>Chris Chew</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problems%20With%20OCF%20Script%20-%20Race%20between%20start%0A%09and%20wait&In-Reply-To=%3C1C7E61787A08F34BBBBD9E7A7CBC368B0A2F848D%40EXMB02OSG.eclg.org%3E"
       TITLE="[rabbitmq-discuss] Problems With OCF Script - Race between start	and wait">chrisch at ecollege.com
       </A><BR>
    <I>Fri May  6 17:27:40 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012843.html">[rabbitmq-discuss] Best Practices using Connection and Channels
</A></li>
        <LI>Next message: <A HREF="012748.html">[rabbitmq-discuss] Problems With OCF Script - Race between start and wait
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12707">[ date ]</a>
              <a href="thread.html#12707">[ thread ]</a>
              <a href="subject.html#12707">[ subject ]</a>
              <a href="author.html#12707">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Everybody.

Doing some testing on 2.4.1 towards upgrading from 2.2, I've noticed an odd behavior when using the OCF scripts to start Rabbit ala the Pacemaker guide.

There seems to be a race condition in the time I call `rabbitmq-server...` and then call `rabbitmqctl -n &lt;host&gt; wait`:  If the erlang node hasn't started up yet, then `rabbitmqctl -n &lt;host&gt; wait` will fail saying the node is down.  This failure causes the OCF process to fail and then falsely report that Rabbit is not running (rabbit still starts up just fine).

I fixed this temporarily on my installation by adding `sleep 2` in the rabbit_start() method of the rabbitmq-server OCF script between the lines where the server is started and the rabbit_wait function is invoked.

Interesting, and this through off the path for a while, the race condition is only lost when I install the management plugin &amp;&amp; set mnesia_base to a shared (network-attached) volume.  Just one or the other is not enough to lose the race, but both are.  This might also helps explain why this might not have been seen before.

Anyways...does this seem plausible or am I just watching shadows on a cave wall, as it were?

Thanks!

Chris Chew
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012843.html">[rabbitmq-discuss] Best Practices using Connection and Channels
</A></li>
	<LI>Next message: <A HREF="012748.html">[rabbitmq-discuss] Problems With OCF Script - Race between start and wait
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12707">[ date ]</a>
              <a href="thread.html#12707">[ thread ]</a>
              <a href="subject.html#12707">[ subject ]</a>
              <a href="author.html#12707">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
