<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Occasional slow message on a local machine
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Occasional%20slow%20message%20on%20a%20local%20machine&In-Reply-To=%3C295CF69A-BD84-4080-BE4C-658DD4E98D55%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022290.html">
   <LINK REL="Next"  HREF="022303.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Occasional slow message on a local machine</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Occasional%20slow%20message%20on%20a%20local%20machine&In-Reply-To=%3C295CF69A-BD84-4080-BE4C-658DD4E98D55%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Occasional slow message on a local machine">watson.timothy at gmail.com
       </A><BR>
    <I>Thu Sep  6 09:17:02 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022290.html">[rabbitmq-discuss] Occasional slow message on a local machine
</A></li>
        <LI>Next message: <A HREF="022303.html">[rabbitmq-discuss] Occasional slow message on a local machine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22296">[ date ]</a>
              <a href="thread.html#22296">[ thread ]</a>
              <a href="subject.html#22296">[ subject ]</a>
              <a href="author.html#22296">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 5 Sep 2012, at 22:19, Brennan Sellner &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">bsellner at seegrid.com</A>&gt; wrote:

&gt;<i> My apologies for the long delay, but we have quite a bit more information available, after doing some extensive field testing.
</I>&gt;<i> 
</I>&gt;<i> We now return you to your thread already in progress...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> We've upgraded Rabbit to 2.8.6.  Erlang has not yet been upgraded, but will be in our next release cycle.  R12B-5.8 was the newest official build we could find that worked with Fedora 11; I've since been able to hand-build the latest Erlang release, but it's still working its way through our testing department.
</I>&gt;<i> 
</I>
R12 is really old and the general performance if the emulator has improved hugely since.

&gt;<i> We now have two different types of systems fielded, one where we're having issues with slow Rabbit operations, and one where we're not (or, at least any slow operations aren't slow enough to trigger our watchdogs).  The software configuration is identical between the two configurations.
</I>&gt;<i> 
</I>&gt;<i> #1: Problematic:
</I>&gt;<i>  - CPU: Core 2 Duo E7300 @ 2.66 GHz
</I>&gt;<i>  - RAM: 2 GB
</I>&gt;<i>  - Disk: SATA 3.0 Gb/s, 5400 RPM
</I>&gt;<i> 
</I>&gt;<i> #2: Working fine:
</I>&gt;<i>  - CPU: i5 M520 @ 2.4 GHz (2 cores + hyperthreading)
</I>&gt;<i>  - RAM: 4 GB
</I>&gt;<i>  - Disk: SATA 6.0 Gb/s, SSD
</I>&gt;<i> 
</I>&gt;<i> With #1, we're seeing the following librabbitmq-c functions occasionally take up to 7.28 seconds to return (3-4 seconds is much more common):
</I>&gt;<i>  - amqp_queue_declare
</I>&gt;<i>  - amqp_queue_bind
</I>&gt;<i>  - amqp_basic_consume
</I>&gt;<i> 
</I>
Can you ascertain how much of that time is spent is system calls waiting for the network?

&gt;<i> We don't have any persistent messages.  Queues are being declared with server-assigned names, passive is false, durable is false, exclusive is true, and auto-delete is true.  The consume calls use an empty consumer tag, set no-local to false, no-ack to false, and exclusive to false.
</I>&gt;<i> 
</I>&gt;<i> We've primarily observed this happening just after launching a new thread, which establishes a fresh connection to Rabbit successfully and quickly, but has issues when establishing its first subscription.  
</I>
You do know that librabbitmq-c is *not* thread safe, at least iirc!?

&gt;<i> This may be sampling bias, though, as our watchdogs are by chance mostly concentrated around new threads being launched.  The full sequence of librabbitmq-c calls in this case is:
</I>&gt;<i> 
</I>&gt;<i>  - amqp_new_connection
</I>&gt;<i>  - amqp_open_socket
</I>&gt;<i>  - amqp_set_sockfd
</I>&gt;<i>  - amqp_login
</I>&gt;<i>  - amqp_channel_open
</I>&gt;<i>  - amqp_basic_qos
</I>&gt;<i>  - amqp_channel_open  # For the new subscription
</I>&gt;<i>  - amqp_basic_qos
</I>&gt;<i>  - amqp_exchange_declare
</I>&gt;<i>  - amqp_queue_declare # Sometimes slow
</I>&gt;<i>  - amqp_queue_bind    # Sometimes slow
</I>&gt;<i>  - amqp_basic_consume # Sometimes slow
</I>&gt;<i> 
</I>&gt;<i> My suspicion is that Rabbit is hitting disk for some reason; we've seen I/O-related delays with other processes (e.g. sqlite) with configuration #1 that we don't see with #2.  The SSD may be enough faster that we don't notice the issue on configuration #2.
</I>&gt;<i> 
</I>
According to top output (below) that's not happening an rabbit will not page to disk without hitting the high memory watermark if your messages are non persistent.

&gt;<i> However, I don't see any reason that Rabbit would be hitting the disk.
</I>
Exactly.

&gt;<i> Once the problematic librabbitmq-c function times out, our code dumps `rabbitmqctl status` to disk.  To take a concrete example, amqp_queue_bind took 3.72 seconds to return.  When the dump ran two seconds later, it reported the below:
</I>&gt;<i> 
</I>&gt;<i> Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">AISINR4 at AISINR4</A>' ...
</I>&gt;<i> [{pid,1698},
</I>&gt;<i> {running_applications,[{rabbitmq_shovel,&quot;Data Shovel for RabbitMQ&quot;,&quot;2.8.6&quot;},
</I>&gt;<i>                        {erlando,&quot;Syntax extensions for Erlang&quot;,&quot;2.8.6&quot;},
</I>&gt;<i>                        {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;2.8.6&quot;},
</I>&gt;<i>                        {rabbit,&quot;RabbitMQ&quot;,&quot;2.8.6&quot;},
</I>&gt;<i>                        {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.1.8&quot;},
</I>&gt;<i>                        {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.5.4&quot;},
</I>&gt;<i>                        {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.4.7&quot;},
</I>&gt;<i>                        {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.15.5&quot;},
</I>&gt;<i>                        {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.12.5&quot;}]},
</I>&gt;<i> {os,{unix,linux}},
</I>&gt;<i> {erlang_version,&quot;Erlang (BEAM) emulator version 5.6.5 [source] [smp:2] [async-threads:30] [hipe] [kernel-poll:true]\n&quot;},
</I>&gt;<i> {memory,[{total,22599840},
</I>&gt;<i>          {processes,9909296},
</I>&gt;<i>          {processes_used,9706816},
</I>&gt;<i>          {system,12690544},
</I>&gt;<i>          {atom,782145},
</I>&gt;<i>          {atom_used,751012},
</I>&gt;<i>          {binary,650640},
</I>&gt;<i>          {code,6257852},
</I>&gt;<i>          {ets,4197052}]},
</I>&gt;<i> {vm_memory_high_watermark,0.4},
</I>&gt;<i> {vm_memory_limit,825982976},
</I>&gt;<i> {disk_free_limit,1000000000},
</I>&gt;<i> {disk_free,140100812800},
</I>&gt;<i> {file_descriptors,[{total_limit,924},
</I>&gt;<i>                    {total_used,17},
</I>&gt;<i>                    {sockets_limit,829},
</I>&gt;<i>                    {sockets_used,13}]},
</I>
Looking at fd volumes, I doubt the message store is writing to disk although I could be wrong.

&gt;<i> {processes,[{limit,1048576},{used,304}]},
</I>&gt;<i> {run_queue,0},
</I>&gt;<i> {uptime,2106}]
</I>&gt;<i> ...done.
</I>&gt;<i> 
</I>&gt;<i> It doesn't look like we're anywhere near the memory high watermark, nor are we stressing the system in terms of sockets or file handles.  We dumped the output of top at the same time, which indicates that we're not touching swap:
</I>&gt;<i> 
</I>&gt;<i> top - 05:18:56 up 35 min,  0 users,  load average: 3.85, 2.26, 1.79
</I>&gt;<i> Tasks:  97 total,   2 running,  95 sleeping,   0 stopped,   0 zombie
</I>&gt;<i> Cpu(s): 16.1%us, 10.2%sy,  0.0%ni, 69.2%id,  3.6%wa,  0.6%hi,  0.3%si, 0.0%st
</I>&gt;<i> Mem:   2016560k total,  1658564k used,   357996k free,   157468k buffers
</I>&gt;<i> Swap:  1023992k total,        0k used,  1023992k free,   787772k cached
</I>&gt;<i> 
</I>&gt;<i>  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND 
</I>&gt;<i> 1698 rabbitmq  20   0 79096  26m 2136 S  7.9  1.4   2:16.89 beam.smp 
</I>&gt;<i> 
</I>&gt;<i> There was nothing interesting in either of Rabbit's logs.
</I>&gt;<i> 
</I>
I wonder if this delay is happening in the client rather than the server. Does a standalone sample client with no threading take so lob to perform the basic operations?

&gt;&gt;<i> You might also be hitting flow control, but that is related to running out of
</I>&gt;&gt;<i> RAM.  
</I>
Um, isn't flow control actually about applying back pressure to producers when the system is overloaded? That sounds feasible and isn't afaict just about hitting ram limits.

&gt;&gt;<i> You can check that as well via the management plugin, the connections will
</I>&gt;&gt;<i> be marked as &quot;blocked&quot;.
</I>&gt;<i> 
</I>&gt;<i> `rabbitmqctl list_connections pid name last_blocked_by last_blocked_age` lists the last-blocked-age as infinity for all connections.  The management plugin is unfortunately not supported with the version of Erlang that we're using at the moment.
</I>&gt;<i> 
</I>&gt;<i> Anyone have any ideas about what might cause these random slow responses, or other data we can collect to help debug?  I'm rather baffled at the moment.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> -Brennan
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022290.html">[rabbitmq-discuss] Occasional slow message on a local machine
</A></li>
	<LI>Next message: <A HREF="022303.html">[rabbitmq-discuss] Occasional slow message on a local machine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22296">[ date ]</a>
              <a href="thread.html#22296">[ thread ]</a>
              <a href="subject.html#22296">[ subject ]</a>
              <a href="author.html#22296">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
