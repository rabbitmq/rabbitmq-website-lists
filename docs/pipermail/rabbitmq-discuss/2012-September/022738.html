<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Errors starting RabbitMQ when cluster membership	changes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Errors%20starting%20RabbitMQ%20when%20cluster%20membership%0A%09changes&In-Reply-To=%3CCACLE7iznHVn6b1Q9f%3DEGks64y2Hy4p17k8PMtT4JS6n_ORnc5A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022735.html">
   <LINK REL="Next"  HREF="022739.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Errors starting RabbitMQ when cluster membership	changes</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Errors%20starting%20RabbitMQ%20when%20cluster%20membership%0A%09changes&In-Reply-To=%3CCACLE7iznHVn6b1Q9f%3DEGks64y2Hy4p17k8PMtT4JS6n_ORnc5A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Errors starting RabbitMQ when cluster membership	changes">mpietrek at skytap.com
       </A><BR>
    <I>Fri Sep 28 20:23:38 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022735.html">[rabbitmq-discuss] pika 0.9.6 and Reconnection Strategies
</A></li>
        <LI>Next message: <A HREF="022739.html">[rabbitmq-discuss] Heartbeat -&gt; re-establish connection flow Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22738">[ date ]</a>
              <a href="thread.html#22738">[ thread ]</a>
              <a href="subject.html#22738">[ subject ]</a>
              <a href="author.html#22738">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In my environment, I have numerous RabbitMQ nodes for testing purposes, and
frequently changing around cluster configuration (e.g. which nodes are part
of a cluster).

Using 2.8.6 and subsequently 2.8.7 on Erlang R15B01, I've observed several
times recently where RabbitMQ has failed to start on a node. The reason
seems to be related to a node that is no longer part of the cluster.

For example, at one point I had a three node cluster: play, play2, and
util. I then removed util from the cluster, although to be honest, simply
by changing the rabbitmq.config file, rather than explicitly running
rabbitmqctl stop_app while the cluster is still running.

My steps:

   - Running as three node cluster, stop all brokers
   - Create a new rabbitmq.config file with just two brokers
   - Attempt to start the new cluster.


Here's my revised RabbitMQ config file. Note references to <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>,
which is no longer part of the cluster:
--------
[
{rabbit, [{cluster_nodes, [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at play2</A>]}, {disk_free_limit,
104857600}]},
{mnesia, [{debug, trace}]}
].
--------


The <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play.log</A> file:

=ERROR REPORT==== 28-Sep-2012::11:31:11 ===
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>): ** ERROR ** (core dumped to file:
&quot;/home/mpietrek/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">MnesiaCore.rabbit at play_1348_857071_113813</A>&quot;)
 ** FATAL ** Failed to merge schema: Bad cookie in table definition
mirrored_sup_childspec: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A> =
{cstruct,mirrored_sup_childspec,ordered_set,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at play2</A>
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at play</A>
],[],[],0,read_write,false,[],[],false,mirrored_sup_childspec,[key,mirroring_pid,childspec],[],[],[],{{1346,266106,862481}<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at play</A>
},{{4,0},{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>,{1348,781672,983885}}}}, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A> =
{cstruct,mirrored_sup_childspec,ordered_set,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>
],[],[],0,read_write,false,[],[],false,mirrored_sup_childspec,[key,mirroring_pid,childspec],[],[],[],{{1348,854318,794171}<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at util</A>
},{{2,0},[]}}


=ERROR REPORT==== 28-Sep-2012::11:31:21 ===
** Generic server mnesia_monitor terminating
** Last message in was {'EXIT',&lt;0.44.0&gt;,killed}
** When Server state == {state,&lt;0.44.0&gt;,[],[],true,[],undefined,[]}
** Reason for termination ==
** killed

=ERROR REPORT==== 28-Sep-2012::11:31:21 ===
** Generic server mnesia_recover terminating
** Last message in was {'EXIT',&lt;0.44.0&gt;,killed}
** When Server state ==
{state,&lt;0.44.0&gt;,undefined,undefined,undefined,0,false,
                               true,[]}
** Reason for termination ==
** killed

=ERROR REPORT==== 28-Sep-2012::11:31:21 ===
** Generic server mnesia_snmp_sup terminating
** Last message in was {'EXIT',&lt;0.44.0&gt;,killed}
** When Server state == {state,
                            {local,mnesia_snmp_sup},
                            simple_one_for_one,
                            [{child,undefined,mnesia_snmp_sup,
                                 {mnesia_snmp_hook,start,[]},
                                 transient,3000,worker,
                                 [mnesia_snmp_sup,mnesia_snmp_hook,
                                  supervisor]}],
                            undefined,0,86400000,[],mnesia_snmp_sup,[]}
** Reason for termination ==
** killed

=ERROR REPORT==== 28-Sep-2012::11:31:21 ===
** Generic server mnesia_subscr terminating
** Last message in was {'EXIT',&lt;0.44.0&gt;,killed}
** When Server state == {state,&lt;0.44.0&gt;,57361}
** Reason for termination ==
** killed

=INFO REPORT==== 28-Sep-2012::11:31:21 ===
    application: mnesia
    exited: {shutdown,{mnesia_sup,start,[normal,[]]}}
    type: permanent


And finally, the output from rabbitmq-server:

Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>): mnesia_late_loader starting: &lt;0.81.0&gt;
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>): Transaction {tid,21431,&lt;0.82.0&gt;} calling
#Fun&lt;mnesia_schema.42.93736344&gt; with [] failed:
 {aborted,{throw,[66,97,100,32,99,111,111,107,105,101,32,105,110,32,116,97,98,
                  108,101,32,100,101,102,105,110,105,116,105,111,110,32,
                  &quot;mirrored_sup_childspec&quot;,58,32,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>&quot;,32,61,32,
                  [123,

[&quot;cstruct&quot;,44,&quot;mirrored_sup_childspec&quot;,44,&quot;ordered_set&quot;,44,
                    [91,[&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>&quot;,44,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play2</A>&quot;,44,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>
&quot;],93],

44,&quot;[]&quot;,44,&quot;[]&quot;,44,&quot;0&quot;,44,&quot;read_write&quot;,44,&quot;false&quot;,44,&quot;[]&quot;,
                    44,&quot;[]&quot;,44,&quot;false&quot;,44,&quot;mirrored_sup_childspec&quot;,44,
                    [91,[&quot;key&quot;,44,&quot;mirroring_pid&quot;,44,&quot;childspec&quot;],93],
                    44,&quot;[]&quot;,44,&quot;[]&quot;,44,&quot;[]&quot;,44,
                    [123,
                     [[123,[&quot;1346&quot;,44,&quot;266106&quot;,44,&quot;862481&quot;],125],
                      44,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>&quot;],
                     125],
                    44,
                    [123,
                     [[123,[&quot;4&quot;,44,&quot;0&quot;],125],
                      44,
                      [123,
                       [&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>&quot;,44,
                        [123,[&quot;1348&quot;,44,&quot;781672&quot;,44,&quot;983885&quot;],125]],
                       125]],
                     125]],
                   125],
                  44,32,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>&quot;,32,61,32,
                  [123,

[&quot;cstruct&quot;,44,&quot;mirrored_sup_childspec&quot;,44,&quot;ordered_set&quot;,44,
                    [91,[&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>&quot;],93],

44,&quot;[]&quot;,44,&quot;[]&quot;,44,&quot;0&quot;,44,&quot;read_write&quot;,44,&quot;false&quot;,44,&quot;[]&quot;,
                    44,&quot;[]&quot;,44,&quot;false&quot;,44,&quot;mirrored_sup_childspec&quot;,44,
                    [91,[&quot;key&quot;,44,&quot;mirroring_pid&quot;,44,&quot;childspec&quot;],93],
                    44,&quot;[]&quot;,44,&quot;[]&quot;,44,&quot;[]&quot;,44,
                    [123,
                     [[123,[&quot;1348&quot;,44,&quot;854318&quot;,44,&quot;794171&quot;],125],
                      44,&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at util</A>&quot;],
                     125],
                    44,
                    [123,[[123,[&quot;2&quot;,44,&quot;0&quot;],125],44,&quot;[]&quot;],125]],
                   125],
                  &quot;\n&quot;]}}
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>): mnesia_monitor got FATAL ERROR from: &lt;0.81.0&gt;
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>): mnesia_subscr terminated: killed
{&quot;Kernel pid
terminated&quot;,application_controller,&quot;{application_start_failure,mnesia,{shutdown,{mnesia_sup,start,[normal,[]]}}}&quot;}

Crash dump was written to: erl_crash.dump
Kernel pid terminated (application_controller)
({application_start_failure,mnesia,{shutdown,{mnesia_sup,start,[normal,[]]}}})

Matt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120928/3464fc19/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120928/3464fc19/attachment.htm</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022735.html">[rabbitmq-discuss] pika 0.9.6 and Reconnection Strategies
</A></li>
	<LI>Next message: <A HREF="022739.html">[rabbitmq-discuss] Heartbeat -&gt; re-establish connection flow Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22738">[ date ]</a>
              <a href="thread.html#22738">[ thread ]</a>
              <a href="subject.html#22738">[ subject ]</a>
              <a href="author.html#22738">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
