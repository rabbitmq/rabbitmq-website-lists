<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] How to achieve HA consumers?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20to%20achieve%20HA%20consumers%3F&In-Reply-To=%3C201209051232051717314%40edocom.cn%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022282.html">
   <LINK REL="Next"  HREF="022269.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] How to achieve HA consumers?</H1>
    <B>johnson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20to%20achieve%20HA%20consumers%3F&In-Reply-To=%3C201209051232051717314%40edocom.cn%3E"
       TITLE="[rabbitmq-discuss] How to achieve HA consumers?">johnson at edocom.cn
       </A><BR>
    <I>Wed Sep  5 05:32:05 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022282.html">[rabbitmq-discuss] AWS clustering
</A></li>
        <LI>Next message: <A HREF="022269.html">[rabbitmq-discuss] How to achieve HA consumers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22265">[ date ]</a>
              <a href="thread.html#22265">[ thread ]</a>
              <a href="subject.html#22265">[ subject ]</a>
              <a href="author.html#22265">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Matthias and Francesco.

Your second approach is prefect and should work fine. I will choose this approach.

However, I have little concern about the first approach. The channel.queueDeclarePassive method returns the consumer count of the specified channel, but the total number of the consumers connected to the rabbitmq server. So if I start two consumers using the following code in two different machines, i.e., two different JVMs, each consumer needs to create a new connection and a new channel. In this way, the channel.queueDeclarePassive method always return the consumer count == 1, not 2. 

  factory = new ConnectionFactory();
  connection = factory.newConnection(address);
  channel = connection.createChannel();

I also try to find a API that can retrieve the existing connection or channel. Then the second consumer can reuse the connection or channel the first consumer created. But it seems no such APIs.




johnson

From: Matthias Radestock
Date: 2012-08-31 19:39
To: Discussions about RabbitMQ
CC: Francesco Mazzoli; johnson
Subject: Re: [rabbitmq-discuss] How to achieve HA consumers?
On 31/08/12 12:27, Francesco Mazzoli wrote:
&gt;<i>    * The second consumer polls the first in some way and starts consuming when it
</I>&gt;<i>      realises the first consumer is dead.  This is simple and should serve you
</I>&gt;<i>      right, but it's not that nice performance wise.
</I>
A passive queue.declare, which returns the consumer_count could 
accomplish this. You'd need to be mindful of races when consumers start up.

&gt;<i>    * You create a second queue that we'll call &quot;token queue&quot;, and you publish one
</I>&gt;<i>      dummy message in it, with acks enabled.  Then, a consumer wishing to consume
</I>&gt;<i>      from your queue, will:
</I>&gt;<i>
</I>&gt;<i>        - Consume from the token queue
</I>
More specifically, start consuming and wait for the token message to 
arrive. And then...

&gt;<i>        - Start consuming from the actual queue
</I>&gt;<i>        - When shutting down, publish a dummy message to the token queue
</I>
No need for the last step (and in fact it will lead to token 
duplication). Simply leave the message unack'ed and let the automatic 
requeue on connection closure/failure take care of the rest.

Matthias.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120905/33efe343/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120905/33efe343/attachment.htm</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022282.html">[rabbitmq-discuss] AWS clustering
</A></li>
	<LI>Next message: <A HREF="022269.html">[rabbitmq-discuss] How to achieve HA consumers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22265">[ date ]</a>
              <a href="thread.html#22265">[ thread ]</a>
              <a href="subject.html#22265">[ subject ]</a>
              <a href="author.html#22265">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
