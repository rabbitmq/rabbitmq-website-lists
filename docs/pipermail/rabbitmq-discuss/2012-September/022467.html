<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ - big delays when establishing Kombu	connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20-%20big%20delays%20when%20establishing%20Kombu%0A%09connection&In-Reply-To=%3C1347545056419-21989.post%40n5.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022466.html">
   <LINK REL="Next"  HREF="022468.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ - big delays when establishing Kombu	connection</H1>
    <B>eugene</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20-%20big%20delays%20when%20establishing%20Kombu%0A%09connection&In-Reply-To=%3C1347545056419-21989.post%40n5.nabble.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ - big delays when establishing Kombu	connection">eugene.doktorov at gmail.com
       </A><BR>
    <I>Thu Sep 13 15:04:16 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="022466.html">[rabbitmq-discuss] Rabbit MQ Log
</A></li>
        <LI>Next message: <A HREF="022468.html">[rabbitmq-discuss] RabbitMQ - big delays when establishing	Kombu connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22467">[ date ]</a>
              <a href="thread.html#22467">[ thread ]</a>
              <a href="subject.html#22467">[ subject ]</a>
              <a href="author.html#22467">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi guys,

We're experiencing big delays (2-25 secs) when using celery's send_task
method

Our environment:
 - client: celery 3.0.7
 - server: celery 3.0.7, rabbitmq 2.8.6
 - typical ping 
	icmp_seq=1 ttl=64 time=0.390 ms
	icmp_seq=2 ttl=64 time=0.375 ms
	icmp_seq=3 ttl=64 time=54.6 ms
	icmp_seq=4 ttl=64 time=0.384 ms
  - no memory or CPU problems are observed on client or server nodes
  - delay occurs with or without using rabbitmq cluster

I investigated problem a bit:
 - enabled Kombu output on client
 - ran tcpdump on client &amp; server
 - was not able to make Kombu log on the server side. Tried
KOMBU_LOG_DEBUG=1 celeryd -l debug

Looking at logs I noticed that:
 - delay ALWAYS happens between the same amqp messages while establishing
Kombu connection.(TCP connection seams to be established fast)
 - server side tcpdump reflects the same delay
 - publishing, processing &amp; receiving results are fast.

Below is client output from Kombu &amp; tcpdump. I redirected them into the same
file:

Where to go from this point? I'd really appreciate some advice.


Thank you!

Eugene



Logs:
 - prodback1.elevate.56418 - celery client
 - 10.0.1.60.amqp - celery server (using rabbitmq) 
 - delay is between 16:30:03.623661 and 16:30:06.848230


&lt;&lt;LOG BEGIN&gt;&gt;

[Kombu connection:0x2c75350] acquired
*[Kombu connection:0x2c75350] establishing connection...*
16:30:03.623330 IP (tos 0x0, ttl 64, id 56366, offset 0, flags [DF], proto
TCP (6), length 60)
    prodback1.elevate.56418 &gt; 10.0.1.60.amqp: Flags [S], cksum 0x167e
(incorrect -&gt; 0x6113), seq 2858003468, win 5840, options [mss 1460,sackOK,TS
val 12218402 ecr 0,nop,wscale 7], length 0
E..&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">.. at .</A>@.H&gt;
...
..&lt;.b.(.Y...........~.........
..p&quot;........

16:30:03.623661 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP
(6), length 60)
    10.0.1.60.amqp &gt; prodback1.elevate.56418: Flags [S.], cksum 0xcd0b
(correct), seq 1781605121, ack 2858003469, win 14480, options [mss
1460,sackOK,TS val 3557232892 ecr 12218402,nop,wscale 7], length 0
E..&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">.. at .</A>@.$m
..&lt;
....(.bj1#..Y.^M..8............
......p&quot;....

16:30:03.623686 IP (tos 0x0, ttl 64, id 56367, offset 0, flags [DF], proto
TCP (6), length 52)
    prodback1.elevate.56418 &gt; 10.0.1.60.amqp: Flags [.], cksum 0x1676
(incorrect -&gt; 0x343a), seq 1, ack 1, win 46, options [nop,nop,TS val
12218402 ecr 3557232892], length 0
E..4./@<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">. at .HE</A>
...
..&lt;.b.(.Y.^Mj1#......v.....
..p&quot;....

16:30:03.624252 IP (tos 0x0, ttl 64, id 56368, offset 0, flags [DF], proto
TCP (6), length 60)
    prodback1.elevate.56418 &gt; 10.0.1.60.amqp: Flags [P.], cksum 0x167e
(incorrect -&gt; 0x988b), seq 1:9, ack 1, win 46, options [nop,nop,TS val
12218402 ecr 3557232892], length 8
E..&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">.0 at .</A>@.H&lt;
...
..&lt;.b.(.Y.^Mj1#......~.....
..p&quot;....AMQP....

*16:30:03.624547* IP (tos 0x0, ttl 64, id 13311, offset 0, flags [DF], proto
TCP (6), length 52)
    10.0.1.60.amqp &gt; prodback1.elevate.56418: Flags [.], cksum 0x33ed
(correct), seq 1, ack 9, win 114, options [nop,nop,TS val 3557232893 ecr
12218402], length 0
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">E..43. at .</A>@..u
..&lt;
....(.bj1#..Y.....r3......
......p&quot;

*&lt;&lt;my comments:
Here is the delay
always happens between these 2 amqp messages. Never in other places
In this case: 3.2 secs. Seen 25 secs.
Server side tcpdump has the same delay&gt;&gt;*

*16:30:06.848230* IP (tos 0x0, ttl 64, id 13312, offset 0, flags [DF], proto
TCP (6), length 299)
    10.0.1.60.amqp &gt; prodback1.elevate.56418: Flags [P.], cksum 0x351f
(correct), seq 1:248, ack 9, win 114, options [nop,nop,TS val 3557236117 ecr
12218402], length 247
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">E..+4. at .</A>@..}
..&lt;
....(.bj1#..Y.....r5......
......p&quot;........
.
.......capabilitiesF....	copyrightS...$Copyright (C) 2007-2012 VMware,
Inc..informationS...5Licensed under the MPL.  See
<A HREF="http://www.rabbitmq.com/.platformS...">http://www.rabbitmq.com/.platformS...</A>
Erlang/OTP.productS....RabbitMQ.versionS....2.8.6....PLAIN
AMQPLAIN....en_US.

16:30:06.848351 IP (tos 0x0, ttl 64, id 56369, offset 0, flags [DF], proto
TCP (6), length 52)
    prodback1.elevate.56418 &gt; 10.0.1.60.amqp: Flags [.], cksum 0x1676
(incorrect -&gt; 0x19ee), seq 9, ack 248, win 54, options [nop,nop,TS val
12221646 ecr 3557236117], length 0
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">E..4.1 at .</A>@.HC
...
..&lt;.b.(.Y..j1#....6.v.....
..|.....

16:30:06.849300 IP (tos 0x0, ttl 64, id 56370, offset 0, flags [DF], proto
TCP (6), length 175)
    prodback1.elevate.56418 &gt; 10.0.1.60.amqp: Flags [P.], cksum 0x16f1
(incorrect -&gt; 0xbb31), seq 9:132, ack 248, win 54, options [nop,nop,TS val
12221647 ecr 3557236117], length 123
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">E....2 at .</A>@.G.
...
..&lt;.b.(.Y..j1#....6.......
..|...........s.
.....5.libraryS....Python
amqplib.library_versionS....1.0.2.AMQPLAIN...#.LOGINS....guest.PASSWORDS....guest.en_US.

16:30:06.849577 IP (tos 0x0, ttl 64, id 13313, offset 0, flags [DF], proto
TCP (6), length 52)
    10.0.1.60.amqp &gt; prodback1.elevate.56418: Flags [.], cksum 0x1935
(correct), seq 248, ack 132, win 114, options [nop,nop,TS val 3557236118 ecr
12221647], length 0
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">E..44. at .</A>@..s
..&lt;
....(.bj1#..Y.....r.5.....
......|.

16:30:06.849696 IP (tos 0x0, ttl 64, id 13314, offset 0, flags [DF], proto
TCP (6), length 72)
    10.0.1.60.amqp &gt; prodback1.elevate.56418: Flags [P.], cksum 0xe14a
(correct), seq 248:268, ack 132, win 114, options [nop,nop,TS val 3557236118
ecr 12221647], length 20
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">E..H4. at .</A>@..^
..&lt;
....(.bj1#..Y.....r.J.....
......|.........
...........

16:30:06.849864 IP (tos 0x0, ttl 64, id 56371, offset 0, flags [DF], proto
TCP (6), length 72)
    prodback1.elevate.56418 &gt; 10.0.1.60.amqp: Flags [P.], cksum 0x168a
(incorrect -&gt; 0xe072), seq 132:152, ack 268, win 54, options [nop,nop,TS val
12221647 ecr 3557236118], length 20
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">E..H.3 at .</A>@.H-
...
..&lt;.b.(.Y..j1$^M...6.......
..|.............
...........

16:30:06.849942 IP (tos 0x0, ttl 64, id 56372, offset 0, flags [DF], proto 
TCP (6), length 68)
    prodback1.elevate.56418 &gt; 10.0.1.60.amqp: Flags [P.], cksum 0x1686
(incorrect -&gt; 0xae61), seq 152:168, ack 268, win 54, options [nop,nop,TS val
12221647 ecr 3557236118], length 16
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">E..D.4 at .</A>@.H0
...
..&lt;.b.(.Y..j1$^M...6.......
..|.............
.(./...

*[Kombu connection:0x2c75350] connection established:
&lt;kombu.transport.amqplib.Connection object at 0x2d20a50&gt;*
[Kombu connection:0x2c75350] create channel
[Kombu channel:1] exchange_declare(nowait=False, exchange='fetcher',
durable=True, arguments=None, type='direct', auto_delete=False)
[Kombu channel:1] queue_declare(passive=False, nowait=False,
exclusive=False, durable=True, queue='fetcher', arguments=None,
auto_delete=False)
[Kombu channel:1] queue_bind(queue='fetcher', arguments=None, nowait=False,
routing_key='fetcher_task', exchange='fetcher')
[Kombu channel:1]
prepare_message(&quot;(dp1\nS'retries'\np2\nI0\nsS'task'\np3\nS'fetcher.ping'\np4\nsS'kwargs'\np5\n(dp6\nsS'eta'\np7\nNsS'args'\np8\n(lp9\nsS'id'\np10\nS'610ba4f3-4fa4-46c4-a07e-2c71909a8c12'\np11\nsS'expires'\np12\nNsS'utc'\np13\nI00\ns.&quot;,
priority=None, headers={}, properties={'delivery_mode': 2},
content_type='application/x-python-serialize', content_encoding='binary')
[Kombu channel:1] basic_publish(&lt;amqplib.client_0_8.basic_message.Message
object at 0x2d20f90&gt;, mandatory=None, routing_key='fetcher_task',
immediate=None, exchange='fetcher')

&lt;&lt;LOG END&gt;&gt;

no delays from this point




--
View this message in context: <A HREF="http://rabbitmq.1065348.n5.nabble.com/RabbitMQ-big-delays-when-establishing-Kombu-connection-tp21989.html">http://rabbitmq.1065348.n5.nabble.com/RabbitMQ-big-delays-when-establishing-Kombu-connection-tp21989.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022466.html">[rabbitmq-discuss] Rabbit MQ Log
</A></li>
	<LI>Next message: <A HREF="022468.html">[rabbitmq-discuss] RabbitMQ - big delays when establishing	Kombu connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22467">[ date ]</a>
              <a href="thread.html#22467">[ thread ]</a>
              <a href="subject.html#22467">[ subject ]</a>
              <a href="author.html#22467">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
