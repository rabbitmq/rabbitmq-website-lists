<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbit_limiter Exception and Broker Issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbit_limiter%20Exception%20and%20Broker%20Issues&In-Reply-To=%3C077401cefa9c%24cd2c2e70%2467848b50%24%40euphoriaaudio.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032626.html">
   <LINK REL="Next"  HREF="032645.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbit_limiter Exception and Broker Issues</H1>
    <B>Chris Larsen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbit_limiter%20Exception%20and%20Broker%20Issues&In-Reply-To=%3C077401cefa9c%24cd2c2e70%2467848b50%24%40euphoriaaudio.com%3E"
       TITLE="[rabbitmq-discuss] rabbit_limiter Exception and Broker Issues">clarsen at euphoriaaudio.com
       </A><BR>
    <I>Mon Dec 16 20:24:19 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="032626.html">[rabbitmq-discuss] Where is list of users stored?
</A></li>
        <LI>Next message: <A HREF="032645.html">[rabbitmq-discuss] rabbit_limiter Exception and Broker Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32627">[ date ]</a>
              <a href="thread.html#32627">[ thread ]</a>
              <a href="subject.html#32627">[ subject ]</a>
              <a href="author.html#32627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hiya, we ran into some problems with a cluster over the weekend. There was a
sharp increase in message publishing traffic to this 2 node cluster that
increased memory and FD usage but we didn't observe the normal limit
messages in the logs. Instead we say this &quot;rabbit_limiter&quot; exception and the
nodes stopped accepting published messages. Thankfully we were able to
consume the queued, in-memory, data before restarting the nodes. Did we
simply throw too many messages at Rabbit or was there an actual bug in the
limiter code? We're running 3.1.5 with Erlang R16B01 on both nodes. Below
are some bits from the main logs on both nodes and the full SASL logs are in
pastebin. Thanks!

 

Node 1 sasl

<A HREF="http://pastebin.com/h55i3AqQ">http://pastebin.com/h55i3AqQ</A>

Node 2 sasl

<A HREF="http://pastebin.com/3hw7f6xA">http://pastebin.com/3hw7f6xA</A>

 

------ NODE1 Rabbit LOG ------

 

=ERROR REPORT==== 14-Dec-2013::11:39:15 ===

** Generic server &lt;0.21763.1353&gt; terminating

** Last message in was stat

** When Server state == {lim,0,&lt;0.26407.1167&gt;,false,[],0}

** Reason for termination == 

** {function_clause,[{rabbit_limiter,handle_call,

                                     [stat,

                                      {&lt;0.234.0&gt;,#Ref&lt;0.0.8426.115176&gt;},

                                      {lim,0,&lt;0.26407.1167&gt;,false,[],0}],

                                     []},

                     {gen_server2,handle_msg,2,[]},

                     {proc_lib,init_p_do_apply,3,

                               [{file,&quot;proc_lib.erl&quot;},{line,239}]}]}

 

=ERROR REPORT==== 14-Dec-2013::11:55:10 ===

** Generic server &lt;0.28277.6695&gt; terminating

** Last message in was {'$gen_cast',

                           {method,

                               {'queue.declare',0,

                                   &lt;&lt;&quot;notification.somehost&quot;&gt;&gt;,

                                   false,false,false,false,false,

                                   [{&lt;&lt;&quot;x-expires&quot;&gt;&gt;,signedint,10800000}]},

                               none,noflow}}

** When Server state == {ch,running,rabbit_framing_amqp_0_9_1,247,

                            &lt;0.4536.6658&gt;,&lt;0.13044.6658&gt;,&lt;0.4536.6658&gt;,

                            &lt;&lt;C_IP -&gt; S_IP&gt;&gt;,

                            {lstate,&lt;0.20106.6569&gt;,false,false},

                            none,1,

                            {[],[]},

                            {user,&lt;&lt;&quot;app_user&quot;&gt;&gt;,

                                [administrator],

                                rabbit_auth_backend_internal,

                                {internal_user,&lt;&lt;&quot;app_user&quot;&gt;&gt;,

 
&lt;&lt;79,159,188,106,120,27,224,243,230,15,223,

                                      54,140,137,70,36,212,30,111,89&gt;&gt;,

                                    [administrator]}},

                            &lt;&lt;&quot;/app_user&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,

                            {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {set,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {set,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            &lt;0.8820.6668&gt;,

                            {state,fine,5000,#Ref&lt;0.0.6989.167017&gt;},

                            false,1,

                            {{0,nil},{0,nil}},

                            [],

                            [{&lt;&lt;&quot;consumer_cancel_notify&quot;&gt;&gt;,bool,true},

                             {&lt;&lt;&quot;publisher_confirms&quot;&gt;&gt;,bool,true}],

                            none}

** Reason for termination == 

** {{{function_clause,

         [{supervisor2,handle_call,

              [stat,

               {&lt;7347.227.0&gt;,#Ref&lt;7347.0.8145.90172&gt;},

               {state,

                   {&lt;7347.9746.1239&gt;,rabbit_intermediate_sup},

                   one_for_one,[],

                   {dict,0,16,16,8,80,48,

                       {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},

                       {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},

                   10,10,[],rabbit_intermediate_sup,[]}],

              []},

          {gen_server,handle_msg,5,[{file,&quot;gen_server.erl&quot;},{line,585}]},

          {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,239}]}]},

     {gen_server2,call,[&lt;7347.9746.1239&gt;,stat,infinity]}},

    [{gen_server2,call,3,[]},

     {delegate,safe_invoke,2,[]},

     {delegate,'-safe_invoke/2-lc$^0/1-0-',2,[]},

     {delegate,handle_call,3,[]},

     {gen_server2,handle_msg,2,[]},

     {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,249}]}]}

 

=ERROR REPORT==== 14-Dec-2013::11:55:10 ===

AMQP connection &lt;0.4536.6658&gt; (running), channel 247 - error:

{{{function_clause,

      [{supervisor2,handle_call,

           [stat,

            {&lt;7347.227.0&gt;,#Ref&lt;7347.0.8145.90172&gt;},

            {state,

                {&lt;7347.9746.1239&gt;,rabbit_intermediate_sup},

                one_for_one,[],

                {dict,0,16,16,8,80,48,

                    {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},

                    {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},

                10,10,[],rabbit_intermediate_sup,[]}],

           []},

       {gen_server,handle_msg,5,[{file,&quot;gen_server.erl&quot;},{line,585}]},

       {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,239}]}]},

  {gen_server2,call,[&lt;7347.9746.1239&gt;,stat,infinity]}},

[{gen_server2,call,3,[]},

  {delegate,safe_invoke,2,[]},

  {delegate,'-safe_invoke/2-lc$^0/1-0-',2,[]},

  {delegate,handle_call,3,[]},

  {gen_server2,handle_msg,2,[]},

  {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,249}]}]}

 

=WARNING REPORT==== 14-Dec-2013::11:55:10 ===

Non-AMQP exit reason '{{{function_clause,

                         [{supervisor2,handle_call,

                           [stat,

                            {&lt;7347.227.0&gt;,#Ref&lt;7347.0.8145.90172&gt;},

                            {state,

                             {&lt;7347.9746.1239&gt;,rabbit_intermediate_sup},

                             one_for_one,[],

                             {dict,0,16,16,8,80,48,

                              {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                               []},

 
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                []}}},

                             10,10,[],rabbit_intermediate_sup,[]}],

                           []},

                          {gen_server,handle_msg,5,

                           [{file,&quot;gen_server.erl&quot;},{line,585}]},

                          {proc_lib,init_p_do_apply,3,

                           [{file,&quot;proc_lib.erl&quot;},{line,239}]}]},

 
{gen_server2,call,[&lt;7347.9746.1239&gt;,stat,infinity]}},

                       [{gen_server2,call,3,[]},

                        {delegate,safe_invoke,2,[]},

                        {delegate,'-safe_invoke/2-lc$^0/1-0-',2,[]},

                        {delegate,handle_call,3,[]},

                        {gen_server2,handle_msg,2,[]},

                        {proc_lib,wake_up,3,

                         [{file,&quot;proc_lib.erl&quot;},{line,249}]}]}'

 

=ERROR REPORT==== 14-Dec-2013::12:27:35 ===

** Generic server &lt;0.17415.2019&gt; terminating

** Last message in was {'$gen_cast',

                           {method,

                               {'queue.declare',0,

                                   &lt;&lt;&quot;notification.somehost&quot;&gt;&gt;,

                                   false,false,false,false,false,

                                   [{&lt;&lt;&quot;x-expires&quot;&gt;&gt;,signedint,10800000}]},

                               none,noflow}}

** When Server state == {ch,running,rabbit_framing_amqp_0_9_1,240,

                            &lt;0.23804.2237&gt;,&lt;0.9694.2017&gt;,&lt;0.23804.2237&gt;,

                            &lt;&lt;C_IP -&gt; S_IP&gt;&gt;,

                            {lstate,&lt;0.8750.2014&gt;,false,false},

                            none,1,

                            {[],[]},

                            {user,&lt;&lt;&quot;app_user&quot;&gt;&gt;,

                                [administrator],

                                rabbit_auth_backend_internal,

                                {internal_user,&lt;&lt;&quot;app_user&quot;&gt;&gt;,

 
&lt;&lt;199,64,175,52,127,65,248,9,70,171,15,9,5,

                                      122,73,4,195,147,238,67&gt;&gt;,

                                    [administrator]}},

                            &lt;&lt;&quot;/app_user&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,

                            {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {set,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            {set,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                 []},

                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                  [],[]}}},

                            &lt;0.6852.2217&gt;,

                            {state,fine,5000,#Ref&lt;0.0.8928.158612&gt;},

                            false,1,

                            {{0,nil},{0,nil}},

                            [],

                            [{&lt;&lt;&quot;consumer_cancel_notify&quot;&gt;&gt;,bool,true},

                             {&lt;&lt;&quot;publisher_confirms&quot;&gt;&gt;,bool,true}],

                            none}

** Reason for termination == 

** {{{function_clause,

         [{supervisor2,handle_call,

              [stat,

               {&lt;7347.226.0&gt;,#Ref&lt;7347.0.8518.17139&gt;},

               {state,

                   {&lt;7347.8508.1220&gt;,rabbit_connection_sup},

                   one_for_all,

                   [{child,&lt;7347.27376.2037&gt;,reader,

                        {rabbit_reader,start_link,

                            [&lt;7347.29450.2047&gt;,&lt;7347.19330.2055&gt;,

                             #Fun&lt;rabbit_heartbeat.2.69784259&gt;]},

                        intrinsic,4294967295,worker,

                        [rabbit_reader]},

                    {child,&lt;7347.29450.2047&gt;,channel_sup3,

                        {rabbit_intermediate_sup,start_link,[]},

                        intrinsic,infinity,supervisor,

                        [rabbit_intermediate_sup]},

                    {child,&lt;7347.19330.2055&gt;,collector,

                        {rabbit_queue_collector,start_link,[]},

                        intrinsic,4294967295,worker,

                        [rabbit_queue_collector]}],

                   {dict,0,16,16,8,80,48,

                       {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},

                       {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},

                   0,1,[],rabbit_connection_sup,[]}],

              []},

          {gen_server,handle_msg,5,[{file,&quot;gen_server.erl&quot;},{line,585}]},

          {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,239}]}]},

     {gen_server2,call,[&lt;7347.8508.1220&gt;,stat,infinity]}},

    [{gen_server2,call,3,[]},

     {delegate,safe_invoke,2,[]},

     {delegate,'-safe_invoke/2-lc$^0/1-0-',2,[]},

     {delegate,handle_call,3,[]},

     {gen_server2,handle_msg,2,[]},

     {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,249}]}]}

 

=ERROR REPORT==== 14-Dec-2013::12:27:35 ===

AMQP connection &lt;0.23804.2237&gt; (running), channel 240 - error:

{{{function_clause,

      [{supervisor2,handle_call,

           [stat,

            {&lt;7347.226.0&gt;,#Ref&lt;7347.0.8518.17139&gt;},

            {state,

                {&lt;7347.8508.1220&gt;,rabbit_connection_sup},

                one_for_all,

                [{child,&lt;7347.27376.2037&gt;,reader,

                     {rabbit_reader,start_link,

                         [&lt;7347.29450.2047&gt;,&lt;7347.19330.2055&gt;,

                          #Fun&lt;rabbit_heartbeat.2.69784259&gt;]},

                     intrinsic,4294967295,worker,

                     [rabbit_reader]},

                 {child,&lt;7347.29450.2047&gt;,channel_sup3,

                     {rabbit_intermediate_sup,start_link,[]},

                     intrinsic,infinity,supervisor,

                     [rabbit_intermediate_sup]},

                 {child,&lt;7347.19330.2055&gt;,collector,

                     {rabbit_queue_collector,start_link,[]},

                     intrinsic,4294967295,worker,

                     [rabbit_queue_collector]}],

                {dict,0,16,16,8,80,48,

                    {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},

                    {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},

                0,1,[],rabbit_connection_sup,[]}],

           []},

       {gen_server,handle_msg,5,[{file,&quot;gen_server.erl&quot;},{line,585}]},

       {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,239}]}]},

  {gen_server2,call,[&lt;7347.8508.1220&gt;,stat,infinity]}},

[{gen_server2,call,3,[]},

  {delegate,safe_invoke,2,[]},

  {delegate,'-safe_invoke/2-lc$^0/1-0-',2,[]},

  {delegate,handle_call,3,[]},

  {gen_server2,handle_msg,2,[]},

  {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,249}]}]}

 

=WARNING REPORT==== 14-Dec-2013::12:27:35 ===

Non-AMQP exit reason '{{{function_clause,

                         [{supervisor2,handle_call,

                           [stat,

                            {&lt;7347.226.0&gt;,#Ref&lt;7347.0.8518.17139&gt;},

                            {state,

                             {&lt;7347.8508.1220&gt;,rabbit_connection_sup},

                             one_for_all,

                             [{child,&lt;7347.27376.2037&gt;,reader,

                               {rabbit_reader,start_link,

                                [&lt;7347.29450.2047&gt;,&lt;7347.19330.2055&gt;,

                                 #Fun&lt;rabbit_heartbeat.2.69784259&gt;]},

                               intrinsic,4294967295,worker,

                               [rabbit_reader]},

                              {child,&lt;7347.29450.2047&gt;,channel_sup3,

                               {rabbit_intermediate_sup,start_link,[]},

                               intrinsic,infinity,supervisor,

                               [rabbit_intermediate_sup]},

                              {child,&lt;7347.19330.2055&gt;,collector,

                               {rabbit_queue_collector,start_link,[]},

                               intrinsic,4294967295,worker,

                               [rabbit_queue_collector]}],

                             {dict,0,16,16,8,80,48,

                              {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                               []},

 
{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],

                                []}}},

                             0,1,[],rabbit_connection_sup,[]}],

                           []},

                          {gen_server,handle_msg,5,

                           [{file,&quot;gen_server.erl&quot;},{line,585}]},

                          {proc_lib,init_p_do_apply,3,

                           [{file,&quot;proc_lib.erl&quot;},{line,239}]}]},

 
{gen_server2,call,[&lt;7347.8508.1220&gt;,stat,infinity]}},

                       [{gen_server2,call,3,[]},

                        {delegate,safe_invoke,2,[]},

                        {delegate,'-safe_invoke/2-lc$^0/1-0-',2,[]},

                        {delegate,handle_call,3,[]},

                        {gen_server2,handle_msg,2,[]},

                        {proc_lib,wake_up,3,

                         [{file,&quot;proc_lib.erl&quot;},{line,249}]}]}'

                         

 

------ NODE2 Rabbit LOG ------

 

=ERROR REPORT==== 14-Dec-2013::11:55:10 ===

** Generic server &lt;0.9746.1239&gt; terminating 

** Last message in was stat

** When Server state == {state,{&lt;0.9746.1239&gt;,rabbit_intermediate_sup},

                               one_for_one,[],

                               {dict,0,16,16,8,80,48,

 
{[],[],[],[],[],[],[],[],[],[],[],[],[],

                                      [],[],[]},

 
{{[],[],[],[],[],[],[],[],[],[],[],[],[],

                                       [],[],[]}}},

                               10,10,[],rabbit_intermediate_sup,[]}

** Reason for termination == 

** {function_clause,

       [{supervisor2,handle_call,

            [stat,

             {&lt;0.227.0&gt;,#Ref&lt;0.0.8145.90172&gt;},

             {state,

                 {&lt;0.9746.1239&gt;,rabbit_intermediate_sup},

                 one_for_one,[],

                 {dict,0,16,16,8,80,48,

                     {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},

                     {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},

                 10,10,[],rabbit_intermediate_sup,[]}],

            []},

        {gen_server,handle_msg,5,[{file,&quot;gen_server.erl&quot;},{line,585}]},

        {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,239}]}]}

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131216/1babfc3a/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131216/1babfc3a/attachment.html</A>&gt;
</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032626.html">[rabbitmq-discuss] Where is list of users stored?
</A></li>
	<LI>Next message: <A HREF="032645.html">[rabbitmq-discuss] rabbit_limiter Exception and Broker Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32627">[ date ]</a>
              <a href="thread.html#32627">[ thread ]</a>
              <a href="subject.html#32627">[ subject ]</a>
              <a href="author.html#32627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
