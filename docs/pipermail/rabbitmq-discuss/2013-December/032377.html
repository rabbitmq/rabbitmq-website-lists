<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] When rabbitmq is clustered with one other node we see a very slow dequeue of messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20When%20rabbitmq%20is%20clustered%20with%20one%20other%0A%20node%20we%20see%20a%20very%20slow%20dequeue%20of%20messages&In-Reply-To=%3C083E352F62C9974389AD0F9F875EA238179D94AB3C%40THSONEA03CMS03P.ONE-03.GRP%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032350.html">
   <LINK REL="Next"  HREF="032387.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] When rabbitmq is clustered with one other node we see a very slow dequeue of messages</H1>
    <B>GENTLING Gregory</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20When%20rabbitmq%20is%20clustered%20with%20one%20other%0A%20node%20we%20see%20a%20very%20slow%20dequeue%20of%20messages&In-Reply-To=%3C083E352F62C9974389AD0F9F875EA238179D94AB3C%40THSONEA03CMS03P.ONE-03.GRP%3E"
       TITLE="[rabbitmq-discuss] When rabbitmq is clustered with one other node we see a very slow dequeue of messages">Gregory.GENTLING at us.thalesgroup.com
       </A><BR>
    <I>Thu Dec  5 19:00:11 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="032350.html">[rabbitmq-discuss] When rabbitmq is clustered with one other	node we see a very slow dequeue of messages
</A></li>
        <LI>Next message: <A HREF="032387.html">[rabbitmq-discuss] When rabbitmq is clustered with one other	node we see a very slow dequeue of messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32377">[ date ]</a>
              <a href="thread.html#32377">[ thread ]</a>
              <a href="subject.html#32377">[ subject ]</a>
              <a href="author.html#32377">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Classification: Thales Group Internal

Hi Simon,

The issue is not that RabbitMQ does not detect a node down in a timely fashion, it does what I expect. The behavior in question is what happens after RabbitMQ removes the node due to net_ticktime expiration. If I set net_ticktime to 20 seconds, 20 seconds goes by, Node B is removed, and then the slow message delivery occurs. Likewise, set it to 10 mins, after 10 mins, Node B is removed and the slowness occurs. Five to ten minutes after Node B is removed, the server catches up. So we are seeing degraded performance *after* Node B is removed from the cluster for up to 10 minutes. 
So much so, that even with a light load of 1MSG/sec after about 5 minutes the consumer falls behind by over 100MSGs. net_ticktime only effects when we will see the server become degraded, but not how long.

Thanks,

Greg &amp; James

-----Original Message-----
From: Simon MacMullen [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>]
Sent: Wednesday, December 04, 2013 3:41 AM
To: Discussions about RabbitMQ
Cc: GENTLING Gregory
Subject: Re: [rabbitmq-discuss] When rabbitmq is clustered with one other node we see a very slow dequeue of messages

The issue is that you are getting into a situation where node B is down, but node A is not aware of this (probably because from a TCP level it's not aware that the connection has been closed). Node A therefore has to wait a considerable time (the net_ticktime) trying to send packets to node B before giving up and treating the node as down.

If node A can tell at the TCP level that the connection to node B has gone down, then you won't have this wait, it'll just mark the node as down immediately and carry on.

To some extent you can tweak this behaviour by reducing net_ticktime - but a short net_ticktime makes it plausible that a node will be considered down when it isn't.

See <A HREF="http://www.rabbitmq.com/partitions.html">http://www.rabbitmq.com/partitions.html</A> for more.

Cheers, Simon

On 04/12/13 01:52, GENTLING Gregory wrote:
&gt;<i> Classification: Open
</I>&gt;<i>
</I>&gt;<i> When rabbitmq is clustered with one other node we see a very slow 
</I>&gt;<i> dequeue of messages. The scenario is simple, Node A and Node B in the 
</I>&gt;<i> cluster. They are clustered with the auto_heal option and default 
</I>&gt;<i> netticktime. Steps to repeat are:
</I>&gt;<i>
</I>&gt;<i> (These are all local connections)
</I>&gt;<i>
</I>&gt;<i> (1)Connect client A1 to Node A
</I>&gt;<i>
</I>&gt;<i> a.Client A1 creates a topic exchange
</I>&gt;<i>
</I>&gt;<i> b.Client A1 is a publisher with 1msg/sec
</I>&gt;<i>
</I>&gt;<i> (2)Connect client A2 to Node A
</I>&gt;<i>
</I>&gt;<i> a.Client A1 listens for the messages in the exchange
</I>&gt;<i>
</I>&gt;<i> (3)Connect client B to Node B   (this is important, the issue does not
</I>&gt;<i> occur unless you have this remote client)
</I>&gt;<i>
</I>&gt;<i> a.Client B listens for the messages in the exchange
</I>&gt;<i>
</I>&gt;<i> (4)Pull the plug on Node B (you will not see the issue with a graceful 
</I>&gt;<i> shutdown), alternately you can just use &quot;route&quot; to now make Node B not 
</I>&gt;<i> routable from Node A
</I>&gt;<i>
</I>&gt;<i> a.If you kill rabbitmq, you will not see the issue
</I>&gt;<i>
</I>&gt;<i> (5)Wait for netticktime (or until you see NodeB being removed from the 
</I>&gt;<i> cluster in Node A's log)
</I>&gt;<i>
</I>&gt;<i> (6)Client A2 no longer receives messages at 1msg/sec, it will fall 
</I>&gt;<i> considerably behind but recover in about 10 mins.
</I>&gt;<i>
</I>&gt;<i> We have two setups with slightly different network setups (two pairs 
</I>&gt;<i> of Node A and B). One we see this issue on, the other we do not, so 
</I>&gt;<i> this is not an issue that can be always reproduced.
</I>&gt;<i>
</I>&gt;<i> Other issues observed in this state:
</I>&gt;<i>
</I>&gt;<i> *rabbitmqctl
</I>&gt;<i> cluster_status/list_queues/list_connections/list_exchanges
</I>&gt;<i> all hang, rabbitmq status does not hang
</I>&gt;<i>
</I>&gt;<i> *declareQueue, declareExchange, declareExchangePassive all hang
</I>&gt;<i>
</I>&gt;<i> *disabling auto_heal does not help
</I>&gt;<i>
</I>&gt;<i> *tested with both Erlang 5.9 and 5.10.3
</I>&gt;<i>
</I>&gt;<i> *tested with both RabbitMq 3.1.5 and 3.1.3, same issue in both
</I>&gt;<i>
</I>&gt;<i> *don't see this issue with direct exchange
</I>&gt;<i>
</I>&gt;<i> *nothing in vmstat out of the ordinary, CPU is not pegged, system is 
</I>&gt;<i> not thrashing
</I>&gt;<i>
</I>&gt;<i> Things we have ruled out:
</I>&gt;<i>
</I>&gt;<i> *Iptables, tested with no rules
</I>&gt;<i>
</I>&gt;<i> *Selinux, tested in permissive
</I>&gt;<i>
</I>&gt;<i> *Java drivers
</I>&gt;<i>
</I>&gt;<i> Same thing as described here:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2013-June/027674.">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2013-June/027674.</A>
</I>&gt;<i> html
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> *Greg Gentling*
</I>&gt;<i>
</I>&gt;<i> Principal Software Architecture - Avant CommonApps
</I>&gt;<i>
</I>&gt;<i> Thales Avionics, Inc.
</I>&gt;<i>
</I>&gt;<i> In-Flight Entertainment and Connectivity
</I>&gt;<i>
</I>&gt;<i> Irvine, CA 92618
</I>&gt;<i>
</I>&gt;<i> 949-595-4943
</I>&gt;<i>
</I>&gt;<i> [@@OPEN@@]
</I>&gt;<i>
</I>&gt;<i> This email was classified by GENTLING Gregoryon Tuesday, December 03,
</I>&gt;<i> 2013 5:52:25 PM.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

--
Simon MacMullen
RabbitMQ, Pivotal

[@@THALES GROUP INTERNAL@@]
 
This email was classified by GENTLING Gregory on Thursday, December 05, 2013 11:00:11 AM.
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032350.html">[rabbitmq-discuss] When rabbitmq is clustered with one other	node we see a very slow dequeue of messages
</A></li>
	<LI>Next message: <A HREF="032387.html">[rabbitmq-discuss] When rabbitmq is clustered with one other	node we see a very slow dequeue of messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32377">[ date ]</a>
              <a href="thread.html#32377">[ thread ]</a>
              <a href="subject.html#32377">[ subject ]</a>
              <a href="author.html#32377">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
