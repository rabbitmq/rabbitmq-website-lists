<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmqctl stop hangs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20stop%20hangs&In-Reply-To=%3CCECCA110.5916A%25ed.tyrrill%40emc.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032428.html">
   <LINK REL="Next"  HREF="032442.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmqctl stop hangs</H1>
    <B>Tyrrill, Ed</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20stop%20hangs&In-Reply-To=%3CCECCA110.5916A%25ed.tyrrill%40emc.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmqctl stop hangs">ed.tyrrill at emc.com
       </A><BR>
    <I>Tue Dec 10 18:48:22 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="032428.html">[rabbitmq-discuss] rabbitmqctl stop hangs
</A></li>
        <LI>Next message: <A HREF="032442.html">[rabbitmq-discuss] rabbitmqctl stop hangs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32436">[ date ]</a>
              <a href="thread.html#32436">[ thread ]</a>
              <a href="subject.html#32436">[ subject ]</a>
              <a href="author.html#32436">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Tim,

Thanks for your quick response.  From the end of the log it looks like the shovel plugin was trying to establish the connection to the remote broker, which was down at the time, at the same time stop was run:

=ERROR REPORT==== 6-Dec-2013::13:51:36 ===
** Generic server &lt;0.8762.19&gt; terminating
** Last message in was {'EXIT',&lt;0.8759.19&gt;,
                           {{badmatch,{error,etimedout}},
                            [{rabbit_shovel_worker,make_conn_and_chan,1,[]},
                             {rabbit_shovel_worker,handle_cast,2,[]},
                             {gen_server2,handle_msg,2,[]},
                             {proc_lib,init_p_do_apply,3,
                                 [{file,&quot;proc_lib.erl&quot;},{line,239}]}]}}
** When Server state == {state,amqp_direct_connection,
                         {state,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>',
                          {user,&lt;&lt;&quot;guest&quot;&gt;&gt;,
                           [administrator],
                           rabbit_auth_backend_internal,
                           {internal_user,&lt;&lt;&quot;guest&quot;&gt;&gt;,
                            &lt;&lt;193,148,73,243,245,222,154,143,19,215,47,234,93,
                              175,56,125,17,151,61,97&gt;&gt;,
                            [administrator]}},
                          &lt;&lt;&quot;/&quot;&gt;&gt;,
                          {amqp_params_direct,&lt;&lt;&quot;guest&quot;&gt;&gt;,none,&lt;&lt;&quot;/&quot;&gt;&gt;,
                           '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>',none,[]},
                          {amqp_adapter_info,unknown,unknown,unknown,unknown,
                           &lt;&lt;&quot;&lt;'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>'.3.8762.19&gt;&quot;&gt;&gt;,
                           {'Direct',{0,9,1}},
                           []},
                          &lt;0.8765.19&gt;,undefined},
                         &lt;0.8764.19&gt;,
                         {amqp_params_direct,&lt;&lt;&quot;guest&quot;&gt;&gt;,none,&lt;&lt;&quot;/&quot;&gt;&gt;,
                          '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>',none,[]},
                         0,
                         [{&lt;&lt;&quot;capabilities&quot;&gt;&gt;,table,
                           [{&lt;&lt;&quot;publisher_confirms&quot;&gt;&gt;,bool,true},
                            {&lt;&lt;&quot;exchange_exchange_bindings&quot;&gt;&gt;,bool,true},
                            {&lt;&lt;&quot;basic.nack&quot;&gt;&gt;,bool,true},
                            {&lt;&lt;&quot;consumer_cancel_notify&quot;&gt;&gt;,bool,true},
                            {&lt;&lt;&quot;connection.blocked&quot;&gt;&gt;,bool,true},
                            {&lt;&lt;&quot;consumer_priorities&quot;&gt;&gt;,bool,true},
                            {&lt;&lt;&quot;authentication_failure_close&quot;&gt;&gt;,bool,true}]},
                          {&lt;&lt;&quot;copyright&quot;&gt;&gt;,longstr,
                           &lt;&lt;&quot;Copyright (C) 2007-2013 GoPivotal, Inc.&quot;&gt;&gt;},
                          {&lt;&lt;&quot;information&quot;&gt;&gt;,longstr,
                           &lt;&lt;&quot;Licensed under the MPL.  See <A HREF="http://www.rabbitmq.com/">http://www.rabbitmq.com/</A>&quot;&gt;&gt;},
                          {&lt;&lt;&quot;platform&quot;&gt;&gt;,longstr,&lt;&lt;&quot;Erlang/OTP&quot;&gt;&gt;},
                          {&lt;&lt;&quot;product&quot;&gt;&gt;,longstr,&lt;&lt;&quot;RabbitMQ&quot;&gt;&gt;},
                          {&lt;&lt;&quot;version&quot;&gt;&gt;,longstr,&lt;&lt;&quot;3.2.0&quot;&gt;&gt;}],
                         none,false}
** Reason for termination ==
** {unexpected_msg,
       {'EXIT',&lt;0.8759.19&gt;,
           {{badmatch,{error,etimedout}},
            [{rabbit_shovel_worker,make_conn_and_chan,1,[]},
             {rabbit_shovel_worker,handle_cast,2,[]},
             {gen_server2,handle_msg,2,[]},
             {proc_lib,init_p_do_apply,3,
                 [{file,&quot;proc_lib.erl&quot;},{line,239}]}]}}}

=INFO REPORT==== 6-Dec-2013::13:51:36 ===
stopped TCP Listener on 127.0.0.1:5672

=INFO REPORT==== 6-Dec-2013::13:51:36 ===
Halting Erlang VM




From: Tim Watson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>&gt;&gt;
Reply-To: Discussions about RabbitMQ &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;&gt;
Date: Tuesday, December 10, 2013 1:49 AM
To: Discussions about RabbitMQ &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;&gt;
Subject: Re: [rabbitmq-discuss] rabbitmqctl stop hangs

There ought to be further information in the log files from the brokers in question during the stop operation. Can you post that, or put it somewhere accessible please? Why do you have both `rabbitmq-server stop' and `rabbitmqctl stop' running at the same time? Are those pointing to different rabbits?

On 10 Dec 2013, at 01:32, Tyrrill, Ed wrote:

Hi All,

We are using rabbitmq-server rpms on linux.  Recently we upgraded from 3.1.1-1 to 3.2.0-1, and we are seeing intermittent hangs when stopping rabbitmq.  Here is the ps output:

root     31052 31051  0 Dec06 ?        00:00:00 /bin/sh /sbin/service rabbitmq-server stop
root     31055 31052  0 Dec06 ?        00:00:00 /bin/sh /etc/init.d/rabbitmq-server stop
root     31100 31055  0 Dec06 ?        00:00:00 /bin/sh /usr/sbin/rabbitmqctl stop /var/run/rabbitmq/pid
root     31111 31100  0 Dec06 ?        00:00:00 su rabbitmq -s /bin/sh -c /usr/lib/rabbitmq/bin/rabbitmqctl  &quot;stop&quot; &quot;/var/run/rabbitmq/pid&quot;
rabbitmq 31112 31111  0 Dec06 ?        00:24:10 /usr/lib64/erlang/erts-5.10.3/bin/beam.smp -- -root /usr/lib64/erlang -progname erl -- -home /var/lib/rabbitmq -- -pa /usr/lib/rabbitmq/lib/rabbitmq_server-3.2.0/sbin/../ebin -noshell -noinput -hidden -sname rabbitmqctl31112 -boot start_clean -s rabbit_control_main -nodename <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A> -extra stop /var/run/rabbitmq/pid

The CPU time column on the erlang process does slowly go up.  I don't know if it plays a factor, but this broker has shovels defined to a remote broker, and the remote broker was down at the time of this stop.


How long do these hangs take? The shovel workers will wait 10 seconds for both their inbound and outbound connections to close cleanly. If you examine the log files for both the source and destination (i.e., remote) brokers during the shutdown, there may be some useful indication of whether this is the cause of the problem or not.

Is this a known issue?  We've been seeing this a couple times a week (over &gt; 100 brokers), and I need to get a fix for this.


We have fixed bugs with shutdown delays and deadlocks in the past, but they're mostly dusted and released now. We do have an open issue that can cause long delays during broker shutdown, which is mediated by having a lot of durable queues (regardless of whether they contain messages or not). Could that be what you're seeing? How many durable queues do these brokers have running on them?

Tim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131210/98ddbd1e/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131210/98ddbd1e/attachment.html</A>&gt;
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032428.html">[rabbitmq-discuss] rabbitmqctl stop hangs
</A></li>
	<LI>Next message: <A HREF="032442.html">[rabbitmq-discuss] rabbitmqctl stop hangs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32436">[ date ]</a>
              <a href="thread.html#32436">[ thread ]</a>
              <a href="subject.html#32436">[ subject ]</a>
              <a href="author.html#32436">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
