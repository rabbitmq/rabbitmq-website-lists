<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmqctl stop hangs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20stop%20hangs&In-Reply-To=%3CA94A2A18-1F95-4E40-BCEA-584D68DE0734%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032449.html">
   <LINK REL="Next"  HREF="032424.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmqctl stop hangs</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20stop%20hangs&In-Reply-To=%3CA94A2A18-1F95-4E40-BCEA-584D68DE0734%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmqctl stop hangs">tim at rabbitmq.com
       </A><BR>
    <I>Wed Dec 11 10:52:06 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="032449.html">[rabbitmq-discuss] rabbitmqctl stop hangs
</A></li>
        <LI>Next message: <A HREF="032424.html">[rabbitmq-discuss] .net client foreground threads
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32457">[ date ]</a>
              <a href="thread.html#32457">[ thread ]</a>
              <a href="subject.html#32457">[ subject ]</a>
              <a href="author.html#32457">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Ed,

If at all possible, would you please send as much of the logging information as possible? You can contact me offline about emailing/uploading it privately if you prefer, or simply scrub any private data from it before hand. I'm going to need to see more of the stack traces in the logs to diagnose this issue properly.

Thanks,
Tim

On 11 Dec 2013, at 09:18, Tim Watson wrote:

&gt;<i> Thanks for the analysis Ed, this sounds like a bug - ill take a walk through the code this morning and confirm that. If the shovel is &quot;stuck&quot; trying to establish a connection, that might well be an explanation. It's surprising that the supervision tree (for shovel workers) doesn't handle this scenario, but it may need to be reconfigured to handle delayed startup or the workers may need to be re-worked to handle startup differently.
</I>&gt;<i> 
</I>&gt;<i> I'll post back when I've validated those issues and let you know what my findings are.
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> Tim
</I>&gt;<i> 
</I>&gt;<i> On 10 Dec 2013, at 23:40, &quot;Tyrrill, Ed&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ed.tyrrill at emc.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Hi Tim,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I realized I did not address all of your questions.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> &gt;  How long do these hangs take? The shovel workers will wait 10 seconds for both their inbound and outbound connections to close cleanly.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I have one I server I left untouched that hung four days ago, and is still hung
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> &gt; If you examine the log files for both the source and destination (i.e., remote) brokers during the shutdown, there may be some useful indication of whether this is the cause of the problem or not.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The destination of the shovel was down at the time so only the source side is relevant.  I noticed that the shutdown_log file has the time 13:46, with the message &quot;Stopping and halting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>' &#8230;&quot;, and shutdown_err is empty.  The &quot;Halting Erlang VM&quot; message in <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29.log</A> is then coming five minutes later at 13:51.  The messages in <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29-sasl.log</A> all seem related to shovel connect attempts.  Also note that the RabbitMQ erlang process is still running.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> &gt; We have fixed bugs with shutdown delays and deadlocks in the past, but they're mostly dusted and released now. We do have an open issue that can cause long delays during broker shutdown, which is mediated by having a lot of durable queues (regardless of whether they contain messages or not). Could that be what you're seeing? How many durable queues do these brokers have running on them?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Five durable queues.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Ed
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> From: &lt;Tyrrill&gt;, Edward Tyrrill &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ed.tyrrill at emc.com</A>&gt;
</I>&gt;&gt;<i> Reply-To: Discussions about RabbitMQ &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> Date: Tuesday, December 10, 2013 10:48 AM
</I>&gt;&gt;<i> To: Discussions about RabbitMQ &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> Subject: Re: [rabbitmq-discuss] rabbitmqctl stop hangs
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Hi Tim,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks for your quick response.  From the end of the log it looks like the shovel plugin was trying to establish the connection to the remote broker, which was down at the time, at the same time stop was run:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> =ERROR REPORT==== 6-Dec-2013::13:51:36 ===
</I>&gt;&gt;<i> ** Generic server &lt;0.8762.19&gt; terminating 
</I>&gt;&gt;<i> ** Last message in was {'EXIT',&lt;0.8759.19&gt;,
</I>&gt;&gt;<i>                            {{badmatch,{error,etimedout}},
</I>&gt;&gt;<i>                             [{rabbit_shovel_worker,make_conn_and_chan,1,[]},
</I>&gt;&gt;<i>                              {rabbit_shovel_worker,handle_cast,2,[]},
</I>&gt;&gt;<i>                              {gen_server2,handle_msg,2,[]},
</I>&gt;&gt;<i>                              {proc_lib,init_p_do_apply,3,
</I>&gt;&gt;<i>                                  [{file,&quot;proc_lib.erl&quot;},{line,239}]}]}}
</I>&gt;&gt;<i> ** When Server state == {state,amqp_direct_connection,
</I>&gt;&gt;<i>                          {state,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>',
</I>&gt;&gt;<i>                           {user,&lt;&lt;&quot;guest&quot;&gt;&gt;,
</I>&gt;&gt;<i>                            [administrator],
</I>&gt;&gt;<i>                            rabbit_auth_backend_internal,
</I>&gt;&gt;<i>                            {internal_user,&lt;&lt;&quot;guest&quot;&gt;&gt;,
</I>&gt;&gt;<i>                             &lt;&lt;193,148,73,243,245,222,154,143,19,215,47,234,93,
</I>&gt;&gt;<i>                               175,56,125,17,151,61,97&gt;&gt;,
</I>&gt;&gt;<i>                             [administrator]}},
</I>&gt;&gt;<i>                           &lt;&lt;&quot;/&quot;&gt;&gt;,
</I>&gt;&gt;<i>                           {amqp_params_direct,&lt;&lt;&quot;guest&quot;&gt;&gt;,none,&lt;&lt;&quot;/&quot;&gt;&gt;,
</I>&gt;&gt;<i>                            '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>',none,[]},
</I>&gt;&gt;<i>                           {amqp_adapter_info,unknown,unknown,unknown,unknown,
</I>&gt;&gt;<i>                            &lt;&lt;&quot;&lt;'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>'.3.8762.19&gt;&quot;&gt;&gt;,
</I>&gt;&gt;<i>                            {'Direct',{0,9,1}},
</I>&gt;&gt;<i>                            []},
</I>&gt;&gt;<i>                           &lt;0.8765.19&gt;,undefined},
</I>&gt;&gt;<i>                          &lt;0.8764.19&gt;,
</I>&gt;&gt;<i>                          {amqp_params_direct,&lt;&lt;&quot;guest&quot;&gt;&gt;,none,&lt;&lt;&quot;/&quot;&gt;&gt;,
</I>&gt;&gt;<i>                           '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A>',none,[]},
</I>&gt;&gt;<i>                          0,
</I>&gt;&gt;<i>                          [{&lt;&lt;&quot;capabilities&quot;&gt;&gt;,table,
</I>&gt;&gt;<i>                            [{&lt;&lt;&quot;publisher_confirms&quot;&gt;&gt;,bool,true},
</I>&gt;&gt;<i>                             {&lt;&lt;&quot;exchange_exchange_bindings&quot;&gt;&gt;,bool,true},
</I>&gt;&gt;<i>                             {&lt;&lt;&quot;basic.nack&quot;&gt;&gt;,bool,true},
</I>&gt;&gt;<i>                             {&lt;&lt;&quot;consumer_cancel_notify&quot;&gt;&gt;,bool,true},
</I>&gt;&gt;<i>                             {&lt;&lt;&quot;connection.blocked&quot;&gt;&gt;,bool,true},
</I>&gt;&gt;<i>                             {&lt;&lt;&quot;consumer_priorities&quot;&gt;&gt;,bool,true},
</I>&gt;&gt;<i>                             {&lt;&lt;&quot;authentication_failure_close&quot;&gt;&gt;,bool,true}]},
</I>&gt;&gt;<i>                           {&lt;&lt;&quot;copyright&quot;&gt;&gt;,longstr,
</I>&gt;&gt;<i>                            &lt;&lt;&quot;Copyright (C) 2007-2013 GoPivotal, Inc.&quot;&gt;&gt;},
</I>&gt;&gt;<i>                           {&lt;&lt;&quot;information&quot;&gt;&gt;,longstr,
</I>&gt;&gt;<i>                            &lt;&lt;&quot;Licensed under the MPL.  See <A HREF="http://www.rabbitmq.com/">http://www.rabbitmq.com/</A>&quot;&gt;&gt;},
</I>&gt;&gt;<i>                           {&lt;&lt;&quot;platform&quot;&gt;&gt;,longstr,&lt;&lt;&quot;Erlang/OTP&quot;&gt;&gt;},
</I>&gt;&gt;<i>                           {&lt;&lt;&quot;product&quot;&gt;&gt;,longstr,&lt;&lt;&quot;RabbitMQ&quot;&gt;&gt;},
</I>&gt;&gt;<i>                           {&lt;&lt;&quot;version&quot;&gt;&gt;,longstr,&lt;&lt;&quot;3.2.0&quot;&gt;&gt;}],
</I>&gt;&gt;<i>                          none,false}
</I>&gt;&gt;<i> ** Reason for termination == 
</I>&gt;&gt;<i> ** {unexpected_msg,
</I>&gt;&gt;<i>        {'EXIT',&lt;0.8759.19&gt;,
</I>&gt;&gt;<i>            {{badmatch,{error,etimedout}},
</I>&gt;&gt;<i>             [{rabbit_shovel_worker,make_conn_and_chan,1,[]},
</I>&gt;&gt;<i>              {rabbit_shovel_worker,handle_cast,2,[]},
</I>&gt;&gt;<i>              {gen_server2,handle_msg,2,[]},
</I>&gt;&gt;<i>              {proc_lib,init_p_do_apply,3,
</I>&gt;&gt;<i>                  [{file,&quot;proc_lib.erl&quot;},{line,239}]}]}}}
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> =INFO REPORT==== 6-Dec-2013::13:51:36 ===
</I>&gt;&gt;<i> stopped TCP Listener on 127.0.0.1:5672
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> =INFO REPORT==== 6-Dec-2013::13:51:36 ===
</I>&gt;&gt;<i> Halting Erlang VM
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> From: Tim Watson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> Reply-To: Discussions about RabbitMQ &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> Date: Tuesday, December 10, 2013 1:49 AM
</I>&gt;&gt;<i> To: Discussions about RabbitMQ &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> Subject: Re: [rabbitmq-discuss] rabbitmqctl stop hangs
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> There ought to be further information in the log files from the brokers in question during the stop operation. Can you post that, or put it somewhere accessible please? Why do you have both `rabbitmq-server stop' and `rabbitmqctl stop' running at the same time? Are those pointing to different rabbits? 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 10 Dec 2013, at 01:32, Tyrrill, Ed wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Hi All,
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> We are using rabbitmq-server rpms on linux.  Recently we upgraded from 3.1.1-1 to 3.2.0-1, and we are seeing intermittent hangs when stopping rabbitmq.  Here is the ps output:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> root     31052 31051  0 Dec06 ?        00:00:00 /bin/sh /sbin/service rabbitmq-server stop
</I>&gt;&gt;&gt;<i> root     31055 31052  0 Dec06 ?        00:00:00 /bin/sh /etc/init.d/rabbitmq-server stop
</I>&gt;&gt;&gt;<i> root     31100 31055  0 Dec06 ?        00:00:00 /bin/sh /usr/sbin/rabbitmqctl stop /var/run/rabbitmq/pid
</I>&gt;&gt;&gt;<i> root     31111 31100  0 Dec06 ?        00:00:00 su rabbitmq -s /bin/sh -c /usr/lib/rabbitmq/bin/rabbitmqctl  &quot;stop&quot; &quot;/var/run/rabbitmq/pid&quot;
</I>&gt;&gt;&gt;<i> rabbitmq 31112 31111  0 Dec06 ?        00:24:10 /usr/lib64/erlang/erts-5.10.3/bin/beam.smp -- -root /usr/lib64/erlang -progname erl -- -home /var/lib/rabbitmq -- -pa /usr/lib/rabbitmq/lib/rabbitmq_server-3.2.0/sbin/../ebin -noshell -noinput -hidden -sname rabbitmqctl31112 -boot start_clean -s rabbit_control_main -nodename <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-ave29</A> -extra stop /var/run/rabbitmq/pid
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The CPU time column on the erlang process does slowly go up.  I don't know if it plays a factor, but this broker has shovels defined to a remote broker, and the remote broker was down at the time of this stop.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> How long do these hangs take? The shovel workers will wait 10 seconds for both their inbound and outbound connections to close cleanly. If you examine the log files for both the source and destination (i.e., remote) brokers during the shutdown, there may be some useful indication of whether this is the cause of the problem or not.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Is this a known issue?  We've been seeing this a couple times a week (over &gt; 100 brokers), and I need to get a fix for this.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> We have fixed bugs with shutdown delays and deadlocks in the past, but they're mostly dusted and released now. We do have an open issue that can cause long delays during broker shutdown, which is mediated by having a lot of durable queues (regardless of whether they contain messages or not). Could that be what you're seeing? How many durable queues do these brokers have running on them?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Tim
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131211/f3a826af/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131211/f3a826af/attachment.html</A>&gt;
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032449.html">[rabbitmq-discuss] rabbitmqctl stop hangs
</A></li>
	<LI>Next message: <A HREF="032424.html">[rabbitmq-discuss] .net client foreground threads
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32457">[ date ]</a>
              <a href="thread.html#32457">[ thread ]</a>
              <a href="subject.html#32457">[ subject ]</a>
              <a href="author.html#32457">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
