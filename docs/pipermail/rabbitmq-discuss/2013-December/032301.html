<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Erlang Client RPC issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20Client%20RPC%20issues&In-Reply-To=%3C15ED1DE2-F1B1-4976-AEE8-A2D4557488D9%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032363.html">
   <LINK REL="Next"  HREF="032365.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Erlang Client RPC issues</H1>
    <B>Chris Jimison</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20Client%20RPC%20issues&In-Reply-To=%3C15ED1DE2-F1B1-4976-AEE8-A2D4557488D9%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Erlang Client RPC issues">cjimison at gmail.com
       </A><BR>
    <I>Wed Dec  4 06:06:52 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="032363.html">[rabbitmq-discuss] Connection alwalys is blocked!
</A></li>
        <LI>Next message: <A HREF="032365.html">[rabbitmq-discuss] Erlang Client RPC issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32301">[ date ]</a>
              <a href="thread.html#32301">[ thread ]</a>
              <a href="subject.html#32301">[ subject ]</a>
              <a href="author.html#32301">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey all,

I am running an Erlang server and I want to make an RPC call to another server that may or may not be running.

I am running the following code:

* Connection is a valid amqp connection

    Client = amqp_rpc_client:start(Connection, &lt;&lt;&#8220;info_queue&#8221;&gt;&gt;),
    Reply = amqp_rpc_client:call(Client, &lt;&lt;&quot;info&quot;&gt;&gt;),
    amqp_rpc_client:stop(Client),

Two questions:

1) I noticed in the amqp_rpc_client.erl that it is not handling #&#8217;basic.return&#8217;{} messages.  I added a call to:
 
amqp_channel:register_return_handler(Channel, self()),

in the init function and a handle_info call:

handle_info({#'basic.return'{}, Content}, State = #state{continuations = Conts, channel = _Channel}) -&gt;
    #amqp_msg{props = #'P_basic'{correlation_id = Id}, payload = _Payload} = Content,
    From = dict:fetch(Id, Conts),
    gen_server:reply(From, basic_return),
    {noreply, State};


and that seems to work well.  I am very new to RabbitMQ and I am not really sure if this is going to break something very badly.  Is there a reason amqp_rpc_client is not a return_handler?


2) When I call amqp_rpc_client:stop I am getting error messages (with our without my changes) about:

{error,{consumer_died,normal}}

It seams to me that when the Channel created in amqp_rpc_client is shutdown, the amqp_direct_consumer is getting the &#8216;DOWN&#8217; message and returning {error, {consumer_died, Info}, C};

Does this sound correct that calling stop on an amqp_rpc_client should be generating so many errors?  Is there some cleaner way I should be stopping the amqp_rpc_client?

I tried moving the amqp_channel:close call into the handle_call(stop, _From, State) function and that did clean things up a bit.  But I am still getting a:

gen_server &lt;0.19536.1&gt; terminated with reason: {error,{consumer_died,normal}}


Thanks for any insights and help!

Environment:

Mac OS X: 10.9
RabbitMQ server 3.2.1
rabbitmq-erlang-client github fork, based on the rabbitmq_v3_2_1 git tag


- Chris
</PRE>


































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032363.html">[rabbitmq-discuss] Connection alwalys is blocked!
</A></li>
	<LI>Next message: <A HREF="032365.html">[rabbitmq-discuss] Erlang Client RPC issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32301">[ date ]</a>
              <a href="thread.html#32301">[ thread ]</a>
              <a href="subject.html#32301">[ subject ]</a>
              <a href="author.html#32301">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
