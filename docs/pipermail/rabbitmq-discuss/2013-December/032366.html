<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] OpenLDAP-based auth with 'other_bind' option: no	DN attribute?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20OpenLDAP-based%20auth%20with%20%27other_bind%27%20option%3A%20no%0A%09DN%20attribute%3F&In-Reply-To=%3C20131205145345.53ac312c%40krasoola.nask.waw.pl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032411.html">
   <LINK REL="Next"  HREF="032395.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] OpenLDAP-based auth with 'other_bind' option: no	DN attribute?</H1>
    <B>Jan Kaliszewski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20OpenLDAP-based%20auth%20with%20%27other_bind%27%20option%3A%20no%0A%09DN%20attribute%3F&In-Reply-To=%3C20131205145345.53ac312c%40krasoola.nask.waw.pl%3E"
       TITLE="[rabbitmq-discuss] OpenLDAP-based auth with 'other_bind' option: no	DN attribute?">jan.kaliszewski at nask.pl
       </A><BR>
    <I>Thu Dec  5 13:53:45 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="032411.html">[rabbitmq-discuss] rabbitmq_c Sometimes I get AMQP_STATUS_TIMER_FAILURE error on Win32
</A></li>
        <LI>Next message: <A HREF="032395.html">[rabbitmq-discuss] OpenLDAP-based auth with 'other_bind' option: no DN attribute?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32366">[ date ]</a>
              <a href="thread.html#32366">[ thread ]</a>
              <a href="subject.html#32366">[ subject ]</a>
              <a href="author.html#32366">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

First, I'd like to express my gratitude to the authors of RabbitMQ for
producing such a useful piece of software!

Now, the problem I encountered (and the solution, or workaround, I
found)...

I am trying to configure RabbitMQ for passwordless (SSL client
certificate-based) and OpenLDAP-based authentication (with the
rabbitmq_auth_mechanism_ssl and rabbitmq_auth_backend_ldap plugins
enabled).

I carefully read the <A HREF="https://www.rabbitmq.com/ldap.html">https://www.rabbitmq.com/ldap.html</A> and
<A HREF="http://www.rabbitmq.com/ssl.html">http://www.rabbitmq.com/ssl.html</A> tutorials and created the following
rabbitmq.config:

[ 
  {rabbit, [
    {auth_backends, [rabbit_auth_backend_ldap]},
    {ssl_listeners, [{&quot;127.0.0.1&quot;, 5671},
                     {&quot;rabbit.example.com&quot;, 5671}
    ]},
    {ssl_options, [
      {cacertfile, &quot;/etc/rabbitmq/certs/cacert-all.pem&quot;},
      {certfile, &quot;/etc/rabbitmq/certs/cert-server.pem&quot;},
      {keyfile, &quot;/etc/rabbitmq/certs/key-server.pem&quot;},
      {verify, verify_peer},
      {fail_if_no_peer_cert, true}
    ]},
    {auth_mechanisms, ['EXTERNAL']},
    {ssl_cert_login_from, common_name}
  ]},
  {rabbitmq_auth_backend_ldap, [
    {servers,               [&quot;localhost&quot;]},
    {dn_lookup_attribute,   &quot;myLoginName&quot;},
    {dn_lookup_base,        &quot;dc=example,dc=com&quot;},
    {other_bind, {
      &quot;myLoginName=rabbit-component,ou=it-components,dc=example,dc=com&quot;,
      &quot;my-secret-password&quot;}},
    {use_ssl,               true},
    {port,                  636},
    {log,                   true},
    {resource_access_query,
      {equals,
        {string, &quot;${user_dn}&quot;},
        {string, &quot;myLoginName=bob,ou=our-users,dc=example,dc=com&quot;}
      }
    }
  ]}
].


The expected sequence of events is as the following:

1. A client connects and shows its TLS/SSL client certificate and the
   RabbitMQ server verifies it (see `ssl_options` above).

2. RabbitMQ binds to OpenLDAP server using fixed rabbit-specific
   credentials (see `other_bind` above).

3. The common name (CN) from the certificate becomes the ${username}
   (see `ssl_cert_login_from` above). RabbitMQ searches in OpenLDAP
   for entry whose myLoginName is equal to the ${username} (see
   `dn_lookup_attribute` and `dn_lookup_base`).

4. The entry's becomes the ${user_dn}. Then RabbitMQ can check ACLs
   (`resource_access_query` etc.)...


Everything works fine, except point #4.  A fragment from logs:

 ** {{badmatch,undefined},
     [{rabbit_auth_backend_ldap,username_to_dn,3,[]},
      {rabbit_auth_backend_ldap,do_login,4,[]},
      {rabbit_auth_backend_ldap,with_ldap,3,[]},
      {rabbit_auth_backend_ldap,handle_call,3,[]},
      {gen_server,handle_msg,5,[{file,&quot;gen_server.erl&quot;},{line,588}]},
      {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,227}]}]}


I investigated the problem and learned that the list of entries
returned from the search triggered in the following function is empty
(no entries are returned).

From rabbitmq-auth-backend-ldap/src/rabbit_auth_backend_ldap.erl:

 username_to_dn(Username, LDAP, Attr) -&gt;
     Filled = fill_user_dn_pattern(Username),
     case eldap:search(LDAP,
                       [{base, env(dn_lookup_base)},
                        {filter, eldap:equalityMatch(Attr, Filled)},
                        {attributes, [&quot;distinguishedName&quot;]}]) of
         {ok, #eldap_search_result{entries = [#eldap_entry{attributes = A}]}} -&gt;
             [DN] = pget(&quot;distinguishedName&quot;, A),
             DN;
         {ok, #eldap_search_result{entries = Entries}} -&gt;
             rabbit_log:warning(&quot;Searching for DN for ~s, got back ~p~n&quot;,
                                [Filled, Entries]), Filled;
         {error, _} = E -&gt;
             exit(E) end.


It seems that 'distinguishedName' (DN) is not treated (by OpenLDAP?) as
a real LDAP attribute.

When I patched that function by replacing the lines:

         {ok, #eldap_search_result{entries = [#eldap_entry{attributes = A}]}} -&gt;
             [DN] = pget(&quot;distinguishedName&quot;, A),
with:
         {ok, #eldap_search_result{entries = [#eldap_entry{object_name = DN}]}} -&gt;

...everything started working.


Am I missing something or is it the only way to make the stuff work, at
least with OpenLDAP 2.4.31?

I tried all that stuff both with RabbitMQ (+ plugins):
* in version 2.8.4, and
* in version 3.2.1.


Cheers,
*j

-- 
Jan Kaliszewski &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jan.kaliszewski at nask.pl</A>&gt;
</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032411.html">[rabbitmq-discuss] rabbitmq_c Sometimes I get AMQP_STATUS_TIMER_FAILURE error on Win32
</A></li>
	<LI>Next message: <A HREF="032395.html">[rabbitmq-discuss] OpenLDAP-based auth with 'other_bind' option: no DN attribute?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32366">[ date ]</a>
              <a href="thread.html#32366">[ thread ]</a>
              <a href="subject.html#32366">[ subject ]</a>
              <a href="author.html#32366">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
