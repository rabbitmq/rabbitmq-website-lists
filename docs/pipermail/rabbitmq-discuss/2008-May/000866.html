<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] possible bug starting rabbit with NODENAME	set?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20possible%20bug%20starting%20rabbit%20with%20NODENAME%0A%09set%3F&In-Reply-To=482D3268.6070000%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000853.html">
   <LINK REL="Next"  HREF="000867.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] possible bug starting rabbit with NODENAME	set?</H1>
    <B>Edwin Fine</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20possible%20bug%20starting%20rabbit%20with%20NODENAME%0A%09set%3F&In-Reply-To=482D3268.6070000%40lshift.net"
       TITLE="[rabbitmq-discuss] possible bug starting rabbit with NODENAME	set?">rabbitmq-discuss_efine at usa.net
       </A><BR>
    <I>Fri May 16 22:36:16 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000853.html">[rabbitmq-discuss] possible bug starting rabbit with NODENAME set?
</A></li>
        <LI>Next message: <A HREF="000867.html">[rabbitmq-discuss] possible bug starting rabbit with NODENAME set?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#866">[ date ]</a>
              <a href="thread.html#866">[ thread ]</a>
              <a href="subject.html#866">[ subject ]</a>
              <a href="author.html#866">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthias,

I can also successfully run /usr/sbin/rabbitmq-server from the command line
if I change -sname to -name. I just have to make sure that I change the
actual mnesia dir to match the NODENAME.

But I think that in addition to the rabbit_multi script, rabbit_multi.erl
will need some serious tweaking. I think it was written with local
clustering in mind and did not adequately consider the effect of using
fully-qualified domain names with -name.

This is my analysis of the code and behavior. If I am mistaken, I am sure
you will point out where and why :)

Firstly, rabbit_multi.erl hard-codes the node name &quot;rabbit&quot;:

    NodeName = if NodeNumber == 0 -&gt;
                       %% For compatibility with running a single node
                       &quot;rabbit&quot;;
                  true -&gt;
                       &quot;rabbit_&quot; ++ integer_to_list(NodeNumber)
               end,
    {NodePid, Started} = start_node(NodeName, &quot;0.0.0.0&quot;, 5672 + NodeNumber,
                                    RpcTimeout),

and then goes on to cut everything off after the &quot;@&quot; in the node name in
localnode():

    Node = rabbit_misc:localnode(list_to_atom(NodeName)),
    case rpc:call(Node, os, getpid, []) of

Even if NodeName wasn't hard-coded to &quot;rabbit&quot;, localnode would strip off
everything after the &quot;@&quot; anyway. Now if <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at myexample.com</A> were running
locally, but using -name, the rpc call would fail because erlang would want
the full node name.

Anyway, the rpc fails because rabbit isn't running yet, so rabbit_multi will
now try to start it (but it will fail for reasons mentioned above). Just
prior to this, to add insult to injury, the code blasts any environment
values that might have existed. This explains the behavior of why RabbitMQ
times out waiting for Mnesia to start. It can't find the node. Even if I
called the node '<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at something.com</A>' and not '<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">grendel at something.com</A>', it
would not work because it would be trying to rpc to 'rabbit', which does not
and never will exist while starting up with -name.

start_node(NodeName, NodeIPAddress, NodePort, RpcTimeout) -&gt;
    os:putenv(&quot;NODENAME&quot;, NodeName),
    os:putenv(&quot;NODE_IP_ADDRESS&quot;, NodeIPAddress),
    os:putenv(&quot;NODE_PORT&quot;, integer_to_list(NodePort)),
    Node = rabbit_misc:localnode(list_to_atom(NodeName)),
    case rpc:call(Node, os, getpid, []) of
        {badrpc, _} -&gt;
            Port = run_cmd(script_filename()),
            Started = wait_for_rabbit_to_start(Node, RpcTimeout, Port),
            Pid = case rpc:call(Node, os, getpid, []) of
                      {badrpc, _} -&gt; throw(cannot_get_pid);
                      PidS -&gt; list_to_integer(PidS)
                  end,
            {{Node, Pid}, Started};
        PidS -&gt;
            Pid = list_to_integer(PidS),
            throw({node_already_running, Node, Pid})
    end.

I respectfully suggest that some more thought needs to go into
rabbit_multi.erl and perhaps the startup/node name architecture.

Regards,
Edwin

On Fri, May 16, 2008 at 3:06 AM, Matthias Radestock &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt;
wrote:

&gt;<i> Edwin,
</I>&gt;<i>
</I>&gt;<i> Edwin Fine wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On this topic, does RabbitMQ have to use a short name (-sname) for its
</I>&gt;&gt;<i> node name? I had issues trying to use -name instead of -sname.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> changing rabbitmq-server to use -name instead of -sname works fine for me,
</I>&gt;<i> though rabbitmq-multi would need some tweaking to get working again after
</I>&gt;<i> such a change.
</I>&gt;<i>
</I>&gt;<i> What problems did you encounter?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080516/ff200040/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080516/ff200040/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000853.html">[rabbitmq-discuss] possible bug starting rabbit with NODENAME set?
</A></li>
	<LI>Next message: <A HREF="000867.html">[rabbitmq-discuss] possible bug starting rabbit with NODENAME set?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#866">[ date ]</a>
              <a href="thread.html#866">[ thread ]</a>
              <a href="subject.html#866">[ subject ]</a>
              <a href="author.html#866">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
