<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Channel%20crashes%20after%20basic.cancel_ok.&In-Reply-To=6c2563b20805072213i60e40d2do3ed0bbbf9f72057a%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000812.html">
   <LINK REL="Next"  HREF="000809.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Channel crashes after basic.cancel_ok.</H1>
    <B>Ben Hood</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Channel%20crashes%20after%20basic.cancel_ok.&In-Reply-To=6c2563b20805072213i60e40d2do3ed0bbbf9f72057a%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Channel crashes after basic.cancel_ok.">0x6e6562 at gmail.com
       </A><BR>
    <I>Thu May  8 11:07:05 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000812.html">[rabbitmq-discuss] Channel crashes after basic.cancel_ok.
</A></li>
        <LI>Next message: <A HREF="000809.html">[rabbitmq-discuss] Channel crashes after basic.cancel_ok.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#808">[ date ]</a>
              <a href="thread.html#808">[ thread ]</a>
              <a href="subject.html#808">[ subject ]</a>
              <a href="author.html#808">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ed,

On 8 May 2008, at 06:13, Edwin Fine wrote:
&gt;<i>
</I>&gt;<i> Well, I have put most of the code I am using into a test program  
</I>&gt;<i> (two modules). This code is not for the mailing list's consumption,  
</I>&gt;<i> if that's ok with you. The problem is, I can't even make the code  
</I>&gt;<i> work for more than 1 consumer and I don't know why. I think I am too  
</I>&gt;<i> tired. In any case, the two modules included are:
</I>&gt;<i> rabbit_chan_crash.erl - The actual test program, which contains most  
</I>&gt;<i> of the Rabbit-related working code;
</I>I've run you code. The problem that that you are executing synchronous  
RPCs on the same channel concurrently, which doesn't work, because the  
protocol flow stipulates that a client performs a blocking receive for  
synchronous commands within a channel.

By doing this though, you have uncovered a bug in the synchronous RPC  
handling code in the client that doesn't protect against this  
properly. So I've fixed this bug and will send it down to the  
repository.

This will not solve your problem, it will just make a clearer  
indication of what went wrong. When designing the client, we  
deliberated whether the client channel module should contain the  
intelligence to queue up pending RPC requests in order to accept  
concurrent requests from user code and essentially serialize their  
dispatch to the server. Initially, we decided against this approach  
because of the complexity it introduces. In general, queue declaration  
and binding is an operation that you don't need to perform  
concurrently per channel. While I think that this view is still valid,  
your use case may provide some food for thought. Thoughts anyone?

To solve your problem, you can do one of a few things:

1. Refactor your code so that synchronous RPCs are not executed in  
parallel (e.g. QueueDeclare, QueueBind, etc) within one channel process;
2. Manage by exception - catch an illegal_pending_rpc error (which is  
the bug fix I just put in) and resend the request;
3. Use more channel processes - this *may* be a bit heavy weight for  
the TCP client, this is better suited to the direct client.

If you want to go down route 2, let me know because we're currently in  
the process of moving the source code from monotone to mercurial.

BTW, I see that you've made a local modification to the  
amqp_connection module to export the start/4 function which allows the  
caller to specify a virtual host. This is probably a good idea and we  
may incorporate this into the API.

&gt;<i> rbmq_admin.erl - An interface to the admin part of Rabbit that I  
</I>&gt;<i> wrote because I wanted to be able to create exchanges, users, etc  
</I>&gt;<i> from within Erlang instead of the command line. Feel free to use  
</I>&gt;<i> this if you think it's of any use, or improve it - feedback welcome.  
</I>&gt;<i> Actually, at some point I want to write a full Web admin interface  
</I>&gt;<i> for Rabbit. Real Soon Now.
</I>Glad you've mentioned this topic. I've done some initial work of doing  
some remote management of Rabbit, if and when you actually want to get  
going, it will probably be a good idea to start a separate discussion  
thread on this one. There are many design issues that would need to be  
discussed, most importantly dependencies that may arise.


&gt;<i> To compile you will need all the usual RabbitMQ paths, and the  
</I>&gt;<i> Erlang client of course. You will also need .erlang.cookie or  
</I>&gt;<i> setcookie with your Rabbit's cookie. I am pretty sure there are no  
</I>&gt;<i> external dependencies other than Rabbit and Erlang.
</I>&gt;<i>
</I>&gt;<i> To run is simple (but please note that the code will try to create a  
</I>&gt;<i> user named emf_test, and an exchange and a bunch of queues). Feel  
</I>&gt;<i> free to hack into shape if you have the time and interest. Tomorrow  
</I>&gt;<i> I will try to run Rabbit and my code co-located.
</I>&gt;<i>
</I>&gt;<i> &gt;rabbit_chan_crash:go(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mynode</A>, NumConsumers, NumMsgsPerSec).
</I>&gt;<i> &gt;rabbit_chan_crash:stop(). % If you can even read the screen to type  
</I>&gt;<i> this in :)
</I>&gt;<i>
</I>&gt;<i> When I use rabbit_chan_crash:go(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mynode</A>, 1, 10) it's all good.
</I>&gt;<i> When I use rabbit_chan_crash:go(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mynode</A>, 2, 10) it's all bad.  
</I>&gt;<i> I don't know what I am doing wrong, but my other code works (each  
</I>&gt;<i> consumer is in its own gen_event server, which is probably why. I  
</I>&gt;<i> think I am getting messages in the wrong message queues due to my  
</I>&gt;<i> lack of Erlang experience. And I am tired, too).
</I>&gt;<i>
</I>&gt;<i> Anyway I have included the &quot;bad&quot; output.
</I>&gt;<i>
</I>&gt;<i> If you have any luck please let me know. Feedback welcome, too.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Ed
</I>&gt;<i>
</I>&gt;<i> (<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">xhg at ender</A>)3&gt; rabbit_chan_crash:go(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ender</A>,2,10).
</I>&gt;<i> Setting up channel on realm &lt;&lt;&quot;/data&quot;&gt;&gt; for connection  
</I>&gt;<i> {&lt;0.60.0&gt;,network}
</I>&gt;<i> Access granted for channel &lt;0.65.0&gt; on realm &lt;&lt;&quot;/data&quot;&gt;&gt; for  
</I>&gt;<i> connection {&lt;0.60.0&gt;,
</I>&gt;<i>                                                                          network 
</I>&gt;<i> }
</I>&gt;<i> Declaring exchange &lt;&lt;&quot;emf_test&quot;&gt;&gt; using ticket 101
</I>&gt;<i> Declared exchange &lt;&lt;&quot;emf_test&quot;&gt;&gt; using ticket 101
</I>&gt;<i> Declaring queue &lt;&lt;&quot;EMF_TEST_Q.1&quot;&gt;&gt;
</I>&gt;<i> Declared queue &lt;&lt;&quot;EMF_TEST_Q.1&quot;&gt;&gt;, msgc = 0, cons_c = 0
</I>&gt;<i> Declaring queue &lt;&lt;&quot;EMF_TEST_Q.2&quot;&gt;&gt;
</I>&gt;<i> Declared queue &lt;&lt;&quot;EMF_TEST_Q.2&quot;&gt;&gt;, msgc = 0, cons_c = 0
</I>&gt;<i> Environment setup complete, rmq_state =
</I>&gt;<i> {rmq_state,&quot;guest&quot;,&quot;guest&quot;,
</I>&gt;<i>            {&lt;0.60.0&gt;,network},
</I>&gt;<i>            &lt;0.65.0&gt;,101,&lt;&lt;&quot;emf_test&quot;&gt;&gt;,&lt;&lt;&quot;/data&quot;&gt;&gt;,&lt;&lt;&quot;/emf_test&quot;&gt;&gt;,
</I>&gt;<i>            <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ender</A>,2}
</I>&gt;<i> Consumers started: [&lt;0.69.0&gt;,&lt;0.70.0&gt;]
</I>&gt;<i> [&lt;0.69.0&gt;] Started consumer tag &lt;&lt;&quot;EMF_TEST_Q.1&quot;&gt;&gt; for existing  
</I>&gt;<i> channel/ticket/queue &lt;0.65.0&gt;/101/&lt;&lt;&quot;EMF_TEST_Q.1&quot;&gt;&gt;
</I>&gt;<i> [&lt;0.70.0&gt;] Started consumer tag &lt;&lt;&quot;EMF_TEST_Q.2&quot;&gt;&gt; for existing  
</I>&gt;<i> channel/ticket/queue &lt;0.65.0&gt;/101/&lt;&lt;&quot;EMF_TEST_Q.2&quot;&gt;&gt;
</I>&gt;<i> &lt;0.68.0&gt;
</I>&gt;<i> Producer started: &lt;0.71.0&gt;
</I>&gt;<i> Binding queue &lt;&lt;&quot;EMF_TEST_Q.1&quot;&gt;&gt;, ticket 101, exchange  
</I>&gt;<i> &lt;&lt;&quot;emf_test&quot;&gt;&gt;, routing key &lt;&lt;&quot;EMF_TEST_Q.1&quot;&gt;&gt;
</I>&gt;<i> Binding queue &lt;&lt;&quot;EMF_TEST_Q.2&quot;&gt;&gt;, ticket 101, exchange  
</I>&gt;<i> &lt;&lt;&quot;emf_test&quot;&gt;&gt;, routing key &lt;&lt;&quot;EMF_TEST_Q.2&quot;&gt;&gt;
</I>&gt;<i> Bound queue &lt;&lt;&quot;EMF_TEST_Q.2&quot;&gt;&gt; to exchange &lt;&lt;&quot;emf_test&quot;&gt;&gt;
</I>&gt;<i> Subscribing consumer &lt;&lt;&quot;EMF_TEST_Q.2&quot;&gt;&gt; to channel &lt;0.65.0&gt;
</I>&gt;<i> (<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">xhg at ender</A>)4&gt;
</I>&gt;<i> =ERROR REPORT==== 8-May-2008::00:57:23 ===
</I>&gt;<i> ** Generic server &lt;0.65.0&gt; terminating
</I>&gt;<i> ** Last message in was {method,{'basic.consume_ok',&lt;&lt;&quot;EMF_TEST_Q. 
</I>&gt;<i> 2&quot;&gt;&gt;},none}
</I>&gt;<i> ** When Server state == {channel_state,1,&lt;0.60.0&gt;,&lt;0.62.0&gt;,&lt;0.66.0&gt;,
</I>&gt;<i>                             #Fun&lt;amqp_network_driver.do.2&gt;,
</I>&gt;<i>                             #Fun&lt;amqp_network_driver.do. 
</I>&gt;<i> 3&gt;,&lt;&lt;&gt;&gt;,&lt;0.70.0&gt;,
</I>&gt;<i>                             false,undefined,
</I>&gt;<i>                             {dict,0,16,16,8,80,48,
</I>&gt;<i>                                 {[],[],[],[],[],[],[],[],[],[],[],[], 
</I>&gt;<i> [],[],[],
</I>&gt;<i>                                  []},
</I>&gt;<i>                                 {{[],[],[],[],[],[],[],[],[],[],[], 
</I>&gt;<i> [],[],[],
</I>&gt;<i>                                   [],[]}}}}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** {function_clause,[{gen_server,reply,
</I>&gt;<i>                                  [&lt;&lt;&gt;&gt;,
</I>&gt;<i>                                   {'basic.consume_ok',&lt;&lt;&quot;EMF_TEST_Q. 
</I>&gt;<i> 2&quot;&gt;&gt;}]},
</I>&gt;<i>                      {amqp_channel,rpc_bottom_half,2},
</I>&gt;<i>                      {amqp_channel,handle_method,2},
</I>&gt;<i>                      {gen_server,handle_msg,5},
</I>&gt;<i>                      {proc_lib,init_p,5}]}
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 8-May-2008::00:57:23 ===
</I>&gt;<i> Error in process &lt;0.70.0&gt; on node '<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">xhg at ender</A>' with exit value:  
</I>&gt;<i> {{badmatch,{'queue.bind_ok'}},[{rabbit_chan_crash,subscribe,2}, 
</I>&gt;<i> {rabbit_chan_crash,consumer,5}]}
</I>&gt;<i> ---------
</I>

HTH,

Ben

PS I'm attaching your code to the list for reference.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment.htm</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: chan_crash_test_src.tar.gz
Type: application/x-gzip
Size: 5093 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment.bin</A> 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment-0001.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080508/220b5f1c/attachment-0001.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000812.html">[rabbitmq-discuss] Channel crashes after basic.cancel_ok.
</A></li>
	<LI>Next message: <A HREF="000809.html">[rabbitmq-discuss] Channel crashes after basic.cancel_ok.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#808">[ date ]</a>
              <a href="thread.html#808">[ thread ]</a>
              <a href="subject.html#808">[ subject ]</a>
              <a href="author.html#808">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
