<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] TCP timeouts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20TCP%20timeouts&In-Reply-To=4823E980.9040205%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000813.html">
   <LINK REL="Next"  HREF="000821.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] TCP timeouts</H1>
    <B>Holger Hoffst&#228;tte</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20TCP%20timeouts&In-Reply-To=4823E980.9040205%40lshift.net"
       TITLE="[rabbitmq-discuss] TCP timeouts">holger at wizards.de
       </A><BR>
    <I>Fri May  9 13:07:12 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000813.html">[rabbitmq-discuss] TCP timeouts
</A></li>
        <LI>Next message: <A HREF="000821.html">[rabbitmq-discuss] TCP timeouts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#819">[ date ]</a>
              <a href="thread.html#819">[ thread ]</a>
              <a href="subject.html#819">[ subject ]</a>
              <a href="author.html#819">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Non-Erlang-related-Java-is-funny-offtopic warning!

&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">David.Corcoran at edftrading.com</A> wrote:
</I>&gt;&gt;<i> It looks like you were right about the java version. Running in java
</I>&gt;&gt;<i> 1.5.0.15 doesn't work. Running in java-6-openjdk or java-6 (1.6.0.06) works
</I>&gt;&gt;<i> fine. I think it's a bug, perhaps related to this:
</I>&gt;&gt;<i> <A HREF="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6383015">http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6383015</A>
</I>&gt;<i> 
</I>&gt;<i> Interesting. Yes, that looks like it would explain the behaviour you saw.
</I>
A very interesting anomaly indeed, especially considering that it only 
seems to affect 1.5, not 1.4 or 1.6. However, as far as I can tell this 
behaviour can only occur with one CPU. I bet that David's test will run 
fine when he enables more cores and/or starts running &quot;real&quot; code in the 
process() method - meaning: code that creates garbage and doesn't just 
repeatedly busy-waits on a native method, which accidentally must also 
obey special synchronization rules. David, could you please try this if it 
is not too inconvenient?
Ideally process() should run in a sepate thread anyway so that the 
controlling thread can properly wait for a result or - more importantly - 
cancel the computation if necessary.

&gt;<i> In the absence of even the most basic fairness guarantees from the jvm - 
</I>&gt;<i> such as no starvation - asking programmers to insert Thread.yield() in 
</I>&gt;<i> strategic places is about he best you can do.
</I>
Unfortunately this might not have the effect that one expects, as yield() is:

- free to be implemented as no-op; I think that at one point the server VM 
  explicitly optimized it away

- implemented differently in various versions of the JVM, both client and 
server

- dependent on OS- and GC-algorithm: for a fun time, search for &quot;yield&quot; in 
<A HREF="http://openjdk.neojava.org/hotspot/xref/src/share/vm/runtime/globals.hpp">http://openjdk.neojava.org/hotspot/xref/src/share/vm/runtime/globals.hpp</A>

- yielding native threads might not even work according to the general 
expectations of either apps or the JVM: until recently (or since then, 
depending on point of view) Linux didn't really yield() &quot;correctly&quot; 
(according to POSIX), resulting in..yet another magic kernel flag! 
Hilarious discussion in: <A HREF="http://kerneltrap.org/Linux/CFS_and_sched_yield">http://kerneltrap.org/Linux/CFS_and_sched_yield</A>

IMHO sprinkling yield() or sleeps() across a codebase has a definite 
&quot;magic pixie dust&quot; smell, and should be avoided at all costs. The JCIP 
book explains all this in chapter 10.3.1 (&quot;Starvation&quot;) and pretty much 
only recommends yields/sleep to create artificial delays when debugging 
(to create races).

Besides, LockSupport.parkNanos() sounds much more advanced anyway. :-)

-h



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000813.html">[rabbitmq-discuss] TCP timeouts
</A></li>
	<LI>Next message: <A HREF="000821.html">[rabbitmq-discuss] TCP timeouts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#819">[ date ]</a>
              <a href="thread.html#819">[ thread ]</a>
              <a href="subject.html#819">[ subject ]</a>
              <a href="author.html#819">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
