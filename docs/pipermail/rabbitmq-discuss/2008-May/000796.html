<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Channel crashes after basic.cancel_ok.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Channel%20crashes%20after%20basic.cancel_ok.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000800.html">
   <LINK REL="Next"  HREF="000797.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Channel crashes after basic.cancel_ok.</H1>
    <B>Edwin Fine</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Channel%20crashes%20after%20basic.cancel_ok.&In-Reply-To="
       TITLE="[rabbitmq-discuss] Channel crashes after basic.cancel_ok.">rabbitmq-discuss_efine at usa.net
       </A><BR>
    <I>Wed May  7 18:57:53 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000800.html">[rabbitmq-discuss] Controlling over-producers
</A></li>
        <LI>Next message: <A HREF="000797.html">[rabbitmq-discuss] Channel crashes after basic.cancel_ok.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#796">[ date ]</a>
              <a href="thread.html#796">[ thread ]</a>
              <a href="subject.html#796">[ subject ]</a>
              <a href="author.html#796">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Using Rabbit 1.3.0, Erlang client, Ubuntu Linux Feisty, Erlang R12B-2 64-bit

Consumer channel crashes as follows when I do the following:

1. Subscribe (basic.consume)
2. Unsubscribe (basic.cancel)

The channel crashes handling the basic.cancel_ok. I can't figure out
why. The channel is under some load (about 100 - 130 messages/second).
I haven't yet built a standalone test case to try to reproduce this,
but it happens consistently in my code.

The code to subscribe is:

    #'basic.consume_ok'{consumer_tag = ConsumerTag} =
amqp_channel:call(Channel, BasicConsume, self())

and this works fine.

The code to cancel is

    BasicCancel = #'basic.cancel'{consumer_tag = ConsumerTag, nowait = false},
    #'basic.cancel_ok'{consumer_tag = ConsumerTag} =
amqp_channel:call(Channel, BasicCancel).

The problem seems to be

** {function_clause,
       [{gen_server,reply,
            [&lt;&lt;&gt;&gt;,
             {'basic.cancel_ok',&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP031.HC031&quot;&gt;&gt;}]},


What am I doing wrong? Any ideas?
Regards,
Edwin Fine
----------------------------------

=ERROR REPORT==== 7-May-2008::13:42:16 ===
** Generic server &lt;0.138.0&gt; terminating
** Last message in was {method,
                           {'basic.cancel_ok',
                               &lt;&lt;&quot;XHG.DELIVERY.Q.HTTP031.HC031&quot;&gt;&gt;},
                           none}
** When Server state == {channel_state,1,&lt;0.132.0&gt;,&lt;0.136.0&gt;,&lt;0.139.0&gt;,
                            #Fun&lt;amqp_network_driver.do.2&gt;,
                            #Fun&lt;amqp_network_driver.do.3&gt;,&lt;&lt;&gt;&gt;,&lt;&lt;&gt;&gt;,false,
                            undefined,
                            {dict,48,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],
                                  [[&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP016.HC016&quot;&gt;&gt;|
                                    &lt;0.145.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP038.HC038&quot;&gt;&gt;|
                                    &lt;0.295.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP009.HC009&quot;&gt;&gt;|
                                    &lt;0.358.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP023.HC023&quot;&gt;&gt;|
                                    &lt;0.522.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP001.HC001&quot;&gt;&gt;|
                                    &lt;0.905.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP030.HC030&quot;&gt;&gt;|
                                    &lt;0.1109.0&gt;]],
                                  [],
                                  [[&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP002.HC002&quot;&gt;&gt;|
                                    &lt;0.150.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP017.HC017&quot;&gt;&gt;|
                                    &lt;0.1014.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP024.HC024&quot;&gt;&gt;|
                                    &lt;0.1062.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP031.HC031&quot;&gt;&gt;|
                                    &lt;0.1115.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP039.HC039&quot;&gt;&gt;|
                                    &lt;0.1170.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP046.HC046&quot;&gt;&gt;|
                                    &lt;0.1220.0&gt;]],
                                  [],
                                  [[&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP003.HC003&quot;&gt;&gt;|
                                    &lt;0.919.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP010.HC010&quot;&gt;&gt;|
                                    &lt;0.967.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP018.HC018&quot;&gt;&gt;|
                                    &lt;0.1025.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP025.HC025&quot;&gt;&gt;|
                                    &lt;0.1073.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP032.HC032&quot;&gt;&gt;|
                                    &lt;0.1118.0&gt;]],
                                  [],
                                  [[&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP019.HC019&quot;&gt;&gt;|
                                    &lt;0.154.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP033.HC033&quot;&gt;&gt;|
                                    &lt;0.354.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP004.HC004&quot;&gt;&gt;|
                                    &lt;0.927.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP011.HC011&quot;&gt;&gt;|
                                    &lt;0.970.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP026.HC026&quot;&gt;&gt;|
                                    &lt;0.1076.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP040.HC040&quot;&gt;&gt;|
                                    &lt;0.1181.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP048.HC048&quot;&gt;&gt;|
                                    &lt;0.1233.0&gt;]],
                                  [],
                                  [[&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP049.HC049&quot;&gt;&gt;|
                                    &lt;0.365.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP005.HC005&quot;&gt;&gt;|
                                    &lt;0.930.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP012.HC012&quot;&gt;&gt;|
                                    &lt;0.980.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP027.HC027&quot;&gt;&gt;|
                                    &lt;0.1088.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP034.HC034&quot;&gt;&gt;|
                                    &lt;0.1130.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP041.HC041&quot;&gt;&gt;|
                                    &lt;0.1185.0&gt;]],
                                  [],
                                  [[&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP006.HC006&quot;&gt;&gt;|
                                    &lt;0.940.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP013.HC013&quot;&gt;&gt;|
                                    &lt;0.988.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP020.HC020&quot;&gt;&gt;|
                                    &lt;0.1039.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP028.HC028&quot;&gt;&gt;|
                                    &lt;0.1092.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP035.HC035&quot;&gt;&gt;|
                                    &lt;0.1147.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP042.HC042&quot;&gt;&gt;|
                                    &lt;0.1188.0&gt;]],
                                  [],
                                  [[&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP050.HC050&quot;&gt;&gt;|
                                    &lt;0.226.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP007.HC007&quot;&gt;&gt;|
                                    &lt;0.299.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP014.HC014&quot;&gt;&gt;|
                                    &lt;0.998.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP021.HC021&quot;&gt;&gt;|
                                    &lt;0.1042.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP029.HC029&quot;&gt;&gt;|
                                    &lt;0.1097.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP036.HC036&quot;&gt;&gt;|
                                    &lt;0.1151.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP043.HC043&quot;&gt;&gt;|
                                    &lt;0.1202.0&gt;]],
                                  [],
                                  [[&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP008.HC008&quot;&gt;&gt;|
                                    &lt;0.953.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP015.HC015&quot;&gt;&gt;|
                                    &lt;0.1001.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP022.HC022&quot;&gt;&gt;|
                                    &lt;0.1049.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP037.HC037&quot;&gt;&gt;|
                                    &lt;0.1153.0&gt;],
                                   [&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP044.HC044&quot;&gt;&gt;|
                                    &lt;0.1205.0&gt;]]}}}}
** Reason for termination ==
** {function_clause,
       [{gen_server,reply,
            [&lt;&lt;&gt;&gt;,
             {'basic.cancel_ok',&lt;&lt;&quot;XHG.DELIVERY.Q.HTTP031.HC031&quot;&gt;&gt;}]},
        {amqp_channel,rpc_bottom_half,2},
        {gen_server,handle_msg,5},
        {proc_lib,init_p,5}]}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000800.html">[rabbitmq-discuss] Controlling over-producers
</A></li>
	<LI>Next message: <A HREF="000797.html">[rabbitmq-discuss] Channel crashes after basic.cancel_ok.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#796">[ date ]</a>
              <a href="thread.html#796">[ thread ]</a>
              <a href="subject.html#796">[ subject ]</a>
              <a href="author.html#796">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
