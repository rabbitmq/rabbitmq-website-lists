<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Question about initial cluster connect &amp;	client-side cluster awareness
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Question%20about%20initial%20cluster%20connect%0A%20%26%09client-side%20cluster%20awareness&In-Reply-To=48D27D58.8020707%40wizards.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001519.html">
   <LINK REL="Next"  HREF="001530.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Question about initial cluster connect &amp;	client-side cluster awareness</H1>
    <B>Dmitriy Samovskiy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Question%20about%20initial%20cluster%20connect%0A%20%26%09client-side%20cluster%20awareness&In-Reply-To=48D27D58.8020707%40wizards.de"
       TITLE="[rabbitmq-discuss] Question about initial cluster connect &amp;	client-side cluster awareness">dmitriy.samovskiy at cohesiveft.com
       </A><BR>
    <I>Thu Sep 18 17:50:57 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001519.html">[rabbitmq-discuss] Question about initial cluster connect &amp;	client-side cluster awareness
</A></li>
        <LI>Next message: <A HREF="001530.html">[rabbitmq-discuss] Question about initial cluster connect	&amp;	client-side cluster awareness
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1520">[ date ]</a>
              <a href="thread.html#1520">[ thread ]</a>
              <a href="subject.html#1520">[ subject ]</a>
              <a href="author.html#1520">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Holger,

Holger Hoffst&#228;tte wrote:
&gt;<i> I've been experimenting with a cluster of rabbits (keeping the current
</I>&gt;<i> limitations in mind) and was wondering about the client side of things.
</I>&gt;<i> How should the problem of the initial connection be approached? As far as
</I>&gt;<i> I can tell there are no built-in mechanisms in place to have a client
</I>&gt;<i> 
</I>&gt;<i> - dynamically discover a broker or a cluster of nodes on a network
</I>&gt;<i> 
</I>&gt;<i> - try to connect to a number of hosts in order to get an initial connection
</I>Correct, there seems to be no built-in mechanism for this, probably because it's hard to 
come up with a one-size-fits-all solution for service discovery.

&gt;<i> - be aware of the available cluster nodes via the known_hosts field (as
</I>&gt;<i> described in the docs) so that when that node dies, the client can
</I>&gt;<i> automatically reconnect to a live member
</I>Speaking about known_hosts. There are several issues that I ran into in this area that you 
might want to know.

1. Rabbit populates known_hosts with hostnames as *it* knows them. What I mean by this is 
that if <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at host1</A> knows that its second cluster node runs on 10.1.1.1 and 10.1.1.1 is 
listed in host1:/etc/hosts as &quot;10.1.1.1 foo&quot;, it will populate known_hosts with 
&quot;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at host1</A><A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at foo</A>&quot;. Note that in this case foo needs to be resolvable by your 
clients as well, otherwise it's useless.

2. known_hosts appears useless if your clients reside in different network segments. What 
I mean by this is consider some clients inside firewall connecting to rabbit as 10.1.1.1 
and clients outside of firewall (from Internet) connecting to rabbit as 216.216.216.216. 
In this case, names appearing in known_hosts needs to be resolvable differently based on 
where client is coming from (there are issues with resolving non-FQDN &quot;foo&quot; outside of 
firewall too). With NAT and VIPs this becomes very difficult to manage for a generic case.

All in all, I personally found the best approach is not to rely on known_hosts at all, and 
tell each client (individually or as a group) IP addresses how they can connect to rabbit. 
I also found connection.redirect response to be useless in this scenario, so I always set 
insist to true when opening a connection. For load balancing, I use tcp level things like 
haproxy instead of AMQP-level techniques. My clients each implement reconnect logic 
individually.

Please note that known_hosts issues I described above are not specific to RabbitMQ. This 
is just the way AMQP (0-8 at least) is - it provides means for cluster node discovery 
after initial bootstrap only if all your clients are in the same network address space and 
have access to the same name resolution services. AMQP experts - I would love to hear your 
opinion on this one.



I am hoping we get more people on this list running rabbit clusters :)


Regards,
Dmitriy Samovskiy



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001519.html">[rabbitmq-discuss] Question about initial cluster connect &amp;	client-side cluster awareness
</A></li>
	<LI>Next message: <A HREF="001530.html">[rabbitmq-discuss] Question about initial cluster connect	&amp;	client-side cluster awareness
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1520">[ date ]</a>
              <a href="thread.html#1520">[ thread ]</a>
              <a href="subject.html#1520">[ subject ]</a>
              <a href="author.html#1520">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
