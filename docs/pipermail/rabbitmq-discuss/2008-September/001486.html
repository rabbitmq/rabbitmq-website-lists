<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ memory management
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20memory%20management&In-Reply-To=48CB95B4.2020706%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001478.html">
   <LINK REL="Next"  HREF="001487.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ memory management</H1>
    <B>Ben Hood</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20memory%20management&In-Reply-To=48CB95B4.2020706%40lshift.net"
       TITLE="[rabbitmq-discuss] RabbitMQ memory management">0x6e6562 at gmail.com
       </A><BR>
    <I>Sun Sep 14 11:53:13 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001478.html">[rabbitmq-discuss] RabbitMQ memory management
</A></li>
        <LI>Next message: <A HREF="001487.html">[rabbitmq-discuss] RabbitMQ memory management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1486">[ date ]</a>
              <a href="thread.html#1486">[ thread ]</a>
              <a href="subject.html#1486">[ subject ]</a>
              <a href="author.html#1486">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthias,

On Sat, Sep 13, 2008 at 11:28 AM, Matthias Radestock
&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Alexis Richardson wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> * provide a means to tell producers to back off, or alert an operator
</I>&gt;<i>
</I>&gt;<i> The easiest solution I can think of is to
</I>&gt;<i>
</I>&gt;<i> 1) configure Erlang's memsup
</I>&gt;<i> (<A HREF="http://www.erlang.org/doc/apps/os_mon/index.html">http://www.erlang.org/doc/apps/os_mon/index.html</A>) to trigger alarms
</I>&gt;<i> when memory consumption gets tight.
</I>&gt;<i>
</I>&gt;<i> This can be done without any code change; in the rabbitmq-server startup
</I>&gt;<i> script simply change the &quot;-os_mon start_memsup false&quot; to &quot;true&quot; and
</I>&gt;<i> adjust the thresholds with additional options of the form &quot;-memsup
</I>&gt;<i> &lt;param&gt; &lt;value&gt;&quot;
</I>&gt;<i>
</I>&gt;<i> When a threshold is reached, a message like this will appear in the
</I>&gt;<i> rabbit.log:
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 13-Sep-2008::10:59:37 ===
</I>&gt;<i>     alarm_handler: {set,{process_memory_high_watermark,&lt;0.31.0&gt;}}
</I>&gt;<i>
</I>&gt;<i> When the memory usage drops below the threshold again a similar message
</I>&gt;<i> is logged.
</I>&gt;<i>
</I>&gt;<i> One can also set up SNMP monitoring, but that is more complicated.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2) get queues to drop messages when memory consumption is above the
</I>&gt;<i> thresholds.
</I>&gt;<i>
</I>&gt;<i> This does require some coding, but not very much.
</I>&gt;<i>
</I>&gt;<i> We set up an alarm handler that informs all a node's queues when a &quot;high
</I>&gt;<i> memory&quot; alarm is set/cleared. Queues record that information as part of
</I>&gt;<i> their state.
</I>&gt;<i>
</I>&gt;<i> When a message is routed to a queue while the alarm is set, and the
</I>&gt;<i> queue cannot immediately route the message to an auto-ack consumer - in
</I>&gt;<i> other words, the message requires queueing - it discards the message. If
</I>&gt;<i> that happens and either the mandatory or immediate flag were set, and
</I>&gt;<i> the message could not be routed to any other queues / consumers, then
</I>&gt;<i> the message is returned to the sender with basic.return.
</I>&gt;<i>
</I>&gt;<i> We can think of other actions to take instead of discarding messages,
</I>&gt;<i> but the above is simple and neatly exploits the existing
</I>&gt;<i> mandatory/immediate functionality.
</I>
I think this is a good idea of how to use the mangement functionality
that comes with OTP. This is one of the reasons why we are using OTP
in the first place.

Ben


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001478.html">[rabbitmq-discuss] RabbitMQ memory management
</A></li>
	<LI>Next message: <A HREF="001487.html">[rabbitmq-discuss] RabbitMQ memory management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1486">[ date ]</a>
              <a href="thread.html#1486">[ thread ]</a>
              <a href="subject.html#1486">[ subject ]</a>
              <a href="author.html#1486">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
