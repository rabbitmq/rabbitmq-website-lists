<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Huge latency in Linux, compared with Leopard
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Huge%20latency%20in%20Linux%2C%20compared%20with%20Leopard&In-Reply-To=48DE7CFF.6080804%40wizards.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001634.html">
   <LINK REL="Next"  HREF="001637.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Huge latency in Linux, compared with Leopard</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Huge%20latency%20in%20Linux%2C%20compared%20with%20Leopard&In-Reply-To=48DE7CFF.6080804%40wizards.de"
       TITLE="[rabbitmq-discuss] Huge latency in Linux, compared with Leopard">matthias at lshift.net
       </A><BR>
    <I>Sat Sep 27 20:26:29 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001634.html">[rabbitmq-discuss] Huge latency in Linux, compared with Leopard
</A></li>
        <LI>Next message: <A HREF="001637.html">[rabbitmq-discuss] Huge latency in Linux, compared with Leopard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1635">[ date ]</a>
              <a href="thread.html#1635">[ thread ]</a>
              <a href="subject.html#1635">[ subject ]</a>
              <a href="author.html#1635">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Holger,

Holger Hoffst&#228;tte wrote:

&gt;<i> - the fixed penalty for small packets reminded me of good old Mr. Nagle
</I>&gt;<i> who is not your friend when it comes to latency..and behold! Setting
</I>&gt;<i> TCP_NODELAY in both the Java client's SocketFrameHandler and the Rabbit
</I>&gt;<i> startup script (as documented in inet: {nodelay, Boolean}) did the trick,
</I>&gt;<i> even *with* auto-ack!
</I>
Adding the line

     -kernel inet_default_listen_options '[{nodelay, true}]' \

to the options in the rabbitmq-server script does improve the results 
significantly.

When running the tests

   sh runjava.sh com.rabbitmq.examples.MulticastMain -r 100 -s 1024 -a

rather than getting min/avg/max latencies of 1500/25000/45000 
microseconds I now get 750/1000/1200 for 2 out of 3 results, though the 
third result is still off the scale.

Turning to the Java client and adding the line

           _socket.setTcpNoDelay(true);

to the SocketFrameHandler constructor reduced the figures to 450/500/750 
!! There's the occasional 1200 microsecond max, but that's nothing like 
the variation we saw before and is perfectly acceptable.

Thanks Holger for this excellent piece of investigative work.

So should we make TCP_NODELAY the default?


Matthias.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001634.html">[rabbitmq-discuss] Huge latency in Linux, compared with Leopard
</A></li>
	<LI>Next message: <A HREF="001637.html">[rabbitmq-discuss] Huge latency in Linux, compared with Leopard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1635">[ date ]</a>
              <a href="thread.html#1635">[ thread ]</a>
              <a href="subject.html#1635">[ subject ]</a>
              <a href="author.html#1635">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
