<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ memory management
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20memory%20management&In-Reply-To=167204d20809130207l5d3b95a0he7e067ff86b7d18b%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001477.html">
   <LINK REL="Next"  HREF="001486.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ memory management</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20memory%20management&In-Reply-To=167204d20809130207l5d3b95a0he7e067ff86b7d18b%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] RabbitMQ memory management">matthias at lshift.net
       </A><BR>
    <I>Sat Sep 13 11:28:04 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001477.html">[rabbitmq-discuss] RabbitMQ memory management
</A></li>
        <LI>Next message: <A HREF="001486.html">[rabbitmq-discuss] RabbitMQ memory management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1478">[ date ]</a>
              <a href="thread.html#1478">[ thread ]</a>
              <a href="subject.html#1478">[ subject ]</a>
              <a href="author.html#1478">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Alexis Richardson wrote:

&gt;<i> * provide a means to tell producers to back off, or alert an operator
</I>
The easiest solution I can think of is to

1) configure Erlang's memsup 
(<A HREF="http://www.erlang.org/doc/apps/os_mon/index.html">http://www.erlang.org/doc/apps/os_mon/index.html</A>) to trigger alarms 
when memory consumption gets tight.

This can be done without any code change; in the rabbitmq-server startup 
script simply change the &quot;-os_mon start_memsup false&quot; to &quot;true&quot; and 
adjust the thresholds with additional options of the form &quot;-memsup 
&lt;param&gt; &lt;value&gt;&quot;

When a threshold is reached, a message like this will appear in the 
rabbit.log:

=INFO REPORT==== 13-Sep-2008::10:59:37 ===
     alarm_handler: {set,{process_memory_high_watermark,&lt;0.31.0&gt;}}

When the memory usage drops below the threshold again a similar message 
is logged.

One can also set up SNMP monitoring, but that is more complicated.


2) get queues to drop messages when memory consumption is above the 
thresholds.

This does require some coding, but not very much.

We set up an alarm handler that informs all a node's queues when a &quot;high 
memory&quot; alarm is set/cleared. Queues record that information as part of 
their state.

When a message is routed to a queue while the alarm is set, and the 
queue cannot immediately route the message to an auto-ack consumer - in 
other words, the message requires queueing - it discards the message. If 
that happens and either the mandatory or immediate flag were set, and 
the message could not be routed to any other queues / consumers, then 
the message is returned to the sender with basic.return.


We can think of other actions to take instead of discarding messages, 
but the above is simple and neatly exploits the existing 
mandatory/immediate functionality.



Matthias.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001477.html">[rabbitmq-discuss] RabbitMQ memory management
</A></li>
	<LI>Next message: <A HREF="001486.html">[rabbitmq-discuss] RabbitMQ memory management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1478">[ date ]</a>
              <a href="thread.html#1478">[ thread ]</a>
              <a href="subject.html#1478">[ subject ]</a>
              <a href="author.html#1478">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
