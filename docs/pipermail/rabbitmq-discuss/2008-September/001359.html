<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [BUG] Erlang RabbitMQ client requires	installed server code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%5BBUG%5D%20Erlang%20RabbitMQ%20client%20requires%0A%09installed%20server%20code&In-Reply-To=6c2563b20809062356k1f492631m4b62e4a7e72ca9f9%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001358.html">
   <LINK REL="Next"  HREF="001361.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [BUG] Erlang RabbitMQ client requires	installed server code</H1>
    <B>Edwin Fine</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%5BBUG%5D%20Erlang%20RabbitMQ%20client%20requires%0A%09installed%20server%20code&In-Reply-To=6c2563b20809062356k1f492631m4b62e4a7e72ca9f9%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] [BUG] Erlang RabbitMQ client requires	installed server code">rabbitmq-discuss_efine at usa.net
       </A><BR>
    <I>Sun Sep  7 08:48:29 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001358.html">[rabbitmq-discuss] [BUG] Erlang RabbitMQ client requires installed	server code
</A></li>
        <LI>Next message: <A HREF="001361.html">[rabbitmq-discuss] [BUG] Erlang RabbitMQ client requires	installed server code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1359">[ date ]</a>
              <a href="thread.html#1359">[ thread ]</a>
              <a href="subject.html#1359">[ subject ]</a>
              <a href="author.html#1359">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> Further to my previous email, a minimal list of required modules for the
proposed &quot;rabbit_common&quot; application are listed below (these are the ones I
needed to get things up and running). I am going to make my own
rabbit_common OTP application, and change the Erlang client to depend on it
rather than the server. I will also see what it takes to change the rabbit
1.4.0 server itself to factor out the common code and to use this
rabbit_common application. Perhaps I can use Dialyzer to ensure that I get
all dependencies. If this would be of interest I would be glad to share it.

src/rabbit_binary_generator.erl
src/rabbit_misc.erl
src/rabbit_heartbeat.erl
src/rabbit_reader.erl
src/rabbit_framing_channel.erl
src/rabbit_writer.erl
src/rabbit_amqqueue.erl
src/rabbit_framing.erl
src/rabbit_binary_parser.erl
src/rabbit_channel.erl
include/rabbit_framing.hrl
include/rabbit_framing_spec.hrl
include/rabbit.hrl

Regards,
Edwin Fine

On Sun, Sep 7, 2008 at 2:56 AM, Edwin Fine
&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss_efine at usa.net</A>&gt;wrote:

&gt;<i> I had a surprise when trying to use the Erlang client on a node on which
</I>&gt;<i> RabbitMQ Server was not installed.
</I>&gt;<i>
</I>&gt;<i> =CRASH REPORT==== 7-Sep-2008::02:41:39 ===
</I>&gt;<i>   crasher:
</I>&gt;<i>     pid: &lt;0.165.0&gt;
</I>&gt;<i>     registered_name: []
</I>&gt;<i>     exception exit: {undef,
</I>&gt;<i> *                        [{rabbit_framing_channel,start_link,
</I>&gt;<i> *                             [#Fun&lt;amqp_network_driver.0.106693221&gt;,
</I>&gt;<i>                               [&lt;0.165.0&gt;]]},
</I>&gt;<i>                          {amqp_network_driver,handshake,1},
</I>&gt;<i>
</I>&gt;<i> A network client should not require server code to be installed on the same
</I>&gt;<i> node. This is certainly true of other clients I have used.
</I>&gt;<i>
</I>&gt;<i> On further investigation, I found a number of direct calls and references
</I>&gt;<i> to an installed server:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> amqp_channel.erl:-include_lib(&quot;rabbitmq_server/include/rabbit_framing.hrl&quot;).
</I>&gt;<i> amqp_channel.erl:    rabbit_amqqueue:notify_sent(Q, ChPid),
</I>&gt;<i>
</I>&gt;<i> amqp_connection.erl:-include_lib(&quot;rabbitmq_server/include/rabbit_framing.hrl&quot;).
</I>&gt;<i>
</I>&gt;<i> amqp_consumer.erl:-include_lib(&quot;rabbitmq_server/include/rabbit_framing.hrl&quot;).
</I>&gt;<i>
</I>&gt;<i> amqp_network_driver.erl:-include_lib(&quot;rabbitmq_server/include/rabbit_framing.hrl&quot;).
</I>&gt;<i> amqp_network_driver.erl:            FramingPid =
</I>&gt;<i> rabbit_framing_channel:start_link(fun(X) -&gt; X end, [Parent]),
</I>&gt;<i> amqp_network_driver.erl:    rabbit_writer:shutdown(WriterPid).
</I>&gt;<i> amqp_network_driver.erl:    rabbit_writer:send_command(Writer, Close),
</I>&gt;<i> amqp_network_driver.erl:    rabbit_writer:shutdown(Writer),
</I>&gt;<i> amqp_network_driver.erl:do(Writer, Method) -&gt;
</I>&gt;<i> rabbit_writer:send_command(Writer, Method).
</I>&gt;<i> amqp_network_driver.erl:do(Writer, Method, Content) -&gt;
</I>&gt;<i> rabbit_writer:send_command(Writer, Method, Content).
</I>&gt;<i> amqp_network_driver.erl:    rabbit_framing_channel:process(ChPid, Frame).
</I>&gt;<i> amqp_network_driver.erl:           response =
</I>&gt;<i> rabbit_binary_generator:generate_table(LoginTable),
</I>&gt;<i> amqp_network_driver.erl:    rabbit_writer:start(Sock, Channel,
</I>&gt;<i> ?FRAME_MIN_SIZE).
</I>&gt;<i> amqp_network_driver.erl:            rabbit_heartbeat:start_heartbeat(Sock,
</I>&gt;<i> Heartbeat),
</I>&gt;<i> amqp_network_driver.erl:    FramingPid =
</I>&gt;<i> rabbit_framing_channel:start_link(fun(X) -&gt; link(X), X end, [ChannelPid]),
</I>&gt;<i> amqp_network_driver.erl:    case rabbit_reader:analyze_frame(Type, Payload)
</I>&gt;<i> of
</I>&gt;<i> amqp_network_driver.erl:            rabbit_misc:die(frame_error);
</I>&gt;<i> amqp_network_driver.erl:            rabbit_misc:die(frame_error);
</I>&gt;<i>
</I>&gt;<i> amqp_rpc_client.erl:-include_lib(&quot;rabbitmq_server/include/rabbit_framing.hrl&quot;).
</I>&gt;<i> amqp_rpc_client.erl:               content_type = ContentType} =
</I>&gt;<i> rabbit_framing:decode_properties(ClassId, PropertiesBin),
</I>&gt;<i>
</I>&gt;<i> amqp_rpc_handler.erl:-include_lib(&quot;rabbitmq_server/include/rabbit_framing.hrl&quot;).
</I>&gt;<i> amqp_rpc_handler.erl:    = rabbit_framing:decode_properties(ClassId,
</I>&gt;<i> PropertiesBin),
</I>&gt;<i>
</I>&gt;<i> amqp_rpc_util.erl:-include_lib(&quot;rabbitmq_server/include/rabbit_framing.hrl&quot;).
</I>&gt;<i> amqp_util.erl:-include_lib(&quot;rabbitmq_server/include/rabbit_framing.hrl&quot;).
</I>&gt;<i>
</I>&gt;<i> I left out the direct driver modules because by definition they need to be
</I>&gt;<i> on the same node.
</I>&gt;<i>
</I>&gt;<i> I respectfully suggest that the above RabbitMQ server modules, and their
</I>&gt;<i> dependencies, be bundled with the Erlang client. Ideally, I would think it
</I>&gt;<i> would be best perhaps to put them a separate Erlang library application
</I>&gt;<i> (maybe &quot;rabbitmq_common&quot;) that is used both by the server and the Erlang
</I>&gt;<i> client.
</I>&gt;<i>
</I>&gt;<i> In addition to that, the include_lib(&quot;rabbitmq_server/include/xxx.hrl&quot;)
</I>&gt;<i> statements prevent one from even compiling the client unless the server is
</I>&gt;<i> installed and this should be changed to use the common library app. I was
</I>&gt;<i> forced to copy the include files and make a dummy rabbitmq_server
</I>&gt;<i> application to be able to compile the client on a different node to the
</I>&gt;<i> server.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Edwin Fine
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080907/3db504e3/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080907/3db504e3/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001358.html">[rabbitmq-discuss] [BUG] Erlang RabbitMQ client requires installed	server code
</A></li>
	<LI>Next message: <A HREF="001361.html">[rabbitmq-discuss] [BUG] Erlang RabbitMQ client requires	installed server code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1359">[ date ]</a>
              <a href="thread.html#1359">[ thread ]</a>
              <a href="subject.html#1359">[ subject ]</a>
              <a href="author.html#1359">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
