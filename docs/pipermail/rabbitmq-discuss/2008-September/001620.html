<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Clustering question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Clustering%20question&In-Reply-To=269388e30809191646x3c298082x7438c61e1bc3fcc6%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001552.html">
   <LINK REL="Next"  HREF="001512.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Clustering question</H1>
    <B>Dmitriy Samovskiy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Clustering%20question&In-Reply-To=269388e30809191646x3c298082x7438c61e1bc3fcc6%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Clustering question">dmitriy.samovskiy at cohesiveft.com
       </A><BR>
    <I>Fri Sep 26 16:23:01 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001552.html">[rabbitmq-discuss] Clustering question
</A></li>
        <LI>Next message: <A HREF="001512.html">[rabbitmq-discuss] AS3 AMQP Library
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1620">[ date ]</a>
              <a href="thread.html#1620">[ thread ]</a>
              <a href="subject.html#1620">[ subject ]</a>
              <a href="author.html#1620">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Ben Hood wrote:
&gt;<i> Dmitriy,
</I>&gt;<i> 
</I>&gt;<i> On Fri, Sep 19, 2008 at 4:59 PM, Dmitriy Samovskiy
</I>&gt;<i> wrote:
</I>&gt;&gt;&gt;<i> Were there any mnesia-related errors in the logs?
</I>&gt;&gt;<i> Yes, I see ** ERROR ** mnesia_event got {inconsistent_database,
</I>&gt;&gt;<i> running_partitioned_network in rabbit.log. My bad for writing to the list without looking
</I>&gt;&gt;<i> in the logs...
</I>&gt;<i> 
</I>I spent some time this week trying to understand this issue better. Please note however 
that I am not an Erlang expert, and it's quite possible I got it all wrong.


RabbitMQ Cluster consisting of 2 nodes running on 2 hosts will enter 
&quot;{inconsistent_database, running_partitioned_network}&quot; state any time when network 
connectivity between the hosts is lost for sufficiently long period of time *and* then 
restored *while* rabbit nodes remain up and running (connectivity loss must be long enough 
for rabbit to notice this). After this happens, mnesia tables will no longer be 
replicated. Which for us effectively means cluster is no longer a cluster - each rabbit 
node now acts as a standalone broker.

Note I may be wrong in saying &quot;must be long enough for rabbit to notice&quot; - haven't tested 
it well enough. In theory, it looks to me like cluster should not be impacted if 
connectivity loss was short.

I suspect based on what I read (but have not verified it) that if your cluster consists of 
N nodes where N &gt; 2, a partitioned network between any two all cause entire cluster to 
break down. I may be wrong here, possibly when some nodes are disk replicas and some nodes 
are ram replicas.


There is no common solution to this problem other than restart (entire node, or at least 
mnesia). Some people on erlang-questions reported running an external app to watch out for 
this state outside of distributed erlang, and then make a decision which nodes to restart 
or what else to do.


<A HREF="http://www.erlang.org/pipermail/erlang-questions/2008-March/033291.html">http://www.erlang.org/pipermail/erlang-questions/2008-March/033291.html</A>
<A HREF="http://www.erlang.org/pipermail/erlang-questions/2004-February/011587.html">http://www.erlang.org/pipermail/erlang-questions/2004-February/011587.html</A>
<A HREF="http://groups.google.com/group/erlang-questions/search?hl=en&amp;group=erlang-questions&amp;q=mnesia+%22partitioned+network%22">http://groups.google.com/group/erlang-questions/search?hl=en&amp;group=erlang-questions&amp;q=mnesia+%22partitioned+network%22</A>



All in all, to answer my original question, there is nothing one can do by remsh'ing into 
a running rabbit node to restore the cluster except mnesia:stop() and mnesia:start() on 
specific nodes, and even then it might not work.


Looking forward to AMQP-level federation and HA...


- Dmitriy


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001552.html">[rabbitmq-discuss] Clustering question
</A></li>
	<LI>Next message: <A HREF="001512.html">[rabbitmq-discuss] AS3 AMQP Library
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1620">[ date ]</a>
              <a href="thread.html#1620">[ thread ]</a>
              <a href="subject.html#1620">[ subject ]</a>
              <a href="author.html#1620">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
