<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Flow Control in RabbitMQ 1.5.3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Flow%20Control%20in%20RabbitMQ%201.5.3&In-Reply-To=de47e4420903231431n2f8b19acyf0ab2a3d968b74cb%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003213.html">
   <LINK REL="Next"  HREF="003215.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Flow Control in RabbitMQ 1.5.3</H1>
    <B>Chris Pettitt</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Flow%20Control%20in%20RabbitMQ%201.5.3&In-Reply-To=de47e4420903231431n2f8b19acyf0ab2a3d968b74cb%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Flow Control in RabbitMQ 1.5.3">cpettitt at gmail.com
       </A><BR>
    <I>Tue Mar 31 23:36:19 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="003213.html">[rabbitmq-discuss] Flow Control in RabbitMQ 1.5.3
</A></li>
        <LI>Next message: <A HREF="003215.html">[rabbitmq-discuss] RabbitMQ / AMQP and Django
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3257">[ date ]</a>
              <a href="thread.html#3257">[ thread ]</a>
              <a href="subject.html#3257">[ subject ]</a>
              <a href="author.html#3257">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I found that Solaris continued to crash regardless of what settings I
used for the high watermark. As memsup on Solaris was questionable I
moved to Linux.

I moved to a Quad core CentOS box with 9 GB of memory. Unfortunately,
I'm seeing similar crashes, though they take longer to occur.

What I'm seeing is usually some variation of the following:

1. Start broker clean
2. Start 1 consumer
3. Start 10 producers that publish as fast as they can (we're trying
to stress the system)
4. Once system memory reaches the high water mark throttling occurs
(I've tried settings from about 40% - 95%, the rest of the
observations will refer to measurements at 70%).
5. Throttling toggles on and off a few times, between 3 - 5 times, and
then all clients (including the consumer) get disconnected.
6. Memory sores to over 90%.
6. Sometimes the erlang process crashes at this point, other times all
producers and consumers reconnect and within about 30 seconds the
erlang process crashes. In most cases the producers never produce
after the reconnect, but on some occasions the consumer does receive
messages before dying.

I understand that this is pretty excessive in terms of stress.
However, without going into details, it is very important that I
demonstrate that RabbitMQ degrades gracefully under high load.

On a more positive note, I'm seeing RabbitMQ outperform my current JMS
provider by a factor of ~15x on Solaris!

Any help would be appreciated.

Thanks,
Chris


On Mon, Mar 23, 2009 at 2:31 PM, Chris Pettitt &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cpettitt at gmail.com</A>&gt; wrote:
&gt;<i> Hi Matthias,
</I>&gt;<i>
</I>&gt;<i> Thank you for the pointer. I should have looked more closely at the
</I>&gt;<i> documentation!
</I>&gt;<i>
</I>&gt;<i> Cursory testing reveals that RabbitMQ is able to use flow control
</I>&gt;<i> without crashing with a high watermark of 0.7, while 0.75 or higher
</I>&gt;<i> results in the Erlang node crashing (before memsup detects the low
</I>&gt;<i> memory condition?). I'll follow up if I learn anything more about
</I>&gt;<i> memsup's behavior on Solaris.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Chris
</I>&gt;<i>
</I>&gt;<i> On Mon, Mar 23, 2009 at 1:14 PM, Matthias Radestock &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt; wrote:
</I>&gt;&gt;<i> Chris,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Chris Pettitt wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I found an article that talks about flow control in RabbitMQ 1.5.0
</I>&gt;&gt;&gt;<i> [1]. It doesn't seem to work in our 1.5.3 setup. When I start rabbit
</I>&gt;&gt;&gt;<i> from erl, I see that the memsup app is not started. I checked the
</I>&gt;&gt;&gt;<i> rabbitmq-server configuration and see &quot;-os_mon start_memsup false&quot;.
</I>&gt;&gt;&gt;<i> I've tried setting start_memsup to true and I've also tried starting
</I>&gt;&gt;&gt;<i> memsup manually before calling rabbit:start(). Neither seems to cause
</I>&gt;&gt;&gt;<i> flow control information to be logged and both still result in the
</I>&gt;&gt;&gt;<i> erlang node crashing.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I very strongly suspect user error, but I'd appreciate some guidance
</I>&gt;&gt;&gt;<i> on how to enable this feature.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> See <A HREF="http://www.rabbitmq.com/admin-guide.html#memsup">http://www.rabbitmq.com/admin-guide.html#memsup</A> - you are supposed to be
</I>&gt;&gt;<i> using &quot;-rabbit memory_alarms true&quot;. &#160;Enabling memsup the way you did should
</I>&gt;&gt;<i> be ok too though as long the server isn't low on memory to start with and
</I>&gt;&gt;<i> you wait at least a minute before stressing it. You may need to tweak the
</I>&gt;&gt;<i> threshold. Also, we don't know whether memsup on Solaris is producing the
</I>&gt;&gt;<i> right information, which is why rabbit leaves it turned off by default on
</I>&gt;&gt;<i> that platform. So if you can do some testing/investigation that would be
</I>&gt;&gt;<i> great.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Matthias.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003213.html">[rabbitmq-discuss] Flow Control in RabbitMQ 1.5.3
</A></li>
	<LI>Next message: <A HREF="003215.html">[rabbitmq-discuss] RabbitMQ / AMQP and Django
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3257">[ date ]</a>
              <a href="thread.html#3257">[ thread ]</a>
              <a href="subject.html#3257">[ subject ]</a>
              <a href="author.html#3257">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
