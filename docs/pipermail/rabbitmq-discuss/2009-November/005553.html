<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Slow throughput on consume side using java	client API
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Slow%20throughput%20on%20consume%20side%20using%20java%0A%09client%20API&In-Reply-To=20091126101033.GA22260%40mrnibble.lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005534.html">
   <LINK REL="Next"  HREF="005556.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Slow throughput on consume side using java	client API</H1>
    <B>scott w</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Slow%20throughput%20on%20consume%20side%20using%20java%0A%09client%20API&In-Reply-To=20091126101033.GA22260%40mrnibble.lshift.net"
       TITLE="[rabbitmq-discuss] Slow throughput on consume side using java	client API">scottblanc at gmail.com
       </A><BR>
    <I>Fri Nov 27 16:18:49 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005534.html">[rabbitmq-discuss] Slow throughput on consume side using java client API
</A></li>
        <LI>Next message: <A HREF="005556.html">[rabbitmq-discuss] Slow throughput on consume side using java	client API
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5553">[ date ]</a>
              <a href="thread.html#5553">[ thread ]</a>
              <a href="subject.html#5553">[ subject ]</a>
              <a href="author.html#5553">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matthew --

Thanks for the feedback. Comments below.

cheers,
Scott

On Thu, Nov 26, 2009 at 2:10 AM, Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at lshift.net</A>&gt; wrote:

&gt;<i> Hi Scott,
</I>&gt;<i>
</I>&gt;<i> I must admit I'm a little confused by your description as it would
</I>&gt;<i> appear somewhat complex to me. However, am I correct in the following?
</I>&gt;<i>
</I>
Not quite. Let me clarify.

&gt;<i>
</I>&gt;<i> 1. You have 1 queue, which is being published to by 50 threads.
</I>&gt;<i>
</I>
Yes although for the purposes of this discussion the publishing side is not
important. You can just assume the queue is filled up with thousands of
messages.


&gt;<i> 2. You have 25 consumers on that queue.
</I>&gt;<i>
</I>
2a. 50 threads calling the equivalent of queue.pop()

2b. Within the queue, I have 25 QueueConsumers and 25 channel (each
QueueConsumer takes in 1 channel in its constructor and there is a 1-1
mapping between QueueConsumer and channel)


&gt;<i> 3. To receive, you randomly select a consumer, and get that consumer to
</I>&gt;<i> consume a message.
</I>&gt;<i>
</I>
Right so one of 50 threads will call queue.pop(), and internally picks a
random channel, synchronizes on that channel, and then calls consume on the
QueueConsumer that maps 1-1 with that channel.


&gt;<i> If that's correct, I'm not surprised by your findings. Consumers on a
</I>&gt;<i> queue are round-robin'd by the broker. Thus each of your 25 consumers
</I>&gt;<i> will receive one 25th of the messages. Thus if you randomly select a
</I>&gt;<i> consumer then it may well have nothing waiting on it as messages have
</I>&gt;<i> been sent to the other consumers.
</I>

This would definitely be true if there was only a single thread. In the case
where there are 50 threads and 25 queue consumers/channels, then on average
there will be 2 threads working on any individual queue consumer/channel.
When the queue starts to drain out, i.e. is almost empty, the impl as I have
it can be sub optimal since some threads may be asking to work on queue
consumers that are empty when there are other queue consumers that have work
to do (something I need to fix) but when the queue isn't close to draining
out, I don't think there should be the problem you describe. I do see the
read throughput go down as it starts to drain out but the 50 reads / sec I
was describing is before it starts to drain.



&gt;<i> Thus you will have to wait for up to
</I>&gt;<i> 25 publishes before that consumer gets a message.
</I>&gt;<i>
</I>&gt;<i> Why are you using so many threads and consumers?
</I>&gt;<i>
</I>
I started with one thread and one consumer and was seeing unacceptable read
throughput (well under 10 reads/sec) so I decided to make the # channels of
and threads parameterizable. After trying various permutations, I found 50
threads and 25 channels to work better than other choices although it wasn't
as scientific as it could be.

The documentation says you can not have multiple threads going against a
single channel so my assumption was that if I need to bump up performance
with multiple threads I would need multiple channels and hence multiple
queue consumers (since it doesn't appear you can have a single queue
consumer going against multiple channels)t. Please correct me if I am wrong.
Or even better if you have some consumer side java code you can share that
you know gives high read throughput, if you wouldn't mind sharing that would
be very much appreciated.

thanks,
Scott
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20091127/d2ca9aea/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20091127/d2ca9aea/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005534.html">[rabbitmq-discuss] Slow throughput on consume side using java client API
</A></li>
	<LI>Next message: <A HREF="005556.html">[rabbitmq-discuss] Slow throughput on consume side using java	client API
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5553">[ date ]</a>
              <a href="thread.html#5553">[ thread ]</a>
              <a href="subject.html#5553">[ subject ]</a>
              <a href="author.html#5553">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
