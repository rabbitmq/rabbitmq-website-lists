<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] intermittent erl.exe crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20intermittent%20erl.exe%20crash&In-Reply-To=4AF302A3.6090105%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005339.html">
   <LINK REL="Next"  HREF="005403.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] intermittent erl.exe crash</H1>
    <B>JD Conley</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20intermittent%20erl.exe%20crash&In-Reply-To=4AF302A3.6090105%40lshift.net"
       TITLE="[rabbitmq-discuss] intermittent erl.exe crash">jdc at hive7.com
       </A><BR>
    <I>Fri Nov  6 22:09:38 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005339.html">[rabbitmq-discuss] intermittent erl.exe crash
</A></li>
        <LI>Next message: <A HREF="005403.html">[rabbitmq-discuss] intermittent erl.exe crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5379">[ date ]</a>
              <a href="thread.html#5379">[ thread ]</a>
              <a href="subject.html#5379">[ subject ]</a>
              <a href="author.html#5379">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> 
</I>&gt;<i> If you can, try running the server directly rather than starting it as
</I>&gt;<i> a
</I>&gt;<i> service. Then, if it crashes, a) you may see a message in the console
</I>&gt;<i> where you started it, and b) the erl_crash.dump should get written to
</I>&gt;<i> the dir where you started the server.
</I>
Ok, running it directly worked. I got a crash dump.
<A HREF="http://corp.hive7.com/download/erl_crash.zip">http://corp.hive7.com/download/erl_crash.zip</A>

The logs weren't very interesting. Just more of the same stuff with
connections terminating and being re-created. Nothing in the SASL log.

It seems like it ran out of memory. How much memory overhead is there per
queue/stored message? I might need to make my timeout sweeping more
aggressive, or bring up more instances.

Or, more likely, my queue configuration or consuming code is wrong and my
messages are being stored forever in memory causing the memory leak. Here
are some c# snippets:

//init
_model.ExchangeDeclare(&quot;myexchangename&quot;, ExchangeType.Fanout, false, false,
false, false, false, null);
_consumer = new EventingBasicConsumer();

...

//start consuming
_model.QueueDeclare(userQueue, false, false, false, false, false, null);
consumerTag = _model.BasicConsume(userQueue, true, null, _consumer);

...

//end consuming
_model.BasicCancel(consumerTag);

...

//bind user specific queue to routing key
_model.QueueDeclare(userQueue, false, false, false, false, false, null);
_model.QueueBind(userQueue, _exchange, key, false, null);

...

//unbind user queue from routing key
_model.QueueUnbind(userQueue, _exchange, key, null);

...

//publish message
var props = _model.CreateBasicProperties();
props.Expiration = &quot;5000&quot;; //is this right? desired expiration time is 5
seconds.
_model.BasicPublish(_exchange, key, false, false, props, body);

...

And, here's the console output:

node          : <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at VMPRODWEB2</A>
app descriptor: c:/Rabbitmq/rabbitmq_server-1.7.0/sbin/../ebin/rabbit.app
home dir      : C:\Users\jdc
cookie hash   : //1wK/zUYlPaC0GVhNfEsw==
log           : C:/Rabbitmq/data/log/rabbit.log
sasl log      : C:/Rabbitmq/data/log/rabbit-sasl.log
database dir  : c:/Rabbitmq/data/db/rabbit-mnesia

starting database             ...done
starting core processes       ...done
starting recovery             ...done
starting persister            ...done
starting guid generator       ...done
starting builtin applications ...done
starting TCP listeners        ...done
starting SSL listeners        ...done

broker running

Crash dump was written to: erl_crash.dump
temp_alloc: Cannot allocate 9176036 bytes of memory (of type &quot;tmp_heap&quot;).

This application has requested the Runtime to terminate it in an unusual
way.
Please contact the application's support team for more information.

-JD



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005339.html">[rabbitmq-discuss] intermittent erl.exe crash
</A></li>
	<LI>Next message: <A HREF="005403.html">[rabbitmq-discuss] intermittent erl.exe crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5379">[ date ]</a>
              <a href="thread.html#5379">[ thread ]</a>
              <a href="subject.html#5379">[ subject ]</a>
              <a href="author.html#5379">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
