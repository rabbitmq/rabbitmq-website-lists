<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] 2 nodes, 4k queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%202%20nodes%2C%204k%20queues&In-Reply-To=4B04F35C.2050103%40gojko.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005479.html">
   <LINK REL="Next"  HREF="005510.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] 2 nodes, 4k queues</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%202%20nodes%2C%204k%20queues&In-Reply-To=4B04F35C.2050103%40gojko.com"
       TITLE="[rabbitmq-discuss] 2 nodes, 4k queues">matthew at lshift.net
       </A><BR>
    <I>Fri Nov 20 13:49:26 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005479.html">[rabbitmq-discuss] 2 nodes, 4k queues
</A></li>
        <LI>Next message: <A HREF="005510.html">[rabbitmq-discuss] 2 nodes, 4k queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5504">[ date ]</a>
              <a href="thread.html#5504">[ thread ]</a>
              <a href="subject.html#5504">[ subject ]</a>
              <a href="author.html#5504">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Gojko,

On Thu, Nov 19, 2009 at 07:27:24AM +0000, Gojko Adzic wrote:
&gt;<i> We had a case of a 2 nodes cluster where message delivery latency was
</I>&gt;<i> unacceptably slow (~ 1-2 min) when the number of queues rose above 4k.
</I>&gt;<i> All the messages were going out to a single topic exchange, average
</I>&gt;<i> message size is 5KB, the number of messages was not more than 10/s and
</I>&gt;<i> most of the messages matched 3-4 queues. We're using topic matching
</I>&gt;<i> between exchange and queues. RabbitMQ was running at about 20-30% CPU on
</I>&gt;<i> large EC2 instances, and about 9% memory, so there doesn't seem to be a
</I>&gt;<i> memory or CPU bottleneck on the machines. Is this kind of performance
</I>&gt;<i> expected (and if it is, how many queues per node would you suggest), or 
</I>&gt;<i> have we hit a configuration problem? Any ideas on monitoring/measuring 
</I>&gt;<i> what starts slowing down processing when the number
</I>&gt;<i> of queues goes up.
</I>
Yeah, our topic matching is inefficient - it's O(n) where n is the
number of bindings. We do have a bug open to improve this. You didn't
mention the number of bindings that you have, but if you're up to 20k
bindings or so then I wouldn't be surprised if this is the performance
you're getting. In general, until we fix this bug (it should become
O(log&#8322;(n)) because really it should just be walking a tree), we'd
probably recommend to use a direct or fanout exchange and then drop
inappropriate messages in the consumer. I know this isn't ideal, but it
might solve the problems you're seeing.

Wrt CPU load, the matching of routing keys against bindings is not
parallelised - thus you can burn a max of 1 CPU for each channel doing
the publish. So if you only have 1 publisher and several CPUs then you
will only really be able to make work for 1 CPU. The situation should be
better if you have many channels or connections and are publishing in
parallel, but there may be something else I've forgotten that limits
this case. What is your topology on the publishing side?

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005479.html">[rabbitmq-discuss] 2 nodes, 4k queues
</A></li>
	<LI>Next message: <A HREF="005510.html">[rabbitmq-discuss] 2 nodes, 4k queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5504">[ date ]</a>
              <a href="thread.html#5504">[ thread ]</a>
              <a href="subject.html#5504">[ subject ]</a>
              <a href="author.html#5504">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
