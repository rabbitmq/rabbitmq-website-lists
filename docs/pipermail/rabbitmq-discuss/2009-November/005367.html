<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ crashes hard when it runs out of memory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20crashes%20hard%20when%20it%20runs%20out%20of%0A%20memory&In-Reply-To=20091106100620.GB30680%40wellquite.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005361.html">
   <LINK REL="Next"  HREF="005378.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of memory</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20crashes%20hard%20when%20it%20runs%20out%20of%0A%20memory&In-Reply-To=20091106100620.GB30680%40wellquite.org"
       TITLE="[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of memory">matthew at lshift.net
       </A><BR>
    <I>Fri Nov  6 10:43:43 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005361.html">[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of memory
</A></li>
        <LI>Next message: <A HREF="005378.html">[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of	memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5367">[ date ]</a>
              <a href="thread.html#5367">[ thread ]</a>
              <a href="subject.html#5367">[ subject ]</a>
              <a href="author.html#5367">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Nov 06, 2009 at 10:06:20AM +0000, Matthew Sackman wrote:
&gt;<i> That's fine. I have to say that it's unlikely this patch will make it
</I>&gt;<i> through - the memory management code has gone through a lot of change
</I>&gt;<i> recently as we're getting a much better handle on resource management.
</I>&gt;<i> Whilst you've obviously been working from the head of our default branch
</I>&gt;<i> (many thanks!), there are a couple of issues with garbage collecting
</I>&gt;<i> every process like that, for example, it's possible that garbage
</I>&gt;<i> collecting vast numbers of processes will take longer than the
</I>&gt;<i> memory_check_interval, making messages queue up for the memory manager
</I>&gt;<i> process. This would become a problem if the garbage collection is unable
</I>&gt;<i> to reclaim any memory at all - eg millions of queues, all of which are
</I>&gt;<i> empty.
</I>
Some immediate ideas to improve this a little.
1) Only do the GC when you initially hit the memory alarm. I.e. in the
first case when going from non-alarmed to alarmed, put the gc in there,
then maybe recurse again (though you'll likely want another param on the
function to stop infinite recursion).

2) Only put GC in processes that are known to eat lots of RAM. Eg if
it's the persister, then putting in a manual GC right after it does a
snapshot is probably a good idea.

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005361.html">[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of memory
</A></li>
	<LI>Next message: <A HREF="005378.html">[rabbitmq-discuss] RabbitMQ crashes hard when it runs out of	memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5367">[ date ]</a>
              <a href="thread.html#5367">[ thread ]</a>
              <a href="subject.html#5367">[ subject ]</a>
              <a href="author.html#5367">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
