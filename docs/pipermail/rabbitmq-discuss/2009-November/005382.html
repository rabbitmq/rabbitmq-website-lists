<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Weird Issue when cluster member restarts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Weird%20Issue%20when%20cluster%20member%20restarts&In-Reply-To=20091106112652.GF30680%40wellquite.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005371.html">
   <LINK REL="Next"  HREF="005404.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Weird Issue when cluster member restarts</H1>
    <B>Arun Suresh</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Weird%20Issue%20when%20cluster%20member%20restarts&In-Reply-To=20091106112652.GF30680%40wellquite.org"
       TITLE="[rabbitmq-discuss] Weird Issue when cluster member restarts">arun.suresh at gmail.com
       </A><BR>
    <I>Mon Nov  9 02:28:36 GMT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005371.html">[rabbitmq-discuss] Weird Issue when cluster member restarts
</A></li>
        <LI>Next message: <A HREF="005404.html">[rabbitmq-discuss] Weird Issue when cluster member restarts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5382">[ date ]</a>
              <a href="thread.html#5382">[ thread ]</a>
              <a href="subject.html#5382">[ subject ]</a>
              <a href="author.html#5382">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Mathew..

Thanks for ur reply.. was out of town so couldn attend to mail earlier.. my
comments inline...

On Fri, Nov 6, 2009 at 4:56 PM, Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at lshift.net</A>&gt; wrote:

&gt;<i> Hi Arun,
</I>&gt;<i>
</I>&gt;<i> On Fri, Nov 06, 2009 at 07:58:09AM +0530, Arun Suresh wrote:
</I>&gt;<i> &gt; My setup is as follows :
</I>&gt;<i> &gt; * 2 RabbitMQ (1.7.0 running on R13B02.1) servers in a cluster (say
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m1</A>,
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m2</A>).. both disk nodes.
</I>&gt;<i> &gt; * 2 Clients (<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m1</A> connected to <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m1</A>, <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m2</A> connected to
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m2</A>). I am using the Erlang client (which currently has an issue
</I>&gt;<i> when
</I>&gt;<i> &gt; connecting to a server which is part of a cluster... this I fixed by
</I>&gt;<i> setting
</I>&gt;<i> &gt; &quot;insist = true&quot; in the #'connection.open' record)
</I>&gt;<i>
</I>&gt;<i> Can you elaborate on this issue a bit? Is this redirection coming back
</I>&gt;<i> from the server?
</I>&gt;<i>
</I>Yes.. I guess its a redirection request coming from the server..
basicaly.. the response to my 'connection.open' request is a
'conncetion.redirect' which on recipt, the client throws an exception and
exits..
ive gotten around this issue by setting 'insist = true' in the request
record...
Maybe ill look at the Java client and see whats done there ?

&gt;<i>
</I>&gt;<i> &gt; * both clients have processes that have subscribed to the same durable
</I>&gt;<i> Queue
</I>&gt;<i> &gt; (Q) using the same key (K). Q is bound to a durable topic exchange (X). X
</I>&gt;<i> &gt; and Q are created on <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m1.</A>
</I>&gt;<i>
</I>&gt;<i> I don't understand what you mean by a queue with a key. I take it you
</I>&gt;<i> have one topic exchange, one queue bound to the exchange with one
</I>&gt;<i> binding key (is this the K you refer to above?), and two consumers on
</I>&gt;<i> the queue. (From reading the rest of your email, yes this is clearly
</I>&gt;<i> what you mean).
</I>&gt;<i>
</I>&gt;<i> &gt; Now this is what i do..
</I>&gt;<i> &gt; * I bring down <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m1</A>, and <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m1</A> (They are co hosted... so both
</I>&gt;<i> are
</I>&gt;<i> &gt; brought down together). I do a &quot;rabbitmqctl list_queues&quot; on <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m2...</A>
</I>&gt;<i> I
</I>&gt;<i> &gt; do not see Q there..
</I>&gt;<i>
</I>&gt;<i> Ok, so the queue has been created on m1, not m2.
</I>&gt;<i>
</I>&gt;<i> &gt; * I bring <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m1</A> up again... After which I see Q when i do a
</I>&gt;<i> &quot;rabbitmqctl
</I>&gt;<i> &gt; list_queues&quot;.
</I>&gt;<i> &gt; * Before I bring up <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m2</A>, I publish a messge to X with a routing
</I>&gt;<i> key
</I>&gt;<i> &gt; K...
</I>&gt;<i> &gt; Issue  : Since <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m2</A> is up and has a process subscribed to Q, I
</I>&gt;<i> expect
</I>&gt;<i> &gt; that process to receive the message... It doesnt..
</I>&gt;<i>
</I>&gt;<i> Indeed it won't.
</I>&gt;<i>
</I>&gt;<i> Clustering makes all exchanges and queues available on all nodes of the
</I>&gt;<i> cluster. *However*, a queue is still located on a single node, even
</I>&gt;<i> though it is accessible via all nodes. The queue will be created on the
</I>&gt;<i> node the client is connected to when it creates the queue. Thus your
</I>&gt;<i> queue has been created on m1, thus it's accessible from both m1 and m2,
</I>&gt;<i> but when m1 goes down, the queue will go down with it.
</I>&gt;<i>
</I>&gt;<i> From that point on, m2 has no record of the queue, so msgs sent to X
</I>&gt;<i> with K to go to Q will not ever reach Q - as far as m2 is concerned, Q
</I>&gt;<i> just does not exist.
</I>&gt;<i>
</I>&gt;<i> When m1 comes back up, Q will be recovered.
</I>&gt;<i>
</I>&gt;<i> &gt; Further more... I notice that when i bring <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m2</A> back up, It
</I>&gt;<i> restarts
</I>&gt;<i> &gt; its subscribers... now all messages published to X with K are sent ONLY
</I>&gt;<i> to
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m2.</A>
</I>&gt;<i>
</I>&gt;<i> Well <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m1</A> died. This means its subscriptions to Q were lost - there
</I>&gt;<i> is no concept of persisting subscriptions, so when <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at m1</A> comes back
</I>&gt;<i> up, the Q will have no consumers at all. If you restart <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m2</A> then
</I>&gt;<i> yes, it'll recreate its subscription to Q, and thus receive all the msgs
</I>&gt;<i> sent to that Q. If you also restart <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m1</A> then that too will
</I>&gt;<i> recreate its subscription to Q and share the msgs with <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">client at m2</A> as
</I>&gt;<i> before.
</I>&gt;<i>
</I>
Confirms what ive been thinking... But Is there any way for clients to be
notified of dead subscriptions ? That would be helpful, else i would have to
keep polling something to get that information..

&gt;<i>
</I>&gt;<i> Hope this is of help.
</I>&gt;<i>
</I>
Definitely.. thanx

&gt;<i>
</I>&gt;<i> Matthew
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20091109/137fd0ef/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20091109/137fd0ef/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005371.html">[rabbitmq-discuss] Weird Issue when cluster member restarts
</A></li>
	<LI>Next message: <A HREF="005404.html">[rabbitmq-discuss] Weird Issue when cluster member restarts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5382">[ date ]</a>
              <a href="thread.html#5382">[ thread ]</a>
              <a href="subject.html#5382">[ subject ]</a>
              <a href="author.html#5382">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
