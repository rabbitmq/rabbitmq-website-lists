<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Patch to support amq.topic in STOMP adaptor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Patch%20to%20support%20amq.topic%20in%20STOMP%20adaptor&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000913.html">
   <LINK REL="Next"  HREF="000920.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Patch to support amq.topic in STOMP adaptor</H1>
    <B>Artur Bergman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Patch%20to%20support%20amq.topic%20in%20STOMP%20adaptor&In-Reply-To="
       TITLE="[rabbitmq-discuss] Patch to support amq.topic in STOMP adaptor">sky at crucially.net
       </A><BR>
    <I>Thu Jun 12 16:40:27 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000913.html">[rabbitmq-discuss] New interesting error message
</A></li>
        <LI>Next message: <A HREF="000920.html">[rabbitmq-discuss] Patch to support amq.topic in STOMP adaptor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#915">[ date ]</a>
              <a href="thread.html#915">[ thread ]</a>
              <a href="subject.html#915">[ subject ]</a>
              <a href="author.html#915">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

This lets you put in exchange to a subscribe and thus start listening  
to an amq.topic

Also, the arguments field to the queue.bind is a bit cargo culted  
(this is my first piece of erlang code ever :).

Sorry of the tab/space level is wrong!

Cheers
Artur




--- rabbit_stomp.erl.bak        2008-06-11 09:42:29.000000000 +0000
+++ rabbit_stomp.erl    2008-06-11 11:41:54.000000000 +0000
@@ -468,6 +468,7 @@
                                   list_to_binary(&quot;Q_&quot; ++ QueueStr)
                           end,
             Queue = list_to_binary(QueueStr),
+
             {ok, send_method(#'basic.consume'{ticket = Ticket,
                                               queue = Queue,
                                               consumer_tag =  
ConsumerTag,
@@ -475,6 +476,32 @@
                                               no_ack = (AckMode ==  
auto),
                                               exclusive = false,
                                               nowait = true},
+               case stomp_frame:header(Frame, &quot;exchange&quot;) of
+                       {ok, ExchangeStr } -&gt;
+                           Exchange = list_to_binary(ExchangeStr),
+                               RoutingKey = list_to_binary 
(stomp_frame:header(Frame, &quot;routing_key&quot;,&quot;&quot;)),
+                               send_method(#'queue.bind'{ticket =  
Ticket,
+                                                         queue  =  
Queue,
+                                                         exchange =  
Exchange,
+                                                         routing_key  
= RoutingKey,
+                                                         nowait = true,
+                                                         arguments =
+                                                            
make_string_table(fun user_header_key/1,
+                                                                        
       Headers)
+                                                       },
+
+                                               send_method 
(#'queue.declare'{ticket = Ticket,
+                                                                        
      queue = Queue,
+                                                                        
      passive = stomp_frame:boolean_header(Frame, &quot;passive&quot;, false),
+                                                                        
      durable = stomp_frame:boolean_header(Frame, &quot;durable&quot;, false),
+                                                                        
      exclusive = stomp_frame:boolean_header(Frame, &quot;exclusive&quot;, false),
+                                                                        
      auto_delete = stomp_frame:boolean_header(Frame, &quot;auto-delete&quot;,  
true),
+                                                                        
      nowait = true,
+                                                                        
       arguments =
+                                                                        
         make_string_table(fun user_header_key/1,
+                                                                        
                   Headers)},
+                                        State));
+                       not_found -&gt;
                              send_method(#'queue.declare'{ticket =  
Ticket,
                                                           queue =  
Queue,
                                                           passive =  
stomp_frame:boolean_header(Frame, &quot;passive&quot;, false),
@@ -485,7 +512,9 @@
                                                           arguments =
                                                              
make_string_table(fun user_header_key/1,
                                                                         
        Headers)},
-                                        State))};
+                                        State)
+               end
+               )};
         not_found -&gt;
             {ok, send_error(&quot;Missing destination&quot;,
                             &quot;SUBSCRIBE must include a 'destination'  
header\n&quot;,



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000913.html">[rabbitmq-discuss] New interesting error message
</A></li>
	<LI>Next message: <A HREF="000920.html">[rabbitmq-discuss] Patch to support amq.topic in STOMP adaptor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#915">[ date ]</a>
              <a href="thread.html#915">[ thread ]</a>
              <a href="subject.html#915">[ subject ]</a>
              <a href="author.html#915">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
