<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Clustered startup with multiple queues	and	multiple masters
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Clustered%20startup%20with%20multiple%20queues%0A%09and%09multiple%20masters&In-Reply-To=%3C87wr3bpmeg.wl%25francesco%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020578.html">
   <LINK REL="Next"  HREF="020600.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Clustered startup with multiple queues	and	multiple masters</H1>
    <B>Francesco Mazzoli</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Clustered%20startup%20with%20multiple%20queues%0A%09and%09multiple%20masters&In-Reply-To=%3C87wr3bpmeg.wl%25francesco%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Clustered startup with multiple queues	and	multiple masters">francesco at rabbitmq.com
       </A><BR>
    <I>Wed Jun 13 10:54:31 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020578.html">[rabbitmq-discuss] Clustered startup with multiple queues and	multiple masters
</A></li>
        <LI>Next message: <A HREF="020600.html">[rabbitmq-discuss] Clustered startup with multiple	queues	and	multiple masters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20594">[ date ]</a>
              <a href="thread.html#20594">[ thread ]</a>
              <a href="subject.html#20594">[ subject ]</a>
              <a href="author.html#20594">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

&gt;<i> As I understand from other messages on this forum, in a clustered
</I>&gt;<i> setup, the last node shut down should be the first node set up. Again
</I>&gt;<i> (in my possibly incorrect assumption), this is because Rabbit and/or
</I>&gt;<i> Mnesia may wait for what they believe to be the previous master to
</I>&gt;<i> come up first.
</I>
That's correct, this is because mnesia wants to make sure that the
node with the most up-to-date dataset starts up first, so that we
avoid diverging tables.

&gt;<i> Now, consider a situation like this, where there are N queues that are
</I>&gt;<i> mastered on different brokers (e.g, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play2</A>). If we
</I>&gt;<i> pulled the power cord on all these machines, what should the node
</I>&gt;<i> startup order be?
</I>
If you shut down the nodes abruptly, rabbit won't complain when
starting the nodes because in whatever order because it won't know
about the running nodes at the time of shutdown (which are recorded in
a file in the shutdown sequence). In other words, it's up to you to
restart them so that the node with the most up-to-date mnesia is
started first (what will happen if mnesia thinks that we're not the
most up to date one is mnesia will hang waiting for the table copies
in the other nodes, which are offline).

&gt;<i> And at the risk of asking a broader question, what is the recommended
</I>&gt;<i> approach to restarting from a catastrophic power failure where all
</I>&gt;<i> nodes go down within a very short period of time?
</I>
I would say that the safest thing to do here is:

  1) Start one disc node. If it hangs waiting for the table, try the
     next one until one works. If none works, things are ugly, and
     I can think of ways of fixing them manually but that's more
     complicated (and dangerous)
  2) Start another node without starting rabbit (you can do
     that setting the RABBITMQ_NODE_ONLY env variable)
  3) Reset it, force_cluster it to the disc node you brought up,
     and then reset it again. This will make the disc node believe that
     the original node has left the cluster.
  4) Once you have done this for each node, you will be left with only
     one node which is not in a cluster, and you can cluster your nodes
     back to that one.

This is pretty ugly but it's the only safe way in all situations, due
to the possibility of the nodes performing upgrades. If you're sure
that the nodes won't need to upgrade (e.g. same version of rabbit and
erlang) you can perform step 1 and then just start the other nodes
normally later, and it should be OK. Someone else in the team might
have a better idea, but I don't :).

By the way, we're working hard on making this process and in general
clustering simpler and safer, so in the future things should be
better.

Francesco

At Tue, 12 Jun 2012 10:29:52 -0700,
Matt Pietrek wrote:
&gt;<i> 
</I>&gt;<i> Looking for some clarification here.
</I>&gt;<i> 
</I>&gt;<i> As I understand from other messages on this forum, in a clustered
</I>&gt;<i> setup, the last node shut down should be the first node set up. Again
</I>&gt;<i> (in my possibly incorrect assumption), this is because Rabbit and/or
</I>&gt;<i> Mnesia may wait for what they believe to be the previous master to
</I>&gt;<i> come up first. By starting up the &quot;master&quot; first, any blocking/waiting
</I>&gt;<i> can be avoided. In addition, message loss can be avoided by preventing
</I>&gt;<i> a prior out-of-sync slave from becoming the master.
</I>&gt;<i> 
</I>&gt;<i> Now, consider a situation like this, where there are N queues that are
</I>&gt;<i> mastered on different brokers (e.g, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play2</A>). If we
</I>&gt;<i> pulled the power cord on all these machines, what should the node
</I>&gt;<i> startup order be?
</I>&gt;<i> 
</I>&gt;<i> real_cm <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A> +2  HA D Active 0 0 0
</I>&gt;<i> aliveness-test <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A>  Active 0 0 0
</I>&gt;<i> carbon <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A> +2  HA D Idle 0 0 0
</I>&gt;<i> cmcmd <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A> +2  HA D Idle 0 0 0
</I>&gt;<i> fake_cm <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play2</A> +2  HA D Idle 0 0 0
</I>&gt;<i> fake_mu_queue <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play2</A> +2  HA D Idle 0 0 0
</I>&gt;<i> fake_service_2 <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A> +2  HA D Idle 0 0 0
</I>&gt;<i> random <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play</A> +2  HA D Idle
</I>&gt;<i> 
</I>&gt;<i> And at the risk of asking a broader question, what is the recommended
</I>&gt;<i> approach to restarting from a catastrophic power failure where all
</I>&gt;<i> nodes go down within a very short period of time?
</I>&gt;<i> 
</I>&gt;<i> In our experiments with RabbitMQ 2.82, Ubuntu 10.04 and Erlang R13B03,
</I>&gt;<i> it's a total crap shoot whether the cluster comes back up or hangs
</I>&gt;<i> with all nodes stuck at the &quot;starting database....&quot; point.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> Matt
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020578.html">[rabbitmq-discuss] Clustered startup with multiple queues and	multiple masters
</A></li>
	<LI>Next message: <A HREF="020600.html">[rabbitmq-discuss] Clustered startup with multiple	queues	and	multiple masters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20594">[ date ]</a>
              <a href="thread.html#20594">[ thread ]</a>
              <a href="subject.html#20594">[ subject ]</a>
              <a href="author.html#20594">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
