<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [Q] Cluster configuration is not retained by	node after restart
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5BQ%5D%20Cluster%20configuration%20is%20not%20retained%0A%20by%09node%20after%20restart&In-Reply-To=%3C4FEB089C.3020003%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020863.html">
   <LINK REL="Next"  HREF="020865.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [Q] Cluster configuration is not retained by	node after restart</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5BQ%5D%20Cluster%20configuration%20is%20not%20retained%0A%20by%09node%20after%20restart&In-Reply-To=%3C4FEB089C.3020003%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] [Q] Cluster configuration is not retained by	node after restart">simon at rabbitmq.com
       </A><BR>
    <I>Wed Jun 27 14:20:28 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020863.html">[rabbitmq-discuss] [Q] Cluster configuration is not retained by	node after restart
</A></li>
        <LI>Next message: <A HREF="020865.html">[rabbitmq-discuss] [Q] Cluster configuration is not retained by	node after restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20864">[ date ]</a>
              <a href="thread.html#20864">[ thread ]</a>
              <a href="subject.html#20864">[ subject ]</a>
              <a href="author.html#20864">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi.

You say you &quot;reboot the server&quot; - is this node 1, node 2, or both?

The description you have after rebooting the server is consistent with 
having one RAM node and one disc node and restarting both of them - in 
2.7.0 if the RAM node came back up first it would create a blank 
database. This was fixed in 2.8.x, in that now a RAM node will refuse to 
start if there are no disc nodes to connect to.

However, when you initially create the cluster you are creating both 
nodes as disc nodes. So I am puzzled as to how you could have got to the 
state where one node was a RAM node. Are you definitely not reclustering 
at any stage?

Cheers, Simon

On 27/06/12 12:48, S.Loewenthal wrote:
&gt;<i> Hi there,
</I>&gt;<i>
</I>&gt;<i> I installed RabbitMQ server but cannot get one node to retain the
</I>&gt;<i> cluster configuration. Step-by-step account follows for what I did to
</I>&gt;<i> configure these nodes.
</I>&gt;<i> Node 1: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-7</A>
</I>&gt;<i> Nide 2: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-8</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On both nodes install 2.7.0 - This version as all other environment run
</I>&gt;<i> same version.
</I>&gt;<i> # rpm -ivh rabbitmq-server-2.7.0-1.noarch.rpm
</I>&gt;<i>
</I>&gt;<i> Start Node 2 (if not already running)
</I>&gt;<i> # /etc/init.d/rabbitmq-server start
</I>&gt;<i>
</I>&gt;<i> Shutdown RabbitMQ on Node 2
</I>&gt;<i> # /etc/init.d/rabbitmq-server stop
</I>&gt;<i>
</I>&gt;<i> Copied the Erlang cookie so that both nodes have the same cookie, or
</I>&gt;<i> else these won't talk with each other
</I>&gt;<i> Copy (Node 1) iuu-7:/var/lib/rabbitmq/.erlang.cookie to (Node 2)
</I>&gt;<i> iuu-8:/var/lib/rabbitmq/.erlang.cookie
</I>&gt;<i> permissions and ownership are : Perms 400 -- Owner rabbitmq:rabbitmq
</I>&gt;<i>
</I>&gt;<i> Start RabbitMQ on Node 2
</I>&gt;<i> # /etc/init.d/rabbitmq-server start
</I>&gt;<i>
</I>&gt;<i> Verify that each node can communicate with each other:
</I>&gt;<i> On Node 1
</I>&gt;<i> $ rabbitmqctl -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-8</A> status
</I>&gt;<i> On Node 2
</I>&gt;<i> $ rabbitmqctl -n <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-7</A> status
</I>&gt;<i>
</I>&gt;<i> Reset Node 2 so that it is ready to join the cluster on Node 1
</I>&gt;<i> $ rabbitmqctl stop_app
</I>&gt;<i> $ rabbitmqctl reset
</I>&gt;<i>
</I>&gt;<i> Add the Node 2 to the first node with disc writing enabled on both nodes:
</I>&gt;<i> $ rabbitmqctl cluster <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-7</A> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-8</A>
</I>&gt;<i>
</I>&gt;<i> Start the app on Node 2
</I>&gt;<i> $ rabbitmqctl start_app
</I>&gt;<i>
</I>&gt;<i> Verify the cluster status on Node 2 and the same on Node 1
</I>&gt;<i> $ rabbitmqctl cluster_status
</I>&gt;<i> Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-8</A>' ...
</I>&gt;<i> [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-8</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-7</A>']}]},
</I>&gt;<i> {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-7</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-8</A>']}]
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i> next I add a few users, and reboot the server. Now the cluster is
</I>&gt;<i> disconnection, and I cannot get ot to connnect. Also, the users added
</I>&gt;<i> afore the reboot no longer exist.
</I>&gt;<i>
</I>&gt;<i> It comes up without the cluster information nor the users:
</I>&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at iuu-7</A> ~]# rabbitmqctl cluster_status
</I>&gt;<i> Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iup-7</A>' ...
</I>&gt;<i> [{nodes,[{ram,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-7</A>']}]},{running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iuu-7</A>']}]
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at iup-8</A> ~]# rabbitmqctl cluster_status
</I>&gt;<i> Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iup-</A>' ...
</I>&gt;<i> [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iup-8</A>']},{ram,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iup-7</A>']}]},
</I>&gt;<i> {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iup-8</A>']}]
</I>&gt;<i> ...done.
</I>&gt;<i>
</I>&gt;<i> The cluster configuration does not survive a server restart and in this
</I>&gt;<i> case user account was was lost. I imagine that I have misconfigured
</I>&gt;<i> something.
</I>&gt;<i>
</I>&gt;<i> ** The question **
</I>&gt;<i> How can I ensure that the cluster reconnects after rabbitmq-server
</I>&gt;<i> restarts, and that data that was written is retained? Or, what did I
</I>&gt;<i> misconfigure
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Many thanks, S.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>




















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020863.html">[rabbitmq-discuss] [Q] Cluster configuration is not retained by	node after restart
</A></li>
	<LI>Next message: <A HREF="020865.html">[rabbitmq-discuss] [Q] Cluster configuration is not retained by	node after restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20864">[ date ]</a>
              <a href="thread.html#20864">[ thread ]</a>
              <a href="subject.html#20864">[ subject ]</a>
              <a href="author.html#20864">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
