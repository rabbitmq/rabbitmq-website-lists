<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Clustered startup with multiple queues and multiple masters
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Clustered%20startup%20with%20multiple%20queues%20and%0A%20multiple%20masters&In-Reply-To=%3CCACLE7iy39d7cD_53jmbWOOBUDOhja2LmSVtziVr4%3DoMNX6j9hg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020689.html">
   <LINK REL="Next"  HREF="020749.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Clustered startup with multiple queues and multiple masters</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Clustered%20startup%20with%20multiple%20queues%20and%0A%20multiple%20masters&In-Reply-To=%3CCACLE7iy39d7cD_53jmbWOOBUDOhja2LmSVtziVr4%3DoMNX6j9hg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Clustered startup with multiple queues and multiple masters">mpietrek at skytap.com
       </A><BR>
    <I>Wed Jun 20 00:33:05 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020689.html">[rabbitmq-discuss] Clustered startup with multiple queues and	multiple masters
</A></li>
        <LI>Next message: <A HREF="020749.html">[rabbitmq-discuss] Clustered startup with multiple queues and	multiple masters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20715">[ date ]</a>
              <a href="thread.html#20715">[ thread ]</a>
              <a href="subject.html#20715">[ subject ]</a>
              <a href="author.html#20715">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Francesco,

Thanks again for the valuable insight from your reply. I'm down to one
issue at this point.

Given what you said earlier about it being OK to start the brokers in any
order, I wrote a simple &quot;catastrophic stress&quot; test. The good news is that
RabbitMQ does what's expected. The bad news: Only most of the time, i.e.
about 90%.

Here's what the test does:

In a loop (5 times):
    Write 5 messages to a queue comprised of 3 clustered nodes (disk based).
    Kill all RabbitMQ's as quickly as possible - I use &quot;killall beam.smp&quot;
invoked on all nodes simultaneously via Capistrano.
    Restart all nodes in parallel (again, using Capistrano).
    Verify that each previously written message can be received.

~90% of the time, an iteration runs to completion as expected. About 10% of
the time, one of the nodes fails to start,
getting stuck with the last line being &quot;starting database ...&quot;

I see nothing of note in the rabbit@&lt;node&gt;.log file.

When this happens, I have no luck getting the node to join the cluster.
Even attempting a &quot;rabbitmqctl force_reset&quot; hangs. The only way I can get
the cluster fully formed again is to terminate all the nodes, then bring
them back up. (A reset is not required in this case, however.)

For what it's worth, the broker start logic looks like this
    nohup rabbitmq-server &amp;
    rabbitmqctl wait &lt;pidfile&gt;

Are their any trace options or other places to look to understand why a
node gets stuck on &quot;creating database...&quot; ?

This bit of startup unpredictability is causing a lot of concern with our
VP. I've been tasked with coming up with the complete story, and
workarounds to any problems like this.

Thanks very much again,

Matt

On Tue, Jun 19, 2012 at 1:49 AM, Francesco Mazzoli
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">francesco at rabbitmq.com</A>&gt;wrote:

&gt;<i> Hi Matt,
</I>&gt;<i>
</I>&gt;<i> At Mon, 18 Jun 2012 11:16:40 -0700,
</I>&gt;<i> Matt Pietrek wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Francesco,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks very much for the detailed reply. It was extremely helpful.
</I>&gt;<i>
</I>&gt;<i> Glad I could help.
</I>&gt;<i>
</I>&gt;<i> &gt; Question 1
</I>&gt;<i> &gt; ----------------
</I>&gt;<i> &gt; I stumbled across this in my own previous experimentation. The
</I>&gt;<i> &gt; question is, do I risk message loss by first starting a node that
</I>&gt;<i> &gt; joined the cluster late, thus not having the full set of messages that
</I>&gt;<i> &gt; other nodes have?
</I>&gt;<i>
</I>&gt;<i> No.
</I>&gt;<i>
</I>&gt;<i> &gt; Question 2
</I>&gt;<i> &gt; ---------------
</I>&gt;<i> &gt; Related to the above scenario, is there any danger (after an unplanned
</I>&gt;<i> &gt; shutdown), in simply letting all the nodes start in parallel and
</I>&gt;<i> &gt; letting Mnesia's waiting sort out the order? It seems to work OK in my
</I>&gt;<i> &gt; limited testing so far, but I don't know if we're risking data loss.
</I>&gt;<i>
</I>&gt;<i> It should be fine, but in general it's better to do cluster operations
</I>&gt;<i> sequentially and at one site. In this specific case it should be OK.
</I>&gt;<i>
</I>&gt;<i> &gt; Question 3
</I>&gt;<i> &gt; ---------------
</I>&gt;<i> &gt; You said:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; In other words, it's up to you to restart them so that the node with
</I>&gt;<i> the most up-to-date mnesia is started first
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is there any information recorded somewhere (e.g. the logs), which
</I>&gt;<i> &gt; would indicate which node has the &quot;most up to date&quot; Mnesia database? I
</I>&gt;<i> &gt; see messages like:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  &gt; Mirrored-queue (queue 'charon' in vhost '/'): Promoting slave
</I>&gt;<i> &gt; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at play2.1.273.0</A>&gt; to master
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But don't know if they're necessarily correlated to who the most
</I>&gt;<i> &gt; up-to-date Mnesia is.
</I>&gt;<i>
</I>&gt;<i> Well, the fact that something got promoted to master tells you that
</I>&gt;<i> the previous master definitely went down before the promoted node.
</I>&gt;<i>
</I>&gt;<i> There won't be precise information if you stop the nodes abruptly, but
</I>&gt;<i> you can look at &quot;rabbit on node &lt;node&gt; down&quot; messages in the logs -
</I>&gt;<i> the node in the clusters are linked in distributed Erlang and these
</I>&gt;<i> messages are generated when a node receives a 'DOWN' message from
</I>&gt;<i> another node. Since they are &quot;info&quot; messages, you need to make sure to
</I>&gt;<i> have those enabled - they are enabled by default but a lot of people
</I>&gt;<i> don't like them.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Francesco.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120619/e680e6aa/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120619/e680e6aa/attachment.htm</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020689.html">[rabbitmq-discuss] Clustered startup with multiple queues and	multiple masters
</A></li>
	<LI>Next message: <A HREF="020749.html">[rabbitmq-discuss] Clustered startup with multiple queues and	multiple masters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20715">[ date ]</a>
              <a href="thread.html#20715">[ thread ]</a>
              <a href="subject.html#20715">[ subject ]</a>
              <a href="author.html#20715">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
