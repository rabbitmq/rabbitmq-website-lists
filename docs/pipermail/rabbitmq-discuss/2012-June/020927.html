<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] HA Queues lost when a node dies
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20HA%20Queues%20lost%20when%20a%20node%20dies&In-Reply-To=%3Cloom.20120630T021521-695%40post.gmane.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020914.html">
   <LINK REL="Next"  HREF="020928.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] HA Queues lost when a node dies</H1>
    <B>Venkat Morampudi</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20HA%20Queues%20lost%20when%20a%20node%20dies&In-Reply-To=%3Cloom.20120630T021521-695%40post.gmane.org%3E"
       TITLE="[rabbitmq-discuss] HA Queues lost when a node dies">venkatmorampudi at gmail.com
       </A><BR>
    <I>Sat Jun 30 01:52:21 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020914.html">[rabbitmq-discuss] Failure starting up after power pulled from	machine
</A></li>
        <LI>Next message: <A HREF="020928.html">[rabbitmq-discuss] HA Queues lost when a node dies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20927">[ date ]</a>
              <a href="thread.html#20927">[ thread ]</a>
              <a href="subject.html#20927">[ subject ]</a>
              <a href="author.html#20927">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Francesco Mazzoli &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">francesco at ...</A>&gt; writes:

&gt;<i> 
</I>&gt;<i> Hi Bozhidar,
</I>&gt;<i> 
</I>&gt;<i> It's hard to tell what happened without looking at the logs and without 
</I>&gt;<i> knowing your setup; but a number of severe bugs related to HA were fixed 
</I>&gt;<i> in 2.8.2,  so it's definitely worth a try.
</I>&gt;<i> 
</I>&gt;<i> If the situation does not improve, please post more details on the list.
</I>&gt;<i> 
</I>&gt;<i> Francesco.
</I>&gt;<i> 
</I>&gt;<i> On 07/05/12 17:44, Bozhidar Bozhanov wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We are currently trying to run RabbitMQ (2.8.1) in a cluster and use
</I>&gt;<i> &gt; highly-available queues. We have around 50 queues. Each queue is
</I>&gt;<i> &gt; registered with one of the nodes (at random), as master, and using
</I>&gt;<i> &gt; x-ha-policy=all. We have 2 nodes in the cluster.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The management console shows that the cluster is successfully created,
</I>&gt;<i> &gt; and that the queues are highly-available and properly mirrored. Then
</I>&gt;<i> &gt; we kill one of the nodes (with kill -9) to simulate system failure. We
</I>&gt;<i> &gt; have tried this five times, and each time a different result was
</I>&gt;<i> &gt; observed:
</I>&gt;<i> &gt; - only 1 queue 'survived' (the metadata about the others was deleted
</I>&gt;<i> &gt; and they were not visible in the management console, nor we could send
</I>&gt;<i> &gt; or consume messages to/from them)
</I>&gt;<i> &gt; - all but 3 queues survived
</I>&gt;<i> &gt; - only 10 queues survived
</I>&gt;<i> &gt; - all queues survived
</I>&gt;<i> &gt; - all but 1 queue survived
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The queues that survived properly switched their master node to the
</I>&gt;<i> &gt; only remaining one.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The results are random, as it seems. Is this expected behaviour? Is it
</I>&gt;<i> &gt; likely to be fixed in 2.8.2. And how can we make sure that if a node
</I>&gt;<i> &gt; dies, the queues don't get deleted.
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at ...</A>
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>Hi Francesco,

I observed similar behavior during my HA testing on V2.8.1. RabbitMQ dropping 
queue randomly when I tried to simulate node failure by stopping rabbitmq 
service.

Errors logged in RabbitMQ log file:

=ERROR REPORT==== 29-Jun-2012::19:15:42 ===
** Generic server &lt;0.240.0&gt; terminating
** Last message in was {'$gen_cast',{gm_deaths,[&lt;6886.642.0&gt;]}}
** When Server state == {state,
                            {amqqueue,
                                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;TestQueue5&quot;&gt;&gt;},
                                true,false,none,
                                [{&lt;&lt;&quot;x-ha-policy&quot;&gt;&gt;,longstr,&lt;&lt;&quot;all&quot;&gt;&gt;}],
                                &lt;0.223.0&gt;,[],all},
                            &lt;0.241.0&gt;,
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            #Fun&lt;rabbit_mirror_queue_master.1.2951048&gt;,
                            #Fun&lt;rabbit_mirror_queue_master.2.72654940&gt;}
** Reason for termination ==
** {{case_clause,{ok,&lt;0.441.0&gt;,[]}},
    [{rabbit_mirror_queue_coordinator,handle_cast,2},
     {gen_server2,handle_msg,2},
     {proc_lib,wake_up,3}]}

=ERROR REPORT==== 29-Jun-2012::19:15:42 ===
** Generic server &lt;0.238.0&gt; terminating
** Last message in was {'$gen_cast',{gm_deaths,[&lt;6886.663.0&gt;]}}
** When Server state == {state,
                            {amqqueue,
                                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;TestQueue4&quot;&gt;&gt;},
                                true,false,none,
                                [{&lt;&lt;&quot;x-ha-policy&quot;&gt;&gt;,longstr,&lt;&lt;&quot;all&quot;&gt;&gt;}],
                                &lt;0.222.0&gt;,[],all},
                            &lt;0.239.0&gt;,
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            #Fun&lt;rabbit_mirror_queue_master.1.2951048&gt;,
                            #Fun&lt;rabbit_mirror_queue_master.2.72654940&gt;}
** Reason for termination ==
** {{case_clause,{ok,&lt;0.451.0&gt;,[]}},
    [{rabbit_mirror_queue_coordinator,handle_cast,2},
     {gen_server2,handle_msg,2},
     {proc_lib,wake_up,3}]}

I can provide complete log file to you if it help debugging.

Really appreciate your help.

Thanks,

-Venkat

</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020914.html">[rabbitmq-discuss] Failure starting up after power pulled from	machine
</A></li>
	<LI>Next message: <A HREF="020928.html">[rabbitmq-discuss] HA Queues lost when a node dies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20927">[ date ]</a>
              <a href="thread.html#20927">[ thread ]</a>
              <a href="subject.html#20927">[ subject ]</a>
              <a href="author.html#20927">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
