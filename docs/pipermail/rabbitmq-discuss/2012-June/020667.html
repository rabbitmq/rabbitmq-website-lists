<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Application architecture question: queue	failure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Application%20architecture%20question%3A%20queue%0A%09failure&In-Reply-To=%3CCAKhN_m6eAVF-hQ4GmF-fCjLeGuhkG3KUPHUDrs4wMKWzNYe76w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020591.html">
   <LINK REL="Next"  HREF="020672.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Application architecture question: queue	failure</H1>
    <B>Bill Moseley</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Application%20architecture%20question%3A%20queue%0A%09failure&In-Reply-To=%3CCAKhN_m6eAVF-hQ4GmF-fCjLeGuhkG3KUPHUDrs4wMKWzNYe76w%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Application architecture question: queue	failure">moseley at hank.org
       </A><BR>
    <I>Mon Jun 18 16:37:42 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020591.html">[rabbitmq-discuss] Application architecture question: queue	failure
</A></li>
        <LI>Next message: <A HREF="020672.html">[rabbitmq-discuss] Application architecture question: queue	failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20667">[ date ]</a>
              <a href="thread.html#20667">[ thread ]</a>
              <a href="subject.html#20667">[ subject ]</a>
              <a href="author.html#20667">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Jun 13, 2012 at 3:53 AM, Tim Watson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>&gt; wrote:

&gt;<i>
</I>&gt;&gt;<i> Anyway, sorry if this is a mundane (if not a bit off-topic) question --,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and I know it's application-specific. But, it's a question that comes up
</I>&gt;&gt;<i> often in our design discussions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do you have these concerns and how do you handle the possibility of
</I>&gt;&gt;<i> message or queue loss?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Well rabbit fight's like a cornered... rabbit ... to make sure this
</I>&gt;<i> doesn't happen! ;)
</I>&gt;<i>
</I>&gt;<i> Please feel free to elaborate on your concerns and questions, as that's
</I>&gt;<i> what the list is for! I'd certainly like to understand a bit more about how
</I>&gt;<i> your application works, what constitutes a job and how these are identified
</I>&gt;<i> throughout the system. I often find the issue of identity can be
</I>&gt;<i> particularly vexing in any non-trivial architecture.
</I>&gt;<i>
</I>
Let me give you an example -- which is an actual workflow we have.

In our web app a user can select to receive a report.  In the web app we
want the user to see that the report is indeed queued, so in the database
we set a flag saying that the job was sent, and when.   This allows us to
display &quot;pending&quot; so the user doesn't submit the request multiple times.

The web app queues the message for the background report generation.
Anything is possible -- so imagine first that the message is somehow lost.
 The web app is still showing &quot;pending&quot; to the user.

But, we do want the task to complete -- it's a revenue generator, for
example.   So, one option is to use cron to look for stale &quot;pending&quot;
request on the web side and assume the message was lost and re-queue.
But, after X attempts maybe the cron job decides to give up.

Now, this report generation actually uses a third-party web service, and
this web service has gone down for extended periods for maintenance.  So,
in this case the report request jobs stack up in the queue.

So, if it's down long enough then cron might run again and re-queue the
same job that is already in the queue.   What I have done for this is
atomically change the state from &quot;pending&quot; to &quot;in process&quot; so that only one
message gets processed.  But, using some kind of UUID and a store is
another option, of course.

Maybe you are right that durable queues are the correct solution for this
-- I still need to track state on the web app side to show &quot;pending&quot; or &quot;in
process&quot;.   And maybe just use cron to report/clean up any stale pending
job on the web app side.

I'm just curious if the above is a common design pattern when using
RabbitMQ in this way.  Obviously, depends on the specifics of the task, but
we seem to have quite a few situations like this.

Oh, and with this example of the third-party web service another problem is
knowing if a failure of this service is permanent or temporary.  I have not
done this, but I'm tempted to have my workers pull the jobs off the queue
and if the job fails for an unclear reason then ack the original job and
then send it to a &quot;try again later&quot; queue and have separate workers handle
those.


Thanks,


-- 
Bill Moseley
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">moseley at hank.org</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120618/6730a0ac/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120618/6730a0ac/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020591.html">[rabbitmq-discuss] Application architecture question: queue	failure
</A></li>
	<LI>Next message: <A HREF="020672.html">[rabbitmq-discuss] Application architecture question: queue	failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20667">[ date ]</a>
              <a href="thread.html#20667">[ thread ]</a>
              <a href="subject.html#20667">[ subject ]</a>
              <a href="author.html#20667">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
