<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ failure under high load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20failure%20under%20high%20load&In-Reply-To=%3C4FE47A17.1030805%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020780.html">
   <LINK REL="Next"  HREF="020800.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ failure under high load</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20failure%20under%20high%20load&In-Reply-To=%3C4FE47A17.1030805%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ failure under high load">simon at rabbitmq.com
       </A><BR>
    <I>Fri Jun 22 14:58:47 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020780.html">[rabbitmq-discuss] RabbitMQ failure under high load
</A></li>
        <LI>Next message: <A HREF="020800.html">[rabbitmq-discuss] librabbitmq-c and amqp_channel_close
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20781">[ date ]</a>
              <a href="thread.html#20781">[ thread ]</a>
              <a href="subject.html#20781">[ subject ]</a>
              <a href="author.html#20781">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Micha&#322;.

This is quite vague - if we can't see the source of your test tool it's 
hard to see what it's actually doing.

The server can use more memory than the high watermark; that's just the 
point at which it stops accepting new messages from the network. This 
should greatly cut the extent to which it can consume more memory, but 
will not eliminate it.

There is an existing issue where the processes used by connections do 
not close when the connection is closed and memory use is above the 
watermark. When the memory use drops the processes will go. Could your 
test application be opening new connections?

Also, you say:

&gt;<i> The readers has been disconnected by the server ahead of time.
</I>
does this mean that huge numbers of messages are building up in the 
server? Note that in the default configuration there is a per-message 
cost in memory of a hundred bytes or so even when the message has been 
paged out to disc, so that might explain why so much memory is being used.

I hope this helps explain what you are seeing. But I'm not exactly sure 
what you are doing...

Cheers, Simon

On 22/06/12 14:09, Micha&#322; Ki&#281;dy&#347; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Software version: 2.8.2
</I>&gt;<i> The cluster has been stressed with 1000 writers and 100 readers. Message
</I>&gt;<i> size is 100kB.
</I>&gt;<i> Test configuration:
</I>&gt;<i>
</I>&gt;<i> _readers node #1_
</I>&gt;<i> test.ConnectionPerWorker=true
</I>&gt;<i> test.WritersCount=0
</I>&gt;<i> test.ReadersCount=33
</I>&gt;<i> test.Durable=true
</I>&gt;<i> test.QueuesCount=1
</I>&gt;<i> test.AutoAck=false
</I>&gt;<i> test.ExchangeType=direct
</I>&gt;<i> test.QueueNamePrefix=direct
</I>&gt;<i> test.Host=arch-task-mq-7.atm
</I>&gt;<i>
</I>&gt;<i> _readers node #2_
</I>&gt;<i> test.ConnectionPerWorker=true
</I>&gt;<i> test.WritersCount=0
</I>&gt;<i> test.ReadersCount=33
</I>&gt;<i> test.Durable=true
</I>&gt;<i> test.QueuesCount=1
</I>&gt;<i> test.AutoAck=false
</I>&gt;<i> test.ExchangeType=direct
</I>&gt;<i> test.QueueNamePrefix=direct
</I>&gt;<i> test.Host=arch-task-mq-8.atm
</I>&gt;<i>
</I>&gt;<i> _readers node #3_
</I>&gt;<i> test.ConnectionPerWorker=true
</I>&gt;<i> test.WritersCount=0
</I>&gt;<i> test.ReadersCount=33
</I>&gt;<i> test.Durable=true
</I>&gt;<i> test.QueuesCount=1
</I>&gt;<i> test.AutoAck=false
</I>&gt;<i> test.ExchangeType=direct
</I>&gt;<i> test.QueueNamePrefix=direct
</I>&gt;<i> test.Host=arch-task-mq-8.atm
</I>&gt;<i>
</I>&gt;<i> _writers node #4_
</I>&gt;<i> test.ConnectionPerWorker=true
</I>&gt;<i> test.WritersCount=333
</I>&gt;<i> test.ReadersCount=0
</I>&gt;<i> test.Durable=true
</I>&gt;<i> test.QueuesCount=1
</I>&gt;<i> test.AutoAck=false
</I>&gt;<i> test.ExchangeType=direct
</I>&gt;<i> test.QueueNamePrefix=direct
</I>&gt;<i> test.BodySize=102400
</I>&gt;<i> # available units: s(seconds), m(minutes), h(hours) d(days)
</I>&gt;<i> test.TestDuration=3h
</I>&gt;<i> test.Host=arch-task-mq-8.atm
</I>&gt;<i>
</I>&gt;<i> writers node #5
</I>&gt;<i> test.ConnectionPerWorker=true
</I>&gt;<i> test.WritersCount=333
</I>&gt;<i> test.ReadersCount=0
</I>&gt;<i> test.Durable=true
</I>&gt;<i> test.QueuesCount=1
</I>&gt;<i> test.AutoAck=false
</I>&gt;<i> test.ExchangeType=direct
</I>&gt;<i> test.QueueNamePrefix=direct
</I>&gt;<i> test.BodySize=102400
</I>&gt;<i> # available units: s(seconds), m(minutes), h(hours) d(days)
</I>&gt;<i> test.TestDuration=3h
</I>&gt;<i> test.Host=arch-task-mq-7.atm
</I>&gt;<i>
</I>&gt;<i> writers node #6
</I>&gt;<i> test.ConnectionPerWorker=true
</I>&gt;<i> test.WritersCount=334
</I>&gt;<i> test.ReadersCount=0
</I>&gt;<i> test.Durable=true
</I>&gt;<i> test.QueuesCount=1
</I>&gt;<i> test.AutoAck=false
</I>&gt;<i> test.ExchangeType=direct
</I>&gt;<i> test.QueueNamePrefix=direct
</I>&gt;<i> test.BodySize=102400
</I>&gt;<i> # available units: s(seconds), m(minutes), h(hours) d(days)
</I>&gt;<i> test.TestDuration=3h
</I>&gt;<i> test.Host=arch-task-mq-8.atm
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _Actual tests state:_
</I>&gt;<i> Running worker-1000w-100r-100kB
</I>&gt;<i> Preparing tests on arch-task-mq-1
</I>&gt;<i> Preparing tests on arch-task-mq-2
</I>&gt;<i> Preparing tests on arch-task-mq-3
</I>&gt;<i> Preparing tests on arch-task-mq-4
</I>&gt;<i> Preparing tests on arch-task-mq-5
</I>&gt;<i> Preparing tests on arch-task-mq-6
</I>&gt;<i> Preparations done, starting testing procedure
</I>&gt;<i> Start tests on arch-task-mq-1
</I>&gt;<i> Start tests on arch-task-mq-2
</I>&gt;<i> Start tests on arch-task-mq-3
</I>&gt;<i> Start tests on arch-task-mq-4
</I>&gt;<i> Start tests on arch-task-mq-5
</I>&gt;<i> Start tests on arch-task-mq-6
</I>&gt;<i> Waiting for tests to finish
</I>&gt;<i> Tests done on arch-task-mq-5
</I>&gt;<i> Tests done on arch-task-mq-6
</I>&gt;<i> Tests done on arch-task-mq-4
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The readers has been disconnected by the server ahead of time.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _Actual cluster state (data from Management Plugin view):_
</I>&gt;<i> Name                   File descriptors (?)           Socket descriptors
</I>&gt;<i> (?)           Erlang processes      Memory                      Disk
</I>&gt;<i> space     Uptime     Type
</I>&gt;<i>                                     (used / available)             (used
</I>&gt;<i> / available)                  (used / available)
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabit at arch-task-mq-7</A>    392 / 1024                     334 / 829
</I>&gt;<i>                       2885 / 1048576        540.2MB
</I>&gt;<i>   49.6GB          21h 14m  Disc Stats *
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   1.6GB high watermark 4.0GB low watermark
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at arch-task-mq-8</A>  692 / 1024                     668 / 829
</I>&gt;<i>                        5522 / 1048576        1.8GB (?)
</I>&gt;<i>   46.1GB          21h 16m  RAM
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   1.6GB high watermark 4.0GB low watermark
</I>&gt;<i>
</I>&gt;<i> Number of processes is growing all the time even though no messages are
</I>&gt;<i> not published or received.
</I>&gt;<i> All publishers has been blocked. After some time I killed the
</I>&gt;<i> publisher processes, but RabbitMQ still sees them as connected and
</I>&gt;<i> blocked. :)
</I>&gt;<i>
</I>&gt;<i> Some logs:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mkiedys at arch-task-mq-8</A>:/var/log/rabbitmq$ cat <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at arch-task-mq-8.log</A>
</I>&gt;<i> |grep vm_memory_high|tail -n 20
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1709148224 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2135174984 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1593121728 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2043534608 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1681947128 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2088225952 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1710494800 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2208875080 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1713902032 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2122564032 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1663616264 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2098909664 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1712666136 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2088814360 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1640273568 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2116966952 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1715305176 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2186572648 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:1716620504 allowed:1717986918
</I>&gt;<i> vm_memory_high_watermark set. Memory used:2180898440 allowed:1717986918
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mkiedys at arch-task-mq-8</A>:/var/log/rabbitmq$ cat <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at arch-task-mq-8.log</A>
</I>&gt;<i> |grep vm_memory_high|wc -l
</I>&gt;<i> 2935
</I>&gt;<i>
</I>&gt;<i> Why does the server consumes more memory than 1.6GB limit?
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> MK
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>



















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020780.html">[rabbitmq-discuss] RabbitMQ failure under high load
</A></li>
	<LI>Next message: <A HREF="020800.html">[rabbitmq-discuss] librabbitmq-c and amqp_channel_close
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20781">[ date ]</a>
              <a href="thread.html#20781">[ thread ]</a>
              <a href="subject.html#20781">[ subject ]</a>
              <a href="author.html#20781">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
