<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> No subject
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20No%20subject&In-Reply-To=%3Cmailman.12.1345141927.8494.rabbitmq-discuss%40lists.rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021869.html">
   <LINK REL="Next"  HREF="021973.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>No subject</H1>
    <B></B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20No%20subject&In-Reply-To=%3Cmailman.12.1345141927.8494.rabbitmq-discuss%40lists.rabbitmq.com%3E"
       TITLE="No subject">
       </A><BR>
    <I>Sun Jun 17 23:12:48 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021869.html">No subject
</A></li>
        <LI>Next message: <A HREF="021973.html">No subject
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21937">[ date ]</a>
              <a href="thread.html#21937">[ thread ]</a>
              <a href="subject.html#21937">[ subject ]</a>
              <a href="author.html#21937">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>WireShark. For the first several thousand messages, everything looks
groovy, in particular, all Tx.Commit messages are always followed
immediately by at Tx.Commit-Ok.

However, when it dies, the sequence looks like this:

--------
No.     Time        Source                Destination           Protocol
Length Info
   3477 60.138041   192.168.78.17         192.168.78.17         AMQP
99     Basic.Ack Tx.Commit

Frame 3477: 99 bytes on wire (792 bits), 99 bytes captured (792 bits)
Ethernet II, Src: 00:00:00_00:00:00 (00:00:00:00:00:00), Dst:
00:00:00_00:00:00 (00:00:00:00:00:00)
Internet Protocol Version 4, Src: 192.168.78.17 (192.168.78.17), Dst:
192.168.78.17 (192.168.78.17)
Transmission Control Protocol, Src Port: 38680 (38680), Dst Port: amqp
(5672), Seq: 21061, Ack: 41128, Len: 33
Advanced Message Queueing Protocol
Advanced Message Queueing Protocol

No.     Time        Source                Destination           Protocol
Length Info
   3478 60.139960   192.168.78.17         192.168.78.17         AMQP
318    Basic.Deliver Content-Header Content-Body

Frame 3478: 318 bytes on wire (2544 bits), 318 bytes captured (2544 bits)
Ethernet II, Src: 00:00:00_00:00:00 (00:00:00:00:00:00), Dst:
00:00:00_00:00:00 (00:00:00:00:00:00)
Internet Protocol Version 4, Src: 192.168.78.17 (192.168.78.17), Dst:
192.168.78.17 (192.168.78.17)
Transmission Control Protocol, Src Port: amqp (5672), Dst Port: 38680
(38680), Seq: 41128, Ack: 21094, Len: 252
Advanced Message Queueing Protocol
Advanced Message Queueing Protocol
Advanced Message Queueing Protocol

No.     Time        Source                Destination           Protocol
Length Info
   3479 60.141903   192.168.78.17         192.168.78.17         AMQP
150    Basic.Publish Content-Header Content-Body

Frame 3479: 150 bytes on wire (1200 bits), 150 bytes captured (1200 bits)
Ethernet II, Src: 00:00:00_00:00:00 (00:00:00:00:00:00), Dst:
00:00:00_00:00:00 (00:00:00:00:00:00)
Internet Protocol Version 4, Src: 192.168.78.17 (192.168.78.17), Dst:
192.168.78.17 (192.168.78.17)
Transmission Control Protocol, Src Port: 38680 (38680), Dst Port: amqp
(5672), Seq: 21094, Ack: 41380, Len: 84
Advanced Message Queueing Protocol
Advanced Message Queueing Protocol
Advanced Message Queueing Protocol

No.     Time        Source                Destination           Protocol
Length Info
   3489 60.227975   192.168.78.17         192.168.78.17         AMQP
148    Connection.Close

Frame 3489: 148 bytes on wire (1184 bits), 148 bytes captured (1184 bits)
Ethernet II, Src: 00:00:00_00:00:00 (00:00:00:00:00:00), Dst:
00:00:00_00:00:00 (00:00:00:00:00:00)
Internet Protocol Version 4, Src: 192.168.78.17 (192.168.78.17), Dst:
192.168.78.17 (192.168.78.17)
Transmission Control Protocol, Src Port: amqp (5672), Dst Port: 38680
(38680), Seq: 41380, Ack: 21178, Len: 82
Advanced Message Queueing Protocol
--------

That is, it looks like a Basic.Deliver and a Basic.Publish are sneaking in
before the Tx.Commit-Ok comes back.

I suspect this is a Pika issue, but my reading of the code doesn't show any
obvious problems.

Thanks,

Matt

--047d7b5d9ce7397a8104c76641a6
Content-Type: text/html; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

I have a simple, single threaded program using Pika&amp;#39;s SelectConnection =
with RabbitMQ 2.8.5 that simply listens for request messages and replies to=
 them.&lt;br&gt;&lt;br&gt;This code generally works - It can receive many thousands of =
messages=20
before it croaks. When it does croak, it&amp;#39;s with the following error:&lt;br=
&gt;<i>
</I>&lt;br&gt;
&lt;b&gt;CHANNEL_ERROR - unexpected command while processing &amp;#39;tx.commit&amp;#39;&lt;=
br&gt;&lt;br&gt;&lt;/b&gt;The code looks like this:&lt;br&gt;&lt;br&gt;def handle_delivery(channel, me=
thod, header, body):&lt;br&gt;=A0=A0=A0 print &amp;quot;Received message&amp;quot;&lt;br&gt;&lt;br=
&gt;<i>
</I>=A0=A0=A0 channel.tx_select()&lt;br&gt;=A0=A0=A0 channel.basic_publish(exchange=
=3D&amp;quot;skytap&amp;quot;,&lt;br&gt;=A0=A0=A0=A0=A0=A0=A0 routing_key=3D&amp;#39;foo.bar&amp;=
#39;,&lt;br&gt;=A0=A0=A0=A0=A0=A0=A0 body=3D&amp;#39;reply&amp;#39;,&lt;br&gt;=A0=A0=A0=A0=A0=
=A0=A0 mandatory=3DTrue,&lt;br&gt;=A0=A0=A0=A0=A0=A0=A0 properties=3DBasicPropert=
ies(delivery_mode=3D2))&lt;br&gt;
=A0=A0=A0 channel.tx_commit()&lt;br&gt;&lt;br&gt;=A0=A0=A0 channel.tx_select()&lt;br&gt;=A0=
=A0=A0 channel.basic_ack(delivery_tag=3Dmethod.delivery_tag)&lt;br&gt;=A0=A0=A0 c=
hannel.tx_commit()&lt;br&gt;&lt;br&gt;From looking at the code, nothing&amp;#39;s obviously=
 wrong so I fired up WireShark. For the first several thousand messages, ev=
erything looks groovy, in particular, all Tx.Commit messages are always fol=
lowed immediately by at Tx.Commit-Ok.&lt;br&gt;
&lt;br&gt;However, when it dies, the sequence looks like this:&lt;br&gt;&lt;br&gt;--------&lt;br=
&gt;<i>No.=A0=A0=A0=A0 Time=A0=A0=A0=A0=A0=A0=A0 Source=A0=A0=A0=A0=A0=A0=A0=A0=
</I>=A0=A0=A0=A0=A0=A0=A0 Destination=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 Protocol Le=
ngth Info&lt;br&gt;=A0=A0 3477 60.138041=A0=A0 192.168.78.17=A0=A0=A0=A0=A0=A0=A0=
=A0 192.168.78.17=A0=A0=A0=A0=A0=A0=A0=A0 AMQP=A0=A0=A0=A0 99=A0=A0=A0=A0 B=
asic.Ack Tx.Commit &lt;br&gt;
&lt;br&gt;Frame 3477: 99 bytes on wire (792 bits), 99 bytes captured (792 bits)&lt;b=
r&gt;Ethernet II, Src: 00:00:00_00:00:00 (00:00:00:00:00:00), Dst: 00:00:00_00=
:<i>00:00 (00:00:00:00:00:00)&lt;br&gt;Internet Protocol Version 4, Src: 192.168.78.=
</I>17 (192.168.78.17), Dst: 192.168.78.17 (192.168.78.17)&lt;br&gt;
Transmission Control Protocol, Src Port: 38680 (38680), Dst Port: amqp (567=
2), Seq: 21061, Ack: 41128, Len: 33&lt;br&gt;Advanced Message Queueing Protocol&lt;b=
r&gt;Advanced Message Queueing Protocol&lt;br&gt;&lt;br&gt;No.=A0=A0=A0=A0 Time=A0=A0=A0=
=A0=A0=A0=A0 Source=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 Destinatio=
n=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 Protocol Length Info&lt;br&gt;
=A0=A0 3478 60.139960=A0=A0 192.168.78.17=A0=A0=A0=A0=A0=A0=A0=A0 192.168.7=
8.17=A0=A0=A0=A0=A0=A0=A0=A0 AMQP=A0=A0=A0=A0 318=A0=A0=A0 Basic.Deliver Co=
ntent-Header Content-Body &lt;br&gt;&lt;br&gt;Frame 3478: 318 bytes on wire (2544 bits)=
, 318 bytes captured (2544 bits)&lt;br&gt;Ethernet II, Src: 00:00:00_00:00:00 (00=
:<i>00:00:00:00:00), Dst: 00:00:00_00:00:00 (00:00:00:00:00:00)&lt;br&gt;
</I>Internet Protocol Version 4, Src: 192.168.78.17 (192.168.78.17), Dst: 192.1=
68.78.17 (192.168.78.17)&lt;br&gt;Transmission Control Protocol, Src Port: amqp (=
5672), Dst Port: 38680 (38680), Seq: 41128, Ack: 21094, Len: 252&lt;br&gt;Advance=
d Message Queueing Protocol&lt;br&gt;
Advanced Message Queueing Protocol&lt;br&gt;Advanced Message Queueing Protocol&lt;br=
&gt;<i>&lt;br&gt;No.=A0=A0=A0=A0 Time=A0=A0=A0=A0=A0=A0=A0 Source=A0=A0=A0=A0=A0=A0=A0=
</I>=A0=A0=A0=A0=A0=A0=A0=A0 Destination=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 Protocol=
 Length Info&lt;br&gt;=A0=A0 3479 60.141903=A0=A0 192.168.78.17=A0=A0=A0=A0=A0=A0=
=A0=A0 192.168.78.17=A0=A0=A0=A0=A0=A0=A0=A0 AMQP=A0=A0=A0=A0 150=A0=A0=A0 =
Basic.Publish Content-Header Content-Body &lt;br&gt;
&lt;br&gt;Frame 3479: 150 bytes on wire (1200 bits), 150 bytes captured (1200 bit=
s)&lt;br&gt;Ethernet II, Src: 00:00:00_00:00:00 (00:00:00:00:00:00), Dst: 00:00:0=
0_00:00:00 (00:00:00:00:00:00)&lt;br&gt;Internet Protocol Version 4, Src: 192.168=
.78.17 (192.168.78.17), Dst: 192.168.78.17 (192.168.78.17)&lt;br&gt;
Transmission Control Protocol, Src Port: 38680 (38680), Dst Port: amqp (567=
2), Seq: 21094, Ack: 41380, Len: 84&lt;br&gt;Advanced Message Queueing Protocol&lt;b=
r&gt;Advanced Message Queueing Protocol&lt;br&gt;Advanced Message Queueing Protocol&lt;=
br&gt;
&lt;br&gt;No.=A0=A0=A0=A0 Time=A0=A0=A0=A0=A0=A0=A0 Source=A0=A0=A0=A0=A0=A0=A0=
=A0=A0=A0=A0=A0=A0=A0=A0 Destination=A0=A0=A0=A0=A0=A0=A0=A0=A0=A0 Protocol=
 Length Info&lt;br&gt;=A0=A0 3489 60.227975=A0=A0 192.168.78.17=A0=A0=A0=A0=A0=A0=
=A0=A0 192.168.78.17=A0=A0=A0=A0=A0=A0=A0=A0 AMQP=A0=A0=A0=A0 148=A0=A0=A0 =
Connection.Close &lt;br&gt;&lt;br&gt;Frame 3489: 148 bytes on wire (1184 bits), 148 byt=
es captured (1184 bits)&lt;br&gt;
Ethernet II, Src: 00:00:00_00:00:00 (00:00:00:00:00:00), Dst: 00:00:00_00:0=
0:00 (00:00:00:00:00:00)&lt;br&gt;Internet Protocol Version 4, Src: 192.168.78.17=
 (192.168.78.17), Dst: 192.168.78.17 (192.168.78.17)&lt;br&gt;Transmission Contro=
l Protocol, Src Port: amqp (5672), Dst Port: 38680 (38680), Seq: 41380, Ack=
:<i> 21178, Len: 82&lt;br&gt;
</I>Advanced Message Queueing Protocol&lt;br&gt;--------&lt;br&gt;&lt;br&gt;That is, it looks lik=
e a Basic.Deliver and a Basic.Publish are sneaking in before the Tx.Commit-=
Ok comes back.&lt;br&gt;&lt;br&gt;I suspect this is a Pika issue, but my reading of the=
 code doesn&amp;#39;t show any obvious problems.&lt;br&gt;
&lt;br&gt;Thanks,&lt;br&gt;&lt;br&gt;Matt&lt;br&gt;&lt;br&gt;

--047d7b5d9ce7397a8104c76641a6--
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021869.html">No subject
</A></li>
	<LI>Next message: <A HREF="021973.html">No subject
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21937">[ date ]</a>
              <a href="thread.html#21937">[ thread ]</a>
              <a href="subject.html#21937">[ subject ]</a>
              <a href="author.html#21937">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
