<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ failure under high load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20failure%20under%20high%20load&In-Reply-To=%3C4FEAE228.3040000%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020907.html">
   <LINK REL="Next"  HREF="020859.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ failure under high load</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20failure%20under%20high%20load&In-Reply-To=%3C4FEAE228.3040000%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ failure under high load">simon at rabbitmq.com
       </A><BR>
    <I>Wed Jun 27 11:36:24 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="020907.html">[rabbitmq-discuss] Connection attempt from disallowed node	question
</A></li>
        <LI>Next message: <A HREF="020859.html">[rabbitmq-discuss] RabbitMQ failure under high load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20858">[ date ]</a>
              <a href="thread.html#20858">[ thread ]</a>
              <a href="subject.html#20858">[ subject ]</a>
              <a href="author.html#20858">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Micha&#322; - please can you keep rabbitmq-discuss on CC?

So as I said, the limit is only the point at which Rabbit stops 
accepting new messages. In the general case this should be enough to 
stop further memory consumption - but in your case it looks like it 
isn't. If you were able to post your test tool in a way that would make 
it easy for us to run, then that might be the easiest way for us to help 
you. At the moment we just don't have enough information.

Cheers, Simon

On 27/06/12 09:36, Micha&#322; Ki&#281;dy&#347; wrote:
&gt;<i> Simon,
</I>&gt;<i>
</I>&gt;<i> My question becomes from fact, that Rabbit can consume even more than
</I>&gt;<i> 4GB when limit is set to 1.6GB.
</I>&gt;<i> At this scenario raports usage at 2.7GB but real usage is more than 4GB.
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at arch-task-mq</A> -8
</I>&gt;<i> &lt;<A HREF="http://arch-task-mq-7:55672/#/nodes/rabbit%40arch-task-mq-8">http://arch-task-mq-7:55672/#/nodes/rabbit%40arch-task-mq-8</A>&gt;
</I>&gt;<i> 734 / 1024
</I>&gt;<i> 701 / 829
</I>&gt;<i> 5795 / 1048576
</I>&gt;<i> 2.7GB (?)
</I>&gt;<i> _1.6GB high watermark
</I>&gt;<i> 49.6GB
</I>&gt;<i> _4.0GB low watermark 12m 33sRAM
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> After a while kernel kills Rabbit process:
</I>&gt;<i>
</I>&gt;<i> Mem-info:
</I>&gt;<i> DMA per-cpu:
</I>&gt;<i> cpu 0 hot: high 186, batch 31 used:8
</I>&gt;<i> cpu 0 cold: high 62, batch 15 used:48
</I>&gt;<i> cpu 1 hot: high 186, batch 31 used:108
</I>&gt;<i> cpu 1 cold: high 62, batch 15 used:55
</I>&gt;<i> cpu 2 hot: high 186, batch 31 used:118
</I>&gt;<i> cpu 2 cold: high 62, batch 15 used:53
</I>&gt;<i> cpu 3 hot: high 186, batch 31 used:89
</I>&gt;<i> cpu 3 cold: high 62, batch 15 used:55
</I>&gt;<i> DMA32 per-cpu: empty
</I>&gt;<i> Normal per-cpu: empty
</I>&gt;<i> HighMem per-cpu: empty
</I>&gt;<i> Free pages:       12076kB (0kB HighMem)
</I>&gt;<i> Active:0 inactive:741324 dirty:0 writeback:9 unstable:0 free:3023
</I>&gt;<i> slab:101876 mapped:3649 pagetables:2586
</I>&gt;<i> DMA free:12092kB min:8196kB low:10244kB high:12292kB active:0kB
</I>&gt;<i> inactive:2965168kB present:4202496kB pages_scanned:32 all_unreclaimable? no
</I>&gt;<i> lowmem_reserve[]: 0 0 0 0
</I>&gt;<i> DMA32 free:0kB min:0kB low:0kB high:0kB active:0kB inactive:0kB
</I>&gt;<i> present:0kB pages_scanned:0 all_unreclaimable? no
</I>&gt;<i> lowmem_reserve[]: 0 0 0 0
</I>&gt;<i> Normal free:0kB min:0kB low:0kB high:0kB active:0kB inactive:0kB
</I>&gt;<i> present:0kB pages_scanned:0 all_unreclaimable? no
</I>&gt;<i> lowmem_reserve[]: 0 0 0 0
</I>&gt;<i> HighMem free:0kB min:128kB low:128kB high:128kB active:0kB inactive:0kB
</I>&gt;<i> present:0kB pages_scanned:0 all_unreclaimable? no
</I>&gt;<i> lowmem_reserve[]: 0 0 0 0
</I>&gt;<i> DMA: 172*4kB 533*8kB 170*16kB 41*32kB 11*64kB 1*128kB 1*256kB 1*512kB
</I>&gt;<i> 0*1024kB 1*2048kB 0*4096kB = 12632kB
</I>&gt;<i> DMA32: empty
</I>&gt;<i> Normal: empty
</I>&gt;<i> HighMem: empty
</I>&gt;<i> Swap cache: add 4358, delete 4243, find 0/0, race 0+0
</I>&gt;<i> Free swap  = 1031136kB
</I>&gt;<i> Total swap = 1048568kB
</I>&gt;<i> Free swap:       1031136kB
</I>&gt;<i> 1050624 pages of RAM
</I>&gt;<i> 26588 reserved pages
</I>&gt;<i> 17300 pages shared
</I>&gt;<i> 83 pages swap cached
</I>&gt;<i> Out of Memory: Kill process 2213 (rabbitmq-server) score 14598295 and
</I>&gt;<i> children.
</I>&gt;<i> Out of memory: Killed process 2227 (beam.smp).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This is Ok?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> MK
</I>&gt;<i>
</I>&gt;<i> 2012/6/22 Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt;
</I>&gt;<i>
</I>&gt;<i>     Hi Micha&#322;.
</I>&gt;<i>
</I>&gt;<i>     This is quite vague - if we can't see the source of your test tool
</I>&gt;<i>     it's hard to see what it's actually doing.
</I>&gt;<i>
</I>&gt;<i>     The server can use more memory than the high watermark; that's just
</I>&gt;<i>     the point at which it stops accepting new messages from the network.
</I>&gt;<i>     This should greatly cut the extent to which it can consume more
</I>&gt;<i>     memory, but will not eliminate it.
</I>&gt;<i>
</I>&gt;<i>     There is an existing issue where the processes used by connections
</I>&gt;<i>     do not close when the connection is closed and memory use is above
</I>&gt;<i>     the watermark. When the memory use drops the processes will go.
</I>&gt;<i>     Could your test application be opening new connections?
</I>&gt;<i>
</I>&gt;<i>     Also, you say:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         The readers has been disconnected by the server ahead of time.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     does this mean that huge numbers of messages are building up in the
</I>&gt;<i>     server? Note that in the default configuration there is a
</I>&gt;<i>     per-message cost in memory of a hundred bytes or so even when the
</I>&gt;<i>     message has been paged out to disc, so that might explain why so
</I>&gt;<i>     much memory is being used.
</I>&gt;<i>
</I>&gt;<i>     I hope this helps explain what you are seeing. But I'm not exactly
</I>&gt;<i>     sure what you are doing...
</I>&gt;<i>
</I>&gt;<i>     Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     On 22/06/12 14:09, Micha&#322; Ki&#281;dy&#347; wrote:
</I>&gt;<i>
</I>&gt;<i>         Hi,
</I>&gt;<i>
</I>&gt;<i>         Software version: 2.8.2
</I>&gt;<i>         The cluster has been stressed with 1000 writers and 100 readers.
</I>&gt;<i>         Message
</I>&gt;<i>         size is 100kB.
</I>&gt;<i>         Test configuration:
</I>&gt;<i>
</I>&gt;<i>         _readers node #1_
</I>&gt;<i>
</I>&gt;<i>         test.ConnectionPerWorker=true
</I>&gt;<i>         test.WritersCount=0
</I>&gt;<i>         test.ReadersCount=33
</I>&gt;<i>         test.Durable=true
</I>&gt;<i>         test.QueuesCount=1
</I>&gt;<i>         test.AutoAck=false
</I>&gt;<i>         test.ExchangeType=direct
</I>&gt;<i>         test.QueueNamePrefix=direct
</I>&gt;<i>         test.Host=arch-task-mq-7.atm
</I>&gt;<i>
</I>&gt;<i>         _readers node #2_
</I>&gt;<i>
</I>&gt;<i>         test.ConnectionPerWorker=true
</I>&gt;<i>         test.WritersCount=0
</I>&gt;<i>         test.ReadersCount=33
</I>&gt;<i>         test.Durable=true
</I>&gt;<i>         test.QueuesCount=1
</I>&gt;<i>         test.AutoAck=false
</I>&gt;<i>         test.ExchangeType=direct
</I>&gt;<i>         test.QueueNamePrefix=direct
</I>&gt;<i>         test.Host=arch-task-mq-8.atm
</I>&gt;<i>
</I>&gt;<i>         _readers node #3_
</I>&gt;<i>
</I>&gt;<i>         test.ConnectionPerWorker=true
</I>&gt;<i>         test.WritersCount=0
</I>&gt;<i>         test.ReadersCount=33
</I>&gt;<i>         test.Durable=true
</I>&gt;<i>         test.QueuesCount=1
</I>&gt;<i>         test.AutoAck=false
</I>&gt;<i>         test.ExchangeType=direct
</I>&gt;<i>         test.QueueNamePrefix=direct
</I>&gt;<i>         test.Host=arch-task-mq-8.atm
</I>&gt;<i>
</I>&gt;<i>         _writers node #4_
</I>&gt;<i>
</I>&gt;<i>         test.ConnectionPerWorker=true
</I>&gt;<i>         test.WritersCount=333
</I>&gt;<i>         test.ReadersCount=0
</I>&gt;<i>         test.Durable=true
</I>&gt;<i>         test.QueuesCount=1
</I>&gt;<i>         test.AutoAck=false
</I>&gt;<i>         test.ExchangeType=direct
</I>&gt;<i>         test.QueueNamePrefix=direct
</I>&gt;<i>         test.BodySize=102400
</I>&gt;<i>         # available units: s(seconds), m(minutes), h(hours) d(days)
</I>&gt;<i>         test.TestDuration=3h
</I>&gt;<i>         test.Host=arch-task-mq-8.atm
</I>&gt;<i>
</I>&gt;<i>         writers node #5
</I>&gt;<i>         test.ConnectionPerWorker=true
</I>&gt;<i>         test.WritersCount=333
</I>&gt;<i>         test.ReadersCount=0
</I>&gt;<i>         test.Durable=true
</I>&gt;<i>         test.QueuesCount=1
</I>&gt;<i>         test.AutoAck=false
</I>&gt;<i>         test.ExchangeType=direct
</I>&gt;<i>         test.QueueNamePrefix=direct
</I>&gt;<i>         test.BodySize=102400
</I>&gt;<i>         # available units: s(seconds), m(minutes), h(hours) d(days)
</I>&gt;<i>         test.TestDuration=3h
</I>&gt;<i>         test.Host=arch-task-mq-7.atm
</I>&gt;<i>
</I>&gt;<i>         writers node #6
</I>&gt;<i>         test.ConnectionPerWorker=true
</I>&gt;<i>         test.WritersCount=334
</I>&gt;<i>         test.ReadersCount=0
</I>&gt;<i>         test.Durable=true
</I>&gt;<i>         test.QueuesCount=1
</I>&gt;<i>         test.AutoAck=false
</I>&gt;<i>         test.ExchangeType=direct
</I>&gt;<i>         test.QueueNamePrefix=direct
</I>&gt;<i>         test.BodySize=102400
</I>&gt;<i>         # available units: s(seconds), m(minutes), h(hours) d(days)
</I>&gt;<i>         test.TestDuration=3h
</I>&gt;<i>         test.Host=arch-task-mq-8.atm
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         _Actual tests state:_
</I>&gt;<i>
</I>&gt;<i>         Running worker-1000w-100r-100kB
</I>&gt;<i>         Preparing tests on arch-task-mq-1
</I>&gt;<i>         Preparing tests on arch-task-mq-2
</I>&gt;<i>         Preparing tests on arch-task-mq-3
</I>&gt;<i>         Preparing tests on arch-task-mq-4
</I>&gt;<i>         Preparing tests on arch-task-mq-5
</I>&gt;<i>         Preparing tests on arch-task-mq-6
</I>&gt;<i>         Preparations done, starting testing procedure
</I>&gt;<i>         Start tests on arch-task-mq-1
</I>&gt;<i>         Start tests on arch-task-mq-2
</I>&gt;<i>         Start tests on arch-task-mq-3
</I>&gt;<i>         Start tests on arch-task-mq-4
</I>&gt;<i>         Start tests on arch-task-mq-5
</I>&gt;<i>         Start tests on arch-task-mq-6
</I>&gt;<i>         Waiting for tests to finish
</I>&gt;<i>         Tests done on arch-task-mq-5
</I>&gt;<i>         Tests done on arch-task-mq-6
</I>&gt;<i>         Tests done on arch-task-mq-4
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         The readers has been disconnected by the server ahead of time.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         _Actual cluster state (data from Management Plugin view):_
</I>&gt;<i>
</I>&gt;<i>         Name                   File descriptors (?)           Socket
</I>&gt;<i>         descriptors
</I>&gt;<i>         (?)           Erlang processes      Memory                      Disk
</I>&gt;<i>         space     Uptime     Type
</I>&gt;<i>                                             (used / available)
</I>&gt;<i>            (used
</I>&gt;<i>         / available)                  (used / available)
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabit at arch-task-mq-7</A>    392 / 1024                     334 / 829
</I>&gt;<i>                               2885 / 1048576        540.2MB
</I>&gt;<i>           49.6GB          21h 14m  Disc Stats *
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>           1.6GB high watermark 4.0GB low watermark
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at arch-task-mq-8</A>  692 / 1024                     668 / 829
</I>&gt;<i>                                5522 / 1048576        1.8GB (?)
</I>&gt;<i>           46.1GB          21h 16m  RAM
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>           1.6GB high watermark 4.0GB low watermark
</I>&gt;<i>
</I>&gt;<i>         Number of processes is growing all the time even though no
</I>&gt;<i>         messages are
</I>&gt;<i>         not published or received.
</I>&gt;<i>         All publishers has been blocked. After some time I killed the
</I>&gt;<i>         publisher processes, but RabbitMQ still sees them as connected and
</I>&gt;<i>         blocked. :)
</I>&gt;<i>
</I>&gt;<i>         Some logs:
</I>&gt;<i>
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mkiedys at arch-task-mq-8</A>:/var/__log/rabbitmq$ cat
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at arch-task-mq-8.log</A>
</I>&gt;<i>         |grep vm_memory_high|tail -n 20
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1709148224
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2135174984
</I>&gt;<i>         &lt;tel:2135174984&gt; allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1593121728
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2043534608
</I>&gt;<i>         &lt;tel:2043534608&gt; allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1681947128
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2088225952
</I>&gt;<i>         &lt;tel:2088225952&gt; allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1710494800
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2208875080
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1713902032
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2122564032
</I>&gt;<i>         &lt;tel:2122564032&gt; allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1663616264
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2098909664
</I>&gt;<i>         &lt;tel:2098909664&gt; allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1712666136
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2088814360
</I>&gt;<i>         &lt;tel:2088814360&gt; allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1640273568
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2116966952
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1715305176
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2186572648
</I>&gt;<i>         &lt;tel:2186572648&gt; allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark clear. Memory used:1716620504
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>         vm_memory_high_watermark set. Memory used:2180898440
</I>&gt;<i>         allowed:1717986918
</I>&gt;<i>
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mkiedys at arch-task-mq-8</A>:/var/__log/rabbitmq$ cat
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at arch-task-mq-8.log</A>
</I>&gt;<i>         |grep vm_memory_high|wc -l
</I>&gt;<i>         2935
</I>&gt;<i>
</I>&gt;<i>         Why does the server consumes more memory than 1.6GB limit?
</I>&gt;<i>
</I>&gt;<i>         Regards,
</I>&gt;<i>         MK
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         _________________________________________________
</I>&gt;<i>         rabbitmq-discuss mailing list
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.__rabbitmq.com</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i>         <A HREF="https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss">https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss</A>
</I>&gt;<i>         &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     --
</I>&gt;<i>     Simon MacMullen
</I>&gt;<i>     RabbitMQ, VMware
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020907.html">[rabbitmq-discuss] Connection attempt from disallowed node	question
</A></li>
	<LI>Next message: <A HREF="020859.html">[rabbitmq-discuss] RabbitMQ failure under high load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20858">[ date ]</a>
              <a href="thread.html#20858">[ thread ]</a>
              <a href="subject.html#20858">[ subject ]</a>
              <a href="author.html#20858">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
