<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] High availability questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20High%20availability%20questions&In-Reply-To=%3CCAD6m6fG-md5cBax0qBiWnJv5hyO-c9F_tzz_FMociVBW82-pRA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024374.html">
   <LINK REL="Next"  HREF="024364.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] High availability questions</H1>
    <B>Jason McIntosh</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20High%20availability%20questions&In-Reply-To=%3CCAD6m6fG-md5cBax0qBiWnJv5hyO-c9F_tzz_FMociVBW82-pRA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] High availability questions">mcintoshj at gmail.com
       </A><BR>
    <I>Thu Dec  6 20:17:33 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024374.html">[rabbitmq-discuss] High availability questions
</A></li>
        <LI>Next message: <A HREF="024364.html">[rabbitmq-discuss] RabbitMQ - 3.0.0 multi node with detach command
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24375">[ date ]</a>
              <a href="thread.html#24375">[ thread ]</a>
              <a href="subject.html#24375">[ subject ]</a>
              <a href="author.html#24375">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So our &quot;publishers&quot; publish to a local rabbitmq in a remote data center.
 Then each shovels their messages to a warehousing cluster for consumption.
 In our case, upgrading a remote system is just pulling that remote system
out of the load balancer, waiting for all it's messages to shovel,
stopping, upgrading it, then rinse &amp; repeat.

In theory, you could do something along the lines of what you're talking
about by clustering your publisher rabbit boxes together, just like you'd
do for the consumer process.  As long as your load balancer stays up
reliably (which they're supposed to do).  I HAVE had issues with connection
resets breaking clients, so like anything else, make sure you test it.
 Connection resets though when shoveling seem to handle such a situation
fine - I'm guessing shovel is designed to work even when it's connection
breaks :)  Which is AWESOME btw.

Jason


On Thu, Dec 6, 2012 at 1:06 PM, Chris Toomey &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ctoomey at gmail.com</A>&gt; wrote:

&gt;<i> So your publishers connect to cluster A, which shovels a VIP that
</I>&gt;<i> initially points to cluster B, and your consumers connect to B.  To upgrade
</I>&gt;<i> B, you point the shovel VIP to new cluster C and start new consumers on C,
</I>&gt;<i> then kill off the consumers on B when they've consumed all the messages.
</I>&gt;<i>  Right?  How do you upgrade cluster A?
</I>&gt;<i>
</I>&gt;<i> We'd like to have a solution that doesn't require our publishers/consumers
</I>&gt;<i> to be touched/restarted at all; since we're starting with a clean sheet we
</I>&gt;<i> can build whatever intelligence we need into our publishers/consumers.  One
</I>&gt;<i> idea is to have 2 clusters, a primary A and secondary B, have publishers
</I>&gt;<i> normally publish to A only, and have consumers consume from both A and B.
</I>&gt;<i>  Then to upgrade A, we would need a way to trigger publishers to start
</I>&gt;<i> publishing to B, and then once all the queues on A were drained by
</I>&gt;<i> consumers we'd shut it down and upgrade.  Then we'd need a similar trigger
</I>&gt;<i> to switch the publishers back to A.
</I>&gt;<i>
</I>&gt;<i> I think if we define a publishing VIP in our load balancer and have
</I>&gt;<i> publishers connect to that, we could accomplish the publishing redirection
</I>&gt;<i> from A to B and back.  To switch them to cluster B, we would terminate
</I>&gt;<i> those VIP connections and point the VIP to cluster B, and then vice-versa
</I>&gt;<i> after A is upgraded.  We'd just need to make sure the publishers
</I>&gt;<i> automatically reconnect to the VIP after being disconnected.
</I>&gt;<i>
</I>&gt;<i> Sound right?
</I>&gt;<i>
</I>&gt;<i> thx,
</I>&gt;<i> Chris
</I>&gt;<i>
</I>&gt;<i> On Wed, Dec 5, 2012 at 7:19 PM, McIntosh Jason &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mcintoshj at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Design we use:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Shovel to a virtual ip rabbit cluster.
</I>&gt;&gt;<i> Rabbit consumers on that cluster.
</I>&gt;&gt;<i> Start new cluster.
</I>&gt;&gt;<i> Can point consumers to hard coded cluster.
</I>&gt;&gt;<i> Shift shovel and/or change VIP to point to new cluster.
</I>&gt;&gt;<i> When all messages on old consumers cleaned, shut them down point em to
</I>&gt;&gt;<i> new cluster.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Our consumers are java apps built into rpms we deploy, so updates are
</I>&gt;&gt;<i> just a restart/new rpm deploy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is pretty rough but hope it helps!
</I>&gt;&gt;<i> Jason
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sent from my iPhone
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Dec 5, 2012, at 9:00 PM, Chris Toomey &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ctoomey at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Belated follow-up on this thread.  Can you talk more about how you
</I>&gt;&gt;<i> manage
</I>&gt;&gt;<i> &gt; this?  E.g., how do you ensure that clients continue consuming from the
</I>&gt;&gt;<i> old
</I>&gt;&gt;<i> &gt; cluster until all the messages published to it have been consumed?  And
</I>&gt;&gt;<i> &gt; during the transition time, consuming clients consume from both old and
</I>&gt;&gt;<i> new
</I>&gt;&gt;<i> &gt; cluster, right?  What hardware/software do you use to gradually shift
</I>&gt;&gt;<i> &gt; publishing from old to new cluster?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; We're just now designing and implementing our infrastructure and apps so
</I>&gt;&gt;<i> &gt; would like to get it as right as possible from the beginning.  Anyone
</I>&gt;&gt;<i> else
</I>&gt;&gt;<i> &gt; using/recommend other approaches to this problem?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; thx,
</I>&gt;&gt;<i> &gt; Chris
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Laing, Michael P. wrote
</I>&gt;&gt;<i> &gt;&gt; We bring up parallel infrastructure with a complete new cluster and
</I>&gt;&gt;<i> &gt;&gt; gradually shift load to it using weighted routing.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; This won't work for everybody, but we have designed our apps with this
</I>&gt;&gt;<i> in
</I>&gt;&gt;<i> &gt;&gt; mind.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Michael
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; From: Chris Toomey &amp;lt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt; ctoomey@
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt; &amp;lt;mailto:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt; ctoomey@
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt; &amp;gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; ...
</I>&gt;&gt;<i> &gt;&gt; That's unfortunate about having to shut down the whole cluster to
</I>&gt;&gt;<i> upgrade
</I>&gt;&gt;<i> &gt;&gt; it -- it means that our applications will need to have some additional
</I>&gt;&gt;<i> HA
</I>&gt;&gt;<i> &gt;&gt; queueing mechanism upstream to buffer up the messages to be published
</I>&gt;&gt;<i> &gt;&gt; during the downtime :-(.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; What kinds of solutions are people using for that problem?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; --
</I>&gt;&gt;<i> &gt; View this message in context:
</I>&gt;&gt;<i> <A HREF="http://rabbitmq.1065348.n5.nabble.com/High-availability-questions-tp23690p23889.html">http://rabbitmq.1065348.n5.nabble.com/High-availability-questions-tp23690p23889.html</A>
</I>&gt;&gt;<i> &gt; Sent from the RabbitMQ mailing list archive at Nabble.com.
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Jason McIntosh
<A HREF="http://mcintosh.poetshome.com/blog/">http://mcintosh.poetshome.com/blog/</A>
573-424-7612
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121206/f1e29201/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121206/f1e29201/attachment.htm</A>&gt;
</PRE>









































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024374.html">[rabbitmq-discuss] High availability questions
</A></li>
	<LI>Next message: <A HREF="024364.html">[rabbitmq-discuss] RabbitMQ - 3.0.0 multi node with detach command
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24375">[ date ]</a>
              <a href="thread.html#24375">[ thread ]</a>
              <a href="subject.html#24375">[ subject ]</a>
              <a href="author.html#24375">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
