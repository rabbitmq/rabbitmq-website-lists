<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Latency of publish confirm
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Latency%20of%20publish%20confirm&In-Reply-To=%3C50BE2248.4070103%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024324.html">
   <LINK REL="Next"  HREF="024331.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Latency of publish confirm</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Latency%20of%20publish%20confirm&In-Reply-To=%3C50BE2248.4070103%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Latency of publish confirm">simon at rabbitmq.com
       </A><BR>
    <I>Tue Dec  4 16:18:16 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024324.html">[rabbitmq-discuss] Latency of publish confirm
</A></li>
        <LI>Next message: <A HREF="024331.html">[rabbitmq-discuss] Latency of publish confirm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24328">[ date ]</a>
              <a href="thread.html#24328">[ thread ]</a>
              <a href="subject.html#24328">[ subject ]</a>
              <a href="author.html#24328">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi. Yes you are right, there is 25ms of latency sending confirms inside 
the broker when using mirrored queues. I'll file a bug to get this fixed.

Cheers, Simon

On 04/12/12 15:16, Pierpaolo Baccichet wrote:
&gt;<i> Found something interesting. I tried to temporarily disable the policy
</I>&gt;<i> for mirroring of my test queue and now I am consistently getting 7/7.5
</I>&gt;<i> milliseconds latency. Seems like the issue is triggered by the mirroring
</I>&gt;<i> of the queue.
</I>&gt;<i>
</I>&gt;<i> Pier
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, Dec 4, 2012 at 7:11 AM, Pierpaolo Baccichet
</I>&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pierpaolo at dropbox.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pierpaolo at dropbox.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     Hello Matthias,
</I>&gt;<i>
</I>&gt;<i>     Thanks for your quick response!
</I>&gt;<i>
</I>&gt;<i>     I double checked the code to make sure that I am not marking
</I>&gt;<i>     messages as persistent and indeed that's the case. The queues and
</I>&gt;<i>     the exchanges are marked as durable but the individual messages I
</I>&gt;<i>     send are not setting the delivery_mode=2.
</I>&gt;<i>
</I>&gt;<i>     I am a little skeptical the issue here is sync on disk because
</I>&gt;<i>     adding producers does not change the behavior. I ran a test with 5
</I>&gt;<i>     producers sending 10 messages per second each and I am still seeing
</I>&gt;<i>     exactly the same results. Each producer observes latencies that are
</I>&gt;<i>     multiple of 31 milliseconds (though based on wireshark capture, this
</I>&gt;<i>     latency seems to be dominated by the 25 milliseconds we see in
</I>&gt;<i>     rabbitMQ side). Example output of what I am seeing on the producer
</I>&gt;<i>     side is below:
</I>&gt;<i>
</I>&gt;<i>     1354633782.0697601 - completing send 15 took 63.736915588378906
</I>&gt;<i>     1354633782.233757 - completing send 16 took 63.80009651184082
</I>&gt;<i>     1354633782.3976469 - completing send 17 took 63.717842102050781
</I>&gt;<i>     1354633782.5615449 - completing send 18 took 63.707828521728516
</I>&gt;<i>     1354633782.725692 - completing send 19 took 63.929080963134766
</I>&gt;<i>     1354633782.8579049 - completing send 20 took 31.997919082641602
</I>&gt;<i>     1354633783.0219419 - completing send 21 took 63.837051391601562
</I>&gt;<i>     1354633783.1538589 - completing send 22 took 31.718969345092773
</I>&gt;<i>     1354633783.285862 - completing send 23 took 31.77189826965332
</I>&gt;<i>     1354633783.4498329 - completing send 24 took 63.776016235351562
</I>&gt;<i>
</I>&gt;<i>     Also, in my previous email I forgot to specify my environment. I am
</I>&gt;<i>     running on rabbitMQ 3.0 Erlang R15B02. Python and pika 0.9.8 on the
</I>&gt;<i>     client side
</I>&gt;<i>
</I>&gt;<i>     Pierpaolo
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     On Tue, Dec 4, 2012 at 1:22 AM, Matthias Radestock
</I>&gt;<i>     &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>         On 04/12/12 08:55, Matthias Radestock wrote:
</I>&gt;<i>
</I>&gt;<i>             I am guessing your messages are marked as persistent. The
</I>&gt;<i>             25ms is indeed
</I>&gt;<i>             an aggregation interval, but for the disk (in particular
</I>&gt;<i>             fsyncs) rather
</I>&gt;<i>             than the network.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         However, fsyncs also happen when queues and the storage
</I>&gt;<i>         sub-system go idle, so the interval only kicks in when the
</I>&gt;<i>         system is busy (thus ensuring that fsyncs aren't delayed
</I>&gt;<i>         indefinitely).
</I>&gt;<i>
</I>&gt;<i>         So I am pretty sure what you are seeing is simply the cost of
</I>&gt;<i>         performing an fsync per message. There's nothing that can be
</I>&gt;<i>         done about that except buying faster disks / switching to SSDs.
</I>&gt;<i>
</I>&gt;<i>         Regards,
</I>&gt;<i>
</I>&gt;<i>         Matthias.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024324.html">[rabbitmq-discuss] Latency of publish confirm
</A></li>
	<LI>Next message: <A HREF="024331.html">[rabbitmq-discuss] Latency of publish confirm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24328">[ date ]</a>
              <a href="thread.html#24328">[ thread ]</a>
              <a href="subject.html#24328">[ subject ]</a>
              <a href="author.html#24328">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
