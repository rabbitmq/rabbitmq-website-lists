<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] BIGIP/F5 and Connection resets
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20BIGIP/F5%20and%20Connection%20resets&In-Reply-To=%3CCAD6m6fGjd63PunXK21Aaf4ki-e_rr%3DJdf_pniaeoZQiJo0r80A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024580.html">
   <LINK REL="Next"  HREF="024602.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] BIGIP/F5 and Connection resets</H1>
    <B>Jason McIntosh</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20BIGIP/F5%20and%20Connection%20resets&In-Reply-To=%3CCAD6m6fGjd63PunXK21Aaf4ki-e_rr%3DJdf_pniaeoZQiJo0r80A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] BIGIP/F5 and Connection resets">mcintoshj at gmail.com
       </A><BR>
    <I>Wed Dec 19 16:39:53 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024580.html">[rabbitmq-discuss] BIGIP/F5 and Connection resets
</A></li>
        <LI>Next message: <A HREF="024602.html">[rabbitmq-discuss] BIGIP/F5 and Connection resets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24598">[ date ]</a>
              <a href="thread.html#24598">[ thread ]</a>
              <a href="subject.html#24598">[ subject ]</a>
              <a href="author.html#24598">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I saw that heartbeats are turned on with 3.0.0 - the question is does 2.8.7
have heartbeat support by default on the server side or can it be turned
on?  How is this different the SO_KEEPALIVE:
<A HREF="http://www.erlang.org/doc/man/inet.html">http://www.erlang.org/doc/man/inet.html</A>

 There's no details on the documentation about configuring the heartbeat on
2.8.7 setting if there is a configuration option for it.  I did find this:
<A HREF="https://bugs.launchpad.net/nova/+bug/856764">https://bugs.launchpad.net/nova/+bug/856764</A>
AND
<A HREF="http://rabbitmq.1065348.n5.nabble.com/Timeout-for-hung-connection-on-rabbitmq-server-td21354.html">http://rabbitmq.1065348.n5.nabble.com/Timeout-for-hung-connection-on-rabbitmq-server-td21354.html</A>
I'm not sure what the difference is between a rabbit heartbeat and erlangs
keepalive?  Or is heartbeat just turning on keepalive?  I'm going to look
at the erlang configuration as a possible fix.  We're trying to do this on
the server side so we don't have to modify all of our clients.

Here's a few more details on the exact issue we've encountered
RAB_SERVER &lt;-&gt; F5/Firewall/etc. &lt;-&gt; RAB_CLIENT
the client and server don't have any traffic going through so they get
disconnected in one of two ways.  If we used just a router and not a load
balancer it seems most network firewalls auto disconnect with NO
notification both clients after an hour of no TCP/IP traffic (from what I
understand, SSH for example uses a TCP/IP Keepalive to keep their
connections going).  The load balancer on the other hand does a graceful
RESET to both client and server after our delay of 300 seconds.  We've
tried increasing the delay, but it looks like 2.8.7 by default doesn't set
any kind of heartbeat or keepalive so even if we set it to an hour, we'd
still get resets.

Rabbit clients using spring &amp; the shovel configuration itself handle resets
of the connection pretty gracefully.  The issue is I'd rather not have
resets as I don't trust all clients to be nice about reconnecting.  The
spring code reconnects gracefully - the standard rabbit client doesn't seem
to be as nice about reconnecting.

Jason






On Tue, Dec 18, 2012 at 6:52 AM, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> Hi Jason,
</I>&gt;<i>
</I>&gt;<i> On 17/12/12 22:53, Jason McIntosh wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; From what I've been told, most network devices drop TCP/IP
</I>&gt;<i> &gt; connections after an hour automatically (i.e. switches, routers,
</I>&gt;<i> &gt; etc.) and force a reconnect - not sure if Rabbit handles this?
</I>&gt;<i>
</I>&gt;<i> The broker handles a closed connection by logging the event.
</I>&gt;<i>
</I>&gt;<i> &gt; There is a work around at the moment we're looking into.  It looks like
</I>&gt;<i> &gt; most (if not all) Rabbit interfaces have a heartbeat setting that would
</I>&gt;<i> &gt; allow connections to be maintained
</I>&gt;<i>
</I>&gt;<i> Yes, AMQP heartbeats are a suitable solution if intermediate network
</I>&gt;<i> devices are closing idle connections too eagerly. Heartbeats are enabled
</I>&gt;<i> by default in v3.0.0 if the client supports them.
</I>&gt;<i>
</I>&gt;<i> Another options is to write client applications to re-establish closed
</I>&gt;<i> connections after a suitable delay.
</I>&gt;<i>
</I>&gt;<i> If consumers receive messages asynchronously instead of polling the
</I>&gt;<i> broker for messages, and there are no messages to deliver then the TCP
</I>&gt;<i> connection will carry no traffic.
</I>&gt;<i>
</I>&gt;<i> &gt; Other questions related to the above:  Is the AMQP protocol designed to
</I>&gt;<i> &gt; have the clients just sit idle, no communication with the servers until
</I>&gt;<i> &gt; a message comes in
</I>&gt;<i>
</I>&gt;<i> Rabbit does not impose limits on connection duration and idle
</I>&gt;<i> connections are permitted to remain so indefinitely.
</I>&gt;<i>
</I>&gt;<i> &gt; If there is no check, and the client hasn't received a message in a
</I>&gt;<i> &gt; day at what point do you retry your connection to verify you're even
</I>&gt;<i> &gt; still connected? It sounds like in this case you could have a
</I>&gt;<i> &gt; consumer of a queue lose it's connection and never realize
</I>&gt;<i>
</I>&gt;<i> If connections are being severed silently without notification from the
</I>&gt;<i> network stack then you must use AMQP heartbeats so that both sides of
</I>&gt;<i> the connection become aware of it. Otherwise the network stack should
</I>&gt;<i> provide notification that the connection has been interrupted.
</I>&gt;<i>
</I>&gt;<i> &gt; Then you'd have a server just sitting backlogging messages waiting
</I>&gt;<i> &gt; for a client (or worse depending on configuration, just dropping all
</I>&gt;<i> &gt; the messages).
</I>&gt;<i>
</I>&gt;<i> The broker will not drop messages due to broken connections and the
</I>&gt;<i> protocol is designed so that a guarantee of message delivery can be
</I>&gt;<i> offered even in the face of an unreliable transport.
</I>&gt;<i>
</I>&gt;<i> &gt; Looked at the AMQP 0-9-1 specifications and not seeing a whole lot
</I>&gt;<i> &gt; defined on how AMQP implementers are supposed to work with TCP/IP
</I>&gt;<i> &gt; traffic (other than some heartbeat definitions).
</I>&gt;<i>
</I>&gt;<i> The &quot;connection&quot; class relates to the transport, which must be
</I>&gt;<i> stream-oriented.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -Emile
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Jason McIntosh
<A HREF="http://mcintosh.poetshome.com/blog/">http://mcintosh.poetshome.com/blog/</A>
573-424-7612
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121219/7c8d0179/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121219/7c8d0179/attachment.htm</A>&gt;
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024580.html">[rabbitmq-discuss] BIGIP/F5 and Connection resets
</A></li>
	<LI>Next message: <A HREF="024602.html">[rabbitmq-discuss] BIGIP/F5 and Connection resets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24598">[ date ]</a>
              <a href="thread.html#24598">[ thread ]</a>
              <a href="subject.html#24598">[ subject ]</a>
              <a href="author.html#24598">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
