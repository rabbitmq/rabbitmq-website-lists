<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Federation and upstream cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Federation%20and%20upstream%20cluster&In-Reply-To=%3C672A41EB-0A96-4AB3-A61F-CD84CF76A2DF%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024689.html">
   <LINK REL="Next"  HREF="024691.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Federation and upstream cluster</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Federation%20and%20upstream%20cluster&In-Reply-To=%3C672A41EB-0A96-4AB3-A61F-CD84CF76A2DF%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Federation and upstream cluster">tim at rabbitmq.com
       </A><BR>
    <I>Fri Dec 28 11:04:59 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024689.html">[rabbitmq-discuss] Federation and upstream cluster
</A></li>
        <LI>Next message: <A HREF="024691.html">[rabbitmq-discuss] Federation and upstream cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24690">[ date ]</a>
              <a href="thread.html#24690">[ thread ]</a>
              <a href="subject.html#24690">[ subject ]</a>
              <a href="author.html#24690">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Vladislav,

Is the upstream exchange you're federating durable? If not, it's going to be deleted when you shut the broker down, which would explain the NOT_FOUND error.

Cheers,
Tim

On 28 Dec 2012, at 09:32, Vladislav Pernin wrote:

&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I'm running RabbitMQ 3.0.1 on two cluster of Linux servers.
</I>&gt;<i> 
</I>&gt;<i> Let's name the two clusters :
</I>&gt;<i> - downstream cluster running a federation to get messages from upstream
</I>&gt;<i> cluster
</I>&gt;<i> - upstream cluster
</I>&gt;<i> 
</I>&gt;<i> The documentation explains well if a node fails, links to upstream
</I>&gt;<i> exchanges will be recreated on a surviving node.
</I>&gt;<i> There is no problem for the &quot;client&quot; side of the federation.
</I>&gt;<i> 
</I>&gt;<i> I cannot use a load balancer if fail over mode to have high avaibility
</I>&gt;<i> of the upstream cluster.
</I>&gt;<i> 
</I>&gt;<i> What would be the recommended solution in this case ?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I'm struggling to understand what the question is here Vladislav. The 'failover' that is being described in the federation plugin documentation is applied when using federation in a cluster, so if the node on which the downstream link is running dies, then another downstream node will take over (i.e., re-establish the links). There is a choice between clustering (i.e., ha/mirror queues) and federation - you do not get 'ha of the upstream cluster' in the same sense that mirror queues in a cluster are 'ha'. You have federated exchanges which copy data using AMQP (with ACKs enabled and some other guarantees) and the ability to try and re-establish links and so. Federation however, provides only the Availability and Partition tolerance parts of the CAP theorem, not the same Consistency guarantees as clustering/ha.
</I>&gt;<i> 
</I>&gt;<i> I did get that, no problem for the downstream side who hold the federation, it works well.
</I>&gt;<i> Question is really : I have two nodes in the &quot;remote&quot; or upstream cluster, I want to get messages of one exchange in a reliable way and the network stream has to be establish by the downstream cluster ; how can I be tolerant to failure of one remote node ? That is what I have called high avaibility on the upstream cluster, but only regarding the transmission of the exchange messages to the downstream cluster.
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have tried to set up two upstream and group them in a upstream set,
</I>&gt;<i> 
</I>&gt;<i> Can you post the configuration you're using to do that?
</I>&gt;<i> 
</I>&gt;<i> The configuration has been done using the HTTP API.
</I>&gt;<i> 
</I>&gt;<i> curl -i -w %{http_code} -k -u &quot;XXX:XXXX&quot; -XPUT -H &quot;content-type:application/json&quot; -d '{
</I>&gt;<i> &quot;pattern&quot;:&quot;downstream-exchange&quot;,&quot;definition&quot;:{&quot;federation-upstream-set&quot;:&quot;upstreamset-test&quot;}
</I>&gt;<i> }' <A HREF="https://localhost:15671/api/policies/%2f/federate-me">https://localhost:15671/api/policies/%2f/federate-me</A>
</I>&gt;<i> 
</I>&gt;<i> curl -i -w %{http_code} -k -u &quot;XXX:XXXX&quot; -XPUT -H &quot;content-type:application/json&quot; -d '{
</I>&gt;<i> &quot;name&quot;:&quot;local-nodename&quot;,&quot;value&quot;:&quot;federation-local&quot;
</I>&gt;<i> }' <A HREF="https://localhost:15671/api/parameters/federation/%2f/local-nodename">https://localhost:15671/api/parameters/federation/%2f/local-nodename</A>
</I>&gt;<i> 
</I>&gt;<i> curl -i -w %{http_code} -u &quot;XXX:XXXX&quot; -k -s -XPUT -H &quot;content-type:application/json&quot; -d &quot;{
</I>&gt;<i>         &quot;value&quot;:{
</I>&gt;<i>             &quot;uri&quot;:\&quot;<A HREF="amqps://XXX:XXX@remote-server1?certfile=XXXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false&quot;">amqps://XXX:XXX@remote-server1?certfile=XXXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false&quot;</A>
</I>&gt;<i>         }
</I>&gt;<i>     }&quot; <A HREF="https://localhost:15671/api/parameters/federation-upstream/%2f/upstream1">https://localhost:15671/api/parameters/federation-upstream/%2f/upstream1</A>
</I>&gt;<i> 
</I>&gt;<i> curl -i -w %{http_code} -u &quot;XXX:XXXX&quot; -k -s -XPUT -H &quot;content-type:application/json&quot; -d &quot;{
</I>&gt;<i>         &quot;value&quot;:{
</I>&gt;<i>             &quot;uri&quot;:\&quot;<A HREF="amqps://XXX:XXX@remote-server2?certfile=XXXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false&quot;">amqps://XXX:XXX@remote-server2?certfile=XXXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false&quot;</A>
</I>&gt;<i>         }
</I>&gt;<i>     }&quot; <A HREF="https://localhost:15671/api/parameters/federation-upstream/%2f/upstream2">https://localhost:15671/api/parameters/federation-upstream/%2f/upstream2</A>
</I>&gt;<i> 
</I>&gt;<i> curl -i -w %{http_code} -k -u &quot;XXX:XXXX&quot; -XPUT -H &quot;content-type:application/json&quot; -d '{
</I>&gt;<i> &quot;value&quot;:[{&quot;upstream&quot;:&quot;upstream1&quot;,&quot;exchange&quot;:&quot;upstream-exchange&quot;},{&quot;upstream&quot;:&quot;upstream2&quot;,&quot;exchange&quot;:&quot;upstream-exchange&quot;}]
</I>&gt;<i> }' <A HREF="https://localhost:15671/api/parameters/federation-upstream-set/%2f/upstreamset-test">https://localhost:15671/api/parameters/federation-upstream-set/%2f/upstreamset-test</A>
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> but I have the following problem :
</I>&gt;<i> - when I shut down one the node, the federation status shows the
</I>&gt;<i> matching upstream down as expected but after having restarted the first
</I>&gt;<i> one, if I shut down the other one, both the federation status shows both
</I>&gt;<i> upstream down
</I>&gt;<i> 
</I>&gt;<i> Just to confirm: you're saying that
</I>&gt;<i> 
</I>&gt;<i> 1. you shut down one of the two upstream nodes
</I>&gt;<i> 2. that node shows up dead in the web interface
</I>&gt;<i> 3. you re-start that node
</I>&gt;<i> 4. that node shows up alive in the web interface
</I>&gt;<i> 5. you shut down the other upstream node
</I>&gt;<i> 6. both nodes show up as dead in the web interface *but*
</I>&gt;<i> 7. one of the upstream nodes *is* alive despite what the web admin says
</I>&gt;<i> 
</I>&gt;<i> Have I understood that correctly?
</I>&gt;<i> 
</I>&gt;<i> Absolutely, you can find an extract of the downstream node log (<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at XXXX.log</A>) at the end of the mail.
</I>&gt;<i> That is not that easy to read but I think there might be an explanation in the logs.
</I>&gt;<i> 
</I>&gt;<i> Case 2 :
</I>&gt;<i> web admin says :
</I>&gt;<i> - upstream1 : running
</I>&gt;<i> - upstream 2 : error (econnrefused)
</I>&gt;<i> Everything is OK
</I>&gt;<i> 
</I>&gt;<i> Case 6 :
</I>&gt;<i> web admin says :
</I>&gt;<i> - upstream1 : error (econnrefused)
</I>&gt;<i> - upstream 2 : shutdown (server_initiated_code,404,&lt;&lt;&quot;NOT_FOUND ...
</I>&gt;<i> the upstream1 (remote-server1) has been shutdown, but not the upstream2 (remote-server2).
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> - so, I tried to add a ha-mode policy to all on the federated queue, it
</I>&gt;<i> is now possible to shutdown either one or the other node,
</I>&gt;<i> 
</I>&gt;<i> I'm not sure I understand this at all. Are you saying it was not possible to shut down one or both of the upstream nodes before? That seems different from your earlier comment.
</I>&gt;<i> 
</I>&gt;<i> My bad ! It is not explained properly. When I was saying &quot;not possible to shutdown&quot;, I meant shutting down the remote node and having the proper status in the federation.
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> but it seems that I'm losing some messages.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When you say 'the federated queue' do you mean the queue created in the upstream exchange's broker? Why would you want to add ha-mode policy that? The upstream queue is internal to the federation mechanism so you should be binding to the downstream exchange only. Or are you saying that you've bound a queue to the downstream exchange and made that ha-enabled? Because in the latter case, that will make no difference to reliability: if both upstream nodes go down before messages are delivered and ack'ed by the downstream for example.
</I>&gt;<i> 
</I>&gt;<i> Yes, &quot;federated queue&quot; is the queue created in the upstream exchange's broker. So, yes, it does not really make sense to add a ha policy, that was just an attempt in order to investigate a little bit further.
</I>&gt;<i> And yes I did bound a ha queue to the downstream exchange, but I agree, it has nothing to do with the subject.
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I'd be interested to hear how you've set this ha-mode policy and why and also how you've determined that there was message loss? I suspect that you have assumed expectations about the reliability of federation (in the face of node failures) that do not hold. If your messages sat in an exchange on an upstream node (or pair of exchanges/nodes, etc) and both nodes die before successfully transmitting the messages, then they will not arrive at the downstream exchange. The guarantees about message delivery for ha/mirror queues apply to nodes in *that* cluster only. The federation guarantees are different and orthogonal to ha/clustering.
</I>&gt;<i> 
</I>&gt;<i> I understand, I just want to make sure that the messages will arrive at the downstream exchange, not duplicated and without loss :
</I>&gt;<i> - if one upstream node dies
</I>&gt;<i> - if there is network failure between downstream and upstream nodes
</I>&gt;<i> - if upstream nodes fail and come back again
</I>&gt;<i> 
</I>&gt;<i> Thanks.
</I>&gt;<i> Vlad
</I>&gt;<i> 
</I>&gt;<i> Extract of logs for case 2 :
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 28-Dec-2012::10:27:08 ===
</I>&gt;<i> Connection (&lt;0.14803.351&gt;) closing: received hard error {'connection.close',
</I>&gt;<i>                                                          320,
</I>&gt;<i>                                                          &lt;&lt;&quot;CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'&quot;&gt;&gt;,
</I>&gt;<i>                                                          0,0} from server
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 28-Dec-2012::10:27:08 ===
</I>&gt;<i> ** Generic server &lt;0.14803.351&gt; terminating
</I>&gt;<i> ** Last message in was {#Ref&lt;0.0.127.4786&gt;,{error,closed}}
</I>&gt;<i> ** When Server state == {state,amqp_network_connection,
</I>&gt;<i>                             {state,
</I>&gt;<i>                                 {ssl_socket,#Port&lt;0.46383&gt;,
</I>&gt;<i>                                     {sslsocket,new_ssl,&lt;0.14806.351&gt;}},
</I>&gt;<i>                                 600,&lt;0.14808.351&gt;,131072,
</I>&gt;<i>                                 {server_initiated_close,320,
</I>&gt;<i>                                     &lt;&lt;&quot;CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'&quot;&gt;&gt;},
</I>&gt;<i>                                 false},
</I>&gt;<i>                             &lt;0.14802.351&gt;,&lt;0.14805.351&gt;,
</I>&gt;<i>                             {amqp_params_network,&lt;&lt;&quot;XXXX&quot;&gt;&gt;,
</I>&gt;<i>                                 &lt;&lt;&quot;XXXX&quot;&gt;&gt;,&lt;&lt;&quot;/&quot;&gt;&gt;,&quot;remote-server2&quot;,5671,0,
</I>&gt;<i>                                 0,0,infinity,
</I>&gt;<i>                                 [{fail_if_no_peer_cert,false},
</I>&gt;<i>                                  {verify,verify_none},
</I>&gt;<i>                                  {keyfile,
</I>&gt;<i>                                      &quot;XXXX&quot;},
</I>&gt;<i>                                  {certfile,
</I>&gt;<i>                                      &quot;XXXX&quot;}],
</I>&gt;<i>                                 [#Fun&lt;amqp_uri.7.123484526&gt;,
</I>&gt;<i>                                  #Fun&lt;amqp_uri.7.123484526&gt;],
</I>&gt;<i>                                 [],[]},
</I>&gt;<i>                             0,
</I>&gt;<i>                             [{&lt;&lt;&quot;capabilities&quot;&gt;&gt;,table,
</I>&gt;<i>                               [{&lt;&lt;&quot;publisher_confirms&quot;&gt;&gt;,bool,true},
</I>&gt;<i>                                {&lt;&lt;&quot;exchange_exchange_bindings&quot;&gt;&gt;,bool,true},
</I>&gt;<i>                                {&lt;&lt;&quot;basic.nack&quot;&gt;&gt;,bool,true},
</I>&gt;<i>                                {&lt;&lt;&quot;consumer_cancel_notify&quot;&gt;&gt;,bool,true}]},
</I>&gt;<i>                              {&lt;&lt;&quot;copyright&quot;&gt;&gt;,longstr,
</I>&gt;<i>                               &lt;&lt;&quot;Copyright (C) 2007-2012 VMware, Inc.&quot;&gt;&gt;},
</I>&gt;<i>                              {&lt;&lt;&quot;information&quot;&gt;&gt;,longstr,
</I>&gt;<i>                               &lt;&lt;&quot;Licensed under the MPL.  See <A HREF="http://www.rabbitmq.com/&quot;">http://www.rabbitmq.com/&quot;</A>&gt;&gt;},
</I>&gt;<i>                              {&lt;&lt;&quot;platform&quot;&gt;&gt;,longstr,&lt;&lt;&quot;Erlang/OTP&quot;&gt;&gt;},
</I>&gt;<i>                              {&lt;&lt;&quot;product&quot;&gt;&gt;,longstr,&lt;&lt;&quot;RabbitMQ&quot;&gt;&gt;},
</I>&gt;<i>                              {&lt;&lt;&quot;version&quot;&gt;&gt;,longstr,&lt;&lt;&quot;3.0.1&quot;&gt;&gt;}],
</I>&gt;<i>                             #Fun&lt;amqp_connection_sup.0.39273983&gt;,
</I>&gt;<i>                             #Fun&lt;amqp_connection_sup.2.54430129&gt;,
</I>&gt;<i>                             {closing,server_initiated_close,
</I>&gt;<i>                                 {'connection.close',320,
</I>&gt;<i>                                     &lt;&lt;&quot;CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'&quot;&gt;&gt;,
</I>&gt;<i>                                     0,0},
</I>&gt;<i>                                 none}}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** socket_closed_unexpectedly
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 28-Dec-2012::10:27:08 ===
</I>&gt;<i> Federation exchange 'downstream-exchange' in vhost '/' disconnected from exchange 'upstream-exchange' in vhost '/' on <A HREF="amqps://XXXX:XXXX@remote-server2?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false">amqps://XXXX:XXXX@remote-server2?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false</A>
</I>&gt;<i> {upstream_channel_down,
</I>&gt;<i>     {connection_closing,
</I>&gt;<i>         {server_initiated_close,320,
</I>&gt;<i>             &lt;&lt;&quot;CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'&quot;&gt;&gt;}}}
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 28-Dec-2012::10:27:08 ===
</I>&gt;<i> Federation exchange 'downstream-exchange' in vhost '/' did not connect to exchange 'upstream-exchange' in vhost '/' on <A HREF="amqps://XXXX:XXXX@remote-server2?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false">amqps://XXXX:XXXX@remote-server2?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false</A>
</I>&gt;<i> {error,econnrefused}
</I>&gt;<i> 
</I>&gt;<i> ==&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at XXXX-sasl.log</A> &lt;==
</I>&gt;<i> 
</I>&gt;<i> =CRASH REPORT==== 28-Dec-2012::10:27:08 ===
</I>&gt;<i>   crasher:
</I>&gt;<i>     initial call: amqp_gen_connection:init/1
</I>&gt;<i>     pid: &lt;0.14803.351&gt;
</I>&gt;<i>     registered_name: []
</I>&gt;<i>     exception exit: socket_closed_unexpectedly
</I>&gt;<i>       in function  gen_server:terminate/6 (gen_server.erl, line 747)
</I>&gt;<i>     ancestors: [&lt;0.14802.351&gt;,amqp_sup,&lt;0.49.0&gt;]
</I>&gt;<i>     messages: []
</I>&gt;<i>     links: [&lt;0.14802.351&gt;]
</I>&gt;<i>     dictionary: []
</I>&gt;<i>     trap_exit: true
</I>&gt;<i>     status: running
</I>&gt;<i>     heap_size: 2584
</I>&gt;<i>     stack_size: 24
</I>&gt;<i>     reductions: 1786
</I>&gt;<i>   neighbours:
</I>&gt;<i> 
</I>&gt;<i> =SUPERVISOR REPORT==== 28-Dec-2012::10:27:08 ===
</I>&gt;<i>      Supervisor: {&lt;0.14802.351&gt;,amqp_connection_sup}
</I>&gt;<i>      Context:    child_terminated
</I>&gt;<i>      Reason:     socket_closed_unexpectedly
</I>&gt;<i>      Offender:   [{pid,&lt;0.14803.351&gt;},
</I>&gt;<i>                   {name,connection},
</I>&gt;<i>                   {mfa,
</I>&gt;<i>                       {amqp_gen_connection,start_link,
</I>&gt;<i>                           [amqp_network_connection,
</I>&gt;<i>                            {amqp_params_network,&lt;&lt;&quot;XXXX&quot;&gt;&gt;,
</I>&gt;<i>                                &lt;&lt;&quot;XXXX&quot;&gt;&gt;,&lt;&lt;&quot;/&quot;&gt;&gt;,&quot;remote-server2&quot;,5671,0,0,
</I>&gt;<i>                                0,infinity,
</I>&gt;<i>                                [{fail_if_no_peer_cert,false},
</I>&gt;<i>                                 {verify,verify_none},
</I>&gt;<i>                                 {keyfile,
</I>&gt;<i>                                     &quot;XXXX&quot;},
</I>&gt;<i>                                 {certfile,
</I>&gt;<i>                                     &quot;XXXX&quot;}],
</I>&gt;<i>                                [#Fun&lt;amqp_uri.7.123484526&gt;,
</I>&gt;<i>                                 #Fun&lt;amqp_uri.7.123484526&gt;],
</I>&gt;<i>                                [],[]},
</I>&gt;<i>                            #Fun&lt;amqp_connection_sup.0.39273983&gt;,
</I>&gt;<i>                            #Fun&lt;amqp_connection_sup.2.54430129&gt;,[]]}},
</I>&gt;<i>                   {restart_type,intrinsic},
</I>&gt;<i>                   {shutdown,brutal_kill},
</I>&gt;<i>                   {child_type,worker}]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> =SUPERVISOR REPORT==== 28-Dec-2012::10:27:08 ===
</I>&gt;<i>      Supervisor: {&lt;0.14802.351&gt;,amqp_connection_sup}
</I>&gt;<i>      Context:    shutdown
</I>&gt;<i>      Reason:     reached_max_restart_intensity
</I>&gt;<i>      Offender:   [{pid,&lt;0.14803.351&gt;},
</I>&gt;<i>                   {name,connection},
</I>&gt;<i>                   {mfa,
</I>&gt;<i>                       {amqp_gen_connection,start_link,
</I>&gt;<i>                           [amqp_network_connection,
</I>&gt;<i>                            {amqp_params_network,&lt;&lt;&quot;XXXX&quot;&gt;&gt;,
</I>&gt;<i>                                &lt;&lt;&quot;XXXX&quot;&gt;&gt;,&lt;&lt;&quot;/&quot;&gt;&gt;,&quot;remote-server2&quot;,5671,0,0,
</I>&gt;<i>                                0,infinity,
</I>&gt;<i>                                [{fail_if_no_peer_cert,false},
</I>&gt;<i>                                 {verify,verify_none},
</I>&gt;<i>                                 {keyfile,
</I>&gt;<i>                                     &quot;XXXX&quot;},
</I>&gt;<i>                                 {certfile,
</I>&gt;<i>                                     &quot;XXXX&quot;}],
</I>&gt;<i>                                [#Fun&lt;amqp_uri.7.123484526&gt;,
</I>&gt;<i>                                 #Fun&lt;amqp_uri.7.123484526&gt;],
</I>&gt;<i>                                [],[]},
</I>&gt;<i>                            #Fun&lt;amqp_connection_sup.0.39273983&gt;,
</I>&gt;<i>                            #Fun&lt;amqp_connection_sup.2.54430129&gt;,[]]}},
</I>&gt;<i>                   {restart_type,intrinsic},
</I>&gt;<i>                   {shutdown,brutal_kill},
</I>&gt;<i>                   {child_type,worker}]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ==&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at XXXX.log</A> &lt;==
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 28-Dec-2012::10:27:10 ===
</I>&gt;<i> Federation exchange 'downstream-exchange' in vhost '/' did not connect to exchange 'upstream-exchange' in vhost '/' on <A HREF="amqps://XXXX:XXXX@remote-server2?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false">amqps://XXXX:XXXX@remote-server2?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false</A>
</I>&gt;<i> {error,econnrefused}
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Extract of logs for case 6 :
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i> Connection (&lt;0.32151.341&gt;) closing: received hard error {'connection.close',
</I>&gt;<i>                                                          320,
</I>&gt;<i>                                                          &lt;&lt;&quot;CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'&quot;&gt;&gt;,
</I>&gt;<i>                                                          0,0} from server
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i> ** Generic server &lt;0.32151.341&gt; terminating
</I>&gt;<i> ** Last message in was {#Ref&lt;0.0.123.217100&gt;,{error,closed}}
</I>&gt;<i> ** When Server state == {state,amqp_network_connection,
</I>&gt;<i>                             {state,
</I>&gt;<i>                                 {ssl_socket,#Port&lt;0.45661&gt;,
</I>&gt;<i>                                     {sslsocket,new_ssl,&lt;0.32161.341&gt;}},
</I>&gt;<i>                                 600,&lt;0.32170.341&gt;,131072,
</I>&gt;<i>                                 {server_initiated_close,320,
</I>&gt;<i>                                     &lt;&lt;&quot;CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'&quot;&gt;&gt;},
</I>&gt;<i>                                 false},
</I>&gt;<i>                             &lt;0.32149.341&gt;,&lt;0.32154.341&gt;,
</I>&gt;<i>                             {amqp_params_network,&lt;&lt;&quot;XXXX&quot;&gt;&gt;,
</I>&gt;<i>                                 &lt;&lt;&quot;XXXX&quot;&gt;&gt;,&lt;&lt;&quot;/&quot;&gt;&gt;,&quot;remote-server1&quot;,5671,0,
</I>&gt;<i>                                 0,0,infinity,
</I>&gt;<i>                                 [{fail_if_no_peer_cert,false},
</I>&gt;<i>                                  {verify,verify_none},
</I>&gt;<i>                                  {keyfile,
</I>&gt;<i>                                      &quot;XXXX&quot;},
</I>&gt;<i>                                  {certfile,
</I>&gt;<i>                                      &quot;XXXX&quot;}],
</I>&gt;<i>                                 [#Fun&lt;amqp_uri.7.123484526&gt;,
</I>&gt;<i>                                  #Fun&lt;amqp_uri.7.123484526&gt;],
</I>&gt;<i>                                 [],[]},
</I>&gt;<i>                             0,
</I>&gt;<i>                             [{&lt;&lt;&quot;capabilities&quot;&gt;&gt;,table,
</I>&gt;<i>                               [{&lt;&lt;&quot;publisher_confirms&quot;&gt;&gt;,bool,true},
</I>&gt;<i>                                {&lt;&lt;&quot;exchange_exchange_bindings&quot;&gt;&gt;,bool,true},
</I>&gt;<i>                                {&lt;&lt;&quot;basic.nack&quot;&gt;&gt;,bool,true},
</I>&gt;<i>                                {&lt;&lt;&quot;consumer_cancel_notify&quot;&gt;&gt;,bool,true}]},
</I>&gt;<i>                              {&lt;&lt;&quot;copyright&quot;&gt;&gt;,longstr,
</I>&gt;<i>                               &lt;&lt;&quot;Copyright (C) 2007-2012 VMware, Inc.&quot;&gt;&gt;},
</I>&gt;<i>                              {&lt;&lt;&quot;information&quot;&gt;&gt;,longstr,
</I>&gt;<i>                               &lt;&lt;&quot;Licensed under the MPL.  See <A HREF="http://www.rabbitmq.com/&quot;">http://www.rabbitmq.com/&quot;</A>&gt;&gt;},
</I>&gt;<i>                              {&lt;&lt;&quot;platform&quot;&gt;&gt;,longstr,&lt;&lt;&quot;Erlang/OTP&quot;&gt;&gt;},
</I>&gt;<i>                              {&lt;&lt;&quot;product&quot;&gt;&gt;,longstr,&lt;&lt;&quot;RabbitMQ&quot;&gt;&gt;},
</I>&gt;<i>                              {&lt;&lt;&quot;version&quot;&gt;&gt;,longstr,&lt;&lt;&quot;3.0.1&quot;&gt;&gt;}],
</I>&gt;<i>                             #Fun&lt;amqp_connection_sup.0.39273983&gt;,
</I>&gt;<i>                             #Fun&lt;amqp_connection_sup.2.54430129&gt;,
</I>&gt;<i>                             {closing,server_initiated_close,
</I>&gt;<i>                                 {'connection.close',320,
</I>&gt;<i>                                     &lt;&lt;&quot;CONNECTION_FORCED - broker forced connection closure with reason 'shutdown'&quot;&gt;&gt;,
</I>&gt;<i>                                     0,0},
</I>&gt;<i>                                 none}}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** socket_closed_unexpectedly
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i> ** Generic server &lt;0.32126.341&gt; terminating
</I>&gt;<i> ** Last message in was {'DOWN',#Ref&lt;0.0.123.217187&gt;,process,&lt;0.32193.341&gt;,
</I>&gt;<i>                                shutdown}
</I>&gt;<i> ** When Server state == {state,
</I>&gt;<i>                          {upstream,
</I>&gt;<i>                           {amqp_params_network,&lt;&lt;&quot;XXXX&quot;&gt;&gt;,
</I>&gt;<i>                            &lt;&lt;&quot;XXXX&quot;&gt;&gt;,&lt;&lt;&quot;/&quot;&gt;&gt;,&quot;remote-server1&quot;,undefined,0,
</I>&gt;<i>                            0,0,infinity,
</I>&gt;<i>                            [{fail_if_no_peer_cert,false},
</I>&gt;<i>                             {verify,verify_none},
</I>&gt;<i>                             {keyfile,
</I>&gt;<i>                              &quot;XXXX&quot;},
</I>&gt;<i>                             {certfile,
</I>&gt;<i>                              &quot;XXXX&quot;}],
</I>&gt;<i>                            [#Fun&lt;amqp_uri.7.123484526&gt;,
</I>&gt;<i>                             #Fun&lt;amqp_uri.7.123484526&gt;],
</I>&gt;<i>                            [],[]},
</I>&gt;<i>                           &lt;&lt;&quot;<A HREF="amqps://XXXX:XXXX@remote-server1?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false&quot;">amqps://XXXX:XXXX@remote-server1?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false&quot;</A>&gt;&gt;,
</I>&gt;<i>                           {exchange,
</I>&gt;<i>                            {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;upstream-exchange&quot;&gt;&gt;},
</I>&gt;<i>                            direct,true,false,false,[],undefined,
</I>&gt;<i>                            [{vhost,&lt;&lt;&quot;/&quot;&gt;&gt;},
</I>&gt;<i>                             {name,&lt;&lt;&quot;federate-me&quot;&gt;&gt;},
</I>&gt;<i>                             {pattern,&lt;&lt;&quot;downstream-exchange&quot;&gt;&gt;},
</I>&gt;<i>                             {definition,
</I>&gt;<i>                              [{&lt;&lt;&quot;federation-upstream-set&quot;&gt;&gt;,
</I>&gt;<i>                                &lt;&lt;&quot;upstreamset-test&quot;&gt;&gt;}]},
</I>&gt;<i>                             {priority,0}]},
</I>&gt;<i>                           1000,1,1,none,none,false,none,&lt;&lt;&quot;upstream1&quot;&gt;&gt;},
</I>&gt;<i>                          &lt;0.32151.341&gt;,&lt;0.32193.341&gt;,
</I>&gt;<i>                          &lt;&lt;&quot;amq.ctag-iCWCgBnLBU7S3cWTi06V1A&quot;&gt;&gt;,
</I>&gt;<i>                          &lt;&lt;&quot;federation: upstream-exchange -&gt; federation-local:downstream-exchange&quot;&gt;&gt;,
</I>&gt;<i>                          &lt;&lt;&quot;federation: upstream-exchange -&gt; federation-local:downstream-exchange B&quot;&gt;&gt;,
</I>&gt;<i>                          {0,nil},
</I>&gt;<i>                          1,
</I>&gt;<i>                          {dict,1,16,16,8,80,48,
</I>&gt;<i>                           {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
</I>&gt;<i>                           {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                             [[{&lt;&lt;&quot;test&quot;&gt;&gt;,[]}|
</I>&gt;<i>                               {set,1,16,16,8,80,48,
</I>&gt;<i>                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
</I>&gt;<i>                                 []},
</I>&gt;<i>                                {{[],[],[],[],
</I>&gt;<i>                                  [{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,
</I>&gt;<i>                                    &lt;&lt;&quot;downstream-queue&quot;&gt;&gt;}],
</I>&gt;<i>                                  [],[],[],[],[],[],[],[],[],[],[]}}}]]}}},
</I>&gt;<i>                          &lt;0.32129.341&gt;,&lt;0.32141.341&gt;,
</I>&gt;<i>                          {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;downstream-exchange&quot;&gt;&gt;},
</I>&gt;<i>                          {0,nil}}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** {upstream_channel_down,shutdown}
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i> Federation exchange 'downstream-exchange' in vhost '/' received 'basic.cancel'
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i> Federation exchange 'downstream-exchange' in vhost '/' did not connect to exchange 'upstream-exchange' in vhost '/' on <A HREF="amqps://XXXX:XXXX@remote-server1?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false">amqps://XXXX:XXXX@remote-server1?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false</A>
</I>&gt;<i> {error,econnrefused}
</I>&gt;<i> 
</I>&gt;<i> ==&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at XXXX-sasl.log</A> &lt;==
</I>&gt;<i> 
</I>&gt;<i> =CRASH REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i>   crasher:
</I>&gt;<i>     initial call: amqp_gen_connection:init/1
</I>&gt;<i>     pid: &lt;0.32151.341&gt;
</I>&gt;<i>     registered_name: []
</I>&gt;<i>     exception exit: socket_closed_unexpectedly
</I>&gt;<i>       in function  gen_server:terminate/6 (gen_server.erl, line 747)
</I>&gt;<i>     ancestors: [&lt;0.32149.341&gt;,amqp_sup,&lt;0.49.0&gt;]
</I>&gt;<i>     messages: [socket_closed]
</I>&gt;<i>     links: [&lt;0.32149.341&gt;]
</I>&gt;<i>     dictionary: []
</I>&gt;<i>     trap_exit: true
</I>&gt;<i>     status: running
</I>&gt;<i>     heap_size: 2584
</I>&gt;<i>     stack_size: 24
</I>&gt;<i>     reductions: 1794
</I>&gt;<i>   neighbours:
</I>&gt;<i> 
</I>&gt;<i> =SUPERVISOR REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i>      Supervisor: {&lt;0.32149.341&gt;,amqp_connection_sup}
</I>&gt;<i>      Context:    child_terminated
</I>&gt;<i>      Reason:     socket_closed_unexpectedly
</I>&gt;<i>      Offender:   [{pid,&lt;0.32151.341&gt;},
</I>&gt;<i>                   {name,connection},
</I>&gt;<i>                   {mfa,
</I>&gt;<i>                       {amqp_gen_connection,start_link,
</I>&gt;<i>                           [amqp_network_connection,
</I>&gt;<i>                            {amqp_params_network,&lt;&lt;&quot;XXXX&quot;&gt;&gt;,
</I>&gt;<i>                                &lt;&lt;&quot;XXXX&quot;&gt;&gt;,&lt;&lt;&quot;/&quot;&gt;&gt;,&quot;remote-server1&quot;,5671,0,0,
</I>&gt;<i>                                0,infinity,
</I>&gt;<i>                                [{fail_if_no_peer_cert,false},
</I>&gt;<i>                                 {verify,verify_none},
</I>&gt;<i>                                 {keyfile,
</I>&gt;<i>                                     &quot;XXXX&quot;},
</I>&gt;<i>                                 {certfile,
</I>&gt;<i>                                     &quot;XXXX&quot;}],
</I>&gt;<i>                                [#Fun&lt;amqp_uri.7.123484526&gt;,
</I>&gt;<i>                                 #Fun&lt;amqp_uri.7.123484526&gt;],
</I>&gt;<i>                                [],[]},
</I>&gt;<i>                            #Fun&lt;amqp_connection_sup.0.39273983&gt;,
</I>&gt;<i>                            #Fun&lt;amqp_connection_sup.2.54430129&gt;,[]]}},
</I>&gt;<i>                   {restart_type,intrinsic},
</I>&gt;<i>                   {shutdown,brutal_kill},
</I>&gt;<i>                   {child_type,worker}]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> =SUPERVISOR REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i>      Supervisor: {&lt;0.32149.341&gt;,amqp_connection_sup}
</I>&gt;<i>      Context:    shutdown
</I>&gt;<i>      Reason:     reached_max_restart_intensity
</I>&gt;<i>      Offender:   [{pid,&lt;0.32151.341&gt;},
</I>&gt;<i>                   {name,connection},
</I>&gt;<i>                   {mfa,
</I>&gt;<i>                       {amqp_gen_connection,start_link,
</I>&gt;<i>                           [amqp_network_connection,
</I>&gt;<i>                            {amqp_params_network,&lt;&lt;&quot;XXXX&quot;&gt;&gt;,
</I>&gt;<i>                                &lt;&lt;&quot;XXXX&quot;&gt;&gt;,&lt;&lt;&quot;/&quot;&gt;&gt;,&quot;remote-server1&quot;,5671,0,0,
</I>&gt;<i>                                0,infinity,
</I>&gt;<i>                                [{fail_if_no_peer_cert,false},
</I>&gt;<i>                                 {verify,verify_none},
</I>&gt;<i>                                 {keyfile,
</I>&gt;<i>                                     &quot;XXXX&quot;},
</I>&gt;<i>                                 {certfile,
</I>&gt;<i>                                     &quot;XXXX&quot;}],
</I>&gt;<i>                                [#Fun&lt;amqp_uri.7.123484526&gt;,
</I>&gt;<i>                                 #Fun&lt;amqp_uri.7.123484526&gt;],
</I>&gt;<i>                                [],[]},
</I>&gt;<i>                            #Fun&lt;amqp_connection_sup.0.39273983&gt;,
</I>&gt;<i>                            #Fun&lt;amqp_connection_sup.2.54430129&gt;,[]]}},
</I>&gt;<i>                   {restart_type,intrinsic},
</I>&gt;<i>                   {shutdown,brutal_kill},
</I>&gt;<i>                   {child_type,worker}]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> =CRASH REPORT==== 28-Dec-2012::10:16:42 ===
</I>&gt;<i>   crasher:
</I>&gt;<i>     initial call: gen:init_it/6
</I>&gt;<i>     pid: &lt;0.32126.341&gt;
</I>&gt;<i>     registered_name: []
</I>&gt;<i>     exception exit: {upstream_channel_down,shutdown}
</I>&gt;<i>       in function  gen_server2:terminate/3
</I>&gt;<i>     ancestors: [&lt;0.32125.341&gt;,&lt;0.218.0&gt;,rabbit_federation_link_sup_sup,
</I>&gt;<i>                   rabbit_federation_sup,rabbit_sup,&lt;0.165.0&gt;]
</I>&gt;<i>     messages: [{'DOWN',#Ref&lt;0.0.123.217038&gt;,process,&lt;0.32141.341&gt;,normal}]
</I>&gt;<i>     links: [&lt;0.32125.341&gt;]
</I>&gt;<i>     dictionary: []
</I>&gt;<i>     trap_exit: true
</I>&gt;<i>     status: running
</I>&gt;<i>     heap_size: 1597
</I>&gt;<i>     stack_size: 24
</I>&gt;<i>     reductions: 2291192
</I>&gt;<i>   neighbours:
</I>&gt;<i> 
</I>&gt;<i> ==&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at XXXX.log</A> &lt;==
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 28-Dec-2012::10:16:44 ===
</I>&gt;<i> Federation exchange 'downstream-exchange' in vhost '/' did not connect to exchange 'upstream-exchange' in vhost '/' on <A HREF="amqps://XXXX:XXXX@remote-server1?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false">amqps://XXXX:XXXX@remote-server1?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false</A>
</I>&gt;<i> {error,econnrefused}
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 28-Dec-2012::10:16:46 ===
</I>&gt;<i> Federation exchange 'downstream-exchange' in vhost '/' did not connect to exchange 'upstream-exchange' in vhost '/' on <A HREF="amqps://XXXX:XXXX@remote-server2?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false">amqps://XXXX:XXXX@remote-server2?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false</A>
</I>&gt;<i> {{shutdown,{server_initiated_close,404,
</I>&gt;<i>                                    &lt;&lt;&quot;NOT_FOUND - home node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at remote-server1</A>' of durable queue 'federation: upstream-exchange -&gt; federation-local:downstream-exchange' in vhost '/' is down or inaccessible&quot;&gt;&gt;}},
</I>&gt;<i>  {gen_server,call,
</I>&gt;<i>              [&lt;0.7847.351&gt;,
</I>&gt;<i>               {call,{'queue.declare',0,
</I>&gt;<i>                                      &lt;&lt;&quot;federation: upstream-exchange -&gt; federation-local:downstream-exchange&quot;&gt;&gt;,
</I>&gt;<i>                                      false,true,false,false,false,[]},
</I>&gt;<i>                     none,&lt;0.7815.351&gt;},
</I>&gt;<i>               infinity]}}
</I>&gt;<i> 
</I>&gt;<i> =WARNING REPORT==== 28-Dec-2012::10:16:48 ===
</I>&gt;<i> Federation exchange 'downstream-exchange' in vhost '/' did not connect to exchange 'upstream-exchange' in vhost '/' on <A HREF="amqps://XXXX:XXXX@remote-server1?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false">amqps://XXXX:XXXX@remote-server1?certfile=XXXX&amp;keyfile=XXXX&amp;verify=verify_none&amp;fail_if_no_peer_cert=false</A>
</I>&gt;<i> {error,econnrefused}
</I>&gt;<i> 
</I>
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024689.html">[rabbitmq-discuss] Federation and upstream cluster
</A></li>
	<LI>Next message: <A HREF="024691.html">[rabbitmq-discuss] Federation and upstream cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24690">[ date ]</a>
              <a href="thread.html#24690">[ thread ]</a>
              <a href="subject.html#24690">[ subject ]</a>
              <a href="author.html#24690">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
