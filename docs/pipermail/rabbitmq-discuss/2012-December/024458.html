<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Creating an auth plugin (Kerberos)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Creating%20an%20auth%20plugin%20%28Kerberos%29&In-Reply-To=%3C20121211185019.GF754%40kaka.it.su.se%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024456.html">
   <LINK REL="Next"  HREF="024457.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Creating an auth plugin (Kerberos)</H1>
    <B>Simon Lundstr&#246;m</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Creating%20an%20auth%20plugin%20%28Kerberos%29&In-Reply-To=%3C20121211185019.GF754%40kaka.it.su.se%3E"
       TITLE="[rabbitmq-discuss] Creating an auth plugin (Kerberos)">simlu at su.se
       </A><BR>
    <I>Tue Dec 11 18:50:19 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024456.html">[rabbitmq-discuss] Creating an auth plugin (Kerberos)
</A></li>
        <LI>Next message: <A HREF="024457.html">[rabbitmq-discuss] Creating an auth plugin (Kerberos)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24458">[ date ]</a>
              <a href="thread.html#24458">[ thread ]</a>
              <a href="subject.html#24458">[ subject ]</a>
              <a href="author.html#24458">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 2012-12-11 at 17:13:50 +0000, Tim Watson wrote:
&gt;<i> HOLD ON.
</I>&gt;<i> 
</I>&gt;<i> If your plugin is packaged as an .ez file (which rabbit plugins usually are) then I wonder if the .so file is not accessible?
</I>
I don't think this is it, because...

&gt;<i> This is a known issue with drivers, as no operating system I know of will allow dynamic loading from a non file system location. On the other hand, I think rabbit unpacks plugins that are enabled into RABBITMQ_PLUGINS_EXPAND_DIR - can you see the dynamic library (.so or .dylib) file in there?
</I>
..I see my .so there and if I use a static path it &quot;works&quot;.

&gt;<i> Anyway, my suspicion is that when you're loading the NIF, it is not in the file system location you think it is. This could be because of the way plugins are expanded, but I'm just guessing there TBH. More likely perhaps, the name that you pass to code:priv_dir/1 is wrong. You're currently using `begin {ok, A} = application:get_application(?MODULE), A end` and I wonder if that's returning what you think it is? And *also* do you know if the application is actually fully loaded (and its environment setup correctly in the erlang node's application controller) at the time which the on_load target is being called? Perhaps calling application:get_env/1 is  not such a good idea when initialising a NIF.
</I>
This is almost what I suspect happens, but...

&gt;<i> Instead of doing that, try hard coding it:
</I>&gt;<i> 
</I>&gt;<i> init() -&gt;
</I>&gt;<i>   Kinit = filename:join(code:priv_dir(rabbit_auth_backend_kerberos), &quot;/kinit.so&quot;),
</I>&gt;<i>   erlang:load_nif(Kinit, 0).
</I>
..this code how ever doesn't work. It gives me:

=ERROR REPORT==== 11-Dec-2012::19:42:17 ===
NEIN: {error,bad_name}

=ERROR REPORT==== 11-Dec-2012::19:42:17 ===
Error in process &lt;0.346.0&gt; on node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-test-disk01.it.su.se</A>' with exit value: {function_clause,[{filename,join,[{error,bad_na
me},&quot;/kinit.so&quot;]},{rabbit_auth_backend_kerberos,init,0},{code_server,'-handle_on_load/4-fun-0-',1}]}

when I use the following code:
&lt;<A HREF="https://github.com/simmel/rabbitmq-auth-backend-kerberos/blob/b7b719ec3a/src/rabbit_auth_backend_kerberos.erl#L12-L16">https://github.com/simmel/rabbitmq-auth-backend-kerberos/blob/b7b719ec3a/src/rabbit_auth_backend_kerberos.erl#L12-L16</A>&gt;

I'm thinking my module isn't loaded yet and so that's why it doesn't appear in the list of loaded apps/modules.

If I use a static path I get the same error message(s) as I said before (&quot;undefined function rabbit_auth_backend_kerberos:check_user_login/2&quot;).

I'll try your other suggestion to put kinit in a seperate module.

Thanks,
- Simon
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024456.html">[rabbitmq-discuss] Creating an auth plugin (Kerberos)
</A></li>
	<LI>Next message: <A HREF="024457.html">[rabbitmq-discuss] Creating an auth plugin (Kerberos)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24458">[ date ]</a>
              <a href="thread.html#24458">[ thread ]</a>
              <a href="subject.html#24458">[ subject ]</a>
              <a href="author.html#24458">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
