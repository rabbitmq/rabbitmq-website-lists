<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ Cluster On AWS VPC
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Cluster%20On%20AWS%20VPC&In-Reply-To=%3CCCF0B735.6D69%25Michael.Laing%40nytimes.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024496.html">
   <LINK REL="Next"  HREF="024542.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ Cluster On AWS VPC</H1>
    <B>Laing, Michael P.</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Cluster%20On%20AWS%20VPC&In-Reply-To=%3CCCF0B735.6D69%25Michael.Laing%40nytimes.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ Cluster On AWS VPC">Michael.Laing at nytimes.com
       </A><BR>
    <I>Fri Dec 14 17:27:05 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024496.html">[rabbitmq-discuss] RabbitMQ Cluster On AWS VPC
</A></li>
        <LI>Next message: <A HREF="024542.html">[rabbitmq-discuss] RabbitMQ Cluster On AWS VPC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24512">[ date ]</a>
              <a href="thread.html#24512">[ thread ]</a>
              <a href="subject.html#24512">[ subject ]</a>
              <a href="author.html#24512">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We have not yet seen any performance issues. All traffic between instances in different availability zones within a region is charged: $.01/GB in us-east-1. So there is a cost, and the volume of traffic through your HA queues has an impact.

In us-east-1, the increase in latency by going across zones is &lt; 10ms, in our small sample. We will add some continuous testing of this in the future across all zones.

Regions may vary in the amount of latency. And latency may vary (jitter).

*Rather then LAN vs WAN, it would be useful to know the design envelope for rabbitmq clusters in terms of latency and jitter, as these are measurable. Also if there is tuning that can be done.

All that said, I may choose to use federation rather than clustering across zones, because the rabbitmq response to a net split is so catastrophic, apparently, and I am not sure I want to live with that uncertainty in production. We are architected in such a way that we can do either with minor modifications. We would run a cluster in each zone and federate the clusters. It's more expensive though and more moving parts.

We use DynamoDB and Riak as reliable KV stores, as well as s3. Riak seems to have good tolerance of net splits. (*Why is it better than rabbitmq in this respect?)

The 'usual' failure mode in an AWS region is that a zone becomes 'compromised', meaning that some or all instances become unreachable and/or unresponsive. We would normally have 3 clustered nodes in different zones in the region. In this scenario, we would expect to lose a node completely and have it drop from the 'wholesale' Elastic Load Balancers. We would also lose all the other instances in that zone depending upon that node &#8211; they would drop from the 'retail' Elastic Load Balancers.

An often under-reported syndrome of zone failure in a region is that the regional 'control plane' is usually compromised as well. This means that one cannot create new instances, load balancers, volumes, etc. across the entire region (all zones). Hence you cannot rely on being able to add new resources to the zones that have not failed. This affects your capacity planning etc.

Hence, in the 'short' term, both wholesale and client apps reconnect via the ELBs to existing resources in the 'good' zones, which have been sized to handle this scenario.

At the same time, we start re-routing new connections to other healthy regions by automatically adjusting Route 53 weighted routing parameters, which are normally set to route only using least latency. The other regions will autoscale resources to handle the load. For example, us-east-1 is backed up by splitting its load between us-west-2 and eu-west-1. If necessary, we will also gradually shed the existing load from the compromised region by causing clients to reconnect.

Best regards,

Michael

From: &#29579;&#20426;&#27874; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wangjunbo924 at gmail.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">wangjunbo924 at gmail.com</A>&gt;&gt;
Reply-To: rabbitmq &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;&gt;
Date: Thu, 13 Dec 2012 20:14:09 -0500
To: rabbitmq &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;&gt;
Subject: Re: [rabbitmq-discuss] RabbitMQ Cluster On AWS VPC

Hi Laing, Is there any performance issue?
And I believe that it's much more expensive to build cluster across AWS zones. Does it?
One another question, I'm wondering how to connect to the cluster in your experience? A Load Balancer before cluster or DNS Round Robin or the Java Client Libraries only?


2012/12/13 Laing, Michael P. &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">Michael.Laing at nytimes.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">Michael.Laing at nytimes.com</A>&gt;&gt;
Clustering across AWS availability zones works fine in our experience so
far.

ml

On 12/13/12 5:48 AM, &quot;Simon MacMullen&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt; wrote:

&gt;<i>On 13/12/12 10:44, &#29579;&#20426;&#27874; wrote:
</I>&gt;&gt;<i> We are going to build RabbitMQ cluster with HA on AWS VPC. Suppose there
</I>&gt;&gt;<i> are two subnets in the VPC, and they are in different available zones(
</I>&gt;&gt;<i> for more info about AWS available zone, please visit:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i><A HREF="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/using-regions-a">http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/using-regions-a</A>
</I>&gt;&gt;<i>vailability-zones.html).
</I>&gt;&gt;<i>   Then I launch instances in both subnets:
</I>&gt;&gt;<i> instance X in subnet1(in AWS zone us-east-1a)
</I>&gt;&gt;<i> instance Y in subnet2(in AWS zone us-east-1b)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So can I create a RabbitMQ cluster with HA consisting of both X and Y?
</I>&gt;<i>
</I>&gt;<i>This is a bad idea - RabbitMQ clusters do not tolerate network
</I>&gt;<i>partitions well. Read <A HREF="http://www.rabbitmq.com/partitions.html">http://www.rabbitmq.com/partitions.html</A> for more
</I>&gt;<i>information.
</I>&gt;<i>
</I>&gt;&gt;<i> Another question is about federation plugin. If I build federation links
</I>&gt;&gt;<i> for X and Y symmetrically with max-hop=1, is there any way that whenever
</I>&gt;&gt;<i> a message is consumed from node X then the corresponding one in node Y
</I>&gt;&gt;<i> is dequeued automatically with no client actually consuming it?
</I>&gt;<i>
</I>&gt;<i>No, I'm afraid not.
</I>&gt;<i>
</I>&gt;<i>Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>--
</I>&gt;<i>Simon MacMullen
</I>&gt;<i>RabbitMQ, VMware
</I>&gt;<i>_______________________________________________
</I>&gt;<i>rabbitmq-discuss mailing list
</I>&gt;<i><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121214/0439798c/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121214/0439798c/attachment.htm</A>&gt;
</PRE>











































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024496.html">[rabbitmq-discuss] RabbitMQ Cluster On AWS VPC
</A></li>
	<LI>Next message: <A HREF="024542.html">[rabbitmq-discuss] RabbitMQ Cluster On AWS VPC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24512">[ date ]</a>
              <a href="thread.html#24512">[ thread ]</a>
              <a href="subject.html#24512">[ subject ]</a>
              <a href="author.html#24512">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
