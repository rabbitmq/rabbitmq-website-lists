<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Automating%20a%20RabbitMQ%203.0%20cluster%20on%20EC2&In-Reply-To=%3CFCE85C15E7F94F3392318548DE2E6634%40paperplanes.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024672.html">
   <LINK REL="Next"  HREF="024721.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2</H1>
    <B>Mathias Meyer</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Automating%20a%20RabbitMQ%203.0%20cluster%20on%20EC2&In-Reply-To=%3CFCE85C15E7F94F3392318548DE2E6634%40paperplanes.de%3E"
       TITLE="[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2">meyer at paperplanes.de
       </A><BR>
    <I>Fri Dec 28 11:26:52 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024672.html">[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
</A></li>
        <LI>Next message: <A HREF="024721.html">[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24692">[ date ]</a>
              <a href="thread.html#24692">[ thread ]</a>
              <a href="subject.html#24692">[ subject ]</a>
              <a href="author.html#24692">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Francesco,

Thanks for the answers, I've added some clarification below.

On Monday, 24. December 2012 at 12:31, Francesco Mazzoli wrote:
&gt;<i>  
</I>&gt;<i> Uhm, two things:
</I>&gt;<i>  
</I>&gt;<i> * RabbitMQ does not like FQDNs - I think you can probably make it work by
</I>&gt;<i> tweaking the startup scripts, but I am not sure. What we recommend is not
</I>&gt;<i> to use FQDNs.
</I>&gt;<i> * If you change the hostname and restart RabbitMQ, things should go smoothly.
</I>&gt;<i>  
</I>&gt;<i> That said, I&#8217;m not sure what DHCP has to do with this. I suppose that what you
</I>&gt;<i> have done is to make possible to resolve the short names of the other nodes,
</I>&gt;<i> since things are working.
</I>&gt;<i>  
</I>Sorry that I wasn't more clear on this. The reference to DHCP is my way of updating either the /etc/hosts file or /etc/resolv.conf. EC2 instances use DHCP to get their network settings, and the DHCP client is responsible for writing things like /etc/resolv.conf, so I used that mechanism to mix in our own domain to search in.

Good to know about the FQDN, I'll leave things as they are then.

Regarding changing the host name, I tried that, and from my experiments, that didn't seem to work properly. But that might have been related again to the hostname temporarily not being resolvable.  
&gt;<i>  
</I>&gt;<i> The behaviour you describe is correct. The `cluster_nodes' list is only
</I>&gt;<i> effective on &#8220;virgin&#8221; nodes, that is nodes that are started for the first time.
</I>&gt;<i> If the node can&#8217;t connect to any other node it won&#8217;t do anything. The rationale
</I>&gt;<i> behind that comes from boring technicalities related to how mnesia (the database
</I>&gt;<i> that backs RabbitMQ clustering) works, and most importantly the fact that
</I>&gt;<i> clustered nodes shouldn&#8217;t experience netsplits. So if you say &#8220;Should a new
</I>&gt;<i> node be partitioned from the others only temporarily...&#8221;, maybe clustering is
</I>&gt;<i> not the right solution.
</I>&gt;<i>  
</I>The partitioning was mostly conjecture. It might happen, and it's still fixable if it does. The whole mechanism just strikes me as less than ideal when it comes to automating a cluster setup.  
&gt;<i>  
</I>&gt;<i> Again, I&#8217;m don&#8217;t see how DHCP has anything to do with this.
</I>&gt;<i>  
</I>Same as above :)
&gt;<i> I don&#8217;t know anything about EC2 or Chef, and I don&#8217;t understand what you are
</I>&gt;<i> doing with DHCP, but I&#8217;m quite sure you&#8217;re mixing up two separated issues: one
</I>&gt;<i> is related to FQDNs and how nodes resolve other node names, and the other is
</I>&gt;<i> related to how the automatic clustering configuration works.
</I>&gt;<i>  
</I>They might seem different on the surface, but given how the RabbitMQ package installer works, they bot converge into the issue of automating and customizing a cluster setup.  
&gt;<i>  
</I>&gt;<i> For what concerns the former, RabbitMQ nodes will use unqualified names (unless
</I>&gt;<i> you are tweaking how RabbitMQ nodes are started up), so you&#8217;ll have to play by
</I>&gt;<i> that. Obviously you&#8217;ll have to make the unqualified names resolve correctly on
</I>&gt;<i> each node, e.g. by adding entries in the hosts file.
</I>&gt;<i>  
</I>&gt;<i> For what concerns the latter, if you are confident that netsplits won&#8217;t occur,
</I>&gt;<i> then the semantics of the `cluster_nodes' configuration should be fine. If that
</I>&gt;<i> is not the case you might need to hack up some other mechanism but I would
</I>&gt;<i> advise against that because
</I>&gt;<i>  
</I>&gt;<i> 1. It&#8217;s easy to get wrong, clustering is quite delicate and there are many
</I>&gt;<i> subtleties.
</I>
Are all of them documented? Looking at the documentation, it seems to be mostly straight-forward, except for the netsplits. If there are that many subtleties, I sure wish they'd be mentioned properly in the documentation.
&gt;<i> 2. If you are on a network that is affected by netsplits, you should avoid
</I>&gt;<i> clustering anyway - see &lt;<A HREF="http://www.rabbitmq.com/clustering.html">http://www.rabbitmq.com/clustering.html</A>&gt;.
</I>&gt;<i>  
</I>The cluster is going to run with all nodes in a single available zone. Netsplits are unavoidable in any network but are less likely to happen in a setup like that.

My biggest question still remains unanswered unfortunately: how do folks go about automating a cluster setup, with or without the issues described in my original email?

Any input on that particular topic would be much appreciated.

Thanks!

Cheers, Mathias  


On Monday, 24. December 2012 at 12:31, Francesco Mazzoli wrote:

&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> Hi Mathias,
</I>&gt;<i>  
</I>&gt;<i> At Thu, 20 Dec 2012 15:48:05 +0100,
</I>&gt;<i> Mathias Meyer wrote:
</I>&gt;<i> &gt; I spent some quality time automating a cluster setup of 3.0.1 on EC2 over the
</I>&gt;<i> &gt; last couple of days, and came across some things that felt a bit odd to
</I>&gt;<i> &gt; me. Maybe I did it all wrong, happy to be proven that I did. I apologize if
</I>&gt;<i> &gt; this turns out a bit long, there are a couple of questions that boil down to a
</I>&gt;<i> &gt; similar issue. Would be curious to hear how other folks have solved this
</I>&gt;<i> &gt; issue, and mostly focussing on RabbitMQ 3.0, as, from what I've read,
</I>&gt;<i> &gt; clustering behaviour has changed with that release.
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; First a whee bit about the setup, nothing special really, but required to
</I>&gt;<i> &gt; clarify some of the questions below: every node has a custom CNAME record
</I>&gt;<i> &gt; rabbitmq1.domain.com (<A HREF="http://rabbitmq1.domain.com">http://rabbitmq1.domain.com</A>), rabbitmq2.domain.com (<A HREF="http://rabbitmq2.domain.com">http://rabbitmq2.domain.com</A>), each pointing to the EC2 host
</I>&gt;<i> &gt; name. I do this because I prefer full hostnames over EC2 hostnames because it
</I>&gt;<i> &gt; adds clarity to the whole setup, at least for me :)
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; The first issue with this setup comes up when you want to change the hostname
</I>&gt;<i> &gt; for the RabbitMQ node. Changing it post-installation is a bit of a hassle
</I>&gt;<i> &gt; because the package already starts up the service. Changing the nodename to
</I>&gt;<i> &gt; the FQDN and trying to restart the service after that leads to errors because
</I>&gt;<i> &gt; the service can't be stopped anymore as the nodenames are now different.
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; I solved this on EC2 by adding domain.com (<A HREF="http://domain.com">http://domain.com</A>) to the DHCP configuration and
</I>&gt;<i> &gt; restarting the network before installing the RabbitMQ package. It's not a
</I>&gt;<i> &gt; great solution, but acceptable. In the end it boils down to the package
</I>&gt;<i> &gt; starting the service immediately on installation, more on that below.
</I>&gt;<i> &gt;  
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> Uhm, two things:
</I>&gt;<i>  
</I>&gt;<i> * RabbitMQ does not like FQDNs - I think you can probably make it work by
</I>&gt;<i> tweaking the startup scripts, but I am not sure. What we recommend is not
</I>&gt;<i> to use FQDNs.
</I>&gt;<i> * If you change the hostname and restart RabbitMQ, things should go smoothly.
</I>&gt;<i>  
</I>&gt;<i> That said, I&#8217;m not sure what DHCP has to do with this. I suppose that what you
</I>&gt;<i> have done is to make possible to resolve the short names of the other nodes,
</I>&gt;<i> since things are working.
</I>&gt;<i>  
</I>&gt;<i> &gt; The next issue is related to clustering. When RabbitMQ starts up, and there's
</I>&gt;<i> &gt; a cluster_nodes section in the config, it seems to try and reach the nodes
</I>&gt;<i> &gt; only once. This behaviour I'm not sure of, hence the question. I noticed that
</I>&gt;<i> &gt; when a node can't look up any of the nodes in the cluster_nodes config, it
</I>&gt;<i> &gt; won't try again at a later point in time, e.g. on restart. Therefore that node
</I>&gt;<i> &gt; will never automatically join the cluster unless rabbitmqctl join_cluster is
</I>&gt;<i> &gt; called.
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; The DHCP configuration helped solve this issue as well, but I'm still
</I>&gt;<i> &gt; wondering if a) my observation is correct and b) if this is desired
</I>&gt;<i> &gt; behaviour. Should a new node be partitioned from the others only temporarily,
</I>&gt;<i> &gt; when it joins, it requires manual intervention to force it to join the
</I>&gt;<i> &gt; cluster. This somewhat seems to conform to what the documentation says:
</I>&gt;<i> &gt; <A HREF="http://www.rabbitmq.com/clustering.html#auto-config,">http://www.rabbitmq.com/clustering.html#auto-config,</A> but I'm not entirely
</I>&gt;<i> &gt; clear on whether a node just gives up trying to form a cluster once it
</I>&gt;<i> &gt; couldn't reach any of the nodes in the cluster_nodes list.
</I>&gt;<i> &gt;  
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> The behaviour you describe is correct. The `cluster_nodes' list is only
</I>&gt;<i> effective on &#8220;virgin&#8221; nodes, that is nodes that are started for the first time.
</I>&gt;<i> If the node can&#8217;t connect to any other node it won&#8217;t do anything. The rationale
</I>&gt;<i> behind that comes from boring technicalities related to how mnesia (the database
</I>&gt;<i> that backs RabbitMQ clustering) works, and most importantly the fact that
</I>&gt;<i> clustered nodes shouldn&#8217;t experience netsplits. So if you say &#8220;Should a new
</I>&gt;<i> node be partitioned from the others only temporarily...&#8221;, maybe clustering is
</I>&gt;<i> not the right solution.
</I>&gt;<i>  
</I>&gt;<i> Again, I&#8217;m don&#8217;t see how DHCP has anything to do with this.
</I>&gt;<i>  
</I>&gt;<i> &gt; So the question boils down to whether the automatic configuration is the way
</I>&gt;<i> &gt; to go or if it makes more sense to automate commands (using Chef, btw) around
</I>&gt;<i> &gt; the join_cluster and cluster_status commands.
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; On top of that, to have a fresh node join the cluster, it needs to be stopped
</I>&gt;<i> &gt; again (stop_app) and reset, which somewhat boils down to the service being
</I>&gt;<i> &gt; started on package installation again. This behaviour seems to also have
</I>&gt;<i> &gt; changed from 2.x where just updating the config and making sure all nodes have
</I>&gt;<i> &gt; the same Erlang cookie is correct, right?
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; So the biggest question is: how do folks work around the fact that the
</I>&gt;<i> &gt; RabbitMQ node is started up on package installation. There's the option to use
</I>&gt;<i> &gt; policy-rc.d systems, but I'm not quite sure how feasible this is to
</I>&gt;<i> &gt; automate. Given that Chef runs every 30 minutes or so, the consequence would
</I>&gt;<i> &gt; be to install a policy on every run or to check on every run whether or not
</I>&gt;<i> &gt; the desired package is already installed. Currently I'm stopping the service
</I>&gt;<i> &gt; after stop_app and reset, before installing the new Erlang cookie. I'm just
</I>&gt;<i> &gt; not sure, it feels a bit weird to automate to me. I'd love for some input or
</I>&gt;<i> &gt; suggestions on this.
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; My current setup is working, and I can add nodes that automatically join the
</I>&gt;<i> &gt; cluster, so it's okay. Just want to make sure it's the right approach, or if
</I>&gt;<i> &gt; there are any other experiences on this. From what I understand there are
</I>&gt;<i> &gt; differences to 2.x cluster setup, where updating the config and changing the
</I>&gt;<i> &gt; Erlang cookie apparently were all that's needed, but that's from my reading of
</I>&gt;<i> &gt; the documentation and existing Chef cookbooks
</I>&gt;<i> &gt; (<A HREF="https://github.com/opscode-cookbooks/rabbitmq">https://github.com/opscode-cookbooks/rabbitmq</A>). Overall I feel like there's a
</I>&gt;<i> &gt; bit of a lack of documentation on how setting up a cluster can or should be
</I>&gt;<i> &gt; automated. Happy to help improving that situation, but I'd like to sure that
</I>&gt;<i> &gt; the choices described above are sane or completely bullocks.
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; Again, apologies for the long email. I hope the setup, issues and questions
</I>&gt;<i> &gt; are somewhat clear. Please let me know if more input is require, happy to dive
</I>&gt;<i> &gt; into more detail.
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; Thank you for your time, for RabbitMQ clustering, and for any feedback you
</I>&gt;<i> &gt; might have :)
</I>&gt;<i> &gt;  
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> I don&#8217;t know anything about EC2 or Chef, and I don&#8217;t understand what you are
</I>&gt;<i> doing with DHCP, but I&#8217;m quite sure you&#8217;re mixing up two separated issues: one
</I>&gt;<i> is related to FQDNs and how nodes resolve other node names, and the other is
</I>&gt;<i> related to how the automatic clustering configuration works.
</I>&gt;<i>  
</I>&gt;<i> For what concerns the former, RabbitMQ nodes will use unqualified names (unless
</I>&gt;<i> you are tweaking how RabbitMQ nodes are started up), so you&#8217;ll have to play by
</I>&gt;<i> that. Obviously you&#8217;ll have to make the unqualified names resolve correctly on
</I>&gt;<i> each node, e.g. by adding entries in the hosts file.
</I>&gt;<i>  
</I>&gt;<i> For what concerns the latter, if you are confident that netsplits won&#8217;t occur,
</I>&gt;<i> then the semantics of the `cluster_nodes' configuration should be fine. If that
</I>&gt;<i> is not the case you might need to hack up some other mechanism but I would
</I>&gt;<i> advise against that because
</I>&gt;<i>  
</I>&gt;<i> 1. It&#8217;s easy to get wrong, clustering is quite delicate and there are many
</I>&gt;<i> subtleties.
</I>&gt;<i> 2. If you are on a network that is affected by netsplits, you should avoid
</I>&gt;<i> clustering anyway - see &lt;<A HREF="http://www.rabbitmq.com/clustering.html">http://www.rabbitmq.com/clustering.html</A>&gt;.
</I>&gt;<i>  
</I>&gt;<i> And yes, things changed from 2.x on this front as part of efforts to make
</I>&gt;<i> clustering more solid.
</I>&gt;<i>  
</I>&gt;<i> I hope this helps.
</I>&gt;<i>  
</I>&gt;<i> Francesco  
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121228/15cce59e/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121228/15cce59e/attachment.htm</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024672.html">[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
</A></li>
	<LI>Next message: <A HREF="024721.html">[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24692">[ date ]</a>
              <a href="thread.html#24692">[ thread ]</a>
              <a href="subject.html#24692">[ subject ]</a>
              <a href="author.html#24692">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
