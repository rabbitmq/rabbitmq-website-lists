<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Automating%20a%20RabbitMQ%203.0%20cluster%20on%20EC2&In-Reply-To=%3C87623rk7p0.wl%25f%40mazzo.li%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024617.html">
   <LINK REL="Next"  HREF="024692.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2</H1>
    <B>Francesco Mazzoli</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Automating%20a%20RabbitMQ%203.0%20cluster%20on%20EC2&In-Reply-To=%3C87623rk7p0.wl%25f%40mazzo.li%3E"
       TITLE="[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2">f at mazzo.li
       </A><BR>
    <I>Mon Dec 24 11:31:23 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024617.html">[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
</A></li>
        <LI>Next message: <A HREF="024692.html">[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24672">[ date ]</a>
              <a href="thread.html#24672">[ thread ]</a>
              <a href="subject.html#24672">[ subject ]</a>
              <a href="author.html#24672">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Hi Mathias,

At Thu, 20 Dec 2012 15:48:05 +0100,
Mathias Meyer wrote:
&gt;<i> I spent some quality time automating a cluster setup of 3.0.1 on EC2 over the
</I>&gt;<i> last couple of days, and came across some things that felt a bit odd to
</I>&gt;<i> me. Maybe I did it all wrong, happy to be proven that I did. I apologize if
</I>&gt;<i> this turns out a bit long, there are a couple of questions that boil down to a
</I>&gt;<i> similar issue. Would be curious to hear how other folks have solved this
</I>&gt;<i> issue, and mostly focussing on RabbitMQ 3.0, as, from what I've read,
</I>&gt;<i> clustering behaviour has changed with that release.
</I>&gt;<i> 
</I>&gt;<i> First a whee bit about the setup, nothing special really, but required to
</I>&gt;<i> clarify some of the questions below: every node has a custom CNAME record
</I>&gt;<i> rabbitmq1.domain.com, rabbitmq2.domain.com, each pointing to the EC2 host
</I>&gt;<i> name. I do this because I prefer full hostnames over EC2 hostnames because it
</I>&gt;<i> adds clarity to the whole setup, at least for me :)
</I>&gt;<i> 
</I>&gt;<i> The first issue with this setup comes up when you want to change the hostname
</I>&gt;<i> for the RabbitMQ node. Changing it post-installation is a bit of a hassle
</I>&gt;<i> because the package already starts up the service. Changing the nodename to
</I>&gt;<i> the FQDN and trying to restart the service after that leads to errors because
</I>&gt;<i> the service can't be stopped anymore as the nodenames are now different.
</I>&gt;<i> 
</I>&gt;<i> I solved this on EC2 by adding domain.com to the DHCP configuration and
</I>&gt;<i> restarting the network before installing the RabbitMQ package. It's not a
</I>&gt;<i> great solution, but acceptable. In the end it boils down to the package
</I>&gt;<i> starting the service immediately on installation, more on that below.
</I>
Uhm, two things:

  * RabbitMQ does not like FQDNs - I think you can probably make it work by
    tweaking the startup scripts, but I am not sure.  What we recommend is not
    to use FQDNs.
  * If you change the hostname and restart RabbitMQ, things should go smoothly.

That said, I&#8217;m not sure what DHCP has to do with this.  I suppose that what you
have done is to make possible to resolve the short names of the other nodes,
since things are working.

&gt;<i> The next issue is related to clustering. When RabbitMQ starts up, and there's
</I>&gt;<i> a cluster_nodes section in the config, it seems to try and reach the nodes
</I>&gt;<i> only once. This behaviour I'm not sure of, hence the question. I noticed that
</I>&gt;<i> when a node can't look up any of the nodes in the cluster_nodes config, it
</I>&gt;<i> won't try again at a later point in time, e.g. on restart. Therefore that node
</I>&gt;<i> will never automatically join the cluster unless rabbitmqctl join_cluster is
</I>&gt;<i> called.
</I>&gt;<i> 
</I>&gt;<i> The DHCP configuration helped solve this issue as well, but I'm still
</I>&gt;<i> wondering if a) my observation is correct and b) if this is desired
</I>&gt;<i> behaviour. Should a new node be partitioned from the others only temporarily,
</I>&gt;<i> when it joins, it requires manual intervention to force it to join the
</I>&gt;<i> cluster. This somewhat seems to conform to what the documentation says:
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/clustering.html#auto-config,">http://www.rabbitmq.com/clustering.html#auto-config,</A> but I'm not entirely
</I>&gt;<i> clear on whether a node just gives up trying to form a cluster once it
</I>&gt;<i> couldn't reach any of the nodes in the cluster_nodes list.
</I>
The behaviour you describe is correct.  The `cluster_nodes' list is only
effective on &#8220;virgin&#8221; nodes, that is nodes that are started for the first time.
If the node can&#8217;t connect to any other node it won&#8217;t do anything.  The rationale
behind that comes from boring technicalities related to how mnesia (the database
that backs RabbitMQ clustering) works, and most importantly the fact that
clustered nodes shouldn&#8217;t experience netsplits.  So if you say &#8220;Should a new
node be partitioned from the others only temporarily...&#8221;, maybe clustering is
not the right solution.

Again, I&#8217;m don&#8217;t see how DHCP has anything to do with this.

&gt;<i> So the question boils down to whether the automatic configuration is the way
</I>&gt;<i> to go or if it makes more sense to automate commands (using Chef, btw) around
</I>&gt;<i> the join_cluster and cluster_status commands.
</I>&gt;<i> 
</I>&gt;<i> On top of that, to have a fresh node join the cluster, it needs to be stopped
</I>&gt;<i> again (stop_app) and reset, which somewhat boils down to the service being
</I>&gt;<i> started on package installation again. This behaviour seems to also have
</I>&gt;<i> changed from 2.x where just updating the config and making sure all nodes have
</I>&gt;<i> the same Erlang cookie is correct, right?
</I>&gt;<i> 
</I>&gt;<i> So the biggest question is: how do folks work around the fact that the
</I>&gt;<i> RabbitMQ node is started up on package installation. There's the option to use
</I>&gt;<i> policy-rc.d systems, but I'm not quite sure how feasible this is to
</I>&gt;<i> automate. Given that Chef runs every 30 minutes or so, the consequence would
</I>&gt;<i> be to install a policy on every run or to check on every run whether or not
</I>&gt;<i> the desired package is already installed. Currently I'm stopping the service
</I>&gt;<i> after stop_app and reset, before installing the new Erlang cookie. I'm just
</I>&gt;<i> not sure, it feels a bit weird to automate to me. I'd love for some input or
</I>&gt;<i> suggestions on this.
</I>&gt;<i> 
</I>&gt;<i> My current setup is working, and I can add nodes that automatically join the
</I>&gt;<i> cluster, so it's okay. Just want to make sure it's the right approach, or if
</I>&gt;<i> there are any other experiences on this. From what I understand there are
</I>&gt;<i> differences to 2.x cluster setup, where updating the config and changing the
</I>&gt;<i> Erlang cookie apparently were all that's needed, but that's from my reading of
</I>&gt;<i> the documentation and existing Chef cookbooks
</I>&gt;<i> (<A HREF="https://github.com/opscode-cookbooks/rabbitmq">https://github.com/opscode-cookbooks/rabbitmq</A>). Overall I feel like there's a
</I>&gt;<i> bit of a lack of documentation on how setting up a cluster can or should be
</I>&gt;<i> automated. Happy to help improving that situation, but I'd like to sure that
</I>&gt;<i> the choices described above are sane or completely bullocks.
</I>&gt;<i> 
</I>&gt;<i> Again, apologies for the long email. I hope the setup, issues and questions
</I>&gt;<i> are somewhat clear. Please let me know if more input is require, happy to dive
</I>&gt;<i> into more detail.
</I>&gt;<i> 
</I>&gt;<i> Thank you for your time, for RabbitMQ clustering, and for any feedback you
</I>&gt;<i> might have :)
</I>
I don&#8217;t know anything about EC2 or Chef, and I don&#8217;t understand what you are
doing with DHCP, but I&#8217;m quite sure you&#8217;re mixing up two separated issues: one
is related to FQDNs and how nodes resolve other node names, and the other is
related to how the automatic clustering configuration works.

For what concerns the former, RabbitMQ nodes will use unqualified names (unless
you are tweaking how RabbitMQ nodes are started up), so you&#8217;ll have to play by
that.  Obviously you&#8217;ll have to make the unqualified names resolve correctly on
each node, e.g. by adding entries in the hosts file.

For what concerns the latter, if you are confident that netsplits won&#8217;t occur,
then the semantics of the `cluster_nodes' configuration should be fine.  If that
is not the case you might need to hack up some other mechanism but I would
advise against that because

  1. It&#8217;s easy to get wrong, clustering is quite delicate and there are many
     subtleties.
  2. If you are on a network that is affected by netsplits, you should avoid
     clustering anyway - see &lt;<A HREF="http://www.rabbitmq.com/clustering.html">http://www.rabbitmq.com/clustering.html</A>&gt;.

And yes, things changed from 2.x on this front as part of efforts to make
clustering more solid.

I hope this helps.

Francesco

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024617.html">[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
</A></li>
	<LI>Next message: <A HREF="024692.html">[rabbitmq-discuss] Automating a RabbitMQ 3.0 cluster on EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24672">[ date ]</a>
              <a href="thread.html#24672">[ thread ]</a>
              <a href="subject.html#24672">[ subject ]</a>
              <a href="author.html#24672">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
