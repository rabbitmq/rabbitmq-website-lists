<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Federation connections, VIPs, and queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Federation%20connections%2C%20VIPs%2C%20and%20queues&In-Reply-To=%3CCACLE7iwpWFbVKxvuOpAOLq9j39adoiAo5CkVywz%2Bf8eX9u%2B11A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024596.html">
   <LINK REL="Next"  HREF="024473.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Federation connections, VIPs, and queues</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Federation%20connections%2C%20VIPs%2C%20and%20queues&In-Reply-To=%3CCACLE7iwpWFbVKxvuOpAOLq9j39adoiAo5CkVywz%2Bf8eX9u%2B11A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Federation connections, VIPs, and queues">mpietrek at skytap.com
       </A><BR>
    <I>Mon Dec 10 21:17:02 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024596.html">[rabbitmq-discuss] Transactions
</A></li>
        <LI>Next message: <A HREF="024473.html">[rabbitmq-discuss] Federation connections, VIPs, and queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24426">[ date ]</a>
              <a href="thread.html#24426">[ thread ]</a>
              <a href="subject.html#24426">[ subject ]</a>
              <a href="author.html#24426">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I realize this is a somewhat esoteric question and apologize for the
complexity. We're still on 2.8.7 for a while, although my guess is that
federation in 3.0 won't drastically change the answer.

In our setup, we have bidirectionally federated nodes, i.e.  'slave' &lt;-&gt;
'master' with an exchange named 'skytap'.  To this mix I add a set of
alternate nodes to enable non-stopping upgrades: 'master-alternate' and
'slave-alternate'. The primary and alternate nodes are identically
configured.

I'm using VIPs (keepalive based) for connections between nodes. There's a
vip-master and a vip-slave. Most of the time vip-master points at the
'master&quot; node, but occasionally points at the 'master-alternate&quot; node. In
the rabbitmq.config, I specify the VIP names everywhere (i.e vip-master,
vip-alternate), and never mention the actual node names.

When I first start this up, I see a federation support queue like this:

federation: skytap -&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at master</A>

This is what I'd expect based on my understanding of federation.

However, after doing an upgrade process (i.e., vip-master goes from
'master' to 'master-alternate' and back to 'master'), I have two queues now:

federation: skytap -&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at slave</A>
federation: skytap -&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at slave-alternate</A>

This isn't so good. The vast majority of the time the slave-alternate node
isn't around. Messages sent to the skytap exchange just pile up in the
second queue. (The do of course get delivered to the non-alternate slave
node.)

*Question 1:*
I'm trying to understand this behavior. It's almost as if the federation
logic is burrowing underneath my VIP and discovering the actual node names.
In my naive understanding, I'd expect that the use of VIPs would hide away
the primary/alternate nodes.

That said, I do notice in the connections list that incoming connections
come from the 'regular' node IP, not from the VIP that's assigned to the
same node. Not sure if this is relevant or not.

*Question 2:*
In a related vein, looking at the Exchanges I see exchanges like this:

federation: skytap -&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at slave</A> A
federation: skytap -&gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at slave-alternate</A> B

What do the A/B signify?

Thanks,

Matt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121210/15751bfd/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20121210/15751bfd/attachment.htm</A>&gt;
</PRE>






































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024596.html">[rabbitmq-discuss] Transactions
</A></li>
	<LI>Next message: <A HREF="024473.html">[rabbitmq-discuss] Federation connections, VIPs, and queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24426">[ date ]</a>
              <a href="thread.html#24426">[ thread ]</a>
              <a href="subject.html#24426">[ subject ]</a>
              <a href="author.html#24426">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
