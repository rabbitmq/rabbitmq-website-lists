<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] binary data corrupts when transferring on	Rabbitmq
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20binary%20data%20corrupts%20when%20transferring%20on%0A%09Rabbitmq&In-Reply-To=%3C1355723370888-24062.post%40n5.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024540.html">
   <LINK REL="Next"  HREF="024536.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] binary data corrupts when transferring on	Rabbitmq</H1>
    <B>saurabh256</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20binary%20data%20corrupts%20when%20transferring%20on%0A%09Rabbitmq&In-Reply-To=%3C1355723370888-24062.post%40n5.nabble.com%3E"
       TITLE="[rabbitmq-discuss] binary data corrupts when transferring on	Rabbitmq">saurabh256 at yahoo.com
       </A><BR>
    <I>Mon Dec 17 05:49:30 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="024540.html">[rabbitmq-discuss] Backup message and state at a point of time
</A></li>
        <LI>Next message: <A HREF="024536.html">[rabbitmq-discuss] binary data corrupts when transferring on Rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24535">[ date ]</a>
              <a href="thread.html#24535">[ thread ]</a>
              <a href="subject.html#24535">[ subject ]</a>
              <a href="author.html#24535">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am new to RabbitMQ and tried to transfer a word document but seems when
recieving or sending something happened during encoding or character set and
output file gets corrupted. 

Below is the code for consumer and publisher. Can someone tell me where I am
wrong? I am using RabbitMQ Version 3.0.0 on windows machine (if the
information helps).

I created one word doc manually and exported locally using the producer
which is working fine but document created by the consumer is corrupt and
word opens that asking for fix. 

This small sample is vey important for me as my all other use cases are
based on same foundation. 

--------------------------------
Publisher-----------------------

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;

import com.rabbitmq.client.AMQP;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;

public class BaseProducer {

  private final static String QUEUE_NAME = &quot;hello&quot;;

  public static void main(String[] argv) throws Exception {
      	      
    ConnectionFactory factory = new ConnectionFactory();
    factory.setHost(&quot;localhost&quot;);
    Connection connection = factory.newConnection();
    Channel channel = connection.createChannel();

    channel.queueDeclare(QUEUE_NAME, false, false, false, null);
    String message = &quot;Hello World!&quot;;
    
    String INPUT_FILE_NAME = &quot;C:\\Folder\\Saurabh\\BSM\\video\\test.docx&quot;;
    byte[] fileContents = read(INPUT_FILE_NAME);
    
    AMQP.BasicProperties.Builder bob = new AMQP.BasicProperties.Builder();
    AMQP.BasicProperties persistentBasic
    =
bob.priority(0).contentType(&quot;application/octet-stream&quot;).contentEncoding(&quot;UTF-8&quot;).build();
    
    channel.basicPublish(&quot;&quot;, QUEUE_NAME, persistentBasic,fileContents);
    System.out.println(&quot; [x] Sent '&quot; + message + &quot;'&quot;);
    
    writeFile(fileContents);
    channel.close();
    connection.close();
  }
  
  static byte[]  read(String aInputFileName){
      //log(&quot;Reading in binary file named : &quot; + aInputFileName);
      File file = new File(aInputFileName);
      //log(&quot;File size: &quot; + file.length());
      byte[] result = new byte[(int)file.length()];
      try {
        InputStream input = null;
          int totalBytesRead = 0;
          input = new FileInputStream(aInputFileName);
          input.read(result);
          input.close();
          
        
      }
      catch (FileNotFoundException ex) {
       // log(&quot;File not found.&quot;);
      }
      catch (IOException ex) {
       // log(ex);
      }
      return result;
    }
  
  static void writeFile(byte[] result){
	  // write file from here only and see if working
      FileOutputStream out;
	try {
		out = new
FileOutputStream(&quot;C:\\Folder\\Saurabh\\BSM\\video\\test-local.docx&quot;);
		out.write(result);
	    out.close();
	} catch (FileNotFoundException e) {
		// TODO Auto-generated catch block
		e.printStackTrace();
	}  
	 catch (IOException ex) {
	       // log(ex);
		 ex.printStackTrace();
	 }
      
  }
}

-------------------------------------------------
Consumer -----------------------------

import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectOutputStream;

import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.QueueingConsumer;

public class BaseConsumer {

    private final static String QUEUE_NAME = &quot;hello&quot;;

    public static void main(String[] argv) throws Exception {

    ConnectionFactory factory = new ConnectionFactory();
    factory.setHost(&quot;localhost&quot;);
    Connection connection = factory.newConnection();
    Channel channel = connection.createChannel();

    channel.queueDeclare(QUEUE_NAME, false, false, false, null);
    System.out.println(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;);
    
    QueueingConsumer consumer = new QueueingConsumer(channel);
   
    channel.basicConsume(QUEUE_NAME, true, consumer);
    
    Object fileObj = null;
    while (true) {
      QueueingConsumer.Delivery delivery = consumer.nextDelivery();
      //String message = new String(delivery.getBody());
      FileOutputStream out =null;
      try {  
      	out = new
FileOutputStream(&quot;C:\\Folder\\Saurabh\\BSM\\video\\test-output.docx&quot;);
      	
      	ObjectOutputStream save = new ObjectOutputStream(out);
      	save.writeObject(delivery.getBody());
      	save.close();

          out.close();
      } catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} 
      
      System.out.println(&quot; [x] Received '&quot; );
    }
  }
}



--
View this message in context: <A HREF="http://rabbitmq.1065348.n5.nabble.com/binary-data-corrupts-when-transferring-on-Rabbitmq-tp24062.html">http://rabbitmq.1065348.n5.nabble.com/binary-data-corrupts-when-transferring-on-Rabbitmq-tp24062.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.
</PRE>














































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024540.html">[rabbitmq-discuss] Backup message and state at a point of time
</A></li>
	<LI>Next message: <A HREF="024536.html">[rabbitmq-discuss] binary data corrupts when transferring on Rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24535">[ date ]</a>
              <a href="thread.html#24535">[ thread ]</a>
              <a href="subject.html#24535">[ subject ]</a>
              <a href="author.html#24535">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
