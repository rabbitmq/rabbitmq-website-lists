<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ running at 100% CPU.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20running%20at%20100%25%20CPU.&In-Reply-To=4805A1B5.1090303%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000724.html">
   <LINK REL="Next"  HREF="000729.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ running at 100% CPU.</H1>
    <B>Michael Arnoldus</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20running%20at%20100%25%20CPU.&In-Reply-To=4805A1B5.1090303%40lshift.net"
       TITLE="[rabbitmq-discuss] RabbitMQ running at 100% CPU.">chime at mu.dk
       </A><BR>
    <I>Wed Apr 16 09:51:06 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000724.html">[rabbitmq-discuss] RabbitMQ running at 100% CPU.
</A></li>
        <LI>Next message: <A HREF="000729.html">[rabbitmq-discuss] RabbitMQ running at 100% CPU.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#727">[ date ]</a>
              <a href="thread.html#727">[ thread ]</a>
              <a href="subject.html#727">[ subject ]</a>
              <a href="author.html#727">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthias,

Nice work!!!

As expected I get 100% CPU wit sock_spin:broken().

uname -a:
Darwin Hobbes.local 9.2.2 Darwin Kernel Version 9.2.2: Tue Mar  4  
21:17:34 PST 2008; root:xnu-1228.4.31~1/RELEASE_I386 i386

erlang version:
Erlang (BEAM) emulator version 5.6.1 [source] [smp:2] [async-threads: 
0] [kernel-poll:false]

I'll be happy to try it on other HW and/or other versions if you think  
you need this.

Regards,

Michael

On Apr 16, 2008, at 8:50 , Matthias Radestock wrote:

&gt;<i> Michael, and anybody else who can spare a couple of minutes,
</I>&gt;<i>
</I>&gt;<i> Matthias Radestock wrote:
</I>&gt;&gt;<i> Michael Arnoldus wrote:
</I>&gt;&gt;&gt;<i> Since we are running on Intel HW, let me know if I can help by  
</I>&gt;&gt;&gt;<i> running stuff or reproduce the problem.
</I>&gt;&gt;<i> Thanks for the offer. I might take you up on it once I have a  
</I>&gt;&gt;<i> simple test case ready.
</I>&gt;<i>
</I>&gt;<i> ...which I now have. See attached.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> To run this,
</I>&gt;<i>
</I>&gt;<i> 1) save the attached file in some directory
</I>&gt;<i>
</I>&gt;<i> 2) cd to that directory
</I>&gt;<i>
</I>&gt;<i> 3) run the erlang shell, i.e. 'erl'
</I>&gt;<i>
</I>&gt;<i> 4) monitor the CPU consumption of the erlang process (usually called  
</I>&gt;<i> 'beam' or 'beam.smp') with a program like 'top'
</I>&gt;<i>
</I>&gt;<i> 5) at the Erlang prompt, compile the program with
</I>&gt;<i>    c(sock_spin).
</I>&gt;<i> which should return
</I>&gt;<i>    {ok,sock_spin}
</I>&gt;<i>
</I>&gt;<i> 6) still at the Erlang prompt, pick a port (e.g. 5678) and run
</I>&gt;<i>    sock_spin:working(5678).
</I>&gt;<i>
</I>&gt;<i> 7) connect to the chosen port with, say, netcat (telnet should work  
</I>&gt;<i> too, but seems to be harder to kill; see next step), e.g.
</I>&gt;<i>    nc localhost 5678 &gt; /dev/null
</I>&gt;<i>
</I>&gt;<i> 8) terminate the connection, e.g. by ^C-ing netcat or killing the  
</I>&gt;<i> process.
</I>&gt;<i>
</I>&gt;<i> 9) At this point (it may take a few seconds) the Erlang shell should  
</I>&gt;<i> return something like {error, closed} or {error, einval}. Check the  
</I>&gt;<i> CPU usage of the Erlang process.
</I>&gt;<i>
</I>&gt;<i> Now repeat steps 6-9 but call
</I>&gt;<i>    sock_spin:broken(5678).
</I>&gt;<i> instead.
</I>&gt;<i>
</I>&gt;<i> Finally, to quit the Erlang shell just type
</I>&gt;<i>    q().
</I>&gt;<i> at the prompt.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The CPU consumption of the Erlang process reported in step 9 should  
</I>&gt;<i> be near 0% at the end of both tests. However, on some systems the  
</I>&gt;<i> second test leaves the Erlang process consuming 100% CPU, though the  
</I>&gt;<i> Erlang shell remains responsive. I am interested in finding out  
</I>&gt;<i> which systems exhibit this behaviour and which don't.
</I>&gt;<i>
</I>&gt;<i> When reporting your results please include information about your  
</I>&gt;<i> system (if you are on Unix just run 'uname -a') and Erlang version  
</I>&gt;<i> (the version number displayed when starting the Erlang shell will do  
</I>&gt;<i> just fine).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i> -module(sock_spin).
</I>&gt;<i>
</I>&gt;<i> -compile(export_all).
</I>&gt;<i>
</I>&gt;<i> working(Port) -&gt;
</I>&gt;<i>    spin(Port, []).
</I>&gt;<i>
</I>&gt;<i> broken(Port) -&gt;
</I>&gt;<i>    spin(Port, [{active, false}]).
</I>&gt;<i>
</I>&gt;<i> spin(Port, Opts) -&gt;
</I>&gt;<i>    {ok, LSock} = gen_tcp:listen(Port, Opts),
</I>&gt;<i>    {ok, Sock} = gen_tcp:accept(LSock),
</I>&gt;<i>    Res = send(Sock, list_to_binary(lists:duplicate(10000, $A))),
</I>&gt;<i>    ok = gen_tcp:close(LSock),
</I>&gt;<i>    Res.
</I>&gt;<i>
</I>&gt;<i> send(Sock, B) -&gt;
</I>&gt;<i>    case gen_tcp:send(Sock, B) of
</I>&gt;<i>        ok    -&gt; send(Sock, B);
</I>&gt;<i>        Other -&gt; Other
</I>&gt;<i>    end.
</I>&gt;<i>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 1912 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/0084c842/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/0084c842/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000724.html">[rabbitmq-discuss] RabbitMQ running at 100% CPU.
</A></li>
	<LI>Next message: <A HREF="000729.html">[rabbitmq-discuss] RabbitMQ running at 100% CPU.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#727">[ date ]</a>
              <a href="thread.html#727">[ thread ]</a>
              <a href="subject.html#727">[ subject ]</a>
              <a href="author.html#727">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
