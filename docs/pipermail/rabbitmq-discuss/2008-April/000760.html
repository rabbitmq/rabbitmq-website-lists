<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ perfomance testing &amp; troubles
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20perfomance%20testing%20%26%20troubles&In-Reply-To=4810EAB7.7070209%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000758.html">
   <LINK REL="Next"  HREF="000762.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ perfomance testing &amp; troubles</H1>
    <B>Andrew V.Statsenko</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20perfomance%20testing%20%26%20troubles&In-Reply-To=4810EAB7.7070209%40lshift.net"
       TITLE="[rabbitmq-discuss] RabbitMQ perfomance testing &amp; troubles">alter at tcontest.ru
       </A><BR>
    <I>Thu Apr 24 23:23:12 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000758.html">[rabbitmq-discuss] RabbitMQ perfomance testing &amp; troubles
</A></li>
        <LI>Next message: <A HREF="000762.html">[rabbitmq-discuss] RabbitMQ perfomance testing &amp; troubles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#760">[ date ]</a>
              <a href="thread.html#760">[ thread ]</a>
              <a href="subject.html#760">[ subject ]</a>
              <a href="author.html#760">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&#208;&#146; &#208;&#167;&#209;&#130;, 24/04/2008 &#208;&#178; 21:16 +0100, Matthias Radestock &#208;&#191;&#208;&#184;&#209;&#136;&#208;&#181;&#209;&#130;:


Matthias, thanks a lot for your answer !

&gt;<i> 
</I>&gt;<i> &gt; Well, I was configured the local cluster for 8 nodes:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; # su rabbitmq -c &quot;/usr/sbin/rabbitmq-multi start_all 8&quot;
</I>&gt;<i> &gt; Starting all nodes...   
</I>&gt;<i> &gt; [...]
</I>&gt;<i> &gt; broker running
</I>&gt;<i> &gt; OK
</I>&gt;<i> 
</I>&gt;<i> Great. Glad it worked without problems.
</I>
And I'm still do think, that we are have a same stable Debian without
(white ? / black ?) magic  :-)


Mmm.. a little: usermod -s /bin/sh rabbitmq. 
Yes, a security hole, but I'm just testing.


&gt;<i> 
</I>&gt;<i> &gt; Is any way to improve perfomance and reduce latency in my N producers =&gt; M consumers scheme ?
</I>&gt;<i> 
</I>&gt;<i> Did you make the other changes I suggested previously, namely:
</I>&gt;<i> 
</I>&gt;<i> - change the exchange type from &quot;topic&quot; to &quot;direct&quot;
</I>
Well, just a second..

&gt;<i> 
</I>&gt;<i> - make sure that all the producer &amp; consumer connections are set up and 
</I>&gt;<i> the queues have been created before starting to send any messages
</I>
Yes, all producers &amp; consumers connections are set before start
send/recieve messages (class constructor) and thread sleep 10 sec after
queues creation and before starting to send any messages


I change the exchange type in producer &amp; consumer from &quot;topic&quot; to
&quot;direct&quot; and start test:

$ java -jar RabbitmqFastMessagingProducerTest.jar 1000 &gt; client.log

The server side of 8 local nodes with  10000 mps looks good:

top - 01:32:47 up 20 days,  8:01,  3 users,  load average: 0.84, 1.31,
0.71
Tasks: 152 total,   1 running, 151 sleeping,   0 stopped,   0 zombie
Cpu(s):  7.4%us,  1.3%sy,  0.0%ni, 89.6%id,  0.0%wa,  0.0%hi,  1.6%si,
0.0%st
Mem:   4139508k total,  1610992k used,  2528516k free,   334196k buffers
Swap:  4194296k total,        0k used,  4194296k free,   862924k cached

PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
12613 rabbitmq  15   0 47604  22m 1596 S   12  0.6   0:37.40 beam
12931 rabbitmq  15   0 48552  23m 1596 S   11  0.6   0:38.55 beam
14203 rabbitmq  15   0 48552  23m 1596 S   11  0.6   0:38.15 beam
13567 rabbitmq  15   0 47612  23m 1596 S   10  0.6   0:37.39 beam
14521 rabbitmq  15   0 48556  23m 1596 S   10  0.6   0:35.25 beam
13885 rabbitmq  15   0 48560  23m 1596 S    9  0.6   0:37.93 beam
14839 rabbitmq  15   0 48556  22m 1596 S    9  0.6   0:35.80 beam
13249 rabbitmq  15   0 48556  23m 1596 S    8  0.6   0:34.43 beam


The client side is also looks good and very low delay (1-20 ms):

$ tail -f client.log | awk '/CLIENT_CONSUMER_THREAD_ID/{print &quot;DELAY: &quot;
$4-$8 &quot; &quot; $0}'

DELAY: 1 CLIENT_CONSUMER_THREAD_ID: 167 TIME: 1209073100621 MESSAGE:
4469 TIME: 1209073100620
DELAY: 2 CLIENT_CONSUMER_THREAD_ID: 988 TIME: 1209073100622 MESSAGE:
4469 TIME: 1209073100620
DELAY: 2 CLIENT_CONSUMER_THREAD_ID: 333 TIME: 1209073100622 MESSAGE:
4468 TIME: 1209073100620
DELAY: 3 CLIENT_CONSUMER_THREAD_ID: 56 TIME: 1209073100623 MESSAGE: 4468
TIME: 1209073100620
DELAY: 43 CLIENT_CONSUMER_THREAD_ID: 857 TIME: 1209073100623 MESSAGE:
4467 TIME: 1209073100580
DELAY: 3 CLIENT_CONSUMER_THREAD_ID: 892 TIME: 1209073100623 MESSAGE:
4462 TIME: 1209073100620
DELAY: 4 CLIENT_CONSUMER_THREAD_ID: 607 TIME: 1209073100624 MESSAGE:
4465 TIME: 1209073100620
DELAY: 4 CLIENT_CONSUMER_THREAD_ID: 553 TIME: 1209073100624 MESSAGE:
4464 TIME: 1209073100620
DELAY: 5 CLIENT_CONSUMER_THREAD_ID: 272 TIME: 1209073100625 MESSAGE:
4466 TIME: 1209073100620
DELAY: 6 CLIENT_CONSUMER_THREAD_ID: 654 TIME: 1209073100626 MESSAGE:
4463 TIME: 1209073100620



But, then I try to calculate message log I have a some confuse 

$ cat client.log | ggrep -v -E &quot;(START|STOP)&quot; | grep
CLIENT_PRODUCER_THREAD_ID | wc -l
 1000000

$ cat client.log | ggrep -v -E &quot;(START|STOP)&quot; | grep
CLIENT_CONSUMER_THREAD_ID | wc -l
  137983

Logs tells that I send 1000000 messages, but recieve only 137983 . 

Hmm... So, why ? 

I can't loss any messages in real play. The test code is attached.


P.S.
I'm very sorry, I'm realy need some sleep. 



WBR,
Alter


-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbitmqfastmessagingproducertest.tar.gz
Type: application/x-compressed-tar
Size: 2017 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080425/dcd6231e/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080425/dcd6231e/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000758.html">[rabbitmq-discuss] RabbitMQ perfomance testing &amp; troubles
</A></li>
	<LI>Next message: <A HREF="000762.html">[rabbitmq-discuss] RabbitMQ perfomance testing &amp; troubles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#760">[ date ]</a>
              <a href="thread.html#760">[ thread ]</a>
              <a href="subject.html#760">[ subject ]</a>
              <a href="author.html#760">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
