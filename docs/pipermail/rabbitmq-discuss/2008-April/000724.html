<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ running at 100% CPU.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20running%20at%20100%25%20CPU.&In-Reply-To=48050CDC.50802%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000721.html">
   <LINK REL="Next"  HREF="000727.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ running at 100% CPU.</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20running%20at%20100%25%20CPU.&In-Reply-To=48050CDC.50802%40lshift.net"
       TITLE="[rabbitmq-discuss] RabbitMQ running at 100% CPU.">matthias at lshift.net
       </A><BR>
    <I>Wed Apr 16 07:50:29 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000721.html">[rabbitmq-discuss] RabbitMQ running at 100% CPU.
</A></li>
        <LI>Next message: <A HREF="000727.html">[rabbitmq-discuss] RabbitMQ running at 100% CPU.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#724">[ date ]</a>
              <a href="thread.html#724">[ thread ]</a>
              <a href="subject.html#724">[ subject ]</a>
              <a href="author.html#724">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Michael, and anybody else who can spare a couple of minutes,

Matthias Radestock wrote:
&gt;<i> Michael Arnoldus wrote:
</I>&gt;&gt;<i> Since we are running on Intel HW, let me know if I can help by running 
</I>&gt;&gt;<i> stuff or reproduce the problem.
</I>&gt;<i> 
</I>&gt;<i> Thanks for the offer. I might take you up on it once I have a simple 
</I>&gt;<i> test case ready.
</I>
...which I now have. See attached.


To run this,

1) save the attached file in some directory

2) cd to that directory

3) run the erlang shell, i.e. 'erl'

4) monitor the CPU consumption of the erlang process (usually called 
'beam' or 'beam.smp') with a program like 'top'

5) at the Erlang prompt, compile the program with
     c(sock_spin).
which should return
     {ok,sock_spin}

6) still at the Erlang prompt, pick a port (e.g. 5678) and run
     sock_spin:working(5678).

7) connect to the chosen port with, say, netcat (telnet should work too, 
but seems to be harder to kill; see next step), e.g.
     nc localhost 5678 &gt; /dev/null

8) terminate the connection, e.g. by ^C-ing netcat or killing the process.

9) At this point (it may take a few seconds) the Erlang shell should 
return something like {error, closed} or {error, einval}. Check the CPU 
usage of the Erlang process.

Now repeat steps 6-9 but call
     sock_spin:broken(5678).
instead.

Finally, to quit the Erlang shell just type
     q().
at the prompt.


The CPU consumption of the Erlang process reported in step 9 should be 
near 0% at the end of both tests. However, on some systems the second 
test leaves the Erlang process consuming 100% CPU, though the Erlang 
shell remains responsive. I am interested in finding out which systems 
exhibit this behaviour and which don't.

When reporting your results please include information about your system 
(if you are on Unix just run 'uname -a') and Erlang version (the version 
number displayed when starting the Erlang shell will do just fine).


Regards,

Matthias.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: sock_spin.erl
Type: text/x-erlang
Size: 463 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/97ffe24c/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080416/97ffe24c/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000721.html">[rabbitmq-discuss] RabbitMQ running at 100% CPU.
</A></li>
	<LI>Next message: <A HREF="000727.html">[rabbitmq-discuss] RabbitMQ running at 100% CPU.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#724">[ date ]</a>
              <a href="thread.html#724">[ thread ]</a>
              <a href="subject.html#724">[ subject ]</a>
              <a href="author.html#724">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
