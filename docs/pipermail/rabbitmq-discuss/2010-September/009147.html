<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Shutdown Listener on Java Client API
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Shutdown%20Listener%20on%20Java%20Client%20API&In-Reply-To=%3CB332427A-10AA-4C9F-AF44-7CFB2ABE0690%40yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009146.html">
   <LINK REL="Next"  HREF="008896.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Shutdown Listener on Java Client API</H1>
    <B>Dave Greggory</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Shutdown%20Listener%20on%20Java%20Client%20API&In-Reply-To=%3CB332427A-10AA-4C9F-AF44-7CFB2ABE0690%40yahoo.com%3E"
       TITLE="[rabbitmq-discuss] Shutdown Listener on Java Client API">davegreggory at yahoo.com
       </A><BR>
    <I>Tue Sep 28 23:16:52 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="009146.html">[rabbitmq-discuss] Shutdown Listener on Java Client API
</A></li>
        <LI>Next message: <A HREF="008896.html">[rabbitmq-discuss] Multiple consumers and queue subscription
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9147">[ date ]</a>
              <a href="thread.html#9147">[ thread ]</a>
              <a href="subject.html#9147">[ subject ]</a>
              <a href="author.html#9147">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;&gt;<i> We had something similar happen again last night. For some reason, one of our producers lost the connection to RabbitMQ at 7:47 PM
</I>&gt;<i> 
</I>&gt;<i> How did you observe this?
</I>
The client web app started dropping messages at 7:47 PM. The app queues messages in internal buffer and a separate thread goes and empties this queue by sending them to rabbitMQ. This async thread prevents any blocking message sends from affecting the rest of functionality. Since we observed dropped messages we can presume that the internal buffer / queue was full and the message send thread either blocked or slowed to a crawl. No errors or exceptions in that thread. No CPU or memory or disk use spikes. We kept dropping messages from 7:47 till 8:58 PM when it detected the connection loss and automatically re-connected. 

Can't say for sure that the connection was lost at 7:47 PM but all things point to it. 

I think I mentioned previously that RabbitMQ nodes stayed up. No message build (our queues are mostly empty all the time as our consumer is really fast). No errors in RabbitMQ logs. 

&gt;&gt;<i> but the shutDownCompleted event did not fire on that producer till 8:58 PM.
</I>&gt;<i> 
</I>&gt;<i> It's possible for a stale network connection to go undetected for a long time. The presence of firewalls and loadbalancers in the path seems to increase the likelihood of this happening.
</I>
True, the problem is probably not in RabbitMQ... But we'd like to detect it as quickly as possible when it happens to take preventive action. 

&gt;&gt;<i> Any thoughts? Is there something in the java client api that could prevent the shutdownEvent from firing quickly?
</I>&gt;<i> 
</I>&gt;<i> No. The most likely cause is that the tcp stack simply took that long to  notice the connection was dead.
</I>&gt;<i> 
</I>&gt;&gt;<i> AMQP Heartbeats were mentioned in another thread, would that help and
</I>&gt;&gt;<i> how do we enable these?
</I>&gt;<i> 
</I>&gt;<i> Yes, heartbeats would help. Enable them with <A HREF="http://www.rabbitmq.com/releases/rabbitmq-java-client/v2.1.0/rabbitmq-java-client-javadoc-2.1.0/com/rabbitmq/client/ConnectionFactory.html#setRequestedHeartbeat(int">http://www.rabbitmq.com/releases/rabbitmq-java-client/v2.1.0/rabbitmq-java-client-javadoc-2.1.0/com/rabbitmq/client/ConnectionFactory.html#setRequestedHeartbeat(int</A>)
</I>&gt;<i> 
</I>&gt;<i> You could also try playing with TCP's 
</I>
Thanks will try heart beats, TCP keep alive's are already enabled by the load balancer. 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009146.html">[rabbitmq-discuss] Shutdown Listener on Java Client API
</A></li>
	<LI>Next message: <A HREF="008896.html">[rabbitmq-discuss] Multiple consumers and queue subscription
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9147">[ date ]</a>
              <a href="thread.html#9147">[ thread ]</a>
              <a href="subject.html#9147">[ subject ]</a>
              <a href="author.html#9147">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
