<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Delay delivering messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Delay%20delivering%20messages&In-Reply-To=%3CAANLkTim6_srrRBO8qDwOHFHHPx7ZyBWqZpr%2BpA54Pqpb%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008992.html">
   <LINK REL="Next"  HREF="009019.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Delay delivering messages</H1>
    <B>Michael Burns</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Delay%20delivering%20messages&In-Reply-To=%3CAANLkTim6_srrRBO8qDwOHFHHPx7ZyBWqZpr%2BpA54Pqpb%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Delay delivering messages">michaelburns1 at gmail.com
       </A><BR>
    <I>Tue Sep 21 13:13:57 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008992.html">[rabbitmq-discuss] Delay delivering messages
</A></li>
        <LI>Next message: <A HREF="009019.html">[rabbitmq-discuss] Delay delivering messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9018">[ date ]</a>
              <a href="thread.html#9018">[ thread ]</a>
              <a href="subject.html#9018">[ subject ]</a>
              <a href="author.html#9018">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I've ran tcpdump on the consumer machine when the problem is occurring. The
Java process running the consumer has definitely gone. list_connections on
the broker shows there is still a connection:

The output of tcpdump:

11:55:15.277607 IP 192.168.2.64.59061 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
1777345129:1777345331, ack 955208465, win 33304, options [nop,nop,TS val
609354052 ecr 6381321], length 202
11:55:30.103223 IP 192.168.2.64.59048 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
3156241994:3156242015, ack 938385998, win 33304, options [nop,nop,TS val
609354200 ecr 6382341], length 21
11:56:19.384882 IP 192.168.2.64.59061 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:202, ack 1, win 33304, options [nop,nop,TS val 609354692 ecr 6381321],
length 202
11:56:34.208833 IP 192.168.2.64.59048 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:21, ack 1, win 33304, options [nop,nop,TS val 609354840 ecr 6382341],
length 21
11:57:23.489908 IP 192.168.2.64.59061 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:202, ack 1, win 33304, options [nop,nop,TS val 609355332 ecr 6381321],
length 202
11:57:38.313950 IP 192.168.2.64.59048 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:21, ack 1, win 33304, options [nop,nop,TS val 609355480 ecr 6382341],
length 21
11:58:27.594809 IP 192.168.2.64.59061 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:202, ack 1, win 33304, options [nop,nop,TS val 609355972 ecr 6381321],
length 202
11:58:42.417220 IP 192.168.2.64.59048 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:21, ack 1, win 33304, options [nop,nop,TS val 609356120 ecr 6382341],
length 21
11:59:31.693171 IP 192.168.2.64.59061 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:202, ack 1, win 33304, options [nop,nop,TS val 609356612 ecr 6381321],
length 202
11:59:46.516762 IP 192.168.2.64.59048 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:21, ack 1, win 33304, options [nop,nop,TS val 609356760 ecr 6382341],
length 21
12:00:35.791504 IP 192.168.2.64.59061 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [R.], seq 203,
ack 1, win 33304, length 0
12:00:50.614290 IP 192.168.2.64.59048 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [FP.], seq
0:21, ack 1, win 33304, options [nop,nop,TS val 609357400 ecr 6382341],
length 21
12:01:54.714736 IP 192.168.2.64.59048 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [R.], seq 22,
ack 1, win 33304, length 0
12:20:38.475816 IP 192.168.2.56.51686 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
1037575082:1037575118, ack 26733943, win 65535, options [nop,nop,TS val
115719776 ecr 11565352], length 36
12:20:38.475824 IP 192.168.2.56.51686 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
36:252, ack 1, win 65535, options [nop,nop,TS val 115719776 ecr 11565352],
length 216
12:20:38.476098 IP 192.168.2.56.51686 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
252:288, ack 1, win 65535, options [nop,nop,TS val 115719776 ecr 11565352],
length 36
12:20:38.476112 IP 192.168.2.56.51686 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
288:543, ack 1, win 65535, options [nop,nop,TS val 115719776 ecr 11565352],
length 255
12:20:38.494336 IP 192.168.2.56.51683 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [.], ack
14626648, win 65535, options [nop,nop,TS val 115719776 ecr 14886791], length
0
12:20:38.494473 IP 192.168.2.56.51683 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [.], ack 332,
win 65535, options [nop,nop,TS val 115719776 ecr 14886791], length 0
12:20:38.597240 IP 192.168.2.56.51683 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
0:21, ack 332, win 65535, options [nop,nop,TS val 115719777 ecr 14886791],
length 21
12:20:38.665082 IP 192.168.2.56.51683 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
21:42, ack 332, win 65535, options [nop,nop,TS val 115719777 ecr 14886911],
length 21
12:22:11.371665 IP 192.168.2.56.51686 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
543:579, ack 1, win 65535, options [nop,nop,TS val 115720704 ecr 14886791],
length 36
12:22:11.371673 IP 192.168.2.56.51686 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
579:834, ack 1, win 65535, options [nop,nop,TS val 115720704 ecr 14886791],
length 255
12:22:11.388416 IP 192.168.2.56.51683 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [.], ack 663,
win 65535, options [nop,nop,TS val 115720704 ecr 14979686], length 0
12:22:11.486539 IP 192.168.2.56.51683 &gt;
ec2-79-125-24-245.eu-west-1.compute.amazonaws.com.amqp: Flags [P.], seq
42:63, ack 663, win 65535, options [nop,nop,TS val 115720705 ecr 14979686],
length 21

The consumer was shutdown at approx 11.50. More than an hour later I am
still seeing the connection on the broker.

Thanks,
Michael







On Sat, Sep 18, 2010 at 11:34 PM, Matthew Sackman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at rabbitmq.com</A>&gt;wrote:

&gt;<i> On Thu, Sep 16, 2010 at 09:01:17AM +0100, Michael Burns wrote:
</I>&gt;<i> &gt; I've noticed sometimes that there are extra connections hanging about on
</I>&gt;<i> the
</I>&gt;<i> &gt; RabbitMQ broker (using rabbitmqctl  list_connections).
</I>&gt;<i> &gt; It's possible sometimes in our consumers that we are not always closing
</I>&gt;<i> the
</I>&gt;<i> &gt; connection cleanly (sometimes people are simply killing their app rather
</I>&gt;<i> &gt; than shutting down cleanly).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Could this somehow explain why we experience these delays?
</I>&gt;<i>
</I>&gt;<i> Yes. If the TCP socket is still alive then Rabbit will not believe the
</I>&gt;<i> connection has died, and so will not make unacknowledged messages
</I>&gt;<i> available to other consumers.
</I>&gt;<i>
</I>&gt;<i> It would seem that this is your problem. To ensure that the connection
</I>&gt;<i> is promptly detected to be detached, you could either turn on AMQP
</I>&gt;<i> heartbeats or TCP KeepAlive. Either should suffice.
</I>&gt;<i>
</I>&gt;<i> Matthew
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100921/897868e7/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100921/897868e7/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008992.html">[rabbitmq-discuss] Delay delivering messages
</A></li>
	<LI>Next message: <A HREF="009019.html">[rabbitmq-discuss] Delay delivering messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9018">[ date ]</a>
              <a href="thread.html#9018">[ thread ]</a>
              <a href="subject.html#9018">[ subject ]</a>
              <a href="author.html#9018">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
