<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Erlang crashes reports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20reports&In-Reply-To=%3C2A9BDBE0-F31E-407D-8AFE-2EAB42D1A8C6%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008969.html">
   <LINK REL="Next"  HREF="008968.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Erlang crashes reports</H1>
    <B>romary.kremer at gmail.com</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20reports&In-Reply-To=%3C2A9BDBE0-F31E-407D-8AFE-2EAB42D1A8C6%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Erlang crashes reports">romary.kremer at gmail.com
       </A><BR>
    <I>Tue Sep 21 08:03:18 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008969.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
        <LI>Next message: <A HREF="008968.html">[rabbitmq-discuss]  How to use Consumer as Producer in rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9015">[ date ]</a>
              <a href="thread.html#9015">[ thread ]</a>
              <a href="subject.html#9015">[ subject ]</a>
              <a href="author.html#9015">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Emile, thanks for the supports and the suggestions.

Le 17 sept. 10 &#224; 11:11, Emile Joubert a &#233;crit :

&gt;<i>
</I>&gt;<i> Hi Romary,
</I>&gt;<i>
</I>&gt;<i> On 16/09/10 16:38, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">romary.kremer at gmail.com</A> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Le 16 sept. 10 &#224; 16:27, Emile Joubert a &#233;crit :
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi Romary,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 16/09/10 14:54, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">romary.kremer at gmail.com</A> wrote:
</I>&gt;&gt;&gt;&gt;<i> Well, I' ve done another run with the whole upgraded configuration
</I>&gt;&gt;&gt;&gt;<i> - RabbitMQ version 2.1.0
</I>&gt;&gt;&gt;&gt;<i> - Erlang R14B (version 5.8.1)
</I>&gt;&gt;&gt;&gt;<i> - No SSL connections (but SSL listener still active on the  
</I>&gt;&gt;&gt;&gt;<i> broker, not
</I>&gt;&gt;&gt;&gt;<i> used)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The memory_high_watermark is set to 0.8, 80% equivalent to 1609  
</I>&gt;&gt;&gt;&gt;<i> MB !
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> That is too high. It is not advised to set the highwater mark  
</I>&gt;&gt;&gt;<i> above 50%.
</I>&gt;&gt;&gt;<i> Can you reproduce the problem while the vm_memory_high_watermark  
</I>&gt;&gt;&gt;<i> is set
</I>&gt;&gt;&gt;<i> to 0.4 ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Since we started to investigate on RabbitMQ, we started (with version
</I>&gt;&gt;<i> 1.7.2) we have never been able to successfully open
</I>&gt;&gt;<i> 10 000 SSL connection with a watermark less that 0.8 (1609 MB) !
</I>&gt;<i>
</I>&gt;<i> If you need to set the highwater mark above 50% then it means your
</I>&gt;<i> server should have more RAM. Are you able to execute the test on a
</I>&gt;<i> server with 4Gb or more?
</I>&gt;<i>
</I>&gt;&gt;<i> The fact is that with 1.7.2 and 1.8.x  we successfully managed to  
</I>&gt;&gt;<i> accept
</I>&gt;&gt;<i> 10 000 connections, without SSL, with the default watermark of 0.4
</I>&gt;&gt;<i> Let me get back into the past to persent the history :
</I>&gt;&gt;<i>    - we started with default setting of rabbitMQ 1.7.2, with a  
</I>&gt;&gt;<i> version
</I>&gt;&gt;<i> that does not use  SSL. It works fine.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - Then our requirements evolved, and we decided that peers must
</I>&gt;&gt;<i> authenticate the borker upon connection, so we started to  
</I>&gt;&gt;<i> investigate on
</I>&gt;&gt;<i> the use of SSL.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - From that point, we could not manage a successful run unless we
</I>&gt;&gt;<i> increase the watermark up to 0.8.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - Now we upgrade to version 2.x.x of RabbitMQ and we realize that
</I>&gt;&gt;<i> the application that used to work on 1.8.0, with SSL no longer work  
</I>&gt;&gt;<i> on
</I>&gt;&gt;<i> the 2.0.0, neither on 2.1.0.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - That's why we decided to run the same test, disabling the SSL
</I>&gt;&gt;<i> authentication, and the same issues happens again either on 2.0.0  
</I>&gt;&gt;<i> or 2.1.0.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I've monitored with rabbit_status, even someone had advised not  
</I>&gt;&gt;&gt;&gt;<i> to while
</I>&gt;&gt;&gt;&gt;<i> benchmarking (why not ?)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> rabbitmqctl or rabbit_status are invaluable for debugging the kind  
</I>&gt;&gt;&gt;<i> of
</I>&gt;&gt;&gt;<i> problem you are reporting. Continuous use incurs a small performance
</I>&gt;&gt;&gt;<i> penalty and can prevent quiescent resources from hibernating.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then what would you recommend us for monitoring the broker a bit less
</I>&gt;&gt;<i> intrusively ?
</I>&gt;<i>
</I>&gt;<i> I *would* recommend using rabbitmqctl.
</I>&gt;<i>
</I>&gt;&gt;<i> Actually, in our environment, we have settled a set of tool to  
</I>&gt;&gt;<i> monitor
</I>&gt;&gt;<i> the CPU load and the overall memory of the rabbitMQ erlang process.  
</I>&gt;&gt;<i> For
</I>&gt;&gt;<i> that we use the UNIX built in tools
</I>&gt;&gt;<i> such as sar, netstat, and ps with option to see the memory occupied.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We also monitor the queue depth by invoking rabbitmq_ctl list_queues,
</I>&gt;&gt;<i> but the problem occurs also whit that monitoring turned OFF !!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After a test, we are able to built some graphics displaying the
</I>&gt;&gt;<i> different statistics monitored.
</I>&gt;&gt;<i> If you want, I can send you extract of these reports so you will have
</I>&gt;&gt;<i> better overview on how the broker behave during tests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Just to have a look, I join you the following snapshots :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - S0_withSSL_withQueueMonitoring : shows the broker behaviour while
</I>&gt;&gt;<i> trying to connect 10 000 peers, with SSL
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - S0_noSSL_withQueueMonitoring : shows the broker behaviour while  
</I>&gt;&gt;<i> trying
</I>&gt;&gt;<i> to connect 10 000 peers wihtout SSL
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - S0_noSSL_noQueueMonitoring : shows the broker behaviour while  
</I>&gt;&gt;<i> trying
</I>&gt;&gt;<i> to connect 10 000 peers without SSL, and without periodic call to
</I>&gt;&gt;<i> rabbitmqctl list_queues
</I>&gt;<i>
</I>&gt;<i> These graphs show that you create the connections at a fast rate. Do  
</I>&gt;<i> you
</I>&gt;<i> get the same failure if you create connections at a lower rate?
</I>
We have a ramp up scenario to evaluate the kind of thing you're  
thinking of. the same
crashes occurs the same way about 4000 connections established.

&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The memory available raised the threshold before the end of  
</I>&gt;&gt;&gt;&gt;<i> connections
</I>&gt;&gt;&gt;&gt;<i> of 10 000 peers.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Maybe the average memory occupied by a single, non SSL connection  
</I>&gt;&gt;&gt;&gt;<i> has
</I>&gt;&gt;&gt;&gt;<i> somehow get bigger between
</I>&gt;&gt;&gt;&gt;<i> release 1.8.x and 2.x.x ??
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The data structures have changed from 1.8.1 to 2.0.0, but I don't  
</I>&gt;&gt;&gt;<i> think
</I>&gt;&gt;&gt;<i> that is the cause of the problem.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Does anybody has experiment or knows the impact of the new  
</I>&gt;&gt;&gt;&gt;<i> release on
</I>&gt;&gt;&gt;&gt;<i> the memory occupied by connections ?
</I>&gt;<i>
</I>&gt;<i> It is possible that more memory is required per connection, If using a
</I>&gt;<i> large number of connections caused your RAM budget to be approached in
</I>&gt;<i> versions prior to 2.0.0 then you may now exceed it.
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I insist in the fact that, in our environment, we can toggle SSL
</I>&gt;&gt;&gt;&gt;<i> authentication of the broker by peers, but we always
</I>&gt;&gt;&gt;&gt;<i> keep the SSL listener running on the broker. The peer just  
</I>&gt;&gt;&gt;&gt;<i> &quot;decide&quot; to
</I>&gt;&gt;&gt;&gt;<i> connect either on 5672 or 5671. In the later,
</I>&gt;&gt;&gt;&gt;<i> SSL authentication will be enable, in the former, it won't !
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thanks for any other idea we can follow, because we are facing a  
</I>&gt;&gt;&gt;&gt;<i> bit of
</I>&gt;&gt;&gt;&gt;<i> a dead end since we upgraded to 2.x.x !
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm surprised that the logfile you posted previously stops after  
</I>&gt;&gt;&gt;<i> opening
</I>&gt;&gt;&gt;<i> ssl and tcp listeners. I would expect to see evidence of 4000+  
</I>&gt;&gt;&gt;<i> clients
</I>&gt;&gt;&gt;<i> connecting.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes sorry for that, but it indeed contains those line for connection
</I>&gt;&gt;<i> accepted / started, but noting interesting after that. Basically we  
</I>&gt;&gt;<i> jump
</I>&gt;&gt;<i> from a series of connection started
</I>&gt;&gt;<i> to a series of connection stopped, without no other warning, nor  
</I>&gt;&gt;<i> error,
</I>&gt;&gt;<i> until the end of the log file.
</I>&gt;<i>
</I>&gt;<i> That is very strange. I would expect to see evidence of the server
</I>&gt;<i> running out of memory.
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> Are you able to get output from &quot;rabbitmqctl list_connections&quot;  
</I>&gt;&gt;&gt;<i> before
</I>&gt;&gt;&gt;<i> the broker becomes unresponsive? What is the status of the beam or
</I>&gt;&gt;&gt;<i> beam.smp process at that point - is it still running? How much  
</I>&gt;&gt;&gt;<i> memory
</I>&gt;&gt;&gt;<i> and CPU is it consuming?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Those information can be gathered by our own &quot;monitoring framework&quot;  
</I>&gt;&gt;<i> as
</I>&gt;&gt;<i> explained above. But as you said just before, the rabbitmq_ctl may be
</I>&gt;&gt;<i> too intrusive, we use netstat to list the
</I>&gt;&gt;<i> established connection on the port 5672 (5671 if SSL is turned ON).
</I>&gt;<i>
</I>&gt;<i> rabbitmqctl does incur a small performance penalty if run continuously
</I>&gt;<i> and it may then prevent unused resources from hibernating. However it
</I>&gt;<i> was designed precisely to investigate the kind of problem you are
</I>&gt;<i> experiencing.
</I>
I have double checked that the same issue happens,even with no  
monitoring
with rabbitmqctl.

&gt;<i>
</I>&gt;<i> Can you confirm whether the beam or beam.smp process is running after
</I>&gt;<i> the test failed?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards
</I>&gt;<i>
</I>&gt;<i> Emile
</I>
We are a bit of worry considering that all the propositions we get to  
fix this issue are
related to give the broker more memory, while we thought the purpose  
of the 2.x.x
was to allow the broker to rely more on disk. Moreover, we are  
wondering what have
caused a connection to be so greedy that we can no longer establish 10  
000 on the same
configuration.

Since we do not have a 4GB server available to run the same tests,  
and, as we have quite
short dead line to set up a field test, we are considering to get back  
using the rabbitMQ release 1.8.1,
with Erlang R14B, hopping that this would be the winning combinaison.

Best regards,

Romary.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008969.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
	<LI>Next message: <A HREF="008968.html">[rabbitmq-discuss]  How to use Consumer as Producer in rabbitmq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9015">[ date ]</a>
              <a href="thread.html#9015">[ thread ]</a>
              <a href="subject.html#9015">[ subject ]</a>
              <a href="author.html#9015">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
