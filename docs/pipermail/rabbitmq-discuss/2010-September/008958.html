<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] flow control issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20flow%20control%20issues&In-Reply-To=%3CAANLkTimz26CrRRVKcvX%3D%3DNGjS3o18nbEvfYm_9NH-sSU%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008940.html">
   <LINK REL="Next"  HREF="009078.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] flow control issues</H1>
    <B>Marek Majkowski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20flow%20control%20issues&In-Reply-To=%3CAANLkTimz26CrRRVKcvX%3D%3DNGjS3o18nbEvfYm_9NH-sSU%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] flow control issues">majek04 at gmail.com
       </A><BR>
    <I>Thu Sep 16 11:31:28 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008940.html">[rabbitmq-discuss] flow control issues
</A></li>
        <LI>Next message: <A HREF="009078.html">[rabbitmq-discuss] flow control issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8958">[ date ]</a>
              <a href="thread.html#8958">[ thread ]</a>
              <a href="subject.html#8958">[ subject ]</a>
              <a href="author.html#8958">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Sep 15, 2010 at 14:45, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">romary.kremer at gmail.com</A>
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">romary.kremer at gmail.com</A>&gt; wrote:
&gt;<i> since I can not find out the reasons of our problems yet, I've decided to
</I>&gt;<i> perform some more basics tests.
</I>
Hurray!

&gt;<i> To step in the memory limitations faster, I 've decreased the memory
</I>&gt;<i> watermark threshold to .05 (5%)
</I>&gt;<i> This corresponds to 50 MB on the host we are using for this test&#160;as shown on
</I>&gt;<i> the rabbit.log file upon startup of broker :
</I>&gt;<i> =INFO REPORT==== 15-Sep-2010::12:36:15 ===
</I>&gt;<i> Memory limit set to 50MB.
</I>
Hooa. 50 megs is _really_ small. Probably more than half of it is
taken by Erlang
internals, really not much is left for Rabbit!
It's hard to say what is the minimal sensible memory allowance, but I'd guess
not less than 150 megs. Probably even 250 megs if you do anything non-trivial.

In your  50megs setup you may run into situation when once the memory
alarm goes on it _never_ goes off. That would mean you won't be able
to publish any message.


&gt;<i> Finally the broker status description (rabbitmqctl status)
</I>&gt;<i> [{running_applications,[{rabbit_status,&quot;RabbitMQ Status Page&quot;,&quot;0.01&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{rabbit,&quot;RabbitMQ&quot;,&quot;2.0.0&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{ssl,&quot;Erlang/OTP SSL application&quot;,&quot;3.10.7&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {public_key,&quot;Public key infrastructure&quot;,&quot;0.4&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {mnesia,&quot;MNESIA &#160;CXC 138 12&quot;,&quot;4.4.12&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {os_mon,&quot;CPO &#160;CXC 138 46&quot;,&quot;2.2.4&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {sasl,&quot;SASL &#160;CXC 138 11&quot;,&quot;2.1.8&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {rabbit_mochiweb,&quot;RabbitMQ Mochiweb
</I>&gt;<i> Embedding&quot;,&quot;0.01&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;1.3&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {crypto,&quot;CRYPTO version 1&quot;,&quot;1.6.3&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {inets,&quot;INETS &#160;CXC 138 49&quot;,&quot;5.2&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {stdlib,&quot;ERTS &#160;CXC 138 10&quot;,&quot;1.16.4&quot;},
</I>&gt;<i> &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {kernel,&quot;ERTS &#160;CXC 138 10&quot;,&quot;2.13.4&quot;}]},
</I>&gt;<i> &#160;{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mystic-buntu</A>']}]},
</I>&gt;<i> &#160; {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mystic-buntu</A>']}]
</I>
Ok. For testing and benchmarking I'd recommend to remove status plugin.
Status plugin (if you look at the results) constantly queries Queues, which
may in some cases make it less likely to GC/hibernate them.

The new management plugin is better and shouldn't affect the GC that much.
(though for benchmarking it's still better to disalbe all the pluigins)

&gt;<i> - The last lines in the broker log are :
</I>&gt;<i> =INFO REPORT==== 15-Sep-2010::14:53:44 === vm_memory_high_watermark set.
</I>&gt;<i> Memory used:53650536 allowed:52556595 =INFO REPORT==== 15-Sep-2010::14:53:44
</I>&gt;<i> === alarm_handler: {set,{vm_memory_high_watermark,[]}}
</I>&gt;<i> From that point, the producer is blocked without any possible recovery. As
</I>&gt;<i> the flow control is designed in v 2.0.0, I would have expected the producer
</I>&gt;<i> to be released thanks to sawp of messages to the disk.
</I>
Yes it will! But only if it has enough memory to breathe!

What has happened is that internal Erlang stuff took most of the memory,
and even if we write everything to disk we won't be able to keep the
memory usage
under the threshold.

&gt;<i> I think this behaviour is not expected and maybe that could be due to a bug
</I>&gt;<i> somewhere, since it si fully reproductible on my configuration.
</I>&gt;<i> The fact that the memory occupation never falls below the threshold after
</I>&gt;<i> message are removed from the queue is particularly strange and
</I>&gt;<i> unwilling from my point of view. It think that this simple test can points
</I>&gt;<i> out an issue that would explains the problems that I mentioned in the
</I>&gt;<i> previous messages, but not sure about it.
</I>&gt;<i> I am sorry for this quite long message, but I thought that the more details
</I>&gt;<i> you get, the better.
</I>
Few suggestions:
 - Give rabbit more memory. How much memory? That depends on your setup.
   If you run 10k of connections you need enough memory to handle those
   connections + some memory to keep messages and queues.
   If the connections will eat up all the memory - rabbit won't allow
you to publish.
 - Disable status plugin (you can try to use management plugin).
 - Try new Erlang, R14B. They claim to have fixed some memory leaks with SSL,
   so it may help.

Cheers!
  Marek
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008940.html">[rabbitmq-discuss] flow control issues
</A></li>
	<LI>Next message: <A HREF="009078.html">[rabbitmq-discuss] flow control issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8958">[ date ]</a>
              <a href="thread.html#8958">[ thread ]</a>
              <a href="subject.html#8958">[ subject ]</a>
              <a href="author.html#8958">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
