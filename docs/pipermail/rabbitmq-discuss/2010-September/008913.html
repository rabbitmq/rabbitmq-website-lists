<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 2.0 hanging
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%202.0%20hanging&In-Reply-To=%3C4C8FC962.2040401%40cynigram.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008910.html">
   <LINK REL="Next"  HREF="008914.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 2.0 hanging</H1>
    <B>Noah Fontes</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%202.0%20hanging&In-Reply-To=%3C4C8FC962.2040401%40cynigram.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ 2.0 hanging">nfontes at cynigram.com
       </A><BR>
    <I>Tue Sep 14 20:13:38 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008910.html">[rabbitmq-discuss] RabbitMQ 2.0 hanging
</A></li>
        <LI>Next message: <A HREF="008914.html">[rabbitmq-discuss] RabbitMQ 2.0 hanging
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8913">[ date ]</a>
              <a href="thread.html#8913">[ thread ]</a>
              <a href="subject.html#8913">[ subject ]</a>
              <a href="author.html#8913">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hello Dave,

On 09/14/2010 10:11 AM, Dave Greggory wrote:
&gt;<i> So it happened again this morning. 
</I>&gt;<i> 
</I>&gt;<i> rabbitmqctl status, list_connections and list_exchanges worked, but list_queues 
</I>&gt;<i> and list_channels hung.
</I>&gt;<i> 
</I>&gt;<i> This time there were no errors in the log, unlike the last time. This has been 
</I>&gt;<i> quite common, that when it happens there's nothing in the logs. That's why I 
</I>&gt;<i> didn't report it any earlier. Very mysterious.
</I>
This is quite interesting. We observed this behavior as well --
list_queues and list_channels hanging. This was also reflected in
consumers/publishers: we could publish messages fine, but trying to read
from a queue (or even delete one) would hang usually indefinitely.

We also noted that if we repeatedly attempted to run list_queues the RPC
call would eventually succeed -- maybe once out of 10 or 15 runs. With
the exception of certain queues building up with messages (as I
mentioned above) everything looked fine.

It started when we switched from 1.7.x to 1.8.x (which we're still
running for the moment). It only seems to happen when nodes are
clustered; I've never seen the problem on a non-clustered instance.

I'll try to grab some more information when/if it happens again for us.

I also haven't seen the issue occur in probably about 3 weeks now. It's
very sporadic, although I think I've seen it happen more than once in a
day (and then not again for a long time).

&gt;<i> I have attached the output of status, list_connections, dmesg, and lsof from 
</I>&gt;<i> both rabbitmq nodes in the cluster.
</I>
FWIW, here's the minimal information I can offer now:

- - We have a four-node cluster of two disk nodes and two memory nodes
across two physical servers.
- - We're running RabbitMQ 1.8.1 with no additional plugins:
{rabbit,&quot;RabbitMQ&quot;,&quot;1.8.1&quot;},
{mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.4.13&quot;},
{os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.5&quot;},
{sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.9&quot;},
{stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.16.5&quot;},
{kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.13.5&quot;}

This is erlang R13B04 on SuSE Linux.

Hopefully this can shed a *little* more light on the problem. Sorry I
can't offer more details at the moment.

Regards,

Noah

&gt;<i> ----- Original Message ----
</I>&gt;<i> From: Dave Greggory &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">davegreggory at yahoo.com</A>&gt;
</I>&gt;<i> To: Matthew Sackman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at rabbitmq.com</A>&gt;; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> Sent: Mon, September 13, 2010 11:48:44 AM
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] RabbitMQ 2.0 hanging
</I>&gt;<i> 
</I>&gt;<i> Wow... ok.
</I>&gt;<i> 
</I>&gt;<i> I'll grab lsof / dmesg / syslog output next time this happens.
</I>&gt;<i> 
</I>&gt;<i> Thanks for looking into it. Much appreciated.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----- Original Message ----
</I>&gt;<i> From: Matthew Sackman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at rabbitmq.com</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> Sent: Mon, September 13, 2010 10:53:24 AM
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] RabbitMQ 2.0 hanging
</I>&gt;<i> 
</I>&gt;<i> Hi Dave,
</I>&gt;<i> 
</I>&gt;<i> Sorry for the delay in getting back to you.
</I>&gt;<i> 
</I>&gt;<i> Your node1 log had this in it:
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 8-Sep-2010::09:45:43 ===
</I>&gt;<i> ** Generic server &lt;0.29.0&gt; terminating
</I>&gt;<i> ** Last message in was {'EXIT',&lt;0.30.0&gt;,eio}
</I>&gt;<i> ** When Server state == {state,user_sup,undefined,&lt;0.30.0&gt;,
</I>&gt;<i>                                {&lt;0.29.0&gt;,user_sup}}
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** eio
</I>&gt;<i> 
</I>&gt;<i> This is utterly bizarre - we've never seen it before and it was
</I>&gt;<i> certainly enough to take down the node1 or at least hang it.
</I>&gt;<i> 
</I>&gt;<i> node2 log has:
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 8-Sep-2010::09:41:38 ===
</I>&gt;<i> ** Generic server delegate_process_0 terminating
</I>&gt;<i> ** Last message in was {'$gen_cast',{thunk,#Fun&lt;delegate.4.123807736&gt;}}
</I>&gt;<i> ** When Server state == no_state
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** {noproc,{gen_server2,call,
</I>&gt;<i>                         [{delegate_process_1,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ent-jms-qa-1</A>'},
</I>&gt;<i>                          {thunk,#Fun&lt;delegate.5.131821234&gt;},
</I>&gt;<i>                          infinity]}}
</I>&gt;<i> 
</I>&gt;<i> This is basically node2 finding that node1 has gone down. This suggests
</I>&gt;<i> (as does your timeline) that node1 actually failed some time previously
</I>&gt;<i> but that the immediate error was not logged and only at some later point
</I>&gt;<i> did a very generic &quot;eio&quot; come out of it - literally error in some form
</I>&gt;<i> of IO operation.
</I>&gt;<i> 
</I>&gt;<i> Now the eio comes out of process &lt;0.30.0&gt; which is a process which is
</I>&gt;<i> started very early on in the Erlang VM boot process. I can't quite tell
</I>&gt;<i> what the user_sup process is meant to be doing - it's so far buried that
</I>&gt;<i> there's no documentation for it. It's quite possible you've found a bug
</I>&gt;<i> in Erlang itself. Even having googled around for a while, I still can't
</I>&gt;<i> really find out what &quot;user&quot; is for - the best I can find is:
</I>&gt;<i> &quot;user is a server which responds to all the messages defined in the I/O
</I>&gt;<i> interface. The code in user.erl can be used as a model for building
</I>&gt;<i> alternative I/O servers.&quot; so that's nice and clear. Anyway, my guess is
</I>&gt;<i> some error came out of said I/O server, took out user and user_sup which
</I>&gt;<i> was then logged. But as to what the fault actually was, I'm afraid I
</I>&gt;<i> have no idea.
</I>&gt;<i> 
</I>&gt;<i> When this next happens, any chance you could check things like number of
</I>&gt;<i> open file descriptors, see if there's any kernel log messages relevant
</I>&gt;<i> etc? Sorry I can't be more helpful - it's just not something we've ever
</I>&gt;<i> come across before.
</I>&gt;<i> 
</I>&gt;<i> Matthew
</I>-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)

iEYEARECAAYFAkyPyWEACgkQhitK+HuUQJRLpwCgnYY/YF8xTUW8xowocWKKPzbJ
BzUAn1aRtruRAgp/23v4mZB1JJXrBIaE
=CEzP
-----END PGP SIGNATURE-----
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008910.html">[rabbitmq-discuss] RabbitMQ 2.0 hanging
</A></li>
	<LI>Next message: <A HREF="008914.html">[rabbitmq-discuss] RabbitMQ 2.0 hanging
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8913">[ date ]</a>
              <a href="thread.html#8913">[ thread ]</a>
              <a href="subject.html#8913">[ subject ]</a>
              <a href="author.html#8913">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
