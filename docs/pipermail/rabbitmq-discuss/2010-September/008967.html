<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Erlang crashes reports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20reports&In-Reply-To=%3C5F60E536-780F-442A-A8DD-A7FAE0B711FA%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008966.html">
   <LINK REL="Next"  HREF="008969.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Erlang crashes reports</H1>
    <B>romary.kremer at gmail.com</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20reports&In-Reply-To=%3C5F60E536-780F-442A-A8DD-A7FAE0B711FA%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Erlang crashes reports">romary.kremer at gmail.com
       </A><BR>
    <I>Thu Sep 16 16:38:53 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008966.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
        <LI>Next message: <A HREF="008969.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8967">[ date ]</a>
              <a href="thread.html#8967">[ thread ]</a>
              <a href="subject.html#8967">[ subject ]</a>
              <a href="author.html#8967">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Le 16 sept. 10 &#224; 16:27, Emile Joubert a &#233;crit :

&gt;<i>
</I>&gt;<i> Hi Romary,
</I>&gt;<i>
</I>&gt;<i> On 16/09/10 14:54, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">romary.kremer at gmail.com</A> wrote:
</I>&gt;&gt;<i> Well, I' ve done another run with the whole upgraded configuration
</I>&gt;&gt;<i> - RabbitMQ version 2.1.0
</I>&gt;&gt;<i> - Erlang R14B (version 5.8.1)
</I>&gt;&gt;<i> - No SSL connections (but SSL listener still active on the broker,  
</I>&gt;&gt;<i> not
</I>&gt;&gt;<i> used)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The memory_high_watermark is set to 0.8, 80% equivalent to 1609 MB !
</I>&gt;<i>
</I>&gt;<i> That is too high. It is not advised to set the highwater mark above  
</I>&gt;<i> 50%.
</I>&gt;<i> Can you reproduce the problem while the vm_memory_high_watermark is  
</I>&gt;<i> set
</I>&gt;<i> to 0.4 ?
</I>
Since we started to investigate on RabbitMQ, we started (with version  
1.7.2) we have never been able to successfully open
10 000 SSL connection with a watermark less that 0.8 (1609 MB) !

The fact is that with 1.7.2 and 1.8.x  we successfully managed to  
accept 10 000 connections, without SSL, with the default watermark of  
0.4
Let me get back into the past to persent the history :
	- we started with default setting of rabbitMQ 1.7.2, with a version  
that does not use  SSL. It works fine.

	- Then our requirements evolved, and we decided that peers must  
authenticate the borker upon connection, so we started to investigate  
on the use of SSL.
	
	- From that point, we could not manage a successful run unless we  
increase the watermark up to 0.8.

	- Now we upgrade to version 2.x.x of RabbitMQ and we realize that the  
application that used to work on 1.8.0, with SSL no longer work on the  
2.0.0, neither on 2.1.0.

	- That's why we decided to run the same test, disabling the SSL  
authentication, and the same issues happens again either on 2.0.0 or  
2.1.0.

&gt;<i>
</I>&gt;&gt;<i> I've monitored with rabbit_status, even someone had advised not to  
</I>&gt;&gt;<i> while
</I>&gt;&gt;<i> benchmarking (why not ?)
</I>&gt;<i>
</I>&gt;<i> rabbitmqctl or rabbit_status are invaluable for debugging the kind of
</I>&gt;<i> problem you are reporting. Continuous use incurs a small performance
</I>&gt;<i> penalty and can prevent quiescent resources from hibernating.
</I>
Then what would you recommend us for monitoring the broker a bit less  
intrusively ?
Actually, in our environment, we have settled a set of tool to monitor  
the CPU load and the overall memory of the rabbitMQ erlang process.  
For that we use the UNIX built in tools
such as sar, netstat, and ps with option to see the memory occupied.

We also monitor the queue depth by invoking rabbitmq_ctl list_queues,  
but the problem occurs also whit that monitoring turned OFF !!

After a test, we are able to built some graphics displaying the  
different statistics monitored.
If you want, I can send you extract of these reports so you will have  
better overview on how the broker behave during tests.

Just to have a look, I join you the following snapshots :

- S0_withSSL_withQueueMonitoring : shows the broker behaviour while  
trying to connect 10 000 peers, with SSL

- S0_noSSL_withQueueMonitoring : shows the broker behaviour while  
trying to connect 10 000 peers wihtout SSL

- S0_noSSL_noQueueMonitoring : shows the broker behaviour while trying  
to connect 10 000 peers without SSL, and without periodic call to  
rabbitmqctl list_queues

&gt;<i>
</I>&gt;&gt;<i> The memory available raised the threshold before the end of  
</I>&gt;&gt;<i> connections
</I>&gt;&gt;<i> of 10 000 peers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Maybe the average memory occupied by a single, non SSL connection has
</I>&gt;&gt;<i> somehow get bigger between
</I>&gt;&gt;<i> release 1.8.x and 2.x.x ??
</I>&gt;<i>
</I>&gt;<i> The data structures have changed from 1.8.1 to 2.0.0, but I don't  
</I>&gt;<i> think
</I>&gt;<i> that is the cause of the problem.
</I>&gt;<i>
</I>&gt;&gt;<i> Does anybody has experiment or knows the impact of the new release on
</I>&gt;&gt;<i> the memory occupied by connections ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I insist in the fact that, in our environment, we can toggle SSL
</I>&gt;&gt;<i> authentication of the broker by peers, but we always
</I>&gt;&gt;<i> keep the SSL listener running on the broker. The peer just &quot;decide&quot;  
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> connect either on 5672 or 5671. In the later,
</I>&gt;&gt;<i> SSL authentication will be enable, in the former, it won't !
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for any other idea we can follow, because we are facing a  
</I>&gt;&gt;<i> bit of
</I>&gt;&gt;<i> a dead end since we upgraded to 2.x.x !
</I>&gt;<i>
</I>&gt;<i> I'm surprised that the logfile you posted previously stops after  
</I>&gt;<i> opening
</I>&gt;<i> ssl and tcp listeners. I would expect to see evidence of 4000+ clients
</I>&gt;<i> connecting.
</I>
Yes sorry for that, but it indeed contains those line for connection  
accepted / started, but noting interesting after that. Basically we  
jump from a series of connection started
to a series of connection stopped, without no other warning, nor  
error, until the end of the log file.

&gt;<i>
</I>&gt;<i> Are you able to get output from &quot;rabbitmqctl list_connections&quot; before
</I>&gt;<i> the broker becomes unresponsive? What is the status of the beam or
</I>&gt;<i> beam.smp process at that point - is it still running? How much memory
</I>&gt;<i> and CPU is it consuming?
</I>
Those information can be gathered by our own &quot;monitoring framework&quot; as  
explained above. But as you said just before, the rabbitmq_ctl may be  
too intrusive, we use netstat to list the
established connection on the port 5672 (5671 if SSL is turned ON).

Thanks for the support again !

Best regards,

Romary.

See attach files :
-------------- next part --------------
A non-text attachment was scrubbed...
Name: S0_noSSL_noQueueMonitoring.jpg
Type: image/jpeg
Size: 41106 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100916/7d6db30f/attachment-0003.jpg">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100916/7d6db30f/attachment-0003.jpg</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: S0_noSSL_withQueueMonitoring.jpg
Type: image/jpeg
Size: 52748 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100916/7d6db30f/attachment-0004.jpg">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100916/7d6db30f/attachment-0004.jpg</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: S0_withSSL_withQueueMonitoring.jpg
Type: image/jpeg
Size: 55918 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100916/7d6db30f/attachment-0005.jpg">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100916/7d6db30f/attachment-0005.jpg</A>&gt;
-------------- next part --------------

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards
</I>&gt;<i>
</I>&gt;<i> Emile
</I>
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008966.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
	<LI>Next message: <A HREF="008969.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8967">[ date ]</a>
              <a href="thread.html#8967">[ thread ]</a>
              <a href="subject.html#8967">[ subject ]</a>
              <a href="author.html#8967">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
