<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Erlang crashes reports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20reports&In-Reply-To=%3C4C9330CA.6090800%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008967.html">
   <LINK REL="Next"  HREF="009016.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Erlang crashes reports</H1>
    <B>Emile Joubert</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Erlang%20crashes%20reports&In-Reply-To=%3C4C9330CA.6090800%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Erlang crashes reports">emile at rabbitmq.com
       </A><BR>
    <I>Fri Sep 17 10:11:38 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008967.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
        <LI>Next message: <A HREF="009016.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8969">[ date ]</a>
              <a href="thread.html#8969">[ thread ]</a>
              <a href="subject.html#8969">[ subject ]</a>
              <a href="author.html#8969">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Romary,

On 16/09/10 16:38, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">romary.kremer at gmail.com</A> wrote:
&gt;<i> 
</I>&gt;<i> Le 16 sept. 10 &#224; 16:27, Emile Joubert a &#233;crit :
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Romary,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 16/09/10 14:54, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">romary.kremer at gmail.com</A> wrote:
</I>&gt;&gt;&gt;<i> Well, I' ve done another run with the whole upgraded configuration
</I>&gt;&gt;&gt;<i> - RabbitMQ version 2.1.0
</I>&gt;&gt;&gt;<i> - Erlang R14B (version 5.8.1)
</I>&gt;&gt;&gt;<i> - No SSL connections (but SSL listener still active on the broker, not
</I>&gt;&gt;&gt;<i> used)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The memory_high_watermark is set to 0.8, 80% equivalent to 1609 MB !
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is too high. It is not advised to set the highwater mark above 50%.
</I>&gt;&gt;<i> Can you reproduce the problem while the vm_memory_high_watermark is set
</I>&gt;&gt;<i> to 0.4 ?
</I>&gt;<i> 
</I>&gt;<i> Since we started to investigate on RabbitMQ, we started (with version
</I>&gt;<i> 1.7.2) we have never been able to successfully open
</I>&gt;<i> 10 000 SSL connection with a watermark less that 0.8 (1609 MB) !
</I>
If you need to set the highwater mark above 50% then it means your
server should have more RAM. Are you able to execute the test on a
server with 4Gb or more?

&gt;<i> The fact is that with 1.7.2 and 1.8.x  we successfully managed to accept
</I>&gt;<i> 10 000 connections, without SSL, with the default watermark of 0.4
</I>&gt;<i> Let me get back into the past to persent the history :
</I>&gt;<i>     - we started with default setting of rabbitMQ 1.7.2, with a version
</I>&gt;<i> that does not use  SSL. It works fine.
</I>&gt;<i> 
</I>&gt;<i>     - Then our requirements evolved, and we decided that peers must
</I>&gt;<i> authenticate the borker upon connection, so we started to investigate on
</I>&gt;<i> the use of SSL.
</I>&gt;<i>     
</I>&gt;<i>     - From that point, we could not manage a successful run unless we
</I>&gt;<i> increase the watermark up to 0.8.
</I>&gt;<i> 
</I>&gt;<i>     - Now we upgrade to version 2.x.x of RabbitMQ and we realize that
</I>&gt;<i> the application that used to work on 1.8.0, with SSL no longer work on
</I>&gt;<i> the 2.0.0, neither on 2.1.0.
</I>&gt;<i> 
</I>&gt;<i>     - That's why we decided to run the same test, disabling the SSL
</I>&gt;<i> authentication, and the same issues happens again either on 2.0.0 or 2.1.0.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've monitored with rabbit_status, even someone had advised not to while
</I>&gt;&gt;&gt;<i> benchmarking (why not ?)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbitmqctl or rabbit_status are invaluable for debugging the kind of
</I>&gt;&gt;<i> problem you are reporting. Continuous use incurs a small performance
</I>&gt;&gt;<i> penalty and can prevent quiescent resources from hibernating.
</I>&gt;<i> 
</I>&gt;<i> Then what would you recommend us for monitoring the broker a bit less
</I>&gt;<i> intrusively ?
</I>
I *would* recommend using rabbitmqctl.

&gt;<i> Actually, in our environment, we have settled a set of tool to monitor
</I>&gt;<i> the CPU load and the overall memory of the rabbitMQ erlang process. For
</I>&gt;<i> that we use the UNIX built in tools
</I>&gt;<i> such as sar, netstat, and ps with option to see the memory occupied.
</I>&gt;<i> 
</I>&gt;<i> We also monitor the queue depth by invoking rabbitmq_ctl list_queues,
</I>&gt;<i> but the problem occurs also whit that monitoring turned OFF !!
</I>&gt;<i> 
</I>&gt;<i> After a test, we are able to built some graphics displaying the
</I>&gt;<i> different statistics monitored.
</I>&gt;<i> If you want, I can send you extract of these reports so you will have
</I>&gt;<i> better overview on how the broker behave during tests.
</I>&gt;<i> 
</I>&gt;<i> Just to have a look, I join you the following snapshots :
</I>&gt;<i> 
</I>&gt;<i> - S0_withSSL_withQueueMonitoring : shows the broker behaviour while
</I>&gt;<i> trying to connect 10 000 peers, with SSL
</I>&gt;<i> 
</I>&gt;<i> - S0_noSSL_withQueueMonitoring : shows the broker behaviour while trying
</I>&gt;<i> to connect 10 000 peers wihtout SSL
</I>&gt;<i> 
</I>&gt;<i> - S0_noSSL_noQueueMonitoring : shows the broker behaviour while trying
</I>&gt;<i> to connect 10 000 peers without SSL, and without periodic call to
</I>&gt;<i> rabbitmqctl list_queues
</I>
These graphs show that you create the connections at a fast rate. Do you
get the same failure if you create connections at a lower rate?

&gt;&gt;&gt;<i> The memory available raised the threshold before the end of connections
</I>&gt;&gt;&gt;<i> of 10 000 peers.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Maybe the average memory occupied by a single, non SSL connection has
</I>&gt;&gt;&gt;<i> somehow get bigger between
</I>&gt;&gt;&gt;<i> release 1.8.x and 2.x.x ??
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The data structures have changed from 1.8.1 to 2.0.0, but I don't think
</I>&gt;&gt;<i> that is the cause of the problem.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Does anybody has experiment or knows the impact of the new release on
</I>&gt;&gt;&gt;<i> the memory occupied by connections ?
</I>
It is possible that more memory is required per connection, If using a
large number of connections caused your RAM budget to be approached in
versions prior to 2.0.0 then you may now exceed it.

&gt;&gt;&gt;<i> I insist in the fact that, in our environment, we can toggle SSL
</I>&gt;&gt;&gt;<i> authentication of the broker by peers, but we always
</I>&gt;&gt;&gt;<i> keep the SSL listener running on the broker. The peer just &quot;decide&quot; to
</I>&gt;&gt;&gt;<i> connect either on 5672 or 5671. In the later,
</I>&gt;&gt;&gt;<i> SSL authentication will be enable, in the former, it won't !
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks for any other idea we can follow, because we are facing a bit of
</I>&gt;&gt;&gt;<i> a dead end since we upgraded to 2.x.x !
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm surprised that the logfile you posted previously stops after opening
</I>&gt;&gt;<i> ssl and tcp listeners. I would expect to see evidence of 4000+ clients
</I>&gt;&gt;<i> connecting.
</I>&gt;<i> 
</I>&gt;<i> Yes sorry for that, but it indeed contains those line for connection
</I>&gt;<i> accepted / started, but noting interesting after that. Basically we jump
</I>&gt;<i> from a series of connection started
</I>&gt;<i> to a series of connection stopped, without no other warning, nor error,
</I>&gt;<i> until the end of the log file.
</I>
That is very strange. I would expect to see evidence of the server
running out of memory.

&gt;&gt;<i> Are you able to get output from &quot;rabbitmqctl list_connections&quot; before
</I>&gt;&gt;<i> the broker becomes unresponsive? What is the status of the beam or
</I>&gt;&gt;<i> beam.smp process at that point - is it still running? How much memory
</I>&gt;&gt;<i> and CPU is it consuming?
</I>&gt;<i> 
</I>&gt;<i> Those information can be gathered by our own &quot;monitoring framework&quot; as
</I>&gt;<i> explained above. But as you said just before, the rabbitmq_ctl may be
</I>&gt;<i> too intrusive, we use netstat to list the
</I>&gt;<i> established connection on the port 5672 (5671 if SSL is turned ON).
</I>
rabbitmqctl does incur a small performance penalty if run continuously
and it may then prevent unused resources from hibernating. However it
was designed precisely to investigate the kind of problem you are
experiencing.

Can you confirm whether the beam or beam.smp process is running after
the test failed?



Regards

Emile
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008967.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
	<LI>Next message: <A HREF="009016.html">[rabbitmq-discuss] Erlang crashes reports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8969">[ date ]</a>
              <a href="thread.html#8969">[ thread ]</a>
              <a href="subject.html#8969">[ subject ]</a>
              <a href="author.html#8969">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
