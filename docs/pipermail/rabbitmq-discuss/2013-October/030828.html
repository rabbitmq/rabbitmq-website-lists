<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] CRL support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20CRL%20support&In-Reply-To=%3C277C7F5E-6A42-4E78-B1D5-730C913E6EDD%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030814.html">
   <LINK REL="Next"  HREF="030829.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] CRL support</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20CRL%20support&In-Reply-To=%3C277C7F5E-6A42-4E78-B1D5-730C913E6EDD%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] CRL support">tim at rabbitmq.com
       </A><BR>
    <I>Tue Oct  8 11:52:45 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030814.html">[rabbitmq-discuss] CRL support
</A></li>
        <LI>Next message: <A HREF="030829.html">[rabbitmq-discuss] CRL support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30828">[ date ]</a>
              <a href="thread.html#30828">[ thread ]</a>
              <a href="subject.html#30828">[ subject ]</a>
              <a href="author.html#30828">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Bala,

A few things....

1. the verify_fun is an option that Erlang's SSL application takes, not a rabbit specific item


On 8 Oct 2013, at 01:23, Balachandher Srinivasan wrote:
&gt;<i> 1. Erlang adopted a more elegant way to express higher order functions (funs), based on <A HREF="http://www.erlang.org/eeps/eep-0023.html.">http://www.erlang.org/eeps/eep-0023.html.</A>  So, {Module, Function} would be typically represented as Module:Function/Arity
</I>&gt;<i> 
</I>
You can't always do that in a config file - it depends on whether you have literals or are trying to use bound variables (where no binding exists). See <A HREF="http://www.erlang.org/doc/man/config.html">http://www.erlang.org/doc/man/config.html</A> for details, but basically the file needs to conform to the same specification that file:consult/1 uses - see <A HREF="http://www.erlang.org/doc/man/file.html#consult-1">http://www.erlang.org/doc/man/file.html#consult-1</A> for more details. If you can't execute `file:consult(&quot;/path/to/your/rabbit/config&quot;)' then the config file isn't valid.

&gt;<i> 2. Based on the EEP mentioned above and the SSL documentation, I was able to write a test program and validate CRL successfully by referring a function either internally within the same module or from an external module. For internal module's function, I used the form, {verify_fun, {fun validate/3, []}}; for external module's function, I used the form {verify_fun, {fun cert_util:validate/3, []}}.
</I>&gt;<i> 
</I>
That won't work in a config file. To test this for yourself, create a text file containing just that term:

$ echo '[{verify_fun, {fun lists:foldl/3, []}}].' &gt;&gt; foo.config

And try to parse it in the shell:

Eshell V5.10.2  (abort with ^G)
1&gt; file:consult(&quot;foo.config&quot;).
{error,{1,erl_parse,&quot;bad term&quot;}} 

&gt;<i> 3. After successfully writing a test program, I tried to apply the same in rabbitmq; however, rabbitmq was unable to start and I witnessed the following in the logs,
</I>&gt;<i> /var/log/rabbitmq/startup_log
</I>&gt;<i> {&quot;could not start kernel pid&quot;,application_controller,&quot;error in config file \&quot;/etc/rabbitmq/rabbitmq.config\&quot; (1): bad term&quot;}
</I>&gt;<i> 
</I>&gt;<i> /var/log/rabbitmq/startup_err
</I>&gt;<i> Crash dump was written to: erl_crash.dump
</I>&gt;<i> could not start kernel pid (application_controller) (error in config file &quot;/etc/rabbitmq/rabbitmq.config&quot; (1): bad term)
</I>&gt;<i> 
</I>
This indicates that the config file contains invalid syntax. As I said, the `fun Mod:Func/Arity' syntax isn't valid in a system configuration file. 

&gt;<i> 4. It was clear from the above that rabbitmq was unable to take the EEP-23 form for verify_fun; so I tried reverting back the funs to old type of the form {Module, Function}.   When I tried restarting, while it gave no errors and started successfully, my CRL validation function was never called.
</I>&gt;<i> 
</I>
Looking at <A HREF="https://github.com/erlang/otp/blob/master/lib/ssl/src/ssl_handshake.erl#L359,">https://github.com/erlang/otp/blob/master/lib/ssl/src/ssl_handshake.erl#L359,</A> it seems likely that the user fun isn't called since as the documentation states:

&quot;The verify fun will be called during the X509-path validation when an error or an extension unknown to the ssl application is encountered. Additionally it will be called when a certificate is considered valid by the path validation to allow access to each certificate in the path to the user application.&quot;

&gt;<i> 5. RabbitMQ site suggests that in order to use SSL reliably use R14B(erts 4.0.1) as the minimum version.  I tried using R16B (erts-5.10.1) on 64-bit Cent OS, which internally uses ssl-5.2.1.  Also, I tried R16B01(erts-5.10.2) on 64-bit Windows 7, which internally uses ssl-5.3.1.  Between these versions, there are lot of bugs fixed and enhancements applied in SSL application <A HREF="http://www.erlang.org/doc/apps/ssl/notes.html.">http://www.erlang.org/doc/apps/ssl/notes.html.</A>  
</I>&gt;<i> 
</I>&gt;<i> To summarize, though RabbitMQ states R14B as the minimum version for reliable SSL, I wonder whether it is compatible with the latest SSL available in the recent Erlang distributions.
</I>&gt;<i> 
</I>
I don't see any incompatibility - Rabbit does little more than forward the options you've provided to the SSL application. It looks to me like this problem has more to do with how the SSL application handles the validate_fun. I'd suggest asking on the erlang-questions mailing list to see if you can get some more guidance there - unless someone else on rabbit-discuss has come across this before and can say more about it.

If/when you find out the cause, please share the outcome with us!

Thanks,
Tim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131008/d64d7ebf/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131008/d64d7ebf/attachment.htm</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030814.html">[rabbitmq-discuss] CRL support
</A></li>
	<LI>Next message: <A HREF="030829.html">[rabbitmq-discuss] CRL support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30828">[ date ]</a>
              <a href="thread.html#30828">[ thread ]</a>
              <a href="subject.html#30828">[ subject ]</a>
              <a href="author.html#30828">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
