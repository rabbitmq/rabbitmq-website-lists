<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5BPATCH%5D%20Suggestions%20for%20improving%20the%0A%20RabbitMQ%20Erlang%20Client&In-Reply-To=%3C525410A1.7050607%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030839.html">
   <LINK REL="Next"  HREF="030880.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5BPATCH%5D%20Suggestions%20for%20improving%20the%0A%20RabbitMQ%20Erlang%20Client&In-Reply-To=%3C525410A1.7050607%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client">simon at rabbitmq.com
       </A><BR>
    <I>Tue Oct  8 15:03:13 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030839.html">[rabbitmq-discuss] java MDB to consume messages from rabbit mq	queues
</A></li>
        <LI>Next message: <A HREF="030880.html">[rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30841">[ date ]</a>
              <a href="thread.html#30841">[ thread ]</a>
              <a href="subject.html#30841">[ subject ]</a>
              <a href="author.html#30841">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>First of all, thanks again for this. We were aware that the Erlang 
client needed some performance improvements; you've provided some very 
useful analysis and patches.

I've been through the various changes you propose, and have some comments:

On 03/09/13 13:35, Jesper Louis Andersen wrote:
&gt;<i> The optimization is straight forward: Read as much data as possible from
</I>&gt;<i> the underlying socket per call.
</I>
I think this is fairly uncontroversial, and I can certainly see large 
gains there. Should find its way into 3.2.0.

&gt;<i> Let us look at what the `rabbit_writer` is doing.
</I>
&lt;snip&gt;

&gt;<i> Ouch! All writes are synchronous!
</I>
&lt;snip&gt;

&gt;<i> RabbitMQ itself does not use the sync writes for anything but closing
</I>&gt;<i> down the line. So we can probably safely change to use async writes on
</I>&gt;<i> the socket.
</I>
You are correct that the synchronous writing hurts performance - but 
it's not quite enough to just switch to async calls. The test suite 
starts failing, for a start :-)

So there is a bit of work needed here to ensure that the messages to the 
writer get flushed before the socket gets closed. I've started work on 
this, and it should end up in 3.2.0.

&lt;snip re channels manager&gt;

&gt;<i> I would probably have chosen a design based on an ETS lookup table. And
</I>&gt;<i> then have kept the state in the channel process itself to maximize
</I>&gt;<i> parallel behaviour. In turn, we can avoid spending a lot of time
</I>&gt;<i> updating internal memory state in a process on the critical path which
</I>&gt;<i> would speed up the system by quite a lot. Also, we are paying reductions
</I>&gt;<i> on busy channels. This will help fairness.
</I>&gt;<i>
</I>&gt;<i> Also, this means we can do away with the channels_manager process
</I>&gt;<i> entirely. There is no need since a decoded message can just be forwarded
</I>&gt;<i> to the channel directly, skipping an unneeded message pass on the
</I>&gt;<i> critical decoder path.
</I>
This is reasonable - but of course it's a more substantial change, 
unlikely to happen particularly soon.

&gt;<i> The writer process inside RabbitMQ is something I wanted to optimize as
</I>&gt;<i> well, so I tried changing two things in it. First, I avoided a
</I>&gt;<i> recomputation of `iolist_size/1` on every received message. And I just
</I>&gt;<i> dropped keeping a small 1414 byte packet size around. The rationale is
</I>&gt;<i> this: either we will be running at a high pace in the writer code and
</I>&gt;<i> then easily exceed the 1414 byte packet size. In this case, bumping it
</I>&gt;<i> to 64 kilobytes and making few calls to the underlying port seems to be
</I>&gt;<i> the right thing to do.
</I>
Hmm. I wasn't actually able to measure a discernable performance 
difference with these changes to the writer. Were you?

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>














































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030839.html">[rabbitmq-discuss] java MDB to consume messages from rabbit mq	queues
</A></li>
	<LI>Next message: <A HREF="030880.html">[rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30841">[ date ]</a>
              <a href="thread.html#30841">[ thread ]</a>
              <a href="subject.html#30841">[ subject ]</a>
              <a href="author.html#30841">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
