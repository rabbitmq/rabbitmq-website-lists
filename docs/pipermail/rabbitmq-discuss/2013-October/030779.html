<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] ETS memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20ETS%20memory%20usage&In-Reply-To=%3CCAOQTPw6MXNB8yC7nDYwxsEWwqqCMm0Kz5CLg9L4VA%2BpZbDSAig%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030778.html">
   <LINK REL="Next"  HREF="030810.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] ETS memory usage</H1>
    <B>Simone Sciarrati</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20ETS%20memory%20usage&In-Reply-To=%3CCAOQTPw6MXNB8yC7nDYwxsEWwqqCMm0Kz5CLg9L4VA%2BpZbDSAig%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] ETS memory usage">s.sciarrati at gmail.com
       </A><BR>
    <I>Mon Oct  7 13:50:21 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030778.html">[rabbitmq-discuss] ETS memory usage
</A></li>
        <LI>Next message: <A HREF="030810.html">[rabbitmq-discuss] mqtt websocket client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30779">[ date ]</a>
              <a href="thread.html#30779">[ thread ]</a>
              <a href="subject.html#30779">[ subject ]</a>
              <a href="author.html#30779">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

For the record, that worked as expected, the memory usage dropped
1.3GB to normal (around 1G) and another node in the cluster became the
stats node. The command took some time to complete (2/3 minutes) but
there was no interruption of service.

Simone

On Mon, Oct 7, 2013 at 2:36 PM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:
&gt;<i> Yes, I believe so.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 07/10/2013 1:32PM, Simone Sciarrati wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think I found the answer in a previous post
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-April/019446.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-April/019446.html</A>):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You should be able to do:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbitmqctl eval 'application:stop(rabbitmq_management).'
</I>&gt;&gt;<i> rabbitmqctl eval 'application:start(rabbitmq_management).'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> to just restart the management plugin.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I assume if I just stop it another node in the cluster will take the
</I>&gt;&gt;<i> stats.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Simone
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, Oct 7, 2013 at 1:50 PM, Simone Sciarrati &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">s.sciarrati at gmail.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks a lot. This node has the most active active queue and it is
</I>&gt;&gt;&gt;<i> also the stats node for the cluster, I can see it is doing lots of IO
</I>&gt;&gt;&gt;<i> compared to the other nodes and as you say it might be lagging behind.
</I>&gt;&gt;&gt;<i> Is there a way to move the stats to another node in the cluster
</I>&gt;&gt;&gt;<i> without having to restart RabbitMQ?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Simone
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Mon, Oct 7, 2013 at 1:16 PM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;
</I>&gt;&gt;&gt;<i> wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 07/10/2013 10:41AM, Simone Sciarrati wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I am investigating memory usage on one of our nodes in a cluster of 3
</I>&gt;&gt;&gt;&gt;&gt;<i> x c1.xlarge instances in ec2, ubuntu 12.04, RabbitMQ 2.8.4 and Erlang
</I>&gt;&gt;&gt;&gt;&gt;<i> R14B04 (2 disk nodes and one ram node) . We are planning to upgrade to
</I>&gt;&gt;&gt;&gt;&gt;<i> 3.1.x but regardless of the version I would like to understand how to
</I>&gt;&gt;&gt;&gt;&gt;<i> extract information about what is consuming the memory.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> You are aware that later versions of RabbitMQ do some of this for you?
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://www.rabbitmq.com/memory-use.html">http://www.rabbitmq.com/memory-use.html</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Right now, one of the nodes is showing 2.3GB used (high watermark
</I>&gt;&gt;&gt;&gt;&gt;<i> 2.7GB), where 2GB are held in ETS according to the management console:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> &lt;snip&gt;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> According to this output the 2 tables that are consuming most of the
</I>&gt;&gt;&gt;&gt;&gt;<i> memory are:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>    2629654         anon              ordered_set 1308748 215451711
</I>&gt;&gt;&gt;&gt;&gt;<i> &lt;0.9548.283&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i>    471110          rabbit_msg_store_ets_index set   2627724 39819062
</I>&gt;&gt;&gt;&gt;&gt;<i> msg_store_persistent
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> &lt;snip&gt;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Looking at this output the sum of the memory doesn't seem to add up to
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2GB
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> IIRC the output from some of the ETS statistics functions are sometimes
</I>&gt;&gt;&gt;&gt;<i> in
</I>&gt;&gt;&gt;&gt;<i> words rather than bytes.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Also we reported discrepancies between the globally reported ETS memory
</I>&gt;&gt;&gt;&gt;<i> use
</I>&gt;&gt;&gt;&gt;<i> and the per-table use that I think were fixed in later versions of
</I>&gt;&gt;&gt;&gt;<i> Erlang.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> , also the number of objects in the rabbit_msg_store_ets_index is
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2.5 millions, which doesn't seem correct when the number of messages
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> in all queues on this node isn't more than 150k at any time (perhaps
</I>&gt;&gt;&gt;&gt;&gt;<i> my understanding of this number is incorrect and it doesn't relate to
</I>&gt;&gt;&gt;&gt;&gt;<i> the # of messages).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It should do. If the server is very active it may lag behind the real
</I>&gt;&gt;&gt;&gt;<i> state
</I>&gt;&gt;&gt;&gt;<i> of affairs (i.e. a message might have been consumed but not yet removed
</I>&gt;&gt;&gt;&gt;<i> from
</I>&gt;&gt;&gt;&gt;<i> the message store index).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Any help in understanding where the memory might be used would be
</I>&gt;&gt;&gt;&gt;&gt;<i> greatly appreciated, this is a generic question not specifically tied
</I>&gt;&gt;&gt;&gt;&gt;<i> to the RabbitMQ version (same or different problem might present with
</I>&gt;&gt;&gt;&gt;&gt;<i> later versions at some point in time).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The bulk of your memory is going to the mgmt stats db, mostly (if I'm
</I>&gt;&gt;&gt;&gt;<i> counting correctly) on the channels table. There was a bug (fixed in
</I>&gt;&gt;&gt;&gt;<i> 3.0.3)
</I>&gt;&gt;&gt;&gt;<i> where stats on connections / channels would leak when a node that was
</I>&gt;&gt;&gt;&gt;<i> not
</I>&gt;&gt;&gt;&gt;<i> running the stats DB went down with active connections / channels. If
</I>&gt;&gt;&gt;&gt;<i> that
</I>&gt;&gt;&gt;&gt;<i> has happened a few times that would explain what you're seeing.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> --
</I>&gt;&gt;&gt;&gt;<i> Simon MacMullen
</I>&gt;&gt;&gt;&gt;<i> RabbitMQ, Pivotal
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, Pivotal
</I></PRE>

























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030778.html">[rabbitmq-discuss] ETS memory usage
</A></li>
	<LI>Next message: <A HREF="030810.html">[rabbitmq-discuss] mqtt websocket client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30779">[ date ]</a>
              <a href="thread.html#30779">[ thread ]</a>
              <a href="subject.html#30779">[ subject ]</a>
              <a href="author.html#30779">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
