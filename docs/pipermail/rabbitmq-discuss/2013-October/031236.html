<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] abnormally large memory use in &quot;binaries&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20abnormally%20large%20memory%20use%20in%20%22binaries%22&In-Reply-To=%3C1382458816.47116.YahooMailNeo%40web122003.mail.ne1.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031229.html">
   <LINK REL="Next"  HREF="031237.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] abnormally large memory use in &quot;binaries&quot;</H1>
    <B>Brian Hammond</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20abnormally%20large%20memory%20use%20in%20%22binaries%22&In-Reply-To=%3C1382458816.47116.YahooMailNeo%40web122003.mail.ne1.yahoo.com%3E"
       TITLE="[rabbitmq-discuss] abnormally large memory use in &quot;binaries&quot;">brianin3d at yahoo.com
       </A><BR>
    <I>Tue Oct 22 17:20:16 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031229.html">[rabbitmq-discuss] abnormally large memory use in &quot;binaries&quot;
</A></li>
        <LI>Next message: <A HREF="031237.html">[rabbitmq-discuss] abnormally large memory use in &quot;binaries&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31236">[ date ]</a>
              <a href="thread.html#31236">[ thread ]</a>
              <a href="subject.html#31236">[ subject ]</a>
              <a href="author.html#31236">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Running this now: &#160;netstat -t -n | grep :5672

As far as the prefetch goes, we are using a value of 500. When using a value like 1, we saw pretty bad performance.

My understanding of pre-fetch was the consumer asks for that number of messages and then has to send an acknowledge before more messages are sent to it. If we have memory issues when there are almost no messages then our pre-fetch values seems an unlikely cause.

If we set prefetch really low, I could see us having a lot of messages in the queue. Setting it high or unlimited should actually be better for the server.

Nonetheless, I'll try it after this current batch with netstat runs to explosion.

Still no luck reproducing the issue with a simple test program...



On Tuesday, October 22, 2013 7:31 AM, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:
 

Hi Brian,

On 21/10/13 19:50, Brian Hammond wrote:
&gt;<i> Do you have a specific set of arguments in mind for netstat? If not I'll
</I>&gt;<i> go look at the man page.
</I>
netstat shows this information by default.

&gt;<i> I'll provide more information as my tests progress.
</I>

From the reports it appears that all consumers are either using
unlimited prefetch or a value of 500. It is likely that the broker
memory use will be reduced if consumers use a much lower prefetch count,
say 1. Would it be possible for you to try that? The reason why it might
help in your particular case is most of the memory is being consumed by
the Erlang processes that write to the network.

I realise that it might be difficult for you to make this change to all
consumers. Let me know if this is too onerous so we can discuss
alternatives.





-Emile
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131022/3920af48/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131022/3920af48/attachment.htm</A>&gt;
</PRE>











































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031229.html">[rabbitmq-discuss] abnormally large memory use in &quot;binaries&quot;
</A></li>
	<LI>Next message: <A HREF="031237.html">[rabbitmq-discuss] abnormally large memory use in &quot;binaries&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31236">[ date ]</a>
              <a href="thread.html#31236">[ thread ]</a>
              <a href="subject.html#31236">[ subject ]</a>
              <a href="author.html#31236">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
