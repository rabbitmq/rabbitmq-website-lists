<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Unexpected Behavior When Using the &quot;X-Consistent-Hash&quot; Exchange Type
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unexpected%20Behavior%20When%20Using%20the%0A%20%22X-Consistent-Hash%22%20Exchange%20Type&In-Reply-To=%3CCAO%3D6ox9jeeSY1jgfGqJT5m9NVcMA%2Bq6-mS8H9_zbD1__scXXRw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031086.html">
   <LINK REL="Next"  HREF="031180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Unexpected Behavior When Using the &quot;X-Consistent-Hash&quot; Exchange Type</H1>
    <B>Richard Raseley</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unexpected%20Behavior%20When%20Using%20the%0A%20%22X-Consistent-Hash%22%20Exchange%20Type&In-Reply-To=%3CCAO%3D6ox9jeeSY1jgfGqJT5m9NVcMA%2Bq6-mS8H9_zbD1__scXXRw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Unexpected Behavior When Using the &quot;X-Consistent-Hash&quot; Exchange Type">richard at raseley.com
       </A><BR>
    <I>Thu Oct 17 17:56:37 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031086.html">[rabbitmq-discuss] Unexpected Behavior When Using the &quot;X-Consistent-Hash&quot; Exchange Type
</A></li>
        <LI>Next message: <A HREF="031180.html">[rabbitmq-discuss] Unexpected Behavior When Using the &quot;X-Consistent-Hash&quot; Exchange Type
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31125">[ date ]</a>
              <a href="thread.html#31125">[ thread ]</a>
              <a href="subject.html#31125">[ subject ]</a>
              <a href="author.html#31125">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>As a final question, can anyone on the engineering team provide a
recommendation as to the best way to generate a header value for hashing
use in terms of what will implicitly provide the most even distribution?

For example, if a random integer is the best way to go, should the range of
possible integers be scoped from 1 to Q*B where Q is equal to the number of
queues you have bound to the x-consistent-hash exchange and B is equal to
the sum of all the integers used as routing keys when binding the queues to
the x-consistent-hash exchange?

Regards,

Richard


On Wed, Oct 16, 2013 at 4:13 PM, Richard Raseley &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">richard at raseley.com</A>&gt;wrote:

&gt;<i> An interesting update. In re-reading the x-consistent-hash type exchange
</I>&gt;<i> documentation, the following passage:
</I>&gt;<i>
</I>&gt;<i> &quot;The more points in the hash space each binding has, the closer the actual
</I>&gt;<i> distribution will be to the desired distribution (as indicated by the ratio
</I>&gt;<i> of points by binding). However, large numbers of points (many thousands)
</I>&gt;<i> will substantially decrease performance of the exchange type.&quot;
</I>&gt;<i>
</I>&gt;<i> It appears that my initial understanding of the integer used to bind
</I>&gt;<i> queues to the x-consistent-hash exchange as a &quot;weight&quot; was incorrect, but
</I>&gt;<i> rather it represents the number of points along the overall hash continuum
</I>&gt;<i> where that particular queue is represented, with the points being
</I>&gt;<i> (seemingly) pseudorandomly distributed across the overall hash space. So I
</I>&gt;<i> updated the bindings on each of the queues from 1 to 100 and re-ran my
</I>&gt;<i> tests with 50K messages this time (in the interests of expediency).
</I>&gt;<i>
</I>&gt;<i> The results are as follows:
</I>&gt;<i>
</I>&gt;<i> **FIRST TEST (Using UUID as the Hash Header)**
</I>&gt;<i>
</I>&gt;<i> Queue Name,Message Count,Percent of Total,Percent of Equality
</I>&gt;<i> error01,3505,7.01%,89.16%
</I>&gt;<i> error02,2919,5.84%,107.06%
</I>&gt;<i> error03,3418,6.84%,91.43%
</I>&gt;<i> error04,2912,5.82%,107.31%
</I>&gt;<i> error05,2945,5.89%,106.11%
</I>&gt;<i> error06,3146,6.29%,99.33%
</I>&gt;<i> error07,3057,6.11%,102.22%
</I>&gt;<i> error08,2868,5.74%,108.96%
</I>&gt;<i> error09,2968,5.94%,105.29%
</I>&gt;<i> error10,2866,5.73%,109.04%
</I>&gt;<i> error11,3513,7.03%,88.96%
</I>&gt;<i> error12,4077,8.15%,76.65%
</I>&gt;<i> error13,3054,6.11%,102.32%
</I>&gt;<i> error14,2648,5.30%,118.01%
</I>&gt;<i> error15,2718,5.44%,114.97%
</I>&gt;<i> error16,3386,6.77%,92.29%
</I>&gt;<i> ALL,50000,100.00%,N/A
</I>&gt;<i>
</I>&gt;<i> **SECOND TEST (Using Random Int Between 1 and 1000000000 as the Hash
</I>&gt;<i> Header)**
</I>&gt;<i>
</I>&gt;<i> Queue Name,Message Count,Percent of Total,Percent of Equality
</I>&gt;<i> error01,3313,6.63%,94.33%
</I>&gt;<i> error02,3255,6.51%,96.01%
</I>&gt;<i> error03,3077,6.15%,101.56%
</I>&gt;<i> error04,3048,6.10%,102.53%
</I>&gt;<i> error05,2384,4.77%,131.08%
</I>&gt;<i> error06,2954,5.91%,105.79%
</I>&gt;<i> error07,3586,7.17%,87.14%
</I>&gt;<i> error08,3055,6.11%,102.29%
</I>&gt;<i> error09,3030,6.06%,103.14%
</I>&gt;<i> error10,3517,7.03%,88.85%
</I>&gt;<i> error11,2954,5.91%,105.79%
</I>&gt;<i> error12,2921,5.84%,106.98%
</I>&gt;<i> error13,3046,6.09%,102.59%
</I>&gt;<i> error14,3710,7.42%,84.23%
</I>&gt;<i> error15,3024,6.05%,103.34%
</I>&gt;<i> error16,3126,6.25%,99.97%
</I>&gt;<i> ALL,50000,100.00%,N/A
</I>&gt;<i>
</I>&gt;<i> So we now have a much more even distribution. I then changed the bindings
</I>&gt;<i> of the queues from 100 to 1000 and reran the test. I saw significant
</I>&gt;<i> increase in CPU usage and flow-control started kicking in (running this VM
</I>&gt;<i> on a single core on my laptop so not unexpected). This is in line with the
</I>&gt;<i> warning in the excerpt above and makes sense.
</I>&gt;<i>
</I>&gt;<i> This leaves me with the following questions:
</I>&gt;<i>
</I>&gt;<i> 1) Is it true to say that it is now just a matter of choosing what
</I>&gt;<i> tradeoff we want to make in terms of performance vs. uniformity of
</I>&gt;<i> distribution?
</I>&gt;<i> 2) Can anyone comment on Michael's previous comment on how using a UUID
</I>&gt;<i> would be handled as the value in the hashed header? The numbers above don't
</I>&gt;<i> seem to show a large difference between using a random integer and a UUID.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Richard Raseley
</I>&gt;<i>
</I>&gt;<i> On Wed, Oct 16, 2013 at 3:34 PM, Michael Klishin &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mklishin at gopivotal.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On oct 17, 2013, at 2:33 a.m., Richard Raseley &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">richard at raseley.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Do you mean to say that those &quot;voided&quot; messages didn't make it to a
</I>&gt;&gt;<i> queue or weren't hashed but simply put to an arbitrary queue?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The former but it was just a guess.
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> MK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Software Engineer, Pivotal/RabbitMQ
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131017/88b37046/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131017/88b37046/attachment.htm</A>&gt;
</PRE>

























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031086.html">[rabbitmq-discuss] Unexpected Behavior When Using the &quot;X-Consistent-Hash&quot; Exchange Type
</A></li>
	<LI>Next message: <A HREF="031180.html">[rabbitmq-discuss] Unexpected Behavior When Using the &quot;X-Consistent-Hash&quot; Exchange Type
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31125">[ date ]</a>
              <a href="thread.html#31125">[ thread ]</a>
              <a href="subject.html#31125">[ subject ]</a>
              <a href="author.html#31125">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
