<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Crash with RabbitMQ 3.1.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Crash%20with%20RabbitMQ%203.1.5&In-Reply-To=%3C878AEE82-C27B-4FF2-B3DD-DB24625632EB%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031059.html">
   <LINK REL="Next"  HREF="031079.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Crash with RabbitMQ 3.1.5</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Crash%20with%20RabbitMQ%203.1.5&In-Reply-To=%3C878AEE82-C27B-4FF2-B3DD-DB24625632EB%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Crash with RabbitMQ 3.1.5">watson.timothy at gmail.com
       </A><BR>
    <I>Wed Oct 16 18:01:24 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031059.html">[rabbitmq-discuss] Crash with RabbitMQ 3.1.5
</A></li>
        <LI>Next message: <A HREF="031079.html">[rabbitmq-discuss] Crash with RabbitMQ 3.1.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31076">[ date ]</a>
              <a href="thread.html#31076">[ thread ]</a>
              <a href="subject.html#31076">[ subject ]</a>
              <a href="author.html#31076">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16 Oct 2013, at 16:34, David Harrison &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dave.l.harrison at gmail.com</A>&gt; wrote:

&gt;<i> Quick update on the queue count: 56
</I>
Hmm. That seems perfectly reasonable.

&gt;<i> On 17 October 2013 02:29, David Harrison &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dave.l.harrison at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> What version of rabbit are you running, and how was it installed?
</I>&gt;<i> 
</I>&gt;<i> 3.1.5, running on Ubuntu Precise, installed via deb package.
</I>
Of course - I missed that in the subject line. 

&gt;<i> I think 3.1.5 is the latest stable ??
</I>
Yep.

&gt;<i> 
</I>&gt;<i> I'll take a look, we saw a few &quot;too many processes&quot; messages,
</I>&gt;<i> 
</I>
That's not a good sign. I can't say we've run into that very frequently - it is possible to raise the limit (on the number of processes), but I suspect that's not the root of this anyway.

&gt;<i> &quot;Generic server net_kernel terminating&quot; followed by :
</I>&gt;<i> 
</I>&gt;<i> ** Reason for termination ==
</I>&gt;<i> ** {system_limit,[{erlang,spawn_opt,
</I>
Yeah - once that goes you're in trouble. That's an unrecoverable error, the equivalent of crashing the jvm.

&gt;<i> There was definitely a network partition, but the whole cluster nose dived during the crash
</I>&gt;<i>  
</I>
Yeah, partitions are bad and can even become unrecoverable without restarts (which is why we warn against using clustering in some environments), but what you're experiencing shouldn't happen.

&gt;<i> 
</I>&gt;<i> &gt; The erl_crash.dump slogan error was : eheap_alloc: Cannot allocate 2850821240 bytes of memory (of type &quot;old_heap&quot;).
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> That's a plain old OOM failure. Rabbit ought to start deliberately paging messages to disk well before that happens, which might also explain a lot of the slow/unresponsive-ness.
</I>&gt;<i> 
</I>&gt;<i> These hosts aren't running swap, we give them a fair bit of RAM (gave them even more now as part of a possible stop gap) 
</I>&gt;<i>  
</I>
This. I suspect the root of your problem is that you don't have any available swap and somehow ran out I memory. Rabbit should've been paging to disk (by hand, not via swap) once you got within a tolerance level of the high watermark, which is why I'd like to see logs if possible since we might be able to identify what led to runaway process spawns and memory allocation during the partition. My money, for the memory use part, is on error_logger, which has been known to blow up in this way when flooded with large logging terms. During a partition, various things can go wrong leading to crashing processes such as queues, some of which can have massive state that RTS logged leading to potential oom situations like this one. Replacing error logger has been in our radar before, but we've not had strong enough reasons to warrant the expense. If what you've seen can be linked to that however...

To properly diagnose what you've seen though, I will new to get my hands on those logs. Can we arrange that somehow?  

Cheers,
Tim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131016/8b213b8d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131016/8b213b8d/attachment.htm</A>&gt;
</PRE>





































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031059.html">[rabbitmq-discuss] Crash with RabbitMQ 3.1.5
</A></li>
	<LI>Next message: <A HREF="031079.html">[rabbitmq-discuss] Crash with RabbitMQ 3.1.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31076">[ date ]</a>
              <a href="thread.html#31076">[ thread ]</a>
              <a href="subject.html#31076">[ subject ]</a>
              <a href="author.html#31076">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
