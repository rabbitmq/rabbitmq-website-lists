<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5BPATCH%5D%20Suggestions%20for%20improving%20the%0A%20RabbitMQ%20Erlang%20Client&In-Reply-To=%3CCAGrdgiUGqX9FcMvSoFtHAKfdkpzA1FKqv%3DX0cD%2BKt0rFro6_zw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030841.html">
   <LINK REL="Next"  HREF="030846.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client</H1>
    <B>Jesper Louis Andersen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5BPATCH%5D%20Suggestions%20for%20improving%20the%0A%20RabbitMQ%20Erlang%20Client&In-Reply-To=%3CCAGrdgiUGqX9FcMvSoFtHAKfdkpzA1FKqv%3DX0cD%2BKt0rFro6_zw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client">jesper.louis.andersen at gmail.com
       </A><BR>
    <I>Wed Oct  9 14:26:37 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030841.html">[rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client
</A></li>
        <LI>Next message: <A HREF="030846.html">[rabbitmq-discuss] integration with jboss 5.1 as
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30880">[ date ]</a>
              <a href="thread.html#30880">[ thread ]</a>
              <a href="subject.html#30880">[ subject ]</a>
              <a href="author.html#30880">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Replying inline

On Tue, Oct 8, 2013 at 4:03 PM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> You are correct that the synchronous writing hurts performance - but it's
</I>&gt;<i> not quite enough to just switch to async calls. The test suite starts
</I>&gt;<i> failing, for a start :-)
</I>&gt;<i>
</I>&gt;<i> So there is a bit of work needed here to ensure that the messages to the
</I>&gt;<i> writer get flushed before the socket gets closed. I've started work on
</I>&gt;<i> this, and it should end up in 3.2.0.
</I>&gt;<i>
</I>&gt;<i>
</I>Ah, I was afraid things might not be so obviously easy. I am glad you
sorted out the more specific parts :) Thanks for the fixes.


&gt;<i> &lt;snip re channels manager&gt;
</I>&gt;<i>
</I>&gt;<i> This is reasonable - but of course it's a more substantial change,
</I>&gt;<i> unlikely to happen particularly soon.
</I>&gt;<i>
</I>&gt;<i>
</I>If we are to do that, it is better to re-imagine the whole way the stack
works I think. There are other parts of the Erlang client that could do
with less misery. I fail to see the need for supervisor2 and gen_server2 in
the code at all for instance.

&gt;<i>
</I>&gt;<i>  The writer process inside RabbitMQ is something I wanted to optimize as
</I>&gt;&gt;<i> well, so I tried changing two things in it. First, I avoided a
</I>&gt;&gt;<i> recomputation of `iolist_size/1` on every received message. And I just
</I>&gt;&gt;<i> dropped keeping a small 1414 byte packet size around. The rationale is
</I>&gt;&gt;<i> this: either we will be running at a high pace in the writer code and
</I>&gt;&gt;<i> then easily exceed the 1414 byte packet size. In this case, bumping it
</I>&gt;&gt;<i> to 64 kilobytes and making few calls to the underlying port seems to be
</I>&gt;&gt;<i> the right thing to do.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hmm. I wasn't actually able to measure a discernable performance
</I>&gt;<i> difference with these changes to the writer. Were you?
</I>&gt;<i>
</I>&gt;<i>
</I>Keep it as is for now. Changing this messes with latency, potentially. My
worry is that you are pushing out small packets where a larger packet might
be equally easy to push. This then means more work on the line between the
client and the server. Keeping the outgoing queue full will prove to be a
problem though with the current setup. We can't guarantee that all
processes interested in pushing messages will be run before the process
doing the actual sending is.

And I did not manage to measure anything significantly better inside the
Erlang VM with this change. Chances are you may see less kernel-processing
though - but I did not measure that either. So in the interest of keeping
it stable, I propose not changing it.


-- 
J.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131009/258c05e2/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131009/258c05e2/attachment.htm</A>&gt;
</PRE>




































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030841.html">[rabbitmq-discuss] [PATCH] Suggestions for improving the RabbitMQ Erlang Client
</A></li>
	<LI>Next message: <A HREF="030846.html">[rabbitmq-discuss] integration with jboss 5.1 as
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30880">[ date ]</a>
              <a href="thread.html#30880">[ thread ]</a>
              <a href="subject.html#30880">[ subject ]</a>
              <a href="author.html#30880">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
