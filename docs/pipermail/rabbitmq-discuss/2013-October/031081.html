<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Unexpected Behavior When Using the	&quot;X-Consistent-Hash&quot; Exchange Type
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unexpected%20Behavior%20When%20Using%20the%0A%09%22X-Consistent-Hash%22%20Exchange%20Type&In-Reply-To=%3CCAO%3D6ox9iyW4RtGY3p6Oih5sJDCOsb_LQQdRcm7oVPe9Tw7-FVg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031075.html">
   <LINK REL="Next"  HREF="031083.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Unexpected Behavior When Using the	&quot;X-Consistent-Hash&quot; Exchange Type</H1>
    <B>Richard Raseley</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unexpected%20Behavior%20When%20Using%20the%0A%09%22X-Consistent-Hash%22%20Exchange%20Type&In-Reply-To=%3CCAO%3D6ox9iyW4RtGY3p6Oih5sJDCOsb_LQQdRcm7oVPe9Tw7-FVg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Unexpected Behavior When Using the	&quot;X-Consistent-Hash&quot; Exchange Type">richard at raseley.com
       </A><BR>
    <I>Wed Oct 16 20:58:51 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031075.html">[rabbitmq-discuss] Flow Control behavior in a Cluster Questions
</A></li>
        <LI>Next message: <A HREF="031083.html">[rabbitmq-discuss] Unexpected Behavior When Using the	&quot;X-Consistent-Hash&quot; Exchange Type
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31081">[ date ]</a>
              <a href="thread.html#31081">[ thread ]</a>
              <a href="subject.html#31081">[ subject ]</a>
              <a href="author.html#31081">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We have encountered some unexpected behavior when using the
&quot;x-consistent-hash&quot; exchange type that I am hoping someone on the list can
help us understand.

At a high level, the issue we're experiencing is that in our testing of the
&quot;x-consistent-hash&quot; exchange we aren't able to get even (or roughly even)
distribution of messages between the queues bound to the exchange.

Here is a link to the full broker configuration export (
<A HREF="http://pastebin.com/nkcXskpY">http://pastebin.com/nkcXskpY</A> ) but at a high level we are doing the
following:

1) Topic exchange named &quot;logging.topic&quot; is bound to hash exchange
&quot;error.hash&quot; with routing key &quot;error.#&quot; (our eventual goal is to have
several of these).
2) Hash exchange &quot;error.hash&quot; is configured with parameters &quot;hash-header:
message-distribution-hash&quot;.
3) Queues named &quot;error01&quot; through &quot;error16&quot; are bound to the &quot;error.hash&quot;
exchange each with routing key of &quot;1&quot; (to ensure they each get an equal
slice of the hash range).

When executing a simple test script ( <A HREF="http://pastebin.com/e7EjZ1TD">http://pastebin.com/e7EjZ1TD</A> ), which
sends 500K messages to the &quot;logging.topic&quot; with a
&quot;message-distribution-hash&quot; header that a value that is a UUID converted to
a string, I see quite unequal distribution of the messages across the
queues. I ran three tests of 500K messages (resetting and reloading the
broker configuration between each test) and I get the following results:

**FIRST TEST**

Queue Name,Message Count
error01,73616
error02,65789
error03,12986
error04,15029
error05,12026
error06,51006
error07,465
error08,95926
error09,34857
error10,16858
error11,19075
error12,25155
error13,25002
error14,14994
error15,8878
error16,28338
TOTAL,500000

**SECOND TEST**

Queue Name,Message Count
error01,23124
error02,5122
error03,29047
error04,24405
error05,1467
error06,1312
error07,28045
error08,35258
error09,164437
error10,25851
error11,40669
error12,24821
error13,17316
error14,18611
error15,41183
error16,19332
TOTAL,500000

**THIRD TEST**

Queue Name,Message Count
error01,26655
error02,77116
error03,405
error04,24106
error05,10543
error06,7734
error07,37476
error08,25048
error09,32156
error10,43750
error11,92675
error12,14325
error13,50265
error14,18449
error15,2665
error16,36632
TOTAL,500000

As you can see, some queues get *many* more messages than other queues for
example in the third test we see that one queue (error03) received only 405
messages (0.081% of the total) while another (error11) received 92675
(18.53% of the total). With all this in mind, my questions are as follows:

1) Why am I seeing such uneven distribution of messages between the queues
bound to the x-consistent-hash exchange?

2) What can I do to ensure the most even distribution of messages as
possible across the queues bound to the x-consistent-has exchange?

Regards,

Richard Raseley
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131016/aca11d3d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131016/aca11d3d/attachment.htm</A>&gt;
</PRE>









































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031075.html">[rabbitmq-discuss] Flow Control behavior in a Cluster Questions
</A></li>
	<LI>Next message: <A HREF="031083.html">[rabbitmq-discuss] Unexpected Behavior When Using the	&quot;X-Consistent-Hash&quot; Exchange Type
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31081">[ date ]</a>
              <a href="thread.html#31081">[ thread ]</a>
              <a href="subject.html#31081">[ subject ]</a>
              <a href="author.html#31081">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
