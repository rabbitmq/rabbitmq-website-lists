<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Crash with RabbitMQ 3.1.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Crash%20with%20RabbitMQ%203.1.5&In-Reply-To=%3C345842AD-209B-4818-BF27-A2B8EDE70438%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031043.html">
   <LINK REL="Next"  HREF="031046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Crash with RabbitMQ 3.1.5</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Crash%20with%20RabbitMQ%203.1.5&In-Reply-To=%3C345842AD-209B-4818-BF27-A2B8EDE70438%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Crash with RabbitMQ 3.1.5">tim at rabbitmq.com
       </A><BR>
    <I>Wed Oct 16 15:29:58 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031043.html">[rabbitmq-discuss] Crash with RabbitMQ 3.1.5
</A></li>
        <LI>Next message: <A HREF="031046.html">[rabbitmq-discuss] Crash with RabbitMQ 3.1.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31045">[ date ]</a>
              <a href="thread.html#31045">[ thread ]</a>
              <a href="subject.html#31045">[ subject ]</a>
              <a href="author.html#31045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello David!

On 16 Oct 2013, at 15:14, David Harrison wrote:
&gt;<i> Hoping someone can help me out.  We recently experienced 2 crashes with our RabbitMQ cluster.  After the first crash, we moved the Mnesia directories elsewhere, and started RabbitMQ again.  This got us up and running.  Second time it happened, we had the original nodes plus an additional 5 nodes we had added to the cluster that we were planning to leave in place while shutting the old nodes down.
</I>&gt;<i> 
</I>
What version of rabbit are you running, and how was it installed?

&gt;<i> During the crash symptoms were as follows:
</I>&gt;<i> 
</I>&gt;<i> - Escalating (and sudden) CPU utilisation on some (but not all) nodes
</I>
We've fixed at least one bug with that symptom in recent releases.

&gt;<i> - Increasing time to publish on queues (and specifically on a test queue we have setup that exists only to test publishing and consuming from the cluster hosts)
</I>
Are there multiple publishers on the same connection/channel when this happens? It wouldn't be unusual, if the server was struggling, to see flow control kick in and affect publishers in this fashion.

&gt;<i> - Running `rabbitmqctl cluster status` gets increasingly slow (some nodes eventually taking up to 10m to return with the response data - some were fast and took 5s)
</I>
Wow, 10m is amazingly slow. Can you provide log files for this period of activity and problems?

&gt;<i> - When trying to shut down a node, running `rabbitmqctl stop_app` appears to block on epmd and doesn't return
</I>
Again, we've fixed bugs in that area in recent releases.

&gt;<i> --- When that doesn't return we eventually have to ctrl-c the command
</I>&gt;<i> --- We have to issue a kill signal to rabbit to stop it
</I>&gt;<i> --- Do the same to the epmd process
</I>
Even if you have to `kill -9' a rabbit node, you shouldn't need to kill epmd. In theory at least. If that was necessary to fix the &quot;state of the world&quot;, it would be indicative of a problem related to the erlang distribution mechanism, but I very much doubt that's the case here.

&gt;<i> Config / details as follows (we use mirrored queues -- 5 hosts, all disc nodes, with a global policy that all queues are mirrored &quot;ha-mode:all&quot;), running on Linux
</I>&gt;<i> 
</I>
How many queues are we talking about here?

&gt;<i> [
</I>&gt;<i>         {rabbit, [
</I>&gt;<i>                 {cluster_nodes, {['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at b05.internal</A>', '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at b06.internal</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at b07.internal</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at b08.internal</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at b09.internal</A>'], disc}},
</I>&gt;<i>                 {cluster_partition_handling, pause_minority}
</I>
Are you sure that what you're seeing is not caused by a network partition? If it were, any nodes in a minority island would &quot;pause&quot;, which would certainly lead to the kind of symptoms you've mentioned here, viz rabbitmqctl calls not returning and so on.

&gt;<i> The erl_crash.dump slogan error was : eheap_alloc: Cannot allocate 2850821240 bytes of memory (of type &quot;old_heap&quot;).
</I>&gt;<i> 
</I>
That's a plain old OOM failure. Rabbit ought to start deliberately paging messages to disk well before that happens, which might also explain a lot of the slow/unresponsive-ness.

&gt;<i> System version : Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:2:2] [rq:2] [async-threads:0] [kernel-poll:false]
</I>&gt;<i> 
</I>
I'd strongly suggest upgrading to R16B02 if you can. R14 is pretty ancient and a *lot* of bug fixes have appeared in erts + OTP since then.

&gt;<i> When I look at the Process Information it seems there's a small number with ALOT of messages queued, and the rest are an order of magnitude lower:
</I>&gt;<i> 
</I>
That's not unusual.

&gt;<i> when I view the second process (first one crashes erlang on me), I see a large number of sender_death events (not sure if these are common or highly unusual ?)
</I>&gt;<i> 
</I>&gt;<i> {'$gen_cast',{gm,{sender_death,&lt;2710.20649.64&gt;}}}
</I>&gt;<i> 
</I>
Interesting - will take a look at that. If you could provide logs for the participating nodes during this whole time period, that would help a lot.

&gt;<i> mixed in with other more regular events:
</I>&gt;<i> 
</I>
Actually, sender_death messages are not &quot;irregular&quot; as such. They're just notifying the GM group members that another member (on another node) has died. This is quite normal with mirrored queues, when nodes get partitioned or stopped due to cluster recovery modes.

Cheers,
Tim


</PRE>











































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031043.html">[rabbitmq-discuss] Crash with RabbitMQ 3.1.5
</A></li>
	<LI>Next message: <A HREF="031046.html">[rabbitmq-discuss] Crash with RabbitMQ 3.1.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31045">[ date ]</a>
              <a href="thread.html#31045">[ thread ]</a>
              <a href="subject.html#31045">[ subject ]</a>
              <a href="author.html#31045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
