<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Feature Req / Bug list
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Feature%20Req%20/%20Bug%20list&In-Reply-To=%3CCAJ4uuZbWFQ_6inoQ01%3DWmhchzBwDFXCrUWC%2BaBKW7_ExOFq-GA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030726.html">
   <LINK REL="Next"  HREF="031349.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Feature Req / Bug list</H1>
    <B>Graeme N</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Feature%20Req%20/%20Bug%20list&In-Reply-To=%3CCAJ4uuZbWFQ_6inoQ01%3DWmhchzBwDFXCrUWC%2BaBKW7_ExOFq-GA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Feature Req / Bug list">graeme at sudo.ca
       </A><BR>
    <I>Thu Oct 24 19:30:31 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="030726.html">[rabbitmq-discuss] Feature Req / Bug list
</A></li>
        <LI>Next message: <A HREF="031349.html">[rabbitmq-discuss] Feature Req / Bug list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31340">[ date ]</a>
              <a href="thread.html#31340">[ thread ]</a>
              <a href="subject.html#31340">[ subject ]</a>
              <a href="author.html#31340">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone,

Took longer than I anticipated, but here's my first pass at reproducible
test cases for some of the issues I reported. Attached to this e-mail is a
tarball that I've been unpacking into /etc/rabbitmq/cluster on a 4CPU/4GB
RAM VM running CentOS 6.4, rabbitmq-server-3.2.0-1.noarch.rpm, and
librabbitmq-tools-0.3.0-1.el6.x86_64. These are the same issues we saw on
our production hardware, so they seem to be reproducible.

- cd /etc/rabbitmq/cluster
- create a 5 node local cluster: ./create_cluster.sh
- Bug: even though node and management port listeners are specified, the
first instance started will still incorrectly bind to port 55672 for the
management interface.
- remove existing queues and create and 100 queues in parallel:
./setup_queues.sh
- Bugs: many of the operations fail, instead of just blocking because the
cluster is busy, with a variety of error messages, and often even have
rabbit commands hang and never return. Run this script in a &quot;while true&quot;
bash loop to see it fall apart pretty quickly.
- populate queues with 1000 messages each in parallel: ./populate_queues.sh
- Note: shows low delivery rates noted before on spinning disks (60-80
msgs/sec), even though my VM storage is on btrfs RAID10 capable of
sustained block writes &gt; 200MB/s. iostat shows the VM is only generating
1-8 MB/s of IO. Looking at messages under
/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit2 at localhost</A>/queues, they seem to be chunked
into 64, 68, 72, and 84 kiB files before being delivered to the 16MiB
msg_store_persistent/*.rdq files. This implies a lot of random IO while
delivering messages, which explains why the performance problems disappear
when switching to SSDs, even just two SSDs in RAID1. Typically with other
data stores we'd expect to see on-disk chunks that are multiples of 128 MiB
to properly leverage RAID block IO, in both incoming and finalized data
stores. The effect of this is that it takes ~20m to load ~32 MiB of
messages, which is pretty awful.
- set policies to evenly balance queues across cluster nodes:
./rebalance_queues.sh
- Bugs: Also demonstrates API failures with too many simultaneous requests,
may require ctl-Cing the script to re-run it. Run multiple times, and admin
interface shows ~20% of queues don't fully sync to all 3 specified nodes
after new &quot;nodes&quot; policy is applied, they require additional sync commands
even though they have ha-sync-mode:automatic. After 2-3 runs, some queues
get stuck with &quot;0% resyncing&quot;, and the entire API interface stops
responding completely until the cluster is killed and restarted.

Hopefully you guys can replicate these results, since they are 100%
reproducible here. Any questions / comments, fire away.

Graeme


On Fri, Oct 4, 2013 at 11:32 AM, Graeme N &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">graeme at sudo.ca</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> On Fri, Oct 4, 2013 at 1:54 AM, Tim Watson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">watson.timothy at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> &gt; All items below were discovered while deploying 3.1.5 over the past few
</I>&gt;&gt;<i> days. Hosts in question have 24 sandy bridge HT cores, 64GB of RAM, XFS
</I>&gt;&gt;<i> filesystem, running on CentOS 6. Cluster is 5 nodes, with a default HA
</I>&gt;&gt;<i> policy on all queues of exact/3/automatic-sync.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131024/f1bf0302/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131024/f1bf0302/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: break-rabbitmq-v1.tar.xz
Type: application/x-xz
Size: 1312 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131024/f1bf0302/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131024/f1bf0302/attachment.bin</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030726.html">[rabbitmq-discuss] Feature Req / Bug list
</A></li>
	<LI>Next message: <A HREF="031349.html">[rabbitmq-discuss] Feature Req / Bug list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31340">[ date ]</a>
              <a href="thread.html#31340">[ thread ]</a>
              <a href="subject.html#31340">[ subject ]</a>
              <a href="author.html#31340">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
