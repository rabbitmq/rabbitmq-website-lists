<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [ANNOUNCEMENT] Introducing Lyra: A High Availability RabbitMQ Client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5BANNOUNCEMENT%5D%20Introducing%20Lyra%3A%20A%20High%0A%20Availability%20RabbitMQ%20Client&In-Reply-To=%3CCA%2Bes_-w0%3DpGcLP9%2BpwEbGAP%2BJRCa7uc2EPkRamErSWA8BEKh%3Dg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031529.html">
   <LINK REL="Next"  HREF="031534.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [ANNOUNCEMENT] Introducing Lyra: A High Availability RabbitMQ Client</H1>
    <B>Jonathan Halterman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%5BANNOUNCEMENT%5D%20Introducing%20Lyra%3A%20A%20High%0A%20Availability%20RabbitMQ%20Client&In-Reply-To=%3CCA%2Bes_-w0%3DpGcLP9%2BpwEbGAP%2BJRCa7uc2EPkRamErSWA8BEKh%3Dg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] [ANNOUNCEMENT] Introducing Lyra: A High Availability RabbitMQ Client">jhalterman at gmail.com
       </A><BR>
    <I>Thu Oct 31 02:49:56 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="031529.html">[rabbitmq-discuss] [ANNOUNCEMENT] Introducing Lyra: A High	Availability RabbitMQ Client
</A></li>
        <LI>Next message: <A HREF="031534.html">[rabbitmq-discuss] [ANNOUNCEMENT] Introducing Lyra: A High Availability RabbitMQ Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31533">[ date ]</a>
              <a href="thread.html#31533">[ thread ]</a>
              <a href="subject.html#31533">[ subject ]</a>
              <a href="author.html#31533">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matthias, Michael,

Interesting scenario - thanks for bringing it up. I'd like to address this,
but I'm not sure that there's an easy way to do it with the current
amqp-client API. Unlike Bunny's VersionedDeliveryTag which Michael pointed
out, the amqp-client API doesn't have a data structure that associates a
delivery tag with the channel its message was consumed through. We could
cache delivery tags for channels internally, but I'm hesitant to go down
that road.

While Lyra certainly makes it easier for this scenario to pop up, rare as
it might be, the same problem could occur without Lyra when swapping a
consumer over to a new channel after the consumer is unexpectedly cancelled
and/or the channel is unexpectedly closed. That said, no good solutions
come to mind just yet. Do you have any ideas?

Cheers,
Jonathan


On Wed, Oct 30, 2013 at 3:45 PM, Matthias Radestock
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;wrote:

&gt;<i> Jonathan,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 24/10/13 04:14, Jonathan Halterman wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Lyra distinguishes between recovery and retries. If an invocation
</I>&gt;&gt;<i> such as Channel.basicConsume fails due to an unexpected (not user
</I>&gt;&gt;<i> initiated) channel closure, the channel is automatically recovered,
</I>&gt;&gt;<i> along with any consumers, according to the configured recovery policy.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> one of the trickier aspects of implementing transparent recovery of AMQP
</I>&gt;<i> channels/connections is what to do about acks for messages received on a
</I>&gt;<i> previous incarnation of a channel. E.g. say a client has set up a consumer
</I>&gt;<i> and the server has sent a bunch of messages to the client. Then some event
</I>&gt;<i> - e.g. a 'publish' to an unknown exchange - occurs that causes the server
</I>&gt;<i> to close the channel with an error. Now, say the recovery logic is
</I>&gt;<i> transparently creating a new channel. Concurrently though, the consumer
</I>&gt;<i> code is still happily processing the messages it received before the error,
</I>&gt;<i> and attempting to ack them.
</I>&gt;<i>
</I>&gt;<i> If these acks go to the replacement channel, one of the following will
</I>&gt;<i> happen:
</I>&gt;<i> a) a 'precondition_failed' error is raised by the server, complaining
</I>&gt;<i> about an unknown delivery tag, or
</I>&gt;<i> b) the wrong message is acknowledged, i.e. a message sent on the
</I>&gt;<i> replacement channel which happens to have the same delivery tag as the
</I>&gt;<i> messsage sent on the original channel
</I>&gt;<i>
</I>&gt;<i> How does Lyra deal with this scenario?
</I>&gt;<i>
</I>&gt;<i> One way to handle this is to simply discard these acks. But that requires
</I>&gt;<i> the client/app to hold extra state, so it can identify them.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>&gt;<i> ______________________________**_________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.</A>**rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131030/856de645/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20131030/856de645/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031529.html">[rabbitmq-discuss] [ANNOUNCEMENT] Introducing Lyra: A High	Availability RabbitMQ Client
</A></li>
	<LI>Next message: <A HREF="031534.html">[rabbitmq-discuss] [ANNOUNCEMENT] Introducing Lyra: A High Availability RabbitMQ Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31533">[ date ]</a>
              <a href="thread.html#31533">[ thread ]</a>
              <a href="subject.html#31533">[ subject ]</a>
              <a href="author.html#31533">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
