<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ writes non stop to disk
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20writes%20non%20stop%20to%20disk&In-Reply-To=%3CCAD7X3-kZnpheaBwkpBWX0bBJS6LyS2i0v8O9ygTPGGfxBbKEtw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015726.html">
   <LINK REL="Next"  HREF="015792.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ writes non stop to disk</H1>
    <B>Raphael Simon</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20writes%20non%20stop%20to%20disk&In-Reply-To=%3CCAD7X3-kZnpheaBwkpBWX0bBJS6LyS2i0v8O9ygTPGGfxBbKEtw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ writes non stop to disk">raphael at rightscale.com
       </A><BR>
    <I>Tue Oct 25 17:22:23 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015726.html">[rabbitmq-discuss] RabbitMQ writes non stop to disk
</A></li>
        <LI>Next message: <A HREF="015792.html">[rabbitmq-discuss] RabbitMQ writes non stop to disk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15749">[ date ]</a>
              <a href="thread.html#15749">[ thread ]</a>
              <a href="subject.html#15749">[ subject ]</a>
              <a href="author.html#15749">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Emile, thanks for the reply, comments inline.

--
Raphael.

On Tue, Oct 25, 2011 at 1:39 AM, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:

&gt;<i> Hi Raphael,
</I>&gt;<i>
</I>&gt;<i> On 25/10/11 02:07, Raphael Simon wrote:
</I>&gt;<i> &gt; Hello all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We are seeing an issue on a production broker where the RabbitMQ process
</I>&gt;<i> &gt; writes non stop to files in mnesia/&lt;node&gt;/msg_store_persistent. It keeps
</I>&gt;<i> &gt; creating new files and the problem seems to be getting worse. Listing
</I>&gt;<i> &gt; the files in that directory shows that it's creating a new 16 MB file
</I>&gt;<i> &gt; every 2 to 4 minutes [1].
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The throughput of persistent messages in this broker is orders of
</I>&gt;<i> &gt; magnitude less (maybe 20 msg/sec at the most, each being in the 10s of
</I>&gt;<i> KB) .
</I>&gt;<i>
</I>&gt;<i> &gt; There are about 100 messages sitting in queues on that broker so that
</I>&gt;<i> &gt; should not cause that many writes, iostat shows about 6000 writes/s.
</I>&gt;<i>
</I>&gt;<i> How did you determine this number? Is it constant? I would expect the
</I>&gt;<i> behaviour you describe when some queues keep growing or when the broker
</I>&gt;<i> needs to free up alot of memory.
</I>&gt;<i>
</I>
We use collectd in combination with rabbitmqctl (not great for performance
but allows us to know what's going on in the brokers at a glance). So these
numbers are directly reported from a combination of rabbitmqctl and iostat
in this case over the course of days. They are fairly constant.


&gt;<i>
</I>&gt;<i> If the broker is running rabbit version 2.5.0 or later, could you please
</I>&gt;<i> supply the result of &quot;rabbitmqctl report&quot;?
</I>&gt;<i>
</I>
We are running rabbit 2.4.1

&gt;<i>
</I>&gt;<i> If it is an older version please run &quot;rabbitmqctl list_queues&quot; with all
</I>&gt;<i> queueinfoitems, and supply both the query and the result. The result of
</I>&gt;<i> &quot;erlang:memory().&quot; from the Erlang shell will also be helpful, as well
</I>&gt;<i> as a copy of the rabbit configuration file, if you have made any
</I>&gt;<i> relevant changes.
</I>&gt;<i>
</I>
So as mentioned above the result of rabbitmqctl list_queues is what we
graph/monitor. The box still has plenty of memory (7G free). Here is the
output of erlang:memory():

(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at broker1-1</A>)1&gt; erlang:memory().
[{total,3240343872},
 {processes,1558984664},
 {processes_used,1545242416},
 {system,1681359208},
 {atom,1924057},
 {atom_used,1908273},
 {binary,1456029912},
 {code,12256962},
 {ets,101781296}]

And here is our config:

[{rabbit, [{vm_memory_high_watermark, 0.5}]}].


&gt;<i> Are there any unusual entries in the broker logfile? How often does the
</I>&gt;<i> memory alarm trigger? Are there any entries that appear at the onset of
</I>&gt;<i> the disk activity?
</I>&gt;<i>
</I>
Nothing unusual in the logs (sasl log is empty, rabbit log just has the
usual connection starting / stopping).


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -Emile
</I>&gt;<i>
</I>&gt;<i>
</I>Something I didn't mention in my first email is that we have about 8
brokers running in production and only one is showing these symptoms, the
throughput is about the same through all brokers.

I've dug deeper using an erlang shell and see that two queue processes seem
to be causing most of the reductions. Looking at the corresponding variable
queue state I see that the target_ram_count of the vqstate record is 0.
This is reminiscent of a couple of bugs we had identified with Matthew
Sackman that he fixed in 2.4. I'm happy to provide more information on the
queue processes state if needed.

--
Raphael.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111025/d85b1185/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111025/d85b1185/attachment.htm</A>&gt;
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015726.html">[rabbitmq-discuss] RabbitMQ writes non stop to disk
</A></li>
	<LI>Next message: <A HREF="015792.html">[rabbitmq-discuss] RabbitMQ writes non stop to disk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15749">[ date ]</a>
              <a href="thread.html#15749">[ thread ]</a>
              <a href="subject.html#15749">[ subject ]</a>
              <a href="author.html#15749">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
