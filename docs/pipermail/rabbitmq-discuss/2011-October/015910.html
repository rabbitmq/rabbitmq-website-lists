<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Queue depth and no. of consumers.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20depth%20and%20no.%20of%20consumers.&In-Reply-To=%3C4f057906-233b-4748-8a1d-610b1a2fb932%40g21g2000yqc.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015863.html">
   <LINK REL="Next"  HREF="015916.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Queue depth and no. of consumers.</H1>
    <B>michael neidhardt</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20depth%20and%20no.%20of%20consumers.&In-Reply-To=%3C4f057906-233b-4748-8a1d-610b1a2fb932%40g21g2000yqc.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Queue depth and no. of consumers.">meem.ok at gmail.com
       </A><BR>
    <I>Mon Oct 31 14:31:26 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015863.html">[rabbitmq-discuss] Queue depth and no. of consumers.
</A></li>
        <LI>Next message: <A HREF="015916.html">[rabbitmq-discuss] Queue depth and no. of consumers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15910">[ date ]</a>
              <a href="thread.html#15910">[ thread ]</a>
              <a href="subject.html#15910">[ subject ]</a>
              <a href="author.html#15910">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi and thanks for the quick reply.

I do use ack, but not QoS. My program is as follows, using Perl and
Net::RabbitMQ:

-----------------------
my ($exchange, $queue, $routing_key) = ('myx', 'isi', 'isi');
my $mq = Net::RabbitMQ-&gt;new();
my $channel = 1;
$mq-&gt;connect($mqhost, { user =&gt; &quot;guest&quot;, password =&gt; &quot;guest&quot; });
$mq-&gt;channel_open($channel);
$mq-&gt;exchange_declare( $channel, $exchange, { exchange_type =&gt;
'direct',
                                              auto_delete =&gt; 0,
                                              durable =&gt; 0});

$mq-&gt;queue_declare( $channel, $queue, { auto_delete =&gt; 0, durable =&gt;
0});
$mq-&gt;queue_bind( $channel, $queue, $exchange, $routing_key);
$mq-&gt;consume($channel, $queue, { no_ack =&gt; 0 } );

while (1) {
    my $msg = $mq-&gt;recv();

    handle_file($msg-&gt;{body});
    $mq-&gt;ack($channel, $msg-&gt;{delivery_tag});
}
-----------------------

With no QoS set, I assume each consumer fetches as many messages as
possible (whatever that means),
and 'queues' them itself. I will try to set QoS/prefetch_count to 1,
though I seem to remember
having read that this can cause trouble. I would assume that it would
be no problem, have you got any thoughts on whether it's a good idea?

As I wrote earlier, we have a number (several thousand) of files to
process, each of which may contain up to several hundred thousand
records (around 2KB each).

In an earlier test, I let the processes handling files push the ID of
each record to a queue.
(Simply add a publish to the above code after the ack). The consumer
for this queue (which uses autoack) would do a lookup in a Postgresql
DB, and nothing else.
After about 50 million records, the vm_memory_high_watermark would be
set, and shortly after
that, I got &lt;&quot;timeout waiting for channel.flow_ok{active=false}&quot;,none}
&gt;<i>. Eventually the whole system froze.
</I>I guess this timeout is caused by my client not reacting to the flow
control from the RabbitMQ server. Is that correct? Unfortunately, the
client I use does not have methods for that. Should I expect to handle
this in normal operation, or could it be handled by a client for me?

Oh, and the big question: Is it out of the question to handle approx.
300 mill. messages (where payload is essentially a bigint) over a few
days?

Regards,
Michael.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015863.html">[rabbitmq-discuss] Queue depth and no. of consumers.
</A></li>
	<LI>Next message: <A HREF="015916.html">[rabbitmq-discuss] Queue depth and no. of consumers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15910">[ date ]</a>
              <a href="thread.html#15910">[ thread ]</a>
              <a href="subject.html#15910">[ subject ]</a>
              <a href="author.html#15910">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
