<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mirror queues and poor write performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirror%20queues%20and%20poor%20write%20performance&In-Reply-To=%3C20111026224223.GA4602%40wellquite.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015786.html">
   <LINK REL="Next"  HREF="015789.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mirror queues and poor write performance</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirror%20queues%20and%20poor%20write%20performance&In-Reply-To=%3C20111026224223.GA4602%40wellquite.org%3E"
       TITLE="[rabbitmq-discuss] Mirror queues and poor write performance">matthew at rabbitmq.com
       </A><BR>
    <I>Wed Oct 26 23:42:23 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015786.html">[rabbitmq-discuss] Mirror queues and poor write performance
</A></li>
        <LI>Next message: <A HREF="015789.html">[rabbitmq-discuss] Mirror queues and poor write performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15788">[ date ]</a>
              <a href="thread.html#15788">[ thread ]</a>
              <a href="subject.html#15788">[ subject ]</a>
              <a href="author.html#15788">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Oct 26, 2011 at 02:10:46PM -0700, Anderew wrote:
&gt;<i> I have been doing a very simple test and have found that in a two node
</I>&gt;<i> cluster write performance where the exchange is bound to a mirrored
</I>&gt;<i> queue is amazingly slow (orders of magnitude slower) compared to a non-
</I>&gt;<i> mirrored queue in an otherwise identical configuration. Dequeue
</I>&gt;<i> performance appears unaffected (i.e. very fast). The queues and
</I>&gt;<i> exchanges are non-durable in both cases. Both nodes in the cluster are
</I>&gt;<i> on the same machine so network latency will not be an factor.
</I>
How are you measuring publishing performance? Publishing is asynchronous
so unless there's some sort of TCP backpressure going on (not impossible
at all), I wouldn't have expected publishing performance to be affected.
That said, it definitely is the case that much much more CPU is being
spent per message and thus if you watch the queue length grow, it'll
grow at a much slower rate than with a non-mirrored queue.

When publishing to a single plain queue on a remote node, the msg is
sent between the nodes (between the node to which you're connected, and
the node upon which the queue resides) once.

When publishing to a mirrored queue where the master is on the node to
which you're connected, the msg will make at least 3 inter-node hops,
and there are further msgs associated with each msg that'll have to go
between nodes. This work alone (serialisation and de) adds substantial
cost.

&gt;<i> What are the expectations for mirror queue write performance? I
</I>&gt;<i> appreciate there is no such thing as a free lunch and that inevitably
</I>&gt;<i> there would be a runtime cost for mirroring.
</I>
I can't remember what the last figures were last time I benchmarked.
I'll try and find time to do some quick tests tomorrow and report back.
But my recollection is that the cost is fairly substantial. I have made
some attempts to minimise this cost - batching in a few places goes on
to try and maximise gain from serialising fewer bigger structures rather
than loads of little ones, but there are probably further opportunities
for optimisations yet to be made. That said, inevitably, there is an
awful lot more work that has to get done per message.

Matthew
</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015786.html">[rabbitmq-discuss] Mirror queues and poor write performance
</A></li>
	<LI>Next message: <A HREF="015789.html">[rabbitmq-discuss] Mirror queues and poor write performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15788">[ date ]</a>
              <a href="thread.html#15788">[ thread ]</a>
              <a href="subject.html#15788">[ subject ]</a>
              <a href="author.html#15788">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
