<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmq 2.6.1 cluster failure recovery
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq%202.6.1%20cluster%20failure%20recovery&In-Reply-To=%3Ca01c6aff-47b2-4dd9-b383-f19fed6c688a%405g2000yqo.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015352.html">
   <LINK REL="Next"  HREF="015338.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmq 2.6.1 cluster failure recovery</H1>
    <B>alain</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq%202.6.1%20cluster%20failure%20recovery&In-Reply-To=%3Ca01c6aff-47b2-4dd9-b383-f19fed6c688a%405g2000yqo.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmq 2.6.1 cluster failure recovery">alain.dazzi at gmail.com
       </A><BR>
    <I>Tue Oct  4 00:04:47 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015352.html">[rabbitmq-discuss] rabbitmq 2.6.1 cluster failure recovery
</A></li>
        <LI>Next message: <A HREF="015338.html">[rabbitmq-discuss] Number of connections and memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15354">[ date ]</a>
              <a href="thread.html#15354">[ thread ]</a>
              <a href="subject.html#15354">[ subject ]</a>
              <a href="author.html#15354">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simon,

Well I got it to work this time... It is unclear what was causing the
issue because I could ping the other node
and nmap would report that port 5672 was opened. I ended switching to
a different cluster of Ubuntu machines
running 10.04 rather than 11.04 (also the 2 machines I am using are
now on the same subnet). I wired the node ips in
/etc/hosts and bind producer/consumer by names.

I was able to create a mirrored-Q, push messages between a producer
and multiple consumers. The set-up seems to survive
when either one of the nodes goes down and comes back on line. Worked
with 1 disc node + 1 ram node as well as 2 disc nodes.

In my pika producer, receiver code I added ...

ha = {}
ha[&quot;x-ha-policy&quot;]=&quot;all&quot;
...
# declare queue
channel.queue_declare(queue=qname, passive=False, durable=True,
                            exclusive=False, auto_delete=False,
arguments=ha)

Thanks!

-A



On Oct 3, 4:26&#160;am, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">si... at rabbitmq.com</A>&gt; wrote:
&gt;<i> Hi Alain.
</I>&gt;<i>
</I>&gt;<i> When you see timeout_waiting_for_tables, that should mean that the node
</I>&gt;<i> you're trying to start:
</I>&gt;<i>
</I>&gt;<i> * Could not find any other cluster nodes running
</I>&gt;<i>
</I>&gt;<i> * Was not the last node to shut down
</I>&gt;<i>
</I>&gt;<i> &#160;From your explanation it sounds like node-1 *is* running while you
</I>&gt;<i> restart node-2 - is that correct? In that case, can node-2 definitely
</I>&gt;<i> see node-1? (i.e. it can ping cumulonimbus)
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> On 01/10/11 01:25, Alain Dazzi wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Hi,
</I>&gt;<i>
</I>&gt;<i> &gt; I can't get my rabbitmq cluster to recover from a dead node. So
</I>&gt;<i> &gt; perhaps someone can help ...
</I>&gt;<i>
</I>&gt;<i> &gt; node-1 (cumulonimbus)
</I>&gt;<i> &gt; Linux cumulonimbus 2.6.38-11-server #50-Ubuntu SMP Mon Sep 12 21:34:27
</I>&gt;<i> &gt; UTC 2011 x86_64 x86_64 x86_64 GNU/Linux
</I>&gt;<i> &gt; ii &#160;rabbitmq-server &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 2.6.1-1
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at cumulonimbus</A>:~# ls -1 /usr/lib/rabbitmq/lib/rabbitmq_server-2.6.1/plugins/
</I>&gt;<i> &gt; amqp_client-2.6.1.ez
</I>&gt;<i> &gt; mochiweb-1.3-rmq2.6.1-git9a53dbd.ez
</I>&gt;<i> &gt; rabbitmq_management-2.6.1.ez
</I>&gt;<i> &gt; rabbitmq_management_agent-2.6.1.ez
</I>&gt;<i> &gt; rabbitmq_management_visualiser-2.6.1.ez
</I>&gt;<i> &gt; rabbitmq_mochiweb-2.6.1.ez
</I>&gt;<i> &gt; README
</I>&gt;<i> &gt; webmachine-1.7.0-rmq2.6.1-hg0c4b60a.ez
</I>&gt;<i>
</I>&gt;<i> &gt; node-2 (nuage-informatique)
</I>&gt;<i> &gt; Linux nuage-informatique 2.6.38-11-generic #50-Ubuntu SMP Mon Sep 12
</I>&gt;<i> &gt; 21:17:25 UTC 2011 x86_64 x86_64 x86_64 GNU/Linux
</I>&gt;<i> &gt; ii &#160;rabbitmq-server &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 2.6.1-1
</I>&gt;<i>
</I>&gt;<i> &gt; 1/ stop both servers and set-up same .erlang_cookie value; restart nodes
</I>&gt;<i>
</I>&gt;<i> &gt; 2/ on node1 I create a cluster
</I>&gt;<i> &gt; &#160; &#160; &#160;rabbitmqctl stop_app
</I>&gt;<i> &gt; &#160; &#160; &#160;rabbitmqctl reset
</I>&gt;<i> &gt; &#160; &#160; &#160;rabbitmqctl cluster <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at nuage-informatique</A> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cumulonimbus</A>
</I>&gt;<i> &gt; Clustering node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cumulonimbus</A> with ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at nuage-informatique</A>',
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at cumulonimbus</A>] ...
</I>&gt;<i> &gt; ...done.
</I>&gt;<i>
</I>&gt;<i> &gt; 3/ This creates 2 disc nodes !!!
</I>&gt;<i>
</I>&gt;<i> &gt; 4/ run a test and pass data successfully
</I>&gt;<i>
</I>&gt;<i> &gt; 5/ restart node-2 (service rabbitmq-server stop)
</I>&gt;<i> &gt; service rabbitmq-server start ... fails with ...
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at nuage-informatique</A>:~/Desktop# service rabbitmq-server start
</I>&gt;<i> &gt; Starting rabbitmq-server: FAILED - check /var/log/rabbitmq/startup_{log, _err}
</I>&gt;<i> &gt; rabbitmq-server.
</I>&gt;<i> &gt; Erlang has closed
</I>&gt;<i> &gt; ^M
</I>&gt;<i> &gt; Crash dump was written to: erl_crash.dump^M
</I>&gt;<i> &gt; Kernel pid terminated (application_controller)
</I>&gt;<i> &gt; ({application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}})^M
</I>&gt;<i>
</I>&gt;<i> &gt; Activating RabbitMQ plugins ...
</I>&gt;<i> &gt; 1 plugins activated:
</I>&gt;<i> &gt; * rabbitmq_management_agent-2.6.1
</I>&gt;<i>
</I>&gt;<i> &gt; +---+ &#160; +---+
</I>&gt;<i> &gt; | &#160; | &#160; | &#160; |
</I>&gt;<i> &gt; | &#160; | &#160; | &#160; |
</I>&gt;<i> &gt; | &#160; | &#160; | &#160; |
</I>&gt;<i> &gt; | &#160; +---+ &#160; +-------+
</I>&gt;<i> &gt; | &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; |
</I>&gt;<i> &gt; | RabbitMQ &#160;+---+ &#160; |
</I>&gt;<i> &gt; | &#160; &#160; &#160; &#160; &#160; | &#160; | &#160; |
</I>&gt;<i> &gt; | &#160; v2.6.1 &#160;+---+ &#160; |
</I>&gt;<i> &gt; | &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; |
</I>&gt;<i> &gt; +-------------------+
</I>&gt;<i> &gt; AMQP 0-9-1 / 0-9 / 0-8
</I>&gt;<i> &gt; Copyright (C) 2007-2011 VMware, Inc.
</I>&gt;<i> &gt; Licensed under the MPL. &#160;<A HREF="Seehttp://www.rabbitmq.com/">Seehttp://www.rabbitmq.com/</A>
</I>&gt;<i>
</I>&gt;<i> &gt; node &#160; &#160; &#160; &#160; &#160; : <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at nuage-informatique</A>
</I>&gt;<i> &gt; app descriptor :
</I>&gt;<i> &gt; /usr/lib/rabbitmq/lib/rabbitmq_server-2.6.1/sbin/../ebin/rabbit.app
</I>&gt;<i> &gt; home dir &#160; &#160; &#160; : /var/lib/rabbitmq
</I>&gt;<i> &gt; config file(s) : (none)
</I>&gt;<i> &gt; cookie hash &#160; &#160;: qHpvLciGsi5o4f8ScVzyWg==
</I>&gt;<i> &gt; log &#160; &#160; &#160; &#160; &#160; &#160;: /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rab... at nuage-informatique.log</A>
</I>&gt;<i> &gt; sasl log &#160; &#160; &#160; : /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rab... at nuage-informatique-sasl.log</A>
</I>&gt;<i> &gt; database dir &#160; : /var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at nuage-informatique</A>
</I>&gt;<i> &gt; erlang version : 5.7.4
</I>&gt;<i>
</I>&gt;<i> &gt; -- rabbit boot start
</I>&gt;<i> &gt; starting file handle cache server &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ...done
</I>&gt;<i> &gt; starting worker pool &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;...done
</I>&gt;<i> &gt; starting database
</I>&gt;<i> &gt; ...BOOT ERROR: FAILED
</I>&gt;<i> &gt; Reason: {error,
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{timeout_waiting_for_tables,
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;[rabbit_user,rabbit_user_permission,rabbit_vhost,
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; rabbit_durable_route,rabbit_durable_exchange,
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; rabbit_durable_queue]}}
</I>&gt;<i> &gt; Stacktrace: [{rabbit_mnesia,wait_for_tables,1},
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {rabbit_mnesia,check_schema_integrity,0},
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {rabbit_mnesia,ensure_schema_integrity,0},
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {rabbit_mnesia,init,0},
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {rabbit,'-run_boot_step/1-lc$^1/1-1-',1},
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {rabbit,run_boot_step,1},
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {rabbit,'-start/2-lc$^0/1-0-',1},
</I>&gt;<i> &gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {rabbit,start,2}]
</I>&gt;<i> &gt; {&quot;Kernel pid terminated&quot;,application_controller,&quot;{application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}}&quot;}^M
</I>&gt;<i>
</I>&gt;<i> &gt; At this point I have to re-install node-2 to recover.
</I>&gt;<i>
</I>&gt;<i> &gt; Any idea why?
</I>&gt;<i>
</I>&gt;<i> &gt; Thank you,
</I>&gt;<i>
</I>&gt;<i> &gt; next I would like to test mirrored q but obviously this has to work first...
</I>&gt;<i>
</I>&gt;<i> &gt; -Alain
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, VMware
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015352.html">[rabbitmq-discuss] rabbitmq 2.6.1 cluster failure recovery
</A></li>
	<LI>Next message: <A HREF="015338.html">[rabbitmq-discuss] Number of connections and memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15354">[ date ]</a>
              <a href="thread.html#15354">[ thread ]</a>
              <a href="subject.html#15354">[ subject ]</a>
              <a href="author.html#15354">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
