<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Message is delivered to all queue consumers when	rabbitmq crashes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Message%20is%20delivered%20to%20all%20queue%20consumers%20when%0A%09rabbitmq%20crashes&In-Reply-To=%3C67adaf50-e0a7-49f2-9868-4a362ab1333e%40k35g2000yqh.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015616.html">
   <LINK REL="Next"  HREF="015659.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Message is delivered to all queue consumers when	rabbitmq crashes</H1>
    <B>rasadoll</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Message%20is%20delivered%20to%20all%20queue%20consumers%20when%0A%09rabbitmq%20crashes&In-Reply-To=%3C67adaf50-e0a7-49f2-9868-4a362ab1333e%40k35g2000yqh.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Message is delivered to all queue consumers when	rabbitmq crashes">rasadoll at gmail.com
       </A><BR>
    <I>Wed Oct 19 21:02:11 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015616.html">[rabbitmq-discuss] Upgrading...
</A></li>
        <LI>Next message: <A HREF="015659.html">[rabbitmq-discuss] Message is delivered to all queue consumers when	rabbitmq crashes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15615">[ date ]</a>
              <a href="thread.html#15615">[ thread ]</a>
              <a href="subject.html#15615">[ subject ]</a>
              <a href="author.html#15615">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have multiple queue consumers running at the same time. They all
listen to one single queue. Messages are sent to the default exchange
with queue name as the routing key. When one of the consumers is busy
processing a message, before acking the message if RabbitMQ service
crashes (simply by stopping the service), the message is sent to all
other consumers immediately which results in processing the same
message multiple times concurrently. Is this the right behavior for
RabbitMQ?

Here is my queue design:

Map&lt;String, Object&gt; args = new HashMap&lt;String, Object&gt;();
args.put(&quot;x-ha-policy&quot;, &quot;all&quot;);
channel.queueDeclare(JOB_EXEC_QUEUE, true, false, false, args);

I use durable HA queue but I am not running in a clustered
environment.
===========================
Message publishing:

channel.basicPublish(&quot;&quot;, JOB_EXEC_QUEUE,
MessageProperties.PERSISTENT_BASIC, message.getBytes());
===========================
Consumer Code:

channel.basicQos(1);
QueueingConsumer consumer = new QueueingConsumer(channel);
channel.basicConsume(JOB_EXEC_QUEUE, consumer);

QueueingConsumer.Delivery delivery;
while (true) {
        try {
          delivery = consumer.nextDelivery();
        } catch (InterruptedException ie) {
          continue;
        }

// process the message

       channel.basicAck(delivery.getEnvelope().getDeliveryTag(),
false);
}

I stop the service when one consumer is in the process message phase.

Am I doing something wrong? Is this an expected behavior for RabbitMQ?

Thanks,
Reza
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015616.html">[rabbitmq-discuss] Upgrading...
</A></li>
	<LI>Next message: <A HREF="015659.html">[rabbitmq-discuss] Message is delivered to all queue consumers when	rabbitmq crashes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15615">[ date ]</a>
              <a href="thread.html#15615">[ thread ]</a>
              <a href="subject.html#15615">[ subject ]</a>
              <a href="author.html#15615">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
