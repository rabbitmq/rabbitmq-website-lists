<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Implementing Prioritised Queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Implementing%20Prioritised%20Queues&In-Reply-To=%3CCAEo4zpeNRc5N5EzruQ%2BO5iouo5H2obuaugPpg6LiVHXknLU2kw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015527.html">
   <LINK REL="Next"  HREF="015496.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Implementing Prioritised Queues</H1>
    <B>James Dear</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Implementing%20Prioritised%20Queues&In-Reply-To=%3CCAEo4zpeNRc5N5EzruQ%2BO5iouo5H2obuaugPpg6LiVHXknLU2kw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Implementing Prioritised Queues">jamesdear at gmail.com
       </A><BR>
    <I>Thu Oct 13 16:25:58 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015527.html">[rabbitmq-discuss] Implementing Prioritised Queues
</A></li>
        <LI>Next message: <A HREF="015496.html">[rabbitmq-discuss]  Frustrated
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15505">[ date ]</a>
              <a href="thread.html#15505">[ thread ]</a>
              <a href="subject.html#15505">[ subject ]</a>
              <a href="author.html#15505">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I notice that RabbitMQ QoS does some kind of probabilistic
load-balancing between queues in a channel. If the client could
specify a priority factor (or even better a probabilistic priority
factor) for each queue it subscribes to, and the server would then
load-balance according to the supplied factors, then this would solve
the problem entirely.

It would also add great flexibility for running clustered computing.
For example, suppose Alice and Bob both work for BigCorp, and each
have a cluster of 1000 cores. The comp resources required are not
uniform over time - there's lots of head-scratching time when Alice is
figuring out what calculation to do next and same for Bob. Hence Alice
is fine with Bob using her cores when they are inactive (ie when
Alice's queue is empty) but wants immediate access when she happens to
want to run her own numbers. Likewise for Bob. So they both ensure
that their clients subscribe to both queues, but Alice's cores
prioritize Alice's queue and Bob's cores prioritize Bob's queue.

I used to work in a large bank where they had this problem big time.
There were literally dozens of 500+ core 'silos' that were idle most
of the time, but were required to be that large so that when they
*were* needed they could kick out an answer rapidly. The different
groups didn't trust each other enough to give each other symmetric
access (for good reason - in reality groups never cared about other
groups), and siloization was the only alternative.

On 13 October 2011 13:55, James Dear &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jamesdear at gmail.com</A>&gt; wrote:
&gt;<i> Thanks.
</I>&gt;<i>
</I>&gt;<i> But if the application buffer is of bounded size (say &lt; N messages),
</I>&gt;<i> and the buffer is fed at equal rate from Q1 &amp; Q2, then over a
</I>&gt;<i> time-horizon &gt;&gt; N the buffer will become saturated with lower-priority
</I>&gt;<i> Q2 messages and the application will start receiving Q1 and Q2 at an
</I>&gt;<i> equal rate again. To solve this you could do one of:
</I>&gt;<i> 1. Have an unlimited buffer or
</I>&gt;<i> 2. Ensure the buffer receives Q1 more rapidly than Q2 or
</I>&gt;<i> 3. Allow the buffer to reject/requeue when it gets saturated with Q2 or
</I>&gt;<i> 4. Something else?
</I>&gt;<i>
</I>&gt;<i> 1. is not really feasible, 2. means there's no longer a need for a
</I>&gt;<i> buffer anyway, not sure about 3. but it seems inefficient.
</I>&gt;<i>
</I>&gt;<i> Is there some other way?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 13 October 2011 12:23, Eugene Kirpichov &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ekirpichov at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> Just consume both queues and internally, in your application,
</I>&gt;&gt;<i> implement &quot;getting next message&quot; as &quot;next from your application's
</I>&gt;&gt;<i> buffer associated with Q1 if it's nonempty, otherwise next from Q2's
</I>&gt;&gt;<i> buffer&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Thu, Oct 13, 2011 at 3:17 PM, James Dear &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jamesdear at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Referring back to a thread active in Feb, it seems the recommended way
</I>&gt;&gt;&gt;<i> to implement a priority queue is to have multiple queues, one for each
</I>&gt;&gt;&gt;<i> priority level:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The usual way of implementing priorities is to use separate queues for
</I>&gt;&gt;&gt;&gt;<i> each priority. So if you need two priority levels then declare queues Q1
</I>&gt;&gt;&gt;&gt;<i> and Q2. Route messages to those queues based on priority and have
</I>&gt;&gt;&gt;&gt;<i> clients consume from queues in that order. So Q2 messages won't be
</I>&gt;&gt;&gt;&gt;<i> consumed unless Q1 is empty.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> How do you actually implement the logic &quot;consume Q2 iff Q1 empty else
</I>&gt;&gt;&gt;<i> consume Q1&quot;? I've read through much of the docs but can't see anything
</I>&gt;&gt;&gt;<i> other than using GET, but I thought I read somewhere that GET was much
</I>&gt;&gt;&gt;<i> slower than CONSUME.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Can anyone help me with this? By the way, I'm writing in python/pika,
</I>&gt;&gt;&gt;<i> although any language example would help me.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> James
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Eugene Kirpichov
</I>&gt;&gt;<i> Principal Engineer, Mirantis Inc. <A HREF="http://www.mirantis.com/">http://www.mirantis.com/</A>
</I>&gt;&gt;<i> Editor, <A HREF="http://fprog.ru/">http://fprog.ru/</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I></PRE>


































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015527.html">[rabbitmq-discuss] Implementing Prioritised Queues
</A></li>
	<LI>Next message: <A HREF="015496.html">[rabbitmq-discuss]  Frustrated
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15505">[ date ]</a>
              <a href="thread.html#15505">[ thread ]</a>
              <a href="subject.html#15505">[ subject ]</a>
              <a href="author.html#15505">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
