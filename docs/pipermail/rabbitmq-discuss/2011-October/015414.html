<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Pika disconnects
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pika%20disconnects&In-Reply-To=%3CCABzX%2Bqybvkw8nobazKaXj4U82%3DVGD-jhxspG71-Oc0eP1Chgbg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015442.html">
   <LINK REL="Next"  HREF="015425.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Pika disconnects</H1>
    <B>Marek Majkowski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Pika%20disconnects&In-Reply-To=%3CCABzX%2Bqybvkw8nobazKaXj4U82%3DVGD-jhxspG71-Oc0eP1Chgbg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Pika disconnects">majek04 at gmail.com
       </A><BR>
    <I>Sat Oct  8 13:50:45 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015442.html">[rabbitmq-discuss] Fairness wrt queues under heavy load
</A></li>
        <LI>Next message: <A HREF="015425.html">[rabbitmq-discuss] Pika disconnects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15414">[ date ]</a>
              <a href="thread.html#15414">[ thread ]</a>
              <a href="subject.html#15414">[ subject ]</a>
              <a href="author.html#15414">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, Oct 8, 2011 at 13:06, John Reuning &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">john at ibiblio.org</A>&gt; wrote:
&gt;<i> Marek,
</I>&gt;<i>
</I>&gt;<i> Your note about the event loop and socket buffers makes sense. &#160;The
</I>&gt;<i> application in question is multi threaded, but only one thread
</I>&gt;<i> accesses the pika objects. &#160;Code in the main thread creates several
</I>&gt;<i> objects in separate threads. &#160;One of these second-layer threads
</I>&gt;<i> watches for events in the application and publishes messages to
</I>&gt;<i> rabbitmq.
</I>
Assuming that the same thread does:
 * event loop
 * consuming
 * publishing

It should be fine :)

&gt;<i> The current implementation has another threaded object spawned by the
</I>&gt;<i> event watcher, which contains the pika event loop and connection to
</I>&gt;<i> rabbitmq. The event watcher is the only object/thread that calls
</I>&gt;<i> basic_publish on the pika channel object. Do problems occur when
</I>&gt;<i> merely crossing a thread boundary using pika?
</I>
It doesn't matter which thread handles pika connection.
But it matters a lot that when you're doing anything
related to amqp connection, no other thread should
be doing anything on that connection.
(including waiting in event loop).

In other words:
 - you can't have blocking event loop in one thread
 - and publish from other thread.

If you want to publish, you need to stop event loop,
publish, and restart event loop. It doesn't matter
which thread does what, but it matters that only
one thread accesses pika stuff at a time.

(I hope that Gavin, pika maintainer, will fix me if I'm wrong)

Cheers,
    Marek


&gt;<i>&#160;Or should this approach
</I>&gt;<i> work as long as the pika objects are only ever used by one thread?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> -John
</I>&gt;<i>
</I>&gt;<i> On Sat, Oct 8, 2011 at 6:03 AM, Marek Majkowski &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">majek04 at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> John,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Pika doesn't support multi threading. Wrapping single basic_publish
</I>&gt;&gt;<i> isn't good enough - the side effect of this command (network buffer)
</I>&gt;&gt;<i> is going to affect different thread (the thread with event loop).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm afraid there isn't a simple workaround. You can try to wrap
</I>&gt;&gt;<i> everything (including event loop) in a lock - and thus allow only
</I>&gt;&gt;<i> one thread at a time to use connection/network socket/buffers.
</I>&gt;&gt;<i> But doing that will be rather hard (how to stop event loop
</I>&gt;&gt;<i> if other thread wants to publish?)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Or, maybe a better solution would be to use multiple connections,
</I>&gt;&gt;<i> one connection per thread.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does it sound reasonable?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i> &#160; Marek
</I>&gt;&gt;<i>
</I>&gt;<i>
</I></PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015442.html">[rabbitmq-discuss] Fairness wrt queues under heavy load
</A></li>
	<LI>Next message: <A HREF="015425.html">[rabbitmq-discuss] Pika disconnects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15414">[ date ]</a>
              <a href="thread.html#15414">[ thread ]</a>
              <a href="subject.html#15414">[ subject ]</a>
              <a href="author.html#15414">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
