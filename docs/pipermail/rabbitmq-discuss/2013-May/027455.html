<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Graceful shutdown of blocking consumers in PHP?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Graceful%20shutdown%20of%20blocking%20consumers%20in%20PHP%3F&In-Reply-To=%3C519E7FDD.9090608%40surfmerchants.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027545.html">
   <LINK REL="Next"  HREF="027460.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Graceful shutdown of blocking consumers in PHP?</H1>
    <B>Colleen Mirabello</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Graceful%20shutdown%20of%20blocking%20consumers%20in%20PHP%3F&In-Reply-To=%3C519E7FDD.9090608%40surfmerchants.com%3E"
       TITLE="[rabbitmq-discuss] Graceful shutdown of blocking consumers in PHP?">colleen at surfmerchants.com
       </A><BR>
    <I>Thu May 23 21:45:17 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027545.html">[rabbitmq-discuss] RabbitMQ Federation &amp; SSL
</A></li>
        <LI>Next message: <A HREF="027460.html">[rabbitmq-discuss] Graceful shutdown of blocking consumers in	PHP?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27455">[ date ]</a>
              <a href="thread.html#27455">[ thread ]</a>
              <a href="subject.html#27455">[ subject ]</a>
              <a href="author.html#27455">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>(PHP 5.33, AMQP protocol 0-9-1, librabbitmq 0.0.1, phpamqp 1.0.9)

I'm having trouble figuring out how to gracefully shut down a blocking 
PHP consumer.

The context of this problem is that we would like to create a script 
that forks many consumer children based on a configuration file. That 
script will then monitor its children and restart them should any fail. 
We would also like to be able to kill this parent script and have it 
stop and kill its children and then exit.

Our preference is to use consume() rather than get() if possible.

The problem we're having is how to get a signal to the child processes 
to get them to stop consuming.

A very simple example script (with connection info removed):

&lt;?php
// so we can catch system calls...
declare(ticks=1);

pcntl_signal(SIGTERM, array('RunControl', 'sysCalls'));
pcntl_signal(SIGHUP, array('RunControl', 'sysCalls'));
pcntl_signal(SIGUSR1, array('RunControl', 'sysCalls'));


class RunControl
{
     static $alive = true;

     // catch system calls
     function sysCalls($signal)
     {
         print &quot;Got signal to die\n&quot;;
     }
}

function consume($message, $queue)
{
     print &quot;Got a message!\n&quot;;
     $queue-&gt;ack($message-&gt;getDeliveryTag());
}


$connection = new AMQPConnection($connectionInfo);
$connection-&gt;connect();

$channel = new AMQPChannel($connection);
$queue = new AMQPQueue($channel);

$queue-&gt;setName('my_queue');

$queue-&gt;consume('consume');
?&gt;

If I run this script, the consumer will happily consume messages. 
However, executing a kill command on its pid does not cause the &quot;Got 
signal to die&quot; message to print.

I have tried using $queue-&gt;cancel() in many different configurations 
(within the same script, in another script, with a consumer tag, 
without), but it doesn't seem to do anything.

I tried the workaround described here: 
<A HREF="http://blog.andrewrose.co.uk/2008/02/php-getting-signals-through-to-blocking.html">http://blog.andrewrose.co.uk/2008/02/php-getting-signals-through-to-blocking.html</A> 
and it resulted in a whole bunch of &quot;interrupted system call&quot; exceptions.

Does anyone have any suggestions for how I can get my consumer to exit 
gracefully? Thanks.

     - Colleen


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130523/12f9abd0/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130523/12f9abd0/attachment.htm</A>&gt;
</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027545.html">[rabbitmq-discuss] RabbitMQ Federation &amp; SSL
</A></li>
	<LI>Next message: <A HREF="027460.html">[rabbitmq-discuss] Graceful shutdown of blocking consumers in	PHP?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27455">[ date ]</a>
              <a href="thread.html#27455">[ thread ]</a>
              <a href="subject.html#27455">[ subject ]</a>
              <a href="author.html#27455">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
