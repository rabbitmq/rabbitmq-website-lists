<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%203.1.0%20lost%20messages%20and%20autoheal%0A%20failures%20when%20recovering%20from%20cluster%20partition&In-Reply-To=%3C5199FB29.70306%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027291.html">
   <LINK REL="Next"  HREF="027586.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%203.1.0%20lost%20messages%20and%20autoheal%0A%20failures%20when%20recovering%20from%20cluster%20partition&In-Reply-To=%3C5199FB29.70306%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition">simon at rabbitmq.com
       </A><BR>
    <I>Mon May 20 11:30:01 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027291.html">[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
</A></li>
        <LI>Next message: <A HREF="027586.html">[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27347">[ date ]</a>
              <a href="thread.html#27347">[ thread ]</a>
              <a href="subject.html#27347">[ subject ]</a>
              <a href="author.html#27347">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/05/13 20:38, Maslinski, Ray wrote:
&gt;<i> Hello,
</I>
Hi!

&gt;<i> To simulate a network partition failure, I&#8217;ve been using iptables to
</I>&gt;<i> temporarily block inbound and outbound access on one of the nodes to the
</I>&gt;<i> single port configured for cluster communications through
</I>&gt;<i> inet_dist_listen_min and inet_dist_listen_max settings (min = max).
</I>&gt;<i> Client access is not blocked during a simulated partition fault.
</I>
Sounds reasonable.

&gt;<i> I&#8217;ve observed two anomalies during testing that I wasn&#8217;t expecting based
</I>&gt;<i> on the documentation I&#8217;ve read:
</I>&gt;<i>
</I>&gt;<i> -At a sufficiently high message rate, some number of messages will be
</I>&gt;<i> lost during the fault sequence, with the number lost tending to increase
</I>&gt;<i> with message rate.  No indication of a send error has been observed by
</I>&gt;<i> the client program. Based on results obtained from test logs and an
</I>&gt;<i> independent monitor listening on trace messages from each node, it
</I>&gt;<i> appears that as soon as the port is blocked, both nodes continue to
</I>&gt;<i> accept published messages, but (temporarily) stop delivering messages
</I>&gt;<i> until the cluster heartbeat failure is detected, at which point the
</I>&gt;<i> cluster is partitioned and the slave promotes itself to become master.
</I>&gt;<i> In the sequences I&#8217;ve looked at, the messages that are lost all appear
</I>&gt;<i> to be published to the original master (and final master after a winner
</I>&gt;<i> is selected during autoheal).  Neither the start nor the end of the lost
</I>&gt;<i> message window appear to line up with any events in the logs, other than
</I>&gt;<i> the start occurring sometime after the port connection is blocked but
</I>&gt;<i> before the cluster heartbeat failure is detected, and the end occurring
</I>&gt;<i> sometime after the detection of the cluster heartbeat failure and before
</I>&gt;<i> the detection of the partitioned cluster after the connection is
</I>&gt;<i> unblocked.  Is message loss to be expected in this scenario?
</I>
I would expect to see message loss in a cluster heal scenario.

It's important to remember that a cluster partition is still a 
substantial problem, and the healing process involves throwing state 
away. Autoheal mode just means you get through this process faster, and 
hopefully spend much less time accepting messages that will end up being 
lost.

I would expect intuitively that only messages from the losing partitions 
would be lost. But I am not entirely surprised if messages from the 
winner are lost too; there is a period after the partitions have come 
back together but before autoheal kicks in during which we will have 
multiple masters for a queue, and behaviour can be unpredictable.

&gt;<i> -Occasionally the autoheal loser node fails to rejoin the cluster after
</I>&gt;<i> restart.  I don&#8217;t have a lot of data points on this one since it&#8217;s only
</I>&gt;<i> happened a handful of times during overnight test iterations.  During
</I>&gt;<i> one failure, the autoheal winner showed the log message below during
</I>&gt;<i> recovery:
</I>
Ah, that looks like a bug in autoheal. I think the stack trace you 
posted should contain enough information to fix it. Thanks.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027291.html">[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
</A></li>
	<LI>Next message: <A HREF="027586.html">[rabbitmq-discuss] RabbitMQ 3.1.0 lost messages and autoheal failures when recovering from cluster partition
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27347">[ date ]</a>
              <a href="thread.html#27347">[ thread ]</a>
              <a href="subject.html#27347">[ subject ]</a>
              <a href="author.html#27347">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
