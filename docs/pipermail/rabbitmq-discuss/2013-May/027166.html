<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] .NET Client Connection.CreateModel Possible Deadlock / Not Thread Safe?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.NET%20Client%20Connection.CreateModel%20Possible%0A%20Deadlock%20/%20Not%20Thread%20Safe%3F&In-Reply-To=%3Cd396c1b3-a161-44f3-b806-8f25140b62e7%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027240.html">
   <LINK REL="Next"  HREF="027245.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] .NET Client Connection.CreateModel Possible Deadlock / Not Thread Safe?</H1>
    <B>Chris Haines</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.NET%20Client%20Connection.CreateModel%20Possible%0A%20Deadlock%20/%20Not%20Thread%20Safe%3F&In-Reply-To=%3Cd396c1b3-a161-44f3-b806-8f25140b62e7%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] .NET Client Connection.CreateModel Possible Deadlock / Not Thread Safe?">cjbhaines at gmail.com
       </A><BR>
    <I>Tue May 14 17:56:42 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027240.html">[rabbitmq-discuss] Flow control issue when shovelling messages between data centres
</A></li>
        <LI>Next message: <A HREF="027245.html">[rabbitmq-discuss] .NET Client Connection.CreateModel Possible Deadlock / Not Thread Safe?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27166">[ date ]</a>
              <a href="thread.html#27166">[ thread ]</a>
              <a href="subject.html#27166">[ subject ]</a>
              <a href="author.html#27166">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi All,

Server version: 3.0.4
.NET client version: 3.0.4

I have had a problem on my Production servers this week where it looks like 
the call to CreateModel on IConnection is not thread safe, despite the 
documentation indicating that the entire IConnection should be thread safe. 
My application runs a single shared connection with somewhere in the region 
of 200-400 threads which will be creating models for at least 1 consumer 
and many publishers per thread. It looks like we had a small 
network hiccup and the connection reset, prompting all of the 
publishers/consumers to request new models at the same time. There is a 
very high chance that there will be threading clashes in this circumstance. 
The symptom after a threading clash is that all current requests for 
Connection.CreateModel() will throw an exception with the following error:

RabbitMQ.Client.Exceptions.OperationInterruptedException: The AMQP 
operation was interrupted: AMQP close-reason, initiated by Peer, code=503, 
text=&quot;COMMAND_INVALID - second 'channel.open' seen&quot;, classId=20, 
methodId=10, cause=

And any subsequent requests to IConnection.CreateModel() on that connection 
instance indefinitely hang. I have managed to resolve this for now by 
adding locking around channel creation.

I have attached an NUnit test file which recreates this problem. The test 
case that uses locking will pass and the test without locking will 
indefinitely hang after it tries to create a channel on line 62 (at which 
point all of the threads are now hanging requesting a model).

Has anyone seen any problems like this before?

Cheers,
Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130514/124cd32f/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130514/124cd32f/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: MultiThreadedChannelCreationTest.cs
Type: text/x-csharp
Size: 3634 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130514/124cd32f/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130514/124cd32f/attachment.bin</A>&gt;
</PRE>







































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027240.html">[rabbitmq-discuss] Flow control issue when shovelling messages between data centres
</A></li>
	<LI>Next message: <A HREF="027245.html">[rabbitmq-discuss] .NET Client Connection.CreateModel Possible Deadlock / Not Thread Safe?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27166">[ date ]</a>
              <a href="thread.html#27166">[ thread ]</a>
              <a href="subject.html#27166">[ subject ]</a>
              <a href="author.html#27166">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
