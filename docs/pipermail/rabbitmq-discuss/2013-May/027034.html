<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cluster upgrade failed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20upgrade%20failed&In-Reply-To=%3C42A58CC11C25A241AE9FC4C208C742C3521A61%40emsbs1.esteeinc.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027032.html">
   <LINK REL="Next"  HREF="027035.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cluster upgrade failed</H1>
    <B>Tracy Dalzell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20upgrade%20failed&In-Reply-To=%3C42A58CC11C25A241AE9FC4C208C742C3521A61%40emsbs1.esteeinc.local%3E"
       TITLE="[rabbitmq-discuss] Cluster upgrade failed">tracy at guisolutions.com
       </A><BR>
    <I>Thu May  9 15:52:35 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027032.html">[rabbitmq-discuss] Cluster upgrade failed
</A></li>
        <LI>Next message: <A HREF="027035.html">[rabbitmq-discuss] Cluster upgrade failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27034">[ date ]</a>
              <a href="thread.html#27034">[ thread ]</a>
              <a href="subject.html#27034">[ subject ]</a>
              <a href="author.html#27034">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simon,
Here's what happened... I followed the cluster upgrade instructions by
taking down each server (service rabbitmg-server stop) in order 1,2,3,4.
Upgraded and restarted in reverse order 4,3,2,1.  When they came back up
I could only login as guest.  All users and vhosts are gone, 2 and 3
were clustered and 1 and 4 were standalone. They are behind an HAProxy
so when I would refresh the management UI I see only nodes 2 and 3
clustered, then only 1, then only 4, etc...

I recreated the cluster, join_cluster rabbit01 -&gt; rabbit02 then rabbit04
-&gt; rabbit02.  The cluster looked good but still no users or fabric.  It
did however, show that one of the nodes was using 16GB of disk and I
knew that was persistent messages that were in a queue when I took
everything down.  I started poking around on all the servers and all the
config and db files seemed to be in place .  I was just about to reset
everything when I found the problem....

The upgrade apparently created a new rabbitmq-env file and a new
symbolic link /usr/lib/rabbitmq/bin/rabbitmq-env -&gt;
../lib/rabbitmq_server-3.1.0/sbin/rabbitmq-env.  Our 3.0.4 configuration
had the following entries in rabbitmq-env:

RABBITMQ_MNESIA_BASE=/mnt/data/rabbitmq/mnesia
export RABBITMQ_MNESIA_BASE

Those two entries were not in the new rabbitmq-env file so when rabbit
started after the upgrade the mnesia database was reinitialized in the
default location.  I took down all the servers, edited the file on each
server, brought them back up and then I had a big phat rabbit, just the
way I like it.

Tracy

-----Original Message-----
From: Simon MacMullen [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>] 
Sent: Thursday, May 09, 2013 9:42 AM
To: Discussions about RabbitMQ
Cc: Tracy Dalzell; Daniel Buchko
Subject: Re: [rabbitmq-discuss] Cluster upgrade failed

Hi. So this looks very much like each node was somehow reset during the
upgrade process.

What exactly did you do for each upgrade?

Cheers, Simon

On 08/05/13 18:13, Tracy Dalzell wrote:
&gt;<i> Status reports attached
</I>&gt;<i>
</I>&gt;<i> *From:*Daniel Buchko [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dbuchko at gopivotal.com</A>]
</I>&gt;<i> *Sent:* Wednesday, May 08, 2013 12:48 PM
</I>&gt;<i> *To:* <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> *Cc:* Tracy Dalzell
</I>&gt;<i> *Subject:* Fwd: Cluster upgrade failed
</I>&gt;<i>
</I>&gt;<i> Forwarding on behalf of Tracy....
</I>&gt;<i>
</I>&gt;<i> ---------- Forwarded message ----------
</I>&gt;<i> From: *Tracy Dalzell* &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tracy at guisolutions.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tracy at guisolutions.com</A>&gt;&gt;
</I>&gt;<i> Date: Wed, May 8, 2013 at 11:59 AM
</I>&gt;<i> Subject: Cluster upgrade failed
</I>&gt;<i> To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> I just upgraded a four node cluster from 3.0.4 -&gt; 3.1.  I took them 
</I>&gt;<i> down (stopped the rabbit server) in order 1,2,3,4.  Upgraded and 
</I>&gt;<i> restarted in reverse order 4,3,2,1.  When everything came back up I 
</I>&gt;<i> could only login as guest.  All users and vhosts are gone.  When I 
</I>&gt;<i> refresh the management UI I see only nodes 2 and 3, then only 1, then 
</I>&gt;<i> only 4, etc...
</I>&gt;<i>
</I>&gt;<i> TIA,
</I>&gt;<i>
</I>&gt;<i> Tracy
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

--
Simon MacMullen
RabbitMQ, Pivotal
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027032.html">[rabbitmq-discuss] Cluster upgrade failed
</A></li>
	<LI>Next message: <A HREF="027035.html">[rabbitmq-discuss] Cluster upgrade failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27034">[ date ]</a>
              <a href="thread.html#27034">[ thread ]</a>
              <a href="subject.html#27034">[ subject ]</a>
              <a href="author.html#27034">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
