<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] One node in a cluster never fully starts up
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20One%20node%20in%20a%20cluster%20never%20fully%20starts%20up&In-Reply-To=%3CCACLE7izKYNKDkxPNDNZgF9cCc8PP%2B6qHnPoA0zop1zNnyhQFmg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027450.html">
   <LINK REL="Next"  HREF="027462.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] One node in a cluster never fully starts up</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20One%20node%20in%20a%20cluster%20never%20fully%20starts%20up&In-Reply-To=%3CCACLE7izKYNKDkxPNDNZgF9cCc8PP%2B6qHnPoA0zop1zNnyhQFmg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] One node in a cluster never fully starts up">mpietrek at skytap.com
       </A><BR>
    <I>Thu May 23 18:03:57 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027450.html">[rabbitmq-discuss] Fwd: RabbitMQ 3.0.4 send to temporary queue fails
</A></li>
        <LI>Next message: <A HREF="027462.html">[rabbitmq-discuss] One node in a cluster never fully starts up
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27446">[ date ]</a>
              <a href="thread.html#27446">[ thread ]</a>
              <a href="subject.html#27446">[ subject ]</a>
              <a href="author.html#27446">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey all,

I'm reviving a really old question here, but I suspect the story has
changed between 2.8.4 and 3.1.1.

See prior messages in this thread for context, but in a nutshell, we're
looking for guidance on whether to start up our clustered brokers
sequentially or in parallel.

I know that sequentially is the ideal situation, but in the case of an
uncontrolled shutdown, it doesn't reliably start, as the first node may
time out waiting for a later node.

When this happens, starting the nodes in parallel gets past the problem.
However, my understanding is that this has its own risks. (See my original
first message in this thread.)

At the end of the day, we just need a set of scripts that will idempotently
start/stop the cluster reliably. It's infeasible to expect an operator
(i.e. not me) to assess the current cluster state and then guess which
approach to take.

Has the guidance changed between 2.8.4 and 3.1.1? I know it's basically a
mnesia issue - I just don't know what improvements have been made since
2.8.4.

Thanks,

Matt


On Thu, Jul 26, 2012 at 8:45 AM, Matt Pietrek &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mpietrek at skytap.com</A>&gt; wrote:

&gt;<i> Francesco,
</I>&gt;<i>
</I>&gt;<i> Thanks for the quick reply. A couple of replies/questions:
</I>&gt;<i>
</I>&gt;<i> If I'm understanding what you're saying, we should be starting up our
</I>&gt;<i> brokers sequentially. However, in my experience this hasn't worked. For
</I>&gt;<i> instance, we've seen mq1 stall in its startup, waiting for mq3 to start.
</I>&gt;<i> But mq3 can't start (per the sequential logic) till mq1 finishes starting
</I>&gt;<i> up. Per advice I received from you previously (below) we've moved to async
</I>&gt;<i> startup of the brokers:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-June/020689.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-June/020689.html</A>
</I>&gt;<i>
</I>&gt;<i> &gt;* Question 2*&gt;* ---------------*&gt;* Related to the above scenario, is there any danger (after an unplanned*&gt;* shutdown), in simply letting all the nodes start in parallel and*&gt;* letting Mnesia's waiting sort out the order? It seems to work OK in my*&gt;* limited testing so far, but I don't know if we're risking data loss.*
</I>&gt;<i> It should be fine, but in general it's better to do cluster operations
</I>&gt;<i> sequentially and at one site. In this specific case it should be OK.
</I>&gt;<i>
</I>&gt;<i> As it stands now, we're in a catch 22 - If we do sequential startup, we
</I>&gt;<i> run the risk of deadlocking if we start the nodes in the wrong order. But
</I>&gt;<i> if we do async startup, we run into the problem described in this thread.
</I>&gt;<i>
</I>&gt;<i> --------
</I>&gt;<i>
</I>&gt;<i> &gt; Uhm.  It looks like mnesia is detecting a deadlock, and I'm not sure
</I>&gt;<i> why.  What
</I>&gt;<i> &gt; happens if you don't kill it?  Does it terminate by itself, eventually?
</I>&gt;<i>
</I>&gt;<i> I've let it wait for a good long time (30 minutes +) before killing it.
</I>&gt;<i>
</I>&gt;<i> Thanks much for your help,
</I>&gt;<i>
</I>&gt;<i> Matt
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Jul 26, 2012 at 2:40 AM, Francesco Mazzoli &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">francesco at rabbitmq.com</A>
</I>&gt;<i> &gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Matt,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At Wed, 25 Jul 2012 11:48:56 -0700,
</I>&gt;&gt;<i> Matt Pietrek wrote:
</I>&gt;&gt;<i> &gt; We have a 3 node cluster (mq1, mq2, mq3) running 2.8.4 supporting a
</I>&gt;&gt;<i> small
</I>&gt;&gt;<i> &gt; number of HA queues. During startup of the cluster, we start all nodes
</I>&gt;&gt;<i> in
</I>&gt;&gt;<i> &gt; parallel.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is not a good idea when dealing with clustering.  RabbitMQ
</I>&gt;&gt;<i> clustering is
</I>&gt;&gt;<i> basically a thin layer over mnesia clustering, and we need to do some
</I>&gt;&gt;<i> additional
</I>&gt;&gt;<i> bookkeeping that is prone to race conditions (e.g. storing the online
</I>&gt;&gt;<i> nodes at
</I>&gt;&gt;<i> shutdown).  We are putting efforts in making this process more reliable
</I>&gt;&gt;<i> on the
</I>&gt;&gt;<i> rabbit side.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For this reason you should always execute clustering operations
</I>&gt;&gt;<i> sequentially.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Usually everything works fine. However, we've just recently seen one of
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> &gt; nodes (mq3) won't start, i.e., the rabbitmqctl wait &lt;pid&gt; doesn't
</I>&gt;&gt;<i> complete.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I can log in to the management UI on mq1 and mq2, so they're at least
</I>&gt;&gt;<i> &gt; minimally running.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Luckily, we've turned on verbose Mnesia logging. here's what the
</I>&gt;&gt;<i> failing node
</I>&gt;&gt;<i> &gt; (mq3) shows in the console spew:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; [...]
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The pattern of &quot;Getting table rabbit_durable_exchange (disc_copies)
</I>&gt;&gt;<i> from node
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>:&quot; cycles between mq1 and mq2 repeatedly until I kill mq3.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Uhm.  It looks like mnesia is detecting a deadlock, and I'm not sure why.
</I>&gt;&gt;<i>  What
</I>&gt;&gt;<i> happens if you don't kill it?  Does it terminate by itself, eventually?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; What other sort of information can I provide or look for when this
</I>&gt;&gt;<i> situation
</I>&gt;&gt;<i> &gt; repeats?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Well, the normal rabbit logs would help.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Francesco * Often in error, never in doubt
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130523/163a7a14/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130523/163a7a14/attachment.htm</A>&gt;
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027450.html">[rabbitmq-discuss] Fwd: RabbitMQ 3.0.4 send to temporary queue fails
</A></li>
	<LI>Next message: <A HREF="027462.html">[rabbitmq-discuss] One node in a cluster never fully starts up
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27446">[ date ]</a>
              <a href="thread.html#27446">[ thread ]</a>
              <a href="subject.html#27446">[ subject ]</a>
              <a href="author.html#27446">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
