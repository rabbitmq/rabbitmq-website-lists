<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] getting duplicated delivery
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20getting%20duplicated%20delivery&In-Reply-To=%3CCAAef2CJ-XEh8sCV8bHUFT6JPTRzYBeK8PEd1PkXjpWeb9%3DqNoA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027258.html">
   <LINK REL="Next"  HREF="027375.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] getting duplicated delivery</H1>
    <B>Billy Hand</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20getting%20duplicated%20delivery&In-Reply-To=%3CCAAef2CJ-XEh8sCV8bHUFT6JPTRzYBeK8PEd1PkXjpWeb9%3DqNoA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] getting duplicated delivery">billythethird at gmail.com
       </A><BR>
    <I>Thu May 16 17:53:49 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027258.html">[rabbitmq-discuss] getting duplicated delivery
</A></li>
        <LI>Next message: <A HREF="027375.html">[rabbitmq-discuss] getting duplicated delivery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27262">[ date ]</a>
              <a href="thread.html#27262">[ thread ]</a>
              <a href="subject.html#27262">[ subject ]</a>
              <a href="author.html#27262">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Well I should add that I'm using PHP and the PECL bindings for the
rabbitmq-c library.  So I've been able to determine the exact repro steps.
1. get (no_ack off)
2. ack
3. get again, the connection drops, the message gets redelivered

The exact same code connecting to rabbitmq 3.0.4 does not have this problem
so I'm guessing something broke with the PHP bindings or rabbitmq-c between
versions.  I leave room for a misconfiguration of rabbitmq on my part but
other than setting up a user/password and giving it full access to the /
vhost I didn't do much configuration on either.  Here is the code I'm using:

Producer:
&lt;?php

$co = new AMQPConnection();
$co-&gt;setLogin('user');
$co-&gt;setPassword('password');
$co-&gt;setTimeout(60);
$co-&gt;connect();

$ch = new AMQPChannel($co);

$ex_name = 'test_exchange';
$ex = new AMQPExchange($ch);
$ex-&gt;setName($ex_name);
$ex-&gt;setType(AMQP_EX_TYPE_DIRECT);
$ex-&gt;declare();

$q_name = 'test_queue';
$q = new AMQPQueue($ch);
$q-&gt;setName($q_name);
$q-&gt;setFlags(AMQP_DURABLE);
$q-&gt;declare();
$q-&gt;bind($ex_name, $q_name);

$ex-&gt;publish('test_message'.microtime(true), $q_name);

Consumer:
&lt;?php

$co = new AMQPConnection();
$co-&gt;setLogin('user');
$co-&gt;setPassword('password');
$co-&gt;setTimeout(0);
$co-&gt;connect();

$ch = new AMQPChannel($co);

$ex_name = 'test_exchange';
$ex = new AMQPExchange($ch);
$ex-&gt;setName($ex_name);
$ex-&gt;setType(AMQP_EX_TYPE_DIRECT);
$ex-&gt;declare();

$q_name = 'test_queue';
$q = new AMQPQueue($ch);
$q-&gt;setName($q_name);
$q-&gt;setFlags(AMQP_DURABLE);
$q-&gt;declare();
$q-&gt;bind($ex_name, $q_name);

while (true) {
  //$envelope = $q-&gt;get(AMQP_AUTOACK);
  $envelope = $q-&gt;get();
  if ($envelope) {
    echo $envelope-&gt;getBody() .&quot;\n&quot;;
    $q-&gt;ack($envelope-&gt;getDeliveryTag());
    $envelope = false;
  }
}


On Thu, May 16, 2013 at 9:48 AM, Michael Klishin &lt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">michael.s.klishin at gmail.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> 2013/5/16 Billy Hand &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">billythethird at gmail.com</A>&gt;
</I>&gt;<i>
</I>&gt;&gt;<i> I'm using a short program I wrote that generates exactly one message.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Can you post the code (of both the producer and consumers)?
</I>&gt;<i> --
</I>&gt;<i> MK
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://github.com/michaelklishin">http://github.com/michaelklishin</A>
</I>&gt;<i> <A HREF="http://twitter.com/michaelklishin">http://twitter.com/michaelklishin</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130516/5ca59a8f/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130516/5ca59a8f/attachment.htm</A>&gt;
</PRE>







































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027258.html">[rabbitmq-discuss] getting duplicated delivery
</A></li>
	<LI>Next message: <A HREF="027375.html">[rabbitmq-discuss] getting duplicated delivery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27262">[ date ]</a>
              <a href="thread.html#27262">[ thread ]</a>
              <a href="subject.html#27262">[ subject ]</a>
              <a href="author.html#27262">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
