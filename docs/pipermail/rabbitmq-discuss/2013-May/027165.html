<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Multiple local-usernames for federation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Multiple%20local-usernames%20for%20federation&In-Reply-To=%3CCAAs9BZPfbbXCmcLZx64ytn4CeuH9Z%2BOLFXEGFEoFzU8YDc2d_w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027156.html">
   <LINK REL="Next"  HREF="027169.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Multiple local-usernames for federation</H1>
    <B>Roman Gaufman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Multiple%20local-usernames%20for%20federation&In-Reply-To=%3CCAAs9BZPfbbXCmcLZx64ytn4CeuH9Z%2BOLFXEGFEoFzU8YDc2d_w%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Multiple local-usernames for federation">hackeron at gmail.com
       </A><BR>
    <I>Tue May 14 17:56:18 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027156.html">[rabbitmq-discuss] Multiple local-usernames for federation
</A></li>
        <LI>Next message: <A HREF="027169.html">[rabbitmq-discuss] Multiple local-usernames for federation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27165">[ date ]</a>
              <a href="thread.html#27165">[ thread ]</a>
              <a href="subject.html#27165">[ subject ]</a>
              <a href="author.html#27165">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Oh you're right! - it broke because I removed the guest user, not because I
had a second username. I got confused as to what the username does, when I
changed it to anything other than what was used to connect (which was a
user on the system), it showed the user not found error.

Everything is working like I wanted with the commands bellow.

One question however, if I have a topic exchange and I bind a queue with a
routing key. Is the federation plugin able to determine and only federate
relevant messages? -- What I mean by that is if an exchange has no queues
that match a routing key, will the message still be federated?

---

On Cloud:
  # Sanity
  rabbitmqctl delete_user guest
  rabbitmqctl add_user portal password
  rabbitmqctl set_user_tags portal administrator

  # New Vhost
  rabbitmqctl add_vhost oracle

  # Federation details
  rabbitmqctl -p oracle set_permissions portal xanview.* xanview.* xanview.*
  rabbitmqctl -p oracle set_parameter federation local-username '&quot;portal&quot;'
  rabbitmqctl -p oracle set_parameter federation local-nodename '&quot;portal&quot;'
  rabbitmqctl -p oracle set_policy federate-me &quot;^xanview&quot;
'{&quot;federation-upstream-set&quot;: &quot;all&quot;}'

  # Local server 1
  rabbitmqctl add_user welbeck-dvr1 password
  rabbitmqctl -p oracle set_permissions welbeck-dvr1 xanview.* xanview.*
xanview.*
  rabbitmqctl -p oracle set_parameter federation-upstream welbeck-dvr1 \
    '{&quot;uri&quot;:&quot;<A HREF="amqp://welbeck-dvr1:password@10.9.0.2/oracle&quot;}'">amqp://welbeck-dvr1:password@10.9.0.2/oracle&quot;}'</A>

  # Local server 2
  rabbitmqctl add_user test-dvr2 password
  rabbitmqctl -p oracle set_permissions test-dvr2 xanview.* xanview.*
xanview.*
  rabbitmqctl -p oracle set_parameter federation-upstream test-dvr2 \
    '{&quot;uri&quot;:&quot;<A HREF="amqp://test-dvr2:password@10.9.0.3/oracle&quot;}'">amqp://test-dvr2:password@10.9.0.3/oracle&quot;}'</A>


On XanBox 1:
  # New Vhost
  rabbitmqctl delete_user guest # sanity
  rabbitmqctl add_vhost oracle

  # Federation details
  rabbitmqctl -p oracle set_parameter federation local-username
'&quot;welbeck-dvr1&quot;'
  rabbitmqctl -p oracle set_parameter federation local-nodename
'&quot;welbeck-dvr1&quot;'
  rabbitmqctl -p oracle set_policy federate-me &quot;^xanview&quot;
'{&quot;federation-upstream-set&quot;: &quot;all&quot;}'

  # User &amp; upstream
  rabbitmqctl add_user welbeck-dvr1 password
  rabbitmqctl -p oracle set_permissions welbeck-dvr1 xanview.* xanview.*
xanview.*
  rabbitmqctl -p oracle set_parameter federation-upstream Portal \
        '{&quot;uri&quot;:&quot;<A HREF="amqp://welbeck-dvr1:password@10.9.0.1/oracle&quot;}'">amqp://welbeck-dvr1:password@10.9.0.1/oracle&quot;}'</A>


On XanBox 2:
  # New Vhost
  rabbitmqctl delete_user guest # Sanity
  rabbitmqctl add_vhost oracle

  # Federation details
  rabbitmqctl -p oracle set_parameter federation local-username
'&quot;test-dvr2&quot;'
  rabbitmqctl -p oracle set_parameter federation local-nodename
'&quot;test-dvr2&quot;'
  rabbitmqctl -p oracle set_policy federate-me &quot;^xanview&quot;
'{&quot;federation-upstream-set&quot;: &quot;all&quot;}'

  # User &amp; upstream
  rabbitmqctl add_user test-dvr2 password
  rabbitmqctl -p oracle set_permissions test-dvr2 xanview.* xanview.*
xanview.*
  rabbitmqctl -p oracle set_parameter federation-upstream Portal \
        '{&quot;uri&quot;:&quot;<A HREF="amqp://test-dvr2:password@10.9.0.1/oracle&quot;}'">amqp://test-dvr2:password@10.9.0.1/oracle&quot;}'</A>


On 14 May 2013 14:46, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i> On 14/05/13 14:24, Roman Gaufman wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Yes but I want it biodirectional, I tried to simplify the example, but I
</I>&gt;&gt;<i> guess that wasn't helpful.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Ah, got it.
</I>&gt;<i>
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i>
</I>&gt;<i>  They each have a RabbitMQ instance, on each one I do:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  1. Create vhost: oracle
</I>&gt;&gt;<i>  2. Create new users: moscow:password, london:password, cloud:password
</I>&gt;&gt;<i>  3. Set permissions for all users for the oracle vhost: .* .* .*
</I>&gt;&gt;<i>  4. Set local username and nodename
</I>&gt;&gt;<i>      1. Cloud: rabbitmqctl -p oracle set_parameter federation
</I>&gt;&gt;<i>         local-username '&quot;Cloud&quot;'
</I>&gt;&gt;<i>      2. London: rabbitmqctl -p oracle set_parameter federation
</I>&gt;&gt;<i>         local-nodename '&quot;London&quot;'
</I>&gt;&gt;<i>      3. Moscow: rabbitmqctl -p oracle set_parameter federation
</I>&gt;&gt;<i>         local-nodename '&quot;Moscow&quot;'
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So here you are setting the local-username to &quot;Cloud&quot;, but local-nodename
</I>&gt;<i> to &quot;London&quot; / &quot;Moscow&quot;. Is that another simplification? Is that happening
</I>&gt;<i> on the same machine?
</I>&gt;<i>
</I>&gt;<i> &lt;snip&gt; the rest of the configuration looks reasonable.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Now the problem comes when I set a federation upstream on the &quot;Local&quot;
</I>&gt;&gt;<i> servers (London and Moscow), I want to have a different
</I>&gt;&gt;<i> username/password on each. But it seems the &quot;Cloud&quot; upstream must always
</I>&gt;&gt;<i> have the same username/password? - Unless I am misunderstanding something?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I'm afraid it's still not tremendously clear what you are asking here. If
</I>&gt;<i> you want &quot;London&quot; to connect to &quot;Cloud&quot; using one username and &quot;Moscow&quot; to
</I>&gt;<i> connect to &quot;Cloud&quot; with another, then you can do that - just set the
</I>&gt;<i> usernames / passwords in the URLs differently.
</I>&gt;<i>
</I>&gt;<i>  Yes, I did all that, but I want to federate in both directions. If I do
</I>&gt;&gt;<i> the above, all messages I write to the Local servers (London, Moscow) I
</I>&gt;&gt;<i> can consume on the Cloud server, however if I write from the Cloud
</I>&gt;&gt;<i> server, I cannot consume the messages on the Local servers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To do that, I need to add federation upstreams on the local servers:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbitmqctl set_parameter federation-upstream Cloud
</I>&gt;&gt;<i> '{&quot;uri&quot;:&quot;<A HREF="amqp://london:**password@10.9.0.1/oracle&lt;http://london:password@10.9.0.1/oracle">amqp://london:**password@10.9.0.1/oracle&lt;http://london:password@10.9.0.1/oracle</A>&gt;
</I>&gt;&gt;<i> &lt;<A HREF="http://london:password@10.9.**0.1/oracle&lt;http://london:password@10.9.0.1/oracle">http://london:password@10.9.**0.1/oracle&lt;http://london:password@10.9.0.1/oracle</A>&gt;
</I>&gt;&gt;<i> &gt;&quot;}'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> rabbitmqctl set_parameter federation-upstream Cloud
</I>&gt;&gt;<i> '{&quot;uri&quot;:&quot;<A HREF="amqp://moscow:**password@10.9.0.1/oracle&lt;http://moscow:password@10.9.0.1/oracle">amqp://moscow:**password@10.9.0.1/oracle&lt;http://moscow:password@10.9.0.1/oracle</A>&gt;
</I>&gt;&gt;<i> &lt;<A HREF="http://moscow:password@10.9.**0.1/oracle&lt;http://moscow:password@10.9.0.1/oracle">http://moscow:password@10.9.**0.1/oracle&lt;http://moscow:password@10.9.0.1/oracle</A>&gt;
</I>&gt;&gt;<i> &gt;&quot;}'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But I cannot do that because RabbitMQ only accepts a single
</I>&gt;&gt;<i> local-username :( - Am I missing something?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Ah - I think I understand what you are missing. Do you think
</I>&gt;<i> local-username must correspond to the username set in another server's
</I>&gt;<i> upstream URL? That's not the case.
</I>&gt;<i>
</I>&gt;<i> The remote username(s) (i.e. the ones in the upstream URLs) need to be
</I>&gt;<i> valid users in the upstream host. I think you have that right.
</I>&gt;<i>
</I>&gt;<i> The local-username just needs to exist locally and be able to publish
</I>&gt;<i> messages; it's used to republish messages that have been received from a
</I>&gt;<i> remote host. *It does not need to correspond to anything else*.
</I>&gt;<i>
</I>&gt;<i> The fact that you are seeing {error,user_does_not_exist} on a certain host
</I>&gt;<i> means that you have set the local-username to the name of a user that does
</I>&gt;<i> not exist on that host. Or that you have not set it, it;s defaulting to
</I>&gt;<i> &quot;guest&quot;, and &quot;guest&quot; does not exist.
</I>&gt;<i>
</I>&gt;<i> Does this make sense?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, Pivotal
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130514/21bc6d41/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130514/21bc6d41/attachment.htm</A>&gt;
</PRE>






















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027156.html">[rabbitmq-discuss] Multiple local-usernames for federation
</A></li>
	<LI>Next message: <A HREF="027169.html">[rabbitmq-discuss] Multiple local-usernames for federation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27165">[ date ]</a>
              <a href="thread.html#27165">[ thread ]</a>
              <a href="subject.html#27165">[ subject ]</a>
              <a href="author.html#27165">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
