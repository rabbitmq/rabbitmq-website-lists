<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] PHP AmqpLib,	rabbit hangs after a few hundred messages ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20PHP%20AmqpLib%2C%0A%09rabbit%20hangs%20after%20a%20few%20hundred%20messages%20%3F&In-Reply-To=%3C18745ab5-775e-49b0-9006-d96b4fd52e8e%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026791.html">
   <LINK REL="Next"  HREF="026796.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] PHP AmqpLib,	rabbit hangs after a few hundred messages ?</H1>
    <B>Angelos Karantzalis</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20PHP%20AmqpLib%2C%0A%09rabbit%20hangs%20after%20a%20few%20hundred%20messages%20%3F&In-Reply-To=%3C18745ab5-775e-49b0-9006-d96b4fd52e8e%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] PHP AmqpLib,	rabbit hangs after a few hundred messages ?">anjelinio at taxibeat.com
       </A><BR>
    <I>Wed May  1 10:11:33 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026791.html">[rabbitmq-discuss] Hanging connections in management interface (v3.0.4)
</A></li>
        <LI>Next message: <A HREF="026796.html">[rabbitmq-discuss] PHP AmqpLib, rabbit hangs after a few hundred messages ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26794">[ date ]</a>
              <a href="thread.html#26794">[ thread ]</a>
              <a href="subject.html#26794">[ subject ]</a>
              <a href="author.html#26794">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi guys, I'm having a serious problem with rabbit and the PHP AMQPLib 
client. 

Our system is in essence a state workflow -&gt; events are triggered when we 
change state in any of our open sessions. We wanted to push processing of 
those events away from our fron-facing web server, so decided on trying our 
rabbit to create a pub-sub architecture for async processing of those 
events. 

Now, those events are not a .. flood of events. We are getting around 10 - 
50 per minute, and they are really small in size. We're using a fanout 
exchange to push them to rabbit, and multi-process them using workers 
running in another machine. 

Yesterday was our first production test. We left it running for the whole 
day, until at around 21:00, after more or less 12 hours running ok, rabbit 
just stopped accepting messages. It was not dead, just not functional. 

As I said, we're using the PhpAmqpLib client. We've written a couple of 
helper classes, to create a Producer, a PubSubProducer ( the former uses a 
topic exchange, the latter a fanout one ) and the corresponding Consumers. 
Can anyone see something wrong in this ?

The source of the pub-sub producer is more or less this:

*public function __construct($exchange_name, $queue_name, $routing_key) *

{

    $this-&gt;_exchange = $exchange_name;

    $this-&gt;_queue    = $queue_name;

    $this-&gt;_routing_key = $routing_key;

}

*public function initialize()*

{

    $config = QueueConfig::instance();

     $this-&gt;_connection = new AMQPConnection($config-&gt;host, $config-&gt;port, 
$config-&gt;user, $config-&gt;pwd, $config-&gt;vhost);

    $this-&gt;_channel = $this-&gt;_connection-&gt;channel();

     if(null!=$this-&gt;_exchange)

    {

        //echo &quot;Registering Exchange: &quot; . $this-&gt;_exchange;

        $this-&gt;_channel-&gt;exchange_declare($this-&gt;_exchange, 'fanout');

    }

}

*public function publish($message, $routing_key = null, $correlation_id = 
null)*

{

    $r_key = (null != $routing_key)? $routing_key : $this-&gt;_routing_key;

     $properties = array('content_type' =&gt; 'text/plain', 'delivery_mode' =&gt; 
2);

    if(null != $correlation_id)

        $properties['correlation_id'] = $correlation_id;

     $msg = new AMQPMessage($message, $properties);

    $this-&gt;_channel-&gt;basic_publish($msg, $this-&gt;_exchange, $r_key);

}
Thanks so much for any help guys, very very very much appreciated ! 

Angel
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130501/3536b008/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130501/3536b008/attachment.htm</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026791.html">[rabbitmq-discuss] Hanging connections in management interface (v3.0.4)
</A></li>
	<LI>Next message: <A HREF="026796.html">[rabbitmq-discuss] PHP AmqpLib, rabbit hangs after a few hundred messages ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26794">[ date ]</a>
              <a href="thread.html#26794">[ thread ]</a>
              <a href="subject.html#26794">[ subject ]</a>
              <a href="author.html#26794">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
