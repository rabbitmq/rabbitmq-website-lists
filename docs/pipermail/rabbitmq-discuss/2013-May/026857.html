<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Proposal: Change consumers Round-Robin behaviour
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Proposal%3A%20Change%20consumers%20Round-Robin%0A%20behaviour&In-Reply-To=%3CCDA7D018.94E1%25Michael.Laing%40nytimes.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026856.html">
   <LINK REL="Next"  HREF="026858.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Proposal: Change consumers Round-Robin behaviour</H1>
    <B>Laing, Michael P.</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Proposal%3A%20Change%20consumers%20Round-Robin%0A%20behaviour&In-Reply-To=%3CCDA7D018.94E1%25Michael.Laing%40nytimes.com%3E"
       TITLE="[rabbitmq-discuss] Proposal: Change consumers Round-Robin behaviour">Michael.Laing at nytimes.com
       </A><BR>
    <I>Thu May  2 13:43:53 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026856.html">[rabbitmq-discuss] Proposal: Change consumers Round-Robin	behaviour
</A></li>
        <LI>Next message: <A HREF="026858.html">[rabbitmq-discuss] Proposal: Change consumers Round-Robin	behaviour
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26857">[ date ]</a>
              <a href="thread.html#26857">[ thread ]</a>
              <a href="subject.html#26857">[ subject ]</a>
              <a href="author.html#26857">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We often have empty queues. In fact we strive for that state.

We like the current round robin because it predictably exercises each
consumer on the queue. We monitor the processing history (region,
availability zone, instance, service, etc) of each message through the
messaging pipeline. The pipelines may involve multiple clusters and
federated links. Typically we process multiple replicas of the same
message through alternate regional pipelines that ultimately 'fan-in'.
Because of the round robin predictability we can very quickly find 'holes'
and slowdowns by comparing the histories of replicas at resolution time -
then take appropriate action, e.g. Terminate low-performing instances so
auto-scaling will add/cluster new ones.

Additionally we use certain queues to hold mutex tokens. For any one
token, multiple processes subscribe w ack and one of them gets it and does
its work, maybe sleeps for a while, and then nacks - the next process gets
the token and so on. Predictable, exercises each process in turn, and if a
process fails the next one picks up immediately.

Michael

On 5/2/13 7:53 AM, &quot;Simon MacMullen&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i>On 02/05/13 12:27, Jesper Louis Andersen wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>Hi.
</I>&gt;<i>
</I>&gt;<i>&lt;snip&gt;
</I>&gt;<i>
</I>&gt;&gt;<i> When this happens, we pick a random consumer in the queue and move him
</I>&gt;&gt;<i> to the front. Over time, this &quot;shuffles&quot; the queue into a random order.
</I>&gt;&gt;<i> It is also not going to cost anything on the critical path since we only
</I>&gt;&gt;<i> do it when we have an empty queue and excess workers.
</I>&gt;<i>
</I>&gt;<i>Bear in mind that the &quot;empty queue and excess workers&quot; case *is* on the
</I>&gt;<i>critical path for straight-through messaging (i.e. where the queue is on
</I>&gt;<i>average empty and we are streaming messages through it as fast as
</I>&gt;<i>possible).
</I>&gt;<i>
</I>&gt;&gt;<i> And we are going
</I>&gt;&gt;<i> to do very little work unless the queue has a behaviour where it empties
</I>&gt;&gt;<i> often in which case you get full random distribution on the consumers
</I>&gt;&gt;<i> with this scheme.
</I>&gt;<i>
</I>&gt;<i>Again, this is a common case for some users.
</I>&gt;<i>
</I>&gt;<i>Also: quite a lot of people *want* round-robin behaviour here.
</I>&gt;<i>
</I>&gt;&gt;<i> The background for the proposal is that Round-robin distribution of
</I>&gt;&gt;<i> messages often tend to bad behaviour over time. By adding a bit of
</I>&gt;&gt;<i> randomness to the process, we automatically alleviate a number of
</I>&gt;&gt;<i> determinism-problems and get better distribution of messages over
</I>&gt;&gt;<i> consumers. One could also imagine different distribution schemes, but
</I>&gt;&gt;<i> those will be more expensive in practice compared to this proposal,
</I>&gt;&gt;<i> which should only have a cost when the queue is not under heavy load.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Did I miss anything?
</I>&gt;&gt;<i> * Is this a good or bad idea? And why?
</I>&gt;&gt;<i> * Do we break any rules w.r.t. AMQP by implementing this?
</I>&gt;&gt;<i> * Is priority on the queue going to be harder to implement? (I don't
</I>&gt;&gt;<i> think so, but...)
</I>&gt;<i>
</I>&gt;<i>So I am not (yet) convinced. This would not violate the spec or make
</I>&gt;<i>priorities harder to implement but I'm not convinced that the majority
</I>&gt;<i>of users would see it as a step forward.
</I>&gt;<i>
</I>&gt;<i>Does anybody who currently depends on round-robin want to speak up?
</I>&gt;<i>
</I>&gt;<i>Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>-- 
</I>&gt;<i>Simon MacMullen
</I>&gt;<i>RabbitMQ, VMware
</I>&gt;<i>_______________________________________________
</I>&gt;<i>rabbitmq-discuss mailing list
</I>&gt;<i><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026856.html">[rabbitmq-discuss] Proposal: Change consumers Round-Robin	behaviour
</A></li>
	<LI>Next message: <A HREF="026858.html">[rabbitmq-discuss] Proposal: Change consumers Round-Robin	behaviour
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26857">[ date ]</a>
              <a href="thread.html#26857">[ thread ]</a>
              <a href="subject.html#26857">[ subject ]</a>
              <a href="author.html#26857">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
