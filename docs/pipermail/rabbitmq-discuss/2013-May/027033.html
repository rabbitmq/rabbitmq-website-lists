<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Someone else with a nodedown error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Someone%20else%20with%20a%20nodedown%20error&In-Reply-To=%3C9C50D264-1E02-4997-982B-FFE42C4F927F%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027017.html">
   <LINK REL="Next"  HREF="027265.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Someone else with a nodedown error</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Someone%20else%20with%20a%20nodedown%20error&In-Reply-To=%3C9C50D264-1E02-4997-982B-FFE42C4F927F%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Someone else with a nodedown error">tim at rabbitmq.com
       </A><BR>
    <I>Thu May  9 15:00:30 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027017.html">[rabbitmq-discuss] Someone else with a nodedown error
</A></li>
        <LI>Next message: <A HREF="027265.html">[rabbitmq-discuss] Someone else with a nodedown error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27033">[ date ]</a>
              <a href="thread.html#27033">[ thread ]</a>
              <a href="subject.html#27033">[ subject ]</a>
              <a href="author.html#27033">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

On 8 May 2013, at 18:22, Eric Berg wrote:

&gt;<i> I have ready through many of these nodedown error emails and of course none of them seem to be exactly what I am experiencing.
</I>&gt;<i> 
</I>&gt;<i> I have a 4 node cluster, and one of the nodes went offline according to the cluster. This box has the following in the sasl log:
</I>&gt;<i> 
</I>&gt;<i> =SUPERVISOR REPORT==== 7-May-2013::14:37:22 ===
</I>&gt;<i>      Supervisor: {&lt;0.11197.1096&gt;,
</I>&gt;<i>                                            rabbit_channel_sup_sup}
</I>&gt;<i>      Context:    shutdown_error
</I>&gt;<i>      Reason:     noproc
</I>&gt;<i>      Offender:   [{pid,&lt;0.11199.1096&gt;},
</I>&gt;<i>                   {name,channel_sup},
</I>&gt;<i>                   {mfa,{rabbit_channel_sup,start_link,[]}},
</I>&gt;<i>                   {restart_type,temporary},
</I>&gt;<i>                   {shutdown,infinity},
</I>&gt;<i>                   {child_type,supervisor}]
</I>&gt;<i> 
</I>
This simply indicates that and error occurred whilst a supervised process was shutting down. It's not indicative of the whole node going down - Erlang allows processes to crash and be restarted whilst the system is running.

&gt;<i> Yet in the regular rabbit log i can see that it was still accepting connections up until 2:22AM the next day:
</I>&gt;<i> 
</I>&gt;<i> (last log entry)
</I>&gt;<i> =INFO REPORT==== 8-May-2013::02:22:26 ===
</I>&gt;<i> closing AMQP connection &lt;0.18267.1145&gt; (IPADDRESS:PORT -&gt; IPADDRESS:PORT)
</I>&gt;<i> 
</I>
So clearly that node didn't actually go offline. The 'nodedown' message in the other clustered broker's logs does not necessarily mean that the node in question crashed; This could, for example, be indicative of a net-split or other connectivity failure. 

&gt;<i> Running rabbitmqctl status returns:
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-box</A> rabbitmq]# rabbitmqctl status
</I>&gt;<i> Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-box</A>' ...
</I>&gt;<i> Error: unable to connect to node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-box</A>': nodedown
</I>&gt;<i> 
</I>&gt;<i> DIAGNOSTICS
</I>&gt;<i> ===========
</I>&gt;<i> 
</I>&gt;<i> nodes in question: ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-box</A>']
</I>&gt;<i> 
</I>&gt;<i> hosts, their running nodes and ports:
</I>&gt;<i> - rabbit-box: [{rabbit,13957},{rabbitmqctl2301,16508}]
</I>&gt;<i> 
</I>&gt;<i> current node details:
</I>&gt;<i> - node name: '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmqctl2301 at rabbit-box</A>'
</I>&gt;<i> - home dir: /var/lib/rabbitmq
</I>&gt;<i> - cookie hash: qQwyFW90ZNbbrFvX1AtrxQ==
</I>
Have you tried running this using `sudo' instead of as root? Is the rabbitmq user's account and home folder in a consistent state? The security cookie used for inter-node communications, which includes communication between the temporary `rabbitmqctl' node and the broker, has to be the same for all the peers.

&gt;<i> A couple of notes:
</I>&gt;<i> - Looking for a process run by rabbit show that it appears to still be running
</I>
Yes - as I said, there's no indication that this node actually died from what you've said. However `rabbitmqctl` should be able to connect to <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-box</A> at the very least. 

&gt;<i> - Erlang cookie is the same on all nodes of the cluster, the cookie hash is the same as well
</I>
If it's not the cookies then....

&gt;<i> - A traffic spike occurred right around the time of the last entry in the rabbit log
</I>
It sounds like this could be a potential culprit. Can you provide any more information about what happened? It could be that whilst the network was saturated, the node in question got disconnected from the other nodes in the cluster because it exceeded the &quot;net tick time&quot; and subsequently things have started to go wrong. That shouldn't happen, viz the node should be able to re-establish connectivity, but it's possible that something's gone wrong here.

What that doesn't explain is why you can't connect from rabbitmqctl. If you `su rabbitmq', can you then run `erl -sname debug -remsh <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-box</A>' to establish a shell into the running broker? If that does work, then you can stop the rabbit application and then the node, as follows:

&gt;<i> rabbit:stop().
</I>ok
&gt;<i> init:stop().
</I>
But before you do, it might be worth evaluating a couple of other things that might help us identify what's going on:

(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iske</A>)1&gt; whereis(rabbit).
&lt;0.152.0&gt;
(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iske</A>)2&gt; application:loaded_applications().
[{os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.9&quot;},
 {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,
                            &quot;0.0.0&quot;},
 {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;0.0.0&quot;},
 etc ...
 ]
(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at iske</A>)3&gt; application:which_applications(). 
[{rabbitmq_shovel_management,&quot;Shovel Status&quot;,&quot;0.0.0&quot;},
 etc ...
]
 
If during any of these you get stuck, CTRL-C (and press the key for 'abort') should get you back out again without incident.


&gt;<i> - I can find no other errors in any logs that relate to rabbit or erlang
</I>&gt;<i> - Up until this point the cluster has been running fine for over 40 days.
</I>&gt;<i> - telnet IP_ADDRESS 5672 times out
</I>
So the broker is no longer accepting new AMQP connections then. Something's clearly quite wrong with this node.

&gt;<i> - I have not restarted the box, erlang node, or entire rabbitmq-server
</I>&gt;<i> 
</I>&gt;<i> Is there anywhere else I can go looking for errors? I am about to start killing processs, but Im not sure that will solve anything.
</I>&gt;<i> 
</I>
Did you do that in the end? If not, I would really like to get to the bottom of what's wrong with this node. I don't suppose it would be possible for you to give us access to this machine would it? If necessary, we may be able to get some kind of confidentiality agreement signed if that'd help.

Cheers,

Tim Watson
Staff Engineer
RabbitMQ



-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130509/7373b798/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130509/7373b798/attachment.htm</A>&gt;
</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027017.html">[rabbitmq-discuss] Someone else with a nodedown error
</A></li>
	<LI>Next message: <A HREF="027265.html">[rabbitmq-discuss] Someone else with a nodedown error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27033">[ date ]</a>
              <a href="thread.html#27033">[ thread ]</a>
              <a href="subject.html#27033">[ subject ]</a>
              <a href="author.html#27033">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
