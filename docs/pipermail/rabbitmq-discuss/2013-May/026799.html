<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] .NET Client ConnectionFactory threading	issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.NET%20Client%20ConnectionFactory%20threading%0A%09issues&In-Reply-To=%3C048dc2cd-6cd7-48fa-b9f3-34ad8e946a2b%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026801.html">
   <LINK REL="Next"  HREF="026802.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] .NET Client ConnectionFactory threading	issues</H1>
    <B>Chris Haines</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.NET%20Client%20ConnectionFactory%20threading%0A%09issues&In-Reply-To=%3C048dc2cd-6cd7-48fa-b9f3-34ad8e946a2b%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] .NET Client ConnectionFactory threading	issues">cjbhaines at gmail.com
       </A><BR>
    <I>Wed May  1 11:31:11 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026801.html">[rabbitmq-discuss] [Architecture] Real-time feed with RabbitMQ and	NodeJS
</A></li>
        <LI>Next message: <A HREF="026802.html">[rabbitmq-discuss] another question on cookies  version 3.0.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26799">[ date ]</a>
              <a href="thread.html#26799">[ thread ]</a>
              <a href="subject.html#26799">[ subject ]</a>
              <a href="author.html#26799">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Hi All,

This had nothing to do with the actual ConnectionFactory. This was because 
our application was thread starved.

The .NET ThreadPool by default has a small number of threads available. The 
minimum number of available threads was set to 8. This means that once 8 
threads have been requested (and still being used) then the ThreadPool 
switches over to an algorithm to decide whether to create new threads in 
the pool or wait for a thread to become available. This algorithm is not 
very generous at creating new threads, so what we were seeing is that the 
connections were timing out on creation due to waiting for a thread to 
become available, not problems within the RabbitMQ client libraries.

You can get round this by setting the minimum number of threads available 
in the ThreadPool, which means that the number specified get created on 
your application start up:

ThreadPool.SetMinThreads(minWorkerThreads, minCompletionPortThreads);

Cheers,
Chris

On Thursday, 18 April 2013 12:37:40 UTC+1, Chris Haines wrote:
&gt;<i>
</I>&gt;<i> Hi All,
</I>&gt;<i>
</I>&gt;<i> I have attached a .cs Nunit test fixture to demonstrate a problem I am 
</I>&gt;<i> having with the ConnectionFactory. If I create 100 connections in a for 
</I>&gt;<i> loop single threaded then I can create them all in about 2 seconds. If I 
</I>&gt;<i> create them via a number of threads, in my test I am using 100 threads to 
</I>&gt;<i> create a connection on each, then I get a lot of timeout exceptions (my 
</I>&gt;<i> test bails out after 60 seconds). I have tried sharing an instance of the 
</I>&gt;<i> ConnectionFactory between all threads and also giving each thread its own 
</I>&gt;<i> instance but they both have the same result. I have also tried locking 
</I>&gt;<i> around the call to CreateConnection but that also didn't help. 
</I>&gt;<i>
</I>&gt;<i> I find this behavior to be very strange. Has anyone else had similar 
</I>&gt;<i> problems?
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Chris
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130501/9a0f033b/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130501/9a0f033b/attachment.htm</A>&gt;
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026801.html">[rabbitmq-discuss] [Architecture] Real-time feed with RabbitMQ and	NodeJS
</A></li>
	<LI>Next message: <A HREF="026802.html">[rabbitmq-discuss] another question on cookies  version 3.0.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26799">[ date ]</a>
              <a href="thread.html#26799">[ thread ]</a>
              <a href="subject.html#26799">[ subject ]</a>
              <a href="author.html#26799">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
