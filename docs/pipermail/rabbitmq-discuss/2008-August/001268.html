<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Linux processor affinity and C code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Linux%20processor%20affinity%20and%20C%20code&In-Reply-To=6c2563b20808301624u60385da6n5777ea911d6b0eaf%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001267.html">
   <LINK REL="Next"  HREF="001270.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Linux processor affinity and C code</H1>
    <B>Edwin Fine</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Linux%20processor%20affinity%20and%20C%20code&In-Reply-To=6c2563b20808301624u60385da6n5777ea911d6b0eaf%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Linux processor affinity and C code">rabbitmq-discuss_efine at usa.net
       </A><BR>
    <I>Sun Aug 31 00:26:01 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001267.html">[rabbitmq-discuss] performance
</A></li>
        <LI>Next message: <A HREF="001270.html">[rabbitmq-discuss] EOFException when messages in queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1268">[ date ]</a>
              <a href="thread.html#1268">[ thread ]</a>
              <a href="subject.html#1268">[ subject ]</a>
              <a href="author.html#1268">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>With regards to RabbitMQ performance and my previous post, I found some C
code from Linux Journal that sets the processor affinity mask for an already
running Linux OS process from the command line. I modified the code a bit to
work with the most recent Linux APIs and to have a slightly more intuitive
user interface.

Link to unmodified code:
<A HREF="http://www.linuxjournal.com/files/linuxjournal.com/linuxjournal/articles/067/6799/6799l1.html">http://www.linuxjournal.com/files/linuxjournal.com/linuxjournal/articles/067/6799/6799l1.html</A>

Example:

<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">efine at ender</A>:~/linux$ ./bindcpu 6609 1000
New mask to be applied: 1000
pid 6609's old affinity: 1111
pid 6609's new affinity: 1000

In the above example, I modified the affinity of an Erlang process that was
started with +S 1. The old affinity allowed it to run on any of the 4 CPUs
on my system. The new one allows it to run only on CPU 3. The mask is a bit
string that lets you specify the affinity for up to 1024 processors by
specifying a '1' in the corresponding bit position. Bit 0 is the rightmost
position in the string. I verified using 'top' that I could change the CPU
on which the beam VM ran, even while it was executing code.

On an 8-core system, one could conceivably leave processor 0 for the OS, and
perhaps reserve processors 1 through 4 for clustered RabbitMQ Erlang VMs and
the rest for other apps. One additional trick that one can use (disclaimer:
VERY carefully! I haven't tried it with Erlang and one could really mess up
one's system) is to raise the priority of the Erlang VM Linux (OS) processes
so that they preempt less important processes and therefore effectively
&quot;reserve&quot; the affinitied CPUs for themselves. I've seen this approach used
in a major US telecomms IT department to maximize database performance, but
the database processes were designed to be used like that, hence my caution.

Anyone interested in seeing if there are RabbitMQ performance improvements
by doing this? I'd be happy to post the code (which is very short, 125 lines
of C). Otherwise I will play around with it on non-RabbitMQ code as time
permits.

Regards,
Edwin Fine
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080830/72b797b6/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20080830/72b797b6/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001267.html">[rabbitmq-discuss] performance
</A></li>
	<LI>Next message: <A HREF="001270.html">[rabbitmq-discuss] EOFException when messages in queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1268">[ date ]</a>
              <a href="thread.html#1268">[ thread ]</a>
              <a href="subject.html#1268">[ subject ]</a>
              <a href="author.html#1268">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
