<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Replay order
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Replay%20order&In-Reply-To=73b10e5b0807301309o200c254aj12965a4f46690842%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001126.html">
   <LINK REL="Next"  HREF="001128.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Replay order</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Replay%20order&In-Reply-To=73b10e5b0807301309o200c254aj12965a4f46690842%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Replay order">matthias at lshift.net
       </A><BR>
    <I>Fri Aug  1 15:11:12 BST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001126.html">[rabbitmq-discuss] Unbind patch
</A></li>
        <LI>Next message: <A HREF="001128.html">[rabbitmq-discuss]  Information about EndlessSummerOfCode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1127">[ date ]</a>
              <a href="thread.html#1127">[ thread ]</a>
              <a href="subject.html#1127">[ subject ]</a>
              <a href="author.html#1127">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Petr,

Petr Sturc wrote:
&gt;<i> the 1.4.0 &quot;Release highlights&quot; is mentioning that there is bugfix for
</I>&gt;<i> &quot;maintain message order on persister replay&quot;.
</I>&gt;<i> Does it mean the messages are replayed in the same order there way sent?
</I>
Following the bugfix, the ordering guarantees provided by AMQP are 
preserved in the event of a replay of persisted messages after a broker 
restart.

AMQP's ordering guarantees are fairly straightforward at first glance 
but turn out to be surprisingly tricky to pin down precisely. Here's an 
attempt at doing the latter, courtesy of my colleague Tony 
Garnock-Jones. Take a deep breath ...

BEGIN

AMQP's transports MUST preserve the order of AMQP commands issued on a 
single channel, meaning that one command (such as a basic.publish, or a 
basic.deliver) can be seen to arrive before or after another carried on 
the same channel.

Let M1 and M2 be two messages, published
  - at the same message priority
  - via the same channel
  - to the same exchange.

Let us examine the case where M1 arrives at the server before M2.

If a particular queue should wind up with copies of both M1 and M2, and 
further if both M1 and M2 are to be sent from that queue
  - down the same channel
  - using basic.deliver
  - with the same consumer-tag,
then the basic.deliver carrying M1 MUST be sent before the basic.deliver 
carrying M2, unless the &quot;redelivered&quot; flag happens to be set on one or 
both of the basic.deliver commands.

If two basic.get operations are issued in sequence
  - on the same channel
  - reading from the same queue, and
  - those two basic.get operations happen to retrieve M1 and M2,
then M1 MUST be returned by the first basic.get-ok, and M2 MUST be 
returned by the second basic.get-ok, unless the &quot;redelivered&quot; flag 
happens to be set on one or both of the basic.get-ok commands.

In all situations not covered by the text above, the server is under no 
obligation to preserve ordering between M1 and M2, but MAY do so.

END

Simple, isn't it? ;)

  &gt; I am playing with single producer and two consumers taking messages
&gt;<i> from the same queue without ACK. I am receiving them in round-robin
</I>&gt;<i> order as expected. When I stop the consumers and connect another one
</I>&gt;<i> WITH ACK, the messages are redelivered, but with no particular order.
</I>&gt;<i> Is it correcect behavour? How does it correspond to the claim about
</I>&gt;<i> maintaining message order?
</I>
As noted above, order may not be preserved for redelivered messages.


Regards,

Matthias.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001126.html">[rabbitmq-discuss] Unbind patch
</A></li>
	<LI>Next message: <A HREF="001128.html">[rabbitmq-discuss]  Information about EndlessSummerOfCode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1127">[ date ]</a>
              <a href="thread.html#1127">[ thread ]</a>
              <a href="subject.html#1127">[ subject ]</a>
              <a href="author.html#1127">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
