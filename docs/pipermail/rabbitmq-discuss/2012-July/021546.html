<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] One node in a cluster never fully starts up
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20One%20node%20in%20a%20cluster%20never%20fully%20starts%20up&In-Reply-To=%3CCACLE7izfttKxd4kEBt9uriR1O%2B-o%3D_Qx9o%3DOGBZ%2BLUbEDf8efQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021536.html">
   <LINK REL="Next"  HREF="021547.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] One node in a cluster never fully starts up</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20One%20node%20in%20a%20cluster%20never%20fully%20starts%20up&In-Reply-To=%3CCACLE7izfttKxd4kEBt9uriR1O%2B-o%3D_Qx9o%3DOGBZ%2BLUbEDf8efQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] One node in a cluster never fully starts up">mpietrek at skytap.com
       </A><BR>
    <I>Thu Jul 26 16:45:50 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021536.html">[rabbitmq-discuss] One node in a cluster never fully starts up
</A></li>
        <LI>Next message: <A HREF="021547.html">[rabbitmq-discuss] One node in a cluster never fully starts up
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21546">[ date ]</a>
              <a href="thread.html#21546">[ thread ]</a>
              <a href="subject.html#21546">[ subject ]</a>
              <a href="author.html#21546">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Francesco,

Thanks for the quick reply. A couple of replies/questions:

If I'm understanding what you're saying, we should be starting up our
brokers sequentially. However, in my experience this hasn't worked. For
instance, we've seen mq1 stall in its startup, waiting for mq3 to start.
But mq3 can't start (per the sequential logic) till mq1 finishes starting
up. Per advice I received from you previously (below) we've moved to async
startup of the brokers:

<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-June/020689.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2012-June/020689.html</A>

&gt;<i>* Question 2*&gt;* ---------------*&gt;* Related to the above scenario, is there any danger (after an unplanned*&gt;* shutdown), in simply letting all the nodes start in parallel and*&gt;* letting Mnesia's waiting sort out the order? It seems to work OK in my*&gt;* limited testing so far, but I don't know if we're risking data loss.*
</I>It should be fine, but in general it's better to do cluster operations
sequentially and at one site. In this specific case it should be OK.

As it stands now, we're in a catch 22 - If we do sequential startup, we run
the risk of deadlocking if we start the nodes in the wrong order. But if we
do async startup, we run into the problem described in this thread.

--------
&gt;<i> Uhm.  It looks like mnesia is detecting a deadlock, and I'm not sure why.
</I> What
&gt;<i> happens if you don't kill it?  Does it terminate by itself, eventually?
</I>
I've let it wait for a good long time (30 minutes +) before killing it.

Thanks much for your help,

Matt

On Thu, Jul 26, 2012 at 2:40 AM, Francesco Mazzoli
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">francesco at rabbitmq.com</A>&gt;wrote:

&gt;<i> Hi Matt,
</I>&gt;<i>
</I>&gt;<i> At Wed, 25 Jul 2012 11:48:56 -0700,
</I>&gt;<i> Matt Pietrek wrote:
</I>&gt;<i> &gt; We have a 3 node cluster (mq1, mq2, mq3) running 2.8.4 supporting a small
</I>&gt;<i> &gt; number of HA queues. During startup of the cluster, we start all nodes in
</I>&gt;<i> &gt; parallel.
</I>&gt;<i>
</I>&gt;<i> This is not a good idea when dealing with clustering.  RabbitMQ clustering
</I>&gt;<i> is
</I>&gt;<i> basically a thin layer over mnesia clustering, and we need to do some
</I>&gt;<i> additional
</I>&gt;<i> bookkeeping that is prone to race conditions (e.g. storing the online
</I>&gt;<i> nodes at
</I>&gt;<i> shutdown).  We are putting efforts in making this process more reliable on
</I>&gt;<i> the
</I>&gt;<i> rabbit side.
</I>&gt;<i>
</I>&gt;<i> For this reason you should always execute clustering operations
</I>&gt;<i> sequentially.
</I>&gt;<i>
</I>&gt;<i> &gt; Usually everything works fine. However, we've just recently seen one of
</I>&gt;<i> the
</I>&gt;<i> &gt; nodes (mq3) won't start, i.e., the rabbitmqctl wait &lt;pid&gt; doesn't
</I>&gt;<i> complete.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I can log in to the management UI on mq1 and mq2, so they're at least
</I>&gt;<i> &gt; minimally running.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Luckily, we've turned on verbose Mnesia logging. here's what the failing
</I>&gt;<i> node
</I>&gt;<i> &gt; (mq3) shows in the console spew:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [...]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The pattern of &quot;Getting table rabbit_durable_exchange (disc_copies) from
</I>&gt;<i> node
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq1</A>:&quot; cycles between mq1 and mq2 repeatedly until I kill mq3.
</I>&gt;<i>
</I>&gt;<i> Uhm.  It looks like mnesia is detecting a deadlock, and I'm not sure why.
</I>&gt;<i>  What
</I>&gt;<i> happens if you don't kill it?  Does it terminate by itself, eventually?
</I>&gt;<i>
</I>&gt;<i> &gt; What other sort of information can I provide or look for when this
</I>&gt;<i> situation
</I>&gt;<i> &gt; repeats?
</I>&gt;<i>
</I>&gt;<i> Well, the normal rabbit logs would help.
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Francesco * Often in error, never in doubt
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120726/b93251f7/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120726/b93251f7/attachment.htm</A>&gt;
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021536.html">[rabbitmq-discuss] One node in a cluster never fully starts up
</A></li>
	<LI>Next message: <A HREF="021547.html">[rabbitmq-discuss] One node in a cluster never fully starts up
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21546">[ date ]</a>
              <a href="thread.html#21546">[ thread ]</a>
              <a href="subject.html#21546">[ subject ]</a>
              <a href="author.html#21546">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
