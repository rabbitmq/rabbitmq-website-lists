<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cluster Setup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20Setup&In-Reply-To=%3CFAB529FB-82AD-4764-ADEB-4A1CDE6DAF13%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021368.html">
   <LINK REL="Next"  HREF="021353.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cluster Setup</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20Setup&In-Reply-To=%3CFAB529FB-82AD-4764-ADEB-4A1CDE6DAF13%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Cluster Setup">tim at rabbitmq.com
       </A><BR>
    <I>Thu Jul 19 03:57:24 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021368.html">[rabbitmq-discuss] Cluster Setup
</A></li>
        <LI>Next message: <A HREF="021353.html">[rabbitmq-discuss] Cluster Setup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21369">[ date ]</a>
              <a href="thread.html#21369">[ thread ]</a>
              <a href="subject.html#21369">[ subject ]</a>
              <a href="author.html#21369">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19 Jul 2012, at 02:15, mrajkovic wrote:
&gt;<i> Hi Tim,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Sorry it was 1am locally here when we were emailing last night, and I needed to getup for an early morning appointment&#8230;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Sleeping is pretty important, so fair enough! :)
&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> telnet has blocked it on that port&#8230;
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at mf-01</A>:~# telnet mf-02 4369
</I>&gt;<i> 
</I>&gt;<i> Trying 119.31.227.106...
</I>&gt;<i> 
</I>&gt;<i> telnet: Unable to connect to remote host: Connection refused
</I>&gt;<i> 
</I>&gt;<i> 
</I>
That's more like what we'd expect, given that epmd isn't listening other than on localhost.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> then I ran netstat on mf-02
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at mf-02</A>:~# netstat -p -l --numeric-ports
</I>&gt;<i> 
</I>&gt;<i> Active Internet connections (only servers)
</I>&gt;<i> 
</I>&gt;<i> Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      995/mysqld
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 0.0.0.0:10000           0.0.0.0:*               LISTEN      2028/perl
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      1982/apache2
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 127.0.0.1:4369          0.0.0.0:*               LISTEN      1868/epmd
</I>&gt;<i> 
</I>
So only listening for local traffic. That's not what we should be seeing:

iske:~ root# netstat -a | grep LISTEN
tcp4       0      0  *.epmd                 *.*                    LISTEN     
tcp4       0      0  *.62693                *.*                    LISTEN     
tcp4       0      0  localhost.ipp          *.*                    LISTEN     
tcp6       0      0  localhost.ipp          *.*                    LISTEN     
iske:~ root# 

&gt;<i> tcp        0      0 0.0.0.0:53              0.0.0.0:*               LISTEN      935/dnsmasq
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 0.0.0.0:21              0.0.0.0:*               LISTEN      764/vsftpd
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      800/sshd
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 0.0.0.0:25              0.0.0.0:*               LISTEN      1755/master
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 0.0.0.0:39616           0.0.0.0:*               LISTEN      26602/beam.smp
</I>&gt;<i> 
</I>&gt;<i> tcp        0      0 119.31.227.106:5672     0.0.0.0:*               LISTEN      26602/beam.smp
</I>&gt;<i> 
</I>
And clearly not all programs are having this problem. Indeed beam is running and listening happily enough.

&gt;<i> tcp6       0      0 :::53                   :::*                    LISTEN      935/dnsmasq
</I>&gt;<i> 
</I>&gt;<i> tcp6       0      0 :::22                   :::*                    LISTEN      800/sshd
</I>&gt;<i> 
</I>&gt;<i> tcp6       0      0 :::25                   :::*                    LISTEN      1755/master
</I>&gt;<i> 
</I>&gt;<i> udp        0      0 0.0.0.0:53              0.0.0.0:*                           935/dnsmasq
</I>&gt;<i> 
</I>&gt;<i> udp        0      0 0.0.0.0:43242           0.0.0.0:*                           1613/dccifd
</I>&gt;<i> 
</I>&gt;<i> udp        0      0 0.0.0.0:10000           0.0.0.0:*                           2028/perl
</I>&gt;<i> 
</I>&gt;<i> udp6       0      0 :::53                   :::*                                935/dnsmasq
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> it looks like its only listening on localhost and not all ports
</I>&gt;<i> 
</I>&gt;<i> 
</I>Clearly. The environment variables that govern epmd's behaviour (taken from <A HREF="http://www.erlang.org/doc/man/epmd.html">http://www.erlang.org/doc/man/epmd.html</A>) are:

ERL_EPMD_ADDRESS
This environment variable may be set to a comma-separated list of IP addresses, in which case the epmd daemon will listen only on the specified address(es) and on the loopback address (which is implicitly added to the list if it           has not been specified). The default behaviour is to listen on all available IP addresses.

And in terms of access restrictions, the same source gives us: 

&lt;quote&gt;
Access restrictions
The epmd daemon accepts messages from both localhost and remote hosts. However, only the query commands are answered (and acted upon) if the query comes from a remote host. It is always an error to try to register a nodename if the client is not a process located on the same host as the epmd instance is running on, why such requests are considered hostile and the connection is immediately closed.

The queries accepted from remote nodes are:

Port queries - i.e. on which port does the node with a given name listen

Name listing - i.e. give a list of all names registered on the host

To restrict access further, firewall software has to be used.

&lt;/quote&gt;

Finally, you can control the list of IP addresses epmd will listen on using the `-address List` flags on startup. Rabbit does not do any of these things, your environment config file isn't doing this and so I'm left a little confused. For the beam (emulator) you can set a parameter in the kernel application (inet_dist_use_interface) to control this, but you're not doing that AFAICT - you don't have any other config files (e.g., in wherever RABBITMQ_CONFIG_FILE is pointing) do you? /etc/rabbitmq can contain a rabbitmq.config file as well as the environment config file you posted originally. Is there anything in there? Even so, inet_dist_use_interface doesn't actually affect what addresses epmd will LISTEN on anyway AFAICT.

Is it possible that some other software in your environment could be starting epmd with -address *before* the rabbit nodes are started up? So really I'm at a bit of a loss here. Could you add to the mix by letting me know what Erlang/OTP version you've got installed, where it came from (i.e., apt, compiled from source, etc)? 

Having looked at the epmd source code, if there are no explicit addresses passed to the server then epmd uses INADDR_ANY, which listens on all interfaces (on most linux variants anyway). Unless you can find something in the configuration and/or environment, or there is something going on that causes INADDR_ANY to only bind to localhost (the result of muti-homing or some such) then I don't know what's going on with this one. Unless someone else has any light to shed, or you're able to locate some extraneous config/environment then we might have to take a wander over to the erlang-questions mailing list and ask there, though I will need you to come along and ask the question initially as I'm not the one who's able to replicate this behaviour.

One last question. You're not trying to run rabbit in a restricted environment (i.e., in a jail) are you? It could just be possible that security permissions are restricting the available addresses you can bind to. 

Tim

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120719/fa622b7d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120719/fa622b7d/attachment.htm</A>&gt;
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021368.html">[rabbitmq-discuss] Cluster Setup
</A></li>
	<LI>Next message: <A HREF="021353.html">[rabbitmq-discuss] Cluster Setup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21369">[ date ]</a>
              <a href="thread.html#21369">[ thread ]</a>
              <a href="subject.html#21369">[ subject ]</a>
              <a href="author.html#21369">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
