<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmq-server process consumes 100% of 1 CPU (rabbitmq 2.8.4 on Erlang R14B04)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq-server%20process%20consumes%20100%25%20of%201%0A%20CPU%20%28rabbitmq%202.8.4%20on%20Erlang%20R14B04%29&In-Reply-To=%3C4FFEBE0A.7070400%40lshift.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021214.html">
   <LINK REL="Next"  HREF="021211.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmq-server process consumes 100% of 1 CPU (rabbitmq 2.8.4 on Erlang R14B04)</H1>
    <B>Ceri Storey</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq-server%20process%20consumes%20100%25%20of%201%0A%20CPU%20%28rabbitmq%202.8.4%20on%20Erlang%20R14B04%29&In-Reply-To=%3C4FFEBE0A.7070400%40lshift.net%3E"
       TITLE="[rabbitmq-discuss] rabbitmq-server process consumes 100% of 1 CPU (rabbitmq 2.8.4 on Erlang R14B04)">ceri at lshift.net
       </A><BR>
    <I>Thu Jul 12 13:07:38 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021214.html">[rabbitmq-discuss] queue declaration in amqp c++ client
</A></li>
        <LI>Next message: <A HREF="021211.html">[rabbitmq-discuss] rabbitmq-server process consumes 100% of 1 CPU (rabbitmq 2.8.4 on Erlang R14B04)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21208">[ date ]</a>
              <a href="thread.html#21208">[ thread ]</a>
              <a href="subject.html#21208">[ subject ]</a>
              <a href="author.html#21208">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Emile,

I'm one of Anthony's Colleagues here at LShift, who assisted in the
initial investigation.

    Thanks for this very detailed diagnostic information. Could you perhaps
    supply the output of &quot;rabbitmqctl report&quot; as well? Feel free to compress
    and send to me directly if it is too large.

Size of the report isn't the main issue in this case--sadly, it looks
like even the process of getting a queue listing wasn't going to
terminate any time soon (I gave up after ~10 minutes). I've attached the
output from a broken rabbit (although that only lists &quot;rabbitmqctl
status&quot;) and a report from the same rabbit with an increased file
descriptor limit.

     I have not been able to reproduce the problem - does this happen each
    time you start the cluster? does stopping and starting the slave nodes
    make any difference? Have you discovered a sequence of actions that is
    likely to reproduce the problem?

In the example I'm seeing (on our internal build slaves that the earlier
etop results were derived from), we have about 1400 queues left over
from a set of rather unhygenic integration tests, so I'd infer that
there's some kind of pathological interaction between the mnesia queue
configuration database resource management and the file_handle_cache
module. So, it does indeed happen every time we restart the single
instance (on our CI machines, they're single instances).

On this hunch, I've bumped our file descriptor limit on one machine to
8192 from 1024 files, and it does indeed that the resource usage does
drop dramatically once the instance has started up. So, I think that
brings us to a work around for one case, if not an explanation of the
underlying behaviour.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120712/739f6a02/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120712/739f6a02/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbitmqctl-report-spinning.txt.xz
Type: application/x-xz
Size: 1244 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120712/739f6a02/attachment.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120712/739f6a02/attachment.bin</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rabbitmqctl-report-stable.txt.xz
Type: application/x-xz
Size: 27020 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120712/739f6a02/attachment-0001.bin">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120712/739f6a02/attachment-0001.bin</A>&gt;
</PRE>
















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021214.html">[rabbitmq-discuss] queue declaration in amqp c++ client
</A></li>
	<LI>Next message: <A HREF="021211.html">[rabbitmq-discuss] rabbitmq-server process consumes 100% of 1 CPU (rabbitmq 2.8.4 on Erlang R14B04)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21208">[ date ]</a>
              <a href="thread.html#21208">[ thread ]</a>
              <a href="subject.html#21208">[ subject ]</a>
              <a href="author.html#21208">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
