<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Plz give me help about EPMD: Non-local peer connected
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Plz%20give%20me%20help%20about%20EPMD%3A%20Non-local%20peer%0A%20connected&In-Reply-To=%3C4FFAA084.8030805%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021115.html">
   <LINK REL="Next"  HREF="021117.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Plz give me help about EPMD: Non-local peer connected</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Plz%20give%20me%20help%20about%20EPMD%3A%20Non-local%20peer%0A%20connected&In-Reply-To=%3C4FFAA084.8030805%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Plz give me help about EPMD: Non-local peer connected">tim at rabbitmq.com
       </A><BR>
    <I>Mon Jul  9 10:12:36 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021115.html">[rabbitmq-discuss] Plz give me help about EPMD: Non-local peer	connected
</A></li>
        <LI>Next message: <A HREF="021117.html">[rabbitmq-discuss] Plz give me help about EPMD: Non-local peer connected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21118">[ date ]</a>
              <a href="thread.html#21118">[ thread ]</a>
              <a href="subject.html#21118">[ subject ]</a>
              <a href="author.html#21118">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I also wonder how the hostname is getting resolved. Rabbit actually 
passes the hostname to erl, so you get something more like `erl -sname 
rabbit@&lt;hostname&gt;` which is calculated something like this:

SCRIPT_DIR=`dirname $SCRIPT_PATH`
RABBITMQ_HOME=&quot;${SCRIPT_DIR}/..&quot;
[ &quot;x&quot; = &quot;x$HOSTNAME&quot; ] &amp;&amp; HOSTNAME=`env hostname`
NODENAME=rabbit@${HOSTNAME%%.*}

So what does `env hostname` return on your machine, and can you start an 
Erlang node with this using erl -sname rabbit@`env hostname` or some 
such construct?

On 07/09/2012 10:00 AM, Tim Watson wrote:
&gt;<i> What OS and rabbit version are you running? I've not seen this happen 
</I>&gt;<i> before but I'll investigate.
</I>&gt;<i>
</I>&gt;<i> On 9 Jul 2012, at 07:32, ?? &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">hebin7611 at hotmail.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">hebin7611 at hotmail.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Tim,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for your reply.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried &quot;erl -sname rabbit&quot;, it's OK.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> my /etc/hosts looks like following:
</I>&gt;&gt;<i> 127.0.0.1    game-01 ZSWY76 localhost.localdomain localhost
</I>&gt;&gt;<i> ::1        localhost6.localdomain6 localhost6
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> EPMD can be started successfully, but always reports &quot;Non-local peer 
</I>&gt;&gt;<i> connected&quot; then force disconnecting rabbit-server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Did I forget any necessory configration for RabbitMQ to use loopback 
</I>&gt;&gt;<i> interface to connect epmd?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks a lot.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> He Bin
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Date: Fri, 6 Jul 2012 18:34:07 +0100
</I>&gt;&gt;<i> &gt; From: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tim at rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> &gt; To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A> 
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> &gt; CC: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">hebin7611 at hotmail.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">hebin7611 at hotmail.com</A>&gt;
</I>&gt;&gt;<i> &gt; Subject: Re: [rabbitmq-discuss] Plz give me help about EPMD: 
</I>&gt;&gt;<i> Non-local peer connected
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Hi there,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On 06/07/2012 06:53, ?? wrote:
</I>&gt;&gt;<i> &gt; &gt; Hi all,
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; I installed RabbotMQ &amp; tried to start it.
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; But I always got error as following:
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Ok so first of all, let's see if we can get you to start a stand alone
</I>&gt;&gt;<i> &gt; distributed Erlang node successfully. Normally stack traces like that
</I>&gt;&gt;<i> &gt; occur when the host environment isn't set up quite right (from 
</I>&gt;&gt;<i> Erlang's
</I>&gt;&gt;<i> &gt; perspective).
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; We need to be able to run `erl -sname rabbit` on the command line and
</I>&gt;&gt;<i> &gt; see the Erlang emulator start successfully. It should look something
</I>&gt;&gt;<i> &gt; like this:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ##############
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">t4 at malachi</A>:systest $ erl -sname rabbit
</I>&gt;&gt;<i> &gt; Erlang R15B01 (erts-5.9.1) [source] [64-bit] [smp:2:2] 
</I>&gt;&gt;<i> [async-threads:0]
</I>&gt;&gt;<i> &gt; [hipe] [kernel-poll:false]
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Eshell V5.9.1 (abort with ^G)
</I>&gt;&gt;<i> &gt; (<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at malachi</A>)1&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ##############
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Can you start Erlang like that successfully? I'm assuming not, but
</I>&gt;&gt;<i> &gt; please let us k now.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I'm also interested in understanding what your hosts configuration
</I>&gt;&gt;<i> &gt; (e.g., /etc/hosts) looks like. On some Operating Systems (such as 
</I>&gt;&gt;<i> CentOS
</I>&gt;&gt;<i> &gt; for example), failing to set an explicit host name prevents you from
</I>&gt;&gt;<i> &gt; starting a distributed Erlang node.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; &gt; {error_logger,{{2012,7,6},{13,32,21}},&quot;Protocol: ~p: register error:
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> ~p~n&quot;,[&quot;inet_tcp&quot;,{{badmatch,{error,epmd_close}},[{inet_tcp_dist,listen,1,[{file,&quot;inet_tcp_dist.erl&quot;},{line,70}]},{net_kernel,start_protos,4,[{file,&quot;net_kernel.erl&quot;},{line,1314}]},{net_kernel,start_protos,3,[{file,&quot;net_kernel.erl&quot;},{line,1307}]},{net_kernel,init_node,2,[{file,&quot;net_kernel.erl&quot;},{line,1197}]},{net_kernel,init,1,[{file,&quot;net_kernel.erl&quot;},{line,357}]},{gen_server,init_it,6,[{file,&quot;gen_server.erl&quot;},{line,304}]},{proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,227}]}]}]}
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> {error_logger,{{2012,7,6},{13,32,21}},crash_report,[[{initial_call,{net_kernel,init, 
</I>&gt;&gt;<i> ['Argument__1']}},{pid,&lt;0.20.0&gt;},{registered_name,[]},{error_info,{exit,{error,badarg},[{gen_server,init_it,6,[{file,&quot;gen_server.erl&quot;},{line,320}]},{proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,227}]}]}},{ancest
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> ors,[net_sup,kernel_sup,&lt;0.9.0&gt;]},{messages,[]},{links,[#Port&lt;0.90&gt;,&lt;0.17.0&gt;]},{dictionary,[{longnames,false}]},{trap_exit,true},{status,running},{heap_size,987},{stack_size,24},{reductions,551}],[]]}
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> {error_logger,{{2012,7,6},{13,32,21}},supervisor_report,[{supervisor,{local,net_sup}},{errorContext,start_error},{reason,{'EXIT',nodistribution}},{offender,[{pid,undefined},{name,net_kernel},{mfargs,{net_kernel,start_link,[[rabbitmqprelaunch1077,shortnames]]}},{restart_type,permanent},{shutdown,2000},{child_type,worker}]}]}
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> {error_logger,{{2012,7,6},{13,32,21}},supervisor_report,[{supervisor,{local,kernel_sup}},{errorContext,start_error},{reason,shutdown},{offender,[{pid,undefined},{name,net_sup}, 
</I>&gt;&gt;<i> {mfargs,{erl_distribution,start_link,[]}},{restart_type,permanent},{shutdown,infinity},{child_type,supervisor}]}]}
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> {error_logger,{{2012,7,6},{13,32,21}},std_info,[{application,kernel},{exited,{shutdown,{kernel,start,[normal,[]]}}},{type,permanent}]}
</I>&gt;&gt;<i> &gt; &gt; {&quot;Kern el pid
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> terminated&quot;,application_controller,&quot;{application_start_failure,kernel,{shutdown,{kernel,start,[normal,[]]}}}&quot;}
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; Crash dump was written to: erl_crash.dump
</I>&gt;&gt;<i> &gt; &gt; Kernel pid terminated (application_controller)
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> ({application_start_failure,kernel,{shutdown,{kernel,start,[normal,[]]}}})
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; I ran it on a server with public IP 183.*.*.* .
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; In Erlang src, I found that epmd checks connection src.
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; /* Determine if connection is from localhost */
</I>&gt;&gt;<i> &gt; &gt; if (getpeername(s-&gt;fd,(struct sockaddr*) &amp;si,&amp;st) ||
</I>&gt;&gt;<i> &gt; &gt; s t &lt; sizeof(si)) {
</I>&gt;&gt;<i> &gt; &gt; /* Failure to get peername is regarded as non local host */
</I>&gt;&gt;<i> &gt; &gt; s-&gt;local_peer = EPMD_FALSE;
</I>&gt;&gt;<i> &gt; &gt; } else {
</I>&gt;&gt;<i> &gt; &gt; /* Only 127.x.x.x and connections from the host's IP address
</I>&gt;&gt;<i> &gt; &gt; allowed, no false positives */
</I>&gt;&gt;<i> &gt; &gt; s-&gt;local_peer =
</I>&gt;&gt;<i> &gt; &gt; (((((unsigned) ntohl(si.sin_addr.s_addr)) &amp; 0xFF000000U) ==
</I>&gt;&gt;<i> &gt; &gt; 0x7F000000U) ||
</I>&gt;&gt;<i> &gt; &gt; (getsockname(s-&gt;fd,(struct sockaddr*) &amp;di,&amp;st) ?
</I>&gt;&gt;<i> &gt; &gt; EPMD_FALSE : si.sin_addr.s_addr == di.s in_addr.s_addr));
</I>&gt;&gt;<i> &gt; &gt; }
</I>&gt;&gt;<i> &gt; &gt; dbg_tty_printf(g,2,(s-&gt;local_peer) ? &quot;Local peer connected&quot; :
</I>&gt;&gt;<i> &gt; &gt; &quot;Non-local peer connected&quot;);
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; But unfortunately, si.sin_addr.s_addr was 183.*.*.*, while
</I>&gt;&gt;<i> &gt; &gt; di.sin_addr.s_addr was 127.0.0.1
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &amp; gt; &gt; My log:Checking peer address, getsockname ret: 0, 
</I>&gt;&gt;<i> si_addr=0xb7??????,
</I>&gt;&gt;<i> &gt; &gt; di_addr=0x7f000001
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I could be wrong, but I suspect this is a red herring. You can restart
</I>&gt;&gt;<i> &gt; epmd with -d to get debugging information as well, but I suspect this
</I>&gt;&gt;<i> &gt; isn't relevant.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Is there any way to force RabbitMQ server connect epmd via a specified
</I>&gt;&gt;<i> &gt; &gt; address?
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I'm not really sure what you mean by this, but I'm fairly confident 
</I>&gt;&gt;<i> that
</I>&gt;&gt;<i> &gt; it is not necessary to even attempt to do something like that. Erlang
</I>&gt;&gt;<i> &gt; should be able to start up nodes with `-sname &lt;name&gt;` or `-name
</I>&gt;&gt;<i> &gt; &lt;name&gt;@&lt;host&gt;` and if either doesn't work, a little tweaking of the 
</I>&gt;&gt;<i> host
</I>&gt;&gt;<i> &gt; configuration should solve it.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Based on your original comment (starting rabbitmq but always 
</I>&gt;&gt;<i> getting an
</I>&gt;&gt;<i> &gt; error) my understanding is that you're trying to start rabbit on this
</I>&gt;&gt;<i> &gt; machine and it fails. AFAIK when a distributed Erlang node connects to
</I>&gt;&gt;<i> &gt; EPMD on the localhost it should be treated as such. The 
</I>&gt;&gt;<i> rabbitmq-server
</I>&gt;&gt;<i> &gt; script starts rabbit up with `-sname rabbit` which implies that the 
</I>&gt;&gt;<i> node
</I>&gt;&gt;<i> &gt; name will be rabbit@&lt;hostname&gt; so you should make sure that `erl 
</I>&gt;&gt;<i> -sname
</I>&gt;&gt;<i> &gt; rabbit` works first of all.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A> 
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120709/db11af9b/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120709/db11af9b/attachment.htm</A>&gt;
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021115.html">[rabbitmq-discuss] Plz give me help about EPMD: Non-local peer	connected
</A></li>
	<LI>Next message: <A HREF="021117.html">[rabbitmq-discuss] Plz give me help about EPMD: Non-local peer connected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21118">[ date ]</a>
              <a href="thread.html#21118">[ thread ]</a>
              <a href="subject.html#21118">[ subject ]</a>
              <a href="author.html#21118">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
