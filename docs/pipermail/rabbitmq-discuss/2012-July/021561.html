<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] &#31572;&#22797;:  something about message priority
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%0A%20%3D%3Futf-8%3Fb%3F562U5aSNOiAgc29tZXRoaW5nIGFib3V0IG1l%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fssage_priority%3F%3D&In-Reply-To=%3C5012827E.6010004%40vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021559.html">
   <LINK REL="Next"  HREF="021571.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] &#31572;&#22797;:  something about message priority</H1>
    <B>Gary Russell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%0A%20%3D%3Futf-8%3Fb%3F562U5aSNOiAgc29tZXRoaW5nIGFib3V0IG1l%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fssage_priority%3F%3D&In-Reply-To=%3C5012827E.6010004%40vmware.com%3E"
       TITLE="[rabbitmq-discuss] &#31572;&#22797;:  something about message priority">grussell at vmware.com
       </A><BR>
    <I>Fri Jul 27 12:58:54 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021559.html">[rabbitmq-discuss] &#31572;&#22797;:  something about message priority
</A></li>
        <LI>Next message: <A HREF="021571.html">[rabbitmq-discuss] Rabbit.js and x-ha-policy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21561">[ date ]</a>
              <a href="thread.html#21561">[ thread ]</a>
              <a href="subject.html#21561">[ subject ]</a>
              <a href="author.html#21561">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This comes up once in a while on the spring-amqp ( <A HREF="http://forum.springsource.org/forumdisplay.php?74-AMQP">http://forum.springsource.org/forumdisplay.php?74-AMQP</A>) and spring-integration ( <A HREF="http://forum.springsource.org/forumdisplay.php?42-Integration">http://forum.springsource.org/forumdisplay.php?42-Integration</A>) forums; especially from folks migrating from JMS.

The general solution is to simulate priority, by having the listener container listen on multiple queues (e.g. 'low, normal, high') and have the client use a different routing key, based on the priority.

This generally works fine, as long as most messages are 'normal' and only a few are high. If you have a priority distribution that has many high priority messages (in relation to normal), you might be better off configuring a different listener container for each queue, so you can configure the consumer count appropriately for each queue (e.g. more consumers for the high priority queue).

On the client side, when using Spring Integration, it's easy to configure a routing-key-expression on the &lt;outbound-channel-adapter/&gt; to generate the appropriate routing key.

Even when not using Spring Integration, it's simple to do the same.

Hope that helps.

Gary
Spring Integration Team
VMware, Inc.


On 07/27/2012 05:31 AM, Ernest Staszuk wrote:
I didn't use spring amqp api, so I can not provide you working example.

I use consuming with small timeout (and there is a cost of time - small delay,
 not an issue in my case, cpu usage and network fingerprints stays very small).
I was also taking advantage of rabbit's java client prefetching (I am not sure
if spring implements that). These two combined gave me acceptable approximation of priorities.

You could also add to messages own argument (for example myPriority) and consume all messages
as they are available (or let's say up to 200 messages or sth), then put them in a priority
queue on your application side. And then process them from the head of this container (using
dedicated thread). That also may give you acceptable results.

Note that the state of art is as follows: RabbitMQ is a FIFO queue, and does not make
use of message priorities today. It could be changed in one of the future releases, I don't
know when it may be. As consequence of that you should apply some reasonable workaround
which will be acceptable for you or reconsider your needs (maybe you don't really need
priorities?) or use something else than RabbitMQ or implement it by yourself. By the way
AMQP itself says that &quot;Messages with higher priorities MAY be delivered before those with
lower priorities&quot;. Following that messages priority in any implementation of AMQP may
be not consistent.

Best regards,
Ernest Staszuk





W dniu 2012-07-27 10:50, andy pisze:
at as you say ,if we are processing 2st queue message as soon as the 1st queue gets a new message needed to process,how can we switch to process 1st? It also means that we should check the amount of  messages in the queue  in order ,I think it will cost much time and machine resource.and could you tell me  how I could  use spring amqp a


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120727/333c9986/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120727/333c9986/attachment.htm</A>&gt;
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021559.html">[rabbitmq-discuss] &#31572;&#22797;:  something about message priority
</A></li>
	<LI>Next message: <A HREF="021571.html">[rabbitmq-discuss] Rabbit.js and x-ha-policy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21561">[ date ]</a>
              <a href="thread.html#21561">[ thread ]</a>
              <a href="subject.html#21561">[ subject ]</a>
              <a href="author.html#21561">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
