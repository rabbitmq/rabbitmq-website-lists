<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Security Exception in IIS using RabbitMQ	Client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Security%20Exception%20in%20IIS%20using%20RabbitMQ%0A%09Client&In-Reply-To=%3C4FF1DB3B-E711-4E36-BD47-7E5D2BF332A6%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021433.html">
   <LINK REL="Next"  HREF="021440.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Security Exception in IIS using RabbitMQ	Client</H1>
    <B>Tim Watson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Security%20Exception%20in%20IIS%20using%20RabbitMQ%0A%09Client&In-Reply-To=%3C4FF1DB3B-E711-4E36-BD47-7E5D2BF332A6%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Security Exception in IIS using RabbitMQ	Client">watson.timothy at gmail.com
       </A><BR>
    <I>Fri Jul 20 22:56:35 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021433.html">[rabbitmq-discuss] Security Exception in IIS using RabbitMQ	Client
</A></li>
        <LI>Next message: <A HREF="021440.html">[rabbitmq-discuss] Security Exception in IIS using RabbitMQ	Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21437">[ date ]</a>
              <a href="thread.html#21437">[ thread ]</a>
              <a href="subject.html#21437">[ subject ]</a>
              <a href="author.html#21437">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 20 Jul 2012, at 19:43, Dave Seltzer &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dseltzer at tveyes.com</A>&gt; wrote:

&gt;<i> Thanks for your help Tim,
</I>&gt;<i> 
</I>&gt;<i> It seems like this isn't an issue with actual file IO, but rather Code
</I>&gt;<i> Security.
</I>&gt;<i> 
</I>&gt;<i> I've tried setting &lt;trust level=&quot;Full&quot; originUrl=&quot;&quot; /&gt; in the web.config,
</I>&gt;<i> but it doesn't seem to help.
</I>&gt;<i> 
</I>
Yes that was my first suspicion. There is a way of setting policy for your web app and for assemblies your linking to but I don't remember off-hand how to set up policies for assemblies outside the GAC. How do you reference the rabbit client assembly in your project? Is this just being done in visual studio or are there settings in the web.config? Forgive my .NET being a bit rusty these days!

&gt;<i> The full stacktrace is below.
</I>&gt;<i> 
</I>&gt;<i> -D
</I>&gt;<i> 
</I>&gt;<i> [SecurityException: Request for the permission of type
</I>&gt;<i> 'System.Security.Permissions.FileIOPermission, mscorlib, Version=2.0.0.0,
</I>&gt;<i> Culture=neutral, PublicKeyToken=b77a5c561934e089' failed.]
</I>&gt;<i>   System.Security.CodeAccessSecurityEngine.Check(Object demand,
</I>&gt;<i> StackCrawlMark&amp; stackMark, Boolean isPermSet) +0
</I>&gt;<i>   System.Security.CodeAccessPermission.Demand() +54
</I>&gt;<i>   System.Reflection.Assembly.VerifyCodeBaseDiscovery(String codeBase)
</I>&gt;<i> +162
</I>&gt;<i>   System.Reflection.Assembly.GetName(Boolean copiedName) +117
</I>&gt;<i>   RabbitMQ.Client.Impl.ConnectionBase.DefaultClientProperties() +42
</I>&gt;<i>   RabbitMQ.Client.ConnectionFactory..ctor() +70
</I>&gt;<i>   ASP.api_messagesearch_aspx.__Render__control1(HtmlTextWriter __w,
</I>&gt;<i> Control parameterContainer) in \\[snip]\api\MessageSearch.aspx:9
</I>&gt;<i>   System.Web.UI.Control.RenderChildrenInternal(HtmlTextWriter writer,
</I>&gt;<i> ICollection children) +115
</I>&gt;<i>   System.Web.UI.Page.Render(HtmlTextWriter writer) +38
</I>&gt;<i>   System.Web.UI.Page.ProcessRequestMain(Boolean
</I>&gt;<i> includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint)
</I>&gt;<i> +11070247
</I>&gt;<i>   System.Web.UI.Page.ProcessRequest(Boolean
</I>&gt;<i> includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint)
</I>&gt;<i> +11069786
</I>&gt;<i>   System.Web.UI.Page.ProcessRequest() +91
</I>&gt;<i>   System.Web.UI.Page.ProcessRequest(HttpContext context) +240
</I>&gt;<i>   ASP.api_messagesearch_aspx.ProcessRequest(HttpContext context) in
</I>&gt;<i> c:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET
</I>&gt;<i> Files\root\cb973a2c\79ccea1e\App_Web_nkfbtca4.9.cs:0
</I>&gt;<i> 
</I>&gt;<i> System.Web.CallHandlerExecutionStep.System.Web.HttpApplication.IExecutionS
</I>&gt;<i> tep.Execute() +599
</I>&gt;<i>   System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean&amp;
</I>&gt;<i> completedSynchronously) +171
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>
</I>&gt;<i> [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>] On Behalf Of Tim
</I>&gt;<i> Watson
</I>&gt;<i> Sent: Friday, July 20, 2012 2:33 PM
</I>&gt;<i> To: Discussions about RabbitMQ
</I>&gt;<i> Cc: Discussions about RabbitMQ
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] Security Exception in IIS using RabbitMQ
</I>&gt;<i> Client
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/4925331/system-security-permissions-fil">http://stackoverflow.com/questions/4925331/system-security-permissions-fil</A>
</I>&gt;<i> eiopermission-when-accessing-folder-outside-web-s
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 20 Jul 2012, at 19:28, Tim Watson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">watson.timothy at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 20 Jul 2012, at 19:06, Dave Seltzer &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dseltzer at tveyes.com</A>&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I'm having a bit of trouble using the .NET RabbitMQ client in IIS,
</I>&gt;<i> maybe
</I>&gt;&gt;&gt;<i> someone knows what I'm running into.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Here's the code I'm trying to run:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  ConnectionFactory rabbitConFactory = new ConnectionFactory();
</I>&gt;&gt;&gt;<i>  rabbitConFactory.Address = &quot;hostname&quot;;
</I>&gt;&gt;&gt;<i>  rabbitConFactory.VirtualHost = &quot;/path&quot;;
</I>&gt;&gt;&gt;<i>  rabbitConFactory.UserName = &quot;user&quot;;
</I>&gt;&gt;&gt;<i>  rabbitConFactory.Password = &quot;password&quot;;
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  IConnection connection = rabbitConFactory.CreateConnection();
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  IModel channel = connection.CreateModel();
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  Dictionary&lt;String, Object&gt; args = new Dictionary&lt;string, object&gt;();
</I>&gt;&gt;&gt;<i>  args.Add(&quot;x-ha-policy&quot;, &quot;all&quot;);
</I>&gt;&gt;&gt;<i>  String ExchangeName = &quot;SearchInstructions&quot;;
</I>&gt;&gt;&gt;<i>  channel.ExchangeDeclare(ExchangeName, &quot;topic&quot;, true, false, args);
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  Guid myId = new Guid();
</I>&gt;&gt;&gt;<i>  String RoutingKey = myId.ToString() + &quot;.Instruction&quot;;
</I>&gt;&gt;&gt;<i>  IBasicProperties MessageProperties = channel.CreateBasicProperties();
</I>&gt;&gt;&gt;<i>  MessageProperties.SetPersistent(true);
</I>&gt;&gt;&gt;<i>  MessageProperties.ContentEncoding = &quot;UTF-8&quot;;
</I>&gt;&gt;&gt;<i>  MessageProperties.ContentType = &quot;text/xml&quot;;
</I>&gt;&gt;&gt;<i>  MessageProperties.Headers.Add(&quot;x-origin&quot;,
</I>&gt;&gt;&gt;<i> Request.ServerVariables[&quot;ServerName&quot;]);
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  String messageContent = &quot;&lt;foo /&gt;&quot;;
</I>&gt;&gt;&gt;<i>  byte[] data = System.Text.Encoding.UTF8.GetBytes(messageContent);
</I>&gt;&gt;&gt;<i>  channel.BasicPublish(ExchangeName,RoutingKey, MessageProperties,
</I>&gt;&gt;&gt;<i> data);
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  channel.Close();
</I>&gt;&gt;&gt;<i>  connection.Close();
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> When I run the code in an ASPX page I receive the following Security
</I>&gt;&gt;&gt;<i> Exception:
</I>&gt;&gt;&gt;<i>  Security Exception
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  Description: The application attempted to perform an operation not
</I>&gt;&gt;&gt;<i> allowed by the security policy.  To grant this application the required
</I>&gt;&gt;&gt;<i> permission please contact your system administrator or change the
</I>&gt;&gt;&gt;<i> application's trust level in the configuration file.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>  Exception Details: System.Security.SecurityException: Request for the
</I>&gt;&gt;&gt;<i> permission of type 'System.Security.Permissions.FileIOPermission,
</I>&gt;&gt;&gt;<i> mscorlib, Version=2.0.0.0, Culture=neutral,
</I>&gt;&gt;&gt;<i> PublicKeyToken=b77a5c561934e089' failed.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I'm not really sure how to proceed. This sounds like an IIS issue, but
</I>&gt;&gt;&gt;<i> someone here must have tackled this problem before.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> This is indeed an IIS configuration issue. You need to grant the
</I>&gt;<i> assembly the appropriate code access permissions. It's been a long time
</I>&gt;<i> since I looked at IIS, so I can't tell you exactly where to set this up
</I>&gt;<i> until I'm in front of a browser, but checking msdn for Code Access,
</I>&gt;<i> FileIOPermission, assemblies and IIS is where I'd start if you want to get
</I>&gt;<i> a head start. Post the list if you figure it out first please! :)
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Thanks much!
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> -Dave
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021433.html">[rabbitmq-discuss] Security Exception in IIS using RabbitMQ	Client
</A></li>
	<LI>Next message: <A HREF="021440.html">[rabbitmq-discuss] Security Exception in IIS using RabbitMQ	Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21437">[ date ]</a>
              <a href="thread.html#21437">[ thread ]</a>
              <a href="subject.html#21437">[ subject ]</a>
              <a href="author.html#21437">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
