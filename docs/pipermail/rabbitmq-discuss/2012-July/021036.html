<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] STOMP plug-in, HA queues,	and consumer cancelations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20STOMP%20plug-in%2C%20HA%20queues%2C%0A%09and%20consumer%20cancelations&In-Reply-To=%3CCAFDmHdMVjvJm_W4_FaQVsR%2BMuZDWG3Ai35FEwqB9N_15M3j92g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021034.html">
   <LINK REL="Next"  HREF="021048.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] STOMP plug-in, HA queues,	and consumer cancelations</H1>
    <B>Elias Levy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20STOMP%20plug-in%2C%20HA%20queues%2C%0A%09and%20consumer%20cancelations&In-Reply-To=%3CCAFDmHdMVjvJm_W4_FaQVsR%2BMuZDWG3Ai35FEwqB9N_15M3j92g%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] STOMP plug-in, HA queues,	and consumer cancelations">fearsome.lucidity at gmail.com
       </A><BR>
    <I>Tue Jul  3 18:52:45 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="021034.html">[rabbitmq-discuss] STOMP plug-in, HA queues,	and consumer cancelations
</A></li>
        <LI>Next message: <A HREF="021048.html">[rabbitmq-discuss] STOMP plug-in, HA queues,	and consumer cancelations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21036">[ date ]</a>
              <a href="thread.html#21036">[ thread ]</a>
              <a href="subject.html#21036">[ subject ]</a>
              <a href="author.html#21036">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Jul 3, 2012 at 9:06 AM, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">steve at rabbitmq.com</A>&gt; wrote:

&gt;<i> You are quite right. Your understanding of HA queues is better than
</I>&gt;<i> mine. However, AFAICS the STOMP adapter doesn't present
</I>&gt;<i> the consumer_cancel_notify capability to the (Erlang) connection, so
</I>&gt;<i> will not receive a notification when the consumer is cancelled.
</I>&gt;<i>
</I>&gt;<i> The STOMP client will think that the subscription is sound even if the
</I>&gt;<i> underlying consumer was cancelled. We can probably do better than this.
</I>&gt;<i>
</I>
And therein lies the problem.


&gt;<i> Although the STOMP client will stop receiving messages, I would not
</I>&gt;<i> characterise this as 'dangerous', merely frustrating.
</I>&gt;<i>
</I>
Maybe not dangerous, since there is no data loss, but certainly a lot worse
than frustrating.  If you have long lived STOMP connections with consumers
which suddenly stop receiving messages without any warning, depending on
the importance of those messages and the processes that consume them, the
loss of the subscription can be quite important from a business perspective.

E.g. if those messages are being used to monitor some business activity,
you are now flying blind until the STOMP connection is torn down and
reestablished.

Can you say what you think the correct STOMP behaviour ought to be if a
&gt;<i> subscription's consumer is unilaterally cancelled? I'm tempted to simply
</I>&gt;<i> send an ERROR frame and simulate an UNSUBSCRIBE,
</I>&gt;<i> leaving the STOMP client to recover however it thinks fit.
</I>&gt;<i>
</I>
To resubscribe to the HA queues, obviously.  The HA queue consumer
cancelation is a rather ugly implementation detail.  In an ideal world, a
HA queue would behave just like a non-HA queue.  From a consumer
perspective whether a queue is HA or non-HA would be invisible.  A HA queue
would failover without consumers attached to the non-failing nodes
noticing. Alas, this is not the case, and I understand why that is given
the existing implementation.

So ideally the STOMP proxy would resubscribe when it receives a consumer
cancelation.  Any messages that consumers received that had not yet been
acked or for which acks where lost in flight wil be requeued and
retransmitted by the new queue master.  I believe thats OK.  RMQ and AMQP
already have an expectation that some messages may be delivered more than
once as it does not have a two-phase commit for acknowledgements, so
clients should already be ready for this eventuality.

But even sending an ERROR frame to the client to it knowns something went
wrong and giving it an opportunity to recover is much better than the
situation as it is right now.

Elias Levy
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120703/fe2fd86c/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120703/fe2fd86c/attachment.htm</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021034.html">[rabbitmq-discuss] STOMP plug-in, HA queues,	and consumer cancelations
</A></li>
	<LI>Next message: <A HREF="021048.html">[rabbitmq-discuss] STOMP plug-in, HA queues,	and consumer cancelations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21036">[ date ]</a>
              <a href="thread.html#21036">[ thread ]</a>
              <a href="subject.html#21036">[ subject ]</a>
              <a href="author.html#21036">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
