From 0x6e6562 at gmail.com  Tue Sep  1 00:08:17 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 1 Sep 2009 00:08:17 +0100
Subject: [rabbitmq-discuss] Transaction management
In-Reply-To: <423d2cbb0908311128m6c59932bv700a0ff82651b2a0@mail.gmail.com>
References: <423d2cbb0908311128m6c59932bv700a0ff82651b2a0@mail.gmail.com>
Message-ID: <269388e30908311608h6d4b35e8x54acfd8ead995c7a@mail.gmail.com>

Amith,

On Mon, Aug 31, 2009 at 7:28 PM, amith kashyap<anktth at gmail.com> wrote:
> Can RabbitMQ act as the transaction manager in a transaction ? or just as a
> participant ?

Rabbit can manage it's own transactions (well, I guess it kind of has
to), but it seems as though you're looking for something like JTA or
even XA - unfortunately there is no interface against which Rabbit
could be enlisted as a participant.

Ben



From charity at lindenlab.com  Tue Sep  1 01:49:37 2009
From: charity at lindenlab.com (Charity Majors)
Date: Mon, 31 Aug 2009 17:49:37 -0700
Subject: [rabbitmq-discuss] direct queue throughput
In-Reply-To: <20090831193741.GA17165@wellquite.org>
References: <f7541d9c0908281516n3e6545c1m8cbe7cd611af7e0@mail.gmail.com>
	<15FDFBBA-B8E0-4FBD-BBA1-7BC516A46CD4@mac.com>
	<20090828230109.GA4507@wellquite.org>
	<f7541d9c0908281651g36073d79x561b99ea118ed2d3@mail.gmail.com>
	<20090829104432.GA6005@wellquite.org>
	<f7541d9c0908311225q4ee47520g55435d388500a6d8@mail.gmail.com>
	<20090831193741.GA17165@wellquite.org>
Message-ID: <f7541d9c0908311749o4159651al62c54577d8c1c979@mail.gmail.com>

>> Yeah, this makes sense. ?Let me try taking RMQ out of the equation
>> completely and seeing how fast the producers are producing messages.
>
> Do let us know how you get on.

Looks like it's a problem with my producers after all.  If I strip out
all the bits that talk to RMQ, I'm only producing about 2-3k messages
a second.  Yikes.

Thanks much,
charity.



From alexis.richardson at gmail.com  Tue Sep  1 03:46:50 2009
From: alexis.richardson at gmail.com (Alexis Richardson)
Date: Mon, 31 Aug 2009 19:46:50 -0700
Subject: [rabbitmq-discuss] Transaction management
In-Reply-To: <269388e30908311608h6d4b35e8x54acfd8ead995c7a@mail.gmail.com>
References: <423d2cbb0908311128m6c59932bv700a0ff82651b2a0@mail.gmail.com>
	<269388e30908311608h6d4b35e8x54acfd8ead995c7a@mail.gmail.com>
Message-ID: <167204d20908311946s7acb854h543f09671d35d260@mail.gmail.com>

Amith,

Can you talk through your use case please?

alexis


On Mon, Aug 31, 2009 at 4:08 PM, Ben Hood<0x6e6562 at gmail.com> wrote:
> Amith,
>
> On Mon, Aug 31, 2009 at 7:28 PM, amith kashyap<anktth at gmail.com> wrote:
>> Can RabbitMQ act as the transaction manager in a transaction ? or just as a
>> participant ?
>
> Rabbit can manage it's own transactions (well, I guess it kind of has
> to), but it seems as though you're looking for something like JTA or
> even XA - unfortunately there is no interface against which Rabbit
> could be enlisted as a participant.
>
> Ben
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



From anthony-rabbitmq at hogan.id.au  Tue Sep  1 08:36:02 2009
From: anthony-rabbitmq at hogan.id.au (Anthony)
Date: Tue, 1 Sep 2009 17:36:02 +1000
Subject: [rabbitmq-discuss] of queues, memory and heartbeats...
Message-ID: <1bf8be120909010036lf5ad8e5r97801898214397@mail.gmail.com>

Hi all,

We're in a particular situation where occasionally a client will be
disconnected from the server (often through some unclean network break, such
as the random stuff that can happen with 3G data links and virtual
machines), but the queues associated with that client don't die and continue
to grow.

Eventually some of the queues grow so large, that we start seeing txamqp
(the client side library we use) start whining that it doesn't know what to
do with "channel_flow" - presumably this is the memory based throttling
kicking in (though I don't recall explicitly enabling it - unless it's
something auto-enabled by default in the .deb packages?)...

Questions would be:

   1. Even though we haven't explicitly enabled it, if we do start to see
   channel_flow messages, this would be the memory based throttling, correct?

   2. Besides rabbit noticing when a TCP connection dies - is there any
   "heartbeat" functionality built into rabbit and/or the AMQP spec that would
   actually test whether or not a connection is active, and if it isn't, kill
   the relevant queues? Do I as the person who monitors the server configure
   this, or do the programmers who write our clients need to incorporate
   something into their code?

   3. In calculating the "5%" of memory available threshold, what would
   rabbit be considering memory.. Real? Swap? Virtual? All of the above?
   Ie.
   # cat /proc/meminfo | grep -i "total\|free"
   MemTotal:       514056 kB
   MemFree:        144860 kB
   HighTotal:           0 kB
   HighFree:            0 kB
   LowTotal:       514056 kB
   LowFree:        144860 kB
   SwapTotal:     1044184 kB
   SwapFree:       838244 kB
   VmallocTotal:   442360 kB
   HugePages_Total:     0
   HugePages_Free:      0

As a failsafe against runaway queues, I'm thinking of implementing something
that culls queues over a given order of magnitude on a timed basis, or
triggered by a lower memory threshold than rabbit's..
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090901/20bf43e7/attachment.htm 

From 0x6e6562 at gmail.com  Tue Sep  1 09:19:00 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 1 Sep 2009 09:19:00 +0100
Subject: [rabbitmq-discuss] of queues, memory and heartbeats...
In-Reply-To: <1bf8be120909010036lf5ad8e5r97801898214397@mail.gmail.com>
References: <1bf8be120909010036lf5ad8e5r97801898214397@mail.gmail.com>
Message-ID: <269388e30909010119r19b69f0ep3bbbbf79824bafed@mail.gmail.com>

Anthony,

On Tue, Sep 1, 2009 at 8:36 AM, Anthony<anthony-rabbitmq at hogan.id.au> wrote:
> We're in a particular situation where occasionally a client will be
> disconnected from the server (often through some unclean network break, such
> as the random stuff that can happen with 3G data links and virtual
> machines), but the queues associated with that client don't die and continue
> to grow.
>
> Eventually some of the queues grow so large, that we start seeing txamqp
> (the client side library we use) start whining that it doesn't know what to
> do with "channel_flow" - presumably this is the memory based throttling
> kicking in (though I don't recall explicitly enabling it - unless it's
> something auto-enabled by default in the .deb packages?)...

Although it is was written a while ago, the behavior it describes
w.r.t channel.flow is still current:

http://hopper.squarespace.com/blog/2008/11/9/flow-control-in-rabbitmq.html

However, the actual client library needs to be aware of the
channel.flow command (which is a reverse RPC from the client's
perspective). IIRC txamqp is based on the qpid python client - it
might be worth looking it that client's support for channel.flow (or
just ask the txamqp guys because I might be wrong).

> Even though we haven't explicitly enabled it, if we do start to see
> channel_flow messages, this would be the memory based throttling, correct?

Yes. Exceeding a high water mark will trigger an alarm which then
sends out the channel flow command.

> Besides rabbit noticing when a TCP connection dies - is there any
> "heartbeat" functionality built into rabbit and/or the AMQP spec that would
> actually test whether or not a connection is active, and if it isn't, kill
> the relevant queues?

There are heartbeats as part of the protocol, but would only propagate
a connection getting killed. This *may* kill queues, for example if
they are not marked as durable.

> Do I as the person who monitors the server configure
> this, or do the programmers who write our clients need to incorporate
> something into their code?

ATM the best why to monitor queues and connections is via rabbitmqctl,
which is an admin centric tool. There is very little exposed in the
client libraries on this matter.

> In calculating the "5%" of memory available threshold, what would rabbit be
> considering memory.. Real? Swap? Virtual? All of the above?
> Ie.
> # cat /proc/meminfo | grep -i "total\|free"
> MemTotal:?????? 514056 kB
> MemFree:??????? 144860 kB
> HighTotal:?????????? 0 kB
> HighFree:??????????? 0 kB
> LowTotal:?????? 514056 kB
> LowFree:??????? 144860 kB
> SwapTotal:???? 1044184 kB
> SwapFree:?????? 838244 kB
> VmallocTotal:?? 442360 kB
> HugePages_Total:???? 0
> HugePages_Free:????? 0

The rabbit_memsup_linux module parses these values out of /proc/meminfo:

'MemTotal', 'MemFree', 'Buffers', 'Cached'

such that

MemUsed = MemTotal - MemFree - Buffers - Cached

> As a failsafe against runaway queues, I'm thinking of implementing something
> that culls queues over a given order of magnitude on a timed basis, or
> triggered by a lower memory threshold than rabbit's..

You might be interested in the new persister that is coming out in the
next release (there are many posts on this - google the archive for
queue paging). With this, you won't be bounded by memory any more.

On a similar note, recently we implemented a queue drain command as
part of the BQL plugin (which is dependent on the plugin mechanism
that is part of the next release) - for one system I just wrote a cron
job that drained the queue to a disk log every hour.

HTH,

Ben



From thomas.herve at canonical.com  Tue Sep  1 09:31:45 2009
From: thomas.herve at canonical.com (Thomas =?ISO-8859-1?Q?Herv=E9?=)
Date: Tue, 01 Sep 2009 10:31:45 +0200
Subject: [rabbitmq-discuss] Python library (py-amqplib)
In-Reply-To: <4A98AB7C.70201@barryp.org>
References: <ce2570e20908051108o3382ed2ke23e9fdd28bd2045@mail.gmail.com>
	<3bb0d9710908060252t7a20e5b4i36b972a222915e5e@mail.gmail.com>
	<4A86E7A3.2040309@barryp.org>  <4A98AB7C.70201@barryp.org>
Message-ID: <1251793905.27818.0.camel@brainwave>

Le vendredi 28 ao?t 2009 ? 23:15 -0500, Barry Pederson a ?crit :
> Hi Everyone:
> 
> I just tagged and uploaded a version 0.6.1 of the Python amqplib to PyPI
> 
>      http://pypi.python.org/pypi/amqplib/0.6.1
> 
> containing the various fixed accumulated over the summer.  The download 
> and source code can also be found on Google Code
> 
>      http://code.google.com/p/py-amqplib/

Thanks a lot for the release!

We've been using the -devel tag for a while now, especially for timeout
support. Any plan to release this branch as well, or do you have any
blocker?

-- 
Thomas




From matthias at lshift.net  Tue Sep  1 09:53:50 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 01 Sep 2009 09:53:50 +0100
Subject: [rabbitmq-discuss] of queues, memory and heartbeats...
In-Reply-To: <269388e30909010119r19b69f0ep3bbbbf79824bafed@mail.gmail.com>
References: <1bf8be120909010036lf5ad8e5r97801898214397@mail.gmail.com>
	<269388e30909010119r19b69f0ep3bbbbf79824bafed@mail.gmail.com>
Message-ID: <4A9CE11E.5000402@lshift.net>

Anthony,

Ben Hood wrote:
> There are heartbeats as part of the protocol, but would only propagate
> a connection getting killed. This *may* kill queues, for example if
> they are not marked as durable.

Durability settings only affect what happens to a queue when the *server 
restarts*.

OTOH, if you mark queues as exclusive then they *will* be removed when 
the connection dies. Similarly, if the queue is marked as auto-delete 
and its only remaining consumers were on the dying connection.

 From your description it sounds like exclusive queues are exactly what 
you want. Their lifetime is tied to that of the creating connection.

Regards,

Matthias.



From 0x6e6562 at gmail.com  Tue Sep  1 10:16:07 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 1 Sep 2009 10:16:07 +0100
Subject: [rabbitmq-discuss] of queues, memory and heartbeats...
In-Reply-To: <4A9CE11E.5000402@lshift.net>
References: <1bf8be120909010036lf5ad8e5r97801898214397@mail.gmail.com>
	<269388e30909010119r19b69f0ep3bbbbf79824bafed@mail.gmail.com>
	<4A9CE11E.5000402@lshift.net>
Message-ID: <269388e30909010216v46fad0c3r1c804d1fc5e0b6f8@mail.gmail.com>

On Tue, Sep 1, 2009 at 9:53 AM, Matthias Radestock<matthias at lshift.net> wrote:
>> There are heartbeats as part of the protocol, but would only propagate
>> a connection getting killed. This *may* kill queues, for example if
>> they are not marked as durable.
>
> Durability settings only affect what happens to a queue when the *server
> restarts*.

Sorry, my mistake. At least somebody was paying attention :-)

Ben



From 0x6e6562 at gmail.com  Tue Sep  1 10:56:47 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 1 Sep 2009 10:56:47 +0100
Subject: [rabbitmq-discuss] building chat
In-Reply-To: <64312.10265.qm@web44715.mail.sp1.yahoo.com>
References: <860157.29474.qm@web44702.mail.sp1.yahoo.com>
	<167204d20908260036v7bf73a3ei8051c0354eec6cf5@mail.gmail.com>
	<619996.73011.qm@web44714.mail.sp1.yahoo.com>
	<269388e30908270522n62ee3dbdo498b9a46f383fb64@mail.gmail.com>
	<64312.10265.qm@web44715.mail.sp1.yahoo.com>
Message-ID: <269388e30909010256q2d52bd05r25ddf28754b2eb6c@mail.gmail.com>

Ram,

On Mon, Aug 31, 2009 at 11:10 PM, Ram Muthiah<ram.muthiah at yahoo.com> wrote:
> I replied to your email last week and copied the list address also. I am not
> copying the list for this email because I am resending the same questions
> again.
>
> 1. Can I use this default exchange for both one-to-one chat and multi-user
> chat?

Many questions can actually be answered by the spec, e.g. this what
section 2.1.2.4 in the 0.9.1 version says:

"
Most integration architectures do not need this level of
sophistication. Like the amateur photographer, a
majority of AMQP users need a "point and shoot" mode. AMQP provides
this through the use of two
simplifying concepts:

- a default exchange for message producers;
- a default binding for message queues that selects messages based on
a match between routing key and
    message queue name.

In effect, the default binding lets a producer send messages directly
to a message queue, given suitable
authority ? it emulates the simplest ?send to destination? addressing
scheme people have come to expect of
traditional middleware.
The default binding does not prevent the message queue from being used
in more sophisticated ways. It
does, however, let one use AMQP without needing to understand how
exchanges and bindings work.
"

> 2.Is there any user/message limit on each exchange?

Not really. But what is you specific concern about this?

To be honest, I can't see any requirement that you have that would not
be best served by a dedicated chat server - for example a proper XMPP
implementation. It seems to me that AMQP/Rabbit *may* not be the best
choice of software for your actual requirements. Why don't you look at
something like ejabberd, enumerate the requirements that you have that
can't be fulfilled it and then consider augmenting it with Rabbit to
mop up the unsatisfied requirements?

BTW please do keep messages on list - it is unfair to the community to
go into private mode and it also means that nobody else can answer
your question - making the Rabbit team unable to load balance the
handling of questions.

HTH,

Ben



From josh at gebaschtel.ch  Tue Sep  1 11:15:27 2009
From: josh at gebaschtel.ch (Josh Geisser)
Date: Tue, 1 Sep 2009 12:15:27 +0200
Subject: [rabbitmq-discuss] beginners question about RabbitMQ over HTTP
In-Reply-To: <29598b610908311348v8e2847bs8947af4d43a895a9@mail.gmail.com>
Message-ID: <9C37154E143FE14CBA656B2D2232745F0327EEBB6782@popeye.gebaschtel.bnet>

Hi Paul

Yes, this explains quite a few things. Using the native TCP would be anyway better than encapsulated in HTTP where you loose the ability to have Synchronous transmissions, etc.

Your suggestion with stunnel / abusing the https-'hole' would work with most proxies quite well, unless you got a proxy with 'deep inspection'. (normal proxy just 'bridge' the https session, deep inspection actually decrypts the session, validates content and re-package the traffic again. Means that the nice little use-putty-with-proxy-against-443-ssh does not work with such proxies.)

I'd rather had an open tcp port, but explaining this to the network/security guy's will result in a big fuzz and discussions and meetings and so on and since it's not business critical I'll never get through with this request (sorry, I'm damaged by big companies :))

What I want to check out after my holidays would be http://www.nocrew.org/software/httptunnel.html which promises (to me) exactly what I'm looking for...

Cheers
Josh

________________________________
Von: Paul Jones [mailto:pauljones23 at gmail.com]
Gesendet: Montag, 31. August 2009 22:48
An: Josh Geisser
Cc: rabbitmq-discuss at lists.rabbitmq.com
Betreff: Re: [rabbitmq-discuss] beginners question about RabbitMQ over HTTP

Josh,

At this stage, none of the standard clients actually support connecting to Rabbit via HTTP. The rabbitmq-mochiweb plugin simply provides an embedded HTTP server within the broker - it doesn't actually provide any HTTP services for the client to connect to.

The rabbitmq-jsonrpc plugin does actually provide a JSON-RPC endpoint for the broker - however, the only client provided for this is a Javascript based client (though this in no way means that a non-javascript client wouldn't be possible).

RabbitHub (http://github.com/tonyg/rabbithub/tree/master) provides another HTTP-style endpoint for Rabbit - in this case, via a Restful API. Once again, however, there is no official client for this.

The documentation is being updated for the various rabbitmq-* plugins as part of the 1.7 release, so hopefully the distinction between the various functions will become clearer at that point.

On your original point however, is it actually not possible to get the RabbitMQ port opened through your firewall? Or alternatively, would you be able to use something like stunnel to sneak the traffic through looking like HTTPS? (this would certainly require experimentation, as I'm not entirely sure this would all work from a protocol perspective - I suspect it would all depend on the strength of the firewall/proxy)

Hopefully this helps clear up some of your questions.

Paul.
On Sun, Aug 30, 2009 at 2:03 PM, Josh Geisser <josh at gebaschtel.ch<mailto:josh at gebaschtel.ch>> wrote:
Hi all

My goal is to connect my consumers and providers over http to the RabbitMQ (fw/proxy between clients and queue), and after a few hours of googeling I'm more confused than before.

I was kind of able to get the rabbitmq-mochiweb running, but didn't find any examples how to use/verify it with amqplib/python

Can someone pinpoint me whether this is already possible, and how to start?

Cheers & thanks
Josh


_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com<mailto:rabbitmq-discuss at lists.rabbitmq.com>
http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090901/5a3e658c/attachment.htm 

From tonyg at lshift.net  Tue Sep  1 11:44:44 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Tue, 01 Sep 2009 11:44:44 +0100
Subject: [rabbitmq-discuss] Clustering Issue
In-Reply-To: <7CA37CF4B3E0664983CF2BD8A97495F9025B0182@GLNEXM01.YELLOWPAGES.LOCAL>
References: <7CA37CF4B3E0664983CF2BD8A97495F9025B0165@GLNEXM01.YELLOWPAGES.LOCAL>	<4A98517C.5030402@lshift.net>
	<7CA37CF4B3E0664983CF2BD8A97495F9025B0182@GLNEXM01.YELLOWPAGES.LOCAL>
Message-ID: <4A9CFB1C.2030709@lshift.net>

Hi Jorge,

Jorge Varona wrote:
> do you have any recommendations on how I could
> provide a higher durability and fault-tolerance guarantees to my
> consumers?

There are a couple of approaches you could use, depending on your exact
requirements and the level of complexity you're willing to cope with.
The two main classes of solution are

 - run a shared filesystem underneath rabbit, with a hot standby if
   one server should fail. This separates data availability from
   service availability, and reduces the "no service" window to the
   failover interval.

 - run two servers and route *all* traffic through *both*, deduping
   at the receiving client. This gives as many nines of uptime as you
   want, at a cost in administrative complexity and bandwidth wastage

We've been talking about this stuff to various people recently so have
some illustrations of what we mean that might be useful: see
http://dev.lshift.net/tonyg/rabbitmq-intro-ha.pdf. [1]

Regards,
  Tony


[1]: A slightly earlier slide deck has a little bit more explanation
attached, and carries similar content otherwise:
http://dev.lshift.net/tonyg/Achieving%20Scale%20with%20Messaging%20and%20the%20Cloud%2020090709%20(with%20notes).pdf

-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From tonyg at lshift.net  Tue Sep  1 12:10:08 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Tue, 01 Sep 2009 12:10:08 +0100
Subject: [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs
 -	"Only one usage of each socket address (protocol/network	address/port) is
 normally permitted"
In-Reply-To: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>
References: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>
Message-ID: <4A9D0110.2070708@lshift.net>

Patrick Kenney wrote:
> seemed to closely resemble the condition, as I am sending 4000 copies of
> the same message to the following method...

Your operating system is probably running out of sockets. Try holding a
single connection open and reusing it for all the deliveries, rather
than opening a connection for each delivery. Connections are relatively
heavyweight compared to calls to BasicPublish.

> I am thinking I am hitting some kind of configurable threshold in the
> RabbitMQ Client  and or RabbitMQ ServiceModel... but have been unable
> thus far to pin it down...

It is more likely to be an operating system (or TCP, depending on how
you look at it) limitation. Neither the C# client, the WCF binding, nor
the RabbitMQ server have any preconfigured limitations of this kind.

> Another interesting thing is that this exact code works unchanged on a
> much older, slower Pentium IV 2ghz, 2gig ram on windows xp pro vs.
> windows server 2003 enterprise  sp2... quad core xeon, 4gig, etc...

If it is socket exhaustion you're seeing, one possible explanation for
the slower machine working better is that it gives the TCP timeouts
longer to run, so sockets are getting recycled "faster" from the
point-of-view of the slower socket-requiring code.

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From tonyg at lshift.net  Tue Sep  1 12:19:11 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Tue, 01 Sep 2009 12:19:11 +0100
Subject: [rabbitmq-discuss] of queues, memory and heartbeats...
In-Reply-To: <1bf8be120909010036lf5ad8e5r97801898214397@mail.gmail.com>
References: <1bf8be120909010036lf5ad8e5r97801898214397@mail.gmail.com>
Message-ID: <4A9D032F.9070305@lshift.net>

Hi Anthony,

Anthony wrote:
>    1. Even though we haven't explicitly enabled it, if we do start to
>       see channel_flow messages, this would be the memory based
>       throttling, correct?

That's right. Individual client libraries need to be altered to cope
with unsolicited "channel.flow" messages.

>    2. Besides rabbit noticing when a TCP connection dies - is there any
>       "heartbeat" functionality built into rabbit and/or the AMQP spec
>       that would actually test whether or not a connection is active,

Yes, there's a heartbeat parameter negotiated as part of the
"connection.tune"/"connection.tune-ok" sequence at connection startup.
It's pretty loosely defined, but basically if there's no activity for N
seconds, a peer may decide the connection has collapsed and may close
the socket.

>       and if it isn't, kill the relevant queues?

This is independently controllable: if the queues were marked exclusive
when declared (see the spec's documentation around "queue.declare"),
then when the connection goes, so will the queues. Autodelete works
similarly, but at consumer granularity rather than connection granularity.

> Do I as the person who
>       monitors the server configure this, or do the programmers who
>       write our clients need to incorporate something into their code?

Interesting question. The server at the moment does not have a mechanism
for suggesting the use of a heartbeat to its clients: it is up to
clients to configure the heartbeats they feel they need. This could be
changed, a little, so that the server could suggest a value, but the
clients would still be free to override the server's suggestion.

Negotiation in AMQP is a bit screwed up, to be honest: most of the
protocol is great, but negotiation is a bit weak. TELNET has the right
idea here!

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From mchruszcz at gmail.com  Tue Sep  1 13:32:39 2009
From: mchruszcz at gmail.com (Michal Chruszcz)
Date: Tue, 1 Sep 2009 14:32:39 +0200
Subject: [rabbitmq-discuss] Priorities support in RabbitMQ
In-Reply-To: <4A9BBFEF.5050809@googlemail.com>
References: <A338BFF3-508E-460F-8558-7A0FCFECFFAC@gmail.com>	<20090828154804.GA22219@mrnibble.lshift.net>	<D84D84FB-2D98-4FBE-853B-DB1D722D9D68@gmail.com>	<4A9B8ED7.5000007@lshift.net>
	<85E27B09-0AE2-4D0F-9558-9CF4D97E763E@gmail.com>
	<4A9BBFEF.5050809@googlemail.com>
Message-ID: <85D366F8-C714-4773-B725-C08179BBF22A@gmail.com>

On Aug 31, 2009, at 2:19 PM, Holger Hoffst?tte wrote:

> Michal Chruszcz wrote:
>> control order of message processing. Say I have distributed
>> asynchronous data processing service, which uses RabbitMQ for  
>> queueing
>> tasks, and would like to prioritize them depending on  data volume
>> (tiny packages are processed first). Priorities seemed to be perfect
>> solution, but unfortunately later I realized it's not supported yet.
>
> It is a common misconception that priorities alone can be used to do  
> this
> "properly" - it will only work well if you are accidentally lucky with
> your ingress patterns or really don't care about a total lack of
> predictable processing latency for larger messages. Since Rabbit  
> does not
> page to disk yet, preferring small messages might even make it run  
> out of
> memory *sooner* as more and more large messages are held back.

In general you're absolutely right, but this does not apply to my  
case, since messages themselves don't contain the data to be  
processed. In fact they are only "pointers" to the data, whose size is  
constant, thus postponing processing of messages pointing to larger  
amounts of data doesn't increase memory usage. In contrary it could  
even lower it, since total throughput would increase.

> Do not
> underestimate the effectiveness of randomized workloads. :)

I am not. However a well thought out deterministic algorithm usually  
is more effective. :-)

> Explicitly moding this with multiple queues and multiple consumers  
> is much
> more likely to result in better (both predictable and controllable)
> scalability and a well-balanced throughput for both small and large
> messages. Spin up multiple consumers for small messages (keeping those
> cores busy and even hopefully reducing per-message latency), have one
> low-priority consumer chew on larger tasks in the background or even  
> on
> another machine. It also gives you the option of having different
> durability/persistence options for different priorities.


Again, this is a good idea in general, but a little bit awkward in my  
situation. I'm using celery (http://celeryproject.org/) as consumers,  
whose role is performing background computation, and the idea behind  
it is automatic distribution of tasks between nodes. While it is  
probably possible to define custom routing of tasks it's against the  
architecture.

Best regards,
Michal Chruszcz
mchruszcz at gmail.com
mobile: +48 607 620 771
phone: +48 22 849 30 26




From pekenney at gmail.com  Tue Sep  1 15:11:30 2009
From: pekenney at gmail.com (Patrick Kenney)
Date: Tue, 1 Sep 2009 07:11:30 -0700
Subject: [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs
	- "Only one usage of each socket address (protocol/network
	address/port) is normally permitted"
In-Reply-To: <4A9D0110.2070708@lshift.net>
References: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>
	<4A9D0110.2070708@lshift.net>
Message-ID: <3a5f03340909010711y74953c8avb8e5dee0834b75b@mail.gmail.com>

am I not already already using the same socket?

        public void PublishMessage(string pstrExchangeName, string
pstrReturnKey, string pstrXml)
        {
            try
            {
                using (IConnection conn = new
ConnectionFactory().CreateConnection("localhost:5672"))
                {
                    using (IModel ch = conn.CreateModel())
                    {
                        IBasicProperties props = ch.CreateBasicProperties();
                        IStreamMessageBuilder b = new
StreamMessageBuilder(ch);

                        byte[] bytes = Encoding.UTF8.GetBytes(pstrXml);
                        b.WriteBytes(bytes);
                        ch.BasicPublish(pstrExchangeName, pstrReturnKey,
null, bytes);
                    }
                }
            }

            catch (Exception ex)
            {
                throw ex;
            }
        }

and from: http://www.rabbitmq.com/faq.html
<snip>
Q. How fast is RabbitMQ in persistent mode?

A. From our testing, we expect easily-achievable throughputs of 4000
persistent, non-transacted one-kilobyte messages per second (Intel Pentium
D, 2.8GHz, dual core, gigabit ethernet) from a single RabbitMQ broker node
writing to a single spindle.
</snip>

I am not even remotely seeing this kind of performance on better then twice
the hardware...

am i missing something ?

thanks in advance.

re:
On Tue, Sep 1, 2009 at 4:10 AM, Tony Garnock-Jones <tonyg at lshift.net> wrote:

> Patrick Kenney wrote:
> > seemed to closely resemble the condition, as I am sending 4000 copies of
> > the same message to the following method...
>
> Your operating system is probably running out of sockets. Try holding a
> single connection open and reusing it for all the deliveries, rather
> than opening a connection for each delivery. Connections are relatively
> heavyweight compared to calls to BasicPublish.
>
> > I am thinking I am hitting some kind of configurable threshold in the
> > RabbitMQ Client  and or RabbitMQ ServiceModel... but have been unable
> > thus far to pin it down...
>
> It is more likely to be an operating system (or TCP, depending on how
> you look at it) limitation. Neither the C# client, the WCF binding, nor
> the RabbitMQ server have any preconfigured limitations of this kind.
>
> > Another interesting thing is that this exact code works unchanged on a
> > much older, slower Pentium IV 2ghz, 2gig ram on windows xp pro vs.
> > windows server 2003 enterprise  sp2... quad core xeon, 4gig, etc...
>
> If it is socket exhaustion you're seeing, one possible explanation for
> the slower machine working better is that it gives the TCP timeouts
> longer to run, so sockets are getting recycled "faster" from the
> point-of-view of the slower socket-requiring code.
>
> Regards,
>  Tony
> --
>  [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
>   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
>  []  [] http://www.lshift.net/ | Email: tonyg at lshift.net
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090901/3f6a49a5/attachment.htm 

From tonyg at lshift.net  Tue Sep  1 15:43:07 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Tue, 01 Sep 2009 15:43:07 +0100
Subject: [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs
 - "Only one usage of each socket address (protocol/network address/port) is
 normally permitted"
In-Reply-To: <3a5f03340909010711y74953c8avb8e5dee0834b75b@mail.gmail.com>
References: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>	
	<4A9D0110.2070708@lshift.net>
	<3a5f03340909010711y74953c8avb8e5dee0834b75b@mail.gmail.com>
Message-ID: <4A9D32FB.7090607@lshift.net>

Patrick Kenney wrote:
> am I not already already using the same socket?

You are not reusing the same socket. Every time you make the following call:

> new ConnectionFactory().CreateConnection("localhost:5672")

... you create a new connection factory, and then a new connection,
which involves creating and connecting a socket, and performing login
and connection parameter negotiation.

Every TCP socket you create, even once it is closed, stays allocated on
the system for about two minutes. This is a characteristic of TCP, and
happens on all operating systems and on all TCP-using applications. If
you have more than a few thousand (at most, tens of thousands) sockets
so registered, your local TCP stack will complain that no more sockets
are available -- just as you reported.

Also, every time you make the following call:

> conn.CreateModel()

... you create a new channel, which involves allocation of stateful
resources on both the server and client side.

We recommend that you

 - create a single connection (CreateConnection(...)) that you use
   for a long time, and

 - create a single channel/model (CreateModel()) that you use for a long
   time, one channel/model per thread (if you're using threads).

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From sconover at gmail.com  Tue Sep  1 17:27:00 2009
From: sconover at gmail.com (Steve Conover)
Date: Tue, 1 Sep 2009 09:27:00 -0700
Subject: [rabbitmq-discuss] rabbitmq nodename/hostname -s problem
Message-ID: <d9743bb40909010927s624bb6fi78998d6e7164a182@mail.gmail.com>

Hi,

We're using 1.6.0 and trying to set up a cluster.  We've found that
rabbitmq refuses to parse the cluster config file when there's a dash
in the hostname - that is, the suffix of the node name, e.g.
[rabbit at foo-bar].  We'd rather not go around changing our
hostnames...is it possible to escape or quote this to get around the
problem (we've tried many possibilities and haven't succeeded getting
the name to parse correctly)?

Also, could we somehow specify an ip address instead?

Regards,
Steve



From jvarona at attinteractive.com  Tue Sep  1 18:41:10 2009
From: jvarona at attinteractive.com (Jorge Varona)
Date: Tue, 1 Sep 2009 10:41:10 -0700
Subject: [rabbitmq-discuss] Clustering Issue
In-Reply-To: <4A9CFB1C.2030709@lshift.net>
References: <7CA37CF4B3E0664983CF2BD8A97495F9025B0165@GLNEXM01.YELLOWPAGES.LOCAL>	<4A98517C.5030402@lshift.net>
	<7CA37CF4B3E0664983CF2BD8A97495F9025B0182@GLNEXM01.YELLOWPAGES.LOCAL>
	<4A9CFB1C.2030709@lshift.net>
Message-ID: <7CA37CF4B3E0664983CF2BD8A97495F9025B0426@GLNEXM01.YELLOWPAGES.LOCAL>

Tony,

Thanks for responding. I'm not sure we're at a point where either of
these scenarios would be appealing. The first one requires additional
hardware and cost and I agree the second one just seems unnecessarily
redundant, not to mention the burden of clients ensuring uniqueness of a
message, probably using some DHT, again more hardware and cost.

We're fortunate in that our current load requirements are such that we
can experiment a bit with several client-based consensus approaches to
mitigate down servers and provide near real-time failover. My real hope
was that RabbitMQ could provide server-side failover functionality or
some kind of loud, broadcasted failure, which clients could detect to
perform their own fail-over (reconnection, declare exchanges/queues,
etc.). This may fall outside the scope of AMQP but I think it could be
beneficial to your user base. 

For now I think we'll bake our failover into our client implementation.
Thanks again for taking the time to respond.

Jorge



-----Original Message-----
From: Tony Garnock-Jones [mailto:tonyg at lshift.net] 
Sent: Tuesday, September 01, 2009 3:45 AM
To: Jorge Varona
Cc: Matthias Radestock; rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Clustering Issue

Hi Jorge,

Jorge Varona wrote:
> do you have any recommendations on how I could
> provide a higher durability and fault-tolerance guarantees to my
> consumers?

There are a couple of approaches you could use, depending on your exact
requirements and the level of complexity you're willing to cope with.
The two main classes of solution are

 - run a shared filesystem underneath rabbit, with a hot standby if
   one server should fail. This separates data availability from
   service availability, and reduces the "no service" window to the
   failover interval.

 - run two servers and route *all* traffic through *both*, deduping
   at the receiving client. This gives as many nines of uptime as you
   want, at a cost in administrative complexity and bandwidth wastage

We've been talking about this stuff to various people recently so have
some illustrations of what we mean that might be useful: see
http://dev.lshift.net/tonyg/rabbitmq-intro-ha.pdf. [1]

Regards,
  Tony


[1]: A slightly earlier slide deck has a little bit more explanation
attached, and carries similar content otherwise:
http://dev.lshift.net/tonyg/Achieving%20Scale%20with%20Messaging%20and%2
0the%20Cloud%2020090709%20(with%20notes).pdf

-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From cremes.devlist at mac.com  Tue Sep  1 19:19:02 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Tue, 01 Sep 2009 13:19:02 -0500
Subject: [rabbitmq-discuss] list_connections output
Message-ID: <57A7F685-8234-45E7-BFD0-21B52DBAA17F@mac.com>

What does it mean when the user column in the "list_connections"  
output is 'none'?

cremes$ ./rabbitmqctl list_connections
Listing connections ...
none	10.10.48.86	59828
guest	10.10.48.86	59808
...done.


I have a client connecting to rabbit but for some reason it is getting  
assigned the name 'none' upon connection. It should be 'guest' like  
the other connection listed.

The 'none' connection times out after exactly 10 seconds and then  
disappears. Is that timeout inside rabbit? What triggers it?

cr




From cremes.devlist at mac.com  Tue Sep  1 22:08:54 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Tue, 01 Sep 2009 16:08:54 -0500
Subject: [rabbitmq-discuss] list_connections output
In-Reply-To: <57A7F685-8234-45E7-BFD0-21B52DBAA17F@mac.com>
References: <57A7F685-8234-45E7-BFD0-21B52DBAA17F@mac.com>
Message-ID: <155FADA4-0A4F-4E23-B7DF-B17D8660F8A5@mac.com>


On Sep 1, 2009, at 1:19 PM, Chuck Remes wrote:

> What does it mean when the user column in the "list_connections"
> output is 'none'?
>
> cremes$ ./rabbitmqctl list_connections
> Listing connections ...
> none	10.10.48.86	59828
> guest	10.10.48.86	59808
> ...done.
>
>
> I have a client connecting to rabbit but for some reason it is getting
> assigned the name 'none' upon connection. It should be 'guest' like
> the other connection listed.
>
> The 'none' connection times out after exactly 10 seconds and then
> disappears. Is that timeout inside rabbit? What triggers it?

I didn't discover the specific answer to my question above but I did  
figure out my problem. I was doing some work in ruby using the amqp  
library. I had accidently embedded a call to AMQP.start inside an  
existing call to EM.run. The outer EM.run was superfluous so I removed  
it and all is well. The list_connections command started returning the  
second connection as 'guest' after my code fix.

cr




From ram.muthiah at yahoo.com  Tue Sep  1 22:20:21 2009
From: ram.muthiah at yahoo.com (Ram Muthiah)
Date: Tue, 1 Sep 2009 14:20:21 -0700 (PDT)
Subject: [rabbitmq-discuss] building chat
In-Reply-To: <269388e30909010256q2d52bd05r25ddf28754b2eb6c@mail.gmail.com>
References: <860157.29474.qm@web44702.mail.sp1.yahoo.com>
	<167204d20908260036v7bf73a3ei8051c0354eec6cf5@mail.gmail.com>
	<619996.73011.qm@web44714.mail.sp1.yahoo.com>
	<269388e30908270522n62ee3dbdo498b9a46f383fb64@mail.gmail.com>
	<64312.10265.qm@web44715.mail.sp1.yahoo.com>
	<269388e30909010256q2d52bd05r25ddf28754b2eb6c@mail.gmail.com>
Message-ID: <620483.77320.qm@web44715.mail.sp1.yahoo.com>

Hi Ben,

Thank you for the answers. 

I don't mind posting to the list! No one answered my questions I posted in the list. Instead of repeating the same post in the list (what's the point in it?), I sent a request to you to answer the questions. That's all. 

Regarding XMPP, ejabberd, etc., -- yes, you are right. Any XMPP server implementation would take care of my requirements. However, AMQP was recommended to me because it was much faster and reliable than just XMPP. (I am not sure how much truth in it, but that's what I heard). 

We ran couple of tests using RabbitMQ for both multi-user chat and one-to-one chat. It works well. 

Regards
Ram




________________________________
From: Ben Hood <0x6e6562 at gmail.com>
To: Ram Muthiah <ram.muthiah at yahoo.com>
Cc: rabbitmq <rabbitmq-discuss at lists.rabbitmq.com>
Sent: Tuesday, September 1, 2009 2:56:47 AM
Subject: Re: [rabbitmq-discuss] building chat

Ram,

On Mon, Aug 31, 2009 at 11:10 PM, Ram Muthiah<ram.muthiah at yahoo.com> wrote:
> I replied to your email last week and copied the list address also. I am not
> copying the list for this email because I am resending the same questions
> again.
>
> 1. Can I use this default exchange for both one-to-one chat and multi-user
> chat?

Many questions can actually be answered by the spec, e.g. this what
section 2.1.2.4 in the 0.9.1 version says:

"
Most integration architectures do not need this level of
sophistication. Like the amateur photographer, a
majority of AMQP users need a "point and shoot" mode. AMQP provides
this through the use of two
simplifying concepts:

- a default exchange for message producers;
- a default binding for message queues that selects messages based on
a match between routing key and
    message queue name.

In effect, the default binding lets a producer send messages directly
to a message queue, given suitable
authority ? it emulates the simplest ?send to destination? addressing
scheme people have come to expect of
traditional middleware.
The default binding does not prevent the message queue from being used
in more sophisticated ways. It
does, however, let one use AMQP without needing to understand how
exchanges and bindings work.
"

> 2.Is there any user/message limit on each exchange?

Not really. But what is you specific concern about this?

To be honest, I can't see any requirement that you have that would not
be best served by a dedicated chat server - for example a proper XMPP
implementation. It seems to me that AMQP/Rabbit *may* not be the best
choice of software for your actual requirements. Why don't you look at
something like ejabberd, enumerate the requirements that you have that
can't be fulfilled it and then consider augmenting it with Rabbit to
mop up the unsatisfied requirements?

BTW please do keep messages on list - it is unfair to the community to
go into private mode and it also means that nobody else can answer
your question - making the Rabbit team unable to load balance the
handling of questions.

HTH,

Ben



      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090901/8d774bac/attachment.htm 

From sconover at gmail.com  Wed Sep  2 06:18:23 2009
From: sconover at gmail.com (Steve Conover)
Date: Tue, 1 Sep 2009 22:18:23 -0700
Subject: [rabbitmq-discuss] Error: mnesia_unexpectedly_running when
	attempting to cluster nodes
Message-ID: <d9743bb40909012218w4f5abbfcwefe6ca6105bd1d67@mail.gmail.com>

Hi,

I'm trying to build a simple cluster using rabbitmqctl:

rabbitmqctl -n rabbit1 at foo cluster rabbit2 at foo

but I get:

Clustering node rabbit1 at foo with [rabbit2 at foo] ...
Error: mnesia_unexpectedly_running

Any ideas on what this could be, or what I should do?

-Steve



From sh at defuze.org  Wed Sep  2 10:18:45 2009
From: sh at defuze.org (Sylvain Hellegouarch)
Date: Wed, 2 Sep 2009 11:18:45 +0200 (CEST)
Subject: [rabbitmq-discuss] Rabbit persister error on startup
Message-ID: <43517.193.253.216.132.1251883125.squirrel@mail1.webfaction.com>

Hi,

I''m getting the following error logged. This prevents Rabbit to start up.
I thought this might be of interest to the list.

=INFO REPORT==== 2-Sep-2009::09:07:41 ===
disk_log: repairing "/var/lib/rabbitmq/mnesia/rabbit/rabbit_persister.LOG"
...

=INFO REPORT==== 2-Sep-2009::09:07:41 ===
Repaired persister log - 0 recovered, 0 bad

=INFO REPORT==== 2-Sep-2009::09:07:41 ===
    application: rabbit
    exited: {bad_return,
                {{rabbit,start,[normal,[]]},
                 {'EXIT',
                     {{badmatch,
                          {error,
                              {{{badmatch,eof},
                                [{rabbit_persister,internal_load_snapshot,2},
                                 {rabbit_persister,init,1},
                                 {gen_server,init_it,6},
                                 {proc_lib,init_p,5}]},
                               {child,undefined,rabbit_persister,
                                   {rabbit_persister,start_link,[]},
                                   transient,100,worker,
                                   [rabbit_persister]}}}},
                      [{rabbit,start_child,1},
                       {rabbit,'-start/2-fun-4-',0},
                       {rabbit,'-start/2-fun-0-',1},
                       {lists,foreach,2},
                       {rabbit,start,2},
                       {application_master,start_it_old,4}]}}}}
    type: temporary

=INFO REPORT==== 2-Sep-2009::09:07:41 ===
    application: mnesia
    exited: stopped
    type: temporary

=INFO REPORT==== 2-Sep-2009::09:07:41 ===
    application: os_mon
    exited: stopped
    type: temporary

Note that deleting said file:
/var/lib/rabbitmq/mnesia/rabbit/rabbit_persister.LOG

Did fix the behavior.

- Sylvain

-- 
Sylvain Hellegouarch
http://www.defuze.org



From anthony-rabbitmq at hogan.id.au  Wed Sep  2 13:09:57 2009
From: anthony-rabbitmq at hogan.id.au (Anthony)
Date: Wed, 2 Sep 2009 22:09:57 +1000
Subject: [rabbitmq-discuss] of queues, memory and heartbeats...
In-Reply-To: <269388e30909010119r19b69f0ep3bbbbf79824bafed@mail.gmail.com>
References: <1bf8be120909010036lf5ad8e5r97801898214397@mail.gmail.com>
	<269388e30909010119r19b69f0ep3bbbbf79824bafed@mail.gmail.com>
Message-ID: <1bf8be120909020509y6be25628t4c03c5134ac883b3@mail.gmail.com>

Hi Ben,

The rabbit_memsup_linux module parses these values out of /proc/meminfo:
> 'MemTotal', 'MemFree', 'Buffers', 'Cached'
> such that
> MemUsed = MemTotal - MemFree - Buffers - Cached
>

Thanks for that..

Hacked up the following script for Nagios so I could keep an eye on memory
approaching threshold..

#!/bin/bash

STATE_OK=0
STATE_WARNING=1
STATE_CRITICAL=2
STATE_UNKNOWN=3
STATE_DEPENDENT=4

MEMTOTAL="`grep "^MemTotal: " /proc/meminfo |\
        awk '{print $2}'`"

MEMFREEEQN="`egrep "^(MemTotal|MemFree|Buffers|Cached):" /proc/meminfo |\
        awk '{print $1 " " $2}' |\
        sed -r 's/^MemTotal:/+/g
                s/^(MemFree|Buffers|Cached):/-/g'`"

MEMFREE="$(( ${MEMFREEEQN} ))"
MEMPCFREE="$(( ( ${MEMFREE} * 100 ) / ${MEMTOTAL} ))"

MEMPCFREECRIT=5
MEMPCFREEWARN=10

if [ ${MEMPCFREE} -gt ${MEMPCFREEWARN} ]; then
        echo "OK: ${MEMFREE} (${MEMPCFREE}%) > ${MEMPCFREEWARN}% free"
        exit $STATE_OK
elif [ ${MEMPCFREE} -gt ${MEMPCFREECRIT} ]; then
        echo "WARNING: ${MEMPCFREECRIT}% < ${MEMFREE} (${MEMPCFREE}%) <
${MEMPCFREEWARN}%"
        exit $STATE_WARNING
elif [ ${MEMPCFREE} -le ${MEMPCFREECRIT} ]; then
        echo "CRITICAL: ${MEMFREE} (${MEMPCFREE}%) <= ${MEMPCFREECRIT}%"
        exit $STATE_CRITICAL
fi

echo "UNKNOWN: Something went awry!"
exit $STATE_UNKNOWN

This'll let me go hunt down issues before they start causing throttle
problems. In the event others are interested, this is the quick check I use
to see if AMQP daemon is contactable in Nagios...

define command{
        command_name    check_amqp
        command_line    $USER1$/check_tcp -H $HOSTADDRESS$ -p 5672 -d 1 -E
-s 'AMQP\r\n\r\n\r\n' -e 'AMQP'
        }

(Wait 1 second, send "AMQP" followed by three EOL sequences and expect the
string "AMQP" returned)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090902/3fcc4750/attachment.htm 

From sconover at gmail.com  Wed Sep  2 15:59:06 2009
From: sconover at gmail.com (Steve Conover)
Date: Wed, 2 Sep 2009 07:59:06 -0700
Subject: [rabbitmq-discuss] Error: mnesia_unexpectedly_running when
	attempting to cluster nodes
In-Reply-To: <d9743bb40909012218w4f5abbfcwefe6ca6105bd1d67@mail.gmail.com>
References: <d9743bb40909012218w4f5abbfcwefe6ca6105bd1d67@mail.gmail.com>
Message-ID: <d9743bb40909020759h6d32b550s3b611aefe95c58e7@mail.gmail.com>

Please disregard, I hadn't stopped the rabbit app before doing this:

http://www.rabbitmq.com/clustering.html#creating

I'd still prefer to assemble the cluster via the cluster config file,
but the hostname parsing problem is blocking me...


On Tue, Sep 1, 2009 at 10:18 PM, Steve Conover<sconover at gmail.com> wrote:
> Hi,
>
> I'm trying to build a simple cluster using rabbitmqctl:
>
> rabbitmqctl -n rabbit1 at foo cluster rabbit2 at foo
>
> but I get:
>
> Clustering node rabbit1 at foo with [rabbit2 at foo] ...
> Error: mnesia_unexpectedly_running
>
> Any ideas on what this could be, or what I should do?
>
> -Steve
>



From pekenney at gmail.com  Wed Sep  2 20:24:37 2009
From: pekenney at gmail.com (Patrick Kenney)
Date: Wed, 2 Sep 2009 12:24:37 -0700
Subject: [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs
	- "Only one usage of each socket address (protocol/network
	address/port) is normally permitted"
In-Reply-To: <4A9D32FB.7090607@lshift.net>
References: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>
	<4A9D0110.2070708@lshift.net>
	<3a5f03340909010711y74953c8avb8e5dee0834b75b@mail.gmail.com>
	<4A9D32FB.7090607@lshift.net>
Message-ID: <3a5f03340909021224l48d26727k5967b0721f52fdb@mail.gmail.com>

k,

So i think you are agreeing with me that when I call ... new
ConnectionFactory().CreateConnection("localhost:5672")...

that I am using the same socket over and over again, but creating new
connections to it...

The following... "Error: RabbitMQ.Client.ConnectionFactory.cs - "Only one
usage of each socket address (protocol/network address/port) is normally
permitted"...

Is not a result of exhausting all available sockets on the system, its a
result of TCP being unable to dispose fast enough... so even though I have
already closed the socket explicitly the system has not disposed of it yet,
so it thinks I am trying to reuse the same socket... (This is confirmed
using the debugger & wireshark (packetsniffer)...

Additionally, this only occurs after thousands of consecutive calls to the
PublishMessage method i posted at the beginning of this thread...

So...

Taking your suggestion to make IModel and IConnection module level, my
threaded PublishMessage method now looks like the following...

public void PublishMessage(string pstrExchangeName, string pstrReturnKey,
string pstrXml)
        {
            try
            {
                if (null == m_Conn)
                {
                    m_Conn = new
ConnectionFactory().CreateConnection(m_strRabbitMqHost);
                }

                if (null == m_Channel)
                {
                    m_Channel = m_Conn.CreateModel();
                }

                IBasicProperties props = m_Channel.CreateBasicProperties();
                IStreamMessageBuilder b = new
StreamMessageBuilder(m_Channel);
                byte[] bytes = Encoding.UTF8.GetBytes(pstrXml);
                b.WriteBytes(bytes);
                m_Channel.BasicPublish(pstrExchangeName, pstrReturnKey,
null, bytes);
            }

          catch(Exception ex)
          {
                 throw ex;
          }

so the error is fixed, but... I still cannot even come close to the 4000
messages per second capability (with better then twice the hardware)
described at:
http://www.rabbitmq.com/faq.html

Q. How fast is RabbitMQ in persistent mode?

A. From our testing, we expect easily-achievable throughputs of 4000
persistent, non-transacted one-kilobyte messages per second (Intel Pentium
D, 2.8GHz, dual core, gigabit ethernet) from a single RabbitMQ broker node
writing to a single spindle.

so what kind of tcp configuration tweaks or otherwise did you guys have to
make to accomplish this?

I am getting about 10% of that advertised 4000 per second capability...

thanks in advance.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090902/e8122674/attachment.htm 

From tonyg at lshift.net  Wed Sep  2 22:55:08 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Wed, 02 Sep 2009 22:55:08 +0100
Subject: [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs
 - "Only one usage of each socket address (protocol/network address/port) is
 normally permitted"
In-Reply-To: <3a5f03340909021224l48d26727k5967b0721f52fdb@mail.gmail.com>
References: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>	
	<4A9D0110.2070708@lshift.net>	
	<3a5f03340909010711y74953c8avb8e5dee0834b75b@mail.gmail.com>	
	<4A9D32FB.7090607@lshift.net>
	<3a5f03340909021224l48d26727k5967b0721f52fdb@mail.gmail.com>
Message-ID: <4A9EE9BC.3000306@lshift.net>

Hi Patrick,

Patrick Kenney wrote:
> So i think you are agreeing with me that [...] I am using the same
> socket over and over again, but creating new connections to it...

No, I think you are creating fresh sockets (TCP connections) each time.
Both fresh instances of .NET's "Socket" class, and fresh TCP port number
allocations.

> "Only one usage of each socket address (protocol/network
> address/port) is normally permitted" Is not a result of exhausting
> all available sockets on the system, its a result of TCP being unable
> to dispose fast enough

Close enough, yes. The message is descriptive text associated with the
socket error code EADDRINUSE (WSAEADDRINUSE on Windows), which has a few
meanings, one of which relates to the inability of the system to
allocate a fresh transient port number.

> ... so even though I have already closed the socket explicitly the
> system has not disposed of it yet, so it thinks I am trying to reuse
> the same socket... (This is confirmed using the debugger & wireshark
> (packetsniffer)...

That's right.

> Taking your suggestion to make IModel and IConnection module level, my
> threaded PublishMessage method now looks like the following...

It looks much better. Avoiding needless connection reestablishment is
generally a good idea.

> so the error is fixed, but... I still cannot even come close to the 4000
> messages per second capability (with better then twice the hardware)
> described at:
> http://www.rabbitmq.com/faq.html

You mentioned earlier that your messages are 400 kilobytes each. If you
have a 100 megabit ethernet, you will saturate your network link at
around 25 of these per second. If, as you mentioned earlier, you are
sending 4000 copies of a 400kB message, then with a 100 megabit
ethernet, you will be unlikely to see the task complete in less than
two-and-a-half minutes.

Regards,
  Tony



From pekenney at gmail.com  Wed Sep  2 23:06:10 2009
From: pekenney at gmail.com (Patrick Kenney)
Date: Wed, 2 Sep 2009 15:06:10 -0700
Subject: [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs
	- "Only one usage of each socket address (protocol/network
	address/port) is normally permitted"
In-Reply-To: <4A9EE9BC.3000306@lshift.net>
References: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>
	<4A9D0110.2070708@lshift.net>
	<3a5f03340909010711y74953c8avb8e5dee0834b75b@mail.gmail.com>
	<4A9D32FB.7090607@lshift.net>
	<3a5f03340909021224l48d26727k5967b0721f52fdb@mail.gmail.com>
	<4A9EE9BC.3000306@lshift.net>
Message-ID: <3a5f03340909021506m32be05c0wef7f8b31a021cb00@mail.gmail.com>

I am now using a 1k message as described at the rmq faq...
and it is all local at this point and the nic is 1 gig...


...re:
>
> > so the error is fixed, but... I still cannot even come close to the 4000
> > messages per second capability (with better then twice the hardware)
> > described at:
> > http://www.rabbitmq.com/faq.html
>
> You mentioned earlier that your messages are 400 kilobytes each. If you
> have a 100 megabit ethernet, you will saturate your network link at
> around 25 of these per second. If, as you mentioned earlier, you are
> sending 4000 copies of a 400kB message, then with a 100 megabit
> ethernet, you will be unlikely to see the task complete in less than
> two-and-a-half minutes.
>
> Regards,
>   Tony
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090902/ca977bd3/attachment.htm 

From tonyg at lshift.net  Wed Sep  2 23:20:00 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Wed, 02 Sep 2009 23:20:00 +0100
Subject: [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs
 - "Only one usage of each socket address (protocol/network address/port) is
 normally permitted"
In-Reply-To: <3a5f03340909021506m32be05c0wef7f8b31a021cb00@mail.gmail.com>
References: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>	
	<4A9D0110.2070708@lshift.net>	
	<3a5f03340909010711y74953c8avb8e5dee0834b75b@mail.gmail.com>	
	<4A9D32FB.7090607@lshift.net>	
	<3a5f03340909021224l48d26727k5967b0721f52fdb@mail.gmail.com>	
	<4A9EE9BC.3000306@lshift.net>
	<3a5f03340909021506m32be05c0wef7f8b31a021cb00@mail.gmail.com>
Message-ID: <4A9EEF90.4020405@lshift.net>

Patrick Kenney wrote:
> I am now using a 1k message as described at the rmq faq...
> and it is all local at this point and the nic is 1 gig...

Try running the ProducerMain and ConsumerMain examples that ship with
the Java client library. Together, they form a very crude and simple
throughput test. The code is short and self-explanatory.

https://dev.rabbitmq.com/wiki/SimplePerformanceTests

Regards,
  Tony





From pekenney at gmail.com  Wed Sep  2 23:43:34 2009
From: pekenney at gmail.com (Patrick Kenney)
Date: Wed, 2 Sep 2009 15:43:34 -0700
Subject: [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs
	- "Only one usage of each socket address (protocol/network
	address/port) is normally permitted"
In-Reply-To: <4A9EEF90.4020405@lshift.net>
References: <3a5f03340908310940p78f0453dr87ed981fb787747f@mail.gmail.com>
	<4A9D0110.2070708@lshift.net>
	<3a5f03340909010711y74953c8avb8e5dee0834b75b@mail.gmail.com>
	<4A9D32FB.7090607@lshift.net>
	<3a5f03340909021224l48d26727k5967b0721f52fdb@mail.gmail.com>
	<4A9EE9BC.3000306@lshift.net>
	<3a5f03340909021506m32be05c0wef7f8b31a021cb00@mail.gmail.com>
	<4A9EEF90.4020405@lshift.net>
Message-ID: <3a5f03340909021543g48e6d1c7jda70c4652e6af842@mail.gmail.com>

thanks, will give it a go...

On Wed, Sep 2, 2009 at 3:20 PM, Tony Garnock-Jones <tonyg at lshift.net> wrote:

> Patrick Kenney wrote:
> > I am now using a 1k message as described at the rmq faq...
> > and it is all local at this point and the nic is 1 gig...
>
> Try running the ProducerMain and ConsumerMain examples that ship with
> the Java client library. Together, they form a very crude and simple
> throughput test. The code is short and self-explanatory.
>
> https://dev.rabbitmq.com/wiki/SimplePerformanceTests
>
> Regards,
>   Tony
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090902/bbd18a2c/attachment.htm 

From dking at ketralnis.com  Thu Sep  3 00:23:07 2009
From: dking at ketralnis.com (David King)
Date: Wed, 2 Sep 2009 16:23:07 -0700
Subject: [rabbitmq-discuss] 50k bindings to two queues?
Message-ID: <E23B36F1-262C-450A-897B-1D58DD24A114@ketralnis.com>

Is it practical to have an exchange with two queues and 50k bindings  
to those two queues?

That is, I have all of these categories, and I load-balance their  
processing over two nodes. So I want message.sports and message.bacon  
to go to the same node, and message.somethingelse to go to the other  
node. But I have 50k of those categories, and growing. While I may add  
more nodes, I'd do so *much* more slowly than new categories would be  
created

Is the binding-matching that efficient? Or am I better off having some  
intermediate process that does its own balancing?



From 0x6e6562 at gmail.com  Thu Sep  3 00:59:08 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 3 Sep 2009 00:59:08 +0100
Subject: [rabbitmq-discuss] 50k bindings to two queues?
In-Reply-To: <E23B36F1-262C-450A-897B-1D58DD24A114@ketralnis.com>
References: <E23B36F1-262C-450A-897B-1D58DD24A114@ketralnis.com>
Message-ID: <269388e30909021659vc0befc8k5cb3775fe5243e9b@mail.gmail.com>

David,

On Thu, Sep 3, 2009 at 12:23 AM, David King<dking at ketralnis.com> wrote:
> Is it practical to have an exchange with two queues and 50k bindings
> to those two queues?

Bindings to direct exchanges are indexed such that the runtime should
be roughly logarithmic. Topic and header exchanges incur a linear
scan. Fanout exchanges can be quick because they route
unconditionally.

> That is, I have all of these categories, and I load-balance their
> processing over two nodes. So I want message.sports and message.bacon
> to go to the same node, and message.somethingelse to go to the other
> node. But I have 50k of those categories, and growing. While I may add
> more nodes, I'd do so *much* more slowly than new categories would be
> created

Load balancing in Rabbit pertains to queues and not exchanges, since
exchanges do not run as a separate process. I don't know whether this
affects your layout.

> Is the binding-matching that efficient? Or am I better off having some
> intermediate process that does its own balancing?

ATM the best you can do is to consume and republish with an embedded
consumer if you can implement a match algorithm that is tuned to your
actual scenario. Going forwards, it would be nice to be able to plug
this in (under the assumption that you have a good matcher).

BTW have you done any load testing with your current setup yet?

HTH,

Ben



From kapouer at melix.org  Thu Sep  3 10:50:23 2009
From: kapouer at melix.org (=?ISO-8859-15?Q?J=E9r=E9my_Lal?=)
Date: Thu, 03 Sep 2009 11:50:23 +0200
Subject: [rabbitmq-discuss] is it possible to receive old messages on
	subscribe ?
Message-ID: <4A9F915F.3020100@melix.org>

Hi,
i'm using rabbitmq STOMP gateway, with clients subscribing with these params :
exchange:'amq.topic'
routing_key:/topic/home
id: <a_unique_id>

so that all subscribed clients receive every message sent to amq.topic, /topic/home.

Now for some queue, i'd like to make every new subscriber receive all messages
previously sent to the queue (by some privileged user).

Is there a way to do this ? if yes, where do i need to look at ?
i tried reading the AMQP spec, and did not understand it well enough to find
an answer...

Regards,
J?r?my Lal





From 0x6e6562 at gmail.com  Thu Sep  3 12:03:17 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 3 Sep 2009 12:03:17 +0100
Subject: [rabbitmq-discuss] is it possible to receive old messages on
	subscribe ?
In-Reply-To: <4A9F915F.3020100@melix.org>
References: <4A9F915F.3020100@melix.org>
Message-ID: <269388e30909030403l28db607fhee9e8c553ec91913@mail.gmail.com>

J?r?my,

On Thu, Sep 3, 2009 at 10:50 AM, J?r?my Lal<kapouer at melix.org> wrote:
> Now for some queue, i'd like to make every new subscriber receive all messages
> previously sent to the queue (by some privileged user).
>
> Is there a way to do this ? if yes, where do i need to look at ?
> i tried reading the AMQP spec, and did not understand it well enough to find
> an answer...

I think the only clean way to do this on a pure AMQP level is to have
create and bind queues for consumers that don't yet exist - so that
they will get a *full* queue when they subscribe - they will consume
all of the previously sent messages first and then continue with the
stuff that trickles in afterwards. Since queue paging is only landing
in the next Rabbit release, this *could* cost you a lot of memory with
the current version. Also, you would have to know about all new
consumers ahead of time.

Conceptually, I think you need to ask yourself whether you are turning
your messaging system into a database. If you are, then maybe it's not
such a good idea to implement a database in Rabbit.

Having said this, this is a reasonably common pattern - to implement
this, some people have set up routing rules to archive each message in
addition to normal consumers subscribing to queues - this routing is
the value-add of AMQP. Then in their application they implement the
subscription logic as follows:

- Create and bind a queue to the to real time exchange, but don't
subscribe yet, just let messages queue up;
- Send a request to the archive to replay archived messages;
- Process the archived messages;
- Subscribe to the queue you bound in step one and handle the initial
duplicates;
- Continue consuming the trickle feed as normal;

There are a few improvements some people have made to this kind of thing:

- Implement monotonically increasing ids for your messages so that you
can replay from an arbitrary point;
- Consider a non-AMQP bulk transfer mechanism for recovering old
messages , e.g. HTTP - this can be useful if your consumers
potentially have to recover a vast amount of old data;

HTH,

Ben



From alexis.richardson at gmail.com  Thu Sep  3 21:51:15 2009
From: alexis.richardson at gmail.com (Alexis Richardson)
Date: Thu, 3 Sep 2009 13:51:15 -0700
Subject: [rabbitmq-discuss] possible meet-up in SF next week?
Message-ID: <167204d20909031351p5d9e2dbbs55d8b5fec57995fd@mail.gmail.com>

Hi all,

Apologies for the cross post.

I'm going to be in SF late next week and would love to schedule a
Pubsub meet-up with anyone interested in Pubsub of any kind:
PubSubHubBub, XEP-60, AMQP and RabbitMQ.

My ideal time would be Friday Sep 11th, after 4pm, over a beer.  But,
I could do Thursday from c.7:30pm if Fridays are bad for people.  [ Or
possibly even Wednesday ]

If you are interested please contact me off-list to avoid cluttering
inboxes further.  I'll post a plan once it's clear.

Cheers,

alexis



From matthias at lshift.net  Thu Sep  3 23:24:25 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 03 Sep 2009 23:24:25 +0100
Subject: [rabbitmq-discuss] rabbitmq nodename/hostname -s problem
In-Reply-To: <d9743bb40909010927s624bb6fi78998d6e7164a182@mail.gmail.com>
References: <d9743bb40909010927s624bb6fi78998d6e7164a182@mail.gmail.com>
Message-ID: <4AA04219.4000501@lshift.net>

Steve,

Steve Conover wrote:

> We've found that rabbitmq refuses to parse the cluster config file
> when there's a dash in the hostname - that is, the suffix of the node
> name, e.g. [rabbit at foo-bar].  We'd rather not go around changing our 
> hostnames...is it possible to escape or quote this to get around the 
> problem (we've tried many possibilities and haven't succeeded getting
>  the name to parse correctly)?

Try ['rabbit at foo-bar'].

> Also, could we somehow specify an ip address instead?

afaik that won't work.


Matthias.



From matthias at lshift.net  Thu Sep  3 23:32:17 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 03 Sep 2009 23:32:17 +0100
Subject: [rabbitmq-discuss] list_connections output
In-Reply-To: <57A7F685-8234-45E7-BFD0-21B52DBAA17F@mac.com>
References: <57A7F685-8234-45E7-BFD0-21B52DBAA17F@mac.com>
Message-ID: <4AA043F1.600@lshift.net>

Chuck,

Chuck Remes wrote:
> What does it mean when the user column in the "list_connections"  
> output is 'none'?
> 
> cremes$ ./rabbitmqctl list_connections
> Listing connections ...
> none	10.10.48.86	59828
> guest	10.10.48.86	59808
> ...done.
> 
> 
> I have a client connecting to rabbit but for some reason it is getting  
> assigned the name 'none' upon connection. It should be 'guest' like  
> the other connection listed.
> 
> The 'none' connection times out after exactly 10 seconds and then  
> disappears. Is that timeout inside rabbit? What triggers it?

'none' is shown when a client has connected but hasn't sent their 
credentials yet. If that (plus all other connection setup steps) aren't 
completed within ten seconds then the server closes the connection.


Matthias.



From allen.fowler at yahoo.com  Thu Sep  3 23:41:04 2009
From: allen.fowler at yahoo.com (Allen Fowler)
Date: Thu, 3 Sep 2009 15:41:04 -0700 (PDT)
Subject: [rabbitmq-discuss] Recommended python library for simple use?
Message-ID: <252719.54262.qm@web45613.mail.sp1.yahoo.com>

Hello,

I am starting to build an application using Queue fifo object in python's "multiprocessing" module to distribute task units to worker processes.

Since I would like to eventually bring in some other components written in .net, I am thinking of trying to use RabbitMQ instead.

I have two questions:

1) Is it hard to set up RabbitMQ for single machine use?  

2) I see there are a few AMQP projects for python.  What should I use?


Notes on my app:

Each task unit is less than 1kb and I don't intend for the queue to be allowed to grow than ~200 task units long.  At that point, I have the task producer set to pause and wait until the queue goes down.

I do want to be able to flag certain tasks as "dependant", so that a certain task must be marked "done" before it's dependent can can run.


Thank you,
:)


      



From 0x6e6562 at gmail.com  Fri Sep  4 00:02:27 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 4 Sep 2009 00:02:27 +0100
Subject: [rabbitmq-discuss] Recommended python library for simple use?
In-Reply-To: <252719.54262.qm@web45613.mail.sp1.yahoo.com>
References: <252719.54262.qm@web45613.mail.sp1.yahoo.com>
Message-ID: <269388e30909031602j104593a1r17b27b05af32484c@mail.gmail.com>

Allen,

On Thu, Sep 3, 2009 at 11:41 PM, Allen Fowler<allen.fowler at yahoo.com> wrote:
> 1) Is it hard to set up RabbitMQ for single machine use?

I wouldn't have thought so. There are packages for a variety of
penguins as well as windows. It's quite a straightforward process.

> 2) I see there are a few AMQP projects for python. ?What should I use?

A lot of people on this list seem to prefer Barry's library for it's
simplicity but YMMV. Some people prefer txAMQP because they're running
stuff in a reactor.

> Each task unit is less than 1kb and I don't intend for the queue to be allowed to grow than ~200 task units long. ?At that point, I have the task producer set to pause and wait until the queue goes down.

Without a back channel, how is the producer going to know about the queue depth?

> I do want to be able to flag certain tasks as "dependant", so that a certain task must be marked "done" before it's dependent can can run.

That sounds quite application specific. Certainly you could set up
routing rules to put different classes of task into different queues,
but that may be too coarse grained for what you need.

HTH,

Ben



From allen.fowler at yahoo.com  Fri Sep  4 01:14:58 2009
From: allen.fowler at yahoo.com (Allen Fowler)
Date: Thu, 3 Sep 2009 17:14:58 -0700 (PDT)
Subject: [rabbitmq-discuss] Recommended python library for simple use?
In-Reply-To: <269388e30909031602j104593a1r17b27b05af32484c@mail.gmail.com>
References: <252719.54262.qm@web45613.mail.sp1.yahoo.com>
	<269388e30909031602j104593a1r17b27b05af32484c@mail.gmail.com>
Message-ID: <638307.71438.qm@web45605.mail.sp1.yahoo.com>

Ben,


> > 1) Is it hard to set up RabbitMQ for single machine use?
> 
> I wouldn't have thought so. There are packages for a variety of
> penguins as well as windows. It's quite a straightforward process.
> 

Planning to use Ubuntu Server, so I will use their packages.

More concerned with configuration, than installation.  Is it a big deal?



> > 2) I see there are a few AMQP projects for python.  What should I use?
> 
> A lot of people on this list seem to prefer Barry's library for it's
> simplicity but YMMV. Some people prefer txAMQP because they're running
> stuff in a reactor.
> 

That's ampqlib, right?

 

> > Each task unit is less than 1kb and I don't intend for the queue to be allowed 
> to grow than ~200 task units long.  At that point, I have the task producer set 
> to pause and wait until the queue goes down.
> 
> Without a back channel, how is the producer going to know about the queue depth?
> 

The one-and-only producer, I had thought, would do something like sleep for a few seconds, query the queue size, and if it's getting low, generate a new block of tasks.

Is this not advisable in RabbitMQ based systems?


> > I do want to be able to flag certain tasks as "dependant", so that a certain 
> task must be marked "done" before it's dependent can can run.
> 
> That sounds quite application specific. Certainly you could set up
> routing rules to put different classes of task into different queues,
> but that may be too coarse grained for what you need.
>

Maybe.

Basically most tasks only need to be done in a "loose FIFO" manner.   Some tasks will wind up sharing a particular attribute, and so their relative order must be followed.  The pool of possible values for this attribute is unlimited, but for any given task block, about 1/3 will share the attribute value with at least one other task.

Any ideas?

Thank you,
:)


      



From alexis.richardson at gmail.com  Fri Sep  4 03:03:45 2009
From: alexis.richardson at gmail.com (Alexis Richardson)
Date: Thu, 3 Sep 2009 19:03:45 -0700
Subject: [rabbitmq-discuss] Recommended python library for simple use?
In-Reply-To: <638307.71438.qm@web45605.mail.sp1.yahoo.com>
References: <252719.54262.qm@web45613.mail.sp1.yahoo.com>
	<269388e30909031602j104593a1r17b27b05af32484c@mail.gmail.com>
	<638307.71438.qm@web45605.mail.sp1.yahoo.com>
Message-ID: <167204d20909031903p2c72c527pa78371b82a0cb043@mail.gmail.com>

Allen

You may also find these links useful:

http://delicious.com/alexisrichardson/rabbitmq+python+work

alexis


On Thu, Sep 3, 2009 at 5:14 PM, Allen Fowler<allen.fowler at yahoo.com> wrote:
> Ben,
>
>
>> > 1) Is it hard to set up RabbitMQ for single machine use?
>>
>> I wouldn't have thought so. There are packages for a variety of
>> penguins as well as windows. It's quite a straightforward process.
>>
>
> Planning to use Ubuntu Server, so I will use their packages.
>
> More concerned with configuration, than installation. ?Is it a big deal?
>
>
>
>> > 2) I see there are a few AMQP projects for python. ?What should I use?
>>
>> A lot of people on this list seem to prefer Barry's library for it's
>> simplicity but YMMV. Some people prefer txAMQP because they're running
>> stuff in a reactor.
>>
>
> That's ampqlib, right?
>
>
>
>> > Each task unit is less than 1kb and I don't intend for the queue to be allowed
>> to grow than ~200 task units long. ?At that point, I have the task producer set
>> to pause and wait until the queue goes down.
>>
>> Without a back channel, how is the producer going to know about the queue depth?
>>
>
> The one-and-only producer, I had thought, would do something like sleep for a few seconds, query the queue size, and if it's getting low, generate a new block of tasks.
>
> Is this not advisable in RabbitMQ based systems?
>
>
>> > I do want to be able to flag certain tasks as "dependant", so that a certain
>> task must be marked "done" before it's dependent can can run.
>>
>> That sounds quite application specific. Certainly you could set up
>> routing rules to put different classes of task into different queues,
>> but that may be too coarse grained for what you need.
>>
>
> Maybe.
>
> Basically most tasks only need to be done in a "loose FIFO" manner. ? Some tasks will wind up sharing a particular attribute, and so their relative order must be followed. ?The pool of possible values for this attribute is unlimited, but for any given task block, about 1/3 will share the attribute value with at least one other task.
>
> Any ideas?
>
> Thank you,
> :)
>
>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



From allen.fowler at yahoo.com  Fri Sep  4 04:01:17 2009
From: allen.fowler at yahoo.com (Allen Fowler)
Date: Thu, 3 Sep 2009 20:01:17 -0700 (PDT)
Subject: [rabbitmq-discuss] How many consumers get message?
Message-ID: <3511.48382.qm@web45611.mail.sp1.yahoo.com>

Hello,

This may be a silly question...

If I have multiple worker process connected to a RabbitMQ server, does each worker get a copy of the submited message, or does only one?

If only one, how is that one chosen?

Thank you,
:)



      



From 0x6e6562 at gmail.com  Fri Sep  4 05:26:54 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 4 Sep 2009 05:26:54 +0100
Subject: [rabbitmq-discuss] Recommended python library for simple use?
In-Reply-To: <638307.71438.qm@web45605.mail.sp1.yahoo.com>
References: <252719.54262.qm@web45613.mail.sp1.yahoo.com>
	<269388e30909031602j104593a1r17b27b05af32484c@mail.gmail.com>
	<638307.71438.qm@web45605.mail.sp1.yahoo.com>
Message-ID: <269388e30909032126l2018f934j4f66ca310d661465@mail.gmail.com>

Allen,

On Fri, Sep 4, 2009 at 1:14 AM, Allen Fowler<allen.fowler at yahoo.com> wrote:
> More concerned with configuration, than installation. ?Is it a big deal?

Depends what you want to configure. Most of the configuration can be
achieved with the rabbitmqctl tool.

> That's ampqlib, right?

Yep.

> The one-and-only producer, I had thought, would do something like sleep for a few seconds, query the queue size, and if it's getting low, generate a new block of tasks.

How are you going to do this from the client?

> Is this not advisable in RabbitMQ based systems?

Provided you can answer the question above (which incidentally does
have a solution) then I don't see this being an issue per se. From an
architectural perspective you might say that it couples producers and
consumers, which is what a consumer driven message broker tries to
avoid in general. It could also be argued that it makes multicasting
more difficult since you would be bypassing the exchange concept. But
consumers can share queues as well, which might actually what you want
in your use case.  And, you could always architect in some kind of
command mechanism that abstracts out the queue control from the
producers.

> Basically most tasks only need to be done in a "loose FIFO" manner. ? Some tasks will wind up sharing a particular attribute, and so their relative order must be followed. ?The pool of possible values for this attribute is unlimited, but for any given task block, about 1/3 will share the attribute value with at least one other task.

If your tasks were expressible as numeric priorities and Rabbit
actually implemented priorities, then that might be a option. But
unfortunately it doesn't yet. If you can get away with a priority
queue, you could always put one into your consumer and then set a
larger prefetch window so that the PQ in your app has more than one
message to prioritize.

HTH,

Ben



From 0x6e6562 at gmail.com  Fri Sep  4 05:33:44 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 4 Sep 2009 05:33:44 +0100
Subject: [rabbitmq-discuss] How many consumers get message?
In-Reply-To: <3511.48382.qm@web45611.mail.sp1.yahoo.com>
References: <3511.48382.qm@web45611.mail.sp1.yahoo.com>
Message-ID: <269388e30909032133k199a0ce8oebfc697fe5f56b45@mail.gmail.com>

Allen,

On Fri, Sep 4, 2009 at 4:01 AM, Allen Fowler<allen.fowler at yahoo.com> wrote:
> If I have multiple worker process connected to a RabbitMQ server, does each worker get a copy of the submited message, or does only one?

This sort of question is kind of answered in the AMQP specification
document. Might be worth taking a look at that for the background.

> If only one, how is that one chosen?

I guess your asking about what other MOMs call topics.

>From a queue, each individual message will only be delivered to one
consumer, even if it is a shared queue. However, the routing model in
AMQP allows you to control how messages end up those queues. So by
specifying routing rules to multiple queues you can multicast each
inbound message to all of your queues.

HTH,

Ben



From allen.fowler at yahoo.com  Fri Sep  4 05:42:59 2009
From: allen.fowler at yahoo.com (Allen Fowler)
Date: Thu, 3 Sep 2009 21:42:59 -0700 (PDT)
Subject: [rabbitmq-discuss] How many consumers get message?
In-Reply-To: <269388e30909032133k199a0ce8oebfc697fe5f56b45@mail.gmail.com>
References: <3511.48382.qm@web45611.mail.sp1.yahoo.com>
	<269388e30909032133k199a0ce8oebfc697fe5f56b45@mail.gmail.com>
Message-ID: <830482.35949.qm@web45611.mail.sp1.yahoo.com>



> 
> From a queue, each individual message will only be delivered to one
> consumer, even if it is a shared queue. However, the routing model in
> AMQP allows you to control how messages end up those queues. So by
> specifying routing rules to multiple queues you can multicast each
> inbound message to all of your queues.


Thank you.


      



From allen.fowler at yahoo.com  Fri Sep  4 06:04:32 2009
From: allen.fowler at yahoo.com (Allen Fowler)
Date: Thu, 3 Sep 2009 22:04:32 -0700 (PDT)
Subject: [rabbitmq-discuss] Recommended python library for simple use?
In-Reply-To: <269388e30909032126l2018f934j4f66ca310d661465@mail.gmail.com>
References: <252719.54262.qm@web45613.mail.sp1.yahoo.com>
	<269388e30909031602j104593a1r17b27b05af32484c@mail.gmail.com>
	<638307.71438.qm@web45605.mail.sp1.yahoo.com>
	<269388e30909032126l2018f934j4f66ca310d661465@mail.gmail.com>
Message-ID: <733192.1308.qm@web45608.mail.sp1.yahoo.com>



> > The one-and-only producer, I had thought, would do something like sleep for a 
> few seconds, query the queue size, and if it's getting low, generate a new block 
> of tasks.
> 
> How are you going to do this from the client?
> 

Well...  i don't know.  :)

As i mentioned, I was planning to use python's multiprocessing.Queue, and that certainly does supply the ability to query the current queue size. 

I am trying to figure out if I can to this in RabbitMQ.  


> > Is this not advisable in RabbitMQ based systems?
> 
> Provided you can answer the question above (which incidentally does
> have a solution) then I don't see this being an issue per se. From an
> architectural perspective you might say that it couples producers and
> consumers, which is what a consumer driven message broker tries to
> avoid in general. It could also be argued that it makes multicasting
> more difficult since you would be bypassing the exchange concept. But
> consumers can share queues as well, which might actually what you want
> in your use case.  And, you could always architect in some kind of
> command mechanism that abstracts out the queue control from the
> producers.
> 

As a AMPQ newbie I am not quite sure what you mean.

To clarify:  In the problem at hand, there is a very large list of tasks to complete stored in a proprietary system.   The proprietary system is constantly reshuffling / editing the list of tasks, and waits for an external "execution engine" to ask for some tasks to work on.  These are marked as "in progress", and eventually "done".  

However, "execution engine" should only be asking for <300 tasks to be marked "in progress" at any time, so as to allow the main system to modify as many tasks as it needs to.

I was hoping to use AMQP in the "execution engine" to reliably distribute these tasks to ~20 workers.  After the task is done the "execution engine" needs to tell the main system to mark that task as done.

Perhaps AMPQ is the wrong tool for the job?




> > Basically most tasks only need to be done in a "loose FIFO" manner.   Some 
> tasks will wind up sharing a particular attribute, and so their relative order 
> must be followed.  The pool of possible values for this attribute is unlimited, 
> but for any given task block, about 1/3 will share the attribute value with at 
> least one other task.
> 
> If your tasks were expressible as numeric priorities and Rabbit
> actually implemented priorities, then that might be a option. But
> unfortunately it doesn't yet. If you can get away with a priority
> queue, you could always put one into your consumer and then set a
> larger prefetch window so that the PQ in your app has more than one
> message to prioritize.
> 

Not sure what you mean...  can you point me to the docs on this?

Worst case I will just dedicate ~5 single worker queues to just handle the pure "in order" streams separately.

(Assuming RabbitMQ can even be used here... see above.)


AF


      



From bchesneau at gmail.com  Fri Sep  4 08:46:16 2009
From: bchesneau at gmail.com (Benoit Chesneau)
Date: Fri, 4 Sep 2009 09:46:16 +0200
Subject: [rabbitmq-discuss] error in network tests of rabbitmq-erlang-client
Message-ID: <b7cd8ed10909040046s2f4864cq87bdebf8bbd8265f@mail.gmail.com>

Hi,

This morning I've pulled latest default branch on my computer (osx
snow leoopard), the same for rabbitmq-server. For server all tests
seem ok :

enlil:rabbitmq-server benoitc$ make run-tests
echo "rabbit_tests:all_tests()." | erl_call -sname rabbit -e
{ok, passed}enlil:rabbitmq-server benoitc$ cd ..


For client, `make test_direct` is ok but when running `make
test_network` I get error at the bottom. Is this "normal" for now ?

broker running
network_client_SUITE: hard_error_test...*failed*
::error:{assertMatch_failed,[{module,negative_test_util},
                           {line,70},
                           {expression,"Code"},
                           {expected,"? NOT_IMPLEMENTED"},
                           {value,1}]}
  in function negative_test_util:'-hard_error_test/1-fun-0-'/1
  in call from negative_test_util:hard_error_test/1


=======================================================
  Failed: 1.  Skipped: 0.  Passed: 22.
make -C ../rabbitmq-server start-background-node
RABBITMQ_NODE_IP_ADDRESS="" RABBITMQ_NODE_PORT=""
RABBITMQ_LOG_BASE="/var/folders/qY/qY5U4px8HhGtAPl90fv4f++++TI/-Tmp-/"
RABBITMQ_MNESIA_DIR="/var/folders/qY/qY5U4px8HhGtAPl90fv4f++++TI/-Tmp-//rabbitmq-rabbit-mnesia"
\
		RABBITMQ_NODE_ONLY=true \
		RABBITMQ_SERVER_START_ARGS=" -detached" \
		./scripts/rabbitmq-server ; sleep 1
make -C ../rabbitmq-server start-rabbit-on-node
echo "rabbit:start()." | erl_call -sname rabbit -e
{ok, ok}../rabbitmq-server/scripts/rabbitmqctl delete_user test_user_no_perm
Deleting user "test_user_no_perm" ...
...done.
make unboot_broker
make -C ../rabbitmq-server stop-rabbit-on-node
echo "rabbit:stop()." | erl_call -sname rabbit -e
{ok, ok}make -C ../rabbitmq-server stop-node
erl_call -sname rabbit -e -q
make[1]: *** [run_test_broker] Error 1
make: *** [test_network] Error 2




- beno?t



From 0x6e6562 at gmail.com  Fri Sep  4 09:17:12 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 4 Sep 2009 09:17:12 +0100
Subject: [rabbitmq-discuss] error in network tests of
	rabbitmq-erlang-client
In-Reply-To: <b7cd8ed10909040046s2f4864cq87bdebf8bbd8265f@mail.gmail.com>
References: <b7cd8ed10909040046s2f4864cq87bdebf8bbd8265f@mail.gmail.com>
Message-ID: <269388e30909040117k6539b150w8be36476af785dee@mail.gmail.com>

Beno?t,

On Fri, Sep 4, 2009 at 8:46 AM, Benoit Chesneau<bchesneau at gmail.com> wrote:
> For client, `make test_direct` is ok but when running `make
> test_network` I get error at the bottom. Is this "normal" for now ?
>
> broker running
> network_client_SUITE: hard_error_test...*failed*
> ::error:{assertMatch_failed,[{module,negative_test_util},
> ? ? ? ? ? ? ? ? ? ? ? ? ? {line,70},
> ? ? ? ? ? ? ? ? ? ? ? ? ? {expression,"Code"},
> ? ? ? ? ? ? ? ? ? ? ? ? ? {expected,"? NOT_IMPLEMENTED"},
> ? ? ? ? ? ? ? ? ? ? ? ? ? {value,1}]}
> ?in function negative_test_util:'-hard_error_test/1-fun-0-'/1
> ?in call from negative_test_util:hard_error_test/1

There is a race condition in the shutdown handling that occurs about
once in ten times. The fix for this has been done, it is in QA at the
moment and should land on default soon - I'll let you know when it
does. For the meantime, it shouldn't affect your normal usage of the
client.

Ben



From matthias at lshift.net  Fri Sep  4 10:20:41 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 04 Sep 2009 10:20:41 +0100
Subject: [rabbitmq-discuss] Recommended python library for simple use?
In-Reply-To: <269388e30909032126l2018f934j4f66ca310d661465@mail.gmail.com>
References: <252719.54262.qm@web45613.mail.sp1.yahoo.com>	<269388e30909031602j104593a1r17b27b05af32484c@mail.gmail.com>	<638307.71438.qm@web45605.mail.sp1.yahoo.com>
	<269388e30909032126l2018f934j4f66ca310d661465@mail.gmail.com>
Message-ID: <4AA0DBE9.3010005@lshift.net>

Allen,

Ben Hood wrote:
> On Fri, Sep 4, 2009 at 1:14 AM, Allen Fowler<allen.fowler at yahoo.com>
> wrote:
>> The one-and-only producer, I had thought, would do something like
>> sleep for a few seconds, query the queue size, and if it's getting
>> low, generate a new block of tasks.
> 
> How are you going to do this from the client?

queue.declare returns the message count.


Matthias.



From bchesneau at gmail.com  Fri Sep  4 15:17:06 2009
From: bchesneau at gmail.com (Benoit Chesneau)
Date: Fri, 4 Sep 2009 16:17:06 +0200
Subject: [rabbitmq-discuss] accept a message on a limited number of consumer
Message-ID: <b7cd8ed10909040717w3dcd3238o2ea37db3c6766df7@mail.gmail.com>

Hi all I'm trying to find the best way to process this kind of message :

I've n consumers waiting on message coming on special routing key. But
I would like that if the message is accepect by 2 of this nodes, all
other ignore it. Any idee how it could be done ?

For now, I hesitate to just place a dispatcher the publisher and all
consumer nodes that choose where messages should be send. So message
will be pushilesd only to the dispatcher that will republish it to
other nodes.

Another way to do it may be to make all nodes listening until they
can't. When they can't accept any other actions they will unbind the
queue.

 Is there a better way to do it ?

- benoit



From irrer at umich.edu  Fri Sep  4 15:38:05 2009
From: irrer at umich.edu (Jim Irrer)
Date: Fri, 4 Sep 2009 10:38:05 -0400
Subject: [rabbitmq-discuss] accept a message on a limited number of
	consumer
In-Reply-To: <b7cd8ed10909040717w3dcd3238o2ea37db3c6766df7@mail.gmail.com>
References: <b7cd8ed10909040717w3dcd3238o2ea37db3c6766df7@mail.gmail.com>
Message-ID: <3b6ef0790909040738u78a8565av84e22a5dcf7e0381@mail.gmail.com>

You could use a direct queue and send the message twice, which
is simple but incurs a little extra overhead.  There is also potential
for the same consumer to process both messages, though I don't
know what problem you are really trying to solve so I don't know if
that is ok.

Is it important that the message is processed twice, or that it be
processed by two different consumers?

- Jim

Jim Irrer     irrer at umich.edu       (734) 647-4409
University of Michigan Hospital Radiation Oncology
519 W. William St.             Ann Arbor, MI 48103


On Fri, Sep 4, 2009 at 10:17 AM, Benoit Chesneau <bchesneau at gmail.com>wrote:

> Hi all I'm trying to find the best way to process this kind of message :
>
> I've n consumers waiting on message coming on special routing key. But
> I would like that if the message is accepect by 2 of this nodes, all
> other ignore it. Any idee how it could be done ?
>
> For now, I hesitate to just place a dispatcher the publisher and all
> consumer nodes that choose where messages should be send. So message
> will be pushilesd only to the dispatcher that will republish it to
> other nodes.
>
> Another way to do it may be to make all nodes listening until they
> can't. When they can't accept any other actions they will unbind the
> queue.
>
>  Is there a better way to do it ?
>
> - benoit
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090904/9813de53/attachment.htm 

From irrer at umich.edu  Fri Sep  4 16:15:47 2009
From: irrer at umich.edu (Jim Irrer)
Date: Fri, 4 Sep 2009 11:15:47 -0400
Subject: [rabbitmq-discuss] accept a message on a limited number of
	consumer
In-Reply-To: <b7cd8ed10909040747o36878aefyfb626b0be770d165@mail.gmail.com>
References: <b7cd8ed10909040717w3dcd3238o2ea37db3c6766df7@mail.gmail.com>
	<3b6ef0790909040738u78a8565av84e22a5dcf7e0381@mail.gmail.com>
	<b7cd8ed10909040747o36878aefyfb626b0be770d165@mail.gmail.com>
Message-ID: <3b6ef0790909040815k4eb9397cr75a8641334e2880e@mail.gmail.com>

The only other thing I can think of is to have two types of consumers, 'A'
and 'B,
with corresponding exchanges, and send messages out once to each of the
exchanges.  This is a suboptimal because you lose any global load balancing
or fault tolerance.  It could also be done with header values.

That's all I've got.

I am curious as to why 2 consumers.  Is it that the processing needs to be
verified, is there a trust issue, or something else?  If the reason is
generally
applicable, then maybe a feature should be added to AMQP to support it.

- Jim


On Fri, Sep 4, 2009 at 10:47 AM, Benoit Chesneau <bchesneau at gmail.com>wrote:

> On Fri, Sep 4, 2009 at 4:38 PM, Jim Irrer<irrer at umich.edu> wrote:
> > You could use a direct queue and send the message twice, which
> > is simple but incurs a little extra overhead.
> The problem here is that I could have a lot of nodes behind. But this
> solution seem simple.
>
> > Is it important that the message is processed twice, or that it be
> > processed by two different consumers?
>
> It's important that the message is processed/accepted by 2 nodes. Each
> nodes will be in its own machine  hand have a limited number of
> specific message it can treat.
>
> - benoit
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090904/d25287f1/attachment.htm 

From vlad at lshift.net  Sun Sep  6 20:20:41 2009
From: vlad at lshift.net (Vlad Alexandru Ionescu)
Date: Sun, 06 Sep 2009 20:20:41 +0100
Subject: [rabbitmq-discuss] error in network tests
	of	rabbitmq-erlang-client
In-Reply-To: <269388e30909040117k6539b150w8be36476af785dee@mail.gmail.com>
References: <b7cd8ed10909040046s2f4864cq87bdebf8bbd8265f@mail.gmail.com>
	<269388e30909040117k6539b150w8be36476af785dee@mail.gmail.com>
Message-ID: <4AA40B89.3090004@lshift.net>

Beno?t,


Ben Hood wrote:
> The fix for this has been done, it is in QA at the
> moment and should land on default soon - I'll let you know when it
> does.

It has now been QA'ed and merged with default.
You will get a lot of output from the tests now, though. This is a new bug and doesn't affect normal usage of the client.


Vlad.




From aniruddh.narayan at yahoo.co.in  Mon Sep  7 06:41:02 2009
From: aniruddh.narayan at yahoo.co.in (aniruddh narayan)
Date: Mon, 7 Sep 2009 11:11:02 +0530 (IST)
Subject: [rabbitmq-discuss] java client library
Message-ID: <518529.47506.qm@web95206.mail.in2.yahoo.com>

Hi,
I have downloaded rabbitmq complete bundle and installed the server and the "broker running"
message
is displayed....but whenever i try to compile an example from the "java
client examples"......persay like "HelloServer.java"......i get a
compilation error....like the following

C:\>javac HelloServer.java
HelloServer.java:34: package com.rabbitmq.client does not exist
import com.rabbitmq.client.AMQP;
?????????????????????????? ^
HelloServer.java:35: package com.rabbitmq.client does not exist
import com.rabbitmq.client.Channel;
??????????????????????????
 ^
HelloServer.java:36: package com.rabbitmq.client does not exist
import com.rabbitmq.client.Connection;
?????????????????????????? ^
HelloServer.java:37: package com.rabbitmq.client does not exist
import com.rabbitmq.client.ConnectionFactory;
?????????????????????????? ^
HelloServer.java:38: package com.rabbitmq.client does not exist
import com.rabbitmq.client.StringRpcServer;
?????????????????????????? ^
HelloServer.java:44: package AMQP does not exist
??????????? int portNumber =
 (args.length > 1) ? Integer.parseInt(args[1]) : AMQ
P.PROTOCOL.PORT;


HelloServer.java:46: cannot find symbol
symbol? : class ConnectionFactory
location: class com.rabbitmq.examples.HelloServer
??????????? ConnectionFactory connFactory = new ConnectionFactory();
??????????? ^
HelloServer.java:46: cannot find symbol
symbol? : class ConnectionFactory
location: class com.rabbitmq.examples.HelloServer
??????????? ConnectionFactory connFactory = new
 ConnectionFactory();
??????????????????????????????????????????????? ^
HelloServer.java:47: cannot find symbol
symbol? : class Connection
location: class com.rabbitmq.examples.HelloServer
??????????? Connection conn = connFactory.newConnection(hostName, portNumber);
??????????? ^
HelloServer.java:48: cannot find symbol
symbol? : class Channel
location: class com.rabbitmq.examples.HelloServer
??????????? final Channel ch =
 conn.createChannel();
????????????????? ^
HelloServer.java:51: cannot find symbol
symbol? : class StringRpcServer
location: class com.rabbitmq.examples.HelloServer
??????????? StringRpcServer server = new StringRpcServer(ch, "Hello") {
??????????? ^
HelloServer.java:51: cannot find symbol

Bascially its not able to impor the packages.....


Any help will be much appreciated.....
thanks...aniruddh


      See the Web&#39;s breaking stories, chosen by people like you. Check out Yahoo! Buzz. http://in.buzz.yahoo.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/1c66be57/attachment.htm 

From 0x6e6562 at gmail.com  Mon Sep  7 06:59:05 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 7 Sep 2009 06:59:05 +0100
Subject: [rabbitmq-discuss] java client library
In-Reply-To: <518529.47506.qm@web95206.mail.in2.yahoo.com>
References: <518529.47506.qm@web95206.mail.in2.yahoo.com>
Message-ID: <269388e30909062259t381dfbc5of8b606738c6e38a1@mail.gmail.com>

Aniruddh,

On Mon, Sep 7, 2009 at 6:41 AM, aniruddh
narayan<aniruddh.narayan at yahoo.co.in> wrote:
> C:\>javac HelloServer.java
> HelloServer.java:34: package com.rabbitmq.client does not exist
> import com.rabbitmq.client.AMQP;

You are missing a compile dependency because you have not specified
anything on the classpath. The source distribution has an ant script
to help out here.

Ben



From aisha.fenton at gmail.com  Mon Sep  7 07:07:09 2009
From: aisha.fenton at gmail.com (aisha fenton)
Date: Mon, 7 Sep 2009 18:07:09 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing queue depth
Message-ID: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>

Hi,
I'm sure I'm doing something wrong since I can't find reference to
this anywhere else. What I'm seeing is that the performance of
draining a queue gets slower as the queue size increases.

I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
out of physical memory that it's performance degrades because it
starts swapping out. But I'm not anywhere close to running out of
memory yet, and the degradation starts almost immediately and
increases linearly as the queue depth grows.

I am publishing 500mps to an exchange. Each message is about 1KB. I
have a single fanout queue bound to the exchange. A single consumer is
popping messages off the queue.

When the queue is less than 20,000 messages I can pop 300mps off the
queue. When the queue is 200,000 messages the performance drop to
40-80mps.

I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or the
publisher are using more than 40% CPU.

I assume I shouldn't be seeing this? Any help much appreciated.

Aisha



From matthias at lshift.net  Mon Sep  7 07:17:52 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Mon, 07 Sep 2009 07:17:52 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
 depth
In-Reply-To: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
Message-ID: <4AA4A590.6060602@lshift.net>

Aisha,

aisha fenton wrote:
> I'm sure I'm doing something wrong since I can't find reference to
> this anywhere else. What I'm seeing is that the performance of
> draining a queue gets slower as the queue size increases.

Are the messages marked as persistent? If so then what you are seeing is 
another characteristic of the current persister which will be addressed 
in 1.7. Try non-persistent messages for a comparison.


Regards,

Matthias.



From digitalwarfare at gmail.com  Mon Sep  7 07:45:33 2009
From: digitalwarfare at gmail.com (Suhail Doshi)
Date: Sun, 6 Sep 2009 23:45:33 -0700
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <4AA4A590.6060602@lshift.net>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com> 
	<4AA4A590.6060602@lshift.net>
Message-ID: <376f3e6f0909062345l145cf5celc23e46727c6ebe82@mail.gmail.com>

What is that characteristic? Also when is 1.7 coming out? =)
Suhail

On Sun, Sep 6, 2009 at 11:17 PM, Matthias Radestock <matthias at lshift.net>wrote:

> Aisha,
>
> aisha fenton wrote:
> > I'm sure I'm doing something wrong since I can't find reference to
> > this anywhere else. What I'm seeing is that the performance of
> > draining a queue gets slower as the queue size increases.
>
> Are the messages marked as persistent? If so then what you are seeing is
> another characteristic of the current persister which will be addressed
> in 1.7. Try non-persistent messages for a comparison.
>
>
> Regards,
>
> Matthias.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
http://mixpanel.com
Blog: http://blog.mixpanel.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090906/5d1bd29a/attachment.htm 

From aisha.fenton at gmail.com  Mon Sep  7 07:50:24 2009
From: aisha.fenton at gmail.com (aisha fenton)
Date: Mon, 7 Sep 2009 18:50:24 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <4AA4A590.6060602@lshift.net>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<4AA4A590.6060602@lshift.net>
Message-ID: <35fd157f0909062350x3ec5e5bdk884407d9f8405dd8@mail.gmail.com>

Thanks Matthias,

I don't believe the message is marked as persistent. The queue is
non-durable (according to rabbitctl list_queues) and the message is
delivery_mode = 1.

By the way. When is 1.7 scheduled for release?



From aniruddh.narayan at yahoo.co.in  Mon Sep  7 07:55:22 2009
From: aniruddh.narayan at yahoo.co.in (aniruddh narayan)
Date: Mon, 7 Sep 2009 12:25:22 +0530 (IST)
Subject: [rabbitmq-discuss] java client library
Message-ID: <825007.72462.qm@web95208.mail.in2.yahoo.com>

Hi 
so do i need to specify the class path of the downloaded java client library like:
PATH="C:\rabbitmq-java-client-bin-1.6.0" .....cause i did this and the problem persists.....
thanks..waiting for the reply
aniruddh



      Love Cricket? Check out live scores, photos, video highlights and more. Click here http://cricket.yahoo.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/c23a2f74/attachment.htm 

From matthias at lshift.net  Mon Sep  7 08:23:04 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Mon, 07 Sep 2009 08:23:04 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
 depth
In-Reply-To: <35fd157f0909062350x3ec5e5bdk884407d9f8405dd8@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>	
	<4AA4A590.6060602@lshift.net>
	<35fd157f0909062350x3ec5e5bdk884407d9f8405dd8@mail.gmail.com>
Message-ID: <4AA4B4D8.3020102@lshift.net>

Aisha,

aisha fenton wrote:
> I don't believe the message is marked as persistent. The queue is
> non-durable (according to rabbitctl list_queues) and the message is
> delivery_mode = 1.

ok. The slowdown is definitely odd then. Can you send the code to 
reproduce this?

> By the way. When is 1.7 scheduled for release?

When it is ready ;)


Regards,

Matthias.



From pauljones23 at gmail.com  Mon Sep  7 08:31:10 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Mon, 7 Sep 2009 08:31:10 +0100
Subject: [rabbitmq-discuss] java client library
In-Reply-To: <825007.72462.qm@web95208.mail.in2.yahoo.com>
References: <825007.72462.qm@web95208.mail.in2.yahoo.com>
Message-ID: <29598b610909070031h44337cb3u443e51b9a00128ad@mail.gmail.com>

Aniruddh,

Try using the -classpath compiler flag to set the specific location of both
the client library jar, and the commons-io jar.

PATH doesn't affect the classpath for the java compiler.

See http://www.j2ee.me/javase/6/docs/technotes/tools/windows/javac.html if
you want more information on these flags.

Paul.

On Mon, Sep 7, 2009 at 7:55 AM, aniruddh narayan <
aniruddh.narayan at yahoo.co.in> wrote:

> Hi
> so do i need to specify the class path of the downloaded java client
> library like:
> PATH="C:\rabbitmq-java-client-bin-1.6.0" .....cause i did this and the
> problem persists.....
> thanks..waiting for the reply
> aniruddh
>
> ------------------------------
> See the Web's breaking stories, chosen by people like you. Check out Yahoo!
> Buzz <http://in.rd.yahoo.com/tagline_buzz_1/*http://in.buzz.yahoo.com/>.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/9e4af8db/attachment.htm 

From aniruddh.narayan at yahoo.co.in  Mon Sep  7 08:51:08 2009
From: aniruddh.narayan at yahoo.co.in (aniruddh narayan)
Date: Mon, 7 Sep 2009 13:21:08 +0530 (IST)
Subject: [rabbitmq-discuss] java client library
Message-ID: <690774.45993.qm@web95205.mail.in2.yahoo.com>

HI
I tried all the class path setting ,but unable to use the java client library ....
can anybody please tell me how to use java client library examples.....whenever i try to compile any of the example files...i find errors....like "package com.rabbitmq.client does not exsist"
...Also throw some light on how to set the class path...
any help is much much appreciated




      Love Cricket? Check out live scores, photos, video highlights and more. Click here http://cricket.yahoo.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/cef1a877/attachment.htm 

From pauljones23 at gmail.com  Mon Sep  7 09:13:49 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Mon, 7 Sep 2009 09:13:49 +0100
Subject: [rabbitmq-discuss] java client library
In-Reply-To: <690774.45993.qm@web95205.mail.in2.yahoo.com>
References: <690774.45993.qm@web95205.mail.in2.yahoo.com>
Message-ID: <29598b610909070113r76bec43dy8ddc0153c1240a47@mail.gmail.com>

Aniruddh,

Perhaps you're attempting to use the source code distribution without having
built it?

The quickest way to get going would be to download both the source code and
binary packages. Assuming that you're in the directory containing
HelloServer.java, and that you've unpacked the binary distribution (ie
http://www.rabbitmq.com/releases/rabbitmq-java-client/v1.6.0/rabbitmq-java-client-bin-1.6.0.zip)
into C:\rabbitmq-java-client-bin-1.6.0, then you'd execute the command:
  javac -classpath
C:\rabbitmq-java-client-bin-1.6.0\rabbitmq-client.jar;C:\rabbitmq-java-client-bin-1.6.0\commons-io-1.2.jar
HelloServer.java

Paul.


On Mon, Sep 7, 2009 at 8:51 AM, aniruddh narayan <
aniruddh.narayan at yahoo.co.in> wrote:

> HI
> I tried all the class path setting ,but unable to use the java client
> library ....
> can anybody please tell me how to use java client library
> examples.....whenever i try to compile any of the example files...i find
> errors....like "package com.rabbitmq.client does not exsist"
> ...Also throw some light on how to set the class path...
> any help is much much appreciated
>
>
> ------------------------------
> See the Web's breaking stories, chosen by people like you. Check out Yahoo!
> Buzz <http://in.rd.yahoo.com/tagline_buzz_1/*http://in.buzz.yahoo.com/>.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/28e272ce/attachment.htm 

From aniruddh.narayan at yahoo.co.in  Mon Sep  7 14:30:51 2009
From: aniruddh.narayan at yahoo.co.in (aniruddh narayan)
Date: Mon, 7 Sep 2009 19:00:51 +0530 (IST)
Subject: [rabbitmq-discuss] java client error
Message-ID: <94225.18792.qm@web95212.mail.in2.yahoo.com>

hi 
the sever seems to be working fine.also there is no compilation
error.but when i try to run the file "HelloServer"...the following
error comes in.....

C:\>javac HelloServer.java

C:\>java HelloServer
Exception in thread "main" java.lang.NoClassDefFoundError: HelloServer

can anybody please fill me in ,as to where the error is....the classpath is well set....
aniruddh





      Love Cricket? Check out live scores, photos, video highlights and more. Click here http://cricket.yahoo.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/7b44d2c8/attachment.htm 

From pauljones23 at gmail.com  Mon Sep  7 15:05:03 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Mon, 7 Sep 2009 15:05:03 +0100
Subject: [rabbitmq-discuss] java client error
In-Reply-To: <94225.18792.qm@web95212.mail.in2.yahoo.com>
References: <94225.18792.qm@web95212.mail.in2.yahoo.com>
Message-ID: <29598b610909070705v61d3b1bp4a0087bfc5a03991@mail.gmail.com>

Hi Aniruddh,

The HelloServer class is in the package com.rabbitmq.examples, so you'll
find the compiler will have placed the .class file into an appropriate
directory structure.

Perhaps try running the command for java as:
  java com.rabbitmq.examples.HelloServer

Running Java from the command line is generally unpleasant for any
non-trivial amount of code. I would recommend downloading (and finding a
guide for) Netbeans or Eclipse as these tools make things substantially
easier. Unfortunately, we're not able to provide any assistance with setting
up these tools though, since they really are out of the realm of the Rabbit
server.

Paul.

On Mon, Sep 7, 2009 at 2:30 PM, aniruddh narayan <
aniruddh.narayan at yahoo.co.in> wrote:

> hi
> the sever seems to be working fine.also there is no compilation error.but
> when i try to run the file "HelloServer"...the following error comes in.....
>
> C:\>javac HelloServer.java
>
> C:\>java HelloServer
> Exception in thread "main" java.lang.NoClassDefFoundError: HelloServer
>
> can anybody please fill me in ,as to where the error is....the classpath is
> well set....
> aniruddh
>
>
>
> ------------------------------
> See the Web's breaking stories, chosen by people like you. Check out Yahoo!
> Buzz <http://in.rd.yahoo.com/tagline_buzz_1/*http://in.buzz.yahoo.com/>.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/75b9c3f4/attachment.htm 

From cremes.devlist at mac.com  Mon Sep  7 16:23:46 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Mon, 07 Sep 2009 10:23:46 -0500
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
Message-ID: <58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>


On Sep 7, 2009, at 1:07 AM, aisha fenton wrote:

> Hi,
> I'm sure I'm doing something wrong since I can't find reference to
> this anywhere else. What I'm seeing is that the performance of
> draining a queue gets slower as the queue size increases.
>
> I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
> out of physical memory that it's performance degrades because it
> starts swapping out. But I'm not anywhere close to running out of
> memory yet, and the degradation starts almost immediately and
> increases linearly as the queue depth grows.
>
> I am publishing 500mps to an exchange. Each message is about 1KB. I
> have a single fanout queue bound to the exchange. A single consumer is
> popping messages off the queue.
>
> When the queue is less than 20,000 messages I can pop 300mps off the
> queue. When the queue is 200,000 messages the performance drop to
> 40-80mps.
>
> I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or the
> publisher are using more than 40% CPU.
>
> I assume I shouldn't be seeing this? Any help much appreciated.

You didn't include any code, but I'm going to take a stab in the dark  
anyway. If you are using the ruby amqp gem you might be doing  
something like this:

def next_message
   exchange = MQ.fanout 'foo'
   queue = MQ.queue 'bar'

   queue.bind exchange

   newest_message = queue.pop
end

In the code above the call to MQ.<whatever> is opening a new channel  
to rabbitmq each time the method is called. You are essentially  
leaking channels all over the place every time you try to pop a new  
message.

If you aren't using the ruby amqp stuff, I still recommend checking  
your code for whatever library you chose. You only need to allocate a  
few channels and reuse them.

cr




From digitalwarfare at gmail.com  Mon Sep  7 17:32:58 2009
From: digitalwarfare at gmail.com (Suhail Doshi)
Date: Mon, 7 Sep 2009 09:32:58 -0700
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com> 
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
Message-ID: <376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>

I almost feel as though rabbitmq can't push items to my consumer fast
enough, I had a backed up queue with 20 consumers and spawned another
watching the items get processed and it just seemed so slow, saw numerous
pauses between item processing and I don't believe it is the consumer's
fault.
I am using the Python library for the consumer part.

Suhail

On Mon, Sep 7, 2009 at 8:23 AM, Chuck Remes <cremes.devlist at mac.com> wrote:

>
> On Sep 7, 2009, at 1:07 AM, aisha fenton wrote:
>
> > Hi,
> > I'm sure I'm doing something wrong since I can't find reference to
> > this anywhere else. What I'm seeing is that the performance of
> > draining a queue gets slower as the queue size increases.
> >
> > I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
> > out of physical memory that it's performance degrades because it
> > starts swapping out. But I'm not anywhere close to running out of
> > memory yet, and the degradation starts almost immediately and
> > increases linearly as the queue depth grows.
> >
> > I am publishing 500mps to an exchange. Each message is about 1KB. I
> > have a single fanout queue bound to the exchange. A single consumer is
> > popping messages off the queue.
> >
> > When the queue is less than 20,000 messages I can pop 300mps off the
> > queue. When the queue is 200,000 messages the performance drop to
> > 40-80mps.
> >
> > I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or the
> > publisher are using more than 40% CPU.
> >
> > I assume I shouldn't be seeing this? Any help much appreciated.
>
> You didn't include any code, but I'm going to take a stab in the dark
> anyway. If you are using the ruby amqp gem you might be doing
> something like this:
>
> def next_message
>   exchange = MQ.fanout 'foo'
>   queue = MQ.queue 'bar'
>
>   queue.bind exchange
>
>   newest_message = queue.pop
> end
>
> In the code above the call to MQ.<whatever> is opening a new channel
> to rabbitmq each time the method is called. You are essentially
> leaking channels all over the place every time you try to pop a new
> message.
>
> If you aren't using the ruby amqp stuff, I still recommend checking
> your code for whatever library you chose. You only need to allocate a
> few channels and reuse them.
>
> cr
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
http://mixpanel.com
Blog: http://blog.mixpanel.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/3f720c59/attachment.htm 

From digitalwarfare at gmail.com  Mon Sep  7 17:34:29 2009
From: digitalwarfare at gmail.com (Suhail Doshi)
Date: Mon, 7 Sep 2009 09:34:29 -0700
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com> 
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
Message-ID: <376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>

2009-09-07 16:33:10,822 INFO [id: 95705166] Processing complete,
acknowledged.
2009-09-07 16:33:10,826 INFO [id: 95705166] Received queue item,
processing...
2009-09-07 16:33:10,878 INFO [id: 95705166] Processing complete,
acknowledged.
2009-09-07 16:33:10,882 INFO [id: 95705166] Received queue item,
processing...
2009-09-07 16:33:12,839 INFO [id: 95705166] Processing complete,
acknowledged.
2009-09-07 16:33:12,839 INFO [id: 95705166] Received queue item,
processing...
2009-09-07 16:33:13,531 INFO [id: 95705166] Processing complete,
acknowledged.
2009-09-07 16:33:13,531 INFO [id: 95705166] Received queue item,
processing...

If you see there's like a pause for a second between 10 and 12, an item gets
processed pretty fast as you can see. Odd isn't it?

Suhail

On Mon, Sep 7, 2009 at 9:32 AM, Suhail Doshi <digitalwarfare at gmail.com>wrote:

> I almost feel as though rabbitmq can't push items to my consumer fast
> enough, I had a backed up queue with 20 consumers and spawned another
> watching the items get processed and it just seemed so slow, saw numerous
> pauses between item processing and I don't believe it is the consumer's
> fault.
> I am using the Python library for the consumer part.
>
> Suhail
>
>
> On Mon, Sep 7, 2009 at 8:23 AM, Chuck Remes <cremes.devlist at mac.com>wrote:
>
>>
>> On Sep 7, 2009, at 1:07 AM, aisha fenton wrote:
>>
>> > Hi,
>> > I'm sure I'm doing something wrong since I can't find reference to
>> > this anywhere else. What I'm seeing is that the performance of
>> > draining a queue gets slower as the queue size increases.
>> >
>> > I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
>> > out of physical memory that it's performance degrades because it
>> > starts swapping out. But I'm not anywhere close to running out of
>> > memory yet, and the degradation starts almost immediately and
>> > increases linearly as the queue depth grows.
>> >
>> > I am publishing 500mps to an exchange. Each message is about 1KB. I
>> > have a single fanout queue bound to the exchange. A single consumer is
>> > popping messages off the queue.
>> >
>> > When the queue is less than 20,000 messages I can pop 300mps off the
>> > queue. When the queue is 200,000 messages the performance drop to
>> > 40-80mps.
>> >
>> > I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or the
>> > publisher are using more than 40% CPU.
>> >
>> > I assume I shouldn't be seeing this? Any help much appreciated.
>>
>> You didn't include any code, but I'm going to take a stab in the dark
>> anyway. If you are using the ruby amqp gem you might be doing
>> something like this:
>>
>> def next_message
>>   exchange = MQ.fanout 'foo'
>>   queue = MQ.queue 'bar'
>>
>>   queue.bind exchange
>>
>>   newest_message = queue.pop
>> end
>>
>> In the code above the call to MQ.<whatever> is opening a new channel
>> to rabbitmq each time the method is called. You are essentially
>> leaking channels all over the place every time you try to pop a new
>> message.
>>
>> If you aren't using the ruby amqp stuff, I still recommend checking
>> your code for whatever library you chose. You only need to allocate a
>> few channels and reuse them.
>>
>> cr
>>
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>
>
>
> --
> http://mixpanel.com
> Blog: http://blog.mixpanel.com
>



-- 
http://mixpanel.com
Blog: http://blog.mixpanel.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/fe029381/attachment.htm 

From tsuraan at gmail.com  Mon Sep  7 19:08:03 2009
From: tsuraan at gmail.com (tsuraan)
Date: Mon, 7 Sep 2009 13:08:03 -0500
Subject: [rabbitmq-discuss] procedure for dealing with
	timeout_waiting_for_tables
Message-ID: <84fb38e30909071108n2ae089b7ne27356b7e062c4d4@mail.gmail.com>

I had a machine that had the timeout_waiting_for_tables (not in a
cluster, just a single node).  I'm guessing that its hostname had
changed, and that was making mnesia angry.  I have two questions about
this.  Is there a good way to figure out exactly why mnesia isn't
starting, i.e. is it a hostname change, a corrupt mnesia file, etc?

Second, to fix this, I thought I could copy out my persister logs,
wipe the rabbit dir from /var/lib/.../mnesia, restart rabbit, and move
the persisters back in.  That didn't seem to work, since the queues
weren't defined anymore, so the log replay apparently just threw
everything away.  Would remaking my exchanges, bindings, and queues,
then moving in my persister logs do the trick?

The full error from the log was:

=INFO REPORT==== 8-Sep-2009::02:53:25 ===
    application: rabbit
    exited: {{timeout_waiting_for_tables,
                 [rabbit_user,rabbit_user_permission,rabbit_vhost,
                  rabbit_config,rabbit_listener,rabbit_durable_route,
                  rabbit_route,rabbit_reverse_route,rabbit_durable_exchange,
                  rabbit_exchange,rabbit_durable_queue,rabbit_queue]},
             {rabbit,start,[normal,[]]}}
    type: temporary

=INFO REPORT==== 8-Sep-2009::02:53:25 ===
    application: mnesia
    exited: stopped
    type: temporary

=INFO REPORT==== 8-Sep-2009::02:53:25 ===
    application: os_mon
    exited: stopped
    type: temporary

That looks pretty standard from what I could find on this list, and it
seems to be related to hostname changes, but I couldn't see how to fix
it from there.



From cremes.devlist at mac.com  Mon Sep  7 19:38:54 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Mon, 07 Sep 2009 13:38:54 -0500
Subject: [rabbitmq-discuss] Performance degrades with increasing
	queue	depth
In-Reply-To: <376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
Message-ID: <DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>

Are you running the same code as Aisha? Are you the same person or  
work together? I'm getting a bit confused in this thread.

And, someone needs to start showing some code. I'm able to push  
hundreds of messages per second and never see a drop off in delivery  
performance regardless of the queue size (until I run out of memory).  
I don't think it is fair to blame rabbit until we can see your code  
and understand what you are doing.

Also, please specify the following things:

exchange - durable or not?
exchange - type? (Looks like "fanout" from the original post)
number of bindings per exchange
queue  - durable?
publishing settings - require ack? persistent? immediate?
message size? 1K according to the original post

Is your test machine paging or swapping? What is the 'top' output for  
your process and for rabbit at various points of the run cycle? Is it  
lower or higher when you are getting 300 msg/s than when you are  
getting 80 msg/s?

What is your subscriber doing with the data it receives? If you make  
that process a "no op" how many messages per second can you handle?  
Does it ever drop off related to queue size? Why are you "popping"  
messages from the queue isn't of having them pushed automatically?

This thread has been really frustrating because there has NOT been  
very much information shared. All I see is "it's slow." Give us more  
information.

cr


On Sep 7, 2009, at 11:34 AM, Suhail Doshi wrote:

> 2009-09-07 16:33:10,822 INFO [id: 95705166] Processing complete,  
> acknowledged.
> 2009-09-07 16:33:10,826 INFO [id: 95705166] Received queue item,  
> processing...
> 2009-09-07 16:33:10,878 INFO [id: 95705166] Processing complete,  
> acknowledged.
> 2009-09-07 16:33:10,882 INFO [id: 95705166] Received queue item,  
> processing...
> 2009-09-07 16:33:12,839 INFO [id: 95705166] Processing complete,  
> acknowledged.
> 2009-09-07 16:33:12,839 INFO [id: 95705166] Received queue item,  
> processing...
> 2009-09-07 16:33:13,531 INFO [id: 95705166] Processing complete,  
> acknowledged.
> 2009-09-07 16:33:13,531 INFO [id: 95705166] Received queue item,  
> processing...
>
> If you see there's like a pause for a second between 10 and 12, an  
> item gets processed pretty fast as you can see. Odd isn't it?
>
> Suhail
>
> On Mon, Sep 7, 2009 at 9:32 AM, Suhail Doshi  
> <digitalwarfare at gmail.com> wrote:
> I almost feel as though rabbitmq can't push items to my consumer  
> fast enough, I had a backed up queue with 20 consumers and spawned  
> another watching the items get processed and it just seemed so slow,  
> saw numerous pauses between item processing and I don't believe it  
> is the consumer's fault.
>
> I am using the Python library for the consumer part.
>
> Suhail
>
>
> On Mon, Sep 7, 2009 at 8:23 AM, Chuck Remes <cremes.devlist at mac.com>  
> wrote:
>
> On Sep 7, 2009, at 1:07 AM, aisha fenton wrote:
>
> > Hi,
> > I'm sure I'm doing something wrong since I can't find reference to
> > this anywhere else. What I'm seeing is that the performance of
> > draining a queue gets slower as the queue size increases.
> >
> > I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
> > out of physical memory that it's performance degrades because it
> > starts swapping out. But I'm not anywhere close to running out of
> > memory yet, and the degradation starts almost immediately and
> > increases linearly as the queue depth grows.
> >
> > I am publishing 500mps to an exchange. Each message is about 1KB. I
> > have a single fanout queue bound to the exchange. A single  
> consumer is
> > popping messages off the queue.
> >
> > When the queue is less than 20,000 messages I can pop 300mps off the
> > queue. When the queue is 200,000 messages the performance drop to
> > 40-80mps.
> >
> > I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or  
> the
> > publisher are using more than 40% CPU.
> >
> > I assume I shouldn't be seeing this? Any help much appreciated.
>
> You didn't include any code, but I'm going to take a stab in the dark
> anyway. If you are using the ruby amqp gem you might be doing
> something like this:
>
> def next_message
>   exchange = MQ.fanout 'foo'
>   queue = MQ.queue 'bar'
>
>   queue.bind exchange
>
>   newest_message = queue.pop
> end
>
> In the code above the call to MQ.<whatever> is opening a new channel
> to rabbitmq each time the method is called. You are essentially
> leaking channels all over the place every time you try to pop a new
> message.
>
> If you aren't using the ruby amqp stuff, I still recommend checking
> your code for whatever library you chose. You only need to allocate a
> few channels and reuse them.
>
> cr
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
>
> -- 
> http://mixpanel.com
> Blog: http://blog.mixpanel.com
>
>
>
> -- 
> http://mixpanel.com
> Blog: http://blog.mixpanel.com

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/1f84fdf7/attachment.htm 

From aisha.fenton at gmail.com  Mon Sep  7 22:16:02 2009
From: aisha.fenton at gmail.com (Aisha Fenton)
Date: Tue, 8 Sep 2009 09:16:02 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
Message-ID: <6E807D23-006F-4B56-9498-85BCA89C0FFF@gmail.com>

Code below.

Chuck, I think you're onto something. Something that I noticed while  
putting together the test code is that it goes 300mps the first time I  
run it. Any subsequent runs drop to 80mps. Only a rabbitmq restart  
gets it back to 300mps, and then only for the first run. Hmmm sounds  
like a connection leak...

I can't see anywhere in the code where I'm leaking connections (?) but  
maybe Bunny (the AMQP Ruby adapter I'm using) is?

----
require "rubygems"
require "bunny"

@msg_server = Bunny.new(:spec => '08')
@msg_server.start

def start
   count ||= 0
   prev_time ||= Time.now
   queue = @msg_server.queue("process_telemetry")

    # main loop
   loop do
     result = queue.pop
     next if result == :queue_empty

     count += 1
     if count > 100
       t = Time.now
       puts("msgs pops per sec: #{count / (t - prev_time)}")
       prev_time = t
       count = 0
     end
   end

end

begin
   start()
ensure
   puts "stopping"
   @msg_server.stop
end


On 8/09/2009, at 3:23 AM, Chuck Remes wrote:

>
> On Sep 7, 2009, at 1:07 AM, aisha fenton wrote:
>
>> Hi,
>> I'm sure I'm doing something wrong since I can't find reference to
>> this anywhere else. What I'm seeing is that the performance of
>> draining a queue gets slower as the queue size increases.
>>
>> I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
>> out of physical memory that it's performance degrades because it
>> starts swapping out. But I'm not anywhere close to running out of
>> memory yet, and the degradation starts almost immediately and
>> increases linearly as the queue depth grows.
>>
>> I am publishing 500mps to an exchange. Each message is about 1KB. I
>> have a single fanout queue bound to the exchange. A single consumer  
>> is
>> popping messages off the queue.
>>
>> When the queue is less than 20,000 messages I can pop 300mps off the
>> queue. When the queue is 200,000 messages the performance drop to
>> 40-80mps.
>>
>> I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or the
>> publisher are using more than 40% CPU.
>>
>> I assume I shouldn't be seeing this? Any help much appreciated.
>
> You didn't include any code, but I'm going to take a stab in the  
> dark anyway. If you are using the ruby amqp gem you might be doing  
> something like this:
>
> def next_message
>  exchange = MQ.fanout 'foo'
>  queue = MQ.queue 'bar'
>
>  queue.bind exchange
>
>  newest_message = queue.pop
> end
>
> In the code above the call to MQ.<whatever> is opening a new channel  
> to rabbitmq each time the method is called. You are essentially  
> leaking channels all over the place every time you try to pop a new  
> message.
>
> If you aren't using the ruby amqp stuff, I still recommend checking  
> your code for whatever library you chose. You only need to allocate  
> a few channels and reuse them.
>
> cr
>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/a5ad2431/attachment.htm 

From aisha.fenton at gmail.com  Mon Sep  7 22:28:07 2009
From: aisha.fenton at gmail.com (Aisha Fenton)
Date: Tue, 8 Sep 2009 09:28:07 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing
	queue	depth
In-Reply-To: <DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
Message-ID: <CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>

Hi Chunk.
I don't know Suhail. And his problem may be different from mine.

To isolate the problem, I've reduce what I'm doing down to the  
attached code files. One pushes messages, the other pops them.

I see the problem even when only test_push.rb is running (as long as  
the queue is sufficiently pre-populated). Nothing else is using  
rabbitmq when I'm doing the test.

I'm getting the same problem on several different machines here -- my  
local MacOSX box and a server class Debian box.


> exchange - durable or not?
not durable

> exchange - type? (Looks like "fanout" from the original post)
fanout

> number of bindings per exchange
1

> queue  - durable?
not durable

> publishing settings - require ack? persistent? immediate?
no ack, non persistent, and non immediate.

> message size? 1K according to the original post
< 1K



test_push.rb
---

require "rubygems"
require "bunny"

EXCHANGE = "raw_telemetry"
QUEUE = "process_telemetry"

count ||= 0
prev_time ||= Time.now
msg_server = Bunny.new(:spec => '08')
msg_server.start

msg_server.exchange(EXCHANGE, :type  => :fanout)
msg_server.queue(QUEUE).bind(EXCHANGE)

loop do

   msg_server.exchange(EXCHANGE).publish("This is my msg")

   count += 1
   if count > 100
     t = Time.now
     puts("msgs pushes per sec: #{count / (t - prev_time)}")
     prev_time = t
     count = 0
   end

end

test_pop.rb
---

require "rubygems"
require "bunny"

@msg_server = Bunny.new(:spec => '08')
@msg_server.start

def start
   count ||= 0
   prev_time ||= Time.now
   queue = @msg_server.queue("process_telemetry")

   loop do
     result = queue.pop
     next if result == :queue_empty

     count += 1
     if count > 100
       t = Time.now
       puts("msgs pops per sec: #{count / (t - prev_time)}")
       prev_time = t
       count = 0
     end
   end

end

begin
   start()
ensure
   puts "stopping"
   @msg_server.stop
end




On 8/09/2009, at 6:38 AM, Chuck Remes wrote:

> Are you running the same code as Aisha? Are you the same person or  
> work together? I'm getting a bit confused in this thread.
>
> And, someone needs to start showing some code. I'm able to push  
> hundreds of messages per second and never see a drop off in delivery  
> performance regardless of the queue size (until I run out of  
> memory). I don't think it is fair to blame rabbit until we can see  
> your code and understand what you are doing.
>
> Also, please specify the following things:
>
> exchange - durable or not?
> exchange - type? (Looks like "fanout" from the original post)
> number of bindings per exchange
> queue  - durable?
> publishing settings - require ack? persistent? immediate?
> message size? 1K according to the original post
>
> Is your test machine paging or swapping? What is the 'top' output  
> for your process and for rabbit at various points of the run cycle?  
> Is it lower or higher when you are getting 300 msg/s than when you  
> are getting 80 msg/s?
>
> What is your subscriber doing with the data it receives? If you make  
> that process a "no op" how many messages per second can you handle?  
> Does it ever drop off related to queue size? Why are you "popping"  
> messages from the queue isn't of having them pushed automatically?
>
> This thread has been really frustrating because there has NOT been  
> very much information shared. All I see is "it's slow." Give us more  
> information.
>
> cr
>
>
> On Sep 7, 2009, at 11:34 AM, Suhail Doshi wrote:
>
>> 2009-09-07 16:33:10,822 INFO [id: 95705166] Processing complete,  
>> acknowledged.
>> 2009-09-07 16:33:10,826 INFO [id: 95705166] Received queue item,  
>> processing...
>> 2009-09-07 16:33:10,878 INFO [id: 95705166] Processing complete,  
>> acknowledged.
>> 2009-09-07 16:33:10,882 INFO [id: 95705166] Received queue item,  
>> processing...
>> 2009-09-07 16:33:12,839 INFO [id: 95705166] Processing complete,  
>> acknowledged.
>> 2009-09-07 16:33:12,839 INFO [id: 95705166] Received queue item,  
>> processing...
>> 2009-09-07 16:33:13,531 INFO [id: 95705166] Processing complete,  
>> acknowledged.
>> 2009-09-07 16:33:13,531 INFO [id: 95705166] Received queue item,  
>> processing...
>>
>> If you see there's like a pause for a second between 10 and 12, an  
>> item gets processed pretty fast as you can see. Odd isn't it?
>>
>> Suhail
>>
>> On Mon, Sep 7, 2009 at 9:32 AM, Suhail Doshi <digitalwarfare at gmail.com 
>> > wrote:
>> I almost feel as though rabbitmq can't push items to my consumer  
>> fast enough, I had a backed up queue with 20 consumers and spawned  
>> another watching the items get processed and it just seemed so  
>> slow, saw numerous pauses between item processing and I don't  
>> believe it is the consumer's fault.
>>
>> I am using the Python library for the consumer part.
>>
>> Suhail
>>
>>
>> On Mon, Sep 7, 2009 at 8:23 AM, Chuck Remes  
>> <cremes.devlist at mac.com> wrote:
>>
>> On Sep 7, 2009, at 1:07 AM, aisha fenton wrote:
>>
>> > Hi,
>> > I'm sure I'm doing something wrong since I can't find reference to
>> > this anywhere else. What I'm seeing is that the performance of
>> > draining a queue gets slower as the queue size increases.
>> >
>> > I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
>> > out of physical memory that it's performance degrades because it
>> > starts swapping out. But I'm not anywhere close to running out of
>> > memory yet, and the degradation starts almost immediately and
>> > increases linearly as the queue depth grows.
>> >
>> > I am publishing 500mps to an exchange. Each message is about 1KB. I
>> > have a single fanout queue bound to the exchange. A single  
>> consumer is
>> > popping messages off the queue.
>> >
>> > When the queue is less than 20,000 messages I can pop 300mps off  
>> the
>> > queue. When the queue is 200,000 messages the performance drop to
>> > 40-80mps.
>> >
>> > I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or  
>> the
>> > publisher are using more than 40% CPU.
>> >
>> > I assume I shouldn't be seeing this? Any help much appreciated.
>>
>> You didn't include any code, but I'm going to take a stab in the dark
>> anyway. If you are using the ruby amqp gem you might be doing
>> something like this:
>>
>> def next_message
>>   exchange = MQ.fanout 'foo'
>>   queue = MQ.queue 'bar'
>>
>>   queue.bind exchange
>>
>>   newest_message = queue.pop
>> end
>>
>> In the code above the call to MQ.<whatever> is opening a new channel
>> to rabbitmq each time the method is called. You are essentially
>> leaking channels all over the place every time you try to pop a new
>> message.
>>
>> If you aren't using the ruby amqp stuff, I still recommend checking
>> your code for whatever library you chose. You only need to allocate a
>> few channels and reuse them.
>>
>> cr
>>
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
>>
>> -- 
>> http://mixpanel.com
>> Blog: http://blog.mixpanel.com
>>
>>
>>
>> -- 
>> http://mixpanel.com
>> Blog: http://blog.mixpanel.com
>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/0027943b/attachment.htm 

From aisha.fenton at gmail.com  Mon Sep  7 22:44:11 2009
From: aisha.fenton at gmail.com (Aisha Fenton)
Date: Tue, 8 Sep 2009 09:44:11 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing
	queue	depth
In-Reply-To: <CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
Message-ID: <506C64DD-BFB1-437A-9C1B-ECFB8CF3A211@gmail.com>

Sorry didn't answer your other questions.

> Is your test machine paging or swapping?

I don't believe so. I see the issue when even though I have Gigs of  
free memory. Unless there is some configuration change that I need to  
make to RabbitMQ for it to take advantage of that memory?

> What is the 'top' output for your process and for rabbit at various  
> points of the run cycle? Is it lower or higher when you are getting  
> 300 msg/s than when you are getting 80 msg/s?

The CPU increases from 10% to 40%. So it does get busier as mps drop  
off. But the machine is still nowhere near CPU bound.

> What is your subscriber doing with the data it receives? If you make  
> that process a "no op" how many messages per second can you handle?

In my test app, just counting how many mps. I assume a "no op" means  
doing nothing but counting the mps, like my test script?

> Does it ever drop off related to queue size?


The mps reduces as the queue depth increases.

>  Why are you "popping" messages from the queue isn't of having them  
> pushed automatically?

The library I'm using (http://github.com/celldee/bunny/tree/master) is  
synchronous only. I'm considering switching to (http://github.com/tmm1/amqp/tree/master 
) which is async and uses libevent. However, I've read that there are  
problems with msg acknowledges in apps that use libevent, because the  
OS can buffer the ack responses. And although I'm not using ack yet, I  
want to in my production system.

  
     



From hungryblank at gmail.com  Mon Sep  7 23:23:10 2009
From: hungryblank at gmail.com (Paolo Negri)
Date: Tue, 8 Sep 2009 00:23:10 +0200
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
Message-ID: <4cf112580909071523y23889f72i39d7e54547bc089d@mail.gmail.com>

Hi Everyone

the code provided for the publisher actually does seem likely to
produce the channel leak

try the following instead

require "rubygems"
require "bunny"

EXCHANGE = "raw_telemetry"
QUEUE = "process_telemetry"

count ||= 0
prev_time ||= Time.now
msg_server = Bunny.new(:spec => '08')
msg_server.start

exchange = msg_server.exchange(EXCHANGE, :type  => :fanout)
msg_server.queue(QUEUE).bind(EXCHANGE)

loop do

  exchange.publish("This is my msg")

  count += 1
  if count > 100
    t = Time.now
    puts("msgs pushes per sec: #{count / (t - prev_time)}")
    prev_time = t
    count = 0
  end

end

Paolo

On Mon, Sep 7, 2009 at 11:28 PM, Aisha Fenton<aisha.fenton at gmail.com> wrote:
> Hi Chunk.
> I don't know Suhail. And his problem may be different from mine.
> To isolate the problem, I've reduce what I'm doing down to the attached code
> files. One pushes messages, the other pops them.
> I see the problem even when only test_push.rb is running (as long as the
> queue is sufficiently pre-populated). Nothing else is using rabbitmq when
> I'm doing the test.
> I'm getting the same problem on several different machines here -- my local
> MacOSX box and a server class Debian box.
>
> exchange - durable or not?
>
> not durable
>
> exchange - type? (Looks like "fanout" from the original post)
>
> fanout
>
> number of bindings per exchange
>
> 1
>
> queue ?- durable?
>
> not durable
>
> publishing settings - require ack? persistent? immediate?
>
> no ack, non persistent, and non immediate.
>
> message size? 1K according to the original post
>
> < 1K
>
>
> test_push.rb
> ---
> require "rubygems"
> require "bunny"
> EXCHANGE = "raw_telemetry"
> QUEUE = "process_telemetry"
> count ||= 0
> prev_time ||= Time.now
> msg_server = Bunny.new(:spec => '08')
> msg_server.start
> msg_server.exchange(EXCHANGE, :type ?=> :fanout)
> msg_server.queue(QUEUE).bind(EXCHANGE)
> loop do
> ??msg_server.exchange(EXCHANGE).publish("This is my msg")
>
> ??count += 1
> ??if count > 100
> ?? ?t = Time.now
> ?? ?puts("msgs pushes per sec: #{count / (t - prev_time)}")
> ?? ?prev_time = t
> ?? ?count = 0
> ??end
>
> end
> test_pop.rb
> ---
> require "rubygems"
> require "bunny"
> @msg_server = Bunny.new(:spec => '08')
> @msg_server.start
> def start
> ??count ||= 0
> ??prev_time ||= Time.now
> ??queue = @msg_server.queue("process_telemetry")
> ??loop do
> ?? ?result = queue.pop
> ?? ?next if result == :queue_empty
>
> ?? ?count += 1
> ?? ?if count > 100
> ?? ? ?t = Time.now
> ?? ? ?puts("msgs pops per sec: #{count / (t - prev_time)}")
> ?? ? ?prev_time = t
> ?? ? ?count = 0
> ?? ?end
> ??end
> end
> begin
> ??start()
> ensure
> ??puts "stopping"
> ??@msg_server.stop
> end
>
>
>
> On 8/09/2009, at 6:38 AM, Chuck Remes wrote:
>
> Are you running the same code as Aisha? Are you the same person or work
> together? I'm getting a bit confused in this thread.
> And, someone needs to start showing some code. I'm able to push hundreds of
> messages per second and never see a drop off in delivery performance
> regardless of the queue size (until I run out of memory). I don't think it
> is fair to blame rabbit until we can see your code and understand what you
> are doing.
> Also, please specify the following things:
> exchange - durable or not?
> exchange - type? (Looks like "fanout" from the original post)
> number of bindings per exchange
> queue ?- durable?
> publishing settings - require ack? persistent? immediate?
> message size? 1K according to the original post
> Is your test machine paging or swapping? What is the 'top' output for your
> process and for rabbit at various points of the run cycle? Is it lower or
> higher when you are getting 300 msg/s than when you are getting 80 msg/s?
> What is your subscriber doing with the data it receives? If you make that
> process a "no op" how many messages per second can you handle? Does it ever
> drop off related to queue size? Why are you "popping" messages from the
> queue isn't of having them pushed automatically?
> This thread has been really frustrating because there has NOT been very much
> information shared. All I see is "it's slow." Give us more information.
> cr
>
> On Sep 7, 2009, at 11:34 AM, Suhail Doshi wrote:
>
> 2009-09-07 16:33:10,822 INFO [id: 95705166] Processing complete,
> acknowledged.
> 2009-09-07 16:33:10,826 INFO [id: 95705166] Received queue item,
> processing...
> 2009-09-07 16:33:10,878 INFO [id: 95705166] Processing complete,
> acknowledged.
> 2009-09-07 16:33:10,882 INFO [id: 95705166] Received queue item,
> processing...
> 2009-09-07 16:33:12,839 INFO [id: 95705166] Processing complete,
> acknowledged.
> 2009-09-07 16:33:12,839 INFO [id: 95705166] Received queue item,
> processing...
> 2009-09-07 16:33:13,531 INFO [id: 95705166] Processing complete,
> acknowledged.
> 2009-09-07 16:33:13,531 INFO [id: 95705166] Received queue item,
> processing...
> If you see there's like a pause for a second between 10 and 12, an item gets
> processed pretty fast as you can see. Odd isn't it?
> Suhail
> On Mon, Sep 7, 2009 at 9:32 AM, Suhail Doshi <digitalwarfare at gmail.com>
> wrote:
>>
>> I almost feel as though rabbitmq can't push items to my consumer fast
>> enough, I had a backed up queue with 20 consumers and spawned another
>> watching the items get processed and it just seemed so slow, saw numerous
>> pauses between item processing and I don't believe it is the consumer's
>> fault.
>> I am using the Python library for the consumer part.
>> Suhail
>>
>> On Mon, Sep 7, 2009 at 8:23 AM, Chuck Remes <cremes.devlist at mac.com>
>> wrote:
>>>
>>> On Sep 7, 2009, at 1:07 AM, aisha fenton wrote:
>>>
>>> > Hi,
>>> > I'm sure I'm doing something wrong since I can't find reference to
>>> > this anywhere else. What I'm seeing is that the performance of
>>> > draining a queue gets slower as the queue size increases.
>>> >
>>> > I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
>>> > out of physical memory that it's performance degrades because it
>>> > starts swapping out. But I'm not anywhere close to running out of
>>> > memory yet, and the degradation starts almost immediately and
>>> > increases linearly as the queue depth grows.
>>> >
>>> > I am publishing 500mps to an exchange. Each message is about 1KB. I
>>> > have a single fanout queue bound to the exchange. A single consumer is
>>> > popping messages off the queue.
>>> >
>>> > When the queue is less than 20,000 messages I can pop 300mps off the
>>> > queue. When the queue is 200,000 messages the performance drop to
>>> > 40-80mps.
>>> >
>>> > I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or the
>>> > publisher are using more than 40% CPU.
>>> >
>>> > I assume I shouldn't be seeing this? Any help much appreciated.
>>>
>>> You didn't include any code, but I'm going to take a stab in the dark
>>> anyway. If you are using the ruby amqp gem you might be doing
>>> something like this:
>>>
>>> def next_message
>>> ? exchange = MQ.fanout 'foo'
>>> ? queue = MQ.queue 'bar'
>>>
>>> ? queue.bind exchange
>>>
>>> ? newest_message = queue.pop
>>> end
>>>
>>> In the code above the call to MQ.<whatever> is opening a new channel
>>> to rabbitmq each time the method is called. You are essentially
>>> leaking channels all over the place every time you try to pop a new
>>> message.
>>>
>>> If you aren't using the ruby amqp stuff, I still recommend checking
>>> your code for whatever library you chose. You only need to allocate a
>>> few channels and reuse them.
>>>
>>> cr
>>>
>>>
>>> _______________________________________________
>>> rabbitmq-discuss mailing list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
>>
>> --
>> http://mixpanel.com
>> Blog: http://blog.mixpanel.com
>
>
>
> --
> http://mixpanel.com
> Blog: http://blog.mixpanel.com
>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>



From celldee at gmail.com  Tue Sep  8 00:36:20 2009
From: celldee at gmail.com (Chris Duncan)
Date: Tue, 8 Sep 2009 00:36:20 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
Message-ID: <e1542d30909071636m422aa17dr468c5cc3b0302e69@mail.gmail.com>

Hi Aisha,

Hope you don't mind me butting in here.

2009/9/7 Aisha Fenton <aisha.fenton at gmail.com>

>  Hi Chunk.
> I don't know Suhail. And his problem may be different from mine.
>
>  To isolate the problem, I've reduce what I'm doing down to the attached
> code files. One pushes messages, the other pops them.
>
> I see the problem even when only test_push.rb is running (as long as the
> queue is sufficiently pre-populated). Nothing else is using rabbitmq when
> I'm doing the test.
>
> I'm getting the same problem on several different machines here -- my local
> MacOSX box and a server class Debian box.
>
>
>   exchange - durable or not?
>
> not durable
>
>  exchange - type? (Looks like "fanout" from the original post)
>
> fanout
>
>  number of bindings per exchange
>
> 1
>
>  queue  - durable?
>
> not durable
>
>  publishing settings - require ack? persistent? immediate?
>
> no ack, non persistent, and non immediate.
>
>  message size? 1K according to the original post
>
> < 1K
>
>
>
> *test_push.rb *
> *---*
>
>  *require "rubygems"*
> *require "bunny"*
> *
> *
> *EXCHANGE = "raw_telemetry"*
> *QUEUE = "process_telemetry"*
>  *
> *
> *count ||= 0*
> *prev_time ||= Time.now*
>  *msg_server = Bunny.new(:spec => '08')*
> *msg_server.start*
> *
> *
> *msg_server.exchange(EXCHANGE, :type  => :fanout)*
> *msg_server.queue(QUEUE).bind(EXCHANGE)*
> *
> *
> *loop do*
> *
> *
> *  msg_server.exchange(EXCHANGE).publish("This is my msg")*
>  *  *
> *  count += 1*
> *  if count > 100*
> *    t = Time.now*
> *    puts("msgs pushes per sec: #{count / (t - prev_time)}")*
>  *    prev_time = t*
> *    count = 0*
> *  end*
> *    *
> *end*
> *
> *
> * test_pop.rb
> ---
>
> *
> * require "rubygems"
> require "bunny"
>
> @msg_server = Bunny.new(:spec => '08')
> @msg_server.start
>
> def start
>   count ||= 0
>   prev_time ||= Time.now
>   queue = @msg_server.queue("process_telemetry")
>
>    loop do
>     result = queue.pop
>     next if result == :queue_empty
>
>     count += 1
>     if count > 100
>       t = Time.now
>       puts("msgs pops per sec: #{count / (t - prev_time)}")
>       prev_time = t
>       count = 0
>     end
>   end
>
> end
>
> begin
>   start()
> ensure
>   puts "stopping"
>   @msg_server.stop
> end
> *
>

I have some observations -

1. In your test_push.rb you have the line -

*msg_server.exchange(EXCHANGE).publish("This is my msg")*
**
The exchange method declares an exchange, so you are doing this every time
you publish a message which will slow things down. Declare the exchange
using a variable outside the loop like this -

*my_exchange = msg_server.exchange(EXCHANGE, :type  => :fanout)*
**
Then use the variable inside the loop -
**
*my_exchange.publish("This is my msg")*
**
I think Paolo has highlighted the same thing.

2. In your test_pop.rb you don't need to specify *:spec => '08'.* Bunny.new
defaults to the AMQP 0-8 spec version.

Also, do you mean to have -

*next if result == :queue_empty*
**
How are you breaking out of the loop? Might you want to use 'break' instead
of 'next'?

3. A Bunny instance only ever uses 2 channels unless you explicitly create
more. Since you don't seem to be creating more channels I don't think that's
where your issue lies.

-- 
Regards

Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/ec5effd0/attachment.htm 

From aisha.fenton at gmail.com  Tue Sep  8 02:37:31 2009
From: aisha.fenton at gmail.com (Aisha Fenton)
Date: Tue, 8 Sep 2009 13:37:31 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <e1542d30909071636m422aa17dr468c5cc3b0302e69@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<e1542d30909071636m422aa17dr468c5cc3b0302e69@mail.gmail.com>
Message-ID: <6E12DD80-4688-456F-9FAF-CC5994C79F05@gmail.com>

Go for it Chris

On 8/09/2009, at 11:36 AM, Chris Duncan wrote:

> Hi Aisha,
>
> Hope you don't mind me butting in here.
>
> 2009/9/7 Aisha Fenton <aisha.fenton at gmail.com>
> Hi Chunk.
> I don't know Suhail. And his problem may be different from mine.
>
> To isolate the problem, I've reduce what I'm doing down to the  
> attached code files. One pushes messages, the other pops them.
>
> I see the problem even when only test_push.rb is running (as long as  
> the queue is sufficiently pre-populated). Nothing else is using  
> rabbitmq when I'm doing the test.
>
> I'm getting the same problem on several different machines here --  
> my local MacOSX box and a server class Debian box.
>
>
>> exchange - durable or not?
> not durable
>
>> exchange - type? (Looks like "fanout" from the original post)
>
> fanout
>
>> number of bindings per exchange
>
> 1
>
>> queue  - durable?
> not durable
>
>> publishing settings - require ack? persistent? immediate?
>
> no ack, non persistent, and non immediate.
>
>> message size? 1K according to the original post
>
> < 1K
>
>
>
> test_push.rb
> ---
>
> require "rubygems"
> require "bunny"
>
> EXCHANGE = "raw_telemetry"
> QUEUE = "process_telemetry"
>
> count ||= 0
> prev_time ||= Time.now
> msg_server = Bunny.new(:spec => '08')
> msg_server.start
>
> msg_server.exchange(EXCHANGE, :type  => :fanout)
> msg_server.queue(QUEUE).bind(EXCHANGE)
>
> loop do
>
>   msg_server.exchange(EXCHANGE).publish("This is my msg")
>
>   count += 1
>   if count > 100
>     t = Time.now
>     puts("msgs pushes per sec: #{count / (t - prev_time)}")
>     prev_time = t
>     count = 0
>   end
>
> end
>
> test_pop.rb
> ---
>
> require "rubygems"
> require "bunny"
>
> @msg_server = Bunny.new(:spec => '08')
> @msg_server.start
>
> def start
>   count ||= 0
>   prev_time ||= Time.now
>   queue = @msg_server.queue("process_telemetry")
>
>   loop do
>     result = queue.pop
>     next if result == :queue_empty
>
>     count += 1
>     if count > 100
>       t = Time.now
>       puts("msgs pops per sec: #{count / (t - prev_time)}")
>       prev_time = t
>       count = 0
>     end
>   end
>
> end
>
> begin
>   start()
> ensure
>   puts "stopping"
>   @msg_server.stop
> end
>
>
> I have some observations -
>
> 1. In your test_push.rb you have the line -
>
> msg_server.exchange(EXCHANGE).publish("This is my msg")
>
> The exchange method declares an exchange, so you are doing this  
> every time you publish a message which will slow things down.  
> Declare the exchange using a variable outside the loop like this -
>
> my_exchange = msg_server.exchange(EXCHANGE, :type  => :fanout)
>
> Then use the variable inside the loop -
>
> my_exchange.publish("This is my msg")
>
> I think Paolo has highlighted the same thing.
>
> 2. In your test_pop.rb you don't need to specify :spec => '08'.  
> Bunny.new defaults to the AMQP 0-8 spec version.
>
> Also, do you mean to have -
>
> next if result == :queue_empty
>
> How are you breaking out of the loop? Might you want to use 'break'  
> instead of 'next'?
>
> 3. A Bunny instance only ever uses 2 channels unless you explicitly  
> create more. Since you don't seem to be creating more channels I  
> don't think that's where your issue lies.
>
> -- 
> Regards
>
> Chris

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/f9c4ea0e/attachment.htm 

From aisha.fenton at gmail.com  Tue Sep  8 02:48:17 2009
From: aisha.fenton at gmail.com (Aisha Fenton)
Date: Tue, 8 Sep 2009 13:48:17 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <4cf112580909071523y23889f72i39d7e54547bc089d@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<4cf112580909071523y23889f72i39d7e54547bc089d@mail.gmail.com>
Message-ID: <E99C12C3-83EC-41B9-B2D1-B639F30133B1@gmail.com>

Hi Paolo,

> the code provided for the publisher actually does seem likely to
> produce the channel leak

I made the suggested change, and it made no difference.

I have changed the test code to use tmm1-amqp (another Ruby AMQP  
library) and I'm now getting 2000mps, and no degradation on deep queues.
So, for me at least, problem solved!

Chris (author of Bunny I believe?), maybe you can shed some light on  
something I'm doing wrong with how I'm using Bunny?

Ash




From cremes.devlist at mac.com  Tue Sep  8 02:53:41 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Mon, 07 Sep 2009 20:53:41 -0500
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <E99C12C3-83EC-41B9-B2D1-B639F30133B1@gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<4cf112580909071523y23889f72i39d7e54547bc089d@mail.gmail.com>
	<E99C12C3-83EC-41B9-B2D1-B639F30133B1@gmail.com>
Message-ID: <433AB25D-4AA1-4F24-9F21-89FC1BD7A121@mac.com>

Progress! Please share the code you are using now so we can compare it  
to the bunny code. Perhaps something obvious will jump out at us  
(punny!).

cr

On Sep 7, 2009, at 8:48 PM, Aisha Fenton wrote:

> Hi Paolo,
>
>> the code provided for the publisher actually does seem likely to
>> produce the channel leak
>
> I made the suggested change, and it made no difference.
>
> I have changed the test code to use tmm1-amqp (another Ruby AMQP  
> library) and I'm now getting 2000mps, and no degradation on deep  
> queues.
> So, for me at least, problem solved!
>
> Chris (author of Bunny I believe?), maybe you can shed some light on  
> something I'm doing wrong with how I'm using Bunny?
>
> Ash
>




From aisha.fenton at gmail.com  Tue Sep  8 03:18:50 2009
From: aisha.fenton at gmail.com (Aisha Fenton)
Date: Tue, 8 Sep 2009 14:18:50 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <433AB25D-4AA1-4F24-9F21-89FC1BD7A121@mac.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<4cf112580909071523y23889f72i39d7e54547bc089d@mail.gmail.com>
	<E99C12C3-83EC-41B9-B2D1-B639F30133B1@gmail.com>
	<433AB25D-4AA1-4F24-9F21-89FC1BD7A121@mac.com>
Message-ID: <043F26FE-6E08-48A0-B5FE-36F34231A13C@gmail.com>

Code below uses tmm1-amqp instead of Bunny. I get 2000mps using this  
code, draining from the same queue.


test_pop_async.rb
---

require "rubygems"
require 'mq'

Signal.trap('INT') { AMQP.stop{ EM.stop } }
Signal.trap('TERM'){ AMQP.stop{ EM.stop } }

count ||= 0
prev_time ||= Time.now

AMQP.start(:host => 'localhost') do
   MQ.queue('process_telemetry').subscribe(:ack => false) do |headers,  
body|
     count += 1
     if count > 100
       t = Time.now
       puts("msgs pops per sec: #{count / (t - prev_time)}")
       prev_time = t
       count = 0
     end
   end
end



On 8/09/2009, at 1:53 PM, Chuck Remes wrote:

> Progress! Please share the code you are using now so we can compare  
> it to the bunny code. Perhaps something obvious will jump out at us  
> (punny!).
>
> cr
>
> On Sep 7, 2009, at 8:48 PM, Aisha Fenton wrote:
>
>> Hi Paolo,
>>
>>> the code provided for the publisher actually does seem likely to
>>> produce the channel leak
>>
>> I made the suggested change, and it made no difference.
>>
>> I have changed the test code to use tmm1-amqp (another Ruby AMQP  
>> library) and I'm now getting 2000mps, and no degradation on deep  
>> queues.
>> So, for me at least, problem solved!
>>
>> Chris (author of Bunny I believe?), maybe you can shed some light  
>> on something I'm doing wrong with how I'm using Bunny?
>>
>> Ash
>>
>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/e642a65d/attachment.htm 

From celldee at gmail.com  Tue Sep  8 04:09:51 2009
From: celldee at gmail.com (celldee)
Date: Mon, 7 Sep 2009 20:09:51 -0700 (PDT)
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <043F26FE-6E08-48A0-B5FE-36F34231A13C@gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com> 
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com> 
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com> 
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com> 
	<4cf112580909071523y23889f72i39d7e54547bc089d@mail.gmail.com> 
	<E99C12C3-83EC-41B9-B2D1-B639F30133B1@gmail.com>
	<433AB25D-4AA1-4F24-9F21-89FC1BD7A121@mac.com> 
	<043F26FE-6E08-48A0-B5FE-36F34231A13C@gmail.com>
Message-ID: <2431f5ce-606e-45f3-a2cd-60e0feb539bb@a21g2000yqc.googlegroups.com>

Hi Aisha,

One difference is that you're using the subscribe method with tmm1-
amqp. What happens if you use the pop method? Also what happens if you
use the subscribe method in Bunny?

Regards,

Chris

On Sep 8, 3:18?am, Aisha Fenton <aisha.fen... at gmail.com> wrote:
> Code below uses tmm1-amqp instead of Bunny. I get 2000mps using this ?
> code, draining from the same queue.
>
> test_pop_async.rb
> ---
>
> require "rubygems"
> require 'mq'
>
> Signal.trap('INT') { AMQP.stop{ EM.stop } }
> Signal.trap('TERM'){ AMQP.stop{ EM.stop } }
>
> count ||= 0
> prev_time ||= Time.now
>
> AMQP.start(:host => 'localhost') do
> ? ?MQ.queue('process_telemetry').subscribe(:ack => false) do |headers, ?
> body|
> ? ? ?count += 1
> ? ? ?if count > 100
> ? ? ? ?t = Time.now
> ? ? ? ?puts("msgs pops per sec: #{count / (t - prev_time)}")
> ? ? ? ?prev_time = t
> ? ? ? ?count = 0
> ? ? ?end
> ? ?end
> end
>
> On 8/09/2009, at 1:53 PM, Chuck Remes wrote:
>
>
>
> > Progress! Please share the code you are using now so we can compare ?
> > it to the bunny code. Perhaps something obvious will jump out at us ?
> > (punny!).
>
> > cr
>
> > On Sep 7, 2009, at 8:48 PM, Aisha Fenton wrote:
>
> >> Hi Paolo,
>
> >>> the code provided for the publisher actually does seem likely to
> >>> produce the channel leak
>
> >> I made the suggested change, and it made no difference.
>
> >> I have changed the test code to use tmm1-amqp (another Ruby AMQP ?
> >> library) and I'm now getting 2000mps, and no degradation on deep ?
> >> queues.
> >> So, for me at least, problem solved!
>
> >> Chris (author of Bunny I believe?), maybe you can shed some light ?
> >> on something I'm doing wrong with how I'm using Bunny?
>
> >> Ash
>
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttp://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss- Hide quoted text -
>
> - Show quoted text -



From aniruddh.narayan at yahoo.co.in  Tue Sep  8 05:44:06 2009
From: aniruddh.narayan at yahoo.co.in (aniruddh narayan)
Date: Tue, 8 Sep 2009 10:14:06 +0530 (IST)
Subject: [rabbitmq-discuss] java client library
Message-ID: <48190.76978.qm@web95201.mail.in2.yahoo.com>

Hi
I copied the file "Helloserver.java " from the?
C:\rabbitmq-java-client-1.6.0\test\src\com\rabbitmq\examples onto my c
drive and i am able to compile the file and two class file
HelloServer.class and HelloServer$1.class file are created in my c
drive......but as soon as i run it with the command..


C:\>javac HelloServer.java

C:\>java HelloServer
Exception in thread "main" java.lang.NoClassDefFoundError: HelloServer

also i tried running it with the command:
java com.rabbitmq.examples.Helloserver
but the problem continues .......

also i checked out my version of java......its 1.5.0_09....is this the
 hitch???
thanks
aniruddh



      See the Web&#39;s breaking stories, chosen by people like you. Check out Yahoo! Buzz. http://in.buzz.yahoo.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/c60adaaa/attachment.htm 

From matthias at lshift.net  Tue Sep  8 06:00:49 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 08 Sep 2009 06:00:49 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
 depth
In-Reply-To: <e1542d30909071636m422aa17dr468c5cc3b0302e69@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<e1542d30909071636m422aa17dr468c5cc3b0302e69@mail.gmail.com>
Message-ID: <4AA5E501.9000603@lshift.net>

Aisha, Chris,

Chris Duncan wrote:
> 1. In your test_push.rb you have the line -
> 
> /msg_server.exchange(EXCHANGE).publish("This is my msg")/ // The 
> exchange method declares an exchange, so you are doing this every 
> time you publish a message

I've run Aisha's original test_push.rb code through the tracer
(http://www.rabbitmq.com/examples.html#tracer), and can see only *one*
exchange.declare, right at the beginning. So that's not the problem.

Aisha Fenton wrote:
> Code below uses tmm1-amqp instead of Bunny. I get 2000mps using this
> code, draining from the same queue.

As Chris mentioned in his response, this uses a subscription, which is a 
much more efficient way of retrieving messages than basic.get. Also, on 
the publishing side, test_push.rb comes nowhere close to maxing out 
rabbit - I guess ruby is simply too slow for that ;)

Back to your original query though ...

> To isolate the problem, I've reduce what I'm doing down to the
> attached code files. One pushes messages, the other pops them.

I ran the tests and got the following results:

- 20k messages: 500Hz, with beam.smp using 30% of the CPU

- 200k messages: 300Hz, with beam.smp using 45% of the CPU - that kind 
of slowdown is not totally unexpected and probably due to the increased 
cost of gc and the nature of the queue data structure we are using,

- 200k messages: 35Hz, with beam.smp using 95% of the CPU - yes, that's 
right, the same test as the previous one but only 1/9th of the throughput!

So there is definitely something odd going on here.

Digging a little deeper, I think the observed behaviour may have to do 
with Erlang process hibernation. I consistently get the slower result 
when I start consuming after the queue process has gone into 
hibernation, which happens after about one second of idleness. By 
contrast, if I start consuming straight away, without the process 
hibernating first, I consistently get the higher rate.

I have filed a bug to investigate this further.


Regards,

Matthias.



From celldee at gmail.com  Tue Sep  8 06:10:03 2009
From: celldee at gmail.com (Chris Duncan)
Date: Tue, 8 Sep 2009 06:10:03 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <4AA5E501.9000603@lshift.net>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<e1542d30909071636m422aa17dr468c5cc3b0302e69@mail.gmail.com>
	<4AA5E501.9000603@lshift.net>
Message-ID: <1DFE6CB6-88A2-408E-A993-1AAE94FED796@gmail.com>

Thanks for the feedback Matthias.

On 8 Sep 2009, at 06:00, Matthias Radestock wrote:

> Aisha, Chris,
>
> Chris Duncan wrote:
>> 1. In your test_push.rb you have the line -
>> /msg_server.exchange(EXCHANGE).publish("This is my msg")/ // The  
>> exchange method declares an exchange, so you are doing this every  
>> time you publish a message
>
> I've run Aisha's original test_push.rb code through the tracer
> (http://www.rabbitmq.com/examples.html#tracer), and can see only *one*
> exchange.declare, right at the beginning. So that's not the problem.

Yes. I forgot that the exchange will be cached when it's declared, so  
one declare is all you'll get.

Regards,

Chris




From pauljones23 at gmail.com  Tue Sep  8 06:12:50 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 8 Sep 2009 06:12:50 +0100
Subject: [rabbitmq-discuss] java client library
In-Reply-To: <48190.76978.qm@web95201.mail.in2.yahoo.com>
References: <48190.76978.qm@web95201.mail.in2.yahoo.com>
Message-ID: <29598b610909072212p15c68738y2acff3180fbbe354@mail.gmail.com>

Aniruddh,

Your second version has a lower-case s in server. Is that a mis-type in the
email, or is that the problem in the command?

Your version of Java should be adequate.

Paul.

On Tue, Sep 8, 2009 at 5:44 AM, aniruddh narayan <
aniruddh.narayan at yahoo.co.in> wrote:

> Hi
> I copied the file "Helloserver.java " from the
> C:\rabbitmq-java-client-1.6.0\test\src\com\rabbitmq\examples onto my c drive
> and i am able to compile the file and two class file HelloServer.class and
> HelloServer$1.class file are created in my c drive......but as soon as i run
> it with the command..
>
>
> C:\>javac HelloServer.java
>
> C:\>java HelloServer
> Exception in thread "main" java.lang.NoClassDefFoundError: HelloServer
>
> also i tried running it with the command:
> java com.rabbitmq.examples.Helloserver
> but the problem continues .......
>
> also i checked out my version of java......its 1.5.0_09....is this the
> hitch???
> thanks
> aniruddh
>
> ------------------------------
> Love Cricket? Check out live scores, photos, video highlights and more. Click
> here <http://in.rd.yahoo.com/tagline_cricket_2/*http://cricket.yahoo.com>.
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/fc2895a2/attachment.htm 

From pauljones23 at gmail.com  Tue Sep  8 06:13:26 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 8 Sep 2009 06:13:26 +0100
Subject: [rabbitmq-discuss] java client library
In-Reply-To: <29598b610909072212p15c68738y2acff3180fbbe354@mail.gmail.com>
References: <48190.76978.qm@web95201.mail.in2.yahoo.com>
	<29598b610909072212p15c68738y2acff3180fbbe354@mail.gmail.com>
Message-ID: <29598b610909072213q2b95e979lb7dc9fe9f506635d@mail.gmail.com>

Also, have you added the current directory (.) to the classpath? Without
this, Java won't search for your class files.

On Tue, Sep 8, 2009 at 6:12 AM, Paul Jones <pauljones23 at gmail.com> wrote:

> Aniruddh,
>
> Your second version has a lower-case s in server. Is that a mis-type in the
> email, or is that the problem in the command?
>
> Your version of Java should be adequate.
>
> Paul.
>
> On Tue, Sep 8, 2009 at 5:44 AM, aniruddh narayan <
> aniruddh.narayan at yahoo.co.in> wrote:
>
>>  Hi
>> I copied the file "Helloserver.java " from the
>> C:\rabbitmq-java-client-1.6.0\test\src\com\rabbitmq\examples onto my c drive
>> and i am able to compile the file and two class file HelloServer.class and
>> HelloServer$1.class file are created in my c drive......but as soon as i run
>> it with the command..
>>
>>
>> C:\>javac HelloServer.java
>>
>> C:\>java HelloServer
>> Exception in thread "main" java.lang.NoClassDefFoundError: HelloServer
>>
>> also i tried running it with the command:
>> java com.rabbitmq.examples.Helloserver
>> but the problem continues .......
>>
>> also i checked out my version of java......its 1.5.0_09....is this the
>> hitch???
>> thanks
>> aniruddh
>>
>> ------------------------------
>> Love Cricket? Check out live scores, photos, video highlights and more. Click
>> here <http://in.rd.yahoo.com/tagline_cricket_2/*http://cricket.yahoo.com>
>> .
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/e23ae9a3/attachment.htm 

From aniruddh.narayan at yahoo.co.in  Tue Sep  8 06:26:09 2009
From: aniruddh.narayan at yahoo.co.in (aniruddh narayan)
Date: Tue, 8 Sep 2009 10:56:09 +0530 (IST)
Subject: [rabbitmq-discuss] re java client error
Message-ID: <100165.48905.qm@web95207.mail.in2.yahoo.com>

Hi paul..the previous was a typo error....anyway included the (.) current directory to the classpath.....but in vain....following is the output

C:\>javac HelloServer.java
C:\>java HelloServerException in thread "main" java.lang.NoClassDefFoundError: HelloServer (wrong name: com/rabbitmq/examples/HelloServer)?? ? ? ?at java.lang.ClassLoader.defineClass1(Native Method)?? ? ? ?at java.lang.ClassLoader.defineClass(ClassLoader.java:620)?? ? ? ?at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)?? ? ? ?at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)?? ? ? ?at java.net.URLClassLoader.access$100(URLClassLoader.java:56)?? ? ? ?at java.net.URLClassLoader$1.run(URLClassLoader.java:195)?? ? ? ?at java.security.AccessController.doPrivileged(Native Method)?? ? ? ?at java.net.URLClassLoader.findClass(URLClassLoader.java:188)?? ? ? ?at java.lang.ClassLoader.loadClass(ClassLoader.java:306)?? ? ? ?at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)?? ? ? ?at java.lang.ClassLoader.loadClass(ClassLoader.java:251)?? ? ? ?at
 java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
C:\>java com.rabbitmq.examples.HelloServerException in thread "main" java.lang.NoClassDefFoundError: com/rabbitmq/examples/HelloServer
Ani

























      See the Web&#39;s breaking stories, chosen by people like you. Check out Yahoo! Buzz. http://in.buzz.yahoo.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/154775dc/attachment.htm 

From pauljones23 at gmail.com  Tue Sep  8 06:52:03 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 8 Sep 2009 06:52:03 +0100
Subject: [rabbitmq-discuss] re java client error
In-Reply-To: <100165.48905.qm@web95207.mail.in2.yahoo.com>
References: <100165.48905.qm@web95207.mail.in2.yahoo.com>
Message-ID: <29598b610909072252s52a0400eu344230138019a8a6@mail.gmail.com>

Aniruddh,

Ok. So the wrong name message means that you compiled the HelloServer
example slightly wrong. Perhaps the quickest thing to do would be to change
the source file, and remove the package declaration at the top. Then, if you
recompile, java HelloServer should work just fine.

Have you considered my suggestion about an IDE? Given the trouble it takes
just to get single class files to work, I'm sure you can see how troublesome
it could be to try to get something more complicated to work. An IDE also
gives you the ability to debug the code, and step through it as it does its
thing.

Also, would you be able to reply to emails instead of starting new threads?
In threaded mail readers (such as gmail), this conversation keeps coming in
as new mail conversations.

Thanks,
Paul.

On Tue, Sep 8, 2009 at 6:26 AM, aniruddh narayan <
aniruddh.narayan at yahoo.co.in> wrote:

> Hi paul..the previous was a typo error....anyway included the (.) current
> directory to the classpath.....but in vain....following is the output
>
> C:\>javac HelloServer.java
>
> C:\>java HelloServer
> Exception in thread "main" java.lang.NoClassDefFoundError: HelloServer
> (wrong na
> me: com/rabbitmq/examples/HelloServer)
>         at java.lang.ClassLoader.defineClass1(Native Method)
>         at java.lang.ClassLoader.defineClass(ClassLoader.java:620)
>         at
> java.security.SecureClassLoader.defineClass(SecureClassLoader.java:12
> 4)
>         at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)
>         at java.net.URLClassLoader.access$100(URLClassLoader.java:56)
>         at java.net.URLClassLoader$1.run(URLClassLoader.java:195)
>         at java.security.AccessController.doPrivileged(Native Method)
>         at java.net.URLClassLoader.findClass(URLClassLoader.java:188)
>         at java.lang.ClassLoader.loadClass(ClassLoader.java:306)
>         at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)
>         at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
>         at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
>
> C:\>java com.rabbitmq.examples.HelloServer
> Exception in thread "main" java.lang.NoClassDefFoundError:
> com/rabbitmq/examples
> /HelloServer
>
> Ani
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
> ------------------------------
> Love Cricket? Check out live scores, photos, video highlights and more. Click
> here <http://in.rd.yahoo.com/tagline_cricket_2/*http://cricket.yahoo.com>.
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/f07437b1/attachment.htm 

From aniruddh.narayan at yahoo.co.in  Tue Sep  8 07:40:52 2009
From: aniruddh.narayan at yahoo.co.in (aniruddh narayan)
Date: Tue, 8 Sep 2009 12:10:52 +0530 (IST)
Subject: [rabbitmq-discuss] re java client error
In-Reply-To: <29598b610909072252s52a0400eu344230138019a8a6@mail.gmail.com>
Message-ID: <502328.85238.qm@web95202.mail.in2.yahoo.com>

HI paul..as u told i canged the source file ie(HelloServer.java) to my present working directory C:\ ,Also deleted the package com.rabbitmq.examples;...the file is compiling fine and a .class file is being produced (but thing as they are not supposed to work ver easily...[:)])..the following error is displayed when trying to run the file

C:\>javac HelloServer.java
C:\>java HelloServerMain thread caught exception: java.io.IOExceptionjava.io.IOException?? ? ? ?at com.rabbitmq.client.impl.AMQChannel.wrap(AMQChannel.java:121)?? ? ? ?at com.rabbitmq.client.impl.AMQConnection.open(AMQConnection.java:363)?? ? ? ?at com.rabbitmq.client.impl.AMQConnection.<init>(AMQConnection.java:208)
?? ? ? ?at com.rabbitmq.client.impl.AMQConnection.<init>(AMQConnection.java:178)
?? ? ? ?at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:165)?? ? ? ?at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:213)?? ? ? ?at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:227)?? ? ? ?at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:238)?? ? ? ?at HelloServer.main(HelloServer.java:45)Caused by: com.rabbitmq.client.ShutdownSignalException: connection error; reason: java.lang.NoClassDefFoundError: org/apache/commons/io/input/ProxyInputStream?? ? ? ?at com.rabbitmq.client.impl.AMQConnection.shutdown(AMQConnection.java:599)?? ? ? ?at com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:465)Caused by: java.lang.NoClassDefFoundError: org/apache/commons/io/input/ProxyInputStream?? ? ? ?at java.lang.ClassLoader.defineClass1(Native Method)?? ? ? ?at
 java.lang.ClassLoader.defineClass(ClassLoader.java:620)?? ? ? ?at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)?? ? ? ?at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)?? ? ? ?at java.net.URLClassLoader.access$100(URLClassLoader.java:56)?? ? ? ?at java.net.URLClassLoader$1.run(URLClassLoader.java:195)?? ? ? ?at java.security.AccessController.doPrivileged(Native Method)?? ? ? ?at java.net.URLClassLoader.findClass(URLClassLoader.java:188)?? ? ? ?at java.lang.ClassLoader.loadClass(ClassLoader.java:306)?? ? ? ?at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)?? ? ? ?at java.lang.ClassLoader.loadClass(ClassLoader.java:251)?? ? ? ?at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)?? ? ? ?at com.rabbitmq.client.impl.MethodArgumentReader.<init>(MethodArgumentReader.java:70)?? ? ? ?at
 com.rabbitmq.client.impl.AMQImpl.readMethodFrom(AMQImpl.java:5710)?? ? ? ?at com.rabbitmq.client.impl.AMQCommand$Assembler.handleFrame(AMQCommand.java:275)?? ? ? ?at com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:107)?? ? ? ?at com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:439)
....also my server is running fine and showing the message "broker running"....

--- On Tue, 8/9/09, Paul Jones <pauljones23 at gmail.com> wrote:

From: Paul Jones <pauljones23 at gmail.com>
Subject: Re: [rabbitmq-discuss] re java client error
To: "aniruddh narayan" <aniruddh.narayan at yahoo.co.in>
Cc: rabbitmq-discuss at lists.rabbitmq.com
Date: Tuesday, 8 September, 2009, 11:22 AM

Aniruddh,

Ok. So the wrong name message means that you compiled the HelloServer example slightly wrong. Perhaps the quickest thing to do would be to change the source file, and remove the package declaration at the top. Then, if you recompile, java HelloServer should work just fine.


Have you considered my suggestion about an IDE? Given the trouble it takes just to get single class files to work, I'm sure you can see how troublesome it could be to try to get something more complicated to work. An IDE also gives you the ability to debug the code, and step through it as it does its thing.


Also, would you be able to reply to emails instead of starting new threads? In threaded mail readers (such as gmail), this conversation keeps coming in as new mail conversations.

Thanks,
Paul.


On Tue, Sep 8, 2009 at 6:26 AM, aniruddh narayan <aniruddh.narayan at yahoo.co.in> wrote:


Hi paul..the previous was a typo error....anyway included the (.) current directory to the classpath.....but in vain....following is the output

C:\>javac HelloServer.java

C:\>java HelloServerException in thread "main" java.lang.NoClassDefFoundError: HelloServer (wrong name: com/rabbitmq/examples/HelloServer)?? ? ? ?at java.lang.ClassLoader.defineClass1(Native Method)
?? ? ? ?at java.lang.ClassLoader.defineClass(ClassLoader.java:620)?? ? ? ?at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)?? ? ? ?at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)
?? ? ?
 ?at java.net.URLClassLoader.access$100(URLClassLoader.java:56)?? ? ? ?at java.net.URLClassLoader$1.run(URLClassLoader.java:195)?? ? ? ?at java.security.AccessController.doPrivileged(Native Method)
?? ? ? ?at java.net.URLClassLoader.findClass(URLClassLoader.java:188)?? ? ? ?at java.lang.ClassLoader.loadClass(ClassLoader.java:306)?? ? ? ?at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)
?? ? ? ?at java.lang.ClassLoader.loadClass(ClassLoader.java:251)?? ? ? ?at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
C:\>java com.rabbitmq.examples.HelloServer
Exception in thread "main" java.lang.NoClassDefFoundError:
 com/rabbitmq/examples/HelloServer
Ani





      See the Web&#39;s breaking stories, chosen by people like you. Check out Yahoo! Buzz. http://in.buzz.yahoo.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/1c735cef/attachment.htm 

From pauljones23 at gmail.com  Tue Sep  8 08:09:45 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 8 Sep 2009 08:09:45 +0100
Subject: [rabbitmq-discuss] re java client error
In-Reply-To: <502328.85238.qm@web95202.mail.in2.yahoo.com>
References: <29598b610909072252s52a0400eu344230138019a8a6@mail.gmail.com>
	<502328.85238.qm@web95202.mail.in2.yahoo.com>
Message-ID: <29598b610909080009x41e75826s45c027a42f9e0c60@mail.gmail.com>

Aniruddh,

You haven't included commons-io in your classpath.

Paul.

On Tue, Sep 8, 2009 at 7:40 AM, aniruddh narayan <
aniruddh.narayan at yahoo.co.in> wrote:

> HI paul..as u told i canged the source file ie(HelloServer.java) to my
> present working directory C:\ ,Also deleted the package
> com.rabbitmq.examples;...the file is compiling fine and a .class file is
> being produced (but thing as they are not supposed to work ver
> easily...[:)])..the following error is displayed when trying to run the file
>
>
> C:\>javac HelloServer.java
>
> C:\>java HelloServer
> Main thread caught exception: java.io.IOException
> java.io.IOException
>         at com.rabbitmq.client.impl.AMQChannel.wrap(AMQChannel.java:121)
>         at
> com.rabbitmq.client.impl.AMQConnection.open(AMQConnection.java:363)
>         at
> com.rabbitmq.client.impl.AMQConnection.<init>(AMQConnection.java:208)
>
>         at
> com.rabbitmq.client.impl.AMQConnection.<init>(AMQConnection.java:178)
>
>         at
> com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory
> .java:165)
>         at
> com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory
> .java:213)
>         at
> com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory
> .java:227)
>         at
> com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory
> .java:238)
>         at HelloServer.main(HelloServer.java:45)
> Caused by: com.rabbitmq.client.ShutdownSignalException: connection error;
> reason
> : java.lang.NoClassDefFoundError:
> org/apache/commons/io/input/ProxyInputStream
>         at
> com.rabbitmq.client.impl.AMQConnection.shutdown(AMQConnection.java:59
> 9)
>         at
> com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.jav
> a:465)
> Caused by: java.lang.NoClassDefFoundError:
> org/apache/commons/io/input/ProxyInpu
> tStream
>         at java.lang.ClassLoader.defineClass1(Native Method)
>         at java.lang.ClassLoader.defineClass(ClassLoader.java:620)
>         at
> java.security.SecureClassLoader.defineClass(SecureClassLoader.java:12
> 4)
>         at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)
>         at java.net.URLClassLoader.access$100(URLClassLoader.java:56)
>         at java.net.URLClassLoader$1.run(URLClassLoader.java:195)
>         at java.security.AccessController.doPrivileged(Native Method)
>         at java.net.URLClassLoader.findClass(URLClassLoader.java:188)
>         at java.lang.ClassLoader.loadClass(ClassLoader.java:306)
>         at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)
>         at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
>         at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
>         at
> com.rabbitmq.client.impl.MethodArgumentReader.<init>(MethodArgumentRe
> ader.java:70)
>         at
> com.rabbitmq.client.impl.AMQImpl.readMethodFrom(AMQImpl.java:5710)
>         at
> com.rabbitmq.client.impl.AMQCommand$Assembler.handleFrame(AMQCommand.
> java:275)
>         at
> com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:107)
>         at
> com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.jav
> a:439)
>
> ....also my server is running fine and showing the message "broker
> running"....
>
>
> --- On *Tue, 8/9/09, Paul Jones <pauljones23 at gmail.com>* wrote:
>
>
> From: Paul Jones <pauljones23 at gmail.com>
> Subject: Re: [rabbitmq-discuss] re java client error
> To: "aniruddh narayan" <aniruddh.narayan at yahoo.co.in>
> Cc: rabbitmq-discuss at lists.rabbitmq.com
> Date: Tuesday, 8 September, 2009, 11:22 AM
>
>
> Aniruddh,
>
> Ok. So the wrong name message means that you compiled the HelloServer
> example slightly wrong. Perhaps the quickest thing to do would be to change
> the source file, and remove the package declaration at the top. Then, if you
> recompile, java HelloServer should work just fine.
>
> Have you considered my suggestion about an IDE? Given the trouble it takes
> just to get single class files to work, I'm sure you can see how troublesome
> it could be to try to get something more complicated to work. An IDE also
> gives you the ability to debug the code, and step through it as it does its
> thing.
>
> Also, would you be able to reply to emails instead of starting new threads?
> In threaded mail readers (such as gmail), this conversation keeps coming in
> as new mail conversations.
>
> Thanks,
> Paul.
>
> On Tue, Sep 8, 2009 at 6:26 AM, aniruddh narayan <
> aniruddh.narayan at yahoo.co.in<http://mc/compose?to=aniruddh.narayan at yahoo.co.in>
> > wrote:
>
>>  Hi paul..the previous was a typo error....anyway included the (.) current
>> directory to the classpath.....but in vain....following is the output
>>
>> C:\>javac HelloServer.java
>>
>> C:\>java HelloServer
>> Exception in thread "main" java.lang.NoClassDefFoundError: HelloServer
>> (wrong na
>> me: com/rabbitmq/examples/HelloServer)
>>         at java.lang.ClassLoader.defineClass1(Native Method)
>>         at java.lang.ClassLoader.defineClass(ClassLoader.java:620)
>>         at
>> java.security.SecureClassLoader.defineClass(SecureClassLoader.java:12
>> 4)
>>         at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)
>>         at java.net.URLClassLoader.access$100(URLClassLoader.java:56)
>>         at java.net.URLClassLoader$1.run(URLClassLoader.java:195)
>>         at java.security.AccessController.doPrivileged(Native Method)
>>         at java.net.URLClassLoader.findClass(URLClassLoader.java:188)
>>         at java.lang.ClassLoader.loadClass(ClassLoader.java:306)
>>         at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)
>>         at java.lang.ClassLoader.loadClass(ClassLoader.java:251)
>>         at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)
>>
>> C:\>java com.rabbitmq.examples.HelloServer
>> Exception in thread "main" java.lang.NoClassDefFoundError:
>> com/rabbitmq/examples
>> /HelloServer
>>
>> Ani
>>
>>
>>
> ------------------------------
> See the Web's breaking stories, chosen by people like you. Check out Yahoo!
> Buzz <http://in.rd.yahoo.com/tagline_buzz_1/*http://in.buzz.yahoo.com/>.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/b9bfebd1/attachment.htm 

From 0x6e6562 at gmail.com  Tue Sep  8 14:33:05 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 8 Sep 2009 14:33:05 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <506C64DD-BFB1-437A-9C1B-ECFB8CF3A211@gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<506C64DD-BFB1-437A-9C1B-ECFB8CF3A211@gmail.com>
Message-ID: <269388e30909080633ie5c92fjb3817da63e4e827e@mail.gmail.com>

Aisha,

Not wanting to hijack this thread another time, but....

On Mon, Sep 7, 2009 at 10:44 PM, Aisha Fenton<aisha.fenton at gmail.com> wrote:
> The library I'm using (http://github.com/celldee/bunny/tree/master) is
> synchronous only. I'm considering switching to (http://github.com/tmm1/amqp/tree/master
> ) which is async and uses libevent. However, I've read that there are
> problems with msg acknowledges in apps that use libevent, because the
> OS can buffer the ack responses. And although I'm not using ack yet, I
> want to in my production system.

I am interested as to what the specific issue is with sending acks
with libevent - are you saying that the app can issue an ack and this
can potentially go AWOL between the the libevent API returning and the
point it time when the AMQP frame is actually written to the socket?

Ben



From cremes.devlist at mac.com  Tue Sep  8 15:01:10 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Tue, 08 Sep 2009 09:01:10 -0500
Subject: [rabbitmq-discuss] Performance degrades with increasing
	queue	depth
In-Reply-To: <269388e30909080633ie5c92fjb3817da63e4e827e@mail.gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<506C64DD-BFB1-437A-9C1B-ECFB8CF3A211@gmail.com>
	<269388e30909080633ie5c92fjb3817da63e4e827e@mail.gmail.com>
Message-ID: <673A5190-357B-4248-B2E6-C712139D33CB@mac.com>

Aisha is mistaken. The ruby amqp library does not use libevent  
anywhere. It uses EventMachine under the covers which is a home-grown  
reactor written in C that uses select, poll and kqueue depending on  
the platform.

cr


On Sep 8, 2009, at 8:33 AM, Ben Hood wrote:

> Aisha,
>
> Not wanting to hijack this thread another time, but....
>
> On Mon, Sep 7, 2009 at 10:44 PM, Aisha  
> Fenton<aisha.fenton at gmail.com> wrote:
>> The library I'm using (http://github.com/celldee/bunny/tree/master)  
>> is
>> synchronous only. I'm considering switching to (http://github.com/tmm1/amqp/tree/master
>> ) which is async and uses libevent. However, I've read that there are
>> problems with msg acknowledges in apps that use libevent, because the
>> OS can buffer the ack responses. And although I'm not using ack  
>> yet, I
>> want to in my production system.
>
> I am interested as to what the specific issue is with sending acks
> with libevent - are you saying that the app can issue an ack and this
> can potentially go AWOL between the the libevent API returning and the
> point it time when the AMQP frame is actually written to the socket?
>
> Ben




From david.wragg at lshift.net  Tue Sep  8 16:31:16 2009
From: david.wragg at lshift.net (David Wragg)
Date: Tue, 08 Sep 2009 16:31:16 +0100
Subject: [rabbitmq-discuss] procedure for dealing with
	timeout_waiting_for_tables
In-Reply-To: <84fb38e30909071108n2ae089b7ne27356b7e062c4d4@mail.gmail.com>
	(tsuraan@gmail.com's message of "Mon\, 7 Sep 2009 13\:08\:03 -0500")
References: <84fb38e30909071108n2ae089b7ne27356b7e062c4d4@mail.gmail.com>
Message-ID: <k5r5uhtpvf.fsf@mrbraver.lshift.net>

Hi Tsuraan,

tsuraan <tsuraan at gmail.com> writes:
> I had a machine that had the timeout_waiting_for_tables (not in a
> cluster, just a single node).  I'm guessing that its hostname had
> changed, and that was making mnesia angry.  I have two questions about
> this.  Is there a good way to figure out exactly why mnesia isn't
> starting, i.e. is it a hostname change, a corrupt mnesia file, etc?

The answer to this part is no, not really.  Searching for reports of
similar symptoms on this list is currently your best bet.

> Second, to fix this, I thought I could copy out my persister logs,
> wipe the rabbit dir from /var/lib/.../mnesia, restart rabbit, and move
> the persisters back in.  That didn't seem to work, since the queues
> weren't defined anymore, so the log replay apparently just threw
> everything away.  Would remaking my exchanges, bindings, and queues,
> then moving in my persister logs do the trick?

Yes, the likely cause is your hostname change. If you recreate all the
resources, stop rabbit, copy the saved persister logs back in, and
start rabbit, it should do the trick.

David

-- 
 [][][] David Wragg       | mail: david.wragg at lshift.net
   [][] Senior Developer  | tel: +44 (0)20 7729 7060
 []  [] LShift Ltd        | web: www.lshift.net



From tsuraan at gmail.com  Tue Sep  8 17:09:44 2009
From: tsuraan at gmail.com (tsuraan)
Date: Tue, 8 Sep 2009 11:09:44 -0500
Subject: [rabbitmq-discuss] procedure for dealing with
	timeout_waiting_for_tables
In-Reply-To: <k5r5uhtpvf.fsf@mrbraver.lshift.net>
References: <84fb38e30909071108n2ae089b7ne27356b7e062c4d4@mail.gmail.com>
	<k5r5uhtpvf.fsf@mrbraver.lshift.net>
Message-ID: <84fb38e30909080909u38801578n9aeb2d45319e6511@mail.gmail.com>

> Yes, the likely cause is your hostname change. If you recreate all the
> resources, stop rabbit, copy the saved persister logs back in, and
> start rabbit, it should do the trick.

I'm currently starting rabbit with the node name 'rabbit'.  If I were
to always start it with 'rabbit at localhost' (or 'rabbit@<some other
constant name>', I guess), would I be guaranteed to not have this
problem, as long as the @name is something that maps to the local
machine?  I assume that erlang implicitly uses rabbit@`hostname` when
the @ is left off, but I'm not entirely sure on that.



From digitalwarfare at gmail.com  Tue Sep  8 17:15:24 2009
From: digitalwarfare at gmail.com (Suhail Doshi)
Date: Tue, 8 Sep 2009 09:15:24 -0700
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <673A5190-357B-4248-B2E6-C712139D33CB@mac.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com> 
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com> 
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com> 
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com> 
	<506C64DD-BFB1-437A-9C1B-ECFB8CF3A211@gmail.com>
	<269388e30909080633ie5c92fjb3817da63e4e827e@mail.gmail.com> 
	<673A5190-357B-4248-B2E6-C712139D33CB@mac.com>
Message-ID: <376f3e6f0909080915l7c2b43behd387faddbeea1aef@mail.gmail.com>

This is the gist of mine:
def get_channel(self):
        """
            Creates a persistent, ack based, non-exclusive queue/exchange
using the routing key event

            Non-exclusivity allows any consumer to grab from the queue
        """
        channel = self.connection.channel()

        channel.queue_declare(queue='storage', durable=True,
exclusive=False, auto_delete=False)
        channel.exchange_declare(exchange='records', type='direct',
durable=True, auto_delete=False)
        channel.queue_bind(queue='storage', exchange='records',
routing_key='event')

        channel.basic_consume(
            queue='storage', no_ack=False, callback=self.recv_event_record,
            consumer_tag=self.consumer_tag
        )

        self.channel = channel

        return channel

    def recv_event_record(self, data):
        """
            Cleans up the record, passes it on for processing
        """

        item = cjson.decode(unicode(data.body).encode("utf8"))

        [processing...]

        logging.info('[id: ' + str(self.consumer_id) + '] Received queue
item, processing...')

        self.process_record(record)
        self.channel.basic_ack(data.delivery_tag)

        logging.info('[id: ' + str(self.consumer_id) + '] Processing
complete, acknowledged.')

    def process_record(self, item):
        process(item)

def connect_consumer():
    channel = get_channel()

    logging.info('Consumer started')

    while True:
        channel.wait()

On Tue, Sep 8, 2009 at 7:01 AM, Chuck Remes <cremes.devlist at mac.com> wrote:

> Aisha is mistaken. The ruby amqp library does not use libevent
> anywhere. It uses EventMachine under the covers which is a home-grown
> reactor written in C that uses select, poll and kqueue depending on
> the platform.
>
> cr
>
>
> On Sep 8, 2009, at 8:33 AM, Ben Hood wrote:
>
> > Aisha,
> >
> > Not wanting to hijack this thread another time, but....
> >
> > On Mon, Sep 7, 2009 at 10:44 PM, Aisha
> > Fenton<aisha.fenton at gmail.com> wrote:
> >> The library I'm using (http://github.com/celldee/bunny/tree/master)
> >> is
> >> synchronous only. I'm considering switching to (
> http://github.com/tmm1/amqp/tree/master
> >> ) which is async and uses libevent. However, I've read that there are
> >> problems with msg acknowledges in apps that use libevent, because the
> >> OS can buffer the ack responses. And although I'm not using ack
> >> yet, I
> >> want to in my production system.
> >
> > I am interested as to what the specific issue is with sending acks
> > with libevent - are you saying that the app can issue an ack and this
> > can potentially go AWOL between the the libevent API returning and the
> > point it time when the AMQP frame is actually written to the socket?
> >
> > Ben
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
http://mixpanel.com
Blog: http://blog.mixpanel.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/5e7a5b4f/attachment.htm 

From david.wragg at lshift.net  Tue Sep  8 18:04:29 2009
From: david.wragg at lshift.net (David Wragg)
Date: Tue, 08 Sep 2009 18:04:29 +0100
Subject: [rabbitmq-discuss] procedure for dealing with
	timeout_waiting_for_tables
In-Reply-To: <84fb38e30909080909u38801578n9aeb2d45319e6511@mail.gmail.com>
	(tsuraan@gmail.com's message of "Tue\, 8 Sep 2009 11\:09\:44 -0500")
References: <84fb38e30909071108n2ae089b7ne27356b7e062c4d4@mail.gmail.com>
	<k5r5uhtpvf.fsf@mrbraver.lshift.net>
	<84fb38e30909080909u38801578n9aeb2d45319e6511@mail.gmail.com>
Message-ID: <k5hbvd8j1e.fsf@mrbraver.lshift.net>

tsuraan <tsuraan at gmail.com> writes:
> I'm currently starting rabbit with the node name 'rabbit'.  If I were
> to always start it with 'rabbit at localhost' (or 'rabbit@<some other
> constant name>', I guess), would I be guaranteed to not have this
> problem, as long as the @name is something that maps to the local
> machine?

Yes, if the machine's hostname is changing, then it's a good idea to
specify the full node name explicitly in order to avoid problems with
mnesia.

In general, the part of the node name after the '@' does not even have
to resolve to the machine in question, although it should if you want
clustering to work.

>  I assume that erlang implicitly uses rabbit@`hostname` when
> the @ is left off, but I'm not entirely sure on that.

Indeed, as described at
<http://erlang.org/doc/reference_manual/distributed.html>.


David

-- 
 [][][] David Wragg       | mail: david.wragg at lshift.net
   [][] Senior Developer  | tel: +44 (0)20 7729 7060
 []  [] LShift Ltd        | web: www.lshift.net



From david.wragg at lshift.net  Tue Sep  8 18:15:19 2009
From: david.wragg at lshift.net (David Wragg)
Date: Tue, 08 Sep 2009 18:15:19 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <376f3e6f0909080915l7c2b43behd387faddbeea1aef@mail.gmail.com>
	(Suhail Doshi's message of "Tue\, 8 Sep 2009 09\:15\:24 -0700")
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<506C64DD-BFB1-437A-9C1B-ECFB8CF3A211@gmail.com>
	<269388e30909080633ie5c92fjb3817da63e4e827e@mail.gmail.com>
	<673A5190-357B-4248-B2E6-C712139D33CB@mac.com>
	<376f3e6f0909080915l7c2b43behd387faddbeea1aef@mail.gmail.com>
Message-ID: <k5d4618ijc.fsf@mrbraver.lshift.net>

Suhail Doshi <digitalwarfare at gmail.com> writes:
> This is the gist of mine:

Hi Suhail,

In order to reproduce what you are describing, it would be helpful to
know:

- Which version of which Python AMQP library you are using.

- A complete program to reproduce the problem.  I notice that your
  email client is breaking lines, so you might want to send the
  program as an attachment, or switch to an email client that can be
  configured not to break lines.

- A bit about your environment: What OS, what kind of hardware, is
  everything running on a single machine or not, etc.

The easier it is to reproduce the problem, the more likely you are to
get a useful answer!


David

-- 
 [][][] David Wragg       | mail: david.wragg at lshift.net
   [][] Senior Developer  | tel: +44 (0)20 7729 7060
 []  [] LShift Ltd        | web: www.lshift.net



From ram.muthiah at yahoo.com  Tue Sep  8 18:48:01 2009
From: ram.muthiah at yahoo.com (Ram Muthiah)
Date: Tue, 8 Sep 2009 10:48:01 -0700 (PDT)
Subject: [rabbitmq-discuss]  java client library
Message-ID: <266385.14925.qm@web44706.mail.sp1.yahoo.com>

Aniruddh,

Install Netbeans. This will help you a lot. After installing it, compile and run from netbeans. You will see the result.

Ram


      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090908/520b1b51/attachment.htm 

From tonyg at lshift.net  Tue Sep  8 19:07:55 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Tue, 08 Sep 2009 19:07:55 +0100
Subject: [rabbitmq-discuss] list_connections output
In-Reply-To: <4AA043F1.600@lshift.net>
References: <57A7F685-8234-45E7-BFD0-21B52DBAA17F@mac.com>
	<4AA043F1.600@lshift.net>
Message-ID: <4AA69D7B.3010903@lshift.net>

Matthias Radestock wrote:
> 'none' is shown when a client has connected but hasn't sent their 
> credentials yet. If that (plus all other connection setup steps) aren't 
> completed within ten seconds then the server closes the connection.

Yuck. It should probably also default to showing the state variable, so
that "none" isn't confused for a valid user name of "none". (The state
will be "pre_init" before login has happened, and "running" when the
connection is logged in and stable. Other values are possible too.)

Cheers,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From aisha.fenton at gmail.com  Tue Sep  8 22:46:50 2009
From: aisha.fenton at gmail.com (Aisha Fenton)
Date: Wed, 9 Sep 2009 09:46:50 +1200
Subject: [rabbitmq-discuss] Performance degrades with increasing
	queue	depth
In-Reply-To: <673A5190-357B-4248-B2E6-C712139D33CB@mac.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<506C64DD-BFB1-437A-9C1B-ECFB8CF3A211@gmail.com>
	<269388e30909080633ie5c92fjb3817da63e4e827e@mail.gmail.com>
	<673A5190-357B-4248-B2E6-C712139D33CB@mac.com>
Message-ID: <A875143C-1ECD-4172-B686-07814D44640B@gmail.com>

Sorry meant to say EventMachine, not libevent.

> I am interested as to what the specific issue is with sending acks
> with libevent - are you saying that the app can issue an ack and this
> can potentially go AWOL between the the libevent API returning and the
> point it time when the AMQP frame is actually written to the socket?


This article sums it up well. I haven't investigated this myself  
though, so only going on a other peoples comments.
http://pivotallabs.com/users/jpalermo/blog/articles/952-rabbitmq-amqp-gem-and-eventmachine

The article also suggests a workaround. Use MQ.prefetch(1)



On 9/09/2009, at 2:01 AM, Chuck Remes wrote:

> Aisha is mistaken. The ruby amqp library does not use libevent  
> anywhere. It uses EventMachine under the covers which is a home- 
> grown reactor written in C that uses select, poll and kqueue  
> depending on the platform.
>
> cr
>
>
> On Sep 8, 2009, at 8:33 AM, Ben Hood wrote:
>
>> Aisha,
>>
>> Not wanting to hijack this thread another time, but....
>>
>> On Mon, Sep 7, 2009 at 10:44 PM, Aisha  
>> Fenton<aisha.fenton at gmail.com> wrote:
>>> The library I'm using (http://github.com/celldee/bunny/tree/ 
>>> master) is
>>> synchronous only. I'm considering switching to (http://github.com/tmm1/amqp/tree/master
>>> ) which is async and uses libevent. However, I've read that there  
>>> are
>>> problems with msg acknowledges in apps that use libevent, because  
>>> the
>>> OS can buffer the ack responses. And although I'm not using ack  
>>> yet, I
>>> want to in my production system.
>>
>> I am interested as to what the specific issue is with sending acks
>> with libevent - are you saying that the app can issue an ack and this
>> can potentially go AWOL between the the libevent API returning and  
>> the
>> point it time when the AMQP frame is actually written to the socket?
>>
>> Ben
>




From sridhar.raman at gmail.com  Wed Sep  9 08:46:11 2009
From: sridhar.raman at gmail.com (Sridhar Raman)
Date: Wed, 9 Sep 2009 13:16:11 +0530
Subject: [rabbitmq-discuss] Subscribe to remote rabbitmq queue
Message-ID: <227621ad0909090046t4c7589c7m1e6c698792ade14e@mail.gmail.com>

Hi

This is our current setup that is working in a server:
Listener (that receives the data and publishes it):
*module QueueData
    def receive_data(d)
        $amq.queue("queue_name").publish(d)
    end
end
EM.run {
  $amq = MQ.new
  EM.start_server "0.0.0.0", 22003, QueueData
}*

Processor (that subscribes to the queue and processes it):
*EM.run {
  amq = MQ.new
  amq.queue("queue_name").subscribe { |d|
    puts d
  }
}*

How do I subscribe to this queue from another machine?  I tried this:
*AMQP.start(:host => 'hostname', :port => 5672, :logging => true) do
  puts "connected ..."
  mq = MQ.new
  MQ.queue('queue_name').subscribe{ |msg|
    puts msg
  }
end*

But it doesn't work.  Any suggestions?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090909/882521ff/attachment.htm 

From pauljones23 at gmail.com  Wed Sep  9 08:50:53 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Wed, 9 Sep 2009 08:50:53 +0100
Subject: [rabbitmq-discuss] Subscribe to remote rabbitmq queue
In-Reply-To: <227621ad0909090046t4c7589c7m1e6c698792ade14e@mail.gmail.com>
References: <227621ad0909090046t4c7589c7m1e6c698792ade14e@mail.gmail.com>
Message-ID: <29598b610909090050y1ec65595l6c1a28ac6e69fc77@mail.gmail.com>

Sridhar,

Can you describe how this doesn't work?

Paul.

On Wed, Sep 9, 2009 at 8:46 AM, Sridhar Raman <sridhar.raman at gmail.com>wrote:

> Hi
>
> This is our current setup that is working in a server:
> Listener (that receives the data and publishes it):
> *module QueueData
>     def receive_data(d)
>         $amq.queue("queue_name").publish(d)
>     end
> end
> EM.run {
>   $amq = MQ.new
>   EM.start_server "0.0.0.0", 22003, QueueData
> }*
>
> Processor (that subscribes to the queue and processes it):
> *EM.run {
>   amq = MQ.new
>   amq.queue("queue_name").subscribe { |d|
>     puts d
>   }
> }*
>
> How do I subscribe to this queue from another machine?  I tried this:
> *AMQP.start(:host => 'hostname', :port => 5672, :logging => true) do
>   puts "connected ..."
>   mq = MQ.new
>   MQ.queue('queue_name').subscribe{ |msg|
>     puts msg
>   }
> end*
>
> But it doesn't work.  Any suggestions?
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090909/437a2bb7/attachment.htm 

From sridhar.raman at gmail.com  Wed Sep  9 08:54:02 2009
From: sridhar.raman at gmail.com (Sridhar Raman)
Date: Wed, 9 Sep 2009 13:24:02 +0530
Subject: [rabbitmq-discuss] Subscribe to remote rabbitmq queue
In-Reply-To: <29598b610909090050y1ec65595l6c1a28ac6e69fc77@mail.gmail.com>
References: <227621ad0909090046t4c7589c7m1e6c698792ade14e@mail.gmail.com>
	<29598b610909090050y1ec65595l6c1a28ac6e69fc77@mail.gmail.com>
Message-ID: <227621ad0909090054p6048b9c5mda0778682f89b17c@mail.gmail.com>

When I run it, this is the error I get:
*/usr/local/lib/ruby/gems/1.8/gems/tmm1-amqp-0.6.4/lib/amqp/client.rb:65:in
`initialize': Could not connect to server hostname:5672 (AMQP::Error)
    from
/usr/local/lib/ruby/gems/1.8/gems/tmm1-amqp-0.6.4/lib/amqp/client.rb:97:in
`call'
    from
/usr/local/lib/ruby/gems/1.8/gems/tmm1-amqp-0.6.4/lib/amqp/client.rb:97:in
`unbind'
    from
/usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:995:in
`call'
    from
/usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:995:in
`run_deferred_callbacks'
    from
/usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:995:in
`times'
    from
/usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:995:in
`run_deferred_callbacks'
    from
/usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:242:in
`run_machine'
    from
/usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:242:in
`run'
    from /usr/local/lib/ruby/gems/1.8/gems/tmm1-amqp-0.6.4/lib/amqp.rb:84:in
`start'
    from test_processor.rb:7*

Could it because port 5672 is not accessible from outside?  In that case,
how do I expose it?
I tried iptables like this:
*iptables -A INPUT -p tcp --dport 5672 -j ACCEPT*

But still no luck.  How do I configure rabbitmq to accept requests from
external IPs?

-S

2009/9/9 Paul Jones <pauljones23 at gmail.com>

> Sridhar,
>
> Can you describe how this doesn't work?
>
> Paul.
>
> On Wed, Sep 9, 2009 at 8:46 AM, Sridhar Raman <sridhar.raman at gmail.com>wrote:
>
>> Hi
>>
>> This is our current setup that is working in a server:
>> Listener (that receives the data and publishes it):
>> *module QueueData
>>     def receive_data(d)
>>         $amq.queue("queue_name").publish(d)
>>     end
>> end
>> EM.run {
>>   $amq = MQ.new
>>   EM.start_server "0.0.0.0", 22003, QueueData
>> }*
>>
>> Processor (that subscribes to the queue and processes it):
>> *EM.run {
>>   amq = MQ.new
>>   amq.queue("queue_name").subscribe { |d|
>>     puts d
>>   }
>> }*
>>
>> How do I subscribe to this queue from another machine?  I tried this:
>> *AMQP.start(:host => 'hostname', :port => 5672, :logging => true) do
>>   puts "connected ..."
>>   mq = MQ.new
>>   MQ.queue('queue_name').subscribe{ |msg|
>>     puts msg
>>   }
>> end*
>>
>> But it doesn't work.  Any suggestions?
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090909/4258da45/attachment.htm 

From pauljones23 at gmail.com  Wed Sep  9 10:11:19 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Wed, 9 Sep 2009 10:11:19 +0100
Subject: [rabbitmq-discuss] Subscribe to remote rabbitmq queue
In-Reply-To: <227621ad0909090054p6048b9c5mda0778682f89b17c@mail.gmail.com>
References: <227621ad0909090046t4c7589c7m1e6c698792ade14e@mail.gmail.com>
	<29598b610909090050y1ec65595l6c1a28ac6e69fc77@mail.gmail.com>
	<227621ad0909090054p6048b9c5mda0778682f89b17c@mail.gmail.com>
Message-ID: <29598b610909090211s4f3b2e10me9a6bbfcd76ff840@mail.gmail.com>

Sridhar,

Rabbit by default should be listening on all addresses on the machine. You
can confirm this by running:
  netstat -an | grep 5672
and validating that an entry such as:
  tcp        0      0 0.0.0.0:5672            0.0.0.0:*               LISTEN

If you're running iptables on your machine, then the command you listed
should *generally* do the trick. However, I wouldn't be able to tell for
sure without seeing the entire output from iptables -L (since you could
always have a deny rule before this one).

Paul.

On Wed, Sep 9, 2009 at 8:54 AM, Sridhar Raman <sridhar.raman at gmail.com>wrote:

> When I run it, this is the error I get:
> */usr/local/lib/ruby/gems/1.8/gems/tmm1-amqp-0.6.4/lib/amqp/client.rb:65:in
> `initialize': Could not connect to server hostname:5672 (AMQP::Error)
>     from
> /usr/local/lib/ruby/gems/1.8/gems/tmm1-amqp-0.6.4/lib/amqp/client.rb:97:in
> `call'
>     from
> /usr/local/lib/ruby/gems/1.8/gems/tmm1-amqp-0.6.4/lib/amqp/client.rb:97:in
> `unbind'
>     from
> /usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:995:in
> `call'
>     from
> /usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:995:in
> `run_deferred_callbacks'
>     from
> /usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:995:in
> `times'
>     from
> /usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:995:in
> `run_deferred_callbacks'
>     from
> /usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:242:in
> `run_machine'
>     from
> /usr/local/lib/ruby/gems/1.8/gems/eventmachine-0.12.8/lib/eventmachine.rb:242:in
> `run'
>     from
> /usr/local/lib/ruby/gems/1.8/gems/tmm1-amqp-0.6.4/lib/amqp.rb:84:in `start'
>     from test_processor.rb:7*
>
> Could it because port 5672 is not accessible from outside?  In that case,
> how do I expose it?
> I tried iptables like this:
> *iptables -A INPUT -p tcp --dport 5672 -j ACCEPT*
>
> But still no luck.  How do I configure rabbitmq to accept requests from
> external IPs?
>
> -S
>
> 2009/9/9 Paul Jones <pauljones23 at gmail.com>
>
> Sridhar,
>>
>> Can you describe how this doesn't work?
>>
>> Paul.
>>
>> On Wed, Sep 9, 2009 at 8:46 AM, Sridhar Raman <sridhar.raman at gmail.com>wrote:
>>
>>> Hi
>>>
>>> This is our current setup that is working in a server:
>>> Listener (that receives the data and publishes it):
>>> *module QueueData
>>>     def receive_data(d)
>>>         $amq.queue("queue_name").publish(d)
>>>     end
>>> end
>>> EM.run {
>>>   $amq = MQ.new
>>>   EM.start_server "0.0.0.0", 22003, QueueData
>>> }*
>>>
>>> Processor (that subscribes to the queue and processes it):
>>> *EM.run {
>>>   amq = MQ.new
>>>   amq.queue("queue_name").subscribe { |d|
>>>     puts d
>>>   }
>>> }*
>>>
>>> How do I subscribe to this queue from another machine?  I tried this:
>>> *AMQP.start(:host => 'hostname', :port => 5672, :logging => true) do
>>>   puts "connected ..."
>>>   mq = MQ.new
>>>   MQ.queue('queue_name').subscribe{ |msg|
>>>     puts msg
>>>   }
>>> end*
>>>
>>> But it doesn't work.  Any suggestions?
>>>
>>> _______________________________________________
>>> rabbitmq-discuss mailing list
>>> rabbitmq-discuss at lists.rabbitmq.com
>>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>>
>>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090909/2972dd62/attachment.htm 

From 0x6e6562 at gmail.com  Wed Sep  9 10:55:31 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Wed, 9 Sep 2009 10:55:31 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <A875143C-1ECD-4172-B686-07814D44640B@gmail.com>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com>
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com>
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com>
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com>
	<506C64DD-BFB1-437A-9C1B-ECFB8CF3A211@gmail.com>
	<269388e30909080633ie5c92fjb3817da63e4e827e@mail.gmail.com>
	<673A5190-357B-4248-B2E6-C712139D33CB@mac.com>
	<A875143C-1ECD-4172-B686-07814D44640B@gmail.com>
Message-ID: <269388e30909090255n70119d80m117aa3e7d57d0009@mail.gmail.com>

Aisha,

On Tue, Sep 8, 2009 at 10:46 PM, Aisha Fenton<aisha.fenton at gmail.com> wrote:
> Sorry meant to say EventMachine, not libevent.
>
>> I am interested as to what the specific issue is with sending acks
>> with libevent - are you saying that the app can issue an ack and this
>> can potentially go AWOL between the the libevent API returning and the
>> point it time when the AMQP frame is actually written to the socket?
>
>
> This article sums it up well. I haven't investigated this myself though, so
> only going on a other peoples comments.
> http://pivotallabs.com/users/jpalermo/blog/articles/952-rabbitmq-amqp-gem-and-eventmachine
>
> The article also suggests a workaround. Use MQ.prefetch(1)

If you need more explicit flow control, then using the AMQP basic.qos
command is the way to go. I presume that MQ.prefetch in tmm1-amqp
wraps this. This command allows a consumer to choose a prefetch window
that specifies the amount of unacknowledged messages it is prepared to
receive. By setting the prefetch count to a non-zero value, the broker
will not deliver any messages to the consumer that would breach that
limit. To move the window forwards, the consumer has to acknowledge
the receipt of a message (or a group of messages). By acknowledging a
message, the consumer gains credit in the broker which makes it
eligible to receive more messages.

Ben



From david.wragg at lshift.net  Wed Sep  9 11:01:39 2009
From: david.wragg at lshift.net (David Wragg)
Date: Wed, 09 Sep 2009 11:01:39 +0100
Subject: [rabbitmq-discuss] Subscribe to remote rabbitmq queue
In-Reply-To: <227621ad0909090054p6048b9c5mda0778682f89b17c@mail.gmail.com>
	(Sridhar Raman's message of "Wed\, 9 Sep 2009 13\:24\:02 +0530")
References: <227621ad0909090046t4c7589c7m1e6c698792ade14e@mail.gmail.com>
	<29598b610909090050y1ec65595l6c1a28ac6e69fc77@mail.gmail.com>
	<227621ad0909090054p6048b9c5mda0778682f89b17c@mail.gmail.com>
Message-ID: <k58wgo8mik.fsf@mrbraver.lshift.net>

Sridhar Raman <sridhar.raman at gmail.com> writes:
> [...]
> Could it because port 5672 is not accessible from outside?  In that case,
> how do I expose it?
> I tried iptables like this:
> *iptables -A INPUT -p tcp --dport 5672 -j ACCEPT*
>
> But still no luck.  How do I configure rabbitmq to accept requests from
> external IPs?

Hi Sridhar,

Have you tried running your client program on the same machine as the
rabbitmq server?  Does it work there?

If your program can connect locally, but not remotely, then it might
be an issue with firewall rules.  How to fix this depends on your
operating system.  Assuming you are on Linux, many distributions come
with higher-level tools than iptables to manage the firewall rules.
It might be worth pursuing your distribution's support channels to
find out more.

On the other hand, if you cannot even connect locally, then it is
likely to be an issue with the rabbitmq server itself.  Paul's
suggestion of using netstat to check whether it is listening is a good
one.


David

-- 
 [][][] David Wragg       | mail: david.wragg at lshift.net
   [][] Senior Developer  | tel: +44 (0)20 7729 7060
 []  [] LShift Ltd        | web: www.lshift.net



From alexis.richardson at gmail.com  Wed Sep  9 19:50:15 2009
From: alexis.richardson at gmail.com (Alexis Richardson)
Date: Wed, 9 Sep 2009 11:50:15 -0700
Subject: [rabbitmq-discuss] possible meet-up in SF next week?
In-Reply-To: <167204d20909031351p5d9e2dbbs55d8b5fec57995fd@mail.gmail.com>
References: <167204d20909031351p5d9e2dbbs55d8b5fec57995fd@mail.gmail.com>
Message-ID: <167204d20909091150v699c9542rd39bf5d21f504114@mail.gmail.com>

Hi all,

Based on feedback - Friday is the best day for a pubsub meet-up.
Please come to the Thirsty Bear any time from 4:30pm Friday.

Again - apologies if you got this twice - I am using a 'reply all' due
to time constraints.

Best wishes,

alexis


On Thu, Sep 3, 2009 at 1:51 PM, Alexis
Richardson<alexis.richardson at gmail.com> wrote:
> Hi all,
>
> Apologies for the cross post.
>
> I'm going to be in SF late next week and would love to schedule a
> Pubsub meet-up with anyone interested in Pubsub of any kind:
> PubSubHubBub, XEP-60, AMQP and RabbitMQ.
>
> My ideal time would be Friday Sep 11th, after 4pm, over a beer. ?But,
> I could do Thursday from c.7:30pm if Fridays are bad for people. ?[ Or
> possibly even Wednesday ]
>
> If you are interested please contact me off-list to avoid cluttering
> inboxes further. ?I'll post a plan once it's clear.
>
> Cheers,
>
> alexis
>



From ashley.ohq at gmail.com  Thu Sep 10 10:43:44 2009
From: ashley.ohq at gmail.com (Ashley van Gerven)
Date: Thu, 10 Sep 2009 19:43:44 +1000
Subject: [rabbitmq-discuss] IModel / thread sharing
Message-ID: <150a3aa50909100243s1ae19b67u582f2a60ad89d0cb@mail.gmail.com>

Hi,

The .NET user guide states that IModel instances should not be shared
accross threads. So having multiple web requests publishing to the queue
using the same IModel instance is not an option. However would it be (a)
possible and (b) advantageous to share a IConnection instance, and have each
web request create an IModel using the same connection instance? My thought
is that sharing the IConnection would speed up message publishing (using
BasicPublish).


Thanks
Ashley
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090910/46c9bff2/attachment.htm 

From pauljones23 at gmail.com  Thu Sep 10 10:50:19 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Thu, 10 Sep 2009 10:50:19 +0100
Subject: [rabbitmq-discuss] IModel / thread sharing
In-Reply-To: <150a3aa50909100243s1ae19b67u582f2a60ad89d0cb@mail.gmail.com>
References: <150a3aa50909100243s1ae19b67u582f2a60ad89d0cb@mail.gmail.com>
Message-ID: <29598b610909100250y50cccc0v9a36dcc5aaee3e31@mail.gmail.com>

Hi Ashley,

Indeed, the purpose for having the IModel hanging off the IConnection is to
allow a single connection to be shared. Sharing the connection reduces the
number of active connections to your server. It also eliminates a potential
cause of problems when connections are created and torn down in rapid
succession.

If you consider the amount of time taken to establish a connection, then
sharing the connection will certainly help increase your message sending
performance.

Paul.

On Thu, Sep 10, 2009 at 10:43 AM, Ashley van Gerven <ashley.ohq at gmail.com>wrote:

> Hi,
>
> The .NET user guide states that IModel instances should not be shared
> accross threads. So having multiple web requests publishing to the queue
> using the same IModel instance is not an option. However would it be (a)
> possible and (b) advantageous to share a IConnection instance, and have each
> web request create an IModel using the same connection instance? My thought
> is that sharing the IConnection would speed up message publishing (using
> BasicPublish).
>
>
> Thanks
> Ashley
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090910/32e36e35/attachment.htm 

From j.belis at be.pgz.eu  Thu Sep 10 12:40:45 2009
From: j.belis at be.pgz.eu (=?us-ascii?Q?Joeri_Belis?=)
Date: Thu, 10 Sep 2009 13:40:45 +0200
Subject: [rabbitmq-discuss] Can not get stomp adapter running with rabbitmq
	1.6.0
Message-ID: <vmime.4aa8e5bd.66b5.314d1c6bbd84b4cd@vmdebianzarafa.nollekens.be>


Env= REDHAT 5 

I have compiled from tar file both rabbitmq and stomp adapter. 

? 

Then i start the rabbitmq from the stomp adapter compiled directory with 

make RABBIT_SOURCE_ROOT=../rabbitmq-server run 

? 

And this is the output. 

Everything except the stomp adapter gets started. Any ideas why??? 

? 

erl -pa ebin -pa test_ebin?? -pa ../rabbitmq-server/ebin -mnesia dir tmp -boot start_sasl -sasl sasl_error_logger '{file, "'/tmp'/rabbit-sasl.log"}' -kernel error_logger '{file, "'/tmp'/rabbit.log"}' -rabbit_stomp listeners "[{\"0.0.0.0\",61613}]" -sname rabbit -eval 'rabbit:start()' -eval 'ok = application:start(rabbit_stomp)' 

Erlang (BEAM) emulator version 5.6.5 [source] [64-bit] [smp:4] [async-threads:0] [hipe] [kernel-poll:false] 

? 

Eshell V5.6.5? (abort with ^G) 

(rabbit at redhat09)1> RabbitMQ 1.6.0 (AMQP 8-0) 

Copyright (C) 2007-2009 LShift Ltd., Cohesive Financial Technologies LLC., and Rabbit Technologies Ltd. 

Licensed under the MPL.? See http://www.rabbitmq.com/ 

? 

node??????? : rabbit at redhat09 

log???????? : /tmp/rabbit.log 

sasl log??? : /tmp/rabbit-sasl.log 

database dir: /usr/local/src/rabbitmq-stomp-7a22cfe47f66/tmp 

? 

starting database???????????? ...done 

starting core processes?????? ...done 

starting recovery???????????? ...done 

starting persister??????????? ...done 

starting guid generator?????? ...done 

starting builtin applications ...done 

starting TCP listeners??????? ...done 

? 

broker running 

starting STOMP Adapter (binding to [{"0.0.0.0",61613}])? ...{"init terminating in do_boot",{{badmatch,{error,{bad_return,{{rabbit_stomp,start,[normal,[]]},{'EXIT',{{badmatch,{error,{shutdown,{child,undefined,'rabbit_stomp_listener_sup_0.0.0.0:61613',{tcp_listener_sup,start_link,[{0,0,0,0},61613,[{packet,raw},{reuseaddr,true}],{rabbit_stomp_server,listener_started,[]},{rabbit_stomp_server,listener_stopped,[]},{rabbit_stomp_server,start_client,[]},"STOMP Listener"]},transient,infinity,supervisor,[tcp_listener_sup]}}}},[{rabbit_stomp_server,start_listeners,1},{rabbit_stomp_server,start,1},{rabbit_stomp,start,2},{application_master,start_it_old,4}]}}}}}},[{erl_eval,expr,3}]}} 

Erlang has closed 

???????????????? /usr/lib64/erlang/lib/os_mon-2.1.8/priv/bin/memsup: Erlang has closed. 

? 

Crash dump was written to: erl_crash.dump 

init terminating in do_boot () 

make: *** [run] Fout 1 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090910/c1c954fa/attachment.htm 

From pauljones23 at gmail.com  Thu Sep 10 12:57:37 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Thu, 10 Sep 2009 12:57:37 +0100
Subject: [rabbitmq-discuss] Can not get stomp adapter running with
	rabbitmq 1.6.0
In-Reply-To: <vmime.4aa8e5bd.66b5.314d1c6bbd84b4cd@vmdebianzarafa.nollekens.be>
References: <vmime.4aa8e5bd.66b5.314d1c6bbd84b4cd@vmdebianzarafa.nollekens.be>
Message-ID: <29598b610909100457w1b1e898w61c1e2e00cac40ef@mail.gmail.com>

Hi Joeri,

>From where did you download the STOMP adapter source? The server and adapter
have recently changed in order to simplify the configuration process using
the plugin mechanism that is set for release in 1.7 (though default of the
server has this right now, and can be used with a source checkout).

Thanks,
Paul.

On Thu, Sep 10, 2009 at 12:40 PM, Joeri Belis <j.belis at be.pgz.eu> wrote:

>  Env= REDHAT 5
>
> I have compiled from tar file both rabbitmq and stomp adapter.
>
>
>
> Then i start the rabbitmq from the stomp adapter compiled directory with
>
> make RABBIT_SOURCE_ROOT=../rabbitmq-server run
>
>
>
> And this is the output.
>
> Everything except the stomp adapter gets started. Any ideas why???
>
>
>
> erl -pa ebin -pa test_ebin   -pa ../rabbitmq-server/ebin -mnesia dir tmp
> -boot start_sasl -sasl sasl_error_logger '{file, "'/tmp'/rabbit-sasl.log"}'
> -kernel error_logger '{file, "'/tmp'/rabbit.log"}' -rabbit_stomp listeners
> "[{\"0.0.0.0\",61613}]" -sname rabbit -eval 'rabbit:start()' -eval 'ok =
> application:start(rabbit_stomp)'
>
> Erlang (BEAM) emulator version 5.6.5 [source] [64-bit] [smp:4]
> [async-threads:0] [hipe] [kernel-poll:false]
>
>
>
> Eshell V5.6.5  (abort with ^G)
>
> (rabbit at redhat09)1> RabbitMQ 1.6.0 (AMQP 8-0)
>
> Copyright (C) 2007-2009 LShift Ltd., Cohesive Financial Technologies LLC.,
> and Rabbit Technologies Ltd.
>
> Licensed under the MPL.  See http://www.rabbitmq.com/
>
>
>
> node        : rabbit at redhat09
>
> log         : /tmp/rabbit.log
>
> sasl log    : /tmp/rabbit-sasl.log
>
> database dir: /usr/local/src/rabbitmq-stomp-7a22cfe47f66/tmp
>
>
>
> starting database             ...done
>
> starting core processes       ...done
>
> starting recovery             ...done
>
> starting persister            ...done
>
> starting guid generator       ...done
>
> starting builtin applications ...done
>
> starting TCP listeners        ...done
>
>
>
> broker running
>
> starting STOMP Adapter (binding to [{"0.0.0.0",61613}])  ...{"init
> terminating in
> do_boot",{{badmatch,{error,{bad_return,{{rabbit_stomp,start,[normal,[]]},{'EXIT',{{badmatch,{error,{shutdown,{child,undefined,'rabbit_stomp_listener_sup_0.0.0.0:61613',{tcp_listener_sup,start_link,[{0,0,0,0},61613,[{packet,raw},{reuseaddr,true}],{rabbit_stomp_server,listener_started,[]},{rabbit_stomp_server,listener_stopped,[]},{rabbit_stomp_server,start_client,[]},"STOMP
> Listener"]},transient,infinity,supervisor,[tcp_listener_sup]}}}},[{rabbit_stomp_server,start_listeners,1},{rabbit_stomp_server,start,1},{rabbit_stomp,start,2},{application_master,start_it_old,4}]}}}}}},[{erl_eval,expr,3}]}}
>
> Erlang has closed
>
>                  /usr/lib64/erlang/lib/os_mon-2.1.8/priv/bin/memsup: Erlang
> has closed.
>
>
>
> Crash dump was written to: erl_crash.dump
>
> init terminating in do_boot ()
>
> make: *** [run] Fout 1
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090910/2187c9c1/attachment.htm 

From pauljones23 at gmail.com  Thu Sep 10 13:07:04 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Thu, 10 Sep 2009 13:07:04 +0100
Subject: [rabbitmq-discuss] Can not get stomp adapter running with
	rabbitmq 1.6.0
In-Reply-To: <vmime.4aa8ea8f.66b5.b12beb8bba74f2ad@vmdebianzarafa.nollekens.be>
References: <29598b610909100457w1b1e898w61c1e2e00cac40ef@mail.gmail.com>
	<vmime.4aa8ea8f.66b5.b12beb8bba74f2ad@vmdebianzarafa.nollekens.be>
Message-ID: <29598b610909100507t591ea565te0ddf2f0e5d9331f@mail.gmail.com>

Joeri,

Seeing as you've already got the build environment functional, I'd recommend
the following process for getting the adapter going:
  - Clone the rabbitmq-public-umbrella with:
     hg clone http://hg.rabbitmq.com/rabbitmq-public-umbrella
  - Request that it checkout all of the appropriate sub-projects with "make
co"
  - Build this by executing make in the top-level directory with "make"
  - Change into the STOMP adapter directory, and execute "make run"

For future reference, you're much better off downloading the "default.zip"
files instead of "tip.zip" - since as you'll see from many remarks in the
history of this list, tip will contain potentially random content, whilst
default will contain the latest QA'd version.

Paul.

On Thu, Sep 10, 2009 at 1:01 PM, Joeri Belis <j.belis at be.pgz.eu> wrote:

>  Paul,
>
>
>
> I got my server version from tar balls from
> http://www.rabbitmq.com/download.html.
>
>
>
> And the stomp version from
> http://hg.rabbitmq.com/rabbitmq-stomp/archive/tip.tar.gz
>
>
>
> Where do i get both 1.7 versions?
>
>
>  ------------------------------
>
> *Van:* Paul Jones [mailto:pauljones23 at gmail.com]
> *Verzonden:* donderdag 10 september 2009 13:58
> *Aan:* Joeri Belis
> *CC:* rabbitmq-discuss at lists.rabbitmq.com
> *Onderwerp:* Re: [rabbitmq-discuss] Can not get stomp adapter running with
> rabbitmq 1.6.0
>
>
>
> Hi Joeri,
>
> From where did you download the STOMP adapter source? The server and
> adapter have recently changed in order to simplify the configuration process
> using the plugin mechanism that is set for release in 1.7 (though default of
> the server has this right now, and can be used with a source checkout).
>
> Thanks,
> Paul.
>
> On Thu, Sep 10, 2009 at 12:40 PM, Joeri Belis <j.belis at be.pgz.eu> wrote:
>
> Env= REDHAT 5
>
> I have compiled from tar file both rabbitmq and stomp adapter.
>
>
>
> Then i start the rabbitmq from the stomp adapter compiled directory with
>
> make RABBIT_SOURCE_ROOT=../rabbitmq-server run
>
>
>
> And this is the output.
>
> Everything except the stomp adapter gets started. Any ideas why???
>
>
>
> erl -pa ebin -pa test_ebin   -pa ../rabbitmq-server/ebin -mnesia dir tmp
> -boot start_sasl -sasl sasl_error_logger '{file, "'/tmp'/rabbit-sasl.log"}'
> -kernel error_logger '{file, "'/tmp'/rabbit.log"}' -rabbit_stomp listeners
> "[{\"0.0.0.0\",61613}]" -sname rabbit -eval 'rabbit:start()' -eval 'ok =
> application:start(rabbit_stomp)'
>
> Erlang (BEAM) emulator version 5.6.5 [source] [64-bit] [smp:4]
> [async-threads:0] [hipe] [kernel-poll:false]
>
>
>
> Eshell V5.6.5  (abort with ^G)
>
> (rabbit at redhat09)1> RabbitMQ 1.6.0 (AMQP 8-0)
>
> Copyright (C) 2007-2009 LShift Ltd., Cohesive Financial Technologies LLC.,
> and Rabbit Technologies Ltd.
>
> Licensed under the MPL.  See http://www.rabbitmq.com/
>
>
>
> node        : rabbit at redhat09
>
> log         : /tmp/rabbit.log
>
> sasl log    : /tmp/rabbit-sasl.log
>
> database dir: /usr/local/src/rabbitmq-stomp-7a22cfe47f66/tmp
>
>
>
> starting database             ...done
>
> starting core processes       ...done
>
> starting recovery             ...done
>
> starting persister            ...done
>
> starting guid generator       ...done
>
> starting builtin applications ...done
>
> starting TCP listeners        ...done
>
>
>
> broker running
>
> starting STOMP Adapter (binding to [{"0.0.0.0",61613}])  ...{"init
> terminating in
> do_boot",{{badmatch,{error,{bad_return,{{rabbit_stomp,start,[normal,[]]},{'EXIT',{{badmatch,{error,{shutdown,{child,undefined,'rabbit_stomp_listener_sup_0.0.0.0:61613',{tcp_listener_sup,start_link,[{0,0,0,0},61613,[{packet,raw},{reuseaddr,true}],{rabbit_stomp_server,listener_started,[]},{rabbit_stomp_server,listener_stopped,[]},{rabbit_stomp_server,start_client,[]},"STOMP
> Listener"]},transient,infinity,supervisor,[tcp_listener_sup]}}}},[{rabbit_stomp_server,start_listeners,1},{rabbit_stomp_server,start,1},{rabbit_stomp,start,2},{application_master,start_it_old,4}]}}}}}},[{erl_eval,expr,3}]}}
>
> Erlang has closed
>
>                  /usr/lib64/erlang/lib/os_mon-2.1.8/priv/bin/memsup: Erlang
> has closed.
>
>
>
> Crash dump was written to: erl_crash.dump
>
> init terminating in do_boot ()
>
> make: *** [run] Fout 1
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090910/713f341e/attachment.htm 

From erik at rigtorp.com  Thu Sep 10 17:00:13 2009
From: erik at rigtorp.com (Erik Rigtorp)
Date: Thu, 10 Sep 2009 18:00:13 +0200
Subject: [rabbitmq-discuss] Question about rabbit_reader.erl
Message-ID: <a57051ba0909100900k16d10576gecc56944ef3a5771@mail.gmail.com>

Hi!

I'm curious about why prim_inet:async_recv() is being used instead of
active mode. I'm writing a software in erlang that requires low
latency networking and I'm having trouble with very high latencies of
400ms+ between the nic and my erlang process. Maybe using
prim_inet:async_recv() has some advantages latency wise?

Thanks,
Erik Rigtorp



From 0x6e6562 at gmail.com  Thu Sep 10 20:21:07 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 10 Sep 2009 20:21:07 +0100
Subject: [rabbitmq-discuss] Question about rabbit_reader.erl
In-Reply-To: <a57051ba0909100900k16d10576gecc56944ef3a5771@mail.gmail.com>
References: <a57051ba0909100900k16d10576gecc56944ef3a5771@mail.gmail.com>
Message-ID: <269388e30909101221y312632b9w58183b395a5dc581@mail.gmail.com>

Erik,

On Thu, Sep 10, 2009 at 5:00 PM, Erik Rigtorp<erik at rigtorp.com> wrote:
> I'm curious about why prim_inet:async_recv() is being used instead of
> active mode. I'm writing a software in erlang that requires low
> latency networking and I'm having trouble with very high latencies of
> 400ms+ between the nic and my erlang process. Maybe using
> prim_inet:async_recv() has some advantages latency wise?

I don't know about what effect an async_recv has on latency (sounds
like a erlang-questions question), but one nice property of it is that
you can receive the socket data from your mailbox - which allows you
to loop on the mailbox and potentially pick up messages from processes
other than the one reading from the socket. If you were to do a
synchronous receive, you couldn't interleave control messages as
elegantly as with this method.

Ben



From alexgentle at sify.com  Thu Sep 10 20:52:49 2009
From: alexgentle at sify.com (Alex Gentle)
Date: Thu, 10 Sep 2009 12:52:49 -0700
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
Message-ID: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>

I have the following situation. I am thinking of using RabbitMQ for chat
inside my iPhone application. iPhone application is connected to the server
thru socket server. The socket server passes the information from iPhone to
the server and vice versa. I am not sure how could I make this communication
path works ? iPhone -> Socket Server -> RabbitMQ server.  I understand that
I can connect the client directly to RabbitMQ server using client library
you provided. I am not sure how could I pass the message thru socket
server.  Socket server basically accepts the incoming message from iPhone
and route the message to appropriate server based on header information in
the incoming message. It does the same thing when a server wants to
communicate to the client thru socket server. Socket server accepts only
binary data.  Is it a overkill to use RabbitMQ for this purpose? If I use
XMPP like ejabbberd, I would still have the same issue of routing the
message thru socket server.  Any help is much appreciated. Thanks!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090910/3bb061e0/attachment.htm 

From matthias at lshift.net  Fri Sep 11 01:23:54 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 11 Sep 2009 01:23:54 +0100
Subject: [rabbitmq-discuss] Question about rabbit_reader.erl
In-Reply-To: <a57051ba0909100900k16d10576gecc56944ef3a5771@mail.gmail.com>
References: <a57051ba0909100900k16d10576gecc56944ef3a5771@mail.gmail.com>
Message-ID: <4AA9989A.2010204@lshift.net>

Erik,

Erik Rigtorp wrote:
> I'm curious about why prim_inet:async_recv() is being used instead of
> active mode.

{active,once} provides no control over PDU size.
{active,true} provides no flow control.
gen_tcp:recv() is blocking.

With prim_inet:async_recv() we can receive exactly the amount of data we 
want, asynchronously.


Regards,

Matthias.



From 0x6e6562 at gmail.com  Fri Sep 11 07:38:46 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Fri, 11 Sep 2009 07:38:46 +0100
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
Message-ID: <72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>

Alex,

On 10 Sep 2009, at 20:52, Alex Gentle <alexgentle at sify.com> wrote:

> I have the following situation. I am thinking of using RabbitMQ for  
> chat inside my iPhone application. iPhone application is connected  
> to the server thru socket server. The socket server passes the  
> information from iPhone to the server and vice versa. I am not sure  
> how could I make this communication path works ? iPhone -> Socket Se 
> rver -> RabbitMQ server.  I understand that I can connect the client 
>  directly to RabbitMQ server using client library you provided. I am 
>  not sure how could I pass the message thru socket server.  Socket s 
> erver basically accepts the incoming message from iPhone and route t 
> he message to appropriate server based on header information in the  
> incoming message. It does the same thing when a server wants to comm 
> unicate to the client thru socket server. Socket server accepts only 
>  binary data.  Is it a overkill to use RabbitMQ for this purpose? If 
>  I use XMPP like ejabbberd, I would still have the same issue of rou 
> ting the message thru socket server.  Any help is much appreciated.  
> Thanks!


I don't understand your intention. What problem are you actually  
trying to solve? Are you trying to write an iPhone app that can send  
and receive messages to and from RabbitMQ? I don't understand what  
this socket server is doing apart from relaying data to either Rabbit  
or ejabberd.

Ben


From erik at rigtorp.com  Fri Sep 11 08:37:44 2009
From: erik at rigtorp.com (Erik Rigtorp)
Date: Fri, 11 Sep 2009 09:37:44 +0200
Subject: [rabbitmq-discuss] Question about rabbit_reader.erl
In-Reply-To: <4AA9989A.2010204@lshift.net>
References: <a57051ba0909100900k16d10576gecc56944ef3a5771@mail.gmail.com>
	<4AA9989A.2010204@lshift.net>
Message-ID: <a57051ba0909110037q1b7b82abld11c05d5b91fbfcf@mail.gmail.com>

I see, thanks. I noticed how you used the length argument to
async_recv() in a neat way in rabbit_reader.erl. I'm working on a
system where under som loads there can be a delay of 400+ms between
NIC and receiving the data in an erlang process. I thought that maybe
you had discovered that prim_inet:async_recv() has lower latency.

Erik

On Fri, Sep 11, 2009 at 02:23, Matthias Radestock <matthias at lshift.net> wrote:
> Erik,
>
> Erik Rigtorp wrote:
>>
>> I'm curious about why prim_inet:async_recv() is being used instead of
>> active mode.
>
> {active,once} provides no control over PDU size.
> {active,true} provides no flow control.
> gen_tcp:recv() is blocking.
>
> With prim_inet:async_recv() we can receive exactly the amount of data we
> want, asynchronously.
>
>
> Regards,
>
> Matthias.
>
>



From akalend at mail.ru  Fri Sep 11 08:55:11 2009
From: akalend at mail.ru (akalend)
Date: Fri, 11 Sep 2009 00:55:11 -0700 (PDT)
Subject: [rabbitmq-discuss]  PHP extention for RabbitMQ
Message-ID: <25392517.post@talk.nabble.com>


Hi All

I started project  http://http://code.google.com/p/php-rabbit/ PHP client
for RabbitMQ 

php-rabbit is a PHP extension for Message Queue Server RabbitMQ
(http://www.rabbitmq.com/) and support the AMQP (Advanced Message Queuing
Protocol http://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol ).
The C extension is using the C-rabbitmq client library
(http://hg.rabbitmq.com/rabbitmq-c/).

I hope the extension will very usefull for PHP Fun.

I regret, that API documentation in the developing...


Alexandre


-- 
View this message in context: http://www.nabble.com/PHP-extention-for-RabbitMQ-tp25392517p25392517.html
Sent from the RabbitMQ mailing list archive at Nabble.com.




From temp at logibit.se  Fri Sep 11 20:53:50 2009
From: temp at logibit.se (H)
Date: Fri, 11 Sep 2009 21:53:50 +0200
Subject: [rabbitmq-discuss] Question about erlang service manager
Message-ID: <000001ca3319$956c1d50$c04457f0$@se>

K:\dev\rabbitmq_server-1.6.0\sbin>rabbitmq-service.bat install

RabbitMQ service is already present - only updating service parameters

C:\Program Files (x86)\erl5.7.2\erts-5.7.2\bin\erlsrv: Warning, could not
set co

rrect interactive mode.

Error: The handle is invalid.

 

Steps:

1.       Install service

2.       Start service

3.       Run 
rabbitmq-service.bat remove

4.       See the crash

5.       Run
sc remove RabbitMQ394589

 

Now erlang's service manager believes there's still the service on the
system. How do I remove the bad book-keeping data?

 

I have tried removing erlang and re-adding it. Still the same failure
message. Where does erlsvr save its state and how do I remove it?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090911/c089e702/attachment.htm 

From jasonjwwilliams at gmail.com  Sun Sep 13 03:15:47 2009
From: jasonjwwilliams at gmail.com (Jason J. W. Williams)
Date: Sat, 12 Sep 2009 20:15:47 -0600
Subject: [rabbitmq-discuss] BASIC CONSUME kills existing queue.
Message-ID: <3b949f090909121915s41f0a813ndd4314fc66e0eb82@mail.gmail.com>

Hello,

Usually, we're pretty good about having our consumers use a different
user/pass than our producers. However, in testing a new app, I used
the same for both.

The producer would create the exchange, queue and binding and then
publish to the exchange. So far so good. Everything is durable, and
everything does persist through a reboot of Rabbit as expected.

What's interesting, is if I run my test consumer, which uses the same
user/pass, when I issue a basic_consume() Rabbit claims the queue
doesn't exist. If I do a rabbitmqctl list_queues...sure enough the
queue is gone.

Is this an artifact of RabbitMQ 1.5.0?

Thank you in advance.

-J



From jasonjwwilliams at gmail.com  Sun Sep 13 03:20:13 2009
From: jasonjwwilliams at gmail.com (Jason J. W. Williams)
Date: Sat, 12 Sep 2009 20:20:13 -0600
Subject: [rabbitmq-discuss] BASIC CONSUME kills existing queue.
In-Reply-To: <3b949f090909121915s41f0a813ndd4314fc66e0eb82@mail.gmail.com>
References: <3b949f090909121915s41f0a813ndd4314fc66e0eb82@mail.gmail.com>
Message-ID: <3b949f090909121920r5e257270t22356e33d81a4758@mail.gmail.com>

Please ignore this...the queue was accidentally set to auto_delete. I apologize.

-J

On Sat, Sep 12, 2009 at 8:15 PM, Jason J. W. Williams
<jasonjwwilliams at gmail.com> wrote:
> Hello,
>
> Usually, we're pretty good about having our consumers use a different
> user/pass than our producers. However, in testing a new app, I used
> the same for both.
>
> The producer would create the exchange, queue and binding and then
> publish to the exchange. So far so good. Everything is durable, and
> everything does persist through a reboot of Rabbit as expected.
>
> What's interesting, is if I run my test consumer, which uses the same
> user/pass, when I issue a basic_consume() Rabbit claims the queue
> doesn't exist. If I do a rabbitmqctl list_queues...sure enough the
> queue is gone.
>
> Is this an artifact of RabbitMQ 1.5.0?
>
> Thank you in advance.
>
> -J
>



From jasonjwwilliams at gmail.com  Sun Sep 13 06:39:40 2009
From: jasonjwwilliams at gmail.com (Jason J. W. Williams)
Date: Sat, 12 Sep 2009 23:39:40 -0600
Subject: [rabbitmq-discuss] Python lib for failing over automatically
Message-ID: <3b949f090909122239o54da3b6k691c0f3f15f4f688@mail.gmail.com>

Hi Guys,

I'm not sure if it would help anyone, but we're posting our wrapper
for py-amqplib that handles transparently reconnecting to a new Rabbit
node when an old one dies. It works well for us, but we'd appreciate
any feedback. Hopefully, it'll help other folks with a similar need.

One note is we don't use RMQ clustering (we had some issues around
dead nodes rejoining and not being able to access their persistent
queues post-join). So this library is designed for a scenario where
you have 2 or more Rabbit nodes that are independent. It should work
for a cluster scenario but hasn't been tested for that.

It's missing our code around consuming resiliently (only handles
connections and publishing)...we'll add that as soon as we get it
extracted from our apps and abstracted into this lib.

http://github.com/williamsjj/py-resilient_mq

-J



From joost at zeekat.nl  Mon Sep 14 11:40:49 2009
From: joost at zeekat.nl (Joost Diepenmaat)
Date: Mon, 14 Sep 2009 12:40:49 +0200
Subject: [rabbitmq-discuss] some fixes to the as3-amqp library
Message-ID: <AAAF4372-6B32-4EFB-BD3A-A6BE2C01CBEB@zeekat.nl>


Hi everybody.

On August 29, Ben Hood asked for some clarifications on the fork of
as3-amqp as found at http://github.com/joodie/as3-amqp

I'm the author of that fork, so I'll give it a shot :)

The most important fix in that fork is a couple of lines of buffering
code, meaning the library will now correctly parse AMQP frames even if
they arrive in chunks (multiple onSocketData events). This is important
because sending largish messages will result in multiple onSocketData
events and because AFAIK flash's builtin socket buffers are limited to
only a few dozen Kb of data.

In the mean time I've added a couple more fixes. These are fairly
straightforward: readTable() didn't correctly handle empty tables, and
the insist option to the Open command is now configurable and
defaults to true, because the library doesn't handle redirection
(rabbitmq seems to like redirecting clients in our setup -I'm not sure  
why).

As for the fork os net-amqp and poe-component-client-amqp in my github
account; they're fixes of the perl AMQP libraries which had similar
buffering problems and were missing some functionality that we needed.

I hope that clears that up, but questions and remarks are welcome.

Cheers,
Joost Diepenmaat.




From majek04 at gmail.com  Mon Sep 14 11:57:54 2009
From: majek04 at gmail.com (majek04)
Date: Mon, 14 Sep 2009 11:57:54 +0100
Subject: [rabbitmq-discuss] Performance degrades with increasing queue
	depth
In-Reply-To: <4AA5E501.9000603@lshift.net>
References: <35fd157f0909062307r632ac063k19e70c56992ea96@mail.gmail.com> 
	<58891171-8AEF-4029-8EFB-BE4DD0B0B59A@mac.com>
	<376f3e6f0909070932k70f13b4agd1e137c41e871a5f@mail.gmail.com> 
	<376f3e6f0909070934w17860febg152a940bf5952f9f@mail.gmail.com> 
	<DA74A49F-F030-4720-B7C5-9CC8FF75B02D@mac.com>
	<CECAA69D-6449-4336-9B03-C172D769F975@gmail.com> 
	<e1542d30909071636m422aa17dr468c5cc3b0302e69@mail.gmail.com> 
	<4AA5E501.9000603@lshift.net>
Message-ID: <3bb0d9710909140357h1f38c09aue1da28e4d0324bef@mail.gmail.com>

On Tue, Sep 8, 2009 at 06:00, Matthias Radestock <matthias at lshift.net> wrote:
> I ran the tests and got the following results:
>
> - 20k messages: 500Hz, with beam.smp using 30% of the CPU
>
> - 200k messages: 300Hz, with beam.smp using 45% of the CPU - that kind
> of slowdown is not totally unexpected and probably due to the increased
> cost of gc and the nature of the queue data structure we are using,
>
> - 200k messages: 35Hz, with beam.smp using 95% of the CPU - yes, that's
> right, the same test as the previous one but only 1/9th of the throughput!

I was able to reproduce this results. The slowdown was identified
in basic.get. The real cause is a bit mysterious, it looks like the issue
has something to do with Erlang garbage collection mechanism.

Hopefully, the problematic code was refactored during the work
on new persistor, so RabbitMQ 1.7 will not be affected.

Cheers.
  Marek Majkowski



From majek04 at gmail.com  Mon Sep 14 16:38:06 2009
From: majek04 at gmail.com (majek04)
Date: Mon, 14 Sep 2009 16:38:06 +0100
Subject: [rabbitmq-discuss] Question about erlang service manager
In-Reply-To: <000001ca3319$956c1d50$c04457f0$@se>
References: <000001ca3319$956c1d50$c04457f0$@se>
Message-ID: <3bb0d9710909140838j5f37999fq5710f65108cd3e68@mail.gmail.com>

On Fri, Sep 11, 2009 at 20:53, H <temp at logibit.se> wrote:
> K:\dev\rabbitmq_server-1.6.0\sbin>rabbitmq-service.bat install
> RabbitMQ service is already present - only updating service parameters
> C:\Program Files (x86)\erl5.7.2\erts-5.7.2\bin\erlsrv: Warning, could not
> set correct interactive mode.
> Error: The handle is invalid.
> [...]
> sc remove RabbitMQ394589
>
> I have tried removing erlang and re-adding it. Still the same failure
> message. Where does erlsvr save its state and how do I remove it?

I'm not sure about that. Quick search reveals that there's something
in the registry. Though, be careful if you want to change anything there:
HKEY_LOCAL_MACHINE\SOFTWARE\Ericsson\Erlang\ErlSrv\1.1\RabbitMQ

If you want to remove the service please try "sc remove" command.


Marek Majkowski



From tonyg at lshift.net  Mon Sep 14 16:45:11 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Mon, 14 Sep 2009 16:45:11 +0100
Subject: [rabbitmq-discuss] IModel / thread sharing
In-Reply-To: <150a3aa50909100243s1ae19b67u582f2a60ad89d0cb@mail.gmail.com>
References: <150a3aa50909100243s1ae19b67u582f2a60ad89d0cb@mail.gmail.com>
Message-ID: <4AAE6507.4070403@lshift.net>

Ashley van Gerven wrote:
> The .NET user guide states that IModel instances should not be shared
> accross threads. So having multiple web requests publishing to the queue
> using the same IModel instance is not an option.

Well, not without somehow ensuring that there are no concurrent accesses
to the object, in any case. Here's what the guide says:

 If more than one thread needs to access a particular IModel
 instances, the application should enforce mutual exclusion itself. One
 way of achieving this is for all users of an IModel to lock the
 instance itself:

  IModel ch = RetrieveSomeSharedIModelInstance();
  lock (ch) {
    ch.BasicPublish(...);
  }

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From tonyg at lshift.net  Mon Sep 14 16:48:09 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Mon, 14 Sep 2009 16:48:09 +0100
Subject: [rabbitmq-discuss] Question about rabbit_reader.erl
In-Reply-To: <a57051ba0909110037q1b7b82abld11c05d5b91fbfcf@mail.gmail.com>
References: <a57051ba0909100900k16d10576gecc56944ef3a5771@mail.gmail.com>	<4AA9989A.2010204@lshift.net>
	<a57051ba0909110037q1b7b82abld11c05d5b91fbfcf@mail.gmail.com>
Message-ID: <4AAE65B9.1050907@lshift.net>

Erik Rigtorp wrote:
> system where under som loads there can be a delay of 400+ms between
> NIC and receiving the data in an erlang process.

Do you really mean 400 *milliseconds*? This is practically an eternity
on modern systems. If it really is 400 milliseconds, it sounds like
there are some buffers filling up with backlog somewhere!

Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From erik at rigtorp.com  Mon Sep 14 19:00:43 2009
From: erik at rigtorp.com (Erik Rigtorp)
Date: Mon, 14 Sep 2009 20:00:43 +0200
Subject: [rabbitmq-discuss] Question about rabbit_reader.erl
In-Reply-To: <4AAE65B9.1050907@lshift.net>
References: <a57051ba0909100900k16d10576gecc56944ef3a5771@mail.gmail.com>
	<4AA9989A.2010204@lshift.net>
	<a57051ba0909110037q1b7b82abld11c05d5b91fbfcf@mail.gmail.com>
	<4AAE65B9.1050907@lshift.net>
Message-ID: <a57051ba0909141100o6441bb5eq6d10ffb2eee19de2@mail.gmail.com>

Yes, I'm currently working on instrumenting the Solaris tcp stack and
Erlang with dtrace to measure this properly, not just taking roundtrip
- average network roundtrip time.

On Mon, Sep 14, 2009 at 17:48, Tony Garnock-Jones<tonyg at lshift.net> wrote:
> Erik Rigtorp wrote:
>> system where under som loads there can be a delay of 400+ms between
>> NIC and receiving the data in an erlang process.
>
> Do you really mean 400 *milliseconds*? This is practically an eternity
> on modern systems. If it really is 400 milliseconds, it sounds like
> there are some buffers filling up with backlog somewhere!
>
> Regards,
> ?Tony
> --
> ?[][][] Tony Garnock-Jones ? ? | Mob: +44 (0)7905 974 211
> ? [][] LShift Ltd ? ? ? ? ? ? | Tel: +44 (0)20 7729 7060
> ?[] ?[] http://www.lshift.net/ | Email: tonyg at lshift.net
>
>



From erik at rigtorp.com  Mon Sep 14 19:32:27 2009
From: erik at rigtorp.com (Erik Rigtorp)
Date: Mon, 14 Sep 2009 20:32:27 +0200
Subject: [rabbitmq-discuss] Question about rabbit_reader.erl
In-Reply-To: <47327.1252949943@snookles.snookles.com>
References: <a57051ba0909110037q1b7b82abld11c05d5b91fbfcf@mail.gmail.com>
	<47327.1252949943@snookles.snookles.com>
Message-ID: <a57051ba0909141132l4bd33560vdb1e64c37218741f@mail.gmail.com>

Yes, I know. It's off. :)

On Mon, Sep 14, 2009 at 19:39, Scott Lystig
Fritchie<fritchie at snookles.com> wrote:
> Erik Rigtorp <erik at rigtorp.com> wrote:
>
> er> I'm working on a system where under som loads there can be a delay
> er> of 400+ms between NIC and receiving the data in an erlang process.
>
> It may be purely a coincidence, but 400ms is exactly twice the the delay
> imposed by the Nagle algorithm on a TCP connection that is being used
> "interactively". ?Disabling Nagle may or may not make this latency
> disappear.
>
> -Scott
>
>



From slfritchie at snookles.com  Mon Sep 14 20:11:59 2009
From: slfritchie at snookles.com (Scott Lystig Fritchie)
Date: Mon, 14 Sep 2009 14:11:59 -0500
Subject: [rabbitmq-discuss] Question about rabbit_reader.erl
In-Reply-To: Message of "Fri, 11 Sep 2009 09:37:44 +0200."
	<a57051ba0909110037q1b7b82abld11c05d5b91fbfcf@mail.gmail.com> 
Message-ID: <51993.1252955519@snookles.snookles.com>

Erik Rigtorp <erik at rigtorp.com> wrote:

er> I'm working on a system where under som loads there can be a delay
er> of 400+ms between NIC and receiving the data in an erlang process.

It may be purely a coincidence, but 400ms is exactly twice the the delay
imposed by the Nagle algorithm on a TCP connection that is being used
"interactively".  Disabling Nagle may or may not make this latency
disappear.

-Scott



From alexgentle at sify.com  Mon Sep 14 20:15:32 2009
From: alexgentle at sify.com (Alex Gentle)
Date: Mon, 14 Sep 2009 12:15:32 -0700
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
Message-ID: <fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>

Ben, Socket server is just relaying data back and forth. It's essential to
use socket server, because of the way entire application is set up. My
iPhone app has chat inside in addition to couple of other photo sharing
features. The idea is to use RabbitMq for iPhone chat app to send/receive
messages.

Because the socket server accepts only binary data, I am not sure how do I
send/receive messages to RabbitMQ server. Without socket server in the
picture, it works like a charm, iPhone can send message to RabbitMQ and
receive the responses. But, due to the constraints I have, the message has
to go thru socket server.

another possible problem is that iPhone app has to keep on checking RabbitMQ
for any messages available. This will be a real problem, if I port iPhone
app into a mobile app because of bandwidth it's going to consume.

Thank you.
On Thu, Sep 10, 2009 at 11:38 PM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Alex,
>
> On 10 Sep 2009, at 20:52, Alex Gentle <alexgentle at sify.com> wrote:
>
> I have the following situation. I am thinking of using RabbitMQ for chat
>> inside my iPhone application. iPhone application is connected to the server
>> thru socket server. The socket server passes the information from iPhone to
>> the server and vice versa. I am not sure how could I make this communication
>> path works ? iPhone -> Socket Server -> RabbitMQ server.  I understand that
>> I can connect the client directly to RabbitMQ server using client library
>> you provided. I am not sure how could I pass the message thru socket server.
>>  Socket server basically accepts the incoming message from iPhone and route
>> the message to appropriate server based on header information in the
>> incoming message. It does the same thing when a server wants to communicate
>> to the client thru socket server. Socket server accepts only binary data.
>>  Is it a overkill to use RabbitMQ for this purpose? If I use XMPP like
>> ejabbberd, I would still have the same issue of routing the message thru
>> socket server.  Any help is much appreciated. Thanks!
>>
>
>
> I don't understand your intention. What problem are you actually trying to
> solve? Are you trying to write an iPhone app that can send and receive
> messages to and from RabbitMQ? I don't understand what this socket server is
> doing apart from relaying data to either Rabbit or ejabberd.
>
> Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090914/b7fa3c42/attachment.htm 

From 0x6e6562 at gmail.com  Tue Sep 15 00:12:05 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Tue, 15 Sep 2009 00:12:05 +0100
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
Message-ID: <269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>

Alex,

On Mon, Sep 14, 2009 at 8:15 PM, Alex Gentle <alexgentle at sify.com> wrote:
> Ben, Socket server is just relaying data back and forth. It's essential to
> use socket server, because of the way entire application is set up. My
> iPhone app has chat inside in addition to couple of other photo sharing
> features. The idea is to use RabbitMq for iPhone chat app?to send/receive
> messages.
>
> Because the socket server accepts only binary data, I am not sure how do I
> send/receive messages to RabbitMQ server. Without socket server in the
> picture, it works like a charm, iPhone can send message to RabbitMQ and
> receive the responses. But, due to the constraints I have, the message has
> to go thru socket server.

Alex, you haven't explained why your app can only send a specific
binary stream to a socket - for intents and purposes AMQP is no more
than a *stream* of binary data.

> another possible problem is that iPhone app has to keep on checking RabbitMQ
> for any messages available. This will be a real problem, if I port iPhone
> app into a mobile app because of bandwidth it's going to consume.

I don't know how the network event notification works in iPhone OS 3.x
(i.e. I don't know whether you get it to pre-empt the phone's kernel).

Ben



From alexgentle at sify.com  Tue Sep 15 02:09:54 2009
From: alexgentle at sify.com (Alex Gentle)
Date: Mon, 14 Sep 2009 18:09:54 -0700
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
	<269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
Message-ID: <fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>

>Alex, you haven't explained why your app can only send a specific
>binary stream to a socket - for intents and purposes AMQP is no more
>than a *stream* of binary data.

I am not sure. It's not a specific binary stream, it can be any binary data.
But, this binary data can't be interpreted by RabbitMQ unless I put another
middle layer to translate this into call to RabbitMQ.

>I don't know how the network event notification works in iPhone OS 3.x
>(i.e. I don't know whether you get it to pre-empt the phone's kernel).

Actually it's not related to iPhone. I was mentioning about polling
mechanism in RabbitMQ. Meaning that, RabbitMQ doesn't inform the user when
he gets the message. User has to check every few seconds to see if there is
anything in his queue. So, iPhone app (OR any application for that matter)
needs to constantly check RabbitMQ to see if there is any message. That's
going to cost lot of bandwidth when I port the app to mobile devices.

Thank you for all the answers.





On Mon, Sep 14, 2009 at 4:12 PM, Ben Hood <0x6e6562 at gmail.com> wrote:

> Alex,
>
> On Mon, Sep 14, 2009 at 8:15 PM, Alex Gentle <alexgentle at sify.com> wrote:
> > Ben, Socket server is just relaying data back and forth. It's essential
> to
> > use socket server, because of the way entire application is set up. My
> > iPhone app has chat inside in addition to couple of other photo sharing
> > features. The idea is to use RabbitMq for iPhone chat app to send/receive
> > messages.
> >
> > Because the socket server accepts only binary data, I am not sure how do
> I
> > send/receive messages to RabbitMQ server. Without socket server in the
> > picture, it works like a charm, iPhone can send message to RabbitMQ and
> > receive the responses. But, due to the constraints I have, the message
> has
> > to go thru socket server.
>
> Alex, you haven't explained why your app can only send a specific
> binary stream to a socket - for intents and purposes AMQP is no more
> than a *stream* of binary data.
>
> > another possible problem is that iPhone app has to keep on checking
> RabbitMQ
> > for any messages available. This will be a real problem, if I port iPhone
> > app into a mobile app because of bandwidth it's going to consume.
>
> I don't know how the network event notification works in iPhone OS 3.x
> (i.e. I don't know whether you get it to pre-empt the phone's kernel).
>
> Ben
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090914/e48d57ab/attachment.htm 

From cremes.devlist at mac.com  Tue Sep 15 04:11:39 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Mon, 14 Sep 2009 22:11:39 -0500
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
	<269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
	<fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>
Message-ID: <05CB3FA2-42C9-4B52-B5E1-03B4BB5758A3@mac.com>


On Sep 14, 2009, at 8:09 PM, Alex Gentle wrote:

> >Alex, you haven't explained why your app can only send a specific
> >binary stream to a socket - for intents and purposes AMQP is no more
> >than a *stream* of binary data.
>
> I am not sure. It's not a specific binary stream, it can be any  
> binary data. But, this binary data can't be interpreted by RabbitMQ  
> unless I put another middle layer to translate this into call to  
> RabbitMQ.
>
> >I don't know how the network event notification works in iPhone OS  
> 3.x
> >(i.e. I don't know whether you get it to pre-empt the phone's  
> kernel).
>
> Actually it's not related to iPhone. I was mentioning about polling  
> mechanism in RabbitMQ. Meaning that, RabbitMQ doesn't inform the  
> user when he gets the message. User has to check every few seconds  
> to see if there is anything in his queue. So, iPhone app (OR any  
> application for that matter) needs to constantly check RabbitMQ to  
> see if there is any message. That's going to cost lot of bandwidth  
> when I port the app to mobile devices.
>
> Thank you for all the answers.

You don't need AMQP on your client side at all based upon your  
descriptions. You already have a methodology for contacting a server  
(the socket connection described). The only role for AMQP would be on  
the server side.

I think you might be trying to squeeze AMQP (and rabbit) into a place  
where it doesn't fit.

Why don't you try describing your entire messaging architecture for  
us. Perhaps we can suggest improvements.

cr




From suhail at mixpanel.com  Tue Sep 15 16:56:12 2009
From: suhail at mixpanel.com (Suhail Doshi)
Date: Tue, 15 Sep 2009 08:56:12 -0700
Subject: [rabbitmq-discuss] eheap_alloc error
Message-ID: <376f3e6f0909150856i6def1e17pe51ccf9f918df830@mail.gmail.com>

queue's are marked as durable and persistent on both sides:

Producer:
send_message(Channel, Ticket, X, RoutingKey, Payload) ->
    BasicPublish = #'basic.publish'{ticket = Ticket,
                                    exchange = X,
                                    routing_key = RoutingKey,
                                    mandatory = false,
                                    immediate = false},
    BasicProperties = amqp_util:basic_properties(),
    Properties = BasicProperties#'P_basic'{delivery_mode=2}, %% Persistence
plz
    Content = #content{class_id = 60,
         properties = Properties,
         properties_bin = none,
         payload_fragments_rev = [Payload]
        },
    amqp_channel:cast(Channel, BasicPublish, Content).


I recently just had my producer crash:
                                     <<"event">>,false,false})
Discarding content bearing method ({'basic.publish',1,<<"records">>,
                                       <<"event">>,false,false})
Discarding content bearing method ({'basic.publish',1,<<"records">>,
                                       <<"event">>,false,false})
Discarding content bearing method ({'basic.publish',1,<<"records">>,
                                       <<"event">>,false,false})
Discarding content bearing method ({'basic.publish',1,<<"records">>,
                                       <<"event">>,false,false})
Discarding content bearing method ({'basic.publish',1,<<"records">>,
                                       <<"event">>,false,false})
Discarding content bearing method ({'basic.publish',1,<<"records">>,
                                       <<"event">>,false,false})

Crash dump was written to: erl_crash.dump
eheap_alloc: Cannot allocate 5854930744 bytes of memory (of type
"heap_frag").
Aborted


Dump:

=erl_crash_dump:0.1
Tue Sep 15 11:12:02 2009
Slogan: eheap_alloc: Cannot allocate 5854930744 bytes of memory (of type
"heap_frag").
System version: Erlang R13B01 (erts-5.7.2) [source] [64-bit] [smp:4:4]
[rq:4] [async-threads:0] [hipe] [kernel-poll:false]
Compiled: Tue Jun 23 19:56:26 2009
Atoms: 7600
=memory
total: 7249076328
processes: 7195628192
processes_used: 7195558088
system: 53448136
atom: 509577
atom_used: 496634
binary: 43489256
code: 4768046
ets: 316624
=hash_table:atom_tab
size: 4813
used: 3785
objs: 7600
depth: 8
=index_table:atom_tab
size: 8192
limit: 1048576
entries: 7600
=hash_table:module_code
size: 97
used: 72
objs: 123
depth: 5
=index_table:module_code
size: 1024
limit: 65536
entries: 123
=hash_table:export_list
size: 2411
used: 1798
objs: 3355
depth: 8
=index_table:export_list
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/49589548/attachment.htm 

From suhail at mixpanel.com  Tue Sep 15 17:03:44 2009
From: suhail at mixpanel.com (Suhail Doshi)
Date: Tue, 15 Sep 2009 09:03:44 -0700
Subject: [rabbitmq-discuss] eheap_alloc error
In-Reply-To: <376f3e6f0909150856i6def1e17pe51ccf9f918df830@mail.gmail.com>
References: <376f3e6f0909150856i6def1e17pe51ccf9f918df830@mail.gmail.com>
Message-ID: <376f3e6f0909150903x320b5f1ckc29d7bcfe43e014f@mail.gmail.com>

Doing some investigation into what happened, apparently the memory just
instantly got used, it wasn't leaking something slowly...any ideas?
Attached is an image of memory usage, then the consumer dies freeing up the
memory used later.

On Tue, Sep 15, 2009 at 8:56 AM, Suhail Doshi <suhail at mixpanel.com> wrote:

> queue's are marked as durable and persistent on both sides:
>
> Producer:
> send_message(Channel, Ticket, X, RoutingKey, Payload) ->
>     BasicPublish = #'basic.publish'{ticket = Ticket,
>                                     exchange = X,
>                                     routing_key = RoutingKey,
>                                     mandatory = false,
>                                     immediate = false},
>     BasicProperties = amqp_util:basic_properties(),
>     Properties = BasicProperties#'P_basic'{delivery_mode=2}, %% Persistence
> plz
>     Content = #content{class_id = 60,
>          properties = Properties,
>          properties_bin = none,
>          payload_fragments_rev = [Payload]
>         },
>     amqp_channel:cast(Channel, BasicPublish, Content).
>
>
> I recently just had my producer crash:
>                                      <<"event">>,false,false})
> Discarding content bearing method ({'basic.publish',1,<<"records">>,
>                                        <<"event">>,false,false})
> Discarding content bearing method ({'basic.publish',1,<<"records">>,
>                                        <<"event">>,false,false})
> Discarding content bearing method ({'basic.publish',1,<<"records">>,
>                                        <<"event">>,false,false})
> Discarding content bearing method ({'basic.publish',1,<<"records">>,
>                                        <<"event">>,false,false})
> Discarding content bearing method ({'basic.publish',1,<<"records">>,
>                                        <<"event">>,false,false})
> Discarding content bearing method ({'basic.publish',1,<<"records">>,
>                                        <<"event">>,false,false})
>
> Crash dump was written to: erl_crash.dump
> eheap_alloc: Cannot allocate 5854930744 bytes of memory (of type
> "heap_frag").
> Aborted
>
>
> Dump:
>
> =erl_crash_dump:0.1
> Tue Sep 15 11:12:02 2009
> Slogan: eheap_alloc: Cannot allocate 5854930744 bytes of memory (of type
> "heap_frag").
> System version: Erlang R13B01 (erts-5.7.2) [source] [64-bit] [smp:4:4]
> [rq:4] [async-threads:0] [hipe] [kernel-poll:false]
> Compiled: Tue Jun 23 19:56:26 2009
> Atoms: 7600
> =memory
> total: 7249076328
> processes: 7195628192
> processes_used: 7195558088
> system: 53448136
> atom: 509577
> atom_used: 496634
> binary: 43489256
> code: 4768046
> ets: 316624
> =hash_table:atom_tab
> size: 4813
> used: 3785
> objs: 7600
> depth: 8
> =index_table:atom_tab
> size: 8192
> limit: 1048576
> entries: 7600
> =hash_table:module_code
> size: 97
> used: 72
> objs: 123
> depth: 5
> =index_table:module_code
> size: 1024
> limit: 65536
> entries: 123
> =hash_table:export_list
> size: 2411
> used: 1798
> objs: 3355
> depth: 8
> =index_table:export_list
>



-- 
http://mixpanel.com
Blog: http://blog.mixpanel.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/ecc29a59/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Picture 2.png
Type: image/png
Size: 40630 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/ecc29a59/attachment.png 

From pkirsanov at 38studios.com  Tue Sep 15 17:27:38 2009
From: pkirsanov at 38studios.com (Philippe Kirsanov)
Date: Tue, 15 Sep 2009 12:27:38 -0400
Subject: [rabbitmq-discuss] Channel and basicAck
Message-ID: <D1AC29FC5C9E644C91BE7C9294BF701B024FCEE8@gmg-maynard-mai.greenmonstergames.net>

I'm using Java library and basicConsume to receive messages.

Messages are retrieved and queued without ack and I need to ack messages
before I start process it. Since channels are not thread-safe and I
noticed that delivery tag is channel-specific (I cannot use different
channel to ack message received by other channel), what is proper way to
ack messages? Channel that receives messages leaves in Connection thread
(this is the way Java lib works), but ack needs to be sent from another
thread.

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/616c0767/attachment.htm 

From pkirsanov at 38studios.com  Tue Sep 15 17:28:21 2009
From: pkirsanov at 38studios.com (Philippe Kirsanov)
Date: Tue, 15 Sep 2009 12:28:21 -0400
Subject: [rabbitmq-discuss] using BasicProperties fields
Message-ID: <D1AC29FC5C9E644C91BE7C9294BF701B024FCEEB@gmg-maynard-mai.greenmonstergames.net>

I'm looking into using some message properties like messageid, replyto,
expiration, timestamp, userid, appid

 

I wander if those are available to use or rabbitmq/java lib may use it
future?

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/40fd74de/attachment.htm 

From alexgentle at sify.com  Wed Sep 16 01:19:02 2009
From: alexgentle at sify.com (Alex Gentle)
Date: Tue, 15 Sep 2009 17:19:02 -0700
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <05CB3FA2-42C9-4B52-B5E1-03B4BB5758A3@mac.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
	<269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
	<fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>
	<05CB3FA2-42C9-4B52-B5E1-03B4BB5758A3@mac.com>
Message-ID: <fb0723210909151719k60e16a76g32ea8b6dadd1da3c@mail.gmail.com>

>You don't need AMQP on your client side at all based upon your
>descriptions. You already have a methodology for contacting a server
>(the socket connection described). The only role for AMQP would be on
>the server side.

I am not sure how you got that impression. I am not using AMQP on the client
side. I never mentioned it like that. iPhone is the client. AMQP (RabbitMQ)
is installed in our server.

>I think you might be trying to squeeze AMQP (and rabbit) into a place
>where it doesn't fit.
>Why don't you try describing your entire messaging architecture for
>us. Perhaps we can suggest improvements.

Here it is...

iPhone app -> socket server -> RabbitMQ server

iPhone app has some social networking features in addition to the chat
component. Think of it like mini-facebook inside iPhone. When a user types a
message inside chat window of iPhone app, the message travels to Socket
server which directs the message depending on what is on the message header.
If the message header says "this message is for RabbitMQ", socket server
will route to RabbitMQ. When a message comes from RabbitMQ to socket server,
it should have message header that says "Route this to xxxxxx user". Then,
socket server will route the message to appropriate user(s).

It all looks good, but it doesn't work. Because I don't know how to make a
call to RabbitMQ using the message from socket server and how to pass the
message from RabbitMQ to socket server in binary format.

Thanks.


On Mon, Sep 14, 2009 at 8:11 PM, Chuck Remes <cremes.devlist at mac.com> wrote:

>
> On Sep 14, 2009, at 8:09 PM, Alex Gentle wrote:
>
> > >Alex, you haven't explained why your app can only send a specific
> > >binary stream to a socket - for intents and purposes AMQP is no more
> > >than a *stream* of binary data.
> >
> > I am not sure. It's not a specific binary stream, it can be any
> > binary data. But, this binary data can't be interpreted by RabbitMQ
> > unless I put another middle layer to translate this into call to
> > RabbitMQ.
> >
> > >I don't know how the network event notification works in iPhone OS
> > 3.x
> > >(i.e. I don't know whether you get it to pre-empt the phone's
> > kernel).
> >
> > Actually it's not related to iPhone. I was mentioning about polling
> > mechanism in RabbitMQ. Meaning that, RabbitMQ doesn't inform the
> > user when he gets the message. User has to check every few seconds
> > to see if there is anything in his queue. So, iPhone app (OR any
> > application for that matter) needs to constantly check RabbitMQ to
> > see if there is any message. That's going to cost lot of bandwidth
> > when I port the app to mobile devices.
> >
> > Thank you for all the answers.
>
> You don't need AMQP on your client side at all based upon your
> descriptions. You already have a methodology for contacting a server
> (the socket connection described). The only role for AMQP would be on
> the server side.
>
> I think you might be trying to squeeze AMQP (and rabbit) into a place
> where it doesn't fit.
>
> Why don't you try describing your entire messaging architecture for
> us. Perhaps we can suggest improvements.
>
> cr
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/1afa8faa/attachment.htm 

From cremes.devlist at mac.com  Wed Sep 16 03:27:49 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Tue, 15 Sep 2009 21:27:49 -0500
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <fb0723210909151719k60e16a76g32ea8b6dadd1da3c@mail.gmail.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
	<269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
	<fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>
	<05CB3FA2-42C9-4B52-B5E1-03B4BB5758A3@mac.com>
	<fb0723210909151719k60e16a76g32ea8b6dadd1da3c@mail.gmail.com>
Message-ID: <9D816149-C7F0-46CE-9C46-89A3C5518EE0@mac.com>


On Sep 15, 2009, at 7:19 PM, Alex Gentle wrote:

> iPhone app -> socket server -> RabbitMQ server

Great, this is very helpful.

> iPhone app has some social networking features in addition to the  
> chat component. Think of it like mini-facebook inside iPhone. When a  
> user types a message inside chat window of iPhone app, the message  
> travels to Socket server which directs the message depending on what  
> is on the message header. If the message header says "this message  
> is for RabbitMQ", socket server will route to RabbitMQ. When a  
> message comes from RabbitMQ to socket server, it should have message  
> header that says "Route this to xxxxxx user". Then, socket server  
> will route the message to appropriate user(s).
>
> It all looks good, but it doesn't work. Because I don't know how to  
> make a call to RabbitMQ using the message from socket server and how  
> to pass the message from RabbitMQ to socket server in binary format.

Ah, this is good.

You need to declare an exchange (of type direct, fanout or topic)  
which acts as the mailbox for sending the message. Once you have  
parsed the message from socket server and determined it should go to  
rabbit, you publish the message to it. Here's some ruby code  
(commented).

def publish_message_to_rabbit(message)
   # declare the exchange
   exchange = MQ.direct 'mailbox'

   # send the message
   exchange.publish(message, :key => 'some.routing.key')
end

Next, you need to have a client somewhere that is listening for  
messages. You need to allocate a queue to receive the message and  
subscribe to the routing key. Again, some ruby code.

def listen_for_rabbit_messages
   # redeclare the exchange; idempotent operation
   exchange = MQ.direct 'mailbox'

   # declare a queue to receive the messages
   queue = MQ.queue 'mailslot'

   # bind the queue to the exchange and match incoming messages against
   # the specified routing key
   queue.bind(exchange, :key => 'some.routing.key').subscribe do | 
message|
     # this block is called each time a message is received
     # do your message processing here
   end
end

Does this help? I highly recommend you take a look through the sample  
code and come back with specific questions.

cr




From 0x6e6562 at gmail.com  Wed Sep 16 09:04:07 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Wed, 16 Sep 2009 09:04:07 +0100
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <fb0723210909151719k60e16a76g32ea8b6dadd1da3c@mail.gmail.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
	<269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
	<fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>
	<05CB3FA2-42C9-4B52-B5E1-03B4BB5758A3@mac.com>
	<fb0723210909151719k60e16a76g32ea8b6dadd1da3c@mail.gmail.com>
Message-ID: <269388e30909160104s6085c338w9a17ddfff2daebfb@mail.gmail.com>

Alex,

On Wed, Sep 16, 2009 at 1:19 AM, Alex Gentle <alexgentle at sify.com> wrote:
> It all looks good, but it doesn't work. Because I don't know how to make a
> call to RabbitMQ using the message from socket server and how to pass the
> message from RabbitMQ to socket server in binary format.

Now I see what your issue is - effectively it has nothing to do with
the iPhone. It's just a case of how to program your socket server
handler to talk to Rabbit in a sensible way. The way you formulated
your original question indicated that you were actually thinking of
running a Rabbit client on the iPhone.

Ben



From majek04 at gmail.com  Wed Sep 16 12:48:20 2009
From: majek04 at gmail.com (majek04)
Date: Wed, 16 Sep 2009 12:48:20 +0100
Subject: [rabbitmq-discuss] eheap_alloc error
In-Reply-To: <376f3e6f0909150903x320b5f1ckc29d7bcfe43e014f@mail.gmail.com>
References: <376f3e6f0909150856i6def1e17pe51ccf9f918df830@mail.gmail.com> 
	<376f3e6f0909150903x320b5f1ckc29d7bcfe43e014f@mail.gmail.com>
Message-ID: <3bb0d9710909160448g2896f872k552dfbbbf689f7e2@mail.gmail.com>

On Tue, Sep 15, 2009 at 17:03, Suhail Doshi <suhail at mixpanel.com> wrote:
> Doing some investigation into what happened, apparently the memory just
> instantly got used, it wasn't leaking something slowly...any ideas?
> Attached is an image of memory usage, then the consumer dies freeing up the
> memory used later.

It looks like erlang was trying to allocate 5 gigs of RAM, and failed.
This could have happened during garbage collection, but only
if a single erlang process was using all the memory.

Do you have a single large queue?
Are you sure that the queue had reasonable size during the crash?
Maybe all the consumers had died and rabbit just ran out of memory?

Cheers!
  Marek Majkowski



From tsuraan at gmail.com  Wed Sep 16 18:04:32 2009
From: tsuraan at gmail.com (tsuraan)
Date: Wed, 16 Sep 2009 12:04:32 -0500
Subject: [rabbitmq-discuss] Erlang has closed
Message-ID: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>

As RabbitMQ is running, I sometimes get messages saying "Erlang has
closed".  These don't seem to be associated with any actual failure or
shutdown; a single long-running rabbit will sometimes have a dozen or
more "Erlang has closed" messages on its standard output.  Rabbit is
still running fine, and I don't see any problems, but the message is a
bit strange.  I also see, in my logs, this triplet of messages:

=INFO REPORT==== 16-Sep-2009::16:45:48 ===
    application: rabbit
    exited: stopped
    type: temporary

=INFO REPORT==== 16-Sep-2009::16:45:48 ===
    application: mnesia
    exited: stopped
    type: temporary

=INFO REPORT==== 16-Sep-2009::16:45:48 ===
    application: os_mon
    exited: stopped
    type: temporary

I don't think those are associated with any interruption either, but
maybe the system is just recovering from that.  Anyhow, some sort of
advice on what these mean, and why I don't need to worry about them
would be great :-)



From brian at echonest.com  Wed Sep 16 18:09:32 2009
From: brian at echonest.com (Brian Whitman)
Date: Wed, 16 Sep 2009 13:09:32 -0400
Subject: [rabbitmq-discuss] broker goes down after many new connections
	started
Message-ID: <dbd9700a0909161009j59221975n6675c0f4a0a2f0a6@mail.gmail.com>

We have a series of machines that we boot at once that all consume and
produce messages on about 20 different queues all to the same broker. The
broker has been terminating when these machines boot recently. We're not
sure why. Here's some log data:
=ERROR REPORT==== 16-Sep-2009::11:48:52 ===
** Generic server <0.2390.0> terminating
** Last message in was {inet_async,#Port<0.3893>,173,{ok,#Port<0.430698>}}
** When Server state == none
** Reason for termination ==
** {cannot_accept,{error,emfile}}


=ERROR REPORT==== 16-Sep-2009::11:48:52 ===
** gen_event handler rabbit_sasl_report_file_h crashed.
** Was installed in error_logger
** Last event was: {error_report,<0.101.0>,
                       {<0.2390.0>,crash_report,

 [[{initial_call,{tcp_acceptor,init,['Argument__1']}},
                          {pid,<0.2390.0>},
                          {registered_name,[]},
                          {error_info,
                              {exit,
                                  {cannot_accept,{error,emfile}},
                                  [{gen_server,terminate,6},
                                   {proc_lib,init_p_do_apply,3}]}},
                          {ancestors,
                              ['tcp_acceptor_sup_0.0.0.0:5672',<0.2387.0>,
                               rabbit_sup,<0.102.0>]},
                          {messages,[]},
                          {links,[<0.2388.0>]},
                          {dictionary,[]},
                          {trap_exit,false},
                          {status,running},
                          {heap_size,377},
                          {stack_size,24},
                          {reductions,597485}],
                         []]}}
** When handler state ==
{<0.48.0>,"/var/log/rabbitmq/rabbit-sasl.log",error}
** Reason == {'module could not be loaded',
                 [{lib,format_exception,
                      [5,exit,
                       {cannot_accept,{error,emfile}},

[{gen_server,terminate,6},{proc_lib,init_p_do_apply,3}],

#Fun<proc_lib.0.17830618>,#Fun<proc_lib.1.112399459>]},
                  {proc_lib,format_exception,3},
                  {proc_lib,format_rep,1},
                  {proc_lib,format_rep,1},
                  {proc_lib,format_rep,1},
                  {proc_lib,format,1},
                  {sasl_report,write_report2,4},
                  {sasl_report_file_h,handle_event,2}]}

=ERROR REPORT==== 16-Sep-2009::11:51:21 ===
Mnesia(rabbit at echonest03): ** ERROR ** (could not write core file: emfile)
 ** FATAL ** Cannot open log file
"/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.TMP": {file_error,


"/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.TMP",

                  emfile}

=INFO REPORT==== 16-Sep-2009::11:51:21 ===
    application: mnesia
    exited: shutdown
    type: temporary

=ERROR REPORT==== 16-Sep-2009::11:51:22 ===
** Generic server <0.1742.15> terminating
** Last message in was {'$gen_cast',
                           {method,
                               {'basic.get',1,

<<"blank_renderer_queue_priority">>,false},
                               none}}
** When Server state ==
{ch,running,1,<0.1727.15>,<0.1740.15>,undefined,none,
                            {set,0,16,16,8,80,48,
                                 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]},

{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                   [],[]}}},
                            1,
                            {[],[]},
                            {[],[]},
                      ...
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090916/ec8339bf/attachment.htm 

From Franck.Boisson at mlp.com  Thu Sep 17 02:10:06 2009
From: Franck.Boisson at mlp.com (Boisson, Franck)
Date: Thu, 17 Sep 2009 09:10:06 +0800
Subject: [rabbitmq-discuss] Monitoring an AMQP Exchange/Queue in
	Java...Problem with passive creation
Message-ID: <1590A5C25AF3E9438F4232897EEFA514AB1576@EXCHSI001.AD.MLP.COM>

H,

 

Here is my problem (quickly explained on the rabbitmq IRC channel):

21:48:29 | <Franckyky> Hello guys

21:48:56 | <Franckyky> Do you know how to monitor an exchange or a queue
in order to detect when it goes down ?

21:49:42 | <Franckyky> for the moment, I am doing it every 5 sec: create
a tmp channel, try to declare the queue/exchange with passive=true,
abort the tmp channel

21:50:07 | <Franckyky> This is working for a moment but seems that
sometimes it fail

21:50:26 | <Franckyky> without any reason (when I look on the rabbitmq
server, exchange/queue is still alive)

21:50:29 | <Franckyky> any idea?

 

Hereunder is my isExchangeExists java function as an exemple of what I
am doing:

public boolean isExchangeExists(String exchangeId, String exchangeType)
throws Exception{

    boolean toReturn = true; 

    Channel tmpChannel = null;

    synchronized(this.amqpMainConnection){

      try{

        tmpChannel = this.amqpMainConnection.createChannel();

      }catch(Exception exc){

        throw new Exception ("Unable to create a temporary channel to
check if exchange " + 

                             exchangeId + " exists [" + exc.getMessage()
+ "]");

      }

    }

    try{

      // Try to create the exchange as passive (will raise an exception
if not exists)

      tmpChannel.exchangeDeclare(exchangeId, exchangeType, true, false,
false, null); //exchange, type, passive, durable, autoDelete, arguments

    }catch(Exception exc){

      toReturn = false;

    }finally{

      try{ tmpChannel.abort(); }catch(Exception unmanagedExc){}

      tmpChannel = null;

    }

    return toReturn;    

  }

 

Do you have any idea about what is happening here?

 

Best regards

Franck

 

 


######################################################################
The information contained in this communication is confidential and
may contain information that is privileged or exempt from disclosure
under applicable law. If you are not a named addressee, please notify
the sender immediately and delete this email from your system.
If you have received this communication, and are not a named
recipient, you are hereby notified that any dissemination,
distribution or copying of this communication is strictly prohibited.
######################################################################
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090917/ad5fb6fb/attachment.htm 

From matthias at lshift.net  Thu Sep 17 10:47:19 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 17 Sep 2009 10:47:19 +0100
Subject: [rabbitmq-discuss] Channel and basicAck
In-Reply-To: <D1AC29FC5C9E644C91BE7C9294BF701B024FCEE8@gmg-maynard-mai.greenmonstergames.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B024FCEE8@gmg-maynard-mai.greenmonstergames.net>
Message-ID: <4AB205A7.9080903@lshift.net>

Philippe,

Philippe Kirsanov wrote:
> I'm using Java library and basicConsume to receive messages.
> 
> Messages are retrieved and queued without ack and I need to ack messages 
> before I start process it. Since channels are not thread-safe and I 
> noticed that delivery tag is channel-specific (I cannot use different 
> channel to ack message received by other channel), what is proper way to 
> ack messages? Channel that receives messages leaves in Connection thread 
> (this is the way Java lib works), but ack needs to be sent from another 
> thread.

The use of a channel by the connection thread is thread-safe. So you 
only have to ensure that there aren't multiple *application* threads 
interacting with the channel concurrently.


Regards,

Matthias.



From matthias at lshift.net  Thu Sep 17 10:58:55 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 17 Sep 2009 10:58:55 +0100
Subject: [rabbitmq-discuss] using BasicProperties fields
In-Reply-To: <D1AC29FC5C9E644C91BE7C9294BF701B024FCEEB@gmg-maynard-mai.greenmonstergames.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B024FCEEB@gmg-maynard-mai.greenmonstergames.net>
Message-ID: <4AB2085F.6020500@lshift.net>

Philippe,

Philippe Kirsanov wrote:
> I'm looking into using some message properties like messageid, replyto, 
> expiration, timestamp, userid, appid
> 
> I wander if those are available to use or rabbitmq/java lib may use it 
> future?

At the moment all message properties except delivery-mode are ignored by 
the server, so you can use them in applications as you please.

A few of the properties, such as expiration and message-id, may be 
inspected by the server as part of some future extension.

I do not envisage the core client libraries to ever do anything with 
these properties other than pass them between the app and the broker.

There are, however, layers on top of the core libraries which use some 
of these properties. See, for example, 
com.rabbitmq.client.Rcp{Client,Server}. More will follow.


Regards,

Matthias.



From 0x6e6562 at gmail.com  Thu Sep 17 11:10:29 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 17 Sep 2009 11:10:29 +0100
Subject: [rabbitmq-discuss] Monitoring an AMQP Exchange/Queue in
	Java...Problem with passive creation
In-Reply-To: <1590A5C25AF3E9438F4232897EEFA514AB1576@EXCHSI001.AD.MLP.COM>
References: <1590A5C25AF3E9438F4232897EEFA514AB1576@EXCHSI001.AD.MLP.COM>
Message-ID: <269388e30909170310if63b959ve978d55b22f876e@mail.gmail.com>

Hey Franck,

On Thu, Sep 17, 2009 at 2:10 AM, Boisson, Franck <Franck.Boisson at mlp.com> wrote:
> Do you have any idea about what is happening here?

Do you have any diagnostics that can help us out here like some server
log files or stack traces?

BTW the disappearance of queues is in general an issue because the
protocol does not mandate any normative behaviour in this scenario -
i.e. there is no defined way of informing a consumer that a queue has
gone AWOL.

Ben



From 0x6e6562 at gmail.com  Thu Sep 17 11:15:36 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 17 Sep 2009 11:15:36 +0100
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
Message-ID: <269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>

Tsuraan,

On Wed, Sep 16, 2009 at 6:04 PM, tsuraan <tsuraan at gmail.com> wrote:
> As RabbitMQ is running, I sometimes get messages saying "Erlang has
> closed". ?These don't seem to be associated with any actual failure or
> shutdown; a single long-running rabbit will sometimes have a dozen or
> more "Erlang has closed" messages on its standard output. ?Rabbit is
> still running fine, and I don't see any problems, but the message is a
> bit strange. ?I also see, in my logs, this triplet of messages:

Is there anything in the sasl log?

Ben



From Franck.Boisson at mlp.com  Thu Sep 17 11:30:40 2009
From: Franck.Boisson at mlp.com (Boisson, Franck)
Date: Thu, 17 Sep 2009 18:30:40 +0800
Subject: [rabbitmq-discuss] Monitoring an AMQP Exchange/Queue in
	Java...Problem with passive creation
In-Reply-To: <269388e30909170310if63b959ve978d55b22f876e@mail.gmail.com>
References: <1590A5C25AF3E9438F4232897EEFA514AB1576@EXCHSI001.AD.MLP.COM>
	<269388e30909170310if63b959ve978d55b22f876e@mail.gmail.com>
Message-ID: <1590A5C25AF3E9438F4232897EEFA514AB1583@EXCHSI001.AD.MLP.COM>

Hey Ben,

Unfortunately I do not have any logs from the rabbitmq server for the
moment. The problem occure every day but I still don't know how to
reproduce it so I will have to wait until the next crash to send you
some logs.

All I know for the moment is that, on the Java side, the problem occure
during the temporary channel creation (tmpChannel =
this.amqpMainConnection.createChannel();). It do not raise any error but
it return null (wich raise after that a nullPointerException on my
program).

Franck

-----Original Message-----
From: Ben Hood [mailto:0x6e6562 at gmail.com] 
Sent: Thursday, September 17, 2009 6:10 PM
To: Boisson, Franck
Cc: rabbitmq
Subject: Re: [rabbitmq-discuss] Monitoring an AMQP Exchange/Queue in
Java...Problem with passive creation

Hey Franck,

On Thu, Sep 17, 2009 at 2:10 AM, Boisson, Franck
<Franck.Boisson at mlp.com> wrote:
> Do you have any idea about what is happening here?

Do you have any diagnostics that can help us out here like some server
log files or stack traces?

BTW the disappearance of queues is in general an issue because the
protocol does not mandate any normative behaviour in this scenario -
i.e. there is no defined way of informing a consumer that a queue has
gone AWOL.

Ben
######################################################################
The information contained in this communication is confidential and
may contain information that is privileged or exempt from disclosure
under applicable law. If you are not a named addressee, please notify
the sender immediately and delete this email from your system.
If you have received this communication, and are not a named
recipient, you are hereby notified that any dissemination,
distribution or copying of this communication is strictly prohibited.
######################################################################



From matthias at lshift.net  Thu Sep 17 13:28:13 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 17 Sep 2009 13:28:13 +0100
Subject: [rabbitmq-discuss] broker goes down after many new connections
 started
In-Reply-To: <dbd9700a0909161009j59221975n6675c0f4a0a2f0a6@mail.gmail.com>
References: <dbd9700a0909161009j59221975n6675c0f4a0a2f0a6@mail.gmail.com>
Message-ID: <4AB22B5D.4070205@lshift.net>

Brian,

Brian Whitman wrote:
> We have a series of machines that we boot at once that all consume and 
> produce messages on about 20 different queues all to the same broker. 
> The broker has been terminating when these machines boot recently.

The errors are indicating that rabbit is running out of file descriptors.

Either your clients are misbehaving and opening lots of connections when 
they shouldn't (or perhaps they are not closing them properly), or the 
fd limit set by the OS is too low.


Regards,

Matthias.



From 0x6e6562 at gmail.com  Thu Sep 17 13:31:48 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 17 Sep 2009 13:31:48 +0100
Subject: [rabbitmq-discuss] Monitoring an AMQP Exchange/Queue in
	Java...Problem with passive creation
In-Reply-To: <1590A5C25AF3E9438F4232897EEFA514AB1583@EXCHSI001.AD.MLP.COM>
References: <1590A5C25AF3E9438F4232897EEFA514AB1576@EXCHSI001.AD.MLP.COM>
	<269388e30909170310if63b959ve978d55b22f876e@mail.gmail.com>
	<1590A5C25AF3E9438F4232897EEFA514AB1583@EXCHSI001.AD.MLP.COM>
Message-ID: <269388e30909170531n3976ee41m8fbd588e7d09e8d4@mail.gmail.com>

Franck,

On Thu, Sep 17, 2009 at 11:30 AM, Boisson, Franck
<Franck.Boisson at mlp.com> wrote:
> All I know for the moment is that, on the Java side, the problem occure
> during the temporary channel creation (tmpChannel =
> this.amqpMainConnection.createChannel();). It do not raise any error but
> it return null (wich raise after that a nullPointerException on my
> program).

Interesting. The createChannel should not usually return null. This
can happen for example if you exhaust the maximum amount of channels
per connection (which is a unsigned 16 bit integer). Are you creating
lots of channels and not closing them? Another possibility is a bug
that we fixed recently - see this thread for details:
http://www.nabble.com/Issue-in-Java-client-while-fetching-channel-td24814076.html

Ben



From Franck.Boisson at mlp.com  Thu Sep 17 14:25:14 2009
From: Franck.Boisson at mlp.com (Boisson, Franck)
Date: Thu, 17 Sep 2009 21:25:14 +0800
Subject: [rabbitmq-discuss] Monitoring an AMQP Exchange/Queue in
	Java...Problem with passive creation
In-Reply-To: <269388e30909170531n3976ee41m8fbd588e7d09e8d4@mail.gmail.com>
References: <1590A5C25AF3E9438F4232897EEFA514AB1576@EXCHSI001.AD.MLP.COM>
	<269388e30909170310if63b959ve978d55b22f876e@mail.gmail.com>
	<1590A5C25AF3E9438F4232897EEFA514AB1583@EXCHSI001.AD.MLP.COM>
	<269388e30909170531n3976ee41m8fbd588e7d09e8d4@mail.gmail.com>
Message-ID: <1590A5C25AF3E9438F4232897EEFA514CF2A43@EXCHSI001.AD.MLP.COM>

As you can see in my exemple, I am systematically  aborting every temp
channel I am creating.
In a previous test, I was looking a the channel number I was getting for
the temporary one and it was the same for all.

I will have a look to your link tks

-----Original Message-----
From: Ben Hood [mailto:0x6e6562 at gmail.com] 
Sent: Thursday, September 17, 2009 8:32 PM
To: Boisson, Franck
Cc: rabbitmq
Subject: Re: [rabbitmq-discuss] Monitoring an AMQP Exchange/Queue in
Java...Problem with passive creation

Franck,

On Thu, Sep 17, 2009 at 11:30 AM, Boisson, Franck
<Franck.Boisson at mlp.com> wrote:
> All I know for the moment is that, on the Java side, the problem
occure
> during the temporary channel creation (tmpChannel =
> this.amqpMainConnection.createChannel();). It do not raise any error
but
> it return null (wich raise after that a nullPointerException on my
> program).

Interesting. The createChannel should not usually return null. This
can happen for example if you exhaust the maximum amount of channels
per connection (which is a unsigned 16 bit integer). Are you creating
lots of channels and not closing them? Another possibility is a bug
that we fixed recently - see this thread for details:
http://www.nabble.com/Issue-in-Java-client-while-fetching-channel-td2481
4076.html

Ben
######################################################################
The information contained in this communication is confidential and
may contain information that is privileged or exempt from disclosure
under applicable law. If you are not a named addressee, please notify
the sender immediately and delete this email from your system.
If you have received this communication, and are not a named
recipient, you are hereby notified that any dissemination,
distribution or copying of this communication is strictly prohibited.
######################################################################



From tsuraan at gmail.com  Thu Sep 17 14:38:39 2009
From: tsuraan at gmail.com (tsuraan)
Date: Thu, 17 Sep 2009 08:38:39 -0500
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
Message-ID: <84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>

> Is there anything in the sasl log?

Yeah.  I've never seen anything in that file before, but there is today:

=CRASH REPORT==== 18-Sep-2009::21:08:20 ===
  crasher:
    pid: <0.26060.21>
    registered_name: []
    exception error: bad argument in an arithmetic expression
      in function  rabbit_load:pick/0
      in call from rabbit_reader:compute_redirects/1
      in call from rabbit_reader:handle_method0/2
      in call from rabbit_reader:handle_method0/3
      in call from rabbit_reader:handle_input/3
      in call from rabbit_reader:mainloop/3
      in call from rabbit_reader:start_connection/3
    initial call: rabbit_reader:init(<0.171.0>)
    ancestors: [rabbit_tcp_client_sup,rabbit_sup,<0.108.0>]
    messages: []
    links: [#Port<0.208888>,<0.171.0>]
    dictionary: []
    trap_exit: true
    status: running
    heap_size: 610
    stack_size: 23
    reductions: 699
  neighbours:

=SUPERVISOR REPORT==== 18-Sep-2009::21:08:20 ===
     Supervisor: {local,rabbit_tcp_client_sup}
     Context:    child_terminated
     Reason:     badarith
     Offender:   [{pid,<0.26060.21>},
                  {name,tcp_client},
                  {mfa,{rabbit_reader,start_link,[]}},
                  {restart_type,temporary},
                  {shutdown,brutal_kill},
                  {child_type,worker}]

This is 1.6.0, running on a badly overloaded machine with a degraded
RAID array :)  Either way, I'm guessing that the badarith is actually
a bug of some sort?



From 0x6e6562 at gmail.com  Thu Sep 17 16:10:36 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 17 Sep 2009 16:10:36 +0100
Subject: [rabbitmq-discuss] Monitoring an AMQP Exchange/Queue in
	Java...Problem with passive creation
In-Reply-To: <1590A5C25AF3E9438F4232897EEFA514CF2A44@EXCHSI001.AD.MLP.COM>
References: <1590A5C25AF3E9438F4232897EEFA514AB1576@EXCHSI001.AD.MLP.COM>
	<269388e30909170310if63b959ve978d55b22f876e@mail.gmail.com>
	<1590A5C25AF3E9438F4232897EEFA514AB1583@EXCHSI001.AD.MLP.COM>
	<269388e30909170531n3976ee41m8fbd588e7d09e8d4@mail.gmail.com>
	<1590A5C25AF3E9438F4232897EEFA514CF2A44@EXCHSI001.AD.MLP.COM>
Message-ID: <269388e30909170810m61b8b66dw1f86d277dd96e430@mail.gmail.com>

Franck,

On Thu, Sep 17, 2009 at 2:30 PM, Boisson, Franck <Franck.Boisson at mlp.com> wrote:
> I reply out of the thread to not polute it.

I think it's OK to reply on the thread - otherwise information just gets lost.

> Seems that's the bug described in you link feet mine (I am running my
> app on java 1.0.6_16 on a 64 bit linux).
>
> Will try to recompile everything with the bug21333 branch (should I take
> this one or the trunk or another tag? As far a I understand, the fix is
> not included in any official release yet. Isn't it?

bug21333 has been QA'ed and hence has already landed on the mainline
so all you need to do to get the fix is to update to the latest
version of the default branch in hg.

Ben



From 0x6e6562 at gmail.com  Thu Sep 17 16:24:15 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Thu, 17 Sep 2009 16:24:15 +0100
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
Message-ID: <269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>

Tsuraan,

On Thu, Sep 17, 2009 at 2:38 PM, tsuraan <tsuraan at gmail.com> wrote:
> ? ?exception error: bad argument in an arithmetic expression
> ? ? ?in function ?rabbit_load:pick/0

I've seen this symptom before, but the circumstances were a bit
contrived - the way the output from uptime was being processed on OSX
- see http://erlang.org/pipermail/erlang-questions/2008-May/034889.html.

However, I'm not convinced that this has anything to do with what you
are seeing.

Can you provide us with some more details of the environment? Is it
possible to isolate the code that can reproduce this?

Ben



From tsuraan at gmail.com  Thu Sep 17 16:43:53 2009
From: tsuraan at gmail.com (tsuraan)
Date: Thu, 17 Sep 2009 10:43:53 -0500
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
Message-ID: <84fb38e30909170843y4bb89795q52cbf623cb8e9f42@mail.gmail.com>

> I've seen this symptom before, but the circumstances were a bit
> contrived - the way the output from uptime was being processed on OSX
> - see http://erlang.org/pipermail/erlang-questions/2008-May/034889.html.
>
> However, I'm not convinced that this has anything to do with what you
> are seeing.
>
> Can you provide us with some more details of the environment? Is it
> possible to isolate the code that can reproduce this?

It's Rabbit 1.6.0 on linux, 2.6.27 kernel.  The machine has a degraded
(rebuilding) RAID5 array, so its disk IO is stuck at a max of around
6MB/s.  At the time of the errors, the system load was between 8 and
15, for an 8-core machine with 4GB RAM.  There's a chance that it was
also swapping, but I wasn't watching that.  Its swap isn't empty, so
it certainly has swapped at some point.

The system was processing a new chunk of data, which took around 8
hours to complete.  From the MQ point of view, there were probably a
few million messages enqueued (well, at least dispatched to consumers;
I realize that rabbit tries really hard not to actually "enqueue"
messages), but no more than 100,000 messages at any one time.  I can
try simulating the message flows on a system with a really high load
to see if I can make the problem occur reliably, but we have rabbit on
a few dozen machines, and it doesn't look like it happens often.

I can give more details if you can think of anything more specific
that would be useful.  I can't share our source code, but I'll try to
come up with a repeatable test case.



From suhail at mixpanel.com  Thu Sep 17 17:45:49 2009
From: suhail at mixpanel.com (Suhail Doshi)
Date: Thu, 17 Sep 2009 09:45:49 -0700
Subject: [rabbitmq-discuss] eheap_alloc error
In-Reply-To: <3bb0d9710909160448g2896f872k552dfbbbf689f7e2@mail.gmail.com>
References: <376f3e6f0909150856i6def1e17pe51ccf9f918df830@mail.gmail.com> 
	<376f3e6f0909150903x320b5f1ckc29d7bcfe43e014f@mail.gmail.com> 
	<3bb0d9710909160448g2896f872k552dfbbbf689f7e2@mail.gmail.com>
Message-ID: <376f3e6f0909170945y22eb9a0fu67b1b7ee598eb576@mail.gmail.com>

On Wed, Sep 16, 2009 at 4:48 AM, majek04 <majek04 at gmail.com> wrote:

> On Tue, Sep 15, 2009 at 17:03, Suhail Doshi <suhail at mixpanel.com> wrote:
> > Doing some investigation into what happened, apparently the memory just
> > instantly got used, it wasn't leaking something slowly...any ideas?
> > Attached is an image of memory usage, then the consumer dies freeing up
> the
> > memory used later.
>
> It looks like erlang was trying to allocate 5 gigs of RAM, and failed.
> This could have happened during garbage collection, but only
> if a single erlang process was using all the memory.
>
> Do you have a single large queue?
>

Yes just 1 queue, definitely adds up after a while if consumers are not
running


> Are you sure that the queue had reasonable size during the crash?
>

I am not sure


> Maybe all the consumers had died and rabbit just ran out of memory?
>
>
No the consumers were very alive.


> Cheers!
>  Marek Majkowski
>



-- 
http://mixpanel.com
Blog: http://blog.mixpanel.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090917/85c6d20e/attachment.htm 

From mark.geib at echostar.com  Thu Sep 17 19:56:54 2009
From: mark.geib at echostar.com (Mark)
Date: Thu, 17 Sep 2009 12:56:54 -0600
Subject: [rabbitmq-discuss] is prefetch count available in erlang rabbitmq
 client
Message-ID: <1253213814.4794.25.camel@geib-testing-9.10>

I would like to limit the number of commands an instance of a worker is
allowed to have that is un-acked at a time, to say one. So that each
worker is allowed to receive, via a subscription, a single message,
completely process it and then ack the message in order to receive the
next one.

Setting the prefetch count to one sounds like that will do what I need,
but I have not found how to do this in the erlang client. Is it there.?

I am using the erlang client that was tagged at the time of the rabbitmq
1.6.0 release.

Thanks,
Mark.

-- 
Principal Engineer
Cheyenne Software Engineering
mark.geib at echostar.com / 35-215

PGP fingerprint:6DFC 389D 9796 0188 92E5 58F5 34C5 6B47 D091 76FD



From Deepak.Kumar1 at rbs.com  Thu Sep 17 20:36:48 2009
From: Deepak.Kumar1 at rbs.com (Deepak.Kumar1 at rbs.com)
Date: Thu, 17 Sep 2009 15:36:48 -0400
Subject: [rabbitmq-discuss] Issue with .Net client Subscription
In-Reply-To: <mailman.220.1253213823.2595.rabbitmq-discuss@lists.rabbitmq.com>
References: <mailman.220.1253213823.2595.rabbitmq-discuss@lists.rabbitmq.com>
Message-ID: <405015D33AA1C842A17F6E241598F62476797A068E@STAPMAL0002.rbsres07.net>

Hello

Has anyone faced issues not getting messages when using catch-all subscription using the .Net Client library ?

The publishing code is below -

IConnection conn1 = new ConnectionFactory().CreateConnection( "localhost:5672");
chSendUpdate = conn1.CreateModel();

...

chSendUpdate.BasicPublish(string.Empty, "STOCK.PRICES." + CUSIP, null, Encoding.UTF8.GetBytes(bodyText));


The subscription code is 
using (IConnection conn = new ConnectionFactory().CreateConnection("localhost:5672")){
    using (IModel ch = conn.CreateModel())    {
         Subscription sub = new Subscription(ch, "STOCK.PRICES.#");
         foreach (BasicDeliverEventArgs e in sub)         {
             Console.WriteLine("Topic({0}):{1}", e.RoutingKey, ASCIIEncoding.ASCII.GetString(e.Body));
             sub.Ack(e);
         }
     }
   }
}


If the subscription RoutingKey is changed to specific like "STOCK.PRICES.MSFT" etc. then the messages are received fine so i'm guessing there's some flag/option that needs to bet setup or enabled 

I've also tried the sample code in the .net user guide using QueueingBasicConsumer
but no success there either


Any ideas on what could be wrong ?
*****Please note that my email address may have changed. For all
future correspondence, please use this address*****


********************************************************************This
message (including any attachments) is confidential and/or
privileged. It is to be used by the intended recipients only. If
you have received it by mistake please notify the sender by return
e-mail and delete this message from your system. Any unauthorized
use or dissemination of this message in whole or in part is
strictly prohibited. Please note that e-mails are inherently
insecure and susceptible to change. The Royal Bank of Scotland
Group, plc ("RBS") and its US subsidiaries, and affiliates and
subsidiary undertakings, including but not limited to, RBS plc New
York and Connecticut Branches, RBS Securities Inc., ABN AMRO Bank
N.V. New York and Chicago Branches and, ABN AMRO Incorporated,
Citizens Financial Group, Inc. and RBS Citizens, N.A., shall not be
liable for the improper or incomplete transmission of the
information contained in this communication or Attachment nor for
any delay in its receipt or damage to your system. RBS does not
guarantee that the integrity of this communication has been
maintained nor that this communication is free of viruses,
interceptions or interference. RBS and its subsidiaries and
affiliates do not guarantee the accuracy of any email or
attachment, that an email will be received or that RBS or its
affiliates and subsidiaries will respond to an email.

RBS makes no representations that any information contained in this
message (including any attachments) are appropriate for use in all
locations or that transactions, securities, products, instruments
or services discussed herein are available or appropriate for sale
or use in all jurisdictions, or by all investors or counterparties.
Those who utilize this information do so on their own initiative
and are responsible for compliance with applicable local laws or
regulations.********************************************************************



From pauljones23 at gmail.com  Thu Sep 17 20:41:38 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Thu, 17 Sep 2009 20:41:38 +0100
Subject: [rabbitmq-discuss] Issue with .Net client Subscription
In-Reply-To: <405015D33AA1C842A17F6E241598F62476797A068E@STAPMAL0002.rbsres07.net>
References: <mailman.220.1253213823.2595.rabbitmq-discuss@lists.rabbitmq.com>
	<405015D33AA1C842A17F6E241598F62476797A068E@STAPMAL0002.rbsres07.net>
Message-ID: <29598b610909171241w6a94acb1ycfc5ff3f4a7691aa@mail.gmail.com>

Hi Deepak,

Did you create a topic exchange? Wildcard routing keys in the form you're
using require a topic exchange.

Paul.

On Thu, Sep 17, 2009 at 8:36 PM, <Deepak.Kumar1 at rbs.com> wrote:

> Hello
>
> Has anyone faced issues not getting messages when using catch-all
> subscription using the .Net Client library ?
>
> The publishing code is below -
>
> IConnection conn1 = new ConnectionFactory().CreateConnection(
> "localhost:5672");
> chSendUpdate = conn1.CreateModel();
>
> ...
>
> chSendUpdate.BasicPublish(string.Empty, "STOCK.PRICES." + CUSIP, null,
> Encoding.UTF8.GetBytes(bodyText));
>
>
> The subscription code is
> using (IConnection conn = new
> ConnectionFactory().CreateConnection("localhost:5672")){
>    using (IModel ch = conn.CreateModel())    {
>         Subscription sub = new Subscription(ch, "STOCK.PRICES.#");
>         foreach (BasicDeliverEventArgs e in sub)         {
>             Console.WriteLine("Topic({0}):{1}", e.RoutingKey,
> ASCIIEncoding.ASCII.GetString(e.Body));
>             sub.Ack(e);
>         }
>     }
>   }
> }
>
>
> If the subscription RoutingKey is changed to specific like
> "STOCK.PRICES.MSFT" etc. then the messages are received fine so i'm guessing
> there's some flag/option that needs to bet setup or enabled
>
> I've also tried the sample code in the .net user guide using
> QueueingBasicConsumer
> but no success there either
>
>
> Any ideas on what could be wrong ?
> *****Please note that my email address may have changed. For all
> future correspondence, please use this address*****
>
>
> ********************************************************************This
> message (including any attachments) is confidential and/or
> privileged. It is to be used by the intended recipients only. If
> you have received it by mistake please notify the sender by return
> e-mail and delete this message from your system. Any unauthorized
> use or dissemination of this message in whole or in part is
> strictly prohibited. Please note that e-mails are inherently
> insecure and susceptible to change. The Royal Bank of Scotland
> Group, plc ("RBS") and its US subsidiaries, and affiliates and
> subsidiary undertakings, including but not limited to, RBS plc New
> York and Connecticut Branches, RBS Securities Inc., ABN AMRO Bank
> N.V. New York and Chicago Branches and, ABN AMRO Incorporated,
> Citizens Financial Group, Inc. and RBS Citizens, N.A., shall not be
> liable for the improper or incomplete transmission of the
> information contained in this communication or Attachment nor for
> any delay in its receipt or damage to your system. RBS does not
> guarantee that the integrity of this communication has been
> maintained nor that this communication is free of viruses,
> interceptions or interference. RBS and its subsidiaries and
> affiliates do not guarantee the accuracy of any email or
> attachment, that an email will be received or that RBS or its
> affiliates and subsidiaries will respond to an email.
>
> RBS makes no representations that any information contained in this
> message (including any attachments) are appropriate for use in all
> locations or that transactions, securities, products, instruments
> or services discussed herein are available or appropriate for sale
> or use in all jurisdictions, or by all investors or counterparties.
> Those who utilize this information do so on their own initiative
> and are responsible for compliance with applicable local laws or
>
> regulations.********************************************************************
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090917/d7192255/attachment.htm 

From Deepak.Kumar1 at rbs.com  Thu Sep 17 20:43:10 2009
From: Deepak.Kumar1 at rbs.com (Deepak.Kumar1 at rbs.com)
Date: Thu, 17 Sep 2009 15:43:10 -0400
Subject: [rabbitmq-discuss] Issue with .Net client Subscription
In-Reply-To: <29598b610909171241w6a94acb1ycfc5ff3f4a7691aa@mail.gmail.com>
References: <mailman.220.1253213823.2595.rabbitmq-discuss@lists.rabbitmq.com>
	<405015D33AA1C842A17F6E241598F62476797A068E@STAPMAL0002.rbsres07.net>
	<29598b610909171241w6a94acb1ycfc5ff3f4a7691aa@mail.gmail.com>
Message-ID: <405015D33AA1C842A17F6E241598F62476797A068F@STAPMAL0002.rbsres07.net>

No, I've been using string.empty as exchange all along

will check it out

Thanks
Deepak



________________________________
From: Paul Jones [mailto:pauljones23 at gmail.com]
Sent: Thursday, September 17, 2009 3:42 PM
To: Kumar, Deepak, GBM
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Issue with .Net client Subscription

Hi Deepak,

Did you create a topic exchange? Wildcard routing keys in the form you're using require a topic exchange.

Paul.

On Thu, Sep 17, 2009 at 8:36 PM, <Deepak.Kumar1 at rbs.com<mailto:Deepak.Kumar1 at rbs.com>> wrote:
Hello

Has anyone faced issues not getting messages when using catch-all subscription using the .Net Client library ?

The publishing code is below -

IConnection conn1 = new ConnectionFactory().CreateConnection( "localhost:5672");
chSendUpdate = conn1.CreateModel();

...

chSendUpdate.BasicPublish(string.Empty, "STOCK.PRICES." + CUSIP, null, Encoding.UTF8.GetBytes(bodyText));


The subscription code is
using (IConnection conn = new ConnectionFactory().CreateConnection("localhost:5672")){
   using (IModel ch = conn.CreateModel())    {
        Subscription sub = new Subscription(ch, "STOCK.PRICES.#");
        foreach (BasicDeliverEventArgs e in sub)         {
            Console.WriteLine("Topic({0}):{1}", e.RoutingKey, ASCIIEncoding.ASCII.GetString(e.Body));
            sub.Ack(e);
        }
    }
  }
}


If the subscription RoutingKey is changed to specific like "STOCK.PRICES.MSFT" etc. then the messages are received fine so i'm guessing there's some flag/option that needs to bet setup or enabled

I've also tried the sample code in the .net user guide using QueueingBasicConsumer
but no success there either


Any ideas on what could be wrong ?
*****Please note that my email address may have changed. For all
future correspondence, please use this address*****


********************************************************************This
message (including any attachments) is confidential and/or
privileged. It is to be used by the intended recipients only. If
you have received it by mistake please notify the sender by return
e-mail and delete this message from your system. Any unauthorized
use or dissemination of this message in whole or in part is
strictly prohibited. Please note that e-mails are inherently
insecure and susceptible to change. The Royal Bank of Scotland
Group, plc ("RBS") and its US subsidiaries, and affiliates and
subsidiary undertakings, including but not limited to, RBS plc New
York and Connecticut Branches, RBS Securities Inc., ABN AMRO Bank
N.V. New York and Chicago Branches and, ABN AMRO Incorporated,
Citizens Financial Group, Inc. and RBS Citizens, N.A., shall not be
liable for the improper or incomplete transmission of the
information contained in this communication or Attachment nor for
any delay in its receipt or damage to your system. RBS does not
guarantee that the integrity of this communication has been
maintained nor that this communication is free of viruses,
interceptions or interference. RBS and its subsidiaries and
affiliates do not guarantee the accuracy of any email or
attachment, that an email will be received or that RBS or its
affiliates and subsidiaries will respond to an email.

RBS makes no representations that any information contained in this
message (including any attachments) are appropriate for use in all
locations or that transactions, securities, products, instruments
or services discussed herein are available or appropriate for sale
or use in all jurisdictions, or by all investors or counterparties.
Those who utilize this information do so on their own initiative
and are responsible for compliance with applicable local laws or
regulations.********************************************************************

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com<mailto:rabbitmq-discuss at lists.rabbitmq.com>
http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090917/82b9a6a3/attachment.htm 

From tsuraan at gmail.com  Thu Sep 17 21:25:21 2009
From: tsuraan at gmail.com (tsuraan)
Date: Thu, 17 Sep 2009 15:25:21 -0500
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
Message-ID: <84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>

> I've seen this symptom before, but the circumstances were a bit
> contrived - the way the output from uptime was being processed on OSX
> - see http://erlang.org/pipermail/erlang-questions/2008-May/034889.html.
>
> However, I'm not convinced that this has anything to do with what you
> are seeing.

I think what's happening is that the os_mon:call (from cpu_sup:avg1())
is errorring out somehow, so its return value is { error, _ } instead
of a number.  In the local_load function of rabbit_load.erl, where you
currently have

_Other -> cpu_sup:avg1()

it should probably be

_Other ->
  case cpu_sup:avg1() of
    { error, _ } -> 0.0;
    Value -> Value
  end

I really wish erlang gave line numbers in its traces, but the only
arithmetic line in pick() is LoadAvg * ?FUDGE_FACTOR, and I don't
think the macro's value is changing :)

Also, avg1()'s man page says it returns a number, but its spec says an
integer or an { 'error', any() } pair.  Its timeout is set at
infinity, so it's not a timeout, but it could be some other error.
I'll see if I can get that machine to bomb out some more with prints
for the return value of avg1().



From tsuraan at gmail.com  Fri Sep 18 01:09:06 2009
From: tsuraan at gmail.com (tsuraan)
Date: Thu, 17 Sep 2009 19:09:06 -0500
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>
Message-ID: <84fb38e30909171709j59e7922ei9e790fd7868313ca@mail.gmail.com>

> I think what's happening is that the os_mon:call (from cpu_sup:avg1())
> is errorring out somehow, so its return value is { error, _ } instead
> of a number.  In the local_load function of rabbit_load.erl, where you
> currently have
>
> _Other -> cpu_sup:avg1()
>
> it should probably be
>
> _Other ->
>   case cpu_sup:avg1() of
>     { error, _ } -> 0.0;
>     Value -> Value
>   end
>
> I really wish erlang gave line numbers in its traces, but the only
> arithmetic line in pick() is LoadAvg * ?FUDGE_FACTOR, and I don't
> think the macro's value is changing :)
>
> Also, avg1()'s man page says it returns a number, but its spec says an
> integer or an { 'error', any() } pair.  Its timeout is set at
> infinity, so it's not a timeout, but it could be some other error.
> I'll see if I can get that machine to bomb out some more with prints
> for the return value of avg1().
>

I stand corrected.  It is indeed a timeout; I used the above code, but
in the case of { error, X }, I have a io:format("avg1() gave the value
~p~n", [ X ]), and it's saying timeout.  bizarre.  Anyhow, assuming
that 0.0 is an acceptable way to handle that error, it looks like the
fix works for me.



From tsuraan at gmail.com  Fri Sep 18 01:18:15 2009
From: tsuraan at gmail.com (tsuraan)
Date: Thu, 17 Sep 2009 19:18:15 -0500
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909171709j59e7922ei9e790fd7868313ca@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>
	<84fb38e30909171709j59e7922ei9e790fd7868313ca@mail.gmail.com>
Message-ID: <84fb38e30909171718n66b549d7he3385a32b7346e1e@mail.gmail.com>

> I stand corrected.  It is indeed a timeout; I used the above code, but
> in the case of { error, X }, I have a io:format("avg1() gave the value
> ~p~n", [ X ]), and it's saying timeout.  bizarre.  Anyhow, assuming
> that 0.0 is an acceptable way to handle that error, it looks like the
> fix works for me.

And, a final self-reply before I shut up, it looks like one of my
queues disappeared.  I know this was an issue in 1.5.3, but I think it
was supposedly fixed in 1.5.5 and 1.6.0.  I don't have any errors in
my rabbit log (other than errors about processes trying to use the
missing queue), my sasl log is empty, and I don't have an erlang crash
dump anywhere.  I have no idea what happened to that queue, but it was
present in the past hour or so.



From Deepak.Kumar1 at rbs.com  Fri Sep 18 01:30:46 2009
From: Deepak.Kumar1 at rbs.com (Deepak.Kumar1 at rbs.com)
Date: Thu, 17 Sep 2009 20:30:46 -0400
Subject: [rabbitmq-discuss] Issue with .Net client Subscription
In-Reply-To: <29598b610909171241w6a94acb1ycfc5ff3f4a7691aa@mail.gmail.com>
References: <mailman.220.1253213823.2595.rabbitmq-discuss@lists.rabbitmq.com>
	<405015D33AA1C842A17F6E241598F62476797A068E@STAPMAL0002.rbsres07.net>
	<29598b610909171241w6a94acb1ycfc5ff3f4a7691aa@mail.gmail.com>
Message-ID: <405015D33AA1C842A17F6E241598F62476797A0690@STAPMAL0002.rbsres07.net>

Hi Paul

Tried a few possible ways to create exchange and Bind2Q but didn't work so far, it seems to need some precise sequence which escapes me
here's the publishing code

string serverAndPort = "localhost:5672";

IConnection conn1 = new ConnectionFactory().CreateConnection( serverAndPort  );
IModel ch = conn1.CreateModel();
string routingKey = "STOCK.PRICES"; //"STOCK.PRICES.#";
string qn = "myq", exch = "nasdaq";
ch.ExchangeDeclare(exch, ExchangeType.Direct);
string finalName = chSendUpdate.QueueDeclare(qn, false,
                                   false, false, false,
                                   false, null);


ch.QueueBind(finalName, exch, routingKey, false, null);
ch.BasicPublish(string.Empty, "STOCK.PRICES." + CUSIP, null, Encoding.UTF8.GetBytes(bodyText));

recv'ng code is

string routingKey = "STOCK.PRICES.#";
using (IConnection conn = new ConnectionFactory().CreateConnection("localhost:5672")){
 using (IModel ch = conn.CreateModel()) {
  Subscription sub = new Subscription(ch, "nasdaq", ExchangeType.Direct, routingKey);
  foreach (BasicDeliverEventArgs e in sub){
   Console.WriteLine("#2> Exch({0}) Topic({1}):{2}", e.Exchange, e.RoutingKey, ASCIIEncoding.ASCII.GetString(e.Body));
   sub.Ack(e);
  }
                Console.WriteLine("Out of sub loop...<ENTER>");
  Console.ReadLine();
 }
}


Assuming it's my code and not something in the library, id' think that a magic combination/method call sequence is required in ch.QueueBind() to make it all work !

Thanks for your help
Deepak




________________________________
From: Paul Jones [mailto:pauljones23 at gmail.com]
Sent: Thursday, September 17, 2009 3:42 PM
To: Kumar, Deepak, GBM
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Issue with .Net client Subscription

Hi Deepak,

Did you create a topic exchange? Wildcard routing keys in the form you're using require a topic exchange.

Paul.

On Thu, Sep 17, 2009 at 8:36 PM, <Deepak.Kumar1 at rbs.com<mailto:Deepak.Kumar1 at rbs.com>> wrote:
Hello

Has anyone faced issues not getting messages when using catch-all subscription using the .Net Client library ?

The publishing code is below -

IConnection conn1 = new ConnectionFactory().CreateConnection( "localhost:5672");
chSendUpdate = conn1.CreateModel();

...

chSendUpdate.BasicPublish(string.Empty, "STOCK.PRICES." + CUSIP, null, Encoding.UTF8.GetBytes(bodyText));


The subscription code is
using (IConnection conn = new ConnectionFactory().CreateConnection("localhost:5672")){
   using (IModel ch = conn.CreateModel())    {
        Subscription sub = new Subscription(ch, "STOCK.PRICES.#");
        foreach (BasicDeliverEventArgs e in sub)         {
            Console.WriteLine("Topic({0}):{1}", e.RoutingKey, ASCIIEncoding.ASCII.GetString(e.Body));
            sub.Ack(e);
        }
    }
  }
}


If the subscription RoutingKey is changed to specific like "STOCK.PRICES.MSFT" etc. then the messages are received fine so i'm guessing there's some flag/option that needs to bet setup or enabled

I've also tried the sample code in the .net user guide using QueueingBasicConsumer
but no success there either


Any ideas on what could be wrong ?
*****Please note that my email address may have changed. For all
future correspondence, please use this address*****


********************************************************************This
message (including any attachments) is confidential and/or
privileged. It is to be used by the intended recipients only. If
you have received it by mistake please notify the sender by return
e-mail and delete this message from your system. Any unauthorized
use or dissemination of this message in whole or in part is
strictly prohibited. Please note that e-mails are inherently
insecure and susceptible to change. The Royal Bank of Scotland
Group, plc ("RBS") and its US subsidiaries, and affiliates and
subsidiary undertakings, including but not limited to, RBS plc New
York and Connecticut Branches, RBS Securities Inc., ABN AMRO Bank
N.V. New York and Chicago Branches and, ABN AMRO Incorporated,
Citizens Financial Group, Inc. and RBS Citizens, N.A., shall not be
liable for the improper or incomplete transmission of the
information contained in this communication or Attachment nor for
any delay in its receipt or damage to your system. RBS does not
guarantee that the integrity of this communication has been
maintained nor that this communication is free of viruses,
interceptions or interference. RBS and its subsidiaries and
affiliates do not guarantee the accuracy of any email or
attachment, that an email will be received or that RBS or its
affiliates and subsidiaries will respond to an email.

RBS makes no representations that any information contained in this
message (including any attachments) are appropriate for use in all
locations or that transactions, securities, products, instruments
or services discussed herein are available or appropriate for sale
or use in all jurisdictions, or by all investors or counterparties.
Those who utilize this information do so on their own initiative
and are responsible for compliance with applicable local laws or
regulations.********************************************************************

_______________________________________________
rabbitmq-discuss mailing list
rabbitmq-discuss at lists.rabbitmq.com<mailto:rabbitmq-discuss at lists.rabbitmq.com>
http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss



*****Please note that my email address may have changed. For all
future correspondence, please use this address*****


********************************************************************This
message (including any attachments) is confidential and/or
privileged. It is to be used by the intended recipients only. If
you have received it by mistake please notify the sender by return
e-mail and delete this message from your system. Any unauthorized
use or dissemination of this message in whole or in part is
strictly prohibited. Please note that e-mails are inherently
insecure and susceptible to change. The Royal Bank of Scotland
Group, plc ("RBS") and its US subsidiaries, and affiliates and
subsidiary undertakings, including but not limited to, RBS plc New
York and Connecticut Branches, RBS Securities Inc., ABN AMRO Bank
N.V. New York and Chicago Branches and, ABN AMRO Incorporated,
Citizens Financial Group, Inc. and RBS Citizens, N.A., shall not be
liable for the improper or incomplete transmission of the
information contained in this communication or Attachment nor for
any delay in its receipt or damage to your system. RBS does not
guarantee that the integrity of this communication has been
maintained nor that this communication is free of viruses,
interceptions or interference. RBS and its subsidiaries and
affiliates do not guarantee the accuracy of any email or
attachment, that an email will be received or that RBS or its
affiliates and subsidiaries will respond to an email.

RBS makes no representations that any information contained in this
message (including any attachments) are appropriate for use in all
locations or that transactions, securities, products, instruments
or services discussed herein are available or appropriate for sale
or use in all jurisdictions, or by all investors or counterparties.
Those who utilize this information do so on their own initiative
and are responsible for compliance with applicable local laws or
regulations.********************************************************************
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090917/ceb56405/attachment.htm 

From alexgentle at sify.com  Fri Sep 18 01:40:15 2009
From: alexgentle at sify.com (Alex Gentle)
Date: Thu, 17 Sep 2009 17:40:15 -0700
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <9D816149-C7F0-46CE-9C46-89A3C5518EE0@mac.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
	<269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
	<fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>
	<05CB3FA2-42C9-4B52-B5E1-03B4BB5758A3@mac.com>
	<fb0723210909151719k60e16a76g32ea8b6dadd1da3c@mail.gmail.com>
	<9D816149-C7F0-46CE-9C46-89A3C5518EE0@mac.com>
Message-ID: <fb0723210909171740i494c0c0csfee4fcba51d6e989@mail.gmail.com>

>You need to declare an exchange (of type direct, fanout or topic)

>which acts as the mailbox for sending the message.



Thank you for taking time to answer my questions.



>Once you have parsed the message from socket server and determined it >should go to rabbit, you publish the message to it.



I don?t know Ruby. I wrote a PHP program that parse the message from
socket server and pass the message to RabbitMQ server. When
the message comes back from RabbitMQ, I format it and send to socket
server that forwards the message to iPhone.



The catch here is the performance. iPhone needs to query for the
message in the queue every few seconds. Let us assume
that User A and User B chats thru iPhone application. User A sends the
message to RabbitMQ.



User A -> Socket Server -> RabbitMQ Server



RabbitMQ has no way of sending the notification to User B that some
message is waiting for him.



User B needs to check the RabbitMQ server every 5 seconds to see if
there is any message in his queue.



Imagine there are 10,000 users like user A and B. All of them will be
sending the message thru socket server to RabbitMQ server. Socket
server can handle all the traffic. It?s a piece of cake for RabbitMQ
to handle the traffic. But, the poor PHP program in the middle
(between socket server and RabbitMQ) can?t handle all the incoming and
outgoing requests with ease. It?s going to slow down the process.
Users will see substantial delay in sending and receiving messages.



Is there a better way to do it? Thanks.





On Tue, Sep 15, 2009 at 7:27 PM, Chuck Remes <cremes.devlist at mac.com> wrote:

>
> On Sep 15, 2009, at 7:19 PM, Alex Gentle wrote:
>
> > iPhone app -> socket server -> RabbitMQ server
>
> Great, this is very helpful.
>
> > iPhone app has some social networking features in addition to the
> > chat component. Think of it like mini-facebook inside iPhone. When a
> > user types a message inside chat window of iPhone app, the message
> > travels to Socket server which directs the message depending on what
> > is on the message header. If the message header says "this message
> > is for RabbitMQ", socket server will route to RabbitMQ. When a
> > message comes from RabbitMQ to socket server, it should have message
> > header that says "Route this to xxxxxx user". Then, socket server
> > will route the message to appropriate user(s).
> >
> > It all looks good, but it doesn't work. Because I don't know how to
> > make a call to RabbitMQ using the message from socket server and how
> > to pass the message from RabbitMQ to socket server in binary format.
>
> Ah, this is good.
>
> You need to declare an exchange (of type direct, fanout or topic)
> which acts as the mailbox for sending the message. Once you have
> parsed the message from socket server and determined it should go to
> rabbit, you publish the message to it. Here's some ruby code
> (commented).
>
> def publish_message_to_rabbit(message)
>   # declare the exchange
>   exchange = MQ.direct 'mailbox'
>
>   # send the message
>   exchange.publish(message, :key => 'some.routing.key')
> end
>
> Next, you need to have a client somewhere that is listening for
> messages. You need to allocate a queue to receive the message and
> subscribe to the routing key. Again, some ruby code.
>
> def listen_for_rabbit_messages
>   # redeclare the exchange; idempotent operation
>   exchange = MQ.direct 'mailbox'
>
>   # declare a queue to receive the messages
>   queue = MQ.queue 'mailslot'
>
>   # bind the queue to the exchange and match incoming messages against
>   # the specified routing key
>   queue.bind(exchange, :key => 'some.routing.key').subscribe do |
> message|
>     # this block is called each time a message is received
>     # do your message processing here
>   end
> end
>
> Does this help? I highly recommend you take a look through the sample
> code and come back with specific questions.
>
> cr
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090917/4aaa6539/attachment.htm 

From matthias at lshift.net  Fri Sep 18 05:46:06 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 18 Sep 2009 05:46:06 +0100
Subject: [rabbitmq-discuss] Issue with .Net client Subscription
In-Reply-To: <405015D33AA1C842A17F6E241598F62476797A0690@STAPMAL0002.rbsres07.net>
References: <mailman.220.1253213823.2595.rabbitmq-discuss@lists.rabbitmq.com>	<405015D33AA1C842A17F6E241598F62476797A068E@STAPMAL0002.rbsres07.net>	<29598b610909171241w6a94acb1ycfc5ff3f4a7691aa@mail.gmail.com>
	<405015D33AA1C842A17F6E241598F62476797A0690@STAPMAL0002.rbsres07.net>
Message-ID: <4AB3108E.4030707@lshift.net>

Deepak,

Deepak.Kumar1 at rbs.com wrote:
> Tried a few possible ways to create exchange and Bind2Q but didn't work 
> so far, it seems to need some precise sequence which escapes me
> here's the publishing code
>  
> [...]
> ch.ExchangeDeclare(exch, ExchangeType.Direct);

As Paul mentioned, for the kind of matching you are doing the exchange 
needs to be a *topic* exchange, so the above should either by 
ExchangeType.Topic, or you could simply use the default topic exchange 
called 'amq.topic'.


Regards,

Matthias.



From matthias at lshift.net  Fri Sep 18 06:11:21 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 18 Sep 2009 06:11:21 +0100
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>
Message-ID: <4AB31679.7050003@lshift.net>

Tsuraan,

tsuraan wrote:
> I think what's happening is that the os_mon:call (from cpu_sup:avg1())
> is errorring out somehow, so its return value is { error, _ } instead
> of a number.  In the local_load function of rabbit_load.erl, where you
> currently have
> 
> _Other -> cpu_sup:avg1()
> 
> it should probably be
> 
> _Other ->
>   case cpu_sup:avg1() of
>     { error, _ } -> 0.0;
>     Value -> Value
>   end

Well spotted. It should be 'infinity' instead of 0.0 though, and we 
shouldn't ignore the error if it is something other than timeout.

I have committed a fix which, subject to qa, will make it into the next 
release.

(Btw, the reason for the timeout is that even though the cpu_sup 
gen_server:call has a timeout of infinity, internally there is a 
measurement_server_call with a timeout of 5s, which presumably gets 
triggered under heavy load).


Regards,

Matthias.



From cremes.devlist at mac.com  Fri Sep 18 13:27:08 2009
From: cremes.devlist at mac.com (Chuck Remes)
Date: Fri, 18 Sep 2009 07:27:08 -0500
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <fb0723210909171740i494c0c0csfee4fcba51d6e989@mail.gmail.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
	<269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
	<fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>
	<05CB3FA2-42C9-4B52-B5E1-03B4BB5758A3@mac.com>
	<fb0723210909151719k60e16a76g32ea8b6dadd1da3c@mail.gmail.com>
	<9D816149-C7F0-46CE-9C46-89A3C5518EE0@mac.com>
	<fb0723210909171740i494c0c0csfee4fcba51d6e989@mail.gmail.com>
Message-ID: <22998192-570B-492D-A9EF-F4F390D22042@mac.com>


On Sep 17, 2009, at 7:40 PM, Alex Gentle wrote:

> >Once you have parsed the message from socket server and determined  
> it >should go to rabbit, you publish the message to it.
>
> I don?t know Ruby. I wrote a PHP program that parse the message from  
> socket server and pass the message to RabbitMQ server.


I wrote the examples in ruby since the code is very compact. You can  
perform the same operations in any language that has an AMQP library.


> The catch here is the performance. iPhone needs to query for the  
> message in the queue every few seconds.


I think we are getting ahead of ourselves. Your original post  
indicated that your code did not work but now you are worried about  
performance. Let's get your code working first and then you can worry  
about optimizing it later.

Can you successfully publish your messages yet? If so, can you pop  
them off of the queue to read them?


> Let us assume
>
> that User A and User B chats thru iPhone application. User A sends  
> the message to RabbitMQ.
>
> User A -> Socket Server -> RabbitMQ Server
>
> RabbitMQ has no way of sending the notification to User B that some  
> message is waiting for him.
>
> User B needs to check the RabbitMQ server every 5 seconds to see if  
> there is any message in his queue.
>
> Imagine there are 10,000 users like user A and B. All of them will  
> be sending the message thru socket server to RabbitMQ server. Socket
>
> server can handle all the traffic. It?s a piece of cake for RabbitMQ  
> to handle the traffic. But, the poor PHP program in the middle
> (between socket server and RabbitMQ) can?t handle all the incoming  
> and outgoing requests with ease. It?s going to slow down the process.
>
> Users will see substantial delay in sending and receiving messages.
>
> Is there a better way to do it? Thanks.

Polling is usually a bad idea particularly since it requires a lot of  
unnecessary messaging. Most AMQP libraries I have seen allow for two  
ways to fetch messages. One way is to "get" them from the queue which  
is a synchronous operation. The second way is to "subscribe" to a  
queue and have it asynchronously push messages to the subscriber. You  
want to investigate this second methodology for your application.  
Async operations result in slightly more complex code but they will  
let you scale better than polling/synchronous operations.

cr

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090918/902d03fc/attachment.htm 

From matthias at lshift.net  Fri Sep 18 13:35:45 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 18 Sep 2009 13:35:45 +0100
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
Message-ID: <4AB37EA1.2070406@lshift.net>

Tsuraan,

tsuraan wrote:
> As RabbitMQ is running, I sometimes get messages saying "Erlang has
> closed".  These don't seem to be associated with any actual failure or
> shutdown; a single long-running rabbit will sometimes have a dozen or
> more "Erlang has closed" messages on its standard output.

AFAIK that message is printed when an external program, such as that
used for memory reporting, terminates. Unless you see any other ill
effects it should be harmless.

> I also see, in my logs, this triplet of messages:
> 
> =INFO REPORT==== 16-Sep-2009::16:45:48 ===
>     application: rabbit
>     exited: stopped
>     type: temporary
> 
> =INFO REPORT==== 16-Sep-2009::16:45:48 ===
>     application: mnesia
>     exited: stopped
>     type: temporary
> 
> =INFO REPORT==== 16-Sep-2009::16:45:48 ===
>     application: os_mon
>     exited: stopped
>     type: temporary
> 
> I don't think those are associated with any interruption either

That sequence usually indicates that rabbit was stopped, e.g. with
rabbitmqctl stop/stop_and_halt, rabbitmq-multi stop_all, or the various
scripts in the os-specific packages.


Regards,

Matthias.



From frobert at emsc-csem.org  Fri Sep 18 13:36:07 2009
From: frobert at emsc-csem.org (Laurent Frobert)
Date: Fri, 18 Sep 2009 05:36:07 -0700 (PDT)
Subject: [rabbitmq-discuss]  RabbitMQ vs Spread vs QWIDS
Message-ID: <25507940.post@talk.nabble.com>


Hi, 

my boss wants me to explain why i want to choose RabbitMQ instead of Spread
(http://www.spread.org/) or QWIDS (http://www.isti2.com/QWIDS/).
Reason for him,  is that Spread and QWIDS are well used in other production
environment,
so, what rabbitmq can give more ?


could you help me, thanks

Laurent Frobert
www.emsc-csem.org
-- 
View this message in context: http://www.nabble.com/RabbitMQ-vs-Spread-vs-QWIDS-tp25507940p25507940.html
Sent from the RabbitMQ mailing list archive at Nabble.com.




From matthias at lshift.net  Fri Sep 18 13:43:23 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 18 Sep 2009 13:43:23 +0100
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909171718n66b549d7he3385a32b7346e1e@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>	<84fb38e30909171709j59e7922ei9e790fd7868313ca@mail.gmail.com>
	<84fb38e30909171718n66b549d7he3385a32b7346e1e@mail.gmail.com>
Message-ID: <4AB3806B.8030803@lshift.net>

Tsuraan,

tsuraan wrote:
> And, a final self-reply before I shut up, it looks like one of my 
> queues disappeared.  I know this was an issue in 1.5.3, but I think
> it was supposedly fixed in 1.5.5 and 1.6.0.

I am not aware of any problem in that area that got fixed in those
releases. Have you got a reference?

> I don't have any errors in my rabbit log (other than errors about
> processes trying to use the missing queue), my sasl log is empty, and
> I don't have an erlang crash dump anywhere.

In that case the only way for the queue to have disappeared is as part
of auto-deletion due to the 'exclusive' or 'auto-delete' flag being set,
or explicit deletion with 'queue.delete'. Unless you are running in a
cluster, in which case queues can disappear if the node they reside on
disappears.


Regards,

Matthias.



From gmr at myyearbook.com  Fri Sep 18 13:53:20 2009
From: gmr at myyearbook.com (Gavin M. Roy)
Date: Fri, 18 Sep 2009 08:53:20 -0400
Subject: [rabbitmq-discuss] RabbitMQ vs Spread vs QWIDS
In-Reply-To: <25507940.post@talk.nabble.com>
References: <25507940.post@talk.nabble.com>
Message-ID: <af1bce590909180553v373c0d1er447e442f10ac8adf@mail.gmail.com>

I find http://wiki.secondlife.com/wiki/Message_Queue_Evaluation_Notes good.
 They don't mention the tools you mention, however.
You've not given any detail to the type of app or use you have, and so it's
difficult to compare them for you. QWIDS seems to be an odd choice as CORBA
went out with the 90's for good reason.  Both Spread and QWIDS seem more
like a message bus, as opposed to a message broker.

In spread you tell a program to join a spread group, then you send messages
and everything in that group gets the message and processes it.  In RabbitMQ
there are multiple workflows.  You can send messages with routing
information, queue up messages for later consumption, use client side
throttling to only receive messages when you need them, etc.

Honestly you should look at your problem area, what you're going to use
RabbitMQ for, and if you need something like RabbitMQ or you need something
like Spread.  I don't seem them as competing for the same space.
Regards,

Gavin

On Fri, Sep 18, 2009 at 8:36 AM, Laurent Frobert <frobert at emsc-csem.org>wrote:

>
> Hi,
>
> my boss wants me to explain why i want to choose RabbitMQ instead of Spread
> (http://www.spread.org/) or QWIDS (http://www.isti2.com/QWIDS/).
> Reason for him,  is that Spread and QWIDS are well used in other production
> environment,
> so, what rabbitmq can give more ?
>
>
> could you help me, thanks
>
> Laurent Frobert
> www.emsc-csem.org
> --
> View this message in context:
> http://www.nabble.com/RabbitMQ-vs-Spread-vs-QWIDS-tp25507940p25507940.html
> Sent from the RabbitMQ mailing list archive at Nabble.com.
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090918/89a7e1a6/attachment.htm 

From tsuraan at gmail.com  Fri Sep 18 15:51:03 2009
From: tsuraan at gmail.com (tsuraan)
Date: Fri, 18 Sep 2009 09:51:03 -0500
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <4AB3806B.8030803@lshift.net>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>
	<84fb38e30909171709j59e7922ei9e790fd7868313ca@mail.gmail.com>
	<84fb38e30909171718n66b549d7he3385a32b7346e1e@mail.gmail.com>
	<4AB3806B.8030803@lshift.net>
Message-ID: <84fb38e30909180751x5efb1376h2730c1c44bf10caa@mail.gmail.com>

> I am not aware of any problem in that area that got fixed in those
> releases. Have you got a reference?

http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-July/004033.html
was my queue_disappeared issue.  I'm not getting the error message
anymore, but a persistent queue is gone.

> In that case the only way for the queue to have disappeared is as part
> of auto-deletion due to the 'exclusive' or 'auto-delete' flag being set,
> or explicit deletion with 'queue.delete'. Unless you are running in a
> cluster, in which case queues can disappear if the node they reside on
> disappears.

It's a single machine, and all the queues are persistent.  There is a
place where queue_delete is called, but the queue is re-created
immediately afterwards (I saw something about queue.purge the other
day, but I haven't looked into it yet). If I do queue_delete and then
a queue_declare in a transaction, will that guarantee that the queue
doesn't disappear?

It looks like right now, if a rabbit_amqqueue_process is terminated,
it removes that queue from mnesia (terminate function of
rabbit_amqqueue_process calls rabbit_amqqueue:internal_delete).
Looking at gen_server2, terminate seems to get called in basically any
case of a process getting an error while handling a call, a supervisor
dying, the process itself dying, I'm not sure what else.  Should all
those things cause the queue record to be removed from mnesia?



From tsuraan at gmail.com  Fri Sep 18 15:55:47 2009
From: tsuraan at gmail.com (tsuraan)
Date: Fri, 18 Sep 2009 09:55:47 -0500
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <4AB31679.7050003@lshift.net>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>
	<4AB31679.7050003@lshift.net>
Message-ID: <84fb38e30909180755k2e6a82cv25235ea9cc9eaba9@mail.gmail.com>

> Well spotted. It should be 'infinity' instead of 0.0 though, and we
> shouldn't ignore the error if it is something other than timeout.

For my system it was a timeout; as I guess you probably saw :)

>
> I have committed a fix which, subject to qa, will make it into the next
> release.

Is that 1.7, or a 1.6.1 release?

> (Btw, the reason for the timeout is that even though the cpu_sup
> gen_server:call has a timeout of infinity, internally there is a
> measurement_server_call with a timeout of 5s, which presumably gets
> triggered under heavy load).

Ok, that makes sense.  This is probably the biggest wart I've found
with erlang; timeouts are a great way to avoid deadlock when I get
sloppy, but they also break down pretty badly when a machine is under
absurd load and swapping.  I can't think of a better way to handle
things, but in my programs I've gotten pretty tired of things timing
out in weird edge cases where they should just be really slow.



From matthias at lshift.net  Fri Sep 18 16:35:15 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 18 Sep 2009 16:35:15 +0100
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909180751x5efb1376h2730c1c44bf10caa@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>	<84fb38e30909171709j59e7922ei9e790fd7868313ca@mail.gmail.com>	<84fb38e30909171718n66b549d7he3385a32b7346e1e@mail.gmail.com>	<4AB3806B.8030803@lshift.net>
	<84fb38e30909180751x5efb1376h2730c1c44bf10caa@mail.gmail.com>
Message-ID: <4AB3A8B3.8000100@lshift.net>

Tsuraan,

tsuraan wrote:
>> I am not aware of any problem in that area that got fixed in those
>> releases. Have you got a reference?
> 
> http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-July/004033.html
> was my queue_disappeared issue.

We did fix some timeout related problems, as indicated in the above
thread. Queues weren't actually disappearing.

> It's a single machine, and all the queues are persistent.

Do you mean 'durable'?

> There is a place where queue_delete is called, but the queue is
> re-created immediately afterwards (I saw something about queue.purge
> the other day, but I haven't looked into it yet). If I do
> queue_delete and then a queue_declare in a transaction, will that
> guarantee that the queue doesn't disappear?

Transactions only span publishes and acks.

> It looks like right now, if a rabbit_amqqueue_process is terminated,
> it removes that queue from mnesia (terminate function of
> rabbit_amqqueue_process calls rabbit_amqqueue:internal_delete).
> Looking at gen_server2, terminate seems to get called in basically any
> case of a process getting an error while handling a call, a supervisor
> dying, the process itself dying, I'm not sure what else.  Should all
> those things cause the queue record to be removed from mnesia?

Any abnormal termination of a queue process should result in a sasl log
entry. Since you are not seeing such log entries it is unlikely that
abnormal queue termination is a problem.

As to whether we should remove the queue record when the queue process
terminates abnormally ... we couldn't just leave the record in place
since then there would be no way to ever create a queue with the same
name or get rid of the record. We could restart the queue process, but
that presents some interesting race conditions as well as masking a
potentially serious error from clients (even more than is usually the
case). It's on our todo list to look into this area though.


Regards,

Matthias.



From tsuraan at gmail.com  Fri Sep 18 17:39:28 2009
From: tsuraan at gmail.com (tsuraan)
Date: Fri, 18 Sep 2009 11:39:28 -0500
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <4AB3A8B3.8000100@lshift.net>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>
	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>
	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>
	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>
	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>
	<84fb38e30909171709j59e7922ei9e790fd7868313ca@mail.gmail.com>
	<84fb38e30909171718n66b549d7he3385a32b7346e1e@mail.gmail.com>
	<4AB3806B.8030803@lshift.net>
	<84fb38e30909180751x5efb1376h2730c1c44bf10caa@mail.gmail.com>
	<4AB3A8B3.8000100@lshift.net>
Message-ID: <84fb38e30909180939p285caadamf9bcba8cd1f83461@mail.gmail.com>

>> It's a single machine, and all the queues are persistent.
>
> Do you mean 'durable'?

Yeah, that.

> Transactions only span publishes and acks.

Ok, so it's possible that my program did delete the queue that it
needed and then it died before re-creating it.  Those two things are
in adjacent lines, but it's still a possibility, especially on a
really heavily overloaded machine.

> Any abnormal termination of a queue process should result in a sasl log
> entry. Since you are not seeing such log entries it is unlikely that
> abnormal queue termination is a problem.

Is the sasl log in any way related to the simple authentication and
security layer?  I had assumed it was logs for secured connections to
rabbit, but now I'm beginning to suspect it's something else...

> As to whether we should remove the queue record when the queue process
> terminates abnormally ... we couldn't just leave the record in place
> since then there would be no way to ever create a queue with the same
> name or get rid of the record. We could restart the queue process, but
> that presents some interesting race conditions as well as masking a
> potentially serious error from clients (even more than is usually the
> case). It's on our todo list to look into this area though.

Yeah, handling process failure would be complicated.  It seems like
the information required to recover a queue's contents is available
(at least the persistent contents are on disk).  I don't have any idea
how you would handle the transactions a queue is engaged in, unless
AMQP had a transaction rollback error like postgres does for
deadlocks.  From my POV, losing the messages in a queue is a pain;
it's not a total catastrophe, but it would be cool if queue contents
could be recovered after a process crash.



From matthias at lshift.net  Fri Sep 18 18:24:00 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 18 Sep 2009 18:24:00 +0100
Subject: [rabbitmq-discuss] Erlang has closed
In-Reply-To: <84fb38e30909180939p285caadamf9bcba8cd1f83461@mail.gmail.com>
References: <84fb38e30909161004m1a0b637dubcfc30b689ed00f3@mail.gmail.com>	<269388e30909170315i787b2f84l9c5e070349880411@mail.gmail.com>	<84fb38e30909170638o2807fadcv1fe5ba743db7d536@mail.gmail.com>	<269388e30909170824nfa84b22r6789d12294652cd6@mail.gmail.com>	<84fb38e30909171325k7bd52156q784206b603284b9c@mail.gmail.com>	<84fb38e30909171709j59e7922ei9e790fd7868313ca@mail.gmail.com>	<84fb38e30909171718n66b549d7he3385a32b7346e1e@mail.gmail.com>	<4AB3806B.8030803@lshift.net>	<84fb38e30909180751x5efb1376h2730c1c44bf10caa@mail.gmail.com>	<4AB3A8B3.8000100@lshift.net>
	<84fb38e30909180939p285caadamf9bcba8cd1f83461@mail.gmail.com>
Message-ID: <4AB3C230.2090308@lshift.net>

Tsuraan,

tsuraan wrote:
> Is the sasl log in any way related to the simple authentication and
> security layer?  I had assumed it was logs for secured connections to
> rabbit, but now I'm beginning to suspect it's something else...

SASL stands for OTP's "System Architecture and Support Libraries".

The rabbit-sasl.log contains log entries generated by Erlang/OTP, 
whereas the rabbit.log contains log entries generated by the rabbit app.

> From my POV, losing the messages in a queue is a pain;
> it's not a total catastrophe, but it would be cool if queue contents
> could be recovered after a process crash.

Queue process crashes should be very rare. If you do see them happening 
please report them.

Being able to recover persisted messages from crashed durable queues 
would indeed be desirable and is something we are looking into. Given 
that such crashes are considered severe and unsual events though, and 
the queue is basically in a completely unknown state at that point, I am 
reluctant to make such recovery automatic - some operator intervention 
is probably desirable.


Regards,

Matthias.



From bp at barryp.org  Fri Sep 18 18:43:02 2009
From: bp at barryp.org (Barry Pederson)
Date: Fri, 18 Sep 2009 12:43:02 -0500
Subject: [rabbitmq-discuss] RabbitMQ vs Spread vs QWIDS
In-Reply-To: <25507940.post@talk.nabble.com>
References: <25507940.post@talk.nabble.com>
Message-ID: <4AB3C6A6.8040306@barryp.org>

Laurent Frobert wrote:
> Hi, 
> 
> my boss wants me to explain why i want to choose RabbitMQ instead of Spread
> (http://www.spread.org/) or QWIDS (http://www.isti2.com/QWIDS/).
> Reason for him,  is that Spread and QWIDS are well used in other production
> environment,
> so, what rabbitmq can give more ?

I used to use Spread, and a few things I didn't like about it were:

The network protocol isn't documented, you pretty much have to use their 
supplied client libraries.  The Python one is just a wrapper around the 
C library, and it gave me lots of trouble with strange errors.  AMQP has 
lots of libraries in various languages now.

No real access control, anyone that connected could send and receive 
anything.  AMQP gives some control over that.

AMQP has topic exchanges, so you can filter out the messages you want 
more easily - Spread didn't have anything like that when I was using it.

Just my 2 cents.

	Barry



From nico.meyer at adition.com  Fri Sep 18 18:58:06 2009
From: nico.meyer at adition.com (Nico Meyer)
Date: Fri, 18 Sep 2009 19:58:06 +0200
Subject: [rabbitmq-discuss] rabbitmq-discuss Digest, Vol 28, Issue 39
In-Reply-To: <mailman.233.1253285466.2595.rabbitmq-discuss@lists.rabbitmq.com>
References: <mailman.233.1253285466.2595.rabbitmq-discuss@lists.rabbitmq.com>
Message-ID: <1253296686.4055.89.camel@erdnuss1.virtualminds-office.de>

Am Freitag, den 18.09.2009, 15:51 +0100 schrieb
rabbitmq-discuss-request at lists.rabbitmq.com:
> Hi, 
> 
> my boss wants me to explain why i want to choose RabbitMQ instead of Spread
> (http://www.spread.org/) or QWIDS (http://www.isti2.com/QWIDS/).
> Reason for him,  is that Spread and QWIDS are well used in other production
> environment,
> so, what rabbitmq can give more ?
> 
> 
> could you help me, thanks
> 

Hi Laurent,

I cannot say anything about QWIDS, but we recently switched from Spread
to RabbitMQ. The switch was mostly motivated by Spread's lack of
scalability and 'development momentum'. Let me elaborate both points a
little.
To scale the performance of a Spread ring you can add more nodes to the
ring. But each message is sent to every node, which is necessary because
of the very strong ordering guarantees that Spread gives you. Because of
this, it scales only for the number of consumers per message, not for
the number of messages. Also the latencies get really bad if you have a
lot of nodes and/or messages per second, because it uses a 'token' which
is passed around the 'ring' and only the node with the token can send
any messages to its clients.
To showcase the other point: about three or four years ago we stumbled
upon a very significant bug in Spread, which could completely disable
the whole Spread ring after some internal message counter wrapped around
(I believe after 2^32 messages). The only way to revive Spread in this
case, is to stop all nodes and restart everything. The first time this I
didn't get any answer on the mailing list. The second time, about 3
months later, someone pointed out a workaround, which had to be
performed manually before the counter reached its maximum value. Last
time I checked (about a year ago) there was no newer version or patch
available.

Besides from these problems, you also have to consider that the three
system are somewhat different in their architecture and have different
goals. Spread implements the Extended Virtual Synchrony model, which is
great if you wan't to maintain a shared state between clients, but is
inherently hard to scale. It gives you presence awareness and for
example a simple master election for free (by ensuring everyone gets
exactly the same join messages in the same order).

But on the other hand Spread does not queue messages or provide any
persistence. If you client disconnects for some time, all messages sent
during that time are lost (unless you implement it yourself with another
consumer). RabbitMQ has queueing and persistence out the box.

Also messages can only be 'routed' by an all or nothing key comparison
(much like a fanout exchange in RabbitMQ). Everyone who is member of a
group gets all messages sent to that group (and in the same order if you
want, but for a possibly large performance penalty). The AMQ model is
more flexible when it comes to routing.

One final thing I can think of is loadbalancing. Since with Spread
'everyone gets everything', the only way to do some kind of
loadbalancing is to selectively drop every Nth message, which is safe
because of the ordering guarantees. This might not be desirable if the
messages are large or otherwise costyl to send/receive. Also there is no
notion of transactions like in RabbitMQ. So if a consumer crashes after
receiving a message but before finishing whatever it needs to do with
it, it is not send to another consumer. You also have to implement that
yourself, should you need it.


I am sure there are more things to consider which I forgot. In the end
everything depends on the application you want to implement and the
requirements you have on the messaging system. Choose the messaging
model that fits best, and only then choose between different products.
End of smartass message!

Bye,
Nico

.



From brian at echonest.com  Sat Sep 19 20:29:55 2009
From: brian at echonest.com (Brian Whitman)
Date: Sat, 19 Sep 2009 15:29:55 -0400
Subject: [rabbitmq-discuss] broker goes down after many new connections
	started
In-Reply-To: <4AB22B5D.4070205@lshift.net>
References: <dbd9700a0909161009j59221975n6675c0f4a0a2f0a6@mail.gmail.com>
	<4AB22B5D.4070205@lshift.net>
Message-ID: <dbd9700a0909191229x50cbda51m4468057507e3379a@mail.gmail.com>

Matthias -- it appears to have been the fd count -- there was 1024, we upped
it to 16384, and things have been stable since.Thanks


On Thu, Sep 17, 2009 at 8:28 AM, Matthias Radestock <matthias at lshift.net>wrote:

> Brian,
>
> Brian Whitman wrote:
>
>> We have a series of machines that we boot at once that all consume and
>> produce messages on about 20 different queues all to the same broker. The
>> broker has been terminating when these machines boot recently.
>>
>
> The errors are indicating that rabbit is running out of file descriptors.
>
> Either your clients are misbehaving and opening lots of connections when
> they shouldn't (or perhaps they are not closing them properly), or the fd
> limit set by the OS is too low.
>
>
> Regards,
>
> Matthias.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090919/95b87789/attachment.htm 

From muharem at hrnjad.net  Sun Sep 20 10:02:49 2009
From: muharem at hrnjad.net (Muharem Hrnjadovic)
Date: Sun, 20 Sep 2009 11:02:49 +0200
Subject: [rabbitmq-discuss] rabbitmq-erlang-client build failure
Message-ID: <4AB5EFB9.9050901@hrnjad.net>

Hello there!

I have rabbitmq version 1.6.0-1 installed on Ubuntu/karmic (erlang
version 1:13.b.1-dfsg-2) and wanted to build the rabbitmq-erlang-client
extension for it.

Unfortunately, I get the following build failure:

{{{
...
mkdir -p deps
unzip -o -d deps dist/rabbit_common.ez
Archive:  dist/rabbit_common.ez
  inflating: deps/rabbit_common/ebin/gen_server2.beam
  inflating: deps/rabbit_common/ebin/rabbit_misc.beam
  inflating: deps/rabbit_common/ebin/rabbit_binary_parser.beam
  inflating: deps/rabbit_common/ebin/rabbit_framing.beam
  inflating: deps/rabbit_common/ebin/rabbit_basic.beam
  inflating: deps/rabbit_common/ebin/rabbit_reader.beam
  inflating: deps/rabbit_common/ebin/rabbit_binary_generator.beam
  inflating: deps/rabbit_common/ebin/rabbit_channel.beam
  inflating: deps/rabbit_common/ebin/rabbit_framing_channel.beam
  inflating: deps/rabbit_common/ebin/rabbit_writer.beam
  inflating: deps/rabbit_common/ebin/rabbit_heartbeat.beam
  inflating: deps/rabbit_common/ebin/rabbit_common.app
  inflating: deps/rabbit_common/include/rabbit_framing.hrl
  inflating: deps/rabbit_common/include/rabbit_framing_spec.hrl
  inflating: deps/rabbit_common/include/rabbit.hrl
ERL_LIBS=deps:dist erlc -I include -o ebin -Wall -v +debug_info
-Duse_specs src/amqp_channel.erl
ERL_LIBS=deps:dist erlc -I include -o ebin -Wall -v +debug_info
-Duse_specs src/amqp_connection.erl
ERL_LIBS=deps:dist erlc -I include -o ebin -Wall -v +debug_info
-Duse_specs src/amqp_direct_driver.erl
ERL_LIBS=deps:dist erlc -I include -o ebin -Wall -v +debug_info
-Duse_specs src/amqp_network_driver.erl
src/amqp_network_driver.erl:64: record ssl_socket undefined
src/amqp_network_driver.erl:63: Warning: variable 'SslSock' is unused
]}}

Has anybody else seen this problem and/or knows how to fix it?

Best regards

-- 
Muharem Hrnjadovic <muharem at hrnjad.net>
Public key id   : B2BBFCFC
Key fingerprint : A5A3 CC67 2B87 D641 103F  5602 219F 6B60 B2BB FCFC

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 898 bytes
Desc: OpenPGP digital signature
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090920/b8051a51/attachment.pgp 

From sh at defuze.org  Sun Sep 20 10:15:36 2009
From: sh at defuze.org (Sylvain Hellegouarch)
Date: Sun, 20 Sep 2009 11:15:36 +0200
Subject: [rabbitmq-discuss] rabbitmq-erlang-client build failure
In-Reply-To: <4AB5EFB9.9050901@hrnjad.net>
References: <4AB5EFB9.9050901@hrnjad.net>
Message-ID: <4AB5F2B8.1050503@defuze.org>

Muharem Hrnjadovic a ?crit :
> Hello there!
>
> I have rabbitmq version 1.6.0-1 installed on Ubuntu/karmic (erlang
> version 1:13.b.1-dfsg-2) and wanted to build the rabbitmq-erlang-client
> extension for it.
>
> Unfortunately, I get the following build failure:
>
> {{{
> ...
> mkdir -p deps
> unzip -o -d deps dist/rabbit_common.ez
> Archive:  dist/rabbit_common.ez
>   inflating: deps/rabbit_common/ebin/gen_server2.beam
>   inflating: deps/rabbit_common/ebin/rabbit_misc.beam
>   inflating: deps/rabbit_common/ebin/rabbit_binary_parser.beam
>   inflating: deps/rabbit_common/ebin/rabbit_framing.beam
>   inflating: deps/rabbit_common/ebin/rabbit_basic.beam
>   inflating: deps/rabbit_common/ebin/rabbit_reader.beam
>   inflating: deps/rabbit_common/ebin/rabbit_binary_generator.beam
>   inflating: deps/rabbit_common/ebin/rabbit_channel.beam
>   inflating: deps/rabbit_common/ebin/rabbit_framing_channel.beam
>   inflating: deps/rabbit_common/ebin/rabbit_writer.beam
>   inflating: deps/rabbit_common/ebin/rabbit_heartbeat.beam
>   inflating: deps/rabbit_common/ebin/rabbit_common.app
>   inflating: deps/rabbit_common/include/rabbit_framing.hrl
>   inflating: deps/rabbit_common/include/rabbit_framing_spec.hrl
>   inflating: deps/rabbit_common/include/rabbit.hrl
> ERL_LIBS=deps:dist erlc -I include -o ebin -Wall -v +debug_info
> -Duse_specs src/amqp_channel.erl
> ERL_LIBS=deps:dist erlc -I include -o ebin -Wall -v +debug_info
> -Duse_specs src/amqp_connection.erl
> ERL_LIBS=deps:dist erlc -I include -o ebin -Wall -v +debug_info
> -Duse_specs src/amqp_direct_driver.erl
> ERL_LIBS=deps:dist erlc -I include -o ebin -Wall -v +debug_info
> -Duse_specs src/amqp_network_driver.erl
> src/amqp_network_driver.erl:64: record ssl_socket undefined
> src/amqp_network_driver.erl:63: Warning: variable 'SslSock' is unused
> ]}}
>
> Has anybody else seen this problem and/or knows how to fix it?
>
> Best regards
>   
I think you may need the most recent RabbitMQ server source code to 
compile the client now.

- Sylvain



From matthias at lshift.net  Sun Sep 20 10:25:35 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Sun, 20 Sep 2009 10:25:35 +0100
Subject: [rabbitmq-discuss] rabbitmq-erlang-client build failure
In-Reply-To: <4AB5F2B8.1050503@defuze.org>
References: <4AB5EFB9.9050901@hrnjad.net> <4AB5F2B8.1050503@defuze.org>
Message-ID: <4AB5F50F.6020808@lshift.net>

Muharem,

Sylvain Hellegouarch wrote:
> Muharem Hrnjadovic a ?crit :
>> I have rabbitmq version 1.6.0-1 installed on Ubuntu/karmic (erlang
>> version 1:13.b.1-dfsg-2) and wanted to build the rabbitmq-erlang-client
>> extension for it.
>>   
> I think you may need the most recent RabbitMQ server source code to 
> compile the client now.

Exactly. Or if you prefer to stick with 1.6.0 then use the version of 
the client tagged 'rabbitmq_v1_6_0' in hg.


Regards,

Matthias.



From muharem at hrnjad.net  Sun Sep 20 21:33:35 2009
From: muharem at hrnjad.net (Muharem Hrnjadovic)
Date: Sun, 20 Sep 2009 22:33:35 +0200
Subject: [rabbitmq-discuss] rabbitmq-erlang-client build failure
In-Reply-To: <4AB5F50F.6020808@lshift.net>
References: <4AB5EFB9.9050901@hrnjad.net> <4AB5F2B8.1050503@defuze.org>
	<4AB5F50F.6020808@lshift.net>
Message-ID: <4AB6919F.3060204@hrnjad.net>

Matthias and Sylvain,

thank you very much, using the client tagged with 'rabbitmq_v1_6_0'
solved the problem.

Best regards

-- 
Muharem Hrnjadovic <muharem at hrnjad.net>
Public key id   : B2BBFCFC
Key fingerprint : A5A3 CC67 2B87 D641 103F  5602 219F 6B60 B2BB FCFC


Matthias Radestock wrote:
> Muharem,
> 
> Sylvain Hellegouarch wrote:
>> Muharem Hrnjadovic a ?crit :
>>> I have rabbitmq version 1.6.0-1 installed on Ubuntu/karmic (erlang
>>> version 1:13.b.1-dfsg-2) and wanted to build the rabbitmq-erlang-client
>>> extension for it.
>>>   
>> I think you may need the most recent RabbitMQ server source code to
>> compile the client now.
> 
> Exactly. Or if you prefer to stick with 1.6.0 then use the version of
> the client tagged 'rabbitmq_v1_6_0' in hg.
> 
> 
> Regards,
> 
> Matthias.
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 898 bytes
Desc: OpenPGP digital signature
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090920/1abb4546/attachment.pgp 

From 0x6e6562 at gmail.com  Mon Sep 21 14:00:37 2009
From: 0x6e6562 at gmail.com (Ben Hood)
Date: Mon, 21 Sep 2009 14:00:37 +0100
Subject: [rabbitmq-discuss] is prefetch count available in erlang
	rabbitmq client
In-Reply-To: <1253213814.4794.25.camel@geib-testing-9.10>
References: <1253213814.4794.25.camel@geib-testing-9.10>
Message-ID: <269388e30909210600m55556be3lc68f671ac3f2cac5@mail.gmail.com>

Hey Mark,

On Thu, Sep 17, 2009 at 7:56 PM, Mark <mark.geib at echostar.com> wrote:
> Setting the prefetch count to one sounds like that will do what I need,
> but I have not found how to do this in the erlang client. Is it there.?

Yes, this is a simple RPC command that is exposed in the Erlang
client. Just create a basic.qos record, set the prefetch_count field
and send it via amqp_channel:call/2. There is a test case called
basic_qos_test in the test_util module that illustrates this.

Ben



From alexis.richardson at gmail.com  Mon Sep 21 14:48:46 2009
From: alexis.richardson at gmail.com (Alexis Richardson)
Date: Mon, 21 Sep 2009 14:48:46 +0100
Subject: [rabbitmq-discuss] is prefetch count available in erlang
	rabbitmq client
In-Reply-To: <269388e30909210600m55556be3lc68f671ac3f2cac5@mail.gmail.com>
References: <1253213814.4794.25.camel@geib-testing-9.10>
	<269388e30909210600m55556be3lc68f671ac3f2cac5@mail.gmail.com>
Message-ID: <167204d20909210648g49937556j9a1224095890da18@mail.gmail.com>

Folks,

FYI

Chris Duncan aka @bunny_amqp has written a note on prefetch and qos,
in the context of Bunny on Ruby:

http://bunnyamqp.wordpress.com/2009/09/20/bunny-quality-of-service-or-prefetch/

alexis


On Mon, Sep 21, 2009 at 2:00 PM, Ben Hood <0x6e6562 at gmail.com> wrote:
> Hey Mark,
>
> On Thu, Sep 17, 2009 at 7:56 PM, Mark <mark.geib at echostar.com> wrote:
>> Setting the prefetch count to one sounds like that will do what I need,
>> but I have not found how to do this in the erlang client. Is it there.?
>
> Yes, this is a simple RPC command that is exposed in the Erlang
> client. Just create a basic.qos record, set the prefetch_count field
> and send it via amqp_channel:call/2. There is a test case called
> basic_qos_test in the test_util module that illustrates this.
>
> Ben
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



From alexgentle at sify.com  Tue Sep 22 03:28:20 2009
From: alexgentle at sify.com (Alex Gentle)
Date: Mon, 21 Sep 2009 19:28:20 -0700
Subject: [rabbitmq-discuss] RabbitMQ with Socket Server
In-Reply-To: <22998192-570B-492D-A9EF-F4F390D22042@mac.com>
References: <fb0723210909101252n23764603k8ae7804be57ffb3b@mail.gmail.com>
	<72AF4FD2-7341-402B-8ED6-7A1FDD2682C0@gmail.com>
	<fb0723210909141215l2fb556afm568f192d291c20ed@mail.gmail.com>
	<269388e30909141612l3f38588cq682d12576acfbd41@mail.gmail.com>
	<fb0723210909141809y411f11b1lc89cfba0956fed4f@mail.gmail.com>
	<05CB3FA2-42C9-4B52-B5E1-03B4BB5758A3@mac.com>
	<fb0723210909151719k60e16a76g32ea8b6dadd1da3c@mail.gmail.com>
	<9D816149-C7F0-46CE-9C46-89A3C5518EE0@mac.com>
	<fb0723210909171740i494c0c0csfee4fcba51d6e989@mail.gmail.com>
	<22998192-570B-492D-A9EF-F4F390D22042@mac.com>
Message-ID: <fb0723210909211928l44df35b0qddde78de73e370d1@mail.gmail.com>

Hi Chuck,

>I think we are getting ahead of ourselves. Your original post indicated
that your code did not work but now you are worried about performance. Let's
get your code working first and then you can worry >about optimizing it
later.

>Can you successfully publish your messages yet? If so, can you pop them off
of the queue to read them?

Yes. The code is working. I can publish and retrieve the messages from the
queue. It works well.

>Polling is usually a bad idea particularly since it requires a lot of
unnecessary messaging. Most AMQP libraries I have seen allow for two ways to
fetch messages. One way is to "get" them from the >queue which is a
synchronous operation. The second way is to "subscribe" to a queue and have
it asynchronously push messages to the subscriber. You want to investigate
this second methodology >for your application. Async operations result in
slightly more complex code but they will let you scale better than
polling/synchronous operations.

This is news to me. I thought that client has to run the call to fetch the
message that is in the client's queue, even if the client subscribes to it.
Could you please explain pushing messages to the subscriber. If I have
socket server in the middle, will it block the pushed messages? I want to
trigger some kind of signal from rabbitmq to the client when a message is
waiting for the client so that client doesn't need to poll every few
seconds.

Thank you.


On Fri, Sep 18, 2009 at 5:27 AM, Chuck Remes <cremes.devlist at mac.com> wrote:

>
> On Sep 17, 2009, at 7:40 PM, Alex Gentle wrote:
>
> >Once you have parsed the message from socket server and determined it >should go to rabbit, you publish the message to it.
>
>
>
> I don?t know Ruby. I wrote a PHP program that parse the message from socket server and pass the message to RabbitMQ server.
>
>
>
> I wrote the examples in ruby since the code is very compact. You can
> perform the same operations in any language that has an AMQP library.
>
>
> The catch here is the performance. iPhone needs to query for the message in the queue every few seconds.
>
>
>
> I think we are getting ahead of ourselves. Your original post indicated
> that your code did not work but now you are worried about performance. Let's
> get your code working first and then you can worry about optimizing it
> later.
>
> Can you successfully publish your messages yet? If so, can you pop them off
> of the queue to read them?
>
>
> Let us assume
>
> that User A and User B chats thru iPhone application. User A sends the message to RabbitMQ.
>
>
>
> User A -> Socket Server -> RabbitMQ Server
>
>
>
> RabbitMQ has no way of sending the notification to User B that some message is waiting for him.
>
>
>
> User B needs to check the RabbitMQ server every 5 seconds to see if there is any message in his queue.
>
>
>
> Imagine there are 10,000 users like user A and B. All of them will be sending the message thru socket server to RabbitMQ server. Socket
>
> server can handle all the traffic. It?s a piece of cake for RabbitMQ to handle the traffic. But, the poor PHP program in the middle
> (between socket server and RabbitMQ) can?t handle all the incoming and outgoing requests with ease. It?s going to slow down the process.
>
> Users will see substantial delay in sending and receiving messages.
>
>
>
> Is there a better way to do it? Thanks.
>
>
> Polling is usually a bad idea particularly since it requires a lot of
> unnecessary messaging. Most AMQP libraries I have seen allow for two ways to
> fetch messages. One way is to "get" them from the queue which is a
> synchronous operation. The second way is to "subscribe" to a queue and have
> it asynchronously push messages to the subscriber. You want to investigate
> this second methodology for your application. Async operations result in
> slightly more complex code but they will let you scale better than
> polling/synchronous operations.
>
> cr
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090921/4299d4c0/attachment.htm 

From farra at apache.org  Tue Sep 22 09:06:26 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 16:06:26 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't get status'
Message-ID: <m21vlzl7y5.fsf@apache.org>


Despite having followed all of the directions on Dmitriy Samovskiy?s
article [1], I consistently see the following when trying to get
rabbitmq up and running:

    $ sudo rabbitmqctl status
    Status of node rabbit at localhost ...
    {badrpc,nodedown}
    ...done.


Details:

 - Mac OS X 10.5.8
 - Erlang installed from source (otp_src_R13B01)
 - RabbitMQ installed from source (rabbitmq-server-1.6.0.tar.gz)
 - rabbitmq user created
 - telnet to 127.0.0.1:5672 works
 - net_admin:names() returns `{ok,[{"rabbit",54472},{"foo",54740}]}`


Any other thoughts?

-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com

[1] http://somic.org/2009/02/19/on-rabbitmqctl-and-badrpcnodedown/



From sh at defuze.org  Tue Sep 22 09:33:24 2009
From: sh at defuze.org (Sylvain Hellegouarch)
Date: Tue, 22 Sep 2009 10:33:24 +0200 (CEST)
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
 can't get status'
In-Reply-To: <m21vlzl7y5.fsf@apache.org>
References: <m21vlzl7y5.fsf@apache.org>
Message-ID: <41130.193.253.216.132.1253608404.squirrel@mail1.webfaction.com>

Usually the logs offer the reason or a good hint in regards to the
failure. You may want to look at them.

- Sylvain

>
> Despite having followed all of the directions on Dmitriy Samovskiy???s
> article [1], I consistently see the following when trying to get
> rabbitmq up and running:
>
>     $ sudo rabbitmqctl status
>     Status of node rabbit at localhost ...
>     {badrpc,nodedown}
>     ...done.
>
>
> Details:
>
>  - Mac OS X 10.5.8
>  - Erlang installed from source (otp_src_R13B01)
>  - RabbitMQ installed from source (rabbitmq-server-1.6.0.tar.gz)
>  - rabbitmq user created
>  - telnet to 127.0.0.1:5672 works
>  - net_admin:names() returns `{ok,[{"rabbit",54472},{"foo",54740}]}`
>
>
> Any other thoughts?
>
> --
>    J. Aaron Farr
>    ?????????
>    www.cubiclemuses.com
>
> [1] http://somic.org/2009/02/19/on-rabbitmqctl-and-badrpcnodedown/
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>


-- 
Sylvain Hellegouarch
http://www.defuze.org



From farra at apache.org  Tue Sep 22 09:42:31 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 16:42:31 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't get status'
In-Reply-To: <41130.193.253.216.132.1253608404.squirrel@mail1.webfaction.com>
	(Sylvain Hellegouarch's message of "Tue, 22 Sep 2009 10:33:24 +0200
	(CEST)")
References: <m21vlzl7y5.fsf@apache.org>
	<41130.193.253.216.132.1253608404.squirrel@mail1.webfaction.com>
Message-ID: <m2ws3rjrpk.fsf@apache.org>


On Tue 22 Sep 2009 16:33, "Sylvain Hellegouarch" <sh at defuze.org> wrote:

> Usually the logs offer the reason or a good hint in regards to the
> failure. You may want to look at them.

Hasn't helped me at least:


    $ rabbitmq-server
    RabbitMQ 1.6.0 (AMQP 8-0)
    Copyright (C) 2007-2009 LShift Ltd., Cohesive Financial Technologies LLC., and Rabbit Technologies Ltd.
    Licensed under the MPL.  See http://www.rabbitmq.com/
    
    node        : rabbit at gandalf
    log         : /var/log/rabbitmq/rabbit.log
    sasl log    : /var/log/rabbitmq/rabbit-sasl.log
    database dir: /var/lib/rabbitmq/mnesia/rabbit
    
    starting database             ...done
    starting core processes       ...done
    starting recovery             ...done
    starting persister            ...done
    starting guid generator       ...done
    starting builtin applications ...done
    starting TCP listeners        ...done
    
    broker running

and:

    $ tail -f *.log
    
    ==> rabbit-sasl.log <==
    
    ==> rabbit.log <==
    Repaired persister log - 1 recovered, 0 bad
    
    =INFO REPORT==== 22-Sep-2009::16:38:28 ===
    Rolling persister log to "/var/lib/rabbitmq/mnesia/rabbit/rabbit_persister.LOG.previous"
    
    =INFO REPORT==== 22-Sep-2009::16:38:28 ===
    started TCP listener on 0.0.0.0:5672
    
    =INFO REPORT==== 22-Sep-2009::16:38:38 ===
    Rolling persister log to "/var/lib/rabbitmq/mnesia/rabbit/rabbit_persister.LOG.previous"

and again:

    $ sudo rabbitmqctl status
    Status of node rabbit at gandalf ...
    {badrpc,nodedown}
    ...done.

Shows no changes in rabbit.log or rabbit-sasl.log
    
-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com



From pauljones23 at gmail.com  Tue Sep 22 09:43:28 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 22 Sep 2009 09:43:28 +0100
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't 	get status'
In-Reply-To: <m21vlzl7y5.fsf@apache.org>
References: <m21vlzl7y5.fsf@apache.org>
Message-ID: <29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>

Is rabbit running as root or rabbitmq? If you're running rabbit as rabbitmq,
then you may need to add "-U rabbitmq" to the sudo command to ensure that
rabbitmqctl is running as the same user.

Paul.

On Tue, Sep 22, 2009 at 9:06 AM, J Aaron Farr <farra at apache.org> wrote:

>
> Despite having followed all of the directions on Dmitriy Samovskiy?s
> article [1], I consistently see the following when trying to get
> rabbitmq up and running:
>
>    $ sudo rabbitmqctl status
>    Status of node rabbit at localhost ...
>    {badrpc,nodedown}
>    ...done.
>
>
> Details:
>
>  - Mac OS X 10.5.8
>  - Erlang installed from source (otp_src_R13B01)
>  - RabbitMQ installed from source (rabbitmq-server-1.6.0.tar.gz)
>  - rabbitmq user created
>  - telnet to 127.0.0.1:5672 works
>  - net_admin:names() returns `{ok,[{"rabbit",54472},{"foo",54740}]}`
>
>
> Any other thoughts?
>
> --
>   J. Aaron Farr
>   ???
>   www.cubiclemuses.com
>
> [1] http://somic.org/2009/02/19/on-rabbitmqctl-and-badrpcnodedown/
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090922/1042384d/attachment.htm 

From farra at apache.org  Tue Sep 22 09:58:52 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 16:58:52 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't  get status'
In-Reply-To: <29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	(Paul Jones's message of "Tue, 22 Sep 2009 09:43:28 +0100")
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
Message-ID: <m2skefjqyb.fsf@apache.org>


On Tue 22 Sep 2009 16:43, Paul Jones <pauljones23 at gmail.com> wrote:

> Is rabbit running as root or rabbitmq? If you're running rabbit as rabbitmq,
> then you may need to add "-U rabbitmq" to the sudo command to ensure that
> rabbitmqctl is running as the same user.

I've tried both combinations, as root and as rabbitmq.  I've checked to
ensure both processes are run as the exact same user.  Still no dice.

I've also made sure every rabbitmq directory is owned by rabbitmq.

`net_adm:localhost().` returns 'gandalf.local' which is the name of the
local computer.  I've even added a line in /etc/hosts for gandalf.local
for 127.0.0.1.

I'm really stumped here.

-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com



From pauljones23 at gmail.com  Tue Sep 22 10:59:12 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 22 Sep 2009 10:59:12 +0100
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't 	get status'
In-Reply-To: <m2skefjqyb.fsf@apache.org>
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
Message-ID: <29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>

Just so we can understand your setup, how are you trying to setup the users
for rabbit? Did you do the build as a rabbitmq user, or ...?

One of the most likely causes of the nodedown tends to be cookie mismatches,
which can be hard to definitively check. In both the rabbitmq-server and
rabbitmqctl scripts, can you please add the follow line somewhere within the
command line flags (perhaps after the -sname):
  -eval 'io:format("~p~n", [init:get_argument(home)])'

This will print (badly formatted I'm afraid) the home directory that erlang
is seeing, and subsequently allows you to determine that the home
directories are the same. If they are, it could also be worth adding:
  -eval 'io:format("~p~n", [erlang:get_cookie()])'

This will dump the value of the erlang cookie. Generally, the Erlang cookie
should be considered somewhat private, so I'll leave it up to you whether
you want to post it to the mailing list. Simply providing detail on whether
they are the same is enough.

On Tue, Sep 22, 2009 at 9:58 AM, J Aaron Farr <farra at apache.org> wrote:

>
> On Tue 22 Sep 2009 16:43, Paul Jones <pauljones23 at gmail.com> wrote:
>
> > Is rabbit running as root or rabbitmq? If you're running rabbit as
> rabbitmq,
> > then you may need to add "-U rabbitmq" to the sudo command to ensure that
> > rabbitmqctl is running as the same user.
>
> I've tried both combinations, as root and as rabbitmq.  I've checked to
> ensure both processes are run as the exact same user.  Still no dice.
>
> I've also made sure every rabbitmq directory is owned by rabbitmq.
>
> `net_adm:localhost().` returns 'gandalf.local' which is the name of the
> local computer.  I've even added a line in /etc/hosts for gandalf.local
> for 127.0.0.1.
>
> I'm really stumped here.
>
> --
>    J. Aaron Farr
>   ???
>   www.cubiclemuses.com
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090922/21bc59fa/attachment.htm 

From farra at apache.org  Tue Sep 22 11:16:38 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 18:16:38 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't  get status'
In-Reply-To: <29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
	(Paul Jones's message of "Tue, 22 Sep 2009 10:59:12 +0100")
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
	<29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
Message-ID: <m2ocp3jncp.fsf@apache.org>


Thanks for the further help, Paul.  Comments below:

On Tue 22 Sep 2009 17:59, Paul Jones <pauljones23 at gmail.com> wrote:

> Just so we can understand your setup, how are you trying to setup the users
> for rabbit? Did you do the build as a rabbitmq user, or ...?

I've done builds as root or as rabbitmq.  I think the current build was
done via the rabbitmq user.

The ultimate intent here is to use rabbitmq with Nanite [1]

> One of the most likely causes of the nodedown tends to be cookie mismatches,
> which can be hard to definitively check. In both the rabbitmq-server and
> rabbitmqctl scripts, can you please add the follow line somewhere within the
> command line flags (perhaps after the -sname):
>   -eval 'io:format("~p~n", [init:get_argument(home)])'

For both:

{ok,[["/Users/rabbitmq"]]}

> This will print (badly formatted I'm afraid) the home directory that erlang
> is seeing, and subsequently allows you to determine that the home
> directories are the same. If they are, it could also be worth adding:
>   -eval 'io:format("~p~n", [erlang:get_cookie()])'

Identical.

gandalf:~ rabbitmq$ rabbitmqctl status
{ok,[["/Users/rabbitmq"]]}
'--------------------'
Status of node rabbit at gandalf ...
{badrpc,nodedown}
...done.


I'm attempting to rebuild my environment on a test server and see if I
can reproduce my situation there.

-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com

[1] http://github.com/ezmobius/nanite



From pauljones23 at gmail.com  Tue Sep 22 11:22:03 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 22 Sep 2009 11:22:03 +0100
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't 	get status'
In-Reply-To: <m2ocp3jncp.fsf@apache.org>
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
	<29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
	<m2ocp3jncp.fsf@apache.org>
Message-ID: <29598b610909220322j15ecc7d8g84b7bb88fde3a814@mail.gmail.com>

On Tue, Sep 22, 2009 at 11:16 AM, J Aaron Farr <farra at apache.org> wrote:

>
> I've done builds as root or as rabbitmq.  I think the current build was
> done via the rabbitmq user.
>
> For both:
>
> {ok,[["/Users/rabbitmq"]]}
>
> > This will print (badly formatted I'm afraid) the home directory that
> erlang
> > is seeing, and subsequently allows you to determine that the home
> > directories are the same. If they are, it could also be worth adding:
> >   -eval 'io:format("~p~n", [erlang:get_cookie()])'
>
> Identical.
>
>
Are you referring to identical home directories or identical cookies?

Have you attempted to run them both without the use of sudo?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090922/413d8621/attachment.htm 

From farra at apache.org  Tue Sep 22 11:59:14 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 18:59:14 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't  get status'
In-Reply-To: <29598b610909220322j15ecc7d8g84b7bb88fde3a814@mail.gmail.com>
	(Paul Jones's message of "Tue, 22 Sep 2009 11:22:03 +0100")
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
	<29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
	<m2ocp3jncp.fsf@apache.org>
	<29598b610909220322j15ecc7d8g84b7bb88fde3a814@mail.gmail.com>
Message-ID: <m21vlznt31.fsf@apache.org>


On Tue 22 Sep 2009 18:22, Paul Jones <pauljones23 at gmail.com> wrote:

> Are you referring to identical home directories or identical cookies?

Both.  Both the home directories are identical (/Users/rabbitmq) and the
cookies.

> Have you attempted to run them both without the use of sudo?

Yes.

I ssh back into the laptop (activemq at 127.0.0.1) and run the command
directly as the activemq user.  I'm certain I'm that user and that my
path is sane.

-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com



From farra at apache.org  Tue Sep 22 12:00:42 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 19:00:42 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't  get status'
In-Reply-To: <m2ocp3jncp.fsf@apache.org> (J. Aaron Farr's message of "Tue, 22
	Sep 2009 18:16:38 +0800")
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
	<29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
	<m2ocp3jncp.fsf@apache.org>
Message-ID: <m2tyyvmeg5.fsf@apache.org>


On Tue 22 Sep 2009 18:16, J Aaron Farr <farra at apache.org> wrote:

> I'm attempting to rebuild my environment on a test server and see if I
> can reproduce my situation there.

And for the record, I just did a similar install on a dev server running
OpenSolaris 2008.11 and it worked just fine.  :-/

I suppose I could just use the dev server instance, but would someday
really like to know why I can't get this to run on my OS X laptop.

-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com



From brian at echonest.com  Tue Sep 22 11:55:28 2009
From: brian at echonest.com (Brian Whitman)
Date: Tue, 22 Sep 2009 06:55:28 -0400
Subject: [rabbitmq-discuss] can't start broker
Message-ID: <dbd9700a0909220355r3b2ae4e5w2cdf99aea012cf13@mail.gmail.com>

The broker crashed and now we're getting this on restart. Any ideas?
@400000004ab8ac9911861b5c Licensed under the MPL.  See
http://www.rabbitmq.com/
@400000004ab8ac9911861f44
@400000004ab8ac991189671c node        : rabbit at echonest03
@400000004ab8ac991199265c log         : /var/log/rabbitmq/rabbit.log
@400000004ab8ac9911aa6c3c sasl log    : /var/log/rabbitmq/rabbit-sasl.log
@400000004ab8ac9911bda234 database dir: /var/lib/rabbitmq/mnesia/rabbit
@400000004ab8ac9911ce7ab4
@400000004ab8ac9911cfd65c starting database             ...done
@400000004ab8ac9d2e669fbc starting core processes       ...done
@400000004ab8ac9d2f3960dc starting disk queue           ...done
@400000004ab8acfc154b976c starting recovery             ...Erlang has closed
@400000004ab8acfd298e2154 {"init terminating in
do_boot",{{nocatch,{error,{cannot_start_application,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{{{badmatch,[]},[{rabbit_disk_queue,'-remove_messages/4-fun-0-',7},{lists,foldl,3},{rabbit_disk_queue,remove_messages,4},{rabbit_disk_queue,internal_purge,2},{rabbit_disk_queue,internal_delete_queue,2},{lists,foldl,3},{ets,do_foldl,4},{ets,foldl,3}]},{gen_server2,call,[rabbit_disk_queue,{delete_non_durable_queues,{set,58,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[{resource,<<1
byte>>,queue,<<10 bytes>>},{resource,<<1 byte>>,queue,<<18
bytes>>},{resource,<<1 byte>>,queue,<<29 bytes>>},{resource,<<1
byte>>,queue,<<25 bytes>>},{resource,<<1 byte>>,queue,<<14
bytes>>},{resource,<<1 byte>>,queue,<<23 bytes>>}],[{resource,<<1
byte>>,queue,<<31 bytes>>},{resource,<<1 byte>>,queue,<<21
bytes>>},{resource,<<1 byte>>,queue,<<28 bytes>>}],[{resource,<<1
byte>>,queue,<<34 bytes>>}],[{resource,<<1 byte>>,queue,<<32
bytes>>},{resource,<<1 byte>>,queue,<<33 bytes>>}],[{resource,<<1
byte>>,queue,<<31 bytes>>},{resource,<<1 byte>>,queue,<<30
bytes>>},{resource,<<1 byte>>,queue,<<36 bytes>>},{resource,<<1
byte>>,queue,<<30 bytes>>}],[{resource,<<1 byte>>,queue,<<26
bytes>>},{resource,<<1 byte>>,queue,<<19 bytes>>},{resource,<<1
byte>>,queue,<<23 bytes>>},{resource,<<1 byte>>,queue,<<24
bytes>>}],[{resource,<<1 byte>>,queue,<<33 bytes>>},{resource,<<1
byte>>,queue,<<21 bytes>>},{resource,<<1 byte>>,queue,<<31
bytes>>},{resource,<<1 byte>>,queue,<<13 bytes>>},{resource,<<1
byte>>,queue,<<27 bytes>>}],[{resource,<<1 byte>>,queue,<<12
bytes>>},{resource,<<1 byte>>,queue,<<23 bytes>>},{resource,<<1
byte>>,queue,<<33 bytes>>}],[{resource,<<1 byte>>,queue,<<31
bytes>>},{resource,<<1 byte>>,queue,<<33 bytes>>},{resource,<<1
byte>>,queue,<<34 bytes>>}],[{resource,<<1 byte>>,queue,<<32
bytes>>}],[{resource,<<1 byte>>,queue,<<20 bytes>>},{resource,<<1
byte>>,queue,<<29 bytes>>},{resource,<<1 byte>>,queue,<<33
bytes>>},{resource,<<1 byte>>,queue,<<31 bytes>>},{resource,<<1
byte>>,queue,<<34 bytes>>},{resource,<<1 byte>>,queue,<<20
bytes>>},{resource,<<1 byte>>,queue,<<25 bytes>>},{resource,<<1
byte>>,queue,<<21 bytes>>},{resource,<<1 byte>>,queue,<<21
bytes>>},{resource,<<1 byte>>,queue,<<29 bytes>>},{resource,<<1
byte>>,queue,<<27 bytes>>}],[{resource,<<1 byte>>,queue,<<20
bytes>>},{resource,<<1 byte>>,queue,<<22 bytes>>},{resource,<<1
byte>>,queue,<<25 bytes>>},{resource,<<1 byte>>,queue,<<25
bytes>>}],[{resource,<<1 byte>>,queue,<<22 bytes>>},{resource,<<1
byte>>,queue,<<24 bytes>>},{resource,<<1 byte>>,queue,<<34
bytes>>},{resource,<<1 byte>>,queue,<<20 bytes>>},{resource,<<1
byte>>,queue,<<24 bytes>>}],[{resource,<<1 byte>>,queue,<<29
bytes>>}],[{resource,<<1 byte>>,queue,<<25 bytes>>},{resource,<<1
byte>>,queue,<<34 bytes>>},{resource,<<1 byte>>,queue,<<22
bytes>>}],[{resource,<<1 byte>>,queue,<<32 bytes>>},{resource,<<1
byte>>,queue,<<34
bytes>>}]}}}},infinity]}}}}}}}},[{init,start_it,1},{init,start_em,1}]}}
@400000004ab8acfd29d4d2fc init terminating in do_boot ()
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090922/789e7a54/attachment.htm 

From farra at apache.org  Tue Sep 22 12:07:41 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 19:07:41 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't  get status'
In-Reply-To: <29598b610909220322j15ecc7d8g84b7bb88fde3a814@mail.gmail.com>
	(Paul Jones's message of "Tue, 22 Sep 2009 11:22:03 +0100")
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
	<29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
	<m2ocp3jncp.fsf@apache.org>
	<29598b610909220322j15ecc7d8g84b7bb88fde3a814@mail.gmail.com>
Message-ID: <m2pr9jme4i.fsf@apache.org>


Could there be some file somewhere that I need to delete or refresh
given the number of times I've been trying to build, rebuild, run and
rerun?  I've cleaned out /var/lib/rabbitmq.  Anything else?  Anything in
a home directory or tmp directory?

-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com



From farra at apache.org  Tue Sep 22 12:09:44 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 19:09:44 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't  get status'
In-Reply-To: <m21vlznt31.fsf@apache.org> (J. Aaron Farr's message of "Tue, 22
	Sep 2009 18:59:14 +0800")
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
	<29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
	<m2ocp3jncp.fsf@apache.org>
	<29598b610909220322j15ecc7d8g84b7bb88fde3a814@mail.gmail.com>
	<m21vlznt31.fsf@apache.org>
Message-ID: <m2ljk7me13.fsf@apache.org>


On Tue 22 Sep 2009 18:59, J Aaron Farr <farra at apache.org> wrote:

> I ssh back into the laptop (activemq at 127.0.0.1) and run the command
> directly as the activemq user.  I'm certain I'm that user and that my
> path is sane.

s/activemq/rabbitmq

sorry about that.

-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com



From brian at echonest.com  Tue Sep 22 12:13:46 2009
From: brian at echonest.com (Brian Whitman)
Date: Tue, 22 Sep 2009 07:13:46 -0400
Subject: [rabbitmq-discuss] can't start broker
In-Reply-To: <dbd9700a0909220355r3b2ae4e5w2cdf99aea012cf13@mail.gmail.com>
References: <dbd9700a0909220355r3b2ae4e5w2cdf99aea012cf13@mail.gmail.com>
Message-ID: <dbd9700a0909220413s7c671247v4fe97fa061894707@mail.gmail.com>

A delete of the mnesia/rabbit folder fixed the restart crash but of course
our queues are all gone. Any ideas what this could have been?

On Tue, Sep 22, 2009 at 6:55 AM, Brian Whitman <brian at echonest.com> wrote:

> The broker crashed and now we're getting this on restart. Any ideas?
> @400000004ab8ac9911861b5c Licensed under the MPL.  See
> http://www.rabbitmq.com/
> @400000004ab8ac9911861f44
> @400000004ab8ac991189671c node        : rabbit at echonest03
> @400000004ab8ac991199265c log         : /var/log/rabbitmq/rabbit.log
> @400000004ab8ac9911aa6c3c sasl log    : /var/log/rabbitmq/rabbit-sasl.log
> @400000004ab8ac9911bda234 database dir: /var/lib/rabbitmq/mnesia/rabbit
> @400000004ab8ac9911ce7ab4
> @400000004ab8ac9911cfd65c starting database             ...done
> @400000004ab8ac9d2e669fbc starting core processes       ...done
> @400000004ab8ac9d2f3960dc starting disk queue           ...done
> @400000004ab8acfc154b976c starting recovery             ...Erlang has
> closed
> @400000004ab8acfd298e2154 {"init terminating in
> do_boot",{{nocatch,{error,{cannot_start_application,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{{{badmatch,[]},[{rabbit_disk_queue,'-remove_messages/4-fun-0-',7},{lists,foldl,3},{rabbit_disk_queue,remove_messages,4},{rabbit_disk_queue,internal_purge,2},{rabbit_disk_queue,internal_delete_queue,2},{lists,foldl,3},{ets,do_foldl,4},{ets,foldl,3}]},{gen_server2,call,[rabbit_disk_queue,{delete_non_durable_queues,{set,58,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[{resource,<<1
> byte>>,queue,<<10 bytes>>},{resource,<<1 byte>>,queue,<<18
> bytes>>},{resource,<<1 byte>>,queue,<<29 bytes>>},{resource,<<1
> byte>>,queue,<<25 bytes>>},{resource,<<1 byte>>,queue,<<14
> bytes>>},{resource,<<1 byte>>,queue,<<23 bytes>>}],[{resource,<<1
> byte>>,queue,<<31 bytes>>},{resource,<<1 byte>>,queue,<<21
> bytes>>},{resource,<<1 byte>>,queue,<<28 bytes>>}],[{resource,<<1
> byte>>,queue,<<34 bytes>>}],[{resource,<<1 byte>>,queue,<<32
> bytes>>},{resource,<<1 byte>>,queue,<<33 bytes>>}],[{resource,<<1
> byte>>,queue,<<31 bytes>>},{resource,<<1 byte>>,queue,<<30
> bytes>>},{resource,<<1 byte>>,queue,<<36 bytes>>},{resource,<<1
> byte>>,queue,<<30 bytes>>}],[{resource,<<1 byte>>,queue,<<26
> bytes>>},{resource,<<1 byte>>,queue,<<19 bytes>>},{resource,<<1
> byte>>,queue,<<23 bytes>>},{resource,<<1 byte>>,queue,<<24
> bytes>>}],[{resource,<<1 byte>>,queue,<<33 bytes>>},{resource,<<1
> byte>>,queue,<<21 bytes>>},{resource,<<1 byte>>,queue,<<31
> bytes>>},{resource,<<1 byte>>,queue,<<13 bytes>>},{resource,<<1
> byte>>,queue,<<27 bytes>>}],[{resource,<<1 byte>>,queue,<<12
> bytes>>},{resource,<<1 byte>>,queue,<<23 bytes>>},{resource,<<1
> byte>>,queue,<<33 bytes>>}],[{resource,<<1 byte>>,queue,<<31
> bytes>>},{resource,<<1 byte>>,queue,<<33 bytes>>},{resource,<<1
> byte>>,queue,<<34 bytes>>}],[{resource,<<1 byte>>,queue,<<32
> bytes>>}],[{resource,<<1 byte>>,queue,<<20 bytes>>},{resource,<<1
> byte>>,queue,<<29 bytes>>},{resource,<<1 byte>>,queue,<<33
> bytes>>},{resource,<<1 byte>>,queue,<<31 bytes>>},{resource,<<1
> byte>>,queue,<<34 bytes>>},{resource,<<1 byte>>,queue,<<20
> bytes>>},{resource,<<1 byte>>,queue,<<25 bytes>>},{resource,<<1
> byte>>,queue,<<21 bytes>>},{resource,<<1 byte>>,queue,<<21
> bytes>>},{resource,<<1 byte>>,queue,<<29 bytes>>},{resource,<<1
> byte>>,queue,<<27 bytes>>}],[{resource,<<1 byte>>,queue,<<20
> bytes>>},{resource,<<1 byte>>,queue,<<22 bytes>>},{resource,<<1
> byte>>,queue,<<25 bytes>>},{resource,<<1 byte>>,queue,<<25
> bytes>>}],[{resource,<<1 byte>>,queue,<<22 bytes>>},{resource,<<1
> byte>>,queue,<<24 bytes>>},{resource,<<1 byte>>,queue,<<34
> bytes>>},{resource,<<1 byte>>,queue,<<20 bytes>>},{resource,<<1
> byte>>,queue,<<24 bytes>>}],[{resource,<<1 byte>>,queue,<<29
> bytes>>}],[{resource,<<1 byte>>,queue,<<25 bytes>>},{resource,<<1
> byte>>,queue,<<34 bytes>>},{resource,<<1 byte>>,queue,<<22
> bytes>>}],[{resource,<<1 byte>>,queue,<<32 bytes>>},{resource,<<1
> byte>>,queue,<<34
> bytes>>}]}}}},infinity]}}}}}}}},[{init,start_it,1},{init,start_em,1}]}}
> @400000004ab8acfd29d4d2fc init terminating in do_boot ()
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090922/c1da42f5/attachment.htm 

From matthias at lshift.net  Tue Sep 22 12:26:10 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 22 Sep 2009 12:26:10 +0100
Subject: [rabbitmq-discuss] can't start broker
In-Reply-To: <dbd9700a0909220355r3b2ae4e5w2cdf99aea012cf13@mail.gmail.com>
References: <dbd9700a0909220355r3b2ae4e5w2cdf99aea012cf13@mail.gmail.com>
Message-ID: <4AB8B452.9090600@lshift.net>

Brian,

Brian Whitman wrote:
> The broker crashed and now we're getting this on restart. Any ideas?

It looks like you are running a bleeding edge version of the broker,
including the new persister, right?

If so, please

1) tell us what version it is (by running 'hg id', assuming you got it
from mercurial)

2) send us the contents of the /var/lib/rabbitmq/mnesia/rabbit directory


Regards,

Matthias.



From brian at echonest.com  Tue Sep 22 12:33:19 2009
From: brian at echonest.com (Brian Whitman)
Date: Tue, 22 Sep 2009 07:33:19 -0400
Subject: [rabbitmq-discuss] can't start broker
In-Reply-To: <4AB8B452.9090600@lshift.net>
References: <dbd9700a0909220355r3b2ae4e5w2cdf99aea012cf13@mail.gmail.com>
	<4AB8B452.9090600@lshift.net>
Message-ID: <dbd9700a0909220433t1d8eeb74o713d46d7aaab2225@mail.gmail.com>

>
>
> It looks like you are running a bleeding edge version of the broker,
> including the new persister, right?
>
>
Yes, probably should have mentioned that, it's early ;)

[root at echonest03 rabbitmq-server]# hg id
184cb96f7846+ (bug20980)



> 2) send us the contents of the /var/lib/rabbitmq/mnesia/rabbit directory
>
>
This is posted to http://posh.echonest.net/bad_data.zip

Thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090922/e7a3279d/attachment.htm 

From pauljones23 at gmail.com  Tue Sep 22 12:36:52 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 22 Sep 2009 12:36:52 +0100
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't 	get status'
In-Reply-To: <m2ljk7me13.fsf@apache.org>
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
	<29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
	<m2ocp3jncp.fsf@apache.org>
	<29598b610909220322j15ecc7d8g84b7bb88fde3a814@mail.gmail.com>
	<m21vlznt31.fsf@apache.org> <m2ljk7me13.fsf@apache.org>
Message-ID: <29598b610909220436o343db79ajf4c90e33479e7ae6@mail.gmail.com>

We're starting to run low on ideas, but here are a few others that can be
tried:

   - Change the RABBITMQ_NODENAME in the rabbitmq-server script to
   rabbit at localhost (or some other predictable host name), and then use the
   -n flag on rabbitmqctl to force it as well.
   - Try doing a sudo killall epmd and sudo killall beam.smp - it is very
   unlikely, but perhaps the process mapper daemon has gotten into a mess
   (alternatively, you could reboot, but I don't really like suggesting that
   for Mac OS X)


On Tue, Sep 22, 2009 at 12:09 PM, J Aaron Farr <farra at apache.org> wrote:

>
> On Tue 22 Sep 2009 18:59, J Aaron Farr <farra at apache.org> wrote:
>
> > I ssh back into the laptop (activemq at 127.0.0.1) and run the command
> > directly as the activemq user.  I'm certain I'm that user and that my
> > path is sane.
>
> s/activemq/rabbitmq
>
> sorry about that.
>
> --
>   J. Aaron Farr
>   ???
>   www.cubiclemuses.com
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090922/be9b55f1/attachment.htm 

From celldee at gmail.com  Tue Sep 22 12:52:58 2009
From: celldee at gmail.com (Chris Duncan)
Date: Tue, 22 Sep 2009 12:52:58 +0100
Subject: [rabbitmq-discuss] RabbitMQ native SSL support
Message-ID: <2C0E40EC-032B-4F3D-A2C5-937ECDEE1BB2@gmail.com>

I had a recent conversation about SSL support in RabbitMQ and would  
like to clarify my understanding. The current v1.6.0 stable RabbitMQ  
release does not appear to have native SSL support. Is v1.7.0  
scheduled to include it and if not, is there a plan to include it in  
a specific future version?

I found this previous thread - http://lists.rabbitmq.com/pipermail/ 
rabbitmq-discuss/2009-July/004045.html - that addressed the subject,  
but I didn't see an answer to my question within it. Please excuse me  
if this has been answered elsewhere.

Regards,

Chris Duncan



From matthias at lshift.net  Tue Sep 22 12:58:06 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 22 Sep 2009 12:58:06 +0100
Subject: [rabbitmq-discuss] can't start broker
In-Reply-To: <dbd9700a0909220433t1d8eeb74o713d46d7aaab2225@mail.gmail.com>
References: <dbd9700a0909220355r3b2ae4e5w2cdf99aea012cf13@mail.gmail.com>	<4AB8B452.9090600@lshift.net>
	<dbd9700a0909220433t1d8eeb74o713d46d7aaab2225@mail.gmail.com>
Message-ID: <4AB8BBCE.2060206@lshift.net>

Brian,

Brian Whitman wrote:
> 
>     It looks like you are running a bleeding edge version of the broker,
>     including the new persister, right?
> 
> 
> Yes, probably should have mentioned that, it's early ;)
> 
> [root at echonest03 rabbitmq-server]# hg id
> 184cb96f7846+ (bug20980)

That's ancient ;) The code has changed quite a bit since then. Having
said that, the bug you encountered may well still exist in the current
version, so we'll take a look.


Matthias.



From matthias at lshift.net  Tue Sep 22 13:04:20 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 22 Sep 2009 13:04:20 +0100
Subject: [rabbitmq-discuss] RabbitMQ native SSL support
In-Reply-To: <2C0E40EC-032B-4F3D-A2C5-937ECDEE1BB2@gmail.com>
References: <2C0E40EC-032B-4F3D-A2C5-937ECDEE1BB2@gmail.com>
Message-ID: <4AB8BD44.8000809@lshift.net>

Chris,

Chris Duncan wrote:
> I had a recent conversation about SSL support in RabbitMQ and would  
> like to clarify my understanding. The current v1.6.0 stable RabbitMQ  
> release does not appear to have native SSL support. Is v1.7.0  
> scheduled to include it

Yes, 1.7.0 will contain native SSL support. The code for it has been
qa'ed, so it is already available on the 'default' branch of the server
sources.


Regards,

Matthias.



From farra at apache.org  Tue Sep 22 15:09:15 2009
From: farra at apache.org (J Aaron Farr)
Date: Tue, 22 Sep 2009 22:09:15 +0800
Subject: [rabbitmq-discuss] Return of 'getting started, broker runs;
	can't  get status'
In-Reply-To: <29598b610909220436o343db79ajf4c90e33479e7ae6@mail.gmail.com>
	(Paul Jones's message of "Tue, 22 Sep 2009 12:36:52 +0100")
References: <m21vlzl7y5.fsf@apache.org>
	<29598b610909220143s7f24bde7q8d3771eaaef9e8f9@mail.gmail.com>
	<m2skefjqyb.fsf@apache.org>
	<29598b610909220259y58b5958ds5eb49e615b94ca1d@mail.gmail.com>
	<m2ocp3jncp.fsf@apache.org>
	<29598b610909220322j15ecc7d8g84b7bb88fde3a814@mail.gmail.com>
	<m21vlznt31.fsf@apache.org> <m2ljk7me13.fsf@apache.org>
	<29598b610909220436o343db79ajf4c90e33479e7ae6@mail.gmail.com>
Message-ID: <m2hbuvm5pw.fsf@apache.org>


You rock.  Details below.

On Tue 22 Sep 2009 19:36, Paul Jones <pauljones23 at gmail.com> wrote:

> We're starting to run low on ideas, but here are a few others that can be
> tried:
>
>    - Change the RABBITMQ_NODENAME in the rabbitmq-server script to
>    rabbit at localhost (or some other predictable host name), and then use the
>    -n flag on rabbitmqctl to force it as well.

replacing ${RABBITMQ_NODENAME} with rabbit at localhost and using
rabbitmqctl -n worked!

Previously it was using rabbit at gandalf, where gandalf was the computer
name.  Pinging gandalf.local still gives me 127.0.0.1, so I'm not sure
why this makes a difference, but apparently it does.

I can at least go from here.

If you want me to further debug this to figure out the root cause, I'm
happy to try anything else for you.

Thanks again!

-- 
   J. Aaron Farr
   ???
   www.cubiclemuses.com



From kyle at raidi.us  Tue Sep 22 15:28:17 2009
From: kyle at raidi.us (Kyle Schaffrick)
Date: Tue, 22 Sep 2009 10:28:17 -0400
Subject: [rabbitmq-discuss] AMQPev client library for Python/Eventlet
Message-ID: <E1Mq6Lr-0008GR-57@victory.heartlandliberty.org>

I've been working on AMQPev, an AMQP client library to use with the
Eventlet networking library for Python. It is available on BitBucket at
[1].

In case you're not familiar with Eventlet [2], it allows writing
non-blocking socket applications using coroutines as an alternative to
directly programming with inversion of control idioms like reactors and
callbacks. There are two examples of what this looks like at [3].

AMQPev is barely complete enough to play with, but is still quite buggy
and may lack some (occasionally obvious) features, such as
authentication. It may also hang or behave strangely when errors occur.
However I'd like to get it out there early and invite people to play
with it. Feedback and improvements are welcome of course!

I realize this isn't RabbitMQ-specific per se, so apologies for being
slightly OT, but I figured this list would be a good place to start,
since I have been solely testing it against RabbitMQ. It may well just
halt and catch fire if you try to use it with another broker :)

 [1] http://bitbucket.org/edarc/amqpev
 [2] http://eventlet.net/
 [2] http://bitbucket.org/edarc/amqpev/wiki/Home

Have fun, and thanks for RabbitMQ!

-Kyle



From alexis.richardson at gmail.com  Tue Sep 22 15:43:15 2009
From: alexis.richardson at gmail.com (Alexis Richardson)
Date: Tue, 22 Sep 2009 15:43:15 +0100
Subject: [rabbitmq-discuss] AMQPev client library for Python/Eventlet
In-Reply-To: <E1Mq6Lr-0008GR-57@victory.heartlandliberty.org>
References: <E1Mq6Lr-0008GR-57@victory.heartlandliberty.org>
Message-ID: <167204d20909220743g399996acq9ffb4dcc3b8cdbdb@mail.gmail.com>

Very cool - thanks Kyle!

alexis


On Tue, Sep 22, 2009 at 3:28 PM, Kyle Schaffrick <kyle at raidi.us> wrote:
> I've been working on AMQPev, an AMQP client library to use with the
> Eventlet networking library for Python. It is available on BitBucket at
> [1].
>
> In case you're not familiar with Eventlet [2], it allows writing
> non-blocking socket applications using coroutines as an alternative to
> directly programming with inversion of control idioms like reactors and
> callbacks. There are two examples of what this looks like at [3].
>
> AMQPev is barely complete enough to play with, but is still quite buggy
> and may lack some (occasionally obvious) features, such as
> authentication. It may also hang or behave strangely when errors occur.
> However I'd like to get it out there early and invite people to play
> with it. Feedback and improvements are welcome of course!
>
> I realize this isn't RabbitMQ-specific per se, so apologies for being
> slightly OT, but I figured this list would be a good place to start,
> since I have been solely testing it against RabbitMQ. It may well just
> halt and catch fire if you try to use it with another broker :)
>
> ?[1] http://bitbucket.org/edarc/amqpev
> ?[2] http://eventlet.net/
> ?[2] http://bitbucket.org/edarc/amqpev/wiki/Home
>
> Have fun, and thanks for RabbitMQ!
>
> -Kyle
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



From celldee at gmail.com  Wed Sep 23 16:32:13 2009
From: celldee at gmail.com (Chris Duncan)
Date: Wed, 23 Sep 2009 16:32:13 +0100
Subject: [rabbitmq-discuss] Problem opening an SSL connection
Message-ID: <92BFC65A-67A1-47F2-97E0-BE072BFABF3E@gmail.com>

Hi,

I'm trying to test the native SSL support in the upcoming RabbitMQ  
v1.7.0 using the Ruby v1.9.1 openssl library and Erlang R12B-5_1.  
I've cloned the default branch of the server code (hg id gives me  
b87b7ed85157) and can start the server successfully according to  
rabbit.log -

=INFO REPORT==== 23-Sep-2009::09:21:25 ===
started TCP Listener on 0.0.0.0:5672

=INFO REPORT==== 23-Sep-2009::09:21:26 ===
started SSL Listener on 0.0.0.0:5671

I wanted to get the simplest case running which is to connect without  
using any certificates. I decided to try to follow the instructions  
in the wiki - https://dev.rabbitmq.com/wiki/SslSupport - and so  
created a rabbit.conf file with similar contents to the example (only  
the paths differ). It contains -

RABBITMQ_SERVER_START_ARGS="-rabbit ssl_listeners [{\"0.0.0.0\", 
5671}] -rabbit ssl_options
[{cacertfile,\"/path/to/testca/cacert.pem\"},{certfile,\"/path/to/ 
server/cert.pem\"},
  {keyfile,\"/path/to/server/key.pem\"},{verify,verify_peer}, 
{fail_if_no_peer_cert,false}]"

When I try to connect I get a 'Connection reset by peer' error and  
these entries in rabbit.log -

=INFO REPORT==== 23-Sep-2009::09:22:24 ===
accepted TCP connection on 0.0.0.0:5671 from 127.0.0.1:51689

=ERROR REPORT==== 23-Sep-2009::09:22:24 ===
failed to upgrade TCP connection from 127.0.0.1:51689 to SSL:
{eoptions,{cacertfile,[]}}

I'm creating an ordinary TCP socket and then using  
OpenSSL::SSL::SSLSocket.new to create the SSL socket like this -

@socket = OpenSSL::SSL::SSLSocket.new(@socket)
@socket.sync_close = true
@socket.connect

The connect call is the one that is failing. This code works when  
connecting via stunnel.

Any help would be greatly appreciated.

Regards,

Chris





From matthew at lshift.net  Wed Sep 23 16:50:12 2009
From: matthew at lshift.net (Matthew Sackman)
Date: Wed, 23 Sep 2009 16:50:12 +0100
Subject: [rabbitmq-discuss] Problem opening an SSL connection
In-Reply-To: <92BFC65A-67A1-47F2-97E0-BE072BFABF3E@gmail.com>
References: <92BFC65A-67A1-47F2-97E0-BE072BFABF3E@gmail.com>
Message-ID: <20090923155012.GA27453@mrnibble.lshift.net>

Hi Chris,

On Wed, Sep 23, 2009 at 04:32:13PM +0100, Chris Duncan wrote:
> I wanted to get the simplest case running which is to connect without  
> using any certificates. I decided to try to follow the instructions  
> in the wiki - https://dev.rabbitmq.com/wiki/SslSupport - and so  
> created a rabbit.conf file with similar contents to the example (only  
> the paths differ).

Please note that the instructions on that wiki page are not entirely
correct and indeed we are going to remove it. The SSL instructions have
been rewritten and will appear on the main website (not on dev.rabbitmq)
when v1.7 gets released.

> It contains -
> 
> RABBITMQ_SERVER_START_ARGS="-rabbit ssl_listeners [{\"0.0.0.0\", 
> 5671}] -rabbit ssl_options
> [{cacertfile,\"/path/to/testca/cacert.pem\"},{certfile,\"/path/to/ 
> server/cert.pem\"},
>   {keyfile,\"/path/to/server/key.pem\"},{verify,verify_peer}, 
> {fail_if_no_peer_cert,false}]"
> 
> When I try to connect I get a 'Connection reset by peer' error and  
> these entries in rabbit.log -
> 
> =INFO REPORT==== 23-Sep-2009::09:22:24 ===
> accepted TCP connection on 0.0.0.0:5671 from 127.0.0.1:51689
> 
> =ERROR REPORT==== 23-Sep-2009::09:22:24 ===
> failed to upgrade TCP connection from 127.0.0.1:51689 to SSL:
> {eoptions,{cacertfile,[]}}

I think that it's not happy with your cacert file. That line in your
rabbit.conf file must be one single line. Also make sure there are no
spaces anywhere between the square brackets.

If you can't make any progress, can you send in your cacert.pem,
cert.pem and key.pem files (obviously, fakes, not the real thing!), and
we'll see if we can make it work.

Matthew



From gmr at myyearbook.com  Wed Sep 23 22:52:45 2009
From: gmr at myyearbook.com (Gavin M. Roy)
Date: Wed, 23 Sep 2009 17:52:45 -0400
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
Message-ID: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com>

I wanted to get some feedback on what I am noticing with Rabbit and memory
use.  In this test case, I loaded up 4 million messages that were roughly 12
bytes or so of data, not counting protocol overhead.  At various stages of
processing I had everything from 0 consumers to 80 consumers running against
RabbitMQ using basic_consume.  The machine that Rabbit is running on is
dedicated to Rabbit and Alice (http://github.com/auser/alice)
Some odd things:


   - In the 6am hour where you see swap spike (red in graph), consumers
   stopped consuming.  I could not find out at the time if it was client or
   Rabbit that stopped dispatching messages.  Restarting consumers resumed the
   previous rates of message consumption.
   - At the time where you see the last major purple graph spike to 10G
   free, we had consumed all of the messages in the broker.  The broker is
   currently sitting idle with no messages, but still has 2+GB of ram
   allocated.

I did notice there seems to be some sort of cleanup worker that runs roughly
every 30 minutes, but it's not reclaimed any of the 2+GB of allocation since
the broker has gone idle. Is this expected behavior? If not, is there any
data I can collect on the issue?  I threw together the following just in
case:

root     29339 20.4 16.7 2905892 2747280 ?     Sl   Sep17 1795:48
/usr/local/lib/erlang/erts-5.7.1/bin/beam.smp -W w -K true -A30 -- -root
/usr/local/lib/erlang -progname erl -- -home /root -pa ./../ebin -noshell
-noinput
root     29383  0.0  0.0   3772   412 ?        Ss   Sep17   0:00  \_
/usr/local/lib/erlang/lib/os_mon-2.2.1/priv/bin/cpu_sup
root     29384  0.0  0.0  10492   452 ?        Ss   Sep17   0:00  \_
inet_gethost 4
root     29385  0.0  0.0  12584   544 ?        S    Sep17   0:00      \_
inet_gethost 4
root     29707  0.2  1.6 411776 274180 ?       Sl   Sep17  23:58
/usr/local/lib/erlang/erts-5.7.1/bin/beam.smp -- -root /usr/local/lib/erlang
-progname erl -- -home /root -pa /opt/alice/ebin -pa
/opt/alice/deps/mochiweb/e
root     29721  0.0  0.0  63868  1092 ?        Ss   Sep17   0:00  \_ sh -s
disksup
root     29722  0.0  0.0   3776   512 ?        Ss   Sep17   0:00  \_
/usr/local/lib/erlang/lib/os_mon-2.2.1/priv/bin/memsup
root     29723  0.0  0.0   3772   408 ?        Ss   Sep17   0:00  \_
/usr/local/lib/erlang/lib/os_mon-2.2.1/priv/bin/cpu_sup
root     29724  0.0  0.0  10492   452 ?        Ss   Sep17   0:00  \_
inet_gethost 4
root     29726  0.0  0.0  16784   708 ?        S    Sep17   0:00      \_
inet_gethost 4

[gmr at mq07 sbin]$ cat /proc/29339/cmdline
/usr/local/lib/erlang/erts-5.7.1/bin/beam.smp-Ww-Ktrue-A30---root/usr/local/lib/erlang-prognameerl---home/root-pa./../ebin-noshell-noinput-srabbit-snamerabbit-bootstart_sasl-kernelinet_default_listen_options[{nodelay,true},{sndbuf,16384},{recbuf,4096}]-kernelinet_default_connect_options[{nodelay,true}]-rabbittcp_listeners[{"0.0.0.0",
5672}]-saslerrlog_typeerror-kernelerror_logger{file,"/var/log/rabbitmq/rabbit.log"}-saslsasl_error_logger{file,"/var/log/rabbitmq/rabbit-sasl.log"}-os_monstart_cpu_suptrue-os_monstart_disksupfalse-os_monstart_memsupfalse-os_monstart_os_supfalse-os_monmemsup_system_onlytrue-os_monsystem_memory_high_watermark0.95-mnesiadir"/var/lib/rabbitmq/mnesia/rabbit"-pa/opt/rabbitmq/ebin-rabbitstomp_listeners[{"0.0.0.0",61613}]extra_startup_steps[{"STOMP-listeners",rabbit_stomp,kickstart,[]}]-noshell-noinpu

[root at mq07 29339]# cat stat
29339 (beam.smp) S 1 29338 29338 0 -1 4202496 22132538291 532 1213 0 4362715
6412157 4 4 25 0 42 0 1106285920 2975633408 686920 18446744073709551615
4194304 5988780 140733909286688 18446744073709551615 206557725890 0 65536
4096 66182 18446744073709551615 0 0 17 4 0 0 0

[root at mq07 29339]# cat statm
726473 686920 393 439 0 721753 0

[root at mq07 sbin]# ./rabbitmqctl status
Status of node rabbit at mq07 ...
[{running_applications,[{rabbit,"RabbitMQ","1.6.0"},
                        {mnesia,"MNESIA  CXC 138 12","4.4.9"},
                        {os_mon,"CPO  CXC 138 46","2.2.1"},
                        {sasl,"SASL  CXC 138 11","2.1.6"},
                        {stdlib,"ERTS  CXC 138 10","1.16.1"},
                        {kernel,"ERTS  CXC 138 10","2.13.1"}]},
 {nodes,[rabbit at mq07]},
 {running_nodes,[rabbit at mq07]}]
...done.
[root at mq07 sbin]# ./rabbitmqctl list_queues
Listing queues ...
Notification 0
...done.
[root at mq07 sbin]# ./rabbitmqctl list_connections
Listing connections ...
guest 10.100.10.85 8820
guest 10.100.10.85 8805
guest 10.100.10.85 8806
guest 10.100.10.85 8821
guest 10.100.10.85 8807
guest 10.100.10.85 8808
guest 10.100.10.85 8822
guest 10.100.10.85 8809
guest 10.100.10.85 8810
guest 10.100.10.85 8824
guest 10.100.10.85 8811
guest 10.100.10.85 8812
guest 10.100.10.85 8813
guest 10.100.10.85 8814
guest 10.100.10.85 8815
guest 10.100.10.85 8816
guest 10.100.10.85 8823
guest 10.100.10.85 8817
guest 10.100.10.85 8818
guest 10.100.10.85 8819
...done.

Regards,

Gavin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090923/0b3cf448/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: graph.png
Type: image/png
Size: 64848 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090923/0b3cf448/attachment.png 

From gmr at myyearbook.com  Wed Sep 23 22:57:14 2009
From: gmr at myyearbook.com (Gavin M. Roy)
Date: Wed, 23 Sep 2009 17:57:14 -0400
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
In-Reply-To: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com>
References: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com>
Message-ID: <af1bce590909231457k6a6c861cu3bb93b557ce0f2ea@mail.gmail.com>

Attached are Alice screenshots.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090923/802dacc8/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screen shot 2009-09-23 at 5.55.08 PM.png
Type: image/png
Size: 41760 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090923/802dacc8/attachment.png 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screen shot 2009-09-23 at 5.56.26 PM.png
Type: image/png
Size: 18437 bytes
Desc: not available
Url : http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090923/802dacc8/attachment-0001.png 

From pradeep.gatram at gmail.com  Thu Sep 24 06:37:24 2009
From: pradeep.gatram at gmail.com (Pradeep Gatram)
Date: Wed, 23 Sep 2009 22:37:24 -0700 (PDT)
Subject: [rabbitmq-discuss] problems with rabbitmq cluster across 2 ubuntu
	9.04 machines
Message-ID: <0b8a31ad-9727-4a8b-81bd-a33392d5b00e@d15g2000prc.googlegroups.com>

I keep getting unable_to_contact_cluster_nodes error

Has anyone seen this earlier and resolved it?

### The machine is pingable (I made an entry in /etc/hosts file)
pgatram at mzl005:~$ ping mz005
PING mz005 (192.168.0.22) 56(84) bytes of data.
64 bytes from mz005 (192.168.0.22): icmp_seq=1 ttl=64 time=0.026 ms
64 bytes from mz005 (192.168.0.22): icmp_seq=2 ttl=64 time=0.023 ms
^C
--- mz005 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 999ms
rtt min/avg/max/mdev = 0.023/0.024/0.026/0.005 ms


### I cant get the cluster to work
pgatram at mzl005:~$ sudo rabbitmqctl cluster rabbit at mz005
Clustering node rabbit at mzl005 with [rabbit at mz005] ...
Error: {unable_to_contact_cluster_nodes,[rabbit at mz005]}



From matthias at lshift.net  Thu Sep 24 09:57:05 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 24 Sep 2009 09:57:05 +0100
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
In-Reply-To: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com>
References: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com>
Message-ID: <4ABB3461.8090706@lshift.net>

Gavin,

Gavin M. Roy wrote:
> I wanted to get some feedback on what I am noticing with Rabbit and
> memory use.  In this test case, I loaded up 4 million messages that were
> roughly 12 bytes or so of data, not counting protocol overhead.  At
> various stages of processing I had everything from 0 consumers to 80
> consumers running against RabbitMQ using basic_consume.  The machine
> that Rabbit is running on is dedicated to Rabbit and Alice
> (http://github.com/auser/alice)
> 
> Some odd things:
> 
>     * In the 6am hour where you see swap spike (red in graph), consumers
>       stopped consuming.  I could not find out at the time if it was
>       client or Rabbit that stopped dispatching messages.  Restarting
>       consumers resumed the previous rates of message consumption.

Next time this happens I suggest you gather some diagnostics with
  rabbitmqctl list_queues name messages_ready messages_unacknowledged
consumers

If the consumer count is 0 then there are no consumers. If you have a
consumer count above 0 and a messages_ready count above 0, and the
broker appears to be idle, then that is a good indication that the
consumers are there but stuck and the tcp connection to them is backlogged.

>     * At the time where you see the last major purple graph spike to 10G
>       free, we had consumed all of the messages in the broker.  The
>       broker is currently sitting idle with no messages, but still has
>       2+GB of ram allocated.
> 
> I did notice there seems to be some sort of cleanup worker that runs
> roughly every 30 minutes, but it's not reclaimed any of the 2+GB of
> allocation since the broker has gone idle. Is this expected behavior?

It is quite common for a gc'ed VM to hold on to large chunks of memory
instead of handing them back to the OS.

Are you monitoring queues with rabbitmqctl or Alice? If that happens
more frequently than once per second then the queue processes are kept
active, which delays the freeing up of memory.

To get some diagnostics on where the memory has gone, shell into rabbit
(erl -sname shell -remsh rabbit@<hostname>) and run
  memory().


Regards,

Matthias.



From gmr at myyearbook.com  Thu Sep 24 14:35:24 2009
From: gmr at myyearbook.com (Gavin M. Roy)
Date: Thu, 24 Sep 2009 09:35:24 -0400
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
In-Reply-To: <4ABB3461.8090706@lshift.net>
References: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com> 
	<4ABB3461.8090706@lshift.net>
Message-ID: <af1bce590909240635lcab7f43g8bfa1279067643c6@mail.gmail.com>

On Thu, Sep 24, 2009 at 4:57 AM, Matthias Radestock <matthias at lshift.net>wrote:

> Gavin,
>
> Next time this happens I suggest you gather some diagnostics with
>  rabbitmqctl list_queues name messages_ready messages_unacknowledged
> consumers
>

I made sure there were no messages in the stack, but since it's still
hanging out with the memory allocated:

[root at mq07 ~]# /opt/rabbitmq/sbin/rabbitmqctl list_queues name
messages_ready messages_unacknowledged
Listing queues ...
Notification 0 0
...done.

If the consumer count is 0 then there are no consumers. If you have a
> consumer count above 0 and a messages_ready count above 0, and the
> broker appears to be idle, then that is a good indication that the
> consumers are there but stuck and the tcp connection to them is backlogged.
>

Yeah I pulled off the consumers when it was done to see if that was why the
memory wasn't given back.

lsof and netstat do not indicate any open sockets (in any state) to Rabbit
from the consumer box.


> It is quite common for a gc'ed VM to hold on to large chunks of memory
> instead of handing them back to the OS.
>

Is it safe to assume the VM will make use of what it's holding on to and
it's not a leak of some sort?


> Are you monitoring queues with rabbitmqctl or Alice? If that happens
> more frequently than once per second then the queue processes are kept
> active, which delays the freeing up of memory.
>

Primarily Alice, and the monitor interval I am using is ~10 seconds.


> To get some diagnostics on where the memory has gone, shell into rabbit
> (erl -sname shell -remsh rabbit@<hostname>) and run
>  memory().
>

[root at mq07 ~]# erl -sname shell -remsh rabbit at mq07
Erlang R13B (erts-5.7.1) [source] [64-bit] [smp:8:8] [rq:8]
[async-threads:0] [hipe] [kernel-poll:false]

Eshell V5.7.1  (abort with ^G)
(rabbit at mq07)1> memory().
[{total,354514080},
 {processes,23750072},
 {processes_used,22779304},
 {system,330764008},
 {atom,775705},
 {atom_used,748674},
 {binary,22063432},
 {code,7638629},
 {ets,5241416}]
(rabbit at mq07)2>

Thanks,

Gavin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090924/b62eff4e/attachment.htm 

From matthias at lshift.net  Thu Sep 24 15:11:37 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Thu, 24 Sep 2009 15:11:37 +0100
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
In-Reply-To: <af1bce590909240635lcab7f43g8bfa1279067643c6@mail.gmail.com>
References: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com>
	<4ABB3461.8090706@lshift.net>
	<af1bce590909240635lcab7f43g8bfa1279067643c6@mail.gmail.com>
Message-ID: <4ABB7E19.3010808@lshift.net>

Gavin,

Gavin M. Roy wrote:
> Is it safe to assume the VM will make use of what it's holding on to and
> it's not a leak of some sort?

I doubt it is a leak, but the VM can hold on to free memory in the
anticipation of future need which may never materialise.

> (rabbit at mq07)1> memory().
> [{total,354514080},

So that's just ~350MB there, which means the rest of the VM process'
memory is technically free but hasn't been returned to the OS, unless
there's a leak in the VM itself.

The docs for erlang:memory/0 mention various caveats regarding the
accuracy of the reported figures, and ways to improve that accuracy,
which is something you may want to look into if you want to investigate
this further.


Regards,

Matthias.



From celldee at gmail.com  Thu Sep 24 17:49:28 2009
From: celldee at gmail.com (Chris Duncan)
Date: Thu, 24 Sep 2009 17:49:28 +0100
Subject: [rabbitmq-discuss] Problem opening an SSL connection
In-Reply-To: <20090923155012.GA27453@mrnibble.lshift.net>
References: <92BFC65A-67A1-47F2-97E0-BE072BFABF3E@gmail.com>
	<20090923155012.GA27453@mrnibble.lshift.net>
Message-ID: <EB356D51-DC3D-4B31-8B77-4FE2F970AC0F@gmail.com>

Hi Matthew,

I've now got this working :)

On 23 Sep 2009, at 16:50, Matthew Sackman wrote:

> Hi Chris,
>
> On Wed, Sep 23, 2009 at 04:32:13PM +0100, Chris Duncan wrote:
>> I wanted to get the simplest case running which is to connect without
>> using any certificates. I decided to try to follow the instructions
>> in the wiki - https://dev.rabbitmq.com/wiki/SslSupport - and so
>> created a rabbit.conf file with similar contents to the example (only
>> the paths differ).
>
> Please note that the instructions on that wiki page are not entirely
> correct and indeed we are going to remove it. The SSL instructions  
> have
> been rewritten and will appear on the main website (not on  
> dev.rabbitmq)
> when v1.7 gets released.
>
>> It contains -
>>
>> RABBITMQ_SERVER_START_ARGS="-rabbit ssl_listeners [{\"0.0.0.0\",
>> 5671}] -rabbit ssl_options
>> [{cacertfile,\"/path/to/testca/cacert.pem\"},{certfile,\"/path/to/
>> server/cert.pem\"},
>>   {keyfile,\"/path/to/server/key.pem\"},{verify,verify_peer},
>> {fail_if_no_peer_cert,false}]"
>>
>> When I try to connect I get a 'Connection reset by peer' error and
>> these entries in rabbit.log -
>>
>> =INFO REPORT==== 23-Sep-2009::09:22:24 ===
>> accepted TCP connection on 0.0.0.0:5671 from 127.0.0.1:51689
>>
>> =ERROR REPORT==== 23-Sep-2009::09:22:24 ===
>> failed to upgrade TCP connection from 127.0.0.1:51689 to SSL:
>> {eoptions,{cacertfile,[]}}
>
> I think that it's not happy with your cacert file. That line in your
> rabbit.conf file must be one single line. Also make sure there are no
> spaces anywhere between the square brackets.
>

Thanks for the pointer. I regenerated a self-signed server  
certificate and key (I think I messed up the CN bit before) then I  
put the following in my rabbit.conf file -

RABBITMQ_SERVER_START_ARGS="-rabbit ssl_listeners [{\"0.0.0.0\", 
5671}] -rabbit ssl_options [{cacertfile,\"/path/to/testca/server.crt 
\"},{certfile,\"/path/to/server/server.crt\"},{keyfile,\"/path/to/ 
server/server.key\"},{verify,verify_none},{fail_if_no_peer_cert,false}]"

I connected using openssl s_client and my Ruby code :)

> If you can't make any progress, can you send in your cacert.pem,
> cert.pem and key.pem files (obviously, fakes, not the real thing!),  
> and
> we'll see if we can make it work.
>
> Matthew
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss




From scott.brooks at epicadvertising.com  Fri Sep 25 17:51:16 2009
From: scott.brooks at epicadvertising.com (Scott Brooks)
Date: Fri, 25 Sep 2009 11:51:16 -0500
Subject: [rabbitmq-discuss] rabbitmq-c
Message-ID: <BB244B56-1BC8-4761-A7CE-FFDBFA6F25F3@epicadvertising.com>

We have been using rabbitmq-c for quite a while internally, and it's  
been working great for us.

I have built a ruby wrapper for rabbitmq-c using ruby-ffi which i  
think we are planning on releasing soon, the only issue is that there  
are some API decisions that make rabbitmq-c hard to use with FFI.

Although passing the amqp_bytes_t as a struct is a really great  
solution to C strings, passing structs by value, and returning structs  
is not supported by libffi/ruby-ffi(as far as I could test anyways).

So I took amqp_api.c, and wrote amqp_api_p.c which accepts pointers to  
structs rather then copy by value.  These functions just create take  
the pointers, copy to local vars and then calls the existing functions.

In general I see a few solutions to the problem of wrapping rabbitmq-c  
for use in higher level languages.
A: don't support it
B: keep a parallel set of pass by pointer functions so either API can  
be used(currently it just copies the data passed to the pointer, and  
then calls the pass by value functions)
C: change the whole API to pass pointers.
D: some other solution

Any thoughts as to which direction you would like to take

Thanks
Scott Brooks




From digitalwarfare at gmail.com  Fri Sep 25 19:46:06 2009
From: digitalwarfare at gmail.com (Suhail Doshi)
Date: Fri, 25 Sep 2009 11:46:06 -0700
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
In-Reply-To: <4ABB7E19.3010808@lshift.net>
References: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com> 
	<4ABB3461.8090706@lshift.net>
	<af1bce590909240635lcab7f43g8bfa1279067643c6@mail.gmail.com> 
	<4ABB7E19.3010808@lshift.net>
Message-ID: <376f3e6f0909251146k19d766cqf8f336e079bc3eef@mail.gmail.com>

Is there a way to place a memory restriction on rabbitmq? I am getting a bit
tired of it locking up all the available memory when there are a significant
amount of items in the queue since it won't write them to disk
Suhail

On Thu, Sep 24, 2009 at 7:11 AM, Matthias Radestock <matthias at lshift.net>wrote:

> Gavin,
>
> Gavin M. Roy wrote:
> > Is it safe to assume the VM will make use of what it's holding on to and
> > it's not a leak of some sort?
>
> I doubt it is a leak, but the VM can hold on to free memory in the
> anticipation of future need which may never materialise.
>
> > (rabbit at mq07)1> memory().
> > [{total,354514080},
>
> So that's just ~350MB there, which means the rest of the VM process'
> memory is technically free but hasn't been returned to the OS, unless
> there's a leak in the VM itself.
>
> The docs for erlang:memory/0 mention various caveats regarding the
> accuracy of the reported figures, and ways to improve that accuracy,
> which is something you may want to look into if you want to investigate
> this further.
>
>
> Regards,
>
> Matthias.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>



-- 
http://mixpanel.com
Blog: http://blog.mixpanel.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090925/c3b4f50f/attachment.htm 

From pkirsanov at 38studios.com  Fri Sep 25 20:00:50 2009
From: pkirsanov at 38studios.com (Philippe Kirsanov)
Date: Fri, 25 Sep 2009 15:00:50 -0400
Subject: [rabbitmq-discuss] Steady performance degradation
Message-ID: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>

I was running some tests against RabbitMQ (1.6 on Linux)

One of the test was to run steady load (about 500 messages per second)
over long period of time.

My client is using Java library.

I noticed that performance steadily going down to 100-200 messages/sec,
resetting client (kill/start process) restores performance.

I don't see any issues with either disk io, memory or CPU - it is all
stays same all the time on client, only client accepts less and less
messages.

I'm using basicConsume with QoS 10 messages.

 

Switching between Linux and Windows don't change anything.

 

Is it known issue?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090925/332b4253/attachment.htm 

From matthias at lshift.net  Fri Sep 25 20:13:09 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 25 Sep 2009 20:13:09 +0100
Subject: [rabbitmq-discuss] problems with rabbitmq cluster across 2
 ubuntu 9.04 machines
In-Reply-To: <0b8a31ad-9727-4a8b-81bd-a33392d5b00e@d15g2000prc.googlegroups.com>
References: <0b8a31ad-9727-4a8b-81bd-a33392d5b00e@d15g2000prc.googlegroups.com>
Message-ID: <4ABD1645.6040208@lshift.net>

Pradeep,

Pradeep Gatram wrote:
> ### I cant get the cluster to work
> pgatram at mzl005:~$ sudo rabbitmqctl cluster rabbit at mz005
> Clustering node rabbit at mzl005 with [rabbit at mz005] ...
> Error: {unable_to_contact_cluster_nodes,[rabbit at mz005]}

Did you ensure that the erlang cookie on both nodes is the same?


Matthias.



From matthias at lshift.net  Fri Sep 25 20:17:26 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 25 Sep 2009 20:17:26 +0100
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
In-Reply-To: <376f3e6f0909251146k19d766cqf8f336e079bc3eef@mail.gmail.com>
References: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com>
	<4ABB3461.8090706@lshift.net>	<af1bce590909240635lcab7f43g8bfa1279067643c6@mail.gmail.com>
	<4ABB7E19.3010808@lshift.net>
	<376f3e6f0909251146k19d766cqf8f336e079bc3eef@mail.gmail.com>
Message-ID: <4ABD1746.2020406@lshift.net>

Suhail,

Suhail Doshi wrote:
> Is there a way to place a memory restriction on rabbitmq? I am getting a 
> bit tired of it locking up all the available memory when there are a 
> significant amount of items in the queue since it won't write them to disk

RabbitMQ stores all messages in memory. Messages that are marked 
'persistent' are stored on disk *as well* as in memory.

That will change when the new persister gets released, at which point 
you should indeed be able to restrict RabbitMQ's memory usage.


Regards,

Matthias.



From matthias at lshift.net  Fri Sep 25 20:20:50 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 25 Sep 2009 20:20:50 +0100
Subject: [rabbitmq-discuss] Steady performance degradation
In-Reply-To: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>
Message-ID: <4ABD1812.2060103@lshift.net>

Philippe,

Philippe Kirsanov wrote:
> One of the test was to run steady load (about 500 messages per second) 
> over long period of time.
> 
> I noticed that performance steadily going down to 100-200 messages/sec, 
> resetting client (kill/start process) restores performance.

can you post your code so we can try to reproduce this?


Regards,

Matthias.



From digitalwarfare at gmail.com  Fri Sep 25 20:41:33 2009
From: digitalwarfare at gmail.com (Suhail Doshi)
Date: Fri, 25 Sep 2009 12:41:33 -0700
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
In-Reply-To: <4ABD1746.2020406@lshift.net>
References: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com> 
	<4ABB3461.8090706@lshift.net>
	<af1bce590909240635lcab7f43g8bfa1279067643c6@mail.gmail.com> 
	<4ABB7E19.3010808@lshift.net>
	<376f3e6f0909251146k19d766cqf8f336e079bc3eef@mail.gmail.com> 
	<4ABD1746.2020406@lshift.net>
Message-ID: <376f3e6f0909251241t3408c30ege92a78faafaac73b@mail.gmail.com>

I know it's being released when it's ready but is that occurring in the next
3 months?
Suhail

On Fri, Sep 25, 2009 at 12:17 PM, Matthias Radestock <matthias at lshift.net>wrote:

> Suhail,
>
> Suhail Doshi wrote:
>
>> Is there a way to place a memory restriction on rabbitmq? I am getting a
>> bit tired of it locking up all the available memory when there are a
>> significant amount of items in the queue since it won't write them to disk
>>
>
> RabbitMQ stores all messages in memory. Messages that are marked
> 'persistent' are stored on disk *as well* as in memory.
>
> That will change when the new persister gets released, at which point you
> should indeed be able to restrict RabbitMQ's memory usage.
>
>
> Regards,
>
> Matthias.
>



-- 
http://mixpanel.com
Blog: http://blog.mixpanel.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090925/fe055088/attachment.htm 

From matthias at lshift.net  Fri Sep 25 22:10:41 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 25 Sep 2009 22:10:41 +0100
Subject: [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
In-Reply-To: <376f3e6f0909251241t3408c30ege92a78faafaac73b@mail.gmail.com>
References: <af1bce590909231452p7615639eo8c3e8c6c55d4e67@mail.gmail.com>
	<4ABB3461.8090706@lshift.net>	<af1bce590909240635lcab7f43g8bfa1279067643c6@mail.gmail.com>
	<4ABB7E19.3010808@lshift.net>	<376f3e6f0909251146k19d766cqf8f336e079bc3eef@mail.gmail.com>
	<4ABD1746.2020406@lshift.net>
	<376f3e6f0909251241t3408c30ege92a78faafaac73b@mail.gmail.com>
Message-ID: <4ABD31D1.7000001@lshift.net>

Suhail,

Suhail Doshi wrote:
> I know it's being released when it's ready but is that occurring in the 
> next 3 months?

That is certainly the plan.


Matthias.



From pkirsanov at 38studios.com  Fri Sep 25 22:29:25 2009
From: pkirsanov at 38studios.com (Philippe Kirsanov)
Date: Fri, 25 Sep 2009 17:29:25 -0400
Subject: [rabbitmq-discuss] Steady performance degradation
In-Reply-To: <4ABD1812.2060103@lshift.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>
	<4ABD1812.2060103@lshift.net>
Message-ID: <D1AC29FC5C9E644C91BE7C9294BF701B026157DA@gmg-maynard-mai.greenmonstergames.net>

The jar includes all dependencies.
I can't send source code, only jar. But this is a code:

Publisher:
messageProperties.messageId	= utils.generateUUIDasBase64 //random
UUID
messageProperties.expiration	= System.currentTimeMillis.toString
channel.basicPublish ( exchName, routingKey, messageProperties , msg )

Consumer:
private val tag = channel.basicConsume ( queueName, noAck,
	new DefaultConsumer ( channel ) {
		override def handleDelivery ( tag : String, env :
Envelope, props : AMQP.BasicProperties, body : Array [ Byte ] ) = {
			if ( brokerConfig.trackMsg ) {
				val now = System.currentTimeMillis
				val than = props.expiration.toLong
				actor {
					statTracker.update ( now - than
)
				}
			}
			cons ! newMessage ( body, env, props )
		}
	}
)

Ack happens in the Actor that handles message before message is
processed
This Actor Ack message and send it for processing to another Actor
react {
	case msg @ newMessage ( m, e, p ) => {
		a ! msg // send message for processing in different
Actor(Thread)
		try {
			channel.basicAck ( e.getDeliveryTag, false )
		}
		catch
		{
			case e : AlreadyClosedException => exit
			case e : java.net.SocketException => exit
		}
		act
	}
}

And this is actual worker that handles message, message should be
already ack by this time:
receive {
	case msg @ newMessage ( m, e, p ) => handler ( m, e, p )
}

I will send jar directly


-----Original Message-----
From: Matthias Radestock [mailto:matthias at lshift.net] 
Sent: Friday, September 25, 2009 15:21
To: Philippe Kirsanov
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Steady performance degradation

Philippe,

Philippe Kirsanov wrote:
> One of the test was to run steady load (about 500 messages per second)

> over long period of time.
> 
> I noticed that performance steadily going down to 100-200
messages/sec, 
> resetting client (kill/start process) restores performance.

can you post your code so we can try to reproduce this?


Regards,

Matthias.



From matthias at lshift.net  Fri Sep 25 22:41:34 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Fri, 25 Sep 2009 22:41:34 +0100
Subject: [rabbitmq-discuss] Steady performance degradation
In-Reply-To: <D1AC29FC5C9E644C91BE7C9294BF701B026157DA@gmg-maynard-mai.greenmonstergames.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>	<4ABD1812.2060103@lshift.net>
	<D1AC29FC5C9E644C91BE7C9294BF701B026157DA@gmg-maynard-mai.greenmonstergames.net>
Message-ID: <4ABD390E.2080406@lshift.net>

Philippe,

Philippe Kirsanov wrote:
> The jar includes all dependencies.
> I can't send source code, only jar. But this is a code:

The code looks fine. And there is no slowdown when running code very 
similar to this, e.g. try the MulticastMain example that ships with the 
Java client and set the rate with "-r 500".

So I strongly suspect the problem is somewhere in the client code, which 
is going to be difficult for us to track down if a) we can't see it, or 
b) it's tangled up in a bigger code base with non-obvious control flow.


Regards,

Matthias.



From pkirsanov at 38studios.com  Fri Sep 25 22:52:23 2009
From: pkirsanov at 38studios.com (Philippe Kirsanov)
Date: Fri, 25 Sep 2009 17:52:23 -0400
Subject: [rabbitmq-discuss] Steady performance degradation
In-Reply-To: <4ABD390E.2080406@lshift.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>	<4ABD1812.2060103@lshift.net>
	<D1AC29FC5C9E644C91BE7C9294BF701B026157DA@gmg-maynard-mai.greenmonstergames.net>
	<4ABD390E.2080406@lshift.net>
Message-ID: <D1AC29FC5C9E644C91BE7C9294BF701B026157ED@gmg-maynard-mai.greenmonstergames.net>

I'm quite sure it is client code, but I was thinking it is Java lib. My
code don't do anything right now - just receives a message and
calculates statistics (2 variable, no arrays).
If you're sure it's not Java lib I'll keep looking. Strange thing is
that no recourse exhaustion of any kind, just fewer packets arrived to
client. My measure is between basicPublish and handleDelivery, with no
my code involvement at all.
Thanks for your help.


-----Original Message-----
From: Matthias Radestock [mailto:matthias at lshift.net] 
Sent: Friday, September 25, 2009 17:42
To: Philippe Kirsanov
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Steady performance degradation

Philippe,

Philippe Kirsanov wrote:
> The jar includes all dependencies.
> I can't send source code, only jar. But this is a code:

The code looks fine. And there is no slowdown when running code very 
similar to this, e.g. try the MulticastMain example that ships with the 
Java client and set the rate with "-r 500".

So I strongly suspect the problem is somewhere in the client code, which

is going to be difficult for us to track down if a) we can't see it, or 
b) it's tangled up in a bigger code base with non-obvious control flow.


Regards,

Matthias.



From pkirsanov at 38studios.com  Fri Sep 25 23:07:10 2009
From: pkirsanov at 38studios.com (Philippe Kirsanov)
Date: Fri, 25 Sep 2009 18:07:10 -0400
Subject: [rabbitmq-discuss] Steady performance degradation
In-Reply-To: <4ABD1812.2060103@lshift.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>
	<4ABD1812.2060103@lshift.net>
Message-ID: <D1AC29FC5C9E644C91BE7C9294BF701B02615805@gmg-maynard-mai.greenmonstergames.net>

I noticed that in example you create connection for every
consumer/producer.
I'm using just one connection and different channels for every consumer.
I read somewhere that it's best practice to have one connection/multiple
channels per server. Is this true or it's better to have separate
connection for every channel? This might result in lots of connection to
broker.

-----Original Message-----
From: Matthias Radestock [mailto:matthias at lshift.net] 
Sent: Friday, September 25, 2009 15:21
To: Philippe Kirsanov
Cc: rabbitmq-discuss at lists.rabbitmq.com
Subject: Re: [rabbitmq-discuss] Steady performance degradation

Philippe,

Philippe Kirsanov wrote:
> One of the test was to run steady load (about 500 messages per second)

> over long period of time.
> 
> I noticed that performance steadily going down to 100-200
messages/sec, 
> resetting client (kill/start process) restores performance.

can you post your code so we can try to reproduce this?


Regards,

Matthias.



From matthias at lshift.net  Sat Sep 26 05:07:10 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Sat, 26 Sep 2009 05:07:10 +0100
Subject: [rabbitmq-discuss] Steady performance degradation
In-Reply-To: <D1AC29FC5C9E644C91BE7C9294BF701B026157ED@gmg-maynard-mai.greenmonstergames.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>	<4ABD1812.2060103@lshift.net>	<D1AC29FC5C9E644C91BE7C9294BF701B026157DA@gmg-maynard-mai.greenmonstergames.net>	<4ABD390E.2080406@lshift.net>
	<D1AC29FC5C9E644C91BE7C9294BF701B026157ED@gmg-maynard-mai.greenmonstergames.net>
Message-ID: <4ABD936E.2050802@lshift.net>

Philippe,

Philippe Kirsanov wrote:
> I'm quite sure it is client code, but I was thinking it is Java lib. My
> code don't do anything right now - just receives a message and
> calculates statistics (2 variable, no arrays).
> If you're sure it's not Java lib I'll keep looking.

I can't be sure of anything, given that I haven't seen the complete 
code. But the order of suspects is: the application code, the 
system/network setup, the Java client lib, the server.

> I noticed that in example you create connection for every
> consumer/producer.
> I'm using just one connection and different channels for every consumer.
> I read somewhere that it's best practice to have one connection/multiple
> channels per server. Is this true or it's better to have separate
> connection for every channel? This might result in lots of connection to
> broker.

If client or server resource consumption is a concern, then few 
connections & lots of channels per connection is preferable to lots of 
connections & few channels per connection  If, OTOH, resources are 
plentiful and you want to maximise performance then the decision is 
reversed.


Regards,

Matthias.



From matthias at lshift.net  Sat Sep 26 05:26:29 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Sat, 26 Sep 2009 05:26:29 +0100
Subject: [rabbitmq-discuss] Steady performance degradation
In-Reply-To: <4ABD936E.2050802@lshift.net>
References: <D1AC29FC5C9E644C91BE7C9294BF701B02615713@gmg-maynard-mai.greenmonstergames.net>	<4ABD1812.2060103@lshift.net>	<D1AC29FC5C9E644C91BE7C9294BF701B026157DA@gmg-maynard-mai.greenmonstergames.net>	<4ABD390E.2080406@lshift.net>	<D1AC29FC5C9E644C91BE7C9294BF701B026157ED@gmg-maynard-mai.greenmonstergames.net>
	<4ABD936E.2050802@lshift.net>
Message-ID: <4ABD97F5.7020402@lshift.net>

Philippe,

Matthias Radestock wrote:
> I can't be sure of anything, given that I haven't seen the complete 
> code. But the order of suspects is: the application code, the 
> system/network setup, the Java client lib, the server.

Also, the following would be on my list of things to check:

1) Is the test exhausting some server resources, in particular CPU or 
network bandwidth?

2) Is the measurement code correct?

3) You mentioned the use of a basic.qos prefetch limit - do you get the 
same results w/o that?

4) Are messages marked as persistent? If so, do you get the same results 
w/o that?

5) Are you using tx at all? If so, do you get the same results w/o that?

I would also recommend that you simplify your test code as much as 
possible. If you can condense it to something along the lines of the 
shipped examples then a) you can send it to us, and b) it will be much 
easier to track down where the problem may be.


Regards,

Matthias.



From pradeep.gatram at gmail.com  Sun Sep 27 07:53:28 2009
From: pradeep.gatram at gmail.com (Pradeep Gatram)
Date: Sat, 26 Sep 2009 23:53:28 -0700 (PDT)
Subject: [rabbitmq-discuss] problems with rabbitmq cluster across 2
	ubuntu 9.04 machines
In-Reply-To: <4ABD1645.6040208@lshift.net>
References: <0b8a31ad-9727-4a8b-81bd-a33392d5b00e@d15g2000prc.googlegroups.com>
	<4ABD1645.6040208@lshift.net>
Message-ID: <a7b27e2d-3a59-406f-aa84-4da1f5b1c788@z4g2000prh.googlegroups.com>

yes, i did that. infact, i have 1 winxp and 1 vista machines as well.
I have same cookie throughout. i am able to create cluster with both
the windows machines but not with the other ubuntu machine. cluster
creation succeeds if both the ubuntu machines enter into a cluster
with a windows machine. this lead me to think that there might be
something with some ubuntu security policy (ufw or something,
disabling ufw did not help though). any ideas will be most helpful.

Pradeep

On Sep 26, 12:13?am, Matthias Radestock <matth... at lshift.net> wrote:
> Pradeep,
>
> Pradeep Gatram wrote:
> > ### I cant get the cluster to work
> > pgatram at mzl005:~$ sudo rabbitmqctl cluster rabbit at mz005
> > Clustering node rabbit at mzl005 with [rabbit at mz005] ...
> > Error: {unable_to_contact_cluster_nodes,[rabbit at mz005]}
>
> Did you ensure that the erlang cookie on both nodes is the same?
>
> Matthias.
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-disc... at lists.rabbitmq.comhttp://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss



From matthias at lshift.net  Sun Sep 27 10:34:19 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Sun, 27 Sep 2009 10:34:19 +0100
Subject: [rabbitmq-discuss] problems with rabbitmq cluster across
 2	ubuntu 9.04 machines
In-Reply-To: <a7b27e2d-3a59-406f-aa84-4da1f5b1c788@z4g2000prh.googlegroups.com>
References: <0b8a31ad-9727-4a8b-81bd-a33392d5b00e@d15g2000prc.googlegroups.com>	<4ABD1645.6040208@lshift.net>
	<a7b27e2d-3a59-406f-aa84-4da1f5b1c788@z4g2000prh.googlegroups.com>
Message-ID: <4ABF319B.6030804@lshift.net>

Pradeep,

Pradeep Gatram wrote:
> yes, i did that. infact, i have 1 winxp and 1 vista machines as well.
> I have same cookie throughout. i am able to create cluster with both
> the windows machines but not with the other ubuntu machine. cluster
> creation succeeds if both the ubuntu machines enter into a cluster
> with a windows machine. this lead me to think that there might be
> something with some ubuntu security policy (ufw or something,
> disabling ufw did not help though). any ideas will be most helpful.

For two Erlang nodes to be able to communicate they

- must have the same cookie (which, you say they do)

- must be able to resolve the other node's hostname to an IP

- must be able to connect to the Erlang port mapper daemon (epmd) on 
that IP - it listens on port 4369 by default

- must be able to connect to the other node's distribution port. That 
port is chosen dynamically (though you can "pin" it with -kernel 
inet_dist_listen_min 4000 inet_dist_listen_max 4000) and returned by epmd.

As a first step in tracking down the problem I suggest you start some 
test Erlang nodes on all your machines with
   erl -sname mytest -setcookie mycookie
and then evaluate
   net_adm:ping(mytest@<machine1>).
   net_adm:ping(mytest@<machine2>).
   ...
in each of the nodes, attempting to connect to the nodes on all other 
machines.

The result of that will tell you which nodes have problems talking to 
each other, and then you can use the above information about epmd etc to 
investigate that further.


Regards,

Matthias.



From tsuraan at gmail.com  Mon Sep 28 22:50:34 2009
From: tsuraan at gmail.com (tsuraan)
Date: Mon, 28 Sep 2009 16:50:34 -0500
Subject: [rabbitmq-discuss] File changes from 1.6.0 to 1.7.0
Message-ID: <84fb38e30909281450y573ae17q191e7a6386839735@mail.gmail.com>

Will the RabbitMQ 1.7.0 disk layout (persister.log, mnesia schema,
etc) be compatible with 1.6.0, or will it clear out the old schema
like the pre-1.5 to 1.5 upgrade did?  If the 1.7.0 layout isn't
compatible, is there a guide for migrating from 1.6 to 1.7?  A search
on rabbitmq upgrade just brought up the 1.5.4 announcement that said
to contact support at rabbitmq if help was needed.



From pradeep.gatram at gmail.com  Tue Sep 29 07:00:30 2009
From: pradeep.gatram at gmail.com (Pradeep Gatram)
Date: Tue, 29 Sep 2009 11:30:30 +0530
Subject: [rabbitmq-discuss] problems with rabbitmq cluster across 2
	ubuntu 9.04 machines
In-Reply-To: <4ABF319B.6030804@lshift.net>
References: <0b8a31ad-9727-4a8b-81bd-a33392d5b00e@d15g2000prc.googlegroups.com>
	<4ABD1645.6040208@lshift.net>
	<a7b27e2d-3a59-406f-aa84-4da1f5b1c788@z4g2000prh.googlegroups.com>
	<4ABF319B.6030804@lshift.net>
Message-ID: <9a2d8f780909282300j67cab61es9f36f3ecf8cfdc81@mail.gmail.com>

Hi Matthias,

Thanks for the suggestions, I plan to try these today and update the group
about the results.

Pradeep

On Sun, Sep 27, 2009 at 3:04 PM, Matthias Radestock <matthias at lshift.net>wrote:

> Pradeep,
>
> Pradeep Gatram wrote:
>
>> yes, i did that. infact, i have 1 winxp and 1 vista machines as well.
>> I have same cookie throughout. i am able to create cluster with both
>> the windows machines but not with the other ubuntu machine. cluster
>> creation succeeds if both the ubuntu machines enter into a cluster
>> with a windows machine. this lead me to think that there might be
>> something with some ubuntu security policy (ufw or something,
>> disabling ufw did not help though). any ideas will be most helpful.
>>
>
> For two Erlang nodes to be able to communicate they
>
> - must have the same cookie (which, you say they do)
>
> - must be able to resolve the other node's hostname to an IP
>
> - must be able to connect to the Erlang port mapper daemon (epmd) on that
> IP - it listens on port 4369 by default
>
> - must be able to connect to the other node's distribution port. That port
> is chosen dynamically (though you can "pin" it with -kernel
> inet_dist_listen_min 4000 inet_dist_listen_max 4000) and returned by epmd.
>
> As a first step in tracking down the problem I suggest you start some test
> Erlang nodes on all your machines with
>  erl -sname mytest -setcookie mycookie
> and then evaluate
>  net_adm:ping(mytest@<machine1>).
>  net_adm:ping(mytest@<machine2>).
>  ...
> in each of the nodes, attempting to connect to the nodes on all other
> machines.
>
> The result of that will tell you which nodes have problems talking to each
> other, and then you can use the above information about epmd etc to
> investigate that further.
>
>
> Regards,
>
> Matthias.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090929/f81e72db/attachment.htm 

From adityagupta.iiitm at GMAIL.COM  Tue Sep 29 08:35:12 2009
From: adityagupta.iiitm at GMAIL.COM (Katrina)
Date: Tue, 29 Sep 2009 00:35:12 -0700 (PDT)
Subject: [rabbitmq-discuss]  Channel.isopen returns false and {timeout,
 running} exception
Message-ID: <25531373.post@talk.nabble.com>


Hi,

I am using RabbitMQ java client with default heart beat  (Server is running
on linux machine). I am having two issues which i am unable to figure out. 

(1) Sometimes when i try to open a new channel then channel.isopen returns
false although connections is still  alive.

(2) Sometimes i got error like:
=ERROR REPORT==== 23-Sep-2009::05:18:22 ===
exception on TCP connection <0.22590.2> from 10.10.99.21:58705
{timeout,running}
can any body tell what could be the possible cause of this?
 
-- 
View this message in context: http://www.nabble.com/Channel.isopen-returns-false-and-%7Btimeout%2Crunning%7D-exception-tp25531373p25531373.html
Sent from the RabbitMQ mailing list archive at Nabble.com.




From pauljones23 at gmail.com  Tue Sep 29 08:54:45 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 29 Sep 2009 08:54:45 +0100
Subject: [rabbitmq-discuss] Channel.isopen returns false and {timeout,
	running} exception
In-Reply-To: <25531373.post@talk.nabble.com>
References: <25531373.post@talk.nabble.com>
Message-ID: <29598b610909290054j184c12acx3416be5838ad3475@mail.gmail.com>

Hi Katrina,

Are you able to reproduce this problem with a simple application? If you
could provide simple code that reproduces the problem, it may make the issue
easier to diagnose.

In the meantime, if you're finding that channels are closed when you don't
expect them to be, you should also be able to call getCloseReason to query
for information about why the channel is marked as closed.

Paul.

On Tue, Sep 29, 2009 at 8:35 AM, Katrina <adityagupta.iiitm at gmail.com>wrote:

>
> Hi,
>
> I am using RabbitMQ java client with default heart beat  (Server is running
> on linux machine). I am having two issues which i am unable to figure out.
>
> (1) Sometimes when i try to open a new channel then channel.isopen returns
> false although connections is still  alive.
>
> (2) Sometimes i got error like:
> =ERROR REPORT==== 23-Sep-2009::05:18:22 ===
> exception on TCP connection <0.22590.2> from 10.10.99.21:58705
> {timeout,running}
> can any body tell what could be the possible cause of this?
>
> --
> View this message in context:
> http://www.nabble.com/Channel.isopen-returns-false-and-%7Btimeout%2Crunning%7D-exception-tp25531373p25531373.html
> Sent from the RabbitMQ mailing list archive at Nabble.com.
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090929/ad3b7808/attachment.htm 

From traceye at pmamediagroup.com  Tue Sep 29 15:16:23 2009
From: traceye at pmamediagroup.com (teubanks)
Date: Tue, 29 Sep 2009 08:16:23 -0600
Subject: [rabbitmq-discuss] Rabbitmq pid files
Message-ID: <49661E84-FB14-4FB1-888A-4530EF36868F@pmamediagroup.com>

I'm using rabbitmq v1.6.0 trying to set it up with monit. I need to  
know where it stores its pid file (assuming it does create/store one).  
Does anyone know? I checked /var/run and /var/log/rabbitmq

Thanks guys



From matthew at lshift.net  Tue Sep 29 15:22:50 2009
From: matthew at lshift.net (Matthew Sackman)
Date: Tue, 29 Sep 2009 15:22:50 +0100
Subject: [rabbitmq-discuss] File changes from 1.6.0 to 1.7.0
In-Reply-To: <84fb38e30909281450y573ae17q191e7a6386839735@mail.gmail.com>
References: <84fb38e30909281450y573ae17q191e7a6386839735@mail.gmail.com>
Message-ID: <20090929142249.GA17364@wellquite.org>

Hi,

1.7 will have a different mnesia schema and a totally different
persister layout. Whilst we have considered being able to migrate the
persister contents, migrating between mnesia schemas is far more
painful. It's likely that we'll recommend using a client that connects
to both versions of Rabbit, and copies messages from the old to the
new.

Matthew



From matthew at lshift.net  Tue Sep 29 15:34:48 2009
From: matthew at lshift.net (Matthew Sackman)
Date: Tue, 29 Sep 2009 15:34:48 +0100
Subject: [rabbitmq-discuss] File changes from 1.6.0 to 1.7.0
In-Reply-To: <20090929142249.GA17364@wellquite.org>
References: <84fb38e30909281450y573ae17q191e7a6386839735@mail.gmail.com>
	<20090929142249.GA17364@wellquite.org>
Message-ID: <20090929143448.GB17364@wellquite.org>

On Tue, Sep 29, 2009 at 03:22:50PM +0100, Matthew Sackman wrote:
> 1.7 will have a different mnesia schema and a totally different
> persister layout. Whilst we have considered being able to migrate the
> persister contents, migrating between mnesia schemas is far more
> painful. It's likely that we'll recommend using a client that connects
> to both versions of Rabbit, and copies messages from the old to the
> new.

Ahh, Matthias has just reminded me that 1.7 is being released before
the new persister, and so will be able to use the persister.log file
from 1.6 installations. So far, there have been no reasons to change
the mnesia schema either so unless that changes between now and 1.7
being released, then you should be able to upgrade seemlessly.

My comments above really refer to when the new persister gets released.

Sorry for creating confusion.

Matthew



From tsuraan at gmail.com  Tue Sep 29 15:47:55 2009
From: tsuraan at gmail.com (tsuraan)
Date: Tue, 29 Sep 2009 09:47:55 -0500
Subject: [rabbitmq-discuss] File changes from 1.6.0 to 1.7.0
In-Reply-To: <20090929143448.GB17364@wellquite.org>
References: <84fb38e30909281450y573ae17q191e7a6386839735@mail.gmail.com>
	<20090929142249.GA17364@wellquite.org>
	<20090929143448.GB17364@wellquite.org>
Message-ID: <84fb38e30909290747g522cc683sae37b5061c04dd56@mail.gmail.com>

> Ahh, Matthias has just reminded me that 1.7 is being released before
> the new persister, and so will be able to use the persister.log file
> from 1.6 installations. So far, there have been no reasons to change
> the mnesia schema either so unless that changes between now and 1.7
> being released, then you should be able to upgrade seemlessly.
>
> My comments above really refer to when the new persister gets released.

I guess that still answers my question well enough; I was assuming the
new persister was part of 1.7, so whenever the new persister comes
out, I'll have to do that.  Why was it pushed back?  I thought it had
passed QA a few months ago.



From majek04 at gmail.com  Tue Sep 29 16:31:04 2009
From: majek04 at gmail.com (majek04)
Date: Tue, 29 Sep 2009 16:31:04 +0100
Subject: [rabbitmq-discuss] Rabbitmq pid files
In-Reply-To: <49661E84-FB14-4FB1-888A-4530EF36868F@pmamediagroup.com>
References: <49661E84-FB14-4FB1-888A-4530EF36868F@pmamediagroup.com>
Message-ID: <3bb0d9710909290831n1e658809jfa46c59f0d6f5079@mail.gmail.com>

On Tue, Sep 29, 2009 at 15:16, teubanks <traceye at pmamediagroup.com> wrote:
> I'm using rabbitmq v1.6.0 trying to set it up with monit. I need to
> know where it stores its pid file

Try: /var/lib/rabbitmq/pids



From matthew at lshift.net  Tue Sep 29 16:38:23 2009
From: matthew at lshift.net (Matthew Sackman)
Date: Tue, 29 Sep 2009 16:38:23 +0100
Subject: [rabbitmq-discuss] File changes from 1.6.0 to 1.7.0
In-Reply-To: <84fb38e30909290747g522cc683sae37b5061c04dd56@mail.gmail.com>
References: <84fb38e30909281450y573ae17q191e7a6386839735@mail.gmail.com>
	<20090929142249.GA17364@wellquite.org>
	<20090929143448.GB17364@wellquite.org>
	<84fb38e30909290747g522cc683sae37b5061c04dd56@mail.gmail.com>
Message-ID: <20090929153823.GC17364@wellquite.org>

On Tue, Sep 29, 2009 at 09:47:55AM -0500, tsuraan wrote:
> I guess that still answers my question well enough; I was assuming the
> new persister was part of 1.7, so whenever the new persister comes
> out, I'll have to do that.  Why was it pushed back?  I thought it had
> passed QA a few months ago.

During the process of going through QA, we realised that mnesia is too
flawed for us to use it as part of the persister. We were never going
to store messages directly in mnesia, merely accountancy information.
However, when operating in "disc_copies", mnesia keeps the entire table
in RAM, and periodically writes the table out to disk. Unfortunately,
it just writes the entire table out to disk, which means that for a
large table with 99% static entries, but 1% rapidly changing entries,
it will rewrite vast amounts of data unnecessarily, whenever it decides
to write out the table. The other problem is that when running in
"disc_only_copies", the entire table is disk only, using dets. Dets has
an upper limit of 2GB of data, and performs very very badly - I've
never seen it push a disk past about 10MB/s. These problems together
have meant that in order to achieve the goals of zero per message RAM
cost, and a sensible bound on the number of times data is rewritten, we
have decided to move away from using mnesia for the persister.

Unfortunately, these issues were only realised fairly late in the day,
hence the delay whilst we do some redesigning and recoding.

Matthew



From adityagupta.iiitm at GMAIL.COM  Tue Sep 29 18:10:06 2009
From: adityagupta.iiitm at GMAIL.COM (Katrina)
Date: Tue, 29 Sep 2009 10:10:06 -0700 (PDT)
Subject: [rabbitmq-discuss] Channel.isopen returns false and {timeout,
 running} exception
In-Reply-To: <29598b610909290054j184c12acx3416be5838ad3475@mail.gmail.com>
References: <25531373.post@talk.nabble.com>
	<29598b610909290054j184c12acx3416be5838ad3475@mail.gmail.com>
Message-ID: <25667088.post@talk.nabble.com>


Hi Paul, 

Yes the problem ({timeout,running}) is repeating again and again .. and
there is one mysterious finding .. dat  it is repeating around same time (in
my case it is 01:00:52-56PST) 

=ERROR REPORT==== 26-Sep-2009::01:00:56 ===
exception on TCP connection <0.17542.7> from 10.10.50.68:59706
{timeout,running}

=ERROR REPORT==== 27-Sep-2009::01:00:52 ===
exception on TCP connection <0.7164.10> from 10.10.50.68:50018
{timeout,running}

=ERROR REPORT==== 28-Sep-2009::01:00:52 ===
exception on TCP connection <0.28520.12> from 10.10.50.68:46859
{timeout,running}

=ERROR REPORT==== 29-Sep-2009::01:00:54 ===
exception on TCP connection <0.17111.15> from 10.10.50.68:60536
{timeout,running}

can u tell me wat r the possible causes/reasons for this condition to
arise???

thanks !! 



Paul Jones-6 wrote:
> 
> Hi Katrina,
> 
> Are you able to reproduce this problem with a simple application? If you
> could provide simple code that reproduces the problem, it may make the
> issue
> easier to diagnose.
> 
> In the meantime, if you're finding that channels are closed when you don't
> expect them to be, you should also be able to call getCloseReason to query
> for information about why the channel is marked as closed.
> 
> Paul.
> 
> On Tue, Sep 29, 2009 at 8:35 AM, Katrina
> <adityagupta.iiitm at gmail.com>wrote:
> 
>>
>> Hi,
>>
>> I am using RabbitMQ java client with default heart beat  (Server is
>> running
>> on linux machine). I am having two issues which i am unable to figure
>> out.
>>
>> (1) Sometimes when i try to open a new channel then channel.isopen
>> returns
>> false although connections is still  alive.
>>
>> (2) Sometimes i got error like:
>> =ERROR REPORT==== 23-Sep-2009::05:18:22 ===
>> exception on TCP connection <0.22590.2> from 10.10.99.21:58705
>> {timeout,running}
>> can any body tell what could be the possible cause of this?
>>
>> --
>> View this message in context:
>> http://www.nabble.com/Channel.isopen-returns-false-and-%7Btimeout%2Crunning%7D-exception-tp25531373p25531373.html
>> Sent from the RabbitMQ mailing list archive at Nabble.com.
>>
>>
>> _______________________________________________
>> rabbitmq-discuss mailing list
>> rabbitmq-discuss at lists.rabbitmq.com
>> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>>
> 
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> 
> 

-- 
View this message in context: http://www.nabble.com/Channel.isopen-returns-false-and-%7Btimeout%2Crunning%7D-exception-tp25531373p25667088.html
Sent from the RabbitMQ mailing list archive at Nabble.com.




From tsuraan at gmail.com  Tue Sep 29 18:34:35 2009
From: tsuraan at gmail.com (tsuraan)
Date: Tue, 29 Sep 2009 12:34:35 -0500
Subject: [rabbitmq-discuss] File changes from 1.6.0 to 1.7.0
In-Reply-To: <20090929153823.GC17364@wellquite.org>
References: <84fb38e30909281450y573ae17q191e7a6386839735@mail.gmail.com>
	<20090929142249.GA17364@wellquite.org>
	<20090929143448.GB17364@wellquite.org>
	<84fb38e30909290747g522cc683sae37b5061c04dd56@mail.gmail.com>
	<20090929153823.GC17364@wellquite.org>
Message-ID: <84fb38e30909291034s49f6d602ude0f01603f15df4c@mail.gmail.com>

> During the process of going through QA, we realised that mnesia is too
> flawed for us to use it as part of the persister. We were never going
> to store messages directly in mnesia, merely accountancy information.
> However, when operating in "disc_copies", mnesia keeps the entire table
> in RAM, and periodically writes the table out to disk. Unfortunately,
> it just writes the entire table out to disk, which means that for a
> large table with 99% static entries, but 1% rapidly changing entries,
> it will rewrite vast amounts of data unnecessarily, whenever it decides
> to write out the table. The other problem is that when running in
> "disc_only_copies", the entire table is disk only, using dets. Dets has
> an upper limit of 2GB of data, and performs very very badly - I've
> never seen it push a disk past about 10MB/s. These problems together
> have meant that in order to achieve the goals of zero per message RAM
> cost, and a sensible bound on the number of times data is rewritten, we
> have decided to move away from using mnesia for the persister.

I'm not sure if you saw the Dukes of Erl mnesiaex project
(http://code.google.com/p/mnesiaex).  I'm guessing you're well on your
way with a different strategy, but I've found tokyo to be really high
performance, and I'd be curious to hear how mnesia with a tokyo
backend works in a real project like rabbit.

> Unfortunately, these issues were only realised fairly late in the day,
> hence the delay whilst we do some redesigning and recoding.

That's always depressing.  Good luck getting this thing working; I'm
sure looking forward to it :)



From pauljones23 at gmail.com  Tue Sep 29 18:52:36 2009
From: pauljones23 at gmail.com (Paul Jones)
Date: Tue, 29 Sep 2009 18:52:36 +0100
Subject: [rabbitmq-discuss] Channel.isopen returns false and {timeout,
	running} exception
In-Reply-To: <25667088.post@talk.nabble.com>
References: <25531373.post@talk.nabble.com>
	<29598b610909290054j184c12acx3416be5838ad3475@mail.gmail.com>
	<25667088.post@talk.nabble.com>
Message-ID: <29598b610909291052x9ce9a07md33895c13524c390@mail.gmail.com>

Would you have any kind of networking event that happens at this time? For
example, would it be possible that your network link gets reset?

Maybe you could try leaving an SSH connection open to the server over that
time period, and see if it too ends up broken?

On Tue, Sep 29, 2009 at 6:10 PM, Katrina <adityagupta.iiitm at gmail.com>wrote:

>
> Hi Paul,
>
> Yes the problem ({timeout,running}) is repeating again and again .. and
> there is one mysterious finding .. dat  it is repeating around same time
> (in
> my case it is 01:00:52-56PST)
>
> =ERROR REPORT==== 26-Sep-2009::01:00:56 ===
> exception on TCP connection <0.17542.7> from 10.10.50.68:59706
> {timeout,running}
>
> =ERROR REPORT==== 27-Sep-2009::01:00:52 ===
> exception on TCP connection <0.7164.10> from 10.10.50.68:50018
> {timeout,running}
>
> =ERROR REPORT==== 28-Sep-2009::01:00:52 ===
> exception on TCP connection <0.28520.12> from 10.10.50.68:46859
> {timeout,running}
>
> =ERROR REPORT==== 29-Sep-2009::01:00:54 ===
> exception on TCP connection <0.17111.15> from 10.10.50.68:60536
> {timeout,running}
>
> can u tell me wat r the possible causes/reasons for this condition to
> arise???
>
> thanks !!
>
>
>
> Paul Jones-6 wrote:
> >
> > Hi Katrina,
> >
> > Are you able to reproduce this problem with a simple application? If you
> > could provide simple code that reproduces the problem, it may make the
> > issue
> > easier to diagnose.
> >
> > In the meantime, if you're finding that channels are closed when you
> don't
> > expect them to be, you should also be able to call getCloseReason to
> query
> > for information about why the channel is marked as closed.
> >
> > Paul.
> >
> > On Tue, Sep 29, 2009 at 8:35 AM, Katrina
> > <adityagupta.iiitm at gmail.com>wrote:
> >
> >>
> >> Hi,
> >>
> >> I am using RabbitMQ java client with default heart beat  (Server is
> >> running
> >> on linux machine). I am having two issues which i am unable to figure
> >> out.
> >>
> >> (1) Sometimes when i try to open a new channel then channel.isopen
> >> returns
> >> false although connections is still  alive.
> >>
> >> (2) Sometimes i got error like:
> >> =ERROR REPORT==== 23-Sep-2009::05:18:22 ===
> >> exception on TCP connection <0.22590.2> from 10.10.99.21:58705
> >> {timeout,running}
> >> can any body tell what could be the possible cause of this?
> >>
> >> --
> >> View this message in context:
> >>
> http://www.nabble.com/Channel.isopen-returns-false-and-%7Btimeout%2Crunning%7D-exception-tp25531373p25531373.html
> >> Sent from the RabbitMQ mailing list archive at Nabble.com.
> >>
> >>
> >> _______________________________________________
> >> rabbitmq-discuss mailing list
> >> rabbitmq-discuss at lists.rabbitmq.com
> >> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> >>
> >
> > _______________________________________________
> > rabbitmq-discuss mailing list
> > rabbitmq-discuss at lists.rabbitmq.com
> > http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
> >
> >
>
> --
> View this message in context:
> http://www.nabble.com/Channel.isopen-returns-false-and-%7Btimeout%2Crunning%7D-exception-tp25531373p25667088.html
> Sent from the RabbitMQ mailing list archive at Nabble.com.
>
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090929/f09cbe9d/attachment.htm 

From matthias at lshift.net  Tue Sep 29 18:59:58 2009
From: matthias at lshift.net (Matthias Radestock)
Date: Tue, 29 Sep 2009 18:59:58 +0100
Subject: [rabbitmq-discuss] Channel.isopen returns false and {timeout,
 running} exception
In-Reply-To: <29598b610909291052x9ce9a07md33895c13524c390@mail.gmail.com>
References: <25531373.post@talk.nabble.com>	<29598b610909290054j184c12acx3416be5838ad3475@mail.gmail.com>	<25667088.post@talk.nabble.com>
	<29598b610909291052x9ce9a07md33895c13524c390@mail.gmail.com>
Message-ID: <4AC24B1E.1020509@lshift.net>

Katrina,

Paul Jones wrote:
> Would you have any kind of networking event that happens at this time? 
> For example, would it be possible that your network link gets reset?
> 
> Maybe you could try leaving an SSH connection open to the server over 
> that time period, and see if it too ends up broken?

Actually, my guess would be that the error is caused by a busy machine, 
perhaps due to backups or some other heavy duty cron jobs running.

I have seen heartbeat timeouts (that's what the {timeout,running} error 
is) getting triggered under those circumstance on a customer system.

If so then the solution is to either increase the heartbeat interval or 
turn off heartbeats altogether (by setting the interval to 0 in the client).


Regards,

Matthias.



From pneumann at gmail.com  Tue Sep 29 21:58:41 2009
From: pneumann at gmail.com (Phillip Neumann)
Date: Tue, 29 Sep 2009 16:58:41 -0400
Subject: [rabbitmq-discuss] Rabbitmq pid files
In-Reply-To: <3bb0d9710909290831n1e658809jfa46c59f0d6f5079@mail.gmail.com>
References: <49661E84-FB14-4FB1-888A-4530EF36868F@pmamediagroup.com>
	<3bb0d9710909290831n1e658809jfa46c59f0d6f5079@mail.gmail.com>
Message-ID: <7AC463BF-B902-44FC-BBCA-E004288C58A0@gmail.com>

sed 's/.*,\(.*\)\}.*/\1/' /var/lib/rabbitmq/pids > /var/run/rabbitmq.pid

El 29-09-2009, a las 11:31, majek04 escribi?:

> On Tue, Sep 29, 2009 at 15:16, teubanks <traceye at pmamediagroup.com>  
> wrote:
>> I'm using rabbitmq v1.6.0 trying to set it up with monit. I need to
>> know where it stores its pid file
>
> Try: /var/lib/rabbitmq/pids
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss




From akalend at mail.ru  Wed Sep 30 00:40:13 2009
From: akalend at mail.ru (Alexandre Kalendarev)
Date: Wed, 30 Sep 2009 03:40:13 +0400
Subject: [rabbitmq-discuss] librabbitmq, expire message
Message-ID: <E1MsmIn-0001Y6-00.akalend-mail-ru@f161.mail.ru>

Hi All,

Can I to use expire parameter in the RabbitMQ messaging?
When I can to set the expire parameter?
Is the support the expire parameter  the RabbitMQ ?

Thanks,

Alexandre



From matthew at lshift.net  Wed Sep 30 10:55:53 2009
From: matthew at lshift.net (Matthew Sackman)
Date: Wed, 30 Sep 2009 10:55:53 +0100
Subject: [rabbitmq-discuss] librabbitmq, expire message
In-Reply-To: <E1MsmIn-0001Y6-00.akalend-mail-ru@f161.mail.ru>
References: <E1MsmIn-0001Y6-00.akalend-mail-ru@f161.mail.ru>
Message-ID: <20090930095553.GA30360@mrnibble.lshift.net>

Hi Alexandre,

On Wed, Sep 30, 2009 at 03:40:13AM +0400, Alexandre Kalendarev wrote:
> Can I to use expire parameter in the RabbitMQ messaging?
> When I can to set the expire parameter?
> Is the support the expire parameter  the RabbitMQ ?

The Time To Live (TTL) is an oft requested feature and certainly one
that we plan to implement in the future. However, it will be a few
releases yet before we will support it. At the moment, Rabbit does not
support message expiry at all, however, this can be worked around in
application logic provided you embed a timestamp within the message and
your receiving consumers are able to understand the timestamp and drop
messages which are too old.

Matthew



From cuonglb at facemain.com  Wed Sep 30 11:57:08 2009
From: cuonglb at facemain.com (Cuong Le)
Date: Wed, 30 Sep 2009 17:57:08 +0700
Subject: [rabbitmq-discuss] librabbitmq, expire message
In-Reply-To: <20090930095553.GA30360@mrnibble.lshift.net>
References: <E1MsmIn-0001Y6-00.akalend-mail-ru@f161.mail.ru>
	<20090930095553.GA30360@mrnibble.lshift.net>
Message-ID: <aae1003d0909300357n1ad22fect4641c8f3491defac@mail.gmail.com>

Hi,

I think i have good plan for this. I'm checking message expiry in my logical
process. Because RabbitMQ is a BROKER
should not need to be [message expiry param].

Cuong

On Wed, Sep 30, 2009 at 4:55 PM, Matthew Sackman <matthew at lshift.net> wrote:

> Hi Alexandre,
>
> On Wed, Sep 30, 2009 at 03:40:13AM +0400, Alexandre Kalendarev wrote:
> > Can I to use expire parameter in the RabbitMQ messaging?
> > When I can to set the expire parameter?
> > Is the support the expire parameter  the RabbitMQ ?
>
> The Time To Live (TTL) is an oft requested feature and certainly one
> that we plan to implement in the future. However, it will be a few
> releases yet before we will support it. At the moment, Rabbit does not
> support message expiry at all, however, this can be worked around in
> application logic provided you embed a timestamp within the message and
> your receiving consumers are able to understand the timestamp and drop
> messages which are too old.
>
> Matthew
>
> _______________________________________________
> rabbitmq-discuss mailing list
> rabbitmq-discuss at lists.rabbitmq.com
> http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090930/74857c22/attachment.htm 

From tonyg at lshift.net  Wed Sep 30 14:13:49 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Wed, 30 Sep 2009 14:13:49 +0100
Subject: [rabbitmq-discuss] rabbitmq-c
In-Reply-To: <BB244B56-1BC8-4761-A7CE-FFDBFA6F25F3@epicadvertising.com>
References: <BB244B56-1BC8-4761-A7CE-FFDBFA6F25F3@epicadvertising.com>
Message-ID: <4AC3598D.2050504@lshift.net>

Hi Scott,

Scott Brooks wrote:
> Although passing the amqp_bytes_t as a struct is a really great  
> solution to C strings, passing structs by value, and returning structs  
> is not supported by libffi/ruby-ffi(as far as I could test anyways).

Yes, it seems like a slightly edgy thing to do even in a C API, I think.

> So I took amqp_api.c, and wrote amqp_api_p.c which accepts pointers to  
> structs rather then copy by value.  These functions just create take  
> the pointers, copy to local vars and then calls the existing functions.

That sounds reasonable. I notice that there aren't many functions that
*return* structs, and those that do are special anyway.

I wonder whether you're doing this:

  amqp_bytes_t v = *arg;
  somefun(v);

or simply:

  somefun(*arg);

?

> In general I see a few solutions to the problem of wrapping rabbitmq-c  
> for use in higher level languages.
> A: don't support it

... thus providing a slight impetus for those languages to make their
FFI able to cope with structs-by-value :-)

Is the lack of structs-by-value a libffi thing, or is it a problem with
the ruby interface to libffi?

> B: keep a parallel set of pass by pointer functions so either API can  
> be used(currently it just copies the data passed to the pointer, and  
> then calls the pass by value functions)

Possible, possible. How are you thinking of dealing with AMQP tables?
They're a little more complex than amqp_bytes_t - a simple
pointer-passing strategy might not work so well.

> C: change the whole API to pass pointers.

I don't like this idea.


Regards,
  Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From scott.brooks at epicadvertising.com  Wed Sep 30 16:41:30 2009
From: scott.brooks at epicadvertising.com (Scott Brooks)
Date: Wed, 30 Sep 2009 10:41:30 -0500
Subject: [rabbitmq-discuss] rabbitmq-c
In-Reply-To: <4AC3598D.2050504@lshift.net>
References: <BB244B56-1BC8-4761-A7CE-FFDBFA6F25F3@epicadvertising.com>
	<4AC3598D.2050504@lshift.net>
Message-ID: <DEF8FC22-A14D-44EB-9451-A201BC3221D2@epicadvertising.com>


On 2009-09-30, at 9:13 AM, Tony Garnock-Jones wrote:

> Hi Scott,
>
> Scott Brooks wrote:
>> Although passing the amqp_bytes_t as a struct is a really great
>> solution to C strings, passing structs by value, and returning  
>> structs
>> is not supported by libffi/ruby-ffi(as far as I could test anyways).
>
> Yes, it seems like a slightly edgy thing to do even in a C API, I  
> think.
>
>> So I took amqp_api.c, and wrote amqp_api_p.c which accepts pointers  
>> to
>> structs rather then copy by value.  These functions just create take
>> the pointers, copy to local vars and then calls the existing  
>> functions.
>
> That sounds reasonable. I notice that there aren't many functions that
> *return* structs, and those that do are special anyway.
Yeah, amqp_cstring_bytes is the main one that returns a struct.

>
> I wonder whether you're doing this:
>
>  amqp_bytes_t v = *arg;
>  somefun(v);
>
> or simply:
>
>  somefun(*arg);
>
> ?
Actually I'm doing something worse!

amqp_bytes_t body;
memcpy(&body, in_body, sizeof(body);

But gcc does a good job on -O1 and above and replaces the memcpy.

>
>> In general I see a few solutions to the problem of wrapping  
>> rabbitmq-c
>> for use in higher level languages.
>> A: don't support it
>
> ... thus providing a slight impetus for those languages to make their
> FFI able to cope with structs-by-value :-)
>
> Is the lack of structs-by-value a libffi thing, or is it a problem  
> with
> the ruby interface to libffi?

Looking at the unit tests for libffi, it looks like they pass by  
struct properly.
I wrote a patch to handle returning structs for ruby-ffi, and then got  
stuck on
handling the pass struct by value because I forgot that the shared  
library ABI
would have a well defined interface for that.

>
>> B: keep a parallel set of pass by pointer functions so either API can
>> be used(currently it just copies the data passed to the pointer, and
>> then calls the pass by value functions)
>
> Possible, possible. How are you thinking of dealing with AMQP tables?
> They're a little more complex than amqp_bytes_t - a simple
> pointer-passing strategy might not work so well.
>
>> C: change the whole API to pass pointers.
>
> I don't like this idea.

I guess option D is revisiting ruby-ffi and trying to get the pass  
structs by
value code working, which looks to be the route I'll try and take.

>
>
> Regards,
>  Tony
> -- 
> [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
>   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
> []  [] http://www.lshift.net/ | Email: tonyg at lshift.net




From tonyg at lshift.net  Wed Sep 30 16:44:27 2009
From: tonyg at lshift.net (Tony Garnock-Jones)
Date: Wed, 30 Sep 2009 16:44:27 +0100
Subject: [rabbitmq-discuss] rabbitmq-c
In-Reply-To: <DEF8FC22-A14D-44EB-9451-A201BC3221D2@epicadvertising.com>
References: <BB244B56-1BC8-4761-A7CE-FFDBFA6F25F3@epicadvertising.com>
	<4AC3598D.2050504@lshift.net>
	<DEF8FC22-A14D-44EB-9451-A201BC3221D2@epicadvertising.com>
Message-ID: <4AC37CDB.4080500@lshift.net>

Scott Brooks wrote:
> I guess option D is revisiting ruby-ffi and trying to get the pass  
> structs by
> value code working, which looks to be the route I'll try and take.

Yep. I'd be *reasonably* happy supporting a parallel API for some of the
operations -- but it really only works well for the simple ones
(amqp_bytes_t). The complex ones will no doubt require special handling
anyway...

Tony
-- 
 [][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
   [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
 []  [] http://www.lshift.net/ | Email: tonyg at lshift.net



From scott.brooks at epicadvertising.com  Wed Sep 30 16:52:11 2009
From: scott.brooks at epicadvertising.com (Scott Brooks)
Date: Wed, 30 Sep 2009 10:52:11 -0500
Subject: [rabbitmq-discuss] rabbitmq-c
In-Reply-To: <4AC37CDB.4080500@lshift.net>
References: <BB244B56-1BC8-4761-A7CE-FFDBFA6F25F3@epicadvertising.com>
	<4AC3598D.2050504@lshift.net>
	<DEF8FC22-A14D-44EB-9451-A201BC3221D2@epicadvertising.com>
	<4AC37CDB.4080500@lshift.net>
Message-ID: <E4CA199E-A941-4175-B311-C62ECF38C538@epicadvertising.com>

On 2009-09-30, at 11:44 AM, Tony Garnock-Jones wrote:

Scott Brooks wrote:
I guess option D is revisiting ruby-ffi and trying to get the pass
structs by
value code working, which looks to be the route I'll try and take.

Yep. I'd be *reasonably* happy supporting a parallel API for some of the
operations -- but it really only works well for the simple ones
(amqp_bytes_t). The complex ones will no doubt require special handling
anyway...

And the Lazyweb wins again.  ruby-ffi was updated a few months ago to support
passing structs by value.  Problem solved!

Thanks for the C-library, chances are once I get the wrapper going with the lastest
ruby-ffi there will be another ruby amqp library in the mix.

Scott


Tony
--
[][][] Tony Garnock-Jones     | Mob: +44 (0)7905 974 211
  [][] LShift Ltd             | Tel: +44 (0)20 7729 7060
[]  [] http://www.lshift.net/ | Email: tonyg at lshift.net<mailto:tonyg at lshift.net>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090930/c7e21018/attachment.htm 

