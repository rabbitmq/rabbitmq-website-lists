<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Fwd: RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fwd%3A%20RabbitMQ%20C%20library%20function%0A%09amqp_simple_wait_frame%20takes%20400%20ms&In-Reply-To=%3CAANLkTikRUsUKdCgLY2rYWcSuSR_A4gFnEZmo09cXEWM6%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007809.html">
   <LINK REL="Next"  HREF="007777.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Fwd: RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms</H1>
    <B>Scott Brooks</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fwd%3A%20RabbitMQ%20C%20library%20function%0A%09amqp_simple_wait_frame%20takes%20400%20ms&In-Reply-To=%3CAANLkTikRUsUKdCgLY2rYWcSuSR_A4gFnEZmo09cXEWM6%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Fwd: RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms">scott at beamdog.com
       </A><BR>
    <I>Wed Jun 30 22:14:33 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007809.html">[rabbitmq-discuss] Fwd: RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms
</A></li>
        <LI>Next message: <A HREF="007777.html">[rabbitmq-discuss] rabbitmq-bql cannot create queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7810">[ date ]</a>
              <a href="thread.html#7810">[ thread ]</a>
              <a href="subject.html#7810">[ subject ]</a>
              <a href="author.html#7810">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Could you post your sample code, or as simple as possible repro case?

Scott Brooks

On Wed, Jun 30, 2010 at 2:54 PM, Jim Irrer &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A>&gt; wrote:
&gt;<i> What I'm trying to implement is a simple client-server paradigm where each
</I>&gt;<i> is single threaded.&#160; The client sends a message to the server, and then
</I>&gt;<i> waits for a reply by posting a read on a separate reply queue.&#160; When the
</I>&gt;<i> server gets the message, it processes it, builds a reply, and sends the
</I>&gt;<i> reply to the client.
</I>&gt;<i>
</I>&gt;<i> I've re-built the rabbitmq-c-default library and inserted print statements
</I>&gt;<i> that show the time in microseconds, and the series of events is a loop that
</I>&gt;<i> basically does the following:
</I>&gt;<i>
</I>&gt;<i> server waits on read
</I>&gt;<i>
</I>&gt;<i> client sends message and then waits for reply
</I>&gt;<i>
</I>&gt;<i> server gets message
</I>&gt;<i>
</I>&gt;<i> server performs trivial processing
</I>&gt;<i>
</I>&gt;<i> server sends reply
</I>&gt;<i>
</I>&gt;<i> client gets reply
</I>&gt;<i>
</I>&gt;<i> Below is a listing of events with timestamps in microseconds.&#160; The initial
</I>&gt;<i> 3172304
</I>&gt;<i> microsecond delay is the time it took me to start the client in a different
</I>&gt;<i> window
</I>&gt;<i> after starting the server.&#160; When a process is &quot;waiting on read&quot;, it is
</I>&gt;<i> actually the
</I>&gt;<i> system read call that is posted on the socket.&#160; I put the print statement
</I>&gt;<i> inside the
</I>&gt;<i> AMQP library call.
</I>&gt;<i>
</I>&gt;<i> relative&#160;&#160; elapsed
</I>&gt;<i> &#160; time&#160;&#160;&#160;&#160;&#160; time&#160;&#160;&#160; operation
</I>&gt;<i> --------&#160;&#160; -------&#160; ---------------------------------------
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160; server waiting on read
</I>&gt;<i> &#160;3172304&#160;&#160; 3172304&#160; client calling amqp_basic_publish
</I>&gt;<i> &#160;3172331&#160;&#160;&#160;&#160;&#160;&#160;&#160; 27&#160; client returned from amqp_basic_publish
</I>&gt;<i> &#160;3172337&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 6&#160; client waiting on read
</I>&gt;<i> &#160;3383774&#160;&#160;&#160; 211437&#160; server returned from read
</I>&gt;<i> &#160;3383892&#160;&#160;&#160;&#160;&#160;&#160; 118&#160; server 1 message: 1
</I>&gt;<i> &#160;3383898&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 6&#160; server calling amqp_basic_publish
</I>&gt;<i> &#160;3383927&#160;&#160;&#160;&#160;&#160;&#160;&#160; 29&#160; server returned from amqp_basic_publish
</I>&gt;<i> &#160;3383938&#160;&#160;&#160;&#160;&#160;&#160;&#160; 11&#160; server waiting on read
</I>&gt;<i> &#160;3497244&#160;&#160;&#160; 113306&#160; client returned from read
</I>&gt;<i> &#160;3497279&#160;&#160;&#160;&#160;&#160;&#160;&#160; 35&#160; client message: 1
</I>&gt;<i> &#160;3497288&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 9&#160; client calling amqp_basic_publish
</I>&gt;<i> &#160;3497310&#160;&#160;&#160;&#160;&#160;&#160;&#160; 22&#160; client returned from amqp_basic_publish
</I>&gt;<i> &#160;3497315&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 5&#160; client waiting on read
</I>&gt;<i> &#160;3715343&#160;&#160;&#160; 218028&#160; server returned from read
</I>&gt;<i> &#160;3715374&#160;&#160;&#160;&#160;&#160;&#160;&#160; 31&#160; server 2 message: 2
</I>&gt;<i> &#160;3715378&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 4&#160; server calling amqp_basic_publish
</I>&gt;<i> &#160;3715400&#160;&#160;&#160;&#160;&#160;&#160;&#160; 22&#160; server returned from amqp_basic_publish
</I>&gt;<i> &#160;3715405&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 5&#160; server waiting on read
</I>&gt;<i> &#160;3934206&#160;&#160;&#160; 218801&#160; client returned from read
</I>&gt;<i> &#160;3934236&#160;&#160;&#160;&#160;&#160;&#160;&#160; 30&#160; client message: 2
</I>&gt;<i> &#160;3934243&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 7&#160; client calling amqp_basic_publish
</I>&gt;<i> &#160;3934265&#160;&#160;&#160;&#160;&#160;&#160;&#160; 22&#160; client returned from amqp_basic_publish
</I>&gt;<i> &#160;3934270&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 5&#160; client waiting on read
</I>&gt;<i> &#160;4153113&#160;&#160;&#160; 218843&#160; server returned from read
</I>&gt;<i> &#160;4153151&#160;&#160;&#160;&#160;&#160;&#160;&#160; 38&#160; server 3 message: 3
</I>&gt;<i> &#160;4153158&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 7&#160; server calling amqp_basic_publish
</I>&gt;<i> &#160;4153189&#160;&#160;&#160;&#160;&#160;&#160;&#160; 31&#160; server returned from amqp_basic_publish
</I>&gt;<i> &#160;4153197&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 8&#160; server waiting on read
</I>&gt;<i> &#160;4371982&#160;&#160;&#160; 218785&#160; client returned from read
</I>&gt;<i> &#160;4372017&#160;&#160;&#160;&#160;&#160;&#160;&#160; 35&#160; client message: 3
</I>&gt;<i> &#160;4372027&#160;&#160;&#160;&#160;&#160;&#160;&#160; 10&#160; client calling amqp_basic_publish
</I>&gt;<i> &#160;4372091&#160;&#160;&#160;&#160;&#160;&#160;&#160; 64&#160; client returned from amqp_basic_publish
</I>&gt;<i> &#160;4372099&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 8&#160; client waiting on read
</I>&gt;<i> &#160;4590627&#160;&#160;&#160; 218528&#160; server returned from read
</I>&gt;<i> &#160;4590657&#160;&#160;&#160;&#160;&#160;&#160;&#160; 30&#160; server 4 message: 4
</I>&gt;<i> &#160;4590661&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 4&#160; server calling amqp_basic_publish
</I>&gt;<i> &#160;4590682&#160;&#160;&#160;&#160;&#160;&#160;&#160; 21&#160; server returned from amqp_basic_publish
</I>&gt;<i> &#160;4590687&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 5&#160; server waiting on read
</I>&gt;<i> &#160;4809133&#160;&#160;&#160; 218446&#160; client returned from read
</I>&gt;<i> &#160;4809162&#160;&#160;&#160;&#160;&#160;&#160;&#160; 29&#160; client message: 4
</I>&gt;<i> &#160;4809169&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 7&#160; client calling amqp_basic_publish
</I>&gt;<i> &#160;4809190&#160;&#160;&#160;&#160;&#160;&#160;&#160; 21&#160; client returned from amqp_basic_publish
</I>&gt;<i> &#160;4809195&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 5&#160; client waiting on read
</I>&gt;<i> &#160;5028276&#160;&#160;&#160; 219081&#160; server returned from read
</I>&gt;<i> &#160;5028308&#160;&#160;&#160;&#160;&#160;&#160;&#160; 32&#160; server 5 message: 5
</I>&gt;<i> &#160;5028312&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 4&#160; server calling amqp_basic_publish
</I>&gt;<i> &#160;5028334&#160;&#160;&#160;&#160;&#160;&#160;&#160; 22&#160; server returned from amqp_basic_publish
</I>&gt;<i> &#160;5030059&#160;&#160;&#160;&#160;&#160; 1725&#160; client returned from read
</I>&gt;<i> &#160;5030077&#160;&#160;&#160;&#160;&#160;&#160;&#160; 18&#160; client message: 5
</I>&gt;<i>
</I>&gt;<i> Each side seems to be introducing a delay that is suspiciously close to 200
</I>&gt;<i> milliseconds, that may be some system configured value.
</I>&gt;<i>
</I>&gt;<i> I tried TCP_NODELAY (it looks like TCP_NODELACK is only in AIX)
</I>&gt;<i> but it had no effect.&#160; Setting this with setsockopt turns off Nagle's
</I>&gt;<i> algorithm which is set by default and tries to optimize socket performance
</I>&gt;<i> for large data transfers by deferring sends until either there is enough
</I>&gt;<i> data to send a full packet or a timeout occurs.&#160; Oddly, I had to be root
</I>&gt;<i> to set this option.
</I>&gt;<i>
</I>&gt;<i> If you have any idea as to why the extra delay is being introduced, please
</I>&gt;<i> let me know (and especially how to fix it :)&#160; )
</I>&gt;<i>
</I>&gt;<i> Thanks for any insights,
</I>&gt;<i>
</I>&gt;<i> - Jim
</I>&gt;<i>
</I>&gt;<i> Jim Irrer &#160; &#160; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A> &#160; &#160; &#160; (734) 647-4409
</I>&gt;<i> University of Michigan Hospital Radiation Oncology
</I>&gt;<i> 519 W. William St. &#160; &#160; &#160; &#160; &#160; &#160; Ann Arbor, MI 48103
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ---------- Forwarded message ----------
</I>&gt;<i> From: Brett Cameron &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">brett.r.cameron at gmail.com</A>&gt;
</I>&gt;<i> Date: Fri, Jun 25, 2010 at 9:57 PM
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] RabbitMQ C library function
</I>&gt;<i> amqp_simple_wait_frame takes 400 ms
</I>&gt;<i> To: David Wragg &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">david at rabbitmq.com</A>&gt;, Jim Irrer &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A>&gt;
</I>&gt;<i> Cc: rabbitmq-discuss &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Jim,
</I>&gt;<i>
</I>&gt;<i> I believe that you are looking at a TCP/IP issue here (which you may or may
</I>&gt;<i> not be able to address by modifying the libRabbitMQ code).&#160;My guess is that
</I>&gt;<i> if you set the TCP/IP kernel parameter tcpnodelack&#160;(or whatever it is called
</I>&gt;<i> on your operating system) to 1 (i.e. don't delay acknowledging TCP data),
</I>&gt;<i> you will see things improve rather significantly. Depending on what platform
</I>&gt;<i> you're using, you may be able to stick a setsockopt() call (using the option
</I>&gt;<i> TCP_NODELACK) in amqp_socket.c between the socket() call and the connect()
</I>&gt;<i> call instead of having to make the chnage globally by messing with the
</I>&gt;<i> kernel parameter.
</I>&gt;<i> For what it's worth, I encountered this problem with libRabbitMQ-C on
</I>&gt;<i> OpenVMS just last week.. Luky for me I've seen the problem before. Seem to
</I>&gt;<i> recall that you guys at umich.edu used to have some OpenVMS systems...
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Brett
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sat, Jun 26, 2010 at 11:54 AM, David Wragg &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">david at rabbitmq.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Jim,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jim Irrer &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">irrer at umich.edu</A>&gt; writes:
</I>&gt;&gt;<i> &gt; I'm working on two functions that act as a client-server pair. &#160;They
</I>&gt;&gt;<i> &gt; use two amq.direct queues to communicate. &#160;When ever either of
</I>&gt;&gt;<i> &gt; them calls the amqp_simple_wait_frame function, it does not return
</I>&gt;&gt;<i> &gt; for 436618 microseconds.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Some other background info that might be relevant:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; If I only send messages in one direction it's really fast.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Both processes are using separate connectors and different sockets.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I used the amqp_consumer.c amqp_producer.c code in
</I>&gt;&gt;<i> &gt; the examples directory as a reference.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Is there a way to avoid this delay?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm not sure what you are really asking here. &#160;As its name suggests,
</I>&gt;&gt;<i> amqp_simple_wait_frame waits for a frame to arrive. &#160;It will typically
</I>&gt;&gt;<i> attempt to read from the socket connected to the AMQP server. &#160;If no
</I>&gt;&gt;<i> data is available, it will block until data is available. &#160;The resulting
</I>&gt;&gt;<i> delays are thus an intrinsic feature of amqp_simple_wait_frame.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Are you sure that the 400ms delay does not simply reflect the wait for a
</I>&gt;&gt;<i> message to arrive?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm guessing, but perhaps the problem is that you want a single
</I>&gt;&gt;<i> application to publish and consume messages concurrently, and you are
</I>&gt;&gt;<i> finding that the synchronous nature of amqp_simple_wait_frame is an
</I>&gt;&gt;<i> obstacle? &#160;If so, the simplest work around would be to have two threads,
</I>&gt;&gt;<i> one to publish and one to consume, and open a separate AMQP connection
</I>&gt;&gt;<i> in each thread.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Also ...
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Could I use the same socket in each program as long as it was only
</I>&gt;&gt;<i> &gt; used by one thread at a time?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Could I use the same connection in each program if it was only
</I>&gt;&gt;<i> &gt; used by one thread at a time?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What's the distinction between socket and connection here?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> librabbitmq does not do anything to explicitly support multithreading,
</I>&gt;&gt;<i> but neither does it do anything to conflict with it. &#160;If you, the
</I>&gt;&gt;<i> application programmer, ensure that for a given connection, only one
</I>&gt;&gt;<i> thread uses librabbitmq at a time, you should be safe.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> David Wragg
</I>&gt;&gt;<i> Staff Engineer, RabbitMQ
</I>&gt;&gt;<i> SpringSource, a division of VMware
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007809.html">[rabbitmq-discuss] Fwd: RabbitMQ C library function	amqp_simple_wait_frame takes 400 ms
</A></li>
	<LI>Next message: <A HREF="007777.html">[rabbitmq-discuss] rabbitmq-bql cannot create queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7810">[ date ]</a>
              <a href="thread.html#7810">[ thread ]</a>
              <a href="subject.html#7810">[ subject ]</a>
              <a href="author.html#7810">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
