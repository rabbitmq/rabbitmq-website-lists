<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Java Client + Android
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Java%20Client%20%2B%20Android&In-Reply-To=%3CAANLkTimd1kZFwnpwvq-8qnE6cNBNiWIlDtgjgLfDAibd%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007565.html">
   <LINK REL="Next"  HREF="007568.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Java Client + Android</H1>
    <B>Miguel Morales</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Java%20Client%20%2B%20Android&In-Reply-To=%3CAANLkTimd1kZFwnpwvq-8qnE6cNBNiWIlDtgjgLfDAibd%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Java Client + Android">therevoltingx at gmail.com
       </A><BR>
    <I>Tue Jun 15 09:57:07 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007565.html">[rabbitmq-discuss] Java Client + Android
</A></li>
        <LI>Next message: <A HREF="007568.html">[rabbitmq-discuss] Java Client + Android
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7566">[ date ]</a>
              <a href="thread.html#7566">[ thread ]</a>
              <a href="subject.html#7566">[ subject ]</a>
              <a href="author.html#7566">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Well, the only method that the Android docs provide is to call
System.gc() which make the JVM schedule a GC run.
This wouldn't help in the inner loop, but it's what I do right after I
connect and setup the queues.

I'm not sure how I can influence the GC in a stock android device beyond that.
&gt;<i>From googling on how to influence the GC in java, some people give
</I>some tips such as setting the objects to null, and some other java
trickery that I'll have to try.

However, from the android google blog, it seems the dalvik (which
android uses) JVM doesn't support such optimizations:
<A HREF="http://android-developers.blogspot.com/2009/02/track-memory-allocations.html">http://android-developers.blogspot.com/2009/02/track-memory-allocations.html</A>

Also, the JIT is coming to Android soon, I'm not entirely familiar
with how it works, but I'll keep looking.    I'm not sure if this will
work on the older devices though.
<A HREF="http://developer.android.com/reference/java/lang/Compiler.html">http://developer.android.com/reference/java/lang/Compiler.html</A>

Other than that, I haven't tried any other compiler trickery, mainly
because this is my first app using java.
Again, any java related hints would be appreciated.

Thanks,
Miguel


On Tue, Jun 15, 2010 at 12:31 AM, John Apps &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">johndapps at gmail.com</A>&gt; wrote:
&gt;<i> This is probably way off the mark, and something you have sure to have
</I>&gt;<i> tried: changing the GC parameters? Or is this not possible on the Android? I
</I>&gt;<i> assume this is Java 6?
</I>&gt;<i> How is Java started on Android or, perhaps better question, can you
</I>&gt;<i> influence the GC parameters?
</I>&gt;<i>
</I>&gt;<i> On Tue, Jun 15, 2010 at 02:36, Miguel Morales &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">therevoltingx at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For the past few months I've been developing a game using Android and
</I>&gt;&gt;<i> the rabbitmq java client with fair results.
</I>&gt;&gt;<i> Setting it up was fairly painless, however, I've run into one issue
</I>&gt;&gt;<i> that's making one of the key parts of my game suffer.
</I>&gt;&gt;<i> In Android, every time the garbage collector runs, the CPU is busy for
</I>&gt;&gt;<i> a few milliseconds, ~200ms.
</I>&gt;&gt;<i> This slows the frame rate and causes the game to stutter for a bit.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem is in consuming messages, I have a thread that simply
</I>&gt;&gt;<i> reads from a queue as fast as it can delivers the body bytes to the
</I>&gt;&gt;<i> game client.
</I>&gt;&gt;<i> However, in the library there are a bunch of small allocations that
</I>&gt;&gt;<i> happen which causes the GC to run at least once every 10 seconds,
</I>&gt;&gt;<i> using both a consumer and a basicGet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've tried to look at the code and remove allocations, and have got
</I>&gt;&gt;<i> the GC runs down to about 1 every 40 seconds. &#160;Still, that GC runs and
</I>&gt;&gt;<i> constant allocations
</I>&gt;&gt;<i> are hindering my ability to render some decent maps on the older
</I>&gt;&gt;<i> Android models (I use a G1)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I also tried briefly to get the rabbitmq-c client working, and I was
</I>&gt;&gt;<i> successful.
</I>&gt;&gt;<i> However, I hit a roadblock when trying to send the body bytes back to
</I>&gt;&gt;<i> the JVM using JNI.
</I>&gt;&gt;<i> I keep running out of memory or crashing using a jbyteArray buffer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My C is pretty rusty so I was hoping someone had some suggestions
</I>&gt;&gt;<i> regarding that.
</I>&gt;&gt;<i> Ideally, I'd just be able to get rid of the allocations while
</I>&gt;&gt;<i> consuming messages, any help is appreciated!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've created a test application for android to test out the different
</I>&gt;&gt;<i> consuming implementations in github:
</I>&gt;&gt;<i> <A HREF="http://github.com/therevoltingx/rabbitmq_android_test">http://github.com/therevoltingx/rabbitmq_android_test</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can see how fiddling around with the internal java client code I
</I>&gt;&gt;<i> was able to get rid of some allocations here (simply by caching
</I>&gt;&gt;<i> Basic.Get):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://github.com/therevoltingx/rabbitmq_android_test/blob/master/src/com/diastrofunk/rabbitmqtest/JavaTests.java#L74">http://github.com/therevoltingx/rabbitmq_android_test/blob/master/src/com/diastrofunk/rabbitmqtest/JavaTests.java#L74</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can see the C/JNI version here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://github.com/therevoltingx/rabbitmq_android_test/blob/master/jni/ndktests.c">http://github.com/therevoltingx/rabbitmq_android_test/blob/master/jni/ndktests.c</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any help in this would be appreciated!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Miguel
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> <A HREF="http://diastrofunk.com,">http://diastrofunk.com,</A> <A HREF="http://developingthedream.blogspot.com/,">http://developingthedream.blogspot.com/,</A>
</I>&gt;&gt;<i> <A HREF="http://www.youtube.com/user/revoltingx,">http://www.youtube.com/user/revoltingx,</A> ~Isaiah 55:8-9
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> ---
</I>&gt;<i> John Apps
</I>&gt;<i> (49) 171 869 1813
</I>&gt;<i>
</I>


-- 
<A HREF="http://diastrofunk.com,">http://diastrofunk.com,</A> <A HREF="http://developingthedream.blogspot.com/,">http://developingthedream.blogspot.com/,</A>
<A HREF="http://www.youtube.com/user/revoltingx,">http://www.youtube.com/user/revoltingx,</A> ~Isaiah 55:8-9
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007565.html">[rabbitmq-discuss] Java Client + Android
</A></li>
	<LI>Next message: <A HREF="007568.html">[rabbitmq-discuss] Java Client + Android
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7566">[ date ]</a>
              <a href="thread.html#7566">[ thread ]</a>
              <a href="subject.html#7566">[ subject ]</a>
              <a href="author.html#7566">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
