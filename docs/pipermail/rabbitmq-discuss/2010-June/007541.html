<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] list_queues times out
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20list_queues%20times%20out&In-Reply-To=%3C2D95FF8F-4675-4F4B-96FE-ED369D17A074%40echonest.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007540.html">
   <LINK REL="Next"  HREF="007542.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] list_queues times out</H1>
    <B>Tyler Williams</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20list_queues%20times%20out&In-Reply-To=%3C2D95FF8F-4675-4F4B-96FE-ED369D17A074%40echonest.com%3E"
       TITLE="[rabbitmq-discuss] list_queues times out">tyler at echonest.com
       </A><BR>
    <I>Thu Jun 10 20:23:23 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007540.html">[rabbitmq-discuss] list_queues times out
</A></li>
        <LI>Next message: <A HREF="007542.html">[rabbitmq-discuss] list_queues times out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7541">[ date ]</a>
              <a href="thread.html#7541">[ thread ]</a>
              <a href="subject.html#7541">[ subject ]</a>
              <a href="author.html#7541">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Mathew,

On Jun 10, 2010, at 2:52 PM, Matthew Sackman wrote:

&gt;<i> Hi Tyler,
</I>&gt;<i> 
</I>&gt;<i> On Thu, Jun 10, 2010 at 02:17:56PM -0400, Tyler Williams wrote:
</I>&gt;&gt;<i> I'm having a problem where after running for a while, and with a very large number of messages (10M+, using about 4G RAM), rabbit will get into a state where it is still working, but I cannot list queues. I've been using the rabbitmq-status plugin, and this also stops working, with this message in the logs when I hit the status page:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> =ERROR REPORT==== 8-Jun-2010::01:29:00 ===
</I>&gt;&gt;<i> {mochiweb_socket_server,235,
</I>&gt;&gt;<i>    {child_error,
</I>&gt;&gt;<i>        {timeout,{gen_server2,call,[rabbit_status_web,get_context]}}}}
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Can I do anything else to debug this? Is this a known issue?
</I>&gt;<i> 
</I>
Thanks for your reply.

&gt;<i> That's a coding error either in rabbit_status. It should not be doing any
</I>&gt;<i> gen_server2:calls without setting the optional timeout to infinity.
</I>&gt;<i> 
</I>&gt;<i> I would advise not using rabbit_status if this issue is causing rabbit
</I>&gt;<i> to crash.
</I>&gt;<i> 
</I>
I don't think this is *causing* rabbit to crash, it just shows up in the logs after rabbit has 'crashed' or gone into this weird state. 

&gt;<i> The rabbitmqctl correctly sets timeouts and will not crash.
</I>&gt;<i> 
</I>&gt;<i> There are times when rabbit can be unresponsive and can take a long time
</I>&gt;<i> to respond to even rabbitmqctl - on the order of several minutes. This
</I>&gt;<i> is easily considered a bug, and fixing this sort of issue is on our todo
</I>&gt;<i> list. However, unresponsiveness does not mean anything's gone wrong -
</I>&gt;<i> especially on the 21673 branch. Rabbit should always be able to recover
</I>&gt;<i> eventually and eventually move to a state where it can accept more
</I>&gt;<i> messages.
</I>&gt;<i> 
</I>
I've run rabbitmqctl list_queues and waited for hours with no response. I still see activity in the logs, and I can still connect to rabbit and do stuff, but I don't get any output from list_queues.

&gt;<i> That said, if you do have 4GB RAM and over 10M messages, you may need to
</I>&gt;<i> start using the rabbitmq-toke plugin which cuts down the per-message RAM
</I>&gt;<i> cost to very little (in combination with the 21673 branch), by using
</I>&gt;<i> tokyo cabinet for a particular index table which otherwise can take a
</I>&gt;<i> couple of hundred bytes per entry. Basically, if you see the high
</I>&gt;<i> watermark set in the logs, and then a while later Rabbit reaches a point
</I>&gt;<i> where it is inactive (no CPU and no disk use) but the high watermark has
</I>&gt;<i> not been cleared, then it's likely you need to start investigating the
</I>&gt;<i> toke plugin.
</I>&gt;<i> 
</I>
Ok, I'll look into this. This is not exactly the failure mode we're seeing though, because in our case, rabbit is still using cpu and disk. It even clears and resets the watermark. I just can't list the queues at all.

As an addendum, after this happened today, I restarted rabbitmq, and it recovered it's previous queues without error. After using it for about 5 minutes though, it died, this time with an error in the log, which I've posted here: <A HREF="http://pastebin.com/BAaGpJab">http://pastebin.com/BAaGpJab</A>

&gt;<i> Best wishes,
</I>&gt;<i> 
</I>&gt;<i> Matthew
</I>
Thanks again for your help.

--tyler

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007540.html">[rabbitmq-discuss] list_queues times out
</A></li>
	<LI>Next message: <A HREF="007542.html">[rabbitmq-discuss] list_queues times out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7541">[ date ]</a>
              <a href="thread.html#7541">[ thread ]</a>
              <a href="subject.html#7541">[ subject ]</a>
              <a href="author.html#7541">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
