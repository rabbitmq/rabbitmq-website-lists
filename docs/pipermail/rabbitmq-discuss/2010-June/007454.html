<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Memory problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20problems&In-Reply-To=%3CAANLkTikhdxoEat-tO6-MUqshMv8-Jx7kZ7jIbW2Dvi7S%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007453.html">
   <LINK REL="Next"  HREF="007455.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Memory problems</H1>
    <B>Nicol&#225;s C&#233;sar</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20problems&In-Reply-To=%3CAANLkTikhdxoEat-tO6-MUqshMv8-Jx7kZ7jIbW2Dvi7S%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Memory problems">nico at nicocesar.com
       </A><BR>
    <I>Thu Jun  3 13:38:38 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007453.html">[rabbitmq-discuss] socket read timeout in rabbitmq-c
</A></li>
        <LI>Next message: <A HREF="007455.html">[rabbitmq-discuss] June 9th - Meetup in London
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7454">[ date ]</a>
              <a href="thread.html#7454">[ thread ]</a>
              <a href="subject.html#7454">[ subject ]</a>
              <a href="author.html#7454">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all

First I need to send kudos to all of you, I've been using rabbit for a year
now and has given me a lot of satisfactions. It reminded me the day I use a
Database instead of a bunch of files.. the same but with data flows! Like a
marriage, satisfactions and problems come in the same pack! Just some
background info:

 * Im running rabbitmq 1.7.0-3 on a debian testing distribution with
python-amqplib 0.6.1-1
 * It's a VPS with 2GB of RAM, *BUT* when the used memory it's aboout 80%,
&quot;tasks may be killed off pre-maturely, we do this to prevent a total OOM
scenario where the VPS goes dead&quot; (literal words from the provider)
 * I was using ~15 queues with 1kb messages and a rate of  ~20
messages/minute

Like a week ago I've made the following changes:
 * I'm using 50 queues  with a rate of ~60 messages/minute
 * One of them (I call it &quot;the fat queue&quot; ) has 50kb messages
 * Processing at the rear end is rate fixed ... so I need rabbit  to act as
a memory/disk buffer

A: High speed producer : 50000 1K messages in a second or so.
B: Translator: reads from A_q and generates a 50kb message from a single 1kb
message  and publishes it on the fat_queue.
C: (Slow) Fixed speed consumer: grabs the 50kb message and does it's magic.

A process -&gt; A_q queue -&gt; B process -&gt; fat_queue -&gt; many C processes (even
that I have many Cs,   A is much faster)


Here is the problem when everythig is almost empty:

rabbitmqctl list_queues memory | awk '{T += $1;}END{print T;}'
5703040

this means that the total memory used for queues is arround 5Mb but RES
memory for beam.smp process is 358Mb !!!

And when I start using it, things get worse. beam.smp just jumps from 400m
to1.6G (in jumps of 100-200m per second) and well... my VPS provider just
decides to kill almost everything on that machine. Right now I'm killing the
B process after a bunch of messages, but actually i don't know how to
estimate how much memory rabbit will be using per message.


I've heard the &quot;new persister&quot; (what a name, eh!) is &quot;much better&quot; with
&quot;memory issues&quot;:
<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-May/007251.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-May/007251.html</A>

taken from:
<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-February/006397.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-February/006397.html</A>

&gt;<i> =INFO REPORT==== 16-Feb-2010::04:42:05 ===
</I>&gt;<i> Memory limit set to 3196MB.
</I>
I'd love that functionality! when was implemented? or what parameters I need
to pass to rabbit?

Greetings!

Nico C&#233;sar
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100603/7cbbbfee/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100603/7cbbbfee/attachment.htm</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007453.html">[rabbitmq-discuss] socket read timeout in rabbitmq-c
</A></li>
	<LI>Next message: <A HREF="007455.html">[rabbitmq-discuss] June 9th - Meetup in London
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7454">[ date ]</a>
              <a href="thread.html#7454">[ thread ]</a>
              <a href="subject.html#7454">[ subject ]</a>
              <a href="author.html#7454">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
