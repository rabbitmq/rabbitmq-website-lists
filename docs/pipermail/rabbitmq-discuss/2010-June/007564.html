<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Java Client + Android
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Java%20Client%20%2B%20Android&In-Reply-To=%3CAANLkTil0z7LgJAajEaU5d7gMiwyxX_ywHj4HZQbX3pjm%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007685.html">
   <LINK REL="Next"  HREF="007565.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Java Client + Android</H1>
    <B>Miguel Morales</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Java%20Client%20%2B%20Android&In-Reply-To=%3CAANLkTil0z7LgJAajEaU5d7gMiwyxX_ywHj4HZQbX3pjm%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Java Client + Android">therevoltingx at gmail.com
       </A><BR>
    <I>Tue Jun 15 01:36:59 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007685.html">[rabbitmq-discuss] Claim on new ocamlmq broker...
</A></li>
        <LI>Next message: <A HREF="007565.html">[rabbitmq-discuss] Java Client + Android
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7564">[ date ]</a>
              <a href="thread.html#7564">[ thread ]</a>
              <a href="subject.html#7564">[ subject ]</a>
              <a href="author.html#7564">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

For the past few months I've been developing a game using Android and
the rabbitmq java client with fair results.
Setting it up was fairly painless, however, I've run into one issue
that's making one of the key parts of my game suffer.
In Android, every time the garbage collector runs, the CPU is busy for
a few milliseconds, ~200ms.
This slows the frame rate and causes the game to stutter for a bit.

The problem is in consuming messages, I have a thread that simply
reads from a queue as fast as it can delivers the body bytes to the
game client.
However, in the library there are a bunch of small allocations that
happen which causes the GC to run at least once every 10 seconds,
using both a consumer and a basicGet.

I've tried to look at the code and remove allocations, and have got
the GC runs down to about 1 every 40 seconds.  Still, that GC runs and
constant allocations
are hindering my ability to render some decent maps on the older
Android models (I use a G1)

I also tried briefly to get the rabbitmq-c client working, and I was
successful.
However, I hit a roadblock when trying to send the body bytes back to
the JVM using JNI.
I keep running out of memory or crashing using a jbyteArray buffer.

My C is pretty rusty so I was hoping someone had some suggestions
regarding that.
Ideally, I'd just be able to get rid of the allocations while
consuming messages, any help is appreciated!

I've created a test application for android to test out the different
consuming implementations in github:
<A HREF="http://github.com/therevoltingx/rabbitmq_android_test">http://github.com/therevoltingx/rabbitmq_android_test</A>

You can see how fiddling around with the internal java client code I
was able to get rid of some allocations here (simply by caching
Basic.Get):
<A HREF="http://github.com/therevoltingx/rabbitmq_android_test/blob/master/src/com/diastrofunk/rabbitmqtest/JavaTests.java#L74">http://github.com/therevoltingx/rabbitmq_android_test/blob/master/src/com/diastrofunk/rabbitmqtest/JavaTests.java#L74</A>

You can see the C/JNI version here:
<A HREF="http://github.com/therevoltingx/rabbitmq_android_test/blob/master/jni/ndktests.c">http://github.com/therevoltingx/rabbitmq_android_test/blob/master/jni/ndktests.c</A>

Any help in this would be appreciated!

Thanks,
Miguel

-- 
<A HREF="http://diastrofunk.com,">http://diastrofunk.com,</A> <A HREF="http://developingthedream.blogspot.com/,">http://developingthedream.blogspot.com/,</A>
<A HREF="http://www.youtube.com/user/revoltingx,">http://www.youtube.com/user/revoltingx,</A> ~Isaiah 55:8-9
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007685.html">[rabbitmq-discuss] Claim on new ocamlmq broker...
</A></li>
	<LI>Next message: <A HREF="007565.html">[rabbitmq-discuss] Java Client + Android
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7564">[ date ]</a>
              <a href="thread.html#7564">[ thread ]</a>
              <a href="subject.html#7564">[ subject ]</a>
              <a href="author.html#7564">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
