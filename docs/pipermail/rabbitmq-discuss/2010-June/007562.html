<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Claim on new ocamlmq broker...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Claim%20on%20new%20ocamlmq%20broker...&In-Reply-To=%3C20100614231848.GB13068%40wellquite.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007561.html">
   <LINK REL="Next"  HREF="007563.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Claim on new ocamlmq broker...</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Claim%20on%20new%20ocamlmq%20broker...&In-Reply-To=%3C20100614231848.GB13068%40wellquite.org%3E"
       TITLE="[rabbitmq-discuss] Claim on new ocamlmq broker...">matthew at rabbitmq.com
       </A><BR>
    <I>Tue Jun 15 00:18:49 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007561.html">[rabbitmq-discuss] Claim on new ocamlmq broker...
</A></li>
        <LI>Next message: <A HREF="007563.html">[rabbitmq-discuss] Claim on new ocamlmq broker...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7562">[ date ]</a>
              <a href="thread.html#7562">[ thread ]</a>
              <a href="subject.html#7562">[ subject ]</a>
              <a href="author.html#7562">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Jun 14, 2010 at 04:01:38PM -0700, mfp wrote:
&gt;<i> &gt;&gt; &quot;RabbitMQ did not guarantee that persistent messages had been saved to
</I>&gt;<i> &gt;&gt; disk before sending the message receipt, which could lead to data
</I>&gt;<i> &gt;&gt; loss&quot;
</I>&gt;<i> 
</I>&gt;<i> Does that mean that these comments by Matthew Sackman (who AFAIK works for
</I>&gt;<i> LShift and is a RabbitMQ developer) no longer apply?
</I>
After the buyout of RabbitMQ, by SpringSource/VMware, I am now employed
by VMware, and continue to work full time on RabbitMQ.

&gt;<i> &gt; When you publish a message with delivery mode 2 you are *not* _guaranteed_
</I>&gt;<i> &gt; that it hits disk. Publishing is an async operation and you get no
</I>&gt;<i> &gt; confirmation that it goes to disk. The new persister does very aggressive
</I>&gt;<i> &gt; caching in order to avoid doing lots of tiny and expensive writes. As
</I>&gt;<i> &gt; such,
</I>&gt;<i> &gt; there will frequently be times where if you restart the broker, you will
</I>&gt;<i> &gt; lose
</I>&gt;<i> &gt; several (maybe hundreds) of messages. 
</I>&gt;<i> 
</I>&gt;<i> Note that I'm referring to what happens in case of a hard RabbitMQ/system
</I>&gt;<i> crash. The behavior described by Matthew Sackman is consistent with what I
</I>&gt;<i> observed in the tests I did before writing ocamlmq: RabbitMQ accepting
</I>&gt;<i> persistent messages at fairly high rates, with quickly growing memory usage
</I>&gt;<i> and no disk activity.
</I>
The behaviour you have described is an intentional design of AMQP. Yes,
you could decide you want to write every message to disk and fsync it,
but if you do that then you'll have utterly atrocious performance.
Anything less that this leaves open the possibility of data loss in the
event of a hard system crash. How much data can be lost is, in the case
of AMQP, left to the client to decide: they can vary the size of the
transactions as they wish - if they can tolerate at most one message
being lost, then they must tx.commit after every publish. This will
likely result in an fsync per message, and performance will be very
poor, but the fact is that it's the client who is able to make decisions
as to the amount of data that can be lost.

Without transactions, publishing is an async activity, and whilst you
can indicate that the message should be written to disk if it ends up in
a durable queue, this is merely guidance: we use quite big buffers in
some carefully chosen places (in the new persister branch) because of
the liklihood that the message will have been delivered to a consumer
and acknowledged quite quickly. As a result, by writing lazily rather
than eagerly, we eliminate 3 disk writes (msg published, msg delivered,
msg acknowledged).

I have no desire to pass comment on ocamlmq. RabbitMQ tries to solve a
very broad category of messaging patterns and requirements. By no means
is it perfect - for some it is too slow, whilst for others it does not
offer enough guarantees. But AMQP does have the advantage of giving a
great amount of flexibility to the user, which is why we believe
RabbitMQ is a sound, general purpose solution for a very broad class of
messaging needs. Careful use of the client libraries and the features
made available by AMQP is frequently sufficient to satisfy most needs.

Matthew
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007561.html">[rabbitmq-discuss] Claim on new ocamlmq broker...
</A></li>
	<LI>Next message: <A HREF="007563.html">[rabbitmq-discuss] Claim on new ocamlmq broker...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7562">[ date ]</a>
              <a href="thread.html#7562">[ thread ]</a>
              <a href="subject.html#7562">[ subject ]</a>
              <a href="author.html#7562">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
