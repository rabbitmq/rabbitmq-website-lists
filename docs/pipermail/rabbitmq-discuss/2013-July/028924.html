<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Push to back of Queue on NAck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Push%20to%20back%20of%20Queue%20on%20NAck&In-Reply-To=%3C51F29EA7.20807%40lshift.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028923.html">
   <LINK REL="Next"  HREF="028926.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Push to back of Queue on NAck</H1>
    <B>Ceri Storey</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Push%20to%20back%20of%20Queue%20on%20NAck&In-Reply-To=%3C51F29EA7.20807%40lshift.net%3E"
       TITLE="[rabbitmq-discuss] Push to back of Queue on NAck">ceri at lshift.net
       </A><BR>
    <I>Fri Jul 26 17:07:03 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028923.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
        <LI>Next message: <A HREF="028926.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28924">[ date ]</a>
              <a href="thread.html#28924">[ thread ]</a>
              <a href="subject.html#28924">[ subject ]</a>
              <a href="author.html#28924">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>(26/07/13 16:49), Tom Anderson wrote:
&gt;<i> Implemented exactly as described there, it yields an infinite loop for
</I>&gt;<i> unprocessable messages. You might therefore also want to keep a count
</I>&gt;<i> of the number of processing attempts in a header on the message, and
</I>&gt;<i> more thoroughly reject messages which reach some maximum number of
</I>&gt;<i> attempts. I think you could do the final rejection by setting a
</I>&gt;<i> routing key on the message when you reject it for the last time, and
</I>&gt;<i> having exchange B be a direct exchange which routes to either queue B
</I>&gt;<i> or some final deadletter queue.
</I>&gt;<i>
</I>&gt;<i> If you want exponential backoff in the retries, then life gets more
</I>&gt;<i> complicated (multiple timeout queues, selected between by a routing
</I>&gt;<i> key set by the consumer of A?). We are currently pussyfooting around
</I>&gt;<i> this issue at my company. I will report back here if we ever implement
</I>&gt;<i> a good solution!
</I>
I've just written some code to do exactly this; limited retries with
exponential backoff. That said, we're kind of cheating in that we store
the retry state in a secondary datastore and buffer messages in the client.

So whenever we receive a message, we:

  * When we post each message, we assign it a unique message_id
  * Lookup message's due time by it's message_id property in our datastore
  * Stash the message in a heap queue
  * When the message becomes due, remove it from the heap queue and pass
    it to the client code.
  * If the client code succeeds, then we finally ack the message.
    Otherwise, we reject the message.

Whilst you can scale this horizontally, you will need enough buffer
space to hold a reasonable proportion of your queue, although/what/
proportion depends on how much you care about timeliness. Also, you are
effectively implementing a secondary queue in your application
(retaining rabbit for it's reliability properties), which seems less
than ideal.


&gt;<i>
</I>&gt;<i> tom
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i>
</I>&gt;<i> Tom Anderson | Developer | +44 20 7826 4312 | timgroup.com
</I>&gt;<i> &lt;<A HREF="http://timgroup.com/">http://timgroup.com/</A>&gt;
</I>&gt;<i>
</I>&gt;<i> STATEMENT OF CONFIDENTIALITY: The information contained in this
</I>&gt;<i> electronic message and any attachments to this message are intended
</I>&gt;<i> for the exclusive use of the addressee(s) and may contain confidential
</I>&gt;<i> or privileged information. If you are not the intended recipient,
</I>&gt;<i> please notify Tom Anderson at TIM Group at <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tom.anderson at timgroup.com</A>
</I>&gt;<i> and destroy all copies of this message and any attachments.
</I>&gt;<i>
</I>&gt;<i> TIM Group is the trading name for YouDevise Limited. YouDevise Limited
</I>&gt;<i> is registered in England, No. 3331176. Registered office: 3 Copthall
</I>&gt;<i> Avenue, London, EC2R 7BH.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130726/4544b7ae/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130726/4544b7ae/attachment.htm</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028923.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
	<LI>Next message: <A HREF="028926.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28924">[ date ]</a>
              <a href="thread.html#28924">[ thread ]</a>
              <a href="subject.html#28924">[ subject ]</a>
              <a href="author.html#28924">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
