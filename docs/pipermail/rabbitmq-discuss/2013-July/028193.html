<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Active-Active implementation issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active-Active%20implementation%20issues&In-Reply-To=%3CCAO68Yr%2Bea2k0%2BGuHD48Z36KY7M-hOKvrr4%2B7207umBrNmZKaVA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028192.html">
   <LINK REL="Next"  HREF="028195.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Active-Active implementation issues</H1>
    <B>Gomathi Nayagam</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active-Active%20implementation%20issues&In-Reply-To=%3CCAO68Yr%2Bea2k0%2BGuHD48Z36KY7M-hOKvrr4%2B7207umBrNmZKaVA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Active-Active implementation issues">sgnayagam at gmail.com
       </A><BR>
    <I>Mon Jul  1 09:33:24 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028192.html">[rabbitmq-discuss] RabbitMQ transaction mode and mandatory bit
</A></li>
        <LI>Next message: <A HREF="028195.html">[rabbitmq-discuss] Active-Active implementation issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28193">[ date ]</a>
              <a href="thread.html#28193">[ thread ]</a>
              <a href="subject.html#28193">[ subject ]</a>
              <a href="author.html#28193">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am trying to implement the active-active High availability Queue and i
have some issues in the implementation. The problem is when we consume
messages from the Mirrored queue if any one of the node is down, we can
able to consume the messages after the node failure. But the consumed
messages after the node failure are still available in the rabbitmq console
even after acking all of the messages.

Some information about the overview of the configuration to test
active-active queues

I have NODE1 in Host1 and NODE2 in Host2. Both of the nodes are in cluster.
I have a Queue named TestQ in NODE1, since i have made this queue (TestQ)
as Mirrored Queue through the policies it is available in Node2 which is
running in Host2.

I am passing the array of Address(Host1, Host2) to get the connection in my
consumer. the code snippet is

Address address1 = new Address(Host1, 5672);
Address address2 = new Address(Host2, 5672);

RabbitmqConsumer consumer = new RabbitmqConsumer(new Address[]{address1,
address2}, queue);

While getting the connection,
Connection conn = connectionFactory.newConnection(addresses);

My use case is as below.

I have 30 messages in TestQ and i can see it in the RabbitMQ console of
Host1,Host2 looks like below

Host1:
Name    Node
TestQ    <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Node2</A>

Host2:
Name    Node
TestQ    <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Node2</A>

In my consumer, I have implemented my own consumer as below.

class MyConsumer extends QueueingConsumer{

    Channel channel;
    public MyConsumer(Channel ch) {
        super(ch);
        this.channel = ch;
    }

    @Override
    public void handleCancel(String consumerTag)  {
        System.out.println(&quot;handleCancel :: consumertag &quot;+consumerTag+&quot;
channel opened &quot;+channel.isOpen()+&quot;,channel &quot;+channel+&quot;, rabbitmq consumer
ch &quot;+RabbitmqConsumer.ch);

    }
}

If i run my consumer, it creates a channel with the reference of
AMQChannel(<A HREF="amqp://guest@Host1:5672/,1">amqp://guest@Host1:5672/,1</A>) and it consumes the messasges from
the TestQ. I have checked the consumer tag of the channel in both of the
host and both are same.

After some of the messages (assume 10 messages) are consumed, i explicitly
down the Node2 by giving the below command

node2$ ./rabbitmqctl stop_app

After the failure of Node2, i can see the print statements which i added in
the handleCancel() method and consumer consumes all of the messages with
out any error. The problem is the even though the remaining 20 messages are
consumed and acked in the consumer, but if i check it in the rabbitmq
console, the 20 messages are still exists in the TestQ.

What i have to do in this scenario to overcome this issue.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130701/24ad62a2/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130701/24ad62a2/attachment.htm</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028192.html">[rabbitmq-discuss] RabbitMQ transaction mode and mandatory bit
</A></li>
	<LI>Next message: <A HREF="028195.html">[rabbitmq-discuss] Active-Active implementation issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28193">[ date ]</a>
              <a href="thread.html#28193">[ thread ]</a>
              <a href="subject.html#28193">[ subject ]</a>
              <a href="author.html#28193">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
