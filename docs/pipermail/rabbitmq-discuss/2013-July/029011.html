<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Trouble with confirms
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Trouble%20with%20confirms&In-Reply-To=%3C51F8F1E1.5080309%40timgroup.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028988.html">
   <LINK REL="Next"  HREF="028931.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Trouble with confirms</H1>
    <B>Tom Anderson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Trouble%20with%20confirms&In-Reply-To=%3C51F8F1E1.5080309%40timgroup.com%3E"
       TITLE="[rabbitmq-discuss] Trouble with confirms">tom.anderson at timgroup.com
       </A><BR>
    <I>Wed Jul 31 12:15:45 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028988.html">[rabbitmq-discuss] Trouble with confirms
</A></li>
        <LI>Next message: <A HREF="028931.html">[rabbitmq-discuss] Getting an error while running rabbitmqctl after upgrading rabbitMQ to latest version 3.1.3.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29011">[ date ]</a>
              <a href="thread.html#29011">[ thread ]</a>
              <a href="subject.html#29011">[ subject ]</a>
              <a href="author.html#29011">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/07/13 17:05, Ceri Storey wrote:
&gt;<i> (30/07/13 16:30), Tom Anderson wrote:
</I>&gt;&gt;<i> On 29/07/13 17:51, Ceri Storey wrote:
</I>&gt;&gt;&gt;<i> (29/07/13 17:25), Tom Anderson wrote:
</I>&gt;&gt;&gt;&gt;<i> On 29/07/13 13:40, Matthias Radestock wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> ...
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Aha. I didn't realise, that, thanks.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> What i'm looking for is a way to get some sort of feedback at the 
</I>&gt;&gt;&gt;&gt;<i> sender when a message has been acknowledged by the consumer. Given 
</I>&gt;&gt;&gt;&gt;<i> that transient messages are confirmed as soon as the message has 
</I>&gt;&gt;&gt;&gt;<i> reached the queue, and persistent messages are confirmed as soon as 
</I>&gt;&gt;&gt;&gt;<i> they are written to disk, am i right in concluding that there is no 
</I>&gt;&gt;&gt;&gt;<i> way to do this with confirms? Is there any other mechanism in 
</I>&gt;&gt;&gt;&gt;<i> RabbitMQ that might let me do this?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> My real goal here is to write a test for an application of ours, to 
</I>&gt;&gt;&gt;&gt;<i> assert that it is only acknowledging messages after it has 
</I>&gt;&gt;&gt;&gt;<i> successfully processed them, and not immediately on receipt. If 
</I>&gt;&gt;&gt;&gt;<i> anyone has any thoughts on how i might be able to do that, i would 
</I>&gt;&gt;&gt;&gt;<i> be very excited to hear them!
</I>&gt;&gt;&gt;<i> For your test, I'd be very tempted to provide an adapter which 
</I>&gt;&gt;&gt;<i> enforces the guarantees you want to make. Then you can have tests that:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   * For the happy path, asserts that no more messages exist on the
</I>&gt;&gt;&gt;<i>     expected (ie: that a basic.get will return no messages)
</I>&gt;&gt;&gt;<i>   * For the failure path, asserts that the sent message is available
</I>&gt;&gt;&gt;<i>     to other consumers once your adapter has properly failed and
</I>&gt;&gt;&gt;<i>     shut down.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Granted, the latter does assume that you can shut down the adapter 
</I>&gt;&gt;&gt;<i> reasonably easily.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Apologies if i'm being thick, but what do you mean by &quot;adapter&quot;? Do 
</I>&gt;&gt;<i> you mean code that sits between the application code and the AMQP 
</I>&gt;&gt;<i> library? Or code that the test can use to take a grip on the 
</I>&gt;&gt;<i> application code? Or something else?
</I>&gt;<i> Yes, sorry, that's it, so it's an interface to external infrastructure 
</I>&gt;<i> (in this case Rabbit), that presents itself in terms of something 
</I>&gt;<i> relevant to your application. So in my case, I tell it what what kinds 
</I>&gt;<i> of job I want to receive, and it would call back to another object 
</I>&gt;<i> when there is a job to be done. It's a term pulled from Alistair 
</I>&gt;<i> Cockburn's Hexagonal Architecture 
</I>&gt;<i> &lt;<A HREF="http://alistair.cockburn.us/Hexagonal+architecture">http://alistair.cockburn.us/Hexagonal+architecture</A>&gt;, FWIW.
</I>
Maybe also similar to Nat Pryce's 'simplicator' then:

<A HREF="http://www.natpryce.com/articles/000785.html">http://www.natpryce.com/articles/000785.html</A>

The thing is, what i really want to test, because it's the thing i have 
most uncertainty about, is my usage of the RabbitMQ API. That would be 
in the adaptor. So, introducing that adaptor would let me write tests 
around the logic inside the application, but they would be rather 
vacuous, and they would leave the scary bit untested.

It is probably still worth driving a plane of fracture through the 
system above the RabbitMQ API and unit-testing that, though. I can then 
at least be confident that bugs are boxed into the API-using code, and 
then write the best end-to-end integration test i can manage, even if 
it's not rock solid.

tom

-- 

Tom Anderson | Developer | +44 20 7826 4312 | timgroup.com 
&lt;<A HREF="http://timgroup.com/">http://timgroup.com/</A>&gt;

STATEMENT OF CONFIDENTIALITY: The information contained in this 
electronic message and any attachments to this message are intended for 
the exclusive use of the addressee(s) and may contain confidential or 
privileged information. If you are not the intended recipient, please 
notify Tom Anderson at TIM Group at <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tom.anderson at timgroup.com</A> and 
destroy all copies of this message and any attachments.

TIM Group is the trading name for YouDevise Limited. YouDevise Limited 
is registered in England, No. 3331176. Registered office: 3 Copthall 
Avenue, London, EC2R 7BH.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130731/dfa92dfb/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130731/dfa92dfb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028988.html">[rabbitmq-discuss] Trouble with confirms
</A></li>
	<LI>Next message: <A HREF="028931.html">[rabbitmq-discuss] Getting an error while running rabbitmqctl after upgrading rabbitMQ to latest version 3.1.3.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29011">[ date ]</a>
              <a href="thread.html#29011">[ thread ]</a>
              <a href="subject.html#29011">[ subject ]</a>
              <a href="author.html#29011">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
