<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Odd%20Behavior%20w/%20Restoring%20Broken%20Cluster&In-Reply-To=%3C51DD0593.5030100%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028398.html">
   <LINK REL="Next"  HREF="028399.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Odd%20Behavior%20w/%20Restoring%20Broken%20Cluster&In-Reply-To=%3C51DD0593.5030100%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster">matthias at rabbitmq.com
       </A><BR>
    <I>Wed Jul 10 07:56:19 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028398.html">[rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster
</A></li>
        <LI>Next message: <A HREF="028399.html">[rabbitmq-discuss] Monitor and restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28435">[ date ]</a>
              <a href="thread.html#28435">[ thread ]</a>
              <a href="subject.html#28435">[ subject ]</a>
              <a href="author.html#28435">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Chris,

apologies for the late reply...

On 08/07/13 16:11, Chris wrote:
&gt;<i> I noticed some odd behavior when trying to restore a broken cluster
</I>&gt;<i> that I think may be a bug.
</I>&gt;<i> [...]
</I>&gt;<i>     *[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# rabbitmqctl stop*
</I>&gt;<i>     Stopping and halting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-a</A>' ...
</I>&gt;<i>
</I>&gt;<i>     =INFO REPORT==== 8-Jul-2013::09:45:48 ===
</I>&gt;<i>     Halting Erlang VM
</I>&gt;<i>     Error: {{badmatch,undefined},
</I>&gt;<i>
</I>&gt;<i>     [{rabbit_plugins,active,0,[{file,&quot;src/rabbit_plugins.erl&quot;},{line,48}]},
</I>&gt;<i>
</I>&gt;<i>       {rabbit,app_shutdown_order,0,[{file,&quot;src/rabbit.erl&quot;},{line,476}]},
</I>&gt;<i>               {rabbit,stop,0,[{file,&quot;src/rabbit.erl&quot;},{line,380}]},
</I>&gt;<i>               {rabbit,stop_and_halt,0,[{file,&quot;src/rabbit.erl&quot;},{line,384}]},
</I>&gt;<i>
</I>&gt;<i>       {rpc,'-handle_call_call/6-fun-0-',5,[{file,&quot;rpc.erl&quot;},{line,205}]}]}
</I>
Yep, that's a bug.

&gt;<i>     *[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# rabbitmqctl reset*
</I>&gt;<i>     Resetting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>' ...
</I>&gt;<i>
</I>&gt;<i>     =INFO REPORT==== 8-Jul-2013::09:49:29 ===
</I>&gt;<i>     Resetting Rabbit
</I>&gt;<i>
</I>&gt;<i>     =INFO REPORT==== 8-Jul-2013::09:49:29 ===
</I>&gt;<i>          application: mnesia
</I>&gt;<i>          exited: stopped
</I>&gt;<i>          type: temporary
</I>&gt;<i>     Error: {version_mismatch,[],
</I>&gt;<i>                               [add_ip_to_listener,exchange_decorators,
</I>&gt;<i>                                exchange_event_serial,gm,gm_pids,
</I>&gt;<i>                                mirrored_supervisor,remove_user_scope,
</I>&gt;<i>
</I>&gt;<i>     runtime_parameters,semi_durable_route,topic_trie,
</I>&gt;<i>
</I>&gt;<i>     topic_trie_node,user_admin_to_tags,add_queue_ttl,
</I>&gt;<i>                                multiple_routing_keys]}
</I>
And that is a bug too. Running force_reset instead would probably avoid 
this error.

&gt;<i>   But here is the WEIRD thing.  Now go back to rabbit-a and get the
</I>&gt;<i> cluster_status.  It seems that rabbit-b has magically rejoined the cluster!/
</I>&gt;<i> /
</I>&gt;<i> /
</I>&gt;<i>
</I>&gt;<i>     *[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-a</A> ~]# rabbitmqctl cluster_status*
</I>&gt;<i>     Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-a</A>' ...
</I>&gt;<i>     [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-a</A>']}]},
</I>&gt;<i>       {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-a</A>']},
</I>&gt;<i>       {partitions,[]}]
</I>&gt;<i>     ...done.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sure enough, if we restart rabbit-b, it will be operating in a cluster
</I>&gt;<i> with rabbit-a again:
</I>&gt;<i>
</I>&gt;<i>     *[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# unset RABBITMQ_NODE_ONLY*
</I>&gt;<i>     *[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# rabbitmq-server &amp;*
</I>&gt;<i>     [1] 15775
</I>&gt;<i>     *[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# rabbitmqctl cluster_status*
</I>&gt;<i>     Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>' ...
</I>&gt;<i>     [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-a</A>']}]},
</I>&gt;<i>       {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-rh62-cmoesel</A>','rabbitmq-b']},
</I>&gt;<i>       {partitions,[]}]
</I>&gt;<i>     ...done.
</I>
And that is another bug.

&gt;<i> I guess in this case I will just delete the mnesia directory instead
</I>&gt;<i> of trying to do a reset.
</I>
force_reset should do the trick.


Thanks for reporting this.


Regards,

Matthias.
</PRE>


























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028398.html">[rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster
</A></li>
	<LI>Next message: <A HREF="028399.html">[rabbitmq-discuss] Monitor and restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28435">[ date ]</a>
              <a href="thread.html#28435">[ thread ]</a>
              <a href="subject.html#28435">[ subject ]</a>
              <a href="author.html#28435">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
