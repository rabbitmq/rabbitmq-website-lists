<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Recipe for corrupting mnesia in a cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Recipe%20for%20corrupting%20mnesia%20in%20a%20cluster&In-Reply-To=%3CCAHEpgBDUwOPqKa%3D%3D21_T1YfWQ09HhnLrMp%3Dbuvi7ySf-XLHbPA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028798.html">
   <LINK REL="Next"  HREF="028849.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Recipe for corrupting mnesia in a cluster</H1>
    <B>Chris</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Recipe%20for%20corrupting%20mnesia%20in%20a%20cluster&In-Reply-To=%3CCAHEpgBDUwOPqKa%3D%3D21_T1YfWQ09HhnLrMp%3Dbuvi7ySf-XLHbPA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Recipe for corrupting mnesia in a cluster">stuff at moesel.net
       </A><BR>
    <I>Tue Jul 23 15:39:16 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028798.html">[rabbitmq-discuss] Local time in overview charts?
</A></li>
        <LI>Next message: <A HREF="028849.html">[rabbitmq-discuss] Recipe for corrupting mnesia in a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28799">[ date ]</a>
              <a href="thread.html#28799">[ thread ]</a>
              <a href="subject.html#28799">[ subject ]</a>
              <a href="author.html#28799">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi All,

We are using RabbitMQ 3.1.1 / Erlang R16B on Redhat EL 6.2.  We've
discovered a scenario that can corrupt the RabbitMQ databases pretty
consistently, and are wondering if you might have some suggestions for
prevention (or might want to consider a fix if possible).

In short, if you are running two nodes in a cluster, and there are active
connections, cutting the power to both nodes in short succession can
corrupt both databases.  This can be easily reproduced with &quot;reboot -nf&quot; as
well.

To reproduce:

   - Make sure both nodes are properly running in the cluster
   - Make sure there are active connections to the nodes (doesn't always
   reproduce otherwise)
   - On Node1, execute: reboot -nf
   - Within a few seconds, on Node2, execute: reboot -nf
   - When they come back up again, you will not be able to start RabbitMQ

If you look at the logs you will see the following errors:

=INFO REPORT==== 23-Jul-2013::09:43:55 ===
Starting RabbitMQ 3.1.1 on Erlang R16B
Copyright (C) 2007-2013 VMware, Inc.
Licensed under the MPL.  See <A HREF="http://www.rabbitmq.com/">http://www.rabbitmq.com/</A>

=INFO REPORT==== 23-Jul-2013::09:43:55 ===
node           : <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node1</A>
home dir       : /var/lib/rabbitmq
config file(s) : (none)
cookie hash    : PRImCFlol1hmJpetFO7NUg==
log            : /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node1.log</A>
sasl log       : /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node1-sasl.log</A>
database dir   : /var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node1</A>

=INFO REPORT==== 23-Jul-2013::09:43:56 ===
Limiting to approx 3996 file handles (3594 sockets)

=INFO REPORT==== 23-Jul-2013::09:44:26 ===
Timeout contacting cluster nodes: ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A>'].

DIAGNOSTICS
===========

nodes in question: ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A>']

hosts, their running nodes and ports:
- node2: []

current node details:
- node name: '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node1</A>'
- home dir: /var/lib/rabbitmq
- cookie hash: PRImCFlol1hmJpetFO7NUg==



=INFO REPORT==== 23-Jul-2013::09:44:27 ===
Error description:
   {could_not_start,rabbit,
       {bad_return,
           {{rabbit,start,[normal,[]]},
            {'EXIT',
                {rabbit,failure_during_boot,
                    {error,
                        {timeout_waiting_for_tables,

[rabbit_user,rabbit_user_permission,rabbit_vhost,
                             rabbit_durable_route,rabbit_durable_exchange,
                             rabbit_runtime_parameters,
                             rabbit_durable_queue]}}}}}}}

Log files (may contain more information):
   /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node1.log</A>
   /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node1-sasl.log</A>


The only way I've been able to fix this is by deleting the contents of
mnesia on both nodes and re-clustering them.  Aside from requiring manual
intervention, this of course also causes data loss.

I know this is a bit of an edge case, but it has already happened to some
of our customers.  I guess in the case of a power outage (with no UPS!) it
is pretty likely.  Does anyone have any thoughts on it?  Is it something
that can be resolved or is it one of those cases where there's really
nothing that can be done?

Thanks!
Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130723/5583cb97/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130723/5583cb97/attachment.htm</A>&gt;
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028798.html">[rabbitmq-discuss] Local time in overview charts?
</A></li>
	<LI>Next message: <A HREF="028849.html">[rabbitmq-discuss] Recipe for corrupting mnesia in a cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28799">[ date ]</a>
              <a href="thread.html#28799">[ thread ]</a>
              <a href="subject.html#28799">[ subject ]</a>
              <a href="author.html#28799">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
