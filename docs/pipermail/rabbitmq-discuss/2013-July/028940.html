<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Push to back of Queue on NAck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Push%20to%20back%20of%20Queue%20on%20NAck&In-Reply-To=%3CCE1AE6EF.1D51D%25stefan.kaes%40xing.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028936.html">
   <LINK REL="Next"  HREF="028941.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Push to back of Queue on NAck</H1>
    <B>Stefan Kaes</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Push%20to%20back%20of%20Queue%20on%20NAck&In-Reply-To=%3CCE1AE6EF.1D51D%25stefan.kaes%40xing.com%3E"
       TITLE="[rabbitmq-discuss] Push to back of Queue on NAck">Stefan.Kaes at xing.com
       </A><BR>
    <I>Sun Jul 28 15:45:43 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028936.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
        <LI>Next message: <A HREF="028941.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28940">[ date ]</a>
              <a href="thread.html#28940">[ thread ]</a>
              <a href="subject.html#28940">[ subject ]</a>
              <a href="author.html#28940">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I tried this, with a slight modification:

Instead of having a dedicated second exchange, I use the default exchange and set the routing key to the name of the queue I want it routed to.

Queue A, no TTL, x-dead-letter-exchange='', x-dead-letter-routing-key='B'
Queue B, ttl of (x) seconds, x-dead-letter-exchange='', x-dead-letter-routing-key='A'

Works like a charm.

However, there's a problem, which I think will prevent us from using this approach:

The size of the x-death header attached to the message grows linearly with the number of dead lettering events.

This is bad for performance, and in the worst case could crash rabbitmq with an out of memory error, if for some reason a message gets rejected a high number of times (or indefinitely).

It would be great if the x-death header could be limited to have only a bounded number entries, say the last 10 events.

Plus maybe the total number of redirects.

Cheers,

Stefan Kaes



On Fri, Jul 26, 2013 at 11:18 PM, Matthias Radestock &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;&gt; wrote:
Queue A, no TTL, DLX=Exchange B (with Queue B bound to it).
Queue B, ttl of (x) seconds, DLX= Exchange A (with Queue A bound to it).

When we NAck the mesage from Queue A, we set requeue=false.

Yep, that makes perfect sense and should work well.


I'll give the using-deadletter-exchange with NAck approach a go.



On Sat, Jul 27, 2013 at 1:49 AM, Tom Anderson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tom.anderson at timgroup.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tom.anderson at timgroup.com</A>&gt;&gt; wrote:

Implemented exactly as described there, it yields an infinite loop for unprocessable messages. You might therefore also want to keep a count of the number of processing attempts in a header on the message, and more thoroughly reject messages which reach some maximum number of attempts. I think you could do the final rejection by setting a routing key on the message when you reject it for the last time, and having exchange B be a direct exchange which routes to either queue B or some final deadletter queue.


Yep, we've got other ways to deal with permanent failures/poison messages.
This is purely to deal with transient problems where we might need to try several times.


Thanks for the feedback and discussion everyone.
Cheers

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130728/00d695ef/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130728/00d695ef/attachment.htm</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028936.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
	<LI>Next message: <A HREF="028941.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28940">[ date ]</a>
              <a href="thread.html#28940">[ thread ]</a>
              <a href="subject.html#28940">[ subject ]</a>
              <a href="author.html#28940">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
