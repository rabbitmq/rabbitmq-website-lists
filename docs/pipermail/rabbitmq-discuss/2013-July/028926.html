<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Push to back of Queue on NAck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Push%20to%20back%20of%20Queue%20on%20NAck&In-Reply-To=%3C51F2ABDA.9020709%40timgroup.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028924.html">
   <LINK REL="Next"  HREF="028932.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Push to back of Queue on NAck</H1>
    <B>Tom Anderson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Push%20to%20back%20of%20Queue%20on%20NAck&In-Reply-To=%3C51F2ABDA.9020709%40timgroup.com%3E"
       TITLE="[rabbitmq-discuss] Push to back of Queue on NAck">tom.anderson at timgroup.com
       </A><BR>
    <I>Fri Jul 26 18:03:22 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028924.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
        <LI>Next message: <A HREF="028932.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28926">[ date ]</a>
              <a href="thread.html#28926">[ thread ]</a>
              <a href="subject.html#28926">[ subject ]</a>
              <a href="author.html#28926">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/07/13 17:07, Ceri Storey wrote:
&gt;<i> (26/07/13 16:49), Tom Anderson wrote:
</I>&gt;&gt;<i> Implemented exactly as described there, it yields an infinite loop 
</I>&gt;&gt;<i> for unprocessable messages. You might therefore also want to keep a 
</I>&gt;&gt;<i> count of the number of processing attempts in a header on the 
</I>&gt;&gt;<i> message, and more thoroughly reject messages which reach some maximum 
</I>&gt;&gt;<i> number of attempts. I think you could do the final rejection by 
</I>&gt;&gt;<i> setting a routing key on the message when you reject it for the last 
</I>&gt;&gt;<i> time, and having exchange B be a direct exchange which routes to 
</I>&gt;&gt;<i> either queue B or some final deadletter queue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you want exponential backoff in the retries, then life gets more 
</I>&gt;&gt;<i> complicated (multiple timeout queues, selected between by a routing 
</I>&gt;&gt;<i> key set by the consumer of A?). We are currently pussyfooting around 
</I>&gt;&gt;<i> this issue at my company. I will report back here if we ever 
</I>&gt;&gt;<i> implement a good solution!
</I>&gt;<i>
</I>&gt;<i> I've just written some code to do exactly this; limited retries with 
</I>&gt;<i> exponential backoff. That said, we're kind of cheating in that we 
</I>&gt;<i> store the retry state in a secondary datastore and buffer messages in 
</I>&gt;<i> the client.
</I>&gt;<i>
</I>&gt;<i> So whenever we receive a message, we:
</I>&gt;<i>
</I>&gt;<i>   * When we post each message, we assign it a unique message_id
</I>&gt;<i>   * Lookup message's due time by it's message_id property in our datastore
</I>&gt;<i>   * Stash the message in a heap queue
</I>&gt;<i>   * When the message becomes due, remove it from the heap queue and
</I>&gt;<i>     pass it to the client code.
</I>&gt;<i>   * If the client code succeeds, then we finally ack the message.
</I>&gt;<i>     Otherwise, we reject the message.
</I>&gt;<i>
</I>
I'm currently writing almost exactly the same thing! The difference 
being that i'm putting the due time in a header on the message rather 
than in a lookaside store, and that my component moves messages from a 
queue to an exchange, rather than from a queue to client code directly.

&gt;<i> Whilst you can scale this horizontally, you will need enough buffer 
</I>&gt;<i> space to hold a reasonable proportion of your queue, although/what/ 
</I>&gt;<i> proportion depends on how much you care about timeliness.
</I>&gt;<i>
</I>
I'm not sure i understand. Don't you need to have enough space to hold 
all the messages that could be delayed at any given time? In our case, 
that happens to not be all that large, fortunately.

&gt;<i> Also, you are effectively implementing a secondary queue in your 
</I>&gt;<i> application (retaining rabbit for it's reliability properties), which 
</I>&gt;<i> seems less than ideal.
</I>&gt;<i>
</I>
Yes. We did kick around the idea of writing a custom exchange to do 
this, but that sounded really scary.

tom

-- 

Tom Anderson | Developer | +44 20 7826 4312 | timgroup.com 
&lt;<A HREF="http://timgroup.com/">http://timgroup.com/</A>&gt;

STATEMENT OF CONFIDENTIALITY: The information contained in this 
electronic message and any attachments to this message are intended for 
the exclusive use of the addressee(s) and may contain confidential or 
privileged information. If you are not the intended recipient, please 
notify Tom Anderson at TIM Group at <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tom.anderson at timgroup.com</A> and 
destroy all copies of this message and any attachments.

TIM Group is the trading name for YouDevise Limited. YouDevise Limited 
is registered in England, No. 3331176. Registered office: 3 Copthall 
Avenue, London, EC2R 7BH.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130726/dd99613a/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130726/dd99613a/attachment.htm</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028924.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
	<LI>Next message: <A HREF="028932.html">[rabbitmq-discuss] Push to back of Queue on NAck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28926">[ date ]</a>
              <a href="thread.html#28926">[ thread ]</a>
              <a href="subject.html#28926">[ subject ]</a>
              <a href="author.html#28926">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
