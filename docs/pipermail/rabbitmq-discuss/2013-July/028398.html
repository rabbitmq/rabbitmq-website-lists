<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Odd%20Behavior%20w/%20Restoring%20Broken%20Cluster&In-Reply-To=%3CCAHEpgBCWo_icdGXmn4mFGZT7GJh_9qLPftyoL6MoYQMsQ_khUQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028550.html">
   <LINK REL="Next"  HREF="028435.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster</H1>
    <B>Chris</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Odd%20Behavior%20w/%20Restoring%20Broken%20Cluster&In-Reply-To=%3CCAHEpgBCWo_icdGXmn4mFGZT7GJh_9qLPftyoL6MoYQMsQ_khUQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster">stuff at moesel.net
       </A><BR>
    <I>Mon Jul  8 16:11:03 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028550.html">[rabbitmq-discuss] Checking queue size in bytes
</A></li>
        <LI>Next message: <A HREF="028435.html">[rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28398">[ date ]</a>
              <a href="thread.html#28398">[ thread ]</a>
              <a href="subject.html#28398">[ subject ]</a>
              <a href="author.html#28398">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I am using RabbitMQ 3.1.1 on RedHat 6.2.  I noticed some odd behavior when
trying to restore a broken cluster that I think may be a bug.  In short,
when I &quot;forget&quot; a node in the cluster, then later call &quot;rabbitmqctl reset&quot;
on it, it re-adds itself to the cluster.

It's actually more complicated than that, but completely reproducible, so
here are the steps:

*Assuming two nodes in a cluster: rabbit-a and rabbit-b.  *
*
*

*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# rabbitmqctl stop*
Stopping and halting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-a</A>' ...
...done.

*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-b</A> ~]# rabbitmqctl stop*
Stopping and halting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-b</A>' ...
...done.

*
*
*Now we will assume we need to start rabbit-a without rabbit-b, which is
all sorts of fun since rabbit-b was the last one down.  Based on what I've
read, we need to start rabbit-a in node-only mode and then forget rabbit-b.*
*
*

*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# export RABBITMQ_NODE_ONLY=true*
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# rabbitmq-server &amp;*
[1] 19386
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# rabbitmqctl forget_cluster_node --offline
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-b</A>*
Removing node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-b</A>' from cluster ...

=INFO REPORT==== 8-Jul-2013::09:45:34 ===
Removing node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-b</A>' from cluster

=INFO REPORT==== 8-Jul-2013::09:45:34 ===
    application: mnesia
    exited: stopped
    type: temporary
...done.
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# rabbitmqctl stop*
Stopping and halting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-a</A>' ...

=INFO REPORT==== 8-Jul-2013::09:45:48 ===
Halting Erlang VM
Error: {{badmatch,undefined},

[{rabbit_plugins,active,0,[{file,&quot;src/rabbit_plugins.erl&quot;},{line,48}]},
         {rabbit,app_shutdown_order,0,[{file,&quot;src/rabbit.erl&quot;},{line,476}]},
         {rabbit,stop,0,[{file,&quot;src/rabbit.erl&quot;},{line,380}]},
         {rabbit,stop_and_halt,0,[{file,&quot;src/rabbit.erl&quot;},{line,384}]},

 {rpc,'-handle_call_call/6-fun-0-',5,[{file,&quot;rpc.erl&quot;},{line,205}]}]}


*Note the error above when it was stopped-- I'm not sure if that is
expected.  Anyway, let's now turn off the node-only mode and start the
server again.  It's successful and note that the cluster status contains
only its own node:*

*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# unset RABBITMQ_NODE_ONLY*
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# rabbitmq-server &amp;*
[1] 21349
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbit-a</A> ~]# rabbitmqctl cluster_status*
Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-a</A>' ...
[{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-a</A>']}]},
 {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-a</A>']},
 {partitions,[]}]
...done.


*So far so good.  But let's assume we're ready to bring rabbit-b back
online.  If we try without making any changes, it will fail due to this
error (which I guess is expected):*

{&quot;init terminating in
do_boot&quot;,{rabbit,failure_during_boot,{error,{inconsistent_cluster,&quot;Node
'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-b</A>' thinks it's clustered with node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-a</A>', but
'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit-a</A>' disagrees&quot;}}}}


*OK.  So I guess we need to reset rabbit-b before we can start it again.  I
know we could delete the mnesia directory, but let's not be so brute force
about it.  Let's put it in node-only mode and use rabbitmqctl reset:*
*
*

*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# export RABBITMQ_NODE_ONLY=true*
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# rabbitmq-server &amp;*
[1] 13647
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# rabbitmqctl reset*
Resetting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>' ...

=INFO REPORT==== 8-Jul-2013::09:49:29 ===
Resetting Rabbit

=INFO REPORT==== 8-Jul-2013::09:49:29 ===
    application: mnesia
    exited: stopped
    type: temporary
Error: {version_mismatch,[],
                         [add_ip_to_listener,exchange_decorators,
                          exchange_event_serial,gm,gm_pids,
                          mirrored_supervisor,remove_user_scope,
                          runtime_parameters,semi_durable_route,topic_trie,
                          topic_trie_node,user_admin_to_tags,add_queue_ttl,
                          multiple_routing_keys]}
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# rabbitmqctl stop*
Stopping and halting node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>' ...


=INFO REPORT==== 8-Jul-2013::09:50:23 ===
Halting Erlang VM
Error: {{badmatch,undefined},

[{rabbit_plugins,active,0,[{file,&quot;src/rabbit_plugins.erl&quot;},{line,48}]},
         {rabbit,app_shutdown_order,0,[{file,&quot;src/rabbit.erl&quot;},{line,476}]},
         {rabbit,stop,0,[{file,&quot;src/rabbit.erl&quot;},{line,380}]},
         {rabbit,stop_and_halt,0,[{file,&quot;src/rabbit.erl&quot;},{line,384}]},

 {rpc,'-handle_call_call/6-fun-0-',5,[{file,&quot;rpc.erl&quot;},{line,205}]}]}


*Note again the error when stopping, but also the error when resetting.
 But here is the WEIRD thing.  Now go back to rabbit-a and get the
cluster_status.  It seems that rabbit-b has magically rejoined the cluster!*
*
*

*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-a</A> ~]# rabbitmqctl cluster_status*
Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-a</A>' ...
[{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-a</A>']}]},
 {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-a</A>']},
 {partitions,[]}]
...done.


Sure enough, if we restart rabbit-b, it will be operating in a cluster with
rabbit-a again:

*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# unset RABBITMQ_NODE_ONLY*
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# rabbitmq-server &amp;*
[1] 15775
*[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at rabbitmq-b</A> ~]# rabbitmqctl cluster_status*
Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>' ...
[{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-b</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbitmq-a</A>']}]},
 {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm-rh62-cmoesel</A>','rabbitmq-b']},
 {partitions,[]}]
...done.


So-- this is not at all what I expected.  Seems like a bug, right?  I guess
in this case I will just delete the mnesia directory instead of trying to
do a reset.

-Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130708/39fad031/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130708/39fad031/attachment.htm</A>&gt;
</PRE>










































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028550.html">[rabbitmq-discuss] Checking queue size in bytes
</A></li>
	<LI>Next message: <A HREF="028435.html">[rabbitmq-discuss] Odd Behavior w/ Restoring Broken Cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28398">[ date ]</a>
              <a href="thread.html#28398">[ thread ]</a>
              <a href="subject.html#28398">[ subject ]</a>
              <a href="author.html#28398">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
