<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Active-Active implementation issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active-Active%20implementation%20issues&In-Reply-To=%3CCAO68YrLA1-D641E5v0xQz4%2BqMW%3DObe31mXi2dmFvZVmn7R37WQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028200.html">
   <LINK REL="Next"  HREF="028326.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Active-Active implementation issues</H1>
    <B>Gomathi Nayagam</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active-Active%20implementation%20issues&In-Reply-To=%3CCAO68YrLA1-D641E5v0xQz4%2BqMW%3DObe31mXi2dmFvZVmn7R37WQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Active-Active implementation issues">sgnayagam at gmail.com
       </A><BR>
    <I>Mon Jul  1 11:57:22 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="028200.html">[rabbitmq-discuss] Publish to exchange that doesn't bind to any queue in trunsaction mode
</A></li>
        <LI>Next message: <A HREF="028326.html">[rabbitmq-discuss] Active-Active implementation issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28203">[ date ]</a>
              <a href="thread.html#28203">[ thread ]</a>
              <a href="subject.html#28203">[ subject ]</a>
              <a href="author.html#28203">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

Thanks for the reply.

My inline response are below.

---------- Forwarded message ----------
From: Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;
Date: Mon, Jul 1, 2013 at 2:44 PM
Subject: Re: [rabbitmq-discuss] Active-Active implementation issues
To: Discussions about RabbitMQ &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
Cc: Gomathi Nayagam &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">sgnayagam at gmail.com</A>&gt;


Hi. Couple of points:

1) It's not *guaranteed* that after you acknowledge a message you will
never see it again after failover - the ack has to travel across the
network and be received by the broker, and if failover happens between the
broker sending the message out and receiving an ack then you will see the
message again.

[Reply] I agree with this point.


2) If this is not happening, make sure you are acknowledging the messages
correctly - make sure they vanish from the console when failover is not an
issue.

[Reply] Let's take the below example, the queue has 20 messages and after
13 messages are consumed (11 messages are acked, 2 messages ack are not
reached to broker) Node1 is down. So in the Node2 we could see 9 messages.
But the consumer consumes and acked all 9 messages (i can get the print
statements inside handleCancel()) during the fail over, but the messages
are not vanishing from the console. It leads to duplication of messages.

Thanks



On Mon, Jul 1, 2013 at 3:31 PM, Gomathi Nayagam &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">sgnayagam at gmail.com</A>&gt; wrote:

&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i> Thanks for the reply.
</I>&gt;<i>
</I>&gt;<i> My inline response are below.
</I>&gt;<i>
</I>&gt;<i> ---------- Forwarded message ----------
</I>&gt;<i> From: Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;
</I>&gt;<i> Date: Mon, Jul 1, 2013 at 2:44 PM
</I>&gt;<i> Subject: Re: [rabbitmq-discuss] Active-Active implementation issues
</I>&gt;<i> To: Discussions about RabbitMQ &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i> Cc: Gomathi Nayagam &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">sgnayagam at gmail.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hi. Couple of points:
</I>&gt;<i>
</I>&gt;<i> 1) It's not *guaranteed* that after you acknowledge a message you will
</I>&gt;<i> never see it again after failover - the ack has to travel across the
</I>&gt;<i> network and be received by the broker, and if failover happens between the
</I>&gt;<i> broker sending the message out and receiving an ack then you will see the
</I>&gt;<i> message again.
</I>&gt;<i>
</I>&gt;<i> [Reply] I agree with this point.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2) If this is not happening, make sure you are acknowledging the messages
</I>&gt;<i> correctly - make sure they vanish from the console when failover is not an
</I>&gt;<i> issue.
</I>&gt;<i>
</I>&gt;<i> [Reply] Let's take the below example, the queue has 20 messages and after
</I>&gt;<i> 13 messages are consumed (11 messages are acked, 2 messages ack are not
</I>&gt;<i> reached to broker) Node1 is down. So in the Node2 we could see 9 messages.
</I>&gt;<i> But the consumer consumes and acked all 9 messages (i can get the print
</I>&gt;<i> statements inside handleCancel()) during the fail over, but the messages
</I>&gt;<i> are not vanishing from the console. It leads to duplication of messages.
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 01/07/2013 09:33, Gomathi Nayagam wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I am trying to implement the active-active High availability Queue and i
</I>&gt;&gt;<i> have some issues in the implementation. The problem is when we consume
</I>&gt;&gt;<i> messages from the Mirrored queue if any one of the node is down, we can
</I>&gt;&gt;<i> able to consume the messages after the node failure. But the consumed
</I>&gt;&gt;<i> messages after the node failure are still available in the rabbitmq
</I>&gt;&gt;<i> console even after acking all of the messages.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Some information about the overview of the configuration to test
</I>&gt;&gt;<i> active-active queues
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have NODE1 in Host1 and NODE2 in Host2. Both of the nodes are in
</I>&gt;&gt;<i> cluster. I have a Queue named TestQ in NODE1, since i have made this
</I>&gt;&gt;<i> queue (TestQ) as Mirrored Queue through the policies it is available in
</I>&gt;&gt;<i> Node2 which is running in Host2.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am passing the array of Address(Host1, Host2) to get the connection in
</I>&gt;&gt;<i> my consumer. the code snippet is
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Address address1 = new Address(Host1, 5672);
</I>&gt;&gt;<i> Address address2 = new Address(Host2, 5672);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> RabbitmqConsumer consumer = new RabbitmqConsumer(new Address[]{address1,
</I>&gt;&gt;<i> address2}, queue);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> While getting the connection,
</I>&gt;&gt;<i> Connection conn = connectionFactory.**newConnection(addresses);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My use case is as below.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have 30 messages in TestQ and i can see it in the RabbitMQ console of
</I>&gt;&gt;<i> Host1,Host2 looks like below
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Host1:
</I>&gt;&gt;<i> Name    Node
</I>&gt;&gt;<i> TestQ    <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Node2</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Host2:
</I>&gt;&gt;<i> Name    Node
</I>&gt;&gt;<i> TestQ    <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at Node2</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In my consumer, I have implemented my own consumer as below.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class MyConsumer extends QueueingConsumer{
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Channel channel;
</I>&gt;&gt;<i>      public MyConsumer(Channel ch) {
</I>&gt;&gt;<i>          super(ch);
</I>&gt;&gt;<i>          this.channel = ch;
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      @Override
</I>&gt;&gt;<i>      public void handleCancel(String consumerTag)  {
</I>&gt;&gt;<i>          System.out.println(&quot;**handleCancel :: consumertag
</I>&gt;&gt;<i> &quot;+consumerTag+&quot;
</I>&gt;&gt;<i> channel opened &quot;+channel.isOpen()+&quot;,channel &quot;+channel+&quot;, rabbitmq
</I>&gt;&gt;<i> consumer ch &quot;+RabbitmqConsumer.ch);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If i run my consumer, it creates a channel with the reference of
</I>&gt;&gt;<i> AMQChannel(<A HREF="amqp://guest@Host1:**5672/,1">amqp://guest@Host1:**5672/,1</A>) and it consumes the messasges
</I>&gt;&gt;<i> from the TestQ. I have checked the consumer tag of the channel in both
</I>&gt;&gt;<i> of the host and both are same.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After some of the messages (assume 10 messages) are consumed, i
</I>&gt;&gt;<i> explicitly down the Node2 by giving the below command
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> node2$ ./rabbitmqctl stop_app
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After the failure of Node2, i can see the print statements which i added
</I>&gt;&gt;<i> in the handleCancel() method and consumer consumes all of the messages
</I>&gt;&gt;<i> with out any error. The problem is the even though the remaining 20
</I>&gt;&gt;<i> messages are consumed and acked in the consumer, but if i check it in
</I>&gt;&gt;<i> the rabbitmq console, the 20 messages are still exists in the TestQ.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What i have to do in this scenario to overcome this issue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ______________________________**_________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.</A>**rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130701/614d0894/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130701/614d0894/attachment.htm</A>&gt;
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028200.html">[rabbitmq-discuss] Publish to exchange that doesn't bind to any queue in trunsaction mode
</A></li>
	<LI>Next message: <A HREF="028326.html">[rabbitmq-discuss] Active-Active implementation issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28203">[ date ]</a>
              <a href="thread.html#28203">[ thread ]</a>
              <a href="subject.html#28203">[ subject ]</a>
              <a href="author.html#28203">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
