<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Rabbitmq falling over &amp; losing messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Rabbitmq%20falling%20over%20%26%20losing%20messages&In-Reply-To=8E98F3D7-4904-4159-81E5-0E8D2FC0D71B%40uszla.me.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002179.html">
   <LINK REL="Next"  HREF="002180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages</H1>
    <B>Ben Hood</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Rabbitmq%20falling%20over%20%26%20losing%20messages&In-Reply-To=8E98F3D7-4904-4159-81E5-0E8D2FC0D71B%40uszla.me.uk"
       TITLE="[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages">0x6e6562 at gmail.com
       </A><BR>
    <I>Mon Dec  1 17:00:35 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002179.html">[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages
</A></li>
        <LI>Next message: <A HREF="002180.html">[rabbitmq-discuss] help to begin with amqp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2183">[ date ]</a>
              <a href="thread.html#2183">[ thread ]</a>
              <a href="subject.html#2183">[ subject ]</a>
              <a href="author.html#2183">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Toby,

On Mon, Dec 1, 2008 at 11:33 AM, Toby White
&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">toby.o.h.white at googlemail.com</A>&gt; wrote:
&gt;&gt;<i> Do you not see anything in the log about an alarm handler for memory, e.g.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =INFO REPORT==== 9-Nov-2008::15:13:31 ===
</I>&gt;&gt;<i>   alarm_handler: {set,{system_memory_high_watermark,[]}}
</I>
I've tried to simulate your test locally and get the same results,
albeit with different figures. The issue is that even with persistent
messaging, you are still bound by memory because Rabbit basically
copies the in-memory copy of the message to the journal. You can see
this by the fact that Erlang tries to allocate ~700MB of memory in one
hit:

&gt;<i> Crash dump was written to: erl_crash.dump
</I>&gt;<i> eheap_alloc: Cannot allocate 729810240 bytes of memory (of type &quot;heap&quot;).
</I>&gt;<i> Aborted
</I>
Because the increment is so big, the memory supervisor does not get a
chance to set the high watermark and let producer flow control
throttle the rate of production because the interpreter has already
died.

This is caused by the fact that you have nothing consuming messages
and hence the persister log is growing continuously. Because of the
way that the snapshot mechanism currently works, an increasing amount
of memory is required to create snapshots of a growing journal.

A solution to this may be to refactor the persister so that it can
handle large surges in persistent message volumes without having to
rely on something draining it.

However, we are looking into the whole disk based queue paging area in
general and it may be more appropriate to incorporate a solution for
the symptom you are seeing into that work.

Another reason to not just *optimize* the persister is also holistic -
even if you can write stuff down to disk in a smooth fashion, you are
still going to run into the issue that all messages are still kept in
memory.

HTH,

Ben


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002179.html">[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages
</A></li>
	<LI>Next message: <A HREF="002180.html">[rabbitmq-discuss] help to begin with amqp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2183">[ date ]</a>
              <a href="thread.html#2183">[ thread ]</a>
              <a href="subject.html#2183">[ subject ]</a>
              <a href="author.html#2183">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
