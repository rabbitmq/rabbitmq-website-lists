<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] [Q] best way to add a sequencer to the broker
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%5BQ%5D%20best%20way%20to%20add%20a%20sequencer%20to%20the%20broker&In-Reply-To=269388e30812291029u30c2b4e6oa4c0a2686b315118%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002342.html">
   <LINK REL="Next"  HREF="002347.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] [Q] best way to add a sequencer to the broker</H1>
    <B>Chuck Remes</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%5BQ%5D%20best%20way%20to%20add%20a%20sequencer%20to%20the%20broker&In-Reply-To=269388e30812291029u30c2b4e6oa4c0a2686b315118%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] [Q] best way to add a sequencer to the broker">cremes.devlist at mac.com
       </A><BR>
    <I>Mon Dec 29 22:09:24 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002342.html">[rabbitmq-discuss] [Q] best way to add a sequencer to the broker
</A></li>
        <LI>Next message: <A HREF="002347.html">[rabbitmq-discuss] [Q] best way to add a sequencer to the broker
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2346">[ date ]</a>
              <a href="thread.html#2346">[ thread ]</a>
              <a href="subject.html#2346">[ subject ]</a>
              <a href="author.html#2346">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Dec 29, 2008, at 12:29 PM, Ben Hood wrote:

&gt;<i> Chuck,
</I>&gt;<i>
</I>&gt;<i> On Mon, Dec 29, 2008 at 5:43 PM, Chuck Remes  
</I>&gt;<i> &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cremes.devlist at mac.com</A>&gt; wrote:
</I>&gt;&gt;<i> Your last sentence quoted above gets it exactly. Each publisher will
</I>&gt;&gt;<i> set the sequence number to 0 so that the republisher/sequencer  
</I>&gt;&gt;<i> service
</I>&gt;&gt;<i> can add the global number stamp to it. I guess the publishers could
</I>&gt;&gt;<i> also set it to nil; the initial value is irrelevant since the
</I>&gt;&gt;<i> Sequencer will overwrite it.
</I>&gt;<i>
</I>&gt;<i> Fair point. It need not be set until it passes through the broker.
</I>&gt;<i> FWIW there are some standard header properties that could be misused
</I>&gt;<i> for this purpose, e.g. the message_id field.
</I>
I would never dream of misusing a header field! :)

&gt;&gt;<i> The use case is to stamp a global order on all messages through the
</I>&gt;&gt;<i> broker for the purposes of replay, debugging and async logging. I
</I>&gt;&gt;<i> realize that during normal operation the services will be publishing
</I>&gt;&gt;<i> messages in an arbitrary order; it doesn't matter to me. I need to
</I>&gt;&gt;<i> recreate that arbitrary order *exactly* for a replay.
</I>&gt;<i>
</I>&gt;<i> What is the scope of the stamp? Is it globally monotonic
</I>&gt;<i>
</I>&gt;<i> a) accross the entire Rabbit cluster
</I>&gt;<i> b) within a single Rabbit node
</I>&gt;<i> c) within a single AMQP channel
</I>&gt;<i> d) just through a particular queue
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> Obviously, as the scope widens the throughput will become more serial.
</I>
I need to order the messages for the entire distributed application,  
so in this case I believe that means (a) and (b). I haven't really  
given much thought to the clustered case. Any rules of thumb when  
designing for a cluster other than &quot;share nothing?&quot;


&gt;&gt;<i> Think of the sequencer as the software equivalent of a hardware bus
</I>&gt;&gt;<i> clock. Alternately, think of the sequencer as the equivalent of  
</I>&gt;&gt;<i> adding
</I>&gt;&gt;<i> an identity column to a database table (this column contains a
</I>&gt;&gt;<i> monotonically increasing integer assigned by the server).
</I>&gt;<i>
</I>&gt;<i> Strict ingress ordering is going to cost more than global identity,
</I>&gt;<i> which could be achieved by a guid, for example.
</I>&gt;<i>
</I>&gt;<i> A timestamp would be cheaper, but than would not be strictly ordered,
</I>&gt;<i> just asymptotically.
</I>
Yes, this is strict ingress ordering. If it were just stamping it with  
a GUID I wouldn't have bothered you fine folks with my question.

&gt;&gt;<i> I think this does solve the issue. I don't know Erlang yet so I'll
</I>&gt;&gt;<i> probably keep the Sequencer as an external Java client for the short-
</I>&gt;&gt;<i> term, but it's nice to know I can get a performance win with a  
</I>&gt;&gt;<i> rewrite
</I>&gt;&gt;<i> in Erlang. Avoiding the TCP overhead, even if it is short circuited  
</I>&gt;&gt;<i> on
</I>&gt;&gt;<i> a localhost, is a good thing.
</I>&gt;<i>
</I>&gt;<i> What would be more efficient would be a custom exchange implementation
</I>&gt;<i> that stamps each message as it passes through, because you would avoid
</I>&gt;<i> the delivery-redelivery overhead. This would also mean less moving
</I>&gt;<i> parts.
</I>&gt;<i>
</I>&gt;<i> In contrast to the Erlang AMQP client, this would involve some coding
</I>&gt;<i> in the server.
</I>
This is the best suggestion yet. I'll start with a Java client and as  
we require additional performance I'll see about contracting this out  
via LShift. While I'd love to write it myself, I long ago concluded  
that it makes more sense to farm this kind of activity out to the real  
experts.


&gt;&gt;<i> As other services declare exchanges and publish to them, I would like
</I>&gt;&gt;<i> my Sequencer to dynamically detect the existence of a new Exchange so
</I>&gt;&gt;<i> it can create a queue, bind the new queue to the Exchange and receive
</I>&gt;&gt;<i> messages from it for processing and republishing.
</I>&gt;<i>
</I>&gt;<i> ATM there is no notification facility present in Rabbit to tell
</I>&gt;<i> somebody that an exchange has been created. One could extend Rabbit to
</I>&gt;<i> do this (which wouldn't be rocket science) or you could also do this
</I>&gt;<i> on the application level, i.e. maintain a notification queue that the
</I>&gt;<i> sequencer listens on, and have whoever creates a new exchange also
</I>&gt;<i> post to this queue.
</I>
Excellent suggestion; I'll do this at the application level. Thank you!

cr



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002342.html">[rabbitmq-discuss] [Q] best way to add a sequencer to the broker
</A></li>
	<LI>Next message: <A HREF="002347.html">[rabbitmq-discuss] [Q] best way to add a sequencer to the broker
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2346">[ date ]</a>
              <a href="thread.html#2346">[ thread ]</a>
              <a href="subject.html#2346">[ subject ]</a>
              <a href="author.html#2346">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
