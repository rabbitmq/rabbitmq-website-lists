<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] eheap_alloc error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20eheap_alloc%20error&In-Reply-To=376f3e6f0909150856i6def1e17pe51ccf9f918df830%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004866.html">
   <LINK REL="Next"  HREF="004873.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] eheap_alloc error</H1>
    <B>Suhail Doshi</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20eheap_alloc%20error&In-Reply-To=376f3e6f0909150856i6def1e17pe51ccf9f918df830%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] eheap_alloc error">suhail at mixpanel.com
       </A><BR>
    <I>Tue Sep 15 17:03:44 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004866.html">[rabbitmq-discuss] eheap_alloc error
</A></li>
        <LI>Next message: <A HREF="004873.html">[rabbitmq-discuss] eheap_alloc error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4867">[ date ]</a>
              <a href="thread.html#4867">[ thread ]</a>
              <a href="subject.html#4867">[ subject ]</a>
              <a href="author.html#4867">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Doing some investigation into what happened, apparently the memory just
instantly got used, it wasn't leaking something slowly...any ideas?
Attached is an image of memory usage, then the consumer dies freeing up the
memory used later.

On Tue, Sep 15, 2009 at 8:56 AM, Suhail Doshi &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">suhail at mixpanel.com</A>&gt; wrote:

&gt;<i> queue's are marked as durable and persistent on both sides:
</I>&gt;<i>
</I>&gt;<i> Producer:
</I>&gt;<i> send_message(Channel, Ticket, X, RoutingKey, Payload) -&gt;
</I>&gt;<i>     BasicPublish = #'basic.publish'{ticket = Ticket,
</I>&gt;<i>                                     exchange = X,
</I>&gt;<i>                                     routing_key = RoutingKey,
</I>&gt;<i>                                     mandatory = false,
</I>&gt;<i>                                     immediate = false},
</I>&gt;<i>     BasicProperties = amqp_util:basic_properties(),
</I>&gt;<i>     Properties = BasicProperties#'P_basic'{delivery_mode=2}, %% Persistence
</I>&gt;<i> plz
</I>&gt;<i>     Content = #content{class_id = 60,
</I>&gt;<i>          properties = Properties,
</I>&gt;<i>          properties_bin = none,
</I>&gt;<i>          payload_fragments_rev = [Payload]
</I>&gt;<i>         },
</I>&gt;<i>     amqp_channel:cast(Channel, BasicPublish, Content).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I recently just had my producer crash:
</I>&gt;<i>                                      &lt;&lt;&quot;event&quot;&gt;&gt;,false,false})
</I>&gt;<i> Discarding content bearing method ({'basic.publish',1,&lt;&lt;&quot;records&quot;&gt;&gt;,
</I>&gt;<i>                                        &lt;&lt;&quot;event&quot;&gt;&gt;,false,false})
</I>&gt;<i> Discarding content bearing method ({'basic.publish',1,&lt;&lt;&quot;records&quot;&gt;&gt;,
</I>&gt;<i>                                        &lt;&lt;&quot;event&quot;&gt;&gt;,false,false})
</I>&gt;<i> Discarding content bearing method ({'basic.publish',1,&lt;&lt;&quot;records&quot;&gt;&gt;,
</I>&gt;<i>                                        &lt;&lt;&quot;event&quot;&gt;&gt;,false,false})
</I>&gt;<i> Discarding content bearing method ({'basic.publish',1,&lt;&lt;&quot;records&quot;&gt;&gt;,
</I>&gt;<i>                                        &lt;&lt;&quot;event&quot;&gt;&gt;,false,false})
</I>&gt;<i> Discarding content bearing method ({'basic.publish',1,&lt;&lt;&quot;records&quot;&gt;&gt;,
</I>&gt;<i>                                        &lt;&lt;&quot;event&quot;&gt;&gt;,false,false})
</I>&gt;<i> Discarding content bearing method ({'basic.publish',1,&lt;&lt;&quot;records&quot;&gt;&gt;,
</I>&gt;<i>                                        &lt;&lt;&quot;event&quot;&gt;&gt;,false,false})
</I>&gt;<i>
</I>&gt;<i> Crash dump was written to: erl_crash.dump
</I>&gt;<i> eheap_alloc: Cannot allocate 5854930744 bytes of memory (of type
</I>&gt;<i> &quot;heap_frag&quot;).
</I>&gt;<i> Aborted
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Dump:
</I>&gt;<i>
</I>&gt;<i> =erl_crash_dump:0.1
</I>&gt;<i> Tue Sep 15 11:12:02 2009
</I>&gt;<i> Slogan: eheap_alloc: Cannot allocate 5854930744 bytes of memory (of type
</I>&gt;<i> &quot;heap_frag&quot;).
</I>&gt;<i> System version: Erlang R13B01 (erts-5.7.2) [source] [64-bit] [smp:4:4]
</I>&gt;<i> [rq:4] [async-threads:0] [hipe] [kernel-poll:false]
</I>&gt;<i> Compiled: Tue Jun 23 19:56:26 2009
</I>&gt;<i> Atoms: 7600
</I>&gt;<i> =memory
</I>&gt;<i> total: 7249076328
</I>&gt;<i> processes: 7195628192
</I>&gt;<i> processes_used: 7195558088
</I>&gt;<i> system: 53448136
</I>&gt;<i> atom: 509577
</I>&gt;<i> atom_used: 496634
</I>&gt;<i> binary: 43489256
</I>&gt;<i> code: 4768046
</I>&gt;<i> ets: 316624
</I>&gt;<i> =hash_table:atom_tab
</I>&gt;<i> size: 4813
</I>&gt;<i> used: 3785
</I>&gt;<i> objs: 7600
</I>&gt;<i> depth: 8
</I>&gt;<i> =index_table:atom_tab
</I>&gt;<i> size: 8192
</I>&gt;<i> limit: 1048576
</I>&gt;<i> entries: 7600
</I>&gt;<i> =hash_table:module_code
</I>&gt;<i> size: 97
</I>&gt;<i> used: 72
</I>&gt;<i> objs: 123
</I>&gt;<i> depth: 5
</I>&gt;<i> =index_table:module_code
</I>&gt;<i> size: 1024
</I>&gt;<i> limit: 65536
</I>&gt;<i> entries: 123
</I>&gt;<i> =hash_table:export_list
</I>&gt;<i> size: 2411
</I>&gt;<i> used: 1798
</I>&gt;<i> objs: 3355
</I>&gt;<i> depth: 8
</I>&gt;<i> =index_table:export_list
</I>&gt;<i>
</I>


-- 
<A HREF="http://mixpanel.com">http://mixpanel.com</A>
Blog: <A HREF="http://blog.mixpanel.com">http://blog.mixpanel.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/ecc29a59/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/ecc29a59/attachment.htm</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Picture 2.png
Type: image/png
Size: 40630 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/ecc29a59/attachment.png">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090915/ecc29a59/attachment.png</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004866.html">[rabbitmq-discuss] eheap_alloc error
</A></li>
	<LI>Next message: <A HREF="004873.html">[rabbitmq-discuss] eheap_alloc error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4867">[ date ]</a>
              <a href="thread.html#4867">[ thread ]</a>
              <a href="subject.html#4867">[ subject ]</a>
              <a href="author.html#4867">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
