<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%201.6.0%20Memory%20Usage&In-Reply-To=af1bce590909231452p7615639eo8c3e8c6c55d4e67%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004947.html">
   <LINK REL="Next"  HREF="004950.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%201.6.0%20Memory%20Usage&In-Reply-To=af1bce590909231452p7615639eo8c3e8c6c55d4e67%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage">matthias at lshift.net
       </A><BR>
    <I>Thu Sep 24 09:57:05 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004947.html">[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
</A></li>
        <LI>Next message: <A HREF="004950.html">[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4949">[ date ]</a>
              <a href="thread.html#4949">[ thread ]</a>
              <a href="subject.html#4949">[ subject ]</a>
              <a href="author.html#4949">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Gavin,

Gavin M. Roy wrote:
&gt;<i> I wanted to get some feedback on what I am noticing with Rabbit and
</I>&gt;<i> memory use.  In this test case, I loaded up 4 million messages that were
</I>&gt;<i> roughly 12 bytes or so of data, not counting protocol overhead.  At
</I>&gt;<i> various stages of processing I had everything from 0 consumers to 80
</I>&gt;<i> consumers running against RabbitMQ using basic_consume.  The machine
</I>&gt;<i> that Rabbit is running on is dedicated to Rabbit and Alice
</I>&gt;<i> (<A HREF="http://github.com/auser/alice">http://github.com/auser/alice</A>)
</I>&gt;<i> 
</I>&gt;<i> Some odd things:
</I>&gt;<i> 
</I>&gt;<i>     * In the 6am hour where you see swap spike (red in graph), consumers
</I>&gt;<i>       stopped consuming.  I could not find out at the time if it was
</I>&gt;<i>       client or Rabbit that stopped dispatching messages.  Restarting
</I>&gt;<i>       consumers resumed the previous rates of message consumption.
</I>
Next time this happens I suggest you gather some diagnostics with
  rabbitmqctl list_queues name messages_ready messages_unacknowledged
consumers

If the consumer count is 0 then there are no consumers. If you have a
consumer count above 0 and a messages_ready count above 0, and the
broker appears to be idle, then that is a good indication that the
consumers are there but stuck and the tcp connection to them is backlogged.

&gt;<i>     * At the time where you see the last major purple graph spike to 10G
</I>&gt;<i>       free, we had consumed all of the messages in the broker.  The
</I>&gt;<i>       broker is currently sitting idle with no messages, but still has
</I>&gt;<i>       2+GB of ram allocated.
</I>&gt;<i> 
</I>&gt;<i> I did notice there seems to be some sort of cleanup worker that runs
</I>&gt;<i> roughly every 30 minutes, but it's not reclaimed any of the 2+GB of
</I>&gt;<i> allocation since the broker has gone idle. Is this expected behavior?
</I>
It is quite common for a gc'ed VM to hold on to large chunks of memory
instead of handing them back to the OS.

Are you monitoring queues with rabbitmqctl or Alice? If that happens
more frequently than once per second then the queue processes are kept
active, which delays the freeing up of memory.

To get some diagnostics on where the memory has gone, shell into rabbit
(erl -sname shell -remsh rabbit@&lt;hostname&gt;) and run
  memory().


Regards,

Matthias.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004947.html">[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
</A></li>
	<LI>Next message: <A HREF="004950.html">[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4949">[ date ]</a>
              <a href="thread.html#4949">[ thread ]</a>
              <a href="subject.html#4949">[ subject ]</a>
              <a href="author.html#4949">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
