<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%201.6.0%20Memory%20Usage&In-Reply-To=4ABB3461.8090706%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004949.html">
   <LINK REL="Next"  HREF="004951.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage</H1>
    <B>Gavin M. Roy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%201.6.0%20Memory%20Usage&In-Reply-To=4ABB3461.8090706%40lshift.net"
       TITLE="[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage">gmr at myyearbook.com
       </A><BR>
    <I>Thu Sep 24 14:35:24 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004949.html">[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
</A></li>
        <LI>Next message: <A HREF="004951.html">[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4950">[ date ]</a>
              <a href="thread.html#4950">[ thread ]</a>
              <a href="subject.html#4950">[ subject ]</a>
              <a href="author.html#4950">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Sep 24, 2009 at 4:57 AM, Matthias Radestock &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at lshift.net</A>&gt;wrote:

&gt;<i> Gavin,
</I>&gt;<i>
</I>&gt;<i> Next time this happens I suggest you gather some diagnostics with
</I>&gt;<i>  rabbitmqctl list_queues name messages_ready messages_unacknowledged
</I>&gt;<i> consumers
</I>&gt;<i>
</I>
I made sure there were no messages in the stack, but since it's still
hanging out with the memory allocated:

[<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at mq07</A> ~]# /opt/rabbitmq/sbin/rabbitmqctl list_queues name
messages_ready messages_unacknowledged
Listing queues ...
Notification 0 0
...done.

If the consumer count is 0 then there are no consumers. If you have a
&gt;<i> consumer count above 0 and a messages_ready count above 0, and the
</I>&gt;<i> broker appears to be idle, then that is a good indication that the
</I>&gt;<i> consumers are there but stuck and the tcp connection to them is backlogged.
</I>&gt;<i>
</I>
Yeah I pulled off the consumers when it was done to see if that was why the
memory wasn't given back.

lsof and netstat do not indicate any open sockets (in any state) to Rabbit
from the consumer box.


&gt;<i> It is quite common for a gc'ed VM to hold on to large chunks of memory
</I>&gt;<i> instead of handing them back to the OS.
</I>&gt;<i>
</I>
Is it safe to assume the VM will make use of what it's holding on to and
it's not a leak of some sort?


&gt;<i> Are you monitoring queues with rabbitmqctl or Alice? If that happens
</I>&gt;<i> more frequently than once per second then the queue processes are kept
</I>&gt;<i> active, which delays the freeing up of memory.
</I>&gt;<i>
</I>
Primarily Alice, and the monitor interval I am using is ~10 seconds.


&gt;<i> To get some diagnostics on where the memory has gone, shell into rabbit
</I>&gt;<i> (erl -sname shell -remsh rabbit@&lt;hostname&gt;) and run
</I>&gt;<i>  memory().
</I>&gt;<i>
</I>
[<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at mq07</A> ~]# erl -sname shell -remsh <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq07</A>
Erlang R13B (erts-5.7.1) [source] [64-bit] [smp:8:8] [rq:8]
[async-threads:0] [hipe] [kernel-poll:false]

Eshell V5.7.1  (abort with ^G)
(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq07</A>)1&gt; memory().
[{total,354514080},
 {processes,23750072},
 {processes_used,22779304},
 {system,330764008},
 {atom,775705},
 {atom_used,748674},
 {binary,22063432},
 {code,7638629},
 {ets,5241416}]
(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq07</A>)2&gt;

Thanks,

Gavin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090924/b62eff4e/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090924/b62eff4e/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004949.html">[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
</A></li>
	<LI>Next message: <A HREF="004951.html">[rabbitmq-discuss] RabbitMQ 1.6.0 Memory Usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4950">[ date ]</a>
              <a href="thread.html#4950">[ thread ]</a>
              <a href="subject.html#4950">[ subject ]</a>
              <a href="author.html#4950">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
