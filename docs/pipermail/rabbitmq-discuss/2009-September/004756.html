<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs	- &quot;Only one usage of each socket address (protocol/network	address/port) is normally permitted&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Error%3A%20RabbitMQ.Client.ConnectionFactory.cs%0A%09-%20%22Only%20one%20usage%20of%20each%20socket%20address%20%28protocol/network%0A%09address/port%29%20is%20normally%20permitted%22&In-Reply-To=4A9D32FB.7090607%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004746.html">
   <LINK REL="Next"  HREF="004757.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs	- &quot;Only one usage of each socket address (protocol/network	address/port) is normally permitted&quot;</H1>
    <B>Patrick Kenney</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Error%3A%20RabbitMQ.Client.ConnectionFactory.cs%0A%09-%20%22Only%20one%20usage%20of%20each%20socket%20address%20%28protocol/network%0A%09address/port%29%20is%20normally%20permitted%22&In-Reply-To=4A9D32FB.7090607%40lshift.net"
       TITLE="[rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs	- &quot;Only one usage of each socket address (protocol/network	address/port) is normally permitted&quot;">pekenney at gmail.com
       </A><BR>
    <I>Wed Sep  2 20:24:37 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004746.html">[rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs - &quot;Only one usage of each socket address (protocol/network address/port) is normally permitted&quot;
</A></li>
        <LI>Next message: <A HREF="004757.html">[rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs - &quot;Only one usage of each socket address (protocol/network address/port) is normally permitted&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4756">[ date ]</a>
              <a href="thread.html#4756">[ thread ]</a>
              <a href="subject.html#4756">[ subject ]</a>
              <a href="author.html#4756">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>k,

So i think you are agreeing with me that when I call ... new
ConnectionFactory().CreateConnection(&quot;localhost:5672&quot;)...

that I am using the same socket over and over again, but creating new
connections to it...

The following... &quot;Error: RabbitMQ.Client.ConnectionFactory.cs - &quot;Only one
usage of each socket address (protocol/network address/port) is normally
permitted&quot;...

Is not a result of exhausting all available sockets on the system, its a
result of TCP being unable to dispose fast enough... so even though I have
already closed the socket explicitly the system has not disposed of it yet,
so it thinks I am trying to reuse the same socket... (This is confirmed
using the debugger &amp; wireshark (packetsniffer)...

Additionally, this only occurs after thousands of consecutive calls to the
PublishMessage method i posted at the beginning of this thread...

So...

Taking your suggestion to make IModel and IConnection module level, my
threaded PublishMessage method now looks like the following...

public void PublishMessage(string pstrExchangeName, string pstrReturnKey,
string pstrXml)
        {
            try
            {
                if (null == m_Conn)
                {
                    m_Conn = new
ConnectionFactory().CreateConnection(m_strRabbitMqHost);
                }

                if (null == m_Channel)
                {
                    m_Channel = m_Conn.CreateModel();
                }

                IBasicProperties props = m_Channel.CreateBasicProperties();
                IStreamMessageBuilder b = new
StreamMessageBuilder(m_Channel);
                byte[] bytes = Encoding.UTF8.GetBytes(pstrXml);
                b.WriteBytes(bytes);
                m_Channel.BasicPublish(pstrExchangeName, pstrReturnKey,
null, bytes);
            }

          catch(Exception ex)
          {
                 throw ex;
          }

so the error is fixed, but... I still cannot even come close to the 4000
messages per second capability (with better then twice the hardware)
described at:
<A HREF="http://www.rabbitmq.com/faq.html">http://www.rabbitmq.com/faq.html</A>

Q. How fast is RabbitMQ in persistent mode?

A. From our testing, we expect easily-achievable throughputs of 4000
persistent, non-transacted one-kilobyte messages per second (Intel Pentium
D, 2.8GHz, dual core, gigabit ethernet) from a single RabbitMQ broker node
writing to a single spindle.

so what kind of tcp configuration tweaks or otherwise did you guys have to
make to accomplish this?

I am getting about 10% of that advertised 4000 per second capability...

thanks in advance.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090902/e8122674/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090902/e8122674/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004746.html">[rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs - &quot;Only one usage of each socket address (protocol/network address/port) is normally permitted&quot;
</A></li>
	<LI>Next message: <A HREF="004757.html">[rabbitmq-discuss] Error: RabbitMQ.Client.ConnectionFactory.cs - &quot;Only one usage of each socket address (protocol/network address/port) is normally permitted&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4756">[ date ]</a>
              <a href="thread.html#4756">[ thread ]</a>
              <a href="subject.html#4756">[ subject ]</a>
              <a href="author.html#4756">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
