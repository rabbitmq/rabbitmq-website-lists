<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Performance degrades with increasing	queue	depth
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Performance%20degrades%20with%20increasing%0A%09queue%09depth&In-Reply-To=376f3e6f0909070934w17860febg152a940bf5952f9f%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004799.html">
   <LINK REL="Next"  HREF="004803.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Performance degrades with increasing	queue	depth</H1>
    <B>Chuck Remes</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Performance%20degrades%20with%20increasing%0A%09queue%09depth&In-Reply-To=376f3e6f0909070934w17860febg152a940bf5952f9f%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Performance degrades with increasing	queue	depth">cremes.devlist at mac.com
       </A><BR>
    <I>Mon Sep  7 19:38:54 BST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004799.html">[rabbitmq-discuss] Performance degrades with increasing queue	depth
</A></li>
        <LI>Next message: <A HREF="004803.html">[rabbitmq-discuss] Performance degrades with increasing	queue	depth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4801">[ date ]</a>
              <a href="thread.html#4801">[ thread ]</a>
              <a href="subject.html#4801">[ subject ]</a>
              <a href="author.html#4801">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Are you running the same code as Aisha? Are you the same person or  
work together? I'm getting a bit confused in this thread.

And, someone needs to start showing some code. I'm able to push  
hundreds of messages per second and never see a drop off in delivery  
performance regardless of the queue size (until I run out of memory).  
I don't think it is fair to blame rabbit until we can see your code  
and understand what you are doing.

Also, please specify the following things:

exchange - durable or not?
exchange - type? (Looks like &quot;fanout&quot; from the original post)
number of bindings per exchange
queue  - durable?
publishing settings - require ack? persistent? immediate?
message size? 1K according to the original post

Is your test machine paging or swapping? What is the 'top' output for  
your process and for rabbit at various points of the run cycle? Is it  
lower or higher when you are getting 300 msg/s than when you are  
getting 80 msg/s?

What is your subscriber doing with the data it receives? If you make  
that process a &quot;no op&quot; how many messages per second can you handle?  
Does it ever drop off related to queue size? Why are you &quot;popping&quot;  
messages from the queue isn't of having them pushed automatically?

This thread has been really frustrating because there has NOT been  
very much information shared. All I see is &quot;it's slow.&quot; Give us more  
information.

cr


On Sep 7, 2009, at 11:34 AM, Suhail Doshi wrote:

&gt;<i> 2009-09-07 16:33:10,822 INFO [id: 95705166] Processing complete,  
</I>&gt;<i> acknowledged.
</I>&gt;<i> 2009-09-07 16:33:10,826 INFO [id: 95705166] Received queue item,  
</I>&gt;<i> processing...
</I>&gt;<i> 2009-09-07 16:33:10,878 INFO [id: 95705166] Processing complete,  
</I>&gt;<i> acknowledged.
</I>&gt;<i> 2009-09-07 16:33:10,882 INFO [id: 95705166] Received queue item,  
</I>&gt;<i> processing...
</I>&gt;<i> 2009-09-07 16:33:12,839 INFO [id: 95705166] Processing complete,  
</I>&gt;<i> acknowledged.
</I>&gt;<i> 2009-09-07 16:33:12,839 INFO [id: 95705166] Received queue item,  
</I>&gt;<i> processing...
</I>&gt;<i> 2009-09-07 16:33:13,531 INFO [id: 95705166] Processing complete,  
</I>&gt;<i> acknowledged.
</I>&gt;<i> 2009-09-07 16:33:13,531 INFO [id: 95705166] Received queue item,  
</I>&gt;<i> processing...
</I>&gt;<i>
</I>&gt;<i> If you see there's like a pause for a second between 10 and 12, an  
</I>&gt;<i> item gets processed pretty fast as you can see. Odd isn't it?
</I>&gt;<i>
</I>&gt;<i> Suhail
</I>&gt;<i>
</I>&gt;<i> On Mon, Sep 7, 2009 at 9:32 AM, Suhail Doshi  
</I>&gt;<i> &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">digitalwarfare at gmail.com</A>&gt; wrote:
</I>&gt;<i> I almost feel as though rabbitmq can't push items to my consumer  
</I>&gt;<i> fast enough, I had a backed up queue with 20 consumers and spawned  
</I>&gt;<i> another watching the items get processed and it just seemed so slow,  
</I>&gt;<i> saw numerous pauses between item processing and I don't believe it  
</I>&gt;<i> is the consumer's fault.
</I>&gt;<i>
</I>&gt;<i> I am using the Python library for the consumer part.
</I>&gt;<i>
</I>&gt;<i> Suhail
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Sep 7, 2009 at 8:23 AM, Chuck Remes &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cremes.devlist at mac.com</A>&gt;  
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;<i> On Sep 7, 2009, at 1:07 AM, aisha fenton wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt; I'm sure I'm doing something wrong since I can't find reference to
</I>&gt;<i> &gt; this anywhere else. What I'm seeing is that the performance of
</I>&gt;<i> &gt; draining a queue gets slower as the queue size increases.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm aware of the issue in RabbitMQ 1.6 that means that when it runs
</I>&gt;<i> &gt; out of physical memory that it's performance degrades because it
</I>&gt;<i> &gt; starts swapping out. But I'm not anywhere close to running out of
</I>&gt;<i> &gt; memory yet, and the degradation starts almost immediately and
</I>&gt;<i> &gt; increases linearly as the queue depth grows.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am publishing 500mps to an exchange. Each message is about 1KB. I
</I>&gt;<i> &gt; have a single fanout queue bound to the exchange. A single  
</I>&gt;<i> consumer is
</I>&gt;<i> &gt; popping messages off the queue.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; When the queue is less than 20,000 messages I can pop 300mps off the
</I>&gt;<i> &gt; queue. When the queue is 200,000 messages the performance drop to
</I>&gt;<i> &gt; 40-80mps.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm running RabbitMQ 1.6.0. And nether rabbitmq, the consumer, or  
</I>&gt;<i> the
</I>&gt;<i> &gt; publisher are using more than 40% CPU.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I assume I shouldn't be seeing this? Any help much appreciated.
</I>&gt;<i>
</I>&gt;<i> You didn't include any code, but I'm going to take a stab in the dark
</I>&gt;<i> anyway. If you are using the ruby amqp gem you might be doing
</I>&gt;<i> something like this:
</I>&gt;<i>
</I>&gt;<i> def next_message
</I>&gt;<i>   exchange = MQ.fanout 'foo'
</I>&gt;<i>   queue = MQ.queue 'bar'
</I>&gt;<i>
</I>&gt;<i>   queue.bind exchange
</I>&gt;<i>
</I>&gt;<i>   newest_message = queue.pop
</I>&gt;<i> end
</I>&gt;<i>
</I>&gt;<i> In the code above the call to MQ.&lt;whatever&gt; is opening a new channel
</I>&gt;<i> to rabbitmq each time the method is called. You are essentially
</I>&gt;<i> leaking channels all over the place every time you try to pop a new
</I>&gt;<i> message.
</I>&gt;<i>
</I>&gt;<i> If you aren't using the ruby amqp stuff, I still recommend checking
</I>&gt;<i> your code for whatever library you chose. You only need to allocate a
</I>&gt;<i> few channels and reuse them.
</I>&gt;<i>
</I>&gt;<i> cr
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> <A HREF="http://mixpanel.com">http://mixpanel.com</A>
</I>&gt;<i> Blog: <A HREF="http://blog.mixpanel.com">http://blog.mixpanel.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> <A HREF="http://mixpanel.com">http://mixpanel.com</A>
</I>&gt;<i> Blog: <A HREF="http://blog.mixpanel.com">http://blog.mixpanel.com</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/1f84fdf7/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20090907/1f84fdf7/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004799.html">[rabbitmq-discuss] Performance degrades with increasing queue	depth
</A></li>
	<LI>Next message: <A HREF="004803.html">[rabbitmq-discuss] Performance degrades with increasing	queue	depth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4801">[ date ]</a>
              <a href="thread.html#4801">[ thread ]</a>
              <a href="subject.html#4801">[ subject ]</a>
              <a href="author.html#4801">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
