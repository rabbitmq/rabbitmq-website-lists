<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Active/Active failover and lost messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active/Active%20failover%20and%20lost%20messages&In-Reply-To=%3C20111107095214.GA21387%40wellquite.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016005.html">
   <LINK REL="Next"  HREF="016026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Active/Active failover and lost messages</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active/Active%20failover%20and%20lost%20messages&In-Reply-To=%3C20111107095214.GA21387%40wellquite.org%3E"
       TITLE="[rabbitmq-discuss] Active/Active failover and lost messages">matthew at rabbitmq.com
       </A><BR>
    <I>Mon Nov  7 09:52:14 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016005.html">[rabbitmq-discuss] Active/Active failover and lost messages
</A></li>
        <LI>Next message: <A HREF="016026.html">[rabbitmq-discuss] Active/Active failover and lost messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16011">[ date ]</a>
              <a href="thread.html#16011">[ thread ]</a>
              <a href="subject.html#16011">[ subject ]</a>
              <a href="author.html#16011">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Konstantin,

On Sun, Nov 06, 2011 at 02:25:59PM -0800, Konstantin Kalin wrote:
&gt;<i> Also I found a root-cause for my issue. Due to misprint in client
</I>&gt;<i> code, the queues were created without &quot;x-ha-policy&quot;. It's stupid but
</I>&gt;<i> it happened :) So my previous result was gained with non-mirrored
</I>&gt;<i> queues. I was really impressed when I found this. The cluster lost not
</I>&gt;<i> many messages in such condition.
</I>
Ah ha! Glad you found it.

&gt;<i> Once I corrected the mistake the cluster works fine. Consumers don't
</I>&gt;<i> lose messages if a cluster node fails (stopped manually, Linux
</I>&gt;<i> rebooted and so on). Everything is delivered except one case.
</I>&gt;<i> If a node fails under heavy load on the cluster (CPU load is above
</I>&gt;<i> 90-95% on cluster nodes) a few messages were lost anyway.  A publisher
</I>&gt;<i> submitted a message properly but a consumer never received it. I
</I>&gt;<i> repeated the test several times and it's reproducible. And now I'm
</I>&gt;<i> pretty confident that messages are lost in RabbitMQ (not in my
</I>&gt;<i> code :) )
</I>
Interesting. I would guess that that's the case when the publisher is
connected to a highly loaded node, and the publisher's node is taken
down. Could you check if that's the case?

Are you using publisher confirms? If so, it really shouldn't be the case
that the confirm is received by the client and the message being publish
is lost. That should never happen. If you're not using publisher
confirms then yes, it is possible that the publisher thinks it's sent a
message but due to failures, that message never manages to make it
through to any of the members of the mirrored queue. Publisher confirms
are only issued back to the client when the message has made it to all
the queues it's been routed to, so you really shouldn't get confirms for
messages that get lost in this way.

If a message has not been confirmed back to the publisher, and the
publisher gets disconnected due to node failure, the publisher *must*
republish any messages it has not received confirms for. Yes, this does
introduce more possibility of duplicates at the consumers, but you have
to do dedupification anyway for other reasons.

Best wishes,

Matthew
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016005.html">[rabbitmq-discuss] Active/Active failover and lost messages
</A></li>
	<LI>Next message: <A HREF="016026.html">[rabbitmq-discuss] Active/Active failover and lost messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16011">[ date ]</a>
              <a href="thread.html#16011">[ thread ]</a>
              <a href="subject.html#16011">[ subject ]</a>
              <a href="author.html#16011">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
