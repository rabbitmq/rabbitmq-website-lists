<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] active/active message persistence problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20active/active%20message%20persistence%20problem&In-Reply-To=%3CCAGWz9vUQdP%2BSrWCQQeS2SUjgXpSZYE5rFE8Mei5pEad7gWXGdw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016441.html">
   <LINK REL="Next"  HREF="016455.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] active/active message persistence problem</H1>
    <B>Cameron Davison</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20active/active%20message%20persistence%20problem&In-Reply-To=%3CCAGWz9vUQdP%2BSrWCQQeS2SUjgXpSZYE5rFE8Mei5pEad7gWXGdw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] active/active message persistence problem">cameron.davison at gmail.com
       </A><BR>
    <I>Tue Nov 22 06:54:57 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016441.html">[rabbitmq-discuss] active/active message persistence problem
</A></li>
        <LI>Next message: <A HREF="016455.html">[rabbitmq-discuss] active/active message persistence problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16442">[ date ]</a>
              <a href="thread.html#16442">[ thread ]</a>
              <a href="subject.html#16442">[ subject ]</a>
              <a href="author.html#16442">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>You can run &quot;rabbitmqctl list_queues name slave_pids
synchronised_slave_pids&quot; to see if the cluster is synchronized or not
but I can tell you right now that they will not be. In step 3 when you
start vm1 back up and it is the slave. It is telling you that there
are 10 messages in the vm2 queue. When you talk to a broker in a
cluster it will talk to the master queue. VM1 will not be synchronized
until all 10 messages are read out of the vm2 queue, because rabbitmq
mirrored clusters do not read old messages that are already in the
master queue. The slave reads the tail of the new message being sent
to the master and expects that once it has been long enough then it
will catch up to the same state as the master.

<A HREF="http://www.rabbitmq.com/ha.html">http://www.rabbitmq.com/ha.html</A> &quot;Unsynchronised Slaves&quot; I think does a
good job of explaining it.

Cameron

On Tue, Nov 22, 2011 at 12:37 AM, Jeffrey Chen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cpthk at hotmail.com</A>&gt; wrote:
&gt;<i> Hello Cameron:
</I>&gt;<i>
</I>&gt;<i> To resolve any confusion, let me make a table to clarify. I DO have
</I>&gt;<i> &quot;x-ha-policy&quot; set to &quot;all&quot;
</I>&gt;<i>
</I>&gt;<i> &#160; Steps &#160;&#160; |&#160;&#160; vm1 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160; | &#160; &#160;&#160; &#160; vm2
</I>&gt;<i>
</I>&gt;<i> ------------------------------------------------------------------------------
</I>&gt;<i> &#160; 1.&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |&#160; started (10 msg, disk, master) &#160; |&#160; started (10 msg, disk)
</I>&gt;<i> &#160; 2.&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |&#160; stop&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160; &#160; &#160;&#160; |&#160; started (10
</I>&gt;<i> msg, disk, became master)
</I>&gt;<i> &#160; 3.&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |&#160; started (10 msg, disk, slave)&#160;&#160; &#160;&#160; |&#160; started (10 msg, disk,
</I>&gt;<i> master)
</I>&gt;<i> &#160; 4.&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |&#160; started (0 msg, disk, master)&#160;&#160;&#160;&#160; | stop
</I>&gt;<i>
</I>&gt;<i> Noticed that in my step 4, when I stop my VM2, the message in VM1
</I>&gt;<i> immediately disappear. You are right, each step has interval of about 10
</I>&gt;<i> seconds, I didn't wait very long to stop the new master. You mentioned that
</I>&gt;<i> I have to I have to wait until the queues are synchronized. How long is that
</I>&gt;<i> waiting? Is there a command that I could find out if they finished the
</I>&gt;<i> synchronization? Like rabbitmqctl command or anything? Or any way to force
</I>&gt;<i> synchronize right now. I am only testing 10 messages, it shouldn't take that
</I>&gt;<i> long.
</I>&gt;<i>
</I>&gt;<i> Thanks for your help.
</I>&gt;<i>
</I>&gt;<i> Jeffrey.
</I>&gt;<i>
</I>&gt;&gt;<i> From: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cameron.davison at gmail.com</A>
</I>&gt;&gt;<i> Date: Mon, 21 Nov 2011 23:46:24 -0600
</I>&gt;&gt;<i> Subject: Re: [rabbitmq-discuss] active/active message persistence problem
</I>&gt;&gt;<i> To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cpthk at hotmail.com</A>
</I>&gt;&gt;<i> CC: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What order are you restarting the nodes? Any rabbitmq server that
</I>&gt;&gt;<i> connects to a cluster will start its queue fresh and begin replicating
</I>&gt;&gt;<i> from the master. You should wait and make sure that all the queues are
</I>&gt;&gt;<i> synchronized before you shut down the master, or new master. Old
</I>&gt;&gt;<i> messages are not read from nodes that connect to the cluster because
</I>&gt;&gt;<i> the assumption is that the queue will go to 0 soon and then the old
</I>&gt;&gt;<i> messages will not matter so only the new messages will be important.
</I>&gt;&gt;<i> Also, you should make sure that the &quot;x-ha-policy&quot; is set to &quot;all&quot; or
</I>&gt;&gt;<i> to the &quot;nodes&quot; that you would like the queue to be mirrored to.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cameron
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, Nov 21, 2011 at 7:14 PM, Jeffrey Chen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cpthk at hotmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> &gt; Hi RabbitMQ community:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I am encounter this problem about message persistence. Here is my case,
</I>&gt;&gt;<i> &gt; I
</I>&gt;&gt;<i> &gt; have 2 server nodes with active/active setup, both are persisted to
</I>&gt;&gt;<i> &gt; DISK.
</I>&gt;&gt;<i> &gt; The queue declarations are defined as durable.
</I>&gt;&gt;<i> &gt; This is what I got when doing:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; # rabbitmqctl cluster_status
</I>&gt;&gt;<i> &gt; Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at aaron-vm177</A>' ...
</I>&gt;&gt;<i> &gt; [{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm1</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm2</A>']}]},
</I>&gt;&gt;<i> &gt; &#160;{running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm1</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at vm2</A>']}]
</I>&gt;&gt;<i> &gt; ...done.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; # rabbitmqctl list_queues
</I>&gt;&gt;<i> &gt; Listing queues ...
</I>&gt;&gt;<i> &gt; test &#160;&#160; 10
</I>&gt;&gt;<i> &gt; ...done.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; My vm1 is currently master node. When I stop RabbitMQ service in vm1,
</I>&gt;&gt;<i> &gt; and
</I>&gt;&gt;<i> &gt; start it back up. I check my messages in the queue, the messages are
</I>&gt;&gt;<i> &gt; still
</I>&gt;&gt;<i> &gt; there. This time when I stop RabbitMQ service in vm2. The messages will
</I>&gt;&gt;<i> &gt; be
</I>&gt;&gt;<i> &gt; gone. It seems like when I restart both server nodes, the data will be
</I>&gt;&gt;<i> &gt; lost.
</I>&gt;&gt;<i> &gt; Does anyone know the reason? Is there any way to work around this?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; My goal is that any server nodes down, and when I bring it back up, no
</I>&gt;&gt;<i> &gt; data
</I>&gt;&gt;<i> &gt; will be lost.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Jeffrey.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;<i>
</I></PRE>













































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016441.html">[rabbitmq-discuss] active/active message persistence problem
</A></li>
	<LI>Next message: <A HREF="016455.html">[rabbitmq-discuss] active/active message persistence problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16442">[ date ]</a>
              <a href="thread.html#16442">[ thread ]</a>
              <a href="subject.html#16442">[ subject ]</a>
              <a href="author.html#16442">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
