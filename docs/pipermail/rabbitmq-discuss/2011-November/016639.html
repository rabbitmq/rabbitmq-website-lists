<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] publisher confirmations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20publisher%20confirmations&In-Reply-To=%3CA62CED95F8064668AF5E0B4BA1C75EC3%40myyearbook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016637.html">
   <LINK REL="Next"  HREF="016568.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] publisher confirmations</H1>
    <B>Gavin M. Roy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20publisher%20confirmations&In-Reply-To=%3CA62CED95F8064668AF5E0B4BA1C75EC3%40myyearbook.com%3E"
       TITLE="[rabbitmq-discuss] publisher confirmations">gmr at myyearbook.com
       </A><BR>
    <I>Tue Nov 29 14:58:32 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016637.html">[rabbitmq-discuss] publisher confirmations
</A></li>
        <LI>Next message: <A HREF="016568.html">[rabbitmq-discuss] publisher confirmations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16639">[ date ]</a>
              <a href="thread.html#16639">[ thread ]</a>
              <a href="subject.html#16639">[ subject ]</a>
              <a href="author.html#16639">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am not using it in production yet, but we do have all of those features in github Master, 0.9.6p0. I am in process of writing tests and cleaning up 0.9.6 for release.

Test it and see if it works for you. I'd not be concerned about production use if you do not run into any issues.

Gavin 


On Tuesday, November 29, 2011 at 8:55 AM, Roey Berman wrote:

&gt;<i> I've created a pull request which fixes the demo: <A HREF="https://github.com/pika/pika/pull/109">https://github.com/pika/pika/pull/109</A>
</I>&gt;<i> 
</I>&gt;<i> Note:
</I>&gt;<i> The stable pika release (0.9.5) doesn't add the Basic.Nack and Confirm.SelectOk callbacks when you call channel.confirm_delivery()
</I>&gt;<i> you'll explicitly have to call channel.add_callback(on_delivered, ['Basic.Nack', 'Confirm.SelectOk'])
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Would you recommend using the git master version of pika or 0.9.5 for a production environment? 
</I>&gt;<i> On Mon, Nov 28, 2011 at 1:53 PM, Roey Berman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">roey.berman at gmail.com</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">roey.berman at gmail.com</A>)&gt; wrote:
</I>&gt;<i> &gt; Thanks again for the quick response.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I also read <A HREF="http://www.rabbitmq.com/extensions.html#publishing">http://www.rabbitmq.com/extensions.html#publishing</A> before posting this question. 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; But again my problem is with simulating server nacks so i can create a test case for my code.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Do you have any idea how I can do that?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; On Mon, Nov 28, 2011 at 1:26 PM, Marek Majkowski &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">majek04 at gmail.com</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">majek04 at gmail.com</A>)&gt; wrote:
</I>&gt;<i> &gt; &gt; On Mon, Nov 28, 2011 at 11:11, Roey Berman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">roey.berman at gmail.com</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">roey.berman at gmail.com</A>)&gt; wrote:
</I>&gt;<i> &gt; &gt; &gt; Oh one fix:
</I>&gt;<i> &gt; &gt; &gt; self.chan.basic_publish(message, **kwargs) -&gt; self.chan.basic_publish(body =
</I>&gt;<i> &gt; &gt; &gt; message, **kwargs)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; On Mon, Nov 28, 2011 at 1:08 PM, Roey Berman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">roey.berman at gmail.com</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">roey.berman at gmail.com</A>)&gt; wrote:
</I>&gt;<i> &gt; &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; Thanks for the quick reply.
</I>&gt;<i> &gt; &gt; &gt;&gt; At first I used the code from the example you referred me to but it
</I>&gt;<i> &gt; &gt; &gt;&gt; doesn't handle the &quot;multiple&quot; flag and NAcks from the server.
</I>&gt;<i> &gt; &gt; &gt;&gt; I know my code handles the &quot;multiple&quot; flag, but don't know about NAcks.
</I>&gt;<i> &gt; &gt; &gt;&gt; I don't really know how to test for nacks since I've never gotten them
</I>&gt;<i> &gt; &gt; &gt;&gt; from rabbitmq server.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; <A HREF="http://www.rabbitmq.com/extensions.html#publishing">http://www.rabbitmq.com/extensions.html#publishing</A>
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; &quot;In exceptional cases when the broker is unable to handle messages
</I>&gt;<i> &gt; &gt; successfully, instead of a basic.ack, the broker will send a
</I>&gt;<i> &gt; &gt; basic.nack. In this context, fields of the basic.nack have the same
</I>&gt;<i> &gt; &gt; meaning as the corresponding ones in basic.ack and the requeue field
</I>&gt;<i> &gt; &gt; should be ignored. By nack'ing one or more messages, the broker
</I>&gt;<i> &gt; &gt; indicates that it was unable to process the messages and refuses
</I>&gt;<i> &gt; &gt; responsibility for them; at that point, the client may choose to
</I>&gt;<i> &gt; &gt; re-publish the messages.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; After a channel is put into confirm mode, all subsequently published
</I>&gt;<i> &gt; &gt; messages will be confirmed or nack'd once. No guarantees are made as
</I>&gt;<i> &gt; &gt; to how soon a message is confirmed. No message will be both confirmed
</I>&gt;<i> &gt; &gt; and nack'd.&quot;
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; That's all I know.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt;&gt; Once I know my code handles all responses correctly I will create a pull
</I>&gt;<i> &gt; &gt; &gt;&gt; request for the pika example code.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; Good!
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; Marek
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt;&gt; On Mon, Nov 28, 2011 at 1:01 PM, Marek Majkowski &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">majek04 at gmail.com</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">majek04 at gmail.com</A>)&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; wrote:
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; Hi,
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; I'm not sure if it works - but the pika example showing
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; publisher confirms usage looks rather similar:
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; <A HREF="https://github.com/pika/pika/blob/120fdea5913e7ed80536ff55634ab0f8f4554e79/examples/demo_send_confirmed.py">https://github.com/pika/pika/blob/120fdea5913e7ed80536ff55634ab0f8f4554e79/examples/demo_send_confirmed.py</A>
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; Cheer,
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt;  Marek
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; On Sun, Nov 27, 2011 at 15:20, bergundy &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">roey.berman at gmail.com</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">roey.berman at gmail.com</A>)&gt; wrote:
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; Hi everyone,
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; I couldn't find code for implementing publisher confirmations.
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; I wrote this piece of code using pika 0.9.5 (python client).
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; Would like to get feedback on this, I hope I got it right ...
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; ---
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; class ConfirmingProducer(object):
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;    def __init__(self, channel):
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        self.delivery_tag = 1
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        self.acked        = 0
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        self._callbacks   = {}
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        self.chan = channel
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        self.chan.confirm_delivery(self.on_delivered)
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;    def publish(self, message, callback, **kwargs):
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        self._callbacks[self.delivery_tag] = callback
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        self.delivery_tag += 1
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        self.chan.basic_publish(message, **kwargs)
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;    def on_delivered(self, frame):
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        success = isinstance(frame.method, pika.spec.Basic.Ack)
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        if frame.method.multiple:
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;            for dtag in range(self.acked+1, frame.method.delivery_tag
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; +1):
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;                self._callbacks.pop(dtag)(success)
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;            self.acked = frame.method.delivery_tag
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;        else:
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;            self._callbacks.pop(frame.method.delivery_tag)(success)
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;            self.acked += 1
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>)
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>)
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111129/d39ed50d/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111129/d39ed50d/attachment.htm</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016637.html">[rabbitmq-discuss] publisher confirmations
</A></li>
	<LI>Next message: <A HREF="016568.html">[rabbitmq-discuss] publisher confirmations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16639">[ date ]</a>
              <a href="thread.html#16639">[ thread ]</a>
              <a href="subject.html#16639">[ subject ]</a>
              <a href="author.html#16639">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
