<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmq-server crashes hard while consuming 31GB of RAM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq-server%20crashes%20hard%20while%20consuming%0A%2031GB%20of%20RAM&In-Reply-To=%3C4ECD2216.40300%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016498.html">
   <LINK REL="Next"  HREF="016530.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmq-server crashes hard while consuming 31GB of RAM</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq-server%20crashes%20hard%20while%20consuming%0A%2031GB%20of%20RAM&In-Reply-To=%3C4ECD2216.40300%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmq-server crashes hard while consuming 31GB of RAM">simon at rabbitmq.com
       </A><BR>
    <I>Wed Nov 23 16:40:54 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016498.html">[rabbitmq-discuss] rabbitmq-server crashes hard while consuming 31GB of RAM
</A></li>
        <LI>Next message: <A HREF="016530.html">[rabbitmq-discuss] rabbitmq-server crashes hard while consuming 31GB of RAM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16508">[ date ]</a>
              <a href="thread.html#16508">[ thread ]</a>
              <a href="subject.html#16508">[ subject ]</a>
              <a href="author.html#16508">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/11/11 15:05, Muharem Hrnjadovic wrote:
&gt;<i> Please see the &quot;sudo rabbitmqctl report&quot; link on:
</I>&gt;<i>      <A HREF="https://bugs.launchpad.net/openquake/+bug/894024/comments/1">https://bugs.launchpad.net/openquake/+bug/894024/comments/1</A>
</I>
Hi. Thanks for this.

There are a number of interesting things going on:

1) Your &quot;rabbitmqctl report&quot; invocation shows about 28000 channels open 
and no connections. Did you edit connection details out of this?

2) About 9GB of memory is used by binaries. This may indicate that you 
have some large messages around - are your messages particularly large?

3) While the memory alarm was set and cleared a number of times, in the 
end the Erlang VM crashed with:

   no next heap size found: -2106532246, offset 0
   Aborted

This error message indicates that the Erlang VM was not available to 
increase the heap size of a particular process as it ran off the end of 
a table of permitted heap sizes. On a 64GB machine the maximum heap size 
is 6.6 Exabytes: I hope you did not run in to that. Unfortunately there 
is a bug in Erlang R13 which garbles the error message above (hence why 
the alleged heap size is a negative number). So:

3a) is this a 64 bit machine?

3b) Can you run:

su rabbitmq -s /bin/sh -c 'erl -remsh rabbit@`hostname -s` -sname foo 
-eval &quot;io:format(\&quot;~p\&quot;, 
[lists:sublist(lists:reverse(lists:sort([{process_info(Pid, memory), 
Pid, process_info(Pid)} || Pid &lt;- processes()])), 30)]), halt().&quot;'

(all on one line, as root) when rabbit is eating a lot of memory and 
send us the output? This should let us see if there are individual 
processes that are eating huge amounts of memory.

3c) Can you upgrade the Erlang VM to see if we can get a better version 
of that error message? Updated debs are available at:

  <A HREF="http://www.erlang-solutions.com/section/132/erlang-otp-packages">http://www.erlang-solutions.com/section/132/erlang-otp-packages</A>

Due to limitations in dpkg you might need to:

# apt-get remove erlang-base
# dpkg -i esl-erlang_14.b.4-1_amd64.deb
# apt-get install erlang-nox
# dpkg -i rabbitmq-server_2.7.0-1_all.deb

(Yes, this is less than ideal but we've only just found out about the 
ESL packages...)

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016498.html">[rabbitmq-discuss] rabbitmq-server crashes hard while consuming 31GB of RAM
</A></li>
	<LI>Next message: <A HREF="016530.html">[rabbitmq-discuss] rabbitmq-server crashes hard while consuming 31GB of RAM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16508">[ date ]</a>
              <a href="thread.html#16508">[ thread ]</a>
              <a href="subject.html#16508">[ subject ]</a>
              <a href="author.html#16508">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
