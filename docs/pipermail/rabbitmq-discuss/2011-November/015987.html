<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Active/Active failover and lost messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active/Active%20failover%20and%20lost%20messages&In-Reply-To=%3C20111104161022.GB31860%40wellquite.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015979.html">
   <LINK REL="Next"  HREF="016005.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Active/Active failover and lost messages</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active/Active%20failover%20and%20lost%20messages&In-Reply-To=%3C20111104161022.GB31860%40wellquite.org%3E"
       TITLE="[rabbitmq-discuss] Active/Active failover and lost messages">matthew at rabbitmq.com
       </A><BR>
    <I>Fri Nov  4 16:10:23 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="015979.html">[rabbitmq-discuss] Active/Active failover and lost messages
</A></li>
        <LI>Next message: <A HREF="016005.html">[rabbitmq-discuss] Active/Active failover and lost messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15987">[ date ]</a>
              <a href="thread.html#15987">[ thread ]</a>
              <a href="subject.html#15987">[ subject ]</a>
              <a href="author.html#15987">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Konstantin,

On Thu, Nov 03, 2011 at 02:19:51PM -0700, Konstantin Kalin wrote:
&gt;<i> I'm playing with RabbitMQ in Active/Active mode (Mirrored queues). I
</I>&gt;<i> think it's very good product. Currently I have an issue and I could
</I>&gt;<i> not find a reason for that. I would like to understand if I use
</I>&gt;<i> RabbitMQ not correctly.
</I>&gt;<i> My setup is:
</I>&gt;<i>  a) 3 cluster nodes (2 disc, 1 ram)
</I>&gt;<i>  b) 50 publishers/consumers. All publishers and consumers are
</I>&gt;<i> distributed between nodes.
</I>&gt;<i>  c) Message publishing rate is about 15 messages per second per
</I>&gt;<i> publisher.
</I>&gt;<i>  d) Publishers work with &quot;Publisher confirms&quot; mode
</I>&gt;<i>  e) Consumers work &quot;autoack=false&quot;
</I>&gt;<i>  f) A publisher or client knows about all nodes in the cluster and
</I>&gt;<i> does failover to another node if there is an issue with current
</I>&gt;<i> connection.
</I>
That all sounds fine, but you don't mention whether all 50 publishers
publish to the same queue and you have 50 consumers consuming from that
queue, or whether each pair of publisher+consumer have an individual
queue between them.

&gt;<i> If I stop a node some consumers don't get all messages (even a
</I>&gt;<i> consumer is connected with another node). About 2-3 messages are
</I>&gt;<i> lost.
</I>
Without understanding your topology better, I'm not quite sure how to
interpret that.

&gt;<i> I did several tests and found a correlation. Only consumers getting
</I>&gt;<i> &quot;ConsumerCancelledException&quot; lose the messages. Other consumers don't
</I>&gt;<i> lose any messages even if they are connected with the node I stop.
</I>&gt;<i> Could you please advise what I need to check to find a reason of the
</I>&gt;<i> issue?
</I>
Ok, so that looks like you're using the Java client? Are you also using
the QueueingConsumer? It's possible that if not, you've been sent some
messages but they've being overtaken by the exception in some way. If
you use the QueueingConsumer, that shouldn't happen. However, that said,
for other reasons, if this was occurring, I'd expect you to be resent
such messages when you reconsumed from the queue.

I've recently improved our MulticastMain java example so that it copes
transparently with the ConsumerCancelledException (though I've actually
not used it to verify the absence of message loss).

<A HREF="http://hg.rabbitmq.com/rabbitmq-java-client/file/15f36113ffd3/test/src/com/rabbitmq/examples/MulticastMain.java">http://hg.rabbitmq.com/rabbitmq-java-client/file/15f36113ffd3/test/src/com/rabbitmq/examples/MulticastMain.java</A>
from line 442 onwards may be of use. Oh yes, I discovered when doing
that QueueingConsumers are not reusable - you really do have to create a
new one whenever you resubscribe. That bit me for a while...


Best wishes,

Matthew
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015979.html">[rabbitmq-discuss] Active/Active failover and lost messages
</A></li>
	<LI>Next message: <A HREF="016005.html">[rabbitmq-discuss] Active/Active failover and lost messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15987">[ date ]</a>
              <a href="thread.html#15987">[ thread ]</a>
              <a href="subject.html#15987">[ subject ]</a>
              <a href="author.html#15987">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
