<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] HA - missing or incompletely replicated	queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20HA%20-%20missing%20or%20incompletely%20replicated%0A%09queues&In-Reply-To=%3CCAGn3ETGwVAtVF21piwwCK0Xdd-cTW_s%2Beb4_jZgu9dMcscTmrQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016019.html">
   <LINK REL="Next"  HREF="016021.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] HA - missing or incompletely replicated	queues</H1>
    <B>Ashley Brown</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20HA%20-%20missing%20or%20incompletely%20replicated%0A%09queues&In-Reply-To=%3CCAGn3ETGwVAtVF21piwwCK0Xdd-cTW_s%2Beb4_jZgu9dMcscTmrQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] HA - missing or incompletely replicated	queues">ashley at spider.io
       </A><BR>
    <I>Mon Nov  7 14:15:23 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016019.html">[rabbitmq-discuss] HA - missing or incompletely replicated	queues
</A></li>
        <LI>Next message: <A HREF="016021.html">[rabbitmq-discuss] HA - missing or incompletely replicated	queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16020">[ date ]</a>
              <a href="thread.html#16020">[ thread ]</a>
              <a href="subject.html#16020">[ subject ]</a>
              <a href="author.html#16020">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>
</I>&gt;<i> You're aware that there is no eager synchronisation of HA queues, yes?
</I>&gt;<i> So it's only by the unsynchronised head of each queue being consumed
</I>&gt;<i> that synchronisation occurs.
</I>

Yes, I allow this to happen.


&gt;<i> Did the previously downed node really come back up and join the cluster
</I>&gt;<i> correctly? Does the output of rabbitmqctl cluster_status on each of the
</I>&gt;<i> 3 nodes report all 3 nodes are running?
</I>

I couldn't tell you that without starting the tests again, but the
management plugin reports they are all up, and producers + consumers
reconnect to the downed node once it has come back up without problems.


&gt;<i> &gt; I've also found that sometimes queues stop delivering messages when
</I>&gt;<i> certain
</I>&gt;<i> &gt; nodes go down (even after being left for minutes), despite being in HA
</I>&gt;<i> mode
</I>&gt;<i> &gt; (haven't been able to dig into this more yet).
</I>&gt;<i>
</I>&gt;<i> When this happens, could you check the logs please on all nodes for any
</I>&gt;<i> entries regarding the queues. If a node with a queue master goes down
</I>&gt;<i> then there should be entries about some slave on another node being
</I>&gt;<i> promoted, but even if it's just a slave that dies, there should be
</I>&gt;<i> entries in the logs that show others have noticed that.
</I>

Yes, will look for that.


&gt;<i> &gt; Sometimes connections to nodes which have gone down are still shown
</I>&gt;<i> &gt; and get stuck.
</I>&gt;<i>
</I>&gt;<i> Interesting. That might be a bug in the mgmt plugin. Does rabbitmqctl
</I>&gt;<i> list_connections also show such phantom connections?
</I>

Will check next time I see it - running some more tests this PM.


&gt;<i> &gt; Today, while bringing up the cluster from scratch (shutdown all
</I>&gt;<i> instances,
</I>&gt;<i> &gt; wipe mnesia, restart) I've got 3 nodes running, but an HA queue with 1
</I>&gt;<i> &gt; master, 2 synced slaves and 1 unsynced slave. Other queues are showing 1
</I>&gt;<i> &gt; master and 2 synced slaves as expected. (see
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://www.evernote.com/shard/s53/sh/b6345885-88d1-4d21-9614-24abda75a1cb/c2a0dd265b39d21f3e8c336c67ced979">http://www.evernote.com/shard/s53/sh/b6345885-88d1-4d21-9614-24abda75a1cb/c2a0dd265b39d21f3e8c336c67ced979</A>
</I>&gt;<i> &gt; )
</I>&gt;<i>
</I>&gt;<i> Well, drain the &quot;unsynced&quot; queue and it'll become synced.
</I>

My issue here is that for this one queue, it claims to have more copies of
the queue than nodes in the cluster. Trying to check if this is a plugin
bug with list_queues (list_queues name slave_pids synchronised_slave_pids),
I can't get the cluster to list them at all, it just sits there (for the
last 15 minutes).

A
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111107/372d65c8/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111107/372d65c8/attachment.htm</A>&gt;
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016019.html">[rabbitmq-discuss] HA - missing or incompletely replicated	queues
</A></li>
	<LI>Next message: <A HREF="016021.html">[rabbitmq-discuss] HA - missing or incompletely replicated	queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16020">[ date ]</a>
              <a href="thread.html#16020">[ thread ]</a>
              <a href="subject.html#16020">[ subject ]</a>
              <a href="author.html#16020">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
