<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cluster Memory Usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20Memory%20Usage&In-Reply-To=%3CCAChq9g0jOixn%3DzN4dM3iJ6ArpYzPUspGoudi%3DFJrBXcU4DZfHw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016434.html">
   <LINK REL="Next"  HREF="016437.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cluster Memory Usage</H1>
    <B>Travis</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20Memory%20Usage&In-Reply-To=%3CCAChq9g0jOixn%3DzN4dM3iJ6ArpYzPUspGoudi%3DFJrBXcU4DZfHw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Cluster Memory Usage">hcoyote at ghostar.org
       </A><BR>
    <I>Mon Nov 21 23:14:20 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016434.html">[rabbitmq-discuss] Cluster Memory Usage
</A></li>
        <LI>Next message: <A HREF="016437.html">[rabbitmq-discuss] Cluster Memory Usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16435">[ date ]</a>
              <a href="thread.html#16435">[ thread ]</a>
              <a href="subject.html#16435">[ subject ]</a>
              <a href="author.html#16435">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Nov 21, 2011 at 4:50 PM, Matthias Radestock
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt; wrote:
&gt;<i> Travis,
</I>&gt;<i>
</I>&gt;<i> On 21/11/11 22:16, Travis wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes. &#160;We've seen this problem when there are only a few dozen messages
</I>&gt;&gt;<i> and when there are hundreds of thousands.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Basically, it seems like the slave is always taking up 2-5x the amount
</I>&gt;&gt;<i> of memory that the master uses.
</I>&gt;<i>
</I>&gt;<i> In my tests the slave uses a bit less memory than the master, which is what
</I>&gt;<i> I would expect in a relatively lightly loaded system when there are no
</I>&gt;<i> connections to the slave node.
</I>&gt;<i>
</I>&gt;&gt;<i> Looking at the two servers, the slave shows that it's beam.smp has
</I>&gt;&gt;<i> spent 12 more hours on cpu than the beam.smp on the master. &#160;This
</I>&gt;&gt;<i> doesn't make sense to me if the slave is doing less work because it's
</I>&gt;&gt;<i> only handling traffic coming from the master.
</I>&gt;<i>
</I>&gt;<i> That's odd indeed. In my test I see the slave getting by with less than half
</I>&gt;<i> the CPU utilisation of the master.
</I>&gt;<i>
</I>&gt;<i> Do you see this memory and CPU pattern - with the slave using more than the
</I>&gt;<i> master - all the time, including shortly after a restart?
</I>
It usually takes some time to build up to this state.  Basically when
we get into it, the remote rabbits are only able to shovel data in at
a very small trickle (on the order of tens of messages a second).

We presume that what's happening is that the slave is bouncing in and
out of the vm_memory_high_watermark warning state causing the master
to slow down sending messages to the slave.  The master would then
tell everything up stream to slow down because it wasn't able to
handle messages fast enough.  We thought killing the slave would get
the master out of this state since it wouldn't be attempting to pass
messages to it.  But, this is not the case.  The throughput doesn't go
back up to &quot;normal&quot; levels until we restart the master.

In today's case, we were seeing about 40-80 messages a second being
delivered when in this weird state, both before and after the slave
was stopped.  When we restarted the master, we began seeing about 4000
messages a second being delivered.  So, something strange is
definitely occurring.


&gt;<i>
</I>&gt;<i> I still haven't got a good trail to follow here. One thing to look at is the
</I>&gt;<i> output of 'rabbitmqctl report' when the system is in the &quot;excessive memory
</I>&gt;<i> use&quot; state. Please send us that.
</I>
I can do that when we next get into this state; it takes a day or two
between restarts of the service.  Unfortunately, we had to restart
both the master and slave about 30 minutes ago because we had a
backlog of about a million messages queued on the shoveling rabbitmq's
that just weren't making it to the cluster in a timely manner.  For
reference, we're only pushing about 14 million messages through the
cluster a day, which doesn't seem like a lot to us.

Travis
-- 
Travis Campbell
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">travis at ghostar.org</A>
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016434.html">[rabbitmq-discuss] Cluster Memory Usage
</A></li>
	<LI>Next message: <A HREF="016437.html">[rabbitmq-discuss] Cluster Memory Usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16435">[ date ]</a>
              <a href="thread.html#16435">[ thread ]</a>
              <a href="subject.html#16435">[ subject ]</a>
              <a href="author.html#16435">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
