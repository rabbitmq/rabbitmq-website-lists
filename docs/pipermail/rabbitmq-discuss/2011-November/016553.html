<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] publisher confirmations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20publisher%20confirmations&In-Reply-To=%3C2f9ce68b-ce6a-4a67-b650-8ab433e2e502%40n10g2000vbg.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016590.html">
   <LINK REL="Next"  HREF="016563.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] publisher confirmations</H1>
    <B>bergundy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20publisher%20confirmations&In-Reply-To=%3C2f9ce68b-ce6a-4a67-b650-8ab433e2e502%40n10g2000vbg.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] publisher confirmations">roey.berman at gmail.com
       </A><BR>
    <I>Sun Nov 27 15:20:11 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016590.html">[rabbitmq-discuss] Website change suggestions
</A></li>
        <LI>Next message: <A HREF="016563.html">[rabbitmq-discuss] publisher confirmations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16553">[ date ]</a>
              <a href="thread.html#16553">[ thread ]</a>
              <a href="subject.html#16553">[ subject ]</a>
              <a href="author.html#16553">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone,

I couldn't find code for implementing publisher confirmations.

I wrote this piece of code using pika 0.9.5 (python client).
Would like to get feedback on this, I hope I got it right ...

---
class ConfirmingProducer(object):
    def __init__(self, channel):
        self.delivery_tag = 1
        self.acked        = 0
        self._callbacks   = {}
        self.chan = channel
        self.chan.confirm_delivery(self.on_delivered)

    def publish(self, message, callback, **kwargs):
        self._callbacks[self.delivery_tag] = callback
        self.delivery_tag += 1
        self.chan.basic_publish(message, **kwargs)

    def on_delivered(self, frame):
        success = isinstance(frame.method, pika.spec.Basic.Ack)

        if frame.method.multiple:
            for dtag in range(self.acked+1, frame.method.delivery_tag
+1):
                self._callbacks.pop(dtag)(success)
            self.acked = frame.method.delivery_tag
        else:
            self._callbacks.pop(frame.method.delivery_tag)(success)
            self.acked += 1
</PRE>



































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016590.html">[rabbitmq-discuss] Website change suggestions
</A></li>
	<LI>Next message: <A HREF="016563.html">[rabbitmq-discuss] publisher confirmations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16553">[ date ]</a>
              <a href="thread.html#16553">[ thread ]</a>
              <a href="subject.html#16553">[ subject ]</a>
              <a href="author.html#16553">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
