<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] HA - missing or incompletely replicated	queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20HA%20-%20missing%20or%20incompletely%20replicated%0A%09queues&In-Reply-To=%3C20111130145120.GB29890%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016661.html">
   <LINK REL="Next"  HREF="016094.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] HA - missing or incompletely replicated	queues</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20HA%20-%20missing%20or%20incompletely%20replicated%0A%09queues&In-Reply-To=%3C20111130145120.GB29890%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] HA - missing or incompletely replicated	queues">matthew at rabbitmq.com
       </A><BR>
    <I>Wed Nov 30 14:51:21 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016661.html">[rabbitmq-discuss] HA - missing or incompletely replicated	queues
</A></li>
        <LI>Next message: <A HREF="016094.html">[rabbitmq-discuss] HA - missing or incompletely	replicated	queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16664">[ date ]</a>
              <a href="thread.html#16664">[ thread ]</a>
              <a href="subject.html#16664">[ subject ]</a>
              <a href="author.html#16664">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Nov 30, 2011 at 02:22:16PM +0000, Matthew Sackman wrote:
&gt;<i> 1. Make sure you set basic.qos, but don't set it to a very low number.
</I>&gt;<i> Often something around 100 to 1000 often works well. Call this number N.
</I>&gt;<i> 
</I>&gt;<i> 2. Rather than acking every single message, instead only ack every N / 2
</I>&gt;<i> (for example), and when you do ack, turn on the multiple flag.
</I>
For example:

-module(test).
-compile([export_all]).

-include_lib(&quot;amqp_client/include/amqp_client.hrl&quot;).

mirror_create_delete(Count, N, Delay) -&gt;
    {ok, Conn} = amqp_connection:start(#amqp_params_network{}),
    {ok, Chan} = amqp_connection:open_channel(Conn),
    #'queue.declare_ok' { queue = Q } =
        amqp_channel:call(
          Chan,
          #'queue.declare'{ queue     = mirror_queue(),
                            durable   = true,
                            exclusive = false,
                            arguments = [{&lt;&lt;&quot;x-ha-policy&quot;&gt;&gt;, longstr, &lt;&lt;&quot;all&quot;&gt;&gt;}]}),

    Msg = #amqp_msg { props = #'P_basic'{ delivery_mode = 1 }, payload = &lt;&lt;&quot;hello&quot;&gt;&gt; },
    Publish = #'basic.publish'{ routing_key = Q },

    M = N div 2,

    spawn(fun () -&gt;
                  {ok, Chan2} = amqp_connection:open_channel(Conn),

                  #'basic.qos_ok'{} =
                      amqp_channel:call(Chan2, #'basic.qos'{ prefetch_count = N }),
                  #'basic.consume_ok' { consumer_tag = Tag } =
                      amqp_channel:subscribe(Chan2, #'basic.consume' { queue = Q }, self()),
                  [begin
                       timer:sleep(Delay),
                       receive
                           {#'basic.deliver'{ delivery_tag = AckTag }, _Content} -&gt;
                               case C rem M of
                                   0 -&gt;
                                       amqp_channel:cast(Chan2, #'basic.ack'{ delivery_tag = AckTag,
                                                                              multiple = true });
                                   _ -&gt; ok
                               end
                       after 30000 -&gt;
                               amqp_channel:call(Chan2, #'basic.cancel'{ consumer_tag = Tag }),
                               amqp_channel:close(Chan2),
                               exit(normal)
                       end
                   end || C &lt;- lists:seq(1, Count)]
          end),

    [amqp_channel:cast(Chan, Publish, Msg) || _ &lt;- lists:seq(1, Count)],

    timer:sleep(10000),

    amqp_channel:call(Chan, #'queue.delete'{ queue = Q }),
    amqp_connection:close(Conn).



If you try running this with too small a Delay then you'll find a large
backlog builds up:

(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">amqp_client at hazel</A>)2&gt; test:mirror_create_delete(500000, 1000, 0). 

Does not perform well at all: the queue constantly reports that it's
empty because whenever it receives a message, it sends it out to the
consumer, and almost as soon as it has sent out the 1000th msg, it
gets an ack back for the first 500 msgs, so has no &quot;spare&quot; time to
process its backlog. Queue ingress and egress rates don't get above 1kHz
for me, and are frequently down at 100Hz.

However, if you simulate the consumer doing something a bit more complex
by increasing the delay then you get much better performance:

test:mirror_create_delete(500000, 1000, 5). 

Once the queue has sent out the first 1000 msgs to the consumer,
there'll then be a helpful gap before the first ack arrives. During this
time, the queue churns through a good chunk of its backlog. After this,
egress stays around 100Hz (not surprising - a 5ms processing time per
message would give a max of 200Hz egress), but ingress jumps up to
around 10kHz, and everything's much happier.

Even with

test:mirror_create_delete(500000, 1000, 1).

things are happier - the delay is sufficent. I see peaks of ingress at
20kHz and egress at 500Hz.


Matthew
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016661.html">[rabbitmq-discuss] HA - missing or incompletely replicated	queues
</A></li>
	<LI>Next message: <A HREF="016094.html">[rabbitmq-discuss] HA - missing or incompletely	replicated	queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16664">[ date ]</a>
              <a href="thread.html#16664">[ thread ]</a>
              <a href="subject.html#16664">[ subject ]</a>
              <a href="author.html#16664">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
