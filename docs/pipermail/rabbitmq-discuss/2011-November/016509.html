<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Messages disappearing from queues when clustered	brokers are restarted.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Messages%20disappearing%20from%20queues%20when%20clustered%0A%09brokers%20are%20restarted.&In-Reply-To=%3C2b52f8ec-d00f-479f-9a8d-9b4cc6264b26%40r9g2000vbw.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016499.html">
   <LINK REL="Next"  HREF="016510.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Messages disappearing from queues when clustered	brokers are restarted.</H1>
    <B>Andreas Lundberg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Messages%20disappearing%20from%20queues%20when%20clustered%0A%09brokers%20are%20restarted.&In-Reply-To=%3C2b52f8ec-d00f-479f-9a8d-9b4cc6264b26%40r9g2000vbw.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Messages disappearing from queues when clustered	brokers are restarted.">andreas.lundberg at integrasco.no
       </A><BR>
    <I>Wed Nov 23 16:44:55 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016499.html">[rabbitmq-discuss] [Slightly OT] JNDI in non-webcontainers?
</A></li>
        <LI>Next message: <A HREF="016510.html">[rabbitmq-discuss] Messages disappearing from queues when clustered brokers are restarted.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16509">[ date ]</a>
              <a href="thread.html#16509">[ thread ]</a>
              <a href="subject.html#16509">[ subject ]</a>
              <a href="author.html#16509">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi.

We have a problem where messages are disappearing from queues when
broker is restarted.

Case:
We running a test scenario of RabbitMQ 2.7 with several queues, where
we have two brokers (nodes) in cluster running on two different
RabbitMQ servers on two different machines.
We are testing with durable queues and persistent messages where we
execute the following procedure on the brokers:

1. Declare multiple queues and populate them with several messages
2. Restart the &quot;master&quot; broker(A) (and wait to the other broker (B)
becomes master)
3. Restart broker(B) and wait to broker(A) becomes master

Problem:

Wen we restart the &quot;master&quot; broker(A) everything behave as it should
and the other broker(B) becomes master,
but when we restart broker B(the new master) every message in every
queue disappears, but the brokers seems to run as normal.

Is there any way to prevent this kind of message loss, and why does it
happen?

Cluster setup:

* We follow the Clustering guide @ <A HREF="http://www.rabbitmq.com/clustering.html">http://www.rabbitmq.com/clustering.html</A>
to set up the cluster.
* Both brokers in clusters is set up to be disk nodes.

1. Setting up both machines with same cookie
2. Executing rabbitmq -detached to create independent broker on both
machines.
3. Execute rabbitmqctl cluster <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at brokerB</A> on machine A
4. Execute rabbitmqctl cluster <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at brokerA</A> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at brokerB</A> on
machine A (To make sure both brokers are disc nodes)

This results in two brokers(A and B) in a cluster, where both brokers
are disc nodes.

Executing rabbitmqctl cluster_status returns the following:
[{nodes,[{disc,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at brokerA</A>,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at brokerB</A>']}]},
 {running_nodes,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at brokerA</A>,'<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at brokerB</A>']}]


Queue setup:

We call declare queue (queueDeclare) with durable = true and RabbitMQ
properties containing x-ha-policy set to &quot;all&quot;
We also call publish (basicPublish) with PERSISTENT_BASIC
(deliveryMode 2 (persistent)).
We use publish confirms instead of transactions.



Hints and suggestions are highly appreciated.
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016499.html">[rabbitmq-discuss] [Slightly OT] JNDI in non-webcontainers?
</A></li>
	<LI>Next message: <A HREF="016510.html">[rabbitmq-discuss] Messages disappearing from queues when clustered brokers are restarted.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16509">[ date ]</a>
              <a href="thread.html#16509">[ thread ]</a>
              <a href="subject.html#16509">[ subject ]</a>
              <a href="author.html#16509">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
