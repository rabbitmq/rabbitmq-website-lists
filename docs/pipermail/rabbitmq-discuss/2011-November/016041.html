<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Stuck waiting for frame during	amqp_basic_qos?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stuck%20waiting%20for%20frame%20during%0A%09amqp_basic_qos%3F&In-Reply-To=%3Cyrv4c7h3ahjfb.fsf%40dwragg.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016033.html">
   <LINK REL="Next"  HREF="016052.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Stuck waiting for frame during	amqp_basic_qos?</H1>
    <B>David Wragg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Stuck%20waiting%20for%20frame%20during%0A%09amqp_basic_qos%3F&In-Reply-To=%3Cyrv4c7h3ahjfb.fsf%40dwragg.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] Stuck waiting for frame during	amqp_basic_qos?">david at rabbitmq.com
       </A><BR>
    <I>Tue Nov  8 12:45:28 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016033.html">[rabbitmq-discuss] Stuck waiting for frame during amqp_basic_qos?
</A></li>
        <LI>Next message: <A HREF="016052.html">[rabbitmq-discuss] Stuck waiting for frame during amqp_basic_qos?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16041">[ date ]</a>
              <a href="thread.html#16041">[ thread ]</a>
              <a href="subject.html#16041">[ subject ]</a>
              <a href="author.html#16041">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Pieter,

Pieter de Zwart &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pdezwart at rubiconproject.com</A>&gt; writes:
&gt;<i> I am doing something wrong, and I could use some help.  I
</I>&gt;<i> maintain/develop the PHP extension that interfaces with RabbitMQ via
</I>&gt;<i> the rabbitmq-c library. We have implemented all of the low level
</I>&gt;<i> calls, but have also added some helpful wrappers to let poor PHP users
</I>&gt;<i> not have to deal with all the complexity of the protocol. One of these
</I>&gt;<i> wrapper methods is AMQPQueue::getMessages(). Unfortunately, I have
</I>&gt;<i> built a bug I don&#8217;t know how to squash.
</I>&gt;<i>
</I>&gt;<i> During the second call to the AMQPQueue::getMessages() function within
</I>&gt;<i> a loop (reusing connection and channel), the process get stuck in busy
</I>&gt;<i> wait. In the attached file on line 37, we call amqp_basic_qos() to
</I>&gt;<i> prevent any prefetching by the server. That call goes through the
</I>&gt;<i> following stack in rabbitmq-c:
</I>&gt;<i>
</I>&gt;<i> librabbitmq/amqp_framing.c:1999: amqp_basic_qos
</I>&gt;<i> librabbitmq/amqp_socket.c:356: amqp_simple_rpc_decoded
</I>&gt;<i> librabbitmq/amqp_socket.c:264: amqp_simple_rpc
</I>&gt;<i> librabbitmq/amqp_socket.c:157: wait_frame_inner
</I>&gt;<i>
</I>&gt;<i> And then it gets stuck in that while(1) loop.
</I>
Nothing stands out as being obviously wrong in your code (I do notice
one issue, but it is not responsible for the problem you describe).

If you think you can guide a PHP newbie through how to trigger the
problem within PHP, I'd be happy to try.

Here is the issue I mentioned:

&gt;<i> 	/* Set the QOS for this channel to match the max_messages */
</I>&gt;<i> 	amqp_basic_qos(
</I>&gt;<i> 		connection-&gt;connection_resource-&gt;connection_state,
</I>&gt;<i> 		channel-&gt;channel_id,
</I>&gt;<i> 		0,						/* prefetch window size */
</I>&gt;<i> 		0,						/* prefetch message count */
</I>&gt;<i> 		0						/* global flag */
</I>&gt;<i> 	);
</I>
The AMQP terminology here is a bit confusing.  Setting the prefetch
count to 0 does not mean &quot;no prefetch&quot;.  The prefetch count represents a
limit on the number of unacked messages for the channel/connection.
Actually setting it to zero wouldn't make sense, as the server would not
be able to deliver any messages to the client.  So a prefetch count of
zero is specified to mean &quot;no limit&quot;.

Instead, you should set the prefetch count to one, meaning &quot;allow me to
have one unacked message, but no more&quot;.  In other words, no messages are
prefetched.

The prefetch size should be left as zero, because you don't want to
limit that.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
VMware, Inc.
</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016033.html">[rabbitmq-discuss] Stuck waiting for frame during amqp_basic_qos?
</A></li>
	<LI>Next message: <A HREF="016052.html">[rabbitmq-discuss] Stuck waiting for frame during amqp_basic_qos?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16041">[ date ]</a>
              <a href="thread.html#16041">[ thread ]</a>
              <a href="subject.html#16041">[ subject ]</a>
              <a href="author.html#16041">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
