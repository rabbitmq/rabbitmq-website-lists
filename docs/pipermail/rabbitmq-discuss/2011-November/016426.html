<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Rabbitmq 2.5-2.6.1 java hanging on close of	connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rabbitmq%202.5-2.6.1%20java%20hanging%20on%20close%20of%0A%09connection&In-Reply-To=%3CCAGnU7uhPjyUWkhWf82Vj-LmxwSijM6kUx9%3D%3DMEEDx6ykGWw0vA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016422.html">
   <LINK REL="Next"  HREF="016591.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Rabbitmq 2.5-2.6.1 java hanging on close of	connection</H1>
    <B>Benjamin Bennett</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rabbitmq%202.5-2.6.1%20java%20hanging%20on%20close%20of%0A%09connection&In-Reply-To=%3CCAGnU7uhPjyUWkhWf82Vj-LmxwSijM6kUx9%3D%3DMEEDx6ykGWw0vA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Rabbitmq 2.5-2.6.1 java hanging on close of	connection">benbennett at gmail.com
       </A><BR>
    <I>Mon Nov 21 16:10:56 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016422.html">[rabbitmq-discuss] Rabbitmq 2.5-2.6.1 java hanging on close of connection
</A></li>
        <LI>Next message: <A HREF="016591.html">[rabbitmq-discuss] Rabbitmq 2.5-2.6.1 java hanging on close of connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16426">[ date ]</a>
              <a href="thread.html#16426">[ thread ]</a>
              <a href="subject.html#16426">[ subject ]</a>
              <a href="author.html#16426">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Our application is using the CachingConnectionFactory, Spring
Integration AMQP .
The way this is happening is just by applying the @DirtiesContext in
our unit test , that we need to reload the context, at that time the
channel close and connection close are closed in different threads.
The BlockingQueueConsumer is the one that end ups doing the channel
closes but the CachingConnectionFactory actually  does the closes .


The stacktraces have no other threads running except spring-amqp
threads BlockingQueueConsumer and CachingConnectionFactory.

My only comment about attracting attention it is a race condition ,
and race conditions are the most painful bugs to have to deal with.

On my dev box I have only seen the issue one time in 200 runs that ran
over night.
On our test windows 7 vms it happens 50% of the time, sample size was 40 runs.
On our windows xp test vms it has never happened.

In our production we get a &quot;The service failed to close in timely
manner&quot; and doesn't shut down.

Finally if you are fixing it in the server , what about the previous
versions? I don't even think spring-amqp has migrated to 2.7 series
java client because it is backwards incompatible.

Thanks,
Benjamin Bennett

On Mon, Nov 21, 2011 at 7:07 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:
&gt;<i> Hi Benjamin.
</I>&gt;<i>
</I>&gt;<i> In general we do accept patches, although due to our Corporate Overlords you
</I>&gt;<i> would have to sign a contributor agreement.
</I>&gt;<i>
</I>&gt;<i> I would be reluctant to merge such a patch though, since:
</I>&gt;<i>
</I>&gt;<i> * It's to work around a server bug which will be fixed in the next release
</I>&gt;<i>
</I>&gt;<i> * This bug has been around for most of a year without attracting much
</I>&gt;<i> attention
</I>&gt;<i>
</I>&gt;<i> * Option 1) is ugly; option 2) is (somewhat) complicated.
</I>&gt;<i>
</I>&gt;<i> BTW, I got a reply from the spring-amqp maintainer, Dave Syer:
</I>&gt;<i>
</I>&gt;&gt;<i> Spring AMQP doesn't explicitly invoke close() in different threads.
</I>&gt;&gt;<i> There's nothing to stop it happening (as is the case with the Java
</I>&gt;&gt;<i> client itself I suppose), but we actually hardly ever call
</I>&gt;&gt;<i> Channel.close() so it is pretty unlikely. &#160;I would be interested to
</I>&gt;&gt;<i> hear of a way to tickle a normal app into this behaviour.
</I>&gt;<i>
</I>&gt;<i> So I still wonder if the threading thing is something you are doing in your
</I>&gt;<i> app.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> On 17/11/11 18:12, Benjamin Bennett wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Had a question if no one is working on patch for the java client do
</I>&gt;&gt;<i> accept external patches?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I was going to either change it to the following .
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1) Remove the infinite wait on a connection close.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Or
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Place a BlockingQueue on the channel closes during the close call.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The sychronize on the BlockingQueue for the connection close &#160;, of
</I>&gt;&gt;<i> which it cannot close the connection if a channel is currently be
</I>&gt;&gt;<i> closed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The second is more code but it would keep the infinity timeout in
</I>&gt;&gt;<i> place will working around the deadlock issue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It would save a lot of pain if people are using 2.7.1 and below.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, Nov 14, 2011 at 5:21 PM, Benjamin Bennett&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">benbennett at gmail.com</A>&gt;
</I>&gt;&gt;<i> &#160;wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am using the spring amqp lib and it is doing the connection closing
</I>&gt;&gt;&gt;<i> when
</I>&gt;&gt;&gt;<i> the spring context is closed. I do not think it has a property to inject
</I>&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;<i> hack. Also if you know any of the spring amqp devs. Having you telling
</I>&gt;&gt;&gt;<i> them
</I>&gt;&gt;&gt;<i> to check to make sure it is doing the way you have described will have
</I>&gt;&gt;&gt;<i> much
</I>&gt;&gt;&gt;<i> more authority than me.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I will probably hack the spring amqp lib for now
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Nov 14, 2011 12:32 PM, &quot;Simon MacMullen&quot;&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; &#160;wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 14/11/11 16:15, Benjamin Bennett wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Here is report from &#160;rabbitmqctrl report
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://pastebin.com/MSwv82C3">http://pastebin.com/MSwv82C3</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Ah, thank you. After some poking, that genuinely looks like a server
</I>&gt;&gt;&gt;&gt;<i> bug.
</I>&gt;&gt;&gt;&gt;<i> Damn.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> In order for it to happen you need the last channel close / close_ok to
</I>&gt;&gt;&gt;&gt;<i> overlap with the connection close / close_ok. With the Java client you
</I>&gt;&gt;&gt;&gt;<i> have
</I>&gt;&gt;&gt;&gt;<i> to invoke Channel.close() and Connection.close() from different threads
</I>&gt;&gt;&gt;&gt;<i> to
</I>&gt;&gt;&gt;&gt;<i> get this to happen, and still be unlucky.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> You should be allowed to do this, but right now it's racy.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I was going to attempt to put a timeout on the connection close method
</I>&gt;&gt;&gt;&gt;&gt;<i> but that really would be a hack.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Indeed! Other slightly less hacky workarounds until we get this fixed:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> * Invoke Channel.close() and Connection.close() from the same thread, or
</I>&gt;&gt;&gt;&gt;<i> otherwise ensure they don't overlap.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> * Don't invoke Channel.close() if you know you're going to invoke
</I>&gt;&gt;&gt;&gt;<i> Connection.close() anyway.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Cheers, Simon
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> --
</I>&gt;&gt;&gt;&gt;<i> Simon MacMullen
</I>&gt;&gt;&gt;&gt;<i> RabbitMQ, VMware
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, VMware
</I>&gt;<i>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016422.html">[rabbitmq-discuss] Rabbitmq 2.5-2.6.1 java hanging on close of connection
</A></li>
	<LI>Next message: <A HREF="016591.html">[rabbitmq-discuss] Rabbitmq 2.5-2.6.1 java hanging on close of connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16426">[ date ]</a>
              <a href="thread.html#16426">[ thread ]</a>
              <a href="subject.html#16426">[ subject ]</a>
              <a href="author.html#16426">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
