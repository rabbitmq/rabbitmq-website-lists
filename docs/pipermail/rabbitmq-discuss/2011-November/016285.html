<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer connection closes abruptly after one	message
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20connection%20closes%20abruptly%20after%20one%0A%09message&In-Reply-To=%3C49d8ed6f-0864-44c7-b26a-9f6a8fa5c93b%40p2g2000vbj.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016273.html">
   <LINK REL="Next"  HREF="016286.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer connection closes abruptly after one	message</H1>
    <B>p2w</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20connection%20closes%20abruptly%20after%20one%0A%09message&In-Reply-To=%3C49d8ed6f-0864-44c7-b26a-9f6a8fa5c93b%40p2g2000vbj.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Consumer connection closes abruptly after one	message">tpletch001 at gmail.com
       </A><BR>
    <I>Wed Nov 16 15:25:58 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016273.html">[rabbitmq-discuss] Send message to rabbit server?
</A></li>
        <LI>Next message: <A HREF="016286.html">[rabbitmq-discuss] Consumer connection closes abruptly after	one message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16285">[ date ]</a>
              <a href="thread.html#16285">[ thread ]</a>
              <a href="subject.html#16285">[ subject ]</a>
              <a href="author.html#16285">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a rails 3.1 app (using thin server which is Event Machine
based) using the AMQP gem to connect to two server cluster on EC2. the
broker is running on ubuntu 11.10 and is version 2.6.1 with erlang
version 5.8.3.

I have an initializer that connects to and subscribes to a specifc
queue. when i place a single message into the queue then start the
server it consumes the message properly and the management console
shows a consumer attached to the queue, all good so far. then when i
place another message into the queue it gets consumed, but subsequent
to that message being consumed the broker log shows a &quot;connection
closed abruptly&quot; error and of course the consumer gets cut off.

I'm sure I'm doing something wrong in the initializer but can't figure
out what as its really pretty vanilla. Any help greatly appreciated...

here's the initializer code:

-------------------------------------------------------
connect_params = YAML::load_file(File.join(Rails.root, &quot;config&quot;,
&quot;rabbitmq.yml&quot;))[Rails.env]

EventMachine.next_tick {
  AMQP.connect(connect_params['uri'], :auto_delete =&gt; false) do |
connection, open_ok|
    puts &quot;Connected to MQ Server to Retreive API Submissions...&quot;
    AMQP::Channel.new(connection) do |channel, open_ok|
      puts &quot;Channel ##{channel.id} is open...&quot;
      exchange = channel.direct('inbound', :durable =&gt; true)
      channel.on_error do |ch, close|
        puts &quot;Handling channel-level error&quot;
        connection.close
      end
      channel.queue('dropbox', :durable =&gt; true) do |queue,
declare_ok|
        queue.bind(exchange).subscribe do |metadata, payload|
          message_h = '#{metadata.headers}'
          message_p = '#{payload}'
          Resque.enqueue(ApiIntake, message_h, message_p)
        end
      end
   end
  end
  }
</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016273.html">[rabbitmq-discuss] Send message to rabbit server?
</A></li>
	<LI>Next message: <A HREF="016286.html">[rabbitmq-discuss] Consumer connection closes abruptly after	one message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16285">[ date ]</a>
              <a href="thread.html#16285">[ thread ]</a>
              <a href="subject.html#16285">[ subject ]</a>
              <a href="author.html#16285">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
