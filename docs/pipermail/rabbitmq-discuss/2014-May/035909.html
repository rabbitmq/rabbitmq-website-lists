<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] dotnet client - Increasing prefetch with BasicQoS during HandleBasicDeliver doesn't trigger retrieval of next message
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20dotnet%20client%20-%20Increasing%20prefetch%20with%0A%20BasicQoS%20during%20HandleBasicDeliver%20doesn%27t%20trigger%20retrieval%20of%20next%0A%20message&In-Reply-To=%3CCAAijfv0MBt34SMxCCZabz0yQur1Y-mnA%3D5wP%3DMzjaEs4qLBTCw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035904.html">
   <LINK REL="Next"  HREF="035893.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] dotnet client - Increasing prefetch with BasicQoS during HandleBasicDeliver doesn't trigger retrieval of next message</H1>
    <B>Jon Stelly</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20dotnet%20client%20-%20Increasing%20prefetch%20with%0A%20BasicQoS%20during%20HandleBasicDeliver%20doesn%27t%20trigger%20retrieval%20of%20next%0A%20message&In-Reply-To=%3CCAAijfv0MBt34SMxCCZabz0yQur1Y-mnA%3D5wP%3DMzjaEs4qLBTCw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] dotnet client - Increasing prefetch with BasicQoS during HandleBasicDeliver doesn't trigger retrieval of next message">jonstelly at gmail.com
       </A><BR>
    <I>Mon May 12 14:08:38 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035904.html">[rabbitmq-discuss] dotnet client - Increasing prefetch with BasicQoS during HandleBasicDeliver doesn't trigger retrieval of next message
</A></li>
        <LI>Next message: <A HREF="035893.html">[rabbitmq-discuss] Using Pika and PyQtGraph (Qt event loop and	BlockingConnection)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35909">[ date ]</a>
              <a href="thread.html#35909">[ thread ]</a>
              <a href="subject.html#35909">[ subject ]</a>
              <a href="author.html#35909">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Simon,

I've tried global as true and false for BasicQoS and see the same behavior.
 I've got some quick example code below that demonstrates the issue I'm
having and a zip archive of the project is available
here&lt;<A HREF="https://www.dropbox.com/s/x7q9e6ijuxzp9zn/RabbitQoSTest.zip">https://www.dropbox.com/s/x7q9e6ijuxzp9zn/RabbitQoSTest.zip</A>&gt;.
 I captured network traffic from WireShark and it seems that calling
BasicQoS() and increasing the prefetchCount, the qos change gets sent to
the server, and the server replies with a qos-ok, but the server doesn't
send more messages if the new prefetch count is greater than the
outstanding message count for the channel.  It's not until I Ack the first
message that the second one is sent.

It seems to me that an Ack from a client is causing the server to look at
the queue being consumed and do something like:

if(queue.has-messages &amp;&amp; channel.unacked-messages &lt; channel.prefetch-count)
    send-messages-to-channel-until-unacked-equals-prefetch-count(channel)

For the behavior I'd like to see, it seems like a call to basic.qos would
require the same logic.

Below is a snippet of my example code.  ActionConsumer is a simple
IBasicConsumer that invokes the action passed to it's constructor during
HandleBasicDeliver.  It also uses a simple extension method to List&lt;T&gt;
called WaitFor() which waits for the list to contain the specified number
of items.  I've added comments based on my network capture of this code
being executed.

Thanks for any help.  Right now, I've got a pretty ugly workaround, which
is that instead of increasing prefetch count and calling basicqos, I just
do a basicget, but this is definitely hacky and makes me poll using
basicget() on another thread, etc...

Thanks.


var consumer = new ActionConsumer(Model, message =&gt;
    Task.Run(() =&gt;
    {
        Log.DebugFormat(&quot;Received({0})&quot;, message);
        messages.Add(Encoding.UTF8.GetString(message.Body));
        if (messages.Count == 1)
        {
            //If this is the first message, send a second, set qos to 2 and
wait for second message to arrive
            Send(&quot;World&quot;); //This message gets sent immediately
            Log.Debug(&quot;BasicQoS(0, 2, false)&quot;);
            Model.BasicQos(0, 2, false); //QoS is sent to server
immediately, prefetch shows as 2 in management console
            Log.Debug(&quot;WaitFor(2, 5000)&quot;);
            messages.WaitFor(2, 5000); //While waiting, 2nd message will
not be received
            Log.DebugFormat(&quot;BasicAck({0}, false)&quot;, message.DeliveryTag);
            Model.BasicAck(message.DeliveryTag, false); //As soon as Ack is
sent, 2nd message is transmitted to client
            messages.WaitFor(2, 2500);
            Log.Debug(&quot;Finished task 1 processing&quot;);
        }
    }));

//Start consuming
Model.BasicConsume(queue, false, consumer);

//Send starter message
Send(&quot;Hello&quot;);
var ret = messages.WaitFor(2, 15000);


On Mon, May 12, 2014 at 4:08 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i> On 11/05/2014 04:55, Jon Stelly wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I have a sort of odd scenario.  I want to process 1 message at a time so
</I>&gt;&gt;<i> I call basic qos with a prefetch of 1 and call BasicConsume(), but
</I>&gt;&gt;<i> sometimes my processing will end in a long blocking task.  When that
</I>&gt;&gt;<i> happens, I would like to increase the qos prefetch to 2 to trigger the
</I>&gt;&gt;<i> next message to be received and processed.  The issue is that I don't
</I>&gt;&gt;<i> want to ack the first message until after the long blocking process
</I>&gt;&gt;<i> completes successfully.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I call BasicQoS before acking the first message, the 2nd message
</I>&gt;&gt;<i> isn't received until after the long running task completes and the ack
</I>&gt;&gt;<i> is sent.  Can anyone explain what's going on and possibly suggest an
</I>&gt;&gt;<i> alternative?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You are running 3.3.x? The new semantics for consumer prefetch mean that
</I>&gt;<i> setting basicQos after consuming will only define a prefetch for *new*
</I>&gt;<i> consumers. You could work around this by setting global=true.
</I>&gt;<i>
</I>&gt;<i> See <A HREF="http://www.rabbitmq.com/consumer-prefetch.html">http://www.rabbitmq.com/consumer-prefetch.html</A> for more information.
</I>&gt;<i>
</I>&gt;<i> I am starting to wonder if the global=false qos should set the prefetch
</I>&gt;<i> for all consumers on the channel; you wouldn't be able to have one channel
</I>&gt;<i> with multiple consumers with different prefetch, but this is an area that
</I>&gt;<i> seems to be unintuitive...
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140512/920bae26/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140512/920bae26/attachment.html</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035904.html">[rabbitmq-discuss] dotnet client - Increasing prefetch with BasicQoS during HandleBasicDeliver doesn't trigger retrieval of next message
</A></li>
	<LI>Next message: <A HREF="035893.html">[rabbitmq-discuss] Using Pika and PyQtGraph (Qt event loop and	BlockingConnection)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35909">[ date ]</a>
              <a href="thread.html#35909">[ thread ]</a>
              <a href="subject.html#35909">[ subject ]</a>
              <a href="author.html#35909">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
