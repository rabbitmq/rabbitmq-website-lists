<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ and batch processing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20and%20batch%20processing&In-Reply-To=%3CCAKgmDnG-sKm-eVb7msFp5ZnAjTDp7WC%2BAsq3JjQXstcyhERHTg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036061.html">
   <LINK REL="Next"  HREF="036089.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ and batch processing</H1>
    <B>Laing, Michael</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20and%20batch%20processing&In-Reply-To=%3CCAKgmDnG-sKm-eVb7msFp5ZnAjTDp7WC%2BAsq3JjQXstcyhERHTg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ and batch processing">michael.laing at nytimes.com
       </A><BR>
    <I>Mon May 19 00:50:28 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036061.html">[rabbitmq-discuss] RabbitMQ and batch processing
</A></li>
        <LI>Next message: <A HREF="036089.html">[rabbitmq-discuss] RabbitMQ and batch processing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36062">[ date ]</a>
              <a href="thread.html#36062">[ thread ]</a>
              <a href="subject.html#36062">[ subject ]</a>
              <a href="author.html#36062">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'll respond inline w our experience:

On Sun, May 18, 2014 at 2:55 PM, Greg Poirier &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">greg.poirier at opower.com</A>&gt;wrote:

&gt;<i> I mentioned this on Twitter and a couple of people have requested that I
</I>&gt;<i> bring this up on the mailing list.
</I>&gt;<i>
</I>&gt;<i> It seems to be a given that RabbitMQ was not designed for the batch
</I>&gt;<i> processing use case (i.e. using RabbitMQ as a buffer between large serial
</I>&gt;<i> steps). We have a system in place that attempts to do just that, however.
</I>&gt;<i>
</I>
It is not a 'given' as far as we are concerned. We have some processes that
result in a million or more messages being queued within a minute or so.
These messages are processed over the ensuing several minutes (for
'dismissals' of news items from individual devices) to several hours (for
lower-priority individualized  'offers'). This is the new 'batch'.


&gt;<i>
</I>&gt;<i> I have been working with the developers of the software involved in an
</I>&gt;<i> attempt to help them redesign around a more ideal use of RabbitMQ (or to
</I>&gt;<i> help them move to a different bus altogether -- database or something like
</I>&gt;<i> kafka) and some of them have been able to simply operate in smaller batch
</I>&gt;<i> sizes (thus keeping their queues relatively small).
</I>&gt;<i>
</I>
We put large message bodies in S3 and pass them by reference. We never use
RabbitMQ persistence and compensate for that with replication. For 'real'
persistence we use Cassandra. Most importantly, none of our internal users
know this, as we provide them with an abstracted interface.


&gt;<i>
</I>&gt;<i> However, I cannot stem the tide of improper RabbitMQ use.
</I>&gt;<i>
</I>
We try to make it easier to use us than not. We work hard to be the most
reliable, fastest, most scalable, most flexible and cheapest component of
our customers technology mix.


&gt;<i>
</I>&gt;<i> When things go poorly, millions of messages end up in the queues.
</I>&gt;<i>
</I>
We target zero length queues. If they grow unexpectedly we: 1) autoscale,
2) shift load, 3) start new regions - usually all those. Then we diagnose.


&gt;<i>
</I>&gt;<i> In 3.1.x we saw this regularly cause our clusters to partition.
</I>&gt;<i>
</I>
We have never had a partition in production because we always overprovision
RabbitMQ so it can maintain cluster communications. We basically avoid disk
IO due to the risk of IO wait interfering w the cluster heartbeat.


&gt;<i>
</I>&gt;<i> In 3.1.x and 3.2.x when we would delete large queues (5+ million messages
</I>&gt;<i> enqueued), this would cause the cluster to become unresponsive, run out of
</I>&gt;<i> memory, and then crash.
</I>&gt;<i>
</I>
When we have tested situations like this, we found it best to just wipe out
the cluster and restart. Before doing this, we shift the load to other
regions operating in parallel.


&gt;<i>
</I>&gt;<i> During the 3.1 -&gt; 3.2 upgrade, we had to completely rebuild our clusters.
</I>&gt;<i> When 3.2 came up, it soon crashed.
</I>&gt;<i>
</I>
We have not had that problem.


&gt;<i>
</I>&gt;<i> In the most recent upgrade, we saw a 3.2.3 cluster in our dev environment
</I>&gt;<i> crash. I performed an opportunistic upgrade to 3.3.1, because hey...
</I>&gt;<i> downtime already, so let's see if 3.3.1 addresses some of the issues we've
</I>&gt;<i> been seeing.
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://gist.github.com/grepory/384410ac90186ed0ce2a">https://gist.github.com/grepory/384410ac90186ed0ce2a</A>
</I>&gt;<i>
</I>&gt;<i> After the upgrade, 3.3.1 would not startup at all. I removed
</I>&gt;<i> /var/lib/rabbitmq/mnesia on all of the nodes and brought RabbitMQ back up.
</I>&gt;<i>
</I>
We are not yet in production w 3.3.1 but 3.2.4 is running solidly in stage
and we will upgrade stage to 3.3.1 this coming week.


&gt;<i>
</I>&gt;<i> 3.3.1 has been up and running alright so far, but we haven't done another
</I>&gt;<i> end-to-end test in our development environment in a while. One of these
</I>&gt;<i> tests can lead to at least a million messages in the queue over a period of
</I>&gt;<i> time on average.
</I>&gt;<i>
</I>
A million is not that many - depending on size of course. As I said - our
target is 0, but really the question is: what's your rate of change? I try
to have enough 'headroom' to easily handle the surges - volumes can vary 20
to 1 depending on the news of the moment etc. If a queue builds and stays
high we add resources until it goes down and then investigate.


&gt;<i>
</I>&gt;<i> So, I guess my question is:
</I>&gt;<i>
</I>&gt;<i> If I know that I have people using RabbitMQ like this, and there is
</I>&gt;<i> nothing I can do to change that fact... what do I do?
</I>&gt;<i>
</I>
You need enough resource. And it is good to be able to autoscale.

A specific suggestion I would make for any internal service provider is to
use an amqp proxy. We locate proxy clusters that we control in our internal
customers' computing environments. They publish to and subscribe from these
proxies. We control the shoveling/federation of the proxies to/from our
core pipelines in regions, redirecting as needed. The proxies are an
additional buffer and also allow us to 'launder' incoming messages, e.g. by
forcing persistence off.

We also track and account for every message using metadata, and can charge
back... We are cheap but not free.

Anyway, I hope this helps.

ml


&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140518/9202c7ab/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140518/9202c7ab/attachment.html</A>&gt;
</PRE>













































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036061.html">[rabbitmq-discuss] RabbitMQ and batch processing
</A></li>
	<LI>Next message: <A HREF="036089.html">[rabbitmq-discuss] RabbitMQ and batch processing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36062">[ date ]</a>
              <a href="thread.html#36062">[ thread ]</a>
              <a href="subject.html#36062">[ subject ]</a>
              <a href="author.html#36062">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
