<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Fully reliable setup impossible?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fully%20reliable%20setup%20impossible%3F&In-Reply-To=%3CCAD6m6fGxP%2B2zWVQsUVrTpyj4Nhf5gyz2gQkLLFjCqMdW_5uZyg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036223.html">
   <LINK REL="Next"  HREF="036239.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Fully reliable setup impossible?</H1>
    <B>Jason McIntosh</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fully%20reliable%20setup%20impossible%3F&In-Reply-To=%3CCAD6m6fGxP%2B2zWVQsUVrTpyj4Nhf5gyz2gQkLLFjCqMdW_5uZyg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Fully reliable setup impossible?">mcintoshj at gmail.com
       </A><BR>
    <I>Thu May 22 21:32:17 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036223.html">[rabbitmq-discuss] Fully reliable setup impossible?
</A></li>
        <LI>Next message: <A HREF="036239.html">[rabbitmq-discuss] Fully reliable setup impossible?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36225">[ date ]</a>
              <a href="thread.html#36225">[ thread ]</a>
              <a href="subject.html#36225">[ subject ]</a>
              <a href="author.html#36225">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Interesting piece of info on that F5 and the round robin and performance.
 We've got an F5 as well, with round-robin handling and mirrored persistent
queues.  Our biggest challenge was the number of persistent connections.
 We have over 4k connections to our main production environment right now,
so we try and even out the connections among our servers.  I may want to go
back and look and see if this was really a good idea....  But, we're pure
physical hardware and I don't think I've seen a network partition in the
last 6 months.  We maintain clusters in each center (well, most of our
stuff is actually local nodes that act as a temporary cache and shovel to
another data center for processing).

Jason


On Thu, May 22, 2014 at 3:04 PM, Ron Cordell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ron.cordell at gmail.com</A>&gt; wrote:

&gt;<i> It seems that one of your assumptions is that a cluster would operate
</I>&gt;<i> across data centers. This is not recommended for RabbitMQ and we don't use
</I>&gt;<i> it that way - we use shovels between clusters since we, like you, can deal
</I>&gt;<i> with eventual consistency.
</I>&gt;<i>
</I>&gt;<i> Our clusters are similar to what you describe. For us, (almost) all queues
</I>&gt;<i> are persistent and mirrored because we can't tolerate message loss. We have
</I>&gt;<i> seen significant sensitivity to partitioning in Windows OS-based clusters
</I>&gt;<i> under very heavy load; we do not see this on Linux and can run at least
</I>&gt;<i> twice the load as well.
</I>&gt;<i>
</I>&gt;<i> There is an F5 in front of the cluster, but it doesn't do load balancing
</I>&gt;<i> but just acts as a persistent router. We've found that by directing all
</I>&gt;<i> traffic to one node and letting it replicate to other nodes we don't have
</I>&gt;<i> to deal with issues if a network partition occurs, and they *do* occur
</I>&gt;<i> (earlier this week one of the virtual NICs stopped on one of the Rabbit
</I>&gt;<i> nodes, for example). The F5 will detect this very quickly and divert
</I>&gt;<i> traffic to another node if necessary. (Note to others - we've found that
</I>&gt;<i> this arrangement scales significantly better than round robin load
</I>&gt;<i> balancing for mirrored persistent queues).
</I>&gt;<i>
</I>&gt;<i> We have clusters in each data center; for clusters that need to replicate
</I>&gt;<i> to a different data center there is the shovel. However, there is a chance
</I>&gt;<i> of message loss if the application sends the message to the cluster in one
</I>&gt;<i> DC and that entire DC is hit by a meteor before the message can be
</I>&gt;<i> delivered to the other data center. For most scenarios, however, the
</I>&gt;<i> messages will be eventually delivered when the DC comes back up.
</I>&gt;<i>
</I>&gt;<i> Hope that helps a little...
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> -ronc
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, May 22, 2014 at 12:04 PM, Steffen Daniel Jensen &lt;
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">steffen.daniel.jensen at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Simon,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you for your reply.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  We have two data centers connected closely by LAN.
</I>&gt;&gt;&gt;&gt;<i> We are interested in a *reliable cluster* setup. It must be a cluster
</I>&gt;&gt;&gt;&gt;<i> because we want clients to be able to connect to each node
</I>&gt;&gt;&gt;&gt;<i> transparently. Federation is not an option.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I hope you realise that you are asking for a lot here! You should read
</I>&gt;&gt;&gt;<i> up on the CAP theorem if you have not already done so.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, I know. But I am not asking an unreasonably lot, IMO :-)
</I>&gt;&gt;<i> I am aware of the CAP theorem, but I don't see how it is in violation. I
</I>&gt;&gt;<i> am willing to live with eventual consistency.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. It happens that the firewall/switch is restarted, and maybe a few
</I>&gt;&gt;&gt;&gt;<i> ping messages are lost.
</I>&gt;&gt;&gt;&gt;<i> 2. The setup should survive data center crash
</I>&gt;&gt;&gt;&gt;<i> 3. All queues are durable and mirrored, all messages are persisted, all
</I>&gt;&gt;&gt;&gt;<i> publishes are confirmed
</I>&gt;&gt;&gt;&gt;<i> There are 3 cluster-recovery settings
</I>&gt;&gt;&gt;&gt;<i> a) ignore: A cross data center network break-down would cause message
</I>&gt;&gt;&gt;&gt;<i> loss on the node that is restarted In order to rejoin.
</I>&gt;&gt;&gt;&gt;<i> b) pause_minority: If we choose the same number of nodes in each data
</I>&gt;&gt;&gt;&gt;<i> center, the whole cluster will pause. If we don't, only the data center
</I>&gt;&gt;&gt;&gt;<i> with the most nodes can survive.
</I>&gt;&gt;&gt;&gt;<i> c) auto_heal: If the cluster decides network partitioning, there is a
</I>&gt;&gt;&gt;&gt;<i> potential of message loss, when joining.
</I>&gt;&gt;&gt;&gt;<i> [I would really like a resync-setting similar to the one described
</I>&gt;&gt;&gt;&gt;<i> below]
</I>&gt;&gt;&gt;&gt;<i> Question 1: Is it even possible to have a fully reliable setup in such a
</I>&gt;&gt;&gt;&gt;<i> setting?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Depends how you define &quot;fully reliable&quot;. If you want Consistency (i.e.
</I>&gt;&gt;&gt;<i> mirrored queues), Availability (i.e. neither data centre pauses) and
</I>&gt;&gt;&gt;<i> Partition tolerance (no loss of data from either side if the network goes
</I>&gt;&gt;&gt;<i> down between them) then I'm afraid you can't.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What I mean when I say &quot;reliable&quot; is: All subscribers at the time of
</I>&gt;&gt;<i> publish will eventually get the message.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That should be possible, assuming that all live inconsistent nodes will
</I>&gt;&gt;<i> eventually rejoin (without dumping messages). I know this is not the case
</I>&gt;&gt;<i> in rabbitmq, but it is definitely theoretically possible. I guess this is
</I>&gt;&gt;<i> what is usually referred to as eventual consistency.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In reality we probably won't have actual network partitions, and it will
</I>&gt;&gt;&gt;&gt;<i> most probably only be a very short network downtime.
</I>&gt;&gt;&gt;&gt;<i> Question 2: Is it possible to adjust how long it takes rabbitmq to
</I>&gt;&gt;&gt;&gt;<i> decide &quot;node down&quot;?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Yes, see <A HREF="http://www.rabbitmq.com/nettick.html">http://www.rabbitmq.com/nettick.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you! (!)
</I>&gt;&gt;<i> I have been looking for that one. But I am surprised to see that it is
</I>&gt;&gt;<i> actually 60sec. Then I really don't understand how I could have seen so
</I>&gt;&gt;<i> many clusters ending up partitioned.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do you know what the consequence of doubling it might be?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> RabbitMq writes:
</I>&gt;&gt;<i> Increasing the net_ticktime across all nodes in a cluster will make the
</I>&gt;&gt;<i> cluster more resilient to short network outtages, but it will take longer
</I>&gt;&gt;<i> for remaing nodes to detect crashed nodes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> More specifically I wonder what happens in the time a node is actually in
</I>&gt;&gt;<i> its own network, but before it finds out. In our setup all publishes have
</I>&gt;&gt;<i> all-HA subscriber queues, with publisher confirm. So I will expect a
</I>&gt;&gt;<i> distributed agreement that the msg has been persisted. Will a publisher
</I>&gt;&gt;<i> confirm then block until the node decides that other nodes are down, and
</I>&gt;&gt;<i> then succeed?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It is much better to have a halted rabbitmq for some seconds than to
</I>&gt;&gt;&gt;&gt;<i> have message loss.
</I>&gt;&gt;&gt;&gt;<i> Question 3: Assume that we are using the ignore setting, and that we
</I>&gt;&gt;&gt;&gt;<i> have only two nodes in the cluster. Would the following be a full
</I>&gt;&gt;&gt;&gt;<i> recovery with zero message loss?
</I>&gt;&gt;&gt;&gt;<i> 0. Decide which node survives, Ns, and which should be restarted, Nr.
</I>&gt;&gt;&gt;&gt;<i> 1. Refuse all connections to Nr except from a special recovery
</I>&gt;&gt;&gt;&gt;<i> application. (One could change the ip, so all running services can't
</I>&gt;&gt;&gt;&gt;<i> connect or similar)
</I>&gt;&gt;&gt;&gt;<i> 2. Consume and republish all message from Nr to Ns.
</I>&gt;&gt;&gt;&gt;<i> 3. Restart Nr
</I>&gt;&gt;&gt;&gt;<i> Then the cluster should be up-and-running again.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> That sounds like it would work. You're losing some availability and
</I>&gt;&gt;&gt;<i> consistency, and your message ordering will change. You have a pretty good
</I>&gt;&gt;&gt;<i> chance of duplicating lots of messages too (any that were in the queues
</I>&gt;&gt;&gt;<i> when the partition happened). Assuming you're happy with that it sounds
</I>&gt;&gt;&gt;<i> reasonable.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The duplication is ok -- but assuming that rabbit is usually empty, it
</I>&gt;&gt;<i> won't really happen, I think.
</I>&gt;&gt;<i> But -- I am sure that rabbit does not guarantee exactly once delivery
</I>&gt;&gt;<i> anyway.
</I>&gt;&gt;<i> For that reason, we will build in idempotency for critical messages.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ordering can always get scrambled when nacking consuming messages, so we
</I>&gt;&gt;<i> are not assuming ordering either.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> About the CAP theorem in relation to rabbit.
</I>&gt;&gt;<i> Reliable messaging (zero message loss), is often preferred in
</I>&gt;&gt;<i> SOA-settings. I wonder why vmware/pivotal/... chose not to prioritize this
</I>&gt;&gt;<i> guarantee. It is aimed by the federation setup, but it is a little to weak
</I>&gt;&gt;<i> in its synchronization. It would be preferred if it had a possibility of
</I>&gt;&gt;<i> communicating consumption of messages. Then one could mirror queues between
</I>&gt;&gt;<i> up/down-stream exchanges, and have even more &quot;availability&quot;. One would
</I>&gt;&gt;<i> definitely give up consistency a little further, but it would be possible
</I>&gt;&gt;<i> to have the setup above, I think. I know it definitely doesn't come
</I>&gt;&gt;<i> out-of-the-box, and it is not a part of AMQP, AFAIK, but it seems possible.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you, Simon!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -- S
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Jason McIntosh
<A HREF="https://github.com/jasonmcintosh/">https://github.com/jasonmcintosh/</A>
573-424-7612
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140522/9a8f41f1/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140522/9a8f41f1/attachment.html</A>&gt;
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036223.html">[rabbitmq-discuss] Fully reliable setup impossible?
</A></li>
	<LI>Next message: <A HREF="036239.html">[rabbitmq-discuss] Fully reliable setup impossible?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36225">[ date ]</a>
              <a href="thread.html#36225">[ thread ]</a>
              <a href="subject.html#36225">[ subject ]</a>
              <a href="author.html#36225">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
