<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Fully reliable setup impossible?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fully%20reliable%20setup%20impossible%3F&In-Reply-To=%3CCAGRy8k7EB7r6GLc3SM1hyzMhULEk7Xpm4GY3BHhXjg5w-iNL_A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036218.html">
   <LINK REL="Next"  HREF="036222.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Fully reliable setup impossible?</H1>
    <B>Steffen Daniel Jensen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fully%20reliable%20setup%20impossible%3F&In-Reply-To=%3CCAGRy8k7EB7r6GLc3SM1hyzMhULEk7Xpm4GY3BHhXjg5w-iNL_A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Fully reliable setup impossible?">steffen.daniel.jensen at gmail.com
       </A><BR>
    <I>Thu May 22 20:04:47 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036218.html">[rabbitmq-discuss] Fully reliable setup impossible?
</A></li>
        <LI>Next message: <A HREF="036222.html">[rabbitmq-discuss] Fully reliable setup impossible?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36220">[ date ]</a>
              <a href="thread.html#36220">[ thread ]</a>
              <a href="subject.html#36220">[ subject ]</a>
              <a href="author.html#36220">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simon,

Thank you for your reply.

&gt;<i>
</I>&gt;<i>  We have two data centers connected closely by LAN.
</I>&gt;&gt;<i> We are interested in a *reliable cluster* setup. It must be a cluster
</I>&gt;&gt;<i> because we want clients to be able to connect to each node
</I>&gt;&gt;<i> transparently. Federation is not an option.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I hope you realise that you are asking for a lot here! You should read up
</I>&gt;<i> on the CAP theorem if you have not already done so.
</I>&gt;<i>
</I>
Yes, I know. But I am not asking an unreasonably lot, IMO :-)
I am aware of the CAP theorem, but I don't see how it is in violation. I am
willing to live with eventual consistency.

1. It happens that the firewall/switch is restarted, and maybe a few
&gt;&gt;<i> ping messages are lost.
</I>&gt;&gt;<i> 2. The setup should survive data center crash
</I>&gt;&gt;<i> 3. All queues are durable and mirrored, all messages are persisted, all
</I>&gt;&gt;<i> publishes are confirmed
</I>&gt;&gt;<i> There are 3 cluster-recovery settings
</I>&gt;&gt;<i> a) ignore: A cross data center network break-down would cause message
</I>&gt;&gt;<i> loss on the node that is restarted In order to rejoin.
</I>&gt;&gt;<i> b) pause_minority: If we choose the same number of nodes in each data
</I>&gt;&gt;<i> center, the whole cluster will pause. If we don't, only the data center
</I>&gt;&gt;<i> with the most nodes can survive.
</I>&gt;&gt;<i> c) auto_heal: If the cluster decides network partitioning, there is a
</I>&gt;&gt;<i> potential of message loss, when joining.
</I>&gt;&gt;<i> [I would really like a resync-setting similar to the one described below]
</I>&gt;&gt;<i> Question 1: Is it even possible to have a fully reliable setup in such a
</I>&gt;&gt;<i> setting?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Depends how you define &quot;fully reliable&quot;. If you want Consistency (i.e.
</I>&gt;<i> mirrored queues), Availability (i.e. neither data centre pauses) and
</I>&gt;<i> Partition tolerance (no loss of data from either side if the network goes
</I>&gt;<i> down between them) then I'm afraid you can't.
</I>&gt;<i>
</I>
What I mean when I say &quot;reliable&quot; is: All subscribers at the time of
publish will eventually get the message.

That should be possible, assuming that all live inconsistent nodes will
eventually rejoin (without dumping messages). I know this is not the case
in rabbitmq, but it is definitely theoretically possible. I guess this is
what is usually referred to as eventual consistency.


&gt;<i> In reality we probably won't have actual network partitions, and it will
</I>&gt;&gt;<i> most probably only be a very short network downtime.
</I>&gt;&gt;<i> Question 2: Is it possible to adjust how long it takes rabbitmq to
</I>&gt;&gt;<i> decide &quot;node down&quot;?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yes, see <A HREF="http://www.rabbitmq.com/nettick.html">http://www.rabbitmq.com/nettick.html</A>
</I>

Thank you! (!)
I have been looking for that one. But I am surprised to see that it is
actually 60sec. Then I really don't understand how I could have seen so
many clusters ending up partitioned.

Do you know what the consequence of doubling it might be?

RabbitMq writes:
Increasing the net_ticktime across all nodes in a cluster will make the
cluster more resilient to short network outtages, but it will take longer
for remaing nodes to detect crashed nodes.

More specifically I wonder what happens in the time a node is actually in
its own network, but before it finds out. In our setup all publishes have
all-HA subscriber queues, with publisher confirm. So I will expect a
distributed agreement that the msg has been persisted. Will a publisher
confirm then block until the node decides that other nodes are down, and
then succeed?

It is much better to have a halted rabbitmq for some seconds than to
&gt;&gt;<i> have message loss.
</I>&gt;&gt;<i> Question 3: Assume that we are using the ignore setting, and that we
</I>&gt;&gt;<i> have only two nodes in the cluster. Would the following be a full
</I>&gt;&gt;<i> recovery with zero message loss?
</I>&gt;&gt;<i> 0. Decide which node survives, Ns, and which should be restarted, Nr.
</I>&gt;&gt;<i> 1. Refuse all connections to Nr except from a special recovery
</I>&gt;&gt;<i> application. (One could change the ip, so all running services can't
</I>&gt;&gt;<i> connect or similar)
</I>&gt;&gt;<i> 2. Consume and republish all message from Nr to Ns.
</I>&gt;&gt;<i> 3. Restart Nr
</I>&gt;&gt;<i> Then the cluster should be up-and-running again.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That sounds like it would work. You're losing some availability and
</I>&gt;<i> consistency, and your message ordering will change. You have a pretty good
</I>&gt;<i> chance of duplicating lots of messages too (any that were in the queues
</I>&gt;<i> when the partition happened). Assuming you're happy with that it sounds
</I>&gt;<i> reasonable.
</I>&gt;<i>
</I>
The duplication is ok -- but assuming that rabbit is usually empty, it
won't really happen, I think.
But -- I am sure that rabbit does not guarantee exactly once delivery
anyway.
For that reason, we will build in idempotency for critical messages.

Ordering can always get scrambled when nacking consuming messages, so we
are not assuming ordering either.


About the CAP theorem in relation to rabbit.
Reliable messaging (zero message loss), is often preferred in SOA-settings.
I wonder why vmware/pivotal/... chose not to prioritize this guarantee. It
is aimed by the federation setup, but it is a little to weak in its
synchronization. It would be preferred if it had a possibility of
communicating consumption of messages. Then one could mirror queues between
up/down-stream exchanges, and have even more &quot;availability&quot;. One would
definitely give up consistency a little further, but it would be possible
to have the setup above, I think. I know it definitely doesn't come
out-of-the-box, and it is not a part of AMQP, AFAIK, but it seems possible.

Thank you, Simon!

-- S
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140522/fdf9cfd4/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140522/fdf9cfd4/attachment.html</A>&gt;
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036218.html">[rabbitmq-discuss] Fully reliable setup impossible?
</A></li>
	<LI>Next message: <A HREF="036222.html">[rabbitmq-discuss] Fully reliable setup impossible?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36220">[ date ]</a>
              <a href="thread.html#36220">[ thread ]</a>
              <a href="subject.html#36220">[ subject ]</a>
              <a href="author.html#36220">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
