<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Retry%20Message%20for%203%20times%20with%2010%20seconds%0A%20interval%20-%20in%20Consumer&In-Reply-To=%3C1DB4F5481AB296448E8A5B5BC9D336541CB1161C%40xmb-aln-x10.cisco.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036178.html">
   <LINK REL="Next"  HREF="036320.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer</H1>
    <B>Srinath Sridharan -X (srinatsr - ZENSAR TECHNOLOGIES INC at Cisco)</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Retry%20Message%20for%203%20times%20with%2010%20seconds%0A%20interval%20-%20in%20Consumer&In-Reply-To=%3C1DB4F5481AB296448E8A5B5BC9D336541CB1161C%40xmb-aln-x10.cisco.com%3E"
       TITLE="[rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer">srinatsr at cisco.com
       </A><BR>
    <I>Wed May 21 21:45:26 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036178.html">[rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer
</A></li>
        <LI>Next message: <A HREF="036320.html">[rabbitmq-discuss] FW: Retry Message for 3 times with 10 seconds interval - in Consumer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36179">[ date ]</a>
              <a href="thread.html#36179">[ thread ]</a>
              <a href="subject.html#36179">[ subject ]</a>
              <a href="author.html#36179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I totally agree Gary.

But how to configure in xml ?  Here is my xml and designed as you described.

   &lt;bean id=&quot;simpleRetryPolicy&quot; class=&quot;org.springframework.retry.policy.SimpleRetryPolicy&quot;&gt;
        &lt;property name=&quot;maxAttempts&quot; value=&quot;3&quot; /&gt;
    &lt;/bean&gt;
    &lt;!-- &lt;bean id=&quot;retryTemplate&quot; class=&quot;org.springframework.retry.support.RetryTemplate&quot;&gt;
        &lt;property name=&quot;retryPolicy&quot; ref=&quot;simpleRetryPolicy&quot; /&gt;
    &lt;/bean&gt; --&gt;
    &lt;bean id=&quot;statefulRetryOperationsInterceptorFactoryBean&quot;
        class=&quot;org.springframework.amqp.rabbit.config.StatefulRetryOperationsInterceptorFactoryBean&quot;&gt;
        &lt;property name=&quot;retryOperations&quot; ref=&quot;retryTemplate&quot; /&gt;
        &lt;property name=&quot;messageRecoverer&quot;
    &lt;/bean&gt;


       &lt;bean id=&quot;retryTemplate&quot; class=&quot;org.springframework.retry.support.RetryTemplate&quot;&gt;
              &lt;property name=&quot;retryPolicy&quot; ref=&quot;simpleRetryPolicy&quot; /&gt;
             &lt;property name=&quot;backOffPolicy&quot;&gt;
                    &lt;bean class=&quot;org.springframework.retry.backoff.ExponentialBackOffPolicy&quot;&gt;
                           &lt;property name=&quot;initialInterval&quot; value=&quot;10000&quot; /&gt;
             &lt;!--         &lt;property name=&quot;multiplier&quot; value=&quot;10.0&quot; /&gt;
                           &lt;property name=&quot;maxInterval&quot; value=&quot;10000&quot; /&gt; --&gt;
                    &lt;/bean&gt;
             &lt;/property&gt;
       &lt;/bean&gt;
       &lt;rabbit:template id=&quot;rabbitTemplate&quot;
             connection-factory=&quot;connectionFactory&quot; /&gt;
       &lt;bean
              class=&quot;org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer&quot;&gt;
             &lt;property name=&quot;connectionFactory&quot; ref=&quot;connectionFactory&quot; /&gt;
             &lt;property name=&quot;queueNames&quot;&gt;
                    &lt;array&gt;
                           &lt;value&gt;validateRequestQueue&lt;/value&gt;
                    &lt;/array&gt;
             &lt;/property&gt;
             &lt;property name=&quot;messageListener&quot;&gt;
                    &lt;bean
                           class=&quot;org.springframework.amqp.rabbit.listener.adapter.MessageListenerAdapter&quot;&gt;
                           &lt;property name=&quot;delegate&quot; ref=&quot;retryConsumer&quot; /&gt;
                    &lt;/bean&gt;
             &lt;/property&gt;
             &lt;property name=&quot;adviceChain&quot; ref=&quot;statefulRetryOperationsInterceptorFactoryBean&quot;&gt;&lt;/property&gt;
             &lt;!-- &lt;property name=&quot;acknowledgeMode&quot; value=&quot;NONE&quot; /&gt; --&gt;
       &lt;/bean&gt;

Regards &#8230;&#8226;
Srinath

From: rabbitmq-discuss [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>] On Behalf Of Gary Russell
Sent: Wednesday, May 21, 2014 1:14 PM
To: Discussions about RabbitMQ
Subject: Re: [rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer

You did not configure a MessageRecoverer as I suggested; the default recoverer logs a WARN message and acks the message.

Add a RejectAndDontRequeueRecoverer and the rejected message will go to the DLE.

On Wed, May 21, 2014 at 2:14 PM, Srinath Sridharan -X (srinatsr - ZENSAR TECHNOLOGIES INC at Cisco) &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">srinatsr at cisco.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">srinatsr at cisco.com</A>&gt;&gt; wrote:
After 3 times, I am getting the following exception.  But I don&#8217;t want this exception, directly the message should go to dead letter exchange.

I  have configured dlx as follows.

rabbitmqctl set_policy DLX &quot;.*&quot; '{&quot;dead-letter-exchange&quot;:&quot;my-dlx&quot;}'


2014-05-21 11:10:37:870 -0700, [WARN] StatefulRetryOperationsInterceptorFactoryBean  recover - 89 Message dropped on recovery: (Body:'[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">B at 3ed60d48</A>(byte[163])'MessageProperties [headers={}, timestamp=null, messageId=1, userId=null, appId=null, clusterId=null, type=null, correlationId=null, replyTo=null, contentType=application/octet-stream, contentEncoding=null, contentLength=0, deliveryMode=PERSISTENT, expiration=null, priority=0, redelivered=true, receivedExchange=, receivedRoutingKey=validateRequestQueue, deliveryTag=8, messageCount=0])
org.springframework.amqp.rabbit.listener.ListenerExecutionFailedException: Listener threw exception
       at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.wrapToListenerExecutionFailedExceptionIfNeeded(AbstractMessageListenerContainer.java:758)
       at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.doInvokeListener(AbstractMessageListenerContainer.java:653)
       at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.invokeListener(AbstractMessageListenerContainer.java:576)
       at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.access$001(SimpleMessageListenerContainer.java:75)
       at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer$1.invokeListener(SimpleMessageListenerContainer.java:154)
       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
       at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
       at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
       at java.lang.reflect.Method.invoke(Method.java:606)
       at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:317)
       at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:183)
       at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:150)
       at org.springframework.retry.interceptor.StatefulRetryOperationsInterceptor$MethodInvocationRetryCallback.doWithRetry(StatefulRetryOperationsInterceptor.java:162)
       at org.springframework.retry.support.RetryTemplate.doExecute(RetryTemplate.java:263)
       at org.springframework.retry.support.RetryTemplate.execute(RetryTemplate.java:193)
       at org.springframework.retry.interceptor.StatefulRetryOperationsInterceptor.invoke(StatefulRetryOperationsInterceptor.java:137)
       at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:172)
       at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:204)
       at com.sun.proxy.$Proxy62.invokeListener(Unknown Source)
       at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.invokeListener(SimpleMessageListenerContainer.java:1113)
       at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.executeListener(AbstractMessageListenerContainer.java:559)
       at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.doReceiveAndExecute(SimpleMessageListenerContainer.java:904)
       at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.receiveAndExecute(SimpleMessageListenerContainer.java:888)
       at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.access$500(SimpleMessageListenerContainer.java:75)
       at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer$AsyncMessageProcessingConsumer.run(SimpleMessageListenerContainer.java:989)
       at java.lang.Thread.run(Thread.java:724)

Regards &#8230;&#8226;
Srinath

From: rabbitmq-discuss [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>&gt;] On Behalf Of Srinath Sridharan -X (srinatsr - ZENSAR TECHNOLOGIES INC at Cisco)
Sent: Wednesday, May 21, 2014 11:00 AM

To: Discussions about RabbitMQ
Subject: Re: [rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer

It works perfect thank you so much &#9786;

Regards &#8230;&#8226;
Srinath

From: rabbitmq-discuss [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>] On Behalf Of Gary Russell
Sent: Tuesday, May 20, 2014 12:48 PM
To: Discussions about RabbitMQ
Subject: Re: [rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer

To configure the retry advice in XML, you need to wire up a StatefulRetryOperationsInterceptorFactoryBean.

It needs a RetryTemplate (RetryOperations) bean which needs a RetryPolicy and BackOffPolicy beans.

Then wire the factory bean into the advice chain.

To set the message id, it depends on how you are sending messages; you can set it directly, or if you are using message conversion, set the createMessageIds to true on the outbound template's SimpleMessageConverter.

However, when using long backoffs like that, there's not much benefit in using stateful retry.

On Tue, May 20, 2014 at 3:29 PM, Srinath Sridharan -X (srinatsr - ZENSAR TECHNOLOGIES INC at Cisco) &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">srinatsr at cisco.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">srinatsr at cisco.com</A>&gt;&gt; wrote:
Thanks  do you have xml version of the following?

I need to set message id before publishing the message?  How to do this?

Regards &#8230;&#8226;
Srinath

From: rabbitmq-discuss [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss-bounces at lists.rabbitmq.com</A>&gt;] On Behalf Of Gary Russell
Sent: Tuesday, May 20, 2014 12:24 PM
To: Discussions about RabbitMQ
Subject: Re: [rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer

@Bean
public MethodInterceptor retryAdvice() {
     FixedBackOffPolicy backOffPolicy = new FixedBackOffPolicy();
     backOffPolicy.setBackOffPeriod(10000);;
     return RetryInterceptorBuilder.stateful()
          .backOffPolicy(backOffPolicy)
          .maxAttempts(3)
          .recoverer(new RejectAndDontRequeueRecoverer())
          .build();
}

Add it to the adviceChain property of the SimpleMessageListenerContainer.

Note: stateful retry requires the message to have a message id; use a stateless advice otherwise.

After the retries are exhausted, the message will be rejected (and dropped or sent to a Dead Letter Exchange of so configured).


On Tue, May 20, 2014 at 3:09 PM, Srinath Sridharan -X (srinatsr - ZENSAR TECHNOLOGIES INC at Cisco) &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">srinatsr at cisco.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">srinatsr at cisco.com</A>&gt;&gt; wrote:

Hello,

I am consuming the messages using the listener as follows,  I need to retry processing three times if any exceptions occurred.

&lt;bean
        class=&quot;org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer&quot;&gt;
        &lt;property name=&quot;connectionFactory&quot; ref=&quot;connectionFactory&quot; /&gt;
        &lt;property name=&quot;queueNames&quot;&gt;
            &lt;array&gt;
                &lt;value&gt;validateRequestQueue&lt;/value&gt;
            &lt;/array&gt;
        &lt;/property&gt;
        &lt;property name=&quot;messageListener&quot;&gt;
            &lt;bean
                class=&quot;org.springframework.amqp.rabbit.listener.adapter.MessageListenerAdapter&quot;&gt;
                &lt;property name=&quot;delegate&quot; ref=&quot;retryConsumer&quot; /&gt;
            &lt;/bean&gt;
        &lt;/property&gt;
        &lt;!-- &lt;property name=&quot;acknowledgeMode&quot; value=&quot;NONE&quot; /&gt; --&gt;
    &lt;/bean&gt;


public class RetryConsumer implements ChannelAwareMessageListener {

       /**
       * Callback for processing a received Rabbit message.
       * @param message the received AMQP message
       * @param channel the underlying Rabbit Channel
       * @throws Exception
        */
       @Override
       public void onMessage(Message message, Channel channel) throws Exception {

             System.out.println(&quot;Received Message :: &quot;+new String(message.getBody()));
             if(true){
             throw new RuntimeException(&quot;Error&quot;);
             }

       }

Regards &#8230;&#8226;
Srinath

From: Srinath Sridharan -X (srinatsr - ZENSAR TECHNOLOGIES INC at Cisco)
Sent: Monday, May 19, 2014 10:47 AM
To: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
Subject: Retry Message for 3 times with 10 seconds interval - in Consumer



Retry unacknowledged RabbitMQ message in 10 second interval

And Retry 3 times using Spring framework in java .



Please need help on this

Regards &#8230;&#8226;
Srinath


_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>


_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>


_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140521/34f7ab28/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140521/34f7ab28/attachment.html</A>&gt;
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036178.html">[rabbitmq-discuss] Retry Message for 3 times with 10 seconds interval - in Consumer
</A></li>
	<LI>Next message: <A HREF="036320.html">[rabbitmq-discuss] FW: Retry Message for 3 times with 10 seconds interval - in Consumer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36179">[ date ]</a>
              <a href="thread.html#36179">[ thread ]</a>
              <a href="subject.html#36179">[ subject ]</a>
              <a href="author.html#36179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
