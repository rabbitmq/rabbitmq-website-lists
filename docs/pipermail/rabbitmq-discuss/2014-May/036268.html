<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] php pecl and max channel reached with php-fpm
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20php%20pecl%20and%20max%20channel%20reached%20with%20php-fpm&In-Reply-To=%3CCAL%2Bek04%3DqKJZqSSpa-fqCcV6TyEDpT9q8WUT%3D0Cf40Qag1BPOQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036266.html">
   <LINK REL="Next"  HREF="036253.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] php pecl and max channel reached with php-fpm</H1>
    <B>B3aT(at)gmail</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20php%20pecl%20and%20max%20channel%20reached%20with%20php-fpm&In-Reply-To=%3CCAL%2Bek04%3DqKJZqSSpa-fqCcV6TyEDpT9q8WUT%3D0Cf40Qag1BPOQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] php pecl and max channel reached with php-fpm">aditza8 at gmail.com
       </A><BR>
    <I>Tue May 27 08:34:26 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036266.html">[rabbitmq-discuss] php pecl and max channel reached with php-fpm
</A></li>
        <LI>Next message: <A HREF="036253.html">[rabbitmq-discuss] Clients with multiple protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36268">[ date ]</a>
              <a href="thread.html#36268">[ thread ]</a>
              <a href="subject.html#36268">[ subject ]</a>
              <a href="author.html#36268">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello and thanks for the answers.

I cannot reuse the channels, requests processed trough fpm do not share
resources at app level.
PHP-amqplib cannot be used, is way too slow because it doesn't support
persistent connections (is minimum 6x times slower then the pecl one, and
slows down the entire apps to a factor of 4-5, we tested it in production),
and s all because this line of code (new AMQPConnection...).

I think php-amqplib reuse the channels, I can mark them as DURABLE, and
have a specific name, but the PECL one it doesn't, you must create a new
channel every time.

I will try to close them at the end of the request, but I thought it
automatically does that when the script ends.

With PECL we have multiple persistent connections per server, and each
connection process hundreds of requests, so far the problem didn't appeared
in production tests, maybe because the fpm workers are limited to a small
number of requests.


/********************************
@author *B.G. Adrian*
@as *Game developer*
@from www.*btools*.eu
@games www.*bcardgames.com*
@work www.*mavenhut*.com
*********************************/


On Tue, May 27, 2014 at 9:38 AM, Alvaro Videla &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">videlalvaro at gmail.com</A>&gt;wrote:

&gt;<i> As MK said, be sure to either close the channels after you don't need
</I>&gt;<i> them, or reuse them. For me it seems that you are keeping persistent
</I>&gt;<i> connections and then you open one channel per request, but you don't close
</I>&gt;<i> the channel at the end, therefore the channels are &quot;leaking&quot;, and thus your
</I>&gt;<i> problem.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Alvaro
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, May 27, 2014 at 7:25 AM, Michael Klishin &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mklishin at gopivotal.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>  On 27 May 2014 at 03:00:50, BeaT Adrian (<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">aditza8 at gmail.com</A>) wrote:
</I>&gt;&gt;<i> &gt; &gt; After a while (I guess 65500 requests) a problem occurs halting
</I>&gt;&gt;<i> &gt; all writes
</I>&gt;&gt;<i> &gt; &quot;Could not create channel. Connection has no open channel slots
</I>&gt;&gt;<i> &gt; remaining&quot;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; From what I have read in the sources is because every tcp connection
</I>&gt;&gt;<i> &gt; have an autoincrement channel ID that reaches its max. This happens
</I>&gt;&gt;<i> &gt; because every request must use the channel, and is no way to use
</I>&gt;&gt;<i> &gt; the same channel ( I could not find a way into the php-amqp channel
</I>&gt;&gt;<i> &gt; classs to make it persistent) and scripts cannot communicate
</I>&gt;&gt;<i> &gt; ( to use the same instance of the channel as php object).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Every AMQP 0-9-1 connection has 1 or more channels (the max is negotiated
</I>&gt;&gt;<i> between client and server, so this can be limited by the broker). If you
</I>&gt;&gt;<i> open a lot of channels, you need to close them, or use more than 1
</I>&gt;&gt;<i> connection
</I>&gt;&gt;<i> (which in turn will use more than 1 TCP connection).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Both channels and especially connections in practice take up some
</I>&gt;&gt;<i> resources.
</I>&gt;&gt;<i> It is very rare that an app actually needs 1000s or 10s of 1000s of
</I>&gt;&gt;<i> channels.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> See <A HREF="http://www.rabbitmq.com/tutorials/amqp-concepts.html">http://www.rabbitmq.com/tutorials/amqp-concepts.html</A> if you need a
</I>&gt;&gt;<i> more
</I>&gt;&gt;<i> detailed explanation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> By the way, it is highly recommended that you use
</I>&gt;&gt;<i> <A HREF="https://github.com/videlalvaro/php-amqplib">https://github.com/videlalvaro/php-amqplib</A>
</I>&gt;&gt;<i> and not the PECL extension (which is not actively maintained AFAIK).
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> MK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Software Engineer, Pivotal/RabbitMQ
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140527/134d0eb8/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140527/134d0eb8/attachment.html</A>&gt;
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036266.html">[rabbitmq-discuss] php pecl and max channel reached with php-fpm
</A></li>
	<LI>Next message: <A HREF="036253.html">[rabbitmq-discuss] Clients with multiple protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36268">[ date ]</a>
              <a href="thread.html#36268">[ thread ]</a>
              <a href="subject.html#36268">[ subject ]</a>
              <a href="author.html#36268">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
