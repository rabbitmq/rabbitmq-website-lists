<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mirrored Queues Down Behaviour
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirrored%20Queues%20Down%20Behaviour&In-Reply-To=%3CCAGPPH4CUOKf6xCgXbRve1%2BVuThRhyM_NCOcQNsrR_D%2BYM%3DwR7Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036295.html">
   <LINK REL="Next"  HREF="036297.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mirrored Queues Down Behaviour</H1>
    <B>Ben Murphy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirrored%20Queues%20Down%20Behaviour&In-Reply-To=%3CCAGPPH4CUOKf6xCgXbRve1%2BVuThRhyM_NCOcQNsrR_D%2BYM%3DwR7Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Mirrored Queues Down Behaviour">benmmurphy at gmail.com
       </A><BR>
    <I>Fri May 23 13:21:47 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="036295.html">[rabbitmq-discuss] frame size eror: source F5 Loadbalancer
</A></li>
        <LI>Next message: <A HREF="036297.html">[rabbitmq-discuss] Mirrored Queues Down Behaviour
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36243">[ date ]</a>
              <a href="thread.html#36243">[ thread ]</a>
              <a href="subject.html#36243">[ subject ]</a>
              <a href="author.html#36243">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've noticed that when rabbitmq nodes becomes unreachable the gm
module can behave very strangely.

It looks like the server is trying to fetch its own record in the view
but this record no longer exists so it crashes. It's view according to
the state at the start of the function is:

'{{0,&lt;2908.114.8&gt;}, {0,&lt;0.19014.9&gt;}, {1,&lt;23021.2099.0&gt;}' and its
process is ' {0,&lt;0.19014.9&gt;}' however it ends up trying to look itself
up in a view that only contains these members: '{1,&lt;23021.2099.0&gt;}'
(<A HREF="https://github.com/rabbitmq/rabbitmq-server/blob/rabbitmq_v3_2_3/src/gm.erl#L1245">https://github.com/rabbitmq/rabbitmq-server/blob/rabbitmq_v3_2_3/src/gm.erl#L1245</A>).
I notice that the state of the view is also stored in mnesia. I think
this state is shared across the cluster but I'm not sure.

If this is true then it might be possible for a node A to consider a
gm process on node B down and then push this state to node A via
mnesia. Then when node A gets the down message for node B and tries to
update its state it will try and fetch itself from the view and will
crash.

** Reason for termination ==
** {function_clause,
       [{orddict,fetch,
            [{0,&lt;0.19014.9&gt;},
             [{{1,&lt;23021.2099.0&gt;},
               {view_member,
                   {1,&lt;23021.2099.0&gt;},
                   [{0,&lt;2908.114.8&gt;}],
                   {1,&lt;23021.2099.0&gt;},
                   {1,&lt;23021.2099.0&gt;}}}]],
            [{file,&quot;orddict.erl&quot;},{line,72}]},
        {gm,check_neighbours,1,[]},
        {gm,handle_info,2,[]},
        {gen_server2,handle_msg,2,[]},
        {proc_lib,wake_up,3,[{file,&quot;proc_lib.erl&quot;},{line,249}]}]}

=ERROR REPORT==== 22-May-2014::15:12:18 ===
** Generic server &lt;0.19014.9&gt; terminating
** Last message in was {'DOWN',#Ref&lt;0.0.195.189462&gt;,process,&lt;2908.114.8&gt;,
                               noconnection}
** When Server state == {state,
                            {0,&lt;0.19014.9&gt;},
                            {{0,&lt;2908.114.8&gt;},#Ref&lt;0.0.195.189462&gt;},
                            {{1,&lt;23021.2099.0&gt;},#Ref&lt;0.0.1718.177207&gt;},
                            {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,
                                &lt;&lt;&quot;retry_queue_600_mo_service_12&quot;&gt;&gt;},
                            rabbit_mirror_queue_coordinator,
                            {2,
                             [{{0,&lt;2908.114.8&gt;},
                               {view_member,
                                   {0,&lt;2908.114.8&gt;},
                                   [],
                                   {1,&lt;23021.2099.0&gt;},
                                   {0,&lt;0.19014.9&gt;}}},
                              {{0,&lt;0.19014.9&gt;},
                               {view_member,
                                   {0,&lt;0.19014.9&gt;},
                                   [],
                                   {0,&lt;2908.114.8&gt;},
                                   {1,&lt;23021.2099.0&gt;}}},
                              {{1,&lt;23021.2099.0&gt;},
                               {view_member,
                                   {1,&lt;23021.2099.0&gt;},
                                   [],
                                   {0,&lt;0.19014.9&gt;},
                                   {0,&lt;2908.114.8&gt;}}}]},
                            2,
                            [{{0,&lt;2908.114.8&gt;},{member,{[],[]},0,0}},
                             {{0,&lt;0.19014.9&gt;},{member,{[],[]},2,2}},
                             {{1,&lt;23021.2099.0&gt;},{member,{[],[]},0,0}}],
                            [&lt;0.19013.9&gt;],
                            {[],[]},
                            [],0,undefined,
                            #Fun&lt;rabbit_misc.execute_mnesia_transaction.1&gt;}
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036295.html">[rabbitmq-discuss] frame size eror: source F5 Loadbalancer
</A></li>
	<LI>Next message: <A HREF="036297.html">[rabbitmq-discuss] Mirrored Queues Down Behaviour
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36243">[ date ]</a>
              <a href="thread.html#36243">[ thread ]</a>
              <a href="subject.html#36243">[ subject ]</a>
              <a href="author.html#36243">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
