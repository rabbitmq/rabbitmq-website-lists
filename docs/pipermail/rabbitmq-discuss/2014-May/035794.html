<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Best way to live migrate RabbitMQ consumer load from one cluster to another
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Best%20way%20to%20live%20migrate%20RabbitMQ%20consumer%0A%20load%20from%20one%20cluster%20to%20another&In-Reply-To=%3CCACLE7ixUX1SBohCsWG-wqnAWPHSqHGUZfoFUQ-Ak176%3DmptFug%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035773.html">
   <LINK REL="Next"  HREF="035772.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Best way to live migrate RabbitMQ consumer load from one cluster to another</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Best%20way%20to%20live%20migrate%20RabbitMQ%20consumer%0A%20load%20from%20one%20cluster%20to%20another&In-Reply-To=%3CCACLE7ixUX1SBohCsWG-wqnAWPHSqHGUZfoFUQ-Ak176%3DmptFug%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Best way to live migrate RabbitMQ consumer load from one cluster to another">mpietrek at skytap.com
       </A><BR>
    <I>Mon May  5 23:20:21 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035773.html">[rabbitmq-discuss] Best way to live migrate RabbitMQ consumer load from one cluster to another
</A></li>
        <LI>Next message: <A HREF="035772.html">[rabbitmq-discuss] Fanout and Route for 3,000 queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35794">[ date ]</a>
              <a href="thread.html#35794">[ thread ]</a>
              <a href="subject.html#35794">[ subject ]</a>
              <a href="author.html#35794">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the reply Arun,

Your scenario is similar to mine, and using multiple clusters is hopefully
in our future. The difference is that I'm trying to achieve it with
haproxy, rather than a dedicated load balancer like F5. My haproxy
experience is limited so I'm hoping somebody has done something like that
and can point me in a general direction.

Matt


On Fri, May 2, 2014 at 1:11 PM, Arun Rao &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">arunrao.seattle at gmail.com</A>&gt; wrote:

&gt;<i> I have not used HA-proxy but I will give you my experience on this
</I>&gt;<i> scenario: I have 3 clusters setup, so even during peak traffic, I can
</I>&gt;<i> safely remove one cluster out and upgrade or do any maintenance.
</I>&gt;<i>
</I>&gt;<i> Key understanding: Your clients catch Shutdownsignals and reconnect.
</I>&gt;<i>
</I>&gt;<i> I have F5 loadbalancer and 3 clusters behind the VIP. During maintenance,
</I>&gt;<i> I take one cluster completely out of rotation and wait for the traffic to
</I>&gt;<i> switch over to other clusters. After an hour or so, there are still few
</I>&gt;<i> connections left behind because the active connections dont switch over so
</I>&gt;<i> I do a restart of the cluster I took out of rotation. When you do the
</I>&gt;<i> restart of the cluster, there should be no pending messages in the cluster
</I>&gt;<i> so ideally you would want to find out the clients connected to this cluster
</I>&gt;<i> and restart them so they connect to the cluster you are wanting to connect.
</I>&gt;<i>
</I>&gt;<i> This is purely based on my experience, please use with caution :)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, May 2, 2014 at 9:46 AM, Matt Pietrek &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mpietrek at skytap.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Pinging on this thread - No responses as of yet, and given other traffic
</I>&gt;&gt;<i> topics here, I'd think somebody would have some thoughts or opinions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Matt
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Wed, Apr 30, 2014 at 10:49 AM, Matt Pietrek &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mpietrek at skytap.com</A>&gt;wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Apologies if this has been answered somewhere already, but my searching
</I>&gt;&gt;&gt;<i> isn't turning up anything.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm looking for advice on how to best move client traffic from one
</I>&gt;&gt;&gt;<i> RabbitMQ cluster to another without service interruption. I suspect it can
</I>&gt;&gt;&gt;<i> be done with HA-proxy, but I can't figure out the steps. I'm open to other
</I>&gt;&gt;&gt;<i> ideas as well.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Scenario: We have a 2-node cluster with all queues mirrored. Let's say
</I>&gt;&gt;&gt;<i> it's running RabbitMQ 3.2.2. Clients connect to this cluster through a VIP
</I>&gt;&gt;&gt;<i> maintained by keepalived on both RabbitMQ hosts.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We now want to move to a different identical cluster, but running 3.3.1.
</I>&gt;&gt;&gt;<i> I'm thinking I can bring up this new cluster &quot;side-by-side&quot; with the old
</I>&gt;&gt;&gt;<i> cluster, such that they're running concurrently. All new connections would
</I>&gt;&gt;&gt;<i> go to the new cluster, while already established connections to the 3.2.2
</I>&gt;&gt;&gt;<i> cluster will remain alive and working, until all clients have eventually
</I>&gt;&gt;&gt;<i> connected to the new cluster. At that point the 3.2.2 cluster can be shut
</I>&gt;&gt;&gt;<i> down.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have a hunch I can put HA-proxy in front of both clusters, and though
</I>&gt;&gt;&gt;<i> live configuration changes have it migrate the traffic to the new cluster
</I>&gt;&gt;&gt;<i> while leaving existing cluster connections alone. What I don't know is the
</I>&gt;&gt;&gt;<i> commands/configuration options/steps to implement it.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thoughts and guidance on how to best do this?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Matt
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140505/b39ffd42/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140505/b39ffd42/attachment.html</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035773.html">[rabbitmq-discuss] Best way to live migrate RabbitMQ consumer load from one cluster to another
</A></li>
	<LI>Next message: <A HREF="035772.html">[rabbitmq-discuss] Fanout and Route for 3,000 queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35794">[ date ]</a>
              <a href="thread.html#35794">[ thread ]</a>
              <a href="subject.html#35794">[ subject ]</a>
              <a href="author.html#35794">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
