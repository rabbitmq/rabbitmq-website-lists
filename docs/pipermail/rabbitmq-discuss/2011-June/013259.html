<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Database Corruption Possibilities
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Database%20Corruption%20Possibilities&In-Reply-To=%3C20110615112341.GA8285%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013127.html">
   <LINK REL="Next"  HREF="013121.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Database Corruption Possibilities</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Database%20Corruption%20Possibilities&In-Reply-To=%3C20110615112341.GA8285%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Database Corruption Possibilities">matthew at rabbitmq.com
       </A><BR>
    <I>Wed Jun 15 12:23:42 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013127.html">[rabbitmq-discuss] Database Corruption Possibilities
</A></li>
        <LI>Next message: <A HREF="013121.html">[rabbitmq-discuss]  Message is available in multiple queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13259">[ date ]</a>
              <a href="thread.html#13259">[ thread ]</a>
              <a href="subject.html#13259">[ subject ]</a>
              <a href="author.html#13259">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Jun 03, 2011 at 12:21:07PM +0100, Ozan Seymen wrote:
&gt;<i> Can someone please explain the scenarios where we might have Rabbit
</I>&gt;<i> message storage (is it mnesia?) corrupted in a way that it is not
</I>&gt;<i> recoverable?
</I>
As stated elsewhere, Rabbit does not store messages in mnesia. That
doesn't mean that mnesia being damaged won't cause problems - if you
take a hex editor to its files, I'm sure you can do much damage. Whether
or not mnesia will start up after that, I'm not sure.

Rabbit's own on disk format is very simple, and recovery is done on a
best effort basis. Rabbit is able to fsck its queues and msg stores if
necessary on start up to ensure that messages are where they're expected
to be, and Rabbit will throw away corrupted files as it finds them. This
may result, in extremis, in Rabbit being able to recover no messages
from disk, but it'll still start up happily. It doesn't care too much
that it can't read messages from disk; it'll just tidy up and get on
with life.

&gt;<i> In the solution I am working on, I simply cannot afford to lose any
</I>&gt;<i> messages. In order to secure this, I will:
</I>&gt;<i> 
</I>&gt;<i> *         Rely on publisher confirms. This should ensure that broker
</I>&gt;<i> will always confirm whether it assumed responsibility and persisted
</I>&gt;<i> the message.
</I>
Yes-ish. If the message is persistent and sent to a durable queue, and
the message isn't consumed (and ack'd), then the confirm will indicate
it's been fsync'd to disk.

&gt;<i> *         Ack enabled in consumers to prevent losing messages if
</I>&gt;<i> consumer dies halfway. I will solve the ordering problem on the
</I>&gt;<i> consumer side.
</I>
Ok. It's not just an ordering problem though; you also will need to
detect duplicates.

&gt;<i> Even though all of these above prevent message loss in normal
</I>&gt;<i> conditions, none of them covers the case where data gets corrupted in
</I>&gt;<i> the broker.
</I>
Indeed not. There are dozens of other places where messages can get
corrupted too. Faulty RAM, for example, dying hard discs,
man-in-the-middle attacks that rewrite your messages on the fly. etc
etc.

&gt;<i> There is a window (albeit small) that things might go
</I>&gt;<i> wrong: broker assumes responsibility (message is in the disk) and
</I>&gt;<i> before message is sent to the consumer, broker experiences problems
</I>&gt;<i> which corrupts the storage.
</I>
This is remarkably unlikely, and whilst I could argue long and hard
about how the design of the persister should prevent this from ever
happening, I've not proved the correctness of the kernel disk drivers,
file system, or even Erlang's own file driver. Thus there could, and
probably are, bugs in all of those that could cause such corruption.

&gt;<i> Am I a total paranoid that is beyond help? Even so, I would really
</I>&gt;<i> appreciate any info you guys can share.
</I>
I don't think you're paranoid, but all (well, nearly all) reasonably
complex software has bugs. Maybe consider taking out insurance against
message loss? Otherwise, IMO, it's far better to build your systems with
message loss in mind, rather than trying to avoid it.


Best wishes,

Matthew
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013127.html">[rabbitmq-discuss] Database Corruption Possibilities
</A></li>
	<LI>Next message: <A HREF="013121.html">[rabbitmq-discuss]  Message is available in multiple queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13259">[ date ]</a>
              <a href="thread.html#13259">[ thread ]</a>
              <a href="subject.html#13259">[ subject ]</a>
              <a href="author.html#13259">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
