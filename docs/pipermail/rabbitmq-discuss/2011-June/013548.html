<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] precondition_failed error with amqp_client for	erlang
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20precondition_failed%20error%20with%20amqp_client%20for%0A%09erlang&In-Reply-To=%3CBANLkTimEPWwHhza%3Dv_6bP98a2JPuo64j9Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013551.html">
   <LINK REL="Next"  HREF="013559.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] precondition_failed error with amqp_client for	erlang</H1>
    <B>Max Warnock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20precondition_failed%20error%20with%20amqp_client%20for%0A%09erlang&In-Reply-To=%3CBANLkTimEPWwHhza%3Dv_6bP98a2JPuo64j9Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] precondition_failed error with amqp_client for	erlang">maxjwarnock at gmail.com
       </A><BR>
    <I>Wed Jun 29 23:28:59 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013551.html">[rabbitmq-discuss] RabbitMQ ACL suggestions?
</A></li>
        <LI>Next message: <A HREF="013559.html">[rabbitmq-discuss] precondition_failed error with amqp_client for erlang
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13548">[ date ]</a>
              <a href="thread.html#13548">[ thread ]</a>
              <a href="subject.html#13548">[ subject ]</a>
              <a href="author.html#13548">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've built a behavior in erlang to subscribe to a given topic exchange and
farm out message handling.  I'm using the rabbitmq amqp_client library for
erlang and when I put the system under heavy load I get, on occasion, the
following error:

=ERROR REPORT==== 29-Jun-2011::18:02:18 ===
** Generic server &lt;0.1117.0&gt; terminating
** Last message in was {'$gen_cast',
                           {method,
                               {'channel.close',406,
                                   &lt;&lt;&quot;PRECONDITION_FAILED - unknown delivery
tag 856&quot;&gt;&gt;,
                                   60,80},
                               none}}
** When Server state == {state,1,&lt;0.1116.0&gt;,network,
                               {[],[]},
                               {[],[]},
                               {dict,0,16,16,8,80,48,

{[],[],[],[],[],[],[],[],[],[],[],[],[],
                                      [],[],[]},

{{[],[],[],[],[],[],[],[],[],[],[],[],[],
                                       [],[],[]}}},
                               false,&lt;0.1118.0&gt;,none,none,0,true,none,
                               {dict,1,16,16,8,80,48,

{[],[],[],[],[],[],[],[],[],[],[],[],[],
                                      [],[],[]},

{{[[&lt;&lt;&quot;amq.ctag-1sViVE9Y/wIKyAliWqjeCA==&quot;&gt;&gt;|
                                         etl_dispatch]],

[],[],[],[],[],[],[],[],[],[],[],[],[],
                                       [],[]}}},
                               none,#Fun&lt;amqp_channel_sup.1.53915388&gt;}
** Reason for termination ==
** {server_initiated_close,406,
                           &lt;&lt;&quot;PRECONDITION_FAILED - unknown delivery tag
856&quot;&gt;&gt;}

The server receive loop where the ack happens looks like this:
receive
...
{#'basic.deliver'{delivery_tag = Tag, routing_key = RoutingKey},
#amqp_msg{payload = Payload}} -&gt;
    amqp_channel:cast(get(amqp_channel_pid), #'basic.ack'{delivery_tag =
Tag}),
    spawn_and_queue(spawn_handle_message, Module, RoutingKey, Payload),
    loop(Module);
...
end

The amqp_client_sup can't seem to bring back the the client either and dies
from the retry intensity being reached.  I've done a hefty amount of
googling and can't seem to find where things could be going wrong.  Before
jumping into the amqp_client code I thought I'd ask the mailing list if they
have any ideas.  The only thing I can think is that there is a race
condition within the client library.  I will be double checking my code to
be sure it isn't sending the ack twice, but given the simplicity of the ack
the only way it could is if it receives the same message (with identical
delivery tag) from the amqp_client library twice.

Thanks,
-Max
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110629/df8095b9/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110629/df8095b9/attachment.htm</A>&gt;
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013551.html">[rabbitmq-discuss] RabbitMQ ACL suggestions?
</A></li>
	<LI>Next message: <A HREF="013559.html">[rabbitmq-discuss] precondition_failed error with amqp_client for erlang
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13548">[ date ]</a>
              <a href="thread.html#13548">[ thread ]</a>
              <a href="subject.html#13548">[ subject ]</a>
              <a href="author.html#13548">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
