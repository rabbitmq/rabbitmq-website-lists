<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] queue subscription + sending to some exchange
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20queue%20subscription%20%2B%20sending%20to%20some%20exchange&In-Reply-To=%3CBANLkTinY87p-tibCVvKfd-MFA-V%2BeJJQ7g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013363.html">
   <LINK REL="Next"  HREF="013367.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] queue subscription + sending to some exchange</H1>
    <B>Petar Shomov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20queue%20subscription%20%2B%20sending%20to%20some%20exchange&In-Reply-To=%3CBANLkTinY87p-tibCVvKfd-MFA-V%2BeJJQ7g%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] queue subscription + sending to some exchange">pshomov at gmail.com
       </A><BR>
    <I>Tue Jun 21 01:17:24 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013363.html">[rabbitmq-discuss] LATEST.LOG growth on clustered ram node
</A></li>
        <LI>Next message: <A HREF="013367.html">[rabbitmq-discuss] queue subscription + sending to some exchange
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13364">[ date ]</a>
              <a href="thread.html#13364">[ thread ]</a>
              <a href="subject.html#13364">[ subject ]</a>
              <a href="author.html#13364">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simone,

Thanx for the suggestion! I have read that section about threading
many times but my understanding is that channels can be shared among
threads as long as they are not used concurrently. I am not doing that
and I even went ahead and created that channel in the thread that is
doing the consumption just to be on the safe side. No dice, same
error.

What worries me in that section is this paragraph:

&quot;Application callback handlers must not invoke blocking AMQP operations (such as
IModel.QueueDeclare, IModel.BasicCancel or IModel.BasicPublish). If
they do, the channel
will deadlock&quot;

Now, does that mean I should not be doing what I intended to be doing
(I use IModel.BasicPublish)? I find that hard to believe.
I am taking care to open a different channel for the publishing of my
messages but I wonder is that enough?
My channel did not deadlock just looks like things got mixed up ;(

---------------------------------
Regards,

Petar



On Mon, Jun 20, 2011 at 9:57 PM, Simone Busoli &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simone.busoli at gmail.com</A>&gt; wrote:
&gt;<i> Hi Petar,
</I>&gt;<i>
</I>&gt;<i> I think you are violating one of the assumption that the C# client does on
</I>&gt;<i> channel usage. Channels should not be shared among threads (read the pdf
</I>&gt;<i> user guide for details), and it appears you are using the channel on a
</I>&gt;<i> different thread than that where the channel was created.
</I>&gt;<i>
</I>&gt;<i> On Mon, Jun 20, 2011 at 23:41, Petar Shomov &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pshomov at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi guys,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a situation which I do not completely understand and I was
</I>&gt;&gt;<i> hoping someone more acquainted with AMQP and RabbitMQ might point me
</I>&gt;&gt;<i> in the right direction.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a console app that needs to subscribe to a message queue where
</I>&gt;&gt;<i> the process of handling a message is rather lengthy. During this
</I>&gt;&gt;<i> lengthy process I need to send out messages to some exchange which
</I>&gt;&gt;<i> represent information about the progress of the operation.
</I>&gt;&gt;<i> The subscription to the queue has to be asynchronous too, since I am
</I>&gt;&gt;<i> doing something else on the main thread. So I have running in a thread
</I>&gt;&gt;<i> this code (C#):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;var job = new Thread(() =&gt;
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; var consumer = new
</I>&gt;&gt;<i> QueueingBasicConsumer(channel);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> channel.BasicConsume(queueName, false, consumer);
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; while (true)
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; BasicDeliverEventArgs e =
</I>&gt;&gt;<i> null;
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; e =
</I>&gt;&gt;<i> (BasicDeliverEventArgs) consumer.Queue.Dequeue();
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> queueHandlers[queueName][e.Exchange](e);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> channel.BasicAck(e.DeliveryTag, false);
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;}
</I>&gt;&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;Unfortunately when I try to send messages within the message handler
</I>&gt;&gt;<i> (I am opening a different channel on the same connection, tried even
</I>&gt;&gt;<i> opening a different connection with no better luck) I am getting these
</I>&gt;&gt;<i> kind of exceptions, usually when attempting to send the *second*
</I>&gt;&gt;<i> message:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - &#160; &#160; &#160; &#160; &#160; &#160; &#160; $exception &#160; &#160; &#160;{&quot;The AMQP operation was interrupted: AMQP
</I>&gt;&gt;<i> close-reason,
</I>&gt;&gt;<i> initiated by Library, code=504, text=\&quot;Frame received for invalid
</I>&gt;&gt;<i> channel 2\&quot;, classId=0, methodId=0,
</I>&gt;&gt;<i> cause=RabbitMQ.Client.Impl.ChannelErrorException: Frame received for
</I>&gt;&gt;<i> invalid channel 2\r\n &#160; at ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thoughts, ideas, anything?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ---------------------------------
</I>&gt;&gt;<i> Regards,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Petar
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013363.html">[rabbitmq-discuss] LATEST.LOG growth on clustered ram node
</A></li>
	<LI>Next message: <A HREF="013367.html">[rabbitmq-discuss] queue subscription + sending to some exchange
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13364">[ date ]</a>
              <a href="thread.html#13364">[ thread ]</a>
              <a href="subject.html#13364">[ subject ]</a>
              <a href="author.html#13364">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
