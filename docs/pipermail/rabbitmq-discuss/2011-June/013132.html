<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Perl%20Net%3A%3ARabbitMQ%20and%20failure%20conditions&In-Reply-To=%3CBANLkTi%3D7r2sQzrjUCCybHbHtEPWwPQgfSw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013130.html">
   <LINK REL="Next"  HREF="013135.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions</H1>
    <B>Ronald J Kimball</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Perl%20Net%3A%3ARabbitMQ%20and%20failure%20conditions&In-Reply-To=%3CBANLkTi%3D7r2sQzrjUCCybHbHtEPWwPQgfSw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions">rkimball at pangeamedia.com
       </A><BR>
    <I>Fri Jun  3 17:39:47 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013130.html">[rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions
</A></li>
        <LI>Next message: <A HREF="013135.html">[rabbitmq-discuss] Ruby AMQP gem 0.8.0.rc13 is released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13132">[ date ]</a>
              <a href="thread.html#13132">[ thread ]</a>
              <a href="subject.html#13132">[ subject ]</a>
              <a href="author.html#13132">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alexis, thanks for getting in touch with Theo.  However, I'm not sure
this addresses my issue.

I think he's using &quot;remote&quot; here to refer to the Rabbit process on the other
end of the socket from my publisher.  If that Rabbit process goes down, the
publisher does receive a SIGPIPE.  However, that is actually my &quot;local&quot;
process.  My &quot;remote&quot; process is the Rabbit node on another machine that
holds the queue.  My publisher connects to the local Rabbit, and the local
Rabbit connects to the remote Rabbit.  If the remote Rabbit goes down, there
is no SIGPIPE in my publisher.

The hang in DESTROY was resolved by upgrading Rabbit itself.

I'll contact him myself and let you know what I find out.

Ronald


On Fri, Jun 3, 2011 at 11:47 AM, Alexis Richardson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexis at rabbitmq.com</A>&gt;wrote:

&gt;<i> Ronald
</I>&gt;<i>
</I>&gt;<i> I spoke with the author, Theo Schlossnagle, who permitted to post his
</I>&gt;<i> reply here:
</I>&gt;<i>
</I>&gt;<i> -
</I>&gt;<i> You must catch SIGPIPE if you plan to handle busted writes on
</I>&gt;<i> sockets. This is straight forward from perl.
</I>&gt;<i>
</I>&gt;<i> The publishes don't erroneously indicated success as the writes() and
</I>&gt;<i> synchronous. The remote is down, but the TCP socket hasn't realized it
</I>&gt;<i> yet... So you write(), which is fine (as the socket hasn't flushed).
</I>&gt;<i> So, if it flushes into the kernel and the kernel knows the socket is
</I>&gt;<i> busted -&gt; SIGPIPE, if not, then you'll get a successful publish.  That
</I>&gt;<i> behaviour is expected, no?
</I>&gt;<i>
</I>&gt;<i> The hang in DESTROY sounds like a bug -- I have not seen that one on
</I>&gt;<i> my side.  Would like some more information -- user-space stack trace
</I>&gt;<i> of the hung perl process w/ symbols would be awesome.
</I>&gt;<i>
</I>&gt;<i> You can also open a issue on github for the specific problems
</I>&gt;<i> remaining unresolved:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/omniti-labs/Net--RabbitMQ">https://github.com/omniti-labs/Net--RabbitMQ</A>
</I>&gt;<i> -
</I>&gt;<i>
</I>&gt;<i> Hope this helps!
</I>&gt;<i>
</I>&gt;<i> alexis
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, May 31, 2011 at 6:34 PM, Ronald J Kimball
</I>&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rkimball at pangeamedia.com</A>&gt; wrote:
</I>&gt;<i> &gt; Hi, thanks for the response.  Unfortunately, I haven't really found an
</I>&gt;<i> &gt; answer.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We upgraded RabbitMQ to 2.4.1, after which Net::RabbitMQ no longer hangs
</I>&gt;<i> &gt; when the remote server is up but the remote app is down.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; However, Net::RabbitMQ still returns a false success when the remote
</I>&gt;<i> server
</I>&gt;<i> &gt; or app goes down after the publisher connects to the local node.  (The
</I>&gt;<i> queue
</I>&gt;<i> &gt; is located on the remote app.)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For now, we've switched to having a single node.  This decreases our
</I>&gt;<i> &gt; throughput slightly, but at least we don't risk dropping messages.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think we must be doing something wrong, but I don't know what...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Ronald
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Tue, May 31, 2011 at 7:41 AM, Alexis Richardson &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">alexis at rabbitmq.com</A>&gt;
</I>&gt;<i> &gt; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Ronald
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Were you able to find an answer to this?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; alexis
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On Thu, May 19, 2011 at 9:44 PM, Ronald J Kimball
</I>&gt;<i> &gt;&gt; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rkimball at pangeamedia.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt; I'm trying to understand how RabbitMQ behaves under failure
</I>&gt;<i> conditions,
</I>&gt;<i> &gt;&gt; &gt; specifically when using the Net::RabbitMQ Perl module.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; We have RabbitMQ set up with three nodes, one on the backend, which
</I>&gt;<i> &gt;&gt; &gt; holds
</I>&gt;<i> &gt;&gt; &gt; the actual queues, and two on the frontend, which receive publish
</I>&gt;<i> &gt;&gt; &gt; requests.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; RabbitMQ 2.2.0
</I>&gt;<i> &gt;&gt; &gt; Net::RabbitMQ 0.1.8
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; Below is the chart of behaviors that I have observed.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &quot;+&quot; means the behavior is as I expected: either the message is
</I>&gt;<i> &gt;&gt; &gt; successfully
</I>&gt;<i> &gt;&gt; &gt; queued, or an error is thrown.
</I>&gt;<i> &gt;&gt; &gt; &quot;-&quot; means the behavior is not as I expected, but can be managed:
</I>&gt;<i> &gt;&gt; &gt; specifically, the process receives a SIGPIPE, which I can trap and
</I>&gt;<i> &gt;&gt; &gt; recover
</I>&gt;<i> &gt;&gt; &gt; from.
</I>&gt;<i> &gt;&gt; &gt; &quot;!&quot; means the behavior is not as I expected, and cannot be managed:
</I>&gt;<i> the
</I>&gt;<i> &gt;&gt; &gt; message is not queued but no error is thrown and/or the process hangs.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &quot;App down&quot; means I ran `rabbitmqctl stop_app`.  &quot;Daemon down&quot; means I
</I>&gt;<i> &gt;&gt; &gt; ran
</I>&gt;<i> &gt;&gt; &gt; `rabbitmqctl stop`.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;   As publishing process starts up:
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Remote daemon up, app up
</I>&gt;<i> &gt;&gt; &gt;       + Everything okay
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Remote daemon up, app down
</I>&gt;<i> &gt;&gt; &gt;       ! Net::RabbitMQ hangs when declaring queue
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Remote daemon down
</I>&gt;<i> &gt;&gt; &gt;       + Net::RabbitMQ throws error when declaring queue
</I>&gt;<i> &gt;&gt; &gt;         &quot;Declaring queue: server channel error 404, message: NOT_FOUND
</I>&gt;<i> -
</I>&gt;<i> &gt;&gt; &gt; no
</I>&gt;<i> &gt;&gt; &gt; queue 'test' in vhost '/'&quot;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Local daemon up, app down
</I>&gt;<i> &gt;&gt; &gt;       + Net::RabbitMQ throws error when connecting
</I>&gt;<i> &gt;&gt; &gt;         &quot;Opening socket: Connection refused&quot;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Local daemon down
</I>&gt;<i> &gt;&gt; &gt;       + Net::RabbitMQ throws error when connecting
</I>&gt;<i> &gt;&gt; &gt;         &quot;Opening socket: Connection refused&quot;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;   After publishing process starts up:
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Local app goes down
</I>&gt;<i> &gt;&gt; &gt;       - Process receives SIGPIPE
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Local daemon goes down
</I>&gt;<i> &gt;&gt; &gt;       - Process receives SIGPIPE
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Remote app goes down
</I>&gt;<i> &gt;&gt; &gt;       ! Net::RabbitMQ falsely indicates success when publishing, then
</I>&gt;<i> &gt;&gt; &gt; hangs
</I>&gt;<i> &gt;&gt; &gt; (in DESTROY?)
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Remote daemon goes down
</I>&gt;<i> &gt;&gt; &gt;       ! Net::RabbitMQ falsely indicates success when publishing
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Local app goes down, comes back up
</I>&gt;<i> &gt;&gt; &gt;       - Process receives SIGPIPE
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Local daemon goes down, comes back up
</I>&gt;<i> &gt;&gt; &gt;       - Process receives SIGPIPE
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Remote app goes down, comes back up
</I>&gt;<i> &gt;&gt; &gt;       + Everything okay
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;     Remote daemon goes down, comes back up
</I>&gt;<i> &gt;&gt; &gt;       + Everything okay
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; Have other people had these problems with Net::RabbitMQ?  Can we
</I>&gt;<i> resolve
</I>&gt;<i> &gt;&gt; &gt; these issues by changing something in our RabbitMQ configuration?
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; thanks,
</I>&gt;<i> &gt;&gt; &gt; Ronald
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; P.S. Here's my script.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; #!/usr/local/bin/perl
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; use strict;
</I>&gt;<i> &gt;&gt; &gt; use warnings;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; use Net::RabbitMQ;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; $| = 1;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; $SIG{'PIPE'} = sub { die &quot;SIGPIPE\n&quot; };
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; my $mq = Net::RabbitMQ-&gt;new();
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; alarm(10);
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; print &quot;Connecting\n&quot;;
</I>&gt;<i> &gt;&gt; &gt; $mq-&gt;connect('localhost', { user =&gt; 'engagement', password =&gt;
</I>&gt;<i> '********'
</I>&gt;<i> &gt;&gt; &gt; })
</I>&gt;<i> &gt;&gt; &gt;   or die &quot;Can't connect to RabbitMQ\n&quot;;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; print &quot;Opening channel\n&quot;;
</I>&gt;<i> &gt;&gt; &gt; $mq-&gt;channel_open(1);
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; print &quot;Declaring exchange\n&quot;;
</I>&gt;<i> &gt;&gt; &gt; $mq-&gt;exchange_declare(1, 'ee_exchange', { durable =&gt; 1 });
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; print &quot;Declaring queue\n&quot;;
</I>&gt;<i> &gt;&gt; &gt; $mq-&gt;queue_declare(1, 'test', { durable =&gt; 1 });
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; print &quot;Binding queue\n&quot;;
</I>&gt;<i> &gt;&gt; &gt; $mq-&gt;queue_bind(1, 'test', 'ee_exchange', 'ee_test');
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; alarm(0);
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; print &quot;&gt; &quot;;
</I>&gt;<i> &gt;&gt; &gt; &lt;&gt;;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; alarm(10);
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; print &quot;Publishing message\n&quot;;
</I>&gt;<i> &gt;&gt; &gt; my $rc =
</I>&gt;<i> &gt;&gt; &gt;   $mq-&gt;publish(1, 'ee_test', 'hello world!',
</I>&gt;<i> &gt;&gt; &gt;                { exchange =&gt; 'ee_exchange', mandatory =&gt; 1, immediate
</I>&gt;<i> =&gt;
</I>&gt;<i> &gt;&gt; &gt; 0
</I>&gt;<i> &gt;&gt; &gt; },
</I>&gt;<i> &gt;&gt; &gt;                { delivery_mode =&gt; 2 });
</I>&gt;<i> &gt;&gt; &gt; print &quot;Result: $rc\n&quot;;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; __END__
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; _______________________________________________
</I>&gt;<i> &gt;&gt; &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt;&gt; &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;&gt; &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110603/afc55274/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110603/afc55274/attachment.htm</A>&gt;
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013130.html">[rabbitmq-discuss] Perl Net::RabbitMQ and failure conditions
</A></li>
	<LI>Next message: <A HREF="013135.html">[rabbitmq-discuss] Ruby AMQP gem 0.8.0.rc13 is released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13132">[ date ]</a>
              <a href="thread.html#13132">[ thread ]</a>
              <a href="subject.html#13132">[ subject ]</a>
              <a href="author.html#13132">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
