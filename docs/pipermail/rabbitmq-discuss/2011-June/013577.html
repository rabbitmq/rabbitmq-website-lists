<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Issue with rabbit starting up every time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Issue%20with%20rabbit%20starting%20up%20every%20time&In-Reply-To=%3C068C0966A93143AA93D90B5720231FA4%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013576.html">
   <LINK REL="Next"  HREF="013578.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Issue with rabbit starting up every time</H1>
    <B>Chris Madden</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Issue%20with%20rabbit%20starting%20up%20every%20time&In-Reply-To=%3C068C0966A93143AA93D90B5720231FA4%40gmail.com%3E"
       TITLE="[rabbitmq-discuss] Issue with rabbit starting up every time">chris.madden at gmail.com
       </A><BR>
    <I>Thu Jun 30 20:47:21 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013576.html">[rabbitmq-discuss] How to add libraries to GAC
</A></li>
        <LI>Next message: <A HREF="013578.html">[rabbitmq-discuss] rabbitmq-c -- multiple exectables receiving same	message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13577">[ date ]</a>
              <a href="thread.html#13577">[ thread ]</a>
              <a href="subject.html#13577">[ subject ]</a>
              <a href="author.html#13577">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have 2 nodes in a cluster, both are disc nodes. Occasionally, following a reboot, rabbit will not start.  The error I get is the dreaded timeout_waiting_for_tables. The googles indicate that this can happen when host names change, but that isn't happening. Further, when I get this problem, one node is always up and stable, and network connectivity appears fine.

Interestingly, it seems to correct itself if I continue to restart rabbit. Sometimes it can take 15-20 attempts to get it to start correctly. It *feels* like a race internal to rabbit to me, as I see it more on single processor systems than I do on multi-processor systems. I don't have any durable or persistent queues for it to have to load or anything, just 1 user in the database and a couple permissions.

I'm suspicious of <A HREF="http://hg.rabbitmq.com/rabbitmq-server/file/5f84b55205fd/src/rabbit_mnesia.erl#l610,">http://hg.rabbitmq.com/rabbitmq-server/file/5f84b55205fd/src/rabbit_mnesia.erl#l610,</A> with a hard coded timeout a heavily loaded system (which this is definitely at boot time) may take more than 30 seconds (assuming I'm reading that correctly).

I've rabbit 2.5.0 on linux on erlang R14B03

Looking at the log files I see:

+---+ +---+
|<i> | | |
</I>|<i> | | |
</I>|<i> | | |
</I>|<i> +---+ +-------+
</I>|<i> |
</I>|<i> RabbitMQ +---+ |
</I>|<i> | | |
</I>|<i> v2.5.0 +---+ |
</I>|<i> |
</I>+-------------------+
AMQP 0-9-1 / 0-9 / 0-8
Copyright (C) 2007-2011 VMware, Inc.
Licensed under the MPL. See <A HREF="http://www.rabbitmq.com/">http://www.rabbitmq.com/</A>

node : <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at halfoat</A> (mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at halfoat</A>)
app descriptor : /usr/lib/rabbitmq/lib/rabbitmq_server-2.5.0/sbin/../ebin/rabbit.app
home dir : /var/lib/rabbitmq
config file(s) : /etc/rabbitmq/rabbitmq.config
cookie hash : nwwpVc1h/mTYt75nAmVI0A==
log : /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at halfoat.log</A> (mailto:/var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at halfoat.log</A>)
sasl log : /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at halfoat-sasl.log</A> (mailto:/var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at halfoat-sasl.log</A>)
database dir : /var/db/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at halfoat</A> (mailto:/var/db/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at halfoat</A>)
erlang version : 5.8.4

-- rabbit boot start
starting file handle cache server ...
=INFO REPORT==== 30-Jun-2011::19:09:41 ===
Limiting to approx 924 file handles (829 sockets)
done
starting worker pool ...done
starting database ...

At this point it pauses, then times out, dumping:

Reason: {error,
 {timeout_waiting_for_tables,
 [rabbit_user,rabbit_user_permission,rabbit_vhost,
rabbit_durable_route,rabbit_durable_exchange,
rabbit_durable_queue]}}
Stacktrace: [{rabbit_mnesia,wait_for_tables,1},
{rabbit_mnesia,check_schema_integrity,0},
{rabbit_mnesia,ensure_schema_integrity,0},
{rabbit_mnesia,init_db,3},
{rabbit_mnesia,init,0},
{rabbit,'-run_boot_step/1-lc$^1/1-1-',1},
{rabbit,run_boot_step,1},
{rabbit,'-start/2-lc$^0/1-0-',1}]
Erlang has closed
{&quot;Kernel pid terminated&quot;,application_controller,&quot;{application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}}&quot;}


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013576.html">[rabbitmq-discuss] How to add libraries to GAC
</A></li>
	<LI>Next message: <A HREF="013578.html">[rabbitmq-discuss] rabbitmq-c -- multiple exectables receiving same	message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13577">[ date ]</a>
              <a href="thread.html#13577">[ thread ]</a>
              <a href="subject.html#13577">[ subject ]</a>
              <a href="author.html#13577">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
