<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] limit number of messages buffered in memory in new persister
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20limit%20number%20of%20messages%20buffered%20in%20memory%0A%20in%20new%20persister&In-Reply-To=738510.88277.qm%40web31803.mail.mud.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006561.html">
   <LINK REL="Next"  HREF="006560.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] limit number of messages buffered in memory in new persister</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20limit%20number%20of%20messages%20buffered%20in%20memory%0A%20in%20new%20persister&In-Reply-To=738510.88277.qm%40web31803.mail.mud.yahoo.com"
       TITLE="[rabbitmq-discuss] limit number of messages buffered in memory in new persister">matthew at lshift.net
       </A><BR>
    <I>Fri Mar  5 11:59:17 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006561.html">[rabbitmq-discuss] limit number of messages buffered in memory	in new persister
</A></li>
        <LI>Next message: <A HREF="006560.html">[rabbitmq-discuss] limit number of messages buffered in memory	in new persister
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6559">[ date ]</a>
              <a href="thread.html#6559">[ thread ]</a>
              <a href="subject.html#6559">[ subject ]</a>
              <a href="author.html#6559">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex,

On Thu, Mar 04, 2010 at 06:25:52PM -0800, alex chen wrote:
&gt;<i> We tested publish+commit and found that it is much slower than publish only.
</I>
It always will be. Rabbit buffers messages in several locations before
they hit disk. By issuing the commit, you're forcing all those buffers
to be drained and the message to be fsync'd to disk. At the end of the
day, you are going to be limited by the speed at which you can fsync.

What you can do, is publish messages in parallel, using different
channels. The server can coalesce these commits under some circumstances
and so you could publish, say, 100 messages on one channel, and then
issue the commit. Whilst you're waiting for the commit_ok to come back,
you could publish on another channel. You'd need to build your client in
this way, but it would mean you're never halting publishes.

&gt;<i> For single client with commit on every publish, it can do about 20 msg/sec.
</I>
That's pretty low. See my other email - you should be able get much much
higer than that with some careful tuning. Experimentation and testing is
the order of the day - it's very dependent on your hard disc, what else
is being written to the disk, the file system, kernel and the direction
of the prevailing wind.

&gt;<i> It took about 40ms for client to get the tx_commit_ok from server.
</I>&gt;<i> It seems to me the bottleneck was not fsync, because disk was not busy.
</I>&gt;<i> also i tried commenting out file:sync() from the src code and it has no effect.
</I>
That is very curious. Also, don't do that - if it crashes at that point
you're not going to be able to recover much data from disk ;) How big
are the messages you're writing?

&gt;<i> if commit on 100 publishes, the performance increases to above 1000 msg/sec.
</I>&gt;<i> Is there anyway to speed up the performance for commit on every publish?  
</I>
Yes. Better hard discs / SSDs and kernel/fs tuning.

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006561.html">[rabbitmq-discuss] limit number of messages buffered in memory	in new persister
</A></li>
	<LI>Next message: <A HREF="006560.html">[rabbitmq-discuss] limit number of messages buffered in memory	in new persister
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6559">[ date ]</a>
              <a href="thread.html#6559">[ thread ]</a>
              <a href="subject.html#6559">[ subject ]</a>
              <a href="author.html#6559">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
