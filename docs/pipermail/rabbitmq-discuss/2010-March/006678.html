<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] High Availability
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20High%20Availability&In-Reply-To=B56341AE-E4D0-4A7F-85D8-1C0F9FD8916A%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006674.html">
   <LINK REL="Next"  HREF="006675.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] High Availability</H1>
    <B>Gustavo Aquino</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20High%20Availability&In-Reply-To=B56341AE-E4D0-4A7F-85D8-1C0F9FD8916A%40gmail.com"
       TITLE="[rabbitmq-discuss] High Availability">aquino.gustavo at gmail.com
       </A><BR>
    <I>Thu Mar 18 16:15:33 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006674.html">[rabbitmq-discuss] High Availability
</A></li>
        <LI>Next message: <A HREF="006675.html">[rabbitmq-discuss] High Availability
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6678">[ date ]</a>
              <a href="thread.html#6678">[ thread ]</a>
              <a href="subject.html#6678">[ subject ]</a>
              <a href="author.html#6678">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alvaro,

On Thu, Mar 18, 2010 at 10:12 AM, Alvaro Videla &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">videlalvaro at gmail.com</A>&gt;wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> While I don't know how HIGH is your high, I can tell you what we do for our
</I>&gt;<i> live site
</I>&gt;<i>
</I>
Our high need to be the HIGHEST, we produce inbound about ~3000 messages per
second and ~9000 messages per second of outbounds and can't loose any
messages, well we are working hard to it, our concerns is about RabbitMQ
cluster HP model, so for hight throughput it works very very well. I will
report about our volume in other e-mail and we are very happy with the power
of RabbitMQ it's putting our server to cry to process in one test 1.000.000
messages per second and do it very well. Sure we have some problems that I
had reported here one with memory consume, until now we unable to use rabbit
with more that 3GB, other with queue monitoring and etc..



&gt;<i> Currently we have around 400.000 messages a day  &#8211;which is not much&#8211;, sent
</I>&gt;<i> to 2 RabbitMQ servers running in low end machines. The unixload on those
</I>&gt;<i> machines is always below 0.2
</I>&gt;<i>
</I>&gt;<i> So here's my story of HA based on that setup:
</I>&gt;<i>
</I>&gt;<i> When we deployed the system we started the two servers, NOT using
</I>&gt;<i> clustering. Their version was 1.5.2. This was mid 2009.
</I>&gt;<i>
</I>&gt;<i> Then we have 28 PHP machines publishing the messages to a SINGLE IP, using
</I>&gt;<i> IP Failover (Heartbeat+LVS), this means that for the PHP publishers there's
</I>&gt;<i> only one IP to connect-to/send-messages.
</I>

&gt;<i> Then we have 2 PHP machines consuming messages, but they connect directly
</I>&gt;<i> to the IPs of the RabbitMQ servers, we do that to be sure that we connect
</I>&gt;<i> directly to a specific broker.
</I>&gt;<i>
</I>&gt;<i> This also means that the queues, exchanges, bindings, etc, are all
</I>&gt;<i> duplicated between the two servers.
</I>&gt;<i>
</I>&gt;<i> But there was a problem! We wanted to upgrade to the latest version of
</I>&gt;<i> RabbitMQ which has a non compatible storage format, at least with our
</I>&gt;<i> version of RabbitMQ.
</I>&gt;<i>
</I>&gt;<i> What we did was the following:
</I>&gt;<i>
</I>&gt;<i> The sysadmin took out of the load balancing one of the brokers, and we
</I>&gt;<i> waited till the workers consumed all the messages. When their queues were
</I>&gt;<i> empty, we shut down the server and did the upgrade. Then we put it back into
</I>&gt;<i> the load balancer and repeated the process with the other broker.
</I>&gt;<i>
</I>&gt;<i> In this way we didn't lose any message.
</I>&gt;<i>
</I>&gt;<i> But we wanted to test the native RabbitMQ clustering...
</I>&gt;<i>
</I>&gt;<i> The sysadmin ran the commands from the Clustering Guide and we had the
</I>&gt;<i> cluster up an running, until we had another problem...
</I>&gt;<i>
</I>&gt;<i> Sometimes the RabbitMQ sent the redirect response to the consumers, and
</I>&gt;<i> told them, to connect to the other node, the problem we had here, is that
</I>&gt;<i> RabbitMQ uses the node() function from Erlang, which for the way we have
</I>&gt;<i> configured the /etc/hosts file, it was returning a node that was unreachable
</I>&gt;<i> from outside (This was only happening to the consumers, because they connect
</I>&gt;<i> directly to the RabbitMQ nodes).
</I>&gt;<i>
</I>&gt;<i> So here we did the same as before, we took one broker out of the load
</I>&gt;<i> balancing, we took it out of the clustering, and put it back again, and the
</I>&gt;<i> same thing with the other node.
</I>&gt;<i>
</I>&gt;<i> Again we didn't lose any message.
</I>&gt;<i>
</I>&gt;<i> Then on the connection configuration, we have a really simple .yml file to
</I>&gt;<i> tell the PHP process where to connect, basically by providing an argument on
</I>&gt;<i> the CLI.
</I>&gt;<i>
</I>&gt;<i> I hope this helps,
</I>&gt;<i>
</I>

I will take a look about LVM now.. so I would like to do some questions that
I'm in doubt about your solution. Do you know what is the overhead using LVM
? How many messages per second do you have ? Do you use a persistent queue ?
If yes how did you to continue consume queue when one node is down ?

You are using a heartbeat, so how you share inter nodes the same disk ? NFS
? Storage ?

Thank you so much for your report it helps a lot.

Best wishes.


&gt;<i>
</I>&gt;<i> Alvaro
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mar 18, 2010, at 7:57 PM, Gustavo Aquino wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have done this question before for many peoples, without success,
</I>&gt;<i> because I don't found (Documentation, discussion lists and etc) any way to
</I>&gt;<i> do High Availability with RabbitMQ without a lot of workaround, so exist a
</I>&gt;<i> way to do HA with RabbitMQ without implementing a lot of stuffs by client
</I>&gt;<i> side, like recreating queues when node down, recreating configurations,
</I>&gt;<i> recreating client connections and etc ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What's recommendation from RabbitMQ to do HA ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Someone here have done some HA implementation to RabbitMQ ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Regards.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Gustavo
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100318/ce1ac412/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100318/ce1ac412/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006674.html">[rabbitmq-discuss] High Availability
</A></li>
	<LI>Next message: <A HREF="006675.html">[rabbitmq-discuss] High Availability
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6678">[ date ]</a>
              <a href="thread.html#6678">[ thread ]</a>
              <a href="subject.html#6678">[ subject ]</a>
              <a href="author.html#6678">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
