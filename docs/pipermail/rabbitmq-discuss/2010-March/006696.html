<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] New Persister
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20New%20Persister&In-Reply-To=20100321225826.GA26638%40wellquite.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006694.html">
   <LINK REL="Next"  HREF="006699.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] New Persister</H1>
    <B>Scott Mohekey</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20New%20Persister&In-Reply-To=20100321225826.GA26638%40wellquite.org"
       TITLE="[rabbitmq-discuss] New Persister">scott.mohekey at telogis.com
       </A><BR>
    <I>Mon Mar 22 01:29:52 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006694.html">[rabbitmq-discuss] New Persister
</A></li>
        <LI>Next message: <A HREF="006699.html">[rabbitmq-discuss] New Persister
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6696">[ date ]</a>
              <a href="thread.html#6696">[ thread ]</a>
              <a href="subject.html#6696">[ subject ]</a>
              <a href="author.html#6696">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Reply inline below:

Scott Mohekey
Systems/Application Specialist &#8211; Fleet &#8211; Telogis, Inc.
www.telogis.com  www.telogis.co.nz
+1 949 625-4115 ext. 207 (USA)  +64 3339 2825 x207 (NZ)

Leading Global Platform for Location Based Services
--
This e-mail, and any attachments, is intended only for use by the
addressee(s) named herein and may contain legally privileged and/or
confidential information.  It is the property of Telogis.  If you are not
the intended recipient of this e-mail, you are hereby notified that any
dissemination, distribution or copying of this e-mail, any attachments
thereto, and use of the information contained, is strictly prohibited.  If
you have received this e-mail in error, please notify the sender and
permanently delete the original and any copy there of.


On Mon, Mar 22, 2010 at 11:58 AM, Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at lshift.net</A>&gt;wrote:

&gt;<i> On Mon, Mar 22, 2010 at 11:26:24AM +1300, Scott Mohekey wrote:
</I>&gt;<i> &gt; I'm trying to find out when the new persister will be available.
</I>&gt;<i>
</I>&gt;<i> Me too!
</I>&gt;<i>
</I>&gt;<i> &gt; I've seen
</I>&gt;<i> &gt; mention that it was to be ready by July of last year (
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-June/003667.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-June/003667.html</A>
</I>&gt;<i> ),
</I>&gt;<i> &gt; and further mention in November of it not being ready yet (
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-November/005386.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2009-November/005386.html</A>
</I>&gt;<i> &gt; ).
</I>&gt;<i>
</I>&gt;<i> Yes. Though the &quot;new persister&quot; was in very different states at both of
</I>&gt;<i> occasions.
</I>&gt;<i>
</I>&gt;<i> &gt; The reason I ask is that we are attempting to publish ~1000 msgs/sec on a
</I>&gt;<i> &gt; single rabbit node, in a persisted queue. The queue is then read by a
</I>&gt;<i> java
</I>&gt;<i> &gt; app on a geographically distant server over the internet, using
</I>&gt;<i> &gt; basic.consume. We also require transactional consumption, so currently
</I>&gt;<i> wrap
</I>&gt;<i> &gt; a batch of X (500 for example) messages in a transaction, acking the last
</I>&gt;<i> &gt; one (passing true to ack multiple). We have qos set to batch size * 2
</I>&gt;<i> (1000
</I>&gt;<i> &gt; in the above example).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We're only managing to get something like 50 or so msgs/sec at the
</I>&gt;<i> moment.
</I>&gt;<i> &gt; The consumption of the messages is slow, but the tx.commit varies in
</I>&gt;<i> speed
</I>&gt;<i> &gt; from a second to many (sometimes even as long as a minute).
</I>&gt;<i>
</I>&gt;<i> Many things can affect this. Are the publishes coming from a single
</I>&gt;<i> publisher client or from many clients? Are all the publishes going to
</I>&gt;<i> the same queue or to several different queues? How big are the messages
</I>&gt;<i> that you're publishing and which client library / language are you
</I>&gt;<i> using?
</I>&gt;<i>
</I>&gt;<i>
</I>We have a single publisher, with 10 production queues which are duplicated
for testing (so 20 queues all up). All of these queues are persistent.

We use a topic exchange, with messages being routed to one or more of the
queues.

The publisher uses the .net client and does no transactions, while the
consumer uses the java client and wraps batches of messages in transactions.


&gt;<i> &gt; The version of rabbitmq we currently have installed is 1.7.0. We are
</I>&gt;<i> &gt; planning to test with 1.7.2 later today to see if this helps any.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What are we doing wrong?
</I>&gt;<i>
</I>&gt;<i> The new persister is much better (at least an order of magnitude, and
</I>&gt;<i> frequently several, depending on workload) at transactions. I would
</I>&gt;<i> suggest you try compiling from source and using that. There are several
</I>&gt;<i> people on this list who have been using the new persister with good
</I>&gt;<i> success. There are occasionally bugs found, but we tend to fix them
</I>&gt;<i> within hours.
</I>&gt;<i>
</I>&gt;<i> There haven't really been any new features added to the new persister
</I>&gt;<i> for a few months - it has been solidifying nicely. However, the diff
</I>&gt;<i> from the current default branch to the new persister branch (bug21673)
</I>&gt;<i> shows the addition of 7000 lines of code. This is the reason why it is
</I>&gt;<i> taking a long time to get through QA - not because it's buggy or faults
</I>&gt;<i> are being found, but simply because it is a lot of very complex code.
</I>&gt;<i>
</I>&gt;<i> If you do choose to use the new persister, try to ensure the following:
</I>&gt;<i> 1) Try to make sure nothing else is writing to the disk that Rabbit is
</I>&gt;<i> using - Rabbit is pretty good at managing the position of the disk head,
</I>&gt;<i> but that tends to go wrong if other applications are writing at the same
</I>&gt;<i> time.
</I>&gt;<i>
</I>
We have our instance of Rabbit running on a XenCenter vm, using shared fibre
storage. Is this going to be a problem?


&gt;<i> 2) Ensure plenty of free RAM so the OS can use it as disk cache. This
</I>&gt;<i> means a lot of reads can be satisfied without going all the way to disk.
</I>&gt;<i>
</I>We have given the vm 8 gigs at the moment.


&gt;<i> 3) You may wish to investigate different file systems - e.g. Matthias's
</I>&gt;<i> desktop, Ubuntu, using ext4, gets a pitiful 9 transactions a second,
</I>&gt;<i> where as my rather more carefully tuned debian sid system gets 500
</I>&gt;<i> txns/sec on an ext3 disk, and 1100 on an ext4 SSD. See the thread at
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://old.nabble.com/limit-number-of-messages-buffered-in-memory-in-new-persister-td27753311.html">http://old.nabble.com/limit-number-of-messages-buffered-in-memory-in-new-persister-td27753311.html</A>
</I>

We're using ext3.


&gt;<i>
</I>&gt;<i> 4) SSDs can go much faster for txns because their fsync cost is very
</I>&gt;<i> very low.
</I>&gt;<i> 5) Publishing in parallel (several producers, all issuing txns
</I>&gt;<i> individually) will get you even better performance.
</I>&gt;<i>
</I>
Will this make a difference even though we're not using transactions on the
publishing side?

Also, it seems to me that the slow throughput is on the consumer side.
Queues have no problem filling up with messages, faster than the consumers
can keep up with them.

Matthew
&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100322/3c9bfea6/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100322/3c9bfea6/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006694.html">[rabbitmq-discuss] New Persister
</A></li>
	<LI>Next message: <A HREF="006699.html">[rabbitmq-discuss] New Persister
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6696">[ date ]</a>
              <a href="thread.html#6696">[ thread ]</a>
              <a href="subject.html#6696">[ subject ]</a>
              <a href="author.html#6696">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
