<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Queue slow to come up with a lot of messages	stored on disk w/ bug21673 branch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Queue%20slow%20to%20come%20up%20with%20a%20lot%20of%20messages%0A%09stored%20on%20disk%20w/%20bug21673%20branch&In-Reply-To=20100301174956.GL1641%40mrnibble.lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006514.html">
   <LINK REL="Next"  HREF="006513.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Queue slow to come up with a lot of messages	stored on disk w/ bug21673 branch</H1>
    <B>scott w</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Queue%20slow%20to%20come%20up%20with%20a%20lot%20of%20messages%0A%09stored%20on%20disk%20w/%20bug21673%20branch&In-Reply-To=20100301174956.GL1641%40mrnibble.lshift.net"
       TITLE="[rabbitmq-discuss] Queue slow to come up with a lot of messages	stored on disk w/ bug21673 branch">scottblanc at gmail.com
       </A><BR>
    <I>Mon Mar  1 23:58:39 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006514.html">[rabbitmq-discuss] Queue slow to come up with a lot of messages stored on disk w/ bug21673 branch
</A></li>
        <LI>Next message: <A HREF="006513.html">[rabbitmq-discuss] Exposing Erlang nodes/proceses through RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6516">[ date ]</a>
              <a href="thread.html#6516">[ thread ]</a>
              <a href="subject.html#6516">[ subject ]</a>
              <a href="author.html#6516">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matthew --

Ok thanks for explaining in such detail the issue at hand. The queues aren't
supposed to normally be as big as they were so hopefully with smaller
queues, the problem will be less pronounced in the future.

thanks,
Scott

On Mon, Mar 1, 2010 at 9:49 AM, Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at lshift.net</A>&gt; wrote:

&gt;<i> Hi Scott,
</I>&gt;<i>
</I>&gt;<i> On Mon, Mar 01, 2010 at 09:35:29AM -0800, scott w wrote:
</I>&gt;<i> &gt; I've noticed the following behavior when there are a large number of
</I>&gt;<i> &gt; messages persisted to disk, e.g. &gt; 1M, and I restart rabbitmq. Initially,
</I>&gt;<i> &gt; when I list the queues using rabbitmqctl it says there are no queues.
</I>&gt;<i> Then
</I>&gt;<i> &gt; after a minute or two a couple queues begin to appear and then after
</I>&gt;<i> ~5-10
</I>&gt;<i> &gt; minutes all the queues show up. I am using branch bug21637. Is this
</I>&gt;<i> expected
</I>&gt;<i> &gt; behaviour? FWIW, I would have expected all of the queues themselves to
</I>&gt;<i> show
</I>&gt;<i> &gt; up immediately assuming that the queues and their sizes are indexed and
</I>&gt;<i> &gt; stored separately from the actual data files.
</I>&gt;<i>
</I>&gt;<i> Yes, that is expected. Firstly, although ctl will respond, the tcp
</I>&gt;<i> listeners won't be started at that point, so you are &quot;safe&quot; in the sense
</I>&gt;<i> that nothing else can come along and start creating or deleting queues.
</I>&gt;<i>
</I>&gt;<i> Secondly, what is going on is basically a pretty thorough fsck of the
</I>&gt;<i> data. I have spent a long time optimising this and basically it really
</I>&gt;<i> can't be made to go much faster - the main reason why storing &quot;clean&quot;
</I>&gt;<i> shutdown and then restoring state isn't sufficient for instant start up
</I>&gt;<i> is that on start up we have to go through the disk and delete any
</I>&gt;<i> messages that are transient (i.e. they only got pushed to disk due to
</I>&gt;<i> memory pressure). As such, we have to walk over every queue on disk.
</I>&gt;<i> This can take a long time.
</I>&gt;<i>
</I>&gt;<i> Finally, what you're suggesting would require that we write out, eg
</I>&gt;<i> queue size (and flush disk caches), on every single publish and
</I>&gt;<i> deliver/get to and from the queue. Doing such a thing would be
</I>&gt;<i> phenominally expensive.
</I>&gt;<i>
</I>&gt;<i> If it wasn't for the fact that people (and AMQP) expect queues to know
</I>&gt;<i> their own length, we could probably drop transient messages lazily.
</I>&gt;<i> However, at the end of the day, the same amount of work has to be done.
</I>&gt;<i> It's really just a matter of when it gets done.
</I>&gt;<i>
</I>&gt;<i> Matthew
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100301/aefe9a57/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100301/aefe9a57/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006514.html">[rabbitmq-discuss] Queue slow to come up with a lot of messages stored on disk w/ bug21673 branch
</A></li>
	<LI>Next message: <A HREF="006513.html">[rabbitmq-discuss] Exposing Erlang nodes/proceses through RabbitMQ
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6516">[ date ]</a>
              <a href="thread.html#6516">[ thread ]</a>
              <a href="subject.html#6516">[ subject ]</a>
              <a href="author.html#6516">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
