<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] database transaction
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20database%20transaction&In-Reply-To=27932801.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006661.html">
   <LINK REL="Next"  HREF="006671.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] database transaction</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20database%20transaction&In-Reply-To=27932801.post%40talk.nabble.com"
       TITLE="[rabbitmq-discuss] database transaction">matthew at lshift.net
       </A><BR>
    <I>Wed Mar 17 15:00:57 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006661.html">[rabbitmq-discuss]  database transaction
</A></li>
        <LI>Next message: <A HREF="006671.html">[rabbitmq-discuss] database transaction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6662">[ date ]</a>
              <a href="thread.html#6662">[ thread ]</a>
              <a href="subject.html#6662">[ subject ]</a>
              <a href="author.html#6662">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Tomek,

On Wed, Mar 17, 2010 at 07:54:10AM -0700, Tomek Rozen wrote:
&gt;<i> Let's say that I have a consumer on a single queue. Every message read from
</I>&gt;<i> the queue is stored to a database and ACKed.
</I>&gt;<i> What is the general approach to assuring that in case of failure either the
</I>&gt;<i> message is saved and ack'ed OR nothing is written to DB and the message
</I>&gt;<i> remains in the queue.
</I>
Really, you want a distributed transaction here, which can't be done.

I would suggest that you insert into the database, when you know that's
there, do the ack. That leaves you open to the possibility of receiving
the message again if the client crashes or the ack message gets lost,
thus you may need some extra logic in the client to try to detect if a
message is already in the database. If you have the possibility that you
may find, on a redelivery, that the message is not in the database
because some other process has deleted it since, then you're going to
struggle at this point!

Also note that delivery messages have a redelivered flag. If this is 0
(or false), Rabbit is guaranteeing to you that the message has not
previously been delivered (hence you can skip duplicate tests here). If
it's 1, then Rabbit is saying it *may* have been already delivered to
you before, so you should check to see whether you've already received
it.

Hope that helps,

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006661.html">[rabbitmq-discuss]  database transaction
</A></li>
	<LI>Next message: <A HREF="006671.html">[rabbitmq-discuss] database transaction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6662">[ date ]</a>
              <a href="thread.html#6662">[ thread ]</a>
              <a href="subject.html#6662">[ subject ]</a>
              <a href="author.html#6662">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
