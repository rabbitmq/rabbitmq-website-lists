<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Queue slow to come up with a lot of messages stored on disk w/ bug21673 branch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Queue%20slow%20to%20come%20up%20with%20a%20lot%20of%20messages%0A%20stored%20on%20disk%20w/%20bug21673%20branch&In-Reply-To=401b577e1003010935n23548840r9a349d4cc704b124%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006512.html">
   <LINK REL="Next"  HREF="006516.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Queue slow to come up with a lot of messages stored on disk w/ bug21673 branch</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Queue%20slow%20to%20come%20up%20with%20a%20lot%20of%20messages%0A%20stored%20on%20disk%20w/%20bug21673%20branch&In-Reply-To=401b577e1003010935n23548840r9a349d4cc704b124%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Queue slow to come up with a lot of messages stored on disk w/ bug21673 branch">matthew at lshift.net
       </A><BR>
    <I>Mon Mar  1 17:49:56 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006512.html">[rabbitmq-discuss] Queue slow to come up with a lot of messages	stored on disk w/ bug21637 branch
</A></li>
        <LI>Next message: <A HREF="006516.html">[rabbitmq-discuss] Queue slow to come up with a lot of messages	stored on disk w/ bug21673 branch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6514">[ date ]</a>
              <a href="thread.html#6514">[ thread ]</a>
              <a href="subject.html#6514">[ subject ]</a>
              <a href="author.html#6514">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Scott,

On Mon, Mar 01, 2010 at 09:35:29AM -0800, scott w wrote:
&gt;<i> I've noticed the following behavior when there are a large number of
</I>&gt;<i> messages persisted to disk, e.g. &gt; 1M, and I restart rabbitmq. Initially,
</I>&gt;<i> when I list the queues using rabbitmqctl it says there are no queues. Then
</I>&gt;<i> after a minute or two a couple queues begin to appear and then after ~5-10
</I>&gt;<i> minutes all the queues show up. I am using branch bug21637. Is this expected
</I>&gt;<i> behaviour? FWIW, I would have expected all of the queues themselves to show
</I>&gt;<i> up immediately assuming that the queues and their sizes are indexed and
</I>&gt;<i> stored separately from the actual data files.
</I>
Yes, that is expected. Firstly, although ctl will respond, the tcp
listeners won't be started at that point, so you are &quot;safe&quot; in the sense
that nothing else can come along and start creating or deleting queues.

Secondly, what is going on is basically a pretty thorough fsck of the
data. I have spent a long time optimising this and basically it really
can't be made to go much faster - the main reason why storing &quot;clean&quot;
shutdown and then restoring state isn't sufficient for instant start up
is that on start up we have to go through the disk and delete any
messages that are transient (i.e. they only got pushed to disk due to
memory pressure). As such, we have to walk over every queue on disk.
This can take a long time.

Finally, what you're suggesting would require that we write out, eg
queue size (and flush disk caches), on every single publish and
deliver/get to and from the queue. Doing such a thing would be
phenominally expensive.

If it wasn't for the fact that people (and AMQP) expect queues to know
their own length, we could probably drop transient messages lazily.
However, at the end of the day, the same amount of work has to be done.
It's really just a matter of when it gets done.

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006512.html">[rabbitmq-discuss] Queue slow to come up with a lot of messages	stored on disk w/ bug21637 branch
</A></li>
	<LI>Next message: <A HREF="006516.html">[rabbitmq-discuss] Queue slow to come up with a lot of messages	stored on disk w/ bug21673 branch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6514">[ date ]</a>
              <a href="thread.html#6514">[ thread ]</a>
              <a href="subject.html#6514">[ subject ]</a>
              <a href="author.html#6514">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
