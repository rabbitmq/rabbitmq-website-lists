<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] New Persister
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20New%20Persister&In-Reply-To=20100322125202.GD19832%40mrnibble.lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006699.html">
   <LINK REL="Next"  HREF="006723.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] New Persister</H1>
    <B>Scott Mohekey</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20New%20Persister&In-Reply-To=20100322125202.GD19832%40mrnibble.lshift.net"
       TITLE="[rabbitmq-discuss] New Persister">scott.mohekey at telogis.com
       </A><BR>
    <I>Mon Mar 22 23:50:24 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006699.html">[rabbitmq-discuss] New Persister
</A></li>
        <LI>Next message: <A HREF="006723.html">[rabbitmq-discuss] New Persister
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6702">[ date ]</a>
              <a href="thread.html#6702">[ thread ]</a>
              <a href="subject.html#6702">[ subject ]</a>
              <a href="author.html#6702">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Scott Mohekey
Systems/Application Specialist &#8211; Fleet &#8211; Telogis, Inc.
www.telogis.com  www.telogis.co.nz
+1 949 625-4115 ext. 207 (USA)  +64 3339 2825 x207 (NZ)

Leading Global Platform for Location Based Services
--
This e-mail, and any attachments, is intended only for use by the
addressee(s) named herein and may contain legally privileged and/or
confidential information.  It is the property of Telogis.  If you are not
the intended recipient of this e-mail, you are hereby notified that any
dissemination, distribution or copying of this e-mail, any attachments
thereto, and use of the information contained, is strictly prohibited.  If
you have received this e-mail in error, please notify the sender and
permanently delete the original and any copy there of.


On Tue, Mar 23, 2010 at 1:52 AM, Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at lshift.net</A>&gt; wrote:

&gt;<i> On Mon, Mar 22, 2010 at 02:29:52PM +1300, Scott Mohekey wrote:
</I>&gt;<i> &gt; On Mon, Mar 22, 2010 at 11:58 AM, Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at lshift.net</A>
</I>&gt;<i> &gt;wrote:
</I>&gt;<i> &gt; We have a single publisher, with 10 production queues which are
</I>&gt;<i> duplicated
</I>&gt;<i> &gt; for testing (so 20 queues all up). All of these queues are persistent.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We use a topic exchange, with messages being routed to one or more of the
</I>&gt;<i> &gt; queues.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The publisher uses the .net client and does no transactions, while the
</I>&gt;<i> &gt; consumer uses the java client and wraps batches of messages in
</I>&gt;<i> transactions.
</I>&gt;<i>
</I>&gt;<i> Ok, so whilst this is a little different, using the java client, I've
</I>&gt;<i> just been testing with:
</I>&gt;<i>
</I>&gt;<i> rabbitmq-java-client$ sh ./build/dist/runjava.sh
</I>&gt;<i> com.rabbitmq.examples.MulticastMain -y 0 -s 128 -e e -t fanout -r 1100 -f
</I>&gt;<i> persistent
</I>&gt;<i>
</I>&gt;<i> and
</I>&gt;<i>
</I>&gt;<i> rabbitmq-java-client$ sh build/dist/runjava.sh
</I>&gt;<i> com/rabbitmq/examples/MulticastMain -x 0 -e e -t fanout -y 10 -n 500 -q 1000
</I>&gt;<i>
</I>&gt;<i> at the same time. This simulates 10 queues, each with their own
</I>&gt;<i> consumer, every consumer sets qos to 1000 and batches up 500 acks in a
</I>&gt;<i> transaction before issuing a commit. The publisher publishes 128-byte
</I>&gt;<i> messages at a rate of 1100Hz. This means we have 1100 Hz into the
</I>&gt;<i> broker, and 11000 Hz out of the server (every publish goes to all 10
</I>&gt;<i> queues and hence consumers). My desktop machine does indeed keep up with
</I>&gt;<i> this just fine.
</I>&gt;<i>
</I>&gt;<i> The difference to yous is:
</I>&gt;<i> a) You're using topic exchange which will be a little slower.
</I>&gt;<i> b) You only have one consumer, which, I assume, is consuming from all
</I>&gt;<i> the queues concurrently?
</I>&gt;<i>
</I>
We actually have a consumer per queue, each on a different machine (all of
them a considerable distance from the rabbit server).


&gt;<i> c) My broker and clients are all on the same machine using loopback
</I>&gt;<i> interface. This is hardly &quot;geographically distant&quot; :)
</I>&gt;<i>
</I>&gt;<i> Even if I push the message size up to 4kB, it still copes (though this
</I>&gt;<i> is pushing ~100MB/s over loopback. I suspect you probably won't have
</I>&gt;<i> this much bandwidth between your consumer and broker).
</I>&gt;<i>
</I>&gt;<i> &gt; We have our instance of Rabbit running on a XenCenter vm, using shared
</I>&gt;<i> fibre
</I>&gt;<i> &gt; storage. Is this going to be a problem?
</I>&gt;<i>
</I>&gt;<i> I have no idea, but I'd be surprised if it is. You may wish to use
</I>&gt;<i> bonnie++ or similar to see what throughput you can get out of that, but
</I>&gt;<i> at least in my tests, it's just bursty up to about 20MB/s (with 4kB
</I>&gt;<i> msgs), but mainly under 1MB/s.
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; 2) Ensure plenty of free RAM so the OS can use it as disk cache. This
</I>&gt;<i> &gt; &gt; means a lot of reads can be satisfied without going all the way to
</I>&gt;<i> disk.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; We have given the vm 8 gigs at the moment.
</I>&gt;<i>
</I>&gt;<i> That's likely to be enough!
</I>&gt;<i>
</I>&gt;<i> &gt; We're using ext3.
</I>&gt;<i>
</I>&gt;<i> Ok, with data=? as the mount option. It may be worth experimenting with
</I>&gt;<i> such options just to see whether it makes much difference.
</I>&gt;<i>
</I>
We haven't played with any filesystem tuning yet.

&gt;<i>
</I>&gt;<i> &gt; &gt; 5) Publishing in parallel (several producers, all issuing txns
</I>&gt;<i> &gt; &gt; individually) will get you even better performance.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Will this make a difference even though we're not using transactions on
</I>&gt;<i> the
</I>&gt;<i> &gt; publishing side?
</I>&gt;<i>
</I>&gt;<i> No, sorry. I failed to spot in your earlier email that you're only
</I>&gt;<i> transacting on consumption, not publish.
</I>&gt;<i>
</I>&gt;<i> &gt; Also, it seems to me that the slow throughput is on the consumer side.
</I>&gt;<i> &gt; Queues have no problem filling up with messages, faster than the
</I>&gt;<i> consumers
</I>&gt;<i> &gt; can keep up with them.
</I>&gt;<i>
</I>&gt;<i> Indeed. Maybe try to work out what the latency is to your consumer given
</I>&gt;<i> the network link you have, what the throughput is, and whether the
</I>&gt;<i> messages you're sending are anywhere near that limit? Also try running
</I>&gt;<i> the above tests and see what numbers you get out of that. Finally, you
</I>&gt;<i> *may* (and I'm totally guessing here) find that you're having issues
</I>&gt;<i> with kernel auto-tuning of TCP Buffers. Are all the hosts Linux, or just
</I>&gt;<i> the broker?
</I>&gt;<i>
</I>&gt;<i> Matthew
</I>&gt;<i>
</I>

One extra thing I should mention, is that while we were seeing this low
throughput, half of the queues had an average of 100,000 queued messages.
Once we've emptied the queues out, the throughput picks up, but still not
much more than around 200 msgs/sec.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100323/ee272b14/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100323/ee272b14/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006699.html">[rabbitmq-discuss] New Persister
</A></li>
	<LI>Next message: <A HREF="006723.html">[rabbitmq-discuss] New Persister
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6702">[ date ]</a>
              <a href="thread.html#6702">[ thread ]</a>
              <a href="subject.html#6702">[ subject ]</a>
              <a href="author.html#6702">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
