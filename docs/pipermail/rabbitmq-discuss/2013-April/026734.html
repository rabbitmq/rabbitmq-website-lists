<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%203.0.4%20-%20Losing%20messages%20in%20a%20HA%20cluster&In-Reply-To=%3CCAD6m6fFcVQbEapAt%2B5krS0%3DMdBB_K0jF1i96MxWGReDhAXkGHQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026724.html">
   <LINK REL="Next"  HREF="026775.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster</H1>
    <B>Jason McIntosh</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%203.0.4%20-%20Losing%20messages%20in%20a%20HA%20cluster&In-Reply-To=%3CCAD6m6fFcVQbEapAt%2B5krS0%3DMdBB_K0jF1i96MxWGReDhAXkGHQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster">mcintoshj at gmail.com
       </A><BR>
    <I>Fri Apr 26 15:38:17 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026724.html">[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster
</A></li>
        <LI>Next message: <A HREF="026775.html">[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26734">[ date ]</a>
              <a href="thread.html#26734">[ thread ]</a>
              <a href="subject.html#26734">[ subject ]</a>
              <a href="author.html#26734">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So to confirm my understanding here.  Message 1 was synched to both queues
before I stopped the disc node.  So when I shut down the disc node, the ram
node become the &quot;master&quot;.  As such, it should have had message 1 and 2.
 When I brought up the disc node it is a slave and had it's messages
essentially reset.  Per the docs: &quot;As such, when a slave rejoins a
mirrored-queue, it throws away any durable local contents it already has
and starts empty.&quot;.  So when I now publish message 2, that goes to the ram
node, which is now the master, and we have 2 messages total (disc node
still off).

The question becomes then - is there any way to recover the messages the
RAM node had if the disc node comes back and the ram node subsequently
failed?  Granted this is an unlikely situation, but I'm trying to plan for
recover scenarios here :)  Do I need to remove the HA policy, then bring up
the RAM node to get the RAM node messages (since it was master prior to
it's restart)?  Since I can't shut off the disc node in this case, just
trying to figure out how to recover.  I can see taking this a step further
- if I had 3 nodes in a cluster, and 1 node went down, but the other 2
nodes each got an even distribution of the queues... hrmm, would make it
somewhat interesting to recover.  I'd almost have to shutdown yet one more
node, start up the original node, make sure that messages get consumed,
then start the third node it sounds like.

I've started testing on the new 3.1 nightly  - I'm hoping it makes this a
lot cleaner!
Thanks!
Jason


On Fri, Apr 26, 2013 at 3:44 AM, Emile Joubert &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">emile at rabbitmq.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hi Jason,
</I>&gt;<i>
</I>&gt;<i> On 25/04/13 21:09, Jason McIntosh wrote:
</I>&gt;<i> &gt; I have 2 nodes in an rabbit cluster, one disc, one ram node.  I'm seeing
</I>&gt;<i> &gt; messages get lost
</I>&gt;<i>
</I>&gt;<i> The explanation can be found here:
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/ha.html#behaviour">http://www.rabbitmq.com/ha.html#behaviour</A>
</I>&gt;<i>
</I>&gt;<i>  &quot;should there be no slave that is synchronised with the master,
</I>&gt;<i>   messages that only the master held will be lost.&quot;
</I>&gt;<i>
</I>&gt;<i> Messages can get lost if you recycle nodes in the cluster faster than it
</I>&gt;<i> takes for the queue contents to be replaced entirely with new messages.
</I>&gt;<i> The solution is to wait for slaves to become synchronised before
</I>&gt;<i> restarting each node.
</I>&gt;<i>
</I>&gt;<i> The next version of RabbitMQ will feature manual eager synchronisation
</I>&gt;<i> which will allow slaves to catch up on old messages held only on the
</I>&gt;<i> master node. You can obtain this feature now by installing a nightly
</I>&gt;<i> build of the broker, or wait for the next release.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -Emile
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Jason McIntosh
<A HREF="http://mcintosh.poetshome.com/blog/">http://mcintosh.poetshome.com/blog/</A>
573-424-7612
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130426/39c9c98e/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130426/39c9c98e/attachment.htm</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026724.html">[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster
</A></li>
	<LI>Next message: <A HREF="026775.html">[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26734">[ date ]</a>
              <a href="thread.html#26734">[ thread ]</a>
              <a href="subject.html#26734">[ subject ]</a>
              <a href="author.html#26734">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
