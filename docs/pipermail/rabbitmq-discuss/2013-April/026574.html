<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ Queues memory leak?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Queues%20memory%20leak%3F&In-Reply-To=%3CCAHWt7w3%2BQ6vY7Oex0Aa16sL26trOiXJgEp18iHu5WYpR7VQvdQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026562.html">
   <LINK REL="Next"  HREF="026589.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ Queues memory leak?</H1>
    <B>Dmitry Saprykin</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Queues%20memory%20leak%3F&In-Reply-To=%3CCAHWt7w3%2BQ6vY7Oex0Aa16sL26trOiXJgEp18iHu5WYpR7VQvdQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ Queues memory leak?">saprykin.dmitry at gmail.com
       </A><BR>
    <I>Fri Apr 19 10:23:55 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026562.html">[rabbitmq-discuss] RabbitMQ Queues memory leak?
</A></li>
        <LI>Next message: <A HREF="026589.html">[rabbitmq-discuss] RabbitMQ Queues memory leak?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26574">[ date ]</a>
              <a href="thread.html#26574">[ thread ]</a>
              <a href="subject.html#26574">[ subject ]</a>
              <a href="author.html#26574">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, Emile

Thank you very much for you help. I will try to provide anything what can
help to solve this issue.


&gt;<i> The difference between 1Mb and 180Mb is relatively large, even after
</I>&gt;<i> taking expected differences due to garbage collection into account. We
</I>&gt;<i> can't rule out a memory leak, but need some assistance from you to confirm.
</I>&gt;<i>
</I>&gt;<i> Do you see the same asymmetry if the master node for the queues switch
</I>&gt;<i> from one node to the other? So if you shut the cdaemon2 node, let
</I>&gt;<i> cdaemon4 become the master for all the queue, turn cdaemon2 back on (it
</I>&gt;<i> will now be a slave node) does the memory on cdaemon2 now grow?
</I>&gt;<i>
</I>
Yes, after current master stops and starts it becomes slave and its memory
starts to grow.
Meantime new selected master memory does not become free. So new master
memory stops to
grow but do not fall back to normal. I have attached memory graphs of our
nodes to this letter.


&gt;<i>
</I>&gt;<i> Have you been able to add a third node to the cluster for testing
</I>&gt;<i> purposes to see if memory grows on more than one slave node?
</I>&gt;<i>
</I>
We have not tied to do this yet. But if it can help we can allocate one
more node.
Is is ok to create test node at the same physical host as one of existing
nodes?


&gt;<i>
</I>&gt;<i> How long does it take for the memory use to reach the VM memory high
</I>&gt;<i> watermark?
</I>&gt;<i>
</I>
Critical point for our cluster comes much more earlier than VM memory high
watermark.
The same time with memory grow slave node starts to use CPU more and more
active.
In our case when memory consumption reaches ~1Gb broker stops to respond.

After slave restart memory grows linearily some time. After that memory
grow changes its pattern.
At some moments it increases by constant step (~20Mb). I have marked these
steps on graphs attached.


&gt;<i> Can you describe your messaging pattern in a bit more detail for us to
</I>&gt;<i> reproduce the problem - how often are new channels created when publishing?
</I>&gt;<i>
</I>
Queues and exchanges:

1 queue and 1 exchange (Durable, ha-mode: all, no autodelete).

Publishers:

We have about 100 web servers which publish messages by next steps:
1) Open connection
2) Create channel
3) Publish message to direct exchange
4) close connection
Publishing rate is between 50 and 600 messages per second at peak hours.
I have attached graph.

Consumers:

We have 3 servers consuming messages in 30 threads each.
Each consuming thread
1) Thread starts
2) Open broker connection
3) Create channel
4) Get message from the queue by basic-get with prefetch=1
5) Process message and acknowledge it.
6) If there are no new messages sleep some time
7) repeat steps 4,5,6 until limit count is reached
8) Close connection
9) Thread stops


&gt;<i>
</I>&gt;<i> In order to investigate further it might be helpful to execute some
</I>&gt;<i> diagnostic commands on the broker. Are you able to replicate the problem
</I>&gt;<i> in a staging or QA environment where it is safe to do this?
</I>&gt;<i>
</I>
I will execute diagnostic commands on the broker. If something goes wrong
our messaging
falls back to version without rabbitMQ involved ).


&gt;<i> -Emile
</I>&gt;<i>
</I>&gt;<i>
</I>Kind regards,
Dmitry Saprykin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130419/f5a2a732/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130419/f5a2a732/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cdaemon2.memory.png
Type: image/png
Size: 37015 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130419/f5a2a732/attachment.png">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130419/f5a2a732/attachment.png</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cdaemon4.memory.png
Type: image/png
Size: 43829 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130419/f5a2a732/attachment-0001.png">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130419/f5a2a732/attachment-0001.png</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: message.publishing.png
Type: image/png
Size: 73012 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130419/f5a2a732/attachment-0002.png">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130419/f5a2a732/attachment-0002.png</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026562.html">[rabbitmq-discuss] RabbitMQ Queues memory leak?
</A></li>
	<LI>Next message: <A HREF="026589.html">[rabbitmq-discuss] RabbitMQ Queues memory leak?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26574">[ date ]</a>
              <a href="thread.html#26574">[ thread ]</a>
              <a href="subject.html#26574">[ subject ]</a>
              <a href="author.html#26574">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
