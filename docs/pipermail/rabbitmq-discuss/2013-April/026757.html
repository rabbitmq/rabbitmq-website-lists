<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] how to call a model from rabbitmq php consumer's callback in codeigniter?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20how%20to%20call%20a%20model%20from%20rabbitmq%20php%0A%20consumer%27s%20callback%20in%20codeigniter%3F&In-Reply-To=%3CCAMcAHLWHJXHCrFgPn59zAroZQ%3DpZ5Pe5db90H8vH1kkfsGHyxg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026693.html">
   <LINK REL="Next"  HREF="026694.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] how to call a model from rabbitmq php consumer's callback in codeigniter?</H1>
    <B>Alvaro Videla</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20how%20to%20call%20a%20model%20from%20rabbitmq%20php%0A%20consumer%27s%20callback%20in%20codeigniter%3F&In-Reply-To=%3CCAMcAHLWHJXHCrFgPn59zAroZQ%3DpZ5Pe5db90H8vH1kkfsGHyxg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] how to call a model from rabbitmq php consumer's callback in codeigniter?">videlalvaro at gmail.com
       </A><BR>
    <I>Mon Apr 29 15:46:18 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026693.html">[rabbitmq-discuss] how to call a model from rabbitmq php consumer's callback in codeigniter?
</A></li>
        <LI>Next message: <A HREF="026694.html">[rabbitmq-discuss] Help us test RabbitMQ 3.1.0!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26757">[ date ]</a>
              <a href="thread.html#26757">[ thread ]</a>
              <a href="subject.html#26757">[ subject ]</a>
              <a href="author.html#26757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

The code for register_shutdown_function is used to call a function when PHP
is shutting down. For example if you want to do some resources clean up
(like closing database connections and so on), you could do it there.

If inside that shutdown function you need to call methods in the
controller, that is, your $this object, then you need to pass it as an
extra argument, as explained here:
<A HREF="http://php.net/manual/en/function.register-shutdown-function.php">http://php.net/manual/en/function.register-shutdown-function.php</A>

On the other hand if you need to pass more arguments to the RabbitMQ
callback, the one that you use in your basic_consume function, the you need
to pass them to the callback function there, for example by using the 'use'
keyword as explained here: <A HREF="http://php.net/manual/en/functions.anonymous.php">http://php.net/manual/en/functions.anonymous.php</A>

Besides that I recommend you to refactor that consumer code out of the
controller into a consumer class or something similar. Keep in mind to
always keep thin controllers.

Also if your consumer callbacks need to use a lot of extra arguments, maybe
is better to create a class for them, instantiate an object and pass the
data inside via the constructor for example.

Regarding MySQL going away, you probably need to search in a php-mysql
forum to see how to solve that MySQL timeout. You could either increase the
timeout value in the server conf, issue a simple query every now and then
to keep the connection alive or implement a reconnection strategy, for
example by catching an exception.

Regards,

Alvaro


On Thu, Apr 25, 2013 at 8:30 AM, Seshachalam Malisetti &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">abbiya at gmail.com</A>&gt;wrote:

&gt;<i> I developed an android app where it subscribes to a queue and also
</I>&gt;<i> publishes to other queues. At a time it publishes the same message to two
</I>&gt;<i> different queues, one of them is a queue named &quot;Queue&quot; and now from a
</I>&gt;<i> appfog instance i need to subscribe to the &quot;Queue&quot; and consume messages and
</I>&gt;<i> insert them in a mysql db.
</I>&gt;<i>
</I>&gt;<i> I created a php standalone app for the above purpose with codeigniter. By
</I>&gt;<i> some reason the worker app loses its connection to rabbitmq. i would like
</I>&gt;<i> to know the best way to do this. How can a worker app on appfog can sustain
</I>&gt;<i> the application restarts.
</I>&gt;<i>
</I>&gt;<i> what of kind of thing i need to use to solve the above problem.
</I>&gt;<i>
</I>&gt;<i> I figured that the problem is not with rabbitmq connection. it is with the
</I>&gt;<i> code related to mysql inserts. i checked the crash logs of my app and the
</I>&gt;<i> error is &quot;Mysql gone away&quot;. an example of php rabbitmq consumer has call
</I>&gt;<i> backs for receive message and register_shutdown. in receive call back i can
</I>&gt;<i> not use $this of code igniter because its out of scope and i was using
</I>&gt;<i> get_instance(). i am not sure how to call a method from rabbitmq client
</I>&gt;<i> receive call back function
</I>&gt;<i>
</I>&gt;<i> The controller is
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &lt;?php
</I>&gt;<i> if (!defined('BASEPATH'))
</I>&gt;<i>   exit('No direct script access allowed');
</I>&gt;<i>
</I>&gt;<i> include(__DIR__ . '/php-amqplib/config.php');
</I>&gt;<i> use PhpAmqpLib\Connection\AMQPConnection;
</I>&gt;<i> class Welcome extends CI_Controller {
</I>&gt;<i> public function __construct() {
</I>&gt;<i>     parent::__construct();}
</I>&gt;<i> public function index() {
</I>&gt;<i>     //connect to rabbitmq and consume messages
</I>&gt;<i>     //insert messages to mysql
</I>&gt;<i>     //$this-&gt;messages = array();
</I>&gt;<i>     $exchange = &quot;router&quot;;
</I>&gt;<i>     $queue = &quot;abbiya&quot;;
</I>&gt;<i>
</I>&gt;<i>     $conn = new AMQPConnection(HOST, PORT, USER, PASS, VHOST);
</I>&gt;<i>     $ch = $conn-&gt;channel();
</I>&gt;<i>
</I>&gt;<i>     /*
</I>&gt;<i>       name: $queue
</I>&gt;<i>       passive: false
</I>&gt;<i>       durable: true // the queue will survive server restarts
</I>&gt;<i>       exclusive: false // the queue can be accessed in other channels
</I>&gt;<i>       auto_delete: false //the queue won't be deleted once the channel is closed.
</I>&gt;<i>      */
</I>&gt;<i>     $ch-&gt;queue_declare($queue, false, true, false, false);
</I>&gt;<i>
</I>&gt;<i>     $ch-&gt;queue_bind($queue, $exchange, $queue);
</I>&gt;<i>
</I>&gt;<i>     /*
</I>&gt;<i>       queue: Queue from where to get the messages
</I>&gt;<i>       consumer_tag: Consumer identifier
</I>&gt;<i>       no_local: Don't receive messages published by this consumer.
</I>&gt;<i>       no_ack: Tells the server if the consumer will acknowledge the messages.
</I>&gt;<i>       exclusive: Request exclusive consumer access, meaning only this consumer can access the queue
</I>&gt;<i>       nowait:
</I>&gt;<i>       callback: A PHP Callback
</I>&gt;<i>      */
</I>&gt;<i>     $consumer_tag = &quot;abbiya&quot;;
</I>&gt;<i>
</I>&gt;<i>     $ch-&gt;basic_recover(true);
</I>&gt;<i>     $ch-&gt;basic_consume($queue, $consumer_tag, false, false, false, false, function($msg) {
</I>&gt;<i>                 $message_body = json_decode($msg-&gt;body);
</I>&gt;<i>                 $msg-&gt;delivery_info['channel']-&gt;
</I>&gt;<i>                         basic_ack($msg-&gt;delivery_info['delivery_tag']);
</I>&gt;<i>
</I>&gt;<i>                 // Send a message with the string &quot;quit&quot; to cancel the consumer.
</I>&gt;<i>                 if ($msg-&gt;body === 'quit') {
</I>&gt;<i>                     $msg-&gt;delivery_info['channel']-&gt;
</I>&gt;<i>                             basic_cancel($msg-&gt;delivery_info['consumer_tag']);
</I>&gt;<i>                 }
</I>&gt;<i>                 $data = array(
</I>&gt;<i>                     'sender_id' =&gt; $message_body-&gt;r,
</I>&gt;<i>                     'receiver_id' =&gt; $message_body-&gt;s,
</I>&gt;<i>                     'message_content' =&gt; $message_body-&gt;m,
</I>&gt;<i>                     // 'sent_time' =&gt; $message_body-&gt;t,
</I>&gt;<i>                     'status' =&gt; 0
</I>&gt;<i>                 );
</I>&gt;<i>                 $ci =&amp; get_instance();
</I>&gt;<i>                 $ci-&gt;Message_model-&gt;newMessage($data);
</I>&gt;<i>             }
</I>&gt;<i>     );
</I>&gt;<i>
</I>&gt;<i>     // Loop as long as the channel has callbacks registered
</I>&gt;<i>     while (count($ch-&gt;callbacks)) {
</I>&gt;<i>         $ch-&gt;wait();
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     register_shutdown_function(function() use ($ch, $conn) {
</I>&gt;<i>                 $ch-&gt;close();
</I>&gt;<i>                 $conn-&gt;close();
</I>&gt;<i>                 $this-&gt;index();
</I>&gt;<i>             }
</I>&gt;<i>     );}
</I>&gt;<i> }
</I>&gt;<i> /* End of file welcome.php *//* Location: ./application/controllers/welcome.php */
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130429/c08995e1/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130429/c08995e1/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026693.html">[rabbitmq-discuss] how to call a model from rabbitmq php consumer's callback in codeigniter?
</A></li>
	<LI>Next message: <A HREF="026694.html">[rabbitmq-discuss] Help us test RabbitMQ 3.1.0!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26757">[ date ]</a>
              <a href="thread.html#26757">[ thread ]</a>
              <a href="subject.html#26757">[ subject ]</a>
              <a href="author.html#26757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
