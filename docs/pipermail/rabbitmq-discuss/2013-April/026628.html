<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] .NET Client ConnectionFactory threading	issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.NET%20Client%20ConnectionFactory%20threading%0A%09issues&In-Reply-To=%3C7e9335d5-d38f-4eb9-91aa-28e3ecf0ab7b%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026593.html">
   <LINK REL="Next"  HREF="026764.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] .NET Client ConnectionFactory threading	issues</H1>
    <B>Chris Haines</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20.NET%20Client%20ConnectionFactory%20threading%0A%09issues&In-Reply-To=%3C7e9335d5-d38f-4eb9-91aa-28e3ecf0ab7b%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] .NET Client ConnectionFactory threading	issues">cjbhaines at gmail.com
       </A><BR>
    <I>Mon Apr 22 17:07:57 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026593.html">[rabbitmq-discuss] .NET Client ConnectionFactory threading	issues
</A></li>
        <LI>Next message: <A HREF="026764.html">[rabbitmq-discuss] .NET Client ConnectionFactory threading	issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26628">[ date ]</a>
              <a href="thread.html#26628">[ thread ]</a>
              <a href="subject.html#26628">[ subject ]</a>
              <a href="author.html#26628">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Michal,

I tried running this against 2 different machines as well. Against a server 
2.8.7 hosted on linux and a server 3.0.4 hosted on server 2008. 

The reason we want to do this is because we have a highly concurrent 
application serving around 300-600 threads each with its own consumer and a 
set of publishers. We were seeing poor throughput over one connection and I 
did some tests which show higher data throughput when using a larger number 
of connections. The only problem we seem to have with it is with the 
concurrent usage of the ConnectionFactory. I have gotten around this for 
now by creating all of the connections on the startup thread and after that 
the connections are shared between all of the threads and we see better 
performance. The broker seems to cope fine with about 1250 connections 
(running several instances of our server application).

I have asked my colleagues to run this as well and they are seeing the same 
symptoms. We are all running Win7 64 as well.

Cheers,
Chris 

On Saturday, 20 April 2013 05:20:04 UTC+1, Michal Lev&#253; wrote:
&gt;<i>
</I>&gt;<i> Hey
</I>&gt;<i>
</I>&gt;<i> All your tests run just fine on my machine (Win7 64)
</I>&gt;<i> CanCreateConnectionsMultiThreaded: Elapsed seconds: 2,9939693
</I>&gt;<i> CanCreateConnectionsMultiThreadedWithLock: Elapsed seconds: 4,3135879
</I>&gt;<i>
</I>&gt;<i> Two difference here:
</I>&gt;<i> - im connecting to remote RabbitMQ running on Debian (not localhost)
</I>&gt;<i> - my client\server version is 3.0.2
</I>&gt;<i>
</I>&gt;<i> Here are few things to consider.
</I>&gt;<i> 1) You are connecting to localhost. Each Rabbit connection opens 3 sockets 
</I>&gt;<i> (2 for heartbeats). With 100 connections, its minimum 300 + 300 sockets 
</I>&gt;<i> trying to open at the same time. Maybe your Win host cant handle it ?
</I>&gt;<i> 2) Why are you trying to open 100 connection from one machine anyway ? Its 
</I>&gt;<i> real wasting of resources. Do you know, you can run multiple independent 
</I>&gt;<i> Rabbit channels on single connection ?
</I>&gt;<i>
</I>&gt;<i> Michal
</I>&gt;<i>
</I>&gt;<i> On Thursday, April 18, 2013 1:37:40 PM UTC+2, Chris Haines wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi All,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have attached a .cs Nunit test fixture to demonstrate a problem I am 
</I>&gt;&gt;<i> having with the ConnectionFactory. If I create 100 connections in a for 
</I>&gt;&gt;<i> loop single threaded then I can create them all in about 2 seconds. If I 
</I>&gt;&gt;<i> create them via a number of threads, in my test I am using 100 threads to 
</I>&gt;&gt;<i> create a connection on each, then I get a lot of timeout exceptions (my 
</I>&gt;&gt;<i> test bails out after 60 seconds). I have tried sharing an instance of the 
</I>&gt;&gt;<i> ConnectionFactory between all threads and also giving each thread its own 
</I>&gt;&gt;<i> instance but they both have the same result. I have also tried locking 
</I>&gt;&gt;<i> around the call to CreateConnection but that also didn't help. 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I find this behavior to be very strange. Has anyone else had similar 
</I>&gt;&gt;<i> problems?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i> Chris
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130422/bbc66d36/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130422/bbc66d36/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026593.html">[rabbitmq-discuss] .NET Client ConnectionFactory threading	issues
</A></li>
	<LI>Next message: <A HREF="026764.html">[rabbitmq-discuss] .NET Client ConnectionFactory threading	issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26628">[ date ]</a>
              <a href="thread.html#26628">[ thread ]</a>
              <a href="subject.html#26628">[ subject ]</a>
              <a href="author.html#26628">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
