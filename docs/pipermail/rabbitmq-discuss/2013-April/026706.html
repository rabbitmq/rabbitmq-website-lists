<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] ConnectionFactory.newConnection(Address[] addrs) is very slow
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20ConnectionFactory.newConnection%28Address%5B%5D%0A%20addrs%29%20is%20very%20slow&In-Reply-To=%3C5179308D.7030800%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026658.html">
   <LINK REL="Next"  HREF="026665.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] ConnectionFactory.newConnection(Address[] addrs) is very slow</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20ConnectionFactory.newConnection%28Address%5B%5D%0A%20addrs%29%20is%20very%20slow&In-Reply-To=%3C5179308D.7030800%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] ConnectionFactory.newConnection(Address[] addrs) is very slow">simon at rabbitmq.com
       </A><BR>
    <I>Thu Apr 25 14:33:01 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026658.html">[rabbitmq-discuss] ConnectionFactory.newConnection(Address[] addrs)	is very slow
</A></li>
        <LI>Next message: <A HREF="026665.html">[rabbitmq-discuss] memory usage reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26706">[ date ]</a>
              <a href="thread.html#26706">[ thread ]</a>
              <a href="subject.html#26706">[ subject ]</a>
              <a href="author.html#26706">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I note that your connection is stuck in java.net.Socket.connect(). I 
assume that this means there is some local network issue which is 
causing attempts to connect to the stopped node to take a long time to 
time out.

As far as I can see you're using newConnection(Address[]) correctly, but 
you may have a network problem. (a badly implemented firewall maybe?)

Cheers, Simon

On 23/04/13 17:16, hwang wrote:
&gt;<i> Recently I begin to use rabbitMQ, but encounter a strange problem. I use
</I>&gt;<i> the method newConnection(Address[] addrs) of class ConnectionFactory
</I>&gt;<i> when I initial the connection, because the document said that this
</I>&gt;<i> method will pick up one available address automatically. The code looks
</I>&gt;<i> like below in function setup():
</I>&gt;<i>
</I>&gt;<i> |String[] mqAddrArr = new String[] {
</I>&gt;<i>      &quot;node1:5672&quot;, &quot;node2:5672&quot;
</I>&gt;<i> };
</I>&gt;<i> connection = connectionFactory.newConnection(mqAddrArr);
</I>&gt;<i> |
</I>&gt;<i>
</I>&gt;<i> In my code, if encounter a ShutdownSignalException, I will catch it and
</I>&gt;<i> re-connect(using the same setup() method).
</I>&gt;<i>
</I>&gt;<i> When I start the application, this newConnection(mqAddrArr) run
</I>&gt;<i> normally. As I run &quot;rabbitmqctl stop&quot; on node1, the program can catch
</I>&gt;<i> the ShutdownSignalException rightly and run setup() to re-connect.
</I>&gt;<i>
</I>&gt;<i> But this time, the newConnection(mqAddrArr) is very slow, maybe about
</I>&gt;<i> 2-3 minutes to re-connect succeed.
</I>&gt;<i>
</I>&gt;<i> I'm wondering if this is the right performance of method
</I>&gt;<i> newConnection(Address[] addrs), or maybe there is some parameter I can
</I>&gt;<i> set to control the re-connect time?
</I>&gt;<i>
</I>&gt;<i> When the newConnection method halt, I get some jstack information in the
</I>&gt;<i> last, maybe helpful.
</I>&gt;<i>
</I>&gt;<i> Thanks.
</I>&gt;<i>
</I>&gt;<i> |&quot;Finalizer&quot; daemon prio=10 tid=0x09f44400 nid=0x3e70 in Object.wait() [0x7c51c000]
</I>&gt;<i>     java.lang.Thread.State: WAITING (on object monitor)
</I>&gt;<i>      at java.lang.Object.wait(Native Method)
</I>&gt;<i>      - waiting on &lt;0xa522f340&gt; (a java.lang.ref.ReferenceQueue$Lock)
</I>&gt;<i>      at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:133)
</I>&gt;<i>      - locked &lt;0xa522f340&gt; (a java.lang.ref.ReferenceQueue$Lock)
</I>&gt;<i>      at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:149)
</I>&gt;<i>      at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:177)
</I>&gt;<i>
</I>&gt;<i> &quot;Reference Handler&quot; daemon prio=10 tid=0x09f3f800 nid=0x3e6f in Object.wait() [0x7c56d000]
</I>&gt;<i>     java.lang.Thread.State: WAITING (on object monitor)
</I>&gt;<i>      at java.lang.Object.wait(Native Method)
</I>&gt;<i>      - waiting on &lt;0xa522ef10&gt; (a java.lang.ref.Reference$Lock)
</I>&gt;<i>      at java.lang.Object.wait(Object.java:502)
</I>&gt;<i>      at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:133)
</I>&gt;<i>      - locked &lt;0xa522ef10&gt; (a java.lang.ref.Reference$Lock)
</I>&gt;<i>
</I>&gt;<i> &quot;main&quot; prio=10 tid=0x09e94000 nid=0x3e68 runnable [0xb776a000]
</I>&gt;<i>     java.lang.Thread.State: RUNNABLE
</I>&gt;<i>      at java.net.PlainSocketImpl.socketConnect(Native Method)
</I>&gt;<i>      at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:327)
</I>&gt;<i>      - locked &lt;0xa470f390&gt; (a java.net.SocksSocketImpl)
</I>&gt;<i>      at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:193)
</I>&gt;<i>      at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:180)
</I>&gt;<i>      at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:384)
</I>&gt;<i>      at java.net.Socket.connect(Socket.java:546)
</I>&gt;<i>      at com.rabbitmq.client.ConnectionFactory.createFrameHandler(ConnectionFactory.java:445)
</I>&gt;<i>      at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:504)
</I>&gt;<i>      at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:488)
</I>&gt;<i>      at com.wandoujia.storage.rabbitmq.RabbitMQReceiver.setup(RabbitMQReceiver.java:114)
</I>&gt;<i>      at com.wandoujia.storage.rabbitmq.RabbitMQReceiver.reconnect(RabbitMQReceiver.java:105)
</I>&gt;<i>      at com.wandoujia.storage.rabbitmq.RabbitMQReceiver.ack(RabbitMQReceiver.java:141)
</I>&gt;<i>      at com.wandoujia.storage.rabbitmq.testMQReceiver.test(testMQReceiver.java:21)
</I>&gt;<i>      at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
</I>&gt;<i>      at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
</I>&gt;<i>      at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
</I>&gt;<i>      at java.lang.reflect.Method.invoke(Method.java:616)
</I>&gt;<i>      at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
</I>&gt;<i>      at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
</I>&gt;<i>      at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
</I>&gt;<i>      at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
</I>&gt;<i>      at org.junit.runners.BlockJUnit4ClassRunner.runNotIgnored(BlockJUnit4ClassRunner.java:79)
</I>&gt;<i>      at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:71)
</I>&gt;<i>      at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:49)
</I>&gt;<i>      at org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)
</I>&gt;<i>      at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)
</I>&gt;<i>      at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)
</I>&gt;<i>      at org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)
</I>&gt;<i>      at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)
</I>&gt;<i>      at org.junit.runners.ParentRunner.run(ParentRunner.java:236)
</I>&gt;<i>      at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:50)
</I>&gt;<i>      at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)
</I>&gt;<i>      at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:467)
</I>&gt;<i>      at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:683)
</I>&gt;<i>      at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:390)
</I>&gt;<i>      at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:197)|
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026658.html">[rabbitmq-discuss] ConnectionFactory.newConnection(Address[] addrs)	is very slow
</A></li>
	<LI>Next message: <A HREF="026665.html">[rabbitmq-discuss] memory usage reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26706">[ date ]</a>
              <a href="thread.html#26706">[ thread ]</a>
              <a href="subject.html#26706">[ subject ]</a>
              <a href="author.html#26706">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
