<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Growing Memory Use and Queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Growing%20Memory%20Use%20and%20Queues&In-Reply-To=%3Cee8bca94-b015-4928-a1f3-7e258da28207%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026622.html">
   <LINK REL="Next"  HREF="026518.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Growing Memory Use and Queues</H1>
    <B>Ilya Volodarsky</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Growing%20Memory%20Use%20and%20Queues&In-Reply-To=%3Cee8bca94-b015-4928-a1f3-7e258da28207%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Growing Memory Use and Queues">ilya at segment.io
       </A><BR>
    <I>Tue Apr 16 17:53:06 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026622.html">[rabbitmq-discuss] RabbitMQ with many queues
</A></li>
        <LI>Next message: <A HREF="026518.html">[rabbitmq-discuss] Growing Memory Use and Queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26514">[ date ]</a>
              <a href="thread.html#26514">[ thread ]</a>
              <a href="subject.html#26514">[ subject ]</a>
              <a href="author.html#26514">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We're having some strange memory problems in our rabbit that looks like 
it's attributed to our queues. We're running Rabbit 3.0.1 in production, 
here's the management plugin overview: <A HREF="http://cl.ly/image/0z25241k320Q">http://cl.ly/image/0z25241k320Q</A>

As you can see, we have almost no messages queued, but the server is using 
5.7GB of active memory. Here's the memory breakdown of the same node: 
<A HREF="http://cl.ly/image/03381l2M3v2p">http://cl.ly/image/03381l2M3v2p</A>

The broker claims to be using 4.8 GB to store the 4454 queues. That's 
strange because most of the queues claim to be using 14kb - 23kb, which 
AFAIK, is the in the correct range for an idle queue. An average of 20kb 
per queue * 4500 queues = 90 MB, not 4800 MB (53 times bigger). 

Here's the JSON description of a queue from the /queues call:

{&quot;memory&quot;:14624,&quot;idle_since&quot;:&quot;2013-04-15 
22:45:20&quot;,&quot;policy&quot;:&quot;&quot;,&quot;exclusive_consumer_tag&quot;:&quot;&quot;,&quot;messages_ready&quot;:0,&quot;messages_unacknowledged&quot;:0,&quot;messages&quot;:0,&quot;consumers&quot;:4,&quot;active_consumers&quot;:4,&quot;backing_queue_status&quot;:{&quot;q1&quot;:0,&quot;q2&quot;:0,&quot;delta&quot;:[&quot;delta&quot;,&quot;undefined&quot;,0,&quot;undefined&quot;],&quot;q3&quot;:0,&quot;q4&quot;:0,&quot;len&quot;:0,&quot;pending_acks&quot;:0,&quot;target_ram_count&quot;:0,&quot;ram_msg_count&quot;:0,&quot;ram_ack_count&quot;:0,&quot;next_seq_id&quot;:0,&quot;persistent_count&quot;:0,&quot;avg_ingress_rate&quot;:0.0,&quot;avg_egress_rate&quot;:0.0,&quot;avg_ack_ingress_rate&quot;:0.0,&quot;avg_ack_egress_rate&quot;:0.0},&quot;messages_details&quot;:{&quot;rate&quot;:0,&quot;interval&quot;:90165823981,&quot;last_event&quot;:1366065920939},&quot;messages_ready_details&quot;:{&quot;rate&quot;:0,&quot;interval&quot;:90165823981,&quot;last_event&quot;:1366065920939},&quot;messages_unacknowledged_details&quot;:{&quot;rate&quot;:0,&quot;interval&quot;:90165823981,&quot;last_event&quot;:1366065920939},&quot;name&quot;:&quot;Ingestion.1899vw88el&quot;,&quot;vhost&quot;:&quot;/segment&quot;,&quot;durable&quot;:true,&quot;auto_delete&quot;:false,&quot;arguments&quot;:{},&quot;node&quot;:&quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at rabbit2</A>&quot;}

A few things to note: we have 4 servers subscribing to every queue, and 
because of the RMQ client (node-amqp) we're using, it creates a channel per 
subscription. I realize that's not ideal and we'll be fixing the client to 
make multiple subscriptions per channel, but either way, the broker reports 
only 350 MB of the memory use coming from the connections vs. 4.8 GB for 
queues. 

The broker has also been up for 76 days without downtime, so maybe there's 
some kind of memory leak? We're seeing the memory go up over time. 

Thanks!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130416/99e2cc54/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130416/99e2cc54/attachment.htm</A>&gt;
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026622.html">[rabbitmq-discuss] RabbitMQ with many queues
</A></li>
	<LI>Next message: <A HREF="026518.html">[rabbitmq-discuss] Growing Memory Use and Queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26514">[ date ]</a>
              <a href="thread.html#26514">[ thread ]</a>
              <a href="subject.html#26514">[ subject ]</a>
              <a href="author.html#26514">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
