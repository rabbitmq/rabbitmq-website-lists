<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ AMQP :- Socket error: Broken pipe on	high load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20AMQP%20%3A-%20Socket%20error%3A%20Broken%20pipe%20on%0A%09high%20load&In-Reply-To=%3C28b773c7-2884-4283-94aa-bd6ef116175e%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026397.html">
   <LINK REL="Next"  HREF="026391.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ AMQP :- Socket error: Broken pipe on	high load</H1>
    <B>dharmanshu at ophio.co.in</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20AMQP%20%3A-%20Socket%20error%3A%20Broken%20pipe%20on%0A%09high%20load&In-Reply-To=%3C28b773c7-2884-4283-94aa-bd6ef116175e%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ AMQP :- Socket error: Broken pipe on	high load">dharmanshu at ophio.co.in
       </A><BR>
    <I>Sun Apr  7 15:20:54 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026397.html">[rabbitmq-discuss] Query regarding architecture including	rabbiMQ
</A></li>
        <LI>Next message: <A HREF="026391.html">[rabbitmq-discuss] RabbitMQ AMQP :- Socket error: Broken pipe on high load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26390">[ date ]</a>
              <a href="thread.html#26390">[ thread ]</a>
              <a href="subject.html#26390">[ subject ]</a>
              <a href="author.html#26390">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey , 
So i am running rabbitmq 3.02 on Ubuntu 12.04. Using PECL AMQP client. 
Using 1 queue, 35 consumers. The consumer fetches an xml object and saves 
it to the  db.

And 1 reader that publishes messages using a for loop.

After publishing around 120,000 messages , the reader gives out the 
following error on publish.
 
Socket error: Broken pipe.

The reader process then needs to be killed manually and the broker needs to 
be restarted. 
Any idea how to handle this ?

Message Queue class

class AppMessageQueue {
    
    public function __construct() {
$this-&gt;_createNewConnectionAndChannel();
    }
    
    public function __destruct() {
    if ($this-&gt;conn) {
        $this-&gt;conn-&gt;disconnect();
    }
    }
    
public function purge($queue) {
$this-&gt;ch-&gt;queue_purge($queue);
}
    public function startConsuming(Parsable $parser) {
        $this-&gt;messageParser = $parser;
        //$ch-&gt;basic_consume(queue, consumer_tag, no_local, no_ack, 
exclusive, nowait, callback);
$this-&gt;queue = new AMQPQueue($this-&gt;ch);
$this-&gt;queue-&gt;setName(MQ_QUEUE);
$this-&gt;queue-&gt;declare();
$this-&gt;queue-&gt;bind(MQ_EXCHANGE, MQ_ROUTING_KEY);
$this-&gt;queue-&gt;consume(array($this , 'processMessage') , AMQP_AUTOACK);
    }
    
    public function processMessage($msg) {
return $this-&gt;messageParser-&gt;parse($msg-&gt;getBody());
    }
    
    public function publishMessage($message) {
try {
$this-&gt;exchange-&gt;publish($message , MQ_ROUTING_KEY);
} catch (Exception $e) {
echo &quot;Caught exception : &quot; . $e-&gt;getMessage();
}
}

protected function _createNewConnectionAndChannel() {

$this-&gt;conn = new AMQPConnection(array(
'host' =&gt; 'localhost' ,
'port' =&gt; 5672 ,
'login' =&gt;  MQ_USER,
'password' =&gt; MQ_PASS
));
$this-&gt;conn-&gt;connect();
$this-&gt;ch = new AMQPChannel($this-&gt;conn);
 $this-&gt;exchange = new AMQPExchange($this-&gt;ch);
$this-&gt;exchange-&gt;setName(MQ_EXCHANGE);
$this-&gt;exchange-&gt;setType('direct');
$this-&gt;exchange-&gt;declare();
}
 
}
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130407/ad3d7989/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130407/ad3d7989/attachment.htm</A>&gt;
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026397.html">[rabbitmq-discuss] Query regarding architecture including	rabbiMQ
</A></li>
	<LI>Next message: <A HREF="026391.html">[rabbitmq-discuss] RabbitMQ AMQP :- Socket error: Broken pipe on high load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26390">[ date ]</a>
              <a href="thread.html#26390">[ thread ]</a>
              <a href="subject.html#26390">[ subject ]</a>
              <a href="author.html#26390">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
