<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%203.0.4%20-%20Losing%20messages%20in%20a%20HA%20cluster&In-Reply-To=%3C517F9D35.70401%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026734.html">
   <LINK REL="Next"  HREF="026722.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster</H1>
    <B>Emile Joubert</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%203.0.4%20-%20Losing%20messages%20in%20a%20HA%20cluster&In-Reply-To=%3C517F9D35.70401%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster">emile at rabbitmq.com
       </A><BR>
    <I>Tue Apr 30 11:30:13 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026734.html">[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster
</A></li>
        <LI>Next message: <A HREF="026722.html">[rabbitmq-discuss] RabbitMQ-C SSL support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26775">[ date ]</a>
              <a href="thread.html#26775">[ thread ]</a>
              <a href="subject.html#26775">[ subject ]</a>
              <a href="author.html#26775">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Jason,

On 26/04/13 15:38, Jason McIntosh wrote:
&gt;<i> So to confirm my understanding here.  Message 1 was synched to both
</I>&gt;<i> queues before I stopped the disc node.  So when I shut down the disc
</I>&gt;<i> node, the ram node become the &quot;master&quot;.  As such, it should have had
</I>&gt;<i> message 1 and 2.  When I brought up the disc node it is a slave and had
</I>&gt;<i> it's messages essentially reset.  Per the docs: &quot;As such, when a slave
</I>&gt;<i> rejoins a mirrored-queue, it throws away any durable local contents it
</I>&gt;<i> already has and starts empty.&quot;.So when I now publish message 2, that
</I>&gt;<i> goes to the ram node, which is now the master, and we have 2 messages
</I>&gt;<i> total (disc node still off).  
</I>
That all sounds correct, as per your first message.

&gt;<i> The question becomes then - is there any way to recover the messages the
</I>&gt;<i> RAM node had if the disc node comes back and the ram node subsequently
</I>&gt;<i> failed?
</I>
Nodes joining the cluster have their queue contents reset. These
messages cannot be recovered.

To avoid message loss you will need to make sure that there is a
synchronised slave. Either add another slave or make sure at least one
of the existing slaves are synchronised. Slaves can be synchronised by
waiting for the queue contents to be replaced by the actions of
producers and consumers, or a future version of the broker will allow
slaves to be synchronised manually.

&gt;<i> Do I need to remove the HA policy, then bring up the RAM node to get
</I>&gt;<i> the RAM node messages (since it was master prior to it's restart)?
</I>
No. See <A HREF="http://www.rabbitmq.com/ha.html#start-stop">http://www.rabbitmq.com/ha.html#start-stop</A>

&gt;<i> if I had 3 nodes in a cluster, and 1 node went down, but
</I>&gt;<i> the other 2 nodes each got an even distribution of the queues
</I>
If you had 3 nodes and all queues were mirrored to all nodes then you
could shut down two of those nodes without losing messages, provided all
slaves were synchronised to start with.

&gt;<i> I've started testing on the new 3.1 nightly
</I>This version allows slave nodes to be synchronised manually.




-Emile





</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026734.html">[rabbitmq-discuss] 3.0.4 - Losing messages in a HA cluster
</A></li>
	<LI>Next message: <A HREF="026722.html">[rabbitmq-discuss] RabbitMQ-C SSL support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26775">[ date ]</a>
              <a href="thread.html#26775">[ thread ]</a>
              <a href="subject.html#26775">[ subject ]</a>
              <a href="author.html#26775">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
