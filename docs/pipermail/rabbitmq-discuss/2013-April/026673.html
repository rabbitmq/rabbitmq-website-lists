<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] memory usage reporting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20memory%20usage%20reporting&In-Reply-To=%3C1355894214.75061.1366823621893.JavaMail.root%400b10.mx%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026672.html">
   <LINK REL="Next"  HREF="026675.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] memory usage reporting</H1>
    <B>Kyle O'Donnell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20memory%20usage%20reporting&In-Reply-To=%3C1355894214.75061.1366823621893.JavaMail.root%400b10.mx%3E"
       TITLE="[rabbitmq-discuss] memory usage reporting">kyleo at 0b10.mx
       </A><BR>
    <I>Wed Apr 24 18:13:41 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026672.html">[rabbitmq-discuss] memory usage reporting
</A></li>
        <LI>Next message: <A HREF="026675.html">[rabbitmq-discuss] memory usage reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26673">[ date ]</a>
              <a href="thread.html#26673">[ thread ]</a>
              <a href="subject.html#26673">[ subject ]</a>
              <a href="author.html#26673">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So I had a hunch it was erlang R15 so I tried R14 and I am not seeing the same behaviour, and my app works just fine:

Has anyone seen similar issues using R15?  Does rabbit actually support R15?

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                         
22185 prod      20   0 2218m 164m 2648 S    1  0.5   2:03.38 /x/s/erlang-R14B04/lib/erlang/erts-5.8.5/bin/beam.smp -W w -K true -A30 -P 1048576 -- -root /x/s/                     

$ rabbitmqctl status
Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at p1-amqp-j101</A>' ...
[{pid,22185},
 {running_applications,
     [{rabbitmq_management_visualiser,&quot;RabbitMQ Visualiser&quot;,&quot;0.0.0&quot;},
      {rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;0.0.0&quot;},
      {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;0.0.0&quot;},
      {rabbit,&quot;RabbitMQ&quot;,&quot;3.0.4&quot;},
      {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.7&quot;},
      {rabbitmq_web_dispatch,&quot;RabbitMQ Web Dispatcher&quot;,&quot;0.0.0&quot;},
      {webmachine,&quot;webmachine&quot;,&quot;1.9.1-rmq0.0.0-git52e62bc&quot;},
      {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;2.3.1-rmq0.0.0-gitd541e9a&quot;},
      {xmerl,&quot;XML parser&quot;,&quot;1.2.10&quot;},
      {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.7.1&quot;},
      {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.5&quot;},
      {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;0.0.0&quot;},
      {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.10&quot;},
      {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.17.5&quot;},
      {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.14.5&quot;}]},
 {os,{unix,linux}},
 {erlang_version,
     &quot;Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:4:4] [rq:4] [async-threads:30] [hipe] [kernel-poll:true]\n&quot;},
 {memory,
     [{total,126538808},
      {connection_procs,77192},
      {queue_procs,322592},
      {plugins,247664},
      {other_proc,30329304},
      {mnesia,92032},
      {mgmt_db,195648},
      {msg_index,302840},
      {other_ets,1738912},
      {binary,31832},
      {code,19051379},
      {atom,1887705},
      {other_system,72261708}]},
 {vm_memory_high_watermark,0.4},
 {vm_memory_limit,13496687001},
 {disk_free_limit,1000000000},
 {disk_free,21999628288},
 {file_descriptors,
     [{total_limit,130970},
      {total_used,5},
      {sockets_limit,117871},
      {sockets_used,3}]},
 {processes,[{limit,1048576},{used,230}]},
 {run_queue,0},
 {uptime,506}]
...done.


----- Original Message -----
From: &quot;Kyle O'Donnell&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">kyleo at 0b10.mx</A>&gt;
To: &quot;Simon MacMullen&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;
Cc: &quot;Discussions about RabbitMQ&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
Sent: Wednesday, April 24, 2013 12:50:16 PM
Subject: Re: [rabbitmq-discuss] memory usage reporting

When I attached to the erlang VM it was indeed reporting ~15GB of memory usage

Ubuntu 12.04

Compiled erlang from source

here are my config options:
./configure --prefix=/x/s/erlang-R15B03 --enable-smp-support --enable-hipe --enable-threads --with-ssl



----- Original Message -----
From: &quot;Simon MacMullen&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;
To: &quot;Discussions about RabbitMQ&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
Cc: &quot;Kyle O'Donnell&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">kyleo at 0b10.mx</A>&gt;
Sent: Wednesday, April 24, 2013 12:43:44 PM
Subject: Re: [rabbitmq-discuss] memory usage reporting

Hmm. I am curious. On my machine (Ubuntu 10.04) the amount of memory 
reported used in &quot;rabbitmqctl status&quot; matches up much more closely with 
RES than with VIRT (which is roughly what you'd expect).

In your case the 17.9GB VIRT vs 269MB RES is too much to be explained by 
paged-out memory since you have 5GB of swap that is not used). So I 
would expect it to be memory-mapped files or other mysterious things.

However, Erlang certainly thinks that your RabbitMQ process is really 
using 15.5GB of memory; the memory breakdown looks plausible and those 
numbers do not at all correspond to memory-mapped files or whatever.

So I am not surprised the memory alarm has gone off, what surprises me 
is that the OS is reporting so little real memory in use. Which OS is 
it? How did you install Erlang?

Cheers, Simon

On 24/04/13 14:49, Kyle O'Donnell wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I've built rabbit (2.8.7 and 3.0.4) from source using R15B03, here
</I>&gt;<i> are the build time options:
</I>&gt;<i>
</I>&gt;<i> make RABBITMQ_BASE=/x/s/rabbitmq-server-3.0.4
</I>&gt;<i> RABBITMQ_LOG_BASE=/x/s/rabbitmq-server-3.0.4/var/log
</I>&gt;<i> RABBITMQ_CONFIG_FILE=/x/s/rabbitmq-server-3.0.4/etc/rabbitmq
</I>&gt;<i> RABBITMQ_MNESIA_DIR=/x/s/rabbitmq-server-3.0.4/var/lib/mnesia
</I>&gt;<i> TARGET_DIR=/x/s/rabbitmq-server-3.0.4
</I>&gt;<i> SBIN_DIR=/x/s/rabbitmq-server-3.0.4/sbin
</I>&gt;<i> MAN_DIR=/x/s/rabbitmq-server-3.0.4/man
</I>&gt;<i>
</I>&gt;<i> When I start my app rabbit quickly reports that it's reached the high
</I>&gt;<i> watermark for memory usage, and it counts virtual memory not resident
</I>&gt;<i> memory:
</I>&gt;<i>
</I>&gt;<i> PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+ COMMAND
</I>&gt;<i> 29723 prod      20   0 17.9g 269m 2752 S    4  0.8   2:40.80
</I>&gt;<i> /x/s/erlang-R15B03/lib/erlang/erts-5.9.3.1/bin/beam.smp -W w -K true
</I>&gt;<i> -A30 -P 1048576 -- -root /x/s/erlang-R15B03/lib/erlang -progname erl
</I>&gt;<i> -- -home /home/prod -- -pa /x/s/rabbitmq
</I>&gt;<i>
</I>&gt;<i> There is plenty of free memory on the machine
</I>&gt;<i>
</I>&gt;<i> $ free -m total       used       free     shared    buffers
</I>&gt;<i> cached Mem:         32178       2992      29186          0        242
</I>&gt;<i> 1929 -/+ buffers/cache:        820      31358 Swap:         5719
</I>&gt;<i> 0       5719
</I>&gt;<i>
</I>&gt;<i> Is this normal? Curious why rabbit cares about the virtual memory
</I>&gt;<i> size when there is so much actual memory available.
</I>&gt;<i>
</I>&gt;<i> below is the output from rabbitmqctl status
</I>&gt;<i>
</I>&gt;<i> Thanks, Kyle
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> rabbitmqctl status Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at p1-amqp-j101</A>' ...
</I>&gt;<i> [{pid,29723}, {running_applications,
</I>&gt;<i> [{rabbitmq_management_visualiser,&quot;RabbitMQ Visualiser&quot;,&quot;0.0.0&quot;},
</I>&gt;<i> {rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;0.0.0&quot;},
</I>&gt;<i> {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;0.0.0&quot;},
</I>&gt;<i> {rabbit,&quot;RabbitMQ&quot;,&quot;3.0.4&quot;}, {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.7.1&quot;},
</I>&gt;<i> {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.10&quot;}, {rabbitmq_web_dispatch,&quot;RabbitMQ
</I>&gt;<i> Web Dispatcher&quot;,&quot;0.0.0&quot;},
</I>&gt;<i> {webmachine,&quot;webmachine&quot;,&quot;1.9.1-rmq0.0.0-git52e62bc&quot;},
</I>&gt;<i> {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;2.3.1-rmq0.0.0-gitd541e9a&quot;},
</I>&gt;<i> {xmerl,&quot;XML parser&quot;,&quot;1.3.2&quot;}, {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.9.2&quot;},
</I>&gt;<i> {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;0.0.0&quot;}, {sasl,&quot;SASL  CXC 138
</I>&gt;<i> 11&quot;,&quot;2.2.1&quot;}, {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.18.3&quot;}, {kernel,&quot;ERTS
</I>&gt;<i> CXC 138 10&quot;,&quot;2.15.3&quot;}]}, {os,{unix,linux}}, {erlang_version, &quot;Erlang
</I>&gt;<i> R15B03 (erts-5.9.3.1) [source] [64-bit] [smp:4:4] [async-threads:30]
</I>&gt;<i> [hipe] [kernel-poll:true]\n&quot;}, {memory, [{total,15536914264},
</I>&gt;<i> {connection_procs,89537888}, {queue_procs,18333416},
</I>&gt;<i> {plugins,1170400}, {other_proc,6548309}, {mnesia,2538168},
</I>&gt;<i> {mgmt_db,32239752}, {msg_index,615120}, {other_ets,3557064},
</I>&gt;<i> {binary,15276878352}, {code,20248995}, {atom,801697},
</I>&gt;<i> {other_system,84445103}]}, {vm_memory_high_watermark,0.4},
</I>&gt;<i> {vm_memory_limit,13496687001}, {disk_free_limit,1000000000},
</I>&gt;<i> {disk_free,22007357440}, {file_descriptors, [{total_limit,130970},
</I>&gt;<i> {total_used,1828}, {sockets_limit,117871}, {sockets_used,1826}]},
</I>&gt;<i> {processes,[{limit,1048576},{used,20875}]}, {run_queue,0},
</I>&gt;<i> {uptime,1620}] ...done.
</I>&gt;<i> _______________________________________________ rabbitmq-discuss
</I>&gt;<i> mailing list <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
_______________________________________________
rabbitmq-discuss mailing list
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026672.html">[rabbitmq-discuss] memory usage reporting
</A></li>
	<LI>Next message: <A HREF="026675.html">[rabbitmq-discuss] memory usage reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26673">[ date ]</a>
              <a href="thread.html#26673">[ thread ]</a>
              <a href="subject.html#26673">[ subject ]</a>
              <a href="author.html#26673">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
