<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] memory usage reporting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20memory%20usage%20reporting&In-Reply-To=%3C1285849370.75155.1366839817632.JavaMail.root%400b10.mx%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026679.html">
   <LINK REL="Next"  HREF="026681.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] memory usage reporting</H1>
    <B>Kyle O'Donnell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20memory%20usage%20reporting&In-Reply-To=%3C1285849370.75155.1366839817632.JavaMail.root%400b10.mx%3E"
       TITLE="[rabbitmq-discuss] memory usage reporting">kyleo at 0b10.mx
       </A><BR>
    <I>Wed Apr 24 22:43:37 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026679.html">[rabbitmq-discuss] memory usage reporting
</A></li>
        <LI>Next message: <A HREF="026681.html">[rabbitmq-discuss] memory usage reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26680">[ date ]</a>
              <a href="thread.html#26680">[ thread ]</a>
              <a href="subject.html#26680">[ subject ]</a>
              <a href="author.html#26680">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matthias,

I don't know if there is anything confidential in the report output.  Is there something specific I can send you (the output is ~10k lines)?

I don't know specifically what our app is doing, though I can ask the development team specific questions for you... If I can simplify/test it I'll let you know.

I think there are 2 possible issues, 1) erlang might be looking in the wrong place to get its memory usage information and 2) something is causing erlang to reserve large chunks of virtual memory.

I also tried one last thing... the build I had of R14 was about 12months old.  I wanted to make sure it was using the exact same configure options my R15 and R16 builds.  I recompiled R14, and rabbit and I am not seeing the huge virtual memory usage:

notice the resident memory usage and the memory reported by rabbit status are very close [120mb vs 166mb]

also notice that the amount of memory allocated to 'binary' is almost nil, whereas with R15/R16 it was huge..


  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                         
26856 prod      20   0 2217m 166m 2640 S    1  0.5   2:03.78 beam.smp                                                                                         

Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at p1-amqp-j101</A>' ...
[{pid,26856},
 {running_applications,
     [{rabbitmq_management_visualiser,&quot;RabbitMQ Visualiser&quot;,&quot;0.0.0&quot;},
      {rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;0.0.0&quot;},
      {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;0.0.0&quot;},
      {rabbit,&quot;RabbitMQ&quot;,&quot;3.0.4&quot;},
      {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.5&quot;},
      {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.7&quot;},
      {rabbitmq_web_dispatch,&quot;RabbitMQ Web Dispatcher&quot;,&quot;0.0.0&quot;},
      {webmachine,&quot;webmachine&quot;,&quot;1.9.1-rmq0.0.0-git52e62bc&quot;},
      {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;2.3.1-rmq0.0.0-gitd541e9a&quot;},
      {xmerl,&quot;XML parser&quot;,&quot;1.2.10&quot;},
      {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.7.1&quot;},
      {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;0.0.0&quot;},
      {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.10&quot;},
      {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.17.5&quot;},
      {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.14.5&quot;}]},
 {os,{unix,linux}},
 {erlang_version,
     &quot;Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:4:4] [rq:4] [async-threads:30] [hipe] [kernel-poll:true]\n&quot;},
 {memory,
     [{total,126532760},
      {connection_procs,225328},
      {queue_procs,414736},
      {plugins,116176},
      {other_proc,30207680},
      {mnesia,97560},
      {mgmt_db,165176},
      {msg_index,302840},
      {other_ets,1744392},
      {binary,34256},
      {code,19111543},
      {atom,1887705},
      {other_system,72225368}]},
 {vm_memory_high_watermark,0.4},
 {vm_memory_limit,13496687001},
 {disk_free_limit,1000000000},
 {disk_free,21576155136},
 {file_descriptors,
     [{total_limit,130970},
      {total_used,5},
      {sockets_limit,117871},
      {sockets_used,3}]},
 {processes,[{limit,1048576},{used,264}]},
 {run_queue,0},
 {uptime,578}]
...done.


----- Original Message -----
From: &quot;Matthias Radestock&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;
To: &quot;Kyle O'Donnell&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">kyleo at 0b10.mx</A>&gt;
Cc: &quot;Discussions about RabbitMQ&quot; &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
Sent: Wednesday, April 24, 2013 5:08:30 PM
Subject: Re: [rabbitmq-discuss] memory usage reporting

Kyle,

On 24/04/13 21:49, Kyle O'Donnell wrote:
&gt;<i> R16B seems to behave the same way R15B03 does:
</I>
Interesting. Do you have a 'rabbitmqctl report' to go with that?

What is your app actually doing? Looks like it opens a fair number of 
connections, and publish quite a lot of (or some very large) messages. 
Presumably it's consuming them too. The difference in behaviour could be 
due to very small scheduling differences in the VM, or, if you are 
running the producers and consumers on the same machine as rabbit, 
differences in Erlang CPU usage and consequent O/S level scheduling.

Can you condense the behaviour into a test case that we can run against 
different erlang versions and observe the difference in behaviour?

Regards,

Matthias.
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026679.html">[rabbitmq-discuss] memory usage reporting
</A></li>
	<LI>Next message: <A HREF="026681.html">[rabbitmq-discuss] memory usage reporting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26680">[ date ]</a>
              <a href="thread.html#26680">[ thread ]</a>
              <a href="subject.html#26680">[ subject ]</a>
              <a href="author.html#26680">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
