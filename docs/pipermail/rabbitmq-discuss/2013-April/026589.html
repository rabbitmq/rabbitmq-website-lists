<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ Queues memory leak?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Queues%20memory%20leak%3F&In-Reply-To=%3C5171732D.4060804%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026574.html">
   <LINK REL="Next"  HREF="026288.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ Queues memory leak?</H1>
    <B>Emile Joubert</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Queues%20memory%20leak%3F&In-Reply-To=%3C5171732D.4060804%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ Queues memory leak?">emile at rabbitmq.com
       </A><BR>
    <I>Fri Apr 19 17:39:09 BST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="026574.html">[rabbitmq-discuss] RabbitMQ Queues memory leak?
</A></li>
        <LI>Next message: <A HREF="026288.html">[rabbitmq-discuss] AD Queues Not AutoDeleting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26589">[ date ]</a>
              <a href="thread.html#26589">[ thread ]</a>
              <a href="subject.html#26589">[ subject ]</a>
              <a href="author.html#26589">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Hi,


On 19/04/13 10:23, Dmitry Saprykin wrote:
&gt;<i>     The difference between 1Mb and 180Mb is relatively large, even after
</I>&gt;<i>     taking expected differences due to garbage collection into account. We
</I>&gt;<i>     can't rule out a memory leak, but need some assistance from you to
</I>&gt;<i>     confirm.
</I>&gt;<i> 
</I>&gt;<i>     Do you see the same asymmetry if the master node for the queues switch
</I>&gt;<i>     from one node to the other? So if you shut the cdaemon2 node, let
</I>&gt;<i>     cdaemon4 become the master for all the queue, turn cdaemon2 back on (it
</I>&gt;<i>     will now be a slave node) does the memory on cdaemon2 now grow?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Yes, after current master stops and starts it becomes slave and its 
</I>&gt;<i> memory starts to grow. Meantime new selected master memory does not
</I>&gt;<i> become free. So new master memory stops to grow but do not fall back
</I>&gt;<i> to normal. I have attached memory graphs of our nodes to this
</I>&gt;<i> letter.
</I>

Thanks for confirming.


&gt;<i>     Have you been able to add a third node to the cluster for testing
</I>&gt;<i>     purposes to see if memory grows on more than one slave node?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> We have not tied to do this yet. But if it can help we can allocate
</I>&gt;<i> one more node. Is is ok to create test node at the same physical host
</I>&gt;<i> as one of existing nodes?
</I>

This is probably not necessary. Based on the information you have
provided we have identified a problem which could be the cause.


&gt;<i>     How long does it take for the memory use to reach the VM memory high
</I>&gt;<i>     watermark? 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Critical point for our cluster comes much more earlier than VM
</I>&gt;<i> memory high watermark. The same time with memory grow slave node
</I>&gt;<i> starts to use CPU more and more active. In our case when memory
</I>&gt;<i> consumption reaches ~1Gb broker stops to respond.
</I>&gt;<i> 
</I>&gt;<i> After slave restart memory grows linearily some time. After that
</I>&gt;<i> memory grow changes its pattern. At some moments it increases by
</I>&gt;<i> constant step (~20Mb). I have marked these steps on graphs attached.
</I>

The linear increase in memory use strongly suggests a memory leak.
Thanks for the detailed information and graphs.


&gt;<i>     Can you describe your messaging pattern in a bit more detail for us to
</I>&gt;<i>     reproduce the problem - how often are new channels created when
</I>&gt;<i>     publishing?
</I>
&gt;<i> 2) Create channel
</I>
&gt;<i> 3) Create channel
</I>

It it likely that the high turnover of channels is a critical
precondition for this leak.



&gt;<i>     In order to investigate further it might be helpful to execute some
</I>&gt;<i>     diagnostic commands on the broker. Are you able to replicate the problem
</I>&gt;<i>     in a staging or QA environment where it is safe to do this?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I will execute diagnostic commands on the broker. If something goes 
</I>&gt;<i> wrong our messaging falls back to version without rabbitMQ involved
</I>&gt;<i> ).
</I>
Please be aware that this command could produce a large amount of
output. It should be run on the slave node:

rabbitmqctl eval 'hd(lists:reverse(lists:sort([{process_info(Pid,
memory), Pid, process_info(Pid)} || Pid &lt;- processes()]))).'


Please pipe the output to a file, compress and email to me offlist.


Thanks again




-Emile







</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026574.html">[rabbitmq-discuss] RabbitMQ Queues memory leak?
</A></li>
	<LI>Next message: <A HREF="026288.html">[rabbitmq-discuss] AD Queues Not AutoDeleting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26589">[ date ]</a>
              <a href="thread.html#26589">[ thread ]</a>
              <a href="subject.html#26589">[ subject ]</a>
              <a href="author.html#26589">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
