<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Form Submission - Add A Question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Form%20Submission%20-%20Add%20A%20Question&In-Reply-To=269388e30811201455g71b3794fqae2133fb86c57b91%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002094.html">
   <LINK REL="Next"  HREF="002119.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Form Submission - Add A Question</H1>
    <B>Sean Treadway</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Form%20Submission%20-%20Add%20A%20Question&In-Reply-To=269388e30811201455g71b3794fqae2133fb86c57b91%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Form Submission - Add A Question">sean at soundcloud.com
       </A><BR>
    <I>Fri Nov 21 21:30:22 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002094.html">[rabbitmq-discuss] Form Submission - Add A Question
</A></li>
        <LI>Next message: <A HREF="002119.html">[rabbitmq-discuss] Form Submission - Add A Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2116">[ date ]</a>
              <a href="thread.html#2116">[ thread ]</a>
              <a href="subject.html#2116">[ subject ]</a>
              <a href="author.html#2116">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Nov 20, 2008, at 23: 55, Ben Hood wrote:
&gt;<i> <A HREF="http://lettuce.squarespace.com/faq/receiving-messages/does-basicget-automatically-acknowledge-a-message.html">http://lettuce.squarespace.com/faq/receiving-messages/does-basicget-automatically-acknowledge-a-message.html</A>
</I>&gt;<i> <A HREF="http://lettuce.squarespace.com/faq/queues/what-is-queue-depth.html">http://lettuce.squarespace.com/faq/queues/what-is-queue-depth.html</A>
</I>
Thanks for formulating these two into the FAQs.

&gt;&gt;<i> Publish 1
</I>&gt;&gt;<i> Publish 2
</I>&gt;&gt;<i> Publish 3
</I>&gt;&gt;<i> Client B: sends Basic.Consume
</I>&gt;&gt;<i> Client B: receives Basic.Deliver 1
</I>&gt;&gt;<i> Client B: sends Bacic.Ack 1
</I>&gt;&gt;<i> Client A: checks depth
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would assume that the queue depth should be 2, but what is  
</I>&gt;&gt;<i> returned is 0.
</I>&gt;&gt;<i> Without the Ack, I would still assume the queue depth to be 3.
</I>&gt;<i>
</I>&gt;<i> Everything is asynchronous here and it is not clear whether
</I>&gt;<i>
</I>&gt;<i> a) The the order of events over time from the broker's perspective
</I>&gt;<i> actually matches the client's perception;
</I>
 From what I was testing, enough time was passing between each event  
that the order of events was reasonably predictable.

&gt;<i> b) The remaining 2 messages that you are supposedly missing are
</I>&gt;<i> actually in mid-flight somewhere.
</I>
What qualifies as &quot;mid-flight&quot; and how/when does that happen?

&gt;<i> This will depend in part on how your client behaves, e.g. whether it
</I>&gt;<i> absorbs socket back pressure or not.
</I>
I don't believe I can control any socket options with the library I'm  
using.

&gt;<i> Two questions:
</I>&gt;<i>
</I>&gt;<i> a) Which statistic are you referring to when you are reporting the  
</I>&gt;<i> queue depth?
</I>&gt;<i> b) What library are you using?
</I>
I'm using the result returned by Queue.Declare passive=1 from RabbitMQ  
1.4.0 using Aman's Ruby library from <A HREF="http://github.com/tmm1/amqp/commits/d2cbf1e48eacdd3a6708212ced4bc1a204d5ae21">http://github.com/tmm1/amqp/commits/d2cbf1e48eacdd3a6708212ced4bc1a204d5ae21</A>

The test case that I'm basing my observations on is zipped up with  
instructions in the README.  The tests require the EventMachine gem,  
and amqp 0.5.9 or source to be installed.

&gt;&gt;<i> Another issue that I took much time to debug was failing to  
</I>&gt;&gt;<i> understand how
</I>&gt;&gt;<i> messages are delivered to clients, where I am assuming a fair  
</I>&gt;&gt;<i> distribution
</I>&gt;&gt;<i> to clients.  Example:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Publish 1
</I>&gt;&gt;<i> Client A: Basic.Consume
</I>&gt;&gt;<i> Publish 2
</I>&gt;&gt;<i> Publish 3
</I>&gt;&gt;<i> Publsih 4
</I>&gt;&gt;<i> Client B: Basic.Consume
</I>&gt;&gt;<i> Publish 5
</I>&gt;&gt;<i> Publish 6
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The delivered order I would assume would be close to this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Client A: Deliver/Ack 1
</I>&gt;&gt;<i> Client B: Deliver/Ack 2
</I>&gt;&gt;<i> Client A: Deliver/Ack 3
</I>&gt;&gt;<i> Client B: Deliver/Ack 4
</I>&gt;&gt;<i> Client A: Deliver/Ack 5
</I>&gt;&gt;<i> Client B: Deliver/Ack 6
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But is actually:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Client A: Deliver/Ack 1
</I>&gt;&gt;<i> Client B: Deliver/Ack 5
</I>&gt;&gt;<i> Client A: Deliver/Ack 2
</I>&gt;&gt;<i> Client A: Deliver/Ack 3
</I>&gt;&gt;<i> Client A: Deliver/Ack 4
</I>&gt;&gt;<i> Client A: Deliver/Ack 6
</I>&gt;<i>
</I>&gt;<i> Do client A and B have their own channel or do they share a channel?
</I>
A and B have different channels, they are running on separate processes.

&gt;&gt;<i> Client B never sees 2,3 or 4.  In the use case of load balancing -  
</I>&gt;&gt;<i> we need
</I>&gt;&gt;<i> to start more clients when the queue depth grows, but this behavior  
</I>&gt;&gt;<i> prevents
</I>&gt;&gt;<i> the new clients to catch up on the previous messages.  Do you have  
</I>&gt;&gt;<i> any
</I>&gt;&gt;<i> suggestions for how to accomplish fair distribution to 'late comer'  
</I>&gt;&gt;<i> clients?
</I>&gt;&gt;<i> Is this even possible, or are there best practices that I'm  
</I>&gt;&gt;<i> missing?  Or
</I>&gt;&gt;<i> are there ways of configuring RabbitMQ to deliver messages like in  
</I>&gt;&gt;<i> the 1st
</I>&gt;&gt;<i> example?
</I>&gt;<i>
</I>&gt;<i> Yes, it's a command that is called basic.qos whereby you set a
</I>&gt;<i> per-channel pre-fetch window and basically credit consumers
</I>&gt;<i> proportionally to the number of acks they send back.
</I>&gt;<i>
</I>&gt;<i> It's currently in development ATM (branch 18577 refers).
</I>
Excellent to hear.

I'm sure that Basic.Get can be used, but in my rough tests, I couldn't  
get un-ack'd messages redelivered.  I believe I was failing to close  
my channel to get them redelivered.  I'll also take another look at  
Basic.Get with no_ack=true.

Thanks!

-Sean



-------------- next part --------------
A non-text attachment was scrubbed...
Name: queue_depth.tgz
Type: application/octet-stream
Size: 1663 bytes
Desc: not available
Url : <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20081121/9982af4d/attachment.obj">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20081121/9982af4d/attachment.obj</A> 
-------------- next part --------------



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002094.html">[rabbitmq-discuss] Form Submission - Add A Question
</A></li>
	<LI>Next message: <A HREF="002119.html">[rabbitmq-discuss] Form Submission - Add A Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2116">[ date ]</a>
              <a href="thread.html#2116">[ thread ]</a>
              <a href="subject.html#2116">[ subject ]</a>
              <a href="author.html#2116">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
