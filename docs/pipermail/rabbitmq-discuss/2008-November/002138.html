<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] py-amqplib status messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20py-amqplib%20status%20messages&In-Reply-To=49266EC0.9000903%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002112.html">
   <LINK REL="Next"  HREF="002139.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] py-amqplib status messages</H1>
    <B>Dmitriy Samovskiy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20py-amqplib%20status%20messages&In-Reply-To=49266EC0.9000903%40lshift.net"
       TITLE="[rabbitmq-discuss] py-amqplib status messages">dmitriy.samovskiy at cohesiveft.com
       </A><BR>
    <I>Mon Nov 24 16:54:45 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002112.html">[rabbitmq-discuss] py-amqplib status messages
</A></li>
        <LI>Next message: <A HREF="002139.html">[rabbitmq-discuss] py-amqplib status messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2138">[ date ]</a>
              <a href="thread.html#2138">[ thread ]</a>
              <a href="subject.html#2138">[ subject ]</a>
              <a href="author.html#2138">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Matthias,

Matthias Radestock wrote:
&gt;&gt;<i>
</I>&gt;&gt;<i> def main():
</I>&gt;&gt;<i>   conn = A.Connection('localhost', userid='tsuraan', password='tsuraan')
</I>&gt;&gt;<i>   chan = conn.channel()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   for i in range(1000):
</I>&gt;&gt;<i>     m = A.Message(str(i), delivery_mode=2)
</I>&gt;&gt;<i>     chan.basic_publish(m, 'rawmsg', 'standard', mandatory=True, immediate=False)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;&gt;<i>   main()
</I>&gt;<i> 
</I>&gt;<i> The above program exits without closing the channel or connection 
</I>&gt;<i> properly first. As a result, any messages that are &quot;in flight&quot; will be lost.
</I>&gt;<i> 
</I>
How do you define &quot;messages in flight&quot; in this scenario?

I played with this code and tcpdump, and discovered that there could be a single TCP 
packet (ack'ed by broker's network stack) with multiple basic.publish methods inside, and 
some of those methods were processed by rabbit, and some were not. Furthermore, there 
could be more TCP packets after this one that also were TCP-ack'ed but were not processed 
by broker.

In rabbit_reader.erl, in mainloop function, I see this:

{inet_async, Sock, Ref, {error, closed}} -&gt;
    if State#v1.connection_state =:= closed -&gt;
       State;
    true -&gt;
       throw(connection_closed_abruptly)
    end;


Maybe before raising an exception, broker could look in its incoming buffer and see if 
there is more data there? It can maybe disregard all methods that require a response 
(because a TCP connection is no longer established at this point), but if it finds 
basic.publish or other methods that do not require response - maybe it could process them?

Is it a fair assumption that if a TCP packet was ack'ed, it means its contents reached the 
broker and would be processed eventually?


- Dmitriy


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002112.html">[rabbitmq-discuss] py-amqplib status messages
</A></li>
	<LI>Next message: <A HREF="002139.html">[rabbitmq-discuss] py-amqplib status messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2138">[ date ]</a>
              <a href="thread.html#2138">[ thread ]</a>
              <a href="subject.html#2138">[ subject ]</a>
              <a href="author.html#2138">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
