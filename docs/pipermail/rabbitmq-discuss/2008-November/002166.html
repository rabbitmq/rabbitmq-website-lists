<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Rabbitmq falling over &amp; losing messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Rabbitmq%20falling%20over%20%26%20losing%20messages&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002165.html">
   <LINK REL="Next"  HREF="002168.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages</H1>
    <B>Toby White</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Rabbitmq%20falling%20over%20%26%20losing%20messages&In-Reply-To="
       TITLE="[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages">toby.o.h.white at googlemail.com
       </A><BR>
    <I>Thu Nov 27 15:41:59 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002165.html">[rabbitmq-discuss] Connection problems with Rabbitmq 1.4.0
</A></li>
        <LI>Next message: <A HREF="002168.html">[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2166">[ date ]</a>
              <a href="thread.html#2166">[ thread ]</a>
              <a href="subject.html#2166">[ subject ]</a>
              <a href="author.html#2166">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm seeing a failure condition in Rabbit, where I seem to lose a whole  
queue's worth of messages.

I'm using RabbitMQ-1.4.0, and talking to it with py-amqplib.

If I push small messages at Rabbit as fast as I can (both client and  
server on the same host) in transacted batches of 1000:

 &gt;&gt;&gt; t = str(time.time())
 &gt;&gt;&gt; ch.tx_select()
 &gt;&gt;&gt; for i in xrange(1000):
...     msgs = [str(1000*i+j)+&quot; &quot;+t for j in xrange(1000)]
...     for j in xrange(1000):
...         ch.basic_publish(amqp.Message(msgs[j], delivery_mode=2),  
'amq.direct', routing_key='TX')
...     print i
...     ch.tx_commit()
...     ch.tx_select()

then initially rabbit accepts the connections, and I can see the  
messages arriving on the queue, in their batches, from the broker's  
shell (there is no consumer running, so all messages are building up  
in the broker queue.)

However, after anywhere between 50,000 and 100,000 messages have been  
published, the client gets an exception, RabbitMQ crashes, and the  
queue vanishes from the server, along with all unconsumed messages.  
Recreating the queue shows it empty; restarting the server entirely is  
a hit-and-miss affair; sometimes it works fine (though the messages  
are still missing); sometimes it fails due to a timeout on the  
persister process, and the only way to restart seems to be to delete / 
var/lib/rabbitmq/mnesia.

This is all entirely reproducible, the only variable being the number  
of messages published/consumed before Rabbit falls over.

At the time of crashing, the erlang process is taking about 40% of the  
host's CPU, and about 10% of its memory; the Python process doing the  
publishing is taking a small amount of CPU and memory, nothing else of  
significance is consuming any resources.

The client exception looks like:

Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 6, in &lt;module&gt;
  File &quot;/usr/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line  
3336, in tx_commit
    (90, 21),    # Channel.tx_commit_ok
  File &quot;/usr/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line  
183, in wait
    frame_type, payload = self._next_frame()
  File &quot;/usr/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line  
123, in _next_frame
    return self.connection._wait_channel(self.channel_id)
  File &quot;/usr/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line  
430, in _wait_channel
    self.wait()
  File &quot;/usr/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line  
203, in wait
    return self._dispatch(method_sig, args, content)
  File &quot;/usr/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line  
115, in _dispatch
    return amqp_method(self, args)
  File &quot;/usr/lib/python2.5/site-packages/amqplib/client_0_8.py&quot;, line  
563, in _close
    raise AMQPConnectionException(reply_code, reply_text, (class_id,  
method_id))
amqplib.client_0_8.AMQPConnectionException: (541, u'INTERNAL_ERROR',  
(0, 0), '')


Looking in the Rabbit logs, this happens at the crash:

=ERROR REPORT==== 27-Nov-2008::12:00:45 ===
connection &lt;0.283.0&gt; (running), channel 1 - error:
{commit_failed,
    [{exit,
         {timeout,
             {gen_server,
                 call,
                 [&lt;0.273.0&gt;,{commit,{{1,&lt;0.288.0&gt;},1080079}}]}}}]}

=WARNING REPORT==== 27-Nov-2008::12:00:45 ===
Non-AMQP exit reason '{commit_failed,
                          [{exit,
                               {timeout,
                                   {gen_server,
                                       call,
                                       [&lt;0.273.0&gt;,
                                        {commit,{{1,&lt;0.288.0&gt;}, 
1080079}}]}}}]}'

=INFO REPORT==== 27-Nov-2008::12:00:45 ===
closing TCP connection &lt;0.283.0&gt; from 127.0.0.1:57226

=ERROR REPORT==== 27-Nov-2008::12:01:36 ===
** Generic server &lt;0.273.0&gt; terminating
** Last message in was {commit,{{1,&lt;0.288.0&gt;},1080079}}
** When Server state == {q,
                         {amqqueue,
                          {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;TX_queue&quot;&gt;&gt;},
                          true,
                          false,
                          [],
                          [],
                          none},
                         none,
                         none,
                         true,
                         1,
[...]
                           {{basic_message,
                              
{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;amq.direct&quot;&gt;&gt;},
                             &lt;&lt;&quot;TX&quot;&gt;&gt;,
                             {content,
                              60,
                              {'P_basic',
                               undefined,
                               undefined,
                               undefined,
                               2,
                               undefined,
                               undefined,
                               undefined,
                               undefined,
                               undefined,
                               undefined,
                               undefined,
                               undefined,
                               undefined,
                               undefined},
                              &lt;&lt;16,0,2&gt;&gt;,
                              [&lt;&lt;&quot;78999 1227785600.85&quot;&gt;&gt;]},
                             {{1,&lt;0.288.0&gt;},1080078}},
                            false}]},
                         {[],[]}}
** Reason for termination ==
** {timeout,
       {gen_server,
           call,
           [rabbit_persister,
            {commit_transaction,
                {{{1,&lt;0.288.0&gt;},1080079},
                 {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;TX_queue&quot;&gt;&gt;}}}]}}


with the entire contents of the queue (79000 messages in this case)  
inside the server state.

What can I do to fix this?

Toby



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002165.html">[rabbitmq-discuss] Connection problems with Rabbitmq 1.4.0
</A></li>
	<LI>Next message: <A HREF="002168.html">[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2166">[ date ]</a>
              <a href="thread.html#2166">[ thread ]</a>
              <a href="subject.html#2166">[ subject ]</a>
              <a href="author.html#2166">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
