<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Rabbitmq falling over &amp; losing messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Rabbitmq%20falling%20over%20%26%20losing%20messages&In-Reply-To=C24403B9-3526-4FC9-80EE-19CF181F2DE7%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002170.html">
   <LINK REL="Next"  HREF="002172.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages</H1>
    <B>Ben Hood</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Rabbitmq%20falling%20over%20%26%20losing%20messages&In-Reply-To=C24403B9-3526-4FC9-80EE-19CF181F2DE7%40gmail.com"
       TITLE="[rabbitmq-discuss] Rabbitmq falling over &amp; losing messages">0x6e6562 at gmail.com
       </A><BR>
    <I>Sat Nov 29 00:06:18 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002170.html">[rabbitmq-discuss] rabbitmqctl_real writes error messages to stdout
</A></li>
        <LI>Next message: <A HREF="002172.html">[rabbitmq-discuss] Form Submission - Add A Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2171">[ date ]</a>
              <a href="thread.html#2171">[ thread ]</a>
              <a href="subject.html#2171">[ subject ]</a>
              <a href="author.html#2171">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Toby,

On Fri, Nov 28, 2008 at 10:47 AM, Toby White
&lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">toby.o.h.white at googlemail.com</A>&gt; wrote:
&gt;<i> I've pulled the latest repository version, and run the same tests. (This
</I>&gt;<i> also required me to upgrade the version of Erlang I was running on from 11b5
</I>&gt;<i> to 12b3)
</I>&gt;<i> The outcome is basically the same, but I get slightly different errors
</I>&gt;<i> logged.
</I>
So are you saying that with the latest version of Rabbit you are still
losing messages that are marked as persistent (as you indicated in
your first post)?

&gt;<i> The publishing script gets an exception like so:
</I>...
&gt;<i> [{exit,{timeout,{gen_server,call,[&lt;0.230.0&gt;,{commit,{{1,&lt;0.247.0&gt;},82082}},5000]}}}]',
</I>&gt;<i> (90, 20), 'Channel.tx_commit')
</I>
This client side trace looks normal for a server crash.

&gt;<i> and the rabbit error message is very slightly different:
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 28-Nov-2008::10:11:40 ===
</I>&gt;<i> connection &lt;0.242.0&gt; (running), channel 1 - error:
</I>&gt;<i> {amqp,internal_error,
</I>&gt;<i>      &quot;commit failed:
</I>&gt;<i> [{exit,{timeout,{gen_server,call,[&lt;0.230.0&gt;,{commit,{{1,&lt;0.247.0&gt;},82082}},5000]}}}]&quot;,
</I>&gt;<i>      'tx.commit'}
</I>&gt;<i>
</I>&gt;<i> (followed by a dump of the whole queue as before.)
</I>&gt;<i>
</I>&gt;<i> Furthermore, the following appears on the console:
</I>&gt;<i>
</I>&gt;<i> (<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at domU-12-31-39-02-61-F6</A>)3&gt;
</I>&gt;<i> /usr/lib/erlang/lib/os_mon-2.1.6/priv/bin/memsup: Erlang has closed.
</I>&gt;<i>
</I>&gt;<i>                           Erlang has closed
</I>&gt;<i>
</I>&gt;<i> Crash dump was written to: erl_crash.dump
</I>&gt;<i> eheap_alloc: Cannot allocate 729810240 bytes of memory (of type &quot;heap&quot;).
</I>&gt;<i> Aborted
</I>
Ok, this looks normal for a case when Rabbit runs out of memory
because you have flooded it with messages.

Currently the only preventative action against this is the
channel.flow command - see this article for the background :
<A HREF="http://hopper.squarespace.com/blog/2008/11/9/flow-control-in-rabbitmq.html">http://hopper.squarespace.com/blog/2008/11/9/flow-control-in-rabbitmq.html</A>

ATM producer throttling requires a well behaved client, i.e. one that
obeys the channel.flow command - the Python client currently isn't
well behaved in this respect.

&gt;<i> even though, as best I can tell from watching the output of top, the erlang
</I>&gt;<i> process never took more than about 10% of available memory.
</I>
Do you not see anything in the log about an alarm handler for memory, e.g.

=INFO REPORT==== 9-Nov-2008::15:13:31 ===
    alarm_handler: {set,{system_memory_high_watermark,[]}}

?

I find the memory statistic a bit strange - the alarm handler kicks in
by default at 95%.

Simon is currently looking into a issue with the way Erlang reports on
memory consumption on Linux - maybe he can can shed some light on what
may be going on with your installation.

Also, can you give some more details about your environment? Are you
running Xen?

Ben


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002170.html">[rabbitmq-discuss] rabbitmqctl_real writes error messages to stdout
</A></li>
	<LI>Next message: <A HREF="002172.html">[rabbitmq-discuss] Form Submission - Add A Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2171">[ date ]</a>
              <a href="thread.html#2171">[ thread ]</a>
              <a href="subject.html#2171">[ subject ]</a>
              <a href="author.html#2171">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
