<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Form Submission - Add A Question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Form%20Submission%20-%20Add%20A%20Question&In-Reply-To=199B1EFC-9BFC-492A-BBFA-879D652ADC6A%40soundcloud.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002106.html">
   <LINK REL="Next"  HREF="002116.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Form Submission - Add A Question</H1>
    <B>Ben Hood</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Form%20Submission%20-%20Add%20A%20Question&In-Reply-To=199B1EFC-9BFC-492A-BBFA-879D652ADC6A%40soundcloud.com"
       TITLE="[rabbitmq-discuss] Form Submission - Add A Question">0x6e6562 at gmail.com
       </A><BR>
    <I>Thu Nov 20 22:55:48 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002106.html">[rabbitmq-discuss] Maximum erlang processes &amp; dead channels
</A></li>
        <LI>Next message: <A HREF="002116.html">[rabbitmq-discuss] Form Submission - Add A Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2094">[ date ]</a>
              <a href="thread.html#2094">[ thread ]</a>
              <a href="subject.html#2094">[ subject ]</a>
              <a href="author.html#2094">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sean,

On Thu, Nov 20, 2008 at 12:55 PM, Sean Treadway &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">sean at soundcloud.com</A>&gt; wrote:
&gt;<i> Thanks Ben, it does indeed help.  For example, I didn't know that Basic.Get
</I>&gt;<i> automatically Acks a message.
</I>
<A HREF="http://lettuce.squarespace.com/faq/receiving-messages/does-basicget-automatically-acknowledge-a-message.html">http://lettuce.squarespace.com/faq/receiving-messages/does-basicget-automatically-acknowledge-a-message.html</A>

&gt;<i> Also, from someone approaching RabbitMQ without a strong background in
</I>&gt;<i> messaging I'm still trying to map out the differences in terminology -
</I>&gt;<i> particularly with regards to queue depth, and consumers vs connections vs
</I>&gt;<i> clients.  I read 'queue depth' as 'queue size', as 'how many messages have
</I>&gt;<i> been published waiting for acknowledgment'. But 'queue size' probably means
</I>&gt;<i> about 10 different things to you :)
</I>
<A HREF="http://lettuce.squarespace.com/faq/queues/what-is-queue-depth.html">http://lettuce.squarespace.com/faq/queues/what-is-queue-depth.html</A>

&gt;<i> I'll try to describe my confusion with
</I>&gt;<i> an example:
</I>&gt;<i>
</I>&gt;<i> Publish 1
</I>&gt;<i> Publish 2
</I>&gt;<i> Publish 3
</I>&gt;<i> Client A: checks depth with Queue.Declare passive
</I>&gt;<i>
</I>&gt;<i> Client A gets a queue depth of 3.
</I>
If this was the only interaction with the queue, then you could
feasibly expect this response.

&gt;<i> But the way RabbitMQ (and possibly AMQP) works is not very obvious:
</I>&gt;<i>
</I>&gt;<i> Publish 1
</I>&gt;<i> Publish 2
</I>&gt;<i> Publish 3
</I>&gt;<i> Client B: sends Basic.Consume
</I>&gt;<i> Client B: receives Basic.Deliver 1
</I>&gt;<i> Client B: sends Bacic.Ack 1
</I>&gt;<i> Client A: checks depth
</I>&gt;<i>
</I>&gt;<i> I would assume that the queue depth should be 2, but what is returned is 0.
</I>&gt;<i>  Without the Ack, I would still assume the queue depth to be 3.
</I>
Everything is asynchronous here and it is not clear whether

a) The the order of events over time from the broker's perspective
actually matches the client's perception;
b) The remaining 2 messages that you are supposedly missing are
actually in mid-flight somewhere.

This will depend in part on how your client behaves, e.g. whether it
absorbs socket back pressure or not.

Two questions:

a) Which statistic are you referring to when you are reporting the queue depth?
b) What library are you using?

&gt;<i> I write this here, because I've been trying to formulate a question but
</I>&gt;<i> can't really come up with one.  Maybe something like &quot;how is queue depth
</I>&gt;<i> calculated?&quot;  or &quot;how do you measure the queue depth of all un-ack'd
</I>&gt;<i> messages?&quot;  Or even something as simple as a glossary of common messaging
</I>&gt;<i> terminology and what each vendor uses for the terms.
</I>
Please see the linked FAQ.

&gt;<i> Another issue that I took much time to debug was failing to understand how
</I>&gt;<i> messages are delivered to clients, where I am assuming a fair distribution
</I>&gt;<i> to clients.  Example:
</I>&gt;<i>
</I>&gt;<i> Publish 1
</I>&gt;<i> Client A: Basic.Consume
</I>&gt;<i> Publish 2
</I>&gt;<i> Publish 3
</I>&gt;<i> Publsih 4
</I>&gt;<i> Client B: Basic.Consume
</I>&gt;<i> Publish 5
</I>&gt;<i> Publish 6
</I>&gt;<i>
</I>&gt;<i> The delivered order I would assume would be close to this:
</I>&gt;<i>
</I>&gt;<i> Client A: Deliver/Ack 1
</I>&gt;<i> Client B: Deliver/Ack 2
</I>&gt;<i> Client A: Deliver/Ack 3
</I>&gt;<i> Client B: Deliver/Ack 4
</I>&gt;<i> Client A: Deliver/Ack 5
</I>&gt;<i> Client B: Deliver/Ack 6
</I>&gt;<i>
</I>&gt;<i> But is actually:
</I>&gt;<i>
</I>&gt;<i> Client A: Deliver/Ack 1
</I>&gt;<i> Client B: Deliver/Ack 5
</I>&gt;<i> Client A: Deliver/Ack 2
</I>&gt;<i> Client A: Deliver/Ack 3
</I>&gt;<i> Client A: Deliver/Ack 4
</I>&gt;<i> Client A: Deliver/Ack 6
</I>
Do client A and B have their own channel or do they share a channel?

&gt;<i> Client B never sees 2,3 or 4.  In the use case of load balancing - we need
</I>&gt;<i> to start more clients when the queue depth grows, but this behavior prevents
</I>&gt;<i> the new clients to catch up on the previous messages.  Do you have any
</I>&gt;<i> suggestions for how to accomplish fair distribution to 'late comer' clients?
</I>&gt;<i>  Is this even possible, or are there best practices that I'm missing?  Or
</I>&gt;<i> are there ways of configuring RabbitMQ to deliver messages like in the 1st
</I>&gt;<i> example?
</I>
Yes, it's a command that is called basic.qos whereby you set a
per-channel pre-fetch window and basically credit consumers
proportionally to the number of acks they send back.

It's currently in development ATM (branch 18577 refers).

HTH,

Ben


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002106.html">[rabbitmq-discuss] Maximum erlang processes &amp; dead channels
</A></li>
	<LI>Next message: <A HREF="002116.html">[rabbitmq-discuss] Form Submission - Add A Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2094">[ date ]</a>
              <a href="thread.html#2094">[ thread ]</a>
              <a href="subject.html#2094">[ subject ]</a>
              <a href="author.html#2094">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
