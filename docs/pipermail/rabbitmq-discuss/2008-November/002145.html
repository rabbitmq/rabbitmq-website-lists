<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] nonblocking py-amqplib issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20nonblocking%20py-amqplib%20issues&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002148.html">
   <LINK REL="Next"  HREF="002149.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] nonblocking py-amqplib issues</H1>
    <B>majek04</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20nonblocking%20py-amqplib%20issues&In-Reply-To="
       TITLE="[rabbitmq-discuss] nonblocking py-amqplib issues">majek04 at gmail.com
       </A><BR>
    <I>Tue Nov 25 11:25:34 GMT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002148.html">[rabbitmq-discuss] about rabbitmq best practice
</A></li>
        <LI>Next message: <A HREF="002149.html">[rabbitmq-discuss] nonblocking py-amqplib issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2145">[ date ]</a>
              <a href="thread.html#2145">[ thread ]</a>
              <a href="subject.html#2145">[ subject ]</a>
              <a href="author.html#2145">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I tried to use amqplib.nbclient_0_8, but I had some problems with it.
I attached the code [1].

1. More than one message in the queue:
console #1:
$ ./rec_2.py  (this is the attached code)
&lt;I pressed ctrl+z to suspend the program&gt;
[1]+  Stopped                 ./rec_2.py

console #2:
$ ./demo_send.py 1 (standard amqplib demo program)
$ ./demo_send.py 2

back to console #1:
$ fg (to resume the program)
Traceback (most recent call last):
  File &quot;./rec_2.py&quot;, line 31, in &lt;module&gt;
    amqp.nbloop([ch])
  File &quot;build/bdist.linux-i686/egg/amqplib/nbclient_0_8.py&quot;, line 176, in nbloop
  File &quot;build/bdist.linux-i686/egg/amqplib/client_0_8.py&quot;, line 203, in wait
  File &quot;build/bdist.linux-i686/egg/amqplib/client_0_8.py&quot;, line 117,
in _dispatch
  File &quot;build/bdist.linux-i686/egg/amqplib/client_0_8.py&quot;, line 2854,
in _basic_deliver
  File &quot;./rec_2.py&quot;, line 7, in callback
    msg.channel.basic_ack(msg.delivery_tag)
  File &quot;build/bdist.linux-i686/egg/amqplib/client_0_8.py&quot;, line 2609,
in basic_ack
  File &quot;build/bdist.linux-i686/egg/amqplib/client_0_8.py&quot;, line 127,
in _send_method_frame
  File &quot;build/bdist.linux-i686/egg/amqplib/client_0_8.py&quot;, line 384,
in _send_channel_method_frame
  File &quot;build/bdist.linux-i686/egg/amqplib/nbclient_0_8.py&quot;, line 74, in write
&lt;P&#65533;' read_buf='&amp;&lt;!amq.ctag-rdYQarPUansf8+2dGsnFAQ==&#65533;6&lt;&lt;!amq.ctag-rdYQarPUansf8+2dGsnFAQ==myfan2&lt;&#65533;
text/plainfooIbarSbaz&#65533;1&#65533;6&lt;&lt;!amq.ctag-rdYQarPUansf8+2dGsnFAQ==myfan2&lt;&#65533;
text/plainfooIbarSbaz&#65533;2&#65533;' read_p='175'

2. Order of the messages is wrong.
I just changed the callback function and disabled basic_ack:

def callback(msg):
    m.append( msg.body )
    #### msg.channel.basic_ack(msg.delivery_tag) # disable ack

Console #1:
$ ./rec2_py

Console #2:
$ ./demo_send.py 1
$ ./demo_send.py 2
$ ./demo_send.py 3
$ ./demo_send.py 4

Back to console #1:
['1', '1']
['2', '1', '2']
['3', '1', '2', '3']
['4', '1', '2', '3', '4']


3. no_ack option for basic_consume is not working.
With disabled basic_ack, and added no_ack to basic_consume:
    ch.consumer_tag = ch.basic_consume(qname, callback=callback, no_ack=True)
I get exactly the same results as before.



I hope there is something that can be done to address this issues.

Cheers!
 Marek Majkowski


[1] The code of rec_2.py:
<A HREF="http://www.lshift.net/~majek/rec_2.py">http://www.lshift.net/~majek/rec_2.py</A>
I paste it also here:

import amqplib.nbclient_0_8 as amqp

m = []
def callback(msg):
    m.append( msg.body )
    msg.channel.basic_ack(msg.delivery_tag)

class NoActivityException(Exception):pass

def my_nb_callback(ch): raise NoActivityException

if __name__ == '__main__':
    conn = amqp.NonBlockingConnection('localhost',
         userid='guest', password='guest',
         nb_callback=my_nb_callback, insist=True, nb_sleep=0.0)

    ch = conn.channel()
    ch.access_request('/data', active=True, read=True)

    ch.exchange_declare('myfan', 'fanout', auto_delete=True)
    qname, _, _ = ch.queue_declare()
    ch.queue_bind(qname, 'myfan')
    ch.consumer_tag = ch.basic_consume(qname, callback=callback)

    while True:
        conn.sock.sock.setblocking(1)
        conn.sock.sock.recv(0)
        conn.sock.sock.setblocking(0)
        try:
            amqp.nbloop([ch])
        except NoActivityException, e:
            pass
        print &quot;%r&quot; % (m,)
        while m: m.pop()
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002148.html">[rabbitmq-discuss] about rabbitmq best practice
</A></li>
	<LI>Next message: <A HREF="002149.html">[rabbitmq-discuss] nonblocking py-amqplib issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2145">[ date ]</a>
              <a href="thread.html#2145">[ thread ]</a>
              <a href="subject.html#2145">[ subject ]</a>
              <a href="author.html#2145">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
