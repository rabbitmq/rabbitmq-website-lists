<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Federated exchange slowdown
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Federated%20exchange%20slowdown&In-Reply-To=%3C4F69F59E.3060208%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019011.html">
   <LINK REL="Next"  HREF="018917.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Federated exchange slowdown</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Federated%20exchange%20slowdown&In-Reply-To=%3C4F69F59E.3060208%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Federated exchange slowdown">simon at rabbitmq.com
       </A><BR>
    <I>Wed Mar 21 15:37:02 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019011.html">[rabbitmq-discuss] Federated exchange slowdown
</A></li>
        <LI>Next message: <A HREF="018917.html">[rabbitmq-discuss]  Sample example with Enqueue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19032">[ date ]</a>
              <a href="thread.html#19032">[ thread ]</a>
              <a href="subject.html#19032">[ subject ]</a>
              <a href="author.html#19032">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simone. I'm afraid I still can't replicate this. I was using iptables 
to interrupt connectivity between two brokers on the same machine, but 
apart from that I think I was doing the same thing.

One thing I noticed was that interrupting a connection that did not have 
heartbeating turned on meant the connection did not recover well unless 
manually killed. Do heartbeats help for you?

Also, what happens if you kill the federation connection when your test 
is stuck?

Cheers, Simon

On 20/03/12 23:03, Simone Busoli wrote:
&gt;<i> Hi Simon, I'm confused as well. Please take my previous observation with
</I>&gt;<i> a grain of salt as I was publishing somewhat big messages (100KB) at a
</I>&gt;<i> rate that perhaps couldn't be handled very well by the network. As soon
</I>&gt;<i> as I reduced the size to one tenth everything started going more
</I>&gt;<i> smoothly, for as long as something weird didn't happen to the network.
</I>&gt;<i> Here's the test environment I've set up to reproduce the issue: two
</I>&gt;<i> physical machines connected each to a network switch (all devices are
</I>&gt;<i> 100Mb), with the two switches connected to each other. Of course B1 and
</I>&gt;<i> B2 live on the two machines, respectively. A bunch of consumers on each
</I>&gt;<i> side. I'm faking a network latency of a few hundreds of milliseconds via
</I>&gt;<i> software, and publishing 20 msg/s of 10 kB each on one side of a
</I>&gt;<i> bidirectional federation exchange seems to work fine.
</I>&gt;<i> If I try disconnecting the network cable which connects the two switched
</I>&gt;<i> and plug it back a few seconds later implies that the federated
</I>&gt;<i> exchanges never catch up with the messages queued up so far, in
</I>&gt;<i> particular the outgoing queue on the broker acting as the downstream in
</I>&gt;<i> this scenario (the one whose messages would then be discarded by the
</I>&gt;<i> plugin once back to the publisher side) seems to not be emptied by
</I>&gt;<i> anyone anymore.
</I>&gt;<i>
</I>&gt;<i> One other thing I noticed during the failure in the production
</I>&gt;<i> environment is that if I deleted this automatically created queue (i.e.
</I>&gt;<i> the queue B2 -&gt; B1, with B1 being the originator of the messages),
</I>&gt;<i> affected the queue B1 -&gt; B2, which from a slow delivery rate stopped
</I>&gt;<i> completely. Now, as far as my understanding goes each direction of an
</I>&gt;<i> exchange federated between two brokers in both directions should be
</I>&gt;<i> independent of the other, but I experienced exactly this, and given that
</I>&gt;<i> a unidirectionally federated exchange under the same conditions
</I>&gt;<i> described above works just fine I am wondering whether connecting two
</I>&gt;<i> exchanges in this way implies some weird behavior in which each side
</I>&gt;<i> influences the other in a sort of cascading behavior which leads to a
</I>&gt;<i> deadlock.
</I>&gt;<i>
</I>&gt;<i> Although unlikely to be the cause of this, I'm wondering if using
</I>&gt;<i> prefetch-count, which I'm using, could lead to this behavior. For
</I>&gt;<i> example after the network bounce mentioned above the prefetch count was
</I>&gt;<i> reached on both sides, so no more deliveries would be done until acks
</I>&gt;<i> arrived from the other side. Might it happen that this could imply a
</I>&gt;<i> deadlock in which each side is waiting for the other to send
</I>&gt;<i> acknowledges before sending anymore messages?
</I>&gt;<i>
</I>&gt;<i> On Tue, Mar 20, 2012 at 13:21, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     On 19/03/12 14:00, Busoli, Simone wrote:
</I>&gt;<i>
</I>&gt;<i>         Hi Simon, I think I've mostly tracked down the issue to the
</I>&gt;<i>         symmetric
</I>&gt;<i>         setup of the federated exchanges between the two brokers. I noticed
</I>&gt;<i>         that whenever I start publishing messages to an exchange configured
</I>&gt;<i>         that way the network starts behaving in surprisingly ways. For
</I>&gt;<i>         instance, I can no longer get two machines connected directly by two
</I>&gt;<i>         network switches to ping each other. Stop publishing messages and
</I>&gt;<i>         everything goes back to a normal state. A federated exchange which
</I>&gt;<i>         goes in one direction only as well as a shovel instead behave just
</I>&gt;<i>         fine.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     I am very confused by this.
</I>&gt;<i>
</I>&gt;<i>     Really, nothing the federation plugin does should be able to stop
</I>&gt;<i>     ICMP pings from working, it's just a TCP connection after all.
</I>&gt;<i>
</I>&gt;<i>     The only thing I can think of is that somehow federation is going
</I>&gt;<i>     mad and flooding the link with traffic - but I'm sure you would have
</I>&gt;<i>     noticed that. And pings should still get through anyway.
</I>&gt;<i>
</I>&gt;<i>     Does wireshark / tcpdump / etc show anything unusual?
</I>&gt;<i>
</I>&gt;<i>     Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     --
</I>&gt;<i>     Simon MacMullen
</I>&gt;<i>     RabbitMQ, VMware
</I>&gt;<i>     _________________________________________________
</I>&gt;<i>     rabbitmq-discuss mailing list
</I>&gt;<i>     <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.__rabbitmq.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i>     <A HREF="https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss">https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss</A>
</I>&gt;<i>     &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019011.html">[rabbitmq-discuss] Federated exchange slowdown
</A></li>
	<LI>Next message: <A HREF="018917.html">[rabbitmq-discuss]  Sample example with Enqueue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19032">[ date ]</a>
              <a href="thread.html#19032">[ thread ]</a>
              <a href="subject.html#19032">[ subject ]</a>
              <a href="author.html#19032">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
