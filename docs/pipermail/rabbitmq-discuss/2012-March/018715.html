<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Lost message in 50k size range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lost%20message%20in%2050k%20size%20range&In-Reply-To=%3C9D6B4FB7-2A5B-453A-A205-BD7F829EEA73%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018659.html">
   <LINK REL="Next"  HREF="018627.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Lost message in 50k size range</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Lost%20message%20in%2050k%20size%20range&In-Reply-To=%3C9D6B4FB7-2A5B-453A-A205-BD7F829EEA73%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Lost message in 50k size range">steve at rabbitmq.com
       </A><BR>
    <I>Mon Mar 12 11:17:12 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018659.html">[rabbitmq-discuss] Lost message in 50k size range
</A></li>
        <LI>Next message: <A HREF="018627.html">[rabbitmq-discuss] Does RabbitMQ has the Message Grouping feature?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18715">[ date ]</a>
              <a href="thread.html#18715">[ thread ]</a>
              <a href="subject.html#18715">[ subject ]</a>
              <a href="author.html#18715">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi John,

I'm not familiar with the pika code, but scanning it (version 0.9.5 for python
2.6) it looks like the callback it is complaining about is one it adds itself
on close. Are you calling (or causing to be called) close twice, do you think?

--------8&lt;----------------------------------------------
_on_close_ready (which is a callback) calls _rpc thus:

        self._rpc(0, spec.Connection.Close(self.closing[0],
                                          self.closing[1], 0, 0),
                  self._on_connection_closed,
                  [spec.Connection.CloseOk])

and the third param is another callback (_on_connection_closed)
and _rpc adds it:

        # If we were passed a callback, add it to our stack
        if callback:
            for reply in acceptable_replies:
                self.callbacks.add(channel_number, reply, callback)

It is this callback which appears to be triggering the message.
--------------------------------------------------------

Steve Powell  (a lippy bunny)
----------some more definitions from the SPD----------
vermin (v.) Treating the dachshund for roundworm.
chinchilla (n.) Cooling device for the lower jaw.
socialcast (n.) Someone to whom everyone is speaking but nobody likes.

On 8 Mar 2012, at 14:30, John Reuning wrote:

&gt;<i> So, it looks like this was a flushing problem.  I either wasn't
</I>&gt;<i> closing the connection properly or was terminating the ioloop too
</I>&gt;<i> soon.  I fixed the message send problem but am now getting a warning
</I>&gt;<i> message from the callback manager.
</I>&gt;<i> 
</I>&gt;<i> /mnt/hgfs/devel/seedbank/seedbank/src/pika/callback.py:72:
</I>&gt;<i> UserWarning: CallbackManager.add: Duplicate callback found for
</I>&gt;<i> &quot;0:Connection.CloseOk&quot;
</I>&gt;<i>  (self.__class__.__name__, prefix, key))
</I>&gt;<i> 
</I>&gt;<i> It gives the warning regardless of whether or not I use
</I>&gt;<i> add_on_close_callback to specify my own callback function.  Any ideas
</I>&gt;<i> why this happens?
</I>&gt;<i> 
</I>&gt;<i> Here's the backtrace to the CallbackManager.add call that generates the message.
</I>&gt;<i> 
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/adapters/select_connection.py&quot;,
</I>&gt;<i> line 124, in start
</I>&gt;<i>    self.poller.start()
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/adapters/select_connection.py&quot;,
</I>&gt;<i> line 374, in start
</I>&gt;<i>    self.poll()
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/adapters/select_connection.py&quot;,
</I>&gt;<i> line 388, in poll
</I>&gt;<i>    self._handler(events[0][0], events[0][1])
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/adapters/base_connection.py&quot;,
</I>&gt;<i> line 134, in _handle_events
</I>&gt;<i>    self._handle_read()
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/adapters/base_connection.py&quot;,
</I>&gt;<i> line 162, in _handle_read
</I>&gt;<i>    self._on_data_available(data)
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/connection.py&quot;,
</I>&gt;<i> line 589, in _on_data_available
</I>&gt;<i>    frame)                 # Args
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/callback.py&quot;, line
</I>&gt;<i> 130, in process
</I>&gt;<i>    callback(*args, **keywords)
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/connection.py&quot;,
</I>&gt;<i> line 553, in _on_channel_close
</I>&gt;<i>    self._on_close_ready()
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/connection.py&quot;,
</I>&gt;<i> line 402, in _on_close_ready
</I>&gt;<i>    [spec.Connection.CloseOk])
</I>&gt;<i>  File &quot;/mnt/hgfs/devel/seedbank/seedbank/src/pika/connection.py&quot;,
</I>&gt;<i> line 620, in _rpc
</I>&gt;<i>    self.callbacks.add(channel_number, reply, callback)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Tue, Mar 6, 2012 at 1:13 PM, John Reuning &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">john at ibiblio.org</A>&gt; wrote:
</I>&gt;&gt;<i> In this case, lost means the consumer never gets it.  I have a test
</I>&gt;&gt;<i> setup for debugging.  Both publisher and consumer are python/pika.
</I>&gt;&gt;<i> The publisher sends 2 messages -- one is a bson encoded python string
</I>&gt;&gt;<i> of length 49144, the other is 49145.  The consumer gets the first
</I>&gt;&gt;<i> message but not the second.  It's the same behavior for messages down
</I>&gt;&gt;<i> to 1 byte and up to a few 100 KB.  The failure point seems to be at
</I>&gt;&gt;<i> this 49145 length.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Other useful information may be that queue durability and message
</I>&gt;&gt;<i> delivery mode settings don't affect the behavior.  Also, your
</I>&gt;&gt;<i> suggestion of publishing to a consumerless queue didn't result in a
</I>&gt;&gt;<i> queued message, as far as I can tell.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I'm using the management and tracing plugins, turned on tracing, and
</I>&gt;&gt;<i> turned on pika debug logging.  I can't find any errors or indication
</I>&gt;&gt;<i> of why the message disappears or where it's going.  I'm not sure I
</I>&gt;&gt;<i> know the right places to look, though.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018659.html">[rabbitmq-discuss] Lost message in 50k size range
</A></li>
	<LI>Next message: <A HREF="018627.html">[rabbitmq-discuss] Does RabbitMQ has the Message Grouping feature?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18715">[ date ]</a>
              <a href="thread.html#18715">[ thread ]</a>
              <a href="subject.html#18715">[ subject ]</a>
              <a href="author.html#18715">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
