<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Unclean shutdown followed by upgrade causes cluster to no longer come up.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unclean%20shutdown%20followed%20by%20upgrade%20causes%0A%20cluster%20to%20no%20longer%20come%20up.&In-Reply-To=%3C4F705CF6.3040408%40encoded.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019261.html">
   <LINK REL="Next"  HREF="019122.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Unclean shutdown followed by upgrade causes cluster to no longer come up.</H1>
    <B>Adam Pollock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unclean%20shutdown%20followed%20by%20upgrade%20causes%0A%20cluster%20to%20no%20longer%20come%20up.&In-Reply-To=%3C4F705CF6.3040408%40encoded.co.uk%3E"
       TITLE="[rabbitmq-discuss] Unclean shutdown followed by upgrade causes cluster to no longer come up.">a.pollock at encoded.co.uk
       </A><BR>
    <I>Mon Mar 26 13:11:34 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019261.html">[rabbitmq-discuss] |Spam| Re:Re: |Spam| question about rabbitmq TPS
</A></li>
        <LI>Next message: <A HREF="019122.html">[rabbitmq-discuss] Unclean shutdown followed by upgrade causes cluster to no longer come up.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19118">[ date ]</a>
              <a href="thread.html#19118">[ thread ]</a>
              <a href="subject.html#19118">[ subject ]</a>
              <a href="author.html#19118">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have a cluster of three nodes which are auto-configured to be clustered.  The nodes are <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node1 at mq1</A>, 
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node2 at mq2</A> and <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node3 at mq3</A>, which are a disc node and two RAM nodes respectively.  A few days ago in 
our test environment, something was powered off which caused all three machines with the nodes on to 
power off.  I decided (probably wrongly) that now was a good time to upgrade them to 2.8.1 (as there 
was a bug fix I was waiting for).  I've upgraded each node to 2.8.1, then attempted to start up the 
nodes.  Node1 started up correctly, but doesn't show any of the other nodes in the cluster status, 
even though the rabbitmq.conf file has them auto-configured.  Then, when I try to start up node2 and 
node3, they both give out the following message in /var/log/rabbit/startup_log:

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at mq2</A> /etc/rabbitmq]# cat /var/log/rabbitmq/startup_log
Activating RabbitMQ plugins ...
6 plugins activated:
* amqp_client-2.8.1
* mochiweb-1.3-rmq2.8.1-git
* rabbitmq_management-2.8.1
* rabbitmq_management_agent-2.8.1
* rabbitmq_mochiweb-2.8.1
* webmachine-1.7.0-rmq2.8.1-hg

****
Cluster upgrade needed but this is a ram node.
Please first start the last disc node to shut down.
****

It seems like nothing I do (no combination of starting, stopping, resetting, etc) can make the 
cluster come back online.  My guess is that this has to do with the ungraceful shutdown of the disc 
node, but surely there must be a way to force it back into the cluster?

Here are the auto-configuration files from each node:

node1:
[{rabbit, [{cluster_nodes, ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node1 at mq1</A>', '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node2 at mq2</A>', '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node3 at mq3</A>']}]}].

node2:
[{rabbit, [{cluster_nodes, ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node1 at mq1</A>', '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node3 at mq3</A>']}]}].

node3:
[{rabbit, [{cluster_nodes, ['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node1 at mq1</A>', '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node2 at mq2</A>']}]}].

And here is the status and cluster status output of node1:

[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at mq1</A> /etc/rabbitmq]# rabbitmqctl status
Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node1 at mq1</A> ...
[{pid,2581},
  {running_applications,
      [{rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;2.8.1&quot;},
       {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;2.8.1&quot;},
       {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;2.8.1&quot;},
       {rabbit,&quot;RabbitMQ&quot;,&quot;2.8.1&quot;},
       {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.7&quot;},
       {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.1.10&quot;},
       {rabbitmq_mochiweb,&quot;RabbitMQ Mochiweb Embedding&quot;,&quot;2.8.1&quot;},
       {webmachine,&quot;webmachine&quot;,&quot;1.7.0-rmq2.8.1-hg&quot;},
       {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;1.3-rmq2.8.1-git&quot;},
       {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.7.1&quot;},
       {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.5&quot;},
       {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.17.5&quot;},
       {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.14.5&quot;}]},
  {os,{unix,linux}},
  {erlang_version,
      &quot;Erlang R14B04 (erts-5.8.5) [source] [64-bit] [rq:1] [async-threads:30] [kernel-poll:true]\n&quot;},
  {memory,
      [{total,30333584},
       {processes,11865208},
       {processes_used,11854376},
       {system,18468376},
       {atom,1348801},
       {atom_used,1327436},
       {binary,145744},
       {code,14619638},
       {ets,1053712}]},
  {vm_memory_high_watermark,0.39999999922162066},
  {vm_memory_limit,205555302},
  {file_descriptors,
      [{total_limit,924},{total_used,3},{sockets_limit,829},{sockets_used,1}]},
  {processes,[{limit,1048576},{used,167}]},
  {run_queue,0},
  {uptime,5}]
...done.
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at mq1</A> /etc/rabbitmq]# rabbitmqctl cluster_status
Cluster status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node1 at mq1</A> ...
[{nodes,[{disc,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node1 at mq1</A>]}]},{running_nodes,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node1 at mq1</A>]}]
...done.

OS is Centos release 6.2 (Final). Upgrade of rabbitmq was from 2.7.1 to 2.8.1.

-- 
Kind regards,

Adam Pollock.
Lead Software Engineer.

Encoded, Ltd.
T: +44 (0)845 120 9790
F: +44 (0)870 830 1945
E: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">a.pollock at encoded.co.uk</A>
W: <A HREF="http://www.encoded.co.uk">http://www.encoded.co.uk</A>

</PRE>














































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019261.html">[rabbitmq-discuss] |Spam| Re:Re: |Spam| question about rabbitmq TPS
</A></li>
	<LI>Next message: <A HREF="019122.html">[rabbitmq-discuss] Unclean shutdown followed by upgrade causes cluster to no longer come up.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19118">[ date ]</a>
              <a href="thread.html#19118">[ thread ]</a>
              <a href="subject.html#19118">[ subject ]</a>
              <a href="author.html#19118">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
