<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Federated exchange slowdown
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Federated%20exchange%20slowdown&In-Reply-To=%3C4F6717BE.4070103%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018922.html">
   <LINK REL="Next"  HREF="018932.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Federated exchange slowdown</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Federated%20exchange%20slowdown&In-Reply-To=%3C4F6717BE.4070103%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Federated exchange slowdown">simon at rabbitmq.com
       </A><BR>
    <I>Mon Mar 19 11:25:50 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018922.html">[rabbitmq-discuss] Federated exchange slowdown
</A></li>
        <LI>Next message: <A HREF="018932.html">[rabbitmq-discuss] Federated exchange slowdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18930">[ date ]</a>
              <a href="thread.html#18930">[ thread ]</a>
              <a href="subject.html#18930">[ subject ]</a>
              <a href="author.html#18930">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hmm. Well, this *should* be very simple - the federation plugin is a bit 
tricky in terms of how it gets everything set up, but once the link is 
up it really just consumes and republishes the messages.

Assuming you have an even slightly fast network link I can't imagine why 
either federation queue would end up with messages backing up.

So assuming you are not network bound we could start by figuring out 
what is stopping the messages getting delivered immediately. If the 
prefetch count is 100, does that mean the queue is showing 100 messages 
unacked (i.e. the delay is happening because the federated exchange is 
not consuming fast enough), or fewer (i.e. the broker is just not 
delivering the messages for some reason)?

Cheers, Simon

On 18/03/12 11:42, Simone Busoli wrote:
&gt;<i> Following up on this issue, the problem has worsened to a great extent.
</I>&gt;<i> Here's a bit more information about the setup.
</I>&gt;<i> Two brokers B1 and B2, running version 2.7.1 and Erlang R14B04 on
</I>&gt;<i> Windows, about 15000 km away from each other. Both machines running the
</I>&gt;<i> brokers are physical machines with several cores, lots of RAM, fast
</I>&gt;<i> disks, and reported no problems in disk access, CPU or memory consumption.
</I>&gt;<i>
</I>&gt;<i> We have two federated durable topic exchanges X1 and X2, the upstream
</I>&gt;<i> connection to the other broker is configured with an hearbeat of a few
</I>&gt;<i> seconds and the prefetch count is 100. X1 is bidirectionally federated
</I>&gt;<i> with max_hops = 1 to prevent messages from going in loops (which
</I>&gt;<i> nonetheless suffer the additional roundtrip before being discarded, a
</I>&gt;<i> problem I reported a while ago), X2 unidirectionally federated from B1
</I>&gt;<i> to B2. Messages are all published on B1, all those published on X1 are
</I>&gt;<i> persistent, while those published on X2 aren't. Messages are published
</I>&gt;<i> on X1 with an average rate of 3 msg/sec, and on X2 with an average rate
</I>&gt;<i> of 10 msg/sec.
</I>&gt;<i>
</I>&gt;<i> What we experienced is that messages published on X1 queue up on the
</I>&gt;<i> outgoing queue on B1, and even worse on the outgoing queue on B2
</I>&gt;<i> (although we don't care about them as the would be discarded once
</I>&gt;<i> delivered thanks to the max_hops setting). Looking at the Web UI it
</I>&gt;<i> appears that the acknowledges for those messages come in more slowly
</I>&gt;<i> than messages are published, but I really can't understand why this
</I>&gt;<i> might be the case, given the very low publish rate. The visible effect
</I>&gt;<i> is a delay of even several minutes between when a message is published
</I>&gt;<i> on B1 and received on B2, but again, only for the low-rate messages
</I>&gt;<i> published on X1 (perhaps even worse for the other direction if the
</I>&gt;<i> messages were not thrown away by the federation because of the max_hops
</I>&gt;<i> setting, as the outgoing queue on B2 has several thousands of messages
</I>&gt;<i> versus the few hundreds of that on B1). In other words, the only
</I>&gt;<i> difference between the two federated exchanges appears to be the
</I>&gt;<i> bidirectionality of the first versus the unidirectionality of the second
</I>&gt;<i> and the fact that those published on the first are persistent.
</I>&gt;<i> The logs of the two brokers contain apparently no relevant information,
</I>&gt;<i> and the network link between the two has always appeared to be in a good
</I>&gt;<i> state.
</I>
-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018922.html">[rabbitmq-discuss] Federated exchange slowdown
</A></li>
	<LI>Next message: <A HREF="018932.html">[rabbitmq-discuss] Federated exchange slowdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18930">[ date ]</a>
              <a href="thread.html#18930">[ thread ]</a>
              <a href="subject.html#18930">[ subject ]</a>
              <a href="author.html#18930">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
