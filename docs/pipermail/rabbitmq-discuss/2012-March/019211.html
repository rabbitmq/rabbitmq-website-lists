<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Per-Connection Flow Control - RMQ 2.8.1
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Per-Connection%20Flow%20Control%20-%20RMQ%202.8.1&In-Reply-To=%3C4F730787.8050304%40aol.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019275.html">
   <LINK REL="Next"  HREF="019101.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Per-Connection Flow Control - RMQ 2.8.1</H1>
    <B>DawgTool</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Per-Connection%20Flow%20Control%20-%20RMQ%202.8.1&In-Reply-To=%3C4F730787.8050304%40aol.com%3E"
       TITLE="[rabbitmq-discuss] Per-Connection Flow Control - RMQ 2.8.1">dawgtool at aol.com
       </A><BR>
    <I>Wed Mar 28 13:43:51 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019275.html">[rabbitmq-discuss] New and Fundamental Confusion
</A></li>
        <LI>Next message: <A HREF="019101.html">[rabbitmq-discuss] Enable Plugins via Config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19211">[ date ]</a>
              <a href="thread.html#19211">[ thread ]</a>
              <a href="subject.html#19211">[ subject ]</a>
              <a href="author.html#19211">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simon,

Thanks for looking into this.  This is a really large project which we 
will be scaling to handle ~300k msg/sec, right now 2.7.1 is running at 
90k msg/sec.

Here is my Configuration (UAT): (2 servers)
x4: Intel(R) Xeon(R) CPU X5650  @ 2.67GHz
x1: MemTotal:  16777216 kB

Number of publishers: 20
Testing with TTL only, No consumers (testing for durability during 
maintenance windows on consumers)
Publishing Rate: 100 - 350 messages/sec per publisher (ie: 100 x 20 = 
2000) to app.publish exchange
x-message-ttl at 10000 should cause flow control to block every second 
to 10 seconds
x-message-ttl at 60000 should cause flow control to block every second 
to 10 seconds, as queue reaches ~1gB expiring will lock the queue and 
everything will block for several minutes.


==&gt; *rabbitmq status* &lt;==
Linux 2.6.18-238.el5xen #1 SMP Thu Jan 13 16:41:45 EST 2011 x86_64 
x86_64 x86_64 GNU/Linux (CentOS 5)

Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at dc001</A>' ...
[{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at dc002</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at dc001</A>']}]},
  {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at dc002</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at dc001</A>']}]
...done.

Status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at dc001</A>' ...
[{pid,26253},
  {running_applications,
      [{rabbitmq_management,&quot;RabbitMQ Management Console&quot;,&quot;2.8.1&quot;},
       {rabbitmq_management_agent,&quot;RabbitMQ Management Agent&quot;,&quot;2.8.1&quot;},
       {amqp_client,&quot;RabbitMQ AMQP Client&quot;,&quot;2.8.1&quot;},
       {rabbit,&quot;RabbitMQ&quot;,&quot;2.8.1&quot;},
       {mnesia,&quot;MNESIA  CXC 138 12&quot;,&quot;4.6&quot;},
       {os_mon,&quot;CPO  CXC 138 46&quot;,&quot;2.2.8&quot;},
       {sasl,&quot;SASL  CXC 138 11&quot;,&quot;2.2&quot;},
       {rabbitmq_mochiweb,&quot;RabbitMQ Mochiweb Embedding&quot;,&quot;2.8.1&quot;},
       {webmachine,&quot;webmachine&quot;,&quot;1.7.0-rmq2.8.1-hg&quot;},
       {mochiweb,&quot;MochiMedia Web Server&quot;,&quot;1.3-rmq2.8.1-git&quot;},
       {inets,&quot;INETS  CXC 138 49&quot;,&quot;5.8&quot;},
       {stdlib,&quot;ERTS  CXC 138 10&quot;,&quot;1.18&quot;},
       {kernel,&quot;ERTS  CXC 138 10&quot;,&quot;2.15&quot;}]},
  {os,{unix,linux}},
  {erlang_version,
      &quot;Erlang R15B (erts-5.9) [source] [64-bit] [smp:4:4] 
[async-threads:30] [hipe] [kernel-poll:true]\n&quot;},
  {memory,
      [{total,485192568},
       {processes,303500420},
       {processes_used,303400224},
       {system,181692148},
       {atom,711569},
       {atom_used,701087},
       {binary,158312632},
       {code,17241165},
       {ets,1651976}]},
  {vm_memory_high_watermark,0.3999999999650754},
  {vm_memory_limit,6871947673},
  {file_descriptors,
      [{total_limit,924},
       {total_used,23},
       {sockets_limit,829},
       {sockets_used,21}]},
  {processes,[{limit,1048576},{used,378}]},
  {run_queue,26},
  {uptime,32423}]
...done.


==&gt; rabbitmq-cfg.dc001.config &lt;==
[
   {rabbit,                    [{tcp_listeners,               [60001]},
                                {vm_memory_high_watermark,    0.4    },
                                {collect_statistics,          fine   },
                                {collect_statistics_interval, 5000   },
                                {hipe_compile,                true   }
                               ]
   },
   {mnesia,                    [{dc_dump_limit,            40   },
                                {dump_log_write_threshold, 50000},
                                {no_table_loaders,         1    },
                                {send_compressed,          9    },
                                {snmp,                     true }
                               ]
   },
   {rabbitmq_management,       [{http_log_dir,     
&quot;/data/rabbitmq/dc001/rabbit-mgmt&quot; },
                                {load_definitions, 
&quot;/etc/rabbitmq/rabbitmq-mgt.dc001.json&quot;}
                               ]
   },
   {rabbitmq_management_agent, [ {force_fine_statistics, true} ] },
   {rabbitmq_mochiweb,
                               [{listeners,
                                            [{'*',  [{port, 61001}]},
                                             {mgmt, [{port, 62001}]}
                                            ]
                               }]
   }
].

==&gt; rabbitmq-env.dc001.conf &lt;==
NODENAME=dc001
BASE=/data/rabbitmq/dc001
LOG_BASE=/data/rabbitmq/dc001/log
MNESIA_BASE=/data/rabbitmq/dc001/mnesia
CONFIG_FILE=/etc/rabbitmq/rabbitmq-cfg.dc001
SERVER_START_ARGS=&quot;+K true -smp enable&quot;
ENABLED_PLUGINS_FILE=/etc/rabbitmq/rabbitmq-plg.dc001.conf

==&gt; rabbitmq-mgt.dc001.json &lt;==
{
&quot;rabbit_version&quot;:&quot;2.8.1&quot;,
&quot;users&quot;:
   [
     {&quot;name&quot;:&quot;guest&quot;,     
&quot;password_hash&quot;:&quot;**secret**&quot;,&quot;tags&quot;:&quot;administrator&quot;     },
     {&quot;name&quot;:&quot;appadmin&quot;, &quot;password_hash&quot;:&quot;**secret**&quot;,&quot;tags&quot;:&quot;app 
administrator&quot;},
     {&quot;name&quot;:&quot;appwriter&quot;,&quot;password_hash&quot;:&quot;**secret**&quot;,&quot;tags&quot;:&quot;app 
write-only&quot;   },
     {&quot;name&quot;:&quot;appreader&quot;,&quot;password_hash&quot;:&quot;**secret**&quot;,&quot;tags&quot;:&quot;app 
read-only&quot;    }
    ],
&quot;vhosts&quot;:
   [
     {&quot;name&quot;:&quot;/&quot;},
     {&quot;name&quot;:&quot;app&quot;}
   ],
&quot;permissions&quot;:
   [
     {&quot;user&quot;:&quot;guest&quot;,     
&quot;vhost&quot;:&quot;app&quot;,&quot;configure&quot;:&quot;.*&quot;,&quot;write&quot;:&quot;.*&quot;,&quot;read&quot;:&quot;.*&quot;},
     {&quot;user&quot;:&quot;guest&quot;,     &quot;vhost&quot;:&quot;/&quot;,   
&quot;configure&quot;:&quot;.*&quot;,&quot;write&quot;:&quot;.*&quot;,&quot;read&quot;:&quot;.*&quot;},
     {&quot;user&quot;:&quot;appadmin&quot;, 
&quot;vhost&quot;:&quot;app&quot;,&quot;configure&quot;:&quot;.*&quot;,&quot;write&quot;:&quot;.*&quot;,&quot;read&quot;:&quot;.*&quot;},
     {&quot;user&quot;:&quot;appwriter&quot;,&quot;vhost&quot;:&quot;app&quot;,&quot;configure&quot;:&quot;&quot;,  
&quot;write&quot;:&quot;.*&quot;,&quot;read&quot;:&quot;&quot;  },
     {&quot;user&quot;:&quot;appreader&quot;,&quot;vhost&quot;:&quot;app&quot;,&quot;configure&quot;:&quot;&quot;,  &quot;write&quot;:&quot;&quot;,  
&quot;read&quot;:&quot;.*&quot;}
   ],
&quot;queues&quot;:
   [
     
{&quot;name&quot;:&quot;app.noroute.all&quot;,&quot;vhost&quot;:&quot;app&quot;,&quot;durable&quot;:true,&quot;auto_delete&quot;:false,&quot;arguments&quot;:{&quot;x-message-ttl&quot;:360000,&quot;x-ha-policy&quot;:&quot;all&quot;}},
     {&quot;name&quot;:&quot;app.q01.all&quot;,    
&quot;vhost&quot;:&quot;app&quot;,&quot;durable&quot;:true,&quot;auto_delete&quot;:false,&quot;arguments&quot;:{&quot;x-message-ttl&quot;:10000, 
&quot;x-ha-policy&quot;:&quot;all&quot;}},
     {&quot;name&quot;:&quot;app.q02.all&quot;,    
&quot;vhost&quot;:&quot;app&quot;,&quot;durable&quot;:true,&quot;auto_delete&quot;:false,&quot;arguments&quot;:{&quot;x-message-ttl&quot;:10000, 
&quot;x-ha-policy&quot;:&quot;all&quot;}}
   ],
&quot;exchanges&quot;:
   [
     {&quot;name&quot;:&quot;app.publish&quot;,&quot;vhost&quot;:&quot;app&quot;,&quot;type&quot;:&quot;topic&quot;, 
&quot;durable&quot;:true,&quot;auto_delete&quot;:false,&quot;internal&quot;:false,&quot;arguments&quot;:{&quot;alternate-exchange&quot;:&quot;app.fanout&quot;}},
     {&quot;name&quot;:&quot;app.fanout&quot;, 
&quot;vhost&quot;:&quot;app&quot;,&quot;type&quot;:&quot;fanout&quot;,&quot;durable&quot;:true,&quot;auto_delete&quot;:false,&quot;internal&quot;:true, 
&quot;arguments&quot;:{}                                  }
   ],
&quot;bindings&quot;:
   [
     {&quot;source&quot;:&quot;app.fanout&quot;, 
&quot;vhost&quot;:&quot;app&quot;,&quot;destination&quot;:&quot;app.noroute.all&quot;,&quot;destination_type&quot;:&quot;queue&quot;,&quot;routing_key&quot;:&quot;&quot;,      
&quot;arguments&quot;:{}},
     
{&quot;source&quot;:&quot;app.publish&quot;,&quot;vhost&quot;:&quot;app&quot;,&quot;destination&quot;:&quot;app.q01.all&quot;,    
&quot;destination_type&quot;:&quot;queue&quot;,&quot;routing_key&quot;:&quot;q01.#&quot;,&quot;arguments&quot;:{}},
     
{&quot;source&quot;:&quot;app.publish&quot;,&quot;vhost&quot;:&quot;app&quot;,&quot;destination&quot;:&quot;app.q02.all&quot;,    
&quot;destination_type&quot;:&quot;queue&quot;,&quot;routing_key&quot;:&quot;q02.#&quot;,&quot;arguments&quot;:{}}
   ]
}


==&gt; rabbitmq-plg.dc001.conf &lt;==
[rabbitmq_management,rabbitmq_management_agent].


==&gt; *record example* &lt;==
Timestamp, Message_id, Delivery Mode, etc. set by the publisher.

Routing Key:      q01.abc.123.1025819054.1
Timestamp:        1332936969243454
Message_id:       648926607241636355
Delivery_mode:    1
Content_encoding: en_US.UTF-8
content_type:     application/octet-stream
Payload:          348 bytes
6Np6696Kw66666/To666R66S66W86pol3W66w6t66S646266666666Q666P4666Q6+66t6t6666n66/n669w666666/66rQt6766rTL06O/6626m662T7T4Qq6016W66QL6666OL66S56P6Orp3s666+6/6666666l666L0K0nQ64Q6n6s+6m66M86kT666M666321T6S6PR946Q66KO66666+s6o664K63T6W665066666n24p66+pMT66663t666n/4o606q67N6K6T7116mLS66676K66T666666O+6q8666r6666m68rQ666k668mm66p66W6l/QlmKW66666966666=




On 3/28/12 6:32 AM, Simon MacMullen wrote:
&gt;<i> On 28/03/12 04:20, DawgTool wrote:
</I>&gt;&gt;<i> The Flow-Control in 2.8.1 has been a huge failure for my UAT systems.
</I>&gt;<i>
</I>&gt;<i> Hi. Sorry to hear that. Obviously our testing hasn't shown any of the 
</I>&gt;<i> issues you raise. I'll try to reproduce your issues as best I can but 
</I>&gt;<i> the more information we have, the better. So just to be clear, you have:
</I>&gt;<i>
</I>&gt;<i> * Clustering
</I>&gt;<i> * Non-persistent messages
</I>&gt;<i> * Queues with x-message-ttl set (and a large number of messages 
</I>&gt;<i> actually expiring, by the sound of it?)
</I>&gt;<i> * Large queues
</I>&gt;<i> * Some HA queues
</I>&gt;<i>
</I>&gt;<i> I will try to reproduce based on the above, but anything else you can 
</I>&gt;<i> tell me would be a great help.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019275.html">[rabbitmq-discuss] New and Fundamental Confusion
</A></li>
	<LI>Next message: <A HREF="019101.html">[rabbitmq-discuss] Enable Plugins via Config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19211">[ date ]</a>
              <a href="thread.html#19211">[ thread ]</a>
              <a href="subject.html#19211">[ subject ]</a>
              <a href="author.html#19211">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
