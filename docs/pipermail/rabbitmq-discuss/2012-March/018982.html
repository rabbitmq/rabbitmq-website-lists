<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Active consumers in declare-ok is less than the actual number of consumers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active%20consumers%20in%20declare-ok%20is%20less%20than%0A%20the%20actual%20number%20of%20consumers&In-Reply-To=%3CCAPeHLwb-hYXFWJEvO83yNk0FsGucPazEHQwu-hdPDW1v9D%3Dy7A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018974.html">
   <LINK REL="Next"  HREF="018965.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Active consumers in declare-ok is less than the actual number of consumers</H1>
    <B>Gerolf Seitz</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Active%20consumers%20in%20declare-ok%20is%20less%20than%0A%20the%20actual%20number%20of%20consumers&In-Reply-To=%3CCAPeHLwb-hYXFWJEvO83yNk0FsGucPazEHQwu-hdPDW1v9D%3Dy7A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Active consumers in declare-ok is less than the actual number of consumers">gerolf.seitz at gmail.com
       </A><BR>
    <I>Tue Mar 20 13:17:35 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018974.html">[rabbitmq-discuss] Active consumers in declare-ok is less than the	actual number of consumers
</A></li>
        <LI>Next message: <A HREF="018965.html">[rabbitmq-discuss] SuSE: 2.8.0 start script uses 'runuser'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18982">[ date ]</a>
              <a href="thread.html#18982">[ thread ]</a>
              <a href="subject.html#18982">[ subject ]</a>
              <a href="author.html#18982">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Mar 20, 2012 at 12:17 PM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;wrote:

&gt;<i> On 20/03/12 06:43, Gerolf Seitz wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> When passively declaring a queue, the returned consumer count is not the
</I>&gt;&gt;<i> same as the consumer count via the management plugin / http API. Turns
</I>&gt;&gt;<i> out, rabbitmq returns the number of consumers that are ready to receive
</I>&gt;&gt;<i> a message.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As an example: there are 5 (manually acknowledging) consumers, 3 of
</I>&gt;&gt;<i> which have consumed a message from the queue, but have not sent an ACK
</I>&gt;&gt;<i> for the respective messages to the broker. Declaring a queue now returns
</I>&gt;&gt;<i> a declare-ok with consumer-count == 2, whereas I would have expected it
</I>&gt;&gt;<i> to be 5.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Looking at the rabbitmq-server code reveals that the &quot;active consumer&quot;
</I>&gt;&gt;<i> part of the state is used for getting the next consumer for round robin
</I>&gt;&gt;<i> delivery and returning the number of consumers as part of the declare-ok
</I>&gt;&gt;<i> message.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Since I don't suspect this to be an oversight but rather a conscious
</I>&gt;&gt;<i> decision, I'm interested in the rationale behind it. I'm aware that
</I>&gt;&gt;<i> changing the semantics at this point is probably not possible and I may
</I>&gt;&gt;<i> have to resort to fetching the consumer count via the http api (which
</I>&gt;&gt;<i> brings some organizational overhead).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can anybody shed some light on this?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hi Gerolf.
</I>&gt;<i>
</I>&gt;<i> Yes, this is deliberate. Code archaeology yielded this:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://hg.rabbitmq.com/**rabbitmq-server/rev/**32e357ad03d6&lt;http://hg.rabbitmq.com/rabbitmq-server/rev/32e357ad03d6">http://hg.rabbitmq.com/**rabbitmq-server/rev/**32e357ad03d6&lt;http://hg.rabbitmq.com/rabbitmq-server/rev/32e357ad03d6</A>&gt;
</I>&gt;<i>
</I>&gt;<i> &quot;count queue consumers as required by the spec&quot;.
</I>&gt;<i>
</I>&gt;<i> The spec actually says:
</I>&gt;<i>
</I>&gt;<i>    Reports the number of active consumers for the queue. Note that
</I>&gt;<i>    consumers can  suspend activity (Channel.Flow) in which case they
</I>&gt;<i>    do not appear in this count.
</I>&gt;<i>
</I>&gt;<i> So that is slightly ambiguous - we are excluding consumers that have
</I>&gt;<i> issued channel.flow, but also those which are blocked due to qos / ack
</I>&gt;<i> interaction. But those could easily be defined as &quot;inactive&quot;...
</I>&gt;<i>
</I>&gt;<i> Hmm. I'll have a think about this. What are you trying to do?
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, VMware
</I>&gt;<i>
</I>
The reply-to-author setting of rabbitmq-discuss screwed me ;)



Hi,

The use case is this:

We have a pool of consumers (each running in a heavy weight process) that
can only process a single unit of work at a time each.
The messages that are sent to these consumers contain data that can become
&quot;old&quot; quite quickly (think stock ticks), so queuing hundreds of messages is
not an option.
Also, these consumers need to be kept busy all the time: as soon as a unit
of work is done, the next task will be submitted and picked up by the free
consumer. (prefetch=1, autoack=false).

Based on the number of consumers, the system decides which unit of work is
sent next, mostly based on the previous time the unit of work took to
complete.

Example:
7 consumers overall
Per configuration, only up to 4 consumers may be used to process really
long running tasks (eg. &gt;1 minute task duration)
The rest of the consumers is used for short running tasks. (eg. &lt;1 minute)

The reason why we don't have 2 different queues is twofold:
1) if there are no long running tasks to be executed, all consumers should
be used for short running tasks
2) the decision whether a task is short or long running is made by the
system that sends the messages to the broker and the decision process can
be tweaked via configuration. This is easier to manipulate than
reconfiguring and restarting the heavy weight consumer processes.

I hope this clears it up a bit ;)

Cheers


-- 
Gerolf Seitz

twitter: @gersei
code: github.com/gseitz
blog: www.gerolfseitz.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120320/e98dbf24/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120320/e98dbf24/attachment.htm</A>&gt;
</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018974.html">[rabbitmq-discuss] Active consumers in declare-ok is less than the	actual number of consumers
</A></li>
	<LI>Next message: <A HREF="018965.html">[rabbitmq-discuss] SuSE: 2.8.0 start script uses 'runuser'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18982">[ date ]</a>
              <a href="thread.html#18982">[ thread ]</a>
              <a href="subject.html#18982">[ subject ]</a>
              <a href="author.html#18982">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
