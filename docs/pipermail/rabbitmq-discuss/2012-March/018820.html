<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Puka client and publisher confirms	performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Puka%20client%20and%20publisher%20confirms%0A%09performance&In-Reply-To=%3CCABzX%2BqySDN0foiff86v_PYm_H4D5dfqQK7y7seydQV23G94BYg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018815.html">
   <LINK REL="Next"  HREF="018821.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Puka client and publisher confirms	performance</H1>
    <B>Marek Majkowski</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Puka%20client%20and%20publisher%20confirms%0A%09performance&In-Reply-To=%3CCABzX%2BqySDN0foiff86v_PYm_H4D5dfqQK7y7seydQV23G94BYg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Puka client and publisher confirms	performance">majek04 at gmail.com
       </A><BR>
    <I>Wed Mar 14 13:14:12 GMT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="018815.html">[rabbitmq-discuss] Puka client and publisher confirms performance
</A></li>
        <LI>Next message: <A HREF="018821.html">[rabbitmq-discuss] Puka client and publisher confirms	performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18820">[ date ]</a>
              <a href="thread.html#18820">[ thread ]</a>
              <a href="subject.html#18820">[ subject ]</a>
              <a href="author.html#18820">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Mar 14, 2012 at 12:31, Christos Stavrakakis
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">stavr.chris at gmail.com</A>&gt; wrote:
&gt;<i> I am using Puka client [1] in order to send messages with guaranteed
</I>&gt;<i> delivery using publisher confirms.
</I>&gt;<i>
</I>&gt;<i> Trying to send 200.000 messages I see that waiting for the confirms, takes a
</I>&gt;<i> lot of time.
</I>&gt;<i>
</I>&gt;<i> To be more specific:
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; promises = []
</I>&gt;<i> &#160;&#160;&#160; t0 = time.time()
</I>&gt;<i> &#160;&#160;&#160; for i in range(0,200000):
</I>&gt;<i> &#160;&#160;&#160; &#160;&#160;&#160; promise = client.basic_publish(exchange='test_exchange',
</I>&gt;<i> routing_key='test',
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; body=&quot;Hello
</I>&gt;<i> world!&quot;)
</I>&gt;<i> &#160;&#160;&#160; &#160;&#160;&#160; promises.append(promise)
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; t1 = time.time()
</I>&gt;<i> &#160;&#160;&#160; client.wait(promises)
</I>&gt;<i> &#160;&#160;&#160; t2 = time.time()
</I>&gt;<i> &#160;&#160;&#160; promise = client.close()
</I>&gt;<i> &#160;&#160;&#160; client.wait(promise)
</I>&gt;<i>
</I>&gt;<i> In this example t1-t0 is arround 9s while t2-t1 is more than 100 seconds!!
</I>&gt;<i> Increasing the number of messages results in even worse performance.
</I>&gt;<i>
</I>&gt;<i> Can anyone explain this behavior ? Is there a more effective way to use
</I>&gt;<i> publisher confirms ?
</I>
Chris,

It's very cool that you found Puka useful!

Puka does some magic under the hood to track publisher confirms.

First, do make sure you're using publiser confirms, please
add pubacks=True parameter to the Client:

   <A HREF="https://github.com/majek/puka/blob/master/puka/connection.py#L24">https://github.com/majek/puka/blob/master/puka/connection.py#L24</A>

(or make sure otherwise that you are using pubacks, there
 should be a property on the client object somewhere....)

Second, here's what I'm doing for performance in the stress_amqp.py example:
<A HREF="https://github.com/majek/puka/blob/master/examples/stress_amqp.py#L54-57">https://github.com/majek/puka/blob/master/examples/stress_amqp.py#L54-57</A>

Basically, I'm just making sure the last message went through. This
should give you a reasonable confidence that previous messages
also were delivered.

Finally, it would be nice to identify what is the performance bottleneck
for the code snippet you supplied. It is possible that there's a stupid
performance issue within Puka.

Cheers,
  Marek
</PRE>











































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018815.html">[rabbitmq-discuss] Puka client and publisher confirms performance
</A></li>
	<LI>Next message: <A HREF="018821.html">[rabbitmq-discuss] Puka client and publisher confirms	performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18820">[ date ]</a>
              <a href="thread.html#18820">[ thread ]</a>
              <a href="subject.html#18820">[ subject ]</a>
              <a href="author.html#18820">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
