<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Testing Shovel on a WAN
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Testing%20Shovel%20on%20a%20WAN&In-Reply-To=%3CC3481B5CE3E61E438EEF6143B51DC17F66A0C7D19B%40Y000IIIV01.rd1.rf1%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019239.html">
   <LINK REL="Next"  HREF="019298.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Testing Shovel on a WAN</H1>
    <B>MELIQUE Denis (MORPHO)</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Testing%20Shovel%20on%20a%20WAN&In-Reply-To=%3CC3481B5CE3E61E438EEF6143B51DC17F66A0C7D19B%40Y000IIIV01.rd1.rf1%3E"
       TITLE="[rabbitmq-discuss] Testing Shovel on a WAN">denis.melique at morpho.com
       </A><BR>
    <I>Fri Mar 30 15:50:03 BST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="019239.html">[rabbitmq-discuss] Testing Shovel on a WAN
</A></li>
        <LI>Next message: <A HREF="019298.html">[rabbitmq-discuss] Testing Shovel on a WAN
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19297">[ date ]</a>
              <a href="thread.html#19297">[ thread ]</a>
              <a href="subject.html#19297">[ subject ]</a>
              <a href="author.html#19297">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi 

To investigate this I set a small client in Python (spy.py) which subscribed the same exchange as my application, and 
traces some information from messages properties (code attached).
Before starting my test I run one spy.py on each end.
At the end of test I compare both information, to see if
there is a difference in the message_id sequences, or if messages have been redelivered.

I did a test first with the local broker clustered (as before):
- then I have a different sequence in messages
- but there is no redelivered messages 

Then I suspected that my problem could be in relation with the cluster configuration (why not), 
So I reconfigured the local end with a single node (no more cluster), leaving the remote end clustered.
- then I could not reproduce the difference in message_id sequences


May be I did something wrong when configuring Shovel with my local cluster ?
What I did is : 
- set a two node cluster on local end
- Have the Shovel plug-In configured on both nodes
  Each node has its one Shovel setting, with similar parameters except &quot;sources [broker..]&quot; and &quot;destinations [broker...]&quot;, 
  That are specific to the node. 
  On each node I have defined one source broker and one destination broker.
  
- set a two node cluster on remote end, without Shovel setting.

I am wondering if this is correct with clusters ?

However, everything is working fine, when the WAN network is good enough.

Any Idea ?

Thank's a lot.

Denis

-----Original Message-----
From: Simon MacMullen [mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>] 
Sent: Wednesday, March 28, 2012 5:57 PM
To: MELIQUE Denis (MORPHO)
Cc: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Subject: Re: [rabbitmq-discuss] Testing Shovel on a WAN

On 28/03/12 14:47, MELIQUE Denis (MORPHO) wrote:
&gt;<i> When I slow the WAN to 1 Mbit/s, I see messages accumulating in the
</I>&gt;<i> shovel queue, which is what as expected.
</I>&gt;<i>
</I>&gt;<i> Then once my throughput go to zero, messages are slowly transferred to
</I>&gt;<i> the distant cluster, and that&#8217;s OK as well.
</I>&gt;<i>
</I>&gt;<i> The problem is that messages are not processed in the same order on the
</I>&gt;<i> distant cluster than on the local.
</I>&gt;<i>
</I>&gt;<i> My feeling is that with 1 Mbit/s some messages fail to be transferred
</I>&gt;<i> correctly, and are re-sent later.
</I>&gt;<i>
</I>&gt;<i> ( I have the same problem when I simulate a very high level of packet
</I>&gt;<i> loss (30%), with a 10Mbit/s speed)
</I>&gt;<i>
</I>&gt;<i> Is there such a logic in Shovel ?
</I>
That seems unlikely. Packet loss should lead to redelivery at the TCP 
level, which the shovel should be unaware of.

Messages should only get redelivered if the consumer rejects them or the 
TCP connection is interrupted completely. Shovel won't reject messages, 
but maybe the connection is being interrupted and re-established? You 
should be able to see this in the logs. You would also see a 
&quot;redelivered&quot; message rate in mgmt.

&gt;<i> Is there a way to configured Shovel to guaranty the sequence of messages ?
</I>
This should already be happening.

&gt;<i> Second:
</I>&gt;<i>
</I>&gt;<i> ---------
</I>&gt;<i>
</I>&gt;<i> When a simulate a WAN outage lasting 2 hours, messages staying in the
</I>&gt;<i> shovel queue have a status,
</I>&gt;<i>
</I>&gt;<i> first set to &#8220;unacknowledged&#8221;.
</I>&gt;<i>
</I>&gt;<i> Then, after about 900 sec, they all have their status changed to &#8220;ready&#8221;.
</I>&gt;<i>
</I>&gt;<i> When the network recovers, all the pending messages change back to
</I>&gt;<i> &#8220;unacknowledged&#8221;, before being sent
</I>&gt;<i>
</I>&gt;<i> to the distant cluster.
</I>&gt;<i>
</I>&gt;<i> It does not seems to be a problem for us, just I&#8217;d like to understand
</I>&gt;<i> this behavior, and if it could impact rabbit performances.
</I>
unacknowledged -&gt; the message has been consumed by the remote end, but 
not acknowledged.

After 900 seconds presumably the connection is determined to be dead by 
RabbitMQ and then the messages go back into the queue (&quot;ready&quot;).

Then when the network recovers, they are sent again and become 
&quot;unacknowledged&quot; again, until the acks come in.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, VMware
#
&quot; Ce courriel et les documents qui lui sont joints peuvent contenir des informations confidentielles ou ayant un caract&#232;re priv&#233;. S'ils ne vous sont pas destin&#233;s, nous vous signalons qu'il est strictement interdit de les divulguer, de les reproduire ou d'en utiliser de quelque mani&#232;re que ce soit le contenu. Si ce message vous a &#233;t&#233; transmis par erreur, merci d'en informer l'exp&#233;diteur et de supprimer imm&#233;diatement de votre syst&#232;me informatique ce courriel ainsi que tous les documents qui y sont attach&#233;s.&quot;
******
&quot; This e-mail and any attached documents may contain confidential or proprietary information. If you are not the intended recipient, you are notified that any dissemination, copying of this e-mail and any attachments thereto or use of their contents by any means whatsoever is strictly prohibited. If you have received this e-mail in error, please advise the sender immediately and delete this e-mail and all attached documents from your computer system.&quot;
#
-------------- next part --------------
A non-text attachment was scrubbed...
Name: spy.py
Type: application/octet-stream
Size: 6425 bytes
Desc: spy.py
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120330/e040b8e6/attachment.obj">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20120330/e040b8e6/attachment.obj</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019239.html">[rabbitmq-discuss] Testing Shovel on a WAN
</A></li>
	<LI>Next message: <A HREF="019298.html">[rabbitmq-discuss] Testing Shovel on a WAN
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19297">[ date ]</a>
              <a href="thread.html#19297">[ thread ]</a>
              <a href="subject.html#19297">[ subject ]</a>
              <a href="author.html#19297">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
