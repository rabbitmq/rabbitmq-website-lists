<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ Stability Issues with large queue -	2011-12-28
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Stability%20Issues%20with%20large%20queue%20-%0A%092011-12-28&In-Reply-To=%3C6FEDEAFD-03B8-4D55-A4D6-D4F4268E715B%40aol.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017045.html">
   <LINK REL="Next"  HREF="017049.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ Stability Issues with large queue -	2011-12-28</H1>
    <B>DawgTool</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20Stability%20Issues%20with%20large%20queue%20-%0A%092011-12-28&In-Reply-To=%3C6FEDEAFD-03B8-4D55-A4D6-D4F4268E715B%40aol.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ Stability Issues with large queue -	2011-12-28">dawgtool at aol.com
       </A><BR>
    <I>Wed Dec 28 14:22:55 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="017045.html">[rabbitmq-discuss] Priority Queue
</A></li>
        <LI>Next message: <A HREF="017049.html">[rabbitmq-discuss] RabbitMQ Stability Issues with large queue -	2011-12-28
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17041">[ date ]</a>
              <a href="thread.html#17041">[ thread ]</a>
              <a href="subject.html#17041">[ subject ]</a>
              <a href="author.html#17041">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>RabbitMQ Stability Issues with large queue - 2011-12-28

Hi All,

I posted in the IRC channel a few nights ago, and they suggested that I bring this to the listserv.
Hopefully can get some suggestions on how to keep my servers from crashing.
Thanks,
-- DawgTool

Cluster Info:
Cluster status of node '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m01</A>' ...
[{nodes,[{disc,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m04</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m03</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m02</A>',
                '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m01</A>']}]},
 {running_nodes,['<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m04</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m03</A>','<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m02</A>',
                 '<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">dc001 at rmquat-m01</A>']}]

Config Info:
==&gt; enabled_plugins &lt;==
[rabbitmq_management,rabbitmq_management_agent,rabbitmq_management_visualiser].

==&gt; rabbitmq.config &lt;==
[
  {rabbit,                    [{vm_memory_high_watermark, 0.6},
                               {collect_statistics_interval, 5000},
                               {hipe_compile, true}
                              ]
  },
  {rabbitmq_management,       [ {http_log_dir, &quot;/data/rabbitmq/dc001/rabbit-mgmt&quot;} ] },
  {rabbitmq_management_agent, [ {force_fine_statistics, true} ] }
].

==&gt; rabbitmq-env.conf &lt;==
NODENAME=dc001
BASE=/data/rabbitmq/dc001
MNESIA_BASE=/data/rabbitmq/dc001/mnesia
LOG_BASE=/data/rabbitmq/dc001/log
SERVER_START_ARGS=&quot;-smp enable&quot;


IRC:
[17:32] &lt;dawgtool&gt; background. doing some testing on 2.7.0 : 4 servers 2vcpu, 8gb ram, 80gb disc.
[17:32] &lt;dawgtool&gt; cluser is setup all disc, currently one exchange durable fanout
[17:33] &lt;dawgtool&gt; one queue also durable bind to the exchange.
[17:33] &lt;dawgtool&gt; i'm pushing about 5M records, payload is ~500bytes each record
[17:34] &lt;dawgtool&gt; rate is about 14k/s (which seems pretty slow)
[17:35] &lt;dawgtool&gt; but my problem is, I'm testing a case where they consumers are busy or unavailable, so the queues would be filling up.
[17:35] &lt;dawgtool&gt; even after slowing the publish rate to about 4k/s the mirrored queue does not complete on any of the clusters nodes other then master.
[17:37] &lt;dawgtool&gt; memory seems to be the biggest issue here, as the servers will grow passed the high water mark, and eventually crash one at a time.
[17:37] &lt;dawgtool&gt; once they are restarted, most servers in the cluster will have about 200k to 300k of messages in their queue
[17:40] &lt;dawgtool&gt; so question is, why is so much memory being consumed (on disk these records are about 5.5GB) RabbitMQ pushes to 7.9 real, 11.9 virtual (swapping).
[17:40] &lt;dawgtool&gt; why is the queue not stopping the publishers (RAM based clusters seem to stop the publisher until it can be spilled to disk)
[17:41] &lt;dawgtool&gt; Why is mirroring unreliable in this test.
[17:41] &lt;dawgtool&gt; ok, i'm done with the backgroud. =)
[17:41] &lt;dawgtool&gt; lol
[17:42] &lt;antares_&gt; having 300K messages in one queue will result in RAM consumption like this
[17:42] &lt;antares_&gt; 30 queues with 10K is a better option
[17:43] &lt;antares_&gt; I can't say for mirroring but my understanding is that mirroring cannot decrease RAM usage
[17:43] &lt;dawgtool&gt; true, i need to make sure I don't loose any records, so disc with mirror
[17:44] &lt;dawgtool&gt; does performance get that bad after 300k message in a queue?
[17:44] &lt;antares_&gt; this kind of questions is better asked on the rabbitmq-discuss (mailing list)
[17:45] &lt;antares_&gt; the exact number will vary but yes, having queues with excessive # of messages that are not consumed will result in more or less this behavior
[17:45] &lt;dawgtool&gt; yea, just joined the mailing list, I can post it there. was hoping someone had a quick answer. =)
[17:45] &lt;antares_&gt; each queue is backed by one Erlang process and Erlang VM GC releases process memory all at once
[17:46] &lt;dawgtool&gt; even with the -smp set to true?
[17:46] &lt;antares_&gt; so having large amount of messages in your queues impedes that
[17:46] &lt;antares_&gt; dawgtool: I doubt that -smp affects GC behavior
[17:46] &lt;dawgtool&gt; hmmm
[17:47] &lt;antares_&gt; in this regard anyway, because there is still no shared heap
[17:47] &lt;antares_&gt; but rabbitmq team members definitely know more than I do
[17:47] &lt;antares_&gt; and they are all on rabbitmq-discuss
[17:48] &lt;dawgtool&gt; ok, I'll give the mailing list a shot.  300k is going to be hard to live under, one of my current systems is  doing server times that a second. =(
[17:49] &lt;dawgtool&gt; which i was hoping to migrate to a more open system, at least parts of it. =(
[17:49] &lt;antares_&gt; dawgtool: total # of messages is not the point
[17:50] &lt;antares_&gt; the point is max # of messages in one queue
[17:50] &lt;antares_&gt; you can have 10K queues and one app consuming messages from them all
[17:50] &lt;antares_&gt; unless ordering is a serious concern for your case, it will work just as well as 1 queue
[17:50] &lt;dawgtool&gt; yea, understand, but some consumers might crash, and I will get a backlog
[17:51] &lt;dawgtool&gt; I need to make sure the MQ system can handle at least a 30 minute outage
[17:51] &lt;antares_&gt; again, you will have the same problem with just 1 queue
[17:51] &lt;antares_&gt; dawgtool: I see. And not lose anything?
[17:51] &lt;dawgtool&gt; right, =(
[17:51] &lt;antares_&gt; rabbitmq queues can have message TTL
[17:52] &lt;dawgtool&gt; yea, I have TTL on metric collection consumers.. usually 6 seconds.
[17:55] &lt;dawgtool&gt; in production, the idea would be to have two exchanges: input.exchange.fanout, metric.exchange.topic bind to input.exchange.fanout. queue.durable.mirror.prod bind to input.exchange.fanout no ttl, several queue.trans.nomirror.metric[1-x] ttl 6sec.
[17:56] &lt;dawgtool&gt; the input.exchange.fanout will have a second and third queue eventually, which is why there are two exchanges.
[17:57] &lt;dawgtool&gt; but the second and third will have a 30min ttl
[18:01] &lt;dawgtool&gt; anyway, thanks for the info.. I'll shot an email out to the listserv and see if I get any bites. =)
[18:01] &lt;dawgtool&gt; thanks again. =)
[18:01] &lt;antares_&gt; dawgtool: no problem


</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017045.html">[rabbitmq-discuss] Priority Queue
</A></li>
	<LI>Next message: <A HREF="017049.html">[rabbitmq-discuss] RabbitMQ Stability Issues with large queue -	2011-12-28
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17041">[ date ]</a>
              <a href="thread.html#17041">[ thread ]</a>
              <a href="subject.html#17041">[ subject ]</a>
              <a href="author.html#17041">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
