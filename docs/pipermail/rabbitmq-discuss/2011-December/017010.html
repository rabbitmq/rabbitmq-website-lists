<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Memory Management Concerns / Questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20Management%20Concerns%20/%20Questions&In-Reply-To=%3C7b382529-4009-45ca-9e3f-1073ee2d0de7%40d10g2000vbk.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017007.html">
   <LINK REL="Next"  HREF="017011.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Memory Management Concerns / Questions</H1>
    <B>AndyB</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20Management%20Concerns%20/%20Questions&In-Reply-To=%3C7b382529-4009-45ca-9e3f-1073ee2d0de7%40d10g2000vbk.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Memory Management Concerns / Questions">andy.berryman at channeladvisor.com
       </A><BR>
    <I>Thu Dec 22 19:35:44 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="017007.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
        <LI>Next message: <A HREF="017011.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17010">[ date ]</a>
              <a href="thread.html#17010">[ thread ]</a>
              <a href="subject.html#17010">[ subject ]</a>
              <a href="author.html#17010">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the quick reply guys.  With the help of one of my systems
guys, I think that we have made some progress on this issue.  After
performing further tests with my application and doing some close
monitoring on the server node itself.  We noticed some unexpected
messages being written to disk for the queue which is transient.  That
immediately confused us.  And after some creative google'ing we came
across the following page which helped us a great deal ...
<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2011-October/015793.html.">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2011-October/015793.html.</A>
Given that information and some tweaks to the tests, I was finally
able to reproduce the memory throttling of publishers that I was
expecting to see.  And I think that I have a better understanding now
for the RAM usage and statistics and their tie to the watermark value.

But this gets me to my next concern ... The throttling of the
publishers appears to be a blocking operation from within the
&quot;BasicPublish&quot; method and as best I can tell, I'm not seeing any sort
of timeout.  This indefinite blocking would be pretty bad if it were
to occur in my production environment.  Is there a way that I can
specify some sort of timeout for the blocking operation?  I see an
overload for &quot;BasicPublish&quot; which has boolean params for &quot;immediate&quot;
and &quot;mandatory&quot;.  Are either of those meant to help in this situation?

Thanks
Andy

On Dec 22, 1:31&#160;pm, Steve Powell &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">st... at rabbitmq.com</A>&gt; wrote:
&gt;<i> Andy,
</I>&gt;<i>
</I>&gt;<i> By the 'lastest release' I presume you mean 2.7.0 (a week ago that would be
</I>&gt;<i> true, but now we have released 2.7.1.)
</I>&gt;<i>
</I>&gt;<i> Please can you show us your rabbitmq log after a crash? The test environment
</I>&gt;<i> case would be interesting, though the production system is probably
</I>&gt;<i> experiencing issues which are of an application nature.
</I>&gt;<i>
</I>&gt;<i> If the consumers were failing (getting exceptions) for some application reason,
</I>&gt;<i> and they were responsible for acknowledging the messages, then it is entirely
</I>&gt;<i> likely that the messages they failed to process are being re-queued, and the
</I>&gt;<i> queue is building up without being drained. &#160;The application exceptions are
</I>&gt;<i> therefore very interesting, and you should take care that a consumer should
</I>&gt;<i> acknowledge the message WHEN IT HAS BEEN DEALT WITH -- even if that means it
</I>&gt;<i> was an error that has been logged/passed on, or whatever.
</I>&gt;<i>
</I>&gt;<i> In the latest release message re-queuing preserves the order (for a single
</I>&gt;<i> consumer) so a failing message might reappear in the queue at the head -- this
</I>&gt;<i> would cause it to be re-processed more-or-less straight away, and if it is a
</I>&gt;<i> message payload logical error of some kind, this is likely to fail again --
</I>&gt;<i> and so on. &#160;The previous releases did not try to preserve message order, and
</I>&gt;<i> so the failing messages could be overtaken by non-failing ones. &#160;This would not
</I>&gt;<i> show up as a bottle-neck during high-load.
</I>&gt;<i>
</I>&gt;<i> I'm interested in your RAM configuration. &#160;It is entirely possible for rabbitmq
</I>&gt;<i> to run out of memory even if there is a threshold set. &#160;Continual high
</I>&gt;<i> publication rates, especially with new publishers all the time, will not be
</I>&gt;<i> blocked entirely even then. This might mean that the test you ran is giving
</I>&gt;<i> you misleading information.
</I>&gt;<i>
</I>&gt;<i> When the memory piles up you could also issue a rabbitmqctl report, which
</I>&gt;<i> should tell us the general situation.
</I>&gt;<i>
</I>&gt;<i> Steve Powell &#160;(a perplexed bunny)
</I>&gt;<i> ----------some more definitions from the SPD----------
</I>&gt;<i> avoirdupois (phr.) 'Would you like peas with that?'
</I>&gt;<i> distribute (v.) To denigrate an award ceremony.
</I>&gt;<i> definite (phr.) 'It's hard of hearing, I think.'
</I>&gt;<i> modest (n.) The most mod.
</I>&gt;<i>
</I>&gt;<i> On 22 Dec 2011, at 16:12, AndyB wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;<A HREF="http://www.rabbitmq.com/memory.html">http://www.rabbitmq.com/memory.html</A>
</I>&gt;<i>
</I>&gt;<i> &gt; I'm running into some problems that I'm hoping that someone here can
</I>&gt;<i> &gt; help me with. &#160;Let me first state my setup. &#160;I'm running the latest
</I>&gt;<i> &gt; release of RabbitMQ on CentOS (64bit) in a clustered configuration
</I>&gt;<i> &gt; with 2 nodes in my Production environment. &#160;In my development
</I>&gt;<i> &gt; environment I only have 1 node though. &#160;My code is written in C# and
</I>&gt;<i> &gt; is using the downloaded SDK from the website. &#160;The memory
</I>&gt;<i> &gt; configuration value is set to 40% as the default.
</I>&gt;<i>
</I>&gt;<i> &gt; I ran into a problem in my Production environment a week ago where
</I>&gt;<i> &gt; work was building up on my queue faster than my consumers were
</I>&gt;<i> &gt; processing it. &#160;Unfortunately I wasnt able to perform any debugging or
</I>&gt;<i> &gt; metrics gathering before the system was recycled or the queue was
</I>&gt;<i> &gt; purged. &#160;I'm still not exactly sure exactly which happened. &#160;But what
</I>&gt;<i> &gt; I can tell you is that it looked to me like exceptions were occurring
</I>&gt;<i> &gt; for both the publishers and consumers and nothing was really
</I>&gt;<i> &gt; happening. &#160;I have since added more consumers and have not had the
</I>&gt;<i> &gt; problem occur again. &#160;But this obviously has me concerned.
</I>&gt;<i>
</I>&gt;<i> &gt; I am currently in the process of trying to reproduce this problem in
</I>&gt;<i> &gt; my development environment, but I'm running into some confusing
</I>&gt;<i> &gt; results. &#160;My test case is to run multiple publishers sending messages
</I>&gt;<i> &gt; over and over as fast as possible while also have a single consumer
</I>&gt;<i> &gt; processing those messages with a delay. &#160;The goal is to obviously
</I>&gt;<i> &gt; force messages to pile up in memory on the node to trigger the memory
</I>&gt;<i> &gt; alert. &#160;Since I have both publishers and consumers connected, I'm
</I>&gt;<i> &gt; expecting to see the consumers begin to get some sort of exception
</I>&gt;<i> &gt; saying that they cant submit anymore work while the consumer continues
</I>&gt;<i> &gt; to process. &#160;But what I'm actually seeing is that the publishers
</I>&gt;<i> &gt; continue piling on and the consumer continues to process, but the
</I>&gt;<i> &gt; machine eventually runs out of disk space and crashes.
</I>&gt;<i>
</I>&gt;<i> &gt; Is there anyone that can advise me on what I'm doing wrong or help me
</I>&gt;<i> &gt; figure out what changes I can make?
</I>&gt;<i>
</I>&gt;<i> &gt; Thanks
</I>&gt;<i> &gt; Andy
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.com</A>
</I>&gt;<i> &gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017007.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
	<LI>Next message: <A HREF="017011.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17010">[ date ]</a>
              <a href="thread.html#17010">[ thread ]</a>
              <a href="subject.html#17010">[ subject ]</a>
              <a href="author.html#17010">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
