<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Using rabbitmq_auth_mechanism_ssl with the	.NET client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Using%20rabbitmq_auth_mechanism_ssl%20with%20the%0A%09.NET%20client&In-Reply-To=%3Cc9696d25-4acc-4d3e-b5e4-a28362dd1dae%40d10g2000vbk.googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017036.html">
   <LINK REL="Next"  HREF="017076.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Using rabbitmq_auth_mechanism_ssl with the	.NET client</H1>
    <B>John Ruiz</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Using%20rabbitmq_auth_mechanism_ssl%20with%20the%0A%09.NET%20client&In-Reply-To=%3Cc9696d25-4acc-4d3e-b5e4-a28362dd1dae%40d10g2000vbk.googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Using rabbitmq_auth_mechanism_ssl with the	.NET client">jruiz at johnruiz.com
       </A><BR>
    <I>Fri Dec 30 16:19:27 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="017036.html">[rabbitmq-discuss] Using rabbitmq_auth_mechanism_ssl with the	.NET client
</A></li>
        <LI>Next message: <A HREF="017076.html">[rabbitmq-discuss] Using rabbitmq_auth_mechanism_ssl with the	.NET client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17075">[ date ]</a>
              <a href="thread.html#17075">[ thread ]</a>
              <a href="subject.html#17075">[ subject ]</a>
              <a href="author.html#17075">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Now that I have all of this working, I need to switch over from an
openssl-based CA to our production CA, which is Active Directory
Certificate Services.  All certificates are issued by the subordinate
enterprise CA --&gt; ISSUE01.devexample.com.

I have a certificate for myself in my personal store on
DC01.devexample.com (Windows Server).

The RabbitMQ Service runs as Local System on APP01.devexample.com
(Windows Server) so there's a certificate for APP01.devexample.com in
the Local Computer's Personal store.

The Root CA certificate is already in Trusted Root Certs on all
machines in the domain devexample.com.  The ISSUE01 CA cert is in the
Intermediate Certification Authority store everywhere as well.

I have exported the Root CA cert to a DER file and then moved it to a
linux machine where I used openssl to convert it to PEM.  I then moved
it back to APP01.  Next, I exported APP01's cert (with private key) to
a PFX file, moved it to a linux machine and extracted the signed
public key cert and the private key cert.

# extract the private key (still password protected)
openssl.exe pkcs12 -in publicAndprivate.pfx -nocerts -out
privateKey.pem

# extract the public cert
openssl.exe pkcs12 -in publicAndprivate.pfx -clcerts -nokeys -out
app01.pem

# remove the password protection
openssl.exe rsa -in privateKey.pem -out app01-private.pem

I moved all of these PEMs back to APP01 -- the CA's public cert,
APP01's public cert, and APP01's private key.  Here is my
rabbitmq.config

[
  {rabbit, [
     {auth_mechanisms,['EXTERNAL']},
     {ssl_listeners, [5671]},
     {ssl_options, [{cacertfile,&quot;C:/Keys/pki-root-ca.pem&quot;},
                    {certfile,&quot;C:/Keys/app01.pem&quot;},
                    {keyfile,&quot;C:/Keys/app01-private.pem&quot;},
                    {verify,verify_peer},
                    {fail_if_no_peer_cert,true}]}
   ]}
].

When I run the code that I've already listed in my blog post, I get
this exception: <A HREF="http://pastebin.com/9USFHWzf">http://pastebin.com/9USFHWzf</A>

In the rabbit log, I see this: <A HREF="http://pastebin.com/GsWsxLGV">http://pastebin.com/GsWsxLGV</A>

As far as I can tell, I've done everything correctly.  I've ensured
that my code references APP01.devexample.com, exactly as it appears on
the certificate (Subject: CN = APP01.devexample.com).

What should I do/try?

Please help!


On Dec 27, 4:22&#160;pm, John Ruiz &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jr... at johnruiz.com</A>&gt; wrote:
&gt;<i> I have figured it out. &#160;There were two issues.
</I>&gt;<i>
</I>&gt;<i> 1. Add the external mechanism factory to your connection factory's
</I>&gt;<i> auth mechanisms
</I>&gt;<i> &#160; &#160; i.e. -- cf.AuthMechanisms = new AuthMechanismFactory[] { new
</I>&gt;<i> ExternalMechanismFactory() };
</I>&gt;<i>
</I>&gt;<i> 2. Configure the server's auth_mechanisms variable in your
</I>&gt;<i> rabbitmq.config.
</I>&gt;<i> &#160; &#160; Here is my complete rabbitmq.config:
</I>&gt;<i>
</I>&gt;<i> [
</I>&gt;<i> &#160; {rabbit, [
</I>&gt;<i> &#160; &#160; &#160;{auth_mechanisms,['EXTERNAL']},
</I>&gt;<i> &#160; &#160; &#160;{ssl_listeners, [5671]},
</I>&gt;<i> &#160; &#160; &#160;{ssl_options, [{cacertfile,&quot;C:/Path/To/Your/cacert.pem&quot;},
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {certfile,&quot;C:/Path/To/Your/cert.pem&quot;},
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {keyfile,&quot;C:/Path/To/Your/key.pem&quot;},
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {verify,verify_peer},
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {fail_if_no_peer_cert,true}]}
</I>&gt;<i> &#160; &#160;]}
</I>&gt;<i> ].
</I>&gt;<i>
</I>&gt;<i> On Dec 27, 1:16&#160;pm, John Ruiz &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jr... at johnruiz.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Hi All,
</I>&gt;<i>
</I>&gt;<i> &gt; I've successfully followed the SSL tutorial and gotten my .NET client
</I>&gt;<i> &gt; to connect, send, and receive messages over SSL. &#160;See my blog for the
</I>&gt;<i> &gt; code:<A HREF="http://blog.johnruiz.com/2011/12/establishing-ssl-connection-to-rabbi....">http://blog.johnruiz.com/2011/12/establishing-ssl-connection-to-rabbi....</A>
</I>&gt;<i>
</I>&gt;<i> &gt; As the next step, I enabled the plugin &quot;rabbitmq_auth_mechanism_ssl&quot;
</I>&gt;<i> &gt; and then re-installed the Windows Service. &#160;Then I re-ran the code I
</I>&gt;<i> &gt; have listed in my blog -- with the addition of a Console.ReadLine() at
</I>&gt;<i> &gt; the end of my using statements so I can see the connection details in
</I>&gt;<i> &gt; the management web app.
</I>&gt;<i>
</I>&gt;<i> &gt; I am still connecting as guest. &#160;What do I need to do in order to
</I>&gt;<i> &gt; connect as the CN of the Subject on my certificate?
</I>&gt;<i>
</I>&gt;<i> &gt; Thanks!
</I>&gt;<i> &gt; ~ jR
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-disc... at lists.rabbitmq.comhttps</A>://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss
</I></PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017036.html">[rabbitmq-discuss] Using rabbitmq_auth_mechanism_ssl with the	.NET client
</A></li>
	<LI>Next message: <A HREF="017076.html">[rabbitmq-discuss] Using rabbitmq_auth_mechanism_ssl with the	.NET client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17075">[ date ]</a>
              <a href="thread.html#17075">[ thread ]</a>
              <a href="subject.html#17075">[ subject ]</a>
              <a href="author.html#17075">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
