<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Memory Management Concerns / Questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20Management%20Concerns%20/%20Questions&In-Reply-To=%3C4EF39150.4010109%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017012.html">
   <LINK REL="Next"  HREF="017014.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Memory Management Concerns / Questions</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20Management%20Concerns%20/%20Questions&In-Reply-To=%3C4EF39150.4010109%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Memory Management Concerns / Questions">matthias at rabbitmq.com
       </A><BR>
    <I>Thu Dec 22 20:21:36 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="017012.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
        <LI>Next message: <A HREF="017014.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17015">[ date ]</a>
              <a href="thread.html#17015">[ thread ]</a>
              <a href="subject.html#17015">[ subject ]</a>
              <a href="author.html#17015">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andy,

On 22/12/11 19:53, AndyB wrote:
&gt;<i> In my test case, I have intentionally coded the consumer to never
</I>&gt;<i> catch up.  During the process, I saw the publishers get blocked
</I>&gt;<i> after the alert, messages were streamed to disk enough to get below
</I>&gt;<i> the watermark, and the publishers were unblocked.  Of course they hit
</I>&gt;<i> the watermark soon after and the same process happened again.  I'd
</I>&gt;<i> say this happened maybe 4 or 5 times and then they just remained in
</I>&gt;<i> a blocked state.  I let the test continue running for almost 10
</I>&gt;<i> minutes and they never became unblocked and the watermark alert never
</I>&gt;<i> seemed to clear on the server.  So I guess that means that it
</I>&gt;<i> stopped streaming the messages to disk or something?
</I>
It's possible that you ran into another limit...

Each message has a small memory footprint, even when it has been paged
to disk. So there is an upper bound to how many messages rabbit can hold
on to. When that bound is reached producers will remain blocked until
some messages have been consumed.

There is way around that - changing the message store index module to
one that is operating entirely on disk. See
<A HREF="https://github.com/rabbitmq/rabbitmq-toke.">https://github.com/rabbitmq/rabbitmq-toke.</A> However, I don't know of any
production rabbits that have actually run into this limitation.

&gt;<i> Either way, I'm going to have to come up with a way to implement
</I>&gt;<i> something in my code to try to avoid tying up a thread for an unknown
</I>&gt;<i> amount of time.  Any ideas?
</I>
You could perform all the invocations of the AMQP client's publish 
methods from a single, separate thread. It would sit in a loop, pulling 
messages off a bounded buffer / queue (e.g. an ArrayBlockingQueue if 
this was Java; there are presumably similar data structures in C#, and 
worst case you could roll your own) and invoking the publish methods in 
the AMQP client.

The &quot;real&quot; publishing threads simply deposit messages into the buffer / 
queue using an operation with a timeout, e.g. BlockingQueue.offer(E o, 
long timeout, TimeUnit unit).


Matthias.
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017012.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
	<LI>Next message: <A HREF="017014.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17015">[ date ]</a>
              <a href="thread.html#17015">[ thread ]</a>
              <a href="subject.html#17015">[ subject ]</a>
              <a href="author.html#17015">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
