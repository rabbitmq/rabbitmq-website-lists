<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Debugging AD
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Debugging%20AD&In-Reply-To=%3CCAB-G1jiO-ANH%3Dv9NbYW8mzvV%3DAcke82eOdF9hNVYCgmdRq9zhQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016762.html">
   <LINK REL="Next"  HREF="016696.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Debugging AD</H1>
    <B>Ben Hood</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Debugging%20AD&In-Reply-To=%3CCAB-G1jiO-ANH%3Dv9NbYW8mzvV%3DAcke82eOdF9hNVYCgmdRq9zhQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Debugging AD">0x6e6562 at gmail.com
       </A><BR>
    <I>Thu Dec  1 17:10:23 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016762.html">[rabbitmq-discuss] Rabbit RPC Application
</A></li>
        <LI>Next message: <A HREF="016696.html">[rabbitmq-discuss] Debugging AD
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16692">[ date ]</a>
              <a href="thread.html#16692">[ thread ]</a>
              <a href="subject.html#16692">[ subject ]</a>
              <a href="author.html#16692">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Nov 30, 2011 at 4:44 PM, Ben Hood &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">0x6e6562 at gmail.com</A>&gt; wrote:
&gt;<i> Hi Simon,
</I>&gt;<i>
</I>&gt;<i> So after spinning the underlying LDAP driver on it's own, I was able
</I>&gt;<i> to establish what combination of input parameters was going to work
</I>&gt;<i> with AD:
</I>&gt;<i>
</I>&gt;<i> 1&gt; {_, C} = eldap:open([&quot;172.20.3.21&quot;],[]).
</I>&gt;<i> 2&gt; eldap:simple_bind(C,
</I>&gt;<i> &quot;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">ben.hood at ACMEDOMAIN</A>&quot;,&quot;DB/nUcPk?DdF&lt;eCjp?erzpbi[g&quot;BdJL.w;pFrT&gt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">tg at KnbCDsi</A>&quot;).
</I>&gt;<i> ok
</I>&gt;<i>
</I>&gt;<i> So this boils down to putting
</I>&gt;<i>
</I>&gt;<i> {user_dn_pattern, &#160; &#160; &#160; &quot;${username}@ACMEDOMAIN&quot;},
</I>
I've managed to test for group membership in AD using after applying this patch:

iff -r 99212b40d834 src/rabbit_auth_backend_ldap.erl
--- a/src/rabbit_auth_backend_ldap.erl	Wed Nov 09 10:20:24 2011 +0000
+++ b/src/rabbit_auth_backend_ldap.erl	Thu Dec 01 17:03:48 2011 +0000
@@ -119,7 +119,7 @@
     object_exists(DNPattern, Filter, Args, LDAP);

 evaluate({in_group, DNPattern}, Args, #user{impl = UserDN}, LDAP) -&gt;
-    Filter = eldap:'and'([eldap:equalityMatch(&quot;objectClass&quot;, &quot;groupOfNames&quot;),
+    Filter = eldap:'and'([eldap:equalityMatch(&quot;objectClass&quot;, &quot;group&quot;),
                           eldap:equalityMatch(&quot;member&quot;,      UserDN)]),
     object_exists(DNPattern, Filter, Args, LDAP);

However, I think I may have run into a brick wall with the bind with AD.

$ ldapsearch -h 172.20.3..21 -w 'xxx' -b &quot;dc=acme,dc=com&quot; -D
&quot;ACMEDOMAIN\\ben.hood&quot;

will return a whole subtree of results, but for an in_group query to work, e.g.

{resource_access_query,
     {for, [
        {permission, configure, {in_group, &quot;CN=Rabbit
Admins,DC=acme,DC=com&quot; } },
        {permission, configure, {constant, false} }
     ]}
   },

the original bind request will have had to returned the full user DN,
not a list of results.

To get AD to return a single user DN, you can do the following:

$ ldapsearch -h 172.20.3..21 -w 'xxx' -b &quot;dc=acme,dc=com&quot; -D
&quot;ACMEDOMAIN\\ben.hood&quot; '(sAMAccountName=ben.hood)' dn

But with AFAICT with eldap this would require the bind to be followed
by a subsequent query by attribute, like the example in the LDAP
driver shows: <A HREF="https://github.com/etnt/eldap/blob/master/doc/README.example">https://github.com/etnt/eldap/blob/master/doc/README.example</A>

So I would love to be corrected, but I can't see how AD authentication
can work without post-processing the initial bind call. Has anybody
else had any success with AD where authentication for the bind is
required?

Cheers,

Ben
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016762.html">[rabbitmq-discuss] Rabbit RPC Application
</A></li>
	<LI>Next message: <A HREF="016696.html">[rabbitmq-discuss] Debugging AD
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16692">[ date ]</a>
              <a href="thread.html#16692">[ thread ]</a>
              <a href="subject.html#16692">[ subject ]</a>
              <a href="author.html#16692">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
