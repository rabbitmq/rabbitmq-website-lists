<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Bug with consistent hash exchange.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bug%20with%20consistent%20hash%20exchange.&In-Reply-To=%3C20111208150210.GA19719%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016794.html">
   <LINK REL="Next"  HREF="016796.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Bug with consistent hash exchange.</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Bug%20with%20consistent%20hash%20exchange.&In-Reply-To=%3C20111208150210.GA19719%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Bug with consistent hash exchange.">matthew at rabbitmq.com
       </A><BR>
    <I>Thu Dec  8 15:02:10 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="016794.html">[rabbitmq-discuss] Bug with consistent hash exchange.
</A></li>
        <LI>Next message: <A HREF="016796.html">[rabbitmq-discuss] Bug with consistent hash exchange.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16795">[ date ]</a>
              <a href="thread.html#16795">[ thread ]</a>
              <a href="subject.html#16795">[ subject ]</a>
              <a href="author.html#16795">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Dec 08, 2011 at 06:34:24AM -0800, Wojciech Durczy&#324;ski wrote:
&gt;<i> Let's consider following routing:
</I>&gt;<i> 
</I>&gt;<i> exchange A of type topic
</I>&gt;<i> exchange B of type consistent-hash-exchange
</I>&gt;<i> exchange C of type consistent-hash-exchange
</I>&gt;<i> 
</I>&gt;<i> binding A -&gt; B with routing key &quot;b.#&quot;
</I>&gt;<i> binding A -&gt; C with routing key &quot;c.#&quot;
</I>&gt;<i> 
</I>&gt;<i> If there are queues bound to exchanges B and C, everything works as 
</I>&gt;<i> expected.
</I>&gt;<i> 
</I>&gt;<i> If there aren't queues bound to C, but there are queues bound to B then 
</I>&gt;<i> message with routing key &quot;c.x&quot; sent to exchange A is routed to one of the 
</I>&gt;<i> B's queues. It should be discarded instead or cause NO-ROUTE or 
</I>&gt;<i> NO_CONSUMERS (message flag dependent).
</I>
Agreed. I've just knocked up the following test, and you're right. It's
clearly wrong. Sorry about that. I'll get it fixed and it should be in
the next release.

-module(test).
-compile([export_all]).

-include_lib(&quot;amqp_client/include/amqp_client.hrl&quot;).

test_consistent_hash() -&gt;
    A = &lt;&lt;&quot;A&quot;&gt;&gt;, B = &lt;&lt;&quot;B&quot;&gt;&gt;, C = &lt;&lt;&quot;C&quot;&gt;&gt;, Q = &lt;&lt;&quot;my_queue&quot;&gt;&gt;,
    {ok, Conn} = amqp_connection:start(#amqp_params_network{}),
    {ok, Chan} = amqp_connection:open_channel(Conn),
    #'queue.declare_ok' {} = amqp_channel:call(Chan, #'queue.declare'{ queue = Q }),
    #'exchange.declare_ok'{} =
        amqp_channel:call(
          Chan, #'exchange.declare'{ exchange = A, type = &lt;&lt;&quot;topic&quot;&gt;&gt; }),
    #'exchange.declare_ok'{} =
        amqp_channel:call(
          Chan, #'exchange.declare'{ exchange = B, type = &lt;&lt;&quot;x-consistent-hash&quot;&gt;&gt; }),
    #'exchange.declare_ok'{} =
        amqp_channel:call(
          Chan, #'exchange.declare'{ exchange = C, type = &lt;&lt;&quot;x-consistent-hash&quot;&gt;&gt; }),
    #'exchange.bind_ok'{} = amqp_channel:call(
                              Chan, #'exchange.bind'{ source = A, destination = B,
                                                      routing_key = &lt;&lt;&quot;b.#&quot;&gt;&gt; }),
    #'exchange.bind_ok'{} = amqp_channel:call(
                              Chan, #'exchange.bind'{ source = A, destination = C,
                                                      routing_key = &lt;&lt;&quot;c.#&quot;&gt;&gt; }),
    #'queue.bind_ok'{} = amqp_channel:call(
                           Chan, #'queue.bind'{ queue = Q, exchange = B,
                                                routing_key = &lt;&lt;&quot;10&quot;&gt;&gt; }),
    Msg = #amqp_msg { props = #'P_basic'{}, payload = &lt;&lt;&quot;hello&quot;&gt;&gt; },
    Publish = #'basic.publish'{ routing_key = &lt;&lt;&quot;c.foo&quot;&gt;&gt;, exchange = A },
    amqp_channel:call(Chan, Publish, Msg),
    timer:sleep(1000),
    io:format(&quot;~p~n&quot;, [amqp_channel:call(Chan, #'queue.declare'{ queue = Q })]),
    amqp_connection:close(Conn).

Matthew
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016794.html">[rabbitmq-discuss] Bug with consistent hash exchange.
</A></li>
	<LI>Next message: <A HREF="016796.html">[rabbitmq-discuss] Bug with consistent hash exchange.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16795">[ date ]</a>
              <a href="thread.html#16795">[ thread ]</a>
              <a href="subject.html#16795">[ subject ]</a>
              <a href="author.html#16795">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
