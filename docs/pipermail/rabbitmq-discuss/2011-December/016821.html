<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] timeout_waiting_for_tables on node that has not	changed node name
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20timeout_waiting_for_tables%20on%20node%20that%20has%20not%0A%09changed%20node%20name&In-Reply-To=%3CCAFDmHdN4aZLWVuSvnU1iLpzamTZSs4KTMLgKU1FSh%3Dw2mgHAXg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017026.html">
   <LINK REL="Next"  HREF="016823.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] timeout_waiting_for_tables on node that has not	changed node name</H1>
    <B>Elias Levy</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20timeout_waiting_for_tables%20on%20node%20that%20has%20not%0A%09changed%20node%20name&In-Reply-To=%3CCAFDmHdN4aZLWVuSvnU1iLpzamTZSs4KTMLgKU1FSh%3Dw2mgHAXg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] timeout_waiting_for_tables on node that has not	changed node name">fearsome.lucidity at gmail.com
       </A><BR>
    <I>Fri Dec  9 20:33:57 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="017026.html">[rabbitmq-discuss] maximum number of amqp connections to a rabbitmq broker
</A></li>
        <LI>Next message: <A HREF="016823.html">[rabbitmq-discuss] timeout_waiting_for_tables on node that has	not changed node name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16821">[ date ]</a>
              <a href="thread.html#16821">[ thread ]</a>
              <a href="subject.html#16821">[ subject ]</a>
              <a href="author.html#16821">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Last night we had to reboot a RabbitMQ node in a 3 node cluster within EC2.
 The node failed to restart with the dreaded timeout_waiting_for_tables
error.

Looking as past discussion on that topic it is clear that the most common
reason for it is a node name change, either because the node name contains
the IP address, the hostname changed, or a new node is being provisioned on
an image with an old mnesia DB with some other nodename.

None of those appears to apply in our current situation.  The node name
does not include the IP address and the node name did not change, as can be
seen in the start up logs.  Just to be sure we set the node name in the
/etc/rabbitmq/rabbitmq-env.conf file and attempted to restart, again
without success.

I enabled mnesia debugging at the trace level and it does not provide any
useful information as to what is causing the timeout.  The cluster has
developed a backlog of persistent messages in two of the queues (about 70K
in total), but from looking at what tables the system complains about it
does not appear those are the tables its trying to sync.  All the other
metadata (users, exchanges, bindings, queues) is of very small size, so 30
seconds should be sufficient time.

While we could wipe the mnesia state from the node, we'd like to find out
why this happens and whether it can be repaired, for future reference.

The start-up log is attached below.

Any ideas?

-----------------
Activating RabbitMQ plugins ...
7 plugins activated:
* amqp_client-2.5.1
* mochiweb-1.3-rmq2.5.1-git9a53dbd
* rabbitmq_management-2.5.1
* rabbitmq_management_agent-2.5.1
* rabbitmq_mochiweb-2.5.1
* rabbitmq_stomp-2.5.1
* webmachine-1.7.0-rmq2.5.1-hg0c4b60a

Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_monitor starting: &lt;0.68.0&gt;
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Version: &quot;4.4.17&quot;
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env access_module: mnesia
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env auto_repair: true
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env backup_module: mnesia_backup
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env debug: trace
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env dir:
&quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>&quot;
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env dump_log_load_regulation: false
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env dump_log_time_threshold: 180000
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env dump_log_update_in_place: true
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env dump_log_write_threshold: 1000
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env embedded_mnemosyne: false
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env event_module: mnesia_event
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env extra_db_nodes: []
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env ignore_fallback_at_startup: false
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env fallback_error_function:
{mnesia,lkill}
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env max_wait_for_decision: infinity
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env schema_location: opt_disc
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env core_dir: false
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env pid_sort_order: false
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env no_table_loaders: 2
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env dc_dump_limit: 4
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Env send_compressed: 0
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Mnesia debug level set to trace
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_subscr starting: &lt;0.69.0&gt;
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_locker starting: &lt;0.70.0&gt;
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_recover starting: &lt;0.71.0&gt;
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_tm starting: &lt;0.72.0&gt;
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Schema initiated from: disc
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Transaction log dump initiated by
scan_decisions
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Transaction log dump initiated by
startup: {needs_dump,0}
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Transaction log dump initiated by
startup: already_dumped
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Initial dump of log during startup:
[dumped,

 dumped]
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_controller starting: &lt;0.98.0&gt;
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_downs = []
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): Intend to load tables: []

+---+   +---+
|<i>   |   |   |
</I>|<i>   |   |   |
</I>|<i>   |   |   |
</I>|<i>   +---+   +-------+
</I>|<i>                   |
</I>|<i> RabbitMQ  +---+   |
</I>|<i>           |   |   |
</I>|<i>   v2.5.1  +---+   |
</I>|<i>                   |
</I>+-------------------+
AMQP 0-9-1 / 0-9 / 0-8
Copyright (C) 2007-2011 VMware, Inc.
Licensed under the MPL.  See <A HREF="http://www.rabbitmq.com/">http://www.rabbitmq.com/</A>

node           : <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>
app descriptor :
/usr/lib/rabbitmq/lib/rabbitmq_server-2.5.1/sbin/../ebin/rabbit.app
home dir       : /var/lib/rabbitmq
config file(s) : /etc/rabbitmq/rabbitmq.config
cookie hash    : a+Jg2nl357GwYTLG/0y3Lg==
log            : /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int.log</A>
sasl log       : /var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int-sasl.log</A>
database dir   : /var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>
erlang version : 5.8.3

-- rabbit boot start
starting file handle cache server
...done
starting worker pool
 ...done
starting database
...BOOT ERROR: FAILED
Reason: {error,
            {timeout_waiting_for_tables,
                [rabbit_user,rabbit_user_permission,rabbit_vhost,
                 rabbit_listener,rabbit_durable_route,

 rabbit_semi_durable_route,rabbit_route,rabbit_reverse_route,
                 rabbit_topic_trie_edge,rabbit_topic_trie_binding,
                 rabbit_durable_exchange,rabbit_exchange,
                 rabbit_exchange_serial,rabbit_durable_queue,rabbit_queue]}}
Stacktrace: [{rabbit_mnesia,wait_for_tables,1},
             {rabbit_mnesia,check_schema_integrity,0},
             {rabbit_mnesia,ensure_schema_integrity,0},
             {rabbit_mnesia,init_db,3},
             {rabbit_mnesia,init,0},
             {rabbit,'-run_boot_step/1-lc$^1/1-1-',1},
             {rabbit,run_boot_step,1},
             {rabbit,'-start/2-lc$^0/1-0-',1}]
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_controller terminated: shutdown
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_tm terminated: shutdown
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_recover terminated: shutdown
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_locker terminated: shutdown
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_subscr terminated: shutdown
Mnesia('<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at queue-beta1-int</A>'): mnesia_monitor terminated: shutdown
{&quot;Kernel pid
terminated&quot;,application_controller,&quot;{application_start_failure,rabbit,{bad_return,{{rabbit,start,[normal,[]]},{'EXIT',{rabbit,failure_during_boot}}}}}&quot;}
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111209/9dddc4b7/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111209/9dddc4b7/attachment.htm</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017026.html">[rabbitmq-discuss] maximum number of amqp connections to a rabbitmq broker
</A></li>
	<LI>Next message: <A HREF="016823.html">[rabbitmq-discuss] timeout_waiting_for_tables on node that has	not changed node name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16821">[ date ]</a>
              <a href="thread.html#16821">[ thread ]</a>
              <a href="subject.html#16821">[ subject ]</a>
              <a href="author.html#16821">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
