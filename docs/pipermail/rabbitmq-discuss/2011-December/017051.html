<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss]  Failed to configure Rabbitmq HA(pacemaker)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%20Failed%20to%20configure%20Rabbitmq%20HA%28pacemaker%29&In-Reply-To=%3CCAKrFU7V5221mxjoomqqsoD-ejTbiOmRgKwUmLP%2BgRwaq438Jfw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017047.html">
   <LINK REL="Next"  HREF="017055.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss]  Failed to configure Rabbitmq HA(pacemaker)</H1>
    <B>Jae Sang Lee</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%20Failed%20to%20configure%20Rabbitmq%20HA%28pacemaker%29&In-Reply-To=%3CCAKrFU7V5221mxjoomqqsoD-ejTbiOmRgKwUmLP%2BgRwaq438Jfw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss]  Failed to configure Rabbitmq HA(pacemaker)">hyangii at gmail.com
       </A><BR>
    <I>Thu Dec 29 01:43:40 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="017047.html">[rabbitmq-discuss] inspecting messages
</A></li>
        <LI>Next message: <A HREF="017055.html">[rabbitmq-discuss] Failed to configure Rabbitmq HA(pacemaker)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17051">[ date ]</a>
              <a href="thread.html#17051">[ thread ]</a>
              <a href="subject.html#17051">[ subject ]</a>
              <a href="author.html#17051">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, all.


I read a rabbitmq HA(pacemaker) article at a homepage, then I tried to
configure two-node HA.
I succeeded run drbd and rabbitmq service by pacemaker. But It failed when
I tried to migrate from master to slave server.


This is first situation.
my node 'ha-node-1', 'ha-node-2'.
Master is 'ha-node-2'

ha-node-2# crm_mon
============
Last updated: Thu Dec 29 10:13:15 2011
Stack: openais
Current DC: ha-node-1 - partition with quorum
Version: 1.0.8-042548a451fce8400660f6031f4da6f0223dd5dd
2 Nodes configured, 2 expected votes
3 Resources configured.
============

Online: [ ha-node-1 ha-node-2 ]

 Master/Slave Set: drbd_ms
     Masters: [ ha-node-2 ]
     Slaves: [ ha-node-1 ]
drbd_fs (ocf::heartbeat:Filesystem):    Started ha-node-2
bunny   (ocf::rabbitmq:rabbitmq-server):        Started ha-node-2


ha-node-2~# cat /proc/drbd
version: 8.3.7 (api:88/proto:86-91)
GIT-hash: ea9e28dbff98e331a62bcbcc63a6135808fe2917 build by <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at glance-demo</A>,
2011-12-26 13:05:30

 1: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r----
    ns:486 nr:5 dw:491 dr:287 al:6 bm:1 lo:0 pe:0 ua:0 ap:0 ep:1 wo:d oos:0

I tested fail situation from master. so
ha-node-2~# crm node standby

ha-node-1~# crm_mon
============
Last updated: Thu Dec 29 10:32:56 2011
Stack: openais
Current DC: ha-node-1 - partition with quorum
Version: 1.0.8-042548a451fce8400660f6031f4da6f0223dd5dd
2 Nodes configured, 2 expected votes
3 Resources configured.
============

Node ha-node-2: standby
Online: [ ha-node-1 ]

 Master/Slave Set: drbd_ms
     Masters: [ ha-node-1 ]
     Stopped: [ drbd:1 ]
drbd_fs (ocf::heartbeat:Filesystem):    Started ha-node-1

Failed actions:
    bunny_start_0 (node=ha-node-1, call=14, rc=1, status=complete): unknown
error

drbd is migrate to slave successfully, but resource bunny(rabbitmq) isn't
start.
this is rabbitmq error log

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ha-node-1</A>:/var/log/rabbitmq# cat startup_log
Activating RabbitMQ plugins ...
ERROR: Could not delete dir
/media/drbd1/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at localhost-plugins-expand</A>({cannot_delete,

&quot;/media/drbd1/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at localhost-plugins-expand</A>/rabbit.script&quot;,

eacces})

I found slave's rabbitmq mnesia dir's owner is ais, not rabbitmq.
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ha-node-1</A>:/var/log/rabbitmq# cd /media/drbd1/
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ha-node-1</A>:/media/drbd1# ll
total 20
drwxr-xr-x 5 ais  ais   1024 2011-12-28 17:09 ./
drwxr-xr-x 3 root root  4096 2011-12-27 13:22 ../
-rw-r--r-- 1 ais  ais      3 2011-12-28 16:48 hello
drwx------ 2 ais  ais  12288 2011-12-28 16:47 lost+found/
drwxr-xr-x 5 ais  ais   1024 2011-12-29 10:32 <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at localhost</A>/
drwxr-xr-x 2 ais  ais   1024 2011-12-28 17:09
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at localhost-plugins-expand</A>/

When ha-node-2 success to run rabbitmq,
mnesia dir's owner is rabbitmq.
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ha-node-2</A>:/media/drbd1# ll
total 20
drwxr-xr-x 5 rabbitmq rabbitmq  1024 2011-12-28 17:09 ./
drwxr-xr-x 3 root     root      4096 2011-12-27 10:58 ../
-rw-r--r-- 1 rabbitmq rabbitmq     3 2011-12-28 16:48 hello
drwx------ 2 rabbitmq rabbitmq 12288 2011-12-28 16:47 lost+found/
drwxr-xr-x 5 rabbitmq rabbitmq  1024 2011-12-29 09:42 <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at localhost</A>/
drwxr-xr-x 2 rabbitmq rabbitmq  1024 2011-12-28 17:09
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at localhost-plugins-expand</A>/


Why pacemaker change owner of file/folder from rabbitmq to ais? I think
that is a reason to fail to run rabbitmq at slave(ha-node-1) server.

How can I fix that? I hope your reply.

Thanks.



ps.
this is pacemaker configure.
# crm configure show
node ha-node-1 \
        attributes standby=&quot;off&quot;
node ha-node-2 \
        attributes standby=&quot;on&quot;
primitive bunny ocf:rabbitmq:rabbitmq-server \
        params mnesia_base=&quot;/media/drbd1&quot; \
        meta target-role=&quot;Started&quot; is-managed=&quot;true&quot;
primitive drbd ocf:linbit:drbd \
        params drbd_resource=&quot;drbd1&quot; \
        op monitor interval=&quot;60s&quot;
primitive drbd_fs ocf:heartbeat:Filesystem \
        params device=&quot;/dev/drbd1&quot; directory=&quot;/media/drbd1&quot; fstype=&quot;ext3&quot;
ms drbd_ms drbd \
        meta master-max=&quot;1&quot; master-node-max=&quot;1&quot; clone-max=&quot;2&quot;
clone-node-max=&quot;1&quot; notify=&quot;true&quot;
colocation bunny_on_fs inf: bunny drbd_fs
colocation fs_on_drbd inf: drbd_fs drbd_ms:Master
order bunny_after_fs inf: drbd_fs bunny
order fs_after_drbd inf: drbd_ms:promote drbd_fs:start
property $id=&quot;cib-bootstrap-options&quot; \
        dc-version=&quot;1.0.8-042548a451fce8400660f6031f4da6f0223dd5dd&quot; \
        cluster-infrastructure=&quot;openais&quot; \
        expected-quorum-votes=&quot;2&quot; \
        stonith-enabled=&quot;false&quot; \
        no-quorum-policy=&quot;ignore&quot;
rsc_defaults $id=&quot;rsc-options&quot; \
        resource-stickiness=&quot;100&quot;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111229/755bde9e/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20111229/755bde9e/attachment.htm</A>&gt;
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017047.html">[rabbitmq-discuss] inspecting messages
</A></li>
	<LI>Next message: <A HREF="017055.html">[rabbitmq-discuss] Failed to configure Rabbitmq HA(pacemaker)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17051">[ date ]</a>
              <a href="thread.html#17051">[ thread ]</a>
              <a href="subject.html#17051">[ subject ]</a>
              <a href="author.html#17051">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
