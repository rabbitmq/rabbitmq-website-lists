<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Memory Management Concerns / Questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20Management%20Concerns%20/%20Questions&In-Reply-To=%3C316AF553-8E56-4F72-8944-DA76471A5396%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017003.html">
   <LINK REL="Next"  HREF="017010.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Memory Management Concerns / Questions</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Memory%20Management%20Concerns%20/%20Questions&In-Reply-To=%3C316AF553-8E56-4F72-8944-DA76471A5396%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Memory Management Concerns / Questions">steve at rabbitmq.com
       </A><BR>
    <I>Thu Dec 22 18:31:33 GMT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="017003.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
        <LI>Next message: <A HREF="017010.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17007">[ date ]</a>
              <a href="thread.html#17007">[ thread ]</a>
              <a href="subject.html#17007">[ subject ]</a>
              <a href="author.html#17007">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andy,

By the 'lastest release' I presume you mean 2.7.0 (a week ago that would be
true, but now we have released 2.7.1.)

Please can you show us your rabbitmq log after a crash? The test environment
case would be interesting, though the production system is probably
experiencing issues which are of an application nature.

If the consumers were failing (getting exceptions) for some application reason,
and they were responsible for acknowledging the messages, then it is entirely
likely that the messages they failed to process are being re-queued, and the
queue is building up without being drained.  The application exceptions are
therefore very interesting, and you should take care that a consumer should
acknowledge the message WHEN IT HAS BEEN DEALT WITH -- even if that means it
was an error that has been logged/passed on, or whatever.

In the latest release message re-queuing preserves the order (for a single
consumer) so a failing message might reappear in the queue at the head -- this
would cause it to be re-processed more-or-less straight away, and if it is a
message payload logical error of some kind, this is likely to fail again --
and so on.  The previous releases did not try to preserve message order, and
so the failing messages could be overtaken by non-failing ones.  This would not
show up as a bottle-neck during high-load.

I'm interested in your RAM configuration.  It is entirely possible for rabbitmq
to run out of memory even if there is a threshold set.  Continual high
publication rates, especially with new publishers all the time, will not be
blocked entirely even then. This might mean that the test you ran is giving
you misleading information.

When the memory piles up you could also issue a rabbitmqctl report, which
should tell us the general situation.

Steve Powell  (a perplexed bunny)
----------some more definitions from the SPD----------
avoirdupois (phr.) 'Would you like peas with that?'
distribute (v.) To denigrate an award ceremony.
definite (phr.) 'It's hard of hearing, I think.'
modest (n.) The most mod.

On 22 Dec 2011, at 16:12, AndyB wrote:

&gt;<i> <A HREF="http://www.rabbitmq.com/memory.html">http://www.rabbitmq.com/memory.html</A>
</I>&gt;<i> 
</I>&gt;<i> I'm running into some problems that I'm hoping that someone here can
</I>&gt;<i> help me with.  Let me first state my setup.  I'm running the latest
</I>&gt;<i> release of RabbitMQ on CentOS (64bit) in a clustered configuration
</I>&gt;<i> with 2 nodes in my Production environment.  In my development
</I>&gt;<i> environment I only have 1 node though.  My code is written in C# and
</I>&gt;<i> is using the downloaded SDK from the website.  The memory
</I>&gt;<i> configuration value is set to 40% as the default.
</I>&gt;<i> 
</I>&gt;<i> I ran into a problem in my Production environment a week ago where
</I>&gt;<i> work was building up on my queue faster than my consumers were
</I>&gt;<i> processing it.  Unfortunately I wasnt able to perform any debugging or
</I>&gt;<i> metrics gathering before the system was recycled or the queue was
</I>&gt;<i> purged.  I'm still not exactly sure exactly which happened.  But what
</I>&gt;<i> I can tell you is that it looked to me like exceptions were occurring
</I>&gt;<i> for both the publishers and consumers and nothing was really
</I>&gt;<i> happening.  I have since added more consumers and have not had the
</I>&gt;<i> problem occur again.  But this obviously has me concerned.
</I>&gt;<i> 
</I>&gt;<i> I am currently in the process of trying to reproduce this problem in
</I>&gt;<i> my development environment, but I'm running into some confusing
</I>&gt;<i> results.  My test case is to run multiple publishers sending messages
</I>&gt;<i> over and over as fast as possible while also have a single consumer
</I>&gt;<i> processing those messages with a delay.  The goal is to obviously
</I>&gt;<i> force messages to pile up in memory on the node to trigger the memory
</I>&gt;<i> alert.  Since I have both publishers and consumers connected, I'm
</I>&gt;<i> expecting to see the consumers begin to get some sort of exception
</I>&gt;<i> saying that they cant submit anymore work while the consumer continues
</I>&gt;<i> to process.  But what I'm actually seeing is that the publishers
</I>&gt;<i> continue piling on and the consumer continues to process, but the
</I>&gt;<i> machine eventually runs out of disk space and crashes.
</I>&gt;<i> 
</I>&gt;<i> Is there anyone that can advise me on what I'm doing wrong or help me
</I>&gt;<i> figure out what changes I can make?
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> Andy
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017003.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
	<LI>Next message: <A HREF="017010.html">[rabbitmq-discuss] Memory Management Concerns / Questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17007">[ date ]</a>
              <a href="thread.html#17007">[ thread ]</a>
              <a href="subject.html#17007">[ subject ]</a>
              <a href="author.html#17007">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
