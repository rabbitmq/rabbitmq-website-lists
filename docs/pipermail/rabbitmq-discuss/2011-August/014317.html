<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Unable to join cluster: &quot;Bad cookie in table definition rabbit_queue&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unable%20to%20join%20cluster%3A%20%22Bad%20cookie%20in%20table%0A%20definition%20rabbit_queue%22&In-Reply-To=%3C20110803123417.GB2906%40dakota.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014316.html">
   <LINK REL="Next"  HREF="014318.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Unable to join cluster: &quot;Bad cookie in table definition rabbit_queue&quot;</H1>
    <B>Alexandru Scvor&#355;ov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Unable%20to%20join%20cluster%3A%20%22Bad%20cookie%20in%20table%0A%20definition%20rabbit_queue%22&In-Reply-To=%3C20110803123417.GB2906%40dakota.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] Unable to join cluster: &quot;Bad cookie in table definition rabbit_queue&quot;">alexandru at rabbitmq.com
       </A><BR>
    <I>Wed Aug  3 13:34:17 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014316.html">[rabbitmq-discuss] Unable to join cluster: &quot;Bad cookie in table	definition rabbit_queue&quot;
</A></li>
        <LI>Next message: <A HREF="014318.html">[rabbitmq-discuss] A few questions about custom	rabbit_msg_store_index implementations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14317">[ date ]</a>
              <a href="thread.html#14317">[ thread ]</a>
              <a href="subject.html#14317">[ subject ]</a>
              <a href="author.html#14317">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

As a rule, if you're breaking up a cluster completely, you need to reset
all nodes.  Otherwise, some nodes may still think they're in the cluster
and contact the nodes that aren't, leading to strange situations.

&gt;<i> (it was on nodes A,B,C,D and became B,C,D,E).
</I>&gt;<i> I killed rabbitmq on nodes B,C,D (forgot to kill it on A) and followed
</I>&gt;<i> the cluster start procedure on B,C,D,E (stop_app, reset, cluster all
</I>&gt;<i> to B, start_app).
</I>
Reseting each of B, C, D should have been enough to inform A that they
have left the cluster, but getting the order of the commands even a bit
wrong might have led to your situation.

You were going from A, B, C, D to B, C, D, E.  If you wanted to destroy
the first cluster completely and create a new one reusing some of the
old machines, you should have &quot;stop_app, reset, start_app&quot; on each of
the original machines (maybe force_resetting the last one) and then run
the your commands to set up the new cluster.

If you just wanted to remove A and add E (i.e. keep the cluster but
change the machines in it), it should have been enough to &quot;stop_app,
reset, start_app&quot; on A and &quot;stop_app, reset, cluster, start_app&quot; on E.

&gt;<i> the cluster start procedure on B,C,D,E (stop_app, reset, cluster all
</I>&gt;<i> to B, start_app).
</I>
If B is the only disc node, you should be able to break the cluster by
stopping all the other nodes and resetting B.

Hope this clears things up.

Cheers,
Alex

On Wed, Aug 03, 2011 at 04:20:57PM +0400, Eugene Kirpichov wrote:
&gt;<i> Hey.
</I>&gt;<i> 
</I>&gt;<i> I got the following error today: I was changing the composition of a
</I>&gt;<i> 4-node RabbitMQ cluster (it was on nodes A,B,C,D and became B,C,D,E).
</I>&gt;<i> I killed rabbitmq on nodes B,C,D (forgot to kill it on A) and followed
</I>&gt;<i> the cluster start procedure on B,C,D,E (stop_app, reset, cluster all
</I>&gt;<i> to B, start_app).
</I>&gt;<i> 
</I>&gt;<i> Is this expected behavior in such a scenario?
</I>&gt;<i> Would the right way to avoid it be &quot;kill on A before starting B,C,D,E cluster&quot;?
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 3-Aug-2011::04:50:23 ===
</I>&gt;<i> Limiting to approx 924 file handles (829 sockets)
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 3-Aug-2011::04:50:23 ===
</I>&gt;<i> Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT002</A>): ** ERROR ** mnesia_event got
</I>&gt;<i> {inconsistent_database, running_partitioned_network,
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT001</A>}
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 3-Aug-2011::04:50:23 ===
</I>&gt;<i> Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT002</A>): ** ERROR ** mnesia_event got
</I>&gt;<i> {inconsistent_database, starting_partitioned_network,
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT001</A>}
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 3-Aug-2011::04:50:23 ===
</I>&gt;<i> FAILED
</I>&gt;<i> Reason: {error,
</I>&gt;<i>             {unable_to_join_cluster,
</I>&gt;<i>                 [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT002</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at RACK2UNIT001</A>],
</I>&gt;<i>                 {merge_schema_failed,
</I>&gt;<i>                     &quot;Bad cookie in table definition rabbit_queue:
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT002</A> =
</I>&gt;<i> {cstruct,rabbit_queue,set,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT002</A>],[],[],0,read_write,[],[],false,amqqueue,[name,durable,auto_delete,exclusive_owner,arguments,pid],[],[],{{1312,371791,515002}<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at RACK2UNIT001</A>},{{3,1},{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT002</A>,{1312,372070,234006}}}},
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT001</A> =
</I>&gt;<i> {cstruct,rabbit_queue,set,[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT004</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at RACK2UNIT003</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at RACK2UNIT001</A>],[],[],0,read_write,[],[],false,amqqueue,[name,durable,auto_delete,exclusive_owner,arguments,pid],[],[],{{1312,372061,609002}<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at RACK2UNIT001</A>},{{3,2},{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT003</A>,{1312,372100,781007}}}}\n&quot;}}}
</I>&gt;<i> Stacktrace: [{rabbit_mnesia,init_db,3},
</I>&gt;<i>              {rabbit_mnesia,init,0},
</I>&gt;<i>              {rabbit,'-run_boot_step/1-lc$^1/1-1-',1},
</I>&gt;<i>              {rabbit,run_boot_step,1},
</I>&gt;<i>              {rabbit,'-start/2-lc$^0/1-0-',1},
</I>&gt;<i>              {rabbit,start,2},
</I>&gt;<i>              {application_master,start_it_old,4}]
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 3-Aug-2011::04:50:24 ===
</I>&gt;<i>     application: rabbit
</I>&gt;<i>     exited: {bad_return,{{rabbit,start,[normal,[]]},
</I>&gt;<i>                          {'EXIT',{rabbit,failure_during_boot}}}}
</I>&gt;<i>     type: permanent
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Eugene Kirpichov
</I>&gt;<i> Principal Engineer, Mirantis Inc. <A HREF="http://www.mirantis.com/">http://www.mirantis.com/</A>
</I>&gt;<i> Editor, <A HREF="http://fprog.ru/">http://fprog.ru/</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014316.html">[rabbitmq-discuss] Unable to join cluster: &quot;Bad cookie in table	definition rabbit_queue&quot;
</A></li>
	<LI>Next message: <A HREF="014318.html">[rabbitmq-discuss] A few questions about custom	rabbit_msg_store_index implementations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14317">[ date ]</a>
              <a href="thread.html#14317">[ thread ]</a>
              <a href="subject.html#14317">[ subject ]</a>
              <a href="author.html#14317">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
