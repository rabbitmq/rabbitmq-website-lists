<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problem auto-deleting large number of queues?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20auto-deleting%20large%20number%20of%20queues%3F&In-Reply-To=%3C307D53C5-2C47-4B07-8561-8A6608C18A24%40plaxo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014741.html">
   <LINK REL="Next"  HREF="014743.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problem auto-deleting large number of queues?</H1>
    <B>Michael Chiang</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20auto-deleting%20large%20number%20of%20queues%3F&In-Reply-To=%3C307D53C5-2C47-4B07-8561-8A6608C18A24%40plaxo.com%3E"
       TITLE="[rabbitmq-discuss] Problem auto-deleting large number of queues?">mchiang at plaxo.com
       </A><BR>
    <I>Sat Aug 27 09:08:45 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014741.html">[rabbitmq-discuss] possible rabbitmq bug
</A></li>
        <LI>Next message: <A HREF="014743.html">[rabbitmq-discuss] Problem auto-deleting large number of queues?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14742">[ date ]</a>
              <a href="thread.html#14742">[ thread ]</a>
              <a href="subject.html#14742">[ subject ]</a>
              <a href="author.html#14742">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,
I just started playing around with rabbitmq and ran into some issue with auto-deleting large number of queues.  

I setup a rabbitMQ server (2.5.1) on a box with 4 cores, 8GB, and running Linux.  I also create 10 java consumers on a separate box, each one with one connection/channel to a rabbit MQ server.  Each consumer creates 20k queues (none-durable, auto-delete, exclusive), for a total of 200k queues on the server.  With 200k queues on the server, the memory footprint is about 2.8GB, and the server is very stable.  I can send/receive messages without any issues.  If I shutdown each consumer gracefully (ie, by calling channel.close() and then connection.close()), the rabbitMQ server takes about 300 seconds to auto-delete all the queues without much issues.

The problem comes if I don't shutdown the consumers gracefully.  If I kill all 10 consumers simultaneously without doing channel.close/connection.close, the RabbitMQ server suddenly have trouble auto-deleting those queues.  The memory effectively double to 5.6GB, and one of the cpu core is constantly staying at 100% (with 3 other cores doing nothing).  Meanwhile, the server become very unresponsive.  It takes hours before the server calms down.  When the server finally calms down, all queues are deleted and everything goes back to normal.  Does anyone knows what's going on?  Why does rabbitmq have trouble auto-deleting here?  Is there some config setting that I can tweak to fix this issue?

Thanks,
Michael  
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014741.html">[rabbitmq-discuss] possible rabbitmq bug
</A></li>
	<LI>Next message: <A HREF="014743.html">[rabbitmq-discuss] Problem auto-deleting large number of queues?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14742">[ date ]</a>
              <a href="thread.html#14742">[ thread ]</a>
              <a href="subject.html#14742">[ subject ]</a>
              <a href="author.html#14742">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
