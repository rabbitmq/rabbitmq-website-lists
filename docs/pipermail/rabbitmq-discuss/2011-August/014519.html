<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20crashed%20in%20ets%3Ainsert_new%20-%20looks%0A%20like%20a%20genuine%20bug...&In-Reply-To=%3C20110812102651.GB24946%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014512.html">
   <LINK REL="Next"  HREF="014521.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20crashed%20in%20ets%3Ainsert_new%20-%20looks%0A%20like%20a%20genuine%20bug...&In-Reply-To=%3C20110812102651.GB24946%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...">matthew at rabbitmq.com
       </A><BR>
    <I>Fri Aug 12 11:26:51 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014512.html">[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
</A></li>
        <LI>Next message: <A HREF="014521.html">[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14519">[ date ]</a>
              <a href="thread.html#14519">[ thread ]</a>
              <a href="subject.html#14519">[ subject ]</a>
              <a href="author.html#14519">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

On Fri, Aug 12, 2011 at 09:06:48AM +0100, Matthew Sackman wrote:
&gt;<i> Which version of Rabbit is this and which version of Erlang, and on what
</I>&gt;<i> platform?
</I>
Well I've figured out it's some form of Windows given the c:\ paths...

&gt;<i> &gt;     exception exit: {badarg,
</I>&gt;<i> &gt;                         [{ets,insert_new,
</I>&gt;<i> &gt;                              [303172,
</I>&gt;<i> 
</I>&gt;<i> What that means is that there's been an attempt to insert into a non
</I>&gt;<i> existant table. This normally suggests the msg_store has exited for
</I>&gt;<i> other reasons and there are still queues trying to write to the
</I>&gt;<i> msg_store's tables. This could indicate other bugs, but this itself is
</I>&gt;<i> unlikely to be the root cause.
</I>
Indeed, and having tracked through your logs, I've found what caused the
msg_store to exit (when the msg_store exits, its tables, which are
publically used, die with it, which then cause all the queues to die
when they next try to use said tables):

=ERROR REPORT==== 11-Aug-2011::19:57:26 ===
** Generic server msg_store_persistent terminating
** Last message in was {'$gen_cast',
                           {sync,
                               [&lt;&lt;....&gt;&gt;],
                               #Fun&lt;rabbit_variable_queue.11.110161290&gt;}}
** When Server state == {msstate,
                            &quot;c:/...../RabbitMQ/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT004-mnesia</A>/msg_store_persistent&quot;,
                            rabbit_msg_store_ets_index,
                            {state,348229,
                                &quot;c:/...../RabbitMQ/db/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at RACK2UNIT004-mnesia</A>/msg_store_persistent&quot;},
                            503,#Ref&lt;0.0.2.67161&gt;,
                            {dict,0,16,16,8,80,48,
                                {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                 []},
                                {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]}}},
                            [...SNIPS...]
** Reason for termination ==
** {{badmatch,not_found},
    [{rabbit_msg_store,'-handle_cast/2-fun-2-',4},
     {lists,any,2},
     {rabbit_msg_store,handle_cast,2},
     {gen_server2,handle_msg,2},
     {proc_lib,wake_up,3}]}

There is only one use of lists:any in the msg_store, and thus it's
fairly easy to work out what's happened: somehow, there's been an
attempt made to sync on disk a msg that turns out not to exist. This is,
unsurprisingly, an unexpected situation, hence the dramatic crash.

Could you provide details of:

1. What version of Windows, Erlang and Rabbit, you are using;
2. What are your clients doing when this occurs - it sounds like you're
doing stress tests: what exactly are these clients doing - if we can
reproduce this ourselves, it makes it _vastly_ easier to track it down
and fix it.
3. The above error entry was in your sasl log. If you could find the
corresponding entry in there in the non-anonymized log and send it to us
offlist, it may well have additional information that we would find
useful - if that's possible.

Best wishes,

Matthew
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014512.html">[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
</A></li>
	<LI>Next message: <A HREF="014521.html">[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14519">[ date ]</a>
              <a href="thread.html#14519">[ thread ]</a>
              <a href="subject.html#14519">[ subject ]</a>
              <a href="author.html#14519">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
