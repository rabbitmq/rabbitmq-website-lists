<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Scenario ideas
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Scenario%20ideas&In-Reply-To=%3CCAEWH9M_BfTbd0fQTsy4tG3Qtkjj%2BNWdHU6OKfy0_KR6QENhqHg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014581.html">
   <LINK REL="Next"  HREF="014595.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Scenario ideas</H1>
    <B>Pete Kelly</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Scenario%20ideas&In-Reply-To=%3CCAEWH9M_BfTbd0fQTsy4tG3Qtkjj%2BNWdHU6OKfy0_KR6QENhqHg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Scenario ideas">pkelly at gmail.com
       </A><BR>
    <I>Wed Aug 17 11:13:34 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014581.html">[rabbitmq-discuss] Scenario ideas
</A></li>
        <LI>Next message: <A HREF="014595.html">[rabbitmq-discuss] Scenario ideas
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14582">[ date ]</a>
              <a href="thread.html#14582">[ thread ]</a>
              <a href="subject.html#14582">[ subject ]</a>
              <a href="author.html#14582">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17 August 2011 10:39, Michael Bridgen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mikeb at rabbitmq.com</A>&gt; wrote:

&gt;<i> Hi Pete,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  I have been playing with rabbitmq and am thinking through some common
</I>&gt;&gt;<i> scenarios I think I will need to deal with, I was wondering if anyone
</I>&gt;&gt;<i> would be able to take the time to read my thoughts and validate them or
</I>&gt;&gt;<i> throw a few more options in/give me some article links?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a topic exchange and need to attach some consumers to process
</I>&gt;&gt;<i> messages.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I attach a consumer with no queue name, a unique one time queue will
</I>&gt;&gt;<i> be created and I can bind the exchange to this queue using a routing key
</I>&gt;&gt;<i> like 'animal.mammals.#'.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Not quite; you have to create the queue with an empty name, then consume
</I>&gt;<i> from it using the name you get back in queue.declare_ok (and then bind it to
</I>&gt;<i> the exchange).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  This is great until
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - the consumer crashes, meaning the exchange will drop all messages (or
</I>&gt;&gt;<i> they get rejected depending on the publish settings I use)
</I>&gt;&gt;<i> or
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yes, that can happen. Though if the queue isn't exclusive or auto_delete
</I>&gt;<i> (and thereby destroyed when the connection drops or consumer goes away), it
</I>&gt;<i> will happily collect messages until the consumer returns. Of course, you'd
</I>&gt;<i> have to have recorded its name somewhere, or generated the name yourself in
</I>&gt;<i> a way you can repeat.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  - I need another consumer to process animals.mammals.#, which I can't do
</I>&gt;&gt;<i> as I am using a one time queue and adding another will mean each message
</I>&gt;&gt;<i> is delivered to 2 queues.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What is the problem with delivering to two queues? If you are using a topic
</I>&gt;<i> exchange, creating an anonymous, exclusive queue for each consumer is
</I>&gt;<i> usually appropriate.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Are the above assumptions correct?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So my second option is to use a named queue. I attach a consumer with a
</I>&gt;&gt;<i> queue name and bind the exchange to this queue using a routing key like
</I>&gt;&gt;<i> 'animal.mammals.#'.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now if I need another consumer I simply bring another one up and attach
</I>&gt;&gt;<i> it to the same queue name, and they get the messages in round robin
</I>&gt;&gt;<i> which is great.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It is certainly an established pattern to use a durable, named queue for
</I>&gt;<i> sharing out messages.  Queues do double duty in AMQP -- firstly as &quot;work
</I>&gt;<i> queues&quot; of this kind, secondly as buffers for transmission.
</I>&gt;<i>
</I>
That's good to know, after experimenting this is the thinking I have come
round to as it allows the consumers to die if they need to and the queues
will still be written to, using a named queue also enables more than one
consumer to attach to a queue and receive the messages in round robin, which
is a nice quick way to add process capacity if it's ever required.


&gt;<i>
</I>&gt;<i> Take care with the order in which you do things, or at least be aware that
</I>&gt;<i> unless you set a prefetch value, the first consumer will get all the
</I>&gt;<i> messages in the queue at that time.
</I>

I noticed that with my experiments, prefetch is now set.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  What's not so great is if I then decide to attach a consumer to this
</I>&gt;&gt;<i> queue name (maybe by accident) and bind the exchange to a routing key
</I>&gt;&gt;<i> 'animal.mammals.rabbit'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then the queue gets 2 copies of each message. Is there any way to avoid
</I>&gt;&gt;<i> this other than careful management of bindings? Maybe a way of telling
</I>&gt;&gt;<i> the exchange to only deliver the message once to a given queue?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> No, it won't get two copies.  The routing will only ever deliver any given
</I>&gt;<i> message once to a queue.
</I>&gt;<i>
</I>&gt;<i> The combination of wildcard routing and round-robin is unusual. Would you
</I>&gt;<i> go into more detail about what you are trying to achieve?
</I>&gt;<i>
</I>
I think I could have confused the issue here somewhat - because of how the
tutorials are laid out I mistakenly thought that the consumer could consume
on a given routing key, rather than the routing key just being a binding
between an exchange and a queue. So I was thinking I was consuming on a
routing key, whereas in reality that's not the case.

The tutorials (and further experimentation) It's been a useful exercise in
finding out just how flexible rabbitmq is, and with that flexibility comes
the potential to really break the queues and bindings (especially if the
application is allowed to blindly create queues and bindings).

I am going to go with an approach that means bindings and queues must be
manually created, and only give the application code permission to write to
the exchanges, and read from the queues.



&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --Michael
</I>&gt;<i> ______________________________**_________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.</A>**rabbitmq.com&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/**cgi-bin/mailman/listinfo/**rabbitmq-discuss&lt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110817/82a0b78c/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110817/82a0b78c/attachment.htm</A>&gt;
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014581.html">[rabbitmq-discuss] Scenario ideas
</A></li>
	<LI>Next message: <A HREF="014595.html">[rabbitmq-discuss] Scenario ideas
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14582">[ date ]</a>
              <a href="thread.html#14582">[ thread ]</a>
              <a href="subject.html#14582">[ subject ]</a>
              <a href="author.html#14582">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
