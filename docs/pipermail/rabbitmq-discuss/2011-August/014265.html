<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Extremely uneven distribution of latencies under	high load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Extremely%20uneven%20distribution%20of%20latencies%20under%0A%09high%20load&In-Reply-To=%3CCANVKUrVYoPZ8qkGjv%3D8T19vthP4isVvY2Cs84W%2BZ_onpGKQX_A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014264.html">
   <LINK REL="Next"  HREF="014266.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Extremely uneven distribution of latencies under	high load</H1>
    <B>Eugene Kirpichov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Extremely%20uneven%20distribution%20of%20latencies%20under%0A%09high%20load&In-Reply-To=%3CCANVKUrVYoPZ8qkGjv%3D8T19vthP4isVvY2Cs84W%2BZ_onpGKQX_A%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Extremely uneven distribution of latencies under	high load">ekirpichov at gmail.com
       </A><BR>
    <I>Mon Aug  1 12:26:59 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014264.html">[rabbitmq-discuss] running rabbitmqadmin CLI on windows 7
</A></li>
        <LI>Next message: <A HREF="014266.html">[rabbitmq-discuss] Extremely uneven distribution of latencies	under high load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14265">[ date ]</a>
              <a href="thread.html#14265">[ thread ]</a>
              <a href="subject.html#14265">[ subject ]</a>
              <a href="author.html#14265">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi.

I've got a large cluster (several hundred machines) &quot;load-testing&quot; a
smaller rabbitmq cluster (4 machines - 1 on one rack, 3 on another, 8
queues) in a ~balanced and partitioned fashion (probably I don't even
need an actual rmq cluster).

I'm publishing about 6000 messages/s, each about 10kb in size, in
roundrobin to these 4 nodes.
Messages are persistent and durable; I have publisher confirms turned
on. Autoack is turned off; I have a cycle of &quot;get, process, publish
result, ack&quot;. Each message takes ~800ms to process.

I'm experiencing things like &quot;rabbitmq not giving a message to a
consumer for several minutes&quot;, i.e. a large portion of my cluster is
idle waiting for messages.
RabbitMQ is also rather frequently dropping connections but I'm reconnecting.

The distribution of message waiting times is like &quot;75% &lt; 50ms, 90% &lt;
1s, 99% &lt; 60s, 100% &lt; 180s&quot;.
Some consumers are served very well (a constant stream of messages),
some wait for minutes. Some have periods of both kinds.
The ones that are served really well don't experience reconnects,
though the poor ones also have only a few reconnects per minute at
most.

I also graphed the publish confirmations from RabbitMQ (actually the
number of unack'd messages remaining) and I'm seeing that most of the
brokers keep this number under a couple of thousand for all queues,
however one other broker (the one on a solitary rack) has it grow
seemingly without bound - to ~25k and more, again on all queues.

1) Is this expected behavior?
2) How can this behavior be explained? Are there any
performance-related quirks in clustered RabbitMQ?
3) Is it likely that I'll be able to get rid of this behavior and make
it at least more predictable by e.g. reconnecting if I don't receive a
message for, say, 15s?

-- 
Eugene Kirpichov
Principal Engineer, Mirantis Inc. <A HREF="http://www.mirantis.com/">http://www.mirantis.com/</A>
Editor, <A HREF="http://fprog.ru/">http://fprog.ru/</A>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014264.html">[rabbitmq-discuss] running rabbitmqadmin CLI on windows 7
</A></li>
	<LI>Next message: <A HREF="014266.html">[rabbitmq-discuss] Extremely uneven distribution of latencies	under high load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14265">[ date ]</a>
              <a href="thread.html#14265">[ thread ]</a>
              <a href="subject.html#14265">[ subject ]</a>
              <a href="author.html#14265">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
