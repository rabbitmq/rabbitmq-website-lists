<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ performance tips, collected with sweat and blood
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20performance%20tips%2C%0A%20collected%20with%20sweat%20and%20blood&In-Reply-To=%3C20110815130432.GD16780%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014522.html">
   <LINK REL="Next"  HREF="014546.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ performance tips, collected with sweat and blood</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20performance%20tips%2C%0A%20collected%20with%20sweat%20and%20blood&In-Reply-To=%3C20110815130432.GD16780%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ performance tips, collected with sweat and blood">matthew at rabbitmq.com
       </A><BR>
    <I>Mon Aug 15 14:04:33 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014522.html">[rabbitmq-discuss] RabbitMQ performance tips, collected with sweat and blood
</A></li>
        <LI>Next message: <A HREF="014546.html">[rabbitmq-discuss] RabbitMQ performance tips, collected with sweat and blood
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14544">[ date ]</a>
              <a href="thread.html#14544">[ thread ]</a>
              <a href="subject.html#14544">[ subject ]</a>
              <a href="author.html#14544">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Eugene,

On Fri, Aug 12, 2011 at 08:20:15AM -0700, Eugene Kirpichov wrote:
&gt;<i> I'm surprised to hear about the negative effect; in my experiments the
</I>&gt;<i> positive effect was very large - basically it raised a local stress
</I>&gt;<i> test throughput from several thousand to several hundred thousand
</I>&gt;<i> messages per second; can you please clarify?
</I>
With one or a low number of consumers from the same queue, especially if
those consumers are doing very little work and are able to acknowledge
msgs very quickly, if you turn on basic.qos then you'll see that the
loading of the consumers should be far more equal, but overall
throughput will drop. This is because of the additional checks necessary
that a queue has to make before trying to send a message to a queue
(essentially, if the prefetch limit was per consumer, rather than per
channel, life would be a lot simpler, at least from the broker's pov).

If you don't use basic.qos and the consumers are still very fast and
very simple then whilst you might get very unbalanced distribution of
messages to consumers, the overall throughput can be quite a lot higher.
Testing with consumers on the same machine as the broker should
demonstrate this.

But if your consumers are doing quite a lot of processing of each
message and are not able to keep up with the rate of messages that the
broker is sending them then it's quite possible for the broker to flood
one or a few consumers with all the messages and those consumers then
slowly work through their backlog whilst other consumers are left idle:
thus overall throughput can drop. Not only this but the memory
consumption of such consumers may well go through the roof (depending on
the client library being used) as they buffer up all the messages.

So by using basic.qos, you help to ensure that all consumers are kept
equally busy, and you can limit the amount of buffering they each do.
But nevertheless, because the broker has to do more work to achieve this
balancing, the broker spends more CPU per message per consumer, and thus
the broker can be seen to be somewhat slower. Indeed I've measured drops
from over 17kHz to 3kHz by using a single consumer and putting basic.qos
at 1. With basic.qos at some larger values (&gt; 1000), the effect is less
pronounced, but it's still a performance drop for really simple and fast
consumers.

Matthew
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014522.html">[rabbitmq-discuss] RabbitMQ performance tips, collected with sweat and blood
</A></li>
	<LI>Next message: <A HREF="014546.html">[rabbitmq-discuss] RabbitMQ performance tips, collected with sweat and blood
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14544">[ date ]</a>
              <a href="thread.html#14544">[ thread ]</a>
              <a href="subject.html#14544">[ subject ]</a>
              <a href="author.html#14544">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
