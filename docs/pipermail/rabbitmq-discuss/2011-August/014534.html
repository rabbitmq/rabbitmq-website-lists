<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] major failure when clearing large queue backlog
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20major%20failure%20when%20clearing%20large%20queue%20backlog&In-Reply-To=%3CCAHiEoM7fqpZvnmmMegRVDob7rNMmP74o%3DgKEWU77Zg0xP%3DGJvQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014571.html">
   <LINK REL="Next"  HREF="014545.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] major failure when clearing large queue backlog</H1>
    <B>Aaron Westendorf</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20major%20failure%20when%20clearing%20large%20queue%20backlog&In-Reply-To=%3CCAHiEoM7fqpZvnmmMegRVDob7rNMmP74o%3DgKEWU77Zg0xP%3DGJvQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] major failure when clearing large queue backlog">aaron at agoragames.com
       </A><BR>
    <I>Fri Aug 12 19:27:25 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014571.html">[rabbitmq-discuss] Load Balanced Consumers?
</A></li>
        <LI>Next message: <A HREF="014545.html">[rabbitmq-discuss] major failure when clearing large queue backlog
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14534">[ date ]</a>
              <a href="thread.html#14534">[ thread ]</a>
              <a href="subject.html#14534">[ subject ]</a>
              <a href="author.html#14534">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We've put two new rabbit 2.5 hosts into production at the same time as we
performed some other major upgrades to our software on 9 August. As
designed, our messages queued up in rabbit, and we slowly consumed them.
When the queues were empty, rabbit blew up and took out both hosts in the
cluster.

Hosts:
2 x 12 core AMD Opteron 6172
8GB ram

The situation here is that we had lots of requests, 1-2k/sec, coming in on
one host, routed to the queues on the second, to which there was connected a
pool of consumers. For a variety of reasons, that pool of consumers was
smaller than we wanted and we had trouble increasing the count. The first
incident occurred after the backlog reported by rabbit reached over 700k;
the second peak below 300k. Message size ranged from 2-20k.

In both cases, both rabbit hosts started spooling to disk as free memory
dropped. We do not use qos, and so our consumers also had significant memory
allocated to frames on their input queues. Eventually, we were able to spawn
enough consumers to slowly drain the queues. At the rate messages were
arriving, this took awhile, but everything stayed within spec.

Shortly after the queues drained, rabbit became completely unresponsive. Our
`watch` process to list_queues and check on the state stopped running. We
observed heavy swap churn via kswapd[0-9]+. It appeared that rabbit was
trying to load in all of the data that it had paged to disk.  I've attached
graphs that show when this event occurred, but they're the weekly rollups so
it's hidden in the noise. The &quot;max&quot; column is the best record of the limits
that were hit, especially the &quot;committed&quot; value which is significantly
higher than the 8GB of RAM available.

-Aaron


-- 
Aaron Westendorf
Senior Software Engineer
Agora Games
359 Broadway
Troy, NY 12180
Phone: 518.268.1000
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">aaron at agoragames.com</A>
www.agoragames.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110812/5cff119f/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110812/5cff119f/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: load-week.png
Type: image/png
Size: 16202 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110812/5cff119f/attachment.png">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110812/5cff119f/attachment.png</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: memory-week.png
Type: image/png
Size: 29857 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110812/5cff119f/attachment-0001.png">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20110812/5cff119f/attachment-0001.png</A>&gt;
</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014571.html">[rabbitmq-discuss] Load Balanced Consumers?
</A></li>
	<LI>Next message: <A HREF="014545.html">[rabbitmq-discuss] major failure when clearing large queue backlog
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14534">[ date ]</a>
              <a href="thread.html#14534">[ thread ]</a>
              <a href="subject.html#14534">[ subject ]</a>
              <a href="author.html#14534">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
