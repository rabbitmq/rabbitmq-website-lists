<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] major failure when clearing large queue backlog
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20major%20failure%20when%20clearing%20large%20queue%0A%20backlog&In-Reply-To=%3C20110815132113.GF16780%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014534.html">
   <LINK REL="Next"  HREF="014556.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] major failure when clearing large queue backlog</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20major%20failure%20when%20clearing%20large%20queue%0A%20backlog&In-Reply-To=%3C20110815132113.GF16780%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] major failure when clearing large queue backlog">matthew at rabbitmq.com
       </A><BR>
    <I>Mon Aug 15 14:21:14 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014534.html">[rabbitmq-discuss] major failure when clearing large queue backlog
</A></li>
        <LI>Next message: <A HREF="014556.html">[rabbitmq-discuss] major failure when clearing large queue	backlog
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14545">[ date ]</a>
              <a href="thread.html#14545">[ thread ]</a>
              <a href="subject.html#14545">[ subject ]</a>
              <a href="author.html#14545">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Aaron,

On Fri, Aug 12, 2011 at 02:27:25PM -0400, Aaron Westendorf wrote:
&gt;<i> We've put two new rabbit 2.5 hosts into production at the same time as we
</I>&gt;<i> performed some other major upgrades to our software on 9 August. As
</I>&gt;<i> designed, our messages queued up in rabbit, and we slowly consumed them.
</I>&gt;<i> When the queues were empty, rabbit blew up and took out both hosts in the
</I>&gt;<i> cluster.
</I>
Not quite as designed. Do you have the logs available for these machines
from as they blew up that you can send us (maybe off list)?

&gt;<i> Shortly after the queues drained, rabbit became completely unresponsive. Our
</I>&gt;<i> `watch` process to list_queues and check on the state stopped running. We
</I>&gt;<i> observed heavy swap churn via kswapd[0-9]+. It appeared that rabbit was
</I>&gt;<i> trying to load in all of the data that it had paged to disk.  I've attached
</I>&gt;<i> graphs that show when this event occurred, but they're the weekly rollups so
</I>&gt;<i> it's hidden in the noise. The &quot;max&quot; column is the best record of the limits
</I>&gt;<i> that were hit, especially the &quot;committed&quot; value which is significantly
</I>&gt;<i> higher than the 8GB of RAM available.
</I>
To me, this sounds like Rabbit was about to crash. Sadly, Erlang is very
very poor at string handling. When processes in Erlang crash, they have
their last known state, stacktrace, and &quot;last message in&quot; dumped to the
log. This is fantastic from a debugging pov, but Erlang is so awful at
converting all this data to a string to put into the log, that I
regularly see Erlang eat GBs of RAM, eventually running out and then
swapping to death when converting a few MB of state to a string. This
seems to match what happened to you.

However, Rabbit certainly shouldn't have crashed, and we've had very few
crash reports with 2.5.1. It's possible that the logs contain at least
part of the reason for the crash, and if so, they'd help a lot. But
other than that there's very little for us to go on to try and help out.

If you have the logs available and if they contain errors then they'd be
of great help. Has Rabbit been behaving itself since or did you
downgrade back to your previously known-good version?

Best wishes,

Matthew
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014534.html">[rabbitmq-discuss] major failure when clearing large queue backlog
</A></li>
	<LI>Next message: <A HREF="014556.html">[rabbitmq-discuss] major failure when clearing large queue	backlog
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14545">[ date ]</a>
              <a href="thread.html#14545">[ thread ]</a>
              <a href="subject.html#14545">[ subject ]</a>
              <a href="author.html#14545">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
