<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20crashed%20in%20ets%3Ainsert_new%20-%20looks%0A%20like%20a%20genuine%20bug...&In-Reply-To=%3CCANVKUrWUzFZr%3D-H%3DzBBjypJKBzuOys0SEkAMdQSCXKfkGfEBRg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014521.html">
   <LINK REL="Next"  HREF="014524.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...</H1>
    <B>Eugene Kirpichov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20crashed%20in%20ets%3Ainsert_new%20-%20looks%0A%20like%20a%20genuine%20bug...&In-Reply-To=%3CCANVKUrWUzFZr%3D-H%3DzBBjypJKBzuOys0SEkAMdQSCXKfkGfEBRg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...">ekirpichov at gmail.com
       </A><BR>
    <I>Fri Aug 12 16:38:18 BST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="014521.html">[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
</A></li>
        <LI>Next message: <A HREF="014524.html">[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14523">[ date ]</a>
              <a href="thread.html#14523">[ thread ]</a>
              <a href="subject.html#14523">[ subject ]</a>
              <a href="author.html#14523">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matthew,

Thanks a lot for taking the time for investigation.

Do you refer to reproducing the INTERNAL_ERROR bug in tx.commit (which
only happened once and didn't cause a node crash), or to the bug that
was causing the node crash (and happened on a different node of the
cluster)?

I'm using RabbitMQ 2.5.1, Erlang R14B02, on Windows indeed.

By the way, I ran the stress test with even more stress on the cluster
several times afterwards and wasn't able to cause it to crash again,
though before that 2 of 2 tests crashed. So I was &quot;lucky&quot; in a sense.

On Fri, Aug 12, 2011 at 7:11 AM, Matthew Sackman &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at rabbitmq.com</A>&gt; wrote:
&gt;<i> On Fri, Aug 12, 2011 at 11:26:51AM +0100, Matthew Sackman wrote:
</I>&gt;&gt;<i> There is only one use of lists:any in the msg_store, and thus it's
</I>&gt;&gt;<i> fairly easy to work out what's happened: somehow, there's been an
</I>&gt;&gt;<i> attempt made to sync on disk a msg that turns out not to exist. This is,
</I>&gt;&gt;<i> unsurprisingly, an unexpected situation, hence the dramatic crash.
</I>&gt;<i>
</I>&gt;<i> I've now been able to reproduce it. For me, the following test causes
</I>&gt;<i> this:
</I>&gt;<i>
</I>&gt;<i> %%%%%%%%%%%
</I>&gt;<i> -module(test).
</I>&gt;<i> -include_lib(&quot;amqp_client/include/amqp_client.hrl&quot;).
</I>&gt;<i>
</I>&gt;<i> crash_tx() -&gt;
</I>&gt;<i> &#160; &#160;{ok, ConnDel} = amqp_connection:start(#amqp_params_network{}),
</I>&gt;<i> &#160; &#160;{ok, ChanDel} = amqp_connection:open_channel(ConnDel),
</I>&gt;<i> &#160; &#160;{ok, Conn} = amqp_connection:start(#amqp_params_network{}),
</I>&gt;<i> &#160; &#160;TxChanCount = 200,
</I>&gt;<i> &#160; &#160;TxChans = [begin
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {ok, ChanPubTx} = amqp_connection:open_channel(Conn),
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; amqp_channel:call(ChanPubTx, #'tx.select'{}),
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ChanPubTx
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; end || _ &lt;- lists:seq(1, TxChanCount)],
</I>&gt;<i> &#160; &#160;amqp_channel:call(
</I>&gt;<i> &#160; &#160; &#160;ChanDel, #'queue.declare' { queue = &lt;&lt;&quot;q&quot;&gt;&gt;, durable = true }),
</I>&gt;<i> &#160; &#160;Method = #'basic.publish'{ routing_key = &lt;&lt;&quot;q&quot;&gt;&gt; },
</I>&gt;<i> &#160; &#160;Content = #amqp_msg { props = #'P_basic'{ delivery_mode = 2 },
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;payload = &lt;&lt;0:8&gt;&gt; },
</I>&gt;<i> &#160; &#160;Rounds = lists:seq(1, 5),
</I>&gt;<i> &#160; &#160;PerRound = lists:seq(1, 1000),
</I>&gt;<i> &#160; &#160;Parent = self(),
</I>&gt;<i> &#160; &#160;PubPidTxs = [spawn(
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; fun () -&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; [begin
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;io:format(&quot;~p: ~p~n&quot;, [self(), R]),
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;amqp_channel:call(ChanPubTx, #'tx.commit'{}),
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;[ok = amqp_channel:cast(ChanPubTx, Method, Content)
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; || _ &lt;- PerRound]
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;end || R &lt;- Rounds],
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Parent ! publish_done,
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; amqp_channel:call(ChanPubTx, #'tx.commit'{})
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; end) || ChanPubTx &lt;- TxChans],
</I>&gt;<i> &#160; &#160;receive
</I>&gt;<i> &#160; &#160; &#160; &#160;publish_done -&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;io:format(&quot;Deleting queue...~n&quot;),
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;amqp_channel:call(ChanDel, #'queue.delete'{ queue = &lt;&lt;&quot;q&quot;&gt;&gt; }),
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;amqp_channel:close(ChanDel),
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;[exit(PubPidTx, kill) || PubPidTx &lt;- PubPidTxs],
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;[amqp_channel:close(ChanPubTx) || ChanPubTx &lt;- TxChans]
</I>&gt;<i> &#160; &#160;end,
</I>&gt;<i> &#160; &#160;amqp_connection:close(ConnDel),
</I>&gt;<i> &#160; &#160;[receive publish_done -&gt; ok end || _ &lt;- tl(TxChans)],
</I>&gt;<i> &#160; &#160;amqp_connection:close(Conn).
</I>&gt;<i> %%%%%%%%%%%%
</I>&gt;<i>
</I>&gt;<i> It's a nasty little bug. Basically, we have all sorts of optimisations
</I>&gt;<i> in place to make sure that when a queue is deleted, even if it has lots
</I>&gt;<i> of outstanding work to do, the queue can be deleted quickly. This
</I>&gt;<i> basically amounts to promoting the delete up the list of things to do,
</I>&gt;<i> the idea being that it can overtake writes and removes and such that
</I>&gt;<i> obviously are now not worth doing considering that the queue is going to
</I>&gt;<i> be deleted.
</I>&gt;<i>
</I>&gt;<i> It turns out that if in the list of things to do, you have a write, and
</I>&gt;<i> then a sync of that write, the write itself can be ignored owing to the
</I>&gt;<i> promoted deletion. But the sync doesn't get ignored, and so tries to
</I>&gt;<i> sync the msg to disk, but the msg isn't known about on disk because it's
</I>&gt;<i> been ignored, hence the not_found, hence the crash.
</I>&gt;<i>
</I>&gt;<i> The good news is that all of that code has changed quite a lot since
</I>&gt;<i> 2.5.1 and so I don't think this bug can happen if you run from default
</I>&gt;<i> (and consequently will be fixed in the next release). I think. I'll
</I>&gt;<i> continue checking through the code on default to be sure of this.
</I>&gt;<i>
</I>&gt;<i> Well found!
</I>&gt;<i>
</I>&gt;<i> Matthew
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>


-- 
Eugene Kirpichov
Principal Engineer, Mirantis Inc. <A HREF="http://www.mirantis.com/">http://www.mirantis.com/</A>
Editor, <A HREF="http://fprog.ru/">http://fprog.ru/</A>
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014521.html">[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
</A></li>
	<LI>Next message: <A HREF="014524.html">[rabbitmq-discuss] RabbitMQ crashed in ets:insert_new - looks like a genuine bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14523">[ date ]</a>
              <a href="thread.html#14523">[ thread ]</a>
              <a href="subject.html#14523">[ subject ]</a>
              <a href="author.html#14523">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
