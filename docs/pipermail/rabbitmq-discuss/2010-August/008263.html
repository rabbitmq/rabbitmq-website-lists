<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Cluster recovery due to network outages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20recovery%20due%20to%20network%20outages&In-Reply-To=%3C20100804134540.GA19625%40dakota.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008245.html">
   <LINK REL="Next"  HREF="008264.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Cluster recovery due to network outages</H1>
    <B>Alexandru Scvortov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Cluster%20recovery%20due%20to%20network%20outages&In-Reply-To=%3C20100804134540.GA19625%40dakota.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] Cluster recovery due to network outages">alexandru at rabbitmq.com
       </A><BR>
    <I>Wed Aug  4 14:45:40 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008245.html">[rabbitmq-discuss] Cluster recovery due to network outages
</A></li>
        <LI>Next message: <A HREF="008264.html">[rabbitmq-discuss] Cluster recovery due to network outages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8263">[ date ]</a>
              <a href="thread.html#8263">[ thread ]</a>
              <a href="subject.html#8263">[ subject ]</a>
              <a href="author.html#8263">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Aaron,

&gt;<i> =ERROR REPORT==== 1-Aug-2010::06:13:24 ===
</I>&gt;<i> ** Node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at caerbannog</A> not responding **
</I>&gt;<i> ** Removing (timedout) connection **
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 1-Aug-2010::06:13:24 ===
</I>&gt;<i> node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at caerbannog</A> down
</I>
As the error message suggests, it means mnesia timed out a connection to
another node.
 
There was a discussion about this a while ago
<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-March/006508.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-March/006508.html</A>

If you're expecting frequent short outages, you might consider
tweaking the timeout parameters as described above.

&gt;<i> A short time later the hosts recovered, also as we've seen before:
</I>&gt;<i> 
</I>&gt;<i> =INFO REPORT==== 1-Aug-2010::06:26:48 ===
</I>&gt;<i> node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at caerbannog</A> up
</I>&gt;<i> =ERROR REPORT==== 1-Aug-2010::06:26:48 ===
</I>&gt;<i> Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at bigwig</A>): ** ERROR ** mnesia_event got
</I>&gt;<i> {inconsistent_database, running_partitioned_network,
</I>&gt;<i>  <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at caerbannog</A>}
</I>&gt;<i> 
</I>&gt;<i> =ERROR REPORT==== 1-Aug-2010::06:26:48 ===
</I>&gt;<i> Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at bigwig</A>): ** ERROR ** mnesia_event got
</I>&gt;<i> {inconsistent_database, starting_partitioned_network
</I>&gt;<i> , <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at caerbannog</A>}
</I>&gt;<i> 
</I>
During the outage, the nodes were out of contact with each other for
so long that mnesia is worried about possible inconsistencies.

The simplest solution would be to take down 3 of the nodes and
restart them.  This should allow them to sync with the fourth.

There's a longer explanation available here.

<A HREF="http://www.erlang.org/doc/apps/mnesia/Mnesia_chap7.html#id2277661">http://www.erlang.org/doc/apps/mnesia/Mnesia_chap7.html#id2277661</A>

&gt;<i> Another 15 minutes later and the timedout errors were logged and that
</I>&gt;<i> was the end of the cluster; I think two of the nodes figured out how
</I>&gt;<i> to connect back to each other, but two others remained on their own.
</I>&gt;<i> The hosts and nodes themselves never shutdown, and when I restarted
</I>&gt;<i> just one of the nodes later in the day, the whole cluster rediscovered
</I>&gt;<i> itself and all appeared to be well (`rabbitmqctl status` was
</I>&gt;<i> consistent with expectations).
</I>&gt;<i> 
</I>&gt;<i> So our first problem is that the nodes did not re-cluster after the
</I>&gt;<i> second outage.
</I>
If this was caused by the inconsistent_database errors, there's not
much you can do apart from a restart of some of the nodes.

&gt;<i> Once we corrected the cluster though, our applications
</I>&gt;<i> still did not respond and we had to restart all of our clients.
</I>&gt;<i> 
</I>&gt;<i> Our clients all have a lot of handling for connection drops and
</I>&gt;<i> channel closures, but most of them did not see any TCP disconnects to
</I>&gt;<i> their respective nodes.  When the cluster was fixed, we found a lot of
</I>&gt;<i> our queues missing (they weren't durable), and so we had to restart
</I>&gt;<i> all of the apps to redeclare the queues.  This still didn't fix our
</I>&gt;<i> installation though, as our apps were receiving and processing data,
</I>&gt;<i> but responses were not being sent back out of our HTTP translators.
</I>&gt;<i> 
</I>&gt;<i> We have a single exchange, &quot;response&quot; that any application expecting a
</I>&gt;<i> response can bind to.  Our HTTP translators handle traffic from our
</I>&gt;<i> public endpoints, publish to various exchanges for the services we
</I>&gt;<i> offer, and those services in turn write back to the response exchange.
</I>&gt;<i>  We have a monitoring tool that confirmed that these translators could
</I>&gt;<i> write a response to its own Rabbit host and immediately receive it (a
</I>&gt;<i> ping, more or less).  However, none of the responses from services
</I>&gt;<i> which were connected to other Rabbit nodes were received by the
</I>&gt;<i> translators.
</I>&gt;<i> 
</I>&gt;<i> In short, it appeared that even though the cluster was healed and all
</I>&gt;<i> our services had re-declared their queues, the bindings between the
</I>&gt;<i> response exchange and the queues which our translators use did not
</I>&gt;<i> appear to propagate to the rest of the nodes in the cluster.
</I>
That doesn't sound right.  As you say, if the cluster was indeed
running, the queues/exhanges/bindings should have appeared on all of the
nodes.

It's possible that the rabbit nodes reconnected succesfully, but the
mnesia ones didn't.  When a rabbitmq node detects another has gone
down, it automatically removes the queues declared on it from the
cluster.  If the rabbit nodes think everything is fine, this removal
wouldn't happen.  As a result, rabbitmqctl might report
queues/exchanges/bindings that are actually unusable.

&gt;<i> So in summary,
</I>&gt;<i> 
</I>&gt;<i> * Rabbit didn't re-connect to the other nodes after the second TCP disconnect
</I>
We don't have any logic in the broker to recover from
inconsistent_database errors.  Your best bet is probably to restart
all but one of the nodes.

&gt;<i> * After fixing the cluster (manually or automatically), Rabbit appears
</I>&gt;<i> to have lost its non-durable queues even though the nodes never
</I>&gt;<i> stopped
</I>&gt;<i> * Although we had every indication that exchanges and queues were
</I>&gt;<i> still alive and functional, bindings appear to have been lost between
</I>&gt;<i> Rabbit nodes
</I>
See above.  The cluster may not have been completely repaired.  Try
restarting.

&gt;<i> What we'd like to know is,
</I>&gt;<i> 
</I>&gt;<i> * Does any of this make sense and can we add more detail to help fix any bugs?
</I>
It makes some sense.  Thanks for pointing this problem out.

&gt;<i> * Have there been fixes for these issues since 1.7.2 that we should deploy?
</I>
Not to this, sorry.

&gt;<i> * Is there anything we should add/change about our applications to
</I>&gt;<i> deal with these types of situations?
</I>
I'm not sure what you could do to prevent this.  This is more of a
mnesia problem.

Cheers,
Alex
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008245.html">[rabbitmq-discuss] Cluster recovery due to network outages
</A></li>
	<LI>Next message: <A HREF="008264.html">[rabbitmq-discuss] Cluster recovery due to network outages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8263">[ date ]</a>
              <a href="thread.html#8263">[ thread ]</a>
              <a href="subject.html#8263">[ subject ]</a>
              <a href="author.html#8263">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
