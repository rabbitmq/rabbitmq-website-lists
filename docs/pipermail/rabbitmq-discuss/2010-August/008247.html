<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ + amqplib (python)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20%2B%20amqplib%20%28python%29&In-Reply-To=%3Cyrv4ck4o9j7j9.fsf%40dwragg.eng.vmware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008246.html">
   <LINK REL="Next"  HREF="008262.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ + amqplib (python)</H1>
    <B>David Wragg</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20%2B%20amqplib%20%28python%29&In-Reply-To=%3Cyrv4ck4o9j7j9.fsf%40dwragg.eng.vmware.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ + amqplib (python)">david at rabbitmq.com
       </A><BR>
    <I>Mon Aug  2 17:36:42 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008246.html">[rabbitmq-discuss] RabbitMQ + amqplib (python)
</A></li>
        <LI>Next message: <A HREF="008262.html">[rabbitmq-discuss] RabbitMQ + amqplib (python)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8247">[ date ]</a>
              <a href="thread.html#8247">[ thread ]</a>
              <a href="subject.html#8247">[ subject ]</a>
              <a href="author.html#8247">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jared,

Jared Smith &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jaredtsmith at gmail.com</A>&gt; writes:
&gt;<i> Everything works good for the first pass where I send 100k
</I>&gt;<i> request/response pairs and I'm getting on the order of 4-5k rpc calls
</I>&gt;<i> per second.  To make amqplib have blocking semantics I registered a
</I>&gt;<i> callback with basic_consume and have that deposit messages that are
</I>&gt;<i> read into a blocking queue which the client thread reads from this; it
</I>&gt;<i> seems to work ok as far as I can tell.
</I>&gt;<i>
</I>&gt;<i> Problem I'm seeing is that on the second run of the program I get the
</I>&gt;<i> following errors:
</I>&gt;<i>
</I>&gt;<i> ==============client error=================
</I>[...]
&gt;<i> u'PRECONDITION_FAILED - timeout waiting for channel.flow_ok{active=false}',
</I>&gt;<i> (0, 0), '')
</I>&gt;<i> =======================================
</I>&gt;<i>
</I>&gt;<i> ============== matching server error ================
</I>[...]
&gt;<i> amqplib.client_0_8.exceptions.AMQPConnectionException: (503,
</I>&gt;<i> u'COMMAND_INVALID - basic.publish received after
</I>&gt;<i> channel.flow_ok{active=false}', (60, 40), 'Channel.basic_publish')
</I>&gt;<i> ==============================================
</I>
It's hard to be sure from the fragments of code you posted, but I wonder
if the issue is that you aren't acknowledging the messages?  To do this,
you either need to call basic_consume with no_ack=True (to tell rabbit
not to expect acknowledgements), or call basic_ack in your consuming
code to explicitly ack the messages.

If you don't acknowledge the messages, then they will stay in the queue,
and take up memory, eventually resulting in the channel.flow methods
indicated above.

You could confirm that this is the issue by doing a

    $ sudo rabbitmqctl list_queues

This will list the queues, along with the count of messages in each
queue.  If you do this after your first run, and see that a lot of
messages are still present, then it is very likely to be the lack of
acks causing the problem.

David

-- 
David Wragg
Staff Engineer, RabbitMQ
SpringSource, a division of VMware
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008246.html">[rabbitmq-discuss] RabbitMQ + amqplib (python)
</A></li>
	<LI>Next message: <A HREF="008262.html">[rabbitmq-discuss] RabbitMQ + amqplib (python)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8247">[ date ]</a>
              <a href="thread.html#8247">[ thread ]</a>
              <a href="subject.html#8247">[ subject ]</a>
              <a href="author.html#8247">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
