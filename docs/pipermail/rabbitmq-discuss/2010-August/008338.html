<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] New user : Help needed in understanding memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20New%20user%20%3A%20Help%20needed%20in%20understanding%0A%20memory%20usage&In-Reply-To=%3C20100810092951.GB6255%40dakota.vmair.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008336.html">
   <LINK REL="Next"  HREF="008339.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] New user : Help needed in understanding memory usage</H1>
    <B>Alexandru Scvor&#355;ov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20New%20user%20%3A%20Help%20needed%20in%20understanding%0A%20memory%20usage&In-Reply-To=%3C20100810092951.GB6255%40dakota.vmair.com%3E"
       TITLE="[rabbitmq-discuss] New user : Help needed in understanding memory usage">alexandru at rabbitmq.com
       </A><BR>
    <I>Tue Aug 10 10:31:42 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008336.html">[rabbitmq-discuss] New user : Help needed in understanding memory	usage
</A></li>
        <LI>Next message: <A HREF="008339.html">[rabbitmq-discuss] Strange behavior when accessing properties of a delivered message (in Java)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8338">[ date ]</a>
              <a href="thread.html#8338">[ thread ]</a>
              <a href="subject.html#8338">[ subject ]</a>
              <a href="author.html#8338">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Avanti,

If the memory usage is steadily increasing, you're probably not ack'ing
the messages.

Try running,
% rabbitmqctl list_queues name messages

That should list your queues and tell you how many ready and
unacknowledged there are.  If this number of messages is
steadily increasing, you're not ack'ing properly.

If that's the case, you can either set noAck to true (i.e. messages
don't need to be acknowledged), or explicitly ack them (like you're
doing now); just make sure that that code is being run with the right
arguments.

Cheers,
Alex

On Mon, Aug 09, 2010 at 04:59:15PM -0700, Avanti Nadgir wrote:
&gt;<i> I am experimenting with RabbitMQ on a rhel vm (ver 1.8.1)
</I>&gt;<i> Have started the broker and am able to publish and consume events till the resident memory usage of the broker peaks at about 400M (it keeps growing with the number of messages published even though the consumer is consuming events) After this the broker needs to be restarted to bring back the memory usage to 0 before more messages can be sent.
</I>&gt;<i> 
</I>&gt;<i> Attached is the code snippet of the publisher and consumer.  
</I>&gt;<i> =================================================================
</I>&gt;<i> Publisher :
</I>&gt;<i>                 factory.setHost(&quot;localhost&quot;);
</I>&gt;<i>                 factory.setPort(5672);
</I>&gt;<i>                 Connection conn = factory.newConnection();
</I>&gt;<i> 
</I>&gt;<i>                 Channel channel = conn.createChannel();
</I>&gt;<i> 
</I>&gt;<i>                 System.out.println(&quot;done creating conn&quot;);
</I>&gt;<i>                 String exchangeName = &quot;testExchange&quot;;
</I>&gt;<i>                 String queueName = &quot;testQueueNew&quot;;
</I>&gt;<i>                 String routingKey = &quot;&quot;;
</I>&gt;<i>                 channel.exchangeDeclare(exchangeName, &quot;direct&quot;, true);
</I>&gt;<i>                 channel.queueDeclare(queueName, true, false, true, null);
</I>&gt;<i>                 channel.queueBind(queueName, exchangeName, routingKey);
</I>&gt;<i> 
</I>&gt;<i>                 byte[] messageBodyBytes = new byte[2000];
</I>&gt;<i>                 for(int j = 0;j&lt;2000;j++) {
</I>&gt;<i>                         messageBodyBytes[j] = 'A';
</I>&gt;<i>                 }
</I>&gt;<i>                 for(int i = 0; i &lt; numMessages; i++) {
</I>&gt;<i>                         channel.basicPublish(exchangeName, routingKey, null, messageBodyBytes);
</I>&gt;<i>                         if(sleepInterval != 0) {
</I>&gt;<i>                                 if (i % sleepInterval == 0) {
</I>&gt;<i>                                         Thread.sleep(timeToSleep);
</I>&gt;<i>                                         System.out.println(&quot;Published Message &quot; + i);
</I>&gt;<i>                                 }
</I>&gt;<i>                         }
</I>&gt;<i>                 }
</I>&gt;<i> 
</I>&gt;<i>                 channel.close();
</I>&gt;<i>                 conn.close();
</I>&gt;<i> ==================================================================
</I>&gt;<i> Consumer :
</I>&gt;<i>                 ConnectionFactory factory = new ConnectionFactory();
</I>&gt;<i>                 factory.setHost(&quot;localhost&quot;);
</I>&gt;<i>                 factory.setPort(5672);
</I>&gt;<i>                 Connection conn = factory.newConnection();
</I>&gt;<i>                 Channel channel = conn.createChannel();
</I>&gt;<i> 
</I>&gt;<i>                 String exchangeName = &quot;testExchange&quot;;
</I>&gt;<i>                 String routingKey = &quot;&quot;;
</I>&gt;<i>                 String queueName = &quot;testQueue&quot;;
</I>&gt;<i>                 channel.exchangeDeclare(exchangeName, &quot;direct&quot;, true);
</I>&gt;<i>                 channel.queueBind(queueName, exchangeName, routingKey);
</I>&gt;<i> 
</I>&gt;<i>                 boolean noAck = false;
</I>&gt;<i>                 QueueingConsumer consumer = new QueueingConsumer(channel);
</I>&gt;<i>                 channel.basicConsume(queueName, noAck, consumer);
</I>&gt;<i>                 int count = 0;
</I>&gt;<i>                 while (count &lt; numMessages) {
</I>&gt;<i>                     count++;
</I>&gt;<i>                     QueueingConsumer.Delivery delivery;
</I>&gt;<i>                     try {
</I>&gt;<i>                         delivery = consumer.nextDelivery();
</I>&gt;<i>                     } catch (InterruptedException ie) {
</I>&gt;<i>                         continue;
</I>&gt;<i>                     }
</I>&gt;<i>                     // (process the message components ...)
</I>&gt;<i> 
</I>&gt;<i>                         byte[] body = delivery.getBody();
</I>&gt;<i>                         String resp = new String(body);
</I>&gt;<i>                         channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
</I>&gt;<i>                 }
</I>&gt;<i> 
</I>&gt;<i>                 channel.close();
</I>&gt;<i>                 conn.close();
</I>&gt;<i> 
</I>&gt;<i> ===================================================================================
</I>&gt;<i> Any help is appreciated.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> Avanti
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008336.html">[rabbitmq-discuss] New user : Help needed in understanding memory	usage
</A></li>
	<LI>Next message: <A HREF="008339.html">[rabbitmq-discuss] Strange behavior when accessing properties of a delivered message (in Java)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8338">[ date ]</a>
              <a href="thread.html#8338">[ thread ]</a>
              <a href="subject.html#8338">[ subject ]</a>
              <a href="author.html#8338">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
