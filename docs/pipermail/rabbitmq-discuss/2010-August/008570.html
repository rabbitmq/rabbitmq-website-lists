<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] problem with new persiter with 1000	topics/queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20with%20new%20persiter%20with%201000%0A%09topics/queues&In-Reply-To=%3C111467.41327.qm%40web31811.mail.mud.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008569.html">
   <LINK REL="Next"  HREF="008571.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] problem with new persiter with 1000	topics/queues</H1>
    <B>alex chen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20with%20new%20persiter%20with%201000%0A%09topics/queues&In-Reply-To=%3C111467.41327.qm%40web31811.mail.mud.yahoo.com%3E"
       TITLE="[rabbitmq-discuss] problem with new persiter with 1000	topics/queues">chen650 at yahoo.com
       </A><BR>
    <I>Wed Aug 25 05:37:06 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008569.html">[rabbitmq-discuss] problem with new persiter with 1000	topics/queues
</A></li>
        <LI>Next message: <A HREF="008571.html">[rabbitmq-discuss] problem with new persiter with 1000	topics/queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8570">[ date ]</a>
              <a href="thread.html#8570">[ thread ]</a>
              <a href="subject.html#8570">[ subject ]</a>
              <a href="author.html#8570">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Using  the C client is fine. What's missing from what you sent us so far is:
</I>
&gt;<i> - the  producer code
</I>
this could be the amqp_producer.c in rabbitmq-c/examples.  simply modify the 
code to accept the topic name and message size from command line.

&gt;<i> - how exactly you are invoking the producer and consumer (&quot;1000  
</I>&gt;<i>amqp_consumers&quot; - but with what args?, etc)
</I>
i use 3 bash shell scripts (bind.sh, producer.sh, consumer.sh):

# bind.sh
for i in {1..1000}
do
   topic=t.$i
   queue=$topic_q
   amqp_bind $topic $queue  &amp;
done

# producer.sh
for i in {1..1000}
do
   topic=t.$i
   let message_size=20*1024   # 20KB 
   amqp_producer $topic $message_size  &amp;
done

# consumer.sh, bind 1000 topics to 1000 queues
for i in {1..1000}
do
   topic=t.$i
   queue=$topic_q
   amqp_consumer $topic $queue  &amp;
done

the test steps are:
1) run bind.sh
2) run producer.sh
3) run the following command the monitor the total size of messages stored:
$ watch --interval 5 &quot;du -hs $rabbitmq_server_dir/rabbit/$message_store_dir&quot;

4) after the output from 3) reaches 200 GB, stop the producers by running:
$ pkill amqp_producer

5) run consumer.sh

after step 5), running &quot;top&quot; command will show the beam process would use about 
10 GB of memory.

&gt;<i> - what exactly it is you are  looking at / measuring - e.g. you mentioned 
</I>&gt;<i>something about 200GB of message  data, how is that figure calculated?
</I>
see the step 3) above.  another way is using &quot;rabbitmqctl list_queues&quot; to get 
the total message counts.  however, i found rabbitmqctl always return errors 
when the broker is busy (e.g. during step 5), so using &quot;du -hs&quot; is a good 
alternative.

our recent test shows that if you run producer.sh and consumer.sh at the same 
time (without 200 GB messages backed up), the broker process would also use 
large amount of mem (around 6 GB).  this way you can reproduce the high mem 
usage problem without waiting long time for the 200 GB messages backed up.

please feel free to let me know if you need further info.
thanks.

-alex



      
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008569.html">[rabbitmq-discuss] problem with new persiter with 1000	topics/queues
</A></li>
	<LI>Next message: <A HREF="008571.html">[rabbitmq-discuss] problem with new persiter with 1000	topics/queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8570">[ date ]</a>
              <a href="thread.html#8570">[ thread ]</a>
              <a href="subject.html#8570">[ subject ]</a>
              <a href="author.html#8570">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
