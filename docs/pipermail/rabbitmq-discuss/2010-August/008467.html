<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] problem with new persiter with 1000	topics/queues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20with%20new%20persiter%20with%201000%0A%09topics/queues&In-Reply-To=%3C529232.46115.qm%40web31809.mail.mud.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008466.html">
   <LINK REL="Next"  HREF="008483.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] problem with new persiter with 1000	topics/queues</H1>
    <B>alex chen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20problem%20with%20new%20persiter%20with%201000%0A%09topics/queues&In-Reply-To=%3C529232.46115.qm%40web31809.mail.mud.yahoo.com%3E"
       TITLE="[rabbitmq-discuss] problem with new persiter with 1000	topics/queues">chen650 at yahoo.com
       </A><BR>
    <I>Tue Aug 17 18:59:33 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008466.html">[rabbitmq-discuss] problem with new persiter with 1000 topics/queues
</A></li>
        <LI>Next message: <A HREF="008483.html">[rabbitmq-discuss] problem with new persiter with 1000	topics/queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8467">[ date ]</a>
              <a href="thread.html#8467">[ thread ]</a>
              <a href="subject.html#8467">[ subject ]</a>
              <a href="author.html#8467">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> Hmm, that's unfortunate. Really, you should only be bound by disk  write
</I>
&gt;<i> speed at that point, and I'm sure your disks can do more than  10MB/sec.
</I>&gt;<i> You might try tuning the msg_store_file_size_limit setting: the  default
</I>&gt;<i> is 16777216 (i.e. 16MB), but try pushing that up to 67108864 (i.e.  64MB)
</I>&gt;<i> and you might find Rabbit can drive the disks harder. You'll need to  do
</I>&gt;<i> that in rabbitmq.config with something like:
</I>&gt;<i> 
</I>&gt;<i> [{rabbit,  [{msg_store_file_size_limit, 67108864}]}].
</I>
The 10MB/sec was due to the broker memory passed 0.4 mem watermark and started 
putting throttling the producer.
The problem is after the producer slowed down, the broker still could not 
recover from the high memory usage.
After i increased the watermark to 0.7, the publish rate could reach 80 MB/sec.  


&gt;<i> We can reproduce that  here. I have a few theories about this, but it's
</I>&gt;<i> really pending more testing  and debugging. Is there any chance you could
</I>&gt;<i> send us your test code - it'd be  good to see exactly what you're doing?
</I>
our code is based on the amqp_consumer.c from the rabbitmq-c/examples, with some 
modifications for durable exchange/queues.
however, it is mixed with lots of our internal functions.  i will try to make 
minimum modification to amqp_consumer.c to reproduce our test case, and send you 
that sample code.

&gt;<i> Mmm. Try seeing what happens if you reduce  the high watermark to 0.2 or
</I>&gt;<i> lower - yes, publishing will be slower, but it  might help with the
</I>&gt;<i> memory usage on consuming.
</I>
i will try that.

&gt;<i> We're not quite sure yet either I'm afraid. As I  say, I have a few
</I>&gt;<i> theories I want to test out but it could be an issue with  the Erlang
</I>&gt;<i> garbage collector. Also, what version of Erlang are you  using?
</I>
good point!  i forgot to mention that i tried both erlang 13B and 14A.
with 13B, the broker would use very high cpu (&gt;700% on our 8 core machine) while 
consuming 200 GB (even for 100 clusters), and the consuming rate would decline 
steadily during the test.
with 14A, the cpu stayed cool (about 200%) during both the 100 and 1000 clusters 
test.  the only problem is the mem usage.

thanks for looking into this!  

-alex



      
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008466.html">[rabbitmq-discuss] problem with new persiter with 1000 topics/queues
</A></li>
	<LI>Next message: <A HREF="008483.html">[rabbitmq-discuss] problem with new persiter with 1000	topics/queues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8467">[ date ]</a>
              <a href="thread.html#8467">[ thread ]</a>
              <a href="subject.html#8467">[ subject ]</a>
              <a href="author.html#8467">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
