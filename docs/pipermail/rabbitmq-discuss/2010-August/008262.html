<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ + amqplib (python)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20%2B%20amqplib%20%28python%29&In-Reply-To=%3CAANLkTi%3D0F%2B66uu88ZaF__PtSosaXM16FVbVheb1e5wMx%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008247.html">
   <LINK REL="Next"  HREF="008248.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ + amqplib (python)</H1>
    <B>Jared Smith</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20%2B%20amqplib%20%28python%29&In-Reply-To=%3CAANLkTi%3D0F%2B66uu88ZaF__PtSosaXM16FVbVheb1e5wMx%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ + amqplib (python)">jaredtsmith at gmail.com
       </A><BR>
    <I>Wed Aug  4 14:31:09 BST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008247.html">[rabbitmq-discuss] RabbitMQ + amqplib (python)
</A></li>
        <LI>Next message: <A HREF="008248.html">[rabbitmq-discuss] rabbitmqctl not reporting anything
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8262">[ date ]</a>
              <a href="thread.html#8262">[ thread ]</a>
              <a href="subject.html#8262">[ subject ]</a>
              <a href="author.html#8262">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the pointer looking at the queues was very helpful figured out I
was never cleaning out the server queues and I kept re-creating a new one
each time it was restarted and they were all bound to the same topic.  So
the sending of 100k messages from the client resulted in coping those 100k
messages into tens of queues making millions of copies of messages.

I changed the server queue to be non-durable and it looked like I can do
many passes with no crash now.

Thanks!

Jared

On Mon, Aug 2, 2010 at 11:36 AM, David Wragg &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">david at rabbitmq.com</A>&gt; wrote:

&gt;<i> Hi Jared,
</I>&gt;<i>
</I>&gt;<i> Jared Smith &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">jaredtsmith at gmail.com</A>&gt; writes:
</I>&gt;<i> &gt; Everything works good for the first pass where I send 100k
</I>&gt;<i> &gt; request/response pairs and I'm getting on the order of 4-5k rpc calls
</I>&gt;<i> &gt; per second.  To make amqplib have blocking semantics I registered a
</I>&gt;<i> &gt; callback with basic_consume and have that deposit messages that are
</I>&gt;<i> &gt; read into a blocking queue which the client thread reads from this; it
</I>&gt;<i> &gt; seems to work ok as far as I can tell.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Problem I'm seeing is that on the second run of the program I get the
</I>&gt;<i> &gt; following errors:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ==============client error=================
</I>&gt;<i> [...]
</I>&gt;<i> &gt; u'PRECONDITION_FAILED - timeout waiting for
</I>&gt;<i> channel.flow_ok{active=false}',
</I>&gt;<i> &gt; (0, 0), '')
</I>&gt;<i> &gt; =======================================
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ============== matching server error ================
</I>&gt;<i> [...]
</I>&gt;<i> &gt; amqplib.client_0_8.exceptions.AMQPConnectionException: (503,
</I>&gt;<i> &gt; u'COMMAND_INVALID - basic.publish received after
</I>&gt;<i> &gt; channel.flow_ok{active=false}', (60, 40), 'Channel.basic_publish')
</I>&gt;<i> &gt; ==============================================
</I>&gt;<i>
</I>&gt;<i> It's hard to be sure from the fragments of code you posted, but I wonder
</I>&gt;<i> if the issue is that you aren't acknowledging the messages?  To do this,
</I>&gt;<i> you either need to call basic_consume with no_ack=True (to tell rabbit
</I>&gt;<i> not to expect acknowledgements), or call basic_ack in your consuming
</I>&gt;<i> code to explicitly ack the messages.
</I>&gt;<i>
</I>&gt;<i> If you don't acknowledge the messages, then they will stay in the queue,
</I>&gt;<i> and take up memory, eventually resulting in the channel.flow methods
</I>&gt;<i> indicated above.
</I>&gt;<i>
</I>&gt;<i> You could confirm that this is the issue by doing a
</I>&gt;<i>
</I>&gt;<i>    $ sudo rabbitmqctl list_queues
</I>&gt;<i>
</I>&gt;<i> This will list the queues, along with the count of messages in each
</I>&gt;<i> queue.  If you do this after your first run, and see that a lot of
</I>&gt;<i> messages are still present, then it is very likely to be the lack of
</I>&gt;<i> acks causing the problem.
</I>&gt;<i>
</I>&gt;<i> David
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> David Wragg
</I>&gt;<i> Staff Engineer, RabbitMQ
</I>&gt;<i> SpringSource, a division of VMware
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100804/824dec6f/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100804/824dec6f/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008247.html">[rabbitmq-discuss] RabbitMQ + amqplib (python)
</A></li>
	<LI>Next message: <A HREF="008248.html">[rabbitmq-discuss] rabbitmqctl not reporting anything
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8262">[ date ]</a>
              <a href="thread.html#8262">[ thread ]</a>
              <a href="subject.html#8262">[ subject ]</a>
              <a href="author.html#8262">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
