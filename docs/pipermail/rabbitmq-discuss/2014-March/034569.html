<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer crash, redelivery and prefetch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20crash%2C%20redelivery%20and%20prefetch&In-Reply-To=%3C1394739062.3450.224.camel%40CLM3X4J.systran.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034570.html">
   <LINK REL="Next"  HREF="034571.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer crash, redelivery and prefetch</H1>
    <B>Thomas Riccardi</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20crash%2C%20redelivery%20and%20prefetch&In-Reply-To=%3C1394739062.3450.224.camel%40CLM3X4J.systran.local%3E"
       TITLE="[rabbitmq-discuss] Consumer crash, redelivery and prefetch">riccardi at systran.fr
       </A><BR>
    <I>Thu Mar 13 19:31:02 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034570.html">[rabbitmq-discuss] RabbitMQ Message Sequence Guarantee
</A></li>
        <LI>Next message: <A HREF="034571.html">[rabbitmq-discuss] Consumer crash, redelivery and prefetch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34569">[ date ]</a>
              <a href="thread.html#34569">[ thread ]</a>
              <a href="subject.html#34569">[ subject ]</a>
              <a href="author.html#34569">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Consumer crash, redelivery and prefetch

Hi,

I'm having issues with consumer crash, redelivery and prefetch:

The messages ack strategy I've chosen is to ack the message only after
the consumer has finished working on the message. I need this because I
cannot aford any lost message, even in case of consumer crash during the
work on the message.

For performance reason my consumer have a non 0 prefetch, so when my
consumer is handling a message (doing some work related to the message),
other messages are pushed to the client so that it has them already
available when it's done working on the previous message.

With this, when a message makes the consumer crash, the handled message
*and* the prefetched ones are re-queued, with the flag &quot;redelivered&quot; ==
1.

I currently have no other choice than rejecting all messages that have
the &quot;redelivered&quot; flag set to true, because I have no way to distinguish
the message that cause the crash from the prefetched ones that did
nothing wrong.
Indeed if I retry to work on a redelivered message, the consumer will
crash again on the poison message, in an infinite loop. However I would
like to not reject the previously prefetched messages since they are
probably OK.
This reasoning also applies to transient crashes that are not
systematically reproduced by the message.


Ideally the solution would be to be able to distinguish the first non
ack'd message from the other ones when the consumer crashes, or
alternatively having two types of ack : one &quot;I'm starting to work on
this message&quot;, and a second one &quot;I've finished working on this message&quot;.

Otherwise a redelivery count would do the trick (even if it means
working multiple times on a message that did make the consumer crash,
which is not efficient if we know crashes happen mostly systematically).

The redelivery count is a &quot;planned&quot; feature according to
<A HREF="http://www.rabbitmq.com/specification.html,">http://www.rabbitmq.com/specification.html,</A> but when will it be really
implemented?
Having a parameter per queue like the TTL to tell a maximum redelivery
count before dead lettering the message would be much helpful in my case
(a RPC above rabbitmq, which is probably not a highly specific and rare
use-case).


Thanks,
Thomas

</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034570.html">[rabbitmq-discuss] RabbitMQ Message Sequence Guarantee
</A></li>
	<LI>Next message: <A HREF="034571.html">[rabbitmq-discuss] Consumer crash, redelivery and prefetch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34569">[ date ]</a>
              <a href="thread.html#34569">[ thread ]</a>
              <a href="subject.html#34569">[ subject ]</a>
              <a href="author.html#34569">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
