<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] OOM kill
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20OOM%20kill&In-Reply-To=%3CAB272810-DDAD-4D3A-8201-D8DFC2652F7D%40alertme.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034387.html">
   <LINK REL="Next"  HREF="034392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] OOM kill</H1>
    <B>Dmitry Andrianov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20OOM%20kill&In-Reply-To=%3CAB272810-DDAD-4D3A-8201-D8DFC2652F7D%40alertme.com%3E"
       TITLE="[rabbitmq-discuss] OOM kill">dmitry.andrianov at alertme.com
       </A><BR>
    <I>Sat Mar  8 11:17:40 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034387.html">[rabbitmq-discuss] OOM kill
</A></li>
        <LI>Next message: <A HREF="034392.html">[rabbitmq-discuss] OOM kill
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34391">[ date ]</a>
              <a href="thread.html#34391">[ thread ]</a>
              <a href="subject.html#34391">[ subject ]</a>
              <a href="author.html#34391">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks very much for the explanation, Simon.

When you say Rabbit will gracefully stop accepting connections when ulimit is reached, are you talking about some action explicitly done by Rabbit itself when it sees limit approaching or is everything done by the OS?
If Rabbit does something - doesn't it make sense to do the same when memory is running low?

i will of course follow your advice and play with ulimit but it does not feel very reliable - even if I find ulimit value which works in that specific test case, it may stop working when message size changes.

Regarding plugin memory - it worth mentioning that we have couple of custom plugins including a custom authentication backend. Can these be the root cause? Is there anything that needs to be explicitly done by the plugin developer to make sure the memory is accounted correctly?

Thank you.

&gt;<i> On 7 Mar 2014, at 17:45, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 07/03/2014 5:16PM, Dmitry Andrianov wrote:
</I>&gt;&gt;<i> Hello.
</I>&gt;<i> 
</I>&gt;<i> Hi.
</I>&gt;<i> 
</I>&gt;&gt;<i> We are trying to load-test RabbitMQ server in different configurations
</I>&gt;&gt;<i> on Amazon EC2 node.
</I>&gt;&gt;<i> Most of our tests end with Linux OOM killer intervening and killing Rabbit.
</I>&gt;&gt;<i> That is something I cannot really understand especially given that it is
</I>&gt;&gt;<i> reproducible even with vm_memory_high_watermark set to 0.2 and no other
</I>&gt;&gt;<i> processes running on that box.
</I>&gt;&gt;<i> So if someone could shed some light onto that issue it would help a lot.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Below the status response not long before the process was killed:
</I>&gt;<i> 
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> 
</I>&gt;&gt;<i> Couple of strange things there are:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1. {vm_memory_limit,804643635} but still memory {total,1984625336}. How
</I>&gt;&gt;<i> is that possible? <A HREF="https://www.rabbitmq.com/memory.html">https://www.rabbitmq.com/memory.html</A> says that erlang
</I>&gt;&gt;<i> process can take twice the configured size so I expected that but it is
</I>&gt;&gt;<i> definitely more than twice.
</I>&gt;<i> 
</I>&gt;<i> The only ways RabbitMQ has of preventing memory use from increasing are to do with messages - when the memory alarm goes off it will stop accepting new messages, and before that point it will start trying to reduce memory use by paging messages out to disc.
</I>&gt;<i> 
</I>&gt;<i> Normally, messages are the biggest user of memory in RabbitMQ, so this approach works OK.
</I>&gt;<i> 
</I>&gt;<i> However, your test ends up causing RabbitMQ to end up using the majority of its memory in connection processes - you have 11k connections open, at about 120kB each.
</I>&gt;<i> 
</I>&gt;<i> We don't prevent RabbitMQ from accepting new connections when the memory alarm goes off since our main worry is messages - and those connections could be intending to consume messages and thus reduce memory pressure.
</I>&gt;<i> 
</I>&gt;<i> So I guess you might want to reduce the ulimit, so that RabbitMQ runs out of file descriptors before it runs out of memory (when it runs out of FDs it *will* stop accepting network connections gracefully).
</I>&gt;<i> 
</I>&gt;&gt;<i> 2. {plugins,-44730984} - how this one is possible?
</I>&gt;<i> 
</I>&gt;<i> That's a good question!
</I>&gt;<i> 
</I>&gt;<i> That value is calculated from (memory used by all plugins including management) - (memory used by the management database). So somehow the memory counter managed to determine that &quot;all plugins&quot; used less memory than just the management plugin. I'll look into that.
</I>&gt;<i> 
</I>&gt;<i> Cheers, Simon
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, Pivotal
</I>This email is for the use of the intended recipient(s) only.
If you have received this email in error, please notify the sender immediately and then delete it.
If you are not the intended recipient, you must not use, disclose or distribute this email without the
author's prior permission. AlertMe.com Ltd. is not responsible for any personal views expressed
in this message or any attachments that are those of the individual sender.

AlertMe.com Ltd, 30 Station Road, Cambridge, CB1 2RE, UK.
Registered in England, Company number 578 2908, VAT registration number GB 895 9914 42.


</PRE>

















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034387.html">[rabbitmq-discuss] OOM kill
</A></li>
	<LI>Next message: <A HREF="034392.html">[rabbitmq-discuss] OOM kill
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34391">[ date ]</a>
              <a href="thread.html#34391">[ thread ]</a>
              <a href="subject.html#34391">[ subject ]</a>
              <a href="author.html#34391">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
