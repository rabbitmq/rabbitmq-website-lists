<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Managing consumers (PHP, Symfony2, Capifony)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Managing%20consumers%20%28PHP%2C%20Symfony2%2C%20Capifony%29&In-Reply-To=%3CCAMcAHLUce4EVtcYa06j3YB-0_bnahCeghLzvuwdfKq3ng2SVVQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034472.html">
   <LINK REL="Next"  HREF="034470.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Managing consumers (PHP, Symfony2, Capifony)</H1>
    <B>Alvaro Videla</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Managing%20consumers%20%28PHP%2C%20Symfony2%2C%20Capifony%29&In-Reply-To=%3CCAMcAHLUce4EVtcYa06j3YB-0_bnahCeghLzvuwdfKq3ng2SVVQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Managing consumers (PHP, Symfony2, Capifony)">videlalvaro at gmail.com
       </A><BR>
    <I>Mon Mar 10 16:26:41 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034472.html">[rabbitmq-discuss] Managing consumers (PHP, Symfony2, Capifony)
</A></li>
        <LI>Next message: <A HREF="034470.html">[rabbitmq-discuss] Configuring cluster rabbitMQ on EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34475">[ date ]</a>
              <a href="thread.html#34475">[ thread ]</a>
              <a href="subject.html#34475">[ subject ]</a>
              <a href="author.html#34475">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Others might comment on this, but so far I've seen that people use the
bundle together with supervisord: <A HREF="http://supervisord.org/">http://supervisord.org/</A>

About start publishing once a set of tasks has been completed, your
publisher could listen on a queue X, and when one of your workers
consume the last message, it could publish a &quot;done&quot; message back in
the queue X. That way, your producer would know that it can continue
sending the new set of tasks.

About knowing the number of messages in the queue:  you can do that by
sending a passive queue declare, or by using the HTTP management API.

Regards,

Alvaro

On Mon, Mar 10, 2014 at 2:53 PM, Christian Riesen
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">christian.riesen at liip.ch</A>&gt; wrote:
&gt;<i> Hello everyone
</I>&gt;<i>
</I>&gt;<i> I'm using RabbitMQ over <A HREF="https://github.com/videlalvaro/RabbitMqBundle">https://github.com/videlalvaro/RabbitMqBundle</A> within
</I>&gt;<i> the Symfony2 PHP framework, which in turn uses
</I>&gt;<i> <A HREF="https://github.com/videlalvaro/php-amqplib">https://github.com/videlalvaro/php-amqplib</A> of course.
</I>&gt;<i>
</I>&gt;<i> I have imports to run that do a lot of traffic for about 3 hours per day and
</I>&gt;<i> the rest of the day do nothing. RabbitMQ is used to parallelize the imports
</I>&gt;<i> (raw data dumped in, processed data is written into storage).
</I>&gt;<i>
</I>&gt;<i> The goal is to have 5 consumers start and in case one dies, automatically
</I>&gt;<i> restarted, but always only 5 of them running at the same time. They all run
</I>&gt;<i> the same queue and exchange, though that could be different in the future.
</I>&gt;<i>
</I>&gt;<i> I was thinking of using a cronjob that checks every 5 minutes if something
</I>&gt;<i> is in the queue (still looking how to see that properly). If there is, it
</I>&gt;<i> checks if consumers are running and enough of them, and if not start them
</I>&gt;<i> since there are some needed. I'd use the idle timeout feature of the bundle
</I>&gt;<i> to shut down the consumers again if there is nothing to do anymore.
</I>&gt;<i>
</I>&gt;<i> We use capifony to deploy our application. Capifony deploys to a folder like
</I>&gt;<i> /dir/release/1/ and /dir/release/2/ then sets a symlink from /dir/current/
</I>&gt;<i> to the actual release directory 1 or 2. So the cronjob idea works well as it
</I>&gt;<i> would switch to the current deployed version if I point it to the consumer
</I>&gt;<i> in the &quot;current&quot; directory. Now I look for a bit a more in depth way to do
</I>&gt;<i> this, as I want the workers of the old version stopped when I deploy. With
</I>&gt;<i> the cronjob they would start on their own in the right version of course.
</I>&gt;<i> The setup runs on a Linux box, so anything I can use on there would be
</I>&gt;<i> highly helpful.
</I>&gt;<i>
</I>&gt;<i> To make everything a bit more interesting, I need a sort of locking system.
</I>&gt;<i> The queue is one, but multiple producers can fill it up. Then I have to wait
</I>&gt;<i> until all the parts in the queue are finished before I can start a second
</I>&gt;<i> set of import tasks (that relies on data from the first set). My current
</I>&gt;<i> approach was to just monitor the queue and wait for it to empty. Once the
</I>&gt;<i> system sees it empty (not 100% sure how to see that yet with the present
</I>&gt;<i> tools) it would start the next batch of imports.
</I>&gt;<i>
</I>&gt;<i> This setup I described is not how it has to be, but just my current path of
</I>&gt;<i> thinking on how to do it. I'd appreciate alternatives on how to do it. Any
</I>&gt;<i> pointers and posts that could help me with one or multiple of these topics
</I>&gt;<i> are much appreciated.
</I>&gt;<i>
</I>&gt;<i> Greetings,
</I>&gt;<i> Christian Riesen
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I></PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034472.html">[rabbitmq-discuss] Managing consumers (PHP, Symfony2, Capifony)
</A></li>
	<LI>Next message: <A HREF="034470.html">[rabbitmq-discuss] Configuring cluster rabbitMQ on EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34475">[ date ]</a>
              <a href="thread.html#34475">[ thread ]</a>
              <a href="subject.html#34475">[ subject ]</a>
              <a href="author.html#34475">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
