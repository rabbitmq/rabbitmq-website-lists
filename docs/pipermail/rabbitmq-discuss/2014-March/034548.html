<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Inconsistent Shovel Delivery
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Inconsistent%20Shovel%20Delivery&In-Reply-To=%3C53217D1B.1010506%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034535.html">
   <LINK REL="Next"  HREF="034538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Inconsistent Shovel Delivery</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Inconsistent%20Shovel%20Delivery&In-Reply-To=%3C53217D1B.1010506%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Inconsistent Shovel Delivery">simon at rabbitmq.com
       </A><BR>
    <I>Thu Mar 13 09:40:43 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034535.html">[rabbitmq-discuss] Inconsistent Shovel Delivery
</A></li>
        <LI>Next message: <A HREF="034538.html">[rabbitmq-discuss] Issues getting RabbitMQ running using apt-get
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34548">[ date ]</a>
              <a href="thread.html#34548">[ thread ]</a>
              <a href="subject.html#34548">[ subject ]</a>
              <a href="author.html#34548">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/03/2014 21:27, rparker wrote:
&gt;<i> We have a simple shovel that takes messages published to a queue on a
</I>&gt;<i> rabbitmq cluster by a custom Windows service (using Mass Transit ) and then
</I>&gt;<i> shovels these messages across a WAN to a fanout exchange on a remote
</I>&gt;<i> rabbitmq cluster that routes to a queue of the same name on that remote
</I>&gt;<i> cluster.  Here's the basic config:
</I>
&lt;snip&gt;

The config looks fine.

&gt;<i> So, what's happening is that only every other message makes it to the
</I>&gt;<i> ultimate queue on the remote cluster.  We originally were addressing the
</I>&gt;<i> remote cluster via a load balancer and we thought this was an easy culprit,
</I>&gt;<i> but after changing the shovel config to go directly to the master node of
</I>&gt;<i> the remote cluster bypassing the LB, the problem still persisted.  We tried
</I>&gt;<i> decoupling both clusters and shoveling between two standalone nodes, and the
</I>&gt;<i> problem still persisted.  We tried unconfiguring shovel and published
</I>&gt;<i> directly to the exchanges/queues on both the local and remote clusters and
</I>&gt;<i> the correct number of messages were published.  Its only when shoveling is
</I>&gt;<i> used that we are getting an inconsistent number of messages, and when
</I>&gt;<i> examining the messages it shows that exactly every other message is making
</I>&gt;<i> it to the remote cluster.  No errors are evident in the log file and when I
</I>&gt;<i> show a status of the shovel, it shows it as running:
</I>
&lt;snip&gt;

Which also looks fine.

&gt;<i> What on earth would cause this behavior other than some sort of faulty
</I>&gt;<i> firewall?  Why would only shovel messages be affected and not directly
</I>&gt;<i> published messages?
</I>
It is very very hard to believe that the shovel is throwing away every 
other message: there's absolutely nothing in the shovel code that would 
even be able to do that.

Your shovel is in on_confirm mode - that means that messages will only 
get acked to the source broker once the destination broker has accepted 
them. So even if somehow the shovel were losing messages, it would 
manifest as the unacked message count growing forever on the source 
queue. I assume this is not happening!

The fact that you're losing exactly every other message strongly hints 
towards there being a second consumer somewhere, probably on the source 
queue. That could be another shovel, or a client app of yours. That's 
the only thing in RabbitMQ which will distribute messages in a round 
robin fashion like that. So first of all I'd check for a consumer you 
haven't seen. &quot;rabbitmqctl list_consumers&quot; or the queue details page in 
mgmt should help here.

&gt;<i> Is there a way to turn up the verbosity of the
</I>&gt;<i> shoveling logging?
</I>
Not in the shovel itself. But you could check what's happening on the 
wire with wireshark, or turn on the tracer 
<A HREF="http://www.rabbitmq.com/firehose.html.">http://www.rabbitmq.com/firehose.html.</A> Depending on your message volumes 
that could be a lot of extra verbosity though.

Cheers, Simon
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034535.html">[rabbitmq-discuss] Inconsistent Shovel Delivery
</A></li>
	<LI>Next message: <A HREF="034538.html">[rabbitmq-discuss] Issues getting RabbitMQ running using apt-get
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34548">[ date ]</a>
              <a href="thread.html#34548">[ thread ]</a>
              <a href="subject.html#34548">[ subject ]</a>
              <a href="author.html#34548">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
