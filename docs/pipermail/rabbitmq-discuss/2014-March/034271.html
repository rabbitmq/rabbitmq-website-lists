<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Blocking Queue - Close connection by client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Blocking%20Queue%20-%20Close%20connection%20by%20client&In-Reply-To=%3CCAK%2BmrqrER6DwPdZ_VA5D1yHryCHtc_7RzRsqZcHfM%3DOPbnX%3D_w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034282.html">
   <LINK REL="Next"  HREF="034272.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Blocking Queue - Close connection by client</H1>
    <B>Claire Fautsch</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Blocking%20Queue%20-%20Close%20connection%20by%20client&In-Reply-To=%3CCAK%2BmrqrER6DwPdZ_VA5D1yHryCHtc_7RzRsqZcHfM%3DOPbnX%3D_w%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Blocking Queue - Close connection by client">cfautsch at goodgamestudios.com
       </A><BR>
    <I>Mon Mar  3 08:18:06 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034282.html">[rabbitmq-discuss] Federation log
</A></li>
        <LI>Next message: <A HREF="034272.html">[rabbitmq-discuss] Blocking Queue - Close connection by client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34271">[ date ]</a>
              <a href="thread.html#34271">[ thread ]</a>
              <a href="subject.html#34271">[ subject ]</a>
              <a href="author.html#34271">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

we have following issue with blocking queues:

Once the memory watermark is reached, the connection from the client gets
blocked by the RabbitMQ server and it is no longer possible to publish
messages.

If this happens, we are for some time still able to publish  messages,
however they remain in the socket's write buffer and are not actually
published until the connection is un-blocked again. Once this buffer is
full, publishing blocks completely.

After some research we found out, that with a newer version of the official
Java client, it is possible to use blocked connection notifications to
react on this situation.

Our prefered reaction would be to close the connection, and re-connect to
another broker. Here however comes the problem: It is not possible to close
the connection to the RabbitMQ, as the method to do so, involves a flush on
the socket before the socket is closed and this is blocked as well.

Is there any possibility for a force-closed on the client side? Or is the
only possibility to open a new connection without closing the old one, and
&quot;let it die&quot;?

Re-writing the SocketFrameHandler would of course also be a  possibility,
but one we would (if possible) like to avoid. (see also discussion here :
<A HREF="https://github.com/rabbitmq/rabbitmq-java-client/issues/11">https://github.com/rabbitmq/rabbitmq-java-client/issues/11</A>)


Additionally, when we see blocking connections occurring, we frequently see
following stack trace in our logs, where we are not absolutely sure where
it comes from, or rather why it occurs

com.rabbitmq.client.ShutdownSignalException: connection error; reason:
java.io.EOFException

at com.rabbitmq.utility.ValueOrException.getValue(ValueOrException.java:67)

at
com.rabbitmq.utility.BlockingValueOrException.uninterruptibleGetValue(BlockingValueOrException.java:37)

at
com.rabbitmq.client.impl.AMQChannel$BlockingRpcContinuation.getReply(AMQChannel.java:349)

at com.rabbitmq.client.impl.ChannelN.close(ChannelN.java:569)

at com.rabbitmq.client.impl.ChannelN.close(ChannelN.java:501)

...

Caused by: java.io.EOFException

at com.rabbitmq.client.impl.ChannelN.close(ChannelN.java:494)at
java.io.DataInputStream.readUnsignedByte(Unknown Source)

at com.rabbitmq.client.impl.Frame.readFrom(Frame.java:95)

at
com.rabbitmq.client.impl.SocketFrameHandler.readFrame(SocketFrameHandler.java:131)

at
com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:515)


For information, we are currently using Java client,
com.rabbitmq:amqp-client version 3.1.4

and com.zanox.lib.rabbiteasy version:rabbiteasy-core version 1.2.0, for the
connection handling (SingleConnectionFactory) and publishing.

Thanks in advance for any hint or ideas.

Regards

Claire
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140303/0218e162/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140303/0218e162/attachment.html</A>&gt;
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034282.html">[rabbitmq-discuss] Federation log
</A></li>
	<LI>Next message: <A HREF="034272.html">[rabbitmq-discuss] Blocking Queue - Close connection by client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34271">[ date ]</a>
              <a href="thread.html#34271">[ thread ]</a>
              <a href="subject.html#34271">[ subject ]</a>
              <a href="author.html#34271">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
