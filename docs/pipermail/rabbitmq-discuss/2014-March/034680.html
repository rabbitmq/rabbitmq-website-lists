<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Rabbit slowing down on accepting messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rabbit%20slowing%20down%20on%20accepting%20messages&In-Reply-To=%3CCAFtA53yKKGBsdr8BH_9Jfije%3DM8hJUdUHS%3DQvpNx8ZQVoz-N-Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034678.html">
   <LINK REL="Next"  HREF="034681.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Rabbit slowing down on accepting messages</H1>
    <B>Ron Cordell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Rabbit%20slowing%20down%20on%20accepting%20messages&In-Reply-To=%3CCAFtA53yKKGBsdr8BH_9Jfije%3DM8hJUdUHS%3DQvpNx8ZQVoz-N-Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Rabbit slowing down on accepting messages">ron.cordell at gmail.com
       </A><BR>
    <I>Wed Mar 19 17:51:14 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034678.html">[rabbitmq-discuss] Rabbit slowing down on accepting messages
</A></li>
        <LI>Next message: <A HREF="034681.html">[rabbitmq-discuss] ANN Bunny 1.1.7 is released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34680">[ date ]</a>
              <a href="thread.html#34680">[ thread ]</a>
              <a href="subject.html#34680">[ subject ]</a>
              <a href="author.html#34680">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The queues are durable/mirrored; there are ~150 of them involved per
message.

The &quot;140K msgs/hr&quot; value means that a producer places a message on the
inbound queue. The application (consumers of this queue) processes the
messages using an asynchronous state machine that uses AMQP as a means of
pushing data to the next state of the processor (publishes/consumes). For
each state there are 2-3 queues such as process, retry, and error; there
are many states per message type. There are 6 application instances
connecting to the Rabbit cluster to process these messages. As a message
flows through the various states its metadata will flow through these
various queues until the processing activity is completed. We use
MassTransit and the .Net C# Rabbit driver on the application side which
implements this behavior. I mention/describe this to be as complete as
possible as we're not testing a single produce/consume type of scenario -
it's more complex as there are several processing states each
publishing/consuming to many different exchanges/queues.

CPU looked fine, Disk is fine, no latency observed - we're on a SAN capably
of 20K IOPs peak and we're not anywhere close to that.

Publishing is done in the MassTransit implementation using the .Net C#
driver, but it publishes then spawns another thread to wait for the ACK. So
the main processing keeps going, but if there is an exceptional return it
is handled elsewhere/asynchronously.

I did confirm that the entire Erlang process was stopped and restarted on
the Rabbit nodes; we will recreate the issue and try just stopping the app
and restarting. The VM's were not restarted nor were they migrated between
test runs.

Cheers,

Ron


On Wed, Mar 19, 2014 at 10:24 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;wrote:

&gt;<i> On 19/03/14 16:27, Ron Cordell wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Any suggestions on places to look to see what the underlying issue might
</I>&gt;&gt;<i> be?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The good news is that performance bottlenecks will get easier to diagnose
</I>&gt;<i> in 3.3.0. The bad news is it's not out yet.
</I>&gt;<i>
</I>&gt;<i> 140kmsg/h is only 40msg/s - so you should not have any difficulty hitting
</I>&gt;<i> that even on modest hardware. I assume the messages were persistent as well
</I>&gt;<i> as mirrored, but unless the messages were both very large and persistent
</I>&gt;<i> you should not have a problem there.
</I>&gt;<i>
</I>&gt;<i> Was anything on the broker looking busy (CPU, disk?) Did any of the
</I>&gt;<i> connections show a status of &quot;flow&quot;?
</I>&gt;<i>
</I>&gt;<i> If the answer to those questions is &quot;no&quot; then could you be publishing
</I>&gt;<i> (effectively) synchronously? Do you use mandatory publishing, publish
</I>&gt;<i> inside transactions, or use confirms in a non-streaming way (i.e. publish,
</I>&gt;<i> wait for confirm, repeat)?
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, Pivotal
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140319/1fa7e642/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140319/1fa7e642/attachment.html</A>&gt;
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034678.html">[rabbitmq-discuss] Rabbit slowing down on accepting messages
</A></li>
	<LI>Next message: <A HREF="034681.html">[rabbitmq-discuss] ANN Bunny 1.1.7 is released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34680">[ date ]</a>
              <a href="thread.html#34680">[ thread ]</a>
              <a href="subject.html#34680">[ subject ]</a>
              <a href="author.html#34680">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
