<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] OOM kill
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20OOM%20kill&In-Reply-To=%3C531A05A2.6020606%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034407.html">
   <LINK REL="Next"  HREF="034383.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] OOM kill</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20OOM%20kill&In-Reply-To=%3C531A05A2.6020606%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] OOM kill">simon at rabbitmq.com
       </A><BR>
    <I>Fri Mar  7 17:45:06 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034407.html">[rabbitmq-discuss] OOM kill
</A></li>
        <LI>Next message: <A HREF="034383.html">[rabbitmq-discuss] OOM kill
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34380">[ date ]</a>
              <a href="thread.html#34380">[ thread ]</a>
              <a href="subject.html#34380">[ subject ]</a>
              <a href="author.html#34380">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/03/2014 5:16PM, Dmitry Andrianov wrote:
&gt;<i> Hello.
</I>
Hi.

&gt;<i> We are trying to load-test RabbitMQ server in different configurations
</I>&gt;<i> on Amazon EC2 node.
</I>&gt;<i> Most of our tests end with Linux OOM killer intervening and killing Rabbit.
</I>&gt;<i> That is something I cannot really understand especially given that it is
</I>&gt;<i> reproducible even with vm_memory_high_watermark set to 0.2 and no other
</I>&gt;<i> processes running on that box.
</I>&gt;<i> So if someone could shed some light onto that issue it would help a lot.
</I>&gt;<i>
</I>&gt;<i> Below the status response not long before the process was killed:
</I>
&lt;snip&gt;

&gt;<i> Couple of strange things there are:
</I>&gt;<i>
</I>&gt;<i> 1. {vm_memory_limit,804643635} but still memory {total,1984625336}. How
</I>&gt;<i> is that possible? <A HREF="https://www.rabbitmq.com/memory.html">https://www.rabbitmq.com/memory.html</A> says that erlang
</I>&gt;<i> process can take twice the configured size so I expected that but it is
</I>&gt;<i> definitely more than twice.
</I>
The only ways RabbitMQ has of preventing memory use from increasing are 
to do with messages - when the memory alarm goes off it will stop 
accepting new messages, and before that point it will start trying to 
reduce memory use by paging messages out to disc.

Normally, messages are the biggest user of memory in RabbitMQ, so this 
approach works OK.

However, your test ends up causing RabbitMQ to end up using the majority 
of its memory in connection processes - you have 11k connections open, 
at about 120kB each.

We don't prevent RabbitMQ from accepting new connections when the memory 
alarm goes off since our main worry is messages - and those connections 
could be intending to consume messages and thus reduce memory pressure.

So I guess you might want to reduce the ulimit, so that RabbitMQ runs 
out of file descriptors before it runs out of memory (when it runs out 
of FDs it *will* stop accepting network connections gracefully).

&gt;<i> 2. {plugins,-44730984} - how this one is possible?
</I>
That's a good question!

That value is calculated from (memory used by all plugins including 
management) - (memory used by the management database). So somehow the 
memory counter managed to determine that &quot;all plugins&quot; used less memory 
than just the management plugin. I'll look into that.

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>






















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034407.html">[rabbitmq-discuss] OOM kill
</A></li>
	<LI>Next message: <A HREF="034383.html">[rabbitmq-discuss] OOM kill
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34380">[ date ]</a>
              <a href="thread.html#34380">[ thread ]</a>
              <a href="subject.html#34380">[ subject ]</a>
              <a href="author.html#34380">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
