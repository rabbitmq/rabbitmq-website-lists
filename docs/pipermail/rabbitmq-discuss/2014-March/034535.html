<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Inconsistent Shovel Delivery
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Inconsistent%20Shovel%20Delivery&In-Reply-To=%3C1394659648393-34070.post%40n5.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034542.html">
   <LINK REL="Next"  HREF="034548.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Inconsistent Shovel Delivery</H1>
    <B>rparker</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Inconsistent%20Shovel%20Delivery&In-Reply-To=%3C1394659648393-34070.post%40n5.nabble.com%3E"
       TITLE="[rabbitmq-discuss] Inconsistent Shovel Delivery">robert_parker at volusion.com
       </A><BR>
    <I>Wed Mar 12 21:27:28 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034542.html">[rabbitmq-discuss] SimpleAmqpClient Channel usage
</A></li>
        <LI>Next message: <A HREF="034548.html">[rabbitmq-discuss] Inconsistent Shovel Delivery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34535">[ date ]</a>
              <a href="thread.html#34535">[ thread ]</a>
              <a href="subject.html#34535">[ subject ]</a>
              <a href="author.html#34535">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We have a simple shovel that takes messages published to a queue on a
rabbitmq cluster by a custom Windows service (using Mass Transit ) and then
shovels these messages across a WAN to a fanout exchange on a remote
rabbitmq cluster that routes to a queue of the same name on that remote
cluster.  Here's the basic config:

  {rabbitmq_shovel,
             [ {shovels, [ {my_shovel,
                    [ {sources,
                        [ {broker, &quot;<A HREF="amqp://">amqp://</A>&quot; }
                        ]}
                    , {destinations,
                        [ {broker, &quot;<A HREF="amqp://guest:guest@server2:5672">amqp://guest:guest@server2:5672</A>&quot;}
                        ]}
                    , {queue, &lt;&lt;&quot;My_Queue&quot;&gt;&gt;}
                    , {prefetch_count, 100}
                    , {ack_mode, on_confirm}
                    , {publish_properties, [ {delivery_mode, 2} ]}
                    , {publish_fields, [ {exchange, &lt;&lt;&quot;My_Exchange&quot;&gt;&gt;}]}
                    , {reconnect_delay, 5}
                    ]}
                ]}
    ]}

So, what's happening is that only every other message makes it to the
ultimate queue on the remote cluster.  We originally were addressing the
remote cluster via a load balancer and we thought this was an easy culprit,
but after changing the shovel config to go directly to the master node of
the remote cluster bypassing the LB, the problem still persisted.  We tried
decoupling both clusters and shoveling between two standalone nodes, and the
problem still persisted.  We tried unconfiguring shovel and published
directly to the exchanges/queues on both the local and remote clusters and
the correct number of messages were published.  Its only when shoveling is
used that we are getting an inconsistent number of messages, and when
examining the messages it shows that exactly every other message is making
it to the remote cluster.  No errors are evident in the log file and when I
show a status of the shovel, it shows it as running:

[{my_shovel,
     {running,
         {source,
             {amqp_params_direct,&lt;&lt;&quot;guest&quot;&gt;&gt;,none,&lt;&lt;&quot;/&quot;&gt;&gt;,
                 <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at server1</A>,none,[]}},
         {destination,
             {amqp_params_network,&lt;&lt;&quot;guest&quot;&gt;&gt;,&lt;&lt;&quot;guest&quot;&gt;&gt;,&lt;&lt;&quot;/&quot;&gt;&gt;,
                 &quot;server2&quot;,5672,0,0,5,infinity,none,
                 [#Fun&lt;amqp_uri.7.121371571&gt;,#Fun&lt;amqp_uri.7.121371571&gt;],
                 [],[]}}},
     {{2014,3,12},{15,45,57}}}]
...done.

What on earth would cause this behavior other than some sort of faulty
firewall?  Why would only shovel messages be affected and not directly
published messages?  Is there a way to turn up the verbosity of the
shoveling logging?

RabbitMQ version is 3.2.4 with Erlang R16B03-1

Thanks in advance



--
View this message in context: <A HREF="http://rabbitmq.1065348.n5.nabble.com/Inconsistent-Shovel-Delivery-tp34070.html">http://rabbitmq.1065348.n5.nabble.com/Inconsistent-Shovel-Delivery-tp34070.html</A>
Sent from the RabbitMQ mailing list archive at Nabble.com.
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034542.html">[rabbitmq-discuss] SimpleAmqpClient Channel usage
</A></li>
	<LI>Next message: <A HREF="034548.html">[rabbitmq-discuss] Inconsistent Shovel Delivery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34535">[ date ]</a>
              <a href="thread.html#34535">[ thread ]</a>
              <a href="subject.html#34535">[ subject ]</a>
              <a href="author.html#34535">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
