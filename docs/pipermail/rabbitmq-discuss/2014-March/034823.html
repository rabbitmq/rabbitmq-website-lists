<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Client certificate based authentication over SSL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Client%20certificate%20based%20authentication%20over%20SSL&In-Reply-To=%3C2aa3c027-69af-401e-adc2-9dbd23a86cff%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034822.html">
   <LINK REL="Next"  HREF="034826.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Client certificate based authentication over SSL</H1>
    <B>Vinay Nayak</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Client%20certificate%20based%20authentication%20over%20SSL&In-Reply-To=%3C2aa3c027-69af-401e-adc2-9dbd23a86cff%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] Client certificate based authentication over SSL">virus.vinay at gmail.com
       </A><BR>
    <I>Thu Mar 27 14:56:56 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034822.html">[rabbitmq-discuss] Client certificate based authentication over SSL
</A></li>
        <LI>Next message: <A HREF="034826.html">[rabbitmq-discuss] Client certificate based authentication over SSL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34823">[ date ]</a>
              <a href="thread.html#34823">[ thread ]</a>
              <a href="subject.html#34823">[ subject ]</a>
              <a href="author.html#34823">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Hi there,


 We are trying to configure client certificate based authentication over 
SSL on our rabbitmq server. However we have hit an issue which we are 
unable to get past.


Can someone please help us figure out the solution?


Our configuration steps are as follows:


1)    Our RabbitMQ version is: 3.2.3 ErLang R16B03-1

2) We would like to achieve password-less authentication using client 
certificate and LDAP authorisation.

3) For client certificates, we installed a stand-alone microsoft pki 
certification authority on our windows server 2008 R2 machine

4) We then issued a client certificate via the certificate manager web 
portal i.e.

(<A HREF="https://&lt;servername">https://&lt;servername</A>&gt;/certmgr -&gt; Request a certificate -&gt; Advanced 
certificate request -&gt; Create and submit a request to this CA -&gt; Filled in 
the details (with Client Authentication Certificate option selected)-&gt; 
Submitted the request -&gt; Approved -&gt; Installed.

Please note the Name on the certificate was set as <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">username at domain.com</A> 
(which is the CN for the user name in AD)

5) We then issued an SSL certificate via the certificate manager web portal 
i.e. the same steps as above but this time had the &#8220;Server Authentication 
Certificate&#8221; selected

Please note the Name on the certificate was set as <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">machine at domain.com</A>

6) Downloaded the CA root certificate in .cer format and converted it into 
.pem using openssl

7) Downloaded the Server certificate (from step 5) in .pfx format. It was 
then separated into ServerCertificate.pem and ServerCertificateKey.pem 
using openssl

8) Downloaded the Client certificate (from step 4) in .pfx format. It was 
then separated into Cert.pem/ Key.pem and then combined into 
ClientCertificate.p12 using openssl

9) Our rabbitmq config is:


[{rabbit,


            [{auth_backends, [rabbit_auth_backend_ldap]},


            {auth_mechanisms, ['EXTERNAL']},


            {ssl_listeners, [{&quot;0.0.0.0&quot;, 5671}]},


            {ssl_options,


                        [{cacertfile,&quot;C:/Program Files (x86)/RabbitMQ 
Server/rabbitmq_server-3.2.3/certificates/pem/CARootCertificate.pem&quot;},


        {certfile,&quot;C:/Program Files (x86)/RabbitMQ 
Server/rabbitmq_server-3.2.3/certificates/pem/ServerCertificate.pem&quot;},


        {keyfile,&quot;C:/Program Files (x86)/RabbitMQ 
Server/rabbitmq_server-3.2.3/certificates/key/ServerCertificateKey.key&quot;},


        {verify,verify_peer},


        {fail_if_no_peer_cert,true}]},


            {ssl_cert_login_from, common_name}]


},


{rabbitmq_auth_backend_ldap,


            [


            {servers,               [&quot;xxxxxxx.yyyyy.com&quot;]},


            {dn_lookup_attribute,   &quot;userPrincipalName&quot;},


            {dn_lookup_base,        &quot;DC= yyyyy,DC=com&quot;},


            {use_ssl,               true},


            {port,                  636},


    {log,                   network},


    {vhost_access_query,    {in_group,


                                                                            
        &quot;ou=${vhost}-users,ou=computers,dc= yyyyy,dc=com&quot;}},


            {resource_access_query,


                        {for,


                                    [{permission, configure, {in_group, 
&quot;cn=domain users,dc= yyyyy,dc=com&quot;}},


                                    {permission, write,


              {for, [{resource, queue,    {in_group, &quot;cn=domain users,dc= 
yyyyy,dc=com&quot;}},


                                                            {resource, 
exchange, {constant, true}}]}},


             {permission, read,


              {for, [{resource, exchange, {in_group, &quot;cn=domain users,dc= 
yyyyy,dc=com&quot;}},


                     {resource, queue,    {constant, true}}]}}


            ]


                        }},


            {tag_queries,           [{administrator, {constant, true}},


                                                                            
        {management,    {constant, true}}]}


   ]}].


10) Our client code is:

            cf.Ssl.ServerName = &lt;CN Name of the server certificate i.e. 
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">machine at domain.com</A>&gt;

            cf.Ssl.CertPath = @&quot;C:\Program Files (x86)\RabbitMQ 
Server\rabbitmq_server-3.2.3\certificates\p12\ClientCertificate.p12&quot;;

            cf.Ssl.CertPassphrase = &quot;rabbitmq&quot;;

            cf.Ssl.Enabled = true;

            cf.Ssl.AcceptablePolicyErrors = 
System.Net.Security.SslPolicyErrors.RemoteCertificateNameMismatch |

            
System.Net.Security.SslPolicyErrors.RemoteCertificateChainErrors|

            
System.Net.Security.SslPolicyErrors.RemoteCertificateNotAvailable;


11) And following is our log:


=INFO REPORT==== 27-Mar-2014::14:35:23 ===


accepting AMQP connection &lt;0.322.0&gt; (a.b.c.d:2935 -&gt; a.b.c.d:5671)


 


=INFO REPORT==== 27-Mar-2014::14:35:23 ===


LDAP CHECK: passwordless login for <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">username at domain.com</A>


 


=ERROR REPORT==== 27-Mar-2014::14:35:26 ===


closing AMQP connection &lt;0.322.0&gt; (a.b.c.d:2935 -&gt; a.b.c.d:5671):


{handshake_error,starting,0,


    {exit,as_user_no_password,'connection.start_ok',


        [{rabbit_auth_backend_ldap,creds,2,[]},


         {rabbit_auth_backend_ldap,check_user_login,2,[]},


         {rabbit_access_control,'-check_user_login/2-fun-0-',4,[]},


         {lists,foldl,3,[{file,&quot;lists.erl&quot;},{line,1248}]},


         {rabbit_reader,auth_phase,2,[]},


         {rabbit_reader,handle_method0,3,[]},


         {rabbit_reader,handle_input,3,[]},


         {rabbit_reader,recvloop,2,[]}]}}


 


And the .net error is &#8220;Possibly caused by authentication failure&#8221;


 


Regards,


Vinay


 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140327/5362c523/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140327/5362c523/attachment.html</A>&gt;
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034822.html">[rabbitmq-discuss] Client certificate based authentication over SSL
</A></li>
	<LI>Next message: <A HREF="034826.html">[rabbitmq-discuss] Client certificate based authentication over SSL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34823">[ date ]</a>
              <a href="thread.html#34823">[ thread ]</a>
              <a href="subject.html#34823">[ subject ]</a>
              <a href="author.html#34823">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
