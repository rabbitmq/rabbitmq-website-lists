<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer crash, redelivery and prefetch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20crash%2C%20redelivery%20and%20prefetch&In-Reply-To=%3C1395082021.3450.332.camel%40CLM3X4J.systran.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034587.html">
   <LINK REL="Next"  HREF="034632.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer crash, redelivery and prefetch</H1>
    <B>Thomas Riccardi</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20crash%2C%20redelivery%20and%20prefetch&In-Reply-To=%3C1395082021.3450.332.camel%40CLM3X4J.systran.local%3E"
       TITLE="[rabbitmq-discuss] Consumer crash, redelivery and prefetch">riccardi at systran.fr
       </A><BR>
    <I>Mon Mar 17 18:47:01 GMT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034587.html">[rabbitmq-discuss] Consumer crash, redelivery and prefetch
</A></li>
        <LI>Next message: <A HREF="034632.html">[rabbitmq-discuss] Consumer crash, redelivery and prefetch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34629">[ date ]</a>
              <a href="thread.html#34629">[ thread ]</a>
              <a href="subject.html#34629">[ subject ]</a>
              <a href="author.html#34629">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the replies all, so we are not alone with this feature
request.


On ven., 2014-03-14 at 08:28 -0400, Laing, Michael wrote: 
&gt;<i> It's a good topic. 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In our std framework, based on python pika, a service may fail in
</I>&gt;<i> processing a message due to an exception being raised - something
</I>&gt;<i> unanticipated - the service will have chosen a default action to take
</I>&gt;<i> in that case when it was initialized, typically 'reject'. Typically it
</I>&gt;<i> will log a warning as well.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> We gather rejected messages in a 'reject' exchange and process them
</I>&gt;<i> enough (via their headers) to route them back to their originators as
</I>&gt;<i> well as to our own 'triage' queue.
</I>&gt;<i> 
</I>
This dead-lettering back to the originator using a headers dead-letter
exchange is a really useful pattern for RPC over RabbitMQ, I was
surprised to not find any mention of this in the readings or ML on the
subject.

(Alas it requires duplicating the &quot;replyTo&quot; information (one time in the
amqp standard message property, and a second time in a non standard
header, as there is no RabbitMQ exchange routing on the &quot;replyTo&quot;
property), or not using the standard &quot;replyTo&quot; at all.)

&gt;<i> 
</I>&gt;<i> Our messages all carry their processing history in their headers:
</I>&gt;<i> region, zone, instance, pid, service, timestamp, etc. - again part of
</I>&gt;<i> the framework.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> We also gather and coordinate the logs of all services on all
</I>&gt;<i> instances.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Additionally we replicate messages and process them in parallel
</I>&gt;<i> through our Core clusters in multiple regions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> A truly poison message will fail spectacularly everywhere. We have not
</I>&gt;<i> actually encountered one yet in production. We do get them in staging,
</I>&gt;<i> and bells go off everywhere.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> A failure of infrastructure will be localized to a region, zone,
</I>&gt;<i> instance, or supporting service like Cassandra or the AWS control
</I>&gt;<i> plane. Anticipated failures are retried. Unanticipated failures result
</I>&gt;<i> in rejection of that message replica but other replicas should
</I>&gt;<i> succeed. We do get these in production and can immediately tell where
</I>&gt;<i> failures occurred and take appropriate action, e.g. shifting load away
</I>&gt;<i> from failure if it has not yet taken place automatically.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Of course it would be nice to get more info upon rejection. We
</I>&gt;<i> compensate by creating context around rejection and coordinating the
</I>&gt;<i> context in near real time across the nyt&#10765;a&#1073;rik.
</I>&gt;<i> 
</I>
I think we will go with manual re-queueing (in the same queue) of
redelivered messages with a custom &quot;redelivery-count&quot; header manually
incremented, instead of currently just rejecting them.
Then, upon receiving a non-redelivered message, we reject it or not
according to the custom &quot;redelivery-count&quot; header.

It's a variation of the re-queueing to a &quot;probably poison&quot; second queue
technique mentioned earlier in this thread. Indeed I don't see why we
need a second queue when we can just modify a header and re-queue.

The only drawback is that we modify the message, which is avoided as
much as possible on the broker, but we are not on the broker so we can
do that without any issue.


Cheers,
Thomas 

</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034587.html">[rabbitmq-discuss] Consumer crash, redelivery and prefetch
</A></li>
	<LI>Next message: <A HREF="034632.html">[rabbitmq-discuss] Consumer crash, redelivery and prefetch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34629">[ date ]</a>
              <a href="thread.html#34629">[ thread ]</a>
              <a href="subject.html#34629">[ subject ]</a>
              <a href="author.html#34629">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
