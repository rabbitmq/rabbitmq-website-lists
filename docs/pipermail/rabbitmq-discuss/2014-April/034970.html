<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Upgrade fail
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Upgrade%20fail&In-Reply-To=%3C533D5DFB.5080405%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034950.html">
   <LINK REL="Next"  HREF="035105.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Upgrade fail</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Upgrade%20fail&In-Reply-To=%3C533D5DFB.5080405%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Upgrade fail">simon at rabbitmq.com
       </A><BR>
    <I>Thu Apr  3 14:11:23 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034950.html">[rabbitmq-discuss] Upgrade fail
</A></li>
        <LI>Next message: <A HREF="035105.html">[rabbitmq-discuss] Upgrade fail
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34970">[ date ]</a>
              <a href="thread.html#34970">[ thread ]</a>
              <a href="subject.html#34970">[ subject ]</a>
              <a href="author.html#34970">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/04/14 20:19, Peter Kopias wrote:
&gt;<i> Hi.
</I>&gt;<i>
</I>&gt;<i>   I've tried to upgrade my cluster to 3.3.0.
</I>
&lt;snip&gt;

&gt;<i> BOOT FAILED
</I>&gt;<i> ===========
</I>&gt;<i>
</I>&gt;<i> Timeout contacting cluster nodes: [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node3</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at node2</A>].
</I>&gt;<i>
</I>&gt;<i> DIAGNOSTICS
</I>&gt;<i> ===========
</I>&gt;<i>
</I>&gt;<i> attempted to contact: [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node3</A><A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">,rabbit at node2</A>]
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node3</A>:
</I>&gt;<i>    * found rabbit (port 25672)
</I>&gt;<i>    * TCP connection succeeded
</I>&gt;<i>    * suggestion: hostname mismatch?
</I>&gt;<i>    * suggestion: is the cookie set correctly?
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A>:
</I>&gt;<i>    * found rabbit (port 25672)
</I>&gt;<i>    * TCP connection succeeded
</I>&gt;<i>    * suggestion: hostname mismatch?
</I>&gt;<i>    * suggestion: is the cookie set correctly?
</I>
This is quite weird. The diagnostics indicate that there actually is 
some process up, registered with epmd and listening on the Erlang 
distribution port for both node2 and node3.

&gt;<i> WHY is it waiting for node2, node3, if node1 was the last to stop, and
</I>&gt;<i> it should come online in itself without them?
</I>
Very good question.

I was able to reproduce this precise error message by doing the 
equivalent of:

(stop node1)
rabbitmqctl -n node2 stop_app
rabbitmqctl -n node3 stop_app
(start node1)

i./e. leaving the Erlang VM running but stopping RabbitMQ (and Mnesia) 
on node2 and node3.

Is there any possibility at all you could have done something like this? 
Is there a beam.smp process running on those nodes?

I am especially puzzled since the nodes have registered 25672 as a 
distribution port - prior to 3.3.0 the distribution port would be chosen 
at random, or you could configure it. So the presence of 25672 strongly 
indicates that those nodes have been upgraded to 3.3.0 and are running 
an Erlang VM - with RabbitMQ stopped?

&gt;<i> The cookie is the same, the hostnames are correct.
</I>
If I am correct about the diagnosis above then the diagnostics don't 
currently handle this situation well; they don't check for the case 
where Erlang is running but RabbitMQ isn't. This will get fixed in the 
next release.

&gt;<i>   I'm trying to start node2 and node3 to have at least one running but
</I>&gt;<i> they always fail, even if I copied back the previous disk state, and
</I>&gt;<i> upgraded again...
</I>
How do they fail? Because it sounds like something is running.

&gt;<i>   Not a single node running currently, looks like I have to:
</I>&gt;<i>   - reinstall each rabbitmq-server with clean /var/lib/rabbitmq dirs
</I>&gt;<i>   - rebuild cluster
</I>&gt;<i>   - rebuild the virtual hosts
</I>&gt;<i>   - recreate all users and permissions
</I>&gt;<i>   - all queues and exchanges and policies
</I>&gt;<i>
</I>&gt;<i>   Thats not the way upgrade should happen. :(
</I>
No, it really isn't. :-(

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034950.html">[rabbitmq-discuss] Upgrade fail
</A></li>
	<LI>Next message: <A HREF="035105.html">[rabbitmq-discuss] Upgrade fail
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34970">[ date ]</a>
              <a href="thread.html#34970">[ thread ]</a>
              <a href="subject.html#34970">[ subject ]</a>
              <a href="author.html#34970">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
