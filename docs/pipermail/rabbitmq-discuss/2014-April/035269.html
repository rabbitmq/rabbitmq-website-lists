<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] java client reconnect error: attempt to reuse consumer tag
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20java%20client%20reconnect%20error%3A%20attempt%20to%0A%20reuse%20consumer%20tag&In-Reply-To=%3C0000014557a49e52-18d53c41-5f6a-4bd1-b035-df84ed467e2f-000000%40email.amazonses.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035260.html">
   <LINK REL="Next"  HREF="035270.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] java client reconnect error: attempt to reuse consumer tag</H1>
    <B>James Bellenger</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20java%20client%20reconnect%20error%3A%20attempt%20to%0A%20reuse%20consumer%20tag&In-Reply-To=%3C0000014557a49e52-18d53c41-5f6a-4bd1-b035-df84ed467e2f-000000%40email.amazonses.com%3E"
       TITLE="[rabbitmq-discuss] java client reconnect error: attempt to reuse consumer tag">james at bellenger.org
       </A><BR>
    <I>Sat Apr 12 21:32:57 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035260.html">[rabbitmq-discuss] java client reconnect error: attempt to reuse consumer tag
</A></li>
        <LI>Next message: <A HREF="035270.html">[rabbitmq-discuss] java client reconnect error: attempt to reuse consumer tag
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35269">[ date ]</a>
              <a href="thread.html#35269">[ thread ]</a>
              <a href="subject.html#35269">[ subject ]</a>
              <a href="author.html#35269">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the pointer, Michael.
In looking at the client code again, 
AutorecoveringConnection.recoverConsumers modifies the consumer map 
while iterating over it. This can change the map ordering and lead to 
recovering the same consumer twice. It looks like a similar thing 
happens in recoverQueues. I've attached a small patch that fixes the 
issue.

Thanks!
James


On 2014-04-12 03:36, Michael Klishin wrote:
&gt;<i> &#160;On 12 April 2014 at 02:39:53, James Bellenger (<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">james at bellenger.org</A>) 
</I>&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; On my machine, recovery appears to work at fewer than about 5
</I>&gt;&gt;<i> consumers. Anything over that, and the client gets a stream of
</I>&gt;&gt;<i> TopologyRecoveryExceptions and is never able to reconnect.
</I>&gt;<i>
</I>&gt;<i> This is annoying but reconnection happens before topology recovery, 
</I>&gt;<i> so
</I>&gt;<i> it is able to reconnect.
</I>&gt;<i>
</I>&gt;&gt;<i> I've looked at the client source and haven't seen any obvious
</I>&gt;&gt;<i> culprit.
</I>&gt;<i>
</I>&gt;<i> I cannot immediately say what may be going here but there is one
</I>&gt;<i> default = 5 in the client.
</I>&gt;<i>
</I>&gt;<i> ConsumerWorkService uses a 5 thread executor by default (instantiated
</I>&gt;<i> with&#160;Executors.newFixedThreadPool). Try setting a custom executor 
</I>&gt;<i> that
</I>&gt;<i> has, say, 64 threads and configure ConnectionFactory with it, and let 
</I>&gt;<i> us know
</I>&gt;<i> how it goes.
</I>&gt;<i> --
</I>&gt;<i> MK
</I>&gt;<i>
</I>&gt;<i> Software Engineer, Pivotal/RabbitMQ
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: recovery.patch
Type: text/x-java
Size: 1411 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140412/00154df2/attachment.java">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140412/00154df2/attachment.java</A>&gt;
</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035260.html">[rabbitmq-discuss] java client reconnect error: attempt to reuse consumer tag
</A></li>
	<LI>Next message: <A HREF="035270.html">[rabbitmq-discuss] java client reconnect error: attempt to reuse consumer tag
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35269">[ date ]</a>
              <a href="thread.html#35269">[ thread ]</a>
              <a href="subject.html#35269">[ subject ]</a>
              <a href="author.html#35269">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
