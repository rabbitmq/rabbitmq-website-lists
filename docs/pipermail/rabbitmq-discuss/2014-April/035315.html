<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Upgrade fail
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Upgrade%20fail&In-Reply-To=%3CCALPks8yQ_9cNMjdYHzz7ZVE2bfuVA8dXTc8kOzeayfMt948wBQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035209.html">
   <LINK REL="Next"  HREF="034951.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Upgrade fail</H1>
    <B>Peter Kopias</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Upgrade%20fail&In-Reply-To=%3CCALPks8yQ_9cNMjdYHzz7ZVE2bfuVA8dXTc8kOzeayfMt948wBQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Upgrade fail">kopias.peter at gmail.com
       </A><BR>
    <I>Tue Apr 15 00:23:32 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035209.html">[rabbitmq-discuss] Upgrade fail
</A></li>
        <LI>Next message: <A HREF="034951.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using	Consumers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35315">[ date ]</a>
              <a href="thread.html#35315">[ thread ]</a>
              <a href="subject.html#35315">[ subject ]</a>
              <a href="author.html#35315">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

 I've just noticed I had this email unsent, waiting in draft for a few days.

 So this is just for closing down the thread with &quot;feedback&quot;.

 It seems like, that erlang hangs sometimes, waiting for an empty list of
files, with no timeouts... it's probably fixed in version 17.

 Thank you for all your help,

 Peter


&gt;<i> Yes. The epmd process staying around is not related to anything else
</I>&gt;<i> you're seeing, that's how epmd is supposed to work.
</I>&gt;<i>
</I>&gt;<i> epmd is a very simple daemon which just maps names to port numbers for
</I>&gt;<i> Erlang (beam) processes. It doesn't contain any other state.
</I>
Ok.

 BTW IMO the &quot;unix way&quot; would be that if I start and stop something, the
machine should be in the state it was before. No processes left. :) But I
can live with this. :) We all like our systems well behaved and
deterministic. :)

   Node2 and node3 always exited with the message that they are not the
&gt;&gt;<i> one stopped the last, and if I removed the locks they tried to connect
</I>&gt;&gt;<i> to each other - while repairing the mnesia db, and as the network
</I>&gt;&gt;<i> connect failed (as they were not accepting connections probably because
</I>&gt;&gt;<i> the db repair was on), they quit, leaving the repair in half. So the
</I>&gt;&gt;<i> nodes were not able to communicate because of the db repair (this is a
</I>&gt;&gt;<i> theory only), and as the timeout arrived they quit before the repair
</I>&gt;&gt;<i> would finish. (It would be nice to have a message like &quot;starting repair&quot;
</I>&gt;&gt;<i> and &quot;repair finished&quot;, as the log message currently is not clear about
</I>&gt;&gt;<i> the state of the repair, I'm not sure that if the repair ends I'll get a
</I>&gt;&gt;<i> logitem.)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If you are talking about the upgrades, then
</I>&gt;<i>
</I>No. No upgrades. It was telling me, that some db files are damaged, and
needs to repair them. I'll copy the messages here, but they don't contain
too much information about what's the problem.

...


&gt;<i>  NOTE that, we have the &quot;K20rabbitmq-server stop&quot;  running, we have the
</I>&gt;&gt;<i> rabbitmq processes too, but currently neither rabbitmqctl nor management
</I>&gt;&gt;<i> plugin is accessible, and the reboot process hung.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So this is very weird. The beam process is still around, but everything in
</I>&gt;<i> the shutdown appears to have succeeded.
</I>&gt;<i>
</I>&gt;<i> By the time &quot;Halting Erlang VM&quot; appears in the logs RabbitMQ is completely
</I>&gt;<i> stopped, that log message is literally the last thing we do before telling
</I>&gt;<i> the VM to stop.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> No, it really shouldn't.
</I>&gt;<i>
</I>&gt;<i> The beam process has already unregistered from epmd (hence &quot;rabbit seems
</I>&gt;<i> not to be running at all&quot; in the status command above).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    The running rabbit processes and their open files are here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://pastebin.com/mLKf5mEu">http://pastebin.com/mLKf5mEu</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And it seems to have few files open, and to have closed all network
</I>&gt;<i> sockets.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    Any ideas? How can I debug this?
</I>&gt;&gt;<i>   Specific questions?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am not full of ideas here, this looks like more of an issue with Erlang
</I>&gt;<i> than RabbitMQ. But some things to look into:
</I>&gt;<i>
</I>&gt;<i> The beam process (2236 in your case) is the interesting one; it's the
</I>&gt;<i> thing that should have shut down but hasn't; everything else is pretty much
</I>&gt;<i> as expected. Unfortunately although it's an Erlang process it has stopped
</I>&gt;<i> listening for Erlang distribution messages so debugging it is likely to be
</I>&gt;<i> hard. Having said that, strace might give some clue as to what it's doing,
</I>&gt;<i> and the small bright side is that so much within that process has already
</I>&gt;<i> shut down that *anything* it is still doing is a good candidate for what's
</I>&gt;<i> making it stuck.
</I>&gt;<i>
</I>&gt;<i> So what does strace say for it?
</I>&gt;<i>
</I>&gt;<i>
</I>CUT STRAIGHT: This is probably the erlang bug that's been fixed in 17, as
you've written in the next email.

# strace -p 2236
Process 2236 attached
select(0, NULL, NULL, NULL, NULL

 that means:
 - zero filedescriptors to look for
 - empty read filedescriptorlist
 - empty write filedescriptorlist
 - empty exception filedescriptor list
 - empty timeout....

from select(2):

&quot;If timeout is NULL (no timeout), select() can block indefinitely.&quot;

This is the cpu-friendly version of

while(1);

 :)

 I'll try to unbalance this via sending the process signals sigint, sighup,
sigterm, sigkill...

Let's try: SIGINT (2)

.....

result:

Connection to ... closed by remote host.

(Note: we we're in a shutdown, when the hangup happened :D)

So, the problem is a &quot;wait for no files with no timeout&quot;, which MAY be the
same bug, erlang 17 has fixed, but we don't know for sure. :)


If someone founds a hanging rabbit process after stopping, strace it and
check whether its a 'select (0,null,null,null',  :)

Thanks Simon for your help again!

 Bye,

 Peter

   Thank you for your help, I hope these hangups could get eliminated.
&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I would hope so. We don't have much to go on though.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, Pivotal
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140415/f07d009f/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140415/f07d009f/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035209.html">[rabbitmq-discuss] Upgrade fail
</A></li>
	<LI>Next message: <A HREF="034951.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using	Consumers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35315">[ date ]</a>
              <a href="thread.html#35315">[ thread ]</a>
              <a href="subject.html#35315">[ subject ]</a>
              <a href="author.html#35315">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
