<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Fwd: Performance bottleneck on inter-node	connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fwd%3A%20Performance%20bottleneck%20on%20inter-node%0A%09connection&In-Reply-To=%3CCADEZEmyav6ZAWODertgEJt9BEgX6LAyoXpC6RC17Tcvtejqu8Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035284.html">
   <LINK REL="Next"  HREF="035369.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node	connection</H1>
    <B>joseph rouphael</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fwd%3A%20Performance%20bottleneck%20on%20inter-node%0A%09connection&In-Reply-To=%3CCADEZEmyav6ZAWODertgEJt9BEgX6LAyoXpC6RC17Tcvtejqu8Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node	connection">josephrouphael at gmail.com
       </A><BR>
    <I>Tue Apr 15 14:20:20 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035284.html">[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node connection
</A></li>
        <LI>Next message: <A HREF="035369.html">[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35337">[ date ]</a>
              <a href="thread.html#35337">[ thread ]</a>
              <a href="subject.html#35337">[ subject ]</a>
              <a href="author.html#35337">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Apr 14, 2014 at 12:00 PM, Matthias Radestock
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;wrote:

&gt;<i> On 11/04/14 17:37, joseph rouphael wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Test 8: Dual node, Queues/Consumers on same node, 20 queue, ACK off
</I>&gt;&gt;<i> -------------------------------------------------------------------
</I>&gt;&gt;<i> Nodes: Double node
</I>&gt;&gt;<i> Queues created on: Node1
</I>&gt;&gt;<i> Producers on: node 2
</I>&gt;&gt;<i> Consumers on: node 1
</I>&gt;&gt;<i> Producer Processes: 20
</I>&gt;&gt;<i> Producer regulate rate per process: 5KHZ
</I>&gt;&gt;<i> Acknowledgment: OFF
</I>&gt;&gt;<i> Expected rate: 100KHZ
</I>&gt;&gt;<i> Achieved rate: Fluctuating between 10KHZ and 20KHZ
</I>&gt;&gt;<i> CPU idle: 95%
</I>&gt;&gt;<i> Note: Bottleneck on inter-node connection
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What happens when you run the above test with both nodes on the same
</I>&gt;<i> machine?
</I>&gt;<i>
</I>
The result is almost the same: Fluctuating between 10 and 23KHZ (Expected
100KHZ). Here is below the summary:

Test 11: Dual nodes same machine, Queues/Consumers on same node, 20 queue,
ACK on/off
------------------------------------------------------------
-------------------------------------------------------------------------------
Nodes: Double nodes same machine
Queues created on: Node1
Producers on: node 2
Consumers on: node 1
Producer Processes: 20
Producer regulate rate per process: 5KHZ
Acknowledgment: OFF or ON same result
Expected rate: 100KHZ
Achieved rate: Fluctuating between 10KHZ and 23KHZ
CPU idle: 82%
Note: Bottleneck on inter-node connection



&gt;<i> Also, you really shouldn't need 20 producers/consumers to saturate a
</I>&gt;<i> broker, unless the machine has &gt;20 cores. So I'd be interested to hear what
</I>&gt;<i> the smallest producer/consumer count is at which you see a significant
</I>&gt;<i> performance difference between the single node and dual node case.
</I>&gt;<i>
</I>
The machine I am working on has 32 cores. So I am relaxed with the numbers
of processes.
1 producer/consumer achieve a maximum of 11 KHZ (No inter-node impact. On
single node it achieves the same)
2 producers/consumers achieve a maximum of ~ 20 KHZ (Minor inter-node
impact - expected 22KHZ)
3 producers/consumers achieve a maximum of ~ 20 KHZ (Major inter-node
impact - expected 33KHZ)

&gt;<i>
</I>&gt;<i> Finally, it would be helpful if you ran your tests using RabbitMQ's
</I>&gt;<i> standard performance testing tool, PerfTest -
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/java-tools.html#perftest.">http://www.rabbitmq.com/java-tools.html#perftest.</A> In order to replicate
</I>&gt;<i> the above scenario you'd run 20 PerfTest instances with options
</I>&gt;<i>   -u q&lt;n&gt; -x 0 -a
</I>&gt;<i> and 20 instances with
</I>&gt;<i>   -u q&lt;n&gt; -y 0
</I>&gt;<i> with n in 1..20.
</I>&gt;<i>
</I>&gt;<i>
</I>perftest ran as advised and the test produced the same result. There is a
real inter-node bottleneck.

Results of perftest:

Test 1: Double nodes same machine
----------
Node1 and Node2 on same machine
Node1 listening on port 5672
Node2 listening on port 5673
20 consumers running full speed
20 producers running full speed
Message size 1KB

Max rate achieved: 16KHZ
CPU Idle 92%
Note: Inter-node bottleneck

The script used to run the test:

#!/bin/sh

for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20
do
./runjava.sh com.rabbitmq.examples.PerfTest -k queue$i -x 0 -a -h <A HREF="amqp://">amqp://</A>
193.100.200.130:5673 -s 1000 &amp;
./runjava.sh com.rabbitmq.examples.PerfTest -k queue$i -y 0 -h <A HREF="amqp://">amqp://</A>
193.100.200.130:5672 -s 1000 &amp;
done

Test 2: Single node
---------
Single node: Node1
Node1 listening on port 5672
20 consumers running full speed
20 producers running full speed
Message size 1KB

Max rate achieved: 200KHZ
CPU Idle 12%

The script used to run the test:

#!/bin/sh

for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20
do
./runjava.sh com.rabbitmq.examples.PerfTest -k queue$i -x 0 -a -h <A HREF="amqp://">amqp://</A>
193.100.200.130:5672 -s 1000 &amp;
./runjava.sh com.rabbitmq.examples.PerfTest -k queue$i -y 0 -h <A HREF="amqp://">amqp://</A>
193.100.200.130:5672 -s 1000 &amp;
done



&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140415/2277a5b6/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140415/2277a5b6/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035284.html">[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node connection
</A></li>
	<LI>Next message: <A HREF="035369.html">[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35337">[ date ]</a>
              <a href="thread.html#35337">[ thread ]</a>
              <a href="subject.html#35337">[ subject ]</a>
              <a href="author.html#35337">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
