<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] MQTT SSL handshake failures causes server lockup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20MQTT%20SSL%20handshake%20failures%20causes%20server%20lockup&In-Reply-To=%3CCB39B622-2A54-49EA-AA73-1C78866E5B00%40me.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035400.html">
   <LINK REL="Next"  HREF="035311.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] MQTT SSL handshake failures causes server lockup</H1>
    <B>Stuart King</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20MQTT%20SSL%20handshake%20failures%20causes%20server%20lockup&In-Reply-To=%3CCB39B622-2A54-49EA-AA73-1C78866E5B00%40me.com%3E"
       TITLE="[rabbitmq-discuss] MQTT SSL handshake failures causes server lockup">stuart.king at me.com
       </A><BR>
    <I>Mon Apr 14 18:00:19 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035400.html">[rabbitmq-discuss] Queue Deleted and Permissions Corrupted While Testing Flow Control
</A></li>
        <LI>Next message: <A HREF="035311.html">[rabbitmq-discuss] MQTT SSL handshake failures causes server lockup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35310">[ date ]</a>
              <a href="thread.html#35310">[ thread ]</a>
              <a href="subject.html#35310">[ subject ]</a>
              <a href="author.html#35310">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I&#8217;m running RabbitMQ with the MQTT adaptor enabled along with SSL. I&#8217;ve discovered that if a small number of connections fail the SSL handshake (e.g. the client rejecting the server&#8217;s certificate because it doesn&#8217;t recognize the certificate authority) it prevents other SSL connections being established to the server for a short period of time. If a &#8216;bad client&#8217; (i.e. one that fails the SSL handshake) keeps trying to reconnect then it effectively locks up the server.

A simple way I found to demonstrate this is by creating my own certificate authority, certificates, keys etc for RabbitMQ as per the instructions at <A HREF="https://www.rabbitmq.com/ssl.html">https://www.rabbitmq.com/ssl.html</A> and adding the relevant ssl options to the  RabbitMQ config file but put the ssl_listeners element into the rabbitmq_mqtt tuple. Then, implement a basic MQTT client in Java using the Paho client libraries. When the client is ran, an exception is thrown as expected since the certificate isn&#8217;t trusted. If this client is put into a basic load test, where a new client is created and attempts to connect to the server every 2 seconds, it will prevent other clients connecting. This can be observed by simply using the &quot;openssl s_client&#8221; command, which will just hang during the time the Java clients are trying to connect.

A sample from the RabbitMQ log file when this occurs is:

=ERROR REPORT==== 10-Apr-2014::21:49:33 ===
SSL: certify: ssl_connection.erl:1724:Fatal error: certificate unknown

=ERROR REPORT==== 10-Apr-2014::21:49:38 ===
** Generic server &lt;0.689.0&gt; terminating
** Last message in was {inet_async,#Port&lt;0.15200&gt;,48667,{ok,#Port&lt;0.16417&gt;}}
** When Server state == {state,
                            {rabbit_mqtt_sup,start_ssl_client,
                                [[{cacertfile,&quot;/home/sking/ssl/cacert.pem&quot;},
                                  {certfile,&quot;/home/sking/ssl/cert.pem&quot;},
                                  {keyfile,&quot;/home/sking/ssl/key.pem&quot;},
                                  {verify,verify_none},
                                  {fail_if_no_peer_cert,false}]]},
                            #Port&lt;0.15200&gt;,48667}
** Reason for termination ==
** {timeout,{gen_server2,call,
                         [&lt;0.718.0&gt;,
                          {go,#Port&lt;0.16417&gt;,
                              #Fun&lt;rabbit_networking.1.24135120&gt;}]}}

=ERROR REPORT==== 10-Apr-2014::21:49:38 ===
** Generic server &lt;0.718.0&gt; terminating
** Last message in was {go,#Port&lt;0.16417&gt;,#Fun&lt;rabbit_networking.1.24135120&gt;}
** When Server state == undefined
** Reason for termination ==
** {{badmatch,{error,{ssl_upgrade_error,&quot;certificate unknown&quot;}}},
    [{rabbit_mqtt_reader,handle_call,3,[]},
     {gen_server2,handle_msg,2,[]},
     {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,227}]}]}


That particular example is on a server running RabbitMQ 3.1.0 / Erlang R15B03, however I have also reproduced it on the more recent RabbitMQ 3.3.0 / Erlang R16B03-1.

I also ran a similar test using AMQP and could not reproduce, so this issue only seems to be with using MQTT over SSL.

Regards,

Stuart
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140414/3bb8e24b/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140414/3bb8e24b/attachment.html</A>&gt;
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035400.html">[rabbitmq-discuss] Queue Deleted and Permissions Corrupted While Testing Flow Control
</A></li>
	<LI>Next message: <A HREF="035311.html">[rabbitmq-discuss] MQTT SSL handshake failures causes server lockup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35310">[ date ]</a>
              <a href="thread.html#35310">[ thread ]</a>
              <a href="subject.html#35310">[ subject ]</a>
              <a href="author.html#35310">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
