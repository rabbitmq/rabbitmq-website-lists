<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Upgrade fail
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Upgrade%20fail&In-Reply-To=%3CCALPks8yK_GGz_aTfSROf8GWDh8iu-xXBLz8Gv2AYRy4B6WVN_w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034970.html">
   <LINK REL="Next"  HREF="035129.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Upgrade fail</H1>
    <B>Peter Kopias</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Upgrade%20fail&In-Reply-To=%3CCALPks8yK_GGz_aTfSROf8GWDh8iu-xXBLz8Gv2AYRy4B6WVN_w%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Upgrade fail">kopias.peter at gmail.com
       </A><BR>
    <I>Wed Apr  9 00:48:51 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034970.html">[rabbitmq-discuss] Upgrade fail
</A></li>
        <LI>Next message: <A HREF="035129.html">[rabbitmq-discuss] Upgrade fail
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35105">[ date ]</a>
              <a href="thread.html#35105">[ thread ]</a>
              <a href="subject.html#35105">[ subject ]</a>
              <a href="author.html#35105">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>
</I>&gt;<i>   I've tried to upgrade my cluster to 3.3.0.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i>
</I>&gt;<i> As I've wrote before, I did a clean install, to drop the inherited
</I>possibly damaged mnesia files, so the previous installation can not be
tested. But of course I've got all the logs.


&gt;&gt;<i> This is quite weird. The diagnostics indicate that there actually is some
</I>&gt;<i> process up, registered with epmd and listening on the Erlang distribution
</I>&gt;<i> port for both node2 and node3.
</I>
I've seen this quite a few times.

Just starting and stopping rabbitmq-server leaves one running epmd process
in memory! I've noticed it before, but it looks like it's intended.

For example (after the fresh rabbit install):

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">petros at node3</A>:~$ ps aux|grep rabbitmq
rabbitmq  1223  0.0  0.0   7496   320 ?        S    00:41   0:00
/usr/lib/erlang/erts-5.10.2/bin/epmd -daemon
rabbitmq  2228  0.0  0.0   4440   624 ?        S    00:42   0:00 /bin/sh
/usr/sbin/rabbitmq-server
rabbitmq  2268  2.1  0.6 1002616 51564 ?       Sl   00:42   0:13
/usr/lib/erlang/erts-5.10.2/bin/beam.smp -W w -K true -A30 -P 1048576 --
-root /usr/lib/erlang -progname erl -- -home /var/lib/rabbitmq -- -pa
/usr/lib/rabbitmq/lib/rabbitmq_server-3.3.0/sbin/../ebin -noshell -noinput
-s rabbit boot -sname <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node3</A> -boot start_sasl -config
/etc/rabbitmq/rabbitmq -kernel inet_default_connect_options
[{nodelay,true}] -sasl errlog_type error -sasl sasl_error_logger false
-rabbit error_logger {file,&quot;/var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node3.log</A>&quot;} -rabbit
sasl_error_logger {file,&quot;/var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node3-sasl.log</A>&quot;} -rabbit
enabled_plugins_file &quot;/etc/rabbitmq/enabled_plugins&quot; -rabbit plugins_dir
&quot;/usr/lib/rabbitmq/lib/rabbitmq_server-3.3.0/sbin/../plugins&quot; -rabbit
plugins_expand_dir &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node3-plugins-expand</A>&quot;
-os_mon start_cpu_sup false -os_mon start_disksup false -os_mon
start_memsup false -mnesia dir &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node3</A>&quot;
-kernel inet_dist_listen_min 25672 -kernel inet_dist_listen_max 25672
rabbitmq  2368  0.0  0.0   7460   428 ?        Ss   00:42   0:00
inet_gethost 4
rabbitmq  2369  0.0  0.0  13788   832 ?        S    00:42   0:00
inet_gethost 4
petros    5381  0.0  0.0  11196   948 pts/0    S+   00:52   0:00 grep
--color=auto rabbitmq
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">petros at node3</A>:~$ sudo service rabbitmq-server stop
 * Stopping message broker rabbitmq-server

                                       [ OK ]
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">petros at node3</A>:~$ ps aux|grep rabbitmq
rabbitmq  1223  0.0  0.0   7496   320 ?        S    00:41   0:00
/usr/lib/erlang/erts-5.10.2/bin/epmd -daemon
petros    5505  0.0  0.0  11196   944 pts/0    S+   00:53   0:00 grep
--color=auto rabbitmq
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">petros at node3</A>:~$

So after stopping, one erlang process still runs, who knows why. :)

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">petros at node3</A>:~$ sudo lsof |grep epmd
epmd      1223        rabbitmq  cwd       DIR                8,1     4096
       2 /
epmd      1223        rabbitmq  rtd       DIR                8,1     4096
       2 /
epmd      1223        rabbitmq  txt       REG                8,1    51856
  936647 /usr/lib/erlang/erts-5.10.2/bin/epmd
epmd      1223        rabbitmq  mem       REG                8,1  1853400
  394057 /lib/x86_64-linux-gnu/libc-2.17.so
epmd      1223        rabbitmq  mem       REG                8,1  1063328
  394030 /lib/x86_64-linux-gnu/libm-2.17.so
epmd      1223        rabbitmq  mem       REG                8,1   149312
  394033 /lib/x86_64-linux-gnu/ld-2.17.so
epmd      1223        rabbitmq    0r      CHR                1,3      0t0
    1029 /dev/null
epmd      1223        rabbitmq    1w      CHR                1,3      0t0
    1029 /dev/null
epmd      1223        rabbitmq    2w      CHR                1,3      0t0
    1029 /dev/null
epmd      1223        rabbitmq    3u     IPv4              10155      0t0
     TCP *:epmd (LISTEN)

and it's listening too...


&gt;<i>
</I>&gt;<i>  WHY is it waiting for node2, node3, if node1 was the last to stop, and
</I>&gt;&gt;<i> it should come online in itself without them?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Very good question.
</I>&gt;<i>
</I>&gt;<i> I was able to reproduce this precise error message by doing the equivalent
</I>&gt;<i> of:
</I>&gt;<i>
</I>&gt;<i> (stop node1)
</I>&gt;<i> rabbitmqctl -n node2 stop_app
</I>&gt;<i> rabbitmqctl -n node3 stop_app
</I>&gt;<i> (start node1)
</I>&gt;<i>
</I>&gt;<i> i./e. leaving the Erlang VM running but stopping RabbitMQ (and Mnesia) on
</I>&gt;<i> node2 and node3.
</I>&gt;<i>
</I>&gt;<i> Is there any possibility at all you could have done something like this?
</I>&gt;<i> Is there a beam.smp process running on those nodes?
</I>&gt;<i>
</I>I don't run rabbitmqctl stop_app commands by hand, I've got these things
(creating a cluster, changing nodetype) scripted, so no, that's not the
case. Even if I run something that needs stop_app, there was a start_app in
a second.

I am especially puzzled since the nodes have registered 25672 as a
&gt;<i> distribution port - prior to 3.3.0 the distribution port would be chosen at
</I>&gt;<i> random, or you could configure it. So the presence of 25672 strongly
</I>&gt;<i> indicates that those nodes have been upgraded to 3.3.0 and are running an
</I>&gt;<i> Erlang VM - with RabbitMQ stopped?
</I>
I think that the standard apt-get process is doing something like this:
service rabbitmq-server stop
upgrade
service rabbitmq-server start

but as we've already identified rabbitmq-server stop does leave an epmd
running, as it did with 3.1.3, 3.2.2, 3.2.3, 3.2.4, 3.3.0

so after upgradeing the epmd isn't fresh, it may have previous settings,
apps running.


&gt;<i>
</I>&gt;<i>  The cookie is the same, the hostnames are correct.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If I am correct about the diagnosis above then the diagnostics don't
</I>&gt;<i> currently handle this situation well; they don't check for the case where
</I>&gt;<i> Erlang is running but RabbitMQ isn't. This will get fixed in the next
</I>&gt;<i> release.
</I>
Intensive logging would help too.


&gt;<i>
</I>&gt;<i>   I'm trying to start node2 and node3 to have at least one running but
</I>&gt;&gt;<i> they always fail, even if I copied back the previous disk state, and
</I>&gt;&gt;<i> upgraded again...
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> How do they fail? Because it sounds like something is running.
</I>
 Node2 and node3 always exited with the message that they are not the one
stopped the last, and if I removed the locks they tried to connect to each
other - while repairing the mnesia db, and as the network connect failed
(as they were not accepting connections probably because the db repair was
on), they quit, leaving the repair in half. So the nodes were not able to
communicate because of the db repair (this is a theory only), and as the
timeout arrived they quit before the repair would finish. (It would be nice
to have a message like &quot;starting repair&quot; and &quot;repair finished&quot;, as the log
message currently is not clear about the state of the repair, I'm not sure
that if the repair ends I'll get a logitem.)


==== cut here ====

At this very moment I have the following situation (after the clean 3.3.0
install on all nodes, and cluster rebuilt):
node1,node2,node3 is after an apt-get upgrade, and needs restarting

node1 restart done, fine.
node3 restart done, fine.

node2: sudo reboot, and it's just waiting forever (without the usual
conneciton closed by foreign host)

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at node2</A>:~# rabbitmqctl status
Status of node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A> ...
Error: unable to connect to node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A>: nodedown

DIAGNOSTICS
===========

attempted to contact: [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A>]

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A>:
  * rabbit seems not to be running at all
  * other nodes on node2: [rabbitmqctl13579]

current node details:
- node name: <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmqctl14147 at node2</A>
- home dir: /var/lib/rabbitmq
- cookie hash: XSquoZCiCPIfZlTilwy1Dg==

....

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at node2</A>:~# ps aux|grep rabbit
rabbitmq  1221  0.0  0.0   9416  2372 ?        S    Apr02   0:10
/usr/lib/erlang/erts-5.10.2/bin/epmd -daemon
rabbitmq  2189  0.0  0.0   4440   624 ?        S    Apr02   0:00 /bin/sh
/usr/sbin/rabbitmq-server
rabbitmq  2236  2.3  0.6 995960 53324 ?        Sl   Apr02 211:08
/usr/lib/erlang/erts-5.10.2/bin/beam.smp -W w -K true -A30 -P 1048576 --
-root /usr/lib/erlang -progname erl -- -home /var/lib/rabbitmq -- -pa
/usr/lib/rabbitmq/lib/rabbitmq_server-3.3.0/sbin/../ebin -noshell -noinput
-s rabbit boot -sname <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A> -boot start_sasl -config
/etc/rabbitmq/rabbitmq -kernel inet_default_connect_options
[{nodelay,true}] -sasl errlog_type error -sasl sasl_error_logger false
-rabbit error_logger {file,&quot;/var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2.log</A>&quot;} -rabbit
sasl_error_logger {file,&quot;/var/log/rabbitmq/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2-sasl.log</A>&quot;} -rabbit
enabled_plugins_file &quot;/etc/rabbitmq/enabled_plugins&quot; -rabbit plugins_dir
&quot;/usr/lib/rabbitmq/lib/rabbitmq_server-3.3.0/sbin/../plugins&quot; -rabbit
plugins_expand_dir &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2-plugins-expand</A>&quot;
-os_mon start_cpu_sup false -os_mon start_disksup false -os_mon
start_memsup false -mnesia dir &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A>&quot;
-kernel inet_dist_listen_min 25672 -kernel inet_dist_listen_max 25672
root     13513  0.0  0.0   4440   776 ?        S    00:42   0:00 /bin/sh
/etc/rc6.d/K20rabbitmq-server stop
root     13568  0.0  0.0   4440   680 ?        S    00:42   0:00 /bin/sh
/usr/sbin/rabbitmqctl stop /var/run/rabbitmq/pid
root     13577  0.0  0.0  53204  1652 ?        S    00:42   0:00 su
rabbitmq -s /bin/sh -c /usr/lib/rabbitmq/bin/rabbitmqctl  &quot;stop&quot;
&quot;/var/run/rabbitmq/pid&quot;
rabbitmq 13578  0.0  0.0   4440   624 ?        Ss   00:42   0:00 sh -c
/usr/lib/rabbitmq/bin/rabbitmqctl  &quot;stop&quot; &quot;/var/run/rabbitmq/pid&quot;
rabbitmq 13579  0.1  0.1 437204 14676 ?        Sl   00:42   0:01
/usr/lib/erlang/erts-5.10.2/bin/beam.smp -- -root /usr/lib/erlang -progname
erl -- -home /var/lib/rabbitmq -- -pa
/usr/lib/rabbitmq/lib/rabbitmq_server-3.3.0/sbin/../ebin -noshell -noinput
-hidden -sname rabbitmqctl13579 -boot start_clean -s rabbit_control_main
-nodename <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A> -extra stop /var/run/rabbitmq/pid
rabbitmq 13611  0.0  0.0   7460   432 ?        Ss   00:42   0:00
inet_gethost 4
rabbitmq 13612  0.0  0.0   9560   636 ?        S    00:42   0:00
inet_gethost 4
root     14958  0.0  0.0  11196   948 pts/0    S+   01:00   0:00 grep
--color=auto rabbit


NOTE that, we have the &quot;K20rabbitmq-server stop&quot;  running, we have the
rabbitmq processes too, but currently neither rabbitmqctl nor management
plugin is accessible, and the reboot process hung.

This was the very reason about month ago, we first killed the rabbitmq
processes. After that we thought &quot;maybe we corrupted mnesia with the kill,
and we don't know why it hang for the first time&quot;.

Unfortunately as the computer is in a &quot;going down to reboot&quot; state, my only
shell is the logged in one (one can't get a new connection while the system
is going down).... but by starting sshd manually I can have this node
powered up for a while.

Log files:

the sasl log on node2 is empty (yeeah)
shutdown_err and startup_err is empty (whoa)
startup_log is normal
shutdown_log
&quot;Stopping and halting node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at node2</A> ...
&quot;
and it has the timestamp of the reboot command

node2.log:

&quot;=INFO REPORT==== 9-Apr-2014::00:42:31 ===
Stopping RabbitMQ

=INFO REPORT==== 9-Apr-2014::00:42:31 ===
stopped TCP Listener on [::]:5672

....a few closed connections....

=INFO REPORT==== 9-Apr-2014::00:42:32 ===
Halting Erlang VM
&quot;

 so it looks like, that rabbitmq really exited 25 minutes ago, but the stop
script won't exit, as the processes still running.


 Could the problem be the inet_gethost process? Unfortunately I've seen dns
problems in our networks, so that could be a problem, but that should not
hang the shutdown.


 The running rabbit processes and their open files are here:

 <A HREF="http://pastebin.com/mLKf5mEu">http://pastebin.com/mLKf5mEu</A>


<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at node2</A>:~# pstree
init&#9472;&#9516;&#9472;dbus-daemon
...
     &#9500;&#9472;epmd
     &#9500;&#9472;rabbitmq-server&#9472;&#9472;&#9472;beam.smp&#9472;&#9472;&#9472;38*[{beam.smp}]

 &#9500;&#9472;rc&#9472;&#9472;&#9472;K20rabbitmq-ser&#9472;&#9472;&#9472;rabbitmqctl&#9472;&#9472;&#9472;su&#9472;&#9472;&#9472;sh&#9472;&#9472;&#9472;beam.smp&#9472;&#9516;&#9472;inet_gethost&#9472;&#9472;&#9472;inet_gethost
     &#9474;
&#9492;&#9472;18*[{beam.smp}]
...

So, I'm looking to find the hangup process... straceing and killing them.
The first try is the gethosts:

<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at node2</A>:~# strace -p 13612
Process 13612 attached
read(0,

....

^CProcess 13612 detached
 &lt;detached ...&gt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at node2</A>:~# strace -p 13611
Process 13611 attached
select(4, [0 3], NULL, NULL, NULL
....
^CProcess 13611 detached

 &lt;detached ...&gt;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at node2</A>:~# kill 13612
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at node2</A>:~# kill 13611

weee, after this second kill we've got the inet_gethost respawned, so the
beam.smp (pid 13579) still works (but it should have already quit :) )

We know that some from these are waiting:


&#9500;&#9472;rc(13415)&#9472;&#9472;&#9472;K20rabbitmq-ser(13513)&#9472;&#9472;&#9472;rabbitmqctl(13568)&#9472;&#9472;&#9472;su(13577)&#9472;&#9472;&#9472;sh(13578)&#9472;&#9472;&#9472;beam.smp(13579)&#9472;&#9516;&#9472;inet_gethost(16346)
        &#9474;
                                &#9500;&#9472;{beam.smp}(13591)
        &#9474;
                                &#9500;&#9472;{beam.smp}(13592)
        &#9474;
                                &#9500;&#9472;{beam.smp}(13593)
...
        &#9474;
                                &#9492;&#9472;{beam.smp}(13608)


 Any ideas? How can I debug this?
 Specific questions?

 I will leave this system in this state for now, to allow us to diagnose
the situation. Unfortunately I don't know erlang, but I can try anything if
I can help solve these hangups. As I've said this is the same behaviour as
3.1.3, 3.2.2, 3.2.3 and so on worked, they sometimes just hung, then we
killed them and had that bad feeling in our hearts, that we may broke the
db. I won't kill this time. :)

 If you can &quot;remote control&quot; me, I may even try to erlang debug the
processes, to guess what they're waiting for.

 Thank you for your help, I hope these hangups could get eliminated.

 Have a nice day,

 Peter
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140409/16298824/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140409/16298824/attachment.html</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034970.html">[rabbitmq-discuss] Upgrade fail
</A></li>
	<LI>Next message: <A HREF="035129.html">[rabbitmq-discuss] Upgrade fail
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35105">[ date ]</a>
              <a href="thread.html#35105">[ thread ]</a>
              <a href="subject.html#35105">[ subject ]</a>
              <a href="author.html#35105">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
