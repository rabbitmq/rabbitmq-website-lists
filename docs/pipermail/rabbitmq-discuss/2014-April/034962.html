<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20to%20shutdown%20cleanly%20a%20Java%20application%0A%20using%20Consumers%3F&In-Reply-To=%3CCADtU9_vsLWqzC%3Drwm6WFP-2hiKf80wmVmSp5soPehQk5gu2tDQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034961.html">
   <LINK REL="Next"  HREF="034963.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?</H1>
    <B>Gary Russell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20to%20shutdown%20cleanly%20a%20Java%20application%0A%20using%20Consumers%3F&In-Reply-To=%3CCADtU9_vsLWqzC%3Drwm6WFP-2hiKf80wmVmSp5soPehQk5gu2tDQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?">grussell at gopivotal.com
       </A><BR>
    <I>Wed Apr  2 23:23:33 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034961.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
</A></li>
        <LI>Next message: <A HREF="034963.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34962">[ date ]</a>
              <a href="thread.html#34962">[ thread ]</a>
              <a href="subject.html#34962">[ subject ]</a>
              <a href="author.html#34962">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In Spring-AMQP, we don't asynchronously cancel the consumer, we tell the
consumer it needs to cancel itself when it's finished its current work.
IIRC, if the consumer is running when you cancel it, its basicAck will fail
because you've already cancelled it and the broker has re-queued that
message. Effectively we tell the consumer to emit the cancel immediately
after the ack.

&gt;<i>stop a badly behaving Consumer
</I>
It depends on how badly behaved it is; if it never executes any
interruptible code (say it's stuck in a while() loop), you are out of luck.
If it does stuff that's interruptible (acquire locks, etc, etc) then you
can interrupt it.

I don't know enough about the rabbit client internals as to whether there
is a mechanism to force it to interrupt the dispatcher thread (I didn't see
anything after a quick look) so you might have to roll your own (capture a
reference to the thread in handleDelivery and interrupt it after your
timeout).

When all else fails, System.exit() is your friend.

Gary



On Wed, Apr 2, 2014 at 5:52 PM, Bertrand Guay-Paquet &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">bernie at step.polymtl.ca</A>
&gt;<i> wrote:
</I>
&gt;<i> Thanks Jason and Gary,
</I>&gt;<i>
</I>&gt;<i> Your replies really helped and I almost got it now. At first, I didn't
</I>&gt;<i> know that handleCancelOk only runs when a consumer is not handling anything
</I>&gt;<i> else. That is, only a single handle*() method can run at the same time on
</I>&gt;<i> any given consumer instance. Thinking about it now, I realize this was
</I>&gt;<i> explained in the doc with the phrase &quot;Each Channel has its own dispatch
</I>&gt;<i> thread.&quot;
</I>&gt;<i>
</I>&gt;<i> So I created my subclass of DefaultConsumer (BasicConsumer) which
</I>&gt;<i> implements isCancelled() and handleCancelOk() which sets a &quot;cancelled flag&quot;
</I>&gt;<i> to true. Is there already a built-in way to know if a consumer was
</I>&gt;<i> cancelled? I couldn't find it myself...
</I>&gt;<i>
</I>&gt;<i> Here are my start and stop sequences which almost completely work. I
</I>&gt;<i> haven't found how to forcefully stop a badly behaving Consumer after a
</I>&gt;<i> given timeout at the end of the stop sequence. How can this be achieved?
</I>&gt;<i>
</I>&gt;<i> Start sequence:
</I>&gt;<i> consumers = new ArrayList&lt;BasicConsumer&gt;();
</I>&gt;<i> consumers.add(...)
</I>&gt;<i>
</I>&gt;<i> Stop sequence:
</I>&gt;<i> // Cancel all consumers
</I>&gt;<i> for (BasicConsumer consumer : consumers) {
</I>&gt;<i>   try {
</I>&gt;<i>     consumer.getChannel().basicCancel(consumer.getConsumerTag());
</I>&gt;<i>   } catch (Exception e) {
</I>&gt;<i>     // report
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> // Wait for all consumers to be cancelled
</I>&gt;<i> Timeout timeout = ...;
</I>&gt;<i> while (!consumers.isEmpty() &amp;&amp; !timeout.isElapsed()) {
</I>&gt;<i>   // Remove cancelled consumers
</I>&gt;<i>   for (Iterator&lt;BasicConsumer&gt; iterator = consumers.iterator();
</I>&gt;<i> iterator.hasNext();) {
</I>&gt;<i>     if (iterator.next().isCancelled())
</I>&gt;<i>       iterator.remove();
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> // Force close remaining (timed-out) consumers
</I>&gt;<i> for (BasicConsumer consumer : consumers) {
</I>&gt;<i>   consumer.getChannel().abort(); // &lt;---- doesn'k kill the consumer
</I>&gt;<i>   // &lt;---------------- How do I kill a timed-out consumer?
</I>&gt;<i> }
</I>&gt;<i> connection.close();
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Bertrand
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140402/4b90638f/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140402/4b90638f/attachment.html</A>&gt;
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034961.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
</A></li>
	<LI>Next message: <A HREF="034963.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34962">[ date ]</a>
              <a href="thread.html#34962">[ thread ]</a>
              <a href="subject.html#34962">[ subject ]</a>
              <a href="author.html#34962">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
