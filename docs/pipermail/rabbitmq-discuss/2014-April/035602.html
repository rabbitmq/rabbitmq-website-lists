<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] ConnectionFactory.CreateConnection() exception when using IPv4 address
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20ConnectionFactory.CreateConnection%28%29%20exception%0A%20when%20using%20IPv4%20address&In-Reply-To=%3C54ce9c0e-843b-45bb-83ce-aa7d158678b8%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035685.html">
   <LINK REL="Next"  HREF="035605.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] ConnectionFactory.CreateConnection() exception when using IPv4 address</H1>
    <B>ewulf84 at gmail.com</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20ConnectionFactory.CreateConnection%28%29%20exception%0A%20when%20using%20IPv4%20address&In-Reply-To=%3C54ce9c0e-843b-45bb-83ce-aa7d158678b8%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] ConnectionFactory.CreateConnection() exception when using IPv4 address">ewulf84 at gmail.com
       </A><BR>
    <I>Tue Apr 29 05:03:08 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035685.html">[rabbitmq-discuss] Rabbitmq cluster design and HA
</A></li>
        <LI>Next message: <A HREF="035605.html">[rabbitmq-discuss] ConnectionFactory.CreateConnection() exception when using IPv4 address
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35602">[ date ]</a>
              <a href="thread.html#35602">[ thread ]</a>
              <a href="subject.html#35602">[ subject ]</a>
              <a href="author.html#35602">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a straightforward issue: If you supply an IPv4 address to a new 
AmqpTcpEndpoint in an IPv6-enabled Windows environment (Windows7) then pass 
that endpoint to a connection factory it will not be able to create 
connections.  It seems that if the client environment supports IPv6 you 
have to use an IPv6 address or a hostname.  My sample code is running the 
3.3.0 RabbitMQ .Net client:

var factory = new ConnectionFactory() 
{
UserName = &quot;eric&quot;,
Password = &quot;pwd&quot; 
};


// WORKS (ipv6 addr)
// var uri = new 
Uri(&quot;amqp-0-9://[2001:a9fe:3100:1:f06c:255a:43e2:1459]:5672&quot;);

// WORKS (hostname)
// var uri = new Uri(&quot;amqp-0-9://s6-2k8r2-3:5672&quot;);

// Times out (mapped ipv4 [socket is probably not dual-stack?])
// var uri = new Uri(&quot;amqp-0-9://[0:0:0:0:0:ffff:172.31.195.246]:5672&quot;);

// Throws a System.ArgumentException in CreateConnection()
var uri = new Uri(&quot;amqp-0-9://172.31.195.246:5672&quot;);

factory.Endpoint = new AmqpTcpEndpoint(uri);

using (var connection = factory.CreateConnection())
{
using (var channel = connection.CreateModel())
{
channel.QueueDeclare(&quot;test&quot;, false, false, false, null);

string message = &quot;Hello World&quot;;
var body = Encoding.UTF8.GetBytes(message);

channel.BasicPublish(&quot;&quot;, &quot;hello&quot;, null, body);
Console.WriteLine(&quot; [x] Sent {0}&quot;, message);
}
}

The problem appears to be in the way the SocketFrameHandler_0_9.ctor() 
determines the socket address family:

if (Socket.OSSupportsIPv6)
    {
        try
        {
            this.m_socket = socketFactory(AddressFamily.InterNetworkV6);
            this.Connect(this.m_socket, endpoint, timeout);
        }
        catch (ConnectFailureException)
        {
            this.m_socket = null;
        }
    }


This may not be the best way to determine whether to use an IPv6 socket or 
an IPv4 socket.  The ArgumentException which is getting thrown from down in 
the Socket's DoDnsCallback is not caught in the FrameHandler ctor and 
instead makes its way up to the caller.  You may want to consider 
IPAddress.TryParsing the host from the Amqp endpoint and then getting the 
address family from that.  It would probably be faster than this method, 
too.

As it stands I cannot figure out a workaround for this issue.  If the only 
way you can access a machine from an IPv6-enabled Windows box is via its 
IPv4 address you would appear to be out of luck.  In the .Net client, 
anyway.

Thanks,
Eric

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140428/c40c6063/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140428/c40c6063/attachment.html</A>&gt;
</PRE>


































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035685.html">[rabbitmq-discuss] Rabbitmq cluster design and HA
</A></li>
	<LI>Next message: <A HREF="035605.html">[rabbitmq-discuss] ConnectionFactory.CreateConnection() exception when using IPv4 address
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35602">[ date ]</a>
              <a href="thread.html#35602">[ thread ]</a>
              <a href="subject.html#35602">[ subject ]</a>
              <a href="author.html#35602">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
