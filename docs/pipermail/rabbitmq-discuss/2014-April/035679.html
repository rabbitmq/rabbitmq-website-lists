<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Mirrored HA queues disappeared on one out of two	nodes restarting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirrored%20HA%20queues%20disappeared%20on%20one%20out%20of%20two%0A%09nodes%20restarting&In-Reply-To=%3CFDB5A57F-17AD-4AD0-B274-A61F49562130%40nationalfibre.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035678.html">
   <LINK REL="Next"  HREF="035680.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Mirrored HA queues disappeared on one out of two	nodes restarting</H1>
    <B>Mark Steele</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Mirrored%20HA%20queues%20disappeared%20on%20one%20out%20of%20two%0A%09nodes%20restarting&In-Reply-To=%3CFDB5A57F-17AD-4AD0-B274-A61F49562130%40nationalfibre.net%3E"
       TITLE="[rabbitmq-discuss] Mirrored HA queues disappeared on one out of two	nodes restarting">marks at nationalfibre.net
       </A><BR>
    <I>Wed Apr 30 16:14:02 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035678.html">[rabbitmq-discuss] Declaring queues and exchanges on both sides
</A></li>
        <LI>Next message: <A HREF="035680.html">[rabbitmq-discuss] Mirrored HA queues disappeared on one out of two nodes restarting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35679">[ date ]</a>
              <a href="thread.html#35679">[ thread ]</a>
              <a href="subject.html#35679">[ subject ]</a>
              <a href="author.html#35679">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

When restarting a node in a cluster that contained mirrored queues, I just experienced a mirrored queue disappearing completely from the cluster.

Both nodes in the cluster were both ram and disc nodes.

This is extremely worrisome to say the least.

--

=INFO REPORT==== 28-Apr-2014::14:17:07 ===
Synchronising queue 'affiliate_clicks' in vhost '/': 5565 messages to synchronise

=INFO REPORT==== 28-Apr-2014::14:17:07 ===
Synchronising queue 'affiliate_clicks' in vhost '/': all slaves already synced

=INFO REPORT==== 29-Apr-2014::22:19:06 ===
Mirrored-queue (queue 'affiliate_clicks' in vhost '/'): Slave &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq04.1.274.0</A>&gt; saw deaths of mirrors &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq03.1.280.0</A>&gt; 

=INFO REPORT==== 29-Apr-2014::22:19:06 ===
Mirrored-queue (queue 'affiliate_clicks' in vhost '/'): Promoting slave &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq04.1.274.0</A>&gt; to master

=INFO REPORT==== 29-Apr-2014::22:19:33 ===
rabbit on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq03</A> up


=INFO REPORT==== 29-Apr-2014::22:19:33 ===
Synchronising queue 'affiliate_clicks' in vhost '/': complete

=INFO REPORT==== 29-Apr-2014::22:19:33 ===
Synchronising queue 'affiliate_clicks' in vhost '/': 4696 messages to synchronise

=INFO REPORT==== 29-Apr-2014::22:19:33 ===
Synchronising queue 'affiliate_clicks' in vhost '/': all slaves already synced

&lt;snip&gt; lots of connection logs, then kaboom &lt;/snip&gt;

=INFO REPORT==== 29-Apr-2014::22:23:48 ===
Mirrored-queue (queue 'affiliate_clicks' in vhost '/'): Master &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq04.1.274.0</A>&gt; saw deaths of mirrors &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq03.2.277.0</A>&gt; 



=ERROR REPORT==== 29-Apr-2014::22:23:50 ===
** Generic server &lt;0.274.0&gt; terminating
** Last message in was emit_stats
** When Server state == {q,
                         {amqqueue,
                          {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;affiliate_clicks&quot;&gt;&gt;},
                          true,false,none,[],&lt;0.274.0&gt;,[],[],
                          [{vhost,&lt;&lt;&quot;/&quot;&gt;&gt;},
                           {name,&lt;&lt;&quot;affiliate_queues&quot;&gt;&gt;},
                           {pattern,&lt;&lt;&quot;^affiliate_.*$&quot;&gt;&gt;},
                           {definition,
                            [{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;},
                             {&lt;&lt;&quot;ha-sync-mode&quot;&gt;&gt;,&lt;&lt;&quot;automatic&quot;&gt;&gt;}]},
                           {priority,0}],
                          [{&lt;2827.281.0&gt;,&lt;2827.280.0&gt;}]},
                         none,false,rabbit_mirror_queue_master,
                         {state,
                          {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;affiliate_clicks&quot;&gt;&gt;},
                          &lt;0.275.0&gt;,&lt;0.19739.588&gt;,rabbit_variable_queue,
                          {vqstate,
                           {0,{[],[]}},
                           {0,{[],[]}},
                           {delta,undefined,0,undefined},
                           {0,{[],[]}},
                           {2660,
                            {[{msg_status,2363798,
                               &lt;&lt;117,194,172,33,185,58,225,43,141,116,31,73,
                                 152,23,146,23&gt;&gt;,
                               {basic_message,
                                {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,
                                 &lt;&lt;&quot;affiliate_clicks&quot;&gt;&gt;},
                                [&lt;&lt;&quot;#&quot;&gt;&gt;],
                                {content,60,
                                 {'P_basic',&lt;&lt;&quot;application/json&quot;&gt;&gt;,undefined,
                                  undefined,undefined,undefined,undefined,
                                  undefined,undefined,undefined,undefined,
                                  undefined,undefined,undefined,undefined},
                                 &lt;&lt;128,0,16,97,112,112,108,105,99,97,116,105,
                                   111,110,47,106,115,111,110&gt;&gt;,
                                 rabbit_framing_amqp_0_9_1,
                                 [&lt;&lt;&quot;DATA SNIPPED OUT&quot;&gt;&gt;]},
                                &lt;&lt;205,79,109,87,12,83,109,226,230,122,218,63,
                                  27,68,138,67&gt;&gt;,
                                false},
                               false,false,false,false,
                               

&lt;LOTS OF REPEATING LOG DATA&gt;


                           2363799,
                           {0,nil},
                           {0,nil},
                           {qistate,
                            &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq04</A>/queues/D8CDHLZOTXCZL6MJMMYRK9EAN&quot;,
                            {{dict,0,16,16,8,80,48,
                              {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []},
                              {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []}}},
                             []},
                            undefined,0,65536,
                            #Fun&lt;rabbit_variable_queue.2.81334491&gt;,
                            {0,nil}},
                           {{client_msstate,msg_store_persistent,
                             &lt;&lt;69,37,230,131,60,26,47,62,12,194,26,130,4,129,
                               159,57&gt;&gt;,
                             {dict,0,16,16,8,80,48,
                              {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []},
                              {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []}}},
                             {state,356427,
                              &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq04</A>/msg_store_persistent&quot;},
                             rabbit_msg_store_ets_index,
                             &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq04</A>/msg_store_persistent&quot;,
                             &lt;0.265.0&gt;,360524,352330,364621,368718},
                            {client_msstate,msg_store_transient,
                             &lt;&lt;140,110,236,52,188,182,217,136,180,245,92,51,
                               176,116,195,10&gt;&gt;,
                             {dict,0,16,16,8,80,48,
                              {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                               []},
                              {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                []}}},
                             {state,335942,
                              &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq04</A>/msg_store_transient&quot;},
                             rabbit_msg_store_ets_index,
                             &quot;/var/lib/rabbitmq/mnesia/<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at mq04</A>/msg_store_transient&quot;,
                             &lt;0.260.0&gt;,340039,331840,344136,348233}},
                           true,0,2660,0,infinity,2660,2660,0,0,0,
                           {rates,
                            {{1398,824624,347232},0},
                            {{1398,824624,347232},84},
                            0.0,17.611352475686193,
                            {1398,824629,389132}},
                           {0,nil},
                           {0,nil},
                           {0,nil},
                           {0,nil},
                           0,0,
                           {rates,
                            {{1398,824624,347232},6706},
                            {{1398,824624,347232},0},
                            663.4928634941101,0.0,
                            {1398,824629,389132}}},
                          {dict,0,16,16,8,80,48,
                           {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                           {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                             []}}},
                          [],
                          {set,0,16,16,8,80,48,
                           {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                           {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                             []}}}},
                         {[],[]},
                         undefined,undefined,undefined,undefined,
                         {state,fine,5000,#Ref&lt;0.0.527.127396&gt;},
                         {0,nil},
                         undefined,undefined,undefined,
                         {dict,1,16,16,8,80,48,
                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
                          {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                            [[&lt;0.18782.588&gt;|#Ref&lt;0.0.524.252716&gt;]]}}},
                         undefined,undefined,undefined,running}
** Reason for termination == 
** {{badmatch,{error,not_found}},
    [{rabbit_mirror_queue_master,stop_all_slaves,2},
     {rabbit_mirror_queue_master,delete_and_terminate,2},
     {rabbit_amqqueue_process,'-terminate_delete/3-fun-1-',6},
     {rabbit_amqqueue_process,terminate_shutdown,2},
     {gen_server2,terminate,3},
     {proc_lib,wake_up,3}]}
** In 'terminate' callback with reason ==
** {{badmatch,{error,not_found}},
    [{rabbit_amqqueue_process,i,2},
     {rabbit_amqqueue_process,'-infos/2-lc$^0/1-0-',2},
     {rabbit_amqqueue_process,'-infos/2-lc$^0/1-0-',2},
     {rabbit_amqqueue_process,emit_stats,2},
     {rabbit_amqqueue_process,handle_info,2},
     {gen_server2,handle_msg,2},
     {proc_lib,wake_up,3}]}




Here's the error in the SASL log:


=SUPERVISOR REPORT==== 29-Apr-2014::22:23:55 ===
     Supervisor: {local,
                                           rabbit_mirror_queue_slave_sup}
     Context:    child_terminated
     Reason:     {{badmatch,{error,not_found}},
                  [{rabbit_mirror_queue_master,stop_all_slaves,2},
                   {rabbit_mirror_queue_master,delete_and_terminate,2},
                   {rabbit_amqqueue_process,'-terminate_delete/3-fun-1-',6},
                   {rabbit_amqqueue_process,terminate_shutdown,2},
                   {gen_server2,terminate,3},
                   {proc_lib,wake_up,3}]}
     Offender:   [{pid,&lt;0.274.0&gt;},
                  {name,rabbit_mirror_queue_slave},
                  {mfa,
                      {rabbit_mirror_queue_slave,start_link,
                          [{amqqueue,
                               {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;affiliate_clicks&quot;&gt;&gt;},
                               true,false,none,[],&lt;2827.280.0&gt;,[],[],
                               [{vhost,&lt;&lt;&quot;/&quot;&gt;&gt;},
                                {name,&lt;&lt;&quot;affiliate_queues&quot;&gt;&gt;},
                                {pattern,&lt;&lt;&quot;^affiliate_.*$&quot;&gt;&gt;},
                                {definition,
                                    [{&lt;&lt;&quot;ha-mode&quot;&gt;&gt;,&lt;&lt;&quot;all&quot;&gt;&gt;},
                                     {&lt;&lt;&quot;ha-sync-mode&quot;&gt;&gt;,&lt;&lt;&quot;automatic&quot;&gt;&gt;}]},
                                {priority,0}],
                               [{&lt;2827.281.0&gt;,&lt;2827.280.0&gt;}]}]}},
                  {restart_type,temporary},
                  {shutdown,4294967295},
                  {child_type,worker}]


Known issue? Need to update? Please advise.

Cheers,

Mark Steele, CISSP, CSM, GCIA, GPEN
Director of development
Instaclick Inc.
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">marks at nationalfibre.net</A>
m: (416) 844-9221

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140430/9686c047/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140430/9686c047/attachment.html</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035678.html">[rabbitmq-discuss] Declaring queues and exchanges on both sides
</A></li>
	<LI>Next message: <A HREF="035680.html">[rabbitmq-discuss] Mirrored HA queues disappeared on one out of two nodes restarting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35679">[ date ]</a>
              <a href="thread.html#35679">[ thread ]</a>
              <a href="subject.html#35679">[ subject ]</a>
              <a href="author.html#35679">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
