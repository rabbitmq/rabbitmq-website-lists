<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Problem with publish confirms
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20publish%20confirms&In-Reply-To=%3CCAChGYf9hFNUKGQENcobV6DjeJ2zTMTiPADQw2f_2EtE9M%2BOFEQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035066.html">
   <LINK REL="Next"  HREF="035050.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Problem with publish confirms</H1>
    <B>Ryan Brown</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Problem%20with%20publish%20confirms&In-Reply-To=%3CCAChGYf9hFNUKGQENcobV6DjeJ2zTMTiPADQw2f_2EtE9M%2BOFEQ%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Problem with publish confirms">ryankbrown at gmail.com
       </A><BR>
    <I>Fri Apr  4 20:44:46 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035066.html">[rabbitmq-discuss] async C client
</A></li>
        <LI>Next message: <A HREF="035050.html">[rabbitmq-discuss] Problem with publish confirms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35006">[ date ]</a>
              <a href="thread.html#35006">[ thread ]</a>
              <a href="subject.html#35006">[ subject ]</a>
              <a href="author.html#35006">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have an application that acts as, essentially, a rest wrapper around
rabbitmq. (There is obviously some special logic that makes it necessary to
build our own).

Some background: We have been using this application (current code
available at <A HREF="https://github.com/PearsonEducation/subpub">https://github.com/PearsonEducation/subpub</A>) as an internal
pub/sub for several years now. It has now grown dramatically in importance
to our vision and we are beginning to get inundated with requests for
features and enhancements. One of those enhancements is to allow publishers
to specify with a header whether they want the application to require
confirmed publishing to rabbit. We had begun this process by checking for
the header value and passing down the chain. However, we are not currently
setting-up a channel that is set for publish confirms. Anyway, TMI...

The state I'm in now is that, on startup, we create connections to each of
our brokers. In this process we create a channel and save it in state. I
have now added logic to create a second channel on that connection that
sets:

 #'confirm.select_ok'{} = amqp_channel:call(ConfirmedChannel,
#'confirm.select'{}),

And saves it to state. Then on publish, I select which one to use based on
the values passed-down the stack from message intake. Set self() as the
confirm handler and respond with a wait so that up the stack I can initiate
a receive loop in the message intake which is not a gen_server. I have
debug messages throughout and it appears that everything is happening as
expected. I trace the message through the publish path. To being published
and passing the wait back up to the receiver. I also see where the
basic.ack is received and the publish_confirm acknowledgement passed all
the way up to the receive loop. However, then things go awry. I get the
attached dump.

My take-away, although likely I am wrong, is that somewhere, apparently in
amqp_balanced_publisher, a gen_server call is timing-out while waiting for
a response. But, I seem to be able to trace the responses through the whole
stack so I am thoroughly confused.

I realize this is vague and additional details/code are likely still
needed. Please let me know. I've spent way too much time on this already
and it's getting quite frustrating. And I know I am likely missing
something obvious but am finding supporting documentation for erlang
lacking. But I'm probably just looking in the right places.

Best regards,


Ryan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140404/54e4575d/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140404/54e4575d/attachment.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: pub_confirm_dump
Type: application/octet-stream
Size: 41657 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140404/54e4575d/attachment.obj">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140404/54e4575d/attachment.obj</A>&gt;
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035066.html">[rabbitmq-discuss] async C client
</A></li>
	<LI>Next message: <A HREF="035050.html">[rabbitmq-discuss] Problem with publish confirms
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35006">[ date ]</a>
              <a href="thread.html#35006">[ thread ]</a>
              <a href="subject.html#35006">[ subject ]</a>
              <a href="author.html#35006">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
