<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20to%20shutdown%20cleanly%20a%20Java%20application%0A%20using%20Consumers%3F&In-Reply-To=%3C533D9093.2020304%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034980.html">
   <LINK REL="Next"  HREF="034982.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20How%20to%20shutdown%20cleanly%20a%20Java%20application%0A%20using%20Consumers%3F&In-Reply-To=%3C533D9093.2020304%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?">simon at rabbitmq.com
       </A><BR>
    <I>Thu Apr  3 17:47:15 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="034980.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
</A></li>
        <LI>Next message: <A HREF="034982.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34981">[ date ]</a>
              <a href="thread.html#34981">[ thread ]</a>
              <a href="subject.html#34981">[ subject ]</a>
              <a href="author.html#34981">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/04/14 17:28, Bertrand Guay-Paquet wrote:
&gt;<i> I tested this on RabbitMQ 3.2.4 and calling basicCancel for a consumer
</I>&gt;<i> tag does not interfere with the ability to basicAck a message currently
</I>&gt;<i> being processed
</I>
That is correct.

&gt;<i> (I used Thread.sleep() in the consumer to ensure the
</I>&gt;<i> operation order). The handleCancelOk() method is only called after the
</I>&gt;<i> handleDelivery() method returns.
</I>
That is also correct.

&gt;<i>  From what I could piece together, calling basicCancel queues the
</I>&gt;<i> channel rpc command for execution after whatever is already queued. The
</I>&gt;<i> consumer even consumes its buffered messages (basicQos &gt; 1) before
</I>&gt;<i> processing the cancel command.
</I>
So there has been a certain lack of clarity in this thread. Two key points:

* It is absolutely fine and normal to acknowledge a message after its 
consumer has been cancelled. The message remains acknowledgeable until 
the channel it was delivered on closes.

* Once you have received basic.cancel-ok, you will not receive any more 
deliveries for that consumer.

So the way to cleanly[0] shut down a consumer in the Java client is:

1) Invoke basicCancel()
2) Process and acknowledge messages as usual
3) When handleCancelOk() gets called and you have acknowledged all 
messages you received before it, you can then consider yourself done, 
close channels and connections as appropriate.

[0] I am assuming &quot;cleanly&quot; here means without causing messages to be 
redelivered. Otherwise you can just pull the network cable :-)

Cheers, Simon

-- 
Simon MacMullen
RabbitMQ, Pivotal
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034980.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
</A></li>
	<LI>Next message: <A HREF="034982.html">[rabbitmq-discuss] How to shutdown cleanly a Java application using Consumers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34981">[ date ]</a>
              <a href="thread.html#34981">[ thread ]</a>
              <a href="subject.html#34981">[ subject ]</a>
              <a href="author.html#34981">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
