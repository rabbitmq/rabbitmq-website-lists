<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Queue disappears during partition/autoheal
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20disappears%20during%20partition/autoheal&In-Reply-To=%3CCACLE7iw9faWTf%2Be3p-jEsOP31Y1r_VikMRCmCD4k6cx8K5MNMA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035368.html">
   <LINK REL="Next"  HREF="035350.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Queue disappears during partition/autoheal</H1>
    <B>Matt Pietrek</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Queue%20disappears%20during%20partition/autoheal&In-Reply-To=%3CCACLE7iw9faWTf%2Be3p-jEsOP31Y1r_VikMRCmCD4k6cx8K5MNMA%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Queue disappears during partition/autoheal">mpietrek at skytap.com
       </A><BR>
    <I>Tue Apr 15 23:09:24 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035368.html">[rabbitmq-discuss] RabbitMQ Cluster node
</A></li>
        <LI>Next message: <A HREF="035350.html">[rabbitmq-discuss] Queue disappears during partition/autoheal
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35343">[ date ]</a>
              <a href="thread.html#35343">[ thread ]</a>
              <a href="subject.html#35343">[ subject ]</a>
              <a href="author.html#35343">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is rabbitmq 3.2.4, running in a 2 node cluster with all queues in ha.

There was a queue called cmcmd declared like this:

arguments:x-ha-policy:alldurable:true
At some point we saw a network partition (see below). It appears that
Autoheal eventually worked, but afterwards the cmcmd queue wasn't on the
broker.

Here's the Autoheal sequence (note the big time gap waiting for the
sea5m1mq1 shutdown):

-----------

21:57 <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mpietrek at foo</A>:/$ grep heal 2014-04-14-mq.log

2014-04-14 18:02:35 sea5m1mq2 [info] <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq2.log</A>:
Auto*heal*request sent to <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1</A>

2014-04-14 18:02:35 sea5m1mq2 [info] <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq2.log</A>: Auto*heal*: I am
the winner, waiting for [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1</A>] to stop

2014-04-14 18:02:35 sea5m1mq2 [info] <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq2.log</A>: Auto*heal*:
final node has stopped, starting...

2014-04-14 18:57:38 sea5m1mq1 [info] <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1.log</A>:
Auto*heal*request received from <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq2</A>

2014-04-14 18:57:38 sea5m1mq1 [info] <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1.log</A>: Auto*heal*decision

2014-04-14 18:57:38 sea5m1mq1 [info] <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1.log</A>: Auto*heal*: we
were selected to restart; winner is <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq2</A>
------------

And the <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq2</A> log spew:


=ERROR REPORT==== 14-Apr-2014::18:02:30 ===
** Node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1</A> not responding **
** Removing (timedout) connection **

=INFO REPORT==== 14-Apr-2014::18:02:30 ===
rabbit on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1</A> down

=ERROR REPORT==== 14-Apr-2014::18:02:30 ===
Mnesia(<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq2</A>): ** ERROR ** mnesia_event got
{inconsistent_database, running_partitioned_network, <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1</A>}

=INFO REPORT==== 14-Apr-2014::18:02:30 ===
Statistics database started.

=INFO REPORT==== 14-Apr-2014::18:02:30 ===
Autoheal request sent to <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at sea5m1mq1</A>

=ERROR REPORT==== 14-Apr-2014::18:02:30 ===
** Generic server &lt;0.204.0&gt; terminating
** Last message in was {<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mnesia_locker,rabbit at sea5m1mq1</A>,granted}
** When Server state == {state,2,{from,&lt;0.302.0&gt;,#Ref&lt;0.0.1372.163190&gt;}}
** Reason for termination ==
** {unexpected_info,{<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mnesia_locker,rabbit at sea5m1mq1</A>,granted}}

=ERROR REPORT==== 14-Apr-2014::18:02:30 ===
** Generic server &lt;0.302.0&gt; terminating
** Last message in was {'DOWN',#Ref&lt;0.0.0.2733&gt;,process,&lt;2782.309.0&gt;,
                               noconnection}
** When Server state == {state,
                            {0,&lt;0.302.0&gt;},
                            {{0,&lt;2782.309.0&gt;},#Ref&lt;0.0.0.2733&gt;},
                            {{0,&lt;2782.309.0&gt;},#Ref&lt;0.0.0.2734&gt;},
                            {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;cmcmd&quot;&gt;&gt;},
                            rabbit_mirror_queue_coordinator,
                            {1,
                             [{{0,&lt;0.302.0&gt;},
                               {view_member,
                                   {0,&lt;0.302.0&gt;},
                                   [],
                                   {0,&lt;2782.309.0&gt;},
                                   {0,&lt;2782.309.0&gt;}}},
                              {{0,&lt;2782.309.0&gt;},
                               {view_member,
                                   {0,&lt;2782.309.0&gt;},
                                   [],
                                   {0,&lt;0.302.0&gt;},
                                   {0,&lt;0.302.0&gt;}}}]},
                            0,
                            [{{0,&lt;0.302.0&gt;},{member,{[],[]},0,0}},
                             {{0,&lt;2782.309.0&gt;},{member,{[],[]},0,0}}],
                            [&lt;0.301.0&gt;],
                            {[],[]},
                            [],0,undefined,
                            #Fun&lt;rabbit_misc.execute_mnesia_transaction.1&gt;}
** Reason for termination ==
** {noproc,{gen_server2,call,
                        [&lt;0.204.0&gt;,
                         {submit,#Fun&lt;rabbit_misc.6.116010224&gt;,&lt;0.302.0&gt;},
                         infinity]}}

=ERROR REPORT==== 14-Apr-2014::18:02:30 ===
** Generic server &lt;0.203.0&gt; terminating
** Last message in was {<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mnesia_locker,rabbit at sea5m1mq1</A>,granted}
** When Server state == {state,1,undefined}
** Reason for termination ==
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140415/7982d737/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140415/7982d737/attachment.html</A>&gt;
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035368.html">[rabbitmq-discuss] RabbitMQ Cluster node
</A></li>
	<LI>Next message: <A HREF="035350.html">[rabbitmq-discuss] Queue disappears during partition/autoheal
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35343">[ date ]</a>
              <a href="thread.html#35343">[ thread ]</a>
              <a href="subject.html#35343">[ subject ]</a>
              <a href="author.html#35343">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
