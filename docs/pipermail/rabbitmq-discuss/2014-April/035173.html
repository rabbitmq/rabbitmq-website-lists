<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Blocking Queue - Close connection by client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Blocking%20Queue%20-%20Close%20connection%20by%20client&In-Reply-To=%3CCAK%2BmrqoxF84gfTUj4y%2BWU8%3DE4n_kbMpG49tA3gNnQThtsNNQSw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035165.html">
   <LINK REL="Next"  HREF="035289.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Blocking Queue - Close connection by client</H1>
    <B>Claire Fautsch</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Blocking%20Queue%20-%20Close%20connection%20by%20client&In-Reply-To=%3CCAK%2BmrqoxF84gfTUj4y%2BWU8%3DE4n_kbMpG49tA3gNnQThtsNNQSw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Blocking Queue - Close connection by client">cfautsch at goodgamestudios.com
       </A><BR>
    <I>Thu Apr 10 07:15:41 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035165.html">[rabbitmq-discuss] consumer.Queue.Dequeue() timeout if there	are no messages
</A></li>
        <LI>Next message: <A HREF="035289.html">[rabbitmq-discuss] Blocking Queue - Close connection by client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35173">[ date ]</a>
              <a href="thread.html#35173">[ thread ]</a>
              <a href="subject.html#35173">[ subject ]</a>
              <a href="author.html#35173">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Michael and all,

Unfortunatelly calling the abort function instead of close, will show
exactly the same behaviour, as there is still a flush at the end (I also
tested this, and indeed not a solution). The only difference is that
Exceptions/Stacktraces are ignroed.
The only option I see so far to avoid hanging here, is to set a timeout to
the close method.

Regards
Claire


2014-03-03 9:18 GMT+01:00 Claire Fautsch &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cfautsch at goodgamestudios.com</A>&gt;:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> we have following issue with blocking queues:
</I>&gt;<i>
</I>&gt;<i> Once the memory watermark is reached, the connection from the client gets
</I>&gt;<i> blocked by the RabbitMQ server and it is no longer possible to publish
</I>&gt;<i> messages.
</I>&gt;<i>
</I>&gt;<i> If this happens, we are for some time still able to publish  messages,
</I>&gt;<i> however they remain in the socket's write buffer and are not actually
</I>&gt;<i> published until the connection is un-blocked again. Once this buffer is
</I>&gt;<i> full, publishing blocks completely.
</I>&gt;<i>
</I>&gt;<i> After some research we found out, that with a newer version of the
</I>&gt;<i> official Java client, it is possible to use blocked connection
</I>&gt;<i> notifications to react on this situation.
</I>&gt;<i>
</I>&gt;<i> Our prefered reaction would be to close the connection, and re-connect to
</I>&gt;<i> another broker. Here however comes the problem: It is not possible to close
</I>&gt;<i> the connection to the RabbitMQ, as the method to do so, involves a flush on
</I>&gt;<i> the socket before the socket is closed and this is blocked as well.
</I>&gt;<i>
</I>&gt;<i> Is there any possibility for a force-closed on the client side? Or is the
</I>&gt;<i> only possibility to open a new connection without closing the old one, and
</I>&gt;<i> &quot;let it die&quot;?
</I>&gt;<i>
</I>&gt;<i> Re-writing the SocketFrameHandler would of course also be a  possibility,
</I>&gt;<i> but one we would (if possible) like to avoid. (see also discussion here :
</I>&gt;<i> <A HREF="https://github.com/rabbitmq/rabbitmq-java-client/issues/11">https://github.com/rabbitmq/rabbitmq-java-client/issues/11</A>)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Additionally, when we see blocking connections occurring, we frequently
</I>&gt;<i> see following stack trace in our logs, where we are not absolutely sure
</I>&gt;<i> where it comes from, or rather why it occurs
</I>&gt;<i>
</I>&gt;<i>  com.rabbitmq.client.ShutdownSignalException: connection error; reason:
</I>&gt;<i> java.io.EOFException
</I>&gt;<i>
</I>&gt;<i> at com.rabbitmq.utility.ValueOrException.getValue(ValueOrException.java:67)
</I>&gt;<i>
</I>&gt;<i> at
</I>&gt;<i> com.rabbitmq.utility.BlockingValueOrException.uninterruptibleGetValue(BlockingValueOrException.java:37)
</I>&gt;<i>
</I>&gt;<i> at
</I>&gt;<i> com.rabbitmq.client.impl.AMQChannel$BlockingRpcContinuation.getReply(AMQChannel.java:349)
</I>&gt;<i>
</I>&gt;<i> at com.rabbitmq.client.impl.ChannelN.close(ChannelN.java:569)
</I>&gt;<i>
</I>&gt;<i> at com.rabbitmq.client.impl.ChannelN.close(ChannelN.java:501)
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> Caused by: java.io.EOFException
</I>&gt;<i>
</I>&gt;<i> at com.rabbitmq.client.impl.ChannelN.close(ChannelN.java:494)at
</I>&gt;<i> java.io.DataInputStream.readUnsignedByte(Unknown Source)
</I>&gt;<i>
</I>&gt;<i> at com.rabbitmq.client.impl.Frame.readFrom(Frame.java:95)
</I>&gt;<i>
</I>&gt;<i> at
</I>&gt;<i> com.rabbitmq.client.impl.SocketFrameHandler.readFrame(SocketFrameHandler.java:131)
</I>&gt;<i>
</I>&gt;<i> at
</I>&gt;<i> com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:515)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For information, we are currently using Java client,
</I>&gt;<i> com.rabbitmq:amqp-client version 3.1.4
</I>&gt;<i>
</I>&gt;<i> and com.zanox.lib.rabbiteasy version:rabbiteasy-core version 1.2.0, for
</I>&gt;<i> the connection handling (SingleConnectionFactory) and publishing.
</I>&gt;<i>
</I>&gt;<i> Thanks in advance for any hint or ideas.
</I>&gt;<i>
</I>&gt;<i> Regards
</I>&gt;<i>
</I>&gt;<i> Claire
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>


-- 


*Claire Fautsch*
Server Developer
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cfautsch at goodgamestudios.com</A>

Goodgame Studios
Theodorstr. 42-90, House 9
22761 Hamburg, Germany
Phone: +49 (0)40 219 880 -0

*www.goodgamestudios.com &lt;<A HREF="http://www.goodgamestudios.com">http://www.goodgamestudios.com</A>&gt;*


Goodgame Studios is a branch of Altigi GmbH
Altigi GmbH, District court Hamburg, HRB 99869
Board of directors: Dr. Kai Wawrzinek, Dr. Christian Wawrzinek, Fabian
Ritter
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140410/dab44a5d/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140410/dab44a5d/attachment.html</A>&gt;
</PRE>












































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035165.html">[rabbitmq-discuss] consumer.Queue.Dequeue() timeout if there	are no messages
</A></li>
	<LI>Next message: <A HREF="035289.html">[rabbitmq-discuss] Blocking Queue - Close connection by client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35173">[ date ]</a>
              <a href="thread.html#35173">[ thread ]</a>
              <a href="subject.html#35173">[ subject ]</a>
              <a href="author.html#35173">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
