<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Fwd: Performance bottleneck on inter-node	connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fwd%3A%20Performance%20bottleneck%20on%20inter-node%0A%09connection&In-Reply-To=%3CCADEZEmzJMBVo%2BS8QdzyD1BbXP_YjE%3DDu7MqKoFY7NANL2%2B6iig%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035216.html">
   <LINK REL="Next"  HREF="035282.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node	connection</H1>
    <B>joseph rouphael</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Fwd%3A%20Performance%20bottleneck%20on%20inter-node%0A%09connection&In-Reply-To=%3CCADEZEmzJMBVo%2BS8QdzyD1BbXP_YjE%3DDu7MqKoFY7NANL2%2B6iig%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node	connection">josephrouphael at gmail.com
       </A><BR>
    <I>Fri Apr 11 17:37:21 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035216.html">[rabbitmq-discuss] Performance bottleneck on inter-node	connection
</A></li>
        <LI>Next message: <A HREF="035282.html">[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35251">[ date ]</a>
              <a href="thread.html#35251">[ thread ]</a>
              <a href="subject.html#35251">[ subject ]</a>
              <a href="author.html#35251">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>---------- Forwarded message ----------
From: joseph rouphael &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">josephrouphael at gmail.com</A>&gt;
Date: Fri, Apr 11, 2014 at 4:11 PM
Subject: Re: [rabbitmq-discuss] Performance bottleneck on inter-node
connection
To: Matthias Radestock &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;





On Thu, Apr 10, 2014 at 7:01 PM, Matthias Radestock
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;wrote:

&gt;<i> (re-adding the list)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 10/04/14 16:42, joseph rouphael wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On Thu, Apr 10, 2014 at 11:57 AM, Matthias Radestock
</I>&gt;&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>     Have you tried this w/o hipe?
</I>&gt;&gt;<i> In fact, HIPE is not enabled in Erlang, so this config has no effect.
</I>&gt;&gt;<i> (You can consider Hipe off)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ok, I'd still prefer if you took out that setting.
</I>
OK, setting removed. (Test re-done with same result)

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>          {delegate_count, 32},
</I>&gt;&gt;<i>     Why did you set this?
</I>&gt;&gt;<i> I have used this in a try to increase the number of delegate processes
</I>&gt;&gt;<i> used for intra-cluster configuration. Hoping that will increase
</I>&gt;&gt;<i> inter-node communication performance (But this had no effect)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Ditto.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  In fact, I am not using any synchronous mechanism. I am publishing
</I>&gt;&gt;<i> messages with no confirm.select.
</I>&gt;&gt;<i> I am using a c client (based on rabbitmq-c) to publish messages with the
</I>&gt;&gt;<i> following config:
</I>&gt;&gt;<i> - Non persistent
</I>&gt;&gt;<i> - No confirm.select
</I>&gt;&gt;<i> - Default Direct exchange
</I>&gt;&gt;<i> - Routing key equal to queue_name
</I>&gt;&gt;<i> - Message size 1KB
</I>&gt;&gt;<i> I am running 10 client processes which are publishing in parallel to 10
</I>&gt;&gt;<i> different queues.
</I>&gt;&gt;<i> Rate is regulated on the client, I can force the publsih rate in the C
</I>&gt;&gt;<i> client.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am running as well 10 other client processes to consume full-speed (no
</I>&gt;&gt;<i> rate regulation) from the 10 queues.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Do the consumers use acknowledgements?
</I>
Yes. Consumers are acknowledging the messages as soon as they are received
(No processing in between)
 I have re-done the test with no-ack and I have encountered the same
bottleneck.The rate achieved with no-ack was fluctuating between 18KHZ and
27KHZ (The expected rate is 100KHZ)


&gt;<i>
</I>&gt;<i>  I am using the same setup to publish/consume messages on one node (node
</I>&gt;&gt;<i> 1 where queues are created), with no issue. I can hit up to 100K TPS (5K
</I>&gt;&gt;<i> TPS on each client process).
</I>&gt;&gt;<i> The problem appears only when I try to publish on node1 and consume from
</I>&gt;&gt;<i> node2 (or publish on node2 and consume from node1). The problem appears
</I>&gt;&gt;<i> only when there is an inter-node activity.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So the 100kHz is the aggregate publishing and consuming rate, i.e. 10 x
</I>&gt;<i> 5kHz publishing and 10 x 5kHz consuming?
</I>&gt;<i>
</I>Sorry my mistake, there are 20 processes with 20 queues (Not 10). So 100KHZ
(20 x 5) producing and 100KHZ (20 x 5) consuming

&gt;<i>
</I>&gt;<i> What results do you get in the single-node and multi-node scenarios when
</I>&gt;<i> running the tests with just a single queue and single producer and single
</I>&gt;<i> consumer?
</I>&gt;<i>
</I>&gt;<i> Single producer/consumer/queue on single node max rate achieved: 11KHZ
</I>Single producer/consumer/queue on dual nodes max rate achieved: ~ 11KHZ
The impact of inter-node is not seen here because the traffic is limited by
the single client connection/process. In single consumer/producer
connection, the throughput is limited by the client connection itself not
by the inter-node connection.

Here are below a summary of the tests performed:

Test1: Single node, 20 queues, ACK on
------------------------------------
Nodes: Single node
Producer Processes: 20
Producer process regulate rate: 5KHZ
Acknowledgment: ON
Expected rate: 100 KHZ
Achieved rate: Steady at 100 KHZ
CPU idle: 33%
Note: No bottleneck detected

Test 2: Single node, 20 queues, ACK off
---------------------------------------
Nodes: Single node
Producer Processes: 20
Producer process regulate rate: 5KHZ
Acknowledgment: OFF
Expected rate: 100 KHZ
Achieved rate: Steady at 100 KHZ
CPU idle: 57%
Note: No bottleneck detected

Test 3: Single node, 1 queue, ACK on
------------------------------------
Nodes: Single node
Producer Processes: 1
Producer process regulate rate: 20KHZ
Acknowledgment: ON
Expected rate: 20 KHZ
Achieved rate: Steady 11 KHZ
CPU idle: 94%
Note: Bottleneck on single client connection

Test 4: Single node, 1 queue, ACK off
------------------------------------
Nodes: Single node
Producer Processes: 1
Producer process regulate rate: 20KHZ
Acknowledgment: OFF
Expected rate: 20 KHZ
Achieved rate: Steady 11 KHZ
CPU idle: 96%
Note: Bottleneck on single client connection

Test 5: Dual node, Queues/Producers on same node, 20 queue, ACK on
------------------------------------------------------------------
Nodes: Double node
Queues created on: Node1
Producers on: node 1
Consumers on: node 2
Producer Processes: 20
Producer regulate rate per process: 5KHZ
Acknowledgment: ON
Expected rate: 100KHZ
Achieved rate: Fluctuating between 12KHZ and 21KHZ
CPU idle: 88%
Note: Bottleneck on inter-node connection

Test 6: Dual node, Queues/Producers on same node, 20 queue, ACK off
-------------------------------------------------------------------
Nodes: Double node
Queues created on: Node1
Producers on: node 1
Consumers on: node 2
Producer Processes: 20
Producer regulate rate per process: 5KHZ
Acknowledgment: OFF
Expected rate: 100KHZ
Achieved rate: Fluctuating between 18KHZ and 27KHZ
CPU idle: 91%
Note: Bottleneck on inter-node connection

Test 7: Dual node, Queues/Consumers on same node, 20 queue, ACK on
------------------------------------------------------------------
Nodes: Double node
Queues created on: Node1
Producers on: node 2
Consumers on: node 1
Producer Processes: 20
Producer regulate rate per process: 5KHZ
Acknowledgment: ON
Expected rate: 100KHZ
Achieved rate: Fluctuating between 10KHZ and 20KHZ
CPU idle: 91%
Note: Bottleneck on inter-node connection

Test 8: Dual node, Queues/Consumers on same node, 20 queue, ACK off
-------------------------------------------------------------------
Nodes: Double node
Queues created on: Node1
Producers on: node 2
Consumers on: node 1
Producer Processes: 20
Producer regulate rate per process: 5KHZ
Acknowledgment: OFF
Expected rate: 100KHZ
Achieved rate: Fluctuating between 10KHZ and 20KHZ
CPU idle: 95%
Note: Bottleneck on inter-node connection


Test 9: Dual node, 1 queue, ACK off
------------------------------------
Nodes: Double node
Queues created on: Node1
Producers on: node 2
Consumers on: node 1
Producer Processes: 1
Producer regulate rate per process: 20KHZ
Acknowledgment: OFF
Expected rate: 20KHZ
Achieved rate: Steady 10.5KHZ
CPU idle: 96%
Note: Bottleneck on single client connection

Test 10: Dual node, 1 queue, ACK on
------------------------------------
Nodes: Double node
Queues created on: Node1
Producers on: node 2
Consumers on: node 1
Producer Processes: 1
Producer regulate rate per process: 20KHZ
Acknowledgment: ON
Expected rate: 20KHZ
Achieved rate: Steady 10.5KHZ
CPU idle: 95%
Note: Bottleneck on single client connection


&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Matthias.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140411/f07f3b89/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140411/f07f3b89/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035216.html">[rabbitmq-discuss] Performance bottleneck on inter-node	connection
</A></li>
	<LI>Next message: <A HREF="035282.html">[rabbitmq-discuss] Fwd: Performance bottleneck on inter-node connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35251">[ date ]</a>
              <a href="thread.html#35251">[ thread ]</a>
              <a href="subject.html#35251">[ subject ]</a>
              <a href="author.html#35251">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
