<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmq-c corrupt content frame from ARM	client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq-c%20corrupt%20content%20frame%20from%20ARM%0A%09client&In-Reply-To=%3CCAAt2po%2BZa83jHUcH4hyZKK78kirOGZ38ROX8MhAOc7oh6ofx3g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035017.html">
   <LINK REL="Next"  HREF="035070.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmq-c corrupt content frame from ARM	client</H1>
    <B>Alan Antonuk</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmq-c%20corrupt%20content%20frame%20from%20ARM%0A%09client&In-Reply-To=%3CCAAt2po%2BZa83jHUcH4hyZKK78kirOGZ38ROX8MhAOc7oh6ofx3g%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmq-c corrupt content frame from ARM	client">alan.antonuk at gmail.com
       </A><BR>
    <I>Mon Apr  7 18:40:20 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="035017.html">[rabbitmq-discuss] rabbitmq-c corrupt content frame from ARM client
</A></li>
        <LI>Next message: <A HREF="035070.html">[rabbitmq-discuss] rabbitmq-c corrupt content frame from ARM client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35069">[ date ]</a>
              <a href="thread.html#35069">[ thread ]</a>
              <a href="subject.html#35069">[ subject ]</a>
              <a href="author.html#35069">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Marco - Thanks I got the file and was able to look at it in Wireshark. Upon
first glance I see two issues: the frame type is wrong (the first byte
should be 0x01 instead of 0x02), and there appears to be an added 0x05
octet right at the beginning of the frame payload (it should be 0x00, 0x0a,
0x00, 0x0b). There may also be some other issues as I didn't look more
deeply than that.  Question for you: is your armv6 system running in little
or big-endian mode? It appears that we've correctly detected the endianness
of the system, but I'm not 100% sure on that.

Also when compiling the library did you notice any compiler warnings?
(Enable -Wall -Wextra if necessary).

*To one of the RabbitMQ broker developers*: for the following message in
the RabbitMQ broker logs:

    =ERROR REPORT==== 3-Apr-2014::15:05:35 ===
    closing AMQP connection &lt;0.380.0&gt; (192.168.1.117:52890
    &lt;<A HREF="http://192.168.1.117:52890">http://192.168.1.117:52890</A>&gt; -&gt; 192.168.1.133:5672
    &lt;<A HREF="http://192.168.1.133:5672">http://192.168.1.133:5672</A>&gt;):

    {handshake_error,starting,0,
                      {amqp_error,frame_error,
                                  &quot;type 0, first 16 octets =
    &lt;&lt;5,10,0,11,0,0,0,80,98,112,__114,111,100,117,99,116&gt;&gt;...&quot;,

                                  none}}

Are those first 16 octets including or not including the frame header?

-Alan



On Sun, Apr 6, 2014 at 2:25 AM, Marco Scoffier &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">marco at metm.org</A>&gt; wrote:

&gt;<i> Hi Alan,
</I>&gt;<i>
</I>&gt;<i> I just re-uploaded the file to include all the packets around the
</I>&gt;<i> handshake (not just the 3 I get when filtering for AMQP) as you mentioned
</I>&gt;<i> wireshark itself might also have parsing issues.
</I>&gt;<i>
</I>&gt;<i> Marco
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 04/06/2014 03:16 AM, Marco Scoffier wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Sure,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I dumped the 3 packets to a separate file. This is the binary data which
</I>&gt;&gt;<i> you can open in wireshark:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://metm.org/images/amqp_handshake_wireshark.log">http://metm.org/images/amqp_handshake_wireshark.log</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for looking into this and happy to provide any additional tests,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Marco
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 04/06/2014 12:48 AM, Alan Antonuk wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Marco;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  From the wireshark info, it sounds like the rabbitmq-c client is
</I>&gt;&gt;&gt;<i> sending completely the wrong data. It should send a Connection.Start-Ok
</I>&gt;&gt;&gt;<i> method and not a content-header frame (e.g., the frame type should be 1
</I>&gt;&gt;&gt;<i> first few bytes of that frame should be: 0x01 {Method Frame}, 0x00, 0x00
</I>&gt;&gt;&gt;<i> {Channel 0}, 0x00, 0x00 0xXX, 0xXX {Big Endian length of frame in bytes}
</I>&gt;&gt;&gt;<i> ). I'm also not sure what to to think about the sent header length: that
</I>&gt;&gt;&gt;<i> should be 8 bytes or 64 bits, I suspect thats a wireshark oddity though.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The octets reported by the RabbitMQ server error message don't really
</I>&gt;&gt;&gt;<i> make sense to me: I'm having trouble correlating what is reported vs
</I>&gt;&gt;&gt;<i> what I think should be, even if the system is doing an incorrect
</I>&gt;&gt;&gt;<i> byteswap. I'm not 100% sure we're clear of any unaligned access issues,
</I>&gt;&gt;&gt;<i> but I would guess we'd be hitting bus-errors in that case, though I'm
</I>&gt;&gt;&gt;<i> not quite sure
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Would you be willing to send me a filtered down wireshark log of the
</I>&gt;&gt;&gt;<i> failed handshake?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -Alan
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Fri, Apr 4, 2014 at 6:38 PM, Marco Scoffier &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">marco at metm.org</A>
</I>&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">marco at metm.org</A>&gt;&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Hello,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     I apologize if this has been discussed before. I checked the
</I>&gt;&gt;&gt;<i>     archives but did not find any mention of the issue.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     I've compiled rabbitmq-c [1] for the arm architecture [2]  from and
</I>&gt;&gt;&gt;<i>     am trying to send messages to a broker running on another machine
</I>&gt;&gt;&gt;<i>     [3]. The rabbitmq-c examples run perfectly on the 64bit linux, same
</I>&gt;&gt;&gt;<i>     code compiled for arm device and running there sends a corrupt
</I>&gt;&gt;&gt;<i> packet.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     [1] <A HREF="https://github.com/alanxz/__rabbitmq-c">https://github.com/alanxz/__rabbitmq-c</A>
</I>&gt;&gt;&gt;<i>     &lt;<A HREF="https://github.com/alanxz/rabbitmq-c">https://github.com/alanxz/rabbitmq-c</A>&gt;
</I>&gt;&gt;&gt;<i>     [2] armv6 linaro toolchain
</I>&gt;&gt;&gt;<i>     [3] linux 64bit rabbitmq-server ppa for ubuntu. running on 12.04
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     I'm a little stuck about how to debug further and am looking for
</I>&gt;&gt;&gt;<i>     some pointers where to look in the code or what extra information I
</I>&gt;&gt;&gt;<i>     can provide.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Wireshark shows three packets for the amqp_sendstring example
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     ARM device/Source = 192.168.1.117
</I>&gt;&gt;&gt;<i>     64bit broker/Destination = 192.168.1.133
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Source          Destination    protocol length info
</I>&gt;&gt;&gt;<i>     --------------+---------------__+--------+------+------------
</I>&gt;&gt;&gt;<i>     192.168.1.117   192.168.1.133   AMQP    74      Protocol-Header 9-1
</I>&gt;&gt;&gt;<i>     192.168.1.133   192.168.1.117   AMQP    522     Connection.Start
</I>&gt;&gt;&gt;<i>     192.168.1.117   192.168.1.133   AMQP    190     Content-Header
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     wireshark's amqp frame dissection shows an error on the 3rd
</I>&gt;&gt;&gt;<i>     Content-Header packet:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Expert Info (Error/Protocol): Unknown header class 1290
</I>&gt;&gt;&gt;<i>     Message: Unknown header class 1290
</I>&gt;&gt;&gt;<i>     Severity level: Error
</I>&gt;&gt;&gt;<i>     Group: Protocol
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     the rabbitmq-server on the linux machine provides this log message:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     =ERROR REPORT==== 3-Apr-2014::15:05:35 ===
</I>&gt;&gt;&gt;<i>     closing AMQP connection &lt;0.380.0&gt; (192.168.1.117:52890
</I>&gt;&gt;&gt;<i>     &lt;<A HREF="http://192.168.1.117:52890">http://192.168.1.117:52890</A>&gt; -&gt; 192.168.1.133:5672
</I>&gt;&gt;&gt;<i>     &lt;<A HREF="http://192.168.1.133:5672">http://192.168.1.133:5672</A>&gt;):
</I>&gt;&gt;&gt;<i>     {handshake_error,starting,0,
</I>&gt;&gt;&gt;<i>                       {amqp_error,frame_error,
</I>&gt;&gt;&gt;<i>                                   &quot;type 0, first 16 octets =
</I>&gt;&gt;&gt;<i>     &lt;&lt;5,10,0,11,0,0,0,80,98,112,__114,111,100,117,99,116&gt;&gt;...&quot;,
</I>&gt;&gt;&gt;<i>                                   none}}
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     repeat that the same code compiled for 64bit linux same command
</I>&gt;&gt;&gt;<i>     works as expected.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Thanks for any pointers,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     Marco
</I>&gt;&gt;&gt;<i>     _________________________________________________
</I>&gt;&gt;&gt;<i>     rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i>     <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.__rabbitmq.com</A>
</I>&gt;&gt;&gt;<i>     &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss">https://lists.rabbitmq.com/__cgi-bin/mailman/listinfo/__rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140407/9344ba58/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140407/9344ba58/attachment.html</A>&gt;
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035017.html">[rabbitmq-discuss] rabbitmq-c corrupt content frame from ARM client
</A></li>
	<LI>Next message: <A HREF="035070.html">[rabbitmq-discuss] rabbitmq-c corrupt content frame from ARM client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35069">[ date ]</a>
              <a href="thread.html#35069">[ thread ]</a>
              <a href="subject.html#35069">[ subject ]</a>
              <a href="author.html#35069">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
