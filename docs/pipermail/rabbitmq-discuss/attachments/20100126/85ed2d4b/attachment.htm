<tt>
Hi&nbsp;folks,&lt;br&gt;&lt;br&gt;I&amp;#39;m&nbsp;trying&nbsp;to&nbsp;find&nbsp;a&nbsp;good&nbsp;way&nbsp;to&nbsp;monitor&nbsp;rabbit&nbsp;for&nbsp;inclusion&nbsp;in&nbsp;an&nbsp;HA&nbsp;cluster&nbsp;(pacemaker/corosync).&lt;br&gt;&lt;br&gt;Does&nbsp;anyone&nbsp;have&nbsp;a&nbsp;good&nbsp;resource&nbsp;agent&nbsp;already&nbsp;created&nbsp;for&nbsp;such&nbsp;a&nbsp;purpose?&lt;br&gt;&lt;br&gt;Here&nbsp;is&nbsp;what&nbsp;I&amp;#39;ve&nbsp;got&nbsp;so&nbsp;far:&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;br&gt;#!/bin/bash                                                                                                                                                                                               &nbsp;&lt;br&gt;#######################################################################&lt;br&gt;<br>
<br>
#&nbsp;Initialization:                                                     &nbsp;&lt;br&gt;.&nbsp;/usr/lib/ocf/resource.d/heartbeat/.ocf-shellfuncs&lt;br&gt;#######################################################################&lt;br&gt;&lt;br&gt;meta_data()&nbsp;{&lt;br&gt;<br>
<br>
       &nbsp;cat&nbsp;&amp;lt;&amp;lt;END&lt;br&gt;&amp;lt;?xml&nbsp;version=&amp;quot;1.0&amp;quot;?&amp;gt;&lt;br&gt;&amp;lt;!DOCTYPE&nbsp;resource-agent&nbsp;SYSTEM&nbsp;&amp;quot;ra-api-1.dtd&amp;quot;&amp;gt;&lt;br&gt;&amp;lt;resource-agent&nbsp;name=&amp;quot;rabbitmq&amp;quot;&nbsp;version=&amp;quot;0.9&amp;quot;&amp;gt;&nbsp;&lt;br&gt;&amp;lt;version&amp;gt;1.0&amp;lt;/version&amp;gt;                        &nbsp;&lt;br&gt;<br>
<br>
&lt;br&gt;&amp;lt;longdesc&nbsp;lang=&amp;quot;en&amp;quot;&amp;gt;&lt;br&gt;Rabbitmq&nbsp;agent     &nbsp;&lt;br&gt;&amp;lt;/longdesc&amp;gt;        &nbsp;&lt;br&gt;&amp;lt;shortdesc&nbsp;lang=&amp;quot;en&amp;quot;&amp;gt;Rabbitmq&nbsp;resource&nbsp;agent&amp;lt;/shortdesc&amp;gt;&lt;br&gt;&amp;lt;actions&amp;gt;&lt;br&gt;&amp;lt;action&nbsp;name=&amp;quot;start&amp;quot;       &nbsp;timeout=&amp;quot;90&amp;quot;&nbsp;/&amp;gt;&lt;br&gt;<br>
<br>
&amp;lt;action&nbsp;name=&amp;quot;stop&amp;quot;        &nbsp;timeout=&amp;quot;100&amp;quot;&nbsp;/&amp;gt;&lt;br&gt;&amp;lt;action&nbsp;name=&amp;quot;monitor&amp;quot;     &nbsp;timeout=&amp;quot;20&amp;quot;&nbsp;interval=&amp;quot;10&amp;quot;&nbsp;depth=&amp;quot;0&amp;quot;&nbsp;start-delay=&amp;quot;0&amp;quot;&nbsp;/&amp;gt;&lt;br&gt;&amp;lt;action&nbsp;name=&amp;quot;meta-data&amp;quot;   &nbsp;timeout=&amp;quot;5&amp;quot;&nbsp;/&amp;gt;                                        &nbsp;&lt;br&gt;<br>
<br>
&amp;lt;action&nbsp;name=&amp;quot;validate-all&amp;quot;  &nbsp;timeout=&amp;quot;30&amp;quot;&nbsp;/&amp;gt;                                     &nbsp;&lt;br&gt;&amp;lt;/actions&amp;gt;                                                                        &nbsp;&lt;br&gt;&amp;lt;/resource-agent&amp;gt;                                                                 &nbsp;&lt;br&gt;<br>
<br>
END                                                                               &nbsp;&lt;br&gt;}                                                                                 &nbsp;&lt;br&gt;&lt;br&gt;usage()&nbsp;{&lt;br&gt;       &nbsp;cat&nbsp;&amp;lt;&amp;lt;END&lt;br&gt;usage:&nbsp;$0&nbsp;{start|stop|monitor|validate-all|meta-data}&lt;br&gt;<br>
<br>
&lt;br&gt;END&lt;br&gt;} &nbsp;&lt;br&gt;&lt;br&gt;start()&nbsp;{&lt;br&gt;       &nbsp;/usr/sbin/rabbitmq-multi&nbsp;start_all&nbsp;1&nbsp;2&amp;gt;&amp;amp;1&nbsp;&amp;gt;&nbsp;/dev/null&lt;br&gt;       &nbsp;exit&nbsp;$?                                             &nbsp;&lt;br&gt;}                                                           &nbsp;&lt;br&gt;<br>
<br>
&lt;br&gt;stop()&nbsp;{&lt;br&gt; &nbsp;/usr/sbin/rabbitmq-multi&nbsp;stop_all&nbsp;2&amp;gt;&amp;amp;1&nbsp;&amp;gt;&nbsp;/dev/null&lt;br&gt; &nbsp;ret=$?                                           &nbsp;&lt;br&gt;&lt;br&gt; &nbsp;if&nbsp;[&nbsp;$ret&nbsp;-eq&nbsp;2&nbsp;];&nbsp;then&lt;br&gt;   &nbsp;return&nbsp;$OCF_SUCCESS &nbsp;&lt;br&gt; &nbsp;fi                    &nbsp;&lt;br&gt;<br>
<br>
&lt;br&gt; &nbsp;if&nbsp;[&nbsp;$ret&nbsp;-ne&nbsp;0&nbsp;];&nbsp;then&lt;br&gt;   &nbsp;sleep&nbsp;5             &nbsp;&lt;br&gt;   &nbsp;pidof&nbsp;beam.smp      &nbsp;&lt;br&gt;   &nbsp;ret=$?              &nbsp;&lt;br&gt;   &nbsp;if&nbsp;[&nbsp;$ret&nbsp;-eq&nbsp;1&nbsp;];&nbsp;then&lt;br&gt;     &nbsp;/usr/bin/killall&nbsp;-TERM&nbsp;epmd&nbsp;beam.smp&lt;br&gt;     &nbsp;sleep&nbsp;30&lt;br&gt;     &nbsp;/usr/bin/killall&nbsp;-KILL&nbsp;epmd&nbsp;beam.smp&lt;br&gt;<br>
<br>
   &nbsp;fi&lt;br&gt; &nbsp;fi&lt;br&gt; &nbsp;return&nbsp;$OCF_SUCCESS&lt;br&gt;}&lt;br&gt;&lt;br&gt;monitor()&nbsp;{&lt;br&gt; &nbsp;status=`/usr/sbin/rabbitmq-multi&nbsp;status&nbsp;2&amp;gt;&amp;amp;1`&lt;br&gt; &nbsp;res=$?&lt;br&gt; &nbsp;if&nbsp;[&nbsp;$res&nbsp;-eq&nbsp;2&nbsp;];&nbsp;then&lt;br&gt;   &nbsp;return&nbsp;$OCF_NOT_RUNNING&lt;br&gt; &nbsp;fi&lt;br&gt;&lt;br&gt; &nbsp;if&nbsp;[[&nbsp;$status&nbsp;=~&nbsp;&amp;#39;not_running&amp;#39;&nbsp;]];&nbsp;then&lt;br&gt;<br>
<br>
   &nbsp;return&nbsp;$OCF_NOT_RUNNING&lt;br&gt; &nbsp;else&lt;br&gt;   &nbsp;if&nbsp;[&nbsp;$res&nbsp;-eq&nbsp;0&nbsp;];&nbsp;then&lt;br&gt;     &nbsp;return&nbsp;$OCF_SUCCESS&lt;br&gt;   &nbsp;else&lt;br&gt;     &nbsp;return&nbsp;$OCF_ERR_GENERIC&lt;br&gt;   &nbsp;fi&lt;br&gt; &nbsp;fi&lt;br&gt;}&lt;br&gt;&lt;br&gt;validate()&nbsp;{&lt;br&gt;   &nbsp;return&nbsp;$OCF_SUCCESS&lt;br&gt;}&lt;br&gt;<br>
<br>
&lt;br&gt;case&nbsp;$__OCF_ACTION&nbsp;in&lt;br&gt;meta-data)     &nbsp;meta_data&lt;br&gt;               &nbsp;exit&nbsp;$OCF_SUCCESS&lt;br&gt;               &nbsp;;;&lt;br&gt;start)         &nbsp;start;;&lt;br&gt;stop)          &nbsp;stop;;&lt;br&gt;monitor)       &nbsp;monitor;;&lt;br&gt;validate-all)  &nbsp;validate;;&lt;br&gt;<br>
<br>
usage|help)    &nbsp;usage&lt;br&gt;               &nbsp;exit&nbsp;$OCF_SUCCESS&lt;br&gt;               &nbsp;;;&lt;br&gt;*)             &nbsp;usage&lt;br&gt;               &nbsp;exit&nbsp;$OCF_ERR_UNIMPLEMENTED&lt;br&gt;               &nbsp;;;&lt;br&gt;esac&lt;br&gt;rc=$?&lt;br&gt;ocf_log&nbsp;debug&nbsp;&amp;quot;${OCF_RESOURCE_INSTANCE}&nbsp;$__OCF_ACTION&nbsp;:&nbsp;$rc&amp;quot;&lt;br&gt;<br>
<br>
exit&nbsp;$rc&lt;br&gt;&lt;br&gt;&lt;br&gt;---------&lt;br&gt;&lt;br&gt;It&nbsp;feels&nbsp;like&nbsp;a&nbsp;bit&nbsp;of&nbsp;a&nbsp;kludge&nbsp;though.&nbsp;If&nbsp;anyone&nbsp;has&nbsp;any&nbsp;suggestions&nbsp;on&nbsp;how&nbsp;to&nbsp;thoroughly&nbsp;monitor&nbsp;rabbit,&nbsp;please&nbsp;let&nbsp;me&nbsp;know.&lt;br&gt;&lt;br&gt;&lt;br&gt;Regards,&lt;br&gt;&lt;br&gt;--&nbsp;&lt;br&gt;Mark&nbsp;Steele&lt;br&gt;Director&nbsp;of&nbsp;development&lt;br&gt;<br>
<br>
Bering&nbsp;Media&nbsp;Inc.&lt;br&gt;&lt;br&gt;&lt;br&gt;
</tt>
