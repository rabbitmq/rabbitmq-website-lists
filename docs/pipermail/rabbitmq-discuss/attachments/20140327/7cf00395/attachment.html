<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Because&nbsp;we&#39;re&nbsp;sometimes&nbsp;just&nbsp;mean&nbsp;to&nbsp;our&nbsp;software,&nbsp;I&nbsp;wrote&nbsp;a&nbsp;torture&nbsp;test&nbsp;to&nbsp;see&nbsp;how&nbsp;RabbitMQ&#39;s&nbsp;Autoheal&nbsp;deal&nbsp;with&nbsp;repeated&nbsp;partitions.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;a&nbsp;nutshell,&nbsp;we&nbsp;start&nbsp;with&nbsp;two&nbsp;brokers&nbsp;(3.2.4)&nbsp;in&nbsp;a&nbsp;cluster.&nbsp;I&nbsp;run&nbsp;my&nbsp;test&nbsp;which&nbsp;uses&nbsp;&quot;iptables&quot;&nbsp;to&nbsp;knock&nbsp;out&nbsp;the&nbsp;link&nbsp;between&nbsp;the&nbsp;two&nbsp;brokers&nbsp;and&nbsp;then&nbsp;restore&nbsp;things.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;does&nbsp;this&nbsp;break/fix&nbsp;continuously&nbsp;in&nbsp;a&nbsp;loop.&nbsp;The&nbsp;time&nbsp;between&nbsp;partitions,&nbsp;and&nbsp;the&nbsp;time&nbsp;inside&nbsp;partitions&nbsp;is&nbsp;configurable.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Using&nbsp;60&nbsp;seconds&nbsp;between&nbsp;inducing&nbsp;a&nbsp;partition,&nbsp;and&nbsp;60&nbsp;seconds&nbsp;in&nbsp;a&nbsp;partitioned&nbsp;state,&nbsp;I&nbsp;expect&nbsp;that&nbsp;this&nbsp;might&nbsp;be&nbsp;messy&nbsp;-&nbsp;The&nbsp;brokers&nbsp;try&nbsp;to&nbsp;autoheal,&nbsp;and&nbsp;then&nbsp;everything&nbsp;falls&nbsp;apart.&nbsp;However,&nbsp;I&#39;d&nbsp;expect&nbsp;that&nbsp;once&nbsp;I&nbsp;stop&nbsp;my&nbsp;torture&nbsp;and&nbsp;return&nbsp;things&nbsp;back&nbsp;to&nbsp;&quot;normal&quot;,&nbsp;that&nbsp;an&nbsp;autoheal&nbsp;will&nbsp;eventually&nbsp;succeed&nbsp;and&nbsp;the&nbsp;brokers&nbsp;will&nbsp;be&nbsp;happily&nbsp;clustered&nbsp;again.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;isn&#39;t&nbsp;what&nbsp;happens.&nbsp;Instead,&nbsp;the&nbsp;two&nbsp;brokers&nbsp;essentially&nbsp;ignore&nbsp;each&nbsp;other.&nbsp;Even&nbsp;after&nbsp;waiting&nbsp;for&nbsp;10+&nbsp;minutes.&nbsp;I&nbsp;can&nbsp;see&nbsp;each&nbsp;broker,&nbsp;but&nbsp;they&nbsp;each&nbsp;think&nbsp;the&nbsp;other&nbsp;is&nbsp;missing.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;Here&#39;s&nbsp;a&nbsp;filtered&nbsp;view&nbsp;of&nbsp;the&nbsp;logs,&nbsp;grepping&nbsp;for&nbsp;&quot;Autoheal|Starting|Stopping|Partitions|Winner|Loser&quot;:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal&nbsp;request&nbsp;sent&nbsp;to&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal:&nbsp;I&nbsp;am&nbsp;the&nbsp;winner,&nbsp;waiting&nbsp;for&nbsp;[rabbit@mq1]&nbsp;to&nbsp;stop&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal:&nbsp;I&nbsp;am&nbsp;the&nbsp;winner,&nbsp;waiting&nbsp;additionally&nbsp;for&nbsp;[rabbit@mq1]&nbsp;to&nbsp;stop&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;sent&nbsp;to&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;received&nbsp;from&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;decision&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Partitions:&nbsp;[[rabbit@mq1],[rabbit@mq2]]&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Winner:&nbsp; &nbsp; &nbsp;rabbit@mq2&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Losers:&nbsp; &nbsp; &nbsp;[rabbit@mq1]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;received&nbsp;from&nbsp;rabbit@mq2&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;decision&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Partitions:&nbsp;[[rabbit@mq1],[rabbit@mq2]]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Winner:&nbsp; &nbsp; &nbsp;rabbit@mq2&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Losers:&nbsp; &nbsp; &nbsp;[rabbit@mq1]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal:&nbsp;we&nbsp;were&nbsp;selected&nbsp;to&nbsp;restart;&nbsp;winner&nbsp;is&nbsp;rabbit@mq2&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Stopping&nbsp;RabbitMQ&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal:&nbsp;aborting&nbsp;-&nbsp;rabbit@mq1&nbsp;went&nbsp;down&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal&nbsp;request&nbsp;sent&nbsp;to&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal:&nbsp;we&nbsp;were&nbsp;selected&nbsp;to&nbsp;restart;&nbsp;winner&nbsp;is&nbsp;rabbit@mq1&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Stopping&nbsp;RabbitMQ&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal:&nbsp;aborting&nbsp;-&nbsp;rabbit@mq2&nbsp;went&nbsp;down&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;sent&nbsp;to&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;received&nbsp;from&nbsp;rabbit@mq2&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;decision&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Partitions:&nbsp;[[rabbit@mq1],[rabbit@mq2]]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Winner:&nbsp; &nbsp; &nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Losers:&nbsp; &nbsp; &nbsp;[rabbit@mq2]&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;received&nbsp;from&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;decision&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Partitions:&nbsp;[[rabbit@mq1],[rabbit@mq2]]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Winner:&nbsp; &nbsp; &nbsp;rabbit@mq1&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Losers:&nbsp; &nbsp; &nbsp;[rabbit@mq2]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal:&nbsp;I&nbsp;am&nbsp;the&nbsp;winner,&nbsp;waiting&nbsp;for&nbsp;[rabbit@mq2]&nbsp;to&nbsp;stop&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal:&nbsp;I&nbsp;am&nbsp;the&nbsp;winner,&nbsp;waiting&nbsp;additionally&nbsp;for&nbsp;[rabbit@mq2]&nbsp;to&nbsp;stop&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal:&nbsp;aborting&nbsp;-&nbsp;rabbit@mq1&nbsp;went&nbsp;down&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal&nbsp;request&nbsp;sent&nbsp;to&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq2.log:&nbsp;Autoheal:&nbsp;we&nbsp;were&nbsp;selected&nbsp;to&nbsp;restart;&nbsp;winner&nbsp;is&nbsp;rabbit@mq1&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal:&nbsp;aborting&nbsp;-&nbsp;rabbit@mq2&nbsp;went&nbsp;down&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;sent&nbsp;to&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;received&nbsp;from&nbsp;rabbit@mq2&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;<br>
rabbit@mq1.log:&nbsp;Autoheal&nbsp;decision&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Partitions:&nbsp;[[rabbit@mq1],[rabbit@mq2]]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Winner:&nbsp; &nbsp; &nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Losers:&nbsp; &nbsp; &nbsp;[rabbit@mq2]&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;request&nbsp;received&nbsp;from&nbsp;rabbit@mq1&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal&nbsp;decision&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Partitions:&nbsp;[[rabbit@mq1],[rabbit@mq2]]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Winner:&nbsp; &nbsp; &nbsp;rabbit@mq1&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log: &nbsp;*&nbsp;Losers:&nbsp; &nbsp; &nbsp;[rabbit@mq2]&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal:&nbsp;I&nbsp;am&nbsp;the&nbsp;winner,&nbsp;waiting&nbsp;for&nbsp;[rabbit@mq2]&nbsp;to&nbsp;stop&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;rabbit@mq1.log:&nbsp;Autoheal:&nbsp;I&nbsp;am&nbsp;the&nbsp;winner,&nbsp;waiting&nbsp;additionally&nbsp;for&nbsp;[rabbit@mq2]&nbsp;to&nbsp;stop&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;#&nbsp;And&nbsp;nothing&nbsp;else&nbsp;beyond&nbsp;this,&nbsp;even&nbsp;after&nbsp;waiting&nbsp;for&nbsp;10+&nbsp;minutes.&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;I&nbsp;don&#39;t&nbsp;ever&nbsp;see&nbsp;the&nbsp;&quot;Stopping&nbsp;RabbitMQ&quot;&nbsp;that&nbsp;I&#39;ve&nbsp;seen&nbsp;in&nbsp;other&nbsp;Autoheal&nbsp;circumstances.&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;&quot;&gt;I&nbsp;can&nbsp;send&nbsp;more&nbsp;complete&nbsp;logs,&nbsp;but&nbsp;wanted&nbsp;to&nbsp;see&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;known&nbsp;issue&nbsp;or&nbsp;expected&nbsp;behavior&nbsp;first.&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;&quot;&gt;Matt&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
