<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Apr&nbsp;14,&nbsp;2014&nbsp;at&nbsp;12:00&nbsp;PM,&nbsp;Matthias&nbsp;Radestock&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:matthias@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;matthias@rabbitmq.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;11/04/14&nbsp;17:37,&nbsp;joseph&nbsp;rouphael&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Test&nbsp;8:&nbsp;Dual&nbsp;node,&nbsp;Queues/Consumers&nbsp;on&nbsp;same&nbsp;node,&nbsp;20&nbsp;queue,&nbsp;ACK&nbsp;off&lt;br&gt;<br>
------------------------------&lt;u&gt;&lt;/u&gt;------------------------------&lt;u&gt;&lt;/u&gt;-------&lt;br&gt;<br>
Nodes:&nbsp;Double&nbsp;node&lt;br&gt;<br>
Queues&nbsp;created&nbsp;on:&nbsp;Node1&lt;br&gt;<br>
Producers&nbsp;on:&nbsp;node&nbsp;2&lt;br&gt;<br>
Consumers&nbsp;on:&nbsp;node&nbsp;1&lt;br&gt;<br>
Producer&nbsp;Processes:&nbsp;20&lt;br&gt;<br>
Producer&nbsp;regulate&nbsp;rate&nbsp;per&nbsp;process:&nbsp;5KHZ&lt;br&gt;<br>
Acknowledgment:&nbsp;OFF&lt;br&gt;<br>
Expected&nbsp;rate:&nbsp;100KHZ&lt;br&gt;<br>
Achieved&nbsp;rate:&nbsp;Fluctuating&nbsp;between&nbsp;10KHZ&nbsp;and&nbsp;20KHZ&lt;br&gt;<br>
CPU&nbsp;idle:&nbsp;95%&lt;br&gt;<br>
Note:&nbsp;Bottleneck&nbsp;on&nbsp;inter-node&nbsp;connection&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
What&nbsp;happens&nbsp;when&nbsp;you&nbsp;run&nbsp;the&nbsp;above&nbsp;test&nbsp;with&nbsp;both&nbsp;nodes&nbsp;on&nbsp;the&nbsp;same&nbsp;machine?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;result&nbsp;is&nbsp;almost&nbsp;the&nbsp;same:&nbsp;Fluctuating&nbsp;between&nbsp;10&nbsp;and&nbsp;23KHZ&nbsp;(Expected&nbsp;100KHZ).&nbsp;Here&nbsp;is&nbsp;below&nbsp;the&nbsp;summary:&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;div&gt;Test&nbsp;11:&nbsp;Dual&nbsp;nodes&nbsp;same&nbsp;machine,&nbsp;Queues/Consumers&nbsp;on&nbsp;same&nbsp;node,&nbsp;20&nbsp;queue,&nbsp;ACK&nbsp;on/off&lt;br&gt;------------------------------&lt;u&gt;&lt;/u&gt;------------------------------&lt;u&gt;&lt;/u&gt;-------------------------------------------------------------------------------&lt;br&gt;<br>
Nodes:&nbsp;Double&nbsp;nodes&nbsp;same&nbsp;machine&lt;br&gt;Queues&nbsp;created&nbsp;on:&nbsp;Node1&lt;br&gt;Producers&nbsp;on:&nbsp;node&nbsp;2&lt;br&gt;Consumers&nbsp;on:&nbsp;node&nbsp;1&lt;br&gt;Producer&nbsp;Processes:&nbsp;20&lt;br&gt;Producer&nbsp;regulate&nbsp;rate&nbsp;per&nbsp;process:&nbsp;5KHZ&lt;br&gt;Acknowledgment:&nbsp;OFF&nbsp;or&nbsp;ON&nbsp;same&nbsp;result&lt;br&gt;<br>
Expected&nbsp;rate:&nbsp;100KHZ&lt;br&gt;Achieved&nbsp;rate:&nbsp;Fluctuating&nbsp;between&nbsp;10KHZ&nbsp;and&nbsp;23KHZ&lt;br&gt;CPU&nbsp;idle:&nbsp;82%&lt;br&gt;Note:&nbsp;Bottleneck&nbsp;on&nbsp;inter-node&nbsp;connection&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
&lt;br&gt;<br>
Also,&nbsp;you&nbsp;really&nbsp;shouldn&#39;t&nbsp;need&nbsp;20&nbsp;producers/consumers&nbsp;to&nbsp;saturate&nbsp;a&nbsp;broker,&nbsp;unless&nbsp;the&nbsp;machine&nbsp;has&nbsp;&gt;20&nbsp;cores.&nbsp;So&nbsp;I&#39;d&nbsp;be&nbsp;interested&nbsp;to&nbsp;hear&nbsp;what&nbsp;the&nbsp;smallest&nbsp;producer/consumer&nbsp;count&nbsp;is&nbsp;at&nbsp;which&nbsp;you&nbsp;see&nbsp;a&nbsp;significant&nbsp;performance&nbsp;difference&nbsp;between&nbsp;the&nbsp;single&nbsp;node&nbsp;and&nbsp;dual&nbsp;node&nbsp;case.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;The&nbsp;machine&nbsp;I&nbsp;am&nbsp;working&nbsp;on&nbsp;has&nbsp;32&nbsp;cores.&nbsp;So&nbsp;I&nbsp;am&nbsp;relaxed&nbsp;with&nbsp;the&nbsp;numbers&nbsp;of&nbsp;processes.&lt;/div&gt;&lt;div&gt;1&nbsp;producer/consumer&nbsp;achieve&nbsp;a&nbsp;maximum&nbsp;of&nbsp;11&nbsp;KHZ&nbsp;(No&nbsp;inter-node&nbsp;impact.&nbsp;On&nbsp;single&nbsp;node&nbsp;it&nbsp;achieves&nbsp;the&nbsp;same)&lt;/div&gt;<br>
&lt;div&gt;2&nbsp;producers/consumers&nbsp;achieve&nbsp;a&nbsp;maximum&nbsp;of&nbsp;~&nbsp;20&nbsp;KHZ&nbsp;(Minor&nbsp;inter-node&nbsp;impact&nbsp;-&nbsp;expected&nbsp;22KHZ)&lt;/div&gt;&lt;div&gt;3&nbsp;producers/consumers&nbsp;achieve&nbsp;a&nbsp;maximum&nbsp;of&nbsp;~&nbsp;20&nbsp;KHZ&nbsp;(Major&nbsp;inter-node&nbsp;impact&nbsp;-&nbsp;expected&nbsp;33KHZ)&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
&lt;br&gt;<br>
Finally,&nbsp;it&nbsp;would&nbsp;be&nbsp;helpful&nbsp;if&nbsp;you&nbsp;ran&nbsp;your&nbsp;tests&nbsp;using&nbsp;RabbitMQ&#39;s&nbsp;standard&nbsp;performance&nbsp;testing&nbsp;tool,&nbsp;PerfTest&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/java-tools.html#perftest&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/java-&lt;u&gt;&lt;/u&gt;tools.html#perftest&lt;/a&gt;.&nbsp;In&nbsp;order&nbsp;to&nbsp;replicate&nbsp;the&nbsp;above&nbsp;scenario&nbsp;you&#39;d&nbsp;run&nbsp;20&nbsp;PerfTest&nbsp;instances&nbsp;with&nbsp;options&lt;br&gt;<br>
<br>
 &nbsp;-u&nbsp;q&lt;n&gt;&nbsp;-x&nbsp;0&nbsp;-a&lt;br&gt;<br>
and&nbsp;20&nbsp;instances&nbsp;with&lt;br&gt;<br>
 &nbsp;-u&nbsp;q&lt;n&gt;&nbsp;-y&nbsp;0&lt;br&gt;<br>
with&nbsp;n&nbsp;in&nbsp;1..20.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;perftest&nbsp;ran&nbsp;as&nbsp;advised&nbsp;and&nbsp;the&nbsp;test&nbsp;produced&nbsp;the&nbsp;same&nbsp;result.&nbsp;There&nbsp;is&nbsp;a&nbsp;real&nbsp;inter-node&nbsp;bottleneck.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;Results&nbsp;of&nbsp;perftest:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Test&nbsp;1:&nbsp;Double&nbsp;nodes&nbsp;same&nbsp;machine&lt;/div&gt;&lt;div&gt;----------&lt;/div&gt;&lt;div&gt;Node1&nbsp;and&nbsp;Node2&nbsp;on&nbsp;same&nbsp;machine&lt;/div&gt;&lt;div&gt;Node1&nbsp;listening&nbsp;on&nbsp;port&nbsp;5672&lt;/div&gt;&lt;div&gt;Node2&nbsp;listening&nbsp;on&nbsp;port&nbsp;5673&lt;/div&gt;&lt;div&gt;20&nbsp;consumers&nbsp;running&nbsp;full&nbsp;speed&lt;/div&gt;<br>
&lt;div&gt;20&nbsp;producers&nbsp;running&nbsp;full&nbsp;speed&lt;/div&gt;&lt;div&gt;Message&nbsp;size&nbsp;1KB&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Max&nbsp;rate&nbsp;achieved:&nbsp;16KHZ&lt;/div&gt;&lt;div&gt;CPU&nbsp;Idle&nbsp;92%&lt;/div&gt;&lt;div&gt;Note:&nbsp;Inter-node&nbsp;bottleneck&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
&lt;div&gt;The&nbsp;script&nbsp;used&nbsp;to&nbsp;run&nbsp;the&nbsp;test:&lt;/div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:collapse;font-family:arial,sans-serif;font-size:13px&quot;&gt; &lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:collapse;font-family:arial,sans-serif;font-size:13px&quot;&gt;#!/bin/sh&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;for&nbsp;i&nbsp;in&nbsp;1&nbsp;2&nbsp;3&nbsp;4&nbsp;5&nbsp;6&nbsp;7&nbsp;8&nbsp;9&nbsp;10&nbsp;11&nbsp;12&nbsp;13&nbsp;14&nbsp;15&nbsp;16&nbsp;17&nbsp;18&nbsp;19&nbsp;20&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;do&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;./runjava.sh&nbsp;com.rabbitmq.examples.PerfTest&nbsp;-k&nbsp;queue$i&nbsp;-x&nbsp;0&nbsp;-a&nbsp;-h&nbsp;amqp://&lt;a&nbsp;href=&quot;http://193.100.200.130:5673&quot;&gt;193.100.200.130:5673&lt;/a&gt;&nbsp;-s&nbsp;1000&nbsp;&amp;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;./runjava.sh&nbsp;com.rabbitmq.examples.PerfTest&nbsp;-k&nbsp;queue$i&nbsp;-y&nbsp;0&nbsp;-h&nbsp;amqp://&lt;a&nbsp;href=&quot;http://193.100.200.130:5672&quot;&gt;193.100.200.130:5672&lt;/a&gt;&nbsp;-s&nbsp;1000&nbsp;&amp;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;done&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Test&nbsp;2:&nbsp;Single&nbsp;node&lt;/div&gt;&lt;div&gt;---------&lt;/div&gt;&lt;div&gt;Single&nbsp;node:&nbsp;Node1&lt;/div&gt;&lt;div&gt;Node1&nbsp;listening&nbsp;on&nbsp;port&nbsp;5672&lt;/div&gt;&lt;div&gt;20&nbsp;consumers&nbsp;running&nbsp;full&nbsp;speed&lt;br&gt;&lt;/div&gt;&lt;div&gt;20&nbsp;producers&nbsp;running&nbsp;full&nbsp;speed&lt;/div&gt;<br>
&lt;div&gt;Message&nbsp;size&nbsp;1KB&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Max&nbsp;rate&nbsp;achieved:&nbsp;200KHZ&lt;/div&gt;&lt;div&gt;CPU&nbsp;Idle&nbsp;12%&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:collapse;font-family:arial,sans-serif;font-size:13px&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
&lt;div&gt;The&nbsp;script&nbsp;used&nbsp;to&nbsp;run&nbsp;the&nbsp;test:&lt;/div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:collapse;font-family:arial,sans-serif;font-size:13px&quot;&gt; &lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:collapse;font-family:arial,sans-serif;font-size:13px&quot;&gt;#!/bin/sh&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;for&nbsp;i&nbsp;in&nbsp;1&nbsp;2&nbsp;3&nbsp;4&nbsp;5&nbsp;6&nbsp;7&nbsp;8&nbsp;9&nbsp;10&nbsp;11&nbsp;12&nbsp;13&nbsp;14&nbsp;15&nbsp;16&nbsp;17&nbsp;18&nbsp;19&nbsp;20&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;do&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;./runjava.sh&nbsp;com.rabbitmq.examples.PerfTest&nbsp;-k&nbsp;queue$i&nbsp;-x&nbsp;0&nbsp;-a&nbsp;-h&nbsp;amqp://&lt;a&nbsp;href=&quot;http://193.100.200.130:5672&quot;&gt;193.100.200.130:5672&lt;/a&gt;&nbsp;-s&nbsp;1000&nbsp;&amp;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;./runjava.sh&nbsp;com.rabbitmq.examples.PerfTest&nbsp;-k&nbsp;queue$i&nbsp;-y&nbsp;0&nbsp;-h&nbsp;amqp://&lt;a&nbsp;href=&quot;http://193.100.200.130:5672&quot;&gt;193.100.200.130:5672&lt;/a&gt;&nbsp;-s&nbsp;1000&nbsp;&amp;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;done&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt; &lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;<br>
&lt;br&gt;<br>
Matthias.&lt;br&gt;<br>
______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
