<tt>
One&nbsp;thing&nbsp;we&nbsp;found&nbsp;out&nbsp;is&nbsp;that&nbsp;disk-IO&nbsp;is&nbsp;the&nbsp;bottleneck&nbsp;in&nbsp;our&nbsp;setup&nbsp;(most&nbsp;queues&nbsp;are&nbsp;ACK-ed,&nbsp;HA-&nbsp;queues).&nbsp;Our&nbsp;solutions:&lt;br&gt;1)&nbsp;batching&nbsp;of&nbsp;messages&nbsp;improved&nbsp;performance&nbsp;(message&nbsp;size&nbsp;bigger,&nbsp;but&nbsp;less&nbsp;messages)&lt;br&gt;2)&nbsp;Faster&nbsp;disks&nbsp;(10k&nbsp;spinners&nbsp;RAIDed)&nbsp;improved&nbsp;performance&lt;br&gt;<br>
&lt;br&gt;So&nbsp;make&nbsp;sure&nbsp;you&nbsp;also&nbsp;look&nbsp;at&nbsp;that&nbsp;part&nbsp;of&nbsp;the&nbsp;system.&lt;br&gt;&lt;br&gt;Cheers&lt;br&gt;Maze&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Dec&nbsp;20,&nbsp;2012&nbsp;at&nbsp;6:27&nbsp;PM,&nbsp;Chris&nbsp;Schmidt&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:cischmidt77@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;cischmidt77@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hello,&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
On&nbsp;Dec&nbsp;20,&nbsp;2012,&nbsp;at&nbsp;9:07&nbsp;AM,&nbsp;Matthias&nbsp;Radestock&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthias@rabbitmq.com&quot;&gt;matthias@rabbitmq.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;gt;&nbsp;Chris,&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;On&nbsp;20/12/12&nbsp;16:18,&nbsp;Chris&nbsp;Schmidt&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;There&nbsp;are&nbsp;22&nbsp;queues&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;gt;&nbsp;[...]&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;A&nbsp;vendor&nbsp;let&nbsp;us&nbsp;borrow&nbsp;the&nbsp;40-core&nbsp;machine&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;would&nbsp;work&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;better.&nbsp; [...]&nbsp;Each&nbsp;core&nbsp;is&nbsp;only&nbsp;11-15%&nbsp;utilized.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;You&nbsp;may&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;saturate&nbsp;40&nbsp;cores&nbsp;with&nbsp;22&nbsp;queues.&nbsp;Depends&nbsp;on&nbsp;how&nbsp;many&nbsp;producers&nbsp;and&nbsp;consumers&nbsp;there&nbsp;are.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;other&nbsp;constraint&nbsp;could&nbsp;be&nbsp;scheduling&nbsp;and&nbsp;general&nbsp;Erlang&nbsp;multi-core&nbsp;performance.&nbsp;This&nbsp;has&nbsp;improved&nbsp;*considerably*&nbsp;over&nbsp;the&nbsp;last&nbsp;few&nbsp;years.&nbsp;So&nbsp;please&nbsp;make&nbsp;sure&nbsp;you&nbsp;are&nbsp;running&nbsp;the&nbsp;latest&nbsp;Erlang/OTP&nbsp;release&nbsp;-&nbsp;R15B03.&lt;br&gt;<br>
<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;You&nbsp;may&nbsp;also&nbsp;want&nbsp;to&nbsp;tweak&nbsp;the&nbsp;various&nbsp;smp/scheduling&nbsp;related&nbsp;settings&nbsp;in&nbsp;Erlang.&nbsp;In&nbsp;particular&nbsp;I&nbsp;have&nbsp;seen&nbsp;massive&nbsp;performance&nbsp;differences&nbsp;when&nbsp;adjusting&nbsp;the&nbsp;+swt&nbsp;setting.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;RHEL&nbsp;6.2&nbsp;doesn&amp;#39;t&nbsp;seem&nbsp;to&nbsp;have&nbsp;the&nbsp;latest&nbsp;version&nbsp;of&nbsp;Erlang&nbsp;available&nbsp;in&nbsp;the&nbsp;repositories.&nbsp;Does&nbsp;anyone&nbsp;have&nbsp;experience&nbsp;with&nbsp;manually&nbsp;building&nbsp;Erlang&nbsp;on&nbsp;that&nbsp;platform&nbsp;with&nbsp;success?&nbsp;We&amp;#39;re&nbsp;on&nbsp;R14B04&nbsp;right&nbsp;now.&nbsp;There&nbsp;are&nbsp;a&nbsp;huge&nbsp;number&nbsp;of&nbsp;erlang&nbsp;related&nbsp;rpms&nbsp;that&nbsp;get&nbsp;installed&nbsp;I&amp;#39;m&nbsp;not&nbsp;certain&nbsp;if&nbsp;a&nbsp;single&nbsp;Erlang&nbsp;version&nbsp;for&nbsp;CentOS&nbsp;would&nbsp;work&nbsp;properly&nbsp;or&nbsp;not.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
I&nbsp;had&nbsp;+K&nbsp;true&nbsp;-smp&nbsp;enable&nbsp;+native&nbsp;+sbtps&nbsp;plus&nbsp;the&nbsp;other&nbsp;RMQ&nbsp;defaults&nbsp;set&nbsp;on&nbsp;the&nbsp;40&nbsp;core&nbsp;machine&nbsp;while&nbsp;testing.&nbsp;I&nbsp;also&nbsp;removed&nbsp;everything&nbsp;to&nbsp;use&nbsp;plain&nbsp;vanilla&nbsp;RMQ&nbsp;settings&nbsp;to&nbsp;see&nbsp;how&nbsp;that&nbsp;impacted&nbsp;performance.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;also&nbsp;had&nbsp;15&nbsp;consumers&nbsp;running&nbsp;against&nbsp;the&nbsp;initial&nbsp;queue&nbsp;that&nbsp;was&nbsp;having&nbsp;problems.&nbsp;I&nbsp;also&nbsp;tried&nbsp;sending&nbsp;the&nbsp;data&nbsp;into&nbsp;2&nbsp;-&nbsp;40&nbsp;exchanges&nbsp;(and&nbsp;updated&nbsp;the&nbsp;queue&nbsp;to&nbsp;read&nbsp;from&nbsp;those&nbsp;exchanges)&nbsp;in&nbsp;order&nbsp;to&nbsp;see&nbsp;if&nbsp;I&nbsp;could&nbsp;spread&nbsp;the&nbsp;load&nbsp;that&nbsp;way.&nbsp;Does&nbsp;a&nbsp;single&nbsp;process&nbsp;manage&nbsp;each&nbsp;queue?&nbsp;If&nbsp;so&nbsp;I&nbsp;can&nbsp;see&nbsp;that&nbsp;being&nbsp;a&nbsp;potential&nbsp;bottleneck&nbsp;due&nbsp;to&nbsp;the&nbsp;core&amp;#39;s&nbsp;speed&nbsp;difference.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Is&nbsp;there&nbsp;an&nbsp;erlang&nbsp;or&nbsp;rabbitmqctl&nbsp;command&nbsp;that&nbsp;I&nbsp;can&nbsp;run&nbsp;against&nbsp;the&nbsp;RMQ&nbsp;server&nbsp;to&nbsp;determine&nbsp;if&nbsp;the&nbsp;queues&nbsp;themselves&nbsp;are&nbsp;the&nbsp;bottleneck?&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;I&amp;#39;ve&nbsp;tried&nbsp;HiPE&nbsp;in&nbsp;the&nbsp;past,&nbsp;but&nbsp;the&nbsp;system&nbsp;%&nbsp;jumped&nbsp;considerably&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;and&nbsp;we&nbsp;actually&nbsp;got&nbsp;poorer&nbsp;performance&nbsp;and&nbsp;instability.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;That&amp;#39;s&nbsp;odd.&nbsp;Again,&nbsp;please&nbsp;make&nbsp;sure&nbsp;you&nbsp;are&nbsp;runninng&nbsp;the&nbsp;latest&nbsp;Erlang;&nbsp;HiPE&nbsp;is&nbsp;another&nbsp;area&nbsp;that&nbsp;has&nbsp;improved&nbsp;considerably&nbsp;recently.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;I&amp;#39;d&nbsp;definitely&nbsp;like&nbsp;to&nbsp;try&nbsp;HiPE&nbsp;again&nbsp;since&nbsp;we&amp;#39;re&nbsp;CPU&nbsp;bound&nbsp;on&nbsp;the&nbsp;existing&nbsp;production&nbsp;server.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;I&nbsp;know&nbsp;the&nbsp;cores&nbsp;are&nbsp;slower&nbsp;in&nbsp;overall&nbsp;speed,&nbsp;but&nbsp;I&nbsp;would&nbsp;have&nbsp;bet&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;money&nbsp;that&nbsp;in&nbsp; aggregate&nbsp;this&nbsp;machine&nbsp;would&nbsp;outperform&nbsp;our&nbsp;other&nbsp;one.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Depends&nbsp;on&nbsp;the&nbsp;workload.&nbsp;e.g.&nbsp;if&nbsp;queues&nbsp;are&nbsp;the&nbsp;bottleneck&nbsp;then&nbsp;having&nbsp;many&nbsp;more&nbsp;(slow)&nbsp;cores&nbsp;than&nbsp;queues&nbsp;won&amp;#39;t&nbsp;help.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Regards,&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Matthias.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;I&nbsp;appreciate&nbsp;the&nbsp;pointers,&nbsp;thanks&nbsp;Matthias!&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
