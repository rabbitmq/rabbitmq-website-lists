<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;In&nbsp;Spring-AMQP,&nbsp;we&nbsp;don&#39;t&nbsp;asynchronously&nbsp;cancel&nbsp;the&nbsp;consumer,&nbsp;we&nbsp;tell&nbsp;the&nbsp;consumer&nbsp;it&nbsp;needs&nbsp;to&nbsp;cancel&nbsp;itself&nbsp;when&nbsp;it&#39;s&nbsp;finished&nbsp;its&nbsp;current&nbsp;work.&nbsp;IIRC,&nbsp;if&nbsp;the&nbsp;consumer&nbsp;is&nbsp;running&nbsp;when&nbsp;you&nbsp;cancel&nbsp;it,&nbsp;its&nbsp;basicAck&nbsp;will&nbsp;fail&nbsp;because&nbsp;you&#39;ve&nbsp;already&nbsp;cancelled&nbsp;it&nbsp;and&nbsp;the&nbsp;broker&nbsp;has&nbsp;re-queued&nbsp;that&nbsp;message.&nbsp;Effectively&nbsp;we&nbsp;tell&nbsp;the&nbsp;consumer&nbsp;to&nbsp;emit&nbsp;the&nbsp;cancel&nbsp;immediately&nbsp;after&nbsp;the&nbsp;ack.&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;stop&nbsp;a&nbsp;badly&nbsp;behaving&nbsp;Consumer&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;It&nbsp;depends&nbsp;on&nbsp;how&nbsp;badly&nbsp;behaved&nbsp;it&nbsp;is;&nbsp;if&nbsp;it&nbsp;never&nbsp;executes&nbsp;any&nbsp;interruptible&nbsp;code&nbsp;(say&nbsp;it&#39;s&nbsp;stuck&nbsp;in&nbsp;a&nbsp;while()&nbsp;loop),&nbsp;you&nbsp;are&nbsp;out&nbsp;of&nbsp;luck.&nbsp;If&nbsp;it&nbsp;does&nbsp;stuff&nbsp;that&#39;s&nbsp;interruptible&nbsp;(acquire&nbsp;locks,&nbsp;etc,&nbsp;etc)&nbsp;then&nbsp;you&nbsp;can&nbsp;interrupt&nbsp;it.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;I&nbsp;don&#39;t&nbsp;know&nbsp;enough&nbsp;about&nbsp;the&nbsp;rabbit&nbsp;client&nbsp;internals&nbsp;as&nbsp;to&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;mechanism&nbsp;to&nbsp;force&nbsp;it&nbsp;to&nbsp;interrupt&nbsp;the&nbsp;dispatcher&nbsp;thread&nbsp;(I&nbsp;didn&#39;t&nbsp;see&nbsp;anything&nbsp;after&nbsp;a&nbsp;quick&nbsp;look)&nbsp;so&nbsp;you&nbsp;might&nbsp;have&nbsp;to&nbsp;roll&nbsp;your&nbsp;own&nbsp;(capture&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;thread&nbsp;in&nbsp;handleDelivery&nbsp;and&nbsp;interrupt&nbsp;it&nbsp;after&nbsp;your&nbsp;timeout).&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;all&nbsp;else&nbsp;fails,&nbsp;System.exit()&nbsp;is&nbsp;your&nbsp;friend.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Gary&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Apr&nbsp;2,&nbsp;2014&nbsp;at&nbsp;5:52&nbsp;PM,&nbsp;Bertrand&nbsp;Guay-Paquet&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:bernie@step.polymtl.ca&quot;&nbsp;target=&quot;_blank&quot;&gt;bernie@step.polymtl.ca&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Thanks&nbsp;Jason&nbsp;and&nbsp;Gary,&lt;br&gt;<br>
&lt;br&gt;<br>
Your&nbsp;replies&nbsp;really&nbsp;helped&nbsp;and&nbsp;I&nbsp;almost&nbsp;got&nbsp;it&nbsp;now.&nbsp;At&nbsp;first,&nbsp;I&nbsp;didn&#39;t&nbsp;know&nbsp;that&nbsp;handleCancelOk&nbsp;only&nbsp;runs&nbsp;when&nbsp;a&nbsp;consumer&nbsp;is&nbsp;not&nbsp;handling&nbsp;anything&nbsp;else.&nbsp;That&nbsp;is,&nbsp;only&nbsp;a&nbsp;single&nbsp;handle*()&nbsp;method&nbsp;can&nbsp;run&nbsp;at&nbsp;the&nbsp;same&nbsp;time&nbsp;on&nbsp;any&nbsp;given&nbsp;consumer&nbsp;instance.&nbsp;Thinking&nbsp;about&nbsp;it&nbsp;now,&nbsp;I&nbsp;realize&nbsp;this&nbsp;was&nbsp;explained&nbsp;in&nbsp;the&nbsp;doc&nbsp;with&nbsp;the&nbsp;phrase&nbsp;&quot;Each&nbsp;Channel&nbsp;has&nbsp;its&nbsp;own&nbsp;dispatch&nbsp;thread.&quot;&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
So&nbsp;I&nbsp;created&nbsp;my&nbsp;subclass&nbsp;of&nbsp;DefaultConsumer&nbsp;(BasicConsumer)&nbsp;which&nbsp;implements&nbsp;isCancelled()&nbsp;and&nbsp;handleCancelOk()&nbsp;which&nbsp;sets&nbsp;a&nbsp;&quot;cancelled&nbsp;flag&quot;&nbsp;to&nbsp;true.&nbsp;Is&nbsp;there&nbsp;already&nbsp;a&nbsp;built-in&nbsp;way&nbsp;to&nbsp;know&nbsp;if&nbsp;a&nbsp;consumer&nbsp;was&nbsp;cancelled?&nbsp;I&nbsp;couldn&#39;t&nbsp;find&nbsp;it&nbsp;myself...&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Here&nbsp;are&nbsp;my&nbsp;start&nbsp;and&nbsp;stop&nbsp;sequences&nbsp;which&nbsp;almost&nbsp;completely&nbsp;work.&nbsp;I&nbsp;haven&#39;t&nbsp;found&nbsp;how&nbsp;to&nbsp;forcefully&nbsp;stop&nbsp;a&nbsp;badly&nbsp;behaving&nbsp;Consumer&nbsp;after&nbsp;a&nbsp;given&nbsp;timeout&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stop&nbsp;sequence.&nbsp;How&nbsp;can&nbsp;this&nbsp;be&nbsp;achieved?&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Start&nbsp;sequence:&lt;br&gt;<br>
consumers&nbsp;=&nbsp;new&nbsp;ArrayList&lt;BasicConsumer&gt;();&lt;br&gt;<br>
consumers.add(...)&lt;br&gt;<br>
&lt;br&gt;<br>
Stop&nbsp;sequence:&lt;br&gt;<br>
//&nbsp;Cancel&nbsp;all&nbsp;consumers&lt;br&gt;<br>
for&nbsp;(BasicConsumer&nbsp;consumer&nbsp;:&nbsp;consumers)&nbsp;{&lt;br&gt;<br>
 &nbsp;try&nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp;consumer.getChannel().&lt;u&gt;&lt;/u&gt;basicCancel(consumer.&lt;u&gt;&lt;/u&gt;getConsumerTag());&lt;br&gt;<br>
 &nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp;//&nbsp;report&lt;br&gt;<br>
 &nbsp;}&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
//&nbsp;Wait&nbsp;for&nbsp;all&nbsp;consumers&nbsp;to&nbsp;be&nbsp;cancelled&lt;br&gt;<br>
Timeout&nbsp;timeout&nbsp;=&nbsp;...;&lt;br&gt;<br>
while&nbsp;(!consumers.isEmpty()&nbsp;&amp;&amp;&nbsp;!timeout.isElapsed())&nbsp;{&lt;br&gt;<br>
 &nbsp;//&nbsp;Remove&nbsp;cancelled&nbsp;consumers&lt;br&gt;<br>
 &nbsp;for&nbsp;(Iterator&lt;BasicConsumer&gt;&nbsp;iterator&nbsp;=&nbsp;consumers.iterator();&nbsp;iterator.hasNext();)&nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp;if&nbsp;(iterator.next().isCancelled()&lt;u&gt;&lt;/u&gt;)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp;iterator.remove();&lt;br&gt;<br>
 &nbsp;}&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
//&nbsp;Force&nbsp;close&nbsp;remaining&nbsp;(timed-out)&nbsp;consumers&lt;br&gt;<br>
for&nbsp;(BasicConsumer&nbsp;consumer&nbsp;:&nbsp;consumers)&nbsp;{&lt;br&gt;<br>
 &nbsp;consumer.getChannel().abort();&nbsp;//&nbsp;&lt;----&nbsp;doesn&#39;k&nbsp;kill&nbsp;the&nbsp;consumer&lt;br&gt;<br>
 &nbsp;//&nbsp;&lt;----------------&nbsp;How&nbsp;do&nbsp;I&nbsp;kill&nbsp;a&nbsp;timed-out&nbsp;consumer?&lt;br&gt;<br>
}&lt;br&gt;<br>
connection.close();&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;<br>
Bertrand&lt;br&gt;<br>
______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
