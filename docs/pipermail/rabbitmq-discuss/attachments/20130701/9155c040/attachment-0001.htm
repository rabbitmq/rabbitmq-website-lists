<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;You&nbsp;need&nbsp;to&nbsp;call&nbsp;amqp_maybe_releae_buffers()&nbsp;after&nbsp;amqp_tx_commit().&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;rule&nbsp;of&nbsp;thumb&nbsp;for&nbsp;rabbitmq-c&nbsp;is&nbsp;if&nbsp;the&nbsp;library&nbsp;returns&nbsp;something&nbsp;to&nbsp;you,&nbsp;you&nbsp;should&nbsp;release&nbsp;it&nbsp;when&nbsp;you&amp;#39;re&nbsp;done&nbsp;with&nbsp;it&nbsp;by&nbsp;calling&nbsp;that&nbsp;function.&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Jul&nbsp;1,&nbsp;2013&nbsp;at&nbsp;6:08&nbsp;AM,&nbsp;Haster&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:haster2004@yandex.ru&quot;&nbsp;target=&quot;_blank&quot;&gt;haster2004@yandex.ru&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hi&nbsp;there!&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;try&nbsp;to&nbsp;use&nbsp;transactions&nbsp;in&nbsp;my&nbsp;producer.&nbsp;And&nbsp;I&nbsp;found&nbsp;that&nbsp;when&nbsp;I&nbsp;send&nbsp;many&lt;br&gt;<br>
messages&nbsp;-&nbsp;my&nbsp;app&nbsp;eat&nbsp;a&nbsp;lot&nbsp;of&nbsp;memory.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;I&nbsp;dismiss&nbsp;transaction&nbsp;feature&nbsp;-&nbsp;memory&nbsp;consumption&nbsp;is&nbsp;normal&lt;br&gt;<br>
&lt;br&gt;<br>
Maybe&nbsp;there&nbsp;is&nbsp;memory&nbsp;leak&nbsp;in&nbsp;amqp_tx_commit?&nbsp;Or&nbsp;maybe&nbsp;I&nbsp;have&nbsp;to&nbsp;call&nbsp;some&lt;br&gt;<br>
function&nbsp;to&nbsp;clean&nbsp;something?&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;test&nbsp;case&nbsp;is&nbsp;below:&lt;br&gt;<br>
const&nbsp;char&nbsp;*&nbsp;const&nbsp;host&nbsp;=&nbsp;&amp;quot;localhost&amp;quot;;&lt;br&gt;<br>
int&nbsp;port&nbsp;=&nbsp;5672;&lt;br&gt;<br>
const&nbsp;char&nbsp;*&nbsp;const&nbsp;user&nbsp;=&nbsp;&amp;quot;admin&amp;quot;;&lt;br&gt;<br>
const&nbsp;char&nbsp;*&nbsp;const&nbsp;pass&nbsp;=&nbsp;&amp;quot;password&amp;quot;;&lt;br&gt;<br>
amqp_channel_t&nbsp;channel_exchange&nbsp;=&nbsp;4;&lt;br&gt;<br>
amqp_channel_t&nbsp;channel_queue&nbsp;=&nbsp;5;&lt;br&gt;<br>
const&nbsp;char&nbsp;*exchange&nbsp;=&nbsp;&amp;quot;haster_ex&amp;quot;;&lt;br&gt;<br>
&lt;br&gt;<br>
void&nbsp;main&nbsp;()&nbsp;{&lt;br&gt;<br>
 &nbsp;amqp_connection_state_t&nbsp;conn&nbsp;=&nbsp;amqp_new_connection();&lt;br&gt;<br>
 &nbsp;if&nbsp;(!conn)&nbsp;{&nbsp;cout&nbsp;&amp;lt;&amp;lt;&nbsp;&amp;quot;Connection&nbsp;error\n&amp;quot;;&nbsp;return;&lt;br&gt;<br>
 &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;int&nbsp;sockfd&nbsp;=&nbsp;amqp_open_socket(host,&nbsp;port);&nbsp; //5672&lt;br&gt;<br>
 &nbsp;if&nbsp;(sockfd&nbsp;&amp;lt;&nbsp;0)&nbsp;{&nbsp;cout&nbsp;&amp;lt;&amp;lt;&nbsp;&amp;quot;Opening&nbsp;socket&nbsp;error\n&amp;quot;;&nbsp;return;&nbsp; }&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;amqp_set_sockfd(conn,&nbsp;sockfd);&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;amqp_rpc_reply_t&nbsp;reply&nbsp;=&nbsp;amqp_login(conn,&nbsp;&amp;quot;/&amp;quot;,&nbsp;0,&nbsp;131072,&nbsp;0,&lt;br&gt;<br>
AMQP_SASL_METHOD_PLAIN,&nbsp;user,&nbsp;pass);&lt;br&gt;<br>
 &nbsp;if&nbsp;(reply.reply_type&nbsp;!=&nbsp;AMQP_RESPONSE_NORMAL)&lt;br&gt;<br>
{amqp_destroy_connection(conn);&nbsp;cout&nbsp;&amp;lt;&amp;lt;&nbsp;&amp;quot;Login&nbsp;error\n&amp;quot;;&nbsp;return;}&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;amqp_channel_open(conn,&nbsp;channel_exchange);&lt;br&gt;<br>
 &nbsp;amqp_rpc_reply_t&nbsp;res&nbsp;=&nbsp;amqp_get_rpc_reply(conn);&lt;br&gt;<br>
 &nbsp;if&nbsp;(res.reply_type&nbsp;!=&nbsp;AMQP_RESPONSE_NORMAL)&nbsp;{cout&nbsp;&amp;lt;&amp;lt;&nbsp;&amp;quot;Channel&nbsp;open&lt;br&gt;<br>
error\n&amp;quot;;&nbsp;amqp_connection_close(conn,&nbsp;AMQP_REPLY_SUCCESS);&lt;br&gt;<br>
amqp_destroy_connection(conn);return;}&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp; amqp_tx_select(conn,&nbsp;channel_exchange);&nbsp; &nbsp;//&nbsp;If&nbsp;comment&nbsp;this&nbsp;-&nbsp;all&nbsp;is&nbsp;OK*&lt;br&gt;<br>
 &nbsp;res&nbsp;=&nbsp;amqp_get_rpc_reply(conn);&lt;br&gt;<br>
 &nbsp;if&nbsp;(res.reply_type&nbsp;!=&nbsp;AMQP_RESPONSE_NORMAL)&nbsp;{cout&nbsp;&amp;lt;&amp;lt;&nbsp;&amp;quot;Select&nbsp;error\n&amp;quot;;&lt;br&gt;<br>
amqp_connection_close(conn,&nbsp;AMQP_REPLY_SUCCESS);&lt;br&gt;<br>
amqp_destroy_connection(conn);return;}&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;amqp_bytes_t&nbsp;message_bytes,&nbsp;routingKey_bytes,&nbsp;exchange_bytes;&lt;br&gt;<br>
 &nbsp;exchange_bytes.bytes&nbsp;=&nbsp;(void*)exchange;&lt;br&gt;<br>
 &nbsp;exchange_bytes.len&nbsp;=&nbsp;strlen(exchange);&lt;br&gt;<br>
 &nbsp;message_bytes.bytes&nbsp;=&nbsp;(void*)&amp;quot;Privrr&amp;quot;;&lt;br&gt;<br>
 &nbsp;message_bytes.len&nbsp;=&nbsp;6;&lt;br&gt;<br>
 &nbsp;routingKey_bytes.bytes&nbsp;=&nbsp;(void*)&amp;quot;key&amp;quot;;&lt;br&gt;<br>
 &nbsp;routingKey_bytes.len&nbsp;=&nbsp;3;&lt;br&gt;<br>
 &nbsp;amqp_basic_properties_t&nbsp;props;&lt;br&gt;<br>
 &nbsp;props._flags&nbsp;|=&nbsp;AMQP_BASIC_DELIVERY_MODE_FLAG;&lt;br&gt;<br>
 &nbsp;props.delivery_mode&nbsp;=&nbsp;2;&lt;br&gt;<br>
 &nbsp;props._flags&nbsp;=&nbsp;AMQP_BASIC_CONTENT_TYPE_FLAG;&lt;br&gt;<br>
 &nbsp;props.content_type&nbsp;=&nbsp;amqp_cstring_bytes(&amp;quot;text/plain&amp;quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;amqp_bytes_t&nbsp;expiration;&lt;br&gt;<br>
 &nbsp;expiration.bytes&nbsp;=&nbsp;(void*)&amp;quot;1000&amp;quot;;&lt;br&gt;<br>
 &nbsp;expiration.len&nbsp;=&nbsp;4;&lt;br&gt;<br>
 &nbsp;props.expiration&nbsp;=&nbsp;expiration;&lt;br&gt;<br>
 &nbsp;props._flags&nbsp;|=&nbsp;AMQP_BASIC_EXPIRATION_FLAG;&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;while&nbsp;(1)&nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp;int&nbsp;r&nbsp;=&nbsp;amqp_basic_publish(conn,&nbsp;channel_exchange,&nbsp;exchange_bytes,&lt;br&gt;<br>
routingKey_bytes,&nbsp; 1,&nbsp;0,&nbsp;&amp;amp;props,&nbsp;message_bytes);&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp; &nbsp; amqp_tx_commit(conn,&nbsp;channel_exchange);&nbsp; //&nbsp;if&nbsp;comment&nbsp;it&nbsp;-&nbsp;all&nbsp;is&nbsp;OK&lt;br&gt;<br>
 &nbsp; &nbsp;amqp_get_rpc_reply(conn);*&lt;br&gt;<br>
 &nbsp; &nbsp;//die_on_amqp_error(amqp_get_rpc_reply(conn),&nbsp;&amp;quot;Commit&nbsp;error&amp;quot;);&lt;br&gt;<br>
 &nbsp;}&lt;br&gt;<br>
 &nbsp;char&nbsp;ch;&lt;br&gt;<br>
 &nbsp;cin&nbsp;&amp;gt;&amp;gt;&nbsp;ch;&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
--&lt;br&gt;<br>
View&nbsp;this&nbsp;message&nbsp;in&nbsp;context:&nbsp;&lt;a&nbsp;href=&quot;http://rabbitmq.1065348.n5.nabble.com/rabbitmq-c-amqp-tx-commit-leak-memory-tp27717.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://rabbitmq.1065348.n5.nabble.com/rabbitmq-c-amqp-tx-commit-leak-memory-tp27717.html&lt;/a&gt;&lt;br&gt;<br>
<br>
Sent&nbsp;from&nbsp;the&nbsp;RabbitMQ&nbsp;mailing&nbsp;list&nbsp;archive&nbsp;at&nbsp;Nabble.com.&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
