<tt>
Hi&nbsp;Alvaro,&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Mar&nbsp;18,&nbsp;2010&nbsp;at&nbsp;10:12&nbsp;AM,&nbsp;Alvaro&nbsp;Videla&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:videlalvaro@gmail.com&quot;&gt;videlalvaro@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
While&nbsp;I&nbsp;don&amp;#39;t&nbsp;know&nbsp;how&nbsp;HIGH&nbsp;is&nbsp;your&nbsp;high,&nbsp;I&nbsp;can&nbsp;tell&nbsp;you&nbsp;what&nbsp;we&nbsp;do&nbsp;for&nbsp;our&nbsp;live&nbsp;site&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Our&nbsp;high&nbsp;need&nbsp;to&nbsp;be&nbsp;the&nbsp;HIGHEST,&nbsp;we&nbsp;produce&nbsp;inbound&nbsp;about&nbsp;~3000&nbsp;messages&nbsp;per&nbsp;second&nbsp;and&nbsp;~9000&nbsp;messages&nbsp;per&nbsp;second&nbsp;of&nbsp;outbounds&nbsp;and&nbsp;can&amp;#39;t&nbsp;loose&nbsp;any&nbsp;messages,&nbsp;well&nbsp;we&nbsp;are&nbsp;working&nbsp;hard&nbsp;to&nbsp;it,&nbsp;our&nbsp;concerns&nbsp;is&nbsp;about&nbsp;RabbitMQ&nbsp;cluster&nbsp;HP&nbsp;model,&nbsp;so&nbsp;for&nbsp;hight&nbsp;throughput&nbsp;it&nbsp;works&nbsp;very&nbsp;very&nbsp;well.&nbsp;I&nbsp;will&nbsp;report&nbsp;about&nbsp;our&nbsp;volume&nbsp;in&nbsp;other&nbsp;e-mail&nbsp;and&nbsp;we&nbsp;are&nbsp;very&nbsp;happy&nbsp;with&nbsp;the&nbsp;power&nbsp;of&nbsp;RabbitMQ&nbsp;it&amp;#39;s&nbsp;putting&nbsp;our&nbsp;server&nbsp;to&nbsp;cry&nbsp;to&nbsp;process&nbsp;in&nbsp;one&nbsp;test&nbsp;1.000.000&nbsp;messages&nbsp;per&nbsp;second&nbsp;and&nbsp;do&nbsp;it&nbsp;very&nbsp;well.&nbsp;Sure&nbsp;we&nbsp;have&nbsp;some&nbsp;problems&nbsp;that&nbsp;I&nbsp;had&nbsp;reported&nbsp;here&nbsp;one&nbsp;with&nbsp;memory&nbsp;consume,&nbsp;until&nbsp;now&nbsp;we&nbsp;unable&nbsp;to&nbsp;use&nbsp;rabbit&nbsp;with&nbsp;more&nbsp;that&nbsp;3GB,&nbsp;other&nbsp;with&nbsp;queue&nbsp;monitoring&nbsp;and&nbsp;etc..&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
Currently&nbsp;we&nbsp;have&nbsp;around&nbsp;400.000&nbsp;messages&nbsp;a&nbsp;day&nbsp; –which&nbsp;is&nbsp;not&nbsp;much–,&nbsp;sent&nbsp;to&nbsp;2&nbsp;RabbitMQ&nbsp;servers&nbsp;running&nbsp;in&nbsp;low&nbsp;end&nbsp;machines.&nbsp;The&nbsp;unixload&nbsp;on&nbsp;those&nbsp;machines&nbsp;is&nbsp;always&nbsp;below&nbsp;0.2&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;here&amp;#39;s&nbsp;my&nbsp;story&nbsp;of&nbsp;HA&nbsp;based&nbsp;on&nbsp;that&nbsp;setup:&lt;br&gt;<br>
&lt;br&gt;<br>
When&nbsp;we&nbsp;deployed&nbsp;the&nbsp;system&nbsp;we&nbsp;started&nbsp;the&nbsp;two&nbsp;servers,&nbsp;NOT&nbsp;using&nbsp;clustering.&nbsp;Their&nbsp;version&nbsp;was&nbsp;1.5.2.&nbsp;This&nbsp;was&nbsp;mid&nbsp;2009.&lt;br&gt;<br>
&lt;br&gt;<br>
Then&nbsp;we&nbsp;have&nbsp;28&nbsp;PHP&nbsp;machines&nbsp;publishing&nbsp;the&nbsp;messages&nbsp;to&nbsp;a&nbsp;SINGLE&nbsp;IP,&nbsp;using&nbsp;IP&nbsp;Failover&nbsp;(Heartbeat+LVS),&nbsp;this&nbsp;means&nbsp;that&nbsp;for&nbsp;the&nbsp;PHP&nbsp;publishers&nbsp;there&amp;#39;s&nbsp;only&nbsp;one&nbsp;IP&nbsp;to&nbsp;connect-to/send-messages. &lt;/blockquote&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
&lt;br&gt;<br>
Then&nbsp;we&nbsp;have&nbsp;2&nbsp;PHP&nbsp;machines&nbsp;consuming&nbsp;messages,&nbsp;but&nbsp;they&nbsp;connect&nbsp;directly&nbsp;to&nbsp;the&nbsp;IPs&nbsp;of&nbsp;the&nbsp;RabbitMQ&nbsp;servers,&nbsp;we&nbsp;do&nbsp;that&nbsp;to&nbsp;be&nbsp;sure&nbsp;that&nbsp;we&nbsp;connect&nbsp;directly&nbsp;to&nbsp;a&nbsp;specific&nbsp;broker.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;also&nbsp;means&nbsp;that&nbsp;the&nbsp;queues,&nbsp;exchanges,&nbsp;bindings,&nbsp;etc,&nbsp;are&nbsp;all&nbsp;duplicated&nbsp;between&nbsp;the&nbsp;two&nbsp;servers.&lt;br&gt;<br>
&lt;br&gt;<br>
But&nbsp;there&nbsp;was&nbsp;a&nbsp;problem!&nbsp;We&nbsp;wanted&nbsp;to&nbsp;upgrade&nbsp;to&nbsp;the&nbsp;latest&nbsp;version&nbsp;of&nbsp;RabbitMQ&nbsp;which&nbsp;has&nbsp;a&nbsp;non&nbsp;compatible&nbsp;storage&nbsp;format,&nbsp;at&nbsp;least&nbsp;with&nbsp;our&nbsp;version&nbsp;of&nbsp;RabbitMQ.&lt;br&gt;<br>
&lt;br&gt;<br>
What&nbsp;we&nbsp;did&nbsp;was&nbsp;the&nbsp;following:&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;sysadmin&nbsp;took&nbsp;out&nbsp;of&nbsp;the&nbsp;load&nbsp;balancing&nbsp;one&nbsp;of&nbsp;the&nbsp;brokers,&nbsp;and&nbsp;we&nbsp;waited&nbsp;till&nbsp;the&nbsp;workers&nbsp;consumed&nbsp;all&nbsp;the&nbsp;messages.&nbsp;When&nbsp;their&nbsp;queues&nbsp;were&nbsp;empty,&nbsp;we&nbsp;shut&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;did&nbsp;the&nbsp;upgrade.&nbsp;Then&nbsp;we&nbsp;put&nbsp;it&nbsp;back&nbsp;into&nbsp;the&nbsp;load&nbsp;balancer&nbsp;and&nbsp;repeated&nbsp;the&nbsp;process&nbsp;with&nbsp;the&nbsp;other&nbsp;broker.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
In&nbsp;this&nbsp;way&nbsp;we&nbsp;didn&amp;#39;t&nbsp;lose&nbsp;any&nbsp;message.&lt;br&gt;<br>
&lt;br&gt;<br>
But&nbsp;we&nbsp;wanted&nbsp;to&nbsp;test&nbsp;the&nbsp;native&nbsp;RabbitMQ&nbsp;clustering...&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;sysadmin&nbsp;ran&nbsp;the&nbsp;commands&nbsp;from&nbsp;the&nbsp;Clustering&nbsp;Guide&nbsp;and&nbsp;we&nbsp;had&nbsp;the&nbsp;cluster&nbsp;up&nbsp;an&nbsp;running,&nbsp;until&nbsp;we&nbsp;had&nbsp;another&nbsp;problem...&lt;br&gt;<br>
&lt;br&gt;<br>
Sometimes&nbsp;the&nbsp;RabbitMQ&nbsp;sent&nbsp;the&nbsp;redirect&nbsp;response&nbsp;to&nbsp;the&nbsp;consumers,&nbsp;and&nbsp;told&nbsp;them,&nbsp;to&nbsp;connect&nbsp;to&nbsp;the&nbsp;other&nbsp;node,&nbsp;the&nbsp;problem&nbsp;we&nbsp;had&nbsp;here,&nbsp;is&nbsp;that&nbsp;RabbitMQ&nbsp;uses&nbsp;the&nbsp;node()&nbsp;function&nbsp;from&nbsp;Erlang,&nbsp;which&nbsp;for&nbsp;the&nbsp;way&nbsp;we&nbsp;have&nbsp;configured&nbsp;the&nbsp;/etc/hosts&nbsp;file,&nbsp;it&nbsp;was&nbsp;returning&nbsp;a&nbsp;node&nbsp;that&nbsp;was&nbsp;unreachable&nbsp;from&nbsp;outside&nbsp;(This&nbsp;was&nbsp;only&nbsp;happening&nbsp;to&nbsp;the&nbsp;consumers,&nbsp;because&nbsp;they&nbsp;connect&nbsp;directly&nbsp;to&nbsp;the&nbsp;RabbitMQ&nbsp;nodes).&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
So&nbsp;here&nbsp;we&nbsp;did&nbsp;the&nbsp;same&nbsp;as&nbsp;before,&nbsp;we&nbsp;took&nbsp;one&nbsp;broker&nbsp;out&nbsp;of&nbsp;the&nbsp;load&nbsp;balancing,&nbsp;we&nbsp;took&nbsp;it&nbsp;out&nbsp;of&nbsp;the&nbsp;clustering,&nbsp;and&nbsp;put&nbsp;it&nbsp;back&nbsp;again,&nbsp;and&nbsp;the&nbsp;same&nbsp;thing&nbsp;with&nbsp;the&nbsp;other&nbsp;node.&lt;br&gt;<br>
&lt;br&gt;<br>
Again&nbsp;we&nbsp;didn&amp;#39;t&nbsp;lose&nbsp;any&nbsp;message.&lt;br&gt;<br>
&lt;br&gt;<br>
Then&nbsp;on&nbsp;the&nbsp;connection&nbsp;configuration,&nbsp;we&nbsp;have&nbsp;a&nbsp;really&nbsp;simple&nbsp;.yml&nbsp;file&nbsp;to&nbsp;tell&nbsp;the&nbsp;PHP&nbsp;process&nbsp;where&nbsp;to&nbsp;connect,&nbsp;basically&nbsp;by&nbsp;providing&nbsp;an&nbsp;argument&nbsp;on&nbsp;the&nbsp;CLI.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;hope&nbsp;this&nbsp;helps,&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;border-collapse:&nbsp;collapse;&nbsp;&quot;&gt;&lt;div&gt;I&nbsp;will&nbsp;take&nbsp;a&nbsp;look&nbsp;about&nbsp;LVM&nbsp;now..&nbsp;so&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;do&nbsp;some&nbsp;questions&nbsp;that&nbsp;I&amp;#39;m&nbsp;in&nbsp;doubt&nbsp;about&nbsp;your&nbsp;solution.&nbsp;Do&nbsp;you&nbsp;know&nbsp;what&nbsp;is&nbsp;the&nbsp;overhead&nbsp;using&nbsp;LVM&nbsp;?&nbsp;How&nbsp;many&nbsp;messages&nbsp;per&nbsp;second&nbsp;do&nbsp;you&nbsp;have&nbsp;?&nbsp;Do&nbsp;you&nbsp;use&nbsp;a&nbsp;persistent&nbsp;queue&nbsp;?&nbsp;If&nbsp;yes&nbsp;how&nbsp;did&nbsp;you&nbsp;to&nbsp;continue&nbsp;consume&nbsp;queue&nbsp;when&nbsp;one&nbsp;node&nbsp;is&nbsp;down&nbsp;?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;You&nbsp;are&nbsp;using&nbsp;a&nbsp;heartbeat,&nbsp;so&nbsp;how&nbsp;you&nbsp;share&nbsp;inter&nbsp;nodes&nbsp;the&nbsp;same&nbsp;disk&nbsp;?&nbsp;NFS&nbsp;?&nbsp;Storage&nbsp;?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;so&nbsp;much&nbsp;for&nbsp;your&nbsp;report&nbsp;it&nbsp;helps&nbsp;a&nbsp;lot.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Best&nbsp;wishes. &lt;/div&gt;<br>
&lt;/span&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
&lt;br&gt;<br>
Alvaro&lt;br&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;Mar&nbsp;18,&nbsp;2010,&nbsp;at&nbsp;7:57&nbsp;PM,&nbsp;Gustavo&nbsp;Aquino&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;gt;&nbsp;Hi,&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;I&nbsp;have&nbsp;done&nbsp;this&nbsp;question&nbsp;before&nbsp;for&nbsp;many&nbsp;peoples,&nbsp;without&nbsp;success,&nbsp;because&nbsp;I&nbsp;don&amp;#39;t&nbsp;found&nbsp;(Documentation,&nbsp;discussion&nbsp;lists&nbsp;and&nbsp;etc)&nbsp;any&nbsp;way&nbsp;to&nbsp;do&nbsp;High&nbsp;Availability&nbsp;with&nbsp;RabbitMQ&nbsp;without&nbsp;a&nbsp;lot&nbsp;of&nbsp;workaround,&nbsp;so&nbsp;exist&nbsp;a&nbsp;way&nbsp;to&nbsp;do&nbsp;HA&nbsp;with&nbsp;RabbitMQ&nbsp;without&nbsp;implementing&nbsp;a&nbsp;lot&nbsp;of&nbsp;stuffs&nbsp;by&nbsp;client&nbsp;side,&nbsp;like&nbsp;recreating&nbsp;queues&nbsp;when&nbsp;node&nbsp;down,&nbsp;recreating&nbsp;configurations,&nbsp;recreating&nbsp;client&nbsp;connections&nbsp;and&nbsp;etc&nbsp;?&lt;br&gt;<br>
<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;What&amp;#39;s&nbsp;recommendation&nbsp;from&nbsp;RabbitMQ&nbsp;to&nbsp;do&nbsp;HA&nbsp;?&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Someone&nbsp;here&nbsp;have&nbsp;done&nbsp;some&nbsp;HA&nbsp;implementation&nbsp;to&nbsp;RabbitMQ&nbsp;?&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Regards.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Gustavo&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&amp;gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&amp;gt;&nbsp;rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
