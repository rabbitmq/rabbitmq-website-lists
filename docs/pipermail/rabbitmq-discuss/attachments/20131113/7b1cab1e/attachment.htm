<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;ve&nbsp;been&nbsp;trying&nbsp;to&nbsp;setup&nbsp;something&nbsp;like&nbsp;this,&nbsp;more&nbsp;like&nbsp;an&nbsp;experiment/research&nbsp;to&nbsp;see&nbsp;how&nbsp;far&nbsp;federation&nbsp;could&nbsp;be&nbsp;taken&nbsp;across&nbsp;AWS&nbsp;availability&nbsp;zones,&nbsp;but&nbsp;I&nbsp;have&nbsp;to&nbsp;admit&nbsp;that&nbsp;I&amp;#39;ve&nbsp;been&nbsp;sidetracked&nbsp;by&nbsp;various&nbsp;projects&nbsp;and&nbsp;conferences.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;When&nbsp;I&nbsp;was&nbsp;living&nbsp;in&nbsp;China&nbsp;I&nbsp;remember&nbsp;that&nbsp;a&nbsp;company&nbsp;there&nbsp;used&nbsp;to&nbsp;have&nbsp;a&nbsp;similar&nbsp;problem&nbsp;as&nbsp;you,&nbsp;when&nbsp;sending&nbsp;data&nbsp;to&nbsp;the&nbsp;US.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Considering&nbsp;that&nbsp;you&nbsp;have&nbsp;upstreams&nbsp;at&nbsp;various&nbsp;locations&nbsp;in&nbsp;the&nbsp;world,&nbsp;could&nbsp;it&nbsp;be&nbsp;the&nbsp;case&nbsp;that&nbsp;you&nbsp;have&nbsp;better&nbsp;TCP&nbsp;bandwidth&nbsp;from&nbsp;China&nbsp;to&nbsp;another&nbsp;non&nbsp;US&nbsp;location,&nbsp;say&nbsp;HK,&nbsp;Japan,&nbsp;Singapore,&nbsp;or&nbsp;Korea?&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;If&nbsp;that&amp;#39;s&nbsp;the&nbsp;case&nbsp;you&nbsp;could&nbsp;perhaps&nbsp;try&nbsp;to&nbsp;form&nbsp;a&nbsp;different&nbsp;federation&nbsp;graph&nbsp;that&nbsp;would&nbsp;allow&nbsp;you&nbsp;to&nbsp;achieve&nbsp;some&nbsp;max&nbsp;flow&nbsp;routing.&nbsp;Say&nbsp;publishing&nbsp;from&nbsp;China&nbsp;to&nbsp;a&nbsp;country&nbsp;that&nbsp;has&nbsp;better&nbsp;bandwidth&nbsp;than&nbsp;from&nbsp;China&nbsp;to&nbsp;the&nbsp;US,&nbsp;and&nbsp;then&nbsp;from&nbsp;that&nbsp;country&nbsp;to&nbsp;the&nbsp;US,&nbsp;or&nbsp;to&nbsp;a&nbsp;third&nbsp;country&nbsp;and&nbsp;so&nbsp;on.&nbsp;I&nbsp;know&nbsp;this&nbsp;might&nbsp;sound&nbsp;nice&nbsp;theoretically&nbsp;but&nbsp;I&nbsp;haven&amp;#39;t&nbsp;tried&nbsp;it.&nbsp;I&nbsp;throw&nbsp;this&nbsp;out&nbsp;nonetheless,&nbsp;in&nbsp;case&nbsp;it&nbsp;might&nbsp;lead&nbsp;you&nbsp;to&nbsp;a&nbsp;solution.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Regards,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Alvaro&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Nov&nbsp;7,&nbsp;2013&nbsp;at&nbsp;6:47&nbsp;PM,&nbsp;Dustin&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:dustink.ml@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;dustink.ml@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello&nbsp;All!&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;wanted&nbsp;to&nbsp;shoot&nbsp;this&nbsp;out&nbsp;to&nbsp;see&nbsp;if&nbsp;anyone&nbsp;has&nbsp;had&nbsp;any&nbsp;experience&nbsp;with&nbsp;using&nbsp;RabbitMQ&nbsp;for&nbsp;a&nbsp;mass&nbsp;global&nbsp;data&nbsp;ingestion&nbsp;pipeline.&nbsp; A&nbsp;small&nbsp;disclaimer,&nbsp;I&amp;#39;m&nbsp;a&nbsp;total&nbsp;RMQ&nbsp;noob&nbsp;:)&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;currently&nbsp;have&nbsp;a&nbsp;fan-in&nbsp;design,&nbsp;where&nbsp;we&nbsp;have&nbsp;a&nbsp;single&nbsp;downstream&nbsp;2&nbsp;node&nbsp;HA&nbsp;cluster&nbsp;in&nbsp;the&nbsp;same&nbsp;data&nbsp;center&nbsp;as&nbsp;our&nbsp;data&nbsp;warehouse.&nbsp; We&nbsp;have&nbsp;around&nbsp;22&nbsp;upstreams&nbsp;(also&nbsp;2&nbsp;node&nbsp;HA&nbsp;clusters)&nbsp;located&nbsp;in&nbsp;datacenters&nbsp;all&nbsp;over&nbsp;the&nbsp;world.&nbsp; The&nbsp;configuration&nbsp;is&nbsp;extremely&nbsp;simple.&nbsp; We&nbsp;have&nbsp;a&nbsp;single&nbsp;direct&nbsp;exchange,&nbsp;which&nbsp;everything&nbsp;publishes&nbsp;to.&nbsp;Each&nbsp;application&nbsp;uses&nbsp;a&nbsp;specified&nbsp;routing&nbsp;key&nbsp;for&nbsp;that&nbsp;application.&nbsp; We&nbsp;end&nbsp;up&nbsp;with&nbsp;queue&nbsp;per&nbsp;application&nbsp;(currently&nbsp;around&nbsp;10).&nbsp; We&nbsp;are&nbsp;running&nbsp;3.0.0&nbsp;on&nbsp;the&nbsp;downstream&nbsp;cluster&nbsp;(been&nbsp;waiting&nbsp;for&nbsp;a&nbsp;maintenance&nbsp;window&nbsp;to&nbsp;upgrade)&nbsp;and&nbsp;3.1.5&nbsp;on&nbsp;the&nbsp;upstreams.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;design&nbsp;has&nbsp;held&nbsp;up&nbsp;well,&nbsp;and&nbsp;we&nbsp;are&nbsp;averaging&nbsp;around&nbsp;20k/sec&nbsp;messages&nbsp;a&nbsp;day.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;ran&nbsp;into&nbsp;2&nbsp;problems&nbsp;which&nbsp;won&amp;#39;t&nbsp;allow&nbsp;us&nbsp;to&nbsp;scale&nbsp;any&nbsp;further.&nbsp; The&nbsp;first&nbsp;is&nbsp;the&nbsp;max&nbsp;bandwidth&nbsp;for&nbsp;a&nbsp;single&nbsp;TCP&nbsp;connection&nbsp;across&nbsp;the&nbsp;globe&nbsp;(specifically&nbsp;between&nbsp;the&nbsp;US&nbsp;and&nbsp;China).&nbsp; The&nbsp;second&nbsp;is&nbsp;we&nbsp;have&nbsp;maxed&nbsp;out&nbsp;the&nbsp;CPU&nbsp;for&nbsp;the&nbsp;federation&nbsp;clients&nbsp;on&nbsp;the&nbsp;downstream&nbsp;(SSL&nbsp;is&nbsp;enabled,&nbsp;I&amp;#39;m&nbsp;not&nbsp;sure&nbsp;how&nbsp;much&nbsp;CPU&nbsp;overhead&nbsp;that&nbsp;adds).&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;For&nbsp;the&nbsp;CPU&nbsp;issue,&nbsp;I&nbsp;figured&nbsp;the&nbsp;newly&nbsp;added&nbsp;federated&nbsp;queues&nbsp;would&nbsp;be&nbsp;a&nbsp;perfect&nbsp;solution&nbsp;to&nbsp;the&nbsp;problem.&nbsp; I&nbsp;can&nbsp;setup&nbsp;additional&nbsp;Rabbits&nbsp;on&nbsp;the&nbsp;downstream&nbsp;side,&nbsp;setup&nbsp;the&nbsp;federation&nbsp;links,&nbsp;and&nbsp;have&nbsp;everything&nbsp;load&nbsp;balance&nbsp;nicely.&nbsp; The&nbsp;only&nbsp;thing&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;address&nbsp;is&nbsp;the&nbsp;max&nbsp;bandwidth&nbsp;for&nbsp;a&nbsp;single&nbsp;TCP&nbsp;connection.&nbsp; Because&nbsp;of&nbsp;our&nbsp;initial&nbsp;design,&nbsp;we&nbsp;would&nbsp;run&nbsp;into&nbsp;max&nbsp;bandwidth&nbsp;problems&nbsp;for&nbsp;each&nbsp;queue.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Our&nbsp;current&nbsp;objective&nbsp;is&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;send&nbsp;20k/sec&nbsp;messages&nbsp;from&nbsp;each&nbsp;datacenter&nbsp;for&nbsp;a&nbsp;single&nbsp;application.&nbsp; In&nbsp;China,&nbsp;the&nbsp;most&nbsp;we&nbsp;can&nbsp;do&nbsp;is&nbsp;around&nbsp;2.5k/sec&nbsp;(ends&nbsp;up&nbsp;being&nbsp;around&nbsp;1.6MB/sec,&nbsp;this&nbsp;is&nbsp;on&nbsp;a&nbsp;good&nbsp;day).&nbsp;Because&nbsp;this&nbsp;message&nbsp;load&nbsp;will&nbsp;be&nbsp;from&nbsp;a&nbsp;single&nbsp;application,&nbsp;with&nbsp;the&nbsp;current&nbsp;design,&nbsp;it&nbsp;will&nbsp;be&nbsp;tied&nbsp;to&nbsp;a&nbsp;single&nbsp;routing&nbsp;key.&nbsp; So&nbsp;for&nbsp;China,&nbsp;I&nbsp;would&nbsp;need&nbsp;around&nbsp;8&nbsp;TCP&nbsp;connections&nbsp;to&nbsp;do&nbsp;this.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;For&nbsp;this&nbsp;use&nbsp;case,&nbsp;message&nbsp;order&nbsp;doesn&amp;#39;t&nbsp;matter.&nbsp; Does&nbsp;anyone&nbsp;have&nbsp;any&nbsp;ideas&nbsp;on&nbsp;how&nbsp;I&nbsp;can&nbsp;setup&nbsp;multiple&nbsp;federation&nbsp;links&nbsp;that&nbsp;will&nbsp;be&nbsp;load&nbsp;balanced?&nbsp; Here&nbsp;are&nbsp;some&nbsp;ideas&nbsp;I&nbsp;have,&nbsp;but&nbsp;they&nbsp;all&nbsp;feel&nbsp;hacky.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)&nbsp;On&nbsp;the&nbsp;upstreams,&nbsp;use&nbsp;a&nbsp;consistent&nbsp;hash&nbsp;exchange,&nbsp;with&nbsp;exchange&nbsp;to&nbsp;exchange&nbsp;bindings&nbsp;to&nbsp;8&nbsp;direct&nbsp;exchanges,&nbsp;which&nbsp;would&nbsp;be&nbsp;federated.&lt;/div&gt;&lt;div&gt;2)&nbsp;Run&nbsp;multiple&nbsp;instances&nbsp;of&nbsp;RMQ&nbsp;on&nbsp;the&nbsp;downstream&nbsp;machines,&nbsp;and&nbsp;use&nbsp;federated&nbsp;queues.&nbsp; Total&nbsp;number&nbsp;of&nbsp;instances&nbsp;across&nbsp;all&nbsp;machines&nbsp;should&nbsp;be&nbsp;greater&nbsp;than&nbsp;8.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;apologies&nbsp;in&nbsp;advance&nbsp;if&nbsp;I&amp;#39;m&nbsp;missing&nbsp;something&nbsp;obvious.&nbsp; Please&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;I&amp;#39;m&nbsp;trying&nbsp;to&nbsp;fit&nbsp;a&nbsp;round&nbsp;peg&nbsp;in&nbsp;a&nbsp;square&nbsp;hole.&nbsp; :)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks!&lt;/div&gt;&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;-Dustin&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
