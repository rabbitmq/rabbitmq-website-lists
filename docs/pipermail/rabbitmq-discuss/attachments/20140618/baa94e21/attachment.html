<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thanks&nbsp;for&nbsp;the&nbsp;suggestion&nbsp;Michael.&nbsp; I&nbsp;checked&nbsp;at&nbsp;there&nbsp;is&nbsp;no&nbsp;sharing&nbsp;of&nbsp;the&nbsp;connection&nbsp;across&nbsp;the&nbsp;thread.&nbsp; The&nbsp;connection&nbsp;is&nbsp;all&nbsp;self&nbsp;contained&nbsp;to&nbsp;this&nbsp;method&nbsp;and&nbsp;this&nbsp;method&nbsp;is&nbsp;only&nbsp;invoked&nbsp;once&nbsp;on&nbsp;the&nbsp;thread.&nbsp; The&nbsp;odd&nbsp;thing&nbsp;is&nbsp;that&nbsp;this&nbsp;same&nbsp;client&nbsp;code&nbsp;used&nbsp;to&nbsp;work.&nbsp; It&nbsp;quit&nbsp;working&nbsp;when&nbsp;our&nbsp;rabbit&nbsp;mq&nbsp;server&nbsp;hyper-v&nbsp;image&nbsp;snapshot&nbsp;got&nbsp;rolled&nbsp;back&nbsp;and&nbsp;I&nbsp;had&nbsp;to&nbsp;re-install&nbsp;reconfigure&nbsp;rabbit&nbsp;mq.&nbsp; It&nbsp;makes&nbsp;me&nbsp;think&nbsp;I&nbsp;screwed&nbsp;up&nbsp;the&nbsp;server&nbsp;side&nbsp;configuration&nbsp;when&nbsp;reinstalling.&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;private&nbsp;void&nbsp;PublishMessage(byte[]&nbsp;message,&nbsp;Type&nbsp;messageType,&nbsp;string&nbsp;contentType,&nbsp;string&nbsp;messageId)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;factory&nbsp;=&nbsp;new&nbsp;ConnectionFactory()&nbsp;{VirtualHost&nbsp;=&nbsp;this.VirtualHost,&nbsp;HostName&nbsp;=&nbsp;this.Host,&nbsp;UserName&nbsp;=&nbsp;this.User,&nbsp;Password&nbsp;=&nbsp;this.Password&nbsp;};&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;using&nbsp;(var&nbsp;connection&nbsp;=&nbsp;factory.CreateConnection())&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;using&nbsp;(var&nbsp;channel&nbsp;=&nbsp;connection.CreateModel())&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IBasicProperties&nbsp;props&nbsp;=&nbsp;channel.CreateBasicProperties();&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;props.SetPersistent(this.PersistMessages);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//Mime&nbsp;time&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;props.ContentType&nbsp;=&nbsp;contentType;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;props.Type&nbsp;=&nbsp;messageType.FullName;&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;props.MessageId&nbsp;=&nbsp;messageId;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/tutorials/tutorial-three-dotnet.html&quot;&gt;http://www.rabbitmq.com/tutorials/tutorial-three-dotnet.html&lt;/a&gt;&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//Note,&nbsp;may&nbsp;get&nbsp;AlreadyClosedException&nbsp;here&nbsp;if&nbsp;publishing&nbsp;to&nbsp;a&nbsp;incorrect&nbsp;exchange&nbsp;name&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;channel.BasicPublish(this.ExchangeName,&nbsp;this.RoutingKey,&nbsp;props,&nbsp;message);&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Jun&nbsp;18,&nbsp;2014&nbsp;at&nbsp;9:04&nbsp;PM,&nbsp;Michael&nbsp;Klishin&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:mklishin@gopivotal.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mklishin@gopivotal.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;On&nbsp;19&nbsp;June&nbsp;2014&nbsp;at&nbsp;06:02:28,&nbsp;Scott&nbsp;McFadden&nbsp;(&lt;a&nbsp;href=&quot;mailto:scott.kendall.mcfadden@gmail.com&quot;&gt;scott.kendall.mcfadden@gmail.com&lt;/a&gt;)&nbsp;wrote:&lt;br&gt;<br>
<br>
&gt;&nbsp;&gt;&nbsp;=ERROR&nbsp;REPORT====&nbsp;18-Jun-2014(&lt;a&nbsp;href=&quot;http://airmail.calendar/2014-06-18%2012:00:00%20GMT+4)::20:17:08&quot;&nbsp;target=&quot;_blank&quot;&gt;http://airmail.calendar/2014-06-18%2012:00:00%20GMT+4)::20:17:08&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;===&lt;br&gt;<br>
&gt;&nbsp;AMQP&nbsp;connection&nbsp;&lt;0.473.0&gt;&nbsp;(running),&nbsp;channel&nbsp;1&nbsp;-&nbsp;error:&lt;br&gt;<br>
&gt;&nbsp;{amqp_error,unexpected_frame,&lt;br&gt;<br>
&gt;&nbsp;&quot;expected&nbsp;content&nbsp;header&nbsp;for&nbsp;class&nbsp;60,&nbsp;got&nbsp;non&nbsp;content&nbsp;header&lt;br&gt;<br>
&gt;&nbsp;frame&nbsp;instead&quot;,&lt;br&gt;<br>
&gt;&nbsp;&#39;basic.publish&#39;}&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;looks&nbsp;like&nbsp;a&nbsp;well&nbsp;known&nbsp;issue&nbsp;you&#39;ll&nbsp;run&nbsp;into&nbsp;if&nbsp;you&nbsp;share&nbsp;a&nbsp;channel&nbsp;(IModel)&nbsp;between&lt;br&gt;<br>
threads,&nbsp;in&nbsp;particular&nbsp;threads&nbsp;that&nbsp;publish&nbsp;messages.&nbsp;This&nbsp;is&nbsp;a&nbsp;connection-level&nbsp;error,&lt;br&gt;<br>
so&nbsp;after&nbsp;getting&nbsp;it&nbsp;RabbitMQ&nbsp;closes&nbsp;the&nbsp;connection&nbsp;and&nbsp;your&nbsp;get&nbsp;socket&nbsp;errors&nbsp;on&nbsp;any&nbsp;subsequent&lt;br&gt;<br>
operation&nbsp;in&nbsp;the&nbsp;client.&lt;br&gt;<br>
&lt;br&gt;<br>
Can&nbsp;the&nbsp;cross-thread&nbsp;sharing&nbsp;be&nbsp;the&nbsp;case? &lt;br&gt;<br>
--&lt;br&gt;<br>
MK&lt;br&gt;<br>
&lt;br&gt;<br>
Software&nbsp;Engineer,&nbsp;Pivotal/RabbitMQ&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
