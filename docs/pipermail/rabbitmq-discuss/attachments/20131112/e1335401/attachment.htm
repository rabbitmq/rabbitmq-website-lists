<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Yes&nbsp;I&nbsp;can&nbsp;see&nbsp;the&nbsp;point&nbsp;about&nbsp;statelessness.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;to&nbsp;me&nbsp;that&nbsp;in&nbsp;a&nbsp;messaging&nbsp;fabric,&nbsp;it&nbsp;is&nbsp;generally&nbsp;useful&nbsp;to&nbsp;have&nbsp;ways&nbsp;of&nbsp;dampening&nbsp;duplicates.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;occurred&nbsp;to&nbsp;me&nbsp;this&nbsp;morning&nbsp;that&nbsp;federation&nbsp;uses&nbsp;hop&nbsp;counts&nbsp;-&nbsp;in&nbsp;some&nbsp;topologies,&nbsp;esp.&nbsp;with&nbsp;planned&nbsp;redundancy,&nbsp;this&nbsp;does&nbsp;not&nbsp;work&nbsp;so&nbsp;well,&nbsp;and&nbsp;perhaps&nbsp;a&nbsp;feature&nbsp;like&nbsp;this&nbsp;would&nbsp;help.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Michael&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Nov&nbsp;12,&nbsp;2013&nbsp;at&nbsp;4:48&nbsp;AM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;The&nbsp;trouble&nbsp;is,&nbsp;exchanges&nbsp;are&nbsp;meant&nbsp;to&nbsp;be&nbsp;stateless.&nbsp;So&nbsp;it&amp;#39;s&nbsp;possible&nbsp;to&nbsp;introduce&nbsp;some&nbsp;state&nbsp;into&nbsp;an&nbsp;exchange,&nbsp;but&nbsp;we&nbsp;have&nbsp;to&nbsp;choose&nbsp;between&nbsp;having&nbsp;per-node&nbsp;state&nbsp;(in&nbsp;which&nbsp;case&nbsp;dedup&nbsp;only&nbsp;works&nbsp;per-node),&nbsp;or&nbsp;having&nbsp;cluster-global&nbsp;state&nbsp;(where&nbsp;we&nbsp;either&nbsp;funnel&nbsp;all&nbsp;messages&nbsp;through&nbsp;one&nbsp;node&nbsp;in&nbsp;the&nbsp;cluster&nbsp;before&nbsp;they&nbsp;get&nbsp;routed&nbsp;to&nbsp;queues,&nbsp;or&nbsp;distribute&nbsp;the&nbsp;state&nbsp;around&nbsp;the&nbsp;cluster,&nbsp;making&nbsp;updates&nbsp;into&nbsp;expensive&nbsp;2PC).&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
So&nbsp;this&nbsp;is&nbsp;doable&nbsp;but&nbsp;it&amp;#39;s&nbsp;not&nbsp;obvious&nbsp;where&nbsp;compromises&nbsp;should&nbsp;be&nbsp;made.&nbsp;And&nbsp;as&nbsp;Matthias&nbsp;sort&nbsp;of&nbsp;pointed&nbsp;out,&nbsp;duplication&nbsp;can&nbsp;still&nbsp;happen&nbsp;due&nbsp;to&nbsp;redelivery,&nbsp;so&nbsp;this&nbsp;has&nbsp;to&nbsp;be&nbsp;an&nbsp;optimisation&nbsp;rather&nbsp;than&nbsp;something&nbsp;that&nbsp;guarantees&nbsp;duplicates&nbsp;won&amp;#39;t&nbsp;happen.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Having&nbsp;said&nbsp;all&nbsp;that,&nbsp;it&nbsp;wouldn&amp;#39;t&nbsp;be&nbsp;hideously&nbsp;difficult&nbsp;to&nbsp;implement,&nbsp;so&nbsp;I&nbsp;might&nbsp;give&nbsp;it&nbsp;a&nbsp;go.&nbsp;Depends&nbsp;on&nbsp;whether&nbsp;anybody&nbsp;else&nbsp;would&nbsp;find&nbsp;such&nbsp;a&nbsp;feature&nbsp;useful...&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&nbsp;Simon&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;11/11/2013&nbsp;19:28,&nbsp;Laing,&nbsp;Michael&nbsp;wrote:&lt;br&gt;<br>
&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
Yes&nbsp;-&nbsp;that&amp;#39;s&nbsp;actually&nbsp;what&nbsp;we&nbsp;do&nbsp;currently,&nbsp;using&nbsp;Cassandra,&nbsp;and&nbsp;it&lt;br&gt;<br>
scales&nbsp;well.&lt;br&gt;<br>
&lt;br&gt;<br>
And&nbsp;we&nbsp;also&nbsp;do&nbsp;it&nbsp;in&nbsp;memory,&nbsp;at&nbsp;the&nbsp;retail&nbsp;level,&nbsp;and&nbsp;it&nbsp;is&nbsp;very&nbsp;fast&nbsp;as&lt;br&gt;<br>
well.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;am&nbsp;just&nbsp;trying&nbsp;to&nbsp;shave&nbsp;a&nbsp;millisecond&nbsp;off&nbsp;at&nbsp;the&nbsp;retail&nbsp;level.&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&lt;br&gt;<br>
&lt;br&gt;<br>
Michael&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;Mon,&nbsp;Nov&nbsp;11,&nbsp;2013&nbsp;at&nbsp;2:22&nbsp;PM,&nbsp;Matthias&nbsp;Reik&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:maze@reik.se&quot;&nbsp;target=&quot;_blank&quot;&gt;maze@reik.se&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;<br>
&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:maze@reik.se&quot;&nbsp;target=&quot;_blank&quot;&gt;maze@reik.se&lt;/a&gt;&amp;gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;Even&nbsp;though&nbsp;it&nbsp;sounds&nbsp;like&nbsp;a&nbsp;nice&nbsp;feature,&nbsp;it&nbsp;is&nbsp;probably&nbsp;difficult&lt;br&gt;<br>
 &nbsp; &nbsp;to&nbsp;really&nbsp;implement,&nbsp;if&nbsp;not&nbsp;done&nbsp;on&nbsp;the&nbsp;client&nbsp;side.&nbsp;The&nbsp;duplicates&lt;br&gt;<br>
 &nbsp; &nbsp;might&nbsp;happen&nbsp;when&nbsp;delivering&nbsp;to&nbsp;the&nbsp;client&nbsp;side.&nbsp;but&nbsp;on&nbsp;the&nbsp;client&lt;br&gt;<br>
 &nbsp; &nbsp;side&nbsp;it&nbsp;should&nbsp;be&nbsp;quite&nbsp;easy&nbsp;to&nbsp;do&nbsp;the&nbsp;filtering:&lt;br&gt;<br>
 &nbsp; &nbsp;*&nbsp;get&nbsp;a&nbsp;message&nbsp;from&nbsp;the&nbsp;queue,&lt;br&gt;<br>
 &nbsp; &nbsp;*&nbsp;check&nbsp;against&nbsp;memcached&nbsp;(couchbase,&nbsp;or&nbsp;some&nbsp;other&nbsp;cache&lt;br&gt;<br>
 &nbsp; &nbsp;technology)&nbsp;whether&nbsp;the&nbsp;messageID&nbsp;exists.&lt;br&gt;<br>
 &nbsp; &nbsp;*&nbsp;Add&nbsp;the&nbsp;new&nbsp;message&nbsp;to&nbsp;memcached&nbsp;(can&nbsp;be&nbsp;done&nbsp;with&nbsp;the&nbsp;previous&nbsp;step)&lt;br&gt;<br>
 &nbsp; &nbsp;*&nbsp;Set&nbsp;the&nbsp;timeout&nbsp;in&nbsp;memcached&nbsp;to&nbsp;your&nbsp;window&nbsp;size.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;This&nbsp;should&nbsp;be&nbsp;straight&nbsp;forward,&nbsp;would&nbsp;scale&nbsp;up&nbsp;to&nbsp;quite&nbsp;a&nbsp;lot&nbsp;of&lt;br&gt;<br>
 &nbsp; &nbsp;messages)&nbsp;and&nbsp;should&nbsp;remove&nbsp;(depending&nbsp;on&nbsp;your&nbsp;window&nbsp;size)&nbsp;all&lt;br&gt;<br>
 &nbsp; &nbsp;duplicates.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;Is&nbsp;there&nbsp;a&nbsp;good&nbsp;reason&nbsp;why&nbsp;you&nbsp;wouldn&amp;#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;this&nbsp;on&nbsp;the&lt;br&gt;<br>
 &nbsp; &nbsp;client&nbsp;side&nbsp;as&nbsp;described?&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;Cheers&lt;br&gt;<br>
 &nbsp; &nbsp;Matthias&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;PS:&nbsp;as&nbsp;a&nbsp;caching&nbsp;technology&nbsp;you&nbsp;could&nbsp;of&nbsp;course&nbsp;do&nbsp;your&nbsp;own&lt;br&gt;<br>
 &nbsp; &nbsp;in-memory-solution&nbsp;but&nbsp;that&amp;#39;s&nbsp;probably&nbsp;more&nbsp;work&nbsp;than&nbsp;to&nbsp;use&nbsp;an&lt;br&gt;<br>
 &nbsp; &nbsp;out-of-the-box&nbsp;solution.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;On&nbsp;2013-11-11&nbsp;12:35&nbsp;,&nbsp;Laing,&nbsp;Michael&nbsp;wrote:&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;<br>
 &nbsp; &nbsp;In&nbsp;our&nbsp;scenarios,&nbsp;messages&nbsp;are&nbsp;ultimately&nbsp;delivered&nbsp;to&nbsp;a&nbsp;&amp;#39;retail&amp;#39;&lt;br&gt;<br>
 &nbsp; &nbsp;rabbitmq&nbsp;instance&nbsp;to&nbsp;be&nbsp;delivered&nbsp;to&nbsp;a&nbsp;client.&nbsp;The&nbsp;pipelines&nbsp;that&lt;br&gt;<br>
 &nbsp; &nbsp;process&nbsp;and&nbsp;deliver&nbsp;messages&nbsp;are&nbsp;purposefully&nbsp;redundant,&nbsp;hence&lt;br&gt;<br>
 &nbsp; &nbsp;there&nbsp;may&nbsp;be&nbsp;multiple&nbsp;replicas&nbsp;of&nbsp;each&nbsp;message&nbsp;&amp;#39;racing&amp;#39;&nbsp;to&nbsp;the&lt;br&gt;<br>
 &nbsp; &nbsp;endpoint.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;Usually,&nbsp;the&nbsp;replicas&nbsp;are&nbsp;resolved&nbsp;before&nbsp;getting&nbsp;to&nbsp;the&nbsp;retail&lt;br&gt;<br>
 &nbsp; &nbsp;rabbit.&nbsp;When&nbsp;components&nbsp;fail,&nbsp;however,&nbsp;duplicates&nbsp;can&nbsp;leak&nbsp;through&lt;br&gt;<br>
 &nbsp; &nbsp;during&nbsp;a&nbsp;small&nbsp;window&nbsp;of&nbsp;time.&nbsp;We&nbsp;eliminate&nbsp;those&nbsp;duplicates&nbsp;at&lt;br&gt;<br>
 &nbsp; &nbsp;the&nbsp;retail&nbsp;layer&nbsp;by&nbsp;looking&nbsp;at&nbsp;each&nbsp;message_id.&nbsp;Ultimately,&nbsp;our&lt;br&gt;<br>
 &nbsp; &nbsp;client&nbsp;contract&nbsp;allows&nbsp;duplicates&nbsp;as&nbsp;well&nbsp;in&nbsp;case&nbsp;one&nbsp;slips&nbsp;by.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;It&nbsp;seems&nbsp;to&nbsp;me&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;generic&nbsp;issue.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;What&nbsp;would&nbsp;be&nbsp;useful&nbsp;in&nbsp;our&nbsp;case,&nbsp;and&nbsp;hopefully&nbsp;for&nbsp;many&nbsp;others,&lt;br&gt;<br>
 &nbsp; &nbsp;would&nbsp;be&nbsp;a&nbsp;&amp;#39;Duplicate&nbsp;Message&nbsp;ID&nbsp;Window&amp;#39;&nbsp;in&nbsp;milliseconds,&nbsp;as&nbsp;an&lt;br&gt;<br>
 &nbsp; &nbsp;exchange&nbsp;attribute.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;If&nbsp;non-zero,&nbsp;the&nbsp;exchange&nbsp;would&nbsp;drop&nbsp;any&nbsp;message&nbsp;with&nbsp;a&nbsp;duplicate&lt;br&gt;<br>
 &nbsp; &nbsp;message_id&nbsp;that&nbsp;appeared&nbsp;within&nbsp;the&nbsp;specified&nbsp;window&nbsp;of&nbsp;time,&lt;br&gt;<br>
 &nbsp; &nbsp;possibly&nbsp;routing&nbsp;it&nbsp;to&nbsp;the&nbsp;alternate&nbsp;exchange,&nbsp;if&nbsp;set.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;In&nbsp;our&nbsp;case,&nbsp;a&nbsp;window&nbsp;of&nbsp;a&nbsp;few&nbsp;seconds,&nbsp;perhaps&nbsp;up&nbsp;to&nbsp;a&nbsp;minute&lt;br&gt;<br>
 &nbsp; &nbsp;would&nbsp;suffice.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;Thanks,&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;Michael&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
 &nbsp; &nbsp;rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
 &nbsp; &nbsp;&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&nbsp; &amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@&lt;u&gt;&lt;/u&gt;lists.rabbitmq.com&lt;/a&gt;&amp;gt;&lt;br&gt;<br>
<br>
 &nbsp; &nbsp;&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
 &nbsp; &nbsp;rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
 &nbsp; &nbsp;&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&lt;br&gt;&lt;/div&gt;<br>
 &nbsp; &nbsp;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@&lt;u&gt;&lt;/u&gt;lists.rabbitmq.com&lt;/a&gt;&amp;gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
 &nbsp; &nbsp;&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
