<tt>
Hey&nbsp;Eric&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Problem&nbsp;is&nbsp;probably&nbsp;in&nbsp;fact,&nbsp;that&nbsp;model&nbsp;instance&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;from&nbsp;multiple&nbsp;threads.&nbsp;If&nbsp;you&nbsp;are&nbsp;publishing&nbsp;from&nbsp;multiple&nbsp;threads,&nbsp;each&nbsp;thread&nbsp;should&nbsp;use&nbsp;its&nbsp;own&nbsp;IModel&nbsp;instance...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Michal&lt;br&gt;&lt;br&gt;On&nbsp;Monday,&nbsp;December&nbsp;10,&nbsp;2012&nbsp;3:22:51&nbsp;PM&nbsp;UTC+1,&nbsp;Eric&nbsp;Swann&nbsp;wrote:&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:&nbsp;0;margin-left:&nbsp;0.8ex;border-left:&nbsp;1px&nbsp;#ccc&nbsp;solid;padding-left:&nbsp;1ex;&quot;&gt;When&nbsp;using&nbsp;publisher&nbsp;confirms&nbsp;with&nbsp;the&nbsp;C#&nbsp;code,&nbsp;there&nbsp;is&nbsp;a&nbsp;bug&nbsp;in&nbsp;the&nbsp;client&nbsp;when&nbsp;experiencing&nbsp;any&nbsp;significant&nbsp;load.&nbsp;&amp;nbsp;The&nbsp;offending&nbsp;code&nbsp;is&nbsp;in&nbsp;the&nbsp;client&nbsp;&quot;RabbitMQ.Client.Impl.&lt;wbr&gt;ModelBase&quot;&nbsp;class&nbsp;in&nbsp;the&nbsp;&quot;BasicPublish&quot;&nbsp;method.&nbsp;&amp;nbsp;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;if&nbsp;(m_nextPubSeqNo&nbsp;&amp;gt;&nbsp;0)&nbsp;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;m_unconfirmedSet.&lt;b&gt;Add&lt;/b&gt;(m_&lt;wbr&gt;nextPubSeqNo,&nbsp;null);&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;m_nextPubSeqNo++;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;looks&nbsp;like&nbsp;there&nbsp;are&nbsp;multiple&nbsp;threads&nbsp;hitting&nbsp;the&nbsp;bolded&nbsp;&quot;&lt;b&gt;Add&lt;/b&gt;&quot;&nbsp;method&nbsp;before&nbsp;the&nbsp;sequence&nbsp;number&nbsp;is&nbsp;incremented&nbsp;in&nbsp;the&nbsp;next&nbsp;line&nbsp;leading&nbsp;to&nbsp;duplicate&nbsp;key&nbsp;exceptions&nbsp;being&nbsp;thrown&nbsp;by&nbsp;the&nbsp;&quot;m_unconfirmedSet&quot;&nbsp;sorted&nbsp;list.&nbsp;&amp;nbsp;&amp;nbsp;This&nbsp;code&nbsp;either&nbsp;needs&nbsp;to&nbsp;have&nbsp;a&nbsp;lock&nbsp;around&nbsp;it&nbsp;or&nbsp;have&nbsp;m_nextPubSeqNo&nbsp;change&nbsp;to&nbsp;a&nbsp;long&nbsp;so&nbsp;that&nbsp;&quot;Interlocked.Increment&quot;&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;assignment.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;
</tt>
