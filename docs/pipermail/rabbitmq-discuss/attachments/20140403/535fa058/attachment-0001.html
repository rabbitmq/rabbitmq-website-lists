<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=ISO-8859-1&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;bgcolor=&quot;#FFFFFF&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;02/04/2014&nbsp;6:23&nbsp;PM,&nbsp;Gary&nbsp;Russell&nbsp;wrote:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
cite=&quot;mid:CADtU9_vsLWqzC=rwm6WFP-2hiKf80wmVmSp5soPehQk5gu2tDQ@mail.gmail.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;In&nbsp;Spring-AMQP,&nbsp;we&nbsp;don't&nbsp;asynchronously&nbsp;cancel&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consumer,&nbsp;we&nbsp;tell&nbsp;the&nbsp;consumer&nbsp;it&nbsp;needs&nbsp;to&nbsp;cancel&nbsp;itself&nbsp;when<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it's&nbsp;finished&nbsp;its&nbsp;current&nbsp;work.&nbsp;IIRC,&nbsp;if&nbsp;the&nbsp;consumer&nbsp;is&nbsp;running<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;you&nbsp;cancel&nbsp;it,&nbsp;its&nbsp;basicAck&nbsp;will&nbsp;fail&nbsp;because&nbsp;you've<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;already&nbsp;cancelled&nbsp;it&nbsp;and&nbsp;the&nbsp;broker&nbsp;has&nbsp;re-queued&nbsp;that&nbsp;message.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Effectively&nbsp;we&nbsp;tell&nbsp;the&nbsp;consumer&nbsp;to&nbsp;emit&nbsp;the&nbsp;cancel&nbsp;immediately<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;after&nbsp;the&nbsp;ack.&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;tested&nbsp;this&nbsp;on&nbsp;RabbitMQ&nbsp;3.2.4&nbsp;and&nbsp;calling&nbsp;basicCancel&nbsp;for&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;consumer&nbsp;tag&nbsp;does&nbsp;not&nbsp;interfere&nbsp;with&nbsp;the&nbsp;ability&nbsp;to&nbsp;basicAck&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;message&nbsp;currently&nbsp;being&nbsp;processed&nbsp;(I&nbsp;used&nbsp;Thread.sleep()&nbsp;in&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;consumer&nbsp;to&nbsp;ensure&nbsp;the&nbsp;operation&nbsp;order).&nbsp;The&nbsp;handleCancelOk()&nbsp;method<br>
&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;only&nbsp;called&nbsp;after&nbsp;the&nbsp;handleDelivery()&nbsp;method&nbsp;returns.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;From&nbsp;what&nbsp;I&nbsp;could&nbsp;piece&nbsp;together,&nbsp;calling&nbsp;basicCancel&nbsp;queues&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;channel&nbsp;rpc&nbsp;command&nbsp;for&nbsp;execution&nbsp;after&nbsp;whatever&nbsp;is&nbsp;already&nbsp;queued.<br>
&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;consumer&nbsp;even&nbsp;consumes&nbsp;its&nbsp;buffered&nbsp;messages&nbsp;(basicQos&nbsp;&gt;&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;before&nbsp;processing&nbsp;the&nbsp;cancel&nbsp;command.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
cite=&quot;mid:CADtU9_vsLWqzC=rwm6WFP-2hiKf80wmVmSp5soPehQk5gu2tDQ@mail.gmail.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&gt;&lt;span<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;stop&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;badly&nbsp;behaving&nbsp;Consumer&lt;/span&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;It<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends&nbsp;on&nbsp;how&nbsp;badly&nbsp;behaved&nbsp;it&nbsp;is;&nbsp;if&nbsp;it&nbsp;never&nbsp;executes&nbsp;any<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interruptible&nbsp;code&nbsp;(say&nbsp;it's&nbsp;stuck&nbsp;in&nbsp;a&nbsp;while()&nbsp;loop),&nbsp;you<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;are&nbsp;out&nbsp;of&nbsp;luck.&nbsp;If&nbsp;it&nbsp;does&nbsp;stuff&nbsp;that's&nbsp;interruptible<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(acquire&nbsp;locks,&nbsp;etc,&nbsp;etc)&nbsp;then&nbsp;you&nbsp;can&nbsp;interrupt&nbsp;it.&lt;/span&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:arial,sans-serif;font-size:13px&quot;&gt;I<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;don't&nbsp;know&nbsp;enough&nbsp;about&nbsp;the&nbsp;rabbit&nbsp;client&nbsp;internals&nbsp;as&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;mechanism&nbsp;to&nbsp;force&nbsp;it&nbsp;to&nbsp;interrupt&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dispatcher&nbsp;thread&nbsp;(I&nbsp;didn't&nbsp;see&nbsp;anything&nbsp;after&nbsp;a&nbsp;quick&nbsp;look)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so&nbsp;you&nbsp;might&nbsp;have&nbsp;to&nbsp;roll&nbsp;your&nbsp;own&nbsp;(capture&nbsp;a&nbsp;reference&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;thread&nbsp;in&nbsp;handleDelivery&nbsp;and&nbsp;interrupt&nbsp;it&nbsp;after&nbsp;your<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timeout).&lt;/span&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;When&nbsp;all&nbsp;else&nbsp;fails,&nbsp;System.exit()&nbsp;is&nbsp;your&nbsp;friend.&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Yeah&nbsp;I&nbsp;think&nbsp;System.exit()&nbsp;will&nbsp;do&nbsp;the&nbsp;trick&nbsp;here.&nbsp;Your&nbsp;idea&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;using&nbsp;my&nbsp;own&nbsp;executor&nbsp;and&nbsp;shutting&nbsp;it&nbsp;down&nbsp;(your&nbsp;other&nbsp;email)&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;very&nbsp;good&nbsp;however,&nbsp;but&nbsp;I&nbsp;think&nbsp;I'm&nbsp;overengineering&nbsp;this&nbsp;a&nbsp;bit&nbsp;for&nbsp;my<br>
&nbsp;&nbsp;&nbsp;&nbsp;current&nbsp;needs.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Thanks&nbsp;for&nbsp;all&nbsp;your&nbsp;help,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Bertrand&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>
<br>

</tt>
