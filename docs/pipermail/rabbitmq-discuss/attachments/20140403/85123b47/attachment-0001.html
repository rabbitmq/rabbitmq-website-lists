<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;written&nbsp;a&nbsp;simple&nbsp;test&nbsp;program&nbsp;using&nbsp;the&nbsp;SimpleAqmpClient&nbsp;library&nbsp;(which&nbsp;in&nbsp;turn&nbsp;uses&nbsp;the&nbsp;rabbitmq-c&nbsp;library),&nbsp;which&nbsp;seems&nbsp;to&nbsp;illustrate&nbsp;a&nbsp;memory&nbsp;leak,&nbsp;of&nbsp;sorts.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;program&nbsp;is&nbsp;a&nbsp;simple&nbsp;main,&nbsp;which&nbsp;pre-allocates&nbsp;a&nbsp;string&nbsp;message,&nbsp;and&nbsp;then&nbsp;calls&nbsp;BasicPublish&nbsp;on&nbsp;a&nbsp;channel&nbsp;in&nbsp;a&nbsp;loop,&nbsp;all&nbsp;single&nbsp;threaded.&nbsp;&nbsp;Effectively:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Menlo;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;style=&quot;color:&nbsp;#bb2ca2&quot;&gt;auto&lt;/span&gt;&nbsp;envelope&nbsp;=&nbsp;&lt;span&nbsp;style=&quot;color:&nbsp;#703daa&quot;&gt;BasicMessage&lt;/span&gt;::&lt;span&nbsp;style=&quot;color:&nbsp;#3d1d81&quot;&gt;Create&lt;/span&gt;(&lt;span&nbsp;style=&quot;color:&nbsp;#31595d&quot;&gt;random_data&lt;/span&gt;(message_size));&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Menlo;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;style=&quot;color:&nbsp;#bb2ca2&quot;&gt;for&lt;/span&gt;&nbsp;(&lt;span&nbsp;style=&quot;color:&nbsp;#bb2ca2&quot;&gt;unsigned&lt;/span&gt;&nbsp;i&nbsp;=&nbsp;&lt;span&nbsp;style=&quot;color:&nbsp;#272ad8&quot;&gt;0&lt;/span&gt;;&nbsp;&nbsp;i&nbsp;&lt;&nbsp;num_messages;&nbsp;&nbsp;++i)&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Menlo;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Menlo;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel-&gt;&lt;span&nbsp;style=&quot;color:&nbsp;#3d1d81&quot;&gt;BasicPublish&lt;/span&gt;(exchange_name,&nbsp;routing_key,&nbsp;envelope);&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Menlo;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;the&nbsp;memory&nbsp;image&nbsp;of&nbsp;this&nbsp;process&nbsp;seems&nbsp;to&nbsp;grow&nbsp;without&nbsp;bounds.&nbsp;&nbsp;The&nbsp;memory&nbsp;all&nbsp;seems&nbsp;to&nbsp;be&nbsp;allocated&nbsp;in&nbsp;amqp_pool_alloc&nbsp;(as&nbsp;expected),&nbsp;when&nbsp;calling&nbsp;wait_frame_inner&nbsp;-&gt;&nbsp;amqp_handle_input.&nbsp;&nbsp;The&nbsp;memory&nbsp;is&nbsp;not&nbsp;orphaned&nbsp;--&nbsp;i.e.,&nbsp;it&nbsp;seems&nbsp;to&nbsp;get&nbsp;cleaned&nbsp;up&nbsp;at&nbsp;shutdown,&nbsp;so&nbsp;it&nbsp;doesn't&nbsp;show&nbsp;up&nbsp;as&nbsp;a&nbsp;leak&nbsp;in&nbsp;a&nbsp;leak&nbsp;detector&nbsp;tool,&nbsp;such&nbsp;a&nbsp;Instruments/DTrace,&nbsp;or&nbsp;valgrind,&nbsp;or&nbsp;purify,&nbsp;etc.&nbsp;&nbsp;But&nbsp;I&nbsp;don't&nbsp;see&nbsp;where&nbsp;the&nbsp;memory&nbsp;is&nbsp;every&nbsp;de-allocated,&nbsp;which&nbsp;will&nbsp;spell&nbsp;doom&nbsp;for&nbsp;an&nbsp;application&nbsp;that&nbsp;is&nbsp;designed&nbsp;to&nbsp;never&nbsp;terminate.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;attaching&nbsp;a&nbsp;screenshot&nbsp;from&nbsp;an&nbsp;Instruments&nbsp;run,&nbsp;to&nbsp;give&nbsp;some&nbsp;context.&nbsp;&nbsp;The&nbsp;code&nbsp;is&nbsp;here:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://github.com/fadushin/sandbox/blob/master/cpp/rabbitmq/sender.cpp&quot;&gt;https://github.com/fadushin/sandbox/blob/master/cpp/rabbitmq/sender.cpp&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;was&nbsp;run&nbsp;against&nbsp;RabbitMQ&nbsp;3.2.4,&nbsp;using&nbsp;rabbitmq-c&nbsp;0.5.0&nbsp;and&nbsp;SimpleAmqpClient&nbsp;2.3,&nbsp;compiled&nbsp;using&nbsp;Clang&nbsp;5.0&nbsp;on&nbsp;OS&nbsp;X.9&nbsp;(Mavericks).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Has&nbsp;anyone&nbsp;seen&nbsp;this&nbsp;behavior?&nbsp;&nbsp;Am&nbsp;I&nbsp;missing&nbsp;something&nbsp;in&nbsp;my&nbsp;use&nbsp;of&nbsp;BasicPublish,&nbsp;that&nbsp;is&nbsp;not&nbsp;telling&nbsp;the&nbsp;rabbitmq-c&nbsp;library&nbsp;to&nbsp;free&nbsp;memory&nbsp;in&nbsp;the&nbsp;&quot;amqp&nbsp;pool&quot;?&nbsp;&nbsp;It&nbsp;doesn't&nbsp;seem&nbsp;to&nbsp;make&nbsp;a&nbsp;difference&nbsp;whether&nbsp;I&nbsp;am&nbsp;actively&nbsp;pulling&nbsp;messages&nbsp;off&nbsp;the&nbsp;queue&nbsp;from&nbsp;a&nbsp;separate&nbsp;process,&nbsp;or&nbsp;even&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;queue&nbsp;bound&nbsp;to&nbsp;the&nbsp;exchange&nbsp;to&nbsp;which&nbsp;I&nbsp;am&nbsp;publishing&nbsp;messages.&nbsp;&nbsp;(Not&nbsp;that&nbsp;I&nbsp;would&nbsp;expect&nbsp;it&nbsp;to)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-Fred&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;encl.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;img&nbsp;apple-inline=&quot;yes&quot;&nbsp;id=&quot;E5B9E917-F251-45D5-A41F-D0AD0D131613&quot;&nbsp;height=&quot;545&quot;&nbsp;width=&quot;897&quot;&nbsp;apple-width=&quot;yes&quot;&nbsp;apple-height=&quot;yes&quot;&nbsp;src=&quot;cid:9DBB6641-0A1A-4374-9788-CFF34265600A@corp.emc.com&quot;&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
