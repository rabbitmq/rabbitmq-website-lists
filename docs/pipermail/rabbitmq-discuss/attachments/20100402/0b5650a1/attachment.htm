<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;Matthew,&nbsp;thanks&nbsp;for&nbsp;your&nbsp;reply!&nbsp;Some&nbsp;comments&nbsp;inline:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Apr&nbsp;2,&nbsp;2010,&nbsp;at&nbsp;1:15&nbsp;PM,&nbsp;Matthew&nbsp;Sackman&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;On&nbsp;Thu,&nbsp;Apr&nbsp;01,&nbsp;2010&nbsp;at&nbsp;12:05:25PM&nbsp;-0300,&nbsp;Juan&nbsp;Wajnerman&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;After&nbsp;unsubscribing&nbsp;from&nbsp;a&nbsp;queue,&nbsp;following&nbsp;&quot;recover&quot;&nbsp;calls&nbsp;will&nbsp;still&nbsp;redeliver&nbsp;unack'd&nbsp;messages&nbsp;through&nbsp;the&nbsp;channel.&nbsp;Even&nbsp;worse,&nbsp;after&nbsp;resubscribing&nbsp;to&nbsp;the&nbsp;queue,&nbsp;the&nbsp;recovered&nbsp;messages&nbsp;are&nbsp;still&nbsp;sent&nbsp;with&nbsp;the&nbsp;old&nbsp;consumer&nbsp;tag.&lt;br&gt;&lt;/blockquote&gt;&lt;br&gt;The&nbsp;documentation&nbsp;of&nbsp;basic.recover&nbsp;is&nbsp;clear:&lt;br&gt;&quot;This&nbsp;method&nbsp;asks&nbsp;the&nbsp;server&nbsp;to&nbsp;redeliver&nbsp;all&nbsp;unacknowledged&nbsp;messages&lt;br&gt;on&nbsp;a&nbsp;specified&nbsp;channel.&quot;&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;what&nbsp;should&nbsp;happen&nbsp;if&nbsp;the&nbsp;subscription&nbsp;was&nbsp;canceled&nbsp;before&nbsp;the&nbsp;messages&lt;/div&gt;&lt;div&gt;were&nbsp;ack'd?&nbsp;The&nbsp;current&nbsp;implementation&nbsp;is&nbsp;still&nbsp;sending&nbsp;the&nbsp;messages&nbsp;with&nbsp;the&nbsp;same&nbsp;consumer&nbsp;tag.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;&lt;br&gt;I&nbsp;don't&nbsp;know&nbsp;the&nbsp;ruby&nbsp;library&nbsp;at&nbsp;all,&nbsp;but&nbsp;I&nbsp;assume&nbsp;from&nbsp;your&nbsp;code&nbsp;below&lt;br&gt;they&nbsp;inverted&nbsp;the&nbsp;noAck&nbsp;flag&nbsp;to&nbsp;ack,&nbsp;hence&nbsp;your&nbsp;:ack&nbsp;=&amp;gt;&nbsp;true&nbsp;indicates&lt;br&gt;you&nbsp;are&nbsp;commiting&nbsp;to&nbsp;acking&nbsp;messages&nbsp;manually.&nbsp;Your&nbsp;code&nbsp;does&nbsp;not&nbsp;do&nbsp;that&lt;br&gt;hence&nbsp;every&nbsp;message&nbsp;you&nbsp;receive&nbsp;as&nbsp;part&nbsp;of&nbsp;the&nbsp;subscription&nbsp;is&nbsp;unack'd,&lt;br&gt;hence&nbsp;will&nbsp;be&nbsp;redelivered&nbsp;when&nbsp;you&nbsp;issue&nbsp;the&nbsp;recover.&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That's&nbsp;right.&nbsp;The&nbsp;omission&nbsp;was&nbsp;completely&nbsp;intentional&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;issue.&lt;/div&gt;&lt;div&gt;I'm&nbsp;sorry,&nbsp;maybe&nbsp;I&nbsp;wasn't&nbsp;clear&nbsp;enough&nbsp;about&nbsp;this.&nbsp;The&nbsp;idea&nbsp;is&nbsp;to&nbsp;cancel&nbsp;the&lt;/div&gt;&lt;div&gt;subscription&nbsp;before&nbsp;the&nbsp;message&nbsp;was&nbsp;ack'd&nbsp;and&nbsp;then&nbsp;resubscribe&nbsp;and&nbsp;perform&nbsp;a&nbsp;recover.&amp;nbsp;&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;&lt;br&gt;Similarly,&nbsp;the&nbsp;documention&nbsp;for&nbsp;basic.cancel&nbsp;(unsubscribe):&lt;br&gt;&quot;This&nbsp;method&nbsp;cancels&nbsp;a&nbsp;consumer.&nbsp;This&nbsp;does&nbsp;not&nbsp;affect&nbsp;already&nbsp;delivered&lt;br&gt;messages,&nbsp;but&nbsp;it&nbsp;does&nbsp;mean&nbsp;the&nbsp;server&nbsp;will&nbsp;not&nbsp;send&nbsp;any&nbsp;more&nbsp;messages&nbsp;for&lt;br&gt;that&nbsp;consumer.&quot;&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;understand&nbsp;this,&nbsp;but&nbsp;I'm&nbsp;looking&nbsp;at&nbsp;the&nbsp;bits&nbsp;on&nbsp;the&nbsp;wire,&nbsp;and&nbsp;after&nbsp;sending&nbsp;a&nbsp;cancel,&nbsp;the&lt;/div&gt;&lt;div&gt;following&nbsp;recover&nbsp;will&nbsp;send&nbsp;the&nbsp;unack'd&nbsp;messages&nbsp;using&nbsp;the&nbsp;same&nbsp;old&nbsp;consumer&nbsp;tag.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;&lt;br&gt;Thus&nbsp;it&nbsp;is&nbsp;clear&nbsp;that&nbsp;cancelling&nbsp;your&nbsp;subscription&nbsp;does&nbsp;not&nbsp;void&nbsp;your&lt;br&gt;commitment&nbsp;to&nbsp;acknowledge&nbsp;the&nbsp;messages&nbsp;you've&nbsp;already&nbsp;been&nbsp;sent.&lt;br&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I'm&nbsp;using&nbsp;the&nbsp;amqp&nbsp;ruby&nbsp;library&nbsp;to&nbsp;consume&nbsp;the&nbsp;queues.&nbsp;Here's&nbsp;a&nbsp;small&nbsp;snippet&nbsp;that&nbsp;reproduces&nbsp;the&nbsp;issue.&nbsp;When&nbsp;I&nbsp;execute&nbsp;this,&nbsp;I&nbsp;always&nbsp;get&nbsp;an&nbsp;error&nbsp;similar&nbsp;to:&nbsp;Basic.Deliver&nbsp;for&nbsp;invalid&nbsp;consumer&nbsp;tag:&nbsp;myqueue-396735623077.&lt;br&gt;&lt;/blockquote&gt;&lt;br&gt;That&nbsp;really&nbsp;shouldn't&nbsp;be&nbsp;happening&nbsp;-&nbsp;and&nbsp;I&nbsp;suspect&nbsp;it's&nbsp;a&nbsp;client&nbsp;bug.&lt;br&gt;I've&nbsp;just&nbsp;checked&nbsp;our&nbsp;code&nbsp;-&nbsp;the&nbsp;queue&nbsp;is&nbsp;told&nbsp;to&nbsp;forget&nbsp;about&nbsp;the&lt;br&gt;consumer&nbsp;tag&nbsp;on&nbsp;the&nbsp;basic.cancel,&nbsp;and&nbsp;is&nbsp;told&nbsp;about&nbsp;the&nbsp;new&nbsp;consumer&lt;br&gt;tag&nbsp;on&nbsp;basic.consume.&nbsp;Your&nbsp;ctag&nbsp;of&nbsp;myqueue-396735623077&nbsp;is&nbsp;clearly&nbsp;one&lt;br&gt;that&nbsp;you,&nbsp;or&nbsp;the&nbsp;library,&nbsp;is&nbsp;specifying&nbsp;-&nbsp;all&nbsp;the&nbsp;server&nbsp;generated&lt;br&gt;ctags&nbsp;start&nbsp;&quot;amq.ctag-&quot;.&nbsp;I&nbsp;have&nbsp;no&nbsp;idea&nbsp;what&nbsp;the&nbsp;ruby&nbsp;amqp&nbsp;library&nbsp;is&lt;br&gt;doing&nbsp;under&nbsp;the&nbsp;bonnet&nbsp;-&nbsp;given&nbsp;that&nbsp;you're&nbsp;not&nbsp;supplying&nbsp;a&nbsp;ctag&lt;br&gt;yourself,&nbsp;nor&nbsp;should&nbsp;the&nbsp;library.&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;was&nbsp;digging&nbsp;into&nbsp;the&nbsp;source&nbsp;code&nbsp;after&nbsp;sending&nbsp;my&nbsp;email&nbsp;and&nbsp;I&nbsp;found&nbsp;that&nbsp;(correct&nbsp;me&nbsp;if&nbsp;I'm&nbsp;wrong,&nbsp;it's&nbsp;my&nbsp;first&nbsp;time&lt;/div&gt;&lt;div&gt;I&nbsp;look&nbsp;into&nbsp;this&nbsp;code)&nbsp;in&nbsp;rabbit_channel.erl:578&nbsp;the&nbsp;recover&nbsp;is&nbsp;taking&nbsp;the&nbsp;unack'd&nbsp;messages&lt;/div&gt;&lt;div&gt;and&nbsp;redelivering&nbsp;these&nbsp;using&nbsp;the&nbsp;same&nbsp;ConsumerTag&nbsp;as&nbsp;it&nbsp;was&nbsp;sent&nbsp;before.&nbsp;I&nbsp;think&nbsp;this&nbsp;is&lt;/div&gt;&lt;div&gt;indeed&nbsp;what&nbsp;the&nbsp;FIXME&nbsp;warns:&nbsp;&quot;What&nbsp;should&nbsp;happen&nbsp;if&nbsp;the&nbsp;consumer's&nbsp;been&amp;nbsp;cancelled&nbsp;since?&quot;.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;Matthew&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
