<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;Transitional//EN&quot;&gt;<br>
&lt;HTML&gt;&lt;HEAD&gt;<br>
&lt;META&nbsp;content=&quot;text/html;&nbsp;charset=iso-8859-1&quot;&nbsp;http-equiv=Content-Type&gt;<br>
&lt;META&nbsp;name=GENERATOR&nbsp;content=&quot;MSHTML&nbsp;8.00.6001.19120&quot;&gt;<br>
&lt;STYLE&gt;&lt;/STYLE&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&nbsp;bgColor=#ffffff&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;Hi&nbsp;there,&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;I&nbsp;came&nbsp;across&nbsp;an&nbsp;interesting&nbsp;issue&nbsp;that&nbsp;I&nbsp;was&nbsp;<br>
hoping&nbsp;someone&nbsp;could&nbsp;help&nbsp;me&nbsp;with.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;I&nbsp;think&nbsp;its&nbsp;related&nbsp;to&nbsp;Channel&nbsp;thread-safety.&amp;nbsp;&nbsp;<br>
Here's&nbsp;the&nbsp;issue.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;I&nbsp;want&nbsp;to&nbsp;create&nbsp;an&nbsp;lightweight&nbsp;web&nbsp;service&nbsp;<br>
endpoint&nbsp;using&nbsp;Gretty&amp;nbsp;that&nbsp;sends&nbsp;(json)&nbsp;messages&nbsp;to&nbsp;rabbitmq.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;It&amp;nbsp;works,&nbsp;but&nbsp;when&nbsp;i&nbsp;benchmark&nbsp;it&nbsp;with&nbsp;'ab&nbsp;-n&nbsp;<br>
1000&nbsp;-c&nbsp;100&nbsp;&lt;A&nbsp;href=&quot;http://x.x.x.x/'&quot;&gt;http://x.x.x.x/'&lt;/A&gt;&nbsp;there&nbsp;are&amp;nbsp;1003&nbsp;<br>
messages&nbsp;in&nbsp;the&nbsp;queue!&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;Gretty&nbsp;relies&nbsp;on&nbsp;Netty&nbsp;(&lt;A&nbsp;<br>
href=&quot;http://www.jboss.org/netty&quot;&gt;http://www.jboss.org/netty&lt;/A&gt;)&nbsp;which&nbsp;is&nbsp;an&nbsp;<br>
asynchronous&nbsp;event-driven&nbsp;framework&nbsp;that&nbsp;uses&nbsp;NIO.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;I've&nbsp;included&nbsp;the&nbsp;(working,&nbsp;no&nbsp;error)&nbsp;Gretty&nbsp;code&nbsp;<br>
below.&amp;nbsp;&nbsp;Could&nbsp;I&nbsp;ask&nbsp;for&nbsp;your&nbsp;insight&nbsp;as&nbsp;to&nbsp;why&nbsp;there&nbsp;are&nbsp;more&nbsp;messages&nbsp;in&nbsp;<br>
the&nbsp;queue&nbsp;than&nbsp;the&nbsp;producer&nbsp;(ab)&nbsp;sent?&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;Thanks&nbsp;for&nbsp;your&nbsp;time,&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;Burt&nbsp;Prior&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;server.groovy:&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;import&nbsp;org.mbte.gretty.httpserver.*&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;//&lt;BR&gt;//&nbsp;server.groovy&lt;BR&gt;//&nbsp;web&nbsp;service&nbsp;endpoint&nbsp;<br>
for&nbsp;activity&nbsp;requests&lt;BR&gt;//&nbsp;9/15/11:&nbsp;bprior&lt;BR&gt;//&lt;BR&gt;//&nbsp;$&nbsp;groovy&nbsp;<br>
server.groovy&lt;BR&gt;//&lt;BR&gt;//&nbsp;then&nbsp;try&nbsp;benchmark:&lt;BR&gt;//&nbsp;$&nbsp;ab&nbsp;-n&nbsp;1000&nbsp;-c&amp;nbsp;100&nbsp;&lt;A&nbsp;<br>
href=&quot;http://192.168.1.129:8080/&quot;&gt;http://192.168.1.129:8080/&lt;/A&gt;&lt;BR&gt;//&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;import&nbsp;<br>
com.rabbitmq.client.ConnectionFactory;&lt;BR&gt;import&nbsp;<br>
com.rabbitmq.client.Connection;&lt;BR&gt;import&nbsp;<br>
com.rabbitmq.client.Channel;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;@GrabResolver(name='gretty',&nbsp;<br>
root='http://groovypp.artifactoryonline.com/groovypp/libs-releases-local')&lt;BR&gt;@Grab('org.mbte.groovypp:gretty:0.4.279')&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;@Grab(group='com.rabbitmq',&nbsp;module='amqp-client',&nbsp;<br>
version='2.6.1')&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;ConnectionFactory&nbsp;factory&nbsp;=&nbsp;new&nbsp;<br>
ConnectionFactory();&lt;BR&gt;factory.setHost(&quot;dallas&quot;);&lt;BR&gt;Connection&nbsp;connection&nbsp;=&nbsp;<br>
factory.newConnection();&lt;BR&gt;Channel&nbsp;channel&nbsp;=&nbsp;<br>
connection.createChannel();&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;channel.queueDeclare(&quot;hello&quot;,&nbsp;false,&nbsp;false,&nbsp;false,&nbsp;<br>
null);&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;GrettyServer&nbsp;server&nbsp;=&nbsp;[]&lt;BR&gt;server.groovy&nbsp;=&nbsp;<br>
[&lt;BR&gt;&amp;nbsp;localAddress:&nbsp;new&nbsp;InetSocketAddress(&quot;dallas&quot;,&nbsp;8080),&lt;BR&gt;&amp;nbsp;&amp;nbsp;&nbsp;<br>
defaultHandler:&nbsp;{&lt;BR&gt;&amp;nbsp;&amp;nbsp;response.redirect&nbsp;<br>
&quot;/&quot;&lt;BR&gt;&amp;nbsp;},&lt;BR&gt;&amp;nbsp;&amp;nbsp;&nbsp;&quot;/:name&quot;:&nbsp;{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;get&nbsp;<br>
{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;String&nbsp;message&nbsp;=&nbsp;&quot;{msg:&nbsp;<br>
{actorId:\&quot;bprior\&quot;,actorType:\&quot;PERSON\&quot;}}&quot;;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;channel.basicPublish(&quot;&quot;,&nbsp;<br>
&quot;hello&quot;,&nbsp;null,&nbsp;message.getBytes());&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;//response.text&nbsp;=&nbsp;<br>
&quot;Hello&nbsp;<br>
${request.parameters['name']}&quot;&lt;BR&gt;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&amp;nbsp;}&lt;BR&gt;]&lt;BR&gt;server.start()&lt;BR&gt;println&nbsp;<br>
&quot;factory:&quot;+factory&lt;BR&gt;println&nbsp;&quot;server&nbsp;started...&quot;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;FONT&nbsp;size=2&nbsp;face=Arial&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;&lt;/BODY&gt;&lt;/HTML&gt;<br>

</tt>
