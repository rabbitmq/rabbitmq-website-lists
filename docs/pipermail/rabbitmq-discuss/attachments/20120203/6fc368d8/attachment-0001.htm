<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;&lt;div&gt;I'm&nbsp;writing&nbsp;some&nbsp;basic&nbsp;throughput&nbsp;tests&nbsp;to&nbsp;verify&nbsp;that&nbsp;RabbitMQ&nbsp;will&nbsp;scale&nbsp;to&nbsp;our&nbsp;needs&nbsp;in&nbsp;HA&nbsp;environments.&nbsp;In&nbsp;one&nbsp;scenario&nbsp;I'm&nbsp;finding&nbsp;substantial&nbsp;message&nbsp;loss.&nbsp;It&nbsp;may&nbsp;be&nbsp;Pika&nbsp;clientlib&nbsp;behavior,&nbsp;but&nbsp;even&nbsp;if&nbsp;so,&nbsp;it's&nbsp;very&nbsp;odd&nbsp;what&nbsp;I'm&nbsp;seeing.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;environment:&lt;/div&gt;&lt;ul&gt;&lt;li&gt;Ubuntu&nbsp;10.04&nbsp;with&nbsp;RabbitMQ&nbsp;2.71.&lt;/li&gt;&lt;li&gt;Broker&nbsp;instances&nbsp;are&nbsp;all&nbsp;disk&nbsp;nodes.&lt;/li&gt;&lt;li&gt;Queues&nbsp;are&nbsp;declared&nbsp;as&nbsp;durable&nbsp;and&nbsp;x-ha-policy:all&lt;/li&gt;&lt;li&gt;Clients&nbsp;are&nbsp;written&nbsp;in&nbsp;Python&nbsp;using&nbsp;Pika&nbsp;0.9.5.&lt;/li&gt;&lt;li&gt;For&nbsp;this&nbsp;test,&nbsp;no&nbsp;transactions&nbsp;or&nbsp;publisher-confirms&nbsp;are&nbsp;used.&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;The&nbsp;test&nbsp;code&nbsp;is&nbsp;extremely&nbsp;simple.&nbsp;It&nbsp;simply&nbsp;reads&nbsp;or&nbsp;writes&nbsp;messages&nbsp;(up&nbsp;to&nbsp;100,000)&nbsp;as&nbsp;quickly&nbsp;as&nbsp;it&nbsp;can,&nbsp;and&nbsp;shows&nbsp;the&nbsp;throughput&nbsp;rate&nbsp;at&nbsp;1000&nbsp;message&nbsp;intervals.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;I&nbsp;run&nbsp;my&nbsp;&quot;write&quot;&nbsp;test&nbsp;against&nbsp;a&nbsp;single&nbsp;broker&nbsp;instance,&nbsp;I&nbsp;rapidly&nbsp;write&nbsp;all&nbsp;the&nbsp;messages&nbsp;and&nbsp;after&nbsp;the&nbsp;app&nbsp;exits,&nbsp;I&nbsp;see&nbsp;100,000&nbsp;messages&nbsp;in&nbsp;the&nbsp;queue,&nbsp;as&nbsp;expected.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;However,&nbsp;if&nbsp;I&nbsp;add&nbsp;two&nbsp;more&nbsp;brokers&nbsp;to&nbsp;the&nbsp;cluster&nbsp;(such&nbsp;that&nbsp;the&nbsp;queue&nbsp;is&nbsp;now&nbsp;mirrored),&nbsp;the&nbsp;identical&nbsp;write&nbsp;test&nbsp;yields&nbsp;only&nbsp;~25K&nbsp;messages&nbsp;in&nbsp;the&nbsp;queue.&nbsp;(They&nbsp;are&nbsp;the&nbsp;first&nbsp;25K&nbsp;messages&nbsp;written,&nbsp;FWIW.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;app&nbsp;calls&nbsp;channel.disconnect()&nbsp;after&nbsp;doing&nbsp;all&nbsp;the&nbsp;writes,&nbsp;so&nbsp;I'd&nbsp;expect&nbsp;that&nbsp;it&nbsp;would&nbsp;flush&nbsp;its&nbsp;internal&nbsp;buffers&nbsp;before&nbsp;exiting.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can&nbsp;supply&nbsp;my&nbsp;entire&nbsp;app&nbsp;(about&nbsp;150&nbsp;lines&nbsp;of&nbsp;Python)&nbsp;if&nbsp;desired,&nbsp;but&nbsp;for&nbsp;now,&nbsp;here&nbsp;are&nbsp;the&nbsp;relevant&nbsp;pieces:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;def&nbsp;do_write(clientlib):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(100000):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;clientlib.write_message(QUEUENAME,&nbsp;&quot;abc_%s&quot;&nbsp;%&nbsp;(i))&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;clientlib.disconnect()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;class&nbsp;Clientlib(object):&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;connect(self,&nbsp;hostname,&nbsp;use_transactions):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.connection&nbsp;=&nbsp;pika.BlockingConnection(&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;pika.ConnectionParameters(host=hostname,&nbsp;port=5672))&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.channel&nbsp;=&nbsp;self.connection.channel()&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.use_transactions&nbsp;=&nbsp;use_transactions&nbsp;&amp;nbsp;#&nbsp;This&nbsp;is&nbsp;False&nbsp;for&nbsp;this&nbsp;test&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;write_message(self,&nbsp;queue_name,&nbsp;json_string):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.channel.basic_publish(exchange='',&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;routing_key=queue_name,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;body=json_string,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;properties=pika.BasicProperties(delivery_mode=2))&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;disconnect(self):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.connection.close()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<br>

</tt>
