<tt>
Thank&nbsp;you&nbsp;for&nbsp;the&nbsp;long&nbsp;explanation&nbsp;Matthew,&nbsp;you&nbsp;had&nbsp;already&nbsp;explained&nbsp;this&nbsp;to&nbsp;me&nbsp;once&nbsp;and&nbsp;I&nbsp;have&nbsp;a&nbsp;vague&nbsp;understanding&nbsp;of&nbsp;how&nbsp;the&nbsp;memory&nbsp;allocation&nbsp;algorithm&nbsp;works&nbsp;at&nbsp;a&nbsp;high&nbsp;level.&nbsp;I&nbsp;don&amp;#39;t&nbsp;think&nbsp;what&nbsp;we&nbsp;are&nbsp;seeing&nbsp;is&nbsp;normal&nbsp;though&nbsp;and&nbsp;can&nbsp;be&nbsp;explained&nbsp;by&nbsp;this.&nbsp;From&nbsp;what&nbsp;I&nbsp;could&nbsp;gather&nbsp;looking&nbsp;at&nbsp;the&nbsp;files&nbsp;written&nbsp;by&nbsp;rabbit&nbsp;they&nbsp;contain&nbsp;messages&nbsp;addressed&nbsp;to&nbsp;queues&nbsp;that&nbsp;are&nbsp;part&nbsp;of&nbsp;the&nbsp;&amp;quot;active&amp;quot;&nbsp;group.&nbsp;Also&nbsp;even&nbsp;if&nbsp;rabbit&nbsp;was&nbsp;to&nbsp;write&nbsp;every&nbsp;single&nbsp;message&nbsp;it&nbsp;gets&nbsp;through&nbsp;all&nbsp;the&nbsp;queues&nbsp;it&nbsp;would&nbsp;not&nbsp;result&nbsp;in&nbsp;that&nbsp;many&nbsp;writes.&nbsp;We&nbsp;don&amp;#39;t&nbsp;have&nbsp;a&nbsp;throughput&nbsp;of&nbsp;6000&nbsp;msg/sec&nbsp;which&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;writes&nbsp;iostat&nbsp;reports&nbsp;(spikes&nbsp;at&nbsp;17,000/s).&nbsp;Our&nbsp;rate&nbsp;is&nbsp;more&nbsp;like&nbsp;20&nbsp;msg/sec&nbsp;across&nbsp;all&nbsp;queues.&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&amp;#39;ll&nbsp;leave&nbsp;it&nbsp;running&nbsp;as&nbsp;is&nbsp;but&nbsp;I&amp;#39;m&nbsp;worried&nbsp;that&nbsp;like&nbsp;in&nbsp;the&nbsp;past&nbsp;it&nbsp;will&nbsp;keep&nbsp;getting&nbsp;worst&nbsp;until&nbsp;the&nbsp;machine&nbsp;simply&nbsp;can&amp;#39;t&nbsp;handle&nbsp;the&nbsp;load.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;--&lt;/div&gt;&lt;div&gt;Raphael.&lt;br&gt;&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Oct&nbsp;26,&nbsp;2011&nbsp;at&nbsp;4:01&nbsp;PM,&nbsp;Matthew&nbsp;Sackman&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthew@rabbitmq.com&quot;&gt;matthew@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
Raphael,&lt;br&gt;<br>
&lt;br&gt;<br>
Rabbit&nbsp;uses&nbsp;a&nbsp;somewhat&nbsp;sophisticated&nbsp;mechanism&nbsp;to&nbsp;allocate&nbsp;RAM&nbsp;to&lt;br&gt;<br>
queues.&nbsp;The&nbsp;allocation&nbsp;of&nbsp;RAM&nbsp;to&nbsp;queues&nbsp;is&nbsp;extremely&nbsp;difficult&nbsp;to&nbsp;do&nbsp;-&lt;br&gt;<br>
what&nbsp;are&nbsp;the&nbsp;criteria&nbsp;that&nbsp;you&nbsp;should&nbsp;use&nbsp;to&nbsp;decide&nbsp;to&nbsp;prioritise&nbsp;one&lt;br&gt;<br>
queue&nbsp;over&nbsp;another?&nbsp;Furthermore,&nbsp;if&nbsp;the&nbsp;same&nbsp;msg&nbsp;ends&nbsp;up&nbsp;in&nbsp;multiple&lt;br&gt;<br>
queues&nbsp;then&nbsp;that&nbsp;msg&nbsp;will&nbsp;exist&nbsp;just&nbsp;once&nbsp;in&nbsp;RAM&nbsp;but&nbsp;be&nbsp;shared&nbsp;by&nbsp;all&lt;br&gt;<br>
those&nbsp;queues.&nbsp;So&nbsp;it&amp;#39;s&nbsp;actually&nbsp;nonsensical&nbsp;to&nbsp;ask&nbsp;how&nbsp;much&nbsp;memory&nbsp;a&lt;br&gt;<br>
queue&nbsp;is&nbsp;using.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;approach&nbsp;we&nbsp;adopt&nbsp;results&nbsp;in&nbsp;Rabbit&nbsp;telling&nbsp;all&nbsp;the&nbsp;queues&nbsp;on&nbsp;a&nbsp;node&lt;br&gt;<br>
to&nbsp;achieve&nbsp;the&nbsp;same&nbsp;*duration*&nbsp;in&nbsp;RAM.&nbsp;I.e.&nbsp;if&nbsp;that&nbsp;duration&nbsp;is,&nbsp;for&lt;br&gt;<br>
example,&nbsp;10&nbsp;seconds,&nbsp;then&nbsp;every&nbsp;queue&nbsp;should&nbsp;ensure&nbsp;that&nbsp;given&nbsp;their&lt;br&gt;<br>
individual&nbsp;current&nbsp;ingress&nbsp;and&nbsp;egress&nbsp;rates,&nbsp;the&nbsp;number&nbsp;of&nbsp;messages&nbsp;they&lt;br&gt;<br>
hold&nbsp;in&nbsp;RAM&nbsp;does&nbsp;not&nbsp;represent&nbsp;more&nbsp;than&nbsp;10&nbsp;seconds.&nbsp;Messages&nbsp;beyond&lt;br&gt;<br>
that&nbsp;count&nbsp;will&nbsp;be&nbsp;written&nbsp;to&nbsp;disk.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;effect&nbsp;of&nbsp;this&nbsp;strategy&nbsp;is&nbsp;that&nbsp;very&nbsp;fast&nbsp;queues&nbsp;find&nbsp;that&nbsp;an&nbsp;awful&lt;br&gt;<br>
lot&nbsp;of&nbsp;messages&nbsp;make&nbsp;up&nbsp;that&nbsp;duration,&nbsp;and&nbsp;very&nbsp;slow&nbsp;queues&nbsp;find&nbsp;that&lt;br&gt;<br>
very&nbsp;few&nbsp;messages&nbsp;make&nbsp;up&nbsp;that&nbsp;duration.&nbsp;Thus&nbsp;very&nbsp;slow&nbsp;queues&nbsp;can&nbsp;end&lt;br&gt;<br>
up&nbsp;with&nbsp;a&nbsp;&amp;quot;target_ram_count&amp;quot;&nbsp;of&nbsp;0&nbsp;or&nbsp;small&nbsp;numbers,&nbsp;whilst&nbsp;fast&nbsp;queues&lt;br&gt;<br>
have&nbsp;much&nbsp;higher&nbsp;&amp;quot;target_ram_counts&amp;quot;.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;is&nbsp;desireable&nbsp;because&nbsp;a&nbsp;slow&nbsp;queue&nbsp;is&nbsp;far&nbsp;more&nbsp;likely&nbsp;to&nbsp;withstand&lt;br&gt;<br>
having&nbsp;to&nbsp;write&nbsp;everything&nbsp;to&nbsp;disk&nbsp;and&nbsp;read&nbsp;from&nbsp;disk&nbsp;than&nbsp;a&nbsp;fast&nbsp;queue&lt;br&gt;<br>
can.&nbsp;As&nbsp;I&nbsp;have&nbsp;blogged&nbsp;about,&lt;br&gt;<br>
(&nbsp;&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/blog/2011/09/24/sizing-your-rabbits/&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/blog/2011/09/24/sizing-your-rabbits/&lt;/a&gt;&nbsp;),&nbsp;as&nbsp;a&lt;br&gt;<br>
queue&nbsp;gets&nbsp;longer,&nbsp;its&nbsp;CPU-per-msg&nbsp;goes&nbsp;up.&nbsp;As&nbsp;it&nbsp;starts&nbsp;having&nbsp;to&nbsp;write&lt;br&gt;<br>
to&nbsp;disk,&nbsp;the&nbsp;CPU-per-msg&nbsp;goes&nbsp;up&nbsp;even&nbsp;faster.&nbsp;Plus&nbsp;disks&nbsp;have&nbsp;much&nbsp;lower&lt;br&gt;<br>
bandwidth&nbsp;than&nbsp;RAM.&nbsp;Thus&nbsp;a&nbsp;fast&nbsp;queue&nbsp;is&nbsp;likely&nbsp;to&nbsp;catastrophically&lt;br&gt;<br>
consume&nbsp;CPU&nbsp;and&nbsp;disk&nbsp;bandwidth&nbsp;if&nbsp;it&nbsp;starts&nbsp;getting&nbsp;forced&nbsp;out&nbsp;to&nbsp;disk.&lt;br&gt;<br>
But&nbsp;for&nbsp;a&nbsp;slow&nbsp;queue,&nbsp;this&nbsp;is&nbsp;absolutely&nbsp;fine.&lt;br&gt;<br>
&lt;br&gt;<br>
Thus&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;a&nbsp;slow&nbsp;queue&nbsp;receiving&nbsp;a&nbsp;lot&nbsp;rate&nbsp;of&nbsp;messages,&nbsp;what&lt;br&gt;<br>
is&nbsp;the&nbsp;problem&nbsp;with&nbsp;Rabbit&nbsp;deciding&nbsp;to&nbsp;write&nbsp;these&nbsp;out&nbsp;to&nbsp;disk?&nbsp;It&amp;#39;s&lt;br&gt;<br>
doing&nbsp;it&nbsp;deliberately&nbsp;because&nbsp;it&nbsp;believes&nbsp;that&nbsp;queue&nbsp;can&nbsp;cope&nbsp;with&nbsp;being&lt;br&gt;<br>
pushed&nbsp;to&nbsp;disk&nbsp;(which&nbsp;it&nbsp;seems&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;-&nbsp;ingress&nbsp;and&nbsp;egress&nbsp;rates&lt;br&gt;<br>
match),&nbsp;and&nbsp;in&nbsp;order&nbsp;to&nbsp;free&nbsp;up&nbsp;vital&nbsp;resources&nbsp;(RAM)&nbsp;for&nbsp;other&nbsp;queues&lt;br&gt;<br>
which&nbsp;can&nbsp;not&nbsp;cope&nbsp;with&nbsp;being&nbsp;sent&nbsp;to&nbsp;disk.&lt;br&gt;<br>
&lt;br&gt;<br>
Rabbit&nbsp;works&nbsp;hard&nbsp;to&nbsp;avoid&nbsp;crowbars&nbsp;-&nbsp;sudden&nbsp;events&nbsp;where&nbsp;it&nbsp;decides&nbsp;to&lt;br&gt;<br>
write&nbsp;out&nbsp;millions&nbsp;of&nbsp;messages.&nbsp;In&nbsp;order&nbsp;to&nbsp;avoid&nbsp;this&nbsp;on&nbsp;a&nbsp;queue&nbsp;that&lt;br&gt;<br>
slowly&nbsp;grows&nbsp;and&nbsp;forces&nbsp;RAM&nbsp;usage&nbsp;to&nbsp;head&nbsp;towards&nbsp;the&nbsp;limit,&nbsp;Rabbit&lt;br&gt;<br>
starts&nbsp;writing&nbsp;out&nbsp;to&nbsp;disk&nbsp;very&nbsp;early&nbsp;on&nbsp;so&nbsp;that&nbsp;the&nbsp;transition&nbsp;to&lt;br&gt;<br>
fully-on-disk&nbsp;operation&nbsp;is&nbsp;as&nbsp;smooth&nbsp;and&nbsp;unnoticable&nbsp;as&nbsp;possible.&nbsp;Thus&lt;br&gt;<br>
even&nbsp;when&nbsp;Rabbit&nbsp;is&nbsp;some&nbsp;way&nbsp;away&nbsp;from&nbsp;its&nbsp;memory&nbsp;limit,&nbsp;it&nbsp;can&nbsp;still&lt;br&gt;<br>
choose&nbsp;to&nbsp;start&nbsp;to&nbsp;push&nbsp;msgs&nbsp;out&nbsp;to&nbsp;disk&nbsp;so&nbsp;to&nbsp;reduce&nbsp;the&nbsp;chances&nbsp;of&lt;br&gt;<br>
hitting&nbsp;the&nbsp;memory&nbsp;limit&nbsp;and&nbsp;then&nbsp;realising&nbsp;that&nbsp;there&nbsp;are&nbsp;millions&nbsp;of&lt;br&gt;<br>
msgs&nbsp;that&nbsp;need&nbsp;writing&nbsp;out&nbsp;causing&nbsp;a&nbsp;massive&nbsp;burst&nbsp;to&nbsp;the&nbsp;disk&nbsp;which&amp;#39;ll&lt;br&gt;<br>
disrupt&nbsp;performance&nbsp;substantially.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;hope&nbsp;that&nbsp;helps&nbsp;explain&nbsp;a&nbsp;little&nbsp;more.&lt;br&gt;<br>
&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Matthew&lt;br&gt;<br>
&lt;/font&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
