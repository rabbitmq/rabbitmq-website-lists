<tt>
I&nbsp;have&nbsp;2&nbsp;RabbitMQ&nbsp;Nodes.&nbsp;One&nbsp;node&nbsp;is&nbsp;on&nbsp;a&nbsp;US&nbsp;server&nbsp;and&nbsp;one&nbsp;is&nbsp;on&nbsp;a&nbsp;UK&nbsp;server.&nbsp;They&nbsp;are&nbsp;both&nbsp;connected&nbsp;to&nbsp;the&nbsp;same&nbsp;VPN.&lt;br&gt;&lt;br&gt;I&amp;#39;m&nbsp;consuming&nbsp;the&nbsp;messages&nbsp;from&nbsp;the&nbsp;local&nbsp;nodes&nbsp;in&nbsp;both&nbsp;in&nbsp;the&nbsp;US&nbsp;and&nbsp;UK&nbsp;with:&lt;br&gt;&lt;br&gt;AMQP.start(&amp;#39;amqp://guest:guest@localhost:25672&amp;#39;)&nbsp;do&nbsp;|connection,&nbsp;open_ok|&lt;br&gt;<br>
<br>
 &nbsp;channel &nbsp;=&nbsp;AMQP::Channel.new(connection)&lt;br&gt; &nbsp;exchange&nbsp;=&nbsp;AMQP::Exchange.new(channel,&nbsp;&amp;quot;x-federation&amp;quot;,&nbsp;&amp;quot;xanview&amp;quot;,&nbsp;:durable&nbsp;=&amp;gt;&nbsp;true,&lt;br&gt;   &nbsp;:arguments&nbsp;=&amp;gt;&nbsp;{&amp;quot;upstream-set&amp;quot;&nbsp;=&amp;gt;&nbsp;&amp;quot;my-upstreams&amp;quot;,&nbsp;&amp;quot;type&amp;quot;&nbsp;=&amp;gt;&nbsp;&amp;quot;topic&amp;quot;,&nbsp;&amp;quot;durable&amp;quot;&nbsp;=&amp;gt;&nbsp;&amp;quot;true&amp;quot;})&lt;br&gt;<br>
<br>
 &nbsp;channel.queue(&amp;quot;testqueue_uk&amp;quot;,&nbsp;:durable&nbsp;=&amp;gt;&nbsp;true)&nbsp;do&nbsp;|queue|&nbsp;#&nbsp;testqueue_us&nbsp;in&nbsp;the&nbsp;US&lt;br&gt;   &nbsp;queue.bind(exchange,&nbsp;:routing_key&nbsp;=&amp;gt;&nbsp;&amp;#39;#&amp;#39;)&lt;br&gt;   &nbsp;queue.subscribe&nbsp;do&nbsp;|metadata,&nbsp;payload|&lt;br&gt;     &nbsp;i+=1&lt;br&gt;<br>
<br>
     &nbsp;puts&nbsp;&amp;quot;#{i}:&nbsp;Recieved&nbsp;message:&nbsp;#{payload.inspect}.&amp;quot;&lt;br&gt;   &nbsp;end&nbsp;&lt;br&gt; &nbsp;end&nbsp;&lt;br&gt;end&lt;br&gt;&lt;br&gt;I&amp;#39;m&nbsp;producing&nbsp;messages&nbsp;locally&nbsp;to&nbsp;the&nbsp;local&nbsp;nodes&nbsp;in&nbsp;both&nbsp;the&nbsp;US&nbsp;and&nbsp;UK&nbsp;with:&lt;br&gt;&lt;br&gt;EventMachine.run&nbsp;do&lt;br&gt; &nbsp;AMQP.connect(&amp;#39;amqp://guest:guest@localhost:25672&amp;#39;)&nbsp;do&nbsp;|connection,&nbsp;open_ok|&lt;br&gt;<br>
<br>
   &nbsp;channel&nbsp;=&nbsp;AMQP::Channel.new(connection)&lt;br&gt;   &nbsp;exchange&nbsp;=&nbsp;AMQP::Exchange.new(channel,&nbsp;&amp;quot;x-federation&amp;quot;,&nbsp;&amp;quot;xanview&amp;quot;,&nbsp;:durable&nbsp;=&amp;gt;&nbsp;true,&nbsp;:arguments&nbsp;=&amp;gt;&nbsp;{&amp;quot;upstream-set&amp;quot;&nbsp;=&amp;gt;&nbsp;&amp;quot;my-upstreams&amp;quot;,&nbsp;&amp;quot;type&amp;quot;&nbsp;=&amp;gt;&nbsp;&amp;quot;topic&amp;quot;,&nbsp;&amp;quot;durable&amp;quot;&nbsp;=&amp;gt;&nbsp;&amp;quot;true&amp;quot;})&lt;br&gt;<br>
<br>
   &nbsp;EventMachine.add_periodic_timer(0.1)&nbsp;do&lt;br&gt;     &nbsp;$i+=1&lt;br&gt;     &nbsp;puts&nbsp;&amp;quot;#{$i}:&nbsp;publishing&nbsp;msg&amp;quot;&lt;br&gt;     &nbsp;$exchange.publish(&amp;quot;#{$i}&nbsp;this&nbsp;is&nbsp;a&nbsp;test&nbsp;message&nbsp;from&nbsp;the&nbsp;US&amp;quot;,&nbsp;:routing_key&nbsp;=&amp;gt;&nbsp;&amp;quot;some.topic&amp;quot;,&nbsp;:persistent&nbsp;=&amp;gt;&nbsp;true&nbsp;)&lt;br&gt;<br>
<br>
   &nbsp;end&lt;br&gt; &nbsp;end&nbsp;&lt;br&gt;end&lt;br&gt;&lt;br&gt;This&nbsp;all&nbsp;seems&nbsp;to&nbsp;work&nbsp;reliably&nbsp;until&nbsp;I&nbsp;try&nbsp;to&nbsp;kill&nbsp;the&nbsp;connection:&nbsp;I&nbsp;shutdown&nbsp;the&nbsp;VPN&nbsp;and&nbsp;see&nbsp;messages&nbsp;being&nbsp;queued&nbsp;in&nbsp;queues&nbsp;called:&nbsp;&amp;quot;federation:&nbsp;xanview&nbsp;-&amp;gt;&nbsp;node2&amp;quot;&nbsp;(on&nbsp;the&nbsp;UK&nbsp;server)&nbsp;and&nbsp;&amp;quot;federation:&nbsp;xanview&nbsp;-&amp;gt;&nbsp;node1&amp;quot;&nbsp;(on&nbsp;the&nbsp;US&nbsp;server)&nbsp;as&nbsp;expected.&lt;br&gt;<br>
<br>
&lt;br&gt;However&nbsp;when&nbsp;I&nbsp;restart&nbsp;the&nbsp;VPN,&nbsp;the&nbsp;UK&nbsp;server&nbsp;has&nbsp;received&nbsp;43737&nbsp;messages&nbsp;while&nbsp;the&nbsp;US&nbsp;only&nbsp;received&nbsp;43708&nbsp;messages.&nbsp;Where&nbsp;did&nbsp;29&nbsp;messages&nbsp;disappear?&lt;br&gt;&lt;br&gt;Both&nbsp;node&nbsp;configs&nbsp;look&nbsp;like&nbsp;this&nbsp;with&nbsp;the&nbsp;only&nbsp;exception&nbsp;of&nbsp;the&nbsp;US&nbsp;connecting&nbsp;to&nbsp;federation&nbsp;on&nbsp;10.8.0.22&nbsp;and&nbsp;the&nbsp;UK&nbsp;connecting&nbsp;to&nbsp;federation&nbsp;on&nbsp;&lt;a&nbsp;href=&quot;http://10.8.0.33&quot;&gt;10.8.0.33&lt;/a&gt;:&nbsp;&lt;br&gt;<br>
<br>
&lt;br&gt;[&lt;br&gt; &nbsp;{rabbit,&nbsp;[&lt;br&gt;   &nbsp;{tcp_listeners,&nbsp;[25672]}&lt;br&gt; &nbsp;]},&lt;br&gt; &nbsp;{rabbitmq_mochiweb,&nbsp;[&lt;br&gt;   &nbsp;{listeners,       &nbsp;[{mgmt,&nbsp;[{port,&nbsp;55555}]}]},&lt;br&gt;   &nbsp;{default_listener,&nbsp;[{port,&nbsp;55550}]},&lt;br&gt;   &nbsp;{contexts,        &nbsp;[{rabbit_mgmt,&nbsp;mgmt}]}&lt;br&gt;<br>
<br>
 &nbsp;]},&lt;br&gt;&lt;br&gt;{rabbitmq_federation,&lt;br&gt;  &nbsp;[&nbsp;{exchanges,&nbsp;[[{exchange,    &nbsp;&amp;quot;xanview&amp;quot;},&lt;br&gt;                  &nbsp;{virtual_host,&nbsp;&amp;quot;/&amp;quot;},&lt;br&gt;                  &nbsp;{type,        &nbsp;&amp;quot;topic&amp;quot;},&lt;br&gt;                  &nbsp;{durable,     &nbsp;true},&lt;br&gt;<br>
<br>
                  &nbsp;{auto_delete, &nbsp;false},&lt;br&gt;                  &nbsp;{internal,    &nbsp;false},&lt;br&gt;                  &nbsp;{upstream_set,&nbsp;&amp;quot;my-upstreams&amp;quot;}]&lt;br&gt;                &nbsp;]},&lt;br&gt;    &nbsp;{upstream_sets,&nbsp;[{&amp;quot;my-upstreams&amp;quot;,&nbsp;[[{connection,&nbsp;&amp;quot;upstream-server&amp;quot;}]]}]},&lt;br&gt;<br>
<br>
    &nbsp;{connections,&nbsp;[{&amp;quot;upstream-server&amp;quot;,&nbsp;[{host,           &nbsp;&amp;quot;10.8.0.22&amp;quot;},&lt;br&gt;                                        &nbsp;{protocol,       &nbsp;&amp;quot;amqp&amp;quot;},&lt;br&gt;                                        &nbsp;{port,           &nbsp;25672},&lt;br&gt;<br>
<br>
                                        &nbsp;{virtual_host,   &nbsp;&amp;quot;/&amp;quot;},&lt;br&gt;                                        &nbsp;{username,       &nbsp;&amp;quot;guest&amp;quot;},&lt;br&gt;                                        &nbsp;{password,       &nbsp;&amp;quot;guest&amp;quot;},&lt;br&gt;<br>
<br>
                                        &nbsp;{mechanism,      &nbsp;default},&lt;br&gt;                                        &nbsp;{prefetch_count, &nbsp;1000},&lt;br&gt;                                        &nbsp;{reconnect_delay,&nbsp;5},&lt;br&gt;                                        &nbsp;{ha_policy,      &nbsp;&amp;quot;all&amp;quot;}&lt;br&gt;<br>
<br>
                                       &nbsp;]}&lt;br&gt;                  &nbsp;]},&lt;br&gt;    &nbsp;{local_username,&nbsp;&amp;quot;guest&amp;quot;},&lt;br&gt;    &nbsp;{local_nodename,&nbsp;&amp;quot;node2&amp;quot;}&lt;br&gt;  &nbsp;]&lt;br&gt; &nbsp;}&lt;br&gt;&lt;br&gt;].&lt;br&gt;&lt;br&gt;Any&nbsp;ideas&nbsp;why&nbsp;messages&nbsp;are&nbsp;lost?&nbsp;What&nbsp;could&nbsp;be&nbsp;causing&nbsp;it?&lt;br&gt;<br>
<br>
&lt;br&gt;Roman&lt;br&gt;
</tt>
