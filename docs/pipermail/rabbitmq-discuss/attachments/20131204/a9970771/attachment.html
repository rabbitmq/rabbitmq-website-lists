<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;,&lt;br&gt;&lt;br&gt;I&#39;ve&nbsp;inherited&nbsp;a&nbsp;system&nbsp;from&nbsp;a&nbsp;departing&nbsp;user&nbsp;and&nbsp;it&nbsp;seems&nbsp;to&nbsp;work,&nbsp;but&nbsp;there&nbsp;are&nbsp;intermittent&nbsp;problems&nbsp;and&nbsp;I&nbsp;feel&nbsp;that&nbsp;if&nbsp;I&nbsp;understood&nbsp;what&nbsp;was&nbsp;going&nbsp;on,&nbsp;then&nbsp;I&nbsp;could&nbsp;help&nbsp;support&nbsp;it&nbsp;better.&lt;br&gt;<br>
&lt;br&gt;Please&nbsp;note&nbsp;this&nbsp;is&nbsp;a&nbsp;complicated&nbsp;system&nbsp;using&nbsp;elastic&nbsp;cloud&nbsp;instances&nbsp;and&nbsp;load&nbsp;balancers,&nbsp;but&nbsp;the&nbsp;principle&nbsp;is&nbsp;that&nbsp;when&nbsp;a&nbsp;new&nbsp;instance&nbsp;starts,&nbsp;it&nbsp;needs&nbsp;to&nbsp;join&nbsp;the&nbsp;rabbit&nbsp;cluster.&nbsp;I&nbsp;do&nbsp;appreciate&nbsp;that&nbsp;asking&nbsp;for&nbsp;help&nbsp;when&nbsp;trying&nbsp;to&nbsp;debug&nbsp;my&nbsp;system&nbsp;may&nbsp;be&nbsp;a&nbsp;&quot;hiding&nbsp;to&nbsp;nothing&quot;&nbsp;but&nbsp;I&nbsp;just&nbsp;want&nbsp;to&nbsp;try&nbsp;and&nbsp;understand&nbsp;the&nbsp;joining&nbsp;cluster&nbsp;aspect.&lt;br&gt;<br>
&lt;br&gt;Whenever&nbsp;a&nbsp;new&nbsp;server&nbsp;instance&nbsp;starts&nbsp;a&nbsp;custom&nbsp;bash&nbsp;script&nbsp;(written&nbsp;by&nbsp;my&nbsp;company)&nbsp;runs.&nbsp;Here&nbsp;is&nbsp;the&nbsp;rabbit&nbsp;part&nbsp;of&nbsp;the&nbsp;script:&lt;br&gt;&lt;br&gt;1:&nbsp;echo&nbsp;&quot;CONFIGURING&nbsp;RABBIT&nbsp;CLUSTER&quot;&nbsp;&lt;br&gt;2:&nbsp;echo&nbsp;&quot;Stopping&nbsp;Rabbit&nbsp;on&nbsp;localhost&quot;&lt;br&gt;<br>
3:&nbsp;while&nbsp;[[&nbsp;-z&nbsp;$RABBIT_HOST&nbsp;]];&nbsp;do&lt;br&gt;4:   &nbsp;echo&nbsp;`date`&nbsp;&quot;Trying&nbsp;to&nbsp;find&nbsp;Rabbit&nbsp;Host&nbsp;to&nbsp;cluster&quot;&lt;br&gt;5:   &nbsp;sudo&nbsp;rabbitmqctl&nbsp;start_app&lt;br&gt;6:   &nbsp;sleep&nbsp;$WAIT_TIME&lt;br&gt;7:   &nbsp;sudo&nbsp;rabbitmqctl&nbsp;stop_app&lt;br&gt;8:   &nbsp;RABBIT_HOST=`curl&nbsp;-s&nbsp;-u&nbsp;guest:guest&nbsp;$PRIVATE_LOAD_BALANCER_HOSTNAME:15672/api/nodes&nbsp;|&nbsp;/home/ubuntu/bin/jq&nbsp;-r&nbsp;&#39;map(select(.running&nbsp;and&nbsp;.type&nbsp;==&nbsp;&quot;disc&quot;))&nbsp;|&nbsp;.[0].name&#39;`&lt;br&gt;<br>
9:   &nbsp;if&nbsp;[&nbsp;-n&nbsp;$RABBIT_HOST&nbsp;];&nbsp;then&lt;br&gt;10:       &nbsp;echo&nbsp;`date`&nbsp;&quot;Found&nbsp;Rabbit&nbsp;Host&quot;&lt;br&gt;11:  &nbsp;fi  &nbsp;&lt;br&gt;12:&nbsp;done&lt;br&gt;13:&lt;br&gt;14:&nbsp;echo&nbsp;`date`&nbsp;&quot;:&nbsp;Joining&nbsp;Rabbit&nbsp;with&nbsp;cluster&nbsp;on&nbsp;&quot;&nbsp;$RABBIT_HOST&lt;br&gt;15:&nbsp;sudo&nbsp;rabbitmqctl&nbsp;join_cluster&nbsp;$RABBIT_HOST&lt;br&gt;<br>
16:&nbsp;echo&nbsp;&quot;Starting&nbsp;Rabbit&nbsp;on&nbsp;localhost&quot;&lt;br&gt;17:&nbsp;sudo&nbsp;rabbitmqctl&nbsp;start_app&lt;br&gt;&lt;br&gt;Here&nbsp;are&nbsp;my&nbsp;questions:&lt;br&gt;&lt;br&gt;Line&nbsp;2&nbsp;:&nbsp;why&nbsp;do&nbsp;we&nbsp;want&nbsp;to&nbsp;&quot;stop&nbsp;rabbit&quot;?&nbsp;I&nbsp;feel&nbsp;this&nbsp;comment&nbsp;is&nbsp;very&nbsp;misleading,&nbsp;since&nbsp;RabbitMQ&nbsp;as&nbsp;an&nbsp;entity&nbsp;will&nbsp;not&nbsp;stop.&nbsp;What&nbsp;would&nbsp;&quot;stopping&nbsp;rabbit&quot;&nbsp;achieve?&lt;br&gt;<br>
&lt;br&gt;Lines&nbsp;5-7&nbsp;:&nbsp;I&nbsp;can&nbsp;see&nbsp;that&nbsp;the&nbsp;rabbit&nbsp;command&nbsp;start_app&nbsp;is&nbsp;executed,&nbsp;followed&nbsp;by&nbsp;a&nbsp;wait&nbsp;then&nbsp;a&nbsp;stop_app.&nbsp;Why?&nbsp;What&nbsp;does&nbsp;this&nbsp;achieve?&nbsp;Why&nbsp;start&nbsp;then&nbsp;stop?&nbsp;Can&nbsp;these&nbsp;steps&nbsp;just&nbsp;be&nbsp;missed&nbsp;out?&lt;br&gt;&lt;br&gt;Line&nbsp;8:&nbsp;curl&nbsp;(and&nbsp;other&nbsp;tools)&nbsp;are&nbsp;used&nbsp;to&nbsp;query&nbsp;the&nbsp;load&nbsp;balancer&nbsp;try&nbsp;and&nbsp;assign&nbsp;a&nbsp;value&nbsp;to&nbsp;the&nbsp;variable&nbsp;RABBIT_HOST.&nbsp;I&nbsp;get&nbsp;this,&nbsp;since&nbsp;we&nbsp;want&nbsp;to&nbsp;cluster&nbsp;this&nbsp;instance&nbsp;to&nbsp;the&nbsp;load&nbsp;balancer.&lt;br&gt;<br>
&lt;br&gt;Line&nbsp;12:&nbsp;If&nbsp;this&nbsp;is&nbsp;successful,&nbsp;the&nbsp;while-do&nbsp;loop&nbsp;ends&nbsp;and&nbsp;the&nbsp;command&nbsp;to&nbsp;join&nbsp;the&nbsp;cluster&nbsp;is&nbsp;issued.&lt;br&gt;&lt;br&gt;Line&nbsp;15:&nbsp;We&nbsp;join&nbsp;the&nbsp;cluster.&nbsp;Fine,&nbsp;although&nbsp;can&nbsp;we&nbsp;only&nbsp;join&nbsp;a&nbsp;cluster&nbsp;after&nbsp;&quot;stop_app&quot;&nbsp;has&nbsp;run?&lt;br&gt;<br>
&lt;br&gt;Line&nbsp;17:&nbsp;We&nbsp;run&nbsp;start_app&nbsp;again!&nbsp;Why???&nbsp;&lt;br&gt;&lt;br&gt;I&nbsp;really&nbsp;don&#39;t&nbsp;understand&nbsp;this&nbsp;whole&nbsp;stop_app&nbsp;/&nbsp;start_app&nbsp;business.&nbsp;Can&nbsp;anyone&nbsp;shed&nbsp;any&nbsp;light&nbsp;onto&nbsp;what&nbsp;this&nbsp;is&nbsp;trying&nbsp;to&nbsp;achieve?&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Phil&lt;br&gt;&lt;/div&gt;<br>

</tt>
