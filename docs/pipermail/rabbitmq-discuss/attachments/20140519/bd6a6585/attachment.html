<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;May&nbsp;19,&nbsp;2014&nbsp;at&nbsp;1:10&nbsp;PM,&nbsp;Laing,&nbsp;Michael&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:michael.laing@nytimes.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.laing@nytimes.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;br&gt;<br>
<br>
&lt;/div&gt;&lt;/div&gt;&lt;div&gt;It&#39;s&nbsp;taking&nbsp;longer&nbsp;than&nbsp;I&nbsp;thought&nbsp;:)&nbsp;Bits&nbsp;and&nbsp;pieces&nbsp;are&nbsp;in&nbsp;the&nbsp;pipeline&nbsp;-&nbsp;our&nbsp;RabbitMQ&nbsp;/&nbsp;Python&nbsp;/&nbsp;Cassandra&nbsp;benchmarks&nbsp;will&nbsp;be&nbsp;out&nbsp;there&nbsp;by&nbsp;Cassandra&nbsp;Day&nbsp;NYC,&nbsp;here&nbsp;at&nbsp;the&nbsp;NYTimes&nbsp;21&nbsp;Jun.&nbsp;A&nbsp;big&nbsp;piece&nbsp;of&nbsp;our&nbsp;rabbit_helpers&nbsp;python&nbsp;framework&nbsp;is&nbsp;included.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
<br>
&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;totally&nbsp;appreciate&nbsp;that.&nbsp;For&nbsp;about&nbsp;two&nbsp;files&nbsp;of&nbsp;Ruby&nbsp;code,&nbsp;it&nbsp;took&nbsp;me&nbsp;2-3&nbsp;weeks&nbsp;to&nbsp;get&nbsp;it&nbsp;open&nbsp;sourced.&nbsp;:)&nbsp;I&nbsp;appreciate&nbsp;the&nbsp;effort&nbsp;though!&nbsp;Looking&nbsp;forward&nbsp;to&nbsp;its&nbsp;eventual&nbsp;announcement,&nbsp;whenever&nbsp;that&nbsp;may&nbsp;be.&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;We&nbsp;let&nbsp;them&nbsp;pass&nbsp;whatever&nbsp;size&nbsp;message&nbsp;they&nbsp;want&nbsp;pretty&nbsp;much.&nbsp;If&nbsp;it&nbsp;is&nbsp;over&nbsp;a&nbsp;configurable&nbsp;size,&nbsp;currently&nbsp;10k,&nbsp;we&nbsp;try&nbsp;gzipping&nbsp;it;&nbsp;if&nbsp;it&nbsp;is&nbsp;still&nbsp;over&nbsp;another&nbsp;configurable&nbsp;amount,&nbsp;currently&nbsp;100k,&nbsp;we&nbsp;push&nbsp;it&nbsp;to&nbsp;S3&nbsp;and&nbsp;place&nbsp;a&nbsp;signed&nbsp;URL&nbsp;in&nbsp;the&nbsp;metadata.&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yeah,&nbsp;we&nbsp;already&nbsp;have&nbsp;one&nbsp;of&nbsp;our&nbsp;users&nbsp;gzipping&nbsp;before&nbsp;sending&nbsp;their&nbsp;messages.&nbsp;This&nbsp;actually&nbsp;helped&nbsp;considerably&nbsp;on&nbsp;memory&nbsp;and&nbsp;disk.&nbsp;I&nbsp;really&nbsp;like&nbsp;the&nbsp;idea&nbsp;of&nbsp;doing&nbsp;this&nbsp;on&nbsp;the&nbsp;RabbitMQ&nbsp;side.&nbsp;We&nbsp;would&nbsp;have&nbsp;to&nbsp;support&nbsp;Java&nbsp;and&nbsp;Ruby&nbsp;for&nbsp;this,&nbsp;but&nbsp;I&nbsp;think&nbsp;that&#39;s&nbsp;not&nbsp;entirely&nbsp;terrible...&nbsp;as&nbsp;we&nbsp;could&nbsp;probably&nbsp;figure&nbsp;out&nbsp;away&nbsp;to&nbsp;do&nbsp;this&nbsp;reasonably&nbsp;with&nbsp;JRuby.&nbsp;We&#39;ll&nbsp;see. &lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;proxy&nbsp;clusters&nbsp;buy&nbsp;us&nbsp;a&nbsp;lot&nbsp;by:&nbsp;forcing&nbsp;non-persistence,&nbsp;buffering&nbsp;the&nbsp;core&nbsp;clusters,&nbsp;making&nbsp;copies&nbsp;for&nbsp;message&nbsp;replay,&nbsp;allowing&nbsp;us&nbsp;to&nbsp;redirect&nbsp;the&nbsp;message&nbsp;flows&nbsp;among&nbsp;core&nbsp;clusters,&nbsp;etc.&nbsp;And&nbsp;they&nbsp;are&nbsp;relatively&nbsp;local&nbsp;to&nbsp;the&nbsp;our&nbsp;internal&nbsp;customers.&nbsp;We&nbsp;don&#39;t&nbsp;run&nbsp;any&nbsp;code&nbsp;on&nbsp;them&nbsp;other&nbsp;than&nbsp;shovels&nbsp;and&nbsp;and&nbsp;federation.&nbsp;Each&nbsp;internal&nbsp;customer&nbsp;has&nbsp;its&nbsp;own&nbsp;vhost. &lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;Yeah,&nbsp;this&nbsp;part&nbsp;is&nbsp;pretty&nbsp;key&nbsp;to&nbsp;me&nbsp;as&nbsp;well.&nbsp;Having&nbsp;a&nbsp;buffer&nbsp;for&nbsp;core&nbsp;RabbitMQ&nbsp;clusters&nbsp;is&nbsp;essential&nbsp;to&nbsp;things&nbsp;like&nbsp;seamless&nbsp;upgrade,&nbsp;cluster&nbsp;migration,&nbsp;scaling,&nbsp;configuration&nbsp;changes,&nbsp;etc.&nbsp;I&nbsp;want&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;bring&nbsp;up&nbsp;an&nbsp;entirely&nbsp;new&nbsp;cluster&nbsp;with&nbsp;all&nbsp;of&nbsp;the&nbsp;new&nbsp;changes,&nbsp;begin&nbsp;shoveling&nbsp;data&nbsp;from&nbsp;the&nbsp;old&nbsp;cluster&nbsp;to&nbsp;the&nbsp;new&nbsp;cluster,&nbsp;and&nbsp;then&nbsp;flip&nbsp;the&nbsp;proxy&nbsp;over&nbsp;to&nbsp;the&nbsp;new&nbsp;cluster&nbsp;as&nbsp;the&nbsp;shovel&nbsp;empties&nbsp;the&nbsp;old&nbsp;cluster&#39;s&nbsp;queues.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;already&nbsp;have&nbsp;the&nbsp;use&nbsp;pattern&nbsp;where&nbsp;every&nbsp;internal&nbsp;customer&nbsp;has&nbsp;its&nbsp;own&nbsp;vhost.&nbsp;If&nbsp;two&nbsp;services&nbsp;want&nbsp;to&nbsp;communicate,&nbsp;they&nbsp;are&nbsp;given&nbsp;access&nbsp;to&nbsp;the&nbsp;appropriate&nbsp;vhost&nbsp;and&nbsp;go&nbsp;from&nbsp;there&nbsp;--&nbsp;as&nbsp;well&nbsp;as&nbsp;having&nbsp;their&nbsp;own.&nbsp;Basically,&nbsp;multiple&nbsp;pub-sub&nbsp;channels&nbsp;that&nbsp;any&nbsp;two&nbsp;services&nbsp;can&nbsp;communicate&nbsp;on.&nbsp;This&nbsp;has&nbsp;worked&nbsp;out&nbsp;well,&nbsp;but&nbsp;right&nbsp;now&nbsp;they&nbsp;all&nbsp;reside&nbsp;on&nbsp;the&nbsp;same&nbsp;clusters.&nbsp;This&nbsp;is&nbsp;not&nbsp;great,&nbsp;because&nbsp;it&nbsp;means&nbsp;that&nbsp;one&nbsp;user&nbsp;can&nbsp;cause&nbsp;an&nbsp;outage&nbsp;for&nbsp;all&nbsp;services&nbsp;utilizing&nbsp;our&nbsp;RabbitMQ&nbsp;offering.&nbsp;Makes&nbsp;for&nbsp;a&nbsp;pretty&nbsp;bad&nbsp;user&nbsp;experience.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;Our&nbsp;customers&nbsp;don&#39;t&nbsp;actually&nbsp;pay&nbsp;attention&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;they&nbsp;go&nbsp;through&nbsp;a&nbsp;proxy&nbsp;-&nbsp;it&nbsp;is&nbsp;all&nbsp;&#39;fabrik&#39;&nbsp;to&nbsp;them.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That&#39;s&nbsp;exactly&nbsp;where&nbsp;I&nbsp;want&nbsp;to&nbsp;head. &lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;Our&nbsp;proxies&nbsp;are&nbsp;2-way.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;publish-to&nbsp;exchange&nbsp;in&nbsp;the&nbsp;proxy&nbsp;has&nbsp;a&nbsp;queue&nbsp;bound&nbsp;to&nbsp;it&nbsp;which&nbsp;is&nbsp;shoveled&nbsp;to&nbsp;the&nbsp;core&nbsp;cluster.&nbsp;The&nbsp;queue&nbsp;will&nbsp;buffer&nbsp;the&nbsp;messages&nbsp;until&nbsp;they&nbsp;are&nbsp;shoveled.&nbsp;The&nbsp;core&nbsp;does&nbsp;whatever.&nbsp;A&nbsp;proxy&nbsp;consume-from&nbsp;exchange&nbsp;is&nbsp;federated&nbsp;to&nbsp;the&nbsp;core&nbsp;as&nbsp;its&nbsp;upstream.&nbsp;The&nbsp;core&nbsp;publishes&nbsp;whatever&nbsp;to&nbsp;that&nbsp;exchange.&nbsp;Consumers&nbsp;create&nbsp;queues&nbsp;and&nbsp;bind&nbsp;to&nbsp;the&nbsp;proxy&nbsp;consume-from&nbsp;exchange,&nbsp;implicitly&nbsp;signaling&nbsp;the&nbsp;upstream&nbsp;to&nbsp;send&nbsp;matching&nbsp;messages.&nbsp;This&nbsp;is&nbsp;one&nbsp;way&nbsp;of&nbsp;configuring&nbsp;the&nbsp;plumbing.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
<br>
&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Fabrik&nbsp;is&nbsp;responsible&nbsp;for&nbsp;the&nbsp;creation&nbsp;of&nbsp;this&nbsp;plumbing?&nbsp;I.e.&nbsp;users&nbsp;ineract&nbsp;with&nbsp;Fabrik&nbsp;like&nbsp;a&nbsp;standard&nbsp;AMQP&nbsp;library,&nbsp;but&nbsp;when&nbsp;they,&nbsp;for&nbsp;example,&nbsp;create&nbsp;the&nbsp;exchange,&nbsp;Fabrik&nbsp;takes&nbsp;over,&nbsp;creates&nbsp;the&nbsp;publish-to&nbsp;exchange,&nbsp;proxy&nbsp;queue,&nbsp;and&nbsp;shovel&nbsp;configuration...&nbsp;then&nbsp;when&nbsp;they&nbsp;bind&nbsp;a&nbsp;queue&nbsp;to&nbsp;the&nbsp;exchange,&nbsp;Fabrik&nbsp;creates&nbsp;the&nbsp;consume-from&nbsp;exchange&nbsp;and&nbsp;federation&nbsp;configuration&nbsp;on&nbsp;the&nbsp;proxy&nbsp;and&nbsp;core?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ahhh...&nbsp;and&nbsp;you&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;maintain&nbsp;state,&nbsp;because&nbsp;all&nbsp;of&nbsp;the&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;RabbitMQ.&nbsp;Each&nbsp;new&nbsp;client&nbsp;that&nbsp;comes&nbsp;up&nbsp;is&nbsp;going&nbsp;to&nbsp;attempt&nbsp;to&nbsp;create&nbsp;the&nbsp;appropriate&nbsp;queues/exchanges,&nbsp;but&nbsp;these&nbsp;become&nbsp;noops&nbsp;because&nbsp;they&nbsp;already&nbsp;exist.&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;Event-driven,&nbsp;no&nbsp;MxN,&nbsp;fast,&nbsp;reliable,&nbsp;flexible,&nbsp;cheap.&nbsp;We&nbsp;have&nbsp;2&nbsp;forms&nbsp;of&nbsp;persistence:&nbsp;S3&nbsp;for&nbsp;big&nbsp;messages,&nbsp;and&nbsp;Cassandra&nbsp;for&nbsp;memory.&nbsp;So&nbsp;most&nbsp;of&nbsp;the&nbsp;fabrik&nbsp;focuses&nbsp;on&nbsp;the&nbsp;routing&nbsp;of&nbsp;small&nbsp;messages.&nbsp;Cassandra&nbsp;lets&nbsp;us&nbsp;&#39;replay&#39;&nbsp;messages&nbsp;selectively:&nbsp;show&nbsp;me&nbsp;the&nbsp;messages&nbsp;I&nbsp;missed,&nbsp;give&nbsp;me&nbsp;the&nbsp;messages&nbsp;sent&nbsp;yesterday&nbsp;during&nbsp;a&nbsp;5&nbsp;minute&nbsp;period,&nbsp;give&nbsp;me&nbsp;the&nbsp;latest&nbsp;10&nbsp;messages&nbsp;on&nbsp;this&nbsp;topic,&nbsp;etc.&nbsp;And&nbsp;it&nbsp;lets&nbsp;us&nbsp;gather&nbsp;event&nbsp;messages&nbsp;for&nbsp;near&nbsp;real-time&nbsp;and&nbsp;longitudinal&nbsp;analysis. &lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;do&nbsp;you&nbsp;persist&nbsp;every&nbsp;messages&nbsp;sent&nbsp;via&nbsp;Fabrik?&nbsp;I&nbsp;think&nbsp;we&nbsp;could&nbsp;do&nbsp;this&nbsp;for&nbsp;some&nbsp;things,&nbsp;but&nbsp;we&nbsp;would&nbsp;have&nbsp;to&nbsp;have&nbsp;TTLs&nbsp;for&nbsp;others.&nbsp;We&nbsp;could&nbsp;even&nbsp;have&nbsp;our&nbsp;persistence&nbsp;store&nbsp;honor&nbsp;TTLs&nbsp;that&nbsp;are&nbsp;assigned&nbsp;during&nbsp;queue&nbsp;creation,&nbsp;I&nbsp;think.&nbsp;I&nbsp;wonder&nbsp;if&nbsp;Cassandra&nbsp;has&nbsp;something&nbsp;built&nbsp;in&nbsp;that&nbsp;would&nbsp;make&nbsp;this&nbsp;easy&nbsp;for&nbsp;us.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;That&#39;s&nbsp;what&nbsp;we&nbsp;do.&nbsp;Actually&nbsp;we&nbsp;store&nbsp;the&nbsp;json-like&nbsp;stuff&nbsp;in&nbsp;the&nbsp;headers&nbsp;property&nbsp;as&nbsp;a&nbsp;&#39;metadata&#39;&nbsp;item.&nbsp;The&nbsp;body&nbsp;is&nbsp;opaque&nbsp;to&nbsp;the&nbsp;fabrik&nbsp;-&nbsp;we&nbsp;treat&nbsp;it&nbsp;as&nbsp;binary.&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;like&nbsp;this.&nbsp;So&nbsp;you&nbsp;have&nbsp;a&nbsp;consistent&nbsp;message&nbsp;format&nbsp;which,&nbsp;when&nbsp;simplified,&nbsp;resmebles:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;{&nbsp;metadata:&nbsp;{},&nbsp;body:&nbsp;&quot;&quot;&nbsp;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;like&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;again.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
