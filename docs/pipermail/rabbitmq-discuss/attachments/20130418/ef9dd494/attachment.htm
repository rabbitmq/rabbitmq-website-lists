<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;&lt;div&gt;&lt;span&gt;&lt;/span&gt;Hi,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;span&gt;I&nbsp;would&nbsp;like&nbsp;to&nbsp;consider&nbsp;a&nbsp;change&nbsp;to&nbsp;the&nbsp;shovel&nbsp;plugin,&nbsp;to&nbsp;allow&nbsp;the&nbsp;shovel&nbsp;to&nbsp;failover&nbsp;more&nbsp;predictably&nbsp;against&nbsp;the&nbsp;list&nbsp;of&nbsp;broker&nbsp;endpoints&nbsp;in&nbsp;the&nbsp;rabbitmq_shovel&nbsp;configuration.&nbsp;&amp;nbsp;Essentially,&nbsp;the&nbsp;idea&nbsp;is&nbsp;to&nbsp;try&nbsp;each&nbsp;endpoint&nbsp;in&nbsp;order&nbsp;of&nbsp;the&nbsp;declaration,&nbsp;and&nbsp;to&nbsp;use&nbsp;the&nbsp;first&nbsp;endpoint&nbsp;to&nbsp;which&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;made,&nbsp;instead&nbsp;of&nbsp;selecting&nbsp;an&nbsp;endpoint&nbsp;at&nbsp;random.&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;This&nbsp;does&nbsp;slightly&nbsp;violate&nbsp;the&nbsp;spirit&nbsp;of&nbsp;Erlang's&nbsp;&quot;let&nbsp;it&nbsp;fail&quot;&nbsp;philosophy,&nbsp;and&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;if&nbsp;the&nbsp;random&nbsp;endpoint&nbsp;selection&nbsp;in&nbsp;the&nbsp;current&nbsp;code&nbsp;is&nbsp;really&nbsp;more&nbsp;designed&nbsp;for&nbsp;clustered&nbsp;environments.&nbsp;&amp;nbsp;Perhaps&nbsp;it&nbsp;would&nbsp;make&nbsp;more&nbsp;sense&nbsp;to&nbsp;make&nbsp;the&nbsp;iterative&nbsp;failover&nbsp;strategy&nbsp;an&nbsp;&quot;opt-in&quot;&nbsp;feature,&nbsp;if&nbsp;not&nbsp;simply&nbsp;for&nbsp;the&nbsp;sake&nbsp;of&nbsp;backwards-compatibility.&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;I&nbsp;am&nbsp;providing&nbsp;a&nbsp;patch,&nbsp;but&nbsp;not&nbsp;suggesting&nbsp;that&nbsp;this&nbsp;actual&nbsp;change&nbsp;go&nbsp;into&nbsp;production&nbsp;code,&nbsp;as&nbsp;I&nbsp;really&nbsp;did&nbsp;the&nbsp;change&nbsp;for&nbsp;testing&nbsp;purposes.&nbsp;&amp;nbsp;I'm&nbsp;really&nbsp;more&nbsp;interested&nbsp;in&nbsp;whether&nbsp;others&nbsp;would&nbsp;find&nbsp;the&nbsp;patch&nbsp;useful,&nbsp;and&nbsp;whether&nbsp;there&nbsp;would&nbsp;be&nbsp;a&nbsp;way&nbsp;for&nbsp;us&nbsp;to&nbsp;fold&nbsp;a&nbsp;feature&nbsp;like&nbsp;this&nbsp;into&nbsp;the&nbsp;shovel.&nbsp;&amp;nbsp;If&nbsp;there&nbsp;is&nbsp;interest,&nbsp;I&nbsp;would&nbsp;be&nbsp;happy&nbsp;to&nbsp;contribute&nbsp;something&nbsp;more&nbsp;production-worthy,&nbsp;for&nbsp;review.&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;Thanks,&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;-Fred&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;Here&nbsp;is&nbsp;the&nbsp;patch&nbsp;(based&nbsp;off&nbsp;3.0.1&nbsp;tag):&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;#&nbsp;HG&nbsp;changeset&nbsp;patch&lt;/span&gt;&lt;br&gt;&lt;span&gt;#&nbsp;User&nbsp;Fred&nbsp;Dushin&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:fred@dushin.net&quot;&nbsp;x-apple-data-detectors=&quot;true&quot;&nbsp;x-apple-data-detectors-result=&quot;0/0&quot;&gt;fred@dushin.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;#&nbsp;Date&amp;nbsp;&lt;a&nbsp;href=&quot;tel:1366295416&quot;&nbsp;x-apple-data-detectors=&quot;true&quot;&nbsp;x-apple-data-detectors-result=&quot;0/1&quot;&gt;1366295416&lt;/a&gt;&amp;nbsp;14400&lt;/span&gt;&lt;br&gt;&lt;span&gt;#&nbsp;Branch&nbsp;fdushin-failover&lt;/span&gt;&lt;br&gt;&lt;span&gt;#&nbsp;Node&nbsp;ID&nbsp;0436511e18908fd8d38d5f56a1a3b0e5af807206&lt;/span&gt;&lt;br&gt;&lt;span&gt;#&nbsp;Parent&nbsp;&amp;nbsp;cdf80b9ac08a61de718314baaff13f8ca5740c4c&lt;/span&gt;&lt;br&gt;&lt;span&gt;Added&nbsp;changes&nbsp;to&nbsp;make&nbsp;failover&nbsp;to&nbsp;additional&nbsp;endpoints&nbsp;deterministic.&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;diff&nbsp;--git&nbsp;a/src/rabbit_shovel_worker.erl&nbsp;b/src/rabbit_shovel_worker.erl&lt;/span&gt;&lt;br&gt;&lt;span&gt;---&nbsp;a/src/rabbit_shovel_worker.erl&lt;/span&gt;&lt;br&gt;&lt;span&gt;+++&nbsp;b/src/rabbit_shovel_worker.erl&lt;/span&gt;&lt;br&gt;&lt;span&gt;@@&nbsp;-53,9&nbsp;+53,9&nbsp;@@&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;random:seed(A,&nbsp;B,&nbsp;C),&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;#shovel{sources&nbsp;=&nbsp;Sources,&nbsp;destinations&nbsp;=&nbsp;Destinations}&nbsp;=&nbsp;Config,&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;{InboundConn,&nbsp;InboundChan,&nbsp;InboundParams}&nbsp;=&lt;/span&gt;&lt;br&gt;&lt;span&gt;-&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;make_conn_and_chan(Sources#endpoint.amqp_params),&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;make_conn_and_chan(lists:reverse(Sources#endpoint.amqp_params)),&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;{OutboundConn,&nbsp;OutboundChan,&nbsp;OutboundParams}&nbsp;=&lt;/span&gt;&lt;br&gt;&lt;span&gt;-&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;make_conn_and_chan(Destinations#endpoint.amqp_params),&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;make_conn_and_chan(lists:reverse(Destinations#endpoint.amqp_params)),&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;create_resources(InboundChan,&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Sources#endpoint.resource_declarations),&lt;/span&gt;&lt;br&gt;&lt;span&gt;@@&nbsp;-240,11&nbsp;+240,27&nbsp;@@&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_channel:call(Chan,&nbsp;#'channel.flow'{active&nbsp;=&nbsp;Active}),&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;ok.&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;-make_conn_and_chan(AmqpParams)&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;-&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;AmqpParam&nbsp;=&nbsp;lists:nth(random:uniform(length(AmqpParams)),&nbsp;AmqpParams),&lt;/span&gt;&lt;br&gt;&lt;span&gt;+amqp_params_to_string(#amqp_params_network{host=Host,&nbsp;port=Port,&nbsp;virtual_host=VirtualHost})&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;io_lib:format(&quot;Host:&nbsp;~p&nbsp;Port:&nbsp;~p&nbsp;VirtualHost:&nbsp;~p&quot;,&nbsp;[Host,&nbsp;Port,&nbsp;VirtualHost]);&lt;/span&gt;&lt;br&gt;&lt;span&gt;+amqp_params_to_string(#amqp_params_direct{virtual_host=VirtualHost})&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;io_lib:format(&quot;(Direct)&nbsp;Virtual&nbsp;Host:&nbsp;~p&quot;,&nbsp;[VirtualHost]).&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&lt;/span&gt;&lt;br&gt;&lt;span&gt;+make_conn_and_chan([])&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;throw(no_endpoints);&lt;/span&gt;&lt;br&gt;&lt;span&gt;+make_conn_and_chan([AmqpParam|Rest])&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;get_conn_and_chan(AmqpParam)&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;catch&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Type:Reason&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;error_logger:error_msg(&quot;Shovel&nbsp;failed&nbsp;to&nbsp;connect&nbsp;to&nbsp;~s:&nbsp;~p:~p&quot;,&nbsp;[amqp_params_to_string(AmqpParam),&nbsp;Type,&nbsp;Reason]),&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;make_conn_and_chan(Rest)&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;end.&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&lt;/span&gt;&lt;br&gt;&lt;span&gt;+get_conn_and_chan(AmqpParam)&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;{ok,&nbsp;Conn}&nbsp;=&nbsp;amqp_connection:start(AmqpParam),&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;link(Conn),&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;{ok,&nbsp;Chan}&nbsp;=&nbsp;amqp_connection:open_channel(Conn),&lt;/span&gt;&lt;br&gt;&lt;span&gt;+&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;error_logger:info_msg(&quot;Shovel&nbsp;connected&nbsp;to&nbsp;~s.&quot;,&nbsp;[amqp_params_to_string(AmqpParam)]),&lt;/span&gt;&lt;br&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;{Conn,&nbsp;Chan,&nbsp;AmqpParam}.&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;create_resources(Chan,&nbsp;Declarations)&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
