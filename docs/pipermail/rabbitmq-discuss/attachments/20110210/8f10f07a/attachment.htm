<tt>
&lt;HTML&gt;<br>
&lt;HEAD&gt;<br>
&lt;TITLE&gt;Synchronous&nbsp;publish&nbsp;with&nbsp;C&nbsp;client&lt;/TITLE&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
&lt;FONT&nbsp;FACE=&quot;Calibri,&nbsp;Verdana,&nbsp;Helvetica,&nbsp;Arial&quot;&gt;&lt;SPAN&nbsp;STYLE='font-size:11pt'&gt;I&nbsp;know&nbsp;that&nbsp;publish&nbsp;is&nbsp;asynchronous,&nbsp;but&nbsp;from&nbsp;other&nbsp;threads&nbsp;I&amp;#8217;ve&nbsp;read&nbsp;I&nbsp;thought&nbsp;that&nbsp;selecting&nbsp;the&nbsp;channel&nbsp;for&nbsp;a&nbsp;transaction,&nbsp;calling&nbsp;publish&nbsp;and&nbsp;then&nbsp;calling&nbsp;commit&nbsp;could&nbsp;be&nbsp;used&nbsp;to&nbsp;accomplish&nbsp;it.&nbsp;&amp;nbsp;I&amp;#8217;ve&nbsp;tried&nbsp;doing&nbsp;this&nbsp;in&nbsp;my&nbsp;C&nbsp;code&nbsp;and&nbsp;have&nbsp;been&nbsp;unable&nbsp;to&nbsp;get&nbsp;it&nbsp;to&nbsp;work.&nbsp;&amp;nbsp;I&amp;#8217;m&nbsp;using&nbsp;the&nbsp;amq.direct&nbsp;exchange&nbsp;and&nbsp;sending&nbsp;to&nbsp;a&nbsp;nonexistent&nbsp;queue&nbsp;using&nbsp;the&nbsp;mandatory&nbsp;and&nbsp;immediate&nbsp;flags.&nbsp;&amp;nbsp;It&nbsp;appears&nbsp;as&nbsp;though&nbsp;the&nbsp;message&nbsp;is&nbsp;being&nbsp;silently&nbsp;dropped&nbsp;by&nbsp;the&nbsp;server&nbsp;though.&nbsp;&amp;nbsp;I&amp;#8217;m&nbsp;running&nbsp;rabbitmQ&nbsp;version&nbsp;2.2.&nbsp;&amp;nbsp;Here&nbsp;is&nbsp;the&nbsp;code&nbsp;I&amp;#8217;m&nbsp;using.&nbsp;&amp;nbsp;Please&nbsp;let&nbsp;me&nbsp;know&nbsp;of&nbsp;any&nbsp;errors&nbsp;there&nbsp;might&nbsp;be&nbsp;in&nbsp;my&nbsp;logic&nbsp;or&nbsp;code.&nbsp;&amp;nbsp;All&nbsp;I&nbsp;get&nbsp;is&lt;BR&gt;<br>
&lt;BR&gt;<br>
[*]&nbsp;Sending&nbsp;some&nbsp;message&lt;BR&gt;<br>
&lt;BR&gt;<br>
outputted&nbsp;when&nbsp;I&nbsp;run&nbsp;this.&nbsp;&amp;nbsp;I&nbsp;would&nbsp;expect&nbsp;to&nbsp;see&nbsp;the&nbsp;&amp;#8216;Error&nbsp;committingtx&amp;#8217;&nbsp;print&nbsp;if&nbsp;the&nbsp;queue&nbsp;does&nbsp;not&nbsp;exist&nbsp;though.&lt;BR&gt;<br>
&lt;BR&gt;<br>
int&nbsp;main(int&nbsp;argc,&nbsp;char&nbsp;*argv[])&lt;BR&gt;<br>
{&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;int&nbsp;rc;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;int&nbsp;sockfd;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;uint16_t&nbsp;channel&nbsp;=&nbsp;1;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_rpc_reply_t&nbsp;reply;&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_connection_state_t&nbsp;conn&nbsp;=&nbsp;amqp_new_connection();&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//Connect&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sockfd&nbsp;=&nbsp;amqp_open_socket(&amp;quot;localhost&amp;quot;,&nbsp;5672);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if&nbsp;(sockfd&nbsp;&amp;lt;&nbsp;0)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf(&amp;quot;Error&nbsp;connecting&nbsp;to&nbsp;localhost:5672\n&amp;quot;);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return&nbsp;1;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_set_sockfd(conn,&nbsp;sockfd);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_login(conn,&nbsp;&amp;quot;/&amp;quot;&nbsp;/*&nbsp;vhost&nbsp;*/,&nbsp;0&nbsp;/*&nbsp;channel_max&nbsp;*/,&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;131072&nbsp;/*&nbsp;frame_max&nbsp;*/,&nbsp;0&nbsp;/*&nbsp;heartbeat&nbsp;*/,&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;AMQP_SASL_METHOD_PLAIN,&nbsp;&amp;quot;guest&amp;quot;,&nbsp;&amp;quot;guest&amp;quot;);&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//Create&nbsp;a&nbsp;channel&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_channel_open(conn,&nbsp;channel);&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//Set&nbsp;up&nbsp;tx&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_tx_select(conn,&nbsp;channel);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;reply&nbsp;=&nbsp;amqp_get_rpc_reply(conn);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if&nbsp;(reply.reply_type&nbsp;!=&nbsp;AMQP_RESPONSE_NORMAL)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf(&amp;quot;Error&nbsp;selecting&nbsp;tx\n&amp;quot;);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return&nbsp;1;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//Send&nbsp;&amp;nbsp;message&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;const&nbsp;char&nbsp;*message&nbsp;=&nbsp;&amp;quot;some&nbsp;message&amp;quot;;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf(&amp;quot;[*]&nbsp;Sending&nbsp;%s\n&amp;quot;,&nbsp;message);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_basic_properties_t&nbsp;props;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;memset(&amp;amp;props,&nbsp;0x00,&nbsp;sizeof(props));&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;props.delivery_mode&nbsp;=&nbsp;2;&nbsp;//persistent&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;rc&nbsp;=&nbsp;amqp_basic_publish(conn,&nbsp;channel,&nbsp;amqp_cstring_bytes(&amp;quot;amq.direct&amp;quot;),&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_cstring_bytes(&amp;quot;nonexistent_queue&amp;quot;),&nbsp;1&nbsp;/*mandatory*/,&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;1&nbsp;/*immediate*/,&nbsp;&amp;amp;props,&nbsp;amqp_cstring_bytes(message));&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if&nbsp;(rc&nbsp;!=&nbsp;0)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;char&nbsp;*errstr&nbsp;=&nbsp;amqp_error_string(-rc);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf(&amp;quot;Error&nbsp;publishing:&nbsp;%s\n&amp;quot;,&nbsp;errstr);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;free(errstr);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//Now&nbsp;send&nbsp;commit&nbsp;and&nbsp;see&nbsp;if&nbsp;it&nbsp;worked&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_tx_commit(conn,&nbsp;channel);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;reply&nbsp;=&nbsp;amqp_get_rpc_reply(conn);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if&nbsp;(reply.reply_type&nbsp;!=&nbsp;AMQP_RESPONSE_NORMAL)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf(&amp;quot;Error&nbsp;committing&nbsp;tx\n&amp;quot;);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return&nbsp;1;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;reply&nbsp;=&nbsp;amqp_channel_close(conn,&nbsp;channel,&nbsp;AMQP_REPLY_SUCCESS);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if&nbsp;(reply.reply_type&nbsp;!=&nbsp;AMQP_RESPONSE_NORMAL)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf(&amp;quot;Error&nbsp;closing&nbsp;channel\n&amp;quot;);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_connection_close(conn,&nbsp;AMQP_REPLY_SUCCESS);&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;amqp_destroy_connection(conn);&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return&nbsp;0;&lt;BR&gt;<br>
}&lt;BR&gt;<br>
&lt;BR&gt;<br>
Cheers,&lt;BR&gt;<br>
Shane&lt;BR&gt;<br>
&lt;/SPAN&gt;&lt;/FONT&gt;<br>
&lt;pre&gt;<br>
<br>
<br>
***************<br>
This&nbsp;e-mail&nbsp;and&nbsp;any&nbsp;files&nbsp;transmitted&nbsp;with&nbsp;it&nbsp;may&nbsp;contain&nbsp;confidential&nbsp;and/or&nbsp;proprietary&nbsp;information.&nbsp;It&nbsp;is&nbsp;intended&nbsp;solely&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;the&nbsp;individual&nbsp;or&nbsp;entity&nbsp;who&nbsp;is&nbsp;the&nbsp;intended&nbsp;recipient.&nbsp;Unauthorized&nbsp;use&nbsp;of&nbsp;this&nbsp;information&nbsp;is&nbsp;prohibited.&nbsp;If&nbsp;you&nbsp;have&nbsp;received&nbsp;this&nbsp;in&nbsp;error,&nbsp;please&nbsp;contact&nbsp;the&nbsp;sender&nbsp;by&nbsp;replying&nbsp;to&nbsp;this&nbsp;message&nbsp;and&nbsp;delete&nbsp;this&nbsp;material&nbsp;from&nbsp;any&nbsp;system&nbsp;it&nbsp;may&nbsp;be&nbsp;on.<br>
***************<br>
&lt;/pre&gt;&lt;/BODY&gt;<br>
&lt;/HTML&gt;<br>
<br>

</tt>
