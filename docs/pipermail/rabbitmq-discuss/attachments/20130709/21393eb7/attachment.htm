<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;On&nbsp;9&nbsp;July&nbsp;2013&nbsp;07:30,&nbsp;Haster&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:haster2004@yandex.ru&quot;&nbsp;target=&quot;_blank&quot;&gt;haster2004@yandex.ru&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
first&nbsp;thread&nbsp;creates&nbsp;all&nbsp;things&nbsp;(connection,&nbsp;channels&nbsp;to&nbsp;queue&nbsp;and&lt;br&gt;<br>
exchanges),&nbsp;call&nbsp;basic.consume&nbsp;and&nbsp;start&nbsp;new&nbsp;thread&nbsp;that&nbsp;reads&nbsp;messages&nbsp;from&lt;br&gt;<br>
queue&nbsp;and&nbsp;processes&nbsp;them...&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;principle,&nbsp;this&nbsp;is&nbsp;fine.&nbsp;I&nbsp;would&nbsp;still&nbsp;not&nbsp;do&nbsp;it,&nbsp;myself:&nbsp;instead,&nbsp;I&nbsp;would&nbsp;never&nbsp;let&nbsp;a&nbsp;connection&nbsp;&amp;quot;cross&nbsp;over&amp;quot;&nbsp;between&nbsp;threads.&nbsp;But&nbsp;that&amp;#39;s&nbsp;probably&nbsp;just&nbsp;superstitious&nbsp;of&nbsp;me&nbsp;:-)&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
But&nbsp;first&nbsp;thread&nbsp;can&nbsp;call&nbsp;one&nbsp;method,&nbsp;that&nbsp;add&nbsp;some&nbsp;binds&nbsp;and&nbsp;maybe&nbsp;declare&lt;br&gt;<br>
new&nbsp;exchanges&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Aha!&nbsp;OK.&nbsp;Yes,&nbsp;that&nbsp;is&nbsp;probably&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;problem.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Try&nbsp;making&nbsp;sure&nbsp;that&nbsp;each&nbsp;thread&nbsp;has&nbsp;its&nbsp;own&nbsp;private&nbsp;connection&nbsp;to&nbsp;the&nbsp;broker.&nbsp;Perhaps&nbsp;the&nbsp;thread&nbsp;that&nbsp;only&nbsp;occasionally&nbsp;needs&nbsp;to&nbsp;use&nbsp;a&nbsp;connection&nbsp;could&nbsp;create&nbsp;it&nbsp;when&nbsp;needed,&nbsp;and&nbsp;destroy&nbsp;it&nbsp;when&nbsp;it&nbsp;is&nbsp;finished.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Connections&nbsp;*must*&nbsp;not&nbsp;be&nbsp;shared&nbsp;between&nbsp;threads[1].&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
But&nbsp;can&nbsp;it&nbsp;be&nbsp;the&nbsp;root&nbsp;of&nbsp;problem?&lt;br&gt;<br>
I&nbsp;use&nbsp;separate&nbsp;channel&nbsp;for&nbsp;each&nbsp;used&nbsp;exchange&nbsp;and&nbsp;queue.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;is&nbsp;*no*&nbsp;locking&nbsp;in&nbsp;librabbitmq,&nbsp;so&nbsp;*any*&nbsp;use&nbsp;of&nbsp;a&nbsp;connection&nbsp;across&nbsp;threads&nbsp;requires&nbsp;you&nbsp;to&nbsp;do&nbsp;the&nbsp;locking&nbsp;manually.&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
And&nbsp;one&nbsp;thing&nbsp;for&nbsp;thinking.&nbsp;My&nbsp;program&nbsp;crashes&nbsp;only&nbsp;on&nbsp;HP-UX&nbsp;11.31,&nbsp;on&lt;br&gt;<br>
windows,&nbsp;Solaris&nbsp;and&nbsp;Linux&nbsp;Red&nbsp;Hat&nbsp;it&nbsp;works&nbsp;well&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;guess&nbsp;is&nbsp;that&nbsp;this&nbsp;is&nbsp;just&nbsp;chance.&nbsp;If&nbsp;two&nbsp;threads&nbsp;are&nbsp;sharing&nbsp;a&nbsp;single&nbsp;librabbitmq&nbsp;connection&nbsp;without&nbsp;any&nbsp;mutexing,&nbsp;then&nbsp;the&nbsp;bug&nbsp;exists&nbsp;on&nbsp;all&nbsp;platforms,&nbsp;even&nbsp;if&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;manifest&nbsp;deterministically.&lt;br&gt;<br>
&lt;br&gt;Regards,&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;Tony&lt;br&gt;&lt;br&gt;[1]&nbsp;Unless&nbsp;you&nbsp;do&nbsp;some&nbsp;locking&nbsp;yourself,&nbsp;which&nbsp;is&nbsp;difficult&nbsp;and&nbsp;error-prone,&nbsp;and&nbsp;not&nbsp;something&nbsp;I&amp;#39;d&nbsp;recommend.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;Tony&nbsp;Garnock-Jones&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:tonygarnockjones@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;tonygarnockjones@gmail.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://homepages.kcbbs.gen.nz/tonyg/&quot;&nbsp;target=&quot;_blank&quot;&gt;http://homepages.kcbbs.gen.nz/tonyg/&lt;/a&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
