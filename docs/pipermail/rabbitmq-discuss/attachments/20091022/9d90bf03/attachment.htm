<tt>
I&nbsp;am&nbsp;not&nbsp;quite&nbsp;sure&nbsp;on&nbsp;the&nbsp;function&nbsp;evaluation&nbsp;order,&nbsp;but&nbsp;it&nbsp;might&nbsp;help&nbsp;to&nbsp;know&nbsp;that&nbsp;&amp;lt;0.159.0&amp;gt;&nbsp;is&nbsp;the&nbsp;disk_log&nbsp;process:&lt;br&gt;&lt;br&gt;&amp;lt;0.159.0&amp;gt;            &nbsp;disk_log:init/2                      &nbsp;1597  &nbsp;879997   &nbsp;0&lt;br&gt;                     &nbsp;disk_log:loop/1                         &nbsp;4             &nbsp;&lt;br&gt;<br>
&lt;br&gt;_steve&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Oct&nbsp;22,&nbsp;2009&nbsp;at&nbsp;5:47&nbsp;PM,&nbsp;Stephen&nbsp;Day&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:sjaday@gmail.com&quot;&gt;sjaday@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
I&nbsp;won&amp;#39;t&nbsp;bore&nbsp;you&nbsp;with&nbsp;all&nbsp;the&nbsp;output,&nbsp;but&nbsp;I&nbsp;tracked&nbsp;down&nbsp;the&nbsp;binary&nbsp;usage&nbsp;to&nbsp;these&nbsp;two&nbsp;processes:&lt;br&gt;&lt;br&gt;[{Pid1,&nbsp;_Info,&nbsp;_Bin},&nbsp;{Pid2,&nbsp;_Info2,&nbsp;_Bin2}&nbsp;|&nbsp;Other&nbsp;]&nbsp;=&nbsp;[{P,<br>
process_info(P),&nbsp;BinInfo}&nbsp;||&nbsp;{P,&nbsp;{binary,&nbsp;BinInfo}}&nbsp;&amp;lt;-&nbsp;[{P,<br>
process_info(P,&nbsp;binary)}&nbsp;||&nbsp;P&nbsp;&amp;lt;-&nbsp;processes()],&nbsp;length(BinInfo)&nbsp;&amp;gt;<br>
100000].&lt;br&gt;&lt;br&gt;&amp;lt;0.157.0&amp;gt;            &nbsp;gen:init_it/6                     &nbsp;1682835 &nbsp;1873131   &nbsp;0&lt;br&gt;                     &nbsp;gen_server2:process_next_msg/8         &nbsp;13             &nbsp;&lt;br&gt;&amp;lt;0.158.0&amp;gt;            &nbsp;rabbit_persister:init/1          &nbsp;19590700&nbsp;29789397   &nbsp;0&lt;br&gt;<br>
<br>
rabbit_persister     &nbsp;gen_server2:process_next_msg/8         &nbsp;13             &nbsp;&lt;br&gt;&lt;br&gt;I&nbsp;tried&nbsp;your&nbsp;suggestion&nbsp;to&nbsp;free&nbsp;memory&nbsp;and&nbsp;check,&nbsp;but&nbsp;it&nbsp;looks&nbsp;most&nbsp;was&nbsp;held&nbsp;up&nbsp;in&nbsp;the&nbsp;persister:&lt;br&gt;&lt;br&gt;35&amp;gt;&nbsp;M&nbsp;=&nbsp;[{erlang:garbage_collect(P),&nbsp;memory(total)}&nbsp;||&nbsp;P&nbsp;&amp;lt;-&nbsp;erlang:processes()].&lt;br&gt;<br>
<br>
&lt;br&gt;51&amp;gt;&nbsp;[{P,Mem}&nbsp;||&nbsp;{Mem,&nbsp;P}&nbsp;&amp;lt;-&nbsp;lists:zip(&nbsp;[Me||{true,&nbsp;Me}&nbsp;&amp;lt;-&nbsp;M],&nbsp;processes()),&nbsp;Mem&nbsp;&amp;lt;&nbsp;842757048].&lt;br&gt;[{&amp;lt;0.148.0&amp;gt;,842753448},&lt;br&gt; {&amp;lt;0.149.0&amp;gt;,842700248},&lt;br&gt; {&amp;lt;0.150.0&amp;gt;,842700248},&lt;br&gt; {&amp;lt;0.151.0&amp;gt;,842700248},&lt;br&gt;<br>
<br>
 {&amp;lt;0.152.0&amp;gt;,842697224},&lt;br&gt; {&amp;lt;0.154.0&amp;gt;,842697792},&lt;br&gt; {&amp;lt;0.155.0&amp;gt;,842724104},&lt;br&gt; {&amp;lt;0.156.0&amp;gt;,842712824},&lt;br&gt; {&amp;lt;0.157.0&amp;gt;,825951032},&lt;br&gt; {&amp;lt;0.158.0&amp;gt;,602886872},&lt;br&gt; {&amp;lt;0.159.0&amp;gt;,345002144},&lt;br&gt;<br>
<br>
 {&amp;lt;0.177.0&amp;gt;,345002144},&lt;br&gt; {&amp;lt;0.178.0&amp;gt;,345002144},&lt;br&gt; {&amp;lt;0.179.0&amp;gt;,345002144},&lt;br&gt; {&amp;lt;0.180.0&amp;gt;,345002144},&lt;br&gt; {&amp;lt;0.181.0&amp;gt;,345002144},&lt;br&gt; {&amp;lt;0.182.0&amp;gt;,345002144},&lt;br&gt; {&amp;lt;0.183.0&amp;gt;,345002144},&lt;br&gt;<br>
<br>
 {&amp;lt;0.184.0&amp;gt;,345002144},&lt;br&gt; {&amp;lt;0.245.0&amp;gt;,345000624},&lt;br&gt; {&amp;lt;0.247.0&amp;gt;,345001520},&lt;br&gt; {&amp;lt;0.248.0&amp;gt;,344996984},&lt;br&gt; {&amp;lt;0.249.0&amp;gt;,344995464},&lt;br&gt; {&amp;lt;0.250.0&amp;gt;,344995512},&lt;br&gt; {&amp;lt;0.252.0&amp;gt;,344996416},&lt;br&gt;<br>
<br>
 {&amp;lt;0.253.0&amp;gt;,344991880},&lt;br&gt; {&amp;lt;0.254.0&amp;gt;,344991928},&lt;br&gt; {&amp;lt;0.261.0&amp;gt;,...},&lt;br&gt; {...}|...]&lt;br&gt;&lt;br&gt;So&nbsp;it&nbsp;looks&nbsp;like&nbsp;the&nbsp;large&nbsp;chunks&nbsp;are&nbsp;held&nbsp;up&nbsp;between&nbsp;between&nbsp;gen_server2&nbsp;and&nbsp;rabbit_persister.&lt;br&gt;&lt;br&gt;_steve&lt;div&gt;<br>
&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Oct&nbsp;22,&nbsp;2009&nbsp;at&nbsp;4:24&nbsp;PM,&nbsp;Matthias&nbsp;Radestock&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthias@lshift.net&quot;&nbsp;target=&quot;_blank&quot;&gt;matthias@lshift.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
<br>
Stephen,&lt;div&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Stephen&nbsp;Day&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
(rabbit@vs-dfw-ctl11)5&amp;gt;&nbsp;[erlang:garbage_collect(P)&nbsp;||&nbsp;P&nbsp;&amp;lt;-&nbsp;erlang:processes()].&lt;br&gt;<br>
[true,true,true,true,true,true,true,true,true,true,true,&lt;br&gt;<br>
 true,true,true,true,true,true,true,true,true,true,true,true,&lt;br&gt;<br>
 true,true,true,true,true,true|...]&lt;br&gt;<br>
&lt;br&gt;<br>
(rabbit@vs-dfw-ctl11)6&amp;gt;&nbsp;memory().&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[{total,145833144},&lt;br&gt;<br>
 {processes,50900752},&lt;br&gt;<br>
 {processes_used,50896864},&lt;br&gt;<br>
 {system,94932392},&lt;br&gt;<br>
 {atom,514765},&lt;br&gt;<br>
 {atom_used,488348},&lt;br&gt;<br>
 {binary,24622512},&lt;br&gt;<br>
 {code,3880064},&lt;br&gt;<br>
 {ets,64745716}]&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;really&nbsp;cut&nbsp;down&nbsp;on&nbsp;usage,&nbsp;so&nbsp;its&nbsp;likely&nbsp;that&nbsp;the&nbsp;binary&nbsp;gc&nbsp;is&nbsp;falling&nbsp;behind&nbsp;rabbits&nbsp;requirements.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Agreed.&lt;div&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
How&nbsp;do&nbsp;I&nbsp;track&nbsp;down&nbsp;the&nbsp;uncollected&nbsp;binary&nbsp;heap&nbsp;usage&nbsp;to&nbsp;a&nbsp;process?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Binaries&nbsp;are&nbsp;shared&nbsp;between&nbsp;processes&nbsp;and&nbsp;ref&nbsp;counted,&nbsp;so&nbsp;no&nbsp;single&nbsp;process&nbsp;owns&nbsp;them.&nbsp;There&nbsp;is&nbsp;a&nbsp;process_info&nbsp;item&nbsp;called&nbsp;&amp;#39;binary&amp;#39;&nbsp;that&nbsp;provides&nbsp;information&nbsp;on&nbsp;the&nbsp;binaries&nbsp;referenced&nbsp;by&nbsp;a&nbsp;process,&nbsp;but&nbsp;I&amp;#39;ve&nbsp;never&nbsp;looked&nbsp;at&nbsp;that&nbsp;myself,&nbsp;so&nbsp;don&amp;#39;t&nbsp;know&nbsp;how&nbsp;useful&nbsp;the&nbsp;contained&nbsp;info&nbsp;is.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
One&nbsp;thing&nbsp;you&nbsp;could&nbsp;try&nbsp;is&nbsp;to&nbsp;run&nbsp;the&nbsp;above&nbsp;garbage_collect&nbsp;code&nbsp;interleaved&nbsp;with&nbsp;the&nbsp;memory&nbsp;reporting&nbsp;code&nbsp;to&nbsp;identify&nbsp;which&nbsp;process&nbsp;results&nbsp;in&nbsp;the&nbsp;biggest&nbsp;drop&nbsp;in&nbsp;memory&nbsp;memory&nbsp;usage&nbsp;when&nbsp;gc&amp;#39;ed.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;<br>
Matthias.&lt;br&gt;<br>
&lt;/font&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
