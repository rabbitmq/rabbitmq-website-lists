<tt>
&gt;From&nbsp;your&nbsp;suggestions,&nbsp;it&nbsp;looks&nbsp;like&nbsp;I&nbsp;was&nbsp;on&nbsp;the&nbsp;right&nbsp;track.&nbsp;Output&nbsp;is&nbsp;inline.&lt;br&gt;&lt;br&gt;Moved&nbsp;to&nbsp;rabbitmq-discuss.&lt;br&gt;&lt;br&gt;And&nbsp;again,&nbsp;your&nbsp;guidance&nbsp;is&nbsp;greatly&nbsp;appreciated.&lt;br&gt;&lt;br&gt;-Stephen&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Oct&nbsp;22,&nbsp;2009&nbsp;at&nbsp;1:51&nbsp;AM,&nbsp;Matthias&nbsp;Radestock&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthias@lshift.net&quot;&gt;matthias@lshift.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;Stephen,&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Stephen&nbsp;Day&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
After&nbsp;running&nbsp;for&nbsp;few&nbsp;days,&nbsp;limiting&nbsp;queue&nbsp;size&nbsp;on&nbsp;producer&nbsp;side&nbsp;(no&nbsp;memory&nbsp;backpressure),&nbsp;I&nbsp;have&nbsp;noticed&nbsp;that&nbsp;RabbitMQ&nbsp;has&nbsp;restarted&nbsp;several&nbsp;times&nbsp;due&nbsp;to&nbsp;out&nbsp;of&nbsp;memory&nbsp;errors.&nbsp;Currently,&nbsp;I&nbsp;have&nbsp;about&nbsp;150,000&nbsp;persistent&nbsp;messages&nbsp;being&nbsp;consumed&nbsp;by&nbsp;16&nbsp;clients&nbsp;with&nbsp;qos.&nbsp;Over&nbsp;about&nbsp;2-6&nbsp;hours,&nbsp;the&nbsp;RSS&nbsp;and&nbsp;VM&nbsp;size&nbsp;of&nbsp;the&nbsp;erlang&nbsp;process&nbsp;grows&nbsp;unbounded,&nbsp;without&nbsp;the&nbsp;producers&nbsp;adding&nbsp;any&nbsp;messages&nbsp;to&nbsp;the&nbsp;queue&nbsp;(externally&nbsp;limited&nbsp;to&nbsp;100,000),&nbsp;and&nbsp;the&nbsp;erlang&nbsp;process&nbsp;crashes.&nbsp;I&nbsp;am&nbsp;running&nbsp;version&nbsp;1.7.0.&lt;br&gt;<br>
<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Memory&nbsp;consumption&nbsp;can&nbsp;increase&nbsp;due&nbsp;to&nbsp;gc&nbsp;effects,&nbsp;but&nbsp;not&nbsp;without&nbsp;bounds.&lt;br&gt;<br>
&lt;br&gt;<br>
How&nbsp;many&nbsp;messages&nbsp;does&nbsp;rabbit&nbsp;think&nbsp;there&nbsp;are&nbsp;in&nbsp;the&nbsp;queues&nbsp;-&nbsp;check&nbsp;with&nbsp;&amp;#39;rabbitmqctl&nbsp;list_queues&amp;#39;&nbsp;-&nbsp;and&nbsp;how&nbsp;big&nbsp;are&nbsp;the&nbsp;messages?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;$&nbsp;~/rabbitmq/sbin/rabbitmqctl&nbsp;list_queues&nbsp;name&nbsp;messages&nbsp;messages_unacknowledged&nbsp;consumers&nbsp;memory&lt;br&gt;<br>
<br>
Listing&nbsp;queues&nbsp;...&lt;br&gt;<br>
&amp;lt;redacted&amp;gt;&nbsp;  &nbsp;0   &nbsp;0   &nbsp;0   &nbsp;2376&lt;br&gt;<br>
&amp;lt;redacted&amp;gt;   &nbsp;27   &nbsp;0   &nbsp;0   &nbsp;27572&lt;br&gt;<br>
&amp;lt;redacted&amp;gt;   &nbsp;0   &nbsp;0   &nbsp;1   &nbsp;2992&lt;br&gt;<br>
&amp;lt;redacted&amp;gt;   &nbsp;149917   &nbsp;16   &nbsp;16   &nbsp;71106232&lt;br&gt;&lt;br&gt;The&nbsp;messages&nbsp;are&nbsp;no&nbsp;bigger&nbsp;than&nbsp;512&nbsp;bytes,&nbsp;but&nbsp;vary&nbsp;in&nbsp;size.&lt;br&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
<br>
&lt;br&gt;<br>
How&nbsp;large&nbsp;is&nbsp;the&nbsp;persister&nbsp;log?&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;$&nbsp;du&nbsp;-b&nbsp;mnesia/rabbit/*&lt;br&gt;162  &nbsp; mnesia/rabbit/DECISION_TAB.LOG&lt;br&gt;98  &nbsp; mnesia/rabbit/LATEST.LOG&lt;br&gt;8  &nbsp; mnesia/rabbit/rabbit_config.DCD&lt;br&gt;995  &nbsp; mnesia/rabbit/rabbit_durable_exchange.DCD&lt;br&gt;<br>
606  &nbsp; mnesia/rabbit/rabbit_durable_queue.DCD&lt;br&gt;976  &nbsp; mnesia/rabbit/rabbit_durable_queue.DCL&lt;br&gt;1396  &nbsp; mnesia/rabbit/rabbit_durable_route.DCD&lt;br&gt;16720  &nbsp; mnesia/rabbit/rabbit_durable_route.DCL&lt;br&gt;82515919  &nbsp; mnesia/rabbit/rabbit_persister.LOG&lt;br&gt;<br>
82526910  &nbsp; mnesia/rabbit/rabbit_persister.LOG.previous&lt;br&gt;4  &nbsp; mnesia/rabbit/rabbit_serial&lt;br&gt;134  &nbsp; mnesia/rabbit/rabbit_user.DCD&lt;br&gt;192  &nbsp; mnesia/rabbit/rabbit_user_permission.DCD&lt;br&gt;133  &nbsp; mnesia/rabbit/rabbit_vhost.DCD&lt;br&gt;<br>
12383  &nbsp; mnesia/rabbit/schema.DAT&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Now,&nbsp;I&nbsp;was&nbsp;under&nbsp;the&nbsp;impression&nbsp;that&nbsp;this&nbsp;memory&nbsp;problem&nbsp;was&nbsp;due&nbsp;to&nbsp;the&nbsp;number&nbsp;of&nbsp;messages&nbsp;being&nbsp;added,&nbsp;but&nbsp;this&nbsp;may&nbsp;not&nbsp;be&nbsp;the&nbsp;case.&nbsp;What&nbsp;information&nbsp;do&nbsp;you&nbsp;need&nbsp;to&nbsp;troubleshoot&nbsp;this?&nbsp;Are&nbsp;there&nbsp;any&nbsp;erlang&nbsp;tools,&nbsp;similar&nbsp;to&nbsp;valgrind,&nbsp;that&nbsp;can&nbsp;track&nbsp;down&nbsp;this&nbsp;memory&nbsp;usage?&lt;br&gt;<br>
<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
There&nbsp;are&nbsp;plenty&nbsp;of&nbsp;tools&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&amp;#39;s&nbsp;going&nbsp;on&nbsp;in&nbsp;a&nbsp;running&nbsp;Erlang&nbsp;system.&nbsp;You&nbsp;need&nbsp;to&nbsp;know&nbsp;a&nbsp;fair&nbsp;bit&nbsp;about&nbsp;Erlang&nbsp;to&nbsp;use&nbsp;them&nbsp;though.&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;a&nbsp;starting&nbsp;point,&nbsp;remsh&nbsp;into&nbsp;rabbit&nbsp;with&nbsp;&amp;quot;erl&nbsp;-sname&nbsp;sh&nbsp;-remsh&nbsp;rabbit@&amp;lt;host&amp;gt;&amp;quot;&nbsp;(you&amp;#39;ll&nbsp;need&nbsp;to&nbsp;run&nbsp;this&nbsp;as&nbsp;the&nbsp;&amp;#39;rabbitmq&amp;#39;&nbsp;user&nbsp;in&nbsp;a&nbsp;typical&nbsp;rabbit&nbsp;installation)&nbsp;and&nbsp;on&nbsp;the&nbsp;prompt&nbsp;type&lt;br&gt;<br>
&nbsp; memory().&lt;br&gt;<br>
which&nbsp;will&nbsp;tell&nbsp;you&nbsp;at&nbsp;a&nbsp;coarse-grain&nbsp;level&nbsp;where&nbsp;the&nbsp;memory&nbsp;has&nbsp;gone.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;Here&nbsp;is&nbsp;the&nbsp;memory()&nbsp;output:&lt;br&gt;&lt;br&gt;(rabbit@vs-dfw-ctl11)1&amp;gt;&nbsp;memory().&lt;br&gt;[{total,1015558480},&lt;br&gt; {processes,161498128},&lt;br&gt;<br>
 {processes_used,161494240},&lt;br&gt; {system,854060352},&lt;br&gt; {atom,516217},&lt;br&gt; {atom_used,492146},&lt;br&gt; {binary,778446312},&lt;br&gt; {code,3860276},&lt;br&gt; {ets,70066180}]&lt;br&gt;&lt;br&gt;Right&nbsp;now,&nbsp;the&nbsp;system&nbsp;is&nbsp;using&nbsp;around&nbsp;1GB&nbsp;of&nbsp;memory,&nbsp;mostly&nbsp;concentrated&nbsp;in&nbsp;binary&nbsp;allocation.&nbsp;I&nbsp;was&nbsp;looking&nbsp;at&nbsp;this&nbsp;yesterday&nbsp;as&nbsp;well,&nbsp;and&nbsp;the&nbsp;process&nbsp;memory&nbsp;hasn&amp;#39;t&nbsp;changed&nbsp;much.&lt;br&gt;<br>
 &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;<br>
Matthias.&lt;br&gt;&lt;/font&gt;<br>
PS:&nbsp;could&nbsp;we&nbsp;move&nbsp;this&nbsp;discussion&nbsp;onto&nbsp;rabbitmq-discuss,&nbsp;please?&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
