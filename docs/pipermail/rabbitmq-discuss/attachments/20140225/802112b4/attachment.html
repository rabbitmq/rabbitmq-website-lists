<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;hello,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;I'm&nbsp;using&nbsp;Publish&nbsp;Confirms&nbsp;and&nbsp;am&nbsp;trying&nbsp;to&nbsp;achieve&nbsp;zero<br>
message&nbsp;loss&nbsp;when&nbsp;the&nbsp;Rabbit&nbsp;MQ&nbsp;instances&nbsp;go&nbsp;down.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;I&nbsp;have&nbsp;2&nbsp;instances&nbsp;of&nbsp;Rabbit&nbsp;MQ,&nbsp;clustered&nbsp;with&nbsp;all<br>
Queues&nbsp;mirrored&nbsp;on&nbsp;my&nbsp;local&nbsp;desktop.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;I&nbsp;think&nbsp;use&nbsp;Publish&nbsp;Confirms&nbsp;to&nbsp;send&nbsp;a&nbsp;batch&nbsp;of&nbsp;about<br>
50,000&nbsp;messages.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;I've&nbsp;implemented&nbsp;duplicate&nbsp;message&nbsp;detection&nbsp;in&nbsp;my<br>
consumer,&nbsp;and&nbsp;implemented&nbsp;the&nbsp;storage&nbsp;of&nbsp;all&nbsp;messages&nbsp;sent&nbsp;on&nbsp;the&nbsp;publisher.&nbsp;I<br>
wired&nbsp;in&nbsp;the&nbsp;following&nbsp;events&nbsp;and&nbsp;remove&nbsp;the&nbsp;messages&nbsp;as&nbsp;Acks&nbsp;come&nbsp;in&nbsp;i.e.:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.model.BasicAcks&nbsp;-=&nbsp;this.MessageAcknowledged;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.model.BasicNacks&nbsp;-=&nbsp;this.MessageNotAcknowledged;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.model.BasicReturn&nbsp;-=&nbsp;this.MessageReturned;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.model.FlowControl&nbsp;-=&nbsp;this.FlowControlChanged;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.model.CallbackException&nbsp;-=&nbsp;ReportCallbackException;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;Fairly&nbsp;straight&nbsp;forward&nbsp;I&nbsp;thought.&nbsp;&nbsp;On&nbsp;the&nbsp;consumer&nbsp;side&nbsp;I&nbsp;did&nbsp;from&nbsp;the&nbsp;QOS<br>
setting&nbsp;for&nbsp;consuming&nbsp;messages.&nbsp;&nbsp;I&nbsp;do<br>
this&nbsp;in&nbsp;a&nbsp;tight&nbsp;loop&nbsp;like&nbsp;so:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
consumerModel&nbsp;=&nbsp;this.connection.CreateModel();&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
consumerModel.BasicQos(0,&nbsp;10000,&nbsp;false);&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<br>
consumer&nbsp;=&nbsp;new&nbsp;QueueingBasicConsumer(consumerModel);&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<br>
consumerTag&nbsp;=&nbsp;consumerModel.BasicConsume(&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.queueName,false,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
consumer);&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
while&nbsp;(true)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
BasicDeliverEventArgs&nbsp;item&nbsp;=&nbsp;null;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
try&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
{&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
if&nbsp;(!consumer.Queue.Dequeue(3000,&nbsp;out&nbsp;item))&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
{&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(null&nbsp;==&nbsp;item)<br>
continue;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
}&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;do&nbsp;stuff&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
consumerModel.BasicAck(item.DeliveryTag,&nbsp;false);&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
}&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;My&nbsp;first&nbsp;finding&nbsp;was&nbsp;that&nbsp;performance&nbsp;was&nbsp;very&nbsp;slow.&nbsp;&nbsp;with&nbsp;250&nbsp;byte&nbsp;messages,&nbsp;I'm&nbsp;getting&nbsp;about&nbsp;500<br>
to&nbsp;600&nbsp;msg/sec&nbsp;delivered.&nbsp;&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;Regardless&nbsp;though,&nbsp;my&nbsp;testing&nbsp;was&nbsp;around<br>
recover-ability.&nbsp;&nbsp;What&nbsp;I'm&nbsp;doing&nbsp;is<br>
sending&nbsp;groups&nbsp;of&nbsp;messages...about&nbsp;50,000&nbsp;at&nbsp;time.&nbsp;&nbsp;Then&nbsp;while&nbsp;they&nbsp;are&nbsp;sending,&nbsp;I&nbsp;take&nbsp;down&nbsp;both<br>
instances&nbsp;of&nbsp;my&nbsp;Rabbit&nbsp;MQ&nbsp;cluster&nbsp;to&nbsp;simulate&nbsp;a&nbsp;failure&nbsp;like&nbsp;so&nbsp;using<br>
Powershell:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&amp;.\rabbitmqctl.bat&nbsp;-n&nbsp;cluster1&nbsp;stop_app&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&amp;.\rabbitmqctl.bat&nbsp;-n&nbsp;cluster2&nbsp;stop_app&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;My&nbsp;results&nbsp;are&nbsp;always&nbsp;the&nbsp;same.&nbsp;&nbsp;There&nbsp;appear&nbsp;to&nbsp;be&nbsp;several&nbsp;thousand&nbsp;messages<br>
that&nbsp;I&nbsp;never&nbsp;received&nbsp;Acks&nbsp;for&nbsp;still&nbsp;in&nbsp;my&nbsp;internal&nbsp;queue&nbsp;on&nbsp;the&nbsp;Publisher<br>
side.&nbsp;&nbsp;There&nbsp;are&nbsp;also&nbsp;pending&nbsp;messages&nbsp;to<br>
be&nbsp;delivered&nbsp;that&nbsp;written&nbsp;to&nbsp;disk...that&nbsp;I&nbsp;don't&nbsp;expect&nbsp;my&nbsp;consumer&nbsp;to&nbsp;get<br>
until&nbsp;one&nbsp;of&nbsp;the&nbsp;cluster&nbsp;instances&nbsp;start&nbsp;back&nbsp;up.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;Hence,&nbsp;I&nbsp;start&nbsp;up&nbsp;the&nbsp;main&nbsp;cluster&nbsp;instance&nbsp;followed&nbsp;by<br>
the&nbsp;second.&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;First&nbsp;observation&nbsp;is&nbsp;that&nbsp;the&nbsp;messages&nbsp;pending&nbsp;in&nbsp;the<br>
Rabbit&nbsp;MQ&nbsp;queue&nbsp;do&nbsp;indeed&nbsp;get&nbsp;delivered&nbsp;to&nbsp;the&nbsp;consumer.&nbsp;&nbsp;great.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;I&nbsp;then&nbsp;resubmit&nbsp;all&nbsp;the&nbsp;messages&nbsp;in&nbsp;my&nbsp;internal&nbsp;queue&nbsp;on<br>
the&nbsp;publisher&nbsp;side.&nbsp;&nbsp;The&nbsp;result&nbsp;is&nbsp;always<br>
the&nbsp;same.&nbsp;&nbsp;I'm&nbsp;always&nbsp;3&nbsp;or&nbsp;4&nbsp;messages<br>
short!&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;I&nbsp;then&nbsp;retested&nbsp;without&nbsp;a&nbsp;cluster&nbsp;and&nbsp;without&nbsp;shutting<br>
down.&nbsp;&nbsp;After&nbsp;my&nbsp;test&nbsp;run..and&nbsp;after&nbsp;the<br>
consumer&nbsp;successfully&nbsp;gets&nbsp;all&nbsp;the&nbsp;messages&nbsp;I&nbsp;always&nbsp;find&nbsp;the&nbsp;same&nbsp;thing.<br>
sometimes&nbsp;I&nbsp;have&nbsp;thousands&nbsp;of&nbsp;unacknowledged&nbsp;messages&nbsp;left&nbsp;in&nbsp;my&nbsp;publisher<br>
queue.&nbsp;&nbsp;I'd&nbsp;come&nbsp;back&nbsp;5&nbsp;minutes<br>
later....still&nbsp;there.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;In&nbsp;short,&nbsp;2&nbsp;serious&nbsp;issues&nbsp;I'm&nbsp;seeing.&nbsp;&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;First&nbsp;one&nbsp;is&nbsp;that&nbsp;Rabbit&nbsp;MQ&nbsp;is&nbsp;losing&nbsp;a&nbsp;few&nbsp;messages&nbsp;if<br>
both&nbsp;servers&nbsp;in&nbsp;the&nbsp;cluster&nbsp;are&nbsp;shut&nbsp;down.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;Second&nbsp;one,&nbsp;Acks/Nacks&nbsp;seem&nbsp;to&nbsp;just&nbsp;get&nbsp;lost&nbsp;by&nbsp;Rabbit<br>
MQ.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;Third&nbsp;one...only&nbsp;happens&nbsp;now&nbsp;again...The&nbsp;producer<br>
actually&nbsp;receives&nbsp;Acks&nbsp;for&nbsp;delivery&nbsp;tags/messages&nbsp;that&nbsp;don't&nbsp;exist&nbsp;in&nbsp;the&nbsp;its<br>
internal&nbsp;queue.&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;Fourth&nbsp;one....when&nbsp;both&nbsp;servers&nbsp;go&nbsp;down,&nbsp;sometimes,&nbsp;but<br>
not&nbsp;always,&nbsp;the&nbsp;consumer&nbsp;will&nbsp;not&nbsp;throw&nbsp;an&nbsp;exception&nbsp;when&nbsp;it&nbsp;tries&nbsp;to&nbsp;read&nbsp;the<br>
message&nbsp;in&nbsp;the&nbsp;while&nbsp;loop.&nbsp;i.e&nbsp;:&nbsp;if&nbsp;(!consumer.Queue.Dequeue(3000,&nbsp;out<br>
item)).&nbsp;&nbsp;The&nbsp;item&nbsp;comes&nbsp;back&nbsp;null,&nbsp;but&nbsp;If<br>
I&nbsp;look&nbsp;in&nbsp;the&nbsp;debugger,&nbsp;the&nbsp;consumer's&nbsp;and&nbsp;connection's&nbsp;isopen&nbsp;property&nbsp;is<br>
true...and&nbsp;the&nbsp;CloseReason&nbsp;is&nbsp;null.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;Does&nbsp;anyone&nbsp;have&nbsp;any&nbsp;ideas&nbsp;or&nbsp;have&nbsp;experienced&nbsp;this?&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;How&nbsp;I'm&nbsp;sending&nbsp;the&nbsp;message&nbsp;is&nbsp;pretty&nbsp;straight&nbsp;forward:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
messageProperties.MessageId&nbsp;=&nbsp;System.Guid.NewGuid().ToString()&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
lock&nbsp;(this.activeMessagesLock)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
{&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;deliveryTag&nbsp;=<br>
0UL;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deliveryTag&nbsp;=<br>
this.model.NextPublishSeqNo;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.model.BasicPublish(&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.exchangeName,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
message.Header.Topic,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.properties.Durable,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;immediate,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
messageProperties,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;body);&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
this.activeMessages[deliveryTag]&nbsp;=&nbsp;message;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
}&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;I'm&nbsp;using&nbsp;the&nbsp;message&nbsp;ID&nbsp;to&nbsp;add&nbsp;to&nbsp;a&nbsp;concurrentdictionary<br>
collection&nbsp;on&nbsp;the&nbsp;consumer&nbsp;side&nbsp;so&nbsp;I&nbsp;can&nbsp;detect&nbsp;duplicates.&nbsp;&nbsp;The&nbsp;message&nbsp;is&nbsp;added&nbsp;to&nbsp;this&nbsp;duplicate<br>
detection&nbsp;dictionary&nbsp;before&nbsp;the&nbsp;Ack&nbsp;is&nbsp;sent&nbsp;back&nbsp;to&nbsp;Rabbit&nbsp;MQ&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;Any&nbsp;help&nbsp;would&nbsp;be&nbsp;appreciated.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;by&nbsp;the&nbsp;way,&nbsp;if&nbsp;I&nbsp;use&nbsp;the&nbsp;TxCommit&nbsp;and&nbsp;TxRollback....I<br>
don't&nbsp;have&nbsp;any&nbsp;issues&nbsp;on&nbsp;resending&nbsp;by&nbsp;resending&nbsp;everything&nbsp;in&nbsp;the&nbsp;producer's<br>
internal&nbsp;queue.&nbsp;Message&nbsp;loss&nbsp;only&nbsp;seems&nbsp;to&nbsp;happen&nbsp;with&nbsp;PublishConfirms&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoPlainText&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;&lt;/div&gt;
</tt>
