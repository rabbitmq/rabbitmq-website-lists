<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Replying&nbsp;inline&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Oct&nbsp;8,&nbsp;2013&nbsp;at&nbsp;4:03&nbsp;PM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;br&gt;<br>
You&nbsp;are&nbsp;correct&nbsp;that&nbsp;the&nbsp;synchronous&nbsp;writing&nbsp;hurts&nbsp;performance&nbsp;-&nbsp;but&nbsp;it&amp;#39;s&nbsp;not&nbsp;quite&nbsp;enough&nbsp;to&nbsp;just&nbsp;switch&nbsp;to&nbsp;async&nbsp;calls.&nbsp;The&nbsp;test&nbsp;suite&nbsp;starts&nbsp;failing,&nbsp;for&nbsp;a&nbsp;start&nbsp;:-)&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;there&nbsp;is&nbsp;a&nbsp;bit&nbsp;of&nbsp;work&nbsp;needed&nbsp;here&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;messages&nbsp;to&nbsp;the&nbsp;writer&nbsp;get&nbsp;flushed&nbsp;before&nbsp;the&nbsp;socket&nbsp;gets&nbsp;closed.&nbsp;I&amp;#39;ve&nbsp;started&nbsp;work&nbsp;on&nbsp;this,&nbsp;and&nbsp;it&nbsp;should&nbsp;end&nbsp;up&nbsp;in&nbsp;3.2.0.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ah,&nbsp;I&nbsp;was&nbsp;afraid&nbsp;things&nbsp;might&nbsp;not&nbsp;be&nbsp;so&nbsp;obviously&nbsp;easy.&nbsp;I&nbsp;am&nbsp;glad&nbsp;you&nbsp;sorted&nbsp;out&nbsp;the&nbsp;more&nbsp;specific&nbsp;parts&nbsp;:)&nbsp;Thanks&nbsp;for&nbsp;the&nbsp;fixes.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
<br>
&amp;lt;snip&nbsp;re&nbsp;channels&nbsp;manager&amp;gt;&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
This&nbsp;is&nbsp;reasonable&nbsp;-&nbsp;but&nbsp;of&nbsp;course&nbsp;it&amp;#39;s&nbsp;a&nbsp;more&nbsp;substantial&nbsp;change,&nbsp;unlikely&nbsp;to&nbsp;happen&nbsp;particularly&nbsp;soon.&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;we&nbsp;are&nbsp;to&nbsp;do&nbsp;that,&nbsp;it&nbsp;is&nbsp;better&nbsp;to&nbsp;re-imagine&nbsp;the&nbsp;whole&nbsp;way&nbsp;the&nbsp;stack&nbsp;works&nbsp;I&nbsp;think.&nbsp;There&nbsp;are&nbsp;other&nbsp;parts&nbsp;of&nbsp;the&nbsp;Erlang&nbsp;client&nbsp;that&nbsp;could&nbsp;do&nbsp;with&nbsp;less&nbsp;misery.&nbsp;I&nbsp;fail&nbsp;to&nbsp;see&nbsp;the&nbsp;need&nbsp;for&nbsp;supervisor2&nbsp;and&nbsp;gen_server2&nbsp;in&nbsp;the&nbsp;code&nbsp;at&nbsp;all&nbsp;for&nbsp;instance. &lt;/div&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
The&nbsp;writer&nbsp;process&nbsp;inside&nbsp;RabbitMQ&nbsp;is&nbsp;something&nbsp;I&nbsp;wanted&nbsp;to&nbsp;optimize&nbsp;as&lt;br&gt;<br>
well,&nbsp;so&nbsp;I&nbsp;tried&nbsp;changing&nbsp;two&nbsp;things&nbsp;in&nbsp;it.&nbsp;First,&nbsp;I&nbsp;avoided&nbsp;a&lt;br&gt;<br>
recomputation&nbsp;of&nbsp;`iolist_size/1`&nbsp;on&nbsp;every&nbsp;received&nbsp;message.&nbsp;And&nbsp;I&nbsp;just&lt;br&gt;<br>
dropped&nbsp;keeping&nbsp;a&nbsp;small&nbsp;1414&nbsp;byte&nbsp;packet&nbsp;size&nbsp;around.&nbsp;The&nbsp;rationale&nbsp;is&lt;br&gt;<br>
this:&nbsp;either&nbsp;we&nbsp;will&nbsp;be&nbsp;running&nbsp;at&nbsp;a&nbsp;high&nbsp;pace&nbsp;in&nbsp;the&nbsp;writer&nbsp;code&nbsp;and&lt;br&gt;<br>
then&nbsp;easily&nbsp;exceed&nbsp;the&nbsp;1414&nbsp;byte&nbsp;packet&nbsp;size.&nbsp;In&nbsp;this&nbsp;case,&nbsp;bumping&nbsp;it&lt;br&gt;<br>
to&nbsp;64&nbsp;kilobytes&nbsp;and&nbsp;making&nbsp;few&nbsp;calls&nbsp;to&nbsp;the&nbsp;underlying&nbsp;port&nbsp;seems&nbsp;to&nbsp;be&lt;br&gt;<br>
the&nbsp;right&nbsp;thing&nbsp;to&nbsp;do.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Hmm.&nbsp;I&nbsp;wasn&amp;#39;t&nbsp;actually&nbsp;able&nbsp;to&nbsp;measure&nbsp;a&nbsp;discernable&nbsp;performance&nbsp;difference&nbsp;with&nbsp;these&nbsp;changes&nbsp;to&nbsp;the&nbsp;writer.&nbsp;Were&nbsp;you?&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Keep&nbsp;it&nbsp;as&nbsp;is&nbsp;for&nbsp;now.&nbsp;Changing&nbsp;this&nbsp;messes&nbsp;with&nbsp;latency,&nbsp;potentially.&nbsp;My&nbsp;worry&nbsp;is&nbsp;that&nbsp;you&nbsp;are&nbsp;pushing&nbsp;out&nbsp;small&nbsp;packets&nbsp;where&nbsp;a&nbsp;larger&nbsp;packet&nbsp;might&nbsp;be&nbsp;equally&nbsp;easy&nbsp;to&nbsp;push.&nbsp;This&nbsp;then&nbsp;means&nbsp;more&nbsp;work&nbsp;on&nbsp;the&nbsp;line&nbsp;between&nbsp;the&nbsp;client&nbsp;and&nbsp;the&nbsp;server.&nbsp;Keeping&nbsp;the&nbsp;outgoing&nbsp;queue&nbsp;full&nbsp;will&nbsp;prove&nbsp;to&nbsp;be&nbsp;a&nbsp;problem&nbsp;though&nbsp;with&nbsp;the&nbsp;current&nbsp;setup.&nbsp;We&nbsp;can&amp;#39;t&nbsp;guarantee&nbsp;that&nbsp;all&nbsp;processes&nbsp;interested&nbsp;in&nbsp;pushing&nbsp;messages&nbsp;will&nbsp;be&nbsp;run&nbsp;before&nbsp;the&nbsp;process&nbsp;doing&nbsp;the&nbsp;actual&nbsp;sending&nbsp;is.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;I&nbsp;did&nbsp;not&nbsp;manage&nbsp;to&nbsp;measure&nbsp;anything&nbsp;significantly&nbsp;better&nbsp;inside&nbsp;the&nbsp;Erlang&nbsp;VM&nbsp;with&nbsp;this&nbsp;change.&nbsp;Chances&nbsp;are&nbsp;you&nbsp;may&nbsp;see&nbsp;less&nbsp;kernel-processing&nbsp;though&nbsp;-&nbsp;but&nbsp;I&nbsp;did&nbsp;not&nbsp;measure&nbsp;that&nbsp;either.&nbsp;So&nbsp;in&nbsp;the&nbsp;interest&nbsp;of&nbsp;keeping&nbsp;it&nbsp;stable,&nbsp;I&nbsp;propose&nbsp;not&nbsp;changing&nbsp;it. &lt;/div&gt;<br>
<br>
&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;J.<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
