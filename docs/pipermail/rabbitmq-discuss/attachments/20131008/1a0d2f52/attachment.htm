<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Under&nbsp;highish&nbsp;loads&nbsp;(upwards&nbsp;of&nbsp;2,000&nbsp;messages/s),&nbsp;RabbitMQ&nbsp;requires&nbsp;more&nbsp;than&nbsp;one&nbsp;of&nbsp;our&nbsp;CPU&nbsp;cores,&nbsp;which&nbsp;is&nbsp;fine.&nbsp;However,&nbsp;after&nbsp;a&nbsp;long&nbsp;(undetermined)&nbsp;period&nbsp;of&nbsp;uptime&nbsp;of&nbsp;the&nbsp;Erlang&nbsp;VM&nbsp;these&nbsp;scheduler&nbsp;threads&nbsp;seem&nbsp;to&nbsp;become&nbsp;unused.&nbsp;Looking&nbsp;in&nbsp;top/htop&nbsp;with&nbsp;thread&nbsp;views&nbsp;enabled,&nbsp;only&nbsp;one&nbsp;thread&nbsp;(always&nbsp;the&nbsp;same&nbsp;thread)&nbsp;is&nbsp;used&nbsp;and&nbsp;is&nbsp;constantly&nbsp;pegged&nbsp;at&nbsp;99%&nbsp;of&nbsp;a&nbsp;core.&nbsp;The&nbsp;other&nbsp;threads&nbsp;barely&nbsp;reach&nbsp;0.1%.&nbsp;We&nbsp;run&nbsp;the&nbsp;Erlang&nbsp;VM&nbsp;with&nbsp;default&nbsp;flags,&nbsp;e.g.&nbsp;no&nbsp;+S&nbsp;or&nbsp;+s&nbsp;options.&nbsp;Some&nbsp;information&nbsp;about&nbsp;the&nbsp;schedulers&nbsp;and&nbsp;CPU&nbsp;bindings&nbsp;etc:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(schedulers_online).'&lt;/div&gt;&lt;div&gt;24&lt;/div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(schedulers).'&lt;/div&gt;&lt;div&gt;24&lt;/div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(cpu_topology).'&lt;/div&gt;&lt;div&gt;[{node,[{processor,[{core,[{thread,{logical,1}},{thread,{logical,13}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,3}},{thread,{logical,15}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,5}},{thread,{logical,17}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,7}},{thread,{logical,19}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,9}},{thread,{logical,21}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,11}},{thread,{logical,23}}]}]}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;{node,[{processor,[{core,[{thread,{logical,0}},{thread,{logical,12}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,2}},{thread,{logical,14}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,4}},{thread,{logical,16}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,6}},{thread,{logical,18}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,8}},{thread,{logical,20}}]},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;{core,[{thread,{logical,10}},{thread,{logical,22}}]}]}]}]&lt;/div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(logical_processors_online).'&lt;/div&gt;&lt;div&gt;24&lt;/div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(multi_scheduling).'&lt;/div&gt;&lt;div&gt;enabled&lt;/div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(schedulers).'&lt;/div&gt;&lt;div&gt;24&lt;/div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(scheduler_bindings).'&lt;/div&gt;&lt;div&gt;{unbound,unbound,unbound,unbound,unbound,unbound,unbound,unbound,unbound,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;unbound,unbound,unbound,unbound,unbound,unbound,unbound,unbound,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;unbound,unbound,unbound,unbound,unbound,unbound,unbound}&lt;/div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(threads).'&lt;/div&gt;&lt;div&gt;true&lt;/div&gt;&lt;div&gt;#&nbsp;rabbitmqctl&nbsp;eval&nbsp;'erlang:system_info(thread_pool_size).'&lt;/div&gt;&lt;div&gt;30&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;beam&nbsp;command&nbsp;line:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;/usr/lib64/erlang/erts-5.10.1/bin/beam.smp&nbsp;-W&nbsp;w&nbsp;-K&nbsp;true&nbsp;-A30&nbsp;-P&nbsp;1048576&nbsp;--&nbsp;-root&nbsp;/usr/lib64/erlang&nbsp;-progname&nbsp;erl&nbsp;--&nbsp;-home&nbsp;/var/lib/rabbitmq&nbsp;--&nbsp;-pa&nbsp;/usr/lib/rabbitmq/lib/rabbitmq_server-3.1.0/sbin/../ebin&nbsp;-noshell&nbsp;-noinput&nbsp;-s&nbsp;rabbit&nbsp;boot&nbsp;-sname&nbsp;rabbit@rabbit-node-name&nbsp;-boot&nbsp;start_sasl&nbsp;-config&nbsp;/etc/rabbitmq/rabbitmq&nbsp;-kernel&nbsp;inet_default_connect_options&nbsp;[{nodelay,true}]&nbsp;-sasl&nbsp;errlog_type&nbsp;error&nbsp;-sasl&nbsp;sasl_error_logger&nbsp;false&nbsp;-rabbit&nbsp;error_logger&nbsp;{file,&quot;/var/log/rabbitmq/rabbit@rabbit-node-name.log&quot;}&nbsp;-rabbit&nbsp;sasl_error_logger&nbsp;{file,&quot;/var/log/rabbitmq/rabbit@rabbit-node-name-sasl.log&quot;}&nbsp;-rabbit&nbsp;enabled_plugins_file&nbsp;&quot;/etc/rabbitmq/enabled_plugins&quot;&nbsp;-rabbit&nbsp;plugins_dir&nbsp;&quot;/usr/lib/rabbitmq/lib/rabbitmq_server-3.1.0/sbin/../plugins&quot;&nbsp;-rabbit&nbsp;plugins_expand_dir&nbsp;&quot;/var/lib/rabbitmq/mnesia/rabbit@rabbit-node-name-plugins-expand&quot;&nbsp;-os_mon&nbsp;start_cpu_sup&nbsp;false&nbsp;-os_mon&nbsp;start_disksup&nbsp;false&nbsp;-os_mon&nbsp;start_memsup&nbsp;false&nbsp;-mnesia&nbsp;dir&nbsp;&quot;/var/lib/rabbitmq/mnesia/rabbit@rabbit-node-name&quot;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;htop&nbsp;screenshot&nbsp;(at&nbsp;not-quite-full&nbsp;load):&amp;nbsp;http://i.imgur.com/fom6Cwa.png&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;this&nbsp;point&nbsp;of&nbsp;only&nbsp;one&nbsp;core&nbsp;being&nbsp;utilised&nbsp;and&nbsp;high&nbsp;loads&nbsp;being&nbsp;encountered,&nbsp;message&nbsp;throughput&nbsp;hits&nbsp;a&nbsp;ceiling,&nbsp;the&nbsp;run_queue&nbsp;grows&nbsp;and&nbsp;the&nbsp;Management&nbsp;API&nbsp;becomes&nbsp;unresponsive&nbsp;(we&nbsp;use&nbsp;it&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;monitoring).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;rectify&nbsp;the&nbsp;situation,&nbsp;we&nbsp;attempted&nbsp;first&nbsp;to&nbsp;do&nbsp;a&nbsp;rabbitmqctl&nbsp;stop_app,&nbsp;rabbitmqctl&nbsp;start_app&nbsp;(our&nbsp;nodes&nbsp;are&nbsp;clustered&nbsp;with&nbsp;mirrored&nbsp;queues)&nbsp;but&nbsp;this&nbsp;didn't&nbsp;help.&nbsp;In&nbsp;the&nbsp;end&nbsp;we&nbsp;shut&nbsp;down&nbsp;the&nbsp;app&nbsp;and&nbsp;restarted&nbsp;the&nbsp;Erlang&nbsp;VM&nbsp;as&nbsp;a&nbsp;whole.&nbsp;Suddenly&nbsp;we&nbsp;see&nbsp;6-8&nbsp;threads&nbsp;all&nbsp;using&nbsp;about&nbsp;70%&nbsp;CPU,&nbsp;throughput&nbsp;increases&nbsp;to&nbsp;where&nbsp;it&nbsp;should&nbsp;be,&nbsp;run_queue&nbsp;is&nbsp;always&nbsp;0&nbsp;and&nbsp;the&nbsp;Management&nbsp;API&nbsp;is&nbsp;fully&nbsp;responsive.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;currently&nbsp;have&nbsp;4&nbsp;nodes&nbsp;in&nbsp;this&nbsp;&quot;stuck&quot;&nbsp;situation&nbsp;on&nbsp;our&nbsp;less-critical&nbsp;workloads,&nbsp;so&nbsp;we&nbsp;are&nbsp;able&nbsp;to&nbsp;provide&nbsp;any&nbsp;debugging&nbsp;information&nbsp;required.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We're&nbsp;running&nbsp;24&nbsp;&quot;cores&quot;&nbsp;worth&nbsp;of&nbsp;Xeon&nbsp;E5645&nbsp;on&nbsp;RHEL5.6&amp;nbsp;2.6.18-238.27.1.el5.&nbsp;We're&nbsp;running&nbsp;RabbitMQ&nbsp;both&nbsp;3.1.0&nbsp;and&nbsp;3.1.5&nbsp;on&nbsp;a&nbsp;self-compiled&nbsp;RPM&nbsp;of&nbsp;Erlang&nbsp;OTP&nbsp;R16B&nbsp;with&nbsp;HiPE&nbsp;disabled.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;any&nbsp;help,&nbsp;and&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;we&nbsp;can&nbsp;provide&nbsp;any&nbsp;further&nbsp;information,&nbsp;straces,&nbsp;netstats&nbsp;etc.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Paul&nbsp;Bowsher&lt;/div&gt;&lt;div&gt;Senior&nbsp;Engineer&lt;/div&gt;&lt;div&gt;Global&nbsp;Personals&lt;/div&gt;&lt;/div&gt;
</tt>
