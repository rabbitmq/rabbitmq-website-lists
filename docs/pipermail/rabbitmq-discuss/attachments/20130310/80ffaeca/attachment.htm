<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Thanks&nbsp;Matthias,&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Knowing&nbsp;that&nbsp;the&nbsp;tokyo&nbsp;plugin&nbsp;is&nbsp;not&nbsp;often&nbsp;used&nbsp;is&nbsp;useful&nbsp;info.&nbsp; I&amp;#39;ve&nbsp;spent&nbsp;the&nbsp;weekend&nbsp;reading&nbsp;as&nbsp;much&nbsp;as&nbsp;I&nbsp;can&nbsp;and&nbsp;some&nbsp;of&nbsp;the&nbsp;blogs&nbsp;on&nbsp;the&nbsp;rabbit&nbsp;site&nbsp;[e.g.&nbsp;1,2&nbsp;were&nbsp;particularly&nbsp;useful].&nbsp; I&nbsp;don&amp;#39;t&nbsp;claim&nbsp;to&nbsp;get&nbsp;all&nbsp;this,&nbsp;but&nbsp;I&nbsp;think&nbsp;I&nbsp;am&nbsp;beginning&nbsp;to&nbsp;get&nbsp;a&nbsp;general&nbsp;understanding&nbsp;and&nbsp;realising&nbsp;we&nbsp;do&nbsp;indeed&nbsp;need&nbsp;a&nbsp;buffer&nbsp;to&nbsp;decouple&nbsp;those&nbsp;consumers&nbsp;that&nbsp;we&nbsp;know&nbsp;are&nbsp;inherently&nbsp;slow&nbsp;or&nbsp;will&nbsp;be&nbsp;taken&nbsp;offline&nbsp;periodically&nbsp;(e.g.&nbsp;the&nbsp;map&nbsp;tile&nbsp;renderers&nbsp;which&nbsp;are&nbsp;maintaining&nbsp;Billions&nbsp;of&nbsp;tiles&nbsp;in&nbsp;HBase&nbsp;in&nbsp;large&nbsp;queue-draining&nbsp;batch&nbsp;operations).&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Really&nbsp;appreciate&nbsp;the&nbsp;helpful&nbsp;pointers&nbsp;from&nbsp;both&nbsp;you&nbsp;and&nbsp;Jerry&nbsp;-&nbsp;cheers&nbsp;guys,&lt;/div&gt;&lt;div&nbsp;style&gt;Tim&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;[1] &lt;a&nbsp;href=&quot;http://www.rabbitmq.com/blog/2012/04/25/rabbitmq-performance-measurements-part-2/&quot;&gt;http://www.rabbitmq.com/blog/2012/04/25/rabbitmq-performance-measurements-part-2/&lt;/a&gt;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;[2] &lt;a&nbsp;href=&quot;http://www.rabbitmq.com/blog/2011/10/27/performance-of-queues-when-less-is-more/&quot;&gt;http://www.rabbitmq.com/blog/2011/10/27/performance-of-queues-when-less-is-more/&lt;/a&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;<br>
&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Mar&nbsp;10,&nbsp;2013&nbsp;at&nbsp;2:17&nbsp;PM,&nbsp;Matthias&nbsp;Radestock&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthias@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;matthias@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
Tim,&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;10/03/13&nbsp;12:14,&nbsp;Tim&nbsp;Robertson&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
it&nbsp;is&nbsp;really&nbsp;not&nbsp;good&nbsp;practice&nbsp;to&lt;br&gt;<br>
deliberately&nbsp;use&nbsp;RMQ&nbsp;as&nbsp;a&nbsp;large&nbsp;buffering&nbsp;technology&nbsp;for&nbsp;queues,&nbsp;due&nbsp;to&lt;br&gt;<br>
the&nbsp;memory&nbsp;management.&nbsp; Namely,&nbsp;that&nbsp;if&nbsp;one&nbsp;queue&nbsp;is&nbsp;hugely&nbsp;backed&nbsp;up,&lt;br&gt;<br>
we&amp;#39;ll&nbsp;get&nbsp;into&nbsp;a&nbsp;oscillation&nbsp;of:&lt;br&gt;<br>
 &nbsp; i)&nbsp;memory&nbsp;limit&nbsp;hit&lt;br&gt;<br>
 &nbsp; ii)&nbsp;block&nbsp;everything&nbsp;while&nbsp;flush&nbsp;partially&nbsp;to&nbsp;disk&lt;br&gt;<br>
 &nbsp; iii)&nbsp;repeat&nbsp;immediately&nbsp;(while&nbsp;the&nbsp;disabled&nbsp;consumer&nbsp;remains)&lt;br&gt;<br>
While&nbsp;it&nbsp;will&nbsp;work,&nbsp;we&amp;#39;ll&nbsp;likely&nbsp;cripple&nbsp;other&nbsp;parts&nbsp;of&nbsp;the&nbsp;system&nbsp;if&lt;br&gt;<br>
they&nbsp;are&nbsp;going&nbsp;through&nbsp;the&nbsp;same&nbsp;broker.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Rabbit&nbsp;will&nbsp;start&nbsp;paging&nbsp;to&nbsp;disk&nbsp;*before*&nbsp;the&nbsp;memory&nbsp;limit&nbsp;is&nbsp;hit,&nbsp;in&nbsp;order&nbsp;to&nbsp;prevent&nbsp;precisely&nbsp;the&nbsp;stop-start&nbsp;scenario&nbsp;you&nbsp;describe&nbsp;above.&lt;br&gt;<br>
&lt;br&gt;<br>
Obviously&nbsp;if&nbsp;the&nbsp;publishing&nbsp;happens&nbsp;at&nbsp;a&nbsp;faster&nbsp;rate&nbsp;than&nbsp;rabbit&nbsp;can&nbsp;write&nbsp;to&nbsp;disk&nbsp;then&nbsp;eventually&nbsp;the&nbsp;memory&nbsp;limit&nbsp;will&nbsp;still&nbsp;be&nbsp;hit&nbsp;and&nbsp;producers&nbsp;blocked&nbsp;while&nbsp;rabbit&nbsp;catches&nbsp;up.&lt;br&gt;<br>
&lt;br&gt;<br>
Furthermore,&nbsp;as&nbsp;Jerry&nbsp;says,&nbsp;messages&nbsp;do&nbsp;have&nbsp;a&nbsp;non-zero&nbsp;memory&nbsp;footprint&nbsp;even&nbsp;when&nbsp;paged&nbsp;to&nbsp;disk.&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;when&nbsp;&amp;quot;filling&amp;quot;&nbsp;rabbit&nbsp;with&nbsp;messages,&nbsp;the&nbsp;paging&nbsp;becomes&nbsp;more&nbsp;and&nbsp;more&nbsp;aggressive&nbsp;over&nbsp;time&nbsp;to&nbsp;the&nbsp;point&nbsp;where&nbsp;all&nbsp;memory&nbsp;is&nbsp;taken&nbsp;up&nbsp;by&nbsp;the&nbsp;residual&nbsp;footprint&nbsp;of&nbsp;paged&nbsp;messages,&nbsp;and&nbsp;publishing&nbsp;even&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;messages&nbsp;will&nbsp;trigger&nbsp;a&nbsp;memory&nbsp;alarm.&nbsp;And&nbsp;eventually&nbsp;*all*&nbsp;memory&nbsp;is&nbsp;consumed&nbsp;that&nbsp;way&nbsp;and&nbsp;publishers&nbsp;are&nbsp;blocked&nbsp;indefinitely&nbsp;until&nbsp;some&nbsp;messages&nbsp;are&nbsp;removed&nbsp;from&nbsp;the&nbsp;queues.&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;think&nbsp;this&nbsp;was&nbsp;probably&nbsp;a&nbsp;lack&nbsp;of&nbsp;understanding&nbsp;on&nbsp;our&nbsp;part,&nbsp;as&nbsp;we&lt;br&gt;<br>
anticipated&nbsp;using&nbsp;it&nbsp;as&nbsp;a&nbsp;queue&nbsp;(to&nbsp;do&nbsp;large&nbsp;buffering)&nbsp;whereas&nbsp;I&lt;br&gt;<br>
presume&nbsp;it&nbsp;is&nbsp;(?)&nbsp;really&nbsp;intended&nbsp;to&nbsp;be&nbsp;a&nbsp;messaging&nbsp;system&nbsp;and&nbsp;targeting&lt;br&gt;<br>
zero&nbsp;queue&nbsp;sizes&nbsp;is&nbsp;the&nbsp;expected&nbsp;behavior&nbsp;(consumer&nbsp;throughput&nbsp;matched&lt;br&gt;<br>
to&nbsp;producer).&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
We&nbsp;used&nbsp;to&nbsp;say&nbsp;that&nbsp;&amp;quot;an&nbsp;empty&nbsp;rabbit&nbsp;is&nbsp;a&nbsp;healthy&nbsp;rabbit&amp;quot;,&nbsp;but&nbsp;that&nbsp;statement&nbsp;predates&nbsp;many&nbsp;improvements&nbsp;to&nbsp;persistence&nbsp;and&nbsp;flow-control&nbsp;that&nbsp;have&nbsp;happened&nbsp;since.&nbsp;So&nbsp;nowadays&nbsp;I&amp;#39;d&nbsp;rephrase&nbsp;that&nbsp;as&nbsp;&amp;quot;a&nbsp;non-obese&nbsp;rabbit&nbsp;is&nbsp;a&nbsp;healthy&nbsp;rabbit&amp;quot;.&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
Are&nbsp;there&nbsp;alternative&nbsp;configurations&nbsp;that&nbsp;you&nbsp;are&nbsp;aware&nbsp;of&nbsp;that&nbsp;would&lt;br&gt;<br>
allow&nbsp;it&nbsp;to&nbsp;back&nbsp;up&nbsp;large&nbsp;queues,&nbsp;without&nbsp;hitting&nbsp;memory&nbsp;limits?&nbsp; (the&lt;br&gt;<br>
tokyo&nbsp;cabinet&nbsp;plugin&nbsp;perhaps?)&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Exactly&nbsp;that.&nbsp;With&nbsp;the&nbsp;tokyo&nbsp;cabinet&nbsp;plugin,&nbsp;messages&nbsp;that&nbsp;have&nbsp;been&nbsp;paged&nbsp;to&nbsp;disk&nbsp;leave&nbsp;zero&nbsp;memory&nbsp;footprint,&nbsp;allowing&nbsp;rabbit&nbsp;to&nbsp;hold&nbsp;on&nbsp;to&nbsp;as&nbsp;much&nbsp;message&nbsp;data&nbsp;as&nbsp;will&nbsp;fit&nbsp;on&nbsp;disk.&lt;br&gt;<br>
&lt;br&gt;<br>
Note&nbsp;however&nbsp;that&nbsp;the&nbsp;plugin&nbsp;is&nbsp;rarely&nbsp;used&nbsp;and&nbsp;is&nbsp;not&nbsp;included&nbsp;in&nbsp;our&nbsp;distributions&nbsp;due&nbsp;to&nbsp;the&nbsp;dependency&nbsp;on&nbsp;non-Erlang,&nbsp;platform-specific&nbsp;code.&lt;br&gt;<br>
&lt;br&gt;<br>
Alternatively,&nbsp;increase&nbsp;the&nbsp;amount&nbsp;of&nbsp;memory&nbsp;on&nbsp;your&nbsp;rabbit&nbsp;machine.&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;<br>
&lt;br&gt;<br>
Matthias.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
