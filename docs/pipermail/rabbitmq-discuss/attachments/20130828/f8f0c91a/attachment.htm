<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello&nbsp;guys,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I've&nbsp;been&nbsp;using&nbsp;RabbitMQ&nbsp;for&nbsp;a&nbsp;while,&nbsp;but&nbsp;this&nbsp;time&nbsp;I&nbsp;have&nbsp;an&nbsp;error&nbsp;which&nbsp;I&nbsp;did&nbsp;not&nbsp;manage&nbsp;to&nbsp;track&nbsp;down:&amp;nbsp;&amp;nbsp;&quot;PRECONDITION_FAILED&nbsp;-&nbsp;unknown&nbsp;delivery&nbsp;tag&nbsp;XXX&quot;&nbsp;&amp;nbsp;(where&nbsp;XXX&nbsp;varies).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now,&nbsp;I've&nbsp;done&nbsp;my&nbsp;research&nbsp;and&nbsp;I&nbsp;know&nbsp;it's&nbsp;usually&nbsp;because&nbsp;of&nbsp;double&nbsp;ack-ing,&nbsp;ack-ing&nbsp;on&nbsp;wrong&nbsp;channels&nbsp;or&nbsp;ack-ing&nbsp;messages&nbsp;that&nbsp;should&nbsp;not&nbsp;be&nbsp;ack-ed.&nbsp;I've&nbsp;checked&nbsp;at&nbsp;least&nbsp;a&nbsp;dozen&nbsp;times,&nbsp;and&nbsp;it&nbsp;doesn't&nbsp;seem&nbsp;to&nbsp;be&nbsp;the&nbsp;case&nbsp;for&nbsp;me.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I've&nbsp;simplified&nbsp;the&nbsp;scenario&nbsp;to&nbsp;the&nbsp;minimum&nbsp;required&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;error&nbsp;(I'm&nbsp;running&nbsp;RabbitMQ&nbsp;3.0.3&nbsp;Erlang&nbsp;R15B01;&nbsp;the&nbsp;code&nbsp;is&nbsp;written&nbsp;in&nbsp;python&nbsp;using&nbsp;pika&nbsp;0.9.10p0).&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;one&nbsp;working&nbsp;agent&nbsp;which&nbsp;has&nbsp;two&nbsp;threads:&lt;/div&gt;&lt;div&gt;&amp;nbsp;-&nbsp;thread&nbsp;one&nbsp;that&nbsp;fetches&nbsp;tasks&nbsp;continuously&nbsp;and&nbsp;puts&nbsp;them&nbsp;in&nbsp;a&nbsp;list&lt;/div&gt;&lt;div&gt;&amp;nbsp;-&nbsp;a&nbsp;worker&nbsp;thread&nbsp;that&nbsp;continuously&nbsp;takes&nbsp;tasks&nbsp;from&nbsp;the&nbsp;list&nbsp;and&nbsp;performs&nbsp;them&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;See&nbsp;code&nbsp;here:&amp;nbsp;&lt;a&nbsp;href=&quot;http://pastebin.com/PG8quVSw&quot;&gt;http://pastebin.com/PG8quVSw&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here's&nbsp;what&nbsp;happens&nbsp;(see&nbsp;example&nbsp;output&nbsp;here:&amp;nbsp;&lt;a&nbsp;href=&quot;http://pastebin.com/6f1sWsYa&quot;&gt;http://pastebin.com/6f1sWsYa&lt;/a&gt;&amp;nbsp;):&nbsp;the&nbsp;agent&nbsp;starts&nbsp;by&nbsp;initializing,&nbsp;pre-fetches&nbsp;10&nbsp;tasks&nbsp;(the&nbsp;prefech_count&nbsp;is&nbsp;set&nbsp;to&nbsp;10)&nbsp;and&nbsp;then&nbsp;tasks&nbsp;are&nbsp;executed&nbsp;one&nbsp;by&nbsp;one.&nbsp;We&nbsp;can&nbsp;see&nbsp;that&nbsp;as&nbsp;soon&nbsp;as&nbsp;one&nbsp;task&nbsp;is&nbsp;ACK-ed,&nbsp;a&nbsp;new&nbsp;one&nbsp;is&nbsp;fetched&nbsp;so&nbsp;that&nbsp;the&nbsp;prefetch&nbsp;queue&nbsp;is&nbsp;staying&nbsp;at&nbsp;10&nbsp;items.&nbsp;However,&nbsp;as&nbsp;we&nbsp;can&nbsp;see&nbsp;at&nbsp;line&nbsp;52&nbsp;in&nbsp;the&nbsp;example&nbsp;output,&nbsp;the&nbsp;error&nbsp;message&amp;nbsp;(406,&nbsp;'PRECONDITION_FAILED&nbsp;-&nbsp;unknown&nbsp;delivery&nbsp;tag&nbsp;12')&nbsp;is&nbsp;returned.&nbsp;The&nbsp;channel&nbsp;is&nbsp;closed,&nbsp;and&nbsp;when&nbsp;the&nbsp;next&nbsp;10&nbsp;tasks&nbsp;from&nbsp;the&nbsp;prefetch&nbsp;queue&nbsp;try&nbsp;to&nbsp;send&nbsp;the&nbsp;ACK&nbsp;they&nbsp;get&nbsp;the&nbsp;error&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed.&nbsp;The&nbsp;tasks&nbsp;are&nbsp;prefetched&nbsp;again&nbsp;on&nbsp;the&nbsp;new&nbsp;channel&nbsp;that&nbsp;was&nbsp;opened&nbsp;automatically&nbsp;and&nbsp;then&nbsp;everything&nbsp;continues&nbsp;fine&nbsp;till&nbsp;the&nbsp;end&nbsp;(there&nbsp;were&nbsp;60&nbsp;tasks&nbsp;in&nbsp;total&nbsp;in&nbsp;the&nbsp;queue).&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;THE&nbsp;PROBLEM:&nbsp;why&nbsp;did&nbsp;ACK&nbsp;12&nbsp;failed?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;managed&nbsp;to&nbsp;reproduce&nbsp;this&nbsp;consistently,&nbsp;but&nbsp;always&nbsp;at&nbsp;at&nbsp;different&nbsp;message,&nbsp;sometimes&nbsp;42,&nbsp;34&nbsp;etc.&nbsp;One&nbsp;weird&nbsp;thing&nbsp;is&nbsp;that&nbsp;the&nbsp;error&nbsp;about&nbsp;the&nbsp;unknown&nbsp;delivery&nbsp;tag&nbsp;is&nbsp;not&nbsp;returned&nbsp;on&nbsp;the&nbsp;call&nbsp;to&nbsp;basic_ack&nbsp;(line&nbsp;13&nbsp;in&nbsp;the&nbsp;code),&nbsp;but&nbsp;on&nbsp;the&nbsp;code&nbsp;that&nbsp;consumes&nbsp;the&nbsp;queue&nbsp;(line&nbsp;45).&nbsp;My&nbsp;guess&nbsp;is&nbsp;that&nbsp;there's&nbsp;a&nbsp;race&nbsp;somewhere,&nbsp;but&nbsp;can't&nbsp;figure&nbsp;where.&nbsp;In&nbsp;pika&nbsp;maybe?&nbsp;If&nbsp;I&nbsp;uncomment&nbsp;lines&nbsp;34&nbsp;and&nbsp;35&nbsp;from&nbsp;the&nbsp;code,&nbsp;it&nbsp;happens&nbsp;a&nbsp;lot&nbsp;less,&nbsp;but&nbsp;it&nbsp;still&nbsp;happens&nbsp;1-2&nbsp;times&nbsp;on&nbsp;1000&nbsp;messages.&nbsp;I&nbsp;think&nbsp;it&nbsp;has&nbsp;something&nbsp;to&nbsp;do&nbsp;with&nbsp;ACK-ing&nbsp;from&nbsp;one&nbsp;thread&nbsp;using&nbsp;the&nbsp;same&nbsp;channel&nbsp;that&nbsp;is&nbsp;used&nbsp;for&nbsp;listening&nbsp;on&nbsp;another&nbsp;thread.&nbsp;But&nbsp;I&nbsp;see&nbsp;no&nbsp;other&nbsp;way&nbsp;of&nbsp;implementing&nbsp;this&nbsp;scenario,&nbsp;with&nbsp;an&nbsp;internal&nbsp;pre-fetch&nbsp;queue&nbsp;on&nbsp;the&nbsp;consumer&nbsp;side.&nbsp;And&nbsp;to&nbsp;answer&nbsp;the&nbsp;question,&nbsp;why&nbsp;do&nbsp;I&nbsp;need&nbsp;this,&nbsp;it's&nbsp;because&nbsp;I&nbsp;need&nbsp;the&nbsp;worker&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;take&nbsp;a&nbsp;peak&nbsp;at&nbsp;some&nbsp;of&nbsp;the&nbsp;tasks&nbsp;in&nbsp;the&nbsp;queues.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;ideas?&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Raz&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;
</tt>
