<tt>
Hi,&lt;br&gt;&lt;br&gt;A&nbsp;couple&nbsp;of&nbsp;people&nbsp;recently&nbsp;asked&nbsp;about&nbsp;support&nbsp;for&nbsp;persistent&nbsp;connections,&nbsp;after&nbsp;a&nbsp;bit&nbsp;of&nbsp;hacking&nbsp;around&nbsp;I&amp;#39;ve&nbsp;uploaded&nbsp;an&nbsp;update&nbsp;which&nbsp;has&nbsp;basic&nbsp;persistent&nbsp;connection&nbsp;support:&nbsp;&lt;a&nbsp;href=&quot;https://github.com/BraveSirRobin/amqphp&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/BraveSirRobin/amqphp&lt;/a&gt;&nbsp;(check&nbsp;the&nbsp;0.9.1&nbsp;tag)&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;&lt;br&gt;The&nbsp;implementation&nbsp;turned&nbsp;out&nbsp;to&nbsp;be&nbsp;fairly&nbsp;straightforward,&nbsp;I&nbsp;only&nbsp;had&nbsp;to&nbsp;add&nbsp;the&nbsp;STREAM_CLIENT_PERSIST&nbsp;flag&nbsp;to&nbsp;the&nbsp;existing&nbsp;stream_socket_client()&nbsp;call,&nbsp;so&nbsp;the&nbsp;changes&nbsp;weren&amp;#39;t&nbsp;too&nbsp;invasive. &nbsp;I&amp;#39;ve&nbsp;created&nbsp;a&nbsp;new&nbsp;&amp;quot;Connection&amp;quot;&nbsp;object&nbsp;called&nbsp;PConnection,&nbsp;and&nbsp;set&nbsp;up&nbsp;a&nbsp;simple&nbsp;framework&nbsp;to&nbsp;persist&nbsp;amqp&nbsp;connection&nbsp;parameters&nbsp;between&nbsp;web&nbsp;requests. &nbsp;The&nbsp;amqp&nbsp;connection&nbsp;setup&nbsp;process&nbsp;is&nbsp;only&nbsp;run&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;PConnection&nbsp;is&nbsp;opened,&nbsp;so&nbsp;both&nbsp;the&nbsp;Amqp&nbsp;&amp;quot;session&amp;quot;&nbsp;and&nbsp;TCP&nbsp;connection&nbsp;remain&nbsp;after&nbsp;the&nbsp;web&nbsp;request&nbsp;and&nbsp;are&nbsp;re-used&nbsp;by&nbsp;subsequent&nbsp;requests&nbsp;to&nbsp;that&nbsp;process. &nbsp;My&nbsp;plan&nbsp;is&nbsp;to&nbsp;add&nbsp;support&nbsp;for&nbsp;persisting&nbsp;Channels&nbsp;as&nbsp;well,&nbsp;possibly&nbsp;by&nbsp;having&nbsp;API&nbsp;calls&nbsp;use&nbsp;channel.flow&nbsp;to&nbsp;inform&nbsp;the&nbsp;broker&nbsp;during&nbsp;the&nbsp;web&nbsp;request&nbsp;wakeup&nbsp;/&nbsp;sleep&nbsp;routines.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;I&amp;#39;d&nbsp;be&nbsp;interested&nbsp;to&nbsp;hear&nbsp;what&nbsp;the&nbsp;RabbitMQ&nbsp;people&nbsp;think&nbsp;about&nbsp;the&nbsp;likely&nbsp;behavior&nbsp;of&nbsp;PHP&nbsp;&amp;quot;persistent&nbsp;connections&amp;quot;,&nbsp;which&nbsp;may&nbsp;include:&lt;br&gt;&lt;br&gt; *&nbsp;If&nbsp;the&nbsp;web&nbsp;server&nbsp;is&nbsp;restarted,&nbsp;all&nbsp;open&nbsp;client&nbsp;connections&nbsp;are&nbsp;dropped&nbsp;without&nbsp;going&nbsp;through&nbsp;the&nbsp;amqp&nbsp;shutdown&nbsp;<br>
sequence,&nbsp;so&nbsp;you&nbsp;get&nbsp;lots&nbsp;of&nbsp;&amp;quot;closed&nbsp;abruptly&amp;quot;&nbsp;errors&nbsp;in&nbsp;the&nbsp;log.&lt;br&gt; *&nbsp;If&nbsp;a&nbsp;web&nbsp;server&nbsp;has&nbsp;no&nbsp;web&nbsp;requests&nbsp;to&nbsp;process&nbsp;then&nbsp;the&nbsp;persistent&nbsp;client&nbsp;can&amp;#39;t&nbsp;respond&nbsp;to&nbsp;any&nbsp;messages&nbsp;the&nbsp;broker&nbsp;sends;&nbsp;the&nbsp;client&nbsp;will&nbsp;&amp;quot;go&nbsp;quiet&amp;quot;.&lt;br&gt;<br>
<br>
&lt;br&gt;In&nbsp;case&nbsp;you&nbsp;don&amp;#39;t&nbsp;know&nbsp;what&nbsp;PHP&nbsp;persistent&nbsp;connections&nbsp;are,&nbsp;they&amp;#39;re&nbsp;basically&nbsp;a&nbsp;socket&nbsp;re-use&nbsp;method&nbsp;for&nbsp;web&nbsp;servers,&nbsp;the&nbsp;idea&nbsp;is&nbsp;that&nbsp;the&nbsp;socket&nbsp;remains&nbsp;open&nbsp;between&nbsp;web&nbsp;requests&nbsp;in&nbsp;order&nbsp;to&nbsp;avoid&nbsp;TCP&nbsp;setup&nbsp;/&nbsp;teardown&nbsp;overheads&nbsp;on&nbsp;busy&nbsp;sites.&lt;br&gt;<br>
&lt;br&gt;If&nbsp;you&amp;#39;d&nbsp;like&nbsp;to&nbsp;test&nbsp;this&nbsp;then&nbsp;check&nbsp;out&nbsp;the&nbsp;demo-multi-producer.php&nbsp;script,&nbsp;I&amp;#39;ve&nbsp;run&nbsp;this&nbsp;inside&nbsp;a&nbsp;PHP-FPM&nbsp;/&nbsp;Nginx&nbsp;setup&nbsp;and&nbsp;it&nbsp;seems&nbsp;to&nbsp;work&nbsp;fine.&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;--Robin&lt;br&gt;<br>
<br>

</tt>
