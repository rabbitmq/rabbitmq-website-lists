<tt>
|&nbsp;I&nbsp;*think*&nbsp;the&nbsp;stats&nbsp;database&nbsp;is&nbsp;a&nbsp;red&nbsp;herring.&lt;br&gt;&lt;br&gt;Perhaps.&nbsp;But&nbsp;it&amp;#39;s&nbsp;the&nbsp;only&nbsp;correlation&nbsp;that&nbsp;I&amp;#39;ve&nbsp;seen.&nbsp;That&nbsp;is,&nbsp;I&amp;#39;ve&nbsp;never&nbsp;seen&nbsp;it&nbsp;happen&nbsp;on&nbsp;node&nbsp;that&nbsp;didn&amp;#39;t&nbsp;have&nbsp;the&nbsp;stats&nbsp;database&nbsp;before&nbsp;it&nbsp;shut&nbsp;down.&lt;br&gt;<br>
&lt;br&gt;A&nbsp;little&nbsp;more&nbsp;background&nbsp;context:&nbsp;I&amp;#39;m&nbsp;writing&nbsp;&amp;quot;rolling&nbsp;restart&amp;quot;&nbsp;logic.&nbsp;For&nbsp;each&nbsp;node&nbsp;in&nbsp;the&nbsp;cluster,&nbsp;in&nbsp;sequence,&nbsp;I&nbsp;stop&nbsp;the&nbsp;node,&nbsp;perform&nbsp;update&nbsp;logic&nbsp;(currently&nbsp;nothing),&nbsp;then&nbsp;restart&nbsp;the&nbsp;node. &nbsp;&lt;br&gt;&lt;br&gt;<br>
|&nbsp;You&nbsp;say&nbsp;this&nbsp;happens&nbsp;when&nbsp;restarting?&lt;br&gt;&lt;br&gt;Yes.&nbsp;Occasionally&nbsp;the&nbsp;node&nbsp;will&nbsp;restart&nbsp;OK,&nbsp;but&nbsp;more&nbsp;often&nbsp;than&nbsp;not,&nbsp;it&nbsp;hangs&nbsp;on&nbsp;the&nbsp;&amp;quot;rabbitmqctl&nbsp;wait&amp;quot;&lt;br&gt;&lt;br&gt;I&nbsp;modified&nbsp;my&nbsp;script&nbsp;to&nbsp;run&nbsp;rabbitmq-server&nbsp;as&nbsp;a&nbsp;background&nbsp;task.&nbsp;Also,&nbsp;worth&nbsp;noting&nbsp;that&nbsp;these&nbsp;scripts&nbsp;are&nbsp;invoked&nbsp;remotely&nbsp;via&nbsp;Capistrano,&nbsp;so&nbsp;until&nbsp;I&nbsp;prefaced&nbsp;them&nbsp;with&nbsp;nohup,&nbsp;the&nbsp;server&nbsp;would&nbsp;start&nbsp;then&nbsp;immediately&nbsp;exit.&nbsp;The&nbsp;invocation&nbsp;line&nbsp;now&nbsp;looks&nbsp;like&nbsp;this:&lt;br&gt;<br>
&lt;br&gt;nohup&nbsp;rabbitmq-server&nbsp;&amp;amp;&lt;br&gt;&lt;br&gt;The&nbsp;nohup.out&nbsp;on&nbsp;the&nbsp;failing&nbsp;node&nbsp;ends&nbsp;with:&lt;br&gt;&lt;br&gt;+---+  &nbsp;+---+&lt;br&gt;|  &nbsp;|  &nbsp;|  &nbsp;|&lt;br&gt;|  &nbsp;|  &nbsp;|  &nbsp;|&lt;br&gt;|  &nbsp;|  &nbsp;|  &nbsp;|&lt;br&gt;|  &nbsp;+---+  &nbsp;+-------+&lt;br&gt;|                  &nbsp;|&lt;br&gt;|&nbsp;RabbitMQ &nbsp;+---+  &nbsp;|&lt;br&gt;<br>
|          &nbsp;|  &nbsp;|  &nbsp;|&lt;br&gt;|  &nbsp;v2.7.1 &nbsp;+---+  &nbsp;|&lt;br&gt;|                  &nbsp;|&lt;br&gt;+-------------------+&lt;br&gt;AMQP&nbsp;0-9-1&nbsp;/&nbsp;0-9&nbsp;/&nbsp;0-8&lt;br&gt;Copyright&nbsp;(C)&nbsp;2007-2011&nbsp;VMware,&nbsp;Inc.&lt;br&gt;Licensed&nbsp;under&nbsp;the&nbsp;MPL. &nbsp;See&nbsp;&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/&quot;&gt;http://www.rabbitmq.com/&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;node          &nbsp;:&nbsp;rabbit@play2&lt;br&gt;app&nbsp;descriptor&nbsp;:&nbsp;/usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin/../ebin/rabbit.app&lt;br&gt;home&nbsp;dir      &nbsp;:&nbsp;/home/mpietrek&lt;br&gt;config&nbsp;file(s)&nbsp;:&nbsp;/home/mpietrek/work/var/run/rabbitmq.config&lt;br&gt;<br>
cookie&nbsp;hash   &nbsp;:&nbsp;pS5H9kY3Wra/XdLEKT5hgQ==&lt;br&gt;log           &nbsp;:&nbsp;/home/mpietrek/work/logs/&lt;a&nbsp;href=&quot;http://play2.mpietrek.internal.illumita.com/rabbit@play2.log&quot;&gt;play2.mpietrek.internal.illumita.com/rabbit@play2.log&lt;/a&gt;&lt;br&gt;sasl&nbsp;log      &nbsp;:&nbsp;/home/mpietrek/work/logs/&lt;a&nbsp;href=&quot;http://play2.mpietrek.internal.illumita.com/rabbit@play2-sasl.log&quot;&gt;play2.mpietrek.internal.illumita.com/rabbit@play2-sasl.log&lt;/a&gt;&lt;br&gt;<br>
database&nbsp;dir  &nbsp;:&nbsp;/home/mpietrek/work/var/lib/rabbit@play2&lt;br&gt;erlang&nbsp;version&nbsp;:&nbsp;5.7.4&lt;br&gt;&lt;br&gt;--&nbsp;rabbit&nbsp;boot&nbsp;start&lt;br&gt;starting&nbsp;file&nbsp;handle&nbsp;cache&nbsp;server                                    &nbsp;...done&lt;br&gt;starting&nbsp;worker&nbsp;pool                                                 &nbsp;...done&lt;br&gt;<br>
starting&nbsp;database                                                    &nbsp;...&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Feb&nbsp;23,&nbsp;2012&nbsp;at&nbsp;3:52&nbsp;AM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;I&nbsp;*think*&nbsp;the&nbsp;stats&nbsp;database&nbsp;is&nbsp;a&nbsp;red&nbsp;herring.&nbsp;You&nbsp;say&nbsp;this&nbsp;happens&nbsp;when&nbsp;restarting?&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;23/02/12&nbsp;00:30,&nbsp;Matt&nbsp;Pietrek&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Let&nbsp;me&nbsp;add&nbsp;some&nbsp;additional&nbsp;information,&nbsp;and&nbsp;re-summarize&nbsp;what&nbsp;I&amp;#39;m&nbsp;seeing.&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;our&nbsp;startup&nbsp;script&nbsp;for&nbsp;RabbitMQ&nbsp;we&nbsp;do&nbsp;the&nbsp;following;&lt;br&gt;<br>
&lt;br&gt;<br>
rabbitmq-server&nbsp;-detached&lt;br&gt;<br>
rabbitmqctl&nbsp;status&lt;br&gt;<br>
&amp;lt;Extract&nbsp;the&nbsp;PID&nbsp;from&nbsp;rabbitmqctl&nbsp;status,&nbsp;write&nbsp;to&nbsp;our&nbsp;PIDFILE&amp;gt;&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
There&amp;#39;s&nbsp;a&nbsp;potential&nbsp;race&nbsp;here&nbsp;if&nbsp;an&nbsp;old&nbsp;server&nbsp;is&nbsp;running&nbsp;(maybe&nbsp;about&nbsp;to&nbsp;shut&nbsp;down?).&nbsp;rabbitmqctl&nbsp;status&nbsp;could&nbsp;pick&nbsp;up&nbsp;the&nbsp;old&nbsp;pid.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
rabbitmqctl&nbsp;wait&nbsp;PIDFILE&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
However,&nbsp;rabbitmqctl&nbsp;wait&nbsp;should&nbsp;then&nbsp;detect&nbsp;that&nbsp;the&nbsp;pid&nbsp;has&nbsp;died&nbsp;and&nbsp;fail.&nbsp;Unless&nbsp;the&nbsp;pid&nbsp;gets&nbsp;reused&nbsp;by&nbsp;the&nbsp;OS&nbsp;but&nbsp;that&nbsp;is&nbsp;presumably&nbsp;unlikely.&lt;br&gt;<br>
&lt;br&gt;<br>
But&nbsp;rabbitmqctl&nbsp;wait&nbsp;will&nbsp;wait&nbsp;indefinitely&nbsp;as&nbsp;long&nbsp;as&nbsp;the&nbsp;pid&nbsp;is&nbsp;alive&nbsp;and&nbsp;not&nbsp;a&nbsp;fully&nbsp;functional&nbsp;rabbit&nbsp;node.&nbsp;So&nbsp;I&amp;#39;d&nbsp;check&nbsp;two&nbsp;things:&lt;br&gt;<br>
&lt;br&gt;<br>
1)&nbsp;You&nbsp;should&nbsp;fix&nbsp;that&nbsp;race,&nbsp;it&nbsp;can&nbsp;be&nbsp;done&nbsp;safely:&lt;br&gt;<br>
&lt;br&gt;<br>
Do&nbsp;not&nbsp;use&nbsp;rabbitmq-server&nbsp;-detached&nbsp;and&nbsp;rabbitmqctl&nbsp;status&nbsp;to&nbsp;get&nbsp;the&nbsp;pid.&nbsp;Instead&nbsp;set&nbsp;RABBITMQ_PID_FILE&nbsp;and&nbsp;background&nbsp;the&nbsp;rabbitmq-server&nbsp;script.&nbsp;You&nbsp;will&nbsp;then&nbsp;*definitely*&nbsp;get&nbsp;the&nbsp;right&nbsp;pid&nbsp;since&nbsp;the&nbsp;script&nbsp;writes&nbsp;its&nbsp;own&nbsp;pid&nbsp;then&nbsp;execs&nbsp;-&nbsp;no&nbsp;race&nbsp;possible.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
2)&nbsp;Capture&nbsp;the&nbsp;stdout&nbsp;of&nbsp;rabbitmq-server&nbsp;when&nbsp;you&nbsp;start&nbsp;it&nbsp;-&nbsp;if&nbsp;rabbitmqctl&nbsp;wait&nbsp;still&nbsp;hangs,&nbsp;see&nbsp;how&nbsp;far&nbsp;it&amp;#39;s&nbsp;got&nbsp;/&nbsp;what&nbsp;it&amp;#39;s&nbsp;doing.&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&nbsp;Simon&lt;br&gt;<br>
&lt;br&gt;<br>
--&nbsp;&lt;br&gt;<br>
Simon&nbsp;MacMullen&lt;br&gt;<br>
RabbitMQ,&nbsp;VMware&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
