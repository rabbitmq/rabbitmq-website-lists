<tt>
Hi,<br>
&lt;br&gt;<br>
&lt;br&gt;2&nbsp;days&nbsp;ago&nbsp;I&nbsp;have&nbsp;upgraded&nbsp;our&nbsp;RabbitMQ&nbsp;cluster&nbsp;(2&nbsp;machines&nbsp;running&nbsp;in&nbsp;<br>
HA&nbsp;mode)&nbsp;from&nbsp;2.8.1&nbsp;to&nbsp;2.8.5.<br>
&lt;br&gt;Mainly&nbsp;to&nbsp;get&nbsp;those&nbsp;OOD&nbsp;fixes&nbsp;in,&nbsp;since&nbsp;we&nbsp;experienced&nbsp;those&nbsp;exact&nbsp;issues.<br>
&lt;br&gt;<br>
&lt;br&gt;The&nbsp;upgrade&nbsp;went&nbsp;very&nbsp;smooth,&nbsp;but&nbsp;at&nbsp;some&nbsp;point&nbsp;one&nbsp;of&nbsp;the&nbsp;machines&nbsp;<br>
(server2)&nbsp;started&nbsp;to&nbsp;allocate&nbsp;more<br>
&lt;br&gt;and&nbsp;more&nbsp;memory&nbsp;(even&nbsp;though&nbsp;all&nbsp;queues&nbsp;are&nbsp;more&nbsp;or&nbsp;less&nbsp;at&nbsp;0&nbsp;with&nbsp;<br>
almost&nbsp;no&nbsp;outstanding&nbsp;acks)<br>
&lt;br&gt;<br>
&lt;br&gt;server&nbsp;1&nbsp;uses&nbsp;~200Mb<br>
&lt;br&gt;server&nbsp;2&nbsp;(at&nbsp;the&nbsp;point&nbsp;where&nbsp;I&nbsp;took&nbsp;it&nbsp;down)&nbsp;used&nbsp;~6Gb<br>
&lt;br&gt;<br>
&lt;br&gt;I&nbsp;run&nbsp;a&nbsp;rabbitmqctl&nbsp;report...&nbsp;but&nbsp;it&nbsp;didn&amp;#39;t&nbsp;give&nbsp;me&nbsp;any&nbsp;insights<br>
&lt;br&gt;I&nbsp;run&nbsp;a&nbsp;rabbitmqctl&nbsp;eval&nbsp;&amp;#39;erlang:memory().&amp;#39;&nbsp;but&nbsp;that&nbsp;didn&amp;#39;t&nbsp;tell&nbsp;me&nbsp;too&nbsp;<br>
much&nbsp;more&nbsp;(but&nbsp;I&nbsp;will&nbsp;attach&nbsp;that&nbsp;at&nbsp;the&nbsp;end)<br>
&lt;br&gt;<br>
&lt;br&gt;I&nbsp;found&nbsp;people&nbsp;with&nbsp;similar&nbsp;problems:<br>
&lt;br&gt;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://grokbase.com/t/rabbitmq/rabbitmq-discuss/1223qcx3gg/rabbitmq-memory-usage-in-two-node-cluster&quot;&gt;http://grokbase.com/t/rabbitmq/rabbitmq-discuss/1223qcx3gg/rabbitmq-memory-usage-in-two-node-cluster&lt;/a&gt;&nbsp;<br>
<br>
&lt;br&gt;but&nbsp;that&amp;#39;s&nbsp;a&nbsp;while&nbsp;back&nbsp;so&nbsp;many&nbsp;things&nbsp;might&nbsp;have&nbsp;changed&nbsp;since&nbsp;then.&nbsp;<br>
Also&nbsp;the&nbsp;memory&nbsp;difference&nbsp;was<br>
&lt;br&gt;rather&nbsp;minimal,&nbsp;whereas&nbsp;here&nbsp;the&nbsp;difference&nbsp;is&nbsp;&lt;span&nbsp;class=&quot;moz-txt-underscore&quot;&gt;&lt;span&nbsp;class=&quot;moz-txt-tag&quot;&gt;_&lt;/span&gt;very&lt;span&nbsp;class=&quot;moz-txt-tag&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&nbsp;significant,&nbsp;<br>
especially&nbsp;since&nbsp;the&nbsp;node&nbsp;with&nbsp;less&nbsp;load<br>
&lt;br&gt;has&nbsp;the&nbsp;increased&nbsp;memory&nbsp;footprint.<br>
&lt;br&gt;<br>
&lt;br&gt;I&nbsp;can&nbsp;upgrade&nbsp;to&nbsp;2.8.6&nbsp;(unfortunately&nbsp;I&nbsp;upgraded&nbsp;just&nbsp;before&nbsp;it&nbsp;was&nbsp;<br>
released&nbsp;:-(),&nbsp;but&nbsp;I&nbsp;only&nbsp;want&nbsp;to&nbsp;do&nbsp;that&nbsp;if<br>
&lt;br&gt;there&nbsp;is&nbsp;some&nbsp;hope&nbsp;that&nbsp;the&nbsp;problem&nbsp;is&nbsp;solved.<br>
&lt;br&gt;I&nbsp;can&nbsp;bring&nbsp;server2&nbsp;back&nbsp;online&nbsp;and&nbsp;try&nbsp;to&nbsp;investigate&nbsp;what&nbsp;is&nbsp;consuming&nbsp;<br>
that&nbsp;much&nbsp;memory,&nbsp;but&nbsp;my<br>
&lt;br&gt;RabbitMQ/Erlang&nbsp;knowledge&nbsp;is&nbsp;not&nbsp;good&nbsp;enough,&nbsp;therefore&nbsp;reaching&nbsp;out&nbsp;for&nbsp;<br>
some&nbsp;help.<br>
&lt;br&gt;<br>
&lt;br&gt;So&nbsp;any&nbsp;help&nbsp;would&nbsp;be&nbsp;much&nbsp;appreciated.<br>
&lt;br&gt;<br>
&lt;br&gt;Thx<br>
&lt;br&gt;Matthias<br>
&lt;br&gt;<br>
&lt;br&gt;Our&nbsp;setup&nbsp;is&nbsp;something&nbsp;like&nbsp;the&nbsp;following:<br>
&lt;br&gt;     &nbsp;2&nbsp;servers&nbsp;exclusively&nbsp;running&nbsp;RabbitMQ&nbsp;on&nbsp;CentOS&nbsp;5.x&nbsp;(high&nbsp;<br>
watermark&nbsp;~22Gb),<br>
&lt;br&gt;           &nbsp;-&nbsp;both&nbsp;with&nbsp;web-console&nbsp;enabled<br>
&lt;br&gt;           &nbsp;-&nbsp;both&nbsp;defined&nbsp;as&nbsp;disk&nbsp;nodes<br>
&lt;br&gt;           &nbsp;-&nbsp;both&nbsp;running&nbsp;RabbitMQ&nbsp;2.8.5&nbsp;on&nbsp;Erlang&nbsp;R15B01&nbsp;(after&nbsp;the&nbsp;<br>
upgrade,&nbsp;Erlang&nbsp;was&nbsp;already&nbsp;at&nbsp;R15&nbsp;before)<br>
&lt;br&gt;   &nbsp;10&nbsp;queues&nbsp;configured&nbsp;with&nbsp;mirroring<br>
&lt;br&gt;     &nbsp;3&nbsp;queues&nbsp;configured&nbsp;(without&nbsp;mirroring)&nbsp;only&nbsp;on&nbsp;server1&nbsp;with&nbsp;a&nbsp;TTL<br>
&lt;br&gt;   &nbsp;Most&nbsp;consumers&nbsp;are&nbsp;connecting&nbsp;to&nbsp;server1,&nbsp;server2&nbsp;only&nbsp;in&nbsp;case&nbsp;of&nbsp;<br>
failover<br>
&lt;br&gt;<br>
&lt;br&gt;We&nbsp;get&nbsp;about&nbsp;1k&nbsp;messages/sec&nbsp;(with&nbsp;peaks&nbsp;much&nbsp;higher&nbsp;than&nbsp;that)&nbsp;into&nbsp;the&nbsp;<br>
system,&nbsp;and&nbsp;each&nbsp;message&nbsp;is<br>
&lt;br&gt;passed&nbsp;through&nbsp;several&nbsp;queues&nbsp;for&nbsp;processing.<br>
&lt;br&gt;<br>
&lt;br&gt;-bash-3.2$&nbsp;sbin/rabbitmqctl&nbsp;eval&nbsp;&amp;#39;erlang:memory().&amp;#39;<br>
&lt;br&gt;[{total,5445584424},<br>
&lt;br&gt; {processes,2184155418},<br>
&lt;br&gt; {processes_used,2184122352},<br>
&lt;br&gt; {system,3261429006},<br>
&lt;br&gt; {atom,703377},<br>
&lt;br&gt; {atom_used,678425},<br>
&lt;br&gt; {binary,3216386480},<br>
&lt;br&gt; {code,17978535},<br>
&lt;br&gt; {ets,4142048}]<br>
&lt;br&gt;...done.&lt;br&gt;&lt;br&gt;PS:&nbsp;Sorry&nbsp;for&nbsp;the&nbsp;eventual&nbsp;spam&nbsp;(caused&nbsp;by&nbsp;mail-box&nbsp;mix&nbsp;up&nbsp;:-(&lt;br&gt;<br>

</tt>
