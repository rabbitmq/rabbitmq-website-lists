<tt>
Hi&nbsp;everyone,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Hoping&nbsp;someone&nbsp;can&nbsp;help&nbsp;me&nbsp;with&nbsp;this&nbsp;problem.&nbsp;&amp;nbsp;After&nbsp;going&nbsp;through&nbsp;a&nbsp;few&nbsp;tutorials,&nbsp;I've&nbsp;pieced&nbsp;together&nbsp;some&nbsp;code&nbsp;the&nbsp;produce&nbsp;and&nbsp;consume&nbsp;messages.&nbsp;&amp;nbsp;I'm&nbsp;using&nbsp;kombu.&nbsp;&amp;nbsp;I'lll&nbsp;past&nbsp;the&nbsp;code&nbsp;below.&nbsp;&amp;nbsp;But&nbsp;the&nbsp;idea&nbsp;is&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;send&nbsp;many&nbsp;messages&nbsp;to&nbsp;the&nbsp;queue,&nbsp;possibly&nbsp;hundreds,&nbsp;then&nbsp;have&nbsp;a&nbsp;periodic&nbsp;task&nbsp;that&nbsp;wakes&nbsp;up&nbsp;and&nbsp;consumes&nbsp;all&nbsp;messages.&nbsp;&amp;nbsp;Right&nbsp;now&nbsp;I&nbsp;haven't&nbsp;set&nbsp;up&nbsp;the&nbsp;periodic&nbsp;task.&nbsp;&amp;nbsp;It's&nbsp;just&nbsp;a&nbsp;simply&nbsp;python&nbsp;file.&nbsp;&amp;nbsp;When&nbsp;passed&nbsp;&quot;produce,&quot;&nbsp;it&nbsp;produces&nbsp;some&nbsp;random&nbsp;messages.&nbsp;&amp;nbsp;When&nbsp;passed&nbsp;&quot;consume,&quot;&nbsp;it&nbsp;consumes&nbsp;them.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I've&nbsp;found&nbsp;that&nbsp;when&nbsp;the&nbsp;total&nbsp;messages&nbsp;is&nbsp;in&nbsp;increments&nbsp;of&nbsp;10&nbsp;(90,&nbsp;100,&nbsp;510,&nbsp;etc.),&nbsp;all&nbsp;messages&nbsp;get&nbsp;processed&nbsp;correctly&nbsp;and&nbsp;the&nbsp;qsize&nbsp;value&nbsp;shows&nbsp;there&nbsp;are&nbsp;0&nbsp;messages&nbsp;remaining.&nbsp;&amp;nbsp;However&nbsp;--&nbsp;and&nbsp;this&nbsp;is&nbsp;better&nbsp;explained&nbsp;by&nbsp;example&nbsp;-&nbsp;if&nbsp;the&nbsp;queue&nbsp;contains&nbsp;78&nbsp;messages,&nbsp;after&nbsp;processing&nbsp;all&nbsp;of&nbsp;them,&nbsp;the&nbsp;queue&nbsp;reports&nbsp;8&nbsp;remaining,&nbsp;but&nbsp;the&nbsp;consumer&nbsp;can&nbsp;no&nbsp;longer&nbsp;get&nbsp;them&nbsp;(times&nbsp;out).&nbsp;&amp;nbsp;Any&nbsp;time&nbsp;the&nbsp;total&nbsp;qsize&nbsp;at&nbsp;the&nbsp;start&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;10&nbsp;increment&nbsp;(129,&nbsp;523,&nbsp;234,&nbsp;etc.),&nbsp;the&nbsp;part&nbsp;beyond&nbsp;the&nbsp;latest&nbsp;10&nbsp;increment&nbsp;is&nbsp;left&nbsp;remaining&nbsp;(9,&nbsp;3,&nbsp;4,&nbsp;etc.).&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I've&nbsp;added&nbsp;some&nbsp;print&nbsp;statements&nbsp;to&nbsp;confirm&nbsp;that&nbsp;each&nbsp;message&nbsp;is&nbsp;actually&nbsp;consumed&nbsp;correctly,&nbsp;and&nbsp;the&nbsp;ack()&nbsp;is&nbsp;being&nbsp;called&nbsp;for&nbsp;each&nbsp;one.&nbsp;&amp;nbsp;However,&nbsp;I&nbsp;noticed&nbsp;that&nbsp;the&nbsp;qsize&nbsp;value&nbsp;is&nbsp;only&nbsp;being&nbsp;updated&nbsp;every&nbsp;10&nbsp;messages.&nbsp;&amp;nbsp;Here's&nbsp;the&nbsp;log&nbsp;for&nbsp;some&nbsp;of&nbsp;them&nbsp;to&nbsp;give&nbsp;you&nbsp;a&nbsp;better&nbsp;idea.&nbsp;The&nbsp;first&nbsp;number&nbsp;is&nbsp;the&nbsp;counter.&nbsp;&amp;nbsp;It's&nbsp;shown&nbsp;three&nbsp;times&nbsp;for&nbsp;each&nbsp;message&nbsp;because&nbsp;I'm&nbsp;printing&nbsp;before&nbsp;the&nbsp;get,&nbsp;after&nbsp;the&nbsp;get,&nbsp;then&nbsp;after&nbsp;the&nbsp;ack().&nbsp;&amp;nbsp;Notice&nbsp;the&nbsp;qsize&nbsp;value&nbsp;only&nbsp;updates&nbsp;every&nbsp;10&nbsp;messages:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;--------------------------------------------------------------------------------&lt;/div&gt;&lt;div&gt;Total&nbsp;Messages:&nbsp;78&lt;/div&gt;&lt;div&gt;--------------------------------------------------------------------------------&lt;/div&gt;&lt;div&gt;Counter&nbsp;|&nbsp;Status&lt;/div&gt;&lt;div&gt;0:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;0:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;0:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;1:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;1:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;1:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;2:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;2:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;2:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;3:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;3:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;3:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;4:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;4:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;4:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;5:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;5:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;5:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;6:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;6:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;6:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;7:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;7:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;7:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;8:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;8:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;8:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;78&lt;/div&gt;&lt;div&gt;9:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;78&lt;/div&gt;&lt;div&gt;9:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;68&lt;/div&gt;&lt;div&gt;9:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;68&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;it&nbsp;just&nbsp;some&nbsp;configuration&nbsp;I&nbsp;have&nbsp;to&nbsp;set?&nbsp;&amp;nbsp;Or&nbsp;is&nbsp;there&nbsp;something&nbsp;wrong&nbsp;in&nbsp;the&nbsp;code?&nbsp;&amp;nbsp;Here's&nbsp;the&nbsp;code&nbsp;in&nbsp;full:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;import&nbsp;sys&lt;/div&gt;&lt;div&gt;from&nbsp;contextlib&nbsp;import&nbsp;closing&lt;/div&gt;&lt;div&gt;from&nbsp;django.conf&nbsp;import&nbsp;settings&lt;/div&gt;&lt;div&gt;from&nbsp;django.dispatch&nbsp;import&nbsp;Signal&lt;/div&gt;&lt;div&gt;from&nbsp;django.dispatch&nbsp;import&nbsp;receiver&lt;/div&gt;&lt;div&gt;from&nbsp;kombu&nbsp;import&nbsp;BrokerConnection&lt;/div&gt;&lt;div&gt;from&nbsp;Queue&nbsp;import&nbsp;Empty&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Test&nbsp;Stuff:&lt;/div&gt;&lt;div&gt;queue_name&nbsp;=&nbsp;&quot;my.messages&quot;&lt;/div&gt;&lt;div&gt;test_messages_to_produce&nbsp;=&nbsp;78&lt;/div&gt;&lt;div&gt;consumer_batch_size&nbsp;=&nbsp;100&lt;/div&gt;&lt;div&gt;consumer_timeout&nbsp;=&nbsp;5&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;class&nbsp;UserMessenger(object):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;&quot;&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;Class&nbsp;for&nbsp;producing&nbsp;and&nbsp;consuming&nbsp;messages&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;&quot;&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;connection,&nbsp;queue_name,&nbsp;serializer=&quot;json&quot;,&nbsp;compression=None):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.queue&nbsp;=&nbsp;connection.SimpleQueue(queue_name)&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.serializer&nbsp;=&nbsp;serializer&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.compression&nbsp;=&nbsp;compression&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;produce_message(self,&nbsp;context={}):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.queue.put(context,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;serializer=self.serializer,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;compression=self.compression)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;consume_messages(self,&nbsp;callback,&nbsp;messages_to_get=1,&nbsp;timeout=1):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(messages_to_get):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;try:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;before_get&nbsp;=&nbsp;self.get_message_count()&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;message&nbsp;=&nbsp;self.queue.get(block=True,&nbsp;timeout=timeout)&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;callback(message.payload)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;after_get_before_ack&nbsp;=&nbsp;self.get_message_count()&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;message.ack()&nbsp;#&nbsp;remove&nbsp;message&nbsp;from&nbsp;queue&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;after_get_after_ack&nbsp;=&nbsp;self.get_message_count()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;deserialized&nbsp;=&nbsp;message.payload&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;user_id&nbsp;=&nbsp;deserialized[&quot;user_id&quot;]&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;print(&quot;%d:&nbsp;amount&nbsp;before&nbsp;queue.get:&nbsp;%d&quot;&nbsp;%&nbsp;(user_id,&nbsp;before_get))&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;print(&quot;%d:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;before&nbsp;ack():&nbsp;%d&quot;&nbsp;%&nbsp;(user_id,&nbsp;after_get_before_ack))&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;print(&quot;%d:&nbsp;amount&nbsp;after&nbsp;queue.get,&nbsp;after&nbsp;ack():&nbsp;%d&quot;&nbsp;%&nbsp;(user_id,&nbsp;after_get_after_ack))&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;except&nbsp;Empty&nbsp;as&nbsp;e:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;break;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;get_message_count(self):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;return&nbsp;self.queue.qsize()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;purge_messages(self):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.queue.clear()&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;close(self):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.queue.close()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;def&nbsp;produce():&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;with&nbsp;BrokerConnection(settings.BROKER_URL)&nbsp;as&nbsp;connection:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;with&nbsp;closing(UserMessenger(connection,&nbsp;queue_name))&nbsp;as&nbsp;messenger:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;#Just&nbsp;produce&nbsp;some&nbsp;random&nbsp;messages&nbsp;for&nbsp;now:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(test_messages_to_produce):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;context&nbsp;=&nbsp;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;user_id&quot;:&nbsp;i,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;changed_fields&quot;:&nbsp;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;'first_name':&nbsp;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;'before':'albert',&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;'after':'Albert'&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;}}}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;messenger.produce_message(context)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;def&nbsp;consume():&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;messages&nbsp;=&nbsp;[]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;def&nbsp;consume_message_callback(message):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;&quot;&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;This&nbsp;callback&nbsp;passed&nbsp;to&nbsp;the&nbsp;messenger&nbsp;consume_messages&nbsp;method,&nbsp;which&nbsp;calls&nbsp;it&nbsp;for&nbsp;each&nbsp;message.&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;Just&nbsp;append&nbsp;to&nbsp;messages&nbsp;for&nbsp;now.&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;&quot;&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;if&nbsp;message&nbsp;is&nbsp;not&nbsp;None:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;messages.append(message)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;with&nbsp;BrokerConnection(settings.BROKER_URL)&nbsp;as&nbsp;connection:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;with&nbsp;closing(UserMessenger(connection,&nbsp;queue_name))&nbsp;as&nbsp;messenger:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;messages_count&nbsp;=&nbsp;messenger.get_message_count()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;#&nbsp;Debug:&nbsp;How&nbsp;many&nbsp;total?&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;print&nbsp;&quot;-&quot;&nbsp;*&nbsp;80;&nbsp;print&nbsp;&quot;Total&nbsp;Messages:&nbsp;%d&quot;&nbsp;%&nbsp;messages_count;&nbsp;print&nbsp;&quot;-&quot;&nbsp;*&nbsp;80&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(0,&nbsp;messages_count,&nbsp;consumer_batch_size):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;messenger.consume_messages(&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;consume_message_callback,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;messages_to_get&nbsp;=&nbsp;consumer_batch_size,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;timeout&nbsp;=&nbsp;consumer_timeout,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;#&nbsp;Debug:&nbsp;Print&nbsp;the&nbsp;results.&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;print&nbsp;&quot;Should&nbsp;be&nbsp;done&nbsp;now.&nbsp;&amp;nbsp;Let's&nbsp;see&nbsp;what&nbsp;we&nbsp;have:&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;for&nbsp;message&nbsp;in&nbsp;messages:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;print&nbsp;message&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;def&nbsp;purge():&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;&quot;&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;Delete&nbsp;messages&nbsp;(for&nbsp;debugging)&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;&quot;&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;with&nbsp;BrokerConnection(settings.BROKER_URL)&nbsp;as&nbsp;connection:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;with&nbsp;closing(UserMessenger(connection,&nbsp;queue_name))&nbsp;as&nbsp;messenger:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;messenger.purge_messages()&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;def&nbsp;status():&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;&quot;&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;Get&nbsp;messages&nbsp;on&nbsp;queue&nbsp;(for&nbsp;debugging)&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&quot;&quot;&quot;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;with&nbsp;BrokerConnection(settings.BROKER_URL)&nbsp;as&nbsp;connection:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;with&nbsp;closing(UserMessenger(connection,&nbsp;queue_name))&nbsp;as&nbsp;messenger:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;print(&quot;Remaining&nbsp;messages:&nbsp;%d&quot;&nbsp;%&nbsp;messenger.queue.qsize())&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;if&nbsp;sys.argv[0].startswith(&quot;python&quot;):&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;option_index&nbsp;=&nbsp;2&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;else:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;option_index&nbsp;=&nbsp;1&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;option&nbsp;=&nbsp;sys.argv[option_index]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;if&nbsp;option&nbsp;==&nbsp;&quot;produce&quot;:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;produce()&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;elif&nbsp;option&nbsp;==&nbsp;&quot;consume&quot;:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;consume()&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;elif&nbsp;option&nbsp;==&nbsp;&quot;purge&quot;:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;purge()&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;elif&nbsp;option&nbsp;==&nbsp;&quot;status&quot;:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;status()&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;else:&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;print&nbsp;&quot;Unknown&nbsp;option&nbsp;'%s';&nbsp;exiting&nbsp;...&quot;&nbsp;%&nbsp;option&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;sys.exit(1)&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;
</tt>
