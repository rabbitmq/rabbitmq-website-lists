<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;We&nbsp;are&nbsp;running&nbsp;RabbitMQ&nbsp;v3.3.1&nbsp;and&nbsp;librabbitmq&nbsp;v1.5.2&nbsp;and&nbsp;have&nbsp;noticed&nbsp;that&nbsp;our&nbsp;client&nbsp;is&nbsp;periodically&nbsp;getting&nbsp;these&nbsp;exceptions:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;span&nbsp;class=&quot;t&quot;&gt;ChannelError&lt;/span&gt;:&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;channel&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;error&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;406&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;,&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;span&nbsp;class=&quot;t&quot;&gt;message&lt;/span&gt;:&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;span&nbsp;class=&quot;t&quot;&gt;PRECONDITION&lt;/span&gt;_&lt;span&nbsp;class=&quot;t&quot;&gt;FAILED&lt;/span&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;-&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;unknown&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;delivery&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&quot;&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;tag&lt;/span&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;t&nbsp;a&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(253,&nbsp;233,&nbsp;168);&nbsp;border-top-width:&nbsp;4px;&nbsp;border-top-style:&nbsp;solid;&nbsp;border-top-color:&nbsp;rgb(253,&nbsp;233,&nbsp;168);&nbsp;border-bottom-width:&nbsp;4px;&nbsp;border-bottom-style:&nbsp;solid;&nbsp;border-bottom-color:&nbsp;rgb(253,&nbsp;233,&nbsp;168);&nbsp;color:&nbsp;rgb(50,&nbsp;73,&nbsp;106);&nbsp;font-family:&nbsp;'Droid&nbsp;Sans&nbsp;Mono',&nbsp;Consolas,&nbsp;Monaco,&nbsp;'Courier&nbsp;New',&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;line-height:&nbsp;16px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;span&nbsp;class=&quot;t&quot;&gt;704117&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;a&nbsp;dedicated&nbsp;separate&nbsp;connection&nbsp;and&nbsp;channel&nbsp;setup&nbsp;to&nbsp;receive&nbsp;the&nbsp;message&nbsp;and&nbsp;ack&nbsp;it&nbsp;back&nbsp;immediately.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;notice&nbsp;that&nbsp;the&nbsp;delivery&nbsp;tag&nbsp;of&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;one&nbsp;we're&lt;/div&gt;&lt;div&gt;trying&nbsp;to&nbsp;acknowledge&nbsp;back,&nbsp;so&nbsp;this&nbsp;tag&nbsp;ID&nbsp;appears&nbsp;to&nbsp;be&nbsp;consistent&nbsp;and&nbsp;one&nbsp;that&nbsp;RMQ&nbsp;should&nbsp;know&nbsp;about.&nbsp;&nbsp;However,&nbsp;it&nbsp;appears&nbsp;to&nbsp;trigger&nbsp;a&nbsp;PRECONDITION_FAILED,&nbsp;making&nbsp;us&nbsp;think&lt;/div&gt;&lt;div&gt;we&nbsp;made&nbsp;a&nbsp;duplicate&nbsp;ACK&nbsp;acknowledgment&nbsp;somewhere.&nbsp;&nbsp;We&nbsp;have&nbsp;placed&nbsp;logging&nbsp;statements&nbsp;to&nbsp;centralize&nbsp;all&nbsp;message&nbsp;acknowledgments&nbsp;and&nbsp;only&nbsp;see&nbsp;one&nbsp;ACK,&nbsp;confirming&nbsp;our&nbsp;belief&lt;/div&gt;&lt;div&gt;that&nbsp;it&nbsp;is&nbsp;a&nbsp;single&nbsp;ACK&nbsp;being&nbsp;made.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;noticed&nbsp;in&nbsp;this&nbsp;code&nbsp;(https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L741-750)&nbsp;that&nbsp;the&nbsp;record&nbsp;of&nbsp;the&nbsp;note&nbsp;being&lt;/div&gt;&lt;div&gt;sent&nbsp;is&nbsp;handled&nbsp;by&nbsp;the&nbsp;rabbit_writer&nbsp;process.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;pre&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-family:&nbsp;Consolas,&nbsp;'Liberation&nbsp;Mono',&nbsp;Menlo,&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;line-height:&nbsp;18px;&quot;&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC741&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;ok&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;o&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;=&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nn&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;rgb(85,&nbsp;85,&nbsp;85);&quot;&gt;rabbit_writer&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;:&lt;/span&gt;&lt;span&nbsp;class=&quot;nf&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;rgb(153,&nbsp;0,&nbsp;0);&nbsp;font-weight:&nbsp;bold;&quot;&gt;send_command&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC742&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;WriterPid&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC743&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;nl&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;#'basic.get_ok'&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;delivery_tag&lt;/span&gt;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;o&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;=&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;DeliveryTag&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC744&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;redelivered&lt;/span&gt;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;o&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;=&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;Redelivered&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC745&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;exchange&lt;/span&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;o&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;=&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;ExchangeName&lt;/span&gt;&lt;span&nbsp;class=&quot;nl&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;#resource.name&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC746&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;routing_key&lt;/span&gt;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;o&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;=&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;RoutingKey&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC747&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;message_count&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;o&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;=&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;MessageCount&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;},&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC748&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;Content&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;),&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC749&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;State1&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;o&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;=&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;monitor_delivering_queue&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;NoAck&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;QPid&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;QName&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;State&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;),&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC750&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;noreply&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;record_sent&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;none&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;ow&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;not&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;NoAck&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;),&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;Msg&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;State1&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;)};&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;However,&nbsp;the&nbsp;delivery&nbsp;tag&nbsp;information&nbsp;appears&nbsp;to&nbsp;get&nbsp;record&nbsp;later&nbsp;in&nbsp;https://github.com/rabbitmq/rabbitmq-server/blob/master/src/rabbit_channel.erl#L1380-1384:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;pre&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-family:&nbsp;Consolas,&nbsp;'Liberation&nbsp;Mono',&nbsp;Menlo,&nbsp;Courier,&nbsp;monospace;&nbsp;font-size:&nbsp;12px;&nbsp;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;line-height:&nbsp;18px;&quot;&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC1381&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;n&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;true&lt;/span&gt;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;o&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;font-weight:&nbsp;bold;&quot;&gt;-&gt;&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nn&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;rgb(85,&nbsp;85,&nbsp;85);&quot;&gt;queue&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;:&lt;/span&gt;&lt;span&nbsp;class=&quot;nf&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;rgb(153,&nbsp;0,&nbsp;0);&nbsp;font-weight:&nbsp;bold;&quot;&gt;in&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;({&lt;/span&gt;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;DeliveryTag&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;ConsumerTag&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;QPid&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;MsgId&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;}},&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;line&quot;&nbsp;id=&quot;LC1382&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;padding-left:&nbsp;10px;&nbsp;height:&nbsp;18px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;204);&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;nv&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&nbsp;color:&nbsp;teal;&quot;&gt;UAMQ&lt;/span&gt;&lt;span&nbsp;class=&quot;p&quot;&nbsp;style=&quot;box-sizing:&nbsp;border-box;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Our&nbsp;current&nbsp;workaround&nbsp;is&nbsp;to&nbsp;delay&nbsp;acknowledging&nbsp;the&nbsp;message&nbsp;instead&nbsp;of&nbsp;trying&nbsp;to&nbsp;ack&nbsp;it&nbsp;right&nbsp;away.&nbsp;&nbsp;The&nbsp;problem&nbsp;shows&nbsp;up&nbsp;intermittently,&nbsp;possibly&nbsp;when&nbsp;there&nbsp;are&nbsp;large&nbsp;queue&nbsp;volumes&nbsp;on&nbsp;the&nbsp;RMQ&nbsp;box&nbsp;and&nbsp;possibly&nbsp;when&nbsp;we&nbsp;start&nbsp;to&nbsp;queue&nbsp;up&nbsp;50-60K&nbsp;unacknowledged&nbsp;messages,&nbsp;which&nbsp;may&nbsp;cause&nbsp;issues&nbsp;for&nbsp;the&nbsp;delivery&nbsp;tag&nbsp;to&nbsp;be&nbsp;added&nbsp;to&nbsp;the&nbsp;unacked&nbsp;list&nbsp;(UAMQ).&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;13px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;13px;&quot;&gt;Is&nbsp;it&nbsp;possible&nbsp;there&nbsp;is&nbsp;a&nbsp;race&nbsp;condition&nbsp;in&nbsp;which&nbsp;the&nbsp;delivery&nbsp;tag&nbsp;received&nbsp;by&nbsp;the&nbsp;client&nbsp;has&nbsp;yet&nbsp;to&nbsp;be&nbsp;recorded?&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;13px;&quot;&gt;Again,&nbsp;the&nbsp;problem&nbsp;happens&nbsp;intermittently&nbsp;but&nbsp;would&nbsp;like&nbsp;to&nbsp;suggest&nbsp;changing&nbsp;the&nbsp;code&nbsp;to&nbsp;record&nbsp;the&nbsp;delivery&nbsp;tag&nbsp;(in&nbsp;record_sent()&nbsp;before&nbsp;dispatching&nbsp;rabbit_writer.&nbsp;&nbsp;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Would&nbsp;appreciate&nbsp;any&nbsp;thoughts&nbsp;about&nbsp;changing&nbsp;the&nbsp;code&nbsp;to&nbsp;add&nbsp;the&nbsp;message&nbsp;before&nbsp;responding&nbsp;back&nbsp;to&nbsp;the&nbsp;writer.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Roger&lt;/div&gt;&lt;/div&gt;
</tt>
