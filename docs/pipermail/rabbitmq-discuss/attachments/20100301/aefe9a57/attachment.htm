<tt>
Hi&nbsp;Matthew&nbsp;--&lt;br&gt;&lt;br&gt;Ok&nbsp;thanks&nbsp;for&nbsp;explaining&nbsp;in&nbsp;such&nbsp;detail&nbsp;the&nbsp;issue&nbsp;at&nbsp;hand.&nbsp;The&nbsp;queues&nbsp;aren&amp;#39;t&nbsp;supposed&nbsp;to&nbsp;normally&nbsp;be&nbsp;as&nbsp;big&nbsp;as&nbsp;they&nbsp;were&nbsp;so&nbsp;hopefully&nbsp;with&nbsp;smaller&nbsp;queues,&nbsp;the&nbsp;problem&nbsp;will&nbsp;be&nbsp;less&nbsp;pronounced&nbsp;in&nbsp;the&nbsp;future.&nbsp;&lt;br&gt;<br>
&lt;br&gt;thanks,&lt;br&gt;Scott&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Mar&nbsp;1,&nbsp;2010&nbsp;at&nbsp;9:49&nbsp;AM,&nbsp;Matthew&nbsp;Sackman&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthew@lshift.net&quot;&gt;matthew@lshift.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hi&nbsp;Scott,&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;Mon,&nbsp;Mar&nbsp;01,&nbsp;2010&nbsp;at&nbsp;09:35:29AM&nbsp;-0800,&nbsp;scott&nbsp;w&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&nbsp;I&amp;#39;ve&nbsp;noticed&nbsp;the&nbsp;following&nbsp;behavior&nbsp;when&nbsp;there&nbsp;are&nbsp;a&nbsp;large&nbsp;number&nbsp;of&lt;br&gt;<br>
&amp;gt;&nbsp;messages&nbsp;persisted&nbsp;to&nbsp;disk,&nbsp;e.g.&nbsp;&amp;gt;&nbsp;1M,&nbsp;and&nbsp;I&nbsp;restart&nbsp;rabbitmq.&nbsp;Initially,&lt;br&gt;<br>
&amp;gt;&nbsp;when&nbsp;I&nbsp;list&nbsp;the&nbsp;queues&nbsp;using&nbsp;rabbitmqctl&nbsp;it&nbsp;says&nbsp;there&nbsp;are&nbsp;no&nbsp;queues.&nbsp;Then&lt;br&gt;<br>
&amp;gt;&nbsp;after&nbsp;a&nbsp;minute&nbsp;or&nbsp;two&nbsp;a&nbsp;couple&nbsp;queues&nbsp;begin&nbsp;to&nbsp;appear&nbsp;and&nbsp;then&nbsp;after&nbsp;~5-10&lt;br&gt;<br>
&amp;gt;&nbsp;minutes&nbsp;all&nbsp;the&nbsp;queues&nbsp;show&nbsp;up.&nbsp;I&nbsp;am&nbsp;using&nbsp;branch&nbsp;bug21637.&nbsp;Is&nbsp;this&nbsp;expected&lt;br&gt;<br>
&amp;gt;&nbsp;behaviour?&nbsp;FWIW,&nbsp;I&nbsp;would&nbsp;have&nbsp;expected&nbsp;all&nbsp;of&nbsp;the&nbsp;queues&nbsp;themselves&nbsp;to&nbsp;show&lt;br&gt;<br>
&amp;gt;&nbsp;up&nbsp;immediately&nbsp;assuming&nbsp;that&nbsp;the&nbsp;queues&nbsp;and&nbsp;their&nbsp;sizes&nbsp;are&nbsp;indexed&nbsp;and&lt;br&gt;<br>
&amp;gt;&nbsp;stored&nbsp;separately&nbsp;from&nbsp;the&nbsp;actual&nbsp;data&nbsp;files.&lt;br&gt;<br>
&lt;br&gt;<br>
Yes,&nbsp;that&nbsp;is&nbsp;expected.&nbsp;Firstly,&nbsp;although&nbsp;ctl&nbsp;will&nbsp;respond,&nbsp;the&nbsp;tcp&lt;br&gt;<br>
listeners&nbsp;won&amp;#39;t&nbsp;be&nbsp;started&nbsp;at&nbsp;that&nbsp;point,&nbsp;so&nbsp;you&nbsp;are&nbsp;&amp;quot;safe&amp;quot;&nbsp;in&nbsp;the&nbsp;sense&lt;br&gt;<br>
that&nbsp;nothing&nbsp;else&nbsp;can&nbsp;come&nbsp;along&nbsp;and&nbsp;start&nbsp;creating&nbsp;or&nbsp;deleting&nbsp;queues.&lt;br&gt;<br>
&lt;br&gt;<br>
Secondly,&nbsp;what&nbsp;is&nbsp;going&nbsp;on&nbsp;is&nbsp;basically&nbsp;a&nbsp;pretty&nbsp;thorough&nbsp;fsck&nbsp;of&nbsp;the&lt;br&gt;<br>
data.&nbsp;I&nbsp;have&nbsp;spent&nbsp;a&nbsp;long&nbsp;time&nbsp;optimising&nbsp;this&nbsp;and&nbsp;basically&nbsp;it&nbsp;really&lt;br&gt;<br>
can&amp;#39;t&nbsp;be&nbsp;made&nbsp;to&nbsp;go&nbsp;much&nbsp;faster&nbsp;-&nbsp;the&nbsp;main&nbsp;reason&nbsp;why&nbsp;storing&nbsp;&amp;quot;clean&amp;quot;&lt;br&gt;<br>
shutdown&nbsp;and&nbsp;then&nbsp;restoring&nbsp;state&nbsp;isn&amp;#39;t&nbsp;sufficient&nbsp;for&nbsp;instant&nbsp;start&nbsp;up&lt;br&gt;<br>
is&nbsp;that&nbsp;on&nbsp;start&nbsp;up&nbsp;we&nbsp;have&nbsp;to&nbsp;go&nbsp;through&nbsp;the&nbsp;disk&nbsp;and&nbsp;delete&nbsp;any&lt;br&gt;<br>
messages&nbsp;that&nbsp;are&nbsp;transient&nbsp;(i.e.&nbsp;they&nbsp;only&nbsp;got&nbsp;pushed&nbsp;to&nbsp;disk&nbsp;due&nbsp;to&lt;br&gt;<br>
memory&nbsp;pressure).&nbsp;As&nbsp;such,&nbsp;we&nbsp;have&nbsp;to&nbsp;walk&nbsp;over&nbsp;every&nbsp;queue&nbsp;on&nbsp;disk.&lt;br&gt;<br>
This&nbsp;can&nbsp;take&nbsp;a&nbsp;long&nbsp;time.&lt;br&gt;<br>
&lt;br&gt;<br>
Finally,&nbsp;what&nbsp;you&amp;#39;re&nbsp;suggesting&nbsp;would&nbsp;require&nbsp;that&nbsp;we&nbsp;write&nbsp;out,&nbsp;eg&lt;br&gt;<br>
queue&nbsp;size&nbsp;(and&nbsp;flush&nbsp;disk&nbsp;caches),&nbsp;on&nbsp;every&nbsp;single&nbsp;publish&nbsp;and&lt;br&gt;<br>
deliver/get&nbsp;to&nbsp;and&nbsp;from&nbsp;the&nbsp;queue.&nbsp;Doing&nbsp;such&nbsp;a&nbsp;thing&nbsp;would&nbsp;be&lt;br&gt;<br>
phenominally&nbsp;expensive.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;it&nbsp;wasn&amp;#39;t&nbsp;for&nbsp;the&nbsp;fact&nbsp;that&nbsp;people&nbsp;(and&nbsp;AMQP)&nbsp;expect&nbsp;queues&nbsp;to&nbsp;know&lt;br&gt;<br>
their&nbsp;own&nbsp;length,&nbsp;we&nbsp;could&nbsp;probably&nbsp;drop&nbsp;transient&nbsp;messages&nbsp;lazily.&lt;br&gt;<br>
However,&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;day,&nbsp;the&nbsp;same&nbsp;amount&nbsp;of&nbsp;work&nbsp;has&nbsp;to&nbsp;be&nbsp;done.&lt;br&gt;<br>
It&amp;#39;s&nbsp;really&nbsp;just&nbsp;a&nbsp;matter&nbsp;of&nbsp;when&nbsp;it&nbsp;gets&nbsp;done.&lt;br&gt;<br>
&lt;br&gt;<br>
Matthew&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
