<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;Michael,&nbsp;had&nbsp;to&nbsp;decompile&nbsp;RabbitMQ.Client&nbsp;assembly&nbsp;and&nbsp;step&nbsp;through&nbsp;to&nbsp;find&nbsp;the&nbsp;issue.&nbsp; Apparently,&nbsp;my&nbsp;code&nbsp;doesn&#39;t&nbsp;always&nbsp;pass&nbsp;a&nbsp;non-null&nbsp;messageId.&nbsp; Setting&nbsp;a&nbsp;null&nbsp;messageId&nbsp;on&nbsp;the&nbsp;basicproperties&nbsp;is&nbsp;allowed&nbsp;but&nbsp;the&nbsp;writing&nbsp;of&nbsp;a&nbsp;null&nbsp;messageId&nbsp;on&nbsp;the&nbsp;wire&nbsp;will&nbsp;cause&nbsp;an&nbsp;error&nbsp;inside&nbsp;of RabbitMQ.Client.&nbsp; So&nbsp;moral&nbsp;of&nbsp;the&nbsp;story&nbsp;is&nbsp;don&#39;t&nbsp;ever&nbsp;set&nbsp;a&nbsp;basicproperties&nbsp;property&nbsp;unless&nbsp;it&#39;s&nbsp;non&nbsp;null&nbsp;(at&nbsp;least&nbsp;as&nbsp;of&nbsp;RabbitMQ.Client&nbsp;3.3.0).&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;put&nbsp;connection&nbsp;and&nbsp;channel&nbsp;logic&nbsp;back&nbsp;in&nbsp;the&nbsp;same&nbsp;method&nbsp;and&nbsp;it&nbsp;works&nbsp;great.&nbsp; &nbsp;Here&nbsp;is&nbsp;new&nbsp;working&nbsp;version.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;private&nbsp;void&nbsp;PublishMessage(byte[]&nbsp;message,&nbsp;Type&nbsp;messageType,&nbsp;string&nbsp;contentType,&nbsp;string&nbsp;messageId)&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; {&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(message&nbsp;==&nbsp;null&nbsp;||&nbsp;message.Length&nbsp;==&nbsp;0)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw&nbsp;new&nbsp;ArgumentNullException(&quot;message&quot;);&nbsp; &nbsp; &lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(messageType&nbsp;==&nbsp;null)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw&nbsp;new&nbsp;ArgumentNullException(&quot;messageType&quot;);&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(String.IsNullOrEmpty(contentType))&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw&nbsp;new&nbsp;ArgumentNullException(&quot;contentType&quot;);&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(String.IsNullOrEmpty(messageId))&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw&nbsp;new&nbsp;ArgumentNullException(&quot;messageId&quot;);&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var&nbsp;factory&nbsp;=&nbsp;new&nbsp;ConnectionFactory()&nbsp;{VirtualHost&nbsp;=&nbsp;this.VirtualHost,&nbsp;HostName&nbsp;=&nbsp;this.Host,&nbsp;UserName&nbsp;=&nbsp;this.User,&nbsp;Password&nbsp;=&nbsp;this.Password&nbsp;};&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; using&nbsp;(var&nbsp;connection&nbsp;=&nbsp;factory.CreateConnection())&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; using&nbsp;(var&nbsp;channel&nbsp;=&nbsp;connection.CreateModel())&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IBasicProperties&nbsp;props&nbsp;=&nbsp;channel.CreateBasicProperties();&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; props.SetPersistent(this.PersistMessages);&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //Mime&nbsp;time&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; props.ContentType&nbsp;=&nbsp;contentType;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; props.Type&nbsp;=&nbsp;messageType.FullName;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(!String.IsNullOrEmpty(messageId))&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //Must&nbsp;be&nbsp;careful&nbsp;not&nbsp;to&nbsp;set&nbsp;IBasicProperties&nbsp;with&nbsp;possible&nbsp;null&nbsp;value&nbsp;as&nbsp;this&nbsp;will&nbsp;cause&nbsp;serialization&nbsp;errors&nbsp;downstream&nbsp;(RabbitMQ.Client&nbsp;3.3.0)&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; props.MessageId&nbsp;=&nbsp;messageId;&nbsp; &nbsp; &lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //Note,&nbsp;may&nbsp;get&nbsp;AlreadyClosedException&nbsp;here&nbsp;if&nbsp;publishing&nbsp;to&nbsp;a&nbsp;incorrect&nbsp;exchange&nbsp;name&lt;/div&gt;&lt;div&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; channel.BasicPublish(this.ExchangeName,&nbsp;this.RoutingKey,&nbsp;props,&nbsp;message);&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;thanks&nbsp;for&nbsp;the&nbsp;help.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;scott&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Jun&nbsp;18,&nbsp;2014&nbsp;at&nbsp;10:05&nbsp;PM,&nbsp;Michael&nbsp;Klishin&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:mklishin@gopivotal.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mklishin@gopivotal.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt; On&nbsp;19&nbsp;June&nbsp;2014&nbsp;at&nbsp;07:02:17,&nbsp;Scott&nbsp;McFadden&nbsp;(&lt;a&nbsp;href=&quot;mailto:scott.kendall.mcfadden@gmail.com&quot;&gt;scott.kendall.mcfadden@gmail.com&lt;/a&gt;)&nbsp;wrote:&lt;br&gt;<br>
<br>
&gt;&nbsp;&gt;&nbsp;It&nbsp;makes&nbsp;me&nbsp;think&nbsp;I&nbsp;screwed&nbsp;up&nbsp;the&nbsp;server&nbsp;side&nbsp;configuration&lt;br&gt;<br>
&gt;&nbsp;when&nbsp;reinstalling.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;There&nbsp;is&nbsp;no&nbsp;configuration&nbsp;that&nbsp;can&nbsp;affect&nbsp;framing/frame&nbsp;interleaving&nbsp;in&nbsp;the&nbsp;client.&lt;br&gt;<br>
This&nbsp;is&nbsp;also&nbsp;the&nbsp;kind&nbsp;of&nbsp;issues&nbsp;that&nbsp;we&#39;d&nbsp;see&nbsp;reported&nbsp;constantly&nbsp;if&nbsp;it&nbsp;was&nbsp;a&nbsp;client&lt;br&gt;<br>
issue.&nbsp;Finally,&nbsp;it&nbsp;happens&nbsp;on&nbsp;a&nbsp;brand&nbsp;new&nbsp;connection.&lt;br&gt;<br>
&lt;br&gt;<br>
I&#39;d&nbsp;recommend&nbsp;doing&nbsp;two&nbsp;things:&lt;br&gt;<br>
&lt;br&gt;<br>
 *&nbsp;Running&nbsp;a&nbsp;tracer&nbsp;proxy&nbsp;in&nbsp;front&nbsp;of&nbsp;RabbitMQ&nbsp;[1]&nbsp;to&nbsp;see&nbsp;what&#39;s&nbsp;being&nbsp;sent&nbsp;on&nbsp;the&nbsp;wire&lt;br&gt;<br>
 *&nbsp;Open&nbsp;a&nbsp;connection&nbsp;on&nbsp;app&nbsp;start&nbsp;if&nbsp;you&nbsp;can&nbsp;instead&nbsp;of&nbsp;opening&nbsp;a&nbsp;new&nbsp;one&nbsp;per&nbsp;channel&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;the&nbsp;latter&nbsp;does&nbsp;not&nbsp;change&nbsp;anything,&nbsp;please&nbsp;post&nbsp;the&nbsp;output&nbsp;of&nbsp;the&nbsp;tracer.&lt;br&gt;<br>
&lt;br&gt;<br>
1. &lt;a&nbsp;href=&quot;http://www.rabbitmq.com/java-tools.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/java-tools.html&lt;/a&gt;,&nbsp;see&nbsp;Tracer&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;--&lt;br&gt;<br>
MK&lt;br&gt;<br>
&lt;br&gt;<br>
Software&nbsp;Engineer,&nbsp;Pivotal/RabbitMQ&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
