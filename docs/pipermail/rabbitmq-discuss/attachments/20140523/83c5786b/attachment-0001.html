<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hello&nbsp;all,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I`m&nbsp;just&nbsp;learning&nbsp;rabbitMQ&nbsp;and&nbsp;I&nbsp;ran&nbsp;into&nbsp;a&nbsp;problem.&lt;/div&gt;&lt;div&gt;&nbsp;&lt;/div&gt;&lt;div&gt;Using&nbsp;http://pecl.php.net/package/amqp&nbsp;version&nbsp;1.4&nbsp;(latest&nbsp;now)&nbsp;and&nbsp;RabbitMQ&nbsp;3.3.1.&lt;/div&gt;&lt;div&gt;We&nbsp;must&nbsp;use&nbsp;php5-fpm&nbsp;and&nbsp;persistent&nbsp;connections&nbsp;with&nbsp;amqp-&gt;pconnect().&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;a&nbsp;while&nbsp;(I&nbsp;guess&nbsp;65500&nbsp;requests)&nbsp;a&nbsp;problem&nbsp;occurs&nbsp;halting&nbsp;all&nbsp;writes&nbsp;&lt;/div&gt;&lt;div&gt;&quot;Could&nbsp;not&nbsp;create&nbsp;channel.&nbsp;Connection&nbsp;has&nbsp;no&nbsp;open&nbsp;channel&nbsp;slots&nbsp;remaining&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;From&nbsp;what&nbsp;I&nbsp;have&nbsp;read&nbsp;in&nbsp;the&nbsp;sources&nbsp;is&nbsp;because&nbsp;every&nbsp;tcp&nbsp;connection&nbsp;have&nbsp;an&nbsp;autoincrement&nbsp;channel&nbsp;ID&nbsp;that&nbsp;reaches&nbsp;its&nbsp;max.&nbsp;This&nbsp;happens&nbsp;because&nbsp;every&nbsp;request&nbsp;must&nbsp;use&nbsp;the&nbsp;channel,&nbsp;and&nbsp;is&nbsp;no&nbsp;way&nbsp;to&nbsp;use&nbsp;the&nbsp;same&nbsp;channel&nbsp;(&nbsp;I&nbsp;could&nbsp;not&nbsp;find&nbsp;a&nbsp;way&nbsp;into&nbsp;the&nbsp;php-amqp&nbsp;channel&nbsp;classs&nbsp;to&nbsp;make&nbsp;it&nbsp;persistent)&nbsp;and&nbsp;scripts&nbsp;cannot&nbsp;communicate&nbsp;(&nbsp;to&nbsp;use&nbsp;the&nbsp;same&nbsp;instance&nbsp;of&nbsp;the&nbsp;channel&nbsp;as&nbsp;php&nbsp;object).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;lower&nbsp;the&nbsp;php-fpm&nbsp;lifetime&nbsp;is&nbsp;not&nbsp;an&nbsp;option,&nbsp;and&nbsp;either&nbsp;decoupling&nbsp;the&nbsp;application-rabbitmq&nbsp;communication&nbsp;trough&nbsp;another&nbsp;technology/library&nbsp;etc.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;there&nbsp;any&nbsp;easy&nbsp;way&nbsp;to&nbsp;fix&nbsp;this&nbsp;?&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Theoretically&nbsp;it&nbsp;should&nbsp;be&nbsp;one&nbsp;channel&nbsp;per&nbsp;thread&nbsp;(php5-fpm&nbsp;worker&nbsp;in&nbsp;this&nbsp;case)&nbsp;but&nbsp;how&nbsp;can&nbsp;be&nbsp;achieved&nbsp;using&nbsp;this&nbsp;library&nbsp;?&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;code&nbsp;I`m&nbsp;using&nbsp;now&nbsp;(similar)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:&nbsp;0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;&nbsp;border-left-width:&nbsp;1px;&nbsp;border-left-color:&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;border-left-style:&nbsp;solid;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;$this-&gt;con&nbsp;=&nbsp;new&nbsp;AMQPConnection(array(&lt;br&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;'host'&nbsp;&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;=&gt;&nbsp;$this-&gt;con_params['host'],&lt;br&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;'port'&nbsp;&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;=&gt;&nbsp;$this-&gt;con_params['port'],&lt;br&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;'vhost'&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;=&gt;&nbsp;$this-&gt;con_params['vhost'],&lt;br&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;'login'&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;=&gt;&nbsp;$this-&gt;con_params['user'],&lt;br&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;'password'&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;=&gt;&nbsp;$this-&gt;con_params['pass'],&lt;br&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;'read_timeout'&nbsp;&nbsp;=&gt;&nbsp;1,//seconds&lt;br&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;'write_timeout'&nbsp;=&gt;&nbsp;1,//seconds&lt;br&gt;'connect_timeout'&nbsp;=&gt;&nbsp;1,//seconds&lt;br&gt;));&lt;br&gt;$this-&gt;con-&gt;pconnect();&lt;br&gt;$channel&nbsp;=&nbsp;new&nbsp;AMQPChannel($this-&gt;con);&lt;br&gt;$queue&nbsp;=&nbsp;new&nbsp;AMQPQueue($channel);&lt;br&gt;$queue-&gt;setName($queueName);&lt;br&gt;$queue-&gt;setFlags(AMQP_DURABLE);&lt;br&gt;//$queue-&gt;declareQueue();//make&nbsp;sure&nbsp;it&nbsp;exists&lt;br&gt;$exchange&nbsp;=&nbsp;new&nbsp;AMQPExchange($channel);&lt;br&gt;$exchange-&gt;setName($exchangeName);&lt;br&gt;$exchange-&gt;setFlags(AMQP_DURABLE);&lt;br&gt;$exchange-&gt;setType(AMQP_EX_TYPE_DIRECT);&lt;br&gt;//$exchange-&gt;declareExchange();&lt;br&gt;$this-&gt;queues[$queueName]-&gt;bind($exchangeName);&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;!!&lt;/div&gt;&lt;/div&gt;
</tt>
