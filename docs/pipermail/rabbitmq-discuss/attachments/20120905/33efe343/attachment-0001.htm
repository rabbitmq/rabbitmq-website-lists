<tt>
﻿&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;Transitional//EN&quot;&gt;<br>
&lt;HTML&gt;&lt;HEAD&gt;<br>
&lt;META&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;http-equiv=Content-Type&gt;<br>
&lt;STYLE&gt;<br>
BLOCKQUOTE&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMARGIN-TOP:&nbsp;0px;&nbsp;MARGIN-BOTTOM:&nbsp;0px;&nbsp;MARGIN-LEFT:&nbsp;2em<br>
}<br>
OL&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMARGIN-TOP:&nbsp;0px;&nbsp;MARGIN-BOTTOM:&nbsp;0px<br>
}<br>
UL&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMARGIN-TOP:&nbsp;0px;&nbsp;MARGIN-BOTTOM:&nbsp;0px<br>
}<br>
P&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMARGIN-TOP:&nbsp;0px;&nbsp;MARGIN-BOTTOM:&nbsp;0px<br>
}<br>
BODY&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspLINE-HEIGHT:&nbsp;1.5;&nbsp;FONT-FAMILY:&nbsp;宋体;&nbsp;COLOR:&nbsp;#000080;&nbsp;FONT-SIZE:&nbsp;10.5pt<br>
}<br>
&lt;/STYLE&gt;<br>
<br>
&lt;META&nbsp;name=GENERATOR&nbsp;content=&quot;MSHTML&nbsp;8.00.7601.17874&quot;&gt;&lt;/HEAD&gt;<br>
&lt;BODY&nbsp;style=&quot;MARGIN:&nbsp;10px&quot;&gt;<br>
&lt;DIV&gt;Thanks&nbsp;Matthias&nbsp;and&nbsp;Francesco.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;Your&nbsp;second&nbsp;approach&nbsp;is&nbsp;prefect&nbsp;and&nbsp;should&nbsp;work&nbsp;fine.&nbsp;I&nbsp;will&nbsp;choose&nbsp;this&nbsp;<br>
approach.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;However,&nbsp;I&nbsp;have&nbsp;little&nbsp;concern&nbsp;about&nbsp;the&nbsp;first&nbsp;approach.&nbsp;The&nbsp;<br>
channel.queueDeclarePassive&nbsp;method&nbsp;returns&nbsp;the&nbsp;consumer&nbsp;count&nbsp;of&nbsp;the&nbsp;specified&nbsp;<br>
channel,&nbsp;but&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;the&nbsp;consumers&nbsp;connected&nbsp;to&nbsp;the&nbsp;rabbitmq&nbsp;server.&nbsp;<br>
So&nbsp;if&nbsp;I&nbsp;start&nbsp;two&nbsp;consumers&nbsp;using&nbsp;the&nbsp;following&nbsp;code&nbsp;in&nbsp;two&nbsp;different&nbsp;machines,&nbsp;<br>
i.e.,&nbsp;two&nbsp;different&nbsp;JVMs,&amp;nbsp;each&nbsp;consumer&nbsp;needs&nbsp;to&nbsp;create&amp;nbsp;a&nbsp;<br>
new&amp;nbsp;connection&nbsp;and&nbsp;a&amp;nbsp;new&nbsp;channel.&nbsp;In&nbsp;this&nbsp;way,&nbsp;the&nbsp;<br>
channel.queueDeclarePassive&nbsp;method&amp;nbsp;always&nbsp;return&nbsp;the&nbsp;consumer&nbsp;count&nbsp;==&nbsp;1,&nbsp;<br>
not&nbsp;2.&nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&amp;nbsp;factory&amp;nbsp;=&amp;nbsp;new&amp;nbsp;ConnectionFactory();&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&amp;nbsp;connection&amp;nbsp;=&amp;nbsp;factory.newConnection(address);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&amp;nbsp;channel&amp;nbsp;=&amp;nbsp;connection.createChannel();&lt;/DIV&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;I&nbsp;also&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;API&nbsp;that&nbsp;can&nbsp;retrieve&nbsp;the&nbsp;existing&nbsp;connection&nbsp;or&nbsp;<br>
channel.&nbsp;Then&nbsp;the&nbsp;second&nbsp;consumer&nbsp;can&nbsp;reuse&nbsp;the&nbsp;connection&nbsp;or&nbsp;channel&nbsp;the&nbsp;first&nbsp;<br>
consumer&nbsp;created.&nbsp;But&nbsp;it&nbsp;seems&nbsp;no&nbsp;such&nbsp;APIs.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;HR&nbsp;style=&quot;WIDTH:&nbsp;210px;&nbsp;HEIGHT:&nbsp;1px&quot;&nbsp;align=left&nbsp;color=#b5c4df&nbsp;SIZE=1&gt;<br>
<br>
&lt;DIV&gt;&lt;SPAN&gt;johnson&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;<br>
style=&quot;BORDER-BOTTOM:&nbsp;medium&nbsp;none;&nbsp;BORDER-LEFT:&nbsp;medium&nbsp;none;&nbsp;PADDING-BOTTOM:&nbsp;0cm;&nbsp;PADDING-LEFT:&nbsp;0cm;&nbsp;PADDING-RIGHT:&nbsp;0cm;&nbsp;BORDER-TOP:&nbsp;#b5c4df&nbsp;1pt&nbsp;solid;&nbsp;BORDER-RIGHT:&nbsp;medium&nbsp;none;&nbsp;PADDING-TOP:&nbsp;3pt&quot;&gt;<br>
&lt;DIV&nbsp;<br>
style=&quot;PADDING-BOTTOM:&nbsp;8px;&nbsp;PADDING-LEFT:&nbsp;8px;&nbsp;PADDING-RIGHT:&nbsp;8px;&nbsp;BACKGROUND:&nbsp;#efefef;&nbsp;COLOR:&nbsp;#000000;&nbsp;FONT-SIZE:&nbsp;12px;&nbsp;PADDING-TOP:&nbsp;8px&quot;&gt;<br>
&lt;DIV&gt;&lt;B&gt;From:&lt;/B&gt;&amp;nbsp;&lt;A&nbsp;href=&quot;mailto:matthias@rabbitmq.com&quot;&gt;Matthias&nbsp;<br>
Radestock&lt;/A&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;B&gt;Date:&lt;/B&gt;&amp;nbsp;2012-08-31&amp;nbsp;19:39&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;B&gt;To:&lt;/B&gt;&amp;nbsp;&lt;A&nbsp;<br>
href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;Discussions&nbsp;about&nbsp;<br>
RabbitMQ&lt;/A&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;B&gt;CC:&lt;/B&gt;&amp;nbsp;&lt;A&nbsp;href=&quot;mailto:francesco@rabbitmq.com&quot;&gt;Francesco&nbsp;<br>
Mazzoli&lt;/A&gt;;&nbsp;&lt;A&nbsp;href=&quot;mailto:johnson@edocom.cn&quot;&gt;johnson&lt;/A&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;B&gt;Subject:&lt;/B&gt;&amp;nbsp;Re:&nbsp;[rabbitmq-discuss]&nbsp;How&nbsp;to&nbsp;achieve&nbsp;HA&nbsp;<br>
consumers?&lt;/DIV&gt;&lt;/DIV&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;DIV&gt;On&amp;nbsp;31/08/12&amp;nbsp;12:27,&amp;nbsp;Francesco&amp;nbsp;Mazzoli&amp;nbsp;wrote:&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;The&amp;nbsp;second&amp;nbsp;consumer&amp;nbsp;polls&amp;nbsp;the&amp;nbsp;first&amp;nbsp;in&amp;nbsp;some&amp;nbsp;way&amp;nbsp;and&amp;nbsp;starts&amp;nbsp;consuming&amp;nbsp;when&amp;nbsp;it&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;realises&amp;nbsp;the&amp;nbsp;first&amp;nbsp;consumer&amp;nbsp;is&amp;nbsp;dead.&amp;nbsp;&amp;nbsp;This&amp;nbsp;is&amp;nbsp;simple&amp;nbsp;and&amp;nbsp;should&amp;nbsp;serve&amp;nbsp;you&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;right,&amp;nbsp;but&amp;nbsp;it's&amp;nbsp;not&amp;nbsp;that&amp;nbsp;nice&amp;nbsp;performance&amp;nbsp;wise.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;A&amp;nbsp;passive&amp;nbsp;queue.declare,&amp;nbsp;which&amp;nbsp;returns&amp;nbsp;the&amp;nbsp;consumer_count&amp;nbsp;could&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;accomplish&amp;nbsp;this.&amp;nbsp;You'd&amp;nbsp;need&amp;nbsp;to&amp;nbsp;be&amp;nbsp;mindful&amp;nbsp;of&amp;nbsp;races&amp;nbsp;when&amp;nbsp;consumers&amp;nbsp;start&amp;nbsp;up.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;You&amp;nbsp;create&amp;nbsp;a&amp;nbsp;second&amp;nbsp;queue&amp;nbsp;that&amp;nbsp;we'll&amp;nbsp;call&amp;nbsp;&quot;token&amp;nbsp;queue&quot;,&amp;nbsp;and&amp;nbsp;you&amp;nbsp;publish&amp;nbsp;one&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;dummy&amp;nbsp;message&amp;nbsp;in&amp;nbsp;it,&amp;nbsp;with&amp;nbsp;acks&amp;nbsp;enabled.&amp;nbsp;&amp;nbsp;Then,&amp;nbsp;a&amp;nbsp;consumer&amp;nbsp;wishing&amp;nbsp;to&amp;nbsp;consume&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;from&amp;nbsp;your&amp;nbsp;queue,&amp;nbsp;will:&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;-&amp;nbsp;Consume&amp;nbsp;from&amp;nbsp;the&amp;nbsp;token&amp;nbsp;queue&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;More&amp;nbsp;specifically,&amp;nbsp;start&amp;nbsp;consuming&amp;nbsp;and&amp;nbsp;wait&amp;nbsp;for&amp;nbsp;the&amp;nbsp;token&amp;nbsp;message&amp;nbsp;to&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;arrive.&amp;nbsp;And&amp;nbsp;then...&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;-&amp;nbsp;Start&amp;nbsp;consuming&amp;nbsp;from&amp;nbsp;the&amp;nbsp;actual&amp;nbsp;queue&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;-&amp;nbsp;When&amp;nbsp;shutting&amp;nbsp;down,&amp;nbsp;publish&amp;nbsp;a&amp;nbsp;dummy&amp;nbsp;message&amp;nbsp;to&amp;nbsp;the&amp;nbsp;token&amp;nbsp;queue&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;No&amp;nbsp;need&amp;nbsp;for&amp;nbsp;the&amp;nbsp;last&amp;nbsp;step&amp;nbsp;(and&amp;nbsp;in&amp;nbsp;fact&amp;nbsp;it&amp;nbsp;will&amp;nbsp;lead&amp;nbsp;to&amp;nbsp;token&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;duplication).&amp;nbsp;Simply&amp;nbsp;leave&amp;nbsp;the&amp;nbsp;message&amp;nbsp;unack'ed&amp;nbsp;and&amp;nbsp;let&amp;nbsp;the&amp;nbsp;automatic&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;requeue&amp;nbsp;on&amp;nbsp;connection&amp;nbsp;closure/failure&amp;nbsp;take&amp;nbsp;care&amp;nbsp;of&amp;nbsp;the&amp;nbsp;rest.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;Matthias.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;&lt;/DIV&gt;&lt;/BODY&gt;&lt;/HTML&gt;<br>

</tt>
