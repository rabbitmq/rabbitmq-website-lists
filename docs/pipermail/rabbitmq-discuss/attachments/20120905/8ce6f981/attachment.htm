<tt>
﻿&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;Transitional//EN&quot;&gt;<br>
&lt;HTML&gt;&lt;HEAD&gt;<br>
&lt;META&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;http-equiv=Content-Type&gt;<br>
&lt;STYLE&gt;<br>
BLOCKQUOTE&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMARGIN-TOP:&nbsp;0px;&nbsp;MARGIN-BOTTOM:&nbsp;0px;&nbsp;MARGIN-LEFT:&nbsp;2em<br>
}<br>
OL&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMARGIN-TOP:&nbsp;0px;&nbsp;MARGIN-BOTTOM:&nbsp;0px<br>
}<br>
UL&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMARGIN-TOP:&nbsp;0px;&nbsp;MARGIN-BOTTOM:&nbsp;0px<br>
}<br>
P&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMARGIN-TOP:&nbsp;0px;&nbsp;MARGIN-BOTTOM:&nbsp;0px<br>
}<br>
BODY&nbsp;{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspLINE-HEIGHT:&nbsp;1.5;&nbsp;FONT-FAMILY:&nbsp;宋体;&nbsp;COLOR:&nbsp;#000080;&nbsp;FONT-SIZE:&nbsp;10.5pt<br>
}<br>
&lt;/STYLE&gt;<br>
<br>
&lt;META&nbsp;name=GENERATOR&nbsp;content=&quot;MSHTML&nbsp;8.00.7601.17874&quot;&gt;&lt;/HEAD&gt;<br>
&lt;BODY&nbsp;style=&quot;MARGIN:&nbsp;10px&quot;&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;Hi&nbsp;Matthias,&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;Thanks&nbsp;for&nbsp;your&nbsp;reply.&nbsp;I&nbsp;wrote&nbsp;some&nbsp;test&nbsp;code&nbsp;and&nbsp;found&nbsp;a&nbsp;wired&nbsp;<br>
problem.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;DIV&gt;The&amp;nbsp;init&amp;nbsp;code&amp;nbsp;is&amp;nbsp;like&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;factory&amp;nbsp;=&amp;nbsp;new&amp;nbsp;ConnectionFactory();&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;connection&amp;nbsp;=&amp;nbsp;factory.newConnection(address);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;channel&amp;nbsp;=&amp;nbsp;connection.createChannel();&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;channel.basicQos(1);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;And&amp;nbsp;the&amp;nbsp;receive&amp;nbsp;code&amp;nbsp;is&amp;nbsp;like&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;QueueingConsumer&amp;nbsp;consumer&amp;nbsp;=&amp;nbsp;new&amp;nbsp;QueueingConsumer(channel);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;boolean&amp;nbsp;autoAck&amp;nbsp;=&amp;nbsp;false;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;Queue.DeclareOk&amp;nbsp;declare&amp;nbsp;=&amp;nbsp;channel.queueDeclarePassive(&quot;LBCQueue&quot;);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;int&amp;nbsp;consumerCount&amp;nbsp;=&amp;nbsp;declare.getConsumerCount();&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;if&amp;nbsp;(consumerCount&amp;nbsp;&amp;gt;&amp;nbsp;0)&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&nbsp;return&amp;nbsp;false;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;channel.basicConsume(&quot;LBCQueue&quot;,&amp;nbsp;autoAck,&amp;nbsp;consumer);&lt;/DIV&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;First&amp;nbsp;I&amp;nbsp;started&amp;nbsp;the&amp;nbsp;first&amp;nbsp;consumer&amp;nbsp;and&amp;nbsp;didn't&amp;nbsp;publish&amp;nbsp;any&amp;nbsp;message.&nbsp;<br>
&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;IMG&nbsp;src=&quot;cid:_Foxmail.0@E5021B12-DF76-4489-B95D-44A01851CE5E&quot;&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;DIV&gt;Then&amp;nbsp;I&amp;nbsp;started&amp;nbsp;the&amp;nbsp;second&amp;nbsp;consumer&amp;nbsp;and&amp;nbsp;the&amp;nbsp;value&amp;nbsp;of&amp;nbsp;the&amp;nbsp;variable&amp;nbsp;declare&amp;nbsp;is&amp;nbsp;#method&amp;lt;queue.declare-ok&amp;gt;(queue=LBCQueue,&amp;nbsp;message-count=0,&amp;nbsp;consumer-count=1).&lt;/DIV&gt;<br>
&lt;DIV&gt;So&amp;nbsp;far&amp;nbsp;everything&amp;nbsp;is&amp;nbsp;OK.&lt;/DIV&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;DIV&gt;Now&amp;nbsp;I&amp;nbsp;publish&amp;nbsp;1&amp;nbsp;messge&amp;nbsp;into&amp;nbsp;the&amp;nbsp;queue&amp;nbsp;and&amp;nbsp;restart&amp;nbsp;the&amp;nbsp;second&amp;nbsp;consumer.&amp;nbsp;The&amp;nbsp;value&amp;nbsp;of&amp;nbsp;the&amp;nbsp;variable&amp;nbsp;declare&amp;nbsp;is&amp;nbsp;#method&amp;lt;queue.declare-ok&amp;gt;(queue=LBCQueue,&amp;nbsp;message-count=0,&amp;nbsp;consumer-count=1).&lt;/DIV&gt;<br>
&lt;DIV&gt;So&amp;nbsp;far&amp;nbsp;everything&amp;nbsp;is&amp;nbsp;still&amp;nbsp;OK.&lt;/DIV&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;IMG&nbsp;src=&quot;cid:_Foxmail.1@F9AF6563-F0B6-497D-B6D2-96E6852953D1&quot;&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;DIV&gt;Then&amp;nbsp;I&amp;nbsp;publish&amp;nbsp;another&amp;nbsp;message&amp;nbsp;into&amp;nbsp;the&amp;nbsp;queue&amp;nbsp;and&amp;nbsp;restart&amp;nbsp;the&amp;nbsp;second&amp;nbsp;consumer&amp;nbsp;again.&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;IMG&nbsp;src=&quot;cid:_Foxmail.2@751C887C-8CEB-41D7-94A1-9A17CA968CBA&quot;&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;This&amp;nbsp;time&amp;nbsp;the&amp;nbsp;value&amp;nbsp;of&amp;nbsp;declare&amp;nbsp;is&amp;nbsp;#method&amp;lt;queue.declare-ok&amp;gt;(queue=LBCQueue,&amp;nbsp;message-count=1,&amp;nbsp;consumer-count=0).&lt;/DIV&gt;<br>
&lt;DIV&gt;The&amp;nbsp;message-count&amp;nbsp;is&amp;nbsp;correct&amp;nbsp;but&amp;nbsp;the&amp;nbsp;consumer-count&amp;nbsp;is&amp;nbsp;changed&amp;nbsp;from&amp;nbsp;1&amp;nbsp;to&amp;nbsp;0.&amp;nbsp;I&amp;nbsp;don't&amp;nbsp;know&amp;nbsp;why.&nbsp;<br>
Is&nbsp;it&nbsp;a&nbsp;bug?&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;&lt;/DIV&gt;<br>
&lt;HR&nbsp;style=&quot;WIDTH:&nbsp;210px;&nbsp;HEIGHT:&nbsp;1px&quot;&nbsp;align=left&nbsp;color=#b5c4df&nbsp;SIZE=1&gt;<br>
<br>
&lt;DIV&gt;&lt;SPAN&gt;johnson&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;<br>
style=&quot;BORDER-BOTTOM:&nbsp;medium&nbsp;none;&nbsp;BORDER-LEFT:&nbsp;medium&nbsp;none;&nbsp;PADDING-BOTTOM:&nbsp;0cm;&nbsp;PADDING-LEFT:&nbsp;0cm;&nbsp;PADDING-RIGHT:&nbsp;0cm;&nbsp;BORDER-TOP:&nbsp;#b5c4df&nbsp;1pt&nbsp;solid;&nbsp;BORDER-RIGHT:&nbsp;medium&nbsp;none;&nbsp;PADDING-TOP:&nbsp;3pt&quot;&gt;<br>
&lt;DIV&nbsp;<br>
style=&quot;PADDING-BOTTOM:&nbsp;8px;&nbsp;PADDING-LEFT:&nbsp;8px;&nbsp;PADDING-RIGHT:&nbsp;8px;&nbsp;BACKGROUND:&nbsp;#efefef;&nbsp;COLOR:&nbsp;#000000;&nbsp;FONT-SIZE:&nbsp;12px;&nbsp;PADDING-TOP:&nbsp;8px&quot;&gt;<br>
&lt;DIV&gt;&lt;B&gt;From:&lt;/B&gt;&amp;nbsp;&lt;A&nbsp;href=&quot;mailto:matthias@rabbitmq.com&quot;&gt;Matthias&nbsp;<br>
Radestock&lt;/A&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;B&gt;Date:&lt;/B&gt;&amp;nbsp;2012-09-05&amp;nbsp;15:48&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;B&gt;To:&lt;/B&gt;&amp;nbsp;&lt;A&nbsp;href=&quot;mailto:johnson@edocom.cn&quot;&gt;johnson&lt;/A&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;B&gt;CC:&lt;/B&gt;&amp;nbsp;&lt;A&nbsp;<br>
href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss&lt;/A&gt;;&nbsp;&lt;A&nbsp;<br>
href=&quot;mailto:francesco@rabbitmq.com&quot;&gt;Francesco&nbsp;Mazzoli&lt;/A&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;B&gt;Subject:&lt;/B&gt;&amp;nbsp;Re:&nbsp;[rabbitmq-discuss]&nbsp;How&nbsp;to&nbsp;achieve&nbsp;HA&nbsp;<br>
consumers?&lt;/DIV&gt;&lt;/DIV&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;DIV&gt;Johnson,&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;On&amp;nbsp;05/09/12&amp;nbsp;05:32,&amp;nbsp;johnson&amp;nbsp;wrote:&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;The&amp;nbsp;channel.queueDeclarePassive&amp;nbsp;method&amp;nbsp;returns&amp;nbsp;the&amp;nbsp;consumer&amp;nbsp;count&amp;nbsp;of&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;&amp;nbsp;the&amp;nbsp;specified&amp;nbsp;channel,&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;No&amp;nbsp;it&amp;nbsp;doesn't.&amp;nbsp;queue.declarePassive&amp;nbsp;returns&amp;nbsp;the&amp;nbsp;total&amp;nbsp;number&amp;nbsp;of&amp;nbsp;active&lt;/DIV&gt;<br>
&lt;DIV&gt;consumers&amp;nbsp;of&amp;nbsp;the&amp;nbsp;queue&amp;nbsp;at&amp;nbsp;that&amp;nbsp;point&amp;nbsp;in&amp;nbsp;time.&amp;nbsp;Regardless&amp;nbsp;of&amp;nbsp;what&lt;/DIV&gt;<br>
&lt;DIV&gt;connection/channel&amp;nbsp;they&amp;nbsp;were&amp;nbsp;created&amp;nbsp;on.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;That&amp;nbsp;should&amp;nbsp;be&amp;nbsp;pretty&amp;nbsp;clear&amp;nbsp;from&amp;nbsp;the&amp;nbsp;docs&amp;nbsp;-&lt;/DIV&gt;<br>
&lt;DIV&gt;http://www.rabbitmq.com/amqp-0-9-1-reference.html#queue.declare-ok.consumer-count&lt;/DIV&gt;<br>
&lt;DIV&gt;-&amp;nbsp;which&amp;nbsp;make&amp;nbsp;no&amp;nbsp;mention&amp;nbsp;of&amp;nbsp;the&amp;nbsp;count&amp;nbsp;being&amp;nbsp;connection/channel&amp;nbsp;specific.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;So&amp;nbsp;if&amp;nbsp;I&amp;nbsp;start&amp;nbsp;two&amp;nbsp;consumers&amp;nbsp;[...]&amp;nbsp;in&amp;nbsp;two&amp;nbsp;different&amp;nbsp;machines&amp;nbsp;[...]&amp;nbsp;the&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;channel.queueDeclarePassive&amp;nbsp;method&amp;nbsp;always&amp;nbsp;return&amp;nbsp;the&amp;nbsp;consumer&amp;nbsp;count&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;==&amp;nbsp;1,&amp;nbsp;not&amp;nbsp;2.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;I&amp;nbsp;am&amp;nbsp;not&amp;nbsp;sure&amp;nbsp;what&amp;nbsp;you&amp;nbsp;are&amp;nbsp;expecting&amp;nbsp;to&amp;nbsp;see&amp;nbsp;here.&amp;nbsp;If&amp;nbsp;you&amp;nbsp;start&amp;nbsp;two&lt;/DIV&gt;<br>
&lt;DIV&gt;consumers,&amp;nbsp;the&amp;nbsp;count&amp;nbsp;they&amp;nbsp;will&amp;nbsp;see&amp;nbsp;prior&amp;nbsp;to&amp;nbsp;consuming&amp;nbsp;will&amp;nbsp;be&amp;nbsp;0&amp;nbsp;or&amp;nbsp;1.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;As&amp;nbsp;mentioned&amp;nbsp;&quot;You'd&amp;nbsp;need&amp;nbsp;to&amp;nbsp;be&amp;nbsp;mindful&amp;nbsp;of&amp;nbsp;races&amp;nbsp;when&amp;nbsp;consumers&amp;nbsp;start&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;up.&quot;,&amp;nbsp;i.e.&amp;nbsp;if&amp;nbsp;both&amp;nbsp;consumers&amp;nbsp;start&amp;nbsp;up&amp;nbsp;near&amp;nbsp;simultaneously&amp;nbsp;then&amp;nbsp;they&amp;nbsp;will&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;both&amp;nbsp;see&amp;nbsp;a&amp;nbsp;count&amp;nbsp;of&amp;nbsp;0.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;I&amp;nbsp;also&amp;nbsp;try&amp;nbsp;to&amp;nbsp;find&amp;nbsp;a&amp;nbsp;API&amp;nbsp;that&amp;nbsp;can&amp;nbsp;retrieve&amp;nbsp;the&amp;nbsp;existing&amp;nbsp;connection&amp;nbsp;or&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;channel.&amp;nbsp;Then&amp;nbsp;the&amp;nbsp;second&amp;nbsp;consumer&amp;nbsp;can&amp;nbsp;reuse&amp;nbsp;the&amp;nbsp;connection&amp;nbsp;or&amp;nbsp;channel&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;gt;&amp;nbsp;the&amp;nbsp;first&amp;nbsp;consumer&amp;nbsp;created.&amp;nbsp;But&amp;nbsp;it&amp;nbsp;seems&amp;nbsp;no&amp;nbsp;such&amp;nbsp;APIs.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;A&amp;nbsp;connection&amp;nbsp;represents&amp;nbsp;a&amp;nbsp;point-to-point&amp;nbsp;TCP&amp;nbsp;connection.&amp;nbsp;You&amp;nbsp;can't&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&quot;reuse&quot;&amp;nbsp;that&amp;nbsp;from&amp;nbsp;a&amp;nbsp;third&amp;nbsp;point.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;Regards,&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;Matthias.&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;&lt;/DIV&gt;&lt;/BODY&gt;&lt;/HTML&gt;<br>

</tt>
