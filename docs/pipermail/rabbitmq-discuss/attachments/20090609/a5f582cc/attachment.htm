<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.01&nbsp;Transitional//EN&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=ISO-8859-1&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;title&gt;&lt;/title&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
Ok,&nbsp;last&nbsp;one&nbsp;today,&nbsp;I&nbsp;promise.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;solved&nbsp;this&nbsp;problem&nbsp;my&nbsp;adding&nbsp;some&nbsp;explicit&nbsp;locks&nbsp;in&nbsp;Subscription&nbsp;and<br>
SimpleRpcServer.&amp;nbsp;&nbsp;I&nbsp;tried&nbsp;to&nbsp;checkout&nbsp;the&nbsp;latest&nbsp;source&nbsp;(on&nbsp;linux,<br>
cygwin,&nbsp;and&nbsp;tortoiseHG)&nbsp;but&nbsp;kept&nbsp;getting&nbsp;a&nbsp;zlib&nbsp;error,&nbsp;so&nbsp;this&nbsp;patch&nbsp;is<br>
against&nbsp;the&nbsp;source&nbsp;in&nbsp;rabbitmq-dotnet-client-1.5.3.zip&nbsp;downloaded&nbsp;from<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://www.rabbitmq.com/dotnet.html&quot;&gt;http://www.rabbitmq.com/dotnet.html&lt;/a&gt;.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;patch&nbsp;makes&nbsp;SimpleRpcServer.Close&nbsp;threadsafe&nbsp;by&nbsp;adding:&lt;br&gt;<br>
&lt;ol&gt;<br>
&nbsp;&nbsp;&lt;li&gt;locking&nbsp;SimpleRpcServer.m_subscription&nbsp;around&nbsp;the&nbsp;body&nbsp;of<br>
SimpleRpcServer.MainLoop's&nbsp;foreach&nbsp;(so&nbsp;we&nbsp;can't&nbsp;close&nbsp;while&nbsp;processing)&lt;/li&gt;<br>
&nbsp;&nbsp;&lt;li&gt;checking&nbsp;for&nbsp;a&nbsp;null&nbsp;Subscription.Consumer&nbsp;before&nbsp;processing&nbsp;a<br>
message&nbsp;in&nbsp;SimpleRpcServer.MainLoop,&nbsp;but&nbsp;after&nbsp;we've&nbsp;locked<br>
m_subscription&nbsp;(to&nbsp;ensure&nbsp;we&nbsp;don't&nbsp;process&nbsp;after&nbsp;we've&nbsp;closed)&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&lt;li&gt;locking&nbsp;this&nbsp;around&nbsp;the&nbsp;body&nbsp;of&nbsp;Subscription.Close&nbsp;(to&nbsp;ensure&nbsp;we<br>
don't&nbsp;close&nbsp;that&nbsp;same&nbsp;subscription&nbsp;at&nbsp;the&nbsp;same&nbsp;time)&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/li&gt;<br>
&lt;/ol&gt;<br>
I&nbsp;*think*&nbsp;that&nbsp;solves&nbsp;the&nbsp;potential&nbsp;race&nbsp;conditions.&amp;nbsp;&nbsp;It&nbsp;certainly<br>
makes&nbsp;my&nbsp;tests&nbsp;work,&nbsp;and&nbsp;running&nbsp;&quot;nant&nbsp;unit&quot;&nbsp;on&nbsp;the&nbsp;1.5.3&nbsp;source&nbsp;gives<br>
2&nbsp;failures&nbsp;in&nbsp;TestSharedQueue.cs&nbsp;that&nbsp;look&nbsp;timing-related.&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks,&lt;br&gt;<br>
&lt;pre&nbsp;class=&quot;moz-signature&quot;&nbsp;cols=&quot;72&quot;&gt;Ryan&nbsp;Davis<br>
Acceleration.net<br>
Director&nbsp;of&nbsp;Programming&nbsp;Services<br>
2831&nbsp;NW&nbsp;41st&nbsp;street,&nbsp;suite&nbsp;B<br>
Gainesville,&nbsp;FL&nbsp;32606<br>
<br>
Office:&nbsp;352-335-6500&nbsp;x&nbsp;124<br>
Fax:&nbsp;352-335-6506&lt;/pre&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Ryan&nbsp;Davis&nbsp;wrote:<br>
&lt;blockquote&nbsp;cite=&quot;mid:4A2EB25D.10907@acceleration.net&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;Ryan&nbsp;Davis&nbsp;wrote:<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;I'm&nbsp;going&nbsp;to&nbsp;add&nbsp;a&nbsp;flag&nbsp;and&nbsp;test&nbsp;out&nbsp;calling&nbsp;Close()&nbsp;from&nbsp;various&nbsp;points<br>
in&nbsp;HandleCall/HandleCast/ProcessRequest.<br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;!----&gt;Wow,&nbsp;I&nbsp;really&nbsp;didn't&nbsp;think&nbsp;that&nbsp;one&nbsp;through.&nbsp;<br>
HandleCall/HandleCast/ProcessRequest&nbsp;are&nbsp;only&nbsp;called&nbsp;when&nbsp;there&nbsp;is&nbsp;a<br>
message&nbsp;to&nbsp;process.&nbsp;&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;message&nbsp;to&nbsp;process,&nbsp;the<br>
SimpleRpcServer&nbsp;is&nbsp;blocked&nbsp;on&nbsp;Subscription.Next(),&nbsp;and&nbsp;will&nbsp;never<br>
exit.&nbsp;&nbsp;&nbsp;My&nbsp;current&nbsp;test&nbsp;case&nbsp;starts&nbsp;a&nbsp;SimpleRpcServer,&nbsp;then&nbsp;tries&nbsp;to<br>
stop&nbsp;it,&nbsp;without&nbsp;sending&nbsp;any&nbsp;messages.<br>
<br>
I&nbsp;changed&nbsp;my&nbsp;code&nbsp;so&nbsp;if&nbsp;the&nbsp;SimpleRpcServer&nbsp;sees&nbsp;a&nbsp;certain&nbsp;byte[]<br>
message&nbsp;(stored&nbsp;as&nbsp;ShutdownKey),&nbsp;it&nbsp;will&nbsp;close&nbsp;itself:<br>
<br>
public&nbsp;override&nbsp;void&nbsp;HandleCast(bool&nbsp;isRedelivered,&nbsp;IBasicProperties<br>
requestProperties,&nbsp;byte[]&nbsp;body)<br>
{<br>
&nbsp;&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&amp;lt;&nbsp;body.Length;&nbsp;i++)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(body[i]&nbsp;!=&nbsp;ShutdownKey[i])&nbsp;return;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;Close();&nbsp;//we&nbsp;must&nbsp;have&nbsp;matched,&nbsp;shut&nbsp;down.<br>
}<br>
<br>
As&nbsp;I&nbsp;expected,&nbsp;this&nbsp;throws&nbsp;a&nbsp;different&nbsp;exception:<br>
System.InvalidOperationException:&nbsp;Operation&nbsp;is&nbsp;not&nbsp;valid&nbsp;due&nbsp;to&nbsp;the&nbsp;current&nbsp;state&nbsp;of&nbsp;the&nbsp;object.<br>
&nbsp;&nbsp;&nbsp;at&nbsp;RabbitMQ.Client.MessagePatterns.Subscription.Next()&nbsp;in&nbsp;d:\Projects\rabbitmq-dotnet-client-1.5.3\src\client\messagepatterns\Subscription.cs:line&nbsp;323<br>
&nbsp;&nbsp;&nbsp;at&nbsp;RabbitMQ.Client.MessagePatterns.Subscription.System.Collections.IEnumerator.MoveNext()&nbsp;in&nbsp;d:\Projects\rabbitmq-dotnet-client-1.5.3\src\client\messagepatterns\Subscription.cs:line&nbsp;437<br>
&nbsp;&nbsp;&nbsp;at&nbsp;RabbitMQ.Client.MessagePatterns.SimpleRpcServer.MainLoop()&nbsp;in&nbsp;d:\Projects\rabbitmq-dotnet-client-1.5.3\src\client\messagepatterns\SimpleRpcServer.cs:line&nbsp;206<br>
<br>
I'm&nbsp;going&nbsp;to&nbsp;start&nbsp;mucking&nbsp;about&nbsp;in&nbsp;SimpleRpcServer.cs/Subscription.cs<br>
to&nbsp;see&nbsp;what's&nbsp;the&nbsp;smalled&nbsp;change&nbsp;I&nbsp;can&nbsp;make&nbsp;to&nbsp;fix&nbsp;it.<br>
<br>
Thanks,<br>
<br>
Ryan&nbsp;Davis<br>
Acceleration.net<br>
Director&nbsp;of&nbsp;Programming&nbsp;Services<br>
2831&nbsp;NW&nbsp;41st&nbsp;street,&nbsp;suite&nbsp;B<br>
Gainesville,&nbsp;FL&nbsp;32606<br>
<br>
Office:&nbsp;352-335-6500&nbsp;x&nbsp;124<br>
Fax:&nbsp;352-335-6506<br>
<br>
<br>
_______________________________________________<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&gt;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
