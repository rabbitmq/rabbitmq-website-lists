<tt>
Hi&nbsp;Emile,&lt;br&gt;&lt;br&gt;I&amp;#39;m&nbsp;using&nbsp;a&nbsp;class&nbsp;based&nbsp;on&nbsp;Subscription&nbsp;(the&nbsp;core&nbsp;functionality&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;Subscription&nbsp;in&nbsp;v2.2.0&nbsp;and&nbsp;the&nbsp;only&nbsp;differences&nbsp;are&nbsp;that&nbsp;I&nbsp;have&nbsp;new&nbsp;methods&nbsp;and&nbsp;made&nbsp;public&nbsp;a&nbsp;pair&nbsp;of&nbsp;private&nbsp;properties)&nbsp;called&nbsp;from&nbsp;a&nbsp;RpcServer&nbsp;class&nbsp;(which&nbsp;I&nbsp;also&nbsp;made&nbsp;my&nbsp;own&nbsp;modifications&nbsp;but&nbsp;calls&nbsp;my&nbsp;custom&nbsp;Subscription&nbsp;class&nbsp;the&nbsp;same&nbsp;way&nbsp;as&nbsp;the&nbsp;v2.2.0&nbsp;provided&nbsp;classes)&lt;br&gt;<br>
&lt;br&gt;I&nbsp;can&nbsp;reproduce&nbsp;the&nbsp;issue&nbsp;(but&nbsp;I&amp;#39;m&nbsp;not&nbsp;sure&nbsp;if&nbsp;it&nbsp;is&nbsp;a&nbsp;expected&nbsp;behavior)&nbsp;by&nbsp;doing&nbsp;the&nbsp;following&nbsp;steps:&lt;br&gt;&lt;br&gt;1.&nbsp;Send &nbsp;messages&nbsp;to&nbsp;a&nbsp;queue&lt;br&gt;2.&nbsp;Start&nbsp;a&nbsp;consumer&nbsp;application&lt;br&gt;3.&nbsp;Disable&nbsp;the&nbsp;network&nbsp;connection&nbsp;in&nbsp;order&nbsp;to&nbsp;simulate&nbsp;an&nbsp;unexpected&nbsp;crash.&lt;br&gt;<br>
&lt;br&gt;What&nbsp;I&nbsp;see&nbsp;is&nbsp;that&nbsp;the&nbsp;my&nbsp;custom&nbsp;RpcServer&nbsp;class&nbsp;which&nbsp;recover &nbsp;the&nbsp;messages&nbsp;keep&nbsp;looping&nbsp;with&nbsp;the&nbsp;foreach&nbsp;although&nbsp;there&nbsp;connection&nbsp;is&nbsp;closed.&lt;br&gt;&lt;br&gt;public&nbsp;void&nbsp;MainLoop()&lt;br&gt;{&lt;br&gt;          &nbsp;&lt;br&gt;           &nbsp;foreach&nbsp;(BasicDeliverEventArgs&nbsp;evt&nbsp;in&nbsp;m_subscription)&lt;br&gt;<br>
           &nbsp;{&lt;br&gt;                   &nbsp;ProcessRequest(evt);&lt;br&gt;           &nbsp;}&lt;br&gt;           &nbsp;&lt;br&gt; }&lt;br&gt;&lt;br&gt;In&nbsp;my&nbsp;custom&nbsp;Subscription&nbsp;class&nbsp;I&nbsp;see&nbsp;that&nbsp;the&nbsp;method&nbsp;Next&nbsp;is&nbsp;returning&nbsp;all&nbsp;events&nbsp;even&nbsp;if&nbsp;the&nbsp;consumer&nbsp;is&nbsp;not&nbsp;running&nbsp;and&nbsp;no&nbsp;exception&nbsp;is&nbsp;launched&nbsp;&nbsp;when&nbsp;is&nbsp;called&nbsp;by&nbsp;foreach&nbsp;loop.&lt;br&gt;<br>
(note:&nbsp;Next()&nbsp;is&nbsp;identical&nbsp;to&nbsp;Subscription&nbsp;class&nbsp;in&nbsp;v2.2.0&nbsp;because&nbsp;I&nbsp;didn&amp;#39;t&nbsp;modiy&nbsp;it)&lt;br&gt;&lt;br&gt;       &nbsp;public&nbsp;BasicDeliverEventArgs&nbsp;Next()&lt;br&gt;       &nbsp;{&lt;br&gt;           &nbsp;try&lt;br&gt;           &nbsp;{&lt;br&gt;               &nbsp;QueueingBasicConsumer&nbsp;consumer&nbsp;=&nbsp;m_consumer;&lt;br&gt;<br>
               &nbsp;if&nbsp;(consumer&nbsp;==&nbsp;null)&lt;br&gt;               &nbsp;{&lt;br&gt;                   &nbsp;//&nbsp;Closed!&lt;br&gt;                   &nbsp;m_latestEvent&nbsp;=&nbsp;null;&lt;br&gt;               &nbsp;}&lt;br&gt;               &nbsp;else&lt;br&gt;               &nbsp;{&lt;br&gt;&lt;br&gt;                   &nbsp;m_latestEvent&nbsp;=&nbsp;(BasicDeliverEventArgs)consumer.Queue.Dequeue();&lt;br&gt;<br>
               &nbsp;}&lt;br&gt;           &nbsp;}&lt;br&gt;           &nbsp;catch&nbsp;(EndOfStreamException)&lt;br&gt;           &nbsp;{&lt;br&gt;               &nbsp;m_latestEvent&nbsp;=&nbsp;null;&lt;br&gt;           &nbsp;}&lt;br&gt;           &nbsp;return&nbsp;m_latestEvent;&lt;br&gt;       &nbsp;}&lt;br&gt;&lt;br&gt;&lt;br&gt;My&nbsp;question&nbsp;is:&nbsp;should&nbsp;consumer.Queue.Dequeue()&nbsp;raise&nbsp;an&nbsp;exception&nbsp;when&nbsp;&amp;quot;consumer&amp;quot;&nbsp;property&nbsp;IsRunning&nbsp;is&nbsp;false?&lt;br&gt;<br>
Currently&nbsp;this&nbsp;is&nbsp;not&nbsp;happening.&lt;br&gt;&lt;br&gt;In&nbsp;my&nbsp;code&nbsp;a&nbsp;workaround&nbsp;could&nbsp;be&nbsp;to&nbsp;check&nbsp;consumer.IsRunning&nbsp;and&nbsp;assign&nbsp;m_lastestEvent&nbsp;to&nbsp;null&nbsp;when&nbsp;if&nbsp;it&nbsp;is&nbsp;&amp;quot;false&amp;quot;&nbsp;and&nbsp;in&nbsp;MainLoop&nbsp;handle&nbsp;that&nbsp;or&nbsp;to&nbsp;launch&nbsp;an&nbsp;excepcion&nbsp;which&nbsp;&lt;span&nbsp;id=&quot;result_box&quot;&nbsp;class=&quot;short_text&quot;&nbsp;lang=&quot;en&quot;&gt;&lt;span&nbsp;title=&quot;Haz&nbsp;clic&nbsp;para&nbsp;obtener&nbsp;traducciones&nbsp;alternativas&quot;&nbsp;class=&quot;hps&quot;&gt;would&nbsp;cause&nbsp;&lt;/span&gt;&lt;/span&gt;MainLoop&nbsp;to&nbsp;end.&lt;br&gt;<br>
&lt;br&gt;Any&nbsp;advice&nbsp;would&nbsp;be&nbsp;appreaciated.&lt;br&gt;&lt;br&gt;Thank&nbsp;you&nbsp;in&nbsp;advance.&lt;br&gt;&lt;br&gt;&lt;br&gt;Regards,&lt;br&gt;&lt;br&gt;Alfonso&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2011/3/30&nbsp;Emile&nbsp;Joubert&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:emile@rabbitmq.com&quot;&gt;emile@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;Hi&nbsp;Alfonso,&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;30/03/11&nbsp;15:43,&nbsp;Alfonso&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;is&nbsp;a&nbsp;difficult&nbsp;one:&nbsp;I&amp;#39;ve&nbsp;observed&nbsp;a&nbsp;couple&nbsp;of&nbsp;times&nbsp;that&nbsp;my&lt;br&gt;<br>
consumer&nbsp;(.NET&nbsp;API&nbsp;2.2.0)&nbsp;doesn&amp;#39;t&nbsp;notice&nbsp;when&nbsp;the&nbsp;server&nbsp;that&nbsp;is&lt;br&gt;<br>
running&nbsp;RabbitMQ&nbsp;(2.2.0)&nbsp;crashes.&lt;br&gt;<br>
Please&nbsp;note&nbsp;that&nbsp;I&nbsp;mean&nbsp;server&nbsp;crash&nbsp;-unexpected&nbsp;shutdown,&nbsp;OS&nbsp;crash,&lt;br&gt;<br>
etc.-&nbsp;not&nbsp;RabbitMQ&nbsp;crash.&lt;br&gt;<br>
&lt;br&gt;<br>
My&nbsp;application&nbsp;is&nbsp;consuming&nbsp;from&nbsp;a&nbsp;queue&nbsp;using&nbsp;&amp;quot;foreach&amp;quot;&nbsp;to&nbsp;get&nbsp;the&lt;br&gt;<br>
messages&nbsp;and&nbsp;I&nbsp;has&nbsp;an&nbsp;event&nbsp;handler&nbsp;attached&nbsp;to&nbsp;the&nbsp;onShutdown&nbsp;event.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
I&amp;#39;m&nbsp;not&nbsp;able&nbsp;to&nbsp;reproduce&nbsp;this&nbsp;using&nbsp;version&nbsp;2.2.0&nbsp;of&nbsp;the&nbsp;broker&nbsp;and&nbsp;the&nbsp;.NET&nbsp;client,&nbsp;implementing&nbsp;the&nbsp;the&nbsp;Subscription&nbsp;pattern.&nbsp;A&nbsp;connectivity&nbsp;problem&nbsp;immediately&nbsp;causes&nbsp;an&nbsp;OperationInterruptedException&nbsp;to&nbsp;be&nbsp;thrown&nbsp;from&nbsp;ConnectionBase.Dispose().&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Time&nbsp;ago&nbsp;disconnection&nbsp;tests&nbsp;consisting&nbsp;of&nbsp;disconnecting&nbsp;the&nbsp;consumer&lt;br&gt;<br>
from&nbsp;the&nbsp;web&nbsp;admin&nbsp;console&nbsp;were&nbsp;made&nbsp;and&nbsp;the&nbsp;event&nbsp;handler&nbsp;was&nbsp;fired&lt;br&gt;<br>
always.&nbsp;So&nbsp;disconnections&nbsp;are&nbsp;caught&nbsp;and&nbsp;logged&nbsp;properly.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;problem&nbsp;is&nbsp;that&nbsp;the&nbsp;consumer&nbsp;got&nbsp;stuck&nbsp;when&nbsp;the&nbsp;server&nbsp;crashed&nbsp;and&lt;br&gt;<br>
it&nbsp;didn&amp;#39;t&nbsp;notice&nbsp;that&nbsp;the&nbsp;connection&nbsp;was&nbsp;gone&nbsp;(due&nbsp;to&nbsp;a&nbsp;server&nbsp;crash)&lt;br&gt;<br>
so&nbsp;it&nbsp;was&nbsp;impossible&nbsp;to&nbsp;log&nbsp;a&nbsp;disconnection&nbsp;error.&lt;br&gt;<br>
In&nbsp;the&nbsp;code&nbsp;there&nbsp;is&nbsp;a&nbsp;while&nbsp;loop&nbsp;for&nbsp;reconnecting&nbsp;when&nbsp;the&nbsp;connection&lt;br&gt;<br>
fails&nbsp;but&nbsp;didn&amp;#39;t&nbsp;loop&nbsp;because&nbsp;my&nbsp;guess&nbsp;is&nbsp;that&nbsp;the&nbsp;code&nbsp;were&nbsp;stuck&nbsp;in&lt;br&gt;<br>
the&nbsp;&amp;quot;foreach&amp;quot;.&lt;br&gt;<br>
&lt;br&gt;<br>
Am&nbsp;I&nbsp;missing&nbsp;something&nbsp;or&nbsp;this&nbsp;could&nbsp;be&nbsp;and&nbsp;issue?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Is&nbsp;it&nbsp;possible&nbsp;that&nbsp;you&nbsp;are&nbsp;preventing&nbsp;an&nbsp;exception&nbsp;from&nbsp;the&nbsp;socket&nbsp;from&nbsp;affecting&nbsp;the&nbsp;Subscription?&nbsp;Posting&nbsp;a&nbsp;minimal&nbsp;piece&nbsp;of&nbsp;code&nbsp;for&nbsp;demonstration&nbsp;may&nbsp;be&nbsp;useful.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Regards&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;<br>
Emile&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/font&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
