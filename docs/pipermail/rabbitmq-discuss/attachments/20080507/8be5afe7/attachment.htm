<tt>
&lt;html&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;Just&nbsp;quickly&nbsp;before&nbsp;you&nbsp;start&nbsp;doing&nbsp;stuff:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;it&nbsp;make&nbsp;a&nbsp;difference&nbsp;if&nbsp;you&nbsp;just&nbsp;the&nbsp;direct&nbsp;client&nbsp;rather&nbsp;than&nbsp;the&nbsp;TCP&nbsp;client?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ben&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;7&nbsp;May&nbsp;2008,&nbsp;at&nbsp;21:50,&nbsp;Edwin&nbsp;Fine&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Thanks&nbsp;for&nbsp;the&nbsp;response,&nbsp;Ben.&nbsp;I&nbsp;will&nbsp;try&nbsp;to&nbsp;create&nbsp;a&nbsp;standalone&nbsp;program&nbsp;that&nbsp;reproduces&amp;nbsp;&nbsp;the&nbsp;issue.&nbsp;I&nbsp;hope&nbsp;I&nbsp;can&nbsp;do&nbsp;it.&nbsp;The&nbsp;hesitation&nbsp;comes&nbsp;because&nbsp;the&nbsp;circumstances&nbsp;under&nbsp;which&nbsp;this&nbsp;occurred&nbsp;are:&lt;br&gt;&lt;ul&gt;&lt;li&gt;50&nbsp;queues&nbsp;on&nbsp;one&nbsp;&amp;lt;&amp;lt;direct&gt;&gt;&nbsp;exchange&lt;/li&gt;&nbsp;&lt;li&gt;A&nbsp;producer&nbsp;that&nbsp;is&nbsp;pushing&nbsp;150&nbsp;messages/second&nbsp;to&nbsp;the&nbsp;queues,&nbsp;evenly&nbsp;across&nbsp;the&nbsp;queue&nbsp;name&lt;/li&gt;&lt;li&gt;Each&nbsp;queue&nbsp;is&nbsp;doing&nbsp;a&nbsp;basic.deliver&nbsp;to&nbsp;one&nbsp;of&nbsp;50&nbsp;Erlang&nbsp;consumer&nbsp;processes&nbsp;(gen_event).&nbsp;The&nbsp;consumer&nbsp;processes&nbsp;all&nbsp;share&nbsp;the&nbsp;same&nbsp;channel&nbsp;(which&nbsp;may&nbsp;not&nbsp;be&nbsp;a&nbsp;good&nbsp;idea,&nbsp;because&nbsp;when&nbsp;the&nbsp;channel&nbsp;crashed,&nbsp;so&nbsp;did&nbsp;all&nbsp;50&nbsp;consumers.&nbsp;I&nbsp;wonder&nbsp;if&nbsp;I&nbsp;should&nbsp;have&nbsp;1&nbsp;channel&nbsp;for&nbsp;each&nbsp;consumer?&nbsp;Too&nbsp;heavy?).&lt;/li&gt;&nbsp;&lt;li&gt;Because&nbsp;the&nbsp;channel.flow&nbsp;command&nbsp;is&nbsp;not&nbsp;implemented,&nbsp;I&nbsp;am&nbsp;using&nbsp;unsubscribe&nbsp;to&nbsp;try&nbsp;to&nbsp;do&nbsp;flow&nbsp;control,&nbsp;because&nbsp;I&nbsp;am&nbsp;finding&nbsp;that&nbsp;RabbitMQ&nbsp;is&nbsp;dumping&nbsp;all&nbsp;the&nbsp;basic.deliver&nbsp;messages&nbsp;into&nbsp;the&nbsp;Erlang&nbsp;message&nbsp;queue&nbsp;of&nbsp;each&nbsp;consumer&nbsp;gen_event&nbsp;process.&nbsp;This&nbsp;is&nbsp;totally&nbsp;not&nbsp;what&nbsp;I&nbsp;want&nbsp;-&nbsp;I&nbsp;want&nbsp;the&nbsp;messages&nbsp;to&nbsp;stay&nbsp;persisted&nbsp;in&nbsp;Rabbit-land&nbsp;until&nbsp;I&nbsp;can&nbsp;deliver&nbsp;them&nbsp;and&nbsp;tell&nbsp;Rabbit&nbsp;to&nbsp;release&nbsp;them.&lt;/li&gt;&nbsp;&lt;li&gt;The&nbsp;reason&nbsp;I&nbsp;need&nbsp;flow&nbsp;control&nbsp;is&nbsp;because&nbsp;I&nbsp;am&nbsp;delivering&nbsp;messages&nbsp;via&nbsp;HTTP/XML&nbsp;to&nbsp;a&nbsp;number&nbsp;of&nbsp;different&nbsp;Web&nbsp;sites.&nbsp;Sometimes&nbsp;a&nbsp;web&nbsp;site&nbsp;may&nbsp;be&nbsp;down,&nbsp;often&nbsp;for&nbsp;hours,&nbsp;and&nbsp;I&nbsp;want&nbsp;to&nbsp;just&nbsp;be&nbsp;able&nbsp;to&nbsp;pause&nbsp;the&nbsp;consumer&nbsp;(and&nbsp;producer)&nbsp;until&nbsp;messages&nbsp;start&nbsp;going&nbsp;through&nbsp;again.&nbsp;Having&nbsp;the&nbsp;Erlang&nbsp;message&nbsp;queues&nbsp;filling&nbsp;up&nbsp;with&nbsp;thousands&nbsp;of&nbsp;messages&nbsp;will&nbsp;eventually&nbsp;crash&nbsp;the&nbsp;VM&nbsp;due&nbsp;to&nbsp;OOM.&nbsp;I&nbsp;know&nbsp;I&nbsp;can&nbsp;poll&nbsp;with&nbsp;basic.get,&nbsp;but&nbsp;the&nbsp;conundrum&nbsp;is&nbsp;that&nbsp;I&nbsp;want&nbsp;high&nbsp;performance&nbsp;while&nbsp;the&nbsp;web&nbsp;sites&nbsp;are&nbsp;accepting&nbsp;input,&nbsp;and&nbsp;shut-off&nbsp;when&nbsp;they&nbsp;are&nbsp;not.&nbsp;Any&nbsp;suggestions?&lt;br&gt;&nbsp;&lt;/li&gt;&lt;/ul&gt;So&nbsp;I&nbsp;may&nbsp;have&nbsp;to&nbsp;build&nbsp;a&nbsp;simulated&nbsp;version&nbsp;of&nbsp;the&nbsp;above&nbsp;to&nbsp;get&nbsp;the&nbsp;problem&nbsp;to&nbsp;happen&nbsp;again.&nbsp;That's&nbsp;the&nbsp;hesitation&nbsp;-&nbsp;will&nbsp;it&nbsp;trigger&nbsp;the&nbsp;error?&lt;br&gt;&lt;br&gt;Anyway,&nbsp;I&nbsp;am&nbsp;probably&nbsp;not&nbsp;doing&nbsp;this&nbsp;the&nbsp;right&nbsp;way,&nbsp;but&nbsp;I&nbsp;have&nbsp;no&nbsp;expertise&nbsp;in&nbsp;AMQP.&nbsp;My&nbsp;knowledge&nbsp;is&nbsp;of&nbsp;MQSeries&nbsp;a&nbsp;few&nbsp;years&nbsp;back.&lt;br&gt;&nbsp;&lt;br&gt;Regards,&lt;br&gt;Edwin&nbsp;Fine&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;May&nbsp;7,&nbsp;2008&nbsp;at&nbsp;4:29&nbsp;PM,&nbsp;Ben&nbsp;Hood&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:0x6e6562@gmail.com&quot;&gt;0x6e6562@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&nbsp;Edwin,&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;On&nbsp;7&nbsp;May&nbsp;2008,&nbsp;at&nbsp;18:57,&nbsp;Edwin&nbsp;Fine&nbsp;wrote:&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&nbsp;Using&nbsp;Rabbit&nbsp;1.3.0,&nbsp;Erlang&nbsp;client,&nbsp;Ubuntu&nbsp;Linux&nbsp;Feisty,&nbsp;Erlang&nbsp;R12B-2&nbsp;64-bit&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;Consumer&nbsp;channel&nbsp;crashes&nbsp;as&nbsp;follows&nbsp;when&nbsp;I&nbsp;do&nbsp;the&nbsp;following:&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;1.&nbsp;Subscribe&nbsp;(basic.consume)&lt;br&gt;&nbsp;2.&nbsp;Unsubscribe&nbsp;(basic.cancel)&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;The&nbsp;channel&nbsp;crashes&nbsp;handling&nbsp;the&nbsp;basic.cancel_ok.&nbsp;I&nbsp;can't&nbsp;figure&nbsp;out&lt;br&gt;&nbsp;why.&nbsp;The&nbsp;channel&nbsp;is&nbsp;under&nbsp;some&nbsp;load&nbsp;(about&nbsp;100&nbsp;-&nbsp;130&nbsp;messages/second).&lt;br&gt;&nbsp;I&nbsp;haven't&nbsp;yet&nbsp;built&nbsp;a&nbsp;standalone&nbsp;test&nbsp;case&nbsp;to&nbsp;try&nbsp;to&nbsp;reproduce&nbsp;this,&lt;br&gt;&nbsp;but&nbsp;it&nbsp;happens&nbsp;consistently&nbsp;in&nbsp;my&nbsp;code.&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;The&nbsp;code&nbsp;to&nbsp;subscribe&nbsp;is:&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;#'basic.consume_ok'{consumer_tag&nbsp;=&nbsp;ConsumerTag}&nbsp;=&lt;br&gt;&nbsp;amqp_channel:call(Channel,&nbsp;BasicConsume,&nbsp;self())&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;and&nbsp;this&nbsp;works&nbsp;fine.&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;The&nbsp;code&nbsp;to&nbsp;cancel&nbsp;is&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;BasicCancel&nbsp;=&nbsp;#'basic.cancel'{consumer_tag&nbsp;=&nbsp;ConsumerTag,&nbsp;nowait&nbsp;=&nbsp;false},&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;#'basic.cancel_ok'{consumer_tag&nbsp;=&nbsp;ConsumerTag}&nbsp;=&lt;br&gt;&nbsp;amqp_channel:call(Channel,&nbsp;BasicCancel).&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;The&nbsp;problem&nbsp;seems&nbsp;to&nbsp;be&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;**&nbsp;{function_clause,&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;[{gen_server,reply,&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;[&amp;lt;&amp;lt;&gt;&gt;,&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{'basic.cancel_ok',&amp;lt;&amp;lt;&quot;XHG.DELIVERY.Q.HTTP031.HC031&quot;&gt;&gt;}]},&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;What&nbsp;am&nbsp;I&nbsp;doing&nbsp;wrong?&nbsp;Any&nbsp;ideas?&lt;br&gt;&nbsp;&lt;/blockquote&gt;&nbsp;&lt;br&gt;&lt;/div&gt;&nbsp;What&nbsp;you&nbsp;are&nbsp;seeing&nbsp;is&nbsp;a&nbsp;symptom&nbsp;of&nbsp;an&nbsp;error&nbsp;in&nbsp;the&nbsp;RPC&nbsp;handling.&nbsp;Essentially,&nbsp;the&nbsp;channel&nbsp;process&nbsp;is&nbsp;receiving&nbsp;a&nbsp;notification&nbsp;that&nbsp;it&nbsp;thinks&nbsp;it&nbsp;has&nbsp;already&nbsp;sent&nbsp;to&nbsp;the&nbsp;invoking&nbsp;process.&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;It&nbsp;would&nbsp;be&nbsp;really&nbsp;good&nbsp;if&nbsp;you&nbsp;could&nbsp;send&nbsp;some&nbsp;code&nbsp;that&nbsp;might&nbsp;help&nbsp;me&nbsp;reproduce&nbsp;this&nbsp;myself.&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;In&nbsp;the&nbsp;meantime&nbsp;I&nbsp;will&nbsp;look&nbsp;into&nbsp;this&nbsp;and&nbsp;see&nbsp;if&nbsp;I&nbsp;can&nbsp;come&nbsp;up&nbsp;with&nbsp;a&nbsp;solution.&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;HTH,&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&nbsp;&lt;br&gt;&nbsp;Ben&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;&lt;br&gt;&nbsp;&lt;/font&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
