diff -r eb110e4290d3 src/rabbit_channel.erl
--- a/src/rabbit_channel.erl	Fri Apr 15 20:18:32 2011 +0100
+++ b/src/rabbit_channel.erl	Wed Apr 20 16:16:30 2011 +0200
@@ -925,17 +925,22 @@ handle_method(#'queue.declare'{queue    
               _, State = #ch{virtual_host        = VHostPath,
                              conn_pid            = ConnPid,
                              queue_collector_pid = CollectorPid}) ->
     Owner = case ExclusiveDeclare of
                 true  -> ConnPid;
                 false -> none
             end,
     ActualNameBin = case QueueNameBin of
-                        <<>>  -> rabbit_guid:binstring_guid("amq.gen");
+                        <<>>  ->
+                            rabbit_guid:binstring_guid(
+                              case rabbit_misc:table_lookup(Args, <<"x-name-prefix">>) of
+                                {_TypeBin, ValueBin} -> binary_to_list(ValueBin);
+                                _                    -> "amq.gen"
+                              end);
                         Other -> check_name('queue', Other)
                     end,
     QueueName = rabbit_misc:r(VHostPath, queue, ActualNameBin),
     check_configure_permitted(QueueName, State),
     case rabbit_amqqueue:with(
            QueueName,
            fun (Q) -> ok = rabbit_amqqueue:assert_equivalence(
                              Q, Durable, AutoDelete, Args, Owner),
