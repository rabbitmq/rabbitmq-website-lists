<tt>
Hello&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;recently&nbsp;moved&nbsp;from&nbsp;RabbitMQ&nbsp;1.8&nbsp;to&nbsp;2.3.1&nbsp;on&nbsp;production&nbsp;and&nbsp;since&nbsp;then&nbsp;we&nbsp;have&nbsp;noticed&nbsp;that&nbsp;after&nbsp;a&nbsp;few&nbsp;days&nbsp;of&nbsp;operations&nbsp;the&nbsp;brokers&nbsp;will&nbsp;get&nbsp;into&nbsp;a&nbsp;mode&nbsp;where&nbsp;they&nbsp;use&nbsp;a&nbsp;lot&nbsp;of&nbsp;cpu&nbsp;to&nbsp;the&nbsp;point&nbsp;where&nbsp;it&nbsp;gets&nbsp;impossible&nbsp;to&nbsp;even&nbsp;use&nbsp;SSH&nbsp;on&nbsp;the&nbsp;machines.&nbsp;This&nbsp;seems&nbsp;to&nbsp;get&nbsp;triggered&nbsp;when&nbsp;many&nbsp;queues&nbsp;get&nbsp;deleted.&nbsp;Inspecting&nbsp;the&nbsp;broker&nbsp;(OS)&nbsp;processes&nbsp;with&nbsp;etop&nbsp;indicates&nbsp;a&nbsp;lot&nbsp;of&nbsp;reductions&nbsp;in&nbsp;(Erlang)&nbsp;processes&nbsp;that&nbsp;are&nbsp;currently&nbsp;executing&nbsp;prim_file:drv_get_response.&nbsp;This&nbsp;is correlated by&nbsp;the&nbsp;collectd&nbsp;daemon&nbsp;showing&nbsp;&amp;gt;&nbsp;12,000&nbsp;reads&nbsp;/&nbsp;sec&nbsp;and&nbsp;&amp;gt;&nbsp;2000&nbsp;writes&nbsp;/sec&nbsp;!&nbsp;These&nbsp;disks&nbsp;access&nbsp;don&amp;#39;t&nbsp;end&nbsp;up&nbsp;hitting&nbsp;the&nbsp;actual&nbsp;disk&nbsp;(are&nbsp;served&nbsp;by&nbsp;the&nbsp;OS&nbsp;cache)&nbsp;hence&nbsp;the&nbsp;high throughput.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;to&nbsp;always&nbsp;be&nbsp;the&nbsp;same&nbsp;processes&nbsp;causing&nbsp;this&nbsp;(around&nbsp;20).&nbsp;Looking&nbsp;at&nbsp;the&nbsp;state&nbsp;of&nbsp;one&nbsp;using&nbsp;sys:get_status&nbsp;returns&nbsp;[1].&nbsp;Looks&nbsp;like&nbsp;a&nbsp;queue&nbsp;process.&nbsp;There&nbsp;are&nbsp;about&nbsp;9K&nbsp;queues&nbsp;on&nbsp;the&nbsp;brokers&nbsp;when&nbsp;this&nbsp;happens&nbsp;and&nbsp;~60K&nbsp;messages.&nbsp;Up&nbsp;to&nbsp;this&nbsp;happening&nbsp;the&nbsp;brokers&nbsp;hover&nbsp;around&nbsp;40%&nbsp;cpu&nbsp;usage&nbsp;peaking&nbsp;at&nbsp;60%&nbsp;when&nbsp;the&nbsp;message&nbsp;store&nbsp;is&nbsp;combining&nbsp;the&nbsp;messages&nbsp;(about&nbsp;every&nbsp;5&nbsp;minutes&nbsp;with&nbsp;our&nbsp;throughput).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&amp;#39;s&nbsp;interesting&nbsp;that&nbsp;this&nbsp;seems&nbsp;to&nbsp;be&nbsp;caused&nbsp;by&nbsp;a&nbsp;small&nbsp;amount&nbsp;of&nbsp;queue&nbsp;processes,&nbsp;always&nbsp;the&nbsp;same&nbsp;that&nbsp;come&nbsp;up&nbsp;in&nbsp;etop.&nbsp;Also&nbsp;the&nbsp;CPU&nbsp;graph&nbsp;is&nbsp;a&nbsp;direct&nbsp;reflection&nbsp;of&nbsp;the&nbsp;disk&nbsp;ops&nbsp;graph. &lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;what&nbsp;are&nbsp;the&nbsp;scenarios&nbsp;that&nbsp;will&nbsp;cause&nbsp;a&nbsp;queue&nbsp;process&nbsp;to&nbsp;access&nbsp;the&nbsp;disk&nbsp;in&nbsp;what&nbsp;looks&nbsp;like&nbsp;an&nbsp;infinite&nbsp;loop?&nbsp;Anything&nbsp;else&nbsp;that&nbsp;could&nbsp;be&nbsp;causing&nbsp;this&nbsp;behavior?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks!&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;--&lt;/div&gt;&lt;div&gt;Raphael.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[1]&lt;/div&gt;&lt;div&gt;{status,&amp;lt;0.17050.0&amp;gt;,&lt;/div&gt;&lt;div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; {module,gen_server2},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; [[{{#Ref&amp;lt;0.0.1.210978&amp;gt;,fhc_handle},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{handle,{file_descriptor,prim_file,{#Port&amp;lt;0.29642&amp;gt;,8437}},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,0,false,576,infinity,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[[&amp;lt;&amp;lt;192,0,0,0,0,0,64,144&amp;gt;&amp;gt;],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;128,0,0,0,0,0,64,144&amp;gt;&amp;gt;],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;0,0,0,0,0,0,65,166&amp;gt;&amp;gt;,&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[&amp;lt;&amp;lt;218,154,254,188,128,203,224,...&amp;gt;&amp;gt;,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;lt;&amp;lt;0,4,161,101,66,238,...&amp;gt;&amp;gt;]],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;192,0,0,0,0,0,64,143&amp;gt;&amp;gt;],&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;128,0,0,0,0,0,64,...&amp;gt;&amp;gt;],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;0,0,0,0,0,0,...&amp;gt;&amp;gt;,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[&amp;lt;&amp;lt;134,78,165,193,...&amp;gt;&amp;gt;,&amp;lt;&amp;lt;0,4,161,...&amp;gt;&amp;gt;]],&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;192,0,0,0,0,...&amp;gt;&amp;gt;],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;128,0,0,0,...&amp;gt;&amp;gt;],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;0,0,0,...&amp;gt;&amp;gt;,[&amp;lt;&amp;lt;&amp;quot;u&amp;lt;&amp;quot;...&amp;gt;&amp;gt;,&amp;lt;&amp;lt;...&amp;gt;&amp;gt;]],&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;192,0,...&amp;gt;&amp;gt;],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;128,...&amp;gt;&amp;gt;],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&amp;lt;&amp;lt;...&amp;gt;&amp;gt;|...],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [...]|...],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;true,&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;quot;/var/lib/rabbitmq/mnesia/rabbit@broker1-2/queues/FIN41VKU7DXMV7IZOJED8MUO/journal.jif&amp;quot;,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[write,binary,raw,read],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[{write_buffer,infinity}],&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;true,true,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{1303,269920,172427}}},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; {{#Ref&amp;lt;0.0.474.103189&amp;gt;,fhc_handle},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{handle,{file_descriptor,prim_file,{#Port&amp;lt;0.116464&amp;gt;,596}},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;15487841,0,false,0,1048576,[],false,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;quot;/var/lib/rabbitmq/mnesia/rabbit@broker1-2/msg_store_persistent/0.rdq&amp;quot;,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[raw,binary,read],&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[{write_buffer,1048576}],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;false,true,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{1303,269928,232634}}},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; {&amp;#39;$ancestors&amp;#39;,[rabbit_amqqueue_sup,rabbit_sup,&amp;lt;0.131.0&amp;gt;]},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; {{&amp;quot;/var/lib/rabbitmq/mnesia/rabbit@broker1-2/msg_store_persistent/0.rdq&amp;quot;,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fhc_file},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{file,1,false}},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; {fhc_age_tree,{2,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{{1303,269920,172427},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #Ref&amp;lt;0.0.1.210978&amp;gt;,nil,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {{1303,269928,232634},#Ref&amp;lt;0.0.474.103189&amp;gt;,nil,nil}}}},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; {{&amp;quot;/var/lib/rabbitmq/mnesia/rabbit@broker1-2/queues/FIN41VKU7DXMV7IZOJED8MUO/journal.jif&amp;quot;,&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fhc_file},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{file,1,true}},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; {&amp;#39;$initial_call&amp;#39;,{gen,init_it,6}}],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp;running,&amp;lt;0.10398.0&amp;gt;,[],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp;[{header,&amp;quot;Status&nbsp;for&nbsp;generic&nbsp;server&nbsp;&amp;lt;0.17050.0&amp;gt;&amp;quot;},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; {data,[{&amp;quot;Status&amp;quot;,running},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&amp;quot;Parent&amp;quot;,&amp;lt;0.10398.0&amp;gt;},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&amp;quot;Logged&nbsp;events&amp;quot;,[]},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&amp;quot;Queued&nbsp;messages&amp;quot;,[]}]},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; {data,[{&amp;quot;State&amp;quot;,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {q,{amqqueue,{resource,&amp;lt;&amp;lt;&amp;quot;/right_net&amp;quot;&amp;gt;&amp;gt;,queue,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;lt;&amp;lt;&amp;quot;nanite-rs-instan&amp;quot;...&amp;gt;&amp;gt;},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;true,false,none,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[{&amp;lt;&amp;lt;&amp;quot;x-messag&amp;quot;...&amp;gt;&amp;gt;,signedint,86400000}],&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;lt;0.17050.0&amp;gt;},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;none,false,rabbit_variable_queue,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{vqstate,{[],[]},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {0,{[],...}},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {delta,undefined,...},&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {277,...},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {...},...},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{[],[]},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{[],[]},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;undefined,&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{1303269928237652,#Ref&amp;lt;0.0.1710.21035&amp;gt;},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{1303269928766020,...},&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;undefined,...}}]}]]}&lt;/div&gt;&lt;/div&gt;<br>

</tt>
