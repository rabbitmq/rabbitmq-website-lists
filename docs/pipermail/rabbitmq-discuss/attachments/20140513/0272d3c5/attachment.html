<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;would&nbsp;like&nbsp;to&nbsp;start&nbsp;by&nbsp;apologizing&nbsp;for&nbsp;the&nbsp;long&nbsp;email&nbsp;but&nbsp;i&nbsp;have&nbsp;quiet&nbsp;a&nbsp;few&nbsp;questions&nbsp;that&nbsp;i&nbsp;need&nbsp;to&nbsp;clarify&nbsp;:)&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;about&nbsp;my&nbsp;problem,&nbsp;i&nbsp;would&nbsp;like&nbsp;to&nbsp;report&nbsp;a&nbsp;miss-behavior&nbsp;of&nbsp;the&nbsp;RabbitMQ&nbsp;cluster&nbsp;(&lt;span&nbsp;style=&quot;text-align:right;color:rgb(68,68,68);font-family:Verdana,sans-serif;font-size:12px&quot;&gt;RabbitMQ&nbsp;3.1.5,&lt;/span&gt;&lt;span&nbsp;style=&quot;text-align:right;color:rgb(68,68,68);font-family:Verdana,sans-serif;font-size:12px&quot;&gt; &lt;/span&gt;&lt;acronym&nbsp;class=&quot;&quot;&nbsp;title=&quot;Erlang&nbsp;R14B04&nbsp;(erts-5.8.5)&nbsp;[source]&nbsp;[64-bit]&nbsp;[smp:8:8]&nbsp;[rq:8]&nbsp;[async-threads:30]&nbsp;[kernel-poll:true]&quot;&nbsp;style=&quot;text-align:right;color:inherit;font-family:Verdana,sans-serif;font-size:12px;background-image:none;padding:0px;border-top-left-radius:2px;border-top-right-radius:2px;border-bottom-right-radius:2px;border-bottom-left-radius:2px;border-style:none&nbsp;none&nbsp;dotted;border-bottom-width:1px&quot;&gt;Erlang&nbsp;R14B04&lt;/acronym&gt;)&nbsp;that&nbsp;we&nbsp;come&nbsp;to&nbsp;notice&nbsp;in&nbsp;our&nbsp;OpenStack&nbsp;cluster,&nbsp;that&nbsp;use&nbsp;RabbitMQ&nbsp;for&nbsp;message&nbsp;delivery.&nbsp;Understanding&nbsp;OpenStack&nbsp;is&nbsp;not&nbsp;required&nbsp;here&nbsp;but&nbsp;i&nbsp;will&nbsp;try&nbsp;to&nbsp;abstract&nbsp;what&nbsp;is&nbsp;that&nbsp;as&nbsp;much&nbsp;as&nbsp;i&nbsp;can.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Basically&nbsp;we&nbsp;have&nbsp;3&nbsp;nodes&nbsp;RabbitMQ&nbsp;cluster&nbsp;and&nbsp;a&nbsp;bunch&nbsp;OpenStack&nbsp;services&nbsp;that&nbsp;use&nbsp;RabbitMQ&nbsp;to&nbsp;communicate&nbsp;between&nbsp;them,&nbsp;one&nbsp;of&nbsp;the&nbsp;mean&nbsp;of&nbsp;communication&nbsp;is&nbsp;RPC,&nbsp;which&nbsp;is&nbsp;done&nbsp;by&nbsp;creating&nbsp;exchanges,&nbsp;queues&nbsp;with&nbsp;auto-delete&nbsp;flag&nbsp;set,&nbsp;which&nbsp;are&nbsp;the&nbsp;one&nbsp;that&nbsp;exhibit&nbsp;the&nbsp;problem.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;usually&nbsp;all&nbsp;OpenStack&nbsp;services&nbsp;start&nbsp;using&nbsp;one&nbsp;node&nbsp;of&nbsp;the&nbsp;cluster&nbsp;and&nbsp;when&nbsp;this&nbsp;node&nbsp;go&nbsp;down&nbsp;they&nbsp;connect&nbsp;to&nbsp;another&nbsp;node&nbsp;and&nbsp;make&nbsp;sure&nbsp;that&nbsp;all&nbsp;exchanges&nbsp;and&nbsp;queues&nbsp;are&nbsp;re-created&nbsp;there,&nbsp;usually&nbsp;the&nbsp;re-creation&nbsp;part&nbsp;end&nbsp;up&nbsp;being&nbsp;a&nbsp;no-op&nbsp;b/c&nbsp;of&nbsp;the&nbsp;cluster&nbsp;synchronization&nbsp;(Queues&nbsp;are&nbsp;also&nbsp;created&nbsp;with&nbsp;x-ha-policy&nbsp;set&nbsp;to&nbsp;all).&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;in&nbsp;the&nbsp;same&nbsp;time&nbsp;if&nbsp;a&nbsp;node&nbsp;of&nbsp;the&nbsp;cluster&nbsp;go&nbsp;down&nbsp;the&nbsp;Queue&nbsp;consumer&nbsp;that&nbsp;are&nbsp;created&nbsp;in&nbsp;this&nbsp;node&nbsp;will&nbsp;be&nbsp;deleted,&nbsp;the&nbsp;Queues&nbsp;with&nbsp;auto-delete&nbsp;will&nbsp;end&nbsp;up&nbsp;being&nbsp;deleted&nbsp;too&nbsp;and&nbsp;the&nbsp;same&nbsp;thing&nbsp;with&nbsp;the&nbsp;exchanges&nbsp;bounded&nbsp;to&nbsp;them&nbsp;which&nbsp;also&nbsp;have&nbsp;auto-delete,&nbsp;all&nbsp;of&nbsp;this&nbsp;will&nbsp;be&nbsp;done&nbsp;**eventually**&nbsp;in&nbsp;all&nbsp;RabbitMQ&nbsp;nodes&nbsp;that&nbsp;are&nbsp;still&nbsp;up.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;in&nbsp;detail&nbsp;from&nbsp;neutron&nbsp;side&nbsp;we&nbsp;have:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;N1.&nbsp;Connect&nbsp;to&nbsp;node&nbsp;2.&lt;/span&gt;&lt;br&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;<br>
<br>
&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;N2.&nbsp;Create&nbsp;Exchange&nbsp;X.&lt;/span&gt;&lt;br&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;<br>
<br>
&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;N3.&nbsp;Create&nbsp;Queue&nbsp;Q.&lt;/span&gt;&lt;br&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;<br>
<br>
&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;N4.&nbsp;Create&nbsp;Binding&nbsp;from&nbsp;Q&nbsp;to&nbsp;X.&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;&lt;br&gt;<br>
<br>
&lt;/span&gt;&lt;/div&gt;&lt;div&gt;From&nbsp;cluster&nbsp;side&nbsp;we&nbsp;have:&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;R1.&nbsp;Delete&nbsp;consumer.&lt;/span&gt;&lt;br&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;<br>
<br>
&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;R2.&nbsp;Delete&nbsp;Queue&nbsp;Q&nbsp;(Binding&nbsp;is&nbsp;deleted&nbsp;explicitly).&lt;/span&gt;&lt;br&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;<br>
<br>
&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;R3.&nbsp;Delete&nbsp;Exchange&nbsp;X.&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(51,51,51);font-family:&#39;Ubuntu&nbsp;Mono&#39;,monospace;font-size:12px;line-height:18px&quot;&gt;&lt;br&gt;<br>
<br>
&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;This&nbsp;actually&nbsp;can&nbsp;lead&nbsp;to&nbsp;a&nbsp;race&nbsp;condition&nbsp;that&nbsp;will&nbsp;result&nbsp;of&nbsp;N4&nbsp;failing&nbsp;with&nbsp;error&nbsp;stating&nbsp;that&nbsp;exchange&nbsp;doesn&#39;t&nbsp;exist&nbsp;because&nbsp;apparently&nbsp;R3&nbsp;action&nbsp;was&nbsp;executed&nbsp;after&nbsp;N2&nbsp;and&nbsp;before&nbsp;N4.&lt;/div&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;workaround&nbsp;that&nbsp;we&nbsp;have&nbsp;created&nbsp;is&nbsp;to&nbsp;retry&nbsp;creation&nbsp;if&nbsp;it&nbsp;fail&nbsp;as&nbsp;you&nbsp;can&nbsp;see&nbsp;in&nbsp;the&nbsp;bug&nbsp;report&nbsp;in&nbsp;OpenStack&nbsp;side &lt;a&nbsp;href=&quot;https://bugs.launchpad.net/neutron/+bug/1318721&quot;&gt;https://bugs.launchpad.net/neutron/+bug/1318721&lt;/a&gt;. &lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;i&nbsp;think&nbsp;that&nbsp;this&nbsp;also&nbsp;a&nbsp;problem&nbsp;in&nbsp;RabbitMQ&nbsp;side,&nbsp;basically&nbsp;i&nbsp;believe&nbsp;a&nbsp;more&nbsp;sane&nbsp;behavior&nbsp;will&nbsp;be&nbsp;for&nbsp;RabbitMQ&nbsp;to&nbsp;ignore&nbsp;**old**&nbsp;delete&nbsp;if&nbsp;a&nbsp;newest&nbsp;exchange&#39;s&nbsp;declare&nbsp;was&nbsp;sent,&nbsp;instead&nbsp;of&nbsp;threading&nbsp;this&nbsp;later&nbsp;as&nbsp;a&nbsp;no&nbsp;op.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;my&nbsp;analyze&nbsp;above&nbsp;make&nbsp;sense&nbsp;!?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;reading&nbsp;also&nbsp;the&nbsp;AMQP&nbsp;0-9-1&nbsp;reference&nbsp;(&lt;a&nbsp;href=&quot;https://www.rabbitmq.com/amqp-0-9-1-reference.html&quot;&gt;https://www.rabbitmq.com/amqp-0-9-1-reference.html&lt;/a&gt;)&nbsp;i&nbsp;found&nbsp;that:&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&nbsp;class=&quot;&quot;&nbsp;style=&quot;margin:0px;padding:0px;color:rgb(85,85,85);font-family:Verdana,sans-serif;font-size:13px;line-height:18px&quot;&gt;&lt;li&nbsp;style=&quot;list-style-type:none;background-image:url(https://www.rabbitmq.com/img/li.gif);margin:0px;padding:6px&nbsp;0px&nbsp;0px&nbsp;10px;background-repeat:no-repeat&nbsp;no-repeat&quot;&gt;<br>
<br>
The&nbsp;server&nbsp;SHOULD&nbsp;allow&nbsp;for&nbsp;a&nbsp;reasonable&nbsp;delay&nbsp;between&nbsp;the&nbsp;point&nbsp;when&nbsp;it&nbsp;determines&nbsp;that&nbsp;an&nbsp;exchange&nbsp;is&nbsp;not&nbsp;being&nbsp;used&nbsp;(or&nbsp;no&nbsp;longer&nbsp;used),&nbsp;and&nbsp;the&nbsp;point&nbsp;when&nbsp;it&nbsp;deletes&nbsp;the&nbsp;exchange.&nbsp;At&nbsp;the&nbsp;least&nbsp;it&nbsp;must&nbsp;allow&nbsp;a&nbsp;client&nbsp;to&nbsp;create&nbsp;an&nbsp;exchange&nbsp;and&nbsp;then&nbsp;bind&nbsp;a&nbsp;queue&nbsp;to&nbsp;it,&nbsp;with&nbsp;a&nbsp;small&nbsp;but&nbsp;non-zero&nbsp;delay&nbsp;between&nbsp;these&nbsp;two&nbsp;actions.&lt;/li&gt;<br>
<br>
&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;my&nbsp;finding&nbsp;contradict&nbsp;this&nbsp;?&nbsp;And&nbsp;how&nbsp;big&nbsp;is&nbsp;the&nbsp;delay&nbsp;?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One&nbsp;last&nbsp;thing&nbsp;is&nbsp;the&nbsp;auto-delete&nbsp;deprecation&nbsp;from&nbsp;&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/amqp-0-9-1-errata.html&quot;&gt;http://www.rabbitmq.com/amqp-0-9-1-errata.html&lt;/a&gt;,&nbsp;point&nbsp;25:&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &lt;span&nbsp;style=&quot;color:rgb(85,85,85);font-family:Verdana,sans-serif;font-size:13px;line-height:18px&quot;&gt;The&nbsp;&#39;auto-delete&#39;&nbsp;flag&nbsp;on&nbsp;&#39;exchange.declare&#39;&nbsp;got&nbsp;deprecated&nbsp;in&nbsp;0-9-1.&nbsp;Auto-delete&nbsp;exchanges&nbsp;are&nbsp;actually&nbsp;quite&nbsp;useful,&nbsp;so&nbsp;this&nbsp;flag&nbsp;should&nbsp;be&nbsp;restored.&lt;/span&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;this&nbsp;mean&nbsp;the&nbsp;auto-delete&nbsp;flag&nbsp;will&nbsp;not&nbsp;be&nbsp;removed&nbsp;from&nbsp;RabbitMQ&nbsp;or&nbsp;what&nbsp;?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;for&nbsp;you&nbsp;time&nbsp;and&nbsp;hope&nbsp;this&nbsp;was&nbsp;helpful&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;--&lt;/div&gt;&lt;div&gt;<br>
Mouad&nbsp;Benchchaoui &lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
