<tt>
Thanks&nbsp;Simon.&nbsp;The&nbsp;5%&nbsp;figure&nbsp;is&nbsp;useful&nbsp;for&nbsp;me.&lt;br&gt;&lt;br&gt;Let&nbsp;me&nbsp;give&nbsp;you&nbsp;a&nbsp;more&nbsp;precise&nbsp;description&nbsp;of&nbsp;what&nbsp;I&amp;#39;m&nbsp;doing&nbsp;to&nbsp;get&nbsp;the&nbsp;36&nbsp;message/sec.&lt;br&gt;&lt;br&gt;&lt;ul&gt;&lt;li&gt;RabbitMQ&nbsp;2.71&nbsp;on&nbsp;a&nbsp;3-node&nbsp;cluster&nbsp;with&nbsp;mirrored&nbsp;queues,&nbsp;durable&nbsp;on&nbsp;all&nbsp;nodes.&lt;/li&gt;<br>
&lt;li&gt;Client&nbsp;is&nbsp;Python&nbsp;2.6/Pika&nbsp;0.9.5.&lt;/li&gt;&lt;li&gt;Each&nbsp;message&nbsp;publish&nbsp;occurs&nbsp;in&nbsp;a&nbsp;transaction&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;be&nbsp;sure&nbsp;it&amp;#39;s&nbsp;safely&nbsp;in&nbsp;RabbitMQ.&lt;/li&gt;&lt;li&gt;All&nbsp;nodes&nbsp;are&nbsp;Ubuntu&nbsp;10.04&nbsp;VMs&nbsp;with&nbsp;4GB&nbsp;RAM&nbsp;and&nbsp;2&nbsp;or&nbsp;4&nbsp;vCPUs.&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;<br>
&lt;br&gt;At&nbsp;the&nbsp;heart&nbsp;of&nbsp;things,&nbsp;we&amp;#39;re&nbsp;driving&nbsp;a&nbsp;highly&nbsp;complex&nbsp;state&nbsp;machine&nbsp;that&nbsp;manages&nbsp;thousands&nbsp;of&nbsp;VMs&nbsp;and&nbsp;their&nbsp;associated&nbsp;state.&nbsp;Losing&nbsp;track&nbsp;of&nbsp;any&nbsp;state&nbsp;is&nbsp;prohibitively&nbsp;expensive&nbsp;to&nbsp;clean&nbsp;up&nbsp;manually.&nbsp;As&nbsp;such,&nbsp;all&nbsp;state&nbsp;is&nbsp;modeled&nbsp;in&nbsp;clustered&nbsp;databases&nbsp;and/or&nbsp;persistent&nbsp;messages&nbsp;in&nbsp;the&nbsp;message&nbsp;queue.&nbsp;We&nbsp;have&nbsp;to&nbsp;assume&nbsp;that&nbsp;a&nbsp;given&nbsp;client&nbsp;app&nbsp;instance&nbsp;(our&nbsp;management&nbsp;code)&nbsp;may&nbsp;be&nbsp;ungracefully&nbsp;terminated&nbsp;at&nbsp;any&nbsp;moment,&nbsp;so&nbsp;enough&nbsp;state&nbsp;must&nbsp;be&nbsp;modeled&nbsp;to&nbsp;let&nbsp;a&nbsp;new&nbsp;instance&nbsp;pick&nbsp;up&nbsp;and&nbsp;recover.&nbsp;If&nbsp;our&nbsp;database&nbsp;record&nbsp;indicates&nbsp;that&nbsp;a&nbsp;message&nbsp;has&nbsp;been&nbsp;sent,&nbsp;it&nbsp;better&nbsp;darn&nbsp;well&nbsp;be&nbsp;in&nbsp;the&nbsp;hands&nbsp;of&nbsp;the&nbsp;RabbitMQ&nbsp;broker,&nbsp;and&nbsp;not&nbsp;sitting&nbsp;in&nbsp;some&nbsp;Pika&nbsp;client-side&nbsp;queue.&lt;br&gt;<br>
&lt;br&gt;For&nbsp;this&nbsp;reasons,&nbsp;publisher-confirms&nbsp;are&nbsp;not&nbsp;particularly&nbsp;helpful&nbsp;-&nbsp;They&nbsp;assume&nbsp;that&nbsp;the&nbsp;client&nbsp;app&nbsp;will&nbsp;be&nbsp;around&nbsp;to&nbsp;resend&nbsp;the&nbsp;message&nbsp;if&nbsp;the&nbsp;message&nbsp;doesn&amp;#39;t&nbsp;get&nbsp;confirmed.&nbsp;Similar&nbsp;story&nbsp;for&nbsp;batching&nbsp;messages.&nbsp;We&nbsp;have&nbsp;to&nbsp;know&nbsp;they&amp;#39;ve&nbsp;been&nbsp;sent,&nbsp;and&nbsp;we&nbsp;can&amp;#39;t&nbsp;stall&nbsp;our&nbsp;state&nbsp;machine&nbsp;waiting&nbsp;for&nbsp;enough&nbsp;message&nbsp;to&nbsp;accumulate&nbsp;to&nbsp;publish&nbsp;multiple&nbsp;messages&nbsp;at&nbsp;once.&lt;br&gt;<br>
&lt;br&gt;My&nbsp;goal&nbsp;in&nbsp;my&nbsp;latest&nbsp;round&nbsp;of&nbsp;experiments&nbsp;is&nbsp;to&nbsp;see&nbsp;what&nbsp;the&nbsp;maximum&nbsp;throughput&nbsp;of&nbsp;a&nbsp;highly&nbsp;available&nbsp;system&nbsp;is&nbsp;in&nbsp;optimal&nbsp;circumstances.&nbsp;We&amp;#39;re&nbsp;perfectly&nbsp;willing&nbsp;to&nbsp;spend&nbsp;the&nbsp;money&nbsp;on&nbsp;high&nbsp;end&nbsp;SSDs&nbsp;and&nbsp;networking&nbsp;equipment&nbsp;as&nbsp;necessary.&lt;br&gt;<br>
&lt;br&gt;To&nbsp;prototype&nbsp;what&nbsp;this&nbsp;perf&nbsp;level&nbsp;is,&nbsp;I&amp;#39;ve&nbsp;configured&nbsp;RabbitMQ&nbsp;with&nbsp;the&nbsp;MNESIA&nbsp;directory&nbsp;pointing&nbsp;to&nbsp;a&nbsp;ramdisk&nbsp;(/tmp).&nbsp;I&amp;#39;ve&nbsp;configured&nbsp;all&nbsp;the&nbsp;VMs&nbsp;with&nbsp;VMXNET3&nbsp;networking,&nbsp;am&nbsp;with&nbsp;16K&nbsp;blocks,&nbsp;are&nbsp;seeing&nbsp;bandwidth&nbsp;of&nbsp;130MB/sec&nbsp;between&nbsp;VMs&nbsp;in&nbsp;the&nbsp;cluster.&lt;br&gt;<br>
&lt;br&gt;My&nbsp;test&nbsp;app&nbsp;simply&nbsp;writes&nbsp;6&nbsp;byte&nbsp;message,&nbsp;one&nbsp;at&nbsp;a&nbsp;time,&nbsp;as&nbsp;quickly&nbsp;as&nbsp;it&nbsp;can.&nbsp;In&nbsp;monitoring&nbsp;the&nbsp;cluster&nbsp;nodes,&nbsp;I&amp;#39;m&nbsp;seeing&nbsp;very&nbsp;low&nbsp;CPU&nbsp;usage,&nbsp;very&nbsp;few&nbsp;writes&nbsp;to&nbsp;the&nbsp;physical&nbsp;disk,&nbsp;and&nbsp;network&nbsp;operation&nbsp;rates&nbsp;of&nbsp;about&nbsp;700/sec&nbsp;for&nbsp;the&nbsp;master&nbsp;node&nbsp;and&nbsp;350/sec&nbsp;for&nbsp;the&nbsp;client&nbsp;node.&lt;br&gt;<br>
&lt;br&gt;In&nbsp;short,&nbsp;there&amp;#39;s&nbsp;a&nbsp;bottleneck&nbsp;somewhere&nbsp;and&nbsp;it&amp;#39;s&nbsp;not&nbsp;obvious&nbsp;where.&nbsp;I&amp;#39;ll&nbsp;try&nbsp;your&nbsp;suggestion&nbsp;about&nbsp;replacing&nbsp;tx.commit.&nbsp;Any&nbsp;other&nbsp;insight&nbsp;or&nbsp;guidance&nbsp;would&nbsp;of&nbsp;course&nbsp;be&nbsp;very&nbsp;much&nbsp;appreciated.&nbsp;:-)&lt;br&gt;&lt;br&gt;Matt&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Feb&nbsp;15,&nbsp;2012&nbsp;at&nbsp;2:08&nbsp;AM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;14/02/12&nbsp;23:07,&nbsp;Matt&nbsp;Pietrek&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&amp;#39;m&nbsp;looking&nbsp;to&nbsp;squeeze&nbsp;every&nbsp;last&nbsp;bit&nbsp;of&nbsp;message&nbsp;throughput&nbsp;out&nbsp;of&nbsp;our&lt;br&gt;<br>
mirrored&nbsp;queue&nbsp;setup.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Hi&nbsp;Matt.&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;max&nbsp;out&nbsp;at&nbsp;36&nbsp;messages/sec&nbsp;when&nbsp;writing.&nbsp;(Yes,&lt;br&gt;<br>
we&nbsp;use&nbsp;transactions,&nbsp;and&nbsp;we&nbsp;know&nbsp;it&amp;#39;s&nbsp;not&nbsp;optimal,&nbsp;but&nbsp;we&amp;#39;re&nbsp;valuing&lt;br&gt;<br>
high&nbsp;reliability&nbsp;over&nbsp;speed.&nbsp;Our&nbsp;clients&nbsp;and/or&nbsp;servers&nbsp;could&nbsp;go&nbsp;away&nbsp;at&lt;br&gt;<br>
any&nbsp;moment,&nbsp;so&nbsp;things&nbsp;like&nbsp;Publisher-acknowledge&nbsp;are&nbsp;nice,&nbsp;but&nbsp;take&nbsp;away&lt;br&gt;<br>
from&nbsp;the&nbsp;fundamental&nbsp;disaster&nbsp;hardness.)&lt;br&gt;<br>
&lt;br&gt;<br>
Anyhow,&nbsp;we&amp;#39;re&nbsp;running&nbsp;on&nbsp;Ubuntu&nbsp;10.04&nbsp;with&nbsp;2.71&nbsp;and&nbsp;the&nbsp;default&nbsp;Erlang&lt;br&gt;<br>
install.&nbsp;This&nbsp;gives&nbsp;us&nbsp;R13B03&nbsp;as&nbsp;the&nbsp;Erlang&nbsp;version.&lt;br&gt;<br>
&lt;br&gt;<br>
Question:&nbsp;Does&nbsp;anybody&nbsp;(and&nbsp;particularly&nbsp;the&nbsp;RabbitMQ&nbsp;folks)&nbsp;have&nbsp;any&lt;br&gt;<br>
input&nbsp;on&nbsp;what&nbsp;sort&nbsp;of&nbsp;perf&nbsp;improvements&nbsp;we&nbsp;might&nbsp;get&nbsp;by&nbsp;switching&nbsp;to&nbsp;a&lt;br&gt;<br>
newer&nbsp;Erlang&nbsp;Version?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Not&nbsp;much&nbsp;really.&nbsp;We&nbsp;haven&amp;#39;t&nbsp;tested&nbsp;extensively&nbsp;but&nbsp;if&nbsp;you&nbsp;got&nbsp;5%&nbsp;I&nbsp;think&nbsp;you&nbsp;would&nbsp;consider&nbsp;yourself&nbsp;lucky.&lt;br&gt;<br>
&lt;br&gt;<br>
However,&nbsp;36&nbsp;msg/s&nbsp;is&nbsp;*really*&nbsp;slow.&lt;br&gt;<br>
&lt;br&gt;<br>
Although&nbsp;mirrored&nbsp;queues&nbsp;are&nbsp;slower&nbsp;than&nbsp;normal&nbsp;ones&nbsp;I&nbsp;would&nbsp;still&nbsp;hope&nbsp;you&nbsp;could&nbsp;stick&nbsp;a&nbsp;couple&nbsp;of&nbsp;zeroes&nbsp;on&nbsp;the&nbsp;end&nbsp;of&nbsp;that&nbsp;figure.&nbsp;So&nbsp;I&nbsp;suspect&nbsp;you&nbsp;are&nbsp;not&nbsp;actually&nbsp;CPU&nbsp;bound&nbsp;at&nbsp;the&nbsp;server.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;assume&nbsp;when&nbsp;you&nbsp;say&nbsp;&amp;quot;using&nbsp;transactions&amp;quot;&nbsp;you&nbsp;mean&nbsp;publishing&nbsp;a&nbsp;single&nbsp;message&nbsp;per&nbsp;transaction?&nbsp;In&nbsp;that&nbsp;case&nbsp;you&nbsp;are&nbsp;incurring&nbsp;the&nbsp;cost&nbsp;of&nbsp;a&nbsp;network&nbsp;round&nbsp;trip&nbsp;and&nbsp;an&nbsp;fsync()&nbsp;on&nbsp;each&nbsp;publish,&nbsp;and&nbsp;I&nbsp;suspect&nbsp;that&nbsp;is&nbsp;what&nbsp;is&nbsp;killing&nbsp;your&nbsp;performance.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
If&nbsp;I&nbsp;had&nbsp;to&nbsp;guess&nbsp;I&nbsp;would&nbsp;suspect&nbsp;the&nbsp;fsync&nbsp;is&nbsp;the&nbsp;worst&nbsp;of&nbsp;the&nbsp;problem.&nbsp;Assuming&nbsp;the&nbsp;36&nbsp;msg/s&nbsp;is&nbsp;from&nbsp;some&nbsp;test&nbsp;app,&nbsp;you&nbsp;might&nbsp;want&nbsp;to&nbsp;remove&nbsp;the&nbsp;tx.select&nbsp;and&nbsp;replace&nbsp;the&nbsp;tx.commit&nbsp;with&nbsp;some&nbsp;meaningless&nbsp;synchronous&nbsp;request&nbsp;(basic.qos&nbsp;is&nbsp;a&nbsp;favourite)&nbsp;and&nbsp;see&nbsp;what&nbsp;happens&nbsp;to&nbsp;your&nbsp;message&nbsp;rate.&nbsp;If&nbsp;it&nbsp;shoots&nbsp;up,&nbsp;the&nbsp;fsync&nbsp;is&nbsp;the&nbsp;problem.&nbsp;If&nbsp;it&nbsp;doesn&amp;#39;t,&nbsp;the&nbsp;network&nbsp;round&nbsp;trip&nbsp;is.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
When&nbsp;you&nbsp;have&nbsp;the&nbsp;answer&nbsp;to&nbsp;that,&nbsp;you&nbsp;know&nbsp;whether&nbsp;you&amp;#39;re&nbsp;going&nbsp;to&nbsp;want&nbsp;to&nbsp;spend&nbsp;money&nbsp;on&nbsp;fancy&nbsp;networking&nbsp;hardware&nbsp;or&nbsp;SSDs...&lt;br&gt;<br>
&lt;br&gt;<br>
Of&nbsp;course,&nbsp;*really*&nbsp;I&nbsp;would&nbsp;suggest&nbsp;you&nbsp;need&nbsp;to&nbsp;be&nbsp;publishing&nbsp;more&nbsp;messages&nbsp;per&nbsp;round-trip&nbsp;/&nbsp;fsync.&nbsp;So&nbsp;either&nbsp;batch&nbsp;multiple&nbsp;publishes&nbsp;into&nbsp;a&nbsp;transaction&nbsp;or&nbsp;start&nbsp;using&nbsp;confirms&nbsp;instead.&nbsp;I&nbsp;know&nbsp;you&nbsp;say&nbsp;that&nbsp;they&nbsp;&amp;quot;take&nbsp;away&nbsp;from&nbsp;the&nbsp;fundamental&nbsp;disaster&nbsp;hardness&amp;quot;&nbsp;but&nbsp;I&amp;#39;m&nbsp;not&nbsp;sure&nbsp;I&nbsp;understand&nbsp;what&nbsp;you&nbsp;mean&nbsp;by&nbsp;that.&nbsp;Both&nbsp;confirms&nbsp;and&nbsp;tx&nbsp;give&nbsp;you&nbsp;a&nbsp;way&nbsp;to&nbsp;know&nbsp;when&nbsp;a&nbsp;given&nbsp;message&nbsp;is&nbsp;definitely&nbsp;on&nbsp;disc.&nbsp;And&nbsp;in&nbsp;fact&nbsp;tx&nbsp;is&nbsp;implemented&nbsp;in&nbsp;terms&nbsp;of&nbsp;confirms&nbsp;these&nbsp;days.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Cheers,&nbsp;Simon&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
--&nbsp;&lt;br&gt;<br>
Simon&nbsp;MacMullen&lt;br&gt;<br>
RabbitMQ,&nbsp;VMware&lt;br&gt;<br>
______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
