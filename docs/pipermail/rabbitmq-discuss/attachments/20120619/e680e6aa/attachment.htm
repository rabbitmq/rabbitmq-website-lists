<tt>
Francesco,&lt;br&gt;&lt;br&gt;Thanks&nbsp;again&nbsp;for&nbsp;the&nbsp;valuable&nbsp;insight&nbsp;from&nbsp;your&nbsp;reply.&nbsp;I&amp;#39;m&nbsp;down&nbsp;to&nbsp;one&nbsp;issue&nbsp;at&nbsp;this&nbsp;point.&lt;br&gt;&lt;br&gt;Given&nbsp;what&nbsp;you&nbsp;said&nbsp;earlier&nbsp;about&nbsp;it&nbsp;being&nbsp;OK&nbsp;to&nbsp;start&nbsp;the&nbsp;brokers&nbsp;in&nbsp;any&nbsp;order,&nbsp;I&nbsp;wrote&nbsp;a&nbsp;simple&nbsp;&amp;quot;catastrophic&nbsp;stress&amp;quot;&nbsp;test.&nbsp;The&nbsp;good&nbsp;news&nbsp;is&nbsp;that&nbsp;RabbitMQ&nbsp;does&nbsp;what&amp;#39;s&nbsp;expected.&nbsp;The&nbsp;bad&nbsp;news:&nbsp;Only&nbsp;most&nbsp;of&nbsp;the&nbsp;time,&nbsp;i.e.&nbsp;about&nbsp;90%.&lt;br&gt;<br>
&lt;br&gt;Here&amp;#39;s&nbsp;what&nbsp;the&nbsp;test&nbsp;does:&lt;br&gt;&lt;br&gt;In&nbsp;a&nbsp;loop&nbsp;(5&nbsp;times):&lt;br&gt; &nbsp; &nbsp;Write&nbsp;5&nbsp;messages&nbsp;to&nbsp;a&nbsp;queue&nbsp;comprised&nbsp;of&nbsp;3&nbsp;clustered&nbsp;nodes&nbsp;(disk&nbsp;based).&lt;br&gt; &nbsp; &nbsp;Kill&nbsp;all&nbsp;RabbitMQ&amp;#39;s&nbsp;as&nbsp;quickly&nbsp;as&nbsp;possible&nbsp;-&nbsp;I&nbsp;use&nbsp;&amp;quot;killall&nbsp;beam.smp&amp;quot;&nbsp;invoked&nbsp;on&nbsp;all&nbsp;nodes&nbsp;simultaneously&nbsp;via&nbsp;Capistrano.&lt;br&gt;<br>
 &nbsp; &nbsp;Restart&nbsp;all&nbsp;nodes&nbsp;in&nbsp;parallel&nbsp;(again,&nbsp;using&nbsp;Capistrano).&lt;br&gt; &nbsp; &nbsp;Verify&nbsp;that&nbsp;each&nbsp;previously&nbsp;written&nbsp;message&nbsp;can&nbsp;be&nbsp;received.&lt;br&gt;&lt;br&gt;~90%&nbsp;of&nbsp;the&nbsp;time,&nbsp;an&nbsp;iteration&nbsp;runs&nbsp;to&nbsp;completion&nbsp;as&nbsp;expected.&nbsp;About&nbsp;10%&nbsp;of&nbsp;the&nbsp;time,&nbsp;one&nbsp;of&nbsp;the&nbsp;nodes&nbsp;fails&nbsp;to&nbsp;start,&lt;br&gt;<br>
getting&nbsp;stuck&nbsp;with&nbsp;the&nbsp;last&nbsp;line&nbsp;being&nbsp;&amp;quot;starting&nbsp;database&nbsp;...&amp;quot;&lt;br&gt;&lt;br&gt;I&nbsp;see&nbsp;nothing&nbsp;of&nbsp;note&nbsp;in&nbsp;the&nbsp;rabbit@&amp;lt;node&amp;gt;.log&nbsp;file.&lt;br&gt;&lt;br&gt;When&nbsp;this&nbsp;happens,&nbsp;I&nbsp;have&nbsp;no&nbsp;luck&nbsp;getting&nbsp;the&nbsp;node&nbsp;to&nbsp;join&nbsp;the&nbsp;cluster.&nbsp;Even&nbsp;attempting&nbsp;a&nbsp;&amp;quot;rabbitmqctl&nbsp;force_reset&amp;quot;&nbsp;hangs.&nbsp;The&nbsp;only&nbsp;way&nbsp;I&nbsp;can&nbsp;get&nbsp;the&nbsp;cluster&nbsp;fully&nbsp;formed&nbsp;again&nbsp;is&nbsp;to&nbsp;terminate&nbsp;all&nbsp;the&nbsp;nodes,&nbsp;then&nbsp;bring&nbsp;them&nbsp;back&nbsp;up.&nbsp;(A&nbsp;reset&nbsp;is&nbsp;not&nbsp;required&nbsp;in&nbsp;this&nbsp;case,&nbsp;however.)&lt;br&gt;<br>
&lt;br&gt;For&nbsp;what&nbsp;it&amp;#39;s&nbsp;worth,&nbsp;the&nbsp;broker&nbsp;start&nbsp;logic&nbsp;looks&nbsp;like&nbsp;this&lt;br&gt;   &nbsp;nohup&nbsp;rabbitmq-server&nbsp;&amp;amp;&lt;br&gt;   &nbsp;rabbitmqctl&nbsp;wait&nbsp;&amp;lt;pidfile&amp;gt;&lt;br&gt;&lt;br&gt;Are&nbsp;their&nbsp;any&nbsp;trace&nbsp;options&nbsp;or&nbsp;other&nbsp;places&nbsp;to&nbsp;look&nbsp;to&nbsp;understand&nbsp;why&nbsp;a&nbsp;node&nbsp;gets&nbsp;stuck&nbsp;on&nbsp;&amp;quot;creating&nbsp;database...&amp;quot;&nbsp;?&lt;br&gt;<br>
&lt;br&gt;This&nbsp;bit&nbsp;of&nbsp;startup&nbsp;unpredictability&nbsp;is&nbsp;causing&nbsp;a&nbsp;lot&nbsp;of&nbsp;concern&nbsp;with&nbsp;our&nbsp;VP.&nbsp;I&amp;#39;ve&nbsp;been&nbsp;tasked&nbsp;with&nbsp;coming&nbsp;up&nbsp;with&nbsp;the&nbsp;complete&nbsp;story,&nbsp;and&nbsp;workarounds&nbsp;to&nbsp;any&nbsp;problems&nbsp;like&nbsp;this.&lt;br&gt;&lt;br&gt;Thanks&nbsp;very&nbsp;much&nbsp;again,&lt;br&gt;&lt;br&gt;<br>
Matt&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jun&nbsp;19,&nbsp;2012&nbsp;at&nbsp;1:49&nbsp;AM,&nbsp;Francesco&nbsp;Mazzoli&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:francesco@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;francesco@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Hi&nbsp;Matt,&lt;br&gt;<br>
&lt;br&gt;<br>
At&nbsp;Mon,&nbsp;18&nbsp;Jun&nbsp;2012&nbsp;11:16:40&nbsp;-0700,&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;Matt&nbsp;Pietrek&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Francesco,&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Thanks&nbsp;very&nbsp;much&nbsp;for&nbsp;the&nbsp;detailed&nbsp;reply.&nbsp;It&nbsp;was&nbsp;extremely&nbsp;helpful.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Glad&nbsp;I&nbsp;could&nbsp;help.&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;gt;&nbsp;Question&nbsp;1&lt;br&gt;<br>
&amp;gt;&nbsp;----------------&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&amp;gt;&nbsp;I&nbsp;stumbled&nbsp;across&nbsp;this&nbsp;in&nbsp;my&nbsp;own&nbsp;previous&nbsp;experimentation.&nbsp;The&lt;br&gt;<br>
&amp;gt;&nbsp;question&nbsp;is,&nbsp;do&nbsp;I&nbsp;risk&nbsp;message&nbsp;loss&nbsp;by&nbsp;first&nbsp;starting&nbsp;a&nbsp;node&nbsp;that&lt;br&gt;<br>
&amp;gt;&nbsp;joined&nbsp;the&nbsp;cluster&nbsp;late,&nbsp;thus&nbsp;not&nbsp;having&nbsp;the&nbsp;full&nbsp;set&nbsp;of&nbsp;messages&nbsp;that&lt;br&gt;<br>
&amp;gt;&nbsp;other&nbsp;nodes&nbsp;have?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;No.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Question&nbsp;2&lt;br&gt;<br>
&amp;gt;&nbsp;---------------&lt;br&gt;<br>
&amp;gt;&nbsp;Related&nbsp;to&nbsp;the&nbsp;above&nbsp;scenario,&nbsp;is&nbsp;there&nbsp;any&nbsp;danger&nbsp;(after&nbsp;an&nbsp;unplanned&lt;br&gt;<br>
&amp;gt;&nbsp;shutdown),&nbsp;in&nbsp;simply&nbsp;letting&nbsp;all&nbsp;the&nbsp;nodes&nbsp;start&nbsp;in&nbsp;parallel&nbsp;and&lt;br&gt;<br>
&amp;gt;&nbsp;letting&nbsp;Mnesia&amp;#39;s&nbsp;waiting&nbsp;sort&nbsp;out&nbsp;the&nbsp;order?&nbsp;It&nbsp;seems&nbsp;to&nbsp;work&nbsp;OK&nbsp;in&nbsp;my&lt;br&gt;<br>
&amp;gt;&nbsp;limited&nbsp;testing&nbsp;so&nbsp;far,&nbsp;but&nbsp;I&nbsp;don&amp;#39;t&nbsp;know&nbsp;if&nbsp;we&amp;#39;re&nbsp;risking&nbsp;data&nbsp;loss.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;It&nbsp;should&nbsp;be&nbsp;fine,&nbsp;but&nbsp;in&nbsp;general&nbsp;it&amp;#39;s&nbsp;better&nbsp;to&nbsp;do&nbsp;cluster&nbsp;operations&lt;br&gt;<br>
sequentially&nbsp;and&nbsp;at&nbsp;one&nbsp;site.&nbsp;In&nbsp;this&nbsp;specific&nbsp;case&nbsp;it&nbsp;should&nbsp;be&nbsp;OK.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Question&nbsp;3&lt;br&gt;<br>
&amp;gt;&nbsp;---------------&lt;br&gt;<br>
&amp;gt;&nbsp;You&nbsp;said:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;gt;&nbsp;In&nbsp;other&nbsp;words,&nbsp;it&amp;#39;s&nbsp;up&nbsp;to&nbsp;you&nbsp;to&nbsp;restart&nbsp;them&nbsp;so&nbsp;that&nbsp;the&nbsp;node&nbsp;with&nbsp;the&nbsp;most&nbsp;up-to-date&nbsp;mnesia&nbsp;is&nbsp;started&nbsp;first&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Is&nbsp;there&nbsp;any&nbsp;information&nbsp;recorded&nbsp;somewhere&nbsp;(e.g.&nbsp;the&nbsp;logs),&nbsp;which&lt;br&gt;<br>
&amp;gt;&nbsp;would&nbsp;indicate&nbsp;which&nbsp;node&nbsp;has&nbsp;the&nbsp;&amp;quot;most&nbsp;up&nbsp;to&nbsp;date&amp;quot;&nbsp;Mnesia&nbsp;database?&nbsp;I&lt;br&gt;<br>
&amp;gt;&nbsp;see&nbsp;messages&nbsp;like:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp; &amp;gt;&nbsp;Mirrored-queue&nbsp;(queue&nbsp;&amp;#39;charon&amp;#39;&nbsp;in&nbsp;vhost&nbsp;&amp;#39;/&amp;#39;):&nbsp;Promoting&nbsp;slave&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;lt;rabbit@play2.1.273.0&amp;gt;&nbsp;to&nbsp;master&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;But&nbsp;don&amp;#39;t&nbsp;know&nbsp;if&nbsp;they&amp;#39;re&nbsp;necessarily&nbsp;correlated&nbsp;to&nbsp;who&nbsp;the&nbsp;most&lt;br&gt;<br>
&amp;gt;&nbsp;up-to-date&nbsp;Mnesia&nbsp;is.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Well,&nbsp;the&nbsp;fact&nbsp;that&nbsp;something&nbsp;got&nbsp;promoted&nbsp;to&nbsp;master&nbsp;tells&nbsp;you&nbsp;that&lt;br&gt;<br>
the&nbsp;previous&nbsp;master&nbsp;definitely&nbsp;went&nbsp;down&nbsp;before&nbsp;the&nbsp;promoted&nbsp;node.&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;won&amp;#39;t&nbsp;be&nbsp;precise&nbsp;information&nbsp;if&nbsp;you&nbsp;stop&nbsp;the&nbsp;nodes&nbsp;abruptly,&nbsp;but&lt;br&gt;<br>
you&nbsp;can&nbsp;look&nbsp;at&nbsp;&amp;quot;rabbit&nbsp;on&nbsp;node&nbsp;&amp;lt;node&amp;gt;&nbsp;down&amp;quot;&nbsp;messages&nbsp;in&nbsp;the&nbsp;logs&nbsp;-&lt;br&gt;<br>
the&nbsp;node&nbsp;in&nbsp;the&nbsp;clusters&nbsp;are&nbsp;linked&nbsp;in&nbsp;distributed&nbsp;Erlang&nbsp;and&nbsp;these&lt;br&gt;<br>
messages&nbsp;are&nbsp;generated&nbsp;when&nbsp;a&nbsp;node&nbsp;receives&nbsp;a&nbsp;&amp;#39;DOWN&amp;#39;&nbsp;message&nbsp;from&lt;br&gt;<br>
another&nbsp;node.&nbsp;Since&nbsp;they&nbsp;are&nbsp;&amp;quot;info&amp;quot;&nbsp;messages,&nbsp;you&nbsp;need&nbsp;to&nbsp;make&nbsp;sure&nbsp;to&lt;br&gt;<br>
have&nbsp;those&nbsp;enabled&nbsp;-&nbsp;they&nbsp;are&nbsp;enabled&nbsp;by&nbsp;default&nbsp;but&nbsp;a&nbsp;lot&nbsp;of&nbsp;people&lt;br&gt;<br>
don&amp;#39;t&nbsp;like&nbsp;them.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Francesco.&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
