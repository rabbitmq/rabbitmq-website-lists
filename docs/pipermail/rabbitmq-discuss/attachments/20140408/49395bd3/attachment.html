<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello&nbsp;All&lt;br&gt;&lt;br&gt;I&nbsp;was&nbsp;wondering&nbsp;if&nbsp;any&nbsp;one&nbsp;has&nbsp;had&nbsp;much&nbsp;success&nbsp;using&nbsp;Lyra&lt;br&gt;&lt;a&nbsp;href=&quot;https://github.com/jhalterman/lyra&quot;&gt;https://github.com/jhalterman/lyra&lt;/a&gt;&lt;br&gt;&lt;br&gt;From&nbsp;my&nbsp;testing&nbsp;so&nbsp;far&nbsp;it&nbsp;appears&nbsp;to&nbsp;do&nbsp;exactly&nbsp;what&nbsp;it&nbsp;says&nbsp;it&nbsp;will&nbsp;do&nbsp;However&lt;br&gt;&lt;br&gt;My&nbsp;problem&nbsp;is&nbsp;that&nbsp;when&nbsp;I&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;recovered&nbsp;consumer&nbsp;the&nbsp;same&nbsp;shutdown&nbsp;exception&nbsp;is&nbsp;thrown&nbsp;that&nbsp;cause&nbsp;the&nbsp;recovery&nbsp;in&nbsp;the&nbsp;first&nbsp;place.&lt;br&gt;My&nbsp;simple&nbsp;test&nbsp;case&nbsp;is&nbsp;to&nbsp;kill&nbsp;the&nbsp;connection&nbsp;using&nbsp;the&nbsp;web&nbsp;management&nbsp;console&nbsp;&nbsp;after&nbsp;sending&nbsp;a&nbsp;number&nbsp;of&nbsp;messages.&lt;br&gt;&lt;br&gt;There&nbsp;must&nbsp;be&nbsp;something&nbsp;here&nbsp;I&nbsp;am&nbsp;not&nbsp;understand&nbsp;correctly.&lt;br&gt;What&nbsp;I&nbsp;would&nbsp;expect&nbsp;is&nbsp;that&nbsp;after&nbsp;the&nbsp;connection&nbsp;and&nbsp;consumer&nbsp;is&nbsp;recovered&nbsp;any&nbsp;un&nbsp;acked&nbsp;messages&nbsp;would&nbsp;be&nbsp;republished&nbsp;but&nbsp;no&nbsp;the&nbsp;forced&nbsp;disconnect&nbsp;that&nbsp;caused&nbsp;the&nbsp;recovery&nbsp;in&nbsp;the&nbsp;first&nbsp;place.&lt;br&gt;&lt;br&gt;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;over&nbsp;come&nbsp;this&nbsp;or&nbsp;is&nbsp;forcefully&nbsp;killing&nbsp;the&nbsp;connection&nbsp;not&nbsp;a&nbsp;valid&nbsp;recovery&nbsp;test&nbsp;case&nbsp;?&lt;br&gt;&lt;br&gt;Here&nbsp;is&nbsp;test&nbsp;code&lt;br&gt;&lt;br&gt;&lt;br&gt;import&nbsp;com.rabbitmq.client.Channel;&lt;br&gt;import&nbsp;com.rabbitmq.client.ConnectionFactory;&lt;br&gt;import&nbsp;com.rabbitmq.client.QueueingConsumer;&lt;br&gt;import&nbsp;net.jodah.lyra.ConnectionOptions;&lt;br&gt;import&nbsp;net.jodah.lyra.Connections;&lt;br&gt;import&nbsp;net.jodah.lyra.config.Config;&lt;br&gt;import&nbsp;net.jodah.lyra.config.ConfigurableConnection;&lt;br&gt;import&nbsp;net.jodah.lyra.config.RecoveryPolicies;&lt;br&gt;&lt;br&gt;&lt;br&gt;public&nbsp;class&nbsp;RecoveryTest&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;RecoveryTest&nbsp;test;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;EXCHANGE_NAME&nbsp;=&nbsp;&quot;ORDER_UPDATES&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;EXCHANGE_HOST&nbsp;=&nbsp;&quot;localhost&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;EXCHANGE_USER&nbsp;=&nbsp;&quot;recover&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;EXCHANGE_PASS&nbsp;=&nbsp;&quot;recover&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;QUEUE&nbsp;=&nbsp;&quot;TEST_UPDATES&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;TOPIC&nbsp;=&nbsp;&quot;*.#&quot;;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Config&nbsp;config&nbsp;=&nbsp;new&nbsp;Config().withRecoveryPolicy(RecoveryPolicies.recoverAlways());;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ConnectionOptions&nbsp;options;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Channel&nbsp;channel;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ConnectionFactory&nbsp;factory;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ConfigurableConnection&nbsp;RecoveryConnection;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;QueueingConsumer&nbsp;consumer;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;void&nbsp;main(String[]&nbsp;args)&nbsp;throws&nbsp;Exception&nbsp;&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;=&nbsp;new&nbsp;RecoveryTest();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test.run();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;RecoveryTest()&nbsp;throws&nbsp;Exception&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options&nbsp;=&nbsp;new&nbsp;ConnectionOptions().withAddresses(EXCHANGE_HOST);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory&nbsp;=&nbsp;options.getConnectionFactory();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory.setUsername(EXCHANGE_USER);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory.setPassword(EXCHANGE_PASS);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RecoveryConnection&nbsp;=&nbsp;Connections.create(options,&nbsp;config);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel&nbsp;=&nbsp;RecoveryConnection.createChannel();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel.queueDeclare(QUEUE,&nbsp;true,&nbsp;false,&nbsp;false,&nbsp;null);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel.queueBind(QUEUE,&nbsp;EXCHANGE_NAME,&nbsp;TOPIC);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consumer&nbsp;=&nbsp;new&nbsp;QueueingConsumer(channel);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;autoAck&nbsp;=&nbsp;true;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel.basicConsume(QUEUE,&nbsp;autoAck,&nbsp;consumer);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;run()&nbsp;{&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QueueingConsumer.Delivery&nbsp;delivery&nbsp;=&nbsp;null;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;Starting&nbsp;Test&nbsp;Run&quot;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(true){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delivery&nbsp;=&nbsp;consumer.nextDelivery();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;ex)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;Somthing&nbsp;went&nbsp;wrong&nbsp;...&quot;&nbsp;+&nbsp;ex.getLocalizedMessage());&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;[]&nbsp;msg&nbsp;=&nbsp;delivery.getBody();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(String.valueOf(new&nbsp;String(msg)));&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;Lets&nbsp;take&nbsp;a&nbsp;rest&quot;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.sleep(8000);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(InterruptedException&nbsp;ex)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;We&nbsp;have&nbsp;been&nbsp;intrupted&quot;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;}&lt;br&gt;&lt;br&gt;&lt;br&gt;[main]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ConnectionHandler&nbsp;-&nbsp;Creating&nbsp;connection&nbsp;cxn-1&nbsp;to&nbsp;[localhost]&lt;br&gt;[main]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ConnectionHandler&nbsp;-&nbsp;Created&nbsp;connection&nbsp;cxn-1&nbsp;to&nbsp;amqp://127.0.0.1:5672/&lt;br&gt;[main]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ConnectionHandler&nbsp;-&nbsp;Created&nbsp;channel-1&nbsp;on&nbsp;cxn-1&lt;br&gt;[main]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ChannelHandler&nbsp;-&nbsp;Created&nbsp;consumer-amq.ctag-vUb0yGdYSY3Cq6eJEARsvA&nbsp;of&nbsp;TEST_UPDATES&nbsp;via&nbsp;channel-1&nbsp;on&nbsp;cxn-1&lt;br&gt;Starting&nbsp;Test&nbsp;Run&lt;br&gt;hello&lt;br&gt;Lets&nbsp;take&nbsp;a&nbsp;rest&lt;br&gt;hello&lt;br&gt;Lets&nbsp;take&nbsp;a&nbsp;rest&lt;br&gt;hello&nbsp;again&nbsp;&lt;br&gt;Lets&nbsp;take&nbsp;a&nbsp;rest&lt;br&gt;This&nbsp;is&nbsp;a&nbsp;new&nbsp;message&nbsp;&lt;br&gt;Lets&nbsp;take&nbsp;a&nbsp;rest&lt;br&gt;[AMQP&nbsp;Connection&nbsp;127.0.0.1:5672]&nbsp;ERROR&nbsp;net.jodah.lyra.internal.ChannelHandler&nbsp;-&nbsp;Channel&nbsp;channel-1&nbsp;on&nbsp;cxn-1&nbsp;was&nbsp;closed&nbsp;unexpectedly&lt;br&gt;Somthing&nbsp;went&nbsp;wrong&nbsp;...connection&nbsp;error;&nbsp;reason:&nbsp;{#method&lt;connection.close&gt;(reply-code=320,&nbsp;reply-text=CONNECTION_FORCED&nbsp;-&nbsp;Closed&nbsp;via&nbsp;management&nbsp;plugin,&nbsp;class-id=0,&nbsp;method-id=0),&nbsp;null,&nbsp;&quot;&quot;}&lt;br&gt;This&nbsp;is&nbsp;a&nbsp;new&nbsp;message&nbsp;&lt;br&gt;Lets&nbsp;take&nbsp;a&nbsp;rest&lt;br&gt;[AMQP&nbsp;Connection&nbsp;127.0.0.1:5672]&nbsp;ERROR&nbsp;net.jodah.lyra.internal.ConnectionHandler&nbsp;-&nbsp;Connection&nbsp;cxn-1&nbsp;was&nbsp;closed&nbsp;unexpectedly&lt;br&gt;[lyra-recovery-1]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ConnectionHandler&nbsp;-&nbsp;Recovering&nbsp;connection&nbsp;cxn-1&nbsp;to&nbsp;[localhost]&lt;br&gt;[lyra-recovery-1]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ConnectionHandler&nbsp;-&nbsp;Recovered&nbsp;connection&nbsp;cxn-1&nbsp;to&nbsp;amqp://127.0.0.1:5672/&lt;br&gt;[lyra-recovery-1]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ConnectionHandler&nbsp;-&nbsp;Recovering&nbsp;queue&nbsp;binding&nbsp;from&nbsp;ORDER_UPDATES&nbsp;to&nbsp;TEST_UPDATES&nbsp;with&nbsp;*.#&nbsp;via&nbsp;cxn-1&lt;br&gt;[lyra-recovery-1]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ChannelHandler&nbsp;-&nbsp;Recovering&nbsp;channel-1&nbsp;on&nbsp;cxn-1&lt;br&gt;[lyra-recovery-1]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ChannelHandler&nbsp;-&nbsp;Recovered&nbsp;channel-1&nbsp;on&nbsp;cxn-1&lt;br&gt;[lyra-recovery-1]&nbsp;INFO&nbsp;net.jodah.lyra.internal.ChannelHandler&nbsp;-&nbsp;Recovering&nbsp;consumer-amq.ctag-vUb0yGdYSY3Cq6eJEARsvA&nbsp;of&nbsp;TEST_UPDATES&nbsp;via&nbsp;channel-1&nbsp;on&nbsp;cxn-1&lt;br&gt;Somthing&nbsp;went&nbsp;wrong&nbsp;...connection&nbsp;error;&nbsp;reason:&nbsp;{#method&lt;connection.close&gt;(reply-code=320,&nbsp;reply-text=CONNECTION_FORCED&nbsp;-&nbsp;Closed&nbsp;via&nbsp;management&nbsp;plugin,&nbsp;class-id=0,&nbsp;method-id=0),&nbsp;null,&nbsp;&quot;&quot;}&lt;br&gt;This&nbsp;is&nbsp;a&nbsp;new&nbsp;message&nbsp;&lt;br&gt;Lets&nbsp;take&nbsp;a&nbsp;rest&lt;br&gt;Somthing&nbsp;went&nbsp;wrong&nbsp;...connection&nbsp;error;&nbsp;reason:&nbsp;{#method&lt;connection.close&gt;(reply-code=320,&nbsp;reply-text=CONNECTION_FORCED&nbsp;-&nbsp;Closed&nbsp;via&nbsp;management&nbsp;plugin,&nbsp;class-id=0,&nbsp;method-id=0),&nbsp;null,&nbsp;&quot;&quot;}&lt;br&gt;This&nbsp;is&nbsp;a&nbsp;new&nbsp;message&nbsp;&lt;br&gt;&lt;br&gt;loop&nbsp;for&nbsp;ever&nbsp;......&nbsp;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;
</tt>
