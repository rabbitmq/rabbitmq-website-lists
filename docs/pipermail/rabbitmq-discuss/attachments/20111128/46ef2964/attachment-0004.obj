# HG changeset patch
# User Iain Hull <Iain.Hull@Workday.com>
# Date 1322478757 0
# Node ID 7779062aa552f4c73cea3fd5f67e18a7db3843ac
# Parent  2b5f03eaaeec2a3fdf4e7cfea6deb64ff7e59140
Fixed a socket leak in ConnectionFactory when server host name is incorrect.

diff -r 2b5f03eaaeec -r 7779062aa552 src/com/rabbitmq/client/ConnectionFactory.java
--- a/src/com/rabbitmq/client/ConnectionFactory.java	Tue Nov 22 11:53:20 2011 +0000
+++ b/src/com/rabbitmq/client/ConnectionFactory.java	Mon Nov 28 11:12:37 2011 +0000
@@ -437,10 +437,16 @@
 
         String hostName = addr.getHost();
         int portNumber = portOrDefault(addr.getPort());
-        Socket socket = factory.createSocket();
-        configureSocket(socket);
-        socket.connect(new InetSocketAddress(hostName, portNumber), connectionTimeout);
-        return createFrameHandler(socket);
+        Socket socket = null;
+        try {
+            socket = factory.createSocket();
+            configureSocket(socket);
+            socket.connect(new InetSocketAddress(hostName, portNumber), connectionTimeout);
+            return createFrameHandler(socket);
+	    } catch (IOException e) {
+            if (socket != null) socket.close();
+            throw e;
+        }
     }
 
     protected FrameHandler createFrameHandler(Socket sock)
