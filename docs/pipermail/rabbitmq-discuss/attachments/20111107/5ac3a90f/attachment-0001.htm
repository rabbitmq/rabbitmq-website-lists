<tt>
I&nbsp;mentioned&nbsp;some&nbsp;performance&nbsp;issues&nbsp;I&nbsp;experienced&nbsp;over&nbsp;the&nbsp;weekend&nbsp;with&nbsp;STOMP&nbsp;on&nbsp;Twitter&nbsp;and&nbsp;@monadic&nbsp;asked&nbsp;me&nbsp;to&nbsp;send&nbsp;an&nbsp;email,&nbsp;so&nbsp;here&nbsp;it&nbsp;is.&lt;br&gt;&lt;br&gt;For&nbsp;a&nbsp;recent&nbsp;internal&nbsp;hackathon&nbsp;project,&nbsp;I&nbsp;hooked&nbsp;some&nbsp;of&nbsp;our&nbsp;logs&nbsp;to&nbsp;RabbitMQ&nbsp;so&nbsp;a&nbsp;team&nbsp;of&nbsp;engineers&nbsp;could&nbsp;process&nbsp;events&nbsp;in&nbsp;real&nbsp;time.&nbsp;Having&nbsp;done&nbsp;this&nbsp;in&nbsp;the&nbsp;past,&nbsp;I&nbsp;wrote&nbsp;a&nbsp;simple&nbsp;perl&nbsp;program&nbsp;to&nbsp;tail&nbsp;the&nbsp;logfile&nbsp;in&nbsp;question&nbsp;and&nbsp;put&nbsp;each&nbsp;message&nbsp;on&nbsp;the&nbsp;queue&nbsp;(e.g.&nbsp;/queue/logs). &nbsp;The&nbsp;messages&nbsp;are&nbsp;about&nbsp;1100&nbsp;bytes&nbsp;on&nbsp;average,&nbsp;including&nbsp;the&nbsp;usual&nbsp;apache&nbsp;style&nbsp;log&nbsp;stuff&nbsp;and&nbsp;a&nbsp;serialized&nbsp;object,&nbsp;mime-encoded. &nbsp;I&nbsp;was&nbsp;capturing&nbsp;logs&nbsp;from&nbsp;8&nbsp;machines&nbsp;that&nbsp;are&nbsp;load&nbsp;balanced,&nbsp;so&nbsp;the&nbsp;rate&nbsp;of&nbsp;messages&nbsp;was&nbsp;pretty&nbsp;even.&lt;br&gt;<br>
<br>
&lt;br&gt;Everything&nbsp;seemed&nbsp;to&nbsp;be&nbsp;working&nbsp;fine&nbsp;when&nbsp;I&nbsp;set&nbsp;it&nbsp;up.&nbsp;Messages&nbsp;were&nbsp;going&nbsp;in&nbsp;and&nbsp;coming&nbsp;out&nbsp;just&nbsp;fine&nbsp;at&nbsp;5000-6000&nbsp;messages/s&nbsp;(both&nbsp;sides&nbsp;stomp).&lt;br&gt;&lt;br&gt;Once&nbsp;the&nbsp;engineer&nbsp;I&nbsp;was&nbsp;helping&nbsp;started&nbsp;running&nbsp;his&nbsp;stuff&nbsp;against&nbsp;RMQ,&nbsp;we&nbsp;started&nbsp;to&nbsp;notice&nbsp;that&nbsp;there&nbsp;was&nbsp;anywhere&nbsp;from&nbsp;30-600&nbsp;seconds&nbsp;of&nbsp;lag&nbsp;between&nbsp;the&nbsp;logs&nbsp;and&nbsp;his&nbsp;client&nbsp;(a&nbsp;dead-simple&nbsp;Ruby&nbsp;app&nbsp;using&nbsp;net-stomp). &nbsp;To&nbsp;make&nbsp;things&nbsp;extra&nbsp;fun,&nbsp;our&nbsp;traffic&nbsp;rose&nbsp;and&nbsp;the&nbsp;message&nbsp;rate&nbsp;rose&nbsp;with&nbsp;up&nbsp;to&nbsp;~14km/s. &nbsp;We&nbsp;instrumented&nbsp;my&nbsp;tailing&nbsp;code&nbsp;and&nbsp;his&nbsp;ruby&nbsp;code&nbsp;and&nbsp;couldn&amp;#39;t&nbsp;find&nbsp;any&nbsp;issue&nbsp;with&nbsp;either.&nbsp;I&nbsp;started&nbsp;watching&nbsp;the&nbsp;RabbitMQ&nbsp;instance,&nbsp;which&nbsp;is&nbsp;running&nbsp;in&nbsp;EC2&nbsp;on&nbsp;a&nbsp;m2.xlarge&nbsp;(in&nbsp;retrospect,&nbsp;not&nbsp;the&nbsp;best&nbsp;instance&nbsp;choice).&nbsp;I&nbsp;could&nbsp;see&nbsp;both&nbsp;vcpus&nbsp;were&nbsp;pretty&nbsp;busy&nbsp;hovering&nbsp;at&nbsp;6-10%&nbsp;idle&nbsp;with&nbsp;12-20%&nbsp;system.&nbsp;I&nbsp;pulled&nbsp;up&nbsp;top&nbsp;with&nbsp;thread&nbsp;view&nbsp;enabled&nbsp;and&nbsp;could&nbsp;see&nbsp;two&nbsp;threads&nbsp;were&nbsp;pegging&nbsp;the&nbsp;CPU. &nbsp;I&nbsp;assumed,&nbsp;but&nbsp;did&nbsp;not&nbsp;verify,&nbsp;that&nbsp;these&nbsp;were&nbsp;running&nbsp;the&nbsp;STOMP&nbsp;code.&nbsp;At&nbsp;the&nbsp;same&nbsp;time&nbsp;all&nbsp;of&nbsp;this&nbsp;was&nbsp;happening,&nbsp;we&nbsp;were&nbsp;watching&nbsp;message&nbsp;rates&nbsp;in&nbsp;the&nbsp;admin&nbsp;webui.&nbsp;When&nbsp;I&nbsp;compared&nbsp;numbers&nbsp;in&nbsp;the&nbsp;UI&nbsp;to&nbsp;what&nbsp;my&nbsp;producers&nbsp;were&nbsp;sending,&nbsp;there&nbsp;was&nbsp;a&nbsp;large&nbsp;mismatch&nbsp;that&nbsp;correlated&nbsp;with&nbsp;the&nbsp;delay&nbsp;we&nbsp;were&nbsp;seeing&nbsp;at&nbsp;the&nbsp;consumers. &nbsp;The&nbsp;memory&nbsp;usage&nbsp;of&nbsp;erlang&nbsp;on&nbsp;the&nbsp;RMQ&nbsp;host&nbsp;was&nbsp;growing&nbsp;well&nbsp;past&nbsp;the&nbsp;40%&nbsp;mark,&nbsp;so&nbsp;we&nbsp;bumped&nbsp;that&nbsp;to&nbsp;75%,&nbsp;which&nbsp;simply&nbsp;allowed&nbsp;more&nbsp;time&nbsp;before&nbsp;it&nbsp;blew&nbsp;up.&lt;br&gt;<br>
<br>
&lt;br&gt;My&nbsp;suspicion&nbsp;is&nbsp;that&nbsp;the&nbsp;STOMP&nbsp;plugin&nbsp;is&nbsp;getting&nbsp;backed&nbsp;up,&nbsp;based&nbsp;on&nbsp;these&nbsp;observations:&lt;br&gt; &nbsp;*&nbsp;memory&nbsp;usage&nbsp;regularly&nbsp;maxed&nbsp;out&nbsp;under&nbsp;load&nbsp;(4,000-14,000&nbsp;messages/second)&lt;br&gt; &nbsp;*&nbsp;the&nbsp;AMQP&nbsp;queue&nbsp;stats&nbsp;did&nbsp;not&nbsp;match&nbsp;what&nbsp;the&nbsp;producers&nbsp;sent&lt;br&gt;<br>
<br>
 &nbsp;*&nbsp;the&nbsp;amount&nbsp;of&nbsp;memory&nbsp;consumed&nbsp;was&nbsp;way&nbsp;out&nbsp;of&nbsp;order&nbsp;from&nbsp;what&nbsp;the&nbsp;AMQP&nbsp;queue&nbsp;depths&nbsp;were&nbsp;(usually&nbsp;close&nbsp;to&nbsp;0!)&lt;br&gt; &nbsp;*&nbsp;we&nbsp;were&nbsp;definitely&nbsp;consuming&nbsp;fast&nbsp;enough&nbsp;with&nbsp;3-8&nbsp;consumer&nbsp;processes&nbsp;on&nbsp;dedicated&nbsp;machines&nbsp;(4x&nbsp;m2.xlarge)&lt;br&gt;<br>
    &nbsp;*&nbsp;these&nbsp;machines/processes&nbsp;were&nbsp;showing&nbsp;no&nbsp;stress&lt;br&gt; &nbsp;*&nbsp;after&nbsp;shutting&nbsp;down&nbsp;producers,&nbsp;it&nbsp;appeared&nbsp;as&nbsp;if&nbsp;they&nbsp;were&nbsp;producing&nbsp;for&nbsp;up&nbsp;to&nbsp;10&nbsp;minutes&nbsp;after&nbsp;shutdown&lt;br&gt;&lt;br&gt;While&nbsp;under&nbsp;the&nbsp;gun,&nbsp;we&nbsp;tried&nbsp;a&nbsp;few&nbsp;quick&nbsp;&amp;amp;&nbsp;dirty&nbsp;hacks:&lt;br&gt;<br>
&lt;br&gt; &nbsp;*&nbsp;dropped&nbsp;every&nbsp;other&nbsp;log&nbsp;line&nbsp;in&nbsp;the&nbsp;producer&nbsp;to&nbsp;cut&nbsp;msg/s&nbsp;in&nbsp;half&lt;br&gt;   &nbsp;*&nbsp;slowed&nbsp;performance&nbsp;decay&nbsp;but&nbsp;did&nbsp;not&nbsp;fix&nbsp;anything&lt;br&gt; &nbsp;*&nbsp;restarted&nbsp;the&nbsp;producer&nbsp;regularly&nbsp;to&nbsp;cycle&nbsp;connections&lt;br&gt;   &nbsp;*&nbsp;made&nbsp;things&nbsp;worse&nbsp;-&nbsp;we&nbsp;could&nbsp;observe&nbsp;many&nbsp;draining&nbsp;producer&nbsp;channels&nbsp;in&nbsp;the&nbsp;admin&nbsp;UI&nbsp;that&nbsp;hung&nbsp;around&nbsp;for&nbsp;more&nbsp;than&nbsp;10&nbsp;minutes&lt;br&gt;<br>
 &nbsp; &nbsp;  &nbsp;*&nbsp;after&nbsp;a&nbsp;while&nbsp;we&nbsp;bounced&nbsp;rabbitmq&nbsp;so&nbsp;we&nbsp;could&nbsp;move&nbsp;on&lt;br&gt;   &nbsp;*&nbsp;thrashing&nbsp;seemed&nbsp;to&nbsp;make&nbsp;the&nbsp;existing&nbsp;producer&nbsp;channels&nbsp;drain&nbsp;even&nbsp;slower&lt;br&gt; &nbsp;*&nbsp;start&nbsp;more&nbsp;consumers&nbsp;-&nbsp;no&nbsp;change&lt;br&gt; &nbsp;*&nbsp;shut&nbsp;down&nbsp;producers&lt;br&gt;   &nbsp;*&nbsp;only&nbsp;when&nbsp;I&nbsp;took&nbsp;it&nbsp;down&nbsp;to&nbsp;1&nbsp;producer&nbsp;did&nbsp;memory&nbsp;usage&nbsp;stop&nbsp;climbing,&nbsp;so&nbsp;~1200&nbsp;messages/s&nbsp;is&nbsp;the&nbsp;observed&nbsp;limit&lt;br&gt;<br>
&lt;br&gt;Things&nbsp;I&amp;#39;d&nbsp;try&nbsp;if&nbsp;this&nbsp;project&nbsp;was&nbsp;still&nbsp;running,&nbsp;but&nbsp;have&nbsp;not:&lt;br&gt;&lt;br&gt; &nbsp;*&nbsp;upgrade&nbsp;to&nbsp;Erlang&nbsp;R14&lt;br&gt; &nbsp;*&nbsp;switch&nbsp;to&nbsp;AMQP&nbsp;producers&lt;br&gt; &nbsp;*&nbsp;more/faster&nbsp;CPU&nbsp;instances&lt;br&gt;&lt;br&gt;In&nbsp;any&nbsp;case,&nbsp;the&nbsp;experiment&nbsp;driving&nbsp;all&nbsp;of&nbsp;this&nbsp;is&nbsp;concluded&nbsp;for&nbsp;now.&nbsp;I&nbsp;can&nbsp;still&nbsp;fire&nbsp;up&nbsp;the&nbsp;producers&nbsp;and&nbsp;dummy&nbsp;consumers&nbsp;for&nbsp;quick&nbsp;tests&nbsp;but&nbsp;don&amp;#39;t&nbsp;have&nbsp;a&nbsp;lot&nbsp;of&nbsp;time&nbsp;to&nbsp;dedicate&nbsp;to&nbsp;debugging&nbsp;this. &nbsp;For&nbsp;what&nbsp;it&amp;#39;s&nbsp;worth,&nbsp;the&nbsp;hackathon&nbsp;project&nbsp;was&nbsp;super&nbsp;cool&nbsp;and&nbsp;successful;&nbsp;I&nbsp;just&nbsp;had&nbsp;to&nbsp;babysit&nbsp;the&nbsp;queue&nbsp;and&nbsp;fire&nbsp;up&nbsp;producers&nbsp;just&nbsp;before&nbsp;the&nbsp;demo&nbsp;started&nbsp;so&nbsp;delay&nbsp;would&nbsp;be&nbsp;acceptable&nbsp;;)&lt;br&gt;<br>
&lt;br&gt;-Al&lt;br&gt;<br>

</tt>
