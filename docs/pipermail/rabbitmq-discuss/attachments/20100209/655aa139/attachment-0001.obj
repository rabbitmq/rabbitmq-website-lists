<?php
// declare Exchange
// publishing
$msg = "my news in the Spb...";

echo "Connecting...\n";
$cnn = new AMQPConnection(array('port' => 5672, 'login' => 'login', 'password' => 'password'));

// Create the exchange
echo "Creating exchange...\n";
$exchange = new AMQPExchange($cnn);
$exchange->declare('rabbit', 'topic', AMQP_DURABLE);


//Queue declare
echo "Declaring persistent queue...\n";
$queue = new AMQPQueue($cnn, 'rabbit_q');
$queue->declare('rabbit_q', AMQP_DURABLE);
$queue->bind('rabbit', 'v1.dev.php.rabbit.*');

// publish
echo "Publishing...\n";
$res = $exchange->publish($msg, 'v1.dev.php.rabbit.test');

// consume
echo "Consuming...\n";
$i = 0;
$queueMessages = $queue->consume( 1 );
foreach($queueMessages as $item){
    $i++;
    echo "$i.$item";
}