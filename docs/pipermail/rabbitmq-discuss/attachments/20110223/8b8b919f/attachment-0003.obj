'''
Created on Feb 23, 2011

@author: yglazner
'''
import sys
import pika


# Open the channel
channel = None

def on_open(connection):
    connection.channel(on_new_channel)
    
def on_new_channel(new_channel):
    global channel
    channel = new_channel
    channel.queue_declare(callback=on_test_declared,
                          queue="test", durable=True,
                  exclusive=False, auto_delete=False)

def on_test_declared(frame):
    channel.basic_consume(handle_delivery, queue='test')

def handle_delivery(ch, method, properties, body):
    print method, properties
    print " [x] Received %r" % (body,)
    ch.basic_ack(delivery_tag=method.delivery_tag)



parameters = pika.ConnectionParameters('localhost', heartbeat=10)
connection = pika.SelectConnection(parameters, on_open)
connection.ioloop.start()
