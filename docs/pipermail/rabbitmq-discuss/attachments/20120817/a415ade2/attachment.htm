<tt>
Thanks&nbsp;for&nbsp;the&nbsp;background&nbsp;Gavin.&nbsp;It&amp;#39;s&nbsp;glad&nbsp;to&nbsp;get&nbsp;confirmation&nbsp;that&nbsp;I&nbsp;was&nbsp;on&nbsp;the&nbsp;right&nbsp;track&nbsp;with&nbsp;my&nbsp;understanding.&lt;br&gt;&lt;br&gt;A&nbsp;few&nbsp;thoughts:&lt;br&gt;&lt;br&gt;It&nbsp;might&nbsp;be&nbsp;worth&nbsp;adding&nbsp;some&nbsp;sort&nbsp;of&nbsp;warning&nbsp;output&nbsp;if&nbsp;there&amp;#39;s&nbsp;a&nbsp;synchronous&nbsp;command&nbsp;in&nbsp;the&nbsp;output&nbsp;buffer&nbsp;and&nbsp;then&nbsp;another&nbsp;&amp;quot;method&amp;quot;&nbsp;(e.g.,&nbsp;Basic.Publish)&nbsp;get&amp;#39;s&nbsp;added.&lt;br&gt;<br>
&lt;br&gt;It&nbsp;would&nbsp;be&nbsp;nice&nbsp;to&nbsp;have&nbsp;some&nbsp;mechanism&nbsp;of&nbsp;saying&nbsp;&amp;quot;Go&nbsp;send&nbsp;whatever&nbsp;output&nbsp;data&nbsp;you&nbsp;have,&nbsp;right&nbsp;now&amp;quot;,&nbsp;then&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;arrive&nbsp;back&nbsp;from&nbsp;the&nbsp;server.&nbsp;The&nbsp;incoming&nbsp;data&nbsp;wouldn&amp;#39;t&nbsp;have&nbsp;to&nbsp;be&nbsp;processed&nbsp;before&nbsp;returning,&nbsp;but&nbsp;you&amp;#39;d&nbsp;at&nbsp;least&nbsp;know&nbsp;that&nbsp;you&nbsp;could&nbsp;safely&nbsp;send&nbsp;more&nbsp;methods&nbsp;without&nbsp;breaking&nbsp;AMQP&nbsp;rules.&lt;br&gt;<br>
&lt;br&gt;My&nbsp;thinking&nbsp;is&nbsp;that&nbsp;after&nbsp;calling&nbsp;tx_commit()&nbsp;in&nbsp;my&nbsp;message&nbsp;handler,&nbsp;I&nbsp;could&nbsp;call&nbsp;this&nbsp;method.&lt;br&gt;&lt;br&gt;Lastly,&nbsp;it&nbsp;would&nbsp;be&nbsp;really&nbsp;helpful&nbsp;to&nbsp;update&nbsp;the&nbsp;Pika&nbsp;doc&nbsp;to&nbsp;reflect&nbsp;what&nbsp;you&nbsp;said&nbsp;in&nbsp;your&nbsp;reply.&nbsp;In&nbsp;particular,&nbsp;this&nbsp;except&nbsp;from&nbsp;the&nbsp;Channel.tx_commit()&nbsp;description&nbsp;appears&nbsp;incorrect,&nbsp;or&nbsp;at&nbsp;least&nbsp;confusing:&lt;br&gt;<br>
&lt;br&gt;&lt;i&gt;&lt;b&gt;This&nbsp;is&nbsp;a&nbsp;synchronous&nbsp;method&nbsp;that&nbsp;will&nbsp;not&nbsp;allow&nbsp;other&nbsp;commands&nbsp;to&nbsp;be<br>
send&nbsp;to&nbsp;the&nbsp;AMQP&nbsp;broker&nbsp;until&nbsp;it&nbsp;has&nbsp;completed.&lt;/b&gt;&lt;/i&gt;&lt;br&gt;&lt;br&gt;Thanks&nbsp;again,&lt;br&gt;&lt;br&gt;Matt&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Aug&nbsp;17,&nbsp;2012&nbsp;at&nbsp;12:38&nbsp;PM,&nbsp;Gavin&nbsp;M.&nbsp;Roy&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:gmr@meetme.com&quot;&nbsp;target=&quot;_blank&quot;&gt;gmr@meetme.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;Fri,&nbsp;Aug&nbsp;17,&nbsp;2012&nbsp;at&nbsp;3:13&nbsp;PM,&nbsp;Matt&nbsp;Pietrek&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:mpietrek@skytap.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mpietrek@skytap.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
I&amp;#39;ve&nbsp;been&nbsp;drilling&nbsp;into&nbsp;an&nbsp;issue&nbsp;for&nbsp;a&nbsp;few&nbsp;days&nbsp;where&nbsp;my&nbsp;Pika&nbsp;channel&nbsp;is&nbsp;abruptly&nbsp;closed.&nbsp;I&amp;#39;m&nbsp;pretty&nbsp;sure&nbsp;I&amp;#39;ve&nbsp;found&nbsp;either:&lt;br&gt;&lt;ul&gt;&lt;li&gt;A&nbsp;large&nbsp;gap&nbsp;in&nbsp;my&nbsp;understanding&lt;/li&gt;&lt;li&gt;A&nbsp;misuse&nbsp;of&nbsp;the&nbsp;Rabbit/Pika&nbsp;APIs&lt;/li&gt;<br>
<br>
<br>
&lt;/ul&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;Depending&nbsp;on&nbsp;your&nbsp;perspective,&nbsp;this&nbsp;seems&nbsp;the&nbsp;most&nbsp;likely,&nbsp;in&nbsp;that&nbsp;there&nbsp;is&nbsp;not&nbsp;any&nbsp;logic&nbsp;in&nbsp;Pika&nbsp;for&nbsp;managing&nbsp;Tx.&nbsp;It&nbsp;lets&nbsp;you&nbsp;send&nbsp;the&nbsp;RPC&nbsp;calls&nbsp;and&nbsp;leaves&nbsp;it&nbsp;to&nbsp;you&nbsp;to&nbsp;manage&nbsp;state&nbsp;outside&nbsp;of&nbsp;the&nbsp;connection/channel. &lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;ul&gt;<br>
&lt;li&gt;A&nbsp;serious&nbsp;bug&nbsp;in&nbsp;Pika.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;My&nbsp;original&nbsp;understanding&nbsp;about&nbsp;transactions&nbsp;is&nbsp;that&nbsp;calling&nbsp;tx_select()&nbsp;is&nbsp;a&nbsp;synchronous&nbsp;operation,&nbsp;and&nbsp;that&nbsp;when&nbsp;it&nbsp;returns,&nbsp;whatever&nbsp;actions&nbsp;you&amp;#39;ve&nbsp;sent&nbsp;to&nbsp;the&nbsp;broker&nbsp;are&nbsp;committed.&lt;/p&gt;<br>
<br>
<br>
<br>
&lt;p&gt;However,&nbsp;in&nbsp;stepping&nbsp;through&nbsp;the&nbsp;Pika&nbsp;tx_commit()&nbsp;code,&nbsp;it&nbsp;seems&nbsp;like&nbsp;it&nbsp;all&nbsp;it&nbsp;does&nbsp;is&nbsp;add&nbsp;the&nbsp;Tx.Commit&nbsp;message&nbsp;to&nbsp;an&nbsp;outgoing&nbsp;buffer,&nbsp;and&nbsp;that&nbsp;the&nbsp;tx_commit()&nbsp;call&nbsp;returns&nbsp;without&nbsp;anything&nbsp;actually&nbsp;sent&nbsp;to&nbsp;the&nbsp;broker.&nbsp;(I&amp;#39;ve&nbsp;set&nbsp;breakpoints&nbsp;in&nbsp;the&nbsp;debugger&nbsp;at&nbsp;strategic&nbsp;points&nbsp;to&nbsp;verify&nbsp;this.)&lt;/p&gt;<br>
<br>
<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;correct,&nbsp;because&nbsp;pika&nbsp;is&nbsp;event-loop&nbsp;driven,&nbsp;it&nbsp;is&nbsp;putting&nbsp;the&nbsp;frame&nbsp;in&nbsp;the&nbsp;output&nbsp;buffer&nbsp;and&nbsp;returning&nbsp;to&nbsp;you.&nbsp;The&nbsp;event&nbsp;loop&nbsp;will&nbsp;write&nbsp;the&nbsp;data&nbsp;out&nbsp;as&nbsp;the&nbsp;operating&nbsp;system&nbsp;tells&nbsp;it&nbsp;it&nbsp;can&nbsp;You&nbsp;are&nbsp;correct&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;blocking&nbsp;on&nbsp;the&nbsp;Tx.Commit&nbsp;until&nbsp;the&nbsp;data&nbsp;is&nbsp;written&nbsp;over&nbsp;the&nbsp;socket.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;p&gt;In&nbsp;my&nbsp;message&nbsp;handler,&nbsp;I&amp;#39;m&nbsp;writing&nbsp;a&nbsp;reply&nbsp;to&nbsp;the&nbsp;incoming&nbsp;message,&nbsp;using&nbsp;the&nbsp;same&nbsp;channel.&nbsp;What&nbsp;I&amp;#39;m&nbsp;seeing&nbsp;(verified&nbsp;via&nbsp;WireShark)&nbsp;is&nbsp;that&nbsp;the&nbsp;Tx.Commit&nbsp;message&nbsp;is&nbsp;followed&nbsp;by&nbsp;some&nbsp;number&nbsp;of&nbsp;Basic.Publish,&nbsp;Content-Header,&nbsp;and&nbsp;Content-Body&nbsp;records&nbsp;corresponding&nbsp;to&nbsp;my&nbsp;reply&nbsp;message&nbsp;writes.&lt;/p&gt;<br>
<br>
<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;Your&nbsp;frames&nbsp;are&nbsp;sent&nbsp;in&nbsp;the&nbsp;order&nbsp;the&nbsp;methods&nbsp;are&nbsp;called. &lt;/div&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;p&gt;&nbsp;This&nbsp;violates&nbsp;the&nbsp;AMQP&nbsp;standard,&nbsp;which&nbsp;says&nbsp;that&nbsp;nothing&nbsp;should&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;broker&nbsp;after&nbsp;sending&nbsp;a&nbsp;Tx.Commit&nbsp;and&nbsp;before&nbsp;receiving&nbsp;a&nbsp;Tx.Commit-Ok&nbsp;reply.&nbsp;(If&nbsp;it&nbsp;helps&nbsp;understanding,&nbsp;my&nbsp;incoming&nbsp;message&nbsp;queue&nbsp;has&nbsp;a&nbsp;few&nbsp;messages&nbsp;in&nbsp;it&nbsp;already,&nbsp;so&nbsp;I&nbsp;see&nbsp;a&nbsp;series&nbsp;of&nbsp;incoming&nbsp;messages&nbsp;immediately&nbsp;after&nbsp;starting.)&lt;br&gt;<br>
<br>
<br>
&lt;/p&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;You&nbsp;should&nbsp;add&nbsp;a&nbsp;callback&nbsp;for&nbsp;the&nbsp;Tx.Commit-Ok&nbsp;reply&nbsp;and&nbsp;then&nbsp;send&nbsp;your&nbsp;messages.&nbsp;You&nbsp;are&nbsp;correct&nbsp;that&nbsp;Pika&nbsp;is&nbsp;not&nbsp;enforcing&nbsp;the&nbsp;behavior&nbsp;of&nbsp;blocking&nbsp;until&nbsp;Tx.Commit-Ok.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
You&nbsp;could&nbsp;open&nbsp;a&nbsp;2nd&nbsp;channel&nbsp;and&nbsp;send&nbsp;your&nbsp;replies&nbsp;over&nbsp;that. &lt;/div&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;p&gt;<br>
&lt;/p&gt;&lt;p&gt;I&nbsp;see&nbsp;that&nbsp;the&nbsp;tx_commit()&nbsp;method&nbsp;takes&nbsp;a&nbsp;callback&nbsp;method,&nbsp;but&nbsp;if&nbsp;I&nbsp;were&nbsp;to&nbsp;simply&nbsp;block&nbsp;in&nbsp;my&nbsp;message&nbsp;handler,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;callback&nbsp;to&nbsp;be&nbsp;invoked,&nbsp;I&amp;#39;d&nbsp;deadlock&nbsp;because&nbsp;Pika&amp;#39;s&nbsp;buffer&nbsp;processing&nbsp;code&nbsp;doesn&amp;#39;t&nbsp;get&nbsp;a&nbsp;chance&nbsp;to&nbsp;run.&lt;br&gt;<br>
<br>
<br>
&lt;/p&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;How&nbsp;are&nbsp;you&nbsp;blocking?&nbsp;If&nbsp;you&amp;#39;re&nbsp;using&nbsp;any&nbsp;truly&nbsp;blocking&nbsp;method,&nbsp;it&nbsp;will&nbsp;stop&nbsp;the&nbsp;event&nbsp;loop&nbsp;from&nbsp;running.&nbsp;Since&nbsp;you&amp;#39;re&nbsp;on&nbsp;the&nbsp;async&nbsp;loop,&nbsp;I&amp;#39;d&nbsp;use&nbsp;a&nbsp;timer&nbsp;and&nbsp;a&nbsp;state&nbsp;variable&nbsp;to&nbsp;toggle&nbsp;between&nbsp;the&nbsp;various&nbsp;states&nbsp;you&amp;#39;re&nbsp;trying&nbsp;to&nbsp;achieve.&lt;/div&gt;<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Gavin&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
