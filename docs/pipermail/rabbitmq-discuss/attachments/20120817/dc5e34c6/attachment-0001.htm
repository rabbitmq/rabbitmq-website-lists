<tt>
I&amp;#39;ve&nbsp;been&nbsp;drilling&nbsp;into&nbsp;an&nbsp;issue&nbsp;for&nbsp;a&nbsp;few&nbsp;days&nbsp;where&nbsp;my&nbsp;Pika&nbsp;channel&nbsp;is&nbsp;abruptly&nbsp;closed.&nbsp;I&amp;#39;m&nbsp;pretty&nbsp;sure&nbsp;I&amp;#39;ve&nbsp;found&nbsp;either:&lt;br&gt;&lt;ul&gt;&lt;li&gt;A&nbsp;large&nbsp;gap&nbsp;in&nbsp;my&nbsp;understanding&lt;/li&gt;&lt;li&gt;A&nbsp;misuse&nbsp;of&nbsp;the&nbsp;Rabbit/Pika&nbsp;APIs&lt;/li&gt;<br>
&lt;li&gt;A&nbsp;serious&nbsp;bug&nbsp;in&nbsp;Pika.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;My&nbsp;original&nbsp;understanding&nbsp;about&nbsp;transactions&nbsp;is&nbsp;that&nbsp;calling&nbsp;tx_select()&nbsp;is&nbsp;a&nbsp;synchronous&nbsp;operation,&nbsp;and&nbsp;that&nbsp;when&nbsp;it&nbsp;returns,&nbsp;whatever&nbsp;actions&nbsp;you&amp;#39;ve&nbsp;sent&nbsp;to&nbsp;the&nbsp;broker&nbsp;are&nbsp;committed.&lt;/p&gt;<br>
&lt;p&gt;However,&nbsp;in&nbsp;stepping&nbsp;through&nbsp;the&nbsp;Pika&nbsp;tx_commit()&nbsp;code,&nbsp;it&nbsp;seems&nbsp;like&nbsp;it&nbsp;all&nbsp;it&nbsp;does&nbsp;is&nbsp;add&nbsp;the&nbsp;Tx.Commit&nbsp;message&nbsp;to&nbsp;an&nbsp;outgoing&nbsp;buffer,&nbsp;and&nbsp;that&nbsp;the&nbsp;tx_commit()&nbsp;call&nbsp;returns&nbsp;without&nbsp;anything&nbsp;actually&nbsp;sent&nbsp;to&nbsp;the&nbsp;broker.&nbsp;(I&amp;#39;ve&nbsp;set&nbsp;breakpoints&nbsp;in&nbsp;the&nbsp;debugger&nbsp;at&nbsp;strategic&nbsp;points&nbsp;to&nbsp;verify&nbsp;this.)&lt;/p&gt;<br>
&lt;p&gt;In&nbsp;my&nbsp;message&nbsp;handler,&nbsp;I&amp;#39;m&nbsp;writing&nbsp;a&nbsp;reply&nbsp;to&nbsp;the&nbsp;incoming&nbsp;message,&nbsp;using&nbsp;the&nbsp;same&nbsp;channel.&nbsp;What&nbsp;I&amp;#39;m&nbsp;seeing&nbsp;(verified&nbsp;via&nbsp;WireShark)&nbsp;is&nbsp;that&nbsp;the&nbsp;Tx.Commit&nbsp;message&nbsp;is&nbsp;followed&nbsp;by&nbsp;some&nbsp;number&nbsp;of&nbsp;Basic.Publish,&nbsp;Content-Header,&nbsp;and&nbsp;Content-Body&nbsp;records&nbsp;corresponding&nbsp;to&nbsp;my&nbsp;reply&nbsp;message&nbsp;writes.&nbsp;This&nbsp;violates&nbsp;the&nbsp;AMQP&nbsp;standard,&nbsp;which&nbsp;says&nbsp;that&nbsp;nothing&nbsp;should&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;broker&nbsp;after&nbsp;sending&nbsp;a&nbsp;Tx.Commit&nbsp;and&nbsp;before&nbsp;receiving&nbsp;a&nbsp;Tx.Commit-Ok&nbsp;reply.&nbsp;(If&nbsp;it&nbsp;helps&nbsp;understanding,&nbsp;my&nbsp;incoming&nbsp;message&nbsp;queue&nbsp;has&nbsp;a&nbsp;few&nbsp;messages&nbsp;in&nbsp;it&nbsp;already,&nbsp;so&nbsp;I&nbsp;see&nbsp;a&nbsp;series&nbsp;of&nbsp;incoming&nbsp;messages&nbsp;immediately&nbsp;after&nbsp;starting.)&lt;br&gt;<br>
&lt;/p&gt;&lt;p&gt;I&nbsp;see&nbsp;that&nbsp;the&nbsp;tx_commit()&nbsp;method&nbsp;takes&nbsp;a&nbsp;callback&nbsp;method,&nbsp;but&nbsp;if&nbsp;I&nbsp;were&nbsp;to&nbsp;simply&nbsp;block&nbsp;in&nbsp;my&nbsp;message&nbsp;handler,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;callback&nbsp;to&nbsp;be&nbsp;invoked,&nbsp;I&amp;#39;d&nbsp;deadlock&nbsp;because&nbsp;Pika&amp;#39;s&nbsp;buffer&nbsp;processing&nbsp;code&nbsp;doesn&amp;#39;t&nbsp;get&nbsp;a&nbsp;chance&nbsp;to&nbsp;run.&lt;br&gt;<br>
&lt;/p&gt;So&nbsp;given&nbsp;the&nbsp;above,&nbsp;is&nbsp;it&nbsp;me?&nbsp;Is&nbsp;it&nbsp;Pika?&lt;br&gt;&lt;br&gt;My&nbsp;code&nbsp;looks&nbsp;like&nbsp;this:&lt;br&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;def&nbsp;echo_on_connected(connection):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;&amp;quot;&amp;quot;&amp;quot;Called&nbsp;when&nbsp;we&nbsp;are&nbsp;fully&nbsp;connected&nbsp;to&nbsp;RabbitMQ&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;#&nbsp;Open&nbsp;a&nbsp;channel&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;connection.channel(echo_on_channel_open)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;#&nbsp;Step&nbsp;#3&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;def&nbsp;echo_on_channel_open(channel):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;channel.queue_declare(queue=echo_queue_name,&nbsp;durable=True,&nbsp;arguments={&amp;quot;x-ha-policy&amp;quot;:&nbsp;&amp;quot;all&amp;quot;})&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;channel.tx_select()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;channel.basic_consume(echo_handle_delivery,&nbsp;queue=echo_queue_name)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;def&nbsp;echo_handle_delivery(channel,&nbsp;method,&nbsp;header,&nbsp;body):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;print&nbsp;&amp;quot;Received&nbsp;message&nbsp;%s&amp;quot;&nbsp;%&nbsp;(body)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;#&nbsp;Write&nbsp;a&nbsp;reply&nbsp;message&nbsp;on&nbsp;the&nbsp;same&nbsp;channel&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;channel.basic_publish(exchange=&amp;#39;&amp;#39;,&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;routing_key=&amp;#39;reply_queue&amp;#39;,&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;body=&amp;quot;replying&nbsp;to&nbsp;%s&amp;quot;&nbsp;%&nbsp;(body),&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;properties=BasicProperties(delivery_mode=2))&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;#&nbsp;Ack&nbsp;the&nbsp;incoming&nbsp;message,&nbsp;then&nbsp;force&nbsp;the&nbsp;write&nbsp;to&nbsp;be&nbsp;flushed.&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;channel.basic_ack(delivery_tag=method.delivery_tag)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;channel.tx_commit()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;def&nbsp;echo_thread():&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;connection_parameters&nbsp;=&nbsp;ConnectionParameters(host=broker_host)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;echo_connection&nbsp;=&nbsp;SelectConnection(connection_parameters,&nbsp;echo_on_connected)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;echo_connection.ioloop.start()&lt;/span&gt;&lt;br&gt;<br>

</tt>
