<tt>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Sep&nbsp;24,&nbsp;2009&nbsp;at&nbsp;4:57&nbsp;AM,&nbsp;Matthias&nbsp;Radestock&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthias@lshift.net&quot;&gt;matthias@lshift.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
Gavin,&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;/div&gt;Next&nbsp;time&nbsp;this&nbsp;happens&nbsp;I&nbsp;suggest&nbsp;you&nbsp;gather&nbsp;some&nbsp;diagnostics&nbsp;with&lt;br&gt;<br>
&nbsp; rabbitmqctl&nbsp;list_queues&nbsp;name&nbsp;messages_ready&nbsp;messages_unacknowledged&lt;br&gt;<br>
consumers&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;made&nbsp;sure&nbsp;there&nbsp;were&nbsp;no&nbsp;messages&nbsp;in&nbsp;the&nbsp;stack,&nbsp;but&nbsp;since&nbsp;it&amp;#39;s&nbsp;still&nbsp;hanging&nbsp;out&nbsp;with&nbsp;the&nbsp;memory&nbsp;allocated:&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;&lt;div&gt;[root@mq07&nbsp;~]#&nbsp;/opt/rabbitmq/sbin/rabbitmqctl&nbsp;list_queues&nbsp;name&nbsp;messages_ready&nbsp;messages_unacknowledged&lt;/div&gt;<br>
<br>
&lt;div&gt;Listing&nbsp;queues&nbsp;...&lt;/div&gt;&lt;div&gt;Notification&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;0&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;0&lt;/div&gt;&lt;div&gt;...done.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
If&nbsp;the&nbsp;consumer&nbsp;count&nbsp;is&nbsp;0&nbsp;then&nbsp;there&nbsp;are&nbsp;no&nbsp;consumers.&nbsp;If&nbsp;you&nbsp;have&nbsp;a&lt;br&gt;<br>
consumer&nbsp;count&nbsp;above&nbsp;0&nbsp;and&nbsp;a&nbsp;messages_ready&nbsp;count&nbsp;above&nbsp;0,&nbsp;and&nbsp;the&lt;br&gt;<br>
broker&nbsp;appears&nbsp;to&nbsp;be&nbsp;idle,&nbsp;then&nbsp;that&nbsp;is&nbsp;a&nbsp;good&nbsp;indication&nbsp;that&nbsp;the&lt;br&gt;<br>
consumers&nbsp;are&nbsp;there&nbsp;but&nbsp;stuck&nbsp;and&nbsp;the&nbsp;tcp&nbsp;connection&nbsp;to&nbsp;them&nbsp;is&nbsp;backlogged.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yeah&nbsp;I&nbsp;pulled&nbsp;off&nbsp;the&nbsp;consumers&nbsp;when&nbsp;it&nbsp;was&nbsp;done&nbsp;to&nbsp;see&nbsp;if&nbsp;that&nbsp;was&nbsp;why&nbsp;the&nbsp;memory&nbsp;wasn&amp;#39;t&nbsp;given&nbsp;back.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;lsof&nbsp;and&nbsp;netstat&nbsp;do&nbsp;not&nbsp;indicate&nbsp;any&nbsp;open&nbsp;sockets&nbsp;(in&nbsp;any&nbsp;state)&nbsp;to&nbsp;Rabbit&nbsp;from&nbsp;the&nbsp;consumer&nbsp;box.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;It&nbsp;is&nbsp;quite&nbsp;common&nbsp;for&nbsp;a&nbsp;gc&amp;#39;ed&nbsp;VM&nbsp;to&nbsp;hold&nbsp;on&nbsp;to&nbsp;large&nbsp;chunks&nbsp;of&nbsp;memory&lt;/div&gt;<br>
instead&nbsp;of&nbsp;handing&nbsp;them&nbsp;back&nbsp;to&nbsp;the&nbsp;OS.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;it&nbsp;safe&nbsp;to&nbsp;assume&nbsp;the&nbsp;VM&nbsp;will&nbsp;make&nbsp;use&nbsp;of&nbsp;what&nbsp;it&amp;#39;s&nbsp;holding&nbsp;on&nbsp;to&nbsp;and&nbsp;it&amp;#39;s&nbsp;not&nbsp;a&nbsp;leak&nbsp;of&nbsp;some&nbsp;sort?&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
Are&nbsp;you&nbsp;monitoring&nbsp;queues&nbsp;with&nbsp;rabbitmqctl&nbsp;or&nbsp;Alice?&nbsp;If&nbsp;that&nbsp;happens&lt;br&gt;<br>
more&nbsp;frequently&nbsp;than&nbsp;once&nbsp;per&nbsp;second&nbsp;then&nbsp;the&nbsp;queue&nbsp;processes&nbsp;are&nbsp;kept&lt;br&gt;<br>
active,&nbsp;which&nbsp;delays&nbsp;the&nbsp;freeing&nbsp;up&nbsp;of&nbsp;memory.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Primarily&nbsp;Alice,&nbsp;and&nbsp;the&nbsp;monitor&nbsp;interval&nbsp;I&nbsp;am&nbsp;using&nbsp;is&nbsp;~10&nbsp;seconds.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
To&nbsp;get&nbsp;some&nbsp;diagnostics&nbsp;on&nbsp;where&nbsp;the&nbsp;memory&nbsp;has&nbsp;gone,&nbsp;shell&nbsp;into&nbsp;rabbit&lt;br&gt;<br>
(erl&nbsp;-sname&nbsp;shell&nbsp;-remsh&nbsp;rabbit@&amp;lt;hostname&amp;gt;)&nbsp;and&nbsp;run&lt;br&gt;<br>
&nbsp; memory().&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[root@mq07&nbsp;~]#&nbsp;erl&nbsp;-sname&nbsp;shell&nbsp;-remsh&nbsp;rabbit@mq07&lt;/div&gt;&lt;div&gt;Erlang&nbsp;R13B&nbsp;(erts-5.7.1)&nbsp;[source]&nbsp;[64-bit]&nbsp;[smp:8:8]&nbsp;[rq:8]&nbsp;[async-threads:0]&nbsp;[hipe]&nbsp;[kernel-poll:false]&lt;/div&gt;&lt;div&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Eshell&nbsp;V5.7.1&nbsp; (abort&nbsp;with&nbsp;^G)&lt;/div&gt;&lt;div&gt;(rabbit@mq07)1&amp;gt;&nbsp;memory().&lt;/div&gt;&lt;div&gt;[{total,354514080},&lt;/div&gt;&lt;div&gt; {processes,23750072},&lt;/div&gt;&lt;div&gt; {processes_used,22779304},&lt;/div&gt;&lt;div&gt; {system,330764008},&lt;/div&gt;<br>
<br>
&lt;div&gt; {atom,775705},&lt;/div&gt;&lt;div&gt; {atom_used,748674},&lt;/div&gt;&lt;div&gt; {binary,22063432},&lt;/div&gt;&lt;div&gt; {code,7638629},&lt;/div&gt;&lt;div&gt; {ets,5241416}]&lt;/div&gt;&lt;div&gt;(rabbit@mq07)2&amp;gt;  &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
<br>
Gavin&lt;/div&gt;&lt;/div&gt;<br>

</tt>
