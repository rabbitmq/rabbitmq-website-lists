<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;Michael,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;your&nbsp;fast&nbsp;reply.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;be&nbsp;honest,&nbsp;I&nbsp;don&#39;t&nbsp;mind&nbsp;that&nbsp;when&nbsp;a&nbsp;node&nbsp;goes&nbsp;down&nbsp;in&nbsp;a&nbsp;RabbitMQ&nbsp;cluster&nbsp;it&nbsp;takes&nbsp;a&nbsp;minute&nbsp;or&nbsp;more&nbsp;to&nbsp;decide&nbsp;that&nbsp;the&nbsp;cluster&nbsp;is&nbsp;broken&nbsp;and&nbsp;what&nbsp;to&nbsp;do.&nbsp;What&nbsp;I&nbsp;don&#39;t&nbsp;fully&nbsp;understand&nbsp;is&nbsp;why&nbsp;the&nbsp;node&nbsp;fallen&nbsp;stops&nbsp;confirming&nbsp;for&nbsp;a&nbsp;while,&nbsp;then&nbsp;suddenly&nbsp;resumes&nbsp;for&nbsp;some&nbsp;seconds&nbsp;(not&nbsp;always,&nbsp;just&nbsp;some&nbsp;times)&nbsp;and&nbsp;then&nbsp;stops&nbsp;Rabbit&nbsp;process&nbsp;closing&nbsp;the&nbsp;connection&nbsp;and&nbsp;having&nbsp;confirmed&nbsp;messages&nbsp;lost.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&#39;s&nbsp;my&nbsp;understanding&nbsp;that&nbsp;the&nbsp;node&nbsp;should&nbsp;do&nbsp;something&nbsp;like,&nbsp;I&nbsp;cannot&nbsp;see&nbsp;nodes&nbsp;1&nbsp;and&nbsp;2&nbsp;(connection&nbsp;is&nbsp;broken),&nbsp;I&#39;m&nbsp;by&nbsp;myself&nbsp;here&nbsp;so&nbsp;I&nbsp;cannot&nbsp;confirm&nbsp;your&nbsp;publishes.&nbsp;Then&nbsp;says&nbsp;I&#39;ve&nbsp;got&nbsp;to&nbsp;stop,&nbsp;because&nbsp;I&#39;m&nbsp;in&nbsp;minority.&nbsp;However,&nbsp;the&nbsp;fact&nbsp;that&nbsp;is&nbsp;confirming&nbsp;messages&nbsp;for&nbsp;a&nbsp;small&nbsp;lapse&nbsp;of&nbsp;time&nbsp;feels&nbsp;like&nbsp;something&nbsp;is&nbsp;not&nbsp;completely&nbsp;working.&nbsp;Also&nbsp;this&nbsp;actually&nbsp;doesn&#39;t&nbsp;always&nbsp;happens,&nbsp;sometimes&nbsp;it&nbsp;does&nbsp;it&nbsp;right,&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;consistent.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;be&nbsp;honest,&nbsp;i&nbsp;like&nbsp;the&nbsp;trick&nbsp;of&nbsp;having&nbsp;a&nbsp;local&nbsp;RabbitMQ,&nbsp;however&nbsp;for&nbsp;us&nbsp;it&nbsp;would&nbsp;be&nbsp;simpler&nbsp;just&nbsp;a&nbsp;cluster.&nbsp;Having&nbsp;a&nbsp;local&nbsp;RabbitMQ,&nbsp;maintaing&nbsp;some&nbsp;federation&nbsp;or&nbsp;shoveling&nbsp;would&nbsp;be&nbsp;a&nbsp;little&nbsp;overkill.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;While&nbsp;doing&nbsp;all&nbsp;these&nbsp;tests.&nbsp;Once,&nbsp;when&nbsp;flushing&nbsp;iptables&nbsp;in&nbsp;node3&nbsp;it&nbsp;has&nbsp;core&nbsp;dumped&nbsp;some&nbsp;Erlang&nbsp;trace.&nbsp;All&nbsp;times&nbsp;before&nbsp;it&nbsp;simply&nbsp;detects&nbsp;network&nbsp;and&nbsp;rejoins&nbsp;cluster&nbsp;without&nbsp;issues.&nbsp;is&nbsp;this&nbsp;something&nbsp;i&nbsp;should&nbsp;report?&nbsp;how?&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&nbsp;cheers&lt;/div&gt;&lt;div&gt;Miguel&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2014-06-04&nbsp;10:17&nbsp;GMT+02:00&nbsp;Michael&nbsp;Klishin&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:mklishin@gopivotal.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mklishin@gopivotal.com&lt;/a&gt;&gt;&lt;/span&gt;:&lt;br&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;4&nbsp;June&nbsp;2014&nbsp;at&nbsp;11:58:41,&nbsp;Miguel&nbsp;Araujo&nbsp;Pérez&nbsp;(&lt;a&nbsp;href=&quot;mailto:miguel.araujo.perez@gmail.com&quot;&gt;miguel.araujo.perez@gmail.com&lt;/a&gt;)&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;The&nbsp;issue&nbsp;is&nbsp;that&nbsp;sometimes&nbsp;after&nbsp;a&nbsp;while&nbsp;publisher3&nbsp;resumes&lt;br&gt;<br>
&gt;&nbsp;and&nbsp;continues&nbsp;pushing&nbsp;messages&nbsp;and&nbsp;according&nbsp;to&nbsp;the&nbsp;library&lt;br&gt;<br>
&gt;&nbsp;receiving&nbsp;acks&nbsp;for&nbsp;them,&nbsp;that&nbsp;goes&nbsp;for&nbsp;a&nbsp;period&nbsp;of&nbsp;6-8&nbsp;seconds&lt;br&gt;<br>
&gt;&nbsp;until&nbsp;an&nbsp;exception&nbsp;is&nbsp;raised&nbsp;because&nbsp;connection&nbsp;is&nbsp;closed&nbsp;(node3&lt;br&gt;<br>
&gt;&nbsp;stops&nbsp;Rabbit).&nbsp;Those&nbsp;&quot;acked&nbsp;messages&quot;&nbsp;aren&#39;t&nbsp;however&nbsp;in&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;queue&nbsp;when&nbsp;I&nbsp;consume&nbsp;it&nbsp;later&nbsp;to&nbsp;see&nbsp;what&#39;s&nbsp;inside.&nbsp;However,&nbsp;other&lt;br&gt;<br>
&gt;&nbsp;times&nbsp;it&nbsp;works&nbsp;as&nbsp;i&nbsp;would&nbsp;expect&nbsp;and&nbsp;doesn&#39;t&nbsp;enqueue&nbsp;any&nbsp;other&lt;br&gt;<br>
&gt;&nbsp;message&nbsp;after&nbsp;iptables&nbsp;takes&nbsp;place.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;So&nbsp;I&nbsp;thought&nbsp;this&nbsp;could&nbsp;be&nbsp;a&nbsp;library&nbsp;issue,&nbsp;and&nbsp;ported&nbsp;the&nbsp;code&lt;br&gt;<br>
&gt;&nbsp;to&nbsp;PHP&nbsp;using&nbsp;official&nbsp;php-amqplib&nbsp;and&nbsp;exact&nbsp;same&nbsp;thing&nbsp;happens.&lt;br&gt;<br>
&gt;&nbsp;My&nbsp;theory&nbsp;is&nbsp;that&nbsp;sometimes&nbsp;node3&nbsp;after&nbsp;trying&nbsp;to&nbsp;coordinate&lt;br&gt;<br>
&gt;&nbsp;with&nbsp;other&nbsp;2&nbsp;nodes&nbsp;goes&nbsp;into&nbsp;a&nbsp;partition&nbsp;for&nbsp;some&nbsp;seconds,&nbsp;in&nbsp;those&lt;br&gt;<br>
&gt;&nbsp;seconds&nbsp;it&nbsp;confirms&nbsp;messages&nbsp;and&nbsp;then&nbsp;pause&nbsp;minority&nbsp;cluster&lt;br&gt;<br>
&gt;&nbsp;policy&nbsp;kicks&nbsp;in&nbsp;and&nbsp;stops&nbsp;Rabbit.&lt;br&gt;<br>
&lt;br&gt;<br>
Yes,&nbsp;it&nbsp;takes&nbsp;time&nbsp;for&nbsp;both&nbsp;RabbitMQ&nbsp;and&nbsp;client&nbsp;libraries&nbsp;to&nbsp;detect&lt;br&gt;<br>
connection&nbsp;failure.&nbsp;This&nbsp;is&nbsp;in&nbsp;part&nbsp;due&nbsp;to&nbsp;how&nbsp;TCP&nbsp;works.&nbsp;You&nbsp;can&nbsp;configure&lt;br&gt;<br>
the&nbsp;interval&nbsp;of&nbsp;inactivity&nbsp;for&nbsp;RabbitMQ&nbsp;nodes:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://www.rabbitmq.com/nettick.html&quot;&nbsp;target=&quot;_blank&quot;&gt;https://www.rabbitmq.com/nettick.html&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
and&nbsp;use&nbsp;a&nbsp;low&nbsp;(say,&nbsp;1-3&nbsp;seconds)&nbsp;heartbeat&nbsp;interval&nbsp;for&nbsp;client&nbsp;libraries.&lt;br&gt;<br>
This&nbsp;should&nbsp;make&nbsp;the&nbsp;exception&nbsp;be&nbsp;thrown&nbsp;much&nbsp;earlier&nbsp;(given&nbsp;that&nbsp;your&nbsp;client&lt;br&gt;<br>
supports&nbsp;it;&nbsp;Pika&nbsp;should)&nbsp;at&nbsp;the&nbsp;cost&nbsp;of&nbsp;having&nbsp;increased&nbsp;network&nbsp;traffic:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/reliability.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/reliability.html&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Beyond&nbsp;that,&nbsp;your&nbsp;apps&nbsp;can&nbsp;publish&nbsp;last&nbsp;N&nbsp;messages&nbsp;(excessively)&nbsp;after&nbsp;a&nbsp;network&lt;br&gt;<br>
failure.&nbsp;If&nbsp;your&nbsp;consumers&nbsp;can&nbsp;de-duplicate&nbsp;them&nbsp;(e.g.&nbsp;every&nbsp;message&nbsp;has&nbsp;an&nbsp;id&nbsp;you&nbsp;can&nbsp;set),&lt;br&gt;<br>
that&nbsp;should&nbsp;work&nbsp;well.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;that&#39;s&nbsp;not&nbsp;the&nbsp;case,&nbsp;there&nbsp;is&nbsp;a&nbsp;trick&nbsp;that&nbsp;some&nbsp;companies&nbsp;do:&nbsp;they&nbsp;run&nbsp;a&nbsp;RabbitMQ&lt;br&gt;<br>
node&nbsp;local&nbsp;to&nbsp;machine&nbsp;(which&nbsp;at&nbsp;least&nbsp;greatly&nbsp;reduces&nbsp;the&nbsp;probability&nbsp;of&nbsp;RabbitMQ&nbsp;becoming&lt;br&gt;<br>
unreachable),&nbsp;publish&nbsp;with&nbsp;publisher&nbsp;confirms&nbsp;and&nbsp;a&nbsp;low&nbsp;heartbeat&nbsp;interval&nbsp;to&nbsp;the&nbsp;local&lt;br&gt;<br>
node&nbsp;and&nbsp;use&nbsp;Federation&nbsp;[1]&nbsp;or&nbsp;Shovel&nbsp;[2]&nbsp;to&nbsp;connect&nbsp;that&nbsp;node&nbsp;to&nbsp;other&nbsp;nodes.&lt;br&gt;<br>
&lt;br&gt;<br>
By&nbsp;the&nbsp;way,&nbsp;there&nbsp;are&nbsp;only&nbsp;two&nbsp;official&nbsp;clients:&nbsp;Java&nbsp;and&nbsp;.NET.&lt;br&gt;<br>
&lt;br&gt;<br>
1. &lt;a&nbsp;href=&quot;http://www.rabbitmq.com/federation.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/federation.html&lt;/a&gt;&lt;br&gt;<br>
2. &lt;a&nbsp;href=&quot;http://www.rabbitmq.com/shovel.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/shovel.html&lt;/a&gt;&lt;br&gt;<br>
--&lt;br&gt;<br>
MK&lt;br&gt;<br>
&lt;br&gt;<br>
Software&nbsp;Engineer,&nbsp;Pivotal/RabbitMQ&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
