<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We've&nbsp;setup&nbsp;a&nbsp;RabbitMQ&nbsp;3.3.1-1&nbsp;cluster&nbsp;of&nbsp;3&nbsp;nodes&nbsp;in&nbsp;pause&nbsp;minority&nbsp;mode.&nbsp;We&nbsp;are&nbsp;making&nbsp;some&nbsp;tests&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don't&nbsp;lose&nbsp;any&nbsp;messages&nbsp;when&nbsp;a&nbsp;node&nbsp;of&nbsp;the&nbsp;cluster&nbsp;goes&nbsp;down.&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;I've&nbsp;setup&nbsp;a&nbsp;little&nbsp;Python&nbsp;script&nbsp;that&nbsp;uses&nbsp;py-amqp&nbsp;to&nbsp;queue&nbsp;messages,&nbsp;It&nbsp;uses&nbsp;publisher&nbsp;confirms&nbsp;for&nbsp;doing&nbsp;so.&nbsp;The&nbsp;queue&nbsp;is&nbsp;durable&nbsp;and&nbsp;mirrored&nbsp;through&nbsp;a&nbsp;policy&nbsp;to&nbsp;all&nbsp;nodes.&nbsp;I&nbsp;use&nbsp;the&nbsp;script&nbsp;to&nbsp;push&nbsp;to&nbsp;the&nbsp;3&nbsp;different&nbsp;nodes&nbsp;in&nbsp;a&nbsp;loop,&nbsp;running&nbsp;3&nbsp;separate&nbsp;processes,&nbsp;one&nbsp;message&nbsp;every&nbsp;second,&nbsp;each&nbsp;message&nbsp;containing&nbsp;information&nbsp;of&nbsp;the&nbsp;publisher&nbsp;that&nbsp;produced&nbsp;it.&nbsp;Once&nbsp;I&nbsp;am&nbsp;publishing&nbsp;to&nbsp;the&nbsp;3&nbsp;nodes&nbsp;separated&nbsp;I&nbsp;enter&nbsp;node3&nbsp;and&nbsp;write&nbsp;iptables&nbsp;rules&nbsp;to&nbsp;close&nbsp;connection&nbsp;with&nbsp;the&nbsp;other&nbsp;2&nbsp;rabbitmq&nbsp;nodes.&nbsp;It&nbsp;takes&nbsp;the&nbsp;cluster&nbsp;around&nbsp;a&nbsp;minute&nbsp;to&nbsp;decide&nbsp;that&nbsp;one&nbsp;node&nbsp;is&nbsp;down&nbsp;and&nbsp;node3&nbsp;to&nbsp;stop&nbsp;Rabbit&nbsp;process.&nbsp;publishers&nbsp;to&nbsp;nodes&nbsp;1&nbsp;and&nbsp;2&nbsp;keep&nbsp;working&nbsp;without&nbsp;issues,&nbsp;however&nbsp;publisher3&nbsp;blocks&nbsp;right&nbsp;after&nbsp;node3&nbsp;blocks&nbsp;connections&nbsp;as&nbsp;I&nbsp;would&nbsp;expect&nbsp;as&nbsp;node3&nbsp;cannot&nbsp;confirm&nbsp;the&nbsp;message&nbsp;as&nbsp;it&nbsp;doesn't&nbsp;see&nbsp;the&nbsp;other&nbsp;2&nbsp;nodes.&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;issue&nbsp;is&nbsp;that&nbsp;sometimes&nbsp;after&nbsp;a&nbsp;while&nbsp;publisher3&nbsp;resumes&nbsp;and&nbsp;continues&nbsp;pushing&nbsp;messages&nbsp;and&nbsp;according&nbsp;to&nbsp;the&nbsp;library&nbsp;receiving&nbsp;acks&nbsp;for&nbsp;them,&nbsp;that&nbsp;goes&nbsp;for&nbsp;a&nbsp;period&nbsp;of&nbsp;6-8&nbsp;seconds&nbsp;until&nbsp;an&nbsp;exception&nbsp;is&nbsp;raised&nbsp;because&nbsp;connection&nbsp;is&nbsp;closed&nbsp;(node3&nbsp;stops&nbsp;Rabbit).&nbsp;Those&nbsp;&quot;acked&nbsp;messages&quot;&nbsp;aren't&nbsp;however&nbsp;in&nbsp;the&nbsp;queue&nbsp;when&nbsp;I&nbsp;consume&nbsp;it&nbsp;later&nbsp;to&nbsp;see&nbsp;what's&nbsp;inside.&nbsp;However,&nbsp;other&nbsp;times&nbsp;it&nbsp;works&nbsp;as&nbsp;i&nbsp;would&nbsp;expect&nbsp;and&nbsp;doesn't&nbsp;enqueue&nbsp;any&nbsp;other&nbsp;message&nbsp;after&nbsp;iptables&nbsp;takes&nbsp;place.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;I&nbsp;thought&nbsp;this&nbsp;could&nbsp;be&nbsp;a&nbsp;library&nbsp;issue,&nbsp;and&nbsp;ported&nbsp;the&nbsp;code&nbsp;to&nbsp;PHP&nbsp;using&nbsp;official&nbsp;php-amqplib&nbsp;and&nbsp;exact&nbsp;same&nbsp;thing&nbsp;happens.&nbsp;My&nbsp;theory&nbsp;is&nbsp;that&nbsp;sometimes&nbsp;node3&nbsp;after&nbsp;trying&nbsp;to&nbsp;coordinate&nbsp;with&nbsp;other&nbsp;2&nbsp;nodes&nbsp;goes&nbsp;into&nbsp;a&nbsp;partition&nbsp;for&nbsp;some&nbsp;seconds,&nbsp;in&nbsp;those&nbsp;seconds&nbsp;it&nbsp;confirms&nbsp;messages&nbsp;and&nbsp;then&nbsp;pause&nbsp;minority&nbsp;cluster&nbsp;policy&nbsp;kicks&nbsp;in&nbsp;and&nbsp;stops&nbsp;Rabbit.&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;be&nbsp;honest,&nbsp;I'm&nbsp;open&nbsp;to&nbsp;suggestions&nbsp;on&nbsp;what&nbsp;to&nbsp;try.&nbsp;We&nbsp;cannot&nbsp;afford&nbsp;losing&nbsp;messages&nbsp;in&nbsp;any&nbsp;situation.&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&nbsp;Cheers&lt;/div&gt;&lt;div&gt;Miguel&lt;/div&gt;&lt;/div&gt;
</tt>
