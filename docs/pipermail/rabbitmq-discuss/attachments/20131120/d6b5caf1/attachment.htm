<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;We&nbsp;have&nbsp;a&nbsp;RabbitMQ&nbsp;cluster&nbsp;in&nbsp;production&nbsp;that&nbsp;seems&nbsp;to&nbsp;be&nbsp;using&nbsp;an&nbsp;excessive&nbsp;amount&nbsp;of&nbsp;memory.&nbsp;I&amp;#39;m&nbsp;trying&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;sort&nbsp;of&nbsp;diagnostics&nbsp;are&nbsp;available&nbsp;to&nbsp;us.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Background:&nbsp;RabbitMQ&nbsp;3.0.2,&nbsp;Erlang&nbsp;R15B01&nbsp;on&nbsp;Ubuntu&nbsp;10.04&nbsp;(64-bit).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;we&amp;#39;d&nbsp;love&nbsp;to&nbsp;upgrade&nbsp;to&nbsp;3.2.1&nbsp;and&nbsp;the&nbsp;latest&nbsp;Erlang,&nbsp;but&nbsp;this&nbsp;is&nbsp;in&nbsp;production,&nbsp;and&nbsp;we&nbsp;can&amp;#39;t&nbsp;just&nbsp;throw&nbsp;something&nbsp;untested&nbsp;(by&nbsp;us,&nbsp;in&nbsp;our&nbsp;scenario)&nbsp;into&nbsp;production.&nbsp;So&nbsp;we&nbsp;need&nbsp;to&nbsp;understand&nbsp;what&amp;#39;s&nbsp;wrong&nbsp;now,&nbsp;and&nbsp;then&nbsp;we&nbsp;can&nbsp;test&nbsp;on&nbsp;newer&nbsp;releases&nbsp;to&nbsp;validate&nbsp;things&nbsp;are&nbsp;better.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&amp;#39;ve&nbsp;now&nbsp;upped&nbsp;our&nbsp;VM&nbsp;to&nbsp;8GB,&nbsp;and&nbsp;RabbitMQ/Erlang&nbsp;seem&nbsp;more&nbsp;than&nbsp;happy&nbsp;to&nbsp;just&nbsp;eat&nbsp;up&nbsp;more&nbsp;memory&nbsp;and&nbsp;keep&nbsp;going.&nbsp;Earlier&nbsp;today&nbsp;a&nbsp;node&nbsp;crashed&nbsp;when&nbsp;the&nbsp;VM&nbsp;had&nbsp;4GB,&nbsp;and&nbsp;Rabbit&nbsp;tried&nbsp;to&nbsp;allocate&nbsp;2.2GB&nbsp;(this&nbsp;was&nbsp;the&nbsp;last&nbsp;entry&nbsp;in&nbsp;our&nbsp;logs).&nbsp;Nothing&nbsp;else&nbsp;of&nbsp;consequence&nbsp;is&nbsp;running&nbsp;on&nbsp;this&nbsp;VM.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Currently&nbsp;the&nbsp;story&nbsp;looks&nbsp;like&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Roughly&nbsp;300&nbsp;queues.&nbsp;Traffic&nbsp;is&nbsp;about&nbsp;50&nbsp;messages/second,&nbsp;although&nbsp;at&nbsp;peak&nbsp;times&nbsp;it&nbsp;goes&nbsp;to&nbsp;400/second.&nbsp;However,&nbsp;message&nbsp;rates&nbsp;and&nbsp;memory&nbsp;consumption&nbsp;seem&nbsp;unrelated.&nbsp;Messages&nbsp;are&nbsp;at&nbsp;most&nbsp;1KB&nbsp;in&nbsp;size.&nbsp;Connections&nbsp;are&nbsp;steady&nbsp;at&nbsp;600,&nbsp;with&nbsp;800&nbsp;channels.&nbsp;We&nbsp;use&nbsp;message&nbsp;acks.&nbsp;Most&nbsp;messages&nbsp;are&nbsp;unacked&nbsp;for&nbsp;a&nbsp;few&nbsp;milliseconds&nbsp;before&nbsp;they&amp;#39;re&nbsp;acked.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Currently&nbsp;Rabbit&nbsp;is&nbsp;consuming&nbsp;in&nbsp;the&nbsp;neighborhood&nbsp;of&nbsp;1.8GB&nbsp;(via&nbsp;the&nbsp;web&nbsp;ui)&nbsp;on&nbsp;average.&nbsp;Here&amp;#39;s&nbsp;a&nbsp;breakdown&nbsp;of&nbsp;the&nbsp;node&nbsp;reported&nbsp;memory&nbsp;usage&nbsp;details&nbsp;from&nbsp;the&nbsp;UI:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Connections&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&lt;/span&gt;154.9MB&lt;/div&gt;<br>
&lt;div&gt;Queues&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&lt;/span&gt;16.2MB&lt;/div&gt;&lt;div&gt;Plugins&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&lt;/span&gt;89.6kB&lt;/div&gt;&lt;div&gt;Other&nbsp;process&nbsp;memory&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&lt;/span&gt;14.2MB&lt;/div&gt;<br>
&lt;div&gt;Mnesia&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&lt;/span&gt;2.6MB&lt;/div&gt;&lt;div&gt;Message&nbsp;store&nbsp;index&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&lt;/span&gt;2.2MB&lt;/div&gt;&lt;div&gt;Management&nbsp;database&nbsp;&lt;span&nbsp;style=&quot;white-space:pre&quot;&gt; &lt;/span&gt;1.3GB&lt;/div&gt;<br>
&lt;div&gt;Other&nbsp;ETS&nbsp;tables&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;6.9MB&lt;/div&gt;&lt;div&gt;Binaries&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;115.9MB&lt;/div&gt;&lt;div&gt;Code&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&lt;/span&gt;17.5MB&lt;/div&gt;<br>
&lt;div&gt;Atoms&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&lt;/span&gt;654.9kB&lt;/div&gt;&lt;div&gt;Other&nbsp;system&nbsp;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;36.1MB&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;management&nbsp;database&nbsp;at&nbsp;1.3GB&nbsp;seems&nbsp;excessive.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Watching&nbsp;the&nbsp;memory&nbsp;consumption&nbsp;over&nbsp;time,&nbsp;it&nbsp;might&nbsp;drop&nbsp;down&nbsp;to&nbsp;1&nbsp;GB,&nbsp;then&nbsp;peak&nbsp;at&nbsp;2.4GB.&nbsp;It&nbsp;seems&nbsp;to&nbsp;randomly&nbsp;wander&nbsp;between&nbsp;those&nbsp;values&nbsp;over&nbsp;time.&nbsp;We&nbsp;have&nbsp;our&nbsp;watermark&nbsp;set&nbsp;at&nbsp;60%,&nbsp;so&nbsp;4.7GB&nbsp;there.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Needless&nbsp;to&nbsp;say,&nbsp;this&nbsp;is&nbsp;baffling&nbsp;and&nbsp;concerning.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Are&nbsp;their&nbsp;known&nbsp;issues&nbsp;with&nbsp;this&nbsp;configuration?&nbsp;How&nbsp;can&nbsp;we&nbsp;pin&nbsp;down&nbsp;what&amp;#39;s&nbsp;happening?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Matt&lt;/div&gt;&lt;/div&gt;<br>

</tt>
