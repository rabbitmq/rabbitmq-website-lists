<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Nov&nbsp;20,&nbsp;2013&nbsp;at&nbsp;12:11&nbsp;AM,&nbsp;Matthias&nbsp;Radestock&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthias@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;matthias@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;20/11/13&nbsp;04:38,&nbsp;Graeme&nbsp;N&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
Rabbit&nbsp;at&nbsp;the&nbsp;moment&nbsp;doesn&amp;#39;t&nbsp;make&nbsp;much&nbsp;effort&nbsp;into&nbsp;making&nbsp;its&lt;br&gt;<br>
workload&nbsp;append&nbsp;only&nbsp;and&nbsp;contiguous&nbsp;by&nbsp;default&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Actually&nbsp;all&nbsp;disk&nbsp;writes&nbsp;in&nbsp;rabbit&nbsp;*are*&nbsp;append-only&nbsp;(plus&nbsp;the&nbsp;occasional&nbsp;truncate).&nbsp;But&nbsp;when&nbsp;dealing&nbsp;with&nbsp;multiple&nbsp;disk-bound&nbsp;queues,&nbsp;there&nbsp;is&nbsp;inevitably&nbsp;a&nbsp;fair&nbsp;bit&nbsp;of&nbsp;seeking&nbsp;going&nbsp;on.&nbsp;And&nbsp;SSDs&nbsp;are&nbsp;much&nbsp;quicker&nbsp;at&nbsp;that.&lt;span&nbsp;class=&quot;&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;Well,&nbsp;I&nbsp;guess&nbsp;that&nbsp;multiple&nbsp;small&nbsp;files,&nbsp;even&nbsp;if&nbsp;they&nbsp;are&nbsp;individually&nbsp;written&nbsp;as&nbsp;append&nbsp;only,&nbsp;doesn&amp;#39;t&nbsp;really&nbsp;qualify&nbsp;as&nbsp;an&nbsp;append-only&nbsp;workload&nbsp;in&nbsp;the&nbsp;sense&nbsp;I&amp;#39;d&nbsp;normally&nbsp;think&nbsp;of&nbsp;it.&nbsp;The&nbsp;reason&nbsp;to&nbsp;use&nbsp;an&nbsp;append-only&nbsp;workload&nbsp;is&nbsp;to&nbsp;ensure&nbsp;it&nbsp;performs&nbsp;well&nbsp;on&nbsp;spinning&nbsp;disks&nbsp;by&nbsp;avoiding&nbsp;seeks.&nbsp;Looking&nbsp;at&nbsp;the&nbsp;files&nbsp;under&nbsp;/var/lib/rabbitmq/mnesia/rabbit@hostname/msg_store_persistent&nbsp;on&nbsp;our&nbsp;busiest&nbsp;host,&nbsp;and&nbsp;we&nbsp;see&nbsp;~390&nbsp;files,&nbsp;all&nbsp;&amp;lt;=&nbsp;17&nbsp;MiB.&nbsp;Compare&nbsp;to&nbsp;MySQL&nbsp;or&nbsp;Riak,&nbsp;where&nbsp;we&nbsp;split&nbsp;the&nbsp;InnoDB&nbsp;or&nbsp;Bitcask&nbsp;append-only&nbsp;logs&nbsp;at&nbsp;500&nbsp;MiB,&nbsp;which&nbsp;is&nbsp;chosen&nbsp;so&nbsp;it&nbsp;fits&nbsp;inside&nbsp;of&nbsp;our&nbsp;hardware&nbsp;RAID&nbsp;controllers&amp;#39;&nbsp;BBU&nbsp;caches.&lt;br&gt;<br>
&lt;br&gt;Our&nbsp;big&nbsp;messages&nbsp;in&nbsp;RabbitMQ&nbsp;are&nbsp;500kiB&nbsp;to&nbsp;4MiB,&nbsp;so&nbsp;each&nbsp;of&nbsp;these&nbsp;16&nbsp;MiB&nbsp;chunks&nbsp;only&nbsp;stores&nbsp;~10&nbsp;of&nbsp;these&nbsp;messages,&nbsp;which&nbsp;is&nbsp;far&nbsp;smaller&nbsp;than&nbsp;our&nbsp;typical&nbsp;batch&nbsp;size&nbsp;of&nbsp;~100&nbsp;messages.&nbsp;Relatively&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;ton&nbsp;more&nbsp;overhead&nbsp;in&nbsp;many&nbsp;small&nbsp;files&nbsp;than&nbsp;we&nbsp;typically&nbsp;see&nbsp;in&nbsp;other&nbsp;datastores&nbsp;that&nbsp;bill&nbsp;themselves&nbsp;as&nbsp;spinning&nbsp;disk&nbsp;friendly&nbsp;/&nbsp;append&nbsp;only.&nbsp;When&nbsp;you&nbsp;consider&nbsp;that&nbsp;those&nbsp;other&nbsp;data&nbsp;stores&nbsp;use&nbsp;a&nbsp;single&nbsp;set&nbsp;of&nbsp;append-only&nbsp;logs&nbsp;for&nbsp;all&nbsp;queues/tables/buckets&nbsp;in&nbsp;the&nbsp;system,&nbsp;and&nbsp;rabbit&nbsp;seems&nbsp;to&nbsp;be&nbsp;segmenting&nbsp;them&nbsp;based&nbsp;on&nbsp;queue,&nbsp;it&nbsp;means&nbsp;that&nbsp;rabbit&amp;#39;s&nbsp;workload&nbsp;contains&nbsp;at&nbsp;least&nbsp;an&nbsp;order&nbsp;of&nbsp;magnitude&nbsp;more&nbsp;seeks&nbsp;when&nbsp;busy&nbsp;than&nbsp;these&nbsp;other&nbsp;storage&nbsp;engines.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;So,&nbsp;while&nbsp;rabbit&amp;#39;s&nbsp;workload&nbsp;at&nbsp;the&nbsp;file&nbsp;chunk&nbsp;level&nbsp;may&nbsp;technically&nbsp;be&nbsp;append&nbsp;only,&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;actually&nbsp;seem&nbsp;to&nbsp;avoid&nbsp;seeks&nbsp;in&nbsp;its&nbsp;workload,&nbsp;and&nbsp;we&nbsp;tend&nbsp;to&nbsp;see&nbsp;pretty&nbsp;massive&nbsp;persistent&nbsp;queue&nbsp;performance&nbsp;improvements&nbsp;by&nbsp;using&nbsp;SSDs.&nbsp;Thus,&nbsp;I&nbsp;wouldn&amp;#39;t&nbsp;really&nbsp;consider&nbsp;its&nbsp;workload&nbsp;in&nbsp;the&nbsp;same&nbsp;class&nbsp;as&nbsp;most&nbsp;append-only&nbsp;storage&nbsp;systems.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;Graeme&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
