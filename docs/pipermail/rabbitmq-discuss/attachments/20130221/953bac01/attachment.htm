<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi!&nbsp;&lt;br&gt;&lt;br&gt;Sorry&nbsp;for&nbsp;the&nbsp;long&nbsp;delay.&nbsp;I&nbsp;did&nbsp;some&nbsp;more&nbsp;tests&nbsp;and&nbsp;found&nbsp;a&nbsp;way&nbsp;to&nbsp;speed&nbsp;things&nbsp;up.&lt;br&gt;After&nbsp;changing&nbsp;{ack_mode,&nbsp;on_confirm}&nbsp;to&nbsp;{ack_mode,&nbsp;on_publish}&nbsp;things&nbsp;started&nbsp;to&nbsp;work&nbsp;well.&nbsp;&lt;br&gt;Which&nbsp;means&nbsp;that&nbsp;the&nbsp;speed&nbsp;of&nbsp;reading&nbsp;the&nbsp;messages&nbsp;from&nbsp;the&nbsp;queue&nbsp;NodeB&nbsp;was&nbsp;the&nbsp;speed&nbsp;they&nbsp;&lt;br&gt;<br>
were&nbsp;published&nbsp;to&nbsp;the&nbsp;queue&nbsp;on&nbsp;NodeA.&nbsp;&lt;br&gt;&lt;br&gt;Before&nbsp;this&nbsp;change&nbsp;(when&nbsp;&amp;#39;on_confirm&amp;#39;&nbsp;was&nbsp;set)&nbsp;messages&nbsp;where&nbsp;piling&nbsp;up&nbsp;in&nbsp;the&nbsp;queue&nbsp;on&nbsp;NodeB.&lt;br&gt;So&nbsp;if&nbsp;i&nbsp;published&nbsp;100&nbsp;messages&nbsp;per&nbsp;sec&nbsp;into&nbsp;a&nbsp;queue&nbsp;on&nbsp;nodeA,&nbsp;the&nbsp;queue&nbsp;on&nbsp;nodeB&nbsp;would&nbsp;receive&nbsp;all&nbsp;of&nbsp;those&nbsp;and&nbsp;the&nbsp;queue&nbsp;on&nbsp;nodeA&nbsp;would&nbsp;be&nbsp;empty&nbsp;(as&nbsp;it&nbsp;should).&nbsp;But&nbsp;the&nbsp;PHP&nbsp;script&nbsp;on&nbsp;nodeB&nbsp;(below)&nbsp;would&nbsp;read&nbsp;something&nbsp;like&nbsp;3-8&nbsp;messages&nbsp;per&nbsp;sec&nbsp;and&nbsp;the&nbsp;rest&nbsp;(92-97&nbsp;messages&nbsp;per&nbsp;sec)&nbsp;would&nbsp;keep&nbsp;piling&nbsp;up&nbsp;in&nbsp;the&nbsp;queue&nbsp;on&nbsp;nodeB.&nbsp;&lt;br&gt;<br>
That&nbsp;is&nbsp;until&nbsp;i&nbsp;completely&nbsp;stopped&nbsp;writing&nbsp;new&nbsp;messages&nbsp;to&nbsp;the&nbsp;queue&nbsp;on&nbsp;nodeA.&nbsp;Then&nbsp;this&nbsp;script&nbsp;will&nbsp;read&nbsp;messages&nbsp;like&nbsp;crazy&nbsp;until&nbsp;the&nbsp;queue&nbsp;on&nbsp;nodeB&nbsp;was&nbsp;completely&nbsp;empty.&nbsp;&lt;br&gt;&lt;br&gt;So&nbsp;I&nbsp;left&nbsp;with&nbsp;a&nbsp;couple&nbsp;of&nbsp;questions.&nbsp;What&nbsp;is&nbsp;causing&nbsp;the&nbsp;write&nbsp;and&nbsp;the&nbsp;read&nbsp;to&nbsp;be&nbsp;so&nbsp;uneven&nbsp;with&nbsp;&amp;#39;on_confirm&amp;#39;&nbsp;given&nbsp;that&nbsp;there&nbsp;no&nbsp;real&nbsp;resources&nbsp;problem?&nbsp;Is&nbsp;this&nbsp;a&nbsp;bug&nbsp;or&nbsp;a&nbsp;feature?&lt;br&gt;<br>
How&nbsp;much&nbsp;reliability&nbsp;do&nbsp;I&nbsp;lose&nbsp;if&nbsp;i&nbsp;use&nbsp;&amp;#39;on_publish&amp;#39;&nbsp;?&nbsp;Is&nbsp;there&nbsp;a&nbsp;chance&nbsp;messages&nbsp;can&nbsp;just&nbsp;disappear&nbsp;with&nbsp;&amp;#39;on_publish&amp;#39;&nbsp;?&nbsp;&lt;br&gt;&lt;br&gt;Here&nbsp;is&nbsp;the&nbsp;outline&nbsp;of&nbsp;my&nbsp;php&nbsp;test&nbsp;reader,&nbsp;very&nbsp;simple:&nbsp;&lt;br&gt;&lt;br&gt;&amp;lt;?php&lt;br&gt;<br>
$connection&nbsp;=&nbsp;new&nbsp;AMQPConnection();&lt;br&gt;$connection-&amp;gt;setLogin(&amp;quot;&amp;lt;login_nodeb&amp;gt;&amp;quot;);&lt;br&gt;$connection-&amp;gt;setPassword(&amp;quot;&amp;lt;password_nodeb&amp;quot;);&lt;br&gt;$connection-&amp;gt;setVhost(&amp;quot;vhostB&amp;quot;);&lt;br&gt;$connection-&amp;gt;connect();&lt;br&gt;<br>
&lt;br&gt;if&nbsp;(!$connection-&amp;gt;isConnected())&nbsp;{&lt;br&gt;   &nbsp;die(&amp;#39;Not&nbsp;connected&nbsp;:(&amp;#39;.&nbsp;PHP_EOL);&lt;br&gt;}&lt;br&gt;$channel   &nbsp;=&nbsp;new&nbsp;AMQPChannel($connection);&lt;br&gt;$queue     &nbsp;=&nbsp;new&nbsp;AMQPQueue($channel);&lt;br&gt;$queue-&amp;gt;setName(&amp;#39;queueB&amp;#39;);&lt;br&gt;<br>
&lt;br&gt;while(true)&nbsp;{&lt;br&gt;       &nbsp;while($queue-&amp;gt;get(AMQP_AUTOACK))&nbsp;{&lt;br&gt;          &nbsp;/*&nbsp;do&nbsp;stuff&nbsp;here,&nbsp;count&nbsp;messages,&nbsp;run&nbsp;mps&nbsp;stats&nbsp;etc...&nbsp;*/&lt;br&gt;       &nbsp;}&lt;br&gt;       &nbsp;/*&nbsp;sleep&nbsp;some&nbsp;not&nbsp;to&nbsp;eat&nbsp;the&nbsp;whole&nbsp;cpu&nbsp;*/&lt;br&gt;       &nbsp;sleep(1);&lt;br&gt;<br>
}&lt;br&gt;&lt;br&gt;&lt;br&gt;Thanks,&nbsp;&lt;br&gt;Boris&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Feb&nbsp;13,&nbsp;2013&nbsp;at&nbsp;5:52&nbsp;PM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;That&nbsp;sounds&nbsp;very&nbsp;wrong.&lt;br&gt;<br>
&lt;br&gt;<br>
Which&nbsp;version&nbsp;of&nbsp;RabbitMQ&nbsp;are&nbsp;you&nbsp;using?&nbsp;Can&nbsp;you&nbsp;post&nbsp;(a&nbsp;cut&nbsp;down&nbsp;version&nbsp;of)&nbsp;your&nbsp;PHP&nbsp;script&nbsp;somewhere?&nbsp;(I&nbsp;have&nbsp;no&nbsp;familiarity&nbsp;with&nbsp;the&nbsp;PHP&nbsp;client&nbsp;but&nbsp;I&amp;#39;d&nbsp;like&nbsp;to&nbsp;see&nbsp;what&nbsp;it&amp;#39;s&nbsp;doing...)&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&nbsp;Simon&lt;div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;13/02/13&nbsp;14:33,&nbsp;bratner&nbsp;bratner&nbsp;wrote:&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&gt;&lt;div&gt;<br>
Hi!&lt;br&gt;<br>
&lt;br&gt;<br>
My&nbsp;setup&nbsp;includes&nbsp;a&nbsp;rabbitmq-c&nbsp;application&nbsp;that&nbsp;publishes&nbsp;messages&nbsp;on&lt;br&gt;<br>
node&nbsp;A.&lt;br&gt;<br>
The&nbsp;publishing&nbsp;rate&nbsp;is&nbsp;about&nbsp;200mps,&nbsp;each&nbsp;message&nbsp;can&nbsp;be&nbsp;up&nbsp;to&nbsp;10Kb.&lt;br&gt;<br>
&lt;br&gt;<br>
Shovel&nbsp;(node&nbsp;A)&nbsp;is&nbsp;configured&nbsp;to&nbsp;move&nbsp;them&nbsp;to&nbsp;node&nbsp;B.&lt;br&gt;<br>
On&nbsp;node&nbsp;B&nbsp;i&amp;#39;m&nbsp;dequeuing&nbsp;the&nbsp;messages&nbsp;with&nbsp;a&nbsp;PHP&nbsp;test&nbsp;script&nbsp;with&lt;br&gt;<br>
$queue-&amp;gt;get(AMQP_AUTOACK).&lt;br&gt;<br>
If&nbsp;i&nbsp;keep&nbsp;the&nbsp;publishing&nbsp;rate&nbsp;at&nbsp;200mps&nbsp;then&nbsp;i&nbsp;can&nbsp;see&nbsp;that&nbsp;the&nbsp;queue&nbsp;on&lt;br&gt;<br>
node&nbsp;A&nbsp;is&nbsp;empty&nbsp;and&nbsp;the&nbsp;Q&nbsp;on&nbsp;node&nbsp;B&nbsp;is&lt;br&gt;<br>
filling&nbsp;up.&nbsp;The&nbsp;read-rate&nbsp;of&nbsp;my&nbsp;test&nbsp;script&nbsp;is&nbsp;really&nbsp;low.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;i&nbsp;stop&nbsp;the&nbsp;publishing,&nbsp;3-5&nbsp;seconds&nbsp;later,&nbsp;my&nbsp;test&nbsp;script&nbsp;starts&lt;br&gt;<br>
reading&nbsp;like&nbsp;crazy&nbsp;until&nbsp;the&nbsp;queue&nbsp;on&nbsp;node&nbsp;B&nbsp;is&nbsp;empty.&lt;br&gt;<br>
&lt;br&gt;<br>
Even&nbsp;If&nbsp;I&nbsp;slow&nbsp;down&nbsp;the&nbsp;publishing&nbsp;rate&nbsp;to&nbsp;5mps&nbsp;,&nbsp;same&nbsp;is&nbsp;happening&nbsp;,&lt;br&gt;<br>
messages&nbsp;are&nbsp;piling&nbsp;up&nbsp;on&nbsp;node&nbsp;B&nbsp;until&nbsp;i&nbsp;dial&nbsp;down&nbsp;the&nbsp;pressure.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;problem&nbsp;disappears&nbsp;if&nbsp;I&nbsp;set&nbsp;ack_mode&nbsp;to&nbsp;on_publish&nbsp;or&nbsp;no_ack.&nbsp;In&lt;br&gt;<br>
this&nbsp;case&nbsp;the&nbsp;reader&nbsp;script&nbsp;reads&nbsp;with&nbsp;the&nbsp;publishing&nbsp;speed.&lt;br&gt;<br>
&lt;br&gt;<br>
My&nbsp;configuration&nbsp;:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
[&lt;br&gt;<br>
{rabbit,&nbsp;[&lt;br&gt;<br>
{log_levels,&nbsp;[{connection,&nbsp;error}]}&lt;br&gt;<br>
]},&lt;br&gt;<br>
{rabbitmq_shovel,&lt;br&gt;<br>
[&nbsp;{shovels,&nbsp;[&nbsp;{messagemover,&nbsp;[&lt;br&gt;<br>
{sources,&nbsp;[&lt;br&gt;<br>
{broker,&nbsp;&amp;quot;amqp://usera:pass@localhost/&lt;u&gt;&lt;/u&gt;vhosta&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
&amp;lt;amqp://cdrposter:4VkI6MKH@&lt;u&gt;&lt;/u&gt;localhost/sipout&amp;gt;&amp;quot;},&lt;div&gt;&lt;br&gt;<br>
{declarations,&nbsp;[&lt;br&gt;<br>
{&amp;#39;exchange.declare&amp;#39;,[{&lt;u&gt;&lt;/u&gt;exchange,&nbsp;&amp;lt;&amp;lt;&amp;quot;my-fanout&amp;quot;&amp;gt;&amp;gt;},{type,&lt;br&gt;<br>
&amp;lt;&amp;lt;&amp;quot;fanout&amp;quot;&amp;gt;&amp;gt;},durable]},&lt;br&gt;<br>
{&amp;#39;queue.declare&amp;#39;,[{queue,&amp;lt;&amp;lt;&amp;quot;&lt;u&gt;&lt;/u&gt;messages&amp;quot;&amp;gt;&amp;gt;},durable]},&lt;br&gt;<br>
{&amp;#39;queue.bind&amp;#39;,[{exchange,&nbsp;&amp;lt;&amp;lt;&amp;quot;my-fanout&amp;quot;&amp;gt;&amp;gt;},{queue,&nbsp;&amp;lt;&amp;lt;&amp;quot;messages&amp;quot;&amp;gt;&amp;gt;}]}&lt;br&gt;<br>
]}&lt;br&gt;<br>
]},&lt;br&gt;<br>
{destinations,&nbsp;[&lt;br&gt;<br>
{brokers,&nbsp;[&nbsp;&amp;quot;amqp://userb:pass@nodeB/&lt;u&gt;&lt;/u&gt;vhostb&lt;br&gt;&lt;/div&gt;<br>
&amp;lt;amqp://&lt;a&nbsp;href=&quot;http://cdr_manager:Ci2XOb3b@10.200.10.218/cdrs&quot;&nbsp;target=&quot;_blank&quot;&gt;cdr_manager:Ci2XOb3b@&lt;u&gt;&lt;/u&gt;10.200.10.218/cdrs&lt;/a&gt;&amp;gt;&amp;quot;&nbsp;]},&lt;div&gt;&lt;br&gt;<br>
{declarations,&nbsp;[&lt;br&gt;<br>
{&amp;#39;exchange.declare&amp;#39;,[{&lt;u&gt;&lt;/u&gt;exchange,&nbsp;&amp;lt;&amp;lt;&amp;quot;my-fanout&amp;quot;&amp;gt;&amp;gt;},{type,&lt;br&gt;<br>
&amp;lt;&amp;lt;&amp;quot;fanout&amp;quot;&amp;gt;&amp;gt;},durable]},&lt;br&gt;<br>
{&amp;#39;queue.declare&amp;#39;,[{queue,&amp;lt;&amp;lt;&amp;quot;&lt;u&gt;&lt;/u&gt;messages&amp;quot;&amp;gt;&amp;gt;},durable]},&lt;br&gt;<br>
{&amp;#39;queue.bind&amp;#39;,[{exchange,&nbsp;&amp;lt;&amp;lt;&amp;quot;my-fanout&amp;quot;&amp;gt;&amp;gt;},{queue,&nbsp;&amp;lt;&amp;lt;&amp;quot;messages&amp;quot;&amp;gt;&amp;gt;}]}&lt;br&gt;<br>
]}&lt;br&gt;<br>
]},&lt;br&gt;<br>
{queue,&nbsp;&amp;lt;&amp;lt;&amp;quot;messages&amp;quot;&amp;gt;&amp;gt;},&lt;br&gt;<br>
{prefetch_count,&nbsp;200},&lt;br&gt;<br>
{ack_mode,&nbsp;on_confirm},&lt;br&gt;<br>
{publish_properties,&nbsp;[{delivery_mode,&nbsp;2}]},&lt;br&gt;<br>
{reconnect_delay,&nbsp;5}&lt;br&gt;<br>
]}&lt;br&gt;<br>
]}&lt;br&gt;<br>
]}&lt;br&gt;<br>
].&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Thank&nbsp;you,&lt;br&gt;<br>
Boris.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;span&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;span&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
--&nbsp;&lt;br&gt;<br>
Simon&nbsp;MacMullen&lt;br&gt;<br>
RabbitMQ,&nbsp;VMware&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
