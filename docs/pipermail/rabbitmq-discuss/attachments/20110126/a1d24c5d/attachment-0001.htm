<tt>
Hi&nbsp;Emile,&lt;br&gt;&lt;br&gt;When&nbsp;I&nbsp;removed&nbsp;the&nbsp;flush,&nbsp;I&nbsp;added&nbsp;an&nbsp;alternate&nbsp;code&nbsp;path&nbsp;so&nbsp;that&nbsp;flushing&nbsp;would&nbsp;only&nbsp;be&nbsp;disabled&nbsp;when&nbsp;called&nbsp;via&nbsp;BasicPublish,&nbsp;and&nbsp;that&nbsp;initiation&nbsp;would&nbsp;still&nbsp;explicitly&nbsp;flush.&nbsp;I&nbsp;initially&nbsp;just&nbsp;commented&nbsp;out&nbsp;the&nbsp;flush,&nbsp;but&nbsp;as&nbsp;you&nbsp;suggested,&nbsp;the&nbsp;connection&nbsp;initiation&nbsp;just&nbsp;failed&nbsp;due&nbsp;to&nbsp;a&nbsp;timeout.&nbsp;Unfortunatey,&nbsp;the&nbsp;problem&nbsp;with&nbsp;just&nbsp;hacking&nbsp;out&nbsp;publish&nbsp;flushing&nbsp;is&nbsp;that&nbsp;sometimes&nbsp;messages&nbsp;will&nbsp;just&nbsp;sit&nbsp;there&nbsp;forever&nbsp;until&nbsp;something&nbsp;forces&nbsp;them&nbsp;out,&nbsp;which&nbsp;could&nbsp;clearly&nbsp;cause&nbsp;a&nbsp;deadlock&nbsp;if&nbsp;your&nbsp;systems&nbsp;ended&nbsp;up&nbsp;waiting&nbsp;on&nbsp;each&nbsp;other.&nbsp;It&nbsp;also&nbsp;caused&nbsp;problems&nbsp;when&nbsp;closing&nbsp;the&nbsp;connection&nbsp;to&nbsp;the&nbsp;broker.&nbsp;I&amp;#39;m&nbsp;guessing&nbsp;that&nbsp;all&nbsp;publish&nbsp;messages&nbsp;need&nbsp;to&nbsp;have&nbsp;been&nbsp;flushed&nbsp;before&nbsp;the&nbsp;library&nbsp;tries&nbsp;to&nbsp;do&nbsp;something&nbsp;else&nbsp;(e.g.&nbsp;a&nbsp;TxCommit&nbsp;or&nbsp;other&nbsp;control&nbsp;messages)?&nbsp;Plus,&nbsp;manually&nbsp;hacking&nbsp;up&nbsp;the&nbsp;RabbitMQ&nbsp;library&nbsp;isn&amp;#39;t&nbsp;really&nbsp;a&nbsp;path&nbsp;I&nbsp;want&nbsp;to&nbsp;go&nbsp;down,&nbsp;since&nbsp;it&amp;#39;ll&nbsp;make&nbsp;upgrading&nbsp;it&nbsp;far&nbsp;more&nbsp;difficult.&lt;br&gt;<br>
&lt;br&gt;I&nbsp;just&nbsp;commented&nbsp;out&nbsp;the&nbsp;line&nbsp;where&nbsp;it&nbsp;sets&nbsp;socket&nbsp;nodelay,&nbsp;and&nbsp;it&nbsp;increased&nbsp;publish&nbsp;to&nbsp;about&nbsp;9-10k&nbsp;messages&nbsp;per&nbsp;second&nbsp;on&nbsp;the&nbsp;Win7&nbsp;system,&nbsp;which&nbsp;is&nbsp;a&nbsp;nice&nbsp;improvement.&nbsp;Is&nbsp;there&nbsp;anywhere&nbsp;I&nbsp;can&nbsp;configure&nbsp;this&nbsp;with&nbsp;the&nbsp;standard&nbsp;client&nbsp;library,&nbsp;rather&nbsp;than&nbsp;building&nbsp;my&nbsp;own&nbsp;with&nbsp;it&nbsp;hacked&nbsp;out?&nbsp;The&nbsp;Java&nbsp;client&nbsp;had&nbsp;a&nbsp;way&nbsp;of&nbsp;overriding&nbsp;the&nbsp;socket&nbsp;factory&nbsp;function.&lt;br&gt;<br>
&lt;br&gt;I&nbsp;think&nbsp;the&nbsp;throughput&nbsp;is&nbsp;still&nbsp;being&nbsp;held&nbsp;back&nbsp;significantly&nbsp;by&nbsp;the&nbsp;explicit&nbsp;flushing.&nbsp;It&amp;#39;d&nbsp;still&nbsp;be&nbsp;nice&nbsp;if&nbsp;we&nbsp;could&nbsp;not&nbsp;flush&nbsp;after&nbsp;every&nbsp;publish&nbsp;or&nbsp;manually&nbsp;take&nbsp;control&nbsp;over&nbsp;when&nbsp;publish&nbsp;flushes&nbsp;occur&nbsp;while&nbsp;still&nbsp;maintaining&nbsp;stability&nbsp;of&nbsp;the&nbsp;library/connection.&nbsp;Are&nbsp;there&nbsp;any&nbsp;plans&nbsp;regarding&nbsp;the&nbsp;flushing&nbsp;behavior,&nbsp;or&nbsp;is&nbsp;Rabbit&amp;#39;s&nbsp;primary&nbsp;focus&nbsp;going&nbsp;to&nbsp;be&nbsp;strictly&nbsp;low&nbsp;latency&nbsp;over&nbsp;high&nbsp;throughput?&nbsp;&lt;br&gt;<br>
&lt;br&gt;Thanks&nbsp;for&nbsp;your&nbsp;help,&lt;br&nbsp;clear=&quot;all&quot;&gt;Cameron&nbsp;Harris&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;26&nbsp;January&nbsp;2011&nbsp;11:36,&nbsp;Emile&nbsp;Joubert&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:emile@rabbitmq.com&quot;&gt;emile@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
&lt;br&gt;<br>
Hi&nbsp;Cameron,&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;25/01/11&nbsp;14:42,&nbsp;Cameron&nbsp;Harris&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;attached&nbsp;a&nbsp;profiler&nbsp;to&nbsp;my&nbsp;publisher&nbsp;and&nbsp;I&nbsp;found&nbsp;that&nbsp;more&nbsp;than&nbsp;90%&nbsp;of&lt;br&gt;<br>
the&nbsp;CPU&nbsp;time&nbsp;was&nbsp;spent&nbsp;calling&nbsp;Flush&nbsp;in&nbsp;WriteFrame&nbsp;(called&nbsp;by&lt;br&gt;<br>
BasicPublish).&nbsp;I&nbsp;created&nbsp;an&nbsp;alternate&nbsp;non-flushing&nbsp;code&nbsp;path&nbsp;in&nbsp;the&lt;br&gt;<br>
RabbitMQ&nbsp;for&nbsp;BasicPublish,&nbsp;and&nbsp;the&nbsp;publishing&nbsp;speed&nbsp;went&nbsp;up&nbsp;to&nbsp;between&lt;br&gt;<br>
35&nbsp;000&nbsp;and&nbsp;45&nbsp;000&nbsp;messages&nbsp;per&nbsp;second,&nbsp;and&nbsp;the&nbsp;messages&nbsp;still&nbsp;got&nbsp;to&nbsp;the&lt;br&gt;<br>
client&nbsp;quickly.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
I&nbsp;would&nbsp;advise&nbsp;caution&nbsp;when&nbsp;removing&nbsp;the&nbsp;flush.&nbsp;Synchronous&nbsp;methods&nbsp;during&nbsp;AMQP&nbsp;connection&nbsp;establishment&nbsp;can&nbsp;timeout&nbsp;and&nbsp;cause&nbsp;failure&nbsp;unless&nbsp;the&nbsp;stream&nbsp;is&nbsp;flushed.&lt;br&gt;<br>
&lt;br&gt;<br>
I&amp;#39;d&nbsp;be&nbsp;interested&nbsp;to&nbsp;know&nbsp;whether&nbsp;disabling&nbsp;the&nbsp;socket&nbsp;nodelay&nbsp;option&nbsp;has&nbsp;any&nbsp;impact&nbsp;on&nbsp;your&nbsp;test.&nbsp;This&nbsp;would&nbsp;be&nbsp;another&nbsp;way&nbsp;of&nbsp;obtaining&nbsp;a&nbsp;different&nbsp;latency/throughput&nbsp;trade-off.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Regards&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;<br>
Emile&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/font&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
