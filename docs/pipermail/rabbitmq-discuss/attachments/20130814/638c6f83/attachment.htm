<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;As&nbsp;an&nbsp;additional&nbsp;piece&nbsp;of&nbsp;information,&nbsp;the&nbsp;cluster&nbsp;consists&nbsp;of&nbsp;two&nbsp;nodes,&nbsp;with&nbsp;the&nbsp;queue&nbsp;in&nbsp;question&nbsp;(and&nbsp;indeed&nbsp;all&nbsp;queues)&nbsp;mirrored,&nbsp;with&nbsp;their&nbsp;home&nbsp;on&nbsp;node&nbsp;A.&nbsp;All&nbsp;the&nbsp;stuck&nbsp;connections&nbsp;are&nbsp;homed&nbsp;on&nbsp;node&nbsp;A.&nbsp;Consumers&nbsp;and&nbsp;publishers&nbsp;connect&nbsp;to&nbsp;either&nbsp;node&nbsp;using&nbsp;a&nbsp;load&nbsp;balancer.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We've&nbsp;just&nbsp;forced&nbsp;our&nbsp;temporary&nbsp;queue&nbsp;(which&nbsp;also&nbsp;started&nbsp;exhibiting&nbsp;the&nbsp;same&nbsp;problem)&nbsp;to&nbsp;have&nbsp;node&nbsp;B&nbsp;as&nbsp;its&nbsp;home,&nbsp;and&nbsp;now&nbsp;any&nbsp;workers&nbsp;that&nbsp;attempt&nbsp;to&nbsp;consume&nbsp;from&nbsp;node&nbsp;A&nbsp;have&nbsp;an&nbsp;error:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:&nbsp;0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;&nbsp;border-left-width:&nbsp;1px;&nbsp;border-left-color:&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;border-left-style:&nbsp;solid;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;Bunny::NotFound:&nbsp;NOT_FOUND&nbsp;-&nbsp;home&nbsp;node&nbsp;'rabbit@nodeA'&nbsp;of&nbsp;durable&nbsp;queue&nbsp;'temp_queue'&nbsp;in&nbsp;vhost&nbsp;'/'&nbsp;is&nbsp;down&nbsp;or&nbsp;inaccessible&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;Cluster&nbsp;status&nbsp;seems&nbsp;to&nbsp;be&nbsp;ok.&nbsp;Now&nbsp;that&nbsp;we&nbsp;only&nbsp;have&nbsp;consumers&nbsp;on&nbsp;node&nbsp;B,&nbsp;we're&nbsp;going&nbsp;to&nbsp;leave&nbsp;it&nbsp;for&nbsp;a&nbsp;while&nbsp;and&nbsp;see&nbsp;if&nbsp;we&nbsp;have&nbsp;any&nbsp;stuck&nbsp;connections.&nbsp;We&nbsp;may&nbsp;attempt&nbsp;to&nbsp;split&nbsp;and&nbsp;rejoin&nbsp;node&nbsp;A&nbsp;from&nbsp;the&nbsp;cluster&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;remedies&nbsp;things.&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;On&nbsp;Wednesday,&nbsp;14&nbsp;August&nbsp;2013&nbsp;10:41:13&nbsp;UTC+1,&nbsp;Paul&nbsp;Bowsher&nbsp;&nbsp;wrote:&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:&nbsp;0;margin-left:&nbsp;0.8ex;border-left:&nbsp;1px&nbsp;#ccc&nbsp;solid;padding-left:&nbsp;1ex;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;the&nbsp;upgrade&nbsp;to&nbsp;RabbitMQ&nbsp;3.1.4&nbsp;we're&nbsp;seeing&nbsp;a&nbsp;large&nbsp;number&nbsp;of&nbsp;linearly-increasing&nbsp;channels&nbsp;which&nbsp;seem&nbsp;to&nbsp;hang&nbsp;around&nbsp;after&nbsp;the&nbsp;connection&nbsp;is&nbsp;closed.&nbsp;This&nbsp;doesn't&nbsp;happen&nbsp;on&nbsp;every&nbsp;queue&nbsp;(even&nbsp;those&nbsp;processed&nbsp;by&nbsp;the&nbsp;same&nbsp;software),&nbsp;only&nbsp;on&nbsp;a&nbsp;particular&nbsp;queue.&nbsp;The&nbsp;orphaned&nbsp;channels&nbsp;leave&nbsp;20&nbsp;messages&nbsp;(the&nbsp;prefetch&nbsp;count)&nbsp;unacked.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Symptoms:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;Initially,&nbsp;larger&nbsp;than&nbsp;expected&nbsp;consumer&nbsp;count&nbsp;on&nbsp;queue&nbsp;from&nbsp;our&nbsp;monitoring&lt;/div&gt;&lt;div&gt;-&nbsp;Stopping&nbsp;all&nbsp;expected&nbsp;consumers&nbsp;on&nbsp;that&nbsp;channel&nbsp;removes&nbsp;the&nbsp;expected&nbsp;number&nbsp;of&nbsp;consumers,&nbsp;leaving&nbsp;orphans&nbsp;(700+&nbsp;at&nbsp;present)&lt;/div&gt;&lt;div&gt;-&nbsp;Each&nbsp;orphaned&nbsp;consumer's&nbsp;channel&nbsp;is&nbsp;reachable&nbsp;using&nbsp;Management&nbsp;tool&lt;/div&gt;&lt;div&gt;-&nbsp;Each&nbsp;connection&nbsp;for&nbsp;the&nbsp;channel&nbsp;is&nbsp;reachable,&nbsp;is&nbsp;in&nbsp;either&nbsp;a&nbsp;&quot;flow&quot;&nbsp;or&nbsp;&quot;blocked&quot;&nbsp;state&nbsp;with&nbsp;zero&nbsp;data&nbsp;flow.&nbsp;Timeout&nbsp;is&nbsp;set&nbsp;to&nbsp;600s&nbsp;(count&nbsp;doesn't&nbsp;decrease&nbsp;after&nbsp;10&nbsp;minutes)&lt;/div&gt;&lt;div&gt;-&nbsp;Forcing&nbsp;a&nbsp;stuck&nbsp;connection&nbsp;closed&nbsp;through&nbsp;the&nbsp;management&nbsp;interface&nbsp;results&nbsp;in&nbsp;a&nbsp;500:&lt;/div&gt;&lt;div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;The&nbsp;server&nbsp;encountered&nbsp;an&nbsp;error&nbsp;while&nbsp;processing&nbsp;this&nbsp;request:&lt;br&gt;{exit,{normal,{gen_server,&lt;wbr&gt;call,&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;[&amp;lt;0.16806.1347&amp;gt;,&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{shutdown,&quot;Closed&nbsp;via&nbsp;management&nbsp;plugin&quot;},&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;infinity]}},&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;[{gen_server,call,3,[{file,&quot;&lt;wbr&gt;gen_server.erl&quot;},{line,188}]},&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{rabbit_mgmt_wm_connection,&lt;wbr&gt;delete_resource,2,[]},&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{webmachine_resource,&lt;wbr&gt;resource_call,3,[]},&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{webmachine_resource,do,3,[]}&lt;wbr&gt;,&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{webmachine_decision_core,&lt;wbr&gt;resource_call,1,[]},&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{webmachine_decision_core,&lt;wbr&gt;decision,1,[]},&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{webmachine_decision_core,&lt;wbr&gt;handle_request,2,[]},&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{rabbit_webmachine,'-&lt;wbr&gt;makeloop/1-fun-0-',2,[]}]}&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;The&nbsp;connection&nbsp;closure&nbsp;does&nbsp;actually&nbsp;succeed,&nbsp;and&nbsp;the&nbsp;count&nbsp;drops.&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;Forcing&nbsp;a&nbsp;normal&nbsp;connection&nbsp;closed&nbsp;still&nbsp;works&nbsp;correctly.&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;Doing&nbsp;a&nbsp;netstat&nbsp;on&nbsp;both&nbsp;the&nbsp;client&nbsp;and&nbsp;server&nbsp;shows&nbsp;that&nbsp;the&nbsp;port&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection&nbsp;is&nbsp;indeed&nbsp;completely&nbsp;closed,&nbsp;and&nbsp;not&nbsp;in&nbsp;any&nbsp;sort&nbsp;of&nbsp;TIME_WAIT&nbsp;or&nbsp;FIN_WAIT&nbsp;state&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;issue&nbsp;occurred&nbsp;over&nbsp;the&nbsp;weekend,&nbsp;but&nbsp;as&nbsp;it&nbsp;was&nbsp;unchecked&nbsp;it&nbsp;eventually&nbsp;exhausted&nbsp;the&nbsp;server&nbsp;of&nbsp;socket&nbsp;descriptors,&nbsp;and&nbsp;we&nbsp;had&nbsp;to&nbsp;restart&nbsp;RabbitMQ&nbsp;to&nbsp;recover.&nbsp;It's&nbsp;happened&nbsp;again&nbsp;over&nbsp;night.&nbsp;We&nbsp;can't&nbsp;see&nbsp;anything&nbsp;in&nbsp;our&nbsp;client&nbsp;or&nbsp;server&nbsp;logs&nbsp;that&nbsp;give&nbsp;any&nbsp;indication&nbsp;as&nbsp;to&nbsp;the&nbsp;cause&nbsp;of&nbsp;it.&nbsp;We&nbsp;upgraded&nbsp;from&nbsp;3.1.0&nbsp;so&nbsp;unfortunately&nbsp;are&nbsp;unable&nbsp;to&nbsp;determine&nbsp;which&nbsp;version&nbsp;is&nbsp;responsible&nbsp;for&nbsp;the&nbsp;bug,&nbsp;if&nbsp;indeed&nbsp;it&nbsp;is&nbsp;a&nbsp;bug.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;anyone&nbsp;has&nbsp;seen&nbsp;this&nbsp;behaviour&nbsp;or&nbsp;has&nbsp;any&nbsp;suggestions,&nbsp;please&nbsp;let&nbsp;us&nbsp;know.&nbsp;Also,&nbsp;if&nbsp;we&nbsp;can&nbsp;provide&nbsp;any&nbsp;debug&nbsp;data&nbsp;let&nbsp;us&nbsp;know.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Paul&nbsp;Bowsher&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
</tt>
