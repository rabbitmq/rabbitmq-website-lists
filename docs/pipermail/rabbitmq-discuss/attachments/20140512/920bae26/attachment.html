<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thanks&nbsp;Simon,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;tried&nbsp;global&nbsp;as&nbsp;true&nbsp;and&nbsp;false&nbsp;for&nbsp;BasicQoS&nbsp;and&nbsp;see&nbsp;the&nbsp;same&nbsp;behavior.&nbsp; I&#39;ve&nbsp;got&nbsp;some&nbsp;quick&nbsp;example&nbsp;code&nbsp;below&nbsp;that&nbsp;demonstrates&nbsp;the&nbsp;issue&nbsp;I&#39;m&nbsp;having&nbsp;and&nbsp;a&nbsp;zip&nbsp;archive&nbsp;of&nbsp;the&nbsp;project&nbsp;is&nbsp;available&nbsp;&lt;a&nbsp;href=&quot;https://www.dropbox.com/s/x7q9e6ijuxzp9zn/RabbitQoSTest.zip&quot;&gt;here&lt;/a&gt;.&nbsp; I&nbsp;captured&nbsp;network&nbsp;traffic&nbsp;from&nbsp;WireShark&nbsp;and&nbsp;it&nbsp;seems&nbsp;that&nbsp;calling&nbsp;BasicQoS()&nbsp;and&nbsp;increasing&nbsp;the&nbsp;prefetchCount,&nbsp;the&nbsp;qos&nbsp;change&nbsp;gets&nbsp;sent&nbsp;to&nbsp;the&nbsp;server,&nbsp;and&nbsp;the&nbsp;server&nbsp;replies&nbsp;with&nbsp;a&nbsp;qos-ok,&nbsp;but&nbsp;the&nbsp;server&nbsp;doesn&#39;t&nbsp;send&nbsp;more&nbsp;messages&nbsp;if&nbsp;the&nbsp;new&nbsp;prefetch&nbsp;count&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;outstanding&nbsp;message&nbsp;count&nbsp;for&nbsp;the&nbsp;channel.&nbsp; It&#39;s&nbsp;not&nbsp;until&nbsp;I&nbsp;Ack&nbsp;the&nbsp;first&nbsp;message&nbsp;that&nbsp;the&nbsp;second&nbsp;one&nbsp;is&nbsp;sent.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;to&nbsp;me&nbsp;that&nbsp;an&nbsp;Ack&nbsp;from&nbsp;a&nbsp;client&nbsp;is&nbsp;causing&nbsp;the&nbsp;server&nbsp;to&nbsp;look&nbsp;at&nbsp;the&nbsp;queue&nbsp;being&nbsp;consumed&nbsp;and&nbsp;do&nbsp;something&nbsp;like:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if(queue.has-messages&nbsp;&amp;&amp;&nbsp;channel.unacked-messages&nbsp;&lt;&nbsp;channel.prefetch-count)&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp; &nbsp;send-messages-to-channel-until-unacked-equals-prefetch-count(channel)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;For&nbsp;the&nbsp;behavior&nbsp;I&#39;d&nbsp;like&nbsp;to&nbsp;see,&nbsp;it&nbsp;seems&nbsp;like&nbsp;a&nbsp;call&nbsp;to&nbsp;basic.qos&nbsp;would&nbsp;require&nbsp;the&nbsp;same&nbsp;logic.&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;Below&nbsp;is&nbsp;a&nbsp;snippet&nbsp;of&nbsp;my&nbsp;example&nbsp;code.&nbsp; ActionConsumer&nbsp;is&nbsp;a&nbsp;simple&nbsp;IBasicConsumer&nbsp;that&nbsp;invokes&nbsp;the&nbsp;action&nbsp;passed&nbsp;to&nbsp;it&#39;s&nbsp;constructor&nbsp;during&nbsp;HandleBasicDeliver.&nbsp; It&nbsp;also&nbsp;uses&nbsp;a&nbsp;simple&nbsp;extension&nbsp;method&nbsp;to&nbsp;List&lt;T&gt;&nbsp;called&nbsp;WaitFor()&nbsp;which&nbsp;waits&nbsp;for&nbsp;the&nbsp;list&nbsp;to&nbsp;contain&nbsp;the&nbsp;specified&nbsp;number&nbsp;of&nbsp;items.&nbsp; I&#39;ve&nbsp;added&nbsp;comments&nbsp;based&nbsp;on&nbsp;my&nbsp;network&nbsp;capture&nbsp;of&nbsp;this&nbsp;code&nbsp;being&nbsp;executed.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;any&nbsp;help.&nbsp; Right&nbsp;now,&nbsp;I&#39;ve&nbsp;got&nbsp;a&nbsp;pretty&nbsp;ugly&nbsp;workaround,&nbsp;which&nbsp;is&nbsp;that&nbsp;instead&nbsp;of&nbsp;increasing&nbsp;prefetch&nbsp;count&nbsp;and&nbsp;calling&nbsp;basicqos,&nbsp;I&nbsp;just&nbsp;do&nbsp;a&nbsp;basicget,&nbsp;but&nbsp;this&nbsp;is&nbsp;definitely&nbsp;hacky&nbsp;and&nbsp;makes&nbsp;me&nbsp;poll&nbsp;using&nbsp;basicget()&nbsp;on&nbsp;another&nbsp;thread,&nbsp;etc...&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;var&nbsp;consumer&nbsp;=&nbsp;new&nbsp;ActionConsumer(Model,&nbsp;message&nbsp;=&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;Task.Run(()&nbsp;=&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;{&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Log.DebugFormat(&quot;Received({0})&quot;,&nbsp;message);&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;messages.Add(Encoding.UTF8.GetString(message.Body));&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(messages.Count&nbsp;==&nbsp;1)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;message,&nbsp;send&nbsp;a&nbsp;second,&nbsp;set&nbsp;qos&nbsp;to&nbsp;2&nbsp;and&nbsp;wait&nbsp;for&nbsp;second&nbsp;message&nbsp;to&nbsp;arrive&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Send(&quot;World&quot;);&nbsp;//This&nbsp;message&nbsp;gets&nbsp;sent&nbsp;immediately&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Log.Debug(&quot;BasicQoS(0,&nbsp;2,&nbsp;false)&quot;);&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Model.BasicQos(0,&nbsp;2,&nbsp;false);&nbsp;//QoS&nbsp;is&nbsp;sent&nbsp;to&nbsp;server&nbsp;immediately,&nbsp;prefetch&nbsp;shows&nbsp;as&nbsp;2&nbsp;in&nbsp;management&nbsp;console&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Log.Debug(&quot;WaitFor(2,&nbsp;5000)&quot;);&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;messages.WaitFor(2,&nbsp;5000);&nbsp;//While&nbsp;waiting,&nbsp;2nd&nbsp;message&nbsp;will&nbsp;not&nbsp;be&nbsp;received&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Log.DebugFormat(&quot;BasicAck({0},&nbsp;false)&quot;,&nbsp;message.DeliveryTag);&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Model.BasicAck(message.DeliveryTag,&nbsp;false);&nbsp;//As&nbsp;soon&nbsp;as&nbsp;Ack&nbsp;is&nbsp;sent,&nbsp;2nd&nbsp;message&nbsp;is&nbsp;transmitted&nbsp;to&nbsp;client&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;messages.WaitFor(2,&nbsp;2500);&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Log.Debug(&quot;Finished&nbsp;task&nbsp;1&nbsp;processing&quot;);&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;}));&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//Start&nbsp;consuming&lt;/div&gt;&lt;div&gt;Model.BasicConsume(queue,&nbsp;false,&nbsp;consumer);&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &lt;/div&gt;&lt;div&gt;//Send&nbsp;starter&nbsp;message&lt;/div&gt;&lt;div&gt;Send(&quot;Hello&quot;);&lt;/div&gt;&lt;div&gt;var&nbsp;ret&nbsp;=&nbsp;messages.WaitFor(2,&nbsp;15000);&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;May&nbsp;12,&nbsp;2014&nbsp;at&nbsp;4:08&nbsp;AM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;On&nbsp;11/05/2014&nbsp;04:55,&nbsp;Jon&nbsp;Stelly&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;have&nbsp;a&nbsp;sort&nbsp;of&nbsp;odd&nbsp;scenario.&nbsp; I&nbsp;want&nbsp;to&nbsp;process&nbsp;1&nbsp;message&nbsp;at&nbsp;a&nbsp;time&nbsp;so&lt;br&gt;<br>
I&nbsp;call&nbsp;basic&nbsp;qos&nbsp;with&nbsp;a&nbsp;prefetch&nbsp;of&nbsp;1&nbsp;and&nbsp;call&nbsp;BasicConsume(),&nbsp;but&lt;br&gt;<br>
sometimes&nbsp;my&nbsp;processing&nbsp;will&nbsp;end&nbsp;in&nbsp;a&nbsp;long&nbsp;blocking&nbsp;task.&nbsp; When&nbsp;that&lt;br&gt;<br>
happens,&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;increase&nbsp;the&nbsp;qos&nbsp;prefetch&nbsp;to&nbsp;2&nbsp;to&nbsp;trigger&nbsp;the&lt;br&gt;<br>
next&nbsp;message&nbsp;to&nbsp;be&nbsp;received&nbsp;and&nbsp;processed.&nbsp; The&nbsp;issue&nbsp;is&nbsp;that&nbsp;I&nbsp;don&#39;t&lt;br&gt;<br>
want&nbsp;to&nbsp;ack&nbsp;the&nbsp;first&nbsp;message&nbsp;until&nbsp;after&nbsp;the&nbsp;long&nbsp;blocking&nbsp;process&lt;br&gt;<br>
completes&nbsp;successfully.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;I&nbsp;call&nbsp;BasicQoS&nbsp;before&nbsp;acking&nbsp;the&nbsp;first&nbsp;message,&nbsp;the&nbsp;2nd&nbsp;message&lt;br&gt;<br>
isn&#39;t&nbsp;received&nbsp;until&nbsp;after&nbsp;the&nbsp;long&nbsp;running&nbsp;task&nbsp;completes&nbsp;and&nbsp;the&nbsp;ack&lt;br&gt;<br>
is&nbsp;sent.&nbsp; Can&nbsp;anyone&nbsp;explain&nbsp;what&#39;s&nbsp;going&nbsp;on&nbsp;and&nbsp;possibly&nbsp;suggest&nbsp;an&lt;br&gt;<br>
alternative?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
You&nbsp;are&nbsp;running&nbsp;3.3.x?&nbsp;The&nbsp;new&nbsp;semantics&nbsp;for&nbsp;consumer&nbsp;prefetch&nbsp;mean&nbsp;that&nbsp;setting&nbsp;basicQos&nbsp;after&nbsp;consuming&nbsp;will&nbsp;only&nbsp;define&nbsp;a&nbsp;prefetch&nbsp;for&nbsp;*new*&nbsp;consumers.&nbsp;You&nbsp;could&nbsp;work&nbsp;around&nbsp;this&nbsp;by&nbsp;setting&nbsp;global=true.&lt;br&gt;<br>
&lt;br&gt;<br>
See&nbsp;&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/consumer-prefetch.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/&lt;u&gt;&lt;/u&gt;consumer-prefetch.html&lt;/a&gt;&nbsp;for&nbsp;more&nbsp;information.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;am&nbsp;starting&nbsp;to&nbsp;wonder&nbsp;if&nbsp;the&nbsp;global=false&nbsp;qos&nbsp;should&nbsp;set&nbsp;the&nbsp;prefetch&nbsp;for&nbsp;all&nbsp;consumers&nbsp;on&nbsp;the&nbsp;channel;&nbsp;you&nbsp;wouldn&#39;t&nbsp;be&nbsp;able&nbsp;to&nbsp;have&nbsp;one&nbsp;channel&nbsp;with&nbsp;multiple&nbsp;consumers&nbsp;with&nbsp;different&nbsp;prefetch,&nbsp;but&nbsp;this&nbsp;is&nbsp;an&nbsp;area&nbsp;that&nbsp;seems&nbsp;to&nbsp;be&nbsp;unintuitive...&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Cheers,&nbsp;Simon&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
