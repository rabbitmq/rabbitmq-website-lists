<tt>
&lt;div&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;&quot;&gt;Matthew,&lt;/div&gt;&lt;div&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;font-family:&nbsp;arial;&nbsp;font-size:&nbsp;small;&nbsp;&quot;&gt;<br>
&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;font-family:&nbsp;arial;&nbsp;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;&quot;&gt;&amp;gt; &lt;/span&gt;&lt;/font&gt;&lt;span&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;&quot;&gt;This&nbsp;is&nbsp;very&nbsp;impressive&nbsp;for&nbsp;a&nbsp;first&nbsp;hack&nbsp;on&nbsp;Rabbit.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;font-family:&nbsp;arial;&nbsp;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;&quot;&gt;Thanks,&nbsp;I&amp;#39;m&nbsp;flattered!&nbsp;:)&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;font-family:&nbsp;arial;&nbsp;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;&quot;&gt;I&nbsp;tried&nbsp;to&nbsp;follow&nbsp;your&nbsp;comments&nbsp;to&nbsp;improve&nbsp;the&nbsp;code...&lt;/span&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;span&nbsp;style=&quot;border-collapse:collapse;font-family:arial,&nbsp;sans-serif;font-size:13px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;border-collapse:collapse;font-family:arial,&nbsp;sans-serif;font-size:13px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;&amp;gt;&nbsp;I&nbsp;would&nbsp;imagine&nbsp;you&amp;#39;re&nbsp;missing&nbsp;a&nbsp;diff&nbsp;here:&nbsp;surely&nbsp;the&nbsp;handle_call&nbsp;in&lt;/span&gt;&lt;/font&gt;&lt;br&gt;<br>
&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;&amp;gt;&nbsp;amqqueue_process&nbsp;for&nbsp;the&nbsp;mandatory&nbsp;delivery&nbsp;that&nbsp;should&nbsp;be&nbsp;returning&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;<br>
&amp;gt;&nbsp;true|spy?&lt;/span&gt;&lt;/font&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;border-collapse:collapse&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;border-collapse:collapse&quot;&gt;You&amp;#39;re&nbsp;right!&nbsp;I&nbsp;forgot&nbsp;to&nbsp;post&nbsp;that&nbsp;piece,&nbsp;here&nbsp;to&nbsp;everything&amp;#39;s&nbsp;not&nbsp;working&nbsp;that&nbsp;well...&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;border-collapse:collapse&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;border-collapse:collapse&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;My&nbsp;final&nbsp;list&nbsp;of&nbsp;changes&nbsp;:&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;border-collapse:collapse&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;div&gt;&lt;i&gt;&lt;span&nbsp;style=&quot;font-style:&nbsp;normal;&nbsp;&quot;&gt;&lt;b&gt;rabbit.hrl&nbsp;:&lt;/b&gt;&lt;/span&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;(edition&nbsp;of&nbsp;the&nbsp;amqqueue&nbsp;record,&nbsp;line&nbsp;47)&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;  &nbsp; &nbsp;-record(amqqueue,&nbsp;{name,&nbsp;durable,&nbsp;auto_delete,&nbsp;exclusive_owner&nbsp;=&nbsp;none, &lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;spy=false,&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;arguments,&nbsp;pid}).&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;b&gt;rabbit_amqqueue.erl&nbsp;:&lt;/b&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;<br>
&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;i&gt;(line&nbsp;115,&nbsp;spec&nbsp;of&nbsp;deliver/2&nbsp;edited&nbsp;)&lt;/i&gt;&lt;/div&gt;&lt;blockquote&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;40px;&nbsp;border-top-style:&nbsp;none;&nbsp;border-right-style:&nbsp;none;&nbsp;border-bottom-style:&nbsp;none;&nbsp;border-left-style:&nbsp;none;&nbsp;border-width:&nbsp;initial;&nbsp;border-color:&nbsp;initial;&nbsp;padding-top:&nbsp;0px;&nbsp;padding-right:&nbsp;0px;&nbsp;padding-bottom:&nbsp;0px;&nbsp;padding-left:&nbsp;0px;&nbsp;font-weight:&nbsp;normal;&nbsp;&quot;&gt;<br>
&lt;div&gt;&lt;i&gt; -spec(deliver/2&nbsp;::&nbsp;(pid(),&nbsp;rabbit_types:delivery())&nbsp;-&amp;gt;&nbsp;boolean()&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;|&amp;#39;spy&amp;#39;&lt;/font&gt;).&lt;/i&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;i&gt;(edition&nbsp;of&nbsp;rabbit_amqqueue:deliver/2)&lt;/i&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;div&gt;  &nbsp; &nbsp;deliver(QPid,&nbsp;Delivery&nbsp;=&nbsp;#delivery{immediate&nbsp;=&nbsp;true})&nbsp;-&amp;gt;&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; gen_server2:call(QPid,&nbsp;{deliver_immediately,&nbsp;Delivery},&nbsp;infinity);&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp;deliver(QPid,&nbsp;Delivery&nbsp;=&nbsp;#delivery{mandatory&nbsp;=&nbsp;true})&nbsp;-&amp;gt;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;case&nbsp;gen_server2:call(QPid,&nbsp;{deliver,&nbsp;Delivery},&nbsp;infinity)&nbsp;of&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;spy&nbsp;-&amp;gt;&nbsp;spy;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_&nbsp;-&amp;gt;&nbsp;true&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; end;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp;deliver(QPid,&nbsp;Delivery)&nbsp;-&amp;gt;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; gen_server2:cast(QPid,&nbsp;{deliver,&nbsp;Delivery}),&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; true.&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;rabbit_amqqueue_process.erl&nbsp;:&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;i&gt;(edition&nbsp;of&nbsp;rabbit_amqqueue_process:declare/3)&lt;/i&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;div&gt;<br>
declare(Recover,&nbsp;From, &lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State&nbsp;=&nbsp;#q{q&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt; =&nbsp;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#CC0000&quot;&gt;Qparam&lt;/font&gt;&nbsp;=&nbsp;#amqqueue{ &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;name&nbsp;=&nbsp;QName, &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;durable&nbsp;=&nbsp;IsDurable&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;, &lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;arguments&nbsp;=&nbsp;Args&lt;/font&gt; &lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;},&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; backing_queue&nbsp;=&nbsp;BQ, &lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;backing_queue_state&nbsp;=&nbsp;undefined,&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stats_timer&nbsp;=&nbsp;StatsTimer &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;small;&nbsp;&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;display:&nbsp;inline&nbsp;!important;&nbsp;&quot;&gt;})&nbsp;-&amp;gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;  &nbsp; &lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;Spy&nbsp;=&nbsp;case&nbsp;rabbit_misc:table_lookup(Args,&nbsp;&amp;lt;&amp;lt;&amp;quot;spy&amp;quot;&amp;gt;&amp;gt;)&nbsp;of &lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;{&amp;#39;bool&amp;#39;,&nbsp;true}&nbsp;-&amp;gt;&nbsp;true;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_&nbsp;-&amp;gt;&nbsp;false&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;  &nbsp; end,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;  &nbsp; Q&nbsp;=&nbsp;Qparam#amqqueue{&nbsp;spy&nbsp;=&nbsp;Spy},&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;  &nbsp; &lt;/font&gt;case&nbsp;rabbit_amqqueue:internal_declare(Q,&nbsp;Recover)&nbsp;of&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; not_found&nbsp;-&amp;gt;&nbsp;{stop,&nbsp;normal,&nbsp;not_found,&nbsp;State};&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; Q&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&amp;gt;&nbsp;gen_server2:reply(From,&nbsp;{new,&nbsp;Q}),&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ok&nbsp;=&nbsp;file_handle_cache:register_callback(&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rabbit_amqqueue,&nbsp;set_maximum_since_use,&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [self()]),&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ok&nbsp;=&nbsp;rabbit_memory_monitor:register(&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self(),&nbsp;{rabbit_amqqueue,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set_ram_duration_target,&nbsp;[self()]}),&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BQS&nbsp;=&nbsp;bq_init(BQ,&nbsp;QName,&nbsp;IsDurable,&nbsp;Recover),&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;State1&nbsp;=&nbsp;process_args(State#q{backing_queue_state&nbsp;=&nbsp;BQS,&nbsp;q=Q}),&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rabbit_event:notify(queue_created,&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;infos(?CREATION_EVENT_KEYS,&nbsp;State1)),&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rabbit_event:if_enabled(StatsTimer,&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fun()&nbsp;-&amp;gt;&nbsp;emit_stats(State1)&nbsp;end),&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;noreply(State1);&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; Q1&nbsp; &nbsp; &nbsp; &nbsp; -&amp;gt;&nbsp;{stop,&nbsp;normal,&nbsp;{existing,&nbsp;Q1},&nbsp;State}&lt;/div&gt;&lt;div&gt;  &nbsp; end.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;(&nbsp;edition&nbsp;of&nbsp;rabbit_amqqueue_procces:handle_call({deliver,&nbsp;_}&nbsp;...,&nbsp;line&nbsp;846&nbsp;)&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;handle_call({deliver,&nbsp;Delivery},&nbsp;From,&nbsp;State)&nbsp;-&amp;gt;&lt;/div&gt;&lt;div&gt;  &nbsp; %%&nbsp;Synchronous,&nbsp;&amp;quot;mandatory&amp;quot;&nbsp;delivery&nbsp;mode.&nbsp;Reply&nbsp;asap.&lt;/div&gt;&lt;div&gt;  &nbsp;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt; case&nbsp;(State#q.q)#amqqueue.spy&nbsp;of&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;true&nbsp; -&amp;gt;&nbsp;gen_server2:reply(From,&nbsp;spy);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;false&nbsp;-&amp;gt;&nbsp;gen_server2:reply(From,&nbsp;true)&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;  &nbsp; end,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;  &nbsp; noreply(deliver_or_enqueue(Delivery,&nbsp;State));&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;i&gt;&lt;span&nbsp;style=&quot;font-style:&nbsp;normal;&nbsp;&quot;&gt;&lt;b&gt;rabbit_amqqueue_router.erl&nbsp;:&lt;/b&gt;&lt;/span&gt;&lt;/i&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;i&gt;(edition&nbsp;of&nbsp;rabbit_router:fold_deliveries/2,&nbsp;line&nbsp;105)&lt;/i&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp;fold_deliveries({Pid,&nbsp;true},{_,&nbsp;Handled})&nbsp;-&amp;gt;&nbsp;{true,&nbsp;[Pid|Handled]};&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;color=&quot;#CC0000&quot;&gt;  &nbsp; &nbsp;&lt;/font&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#FF0000&quot;&gt;fold_deliveries({_,&nbsp; spy},&nbsp;{false,&nbsp;Handled})&nbsp;-&amp;gt;&nbsp;{false,&nbsp;Handled};&lt;/font&gt;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp;fold_deliveries({_,&nbsp; _},{_,&nbsp;Handled})&nbsp;-&amp;gt;&nbsp;{true,&nbsp;Handled}.&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&nbsp;style=&quot;font-weight:&nbsp;normal;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;I&nbsp;encountered&nbsp;no&nbsp;problem&nbsp;for&nbsp;the&nbsp;moment,&nbsp;testing&nbsp;that&nbsp;feature&nbsp;with&nbsp;the&nbsp;java&nbsp;API.&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Mar&nbsp;25,&nbsp;2011&nbsp;at&nbsp;4:04&nbsp;PM,&nbsp;Matthew&nbsp;Sackman&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthew@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;matthew@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&gt;On&nbsp;Fri,&nbsp;Mar&nbsp;25,&nbsp;2011&nbsp;at&nbsp;02:58:43PM&nbsp;+0000,&nbsp;Matthew&nbsp;Sackman&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&nbsp;I&amp;#39;d&nbsp;probably&nbsp;bring&nbsp;that&nbsp;out&nbsp;to&nbsp;a&nbsp;Spy&nbsp;variable.&nbsp;Also,&nbsp;take&nbsp;a&nbsp;look&nbsp;at&lt;br&gt;<br>
&amp;gt;&nbsp;rabbit_misc:table_lookup/2.&nbsp;Also,&nbsp;you&nbsp;might&nbsp;want&nbsp;to&nbsp;delay&nbsp;that&lt;br&gt;<br>
&amp;gt;&nbsp;inspection&nbsp;until&nbsp;you&amp;#39;re&nbsp;in&nbsp;amqqueue_process:delay&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Erm,&nbsp;I&nbsp;meant&nbsp;amqqueue_process:declare&nbsp;there.&nbsp;Fingers&nbsp;don&amp;#39;t&nbsp;work...&lt;br&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
Matthew&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
