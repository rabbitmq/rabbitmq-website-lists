<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hello,&nbsp;Emile&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;very&nbsp;much&nbsp;for&nbsp;you&nbsp;help.&nbsp;I&nbsp;will&nbsp;try&nbsp;to&nbsp;provide&nbsp;anything&nbsp;what&nbsp;can&nbsp;help&nbsp;to&nbsp;solve&nbsp;this&nbsp;issue. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;The&nbsp;difference&nbsp;between&nbsp;1Mb&nbsp;and&nbsp;180Mb&nbsp;is&nbsp;relatively&nbsp;large,&nbsp;even&nbsp;after&lt;br&gt;<br>
taking&nbsp;expected&nbsp;differences&nbsp;due&nbsp;to&nbsp;garbage&nbsp;collection&nbsp;into&nbsp;account.&nbsp;We&lt;br&gt;<br>
can&amp;#39;t&nbsp;rule&nbsp;out&nbsp;a&nbsp;memory&nbsp;leak,&nbsp;but&nbsp;need&nbsp;some&nbsp;assistance&nbsp;from&nbsp;you&nbsp;to&nbsp;confirm.&lt;br&gt;<br>
&lt;br&gt;<br>
Do&nbsp;you&nbsp;see&nbsp;the&nbsp;same&nbsp;asymmetry&nbsp;if&nbsp;the&nbsp;master&nbsp;node&nbsp;for&nbsp;the&nbsp;queues&nbsp;switch&lt;br&gt;<br>
from&nbsp;one&nbsp;node&nbsp;to&nbsp;the&nbsp;other?&nbsp;So&nbsp;if&nbsp;you&nbsp;shut&nbsp;the&nbsp;cdaemon2&nbsp;node,&nbsp;let&lt;br&gt;<br>
cdaemon4&nbsp;become&nbsp;the&nbsp;master&nbsp;for&nbsp;all&nbsp;the&nbsp;queue,&nbsp;turn&nbsp;cdaemon2&nbsp;back&nbsp;on&nbsp;(it&lt;br&gt;<br>
will&nbsp;now&nbsp;be&nbsp;a&nbsp;slave&nbsp;node)&nbsp;does&nbsp;the&nbsp;memory&nbsp;on&nbsp;cdaemon2&nbsp;now&nbsp;grow?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;after&nbsp;current&nbsp;master&nbsp;stops&nbsp;and&nbsp;starts&nbsp;it&nbsp;becomes&nbsp;slave&nbsp;and&nbsp;its&nbsp;memory&nbsp;starts&nbsp;to&nbsp;grow.&lt;/div&gt;&lt;div&gt;Meantime&nbsp;new&nbsp;selected&nbsp;master&nbsp;memory&nbsp;does&nbsp;not&nbsp;become&nbsp;free.&nbsp;So&nbsp;new&nbsp;master&nbsp;memory&nbsp;stops&nbsp;to&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;grow&nbsp;but&nbsp;do&nbsp;not&nbsp;fall&nbsp;back&nbsp;to&nbsp;normal.&nbsp;I&nbsp;have&nbsp;attached&nbsp;memory&nbsp;graphs&nbsp;of&nbsp;our&nbsp;nodes&nbsp;to&nbsp;this&nbsp;letter.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&gt;<br>
Have&nbsp;you&nbsp;been&nbsp;able&nbsp;to&nbsp;add&nbsp;a&nbsp;third&nbsp;node&nbsp;to&nbsp;the&nbsp;cluster&nbsp;for&nbsp;testing&lt;br&gt;<br>
purposes&nbsp;to&nbsp;see&nbsp;if&nbsp;memory&nbsp;grows&nbsp;on&nbsp;more&nbsp;than&nbsp;one&nbsp;slave&nbsp;node?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;not&nbsp;tied&nbsp;to&nbsp;do&nbsp;this&nbsp;yet.&nbsp;But&nbsp;if&nbsp;it&nbsp;can&nbsp;help&nbsp;we&nbsp;can&nbsp;allocate&nbsp;one&nbsp;more&nbsp;node.&lt;/div&gt;&lt;div&gt;Is&nbsp;is&nbsp;ok&nbsp;to&nbsp;create&nbsp;test&nbsp;node&nbsp;at&nbsp;the&nbsp;same&nbsp;physical&nbsp;host&nbsp;as&nbsp;one&nbsp;of&nbsp;existing&nbsp;nodes?&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
How&nbsp;long&nbsp;does&nbsp;it&nbsp;take&nbsp;for&nbsp;the&nbsp;memory&nbsp;use&nbsp;to&nbsp;reach&nbsp;the&nbsp;VM&nbsp;memory&nbsp;high&lt;br&gt;<br>
watermark? &lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Critical&nbsp;point&nbsp;for&nbsp;our&nbsp;cluster&nbsp;comes&nbsp;much&nbsp;more&nbsp;earlier&nbsp;than&nbsp;VM&nbsp;memory&nbsp;high&nbsp;watermark.&lt;/div&gt;&lt;div&gt;The&nbsp;same&nbsp;time&nbsp;with&nbsp;memory&nbsp;grow&nbsp;slave&nbsp;node&nbsp;starts&nbsp;to&nbsp;use&nbsp;CPU&nbsp;more&nbsp;and&nbsp;more&nbsp;active.&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;In&nbsp;our&nbsp;case&nbsp;when&nbsp;memory&nbsp;consumption&nbsp;reaches&nbsp;~1Gb&nbsp;broker&nbsp;stops&nbsp;to&nbsp;respond.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;slave&nbsp;restart&nbsp;memory&nbsp;grows&nbsp;linearily&nbsp;some&nbsp;time.&nbsp;After&nbsp;that&nbsp;memory&nbsp;grow&nbsp;changes&nbsp;its&nbsp;pattern.&lt;/div&gt;<br>
&lt;div&gt;At&nbsp;some&nbsp;moments&nbsp;it&nbsp;increases&nbsp;by&nbsp;constant&nbsp;step&nbsp;(~20Mb).&nbsp;I&nbsp;have&nbsp;marked&nbsp;these&nbsp;steps&nbsp;on&nbsp;graphs&nbsp;attached. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&gt;<br>
Can&nbsp;you&nbsp;describe&nbsp;your&nbsp;messaging&nbsp;pattern&nbsp;in&nbsp;a&nbsp;bit&nbsp;more&nbsp;detail&nbsp;for&nbsp;us&nbsp;to&lt;br&gt;<br>
reproduce&nbsp;the&nbsp;problem&nbsp;-&nbsp;how&nbsp;often&nbsp;are&nbsp;new&nbsp;channels&nbsp;created&nbsp;when&nbsp;publishing?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Queues&nbsp;and&nbsp;exchanges:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1&nbsp;queue&nbsp;and&nbsp;1&nbsp;exchange&nbsp;(Durable,&nbsp;ha-mode:&nbsp;all,&nbsp;no&nbsp;autodelete). &lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Publishers:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;about&nbsp;100&nbsp;web&nbsp;servers&nbsp;which&nbsp;publish&nbsp;messages&nbsp;by&nbsp;next&nbsp;steps:&lt;/div&gt;&lt;div&gt;1)&nbsp;Open&nbsp;connection&lt;/div&gt;&lt;div&gt;2)&nbsp;Create&nbsp;channel&lt;/div&gt;&lt;div&gt;<br>
3)&nbsp;Publish&nbsp;message&nbsp;to&nbsp;direct&nbsp;exchange&lt;/div&gt;&lt;div&gt;4)&nbsp;close&nbsp;connection&lt;/div&gt;&lt;div&gt;Publishing&nbsp;rate&nbsp;is&nbsp;between&nbsp;50&nbsp;and&nbsp;600&nbsp;messages&nbsp;per&nbsp;second&nbsp;at&nbsp;peak&nbsp;hours. &lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;attached&nbsp;graph.&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;Consumers:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;3&nbsp;servers&nbsp;consuming&nbsp;messages&nbsp;in&nbsp;30&nbsp;threads&nbsp;each.&lt;/div&gt;&lt;div&gt;Each&nbsp;consuming&nbsp;thread&lt;/div&gt;&lt;div&gt;1)&nbsp;Thread&nbsp;starts&lt;/div&gt;&lt;div&gt;2)&nbsp;Open&nbsp;broker&nbsp;connection&lt;/div&gt;<br>
&lt;div&gt;3)&nbsp;Create&nbsp;channel&lt;/div&gt;&lt;div&gt;4)&nbsp;Get&nbsp;message&nbsp;from&nbsp;the&nbsp;queue&nbsp;by&nbsp;basic-get&nbsp;with&nbsp;prefetch=1&lt;/div&gt;&lt;div&gt;5)&nbsp;Process&nbsp;message&nbsp;and&nbsp;acknowledge&nbsp;it.&lt;/div&gt;&lt;div&gt;6)&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;new&nbsp;messages&nbsp;sleep&nbsp;some&nbsp;time&lt;/div&gt;<br>
&lt;div&gt;7)&nbsp;repeat&nbsp;steps&nbsp;4,5,6&nbsp;until&nbsp;limit&nbsp;count&nbsp;is&nbsp;reached&lt;/div&gt;&lt;div&gt;8)&nbsp;Close&nbsp;connection&lt;/div&gt;&lt;div&gt;9)&nbsp;Thread&nbsp;stops&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&gt;<br>
In&nbsp;order&nbsp;to&nbsp;investigate&nbsp;further&nbsp;it&nbsp;might&nbsp;be&nbsp;helpful&nbsp;to&nbsp;execute&nbsp;some&lt;br&gt;<br>
diagnostic&nbsp;commands&nbsp;on&nbsp;the&nbsp;broker.&nbsp;Are&nbsp;you&nbsp;able&nbsp;to&nbsp;replicate&nbsp;the&nbsp;problem&lt;br&gt;<br>
in&nbsp;a&nbsp;staging&nbsp;or&nbsp;QA&nbsp;environment&nbsp;where&nbsp;it&nbsp;is&nbsp;safe&nbsp;to&nbsp;do&nbsp;this?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;will&nbsp;execute&nbsp;diagnostic&nbsp;commands&nbsp;on&nbsp;the&nbsp;broker.&nbsp;If&nbsp;something&nbsp;goes&nbsp;wrong&nbsp;our&nbsp;messaging&lt;/div&gt;&lt;div&gt;falls&nbsp;back&nbsp;to&nbsp;version&nbsp;without&nbsp;rabbitMQ&nbsp;involved&nbsp;).&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;span&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
<br>
-Emile&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Kind&nbsp;regards,&lt;/div&gt;&lt;div&gt;Dmitry&nbsp;Saprykin &lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
