<tt>
&lt;p&gt;The&nbsp;name&nbsp;of&nbsp;the&nbsp;example&nbsp;is&nbsp;probably&nbsp;a&nbsp;little&nbsp;misleading,&nbsp;in&nbsp;that&nbsp;it&nbsp;simply&nbsp;allows&nbsp;you&nbsp;to&nbsp;know&nbsp;if&nbsp;messages&nbsp;may&nbsp;have&nbsp;been&nbsp;lost,&nbsp;but&nbsp;does&nbsp;nothing&nbsp;to&nbsp;cope&nbsp;with&nbsp;eventually&nbsp;lost&nbsp;messages.&lt;br&gt;<br>
You&nbsp;indeed&nbsp;have&nbsp;to&nbsp;implement&nbsp;a&nbsp;confirm&nbsp;listener&nbsp;and&nbsp;set&nbsp;up&nbsp;republishing&nbsp;yourself.&nbsp;Also,&nbsp;by&nbsp;definition&nbsp;republishing&nbsp;unconfirmed&nbsp;messages&nbsp;may&nbsp;lead&nbsp;to&nbsp;duplicate&nbsp;messages.&lt;/p&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Feb&nbsp;1,&nbsp;2012&nbsp;1:27&nbsp;AM,&nbsp;&amp;quot;Pablo&nbsp;Molnar&amp;quot;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:pablomolnar@gmail.com&quot;&gt;pablomolnar@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&nbsp;type=&quot;attribution&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Ok...so&nbsp;I&amp;#39;m&nbsp;maybe&nbsp;confused.&nbsp;Basically&nbsp;I&nbsp;follow&nbsp;this&nbsp;example:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;http://hg.rabbitmq.com/rabbitmq-java-client/file/default/test/src/com/rabbitmq/examples/ConfirmDontLoseMessages.java&quot;&nbsp;target=&quot;_blank&quot;&gt;http://hg.rabbitmq.com/rabbitmq-java-client/file/default/test/src/com/rabbitmq/examples/ConfirmDontLoseMessages.java&lt;/a&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Using&nbsp;the&nbsp;sentences &lt;span&nbsp;style=&quot;background-color:rgb(237,236,230);font-family:monospace;font-size:12px&quot;&gt;ch.confirmSelect(); &lt;/span&gt;and &lt;span&nbsp;style=&quot;background-color:rgb(237,236,230);font-size:12px&quot;&gt;ch.waitForConfirmsOrDie();&nbsp; &lt;/span&gt;all&nbsp;in&nbsp;a&nbsp;durable&nbsp;queue.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;example&nbsp;doesn&amp;#39;t&nbsp;cover&nbsp;republishing&nbsp;nacks? Do&nbsp;you&nbsp;have&nbsp;an&nbsp;example?&nbsp;I&nbsp;have&nbsp;to&nbsp;implement&nbsp;a &lt;span&nbsp;style=&quot;line-height:18px;text-align:left;color:rgb(85,85,85);font-size:13px&quot;&gt;ConfirmListener?&lt;/span&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:18px;text-align:left;color:rgb(85,85,85);font-size:13px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;Thanks&nbsp;for&nbsp;helping&nbsp;Simone!&lt;div&gt;&lt;br&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jan&nbsp;31,&nbsp;2012&nbsp;at&nbsp;8:43&nbsp;PM,&nbsp;Simone&nbsp;Busoli&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simone.busoli@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;simone.busoli@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;p&gt;Hi&nbsp;Pablo,&nbsp;looking&nbsp;at&nbsp;your&nbsp;code&nbsp;I&nbsp;can&amp;#39;t&nbsp;see&nbsp;where&nbsp;you&nbsp;are&nbsp;republishing&nbsp;messages&nbsp;which&nbsp;have&nbsp;not&nbsp;been&nbsp;confirmed&nbsp;by&nbsp;the&nbsp;broker.&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;make&nbsp;sure&nbsp;that&nbsp;publishes&nbsp;will&nbsp;eventually&nbsp;be&nbsp;delivered&nbsp;you&nbsp;have&nbsp;to&nbsp;keep&nbsp;track&nbsp;of&nbsp;them&nbsp;and&nbsp;re-issue&nbsp;them&nbsp;in&nbsp;case&nbsp;an&nbsp;ack&nbsp;doesn&amp;#39;t&nbsp;arrive&nbsp;from&nbsp;the&nbsp;broker,&nbsp;which&nbsp;usually&nbsp;happens&nbsp;when&nbsp;the&nbsp;broker&nbsp;dies.&lt;/p&gt;<br>
<br>
<br>
<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Jan&nbsp;31,&nbsp;2012&nbsp;11:52&nbsp;PM,&nbsp;&amp;quot;Pablo&nbsp;Molnar&amp;quot;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:pablomolnar@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;pablomolnar@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&nbsp;type=&quot;attribution&quot;&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&gt;&lt;div&gt;<br>
Hi&nbsp;all!&lt;br&gt;&lt;br&gt;I&amp;#39;m&nbsp;doing&nbsp;some&nbsp;HA&nbsp;tests&nbsp;stressing&nbsp;my&nbsp;cluster&nbsp;and&nbsp;I&amp;#39;m&nbsp;experimenting&nbsp;lost&nbsp;messages&nbsp;ONLY&nbsp;when&nbsp;the&nbsp;publisher&nbsp;lost&nbsp;the&nbsp;connection&nbsp;due&nbsp;a&nbsp;kill&nbsp;-9.&lt;br&gt;&lt;br&gt;&lt;b&gt;Test&nbsp;OK&lt;/b&gt;:&nbsp;Kill&nbsp;node&nbsp;while&nbsp;consuming:&lt;br&gt;1&nbsp;-&nbsp;Setup&nbsp;a&nbsp;clean&nbsp;3&nbsp;node&amp;#39;s&nbsp;cluster&lt;br&gt;<br>
<br>
<br>
<br>
2&nbsp;-&nbsp;Execute&nbsp;producer&nbsp;with&nbsp;10.000&nbsp;messages&nbsp;connected&nbsp;to&nbsp;node&nbsp;A&lt;br&gt;3&nbsp;-&nbsp;Wait&nbsp;producer&nbsp;to&nbsp;finish&lt;br&gt;4&nbsp;-&nbsp;Execute&nbsp;consumer&nbsp;connected&nbsp;to&nbsp;node&nbsp;A&lt;br&gt;5&nbsp;-&nbsp;While&nbsp;consumer&nbsp;is&nbsp;running&nbsp;kill&nbsp;node&nbsp;A&lt;br&gt;&lt;br&gt;Result:&nbsp;The&nbsp;consumer&nbsp;reconnects&nbsp;to&nbsp;another&nbsp;node&nbsp;and&nbsp;consume&nbsp;the&nbsp;rest&nbsp;of&nbsp;messages&nbsp;ok.&nbsp;All&nbsp;10.000&nbsp;messages&nbsp;were&nbsp;consumed&nbsp;ok.&lt;br&gt;<br>
<br>
<br>
<br>
&lt;br&gt;&lt;b&gt;Test&nbsp;FAILED&lt;/b&gt;:&nbsp;Kill&nbsp;node&nbsp;while&nbsp;producing:&lt;br&gt;<br>
1&nbsp;-&nbsp;Setup&nbsp;a&nbsp;clean&nbsp;3&nbsp;node&amp;#39;s&nbsp;cluster&lt;br&gt;2&nbsp;-&nbsp;Execute&nbsp;consumer&nbsp;to&nbsp;start&nbsp;listening&nbsp;connected&nbsp;node&nbsp;A&lt;br&gt;3&nbsp;-&nbsp;Execute&nbsp;producer&nbsp;with&nbsp;10.000&nbsp;messages&nbsp;connected&nbsp;to&nbsp;node&nbsp;A&lt;br&gt;<br>
4&nbsp;-&nbsp;While&nbsp;producer&nbsp;is&nbsp;running&nbsp;kill&nbsp;node&nbsp;A&lt;br&gt;<br>
&lt;br&gt;<br>
Result:&nbsp;The&nbsp;producer&nbsp;reconnects&nbsp;fine&nbsp;(the&nbsp;consumer&nbsp;too)&nbsp;and&nbsp;keep&nbsp;publishing&nbsp;but&nbsp;some&nbsp;of&nbsp;the&nbsp;messages&lt;b&gt;&nbsp;already&nbsp;published&lt;/b&gt;&nbsp;to&nbsp;node&nbsp;A&nbsp;are&nbsp;lost.&lt;br&gt;&lt;br&gt;&lt;br&gt;These&nbsp;are&nbsp;my&nbsp;settings:&lt;br&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;rabbitmqctl&nbsp;status&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;Status&nbsp;of&nbsp;node&nbsp;&amp;#39;rabbit@i-00000007-asm&amp;#39;&nbsp;...&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;[{pid,11339},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; {running_applications,&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;    &nbsp;[{rabbitmq_management,&amp;quot;RabbitMQ&nbsp;Management&nbsp;Console&amp;quot;,&amp;quot;2.7.1&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{rabbitmq_management_agent,&amp;quot;RabbitMQ&nbsp;Management&nbsp;Agent&amp;quot;,&amp;quot;2.7.1&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{amqp_client,&amp;quot;RabbitMQ&nbsp;AMQP&nbsp;Client&amp;quot;,&amp;quot;2.7.1&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{rabbit,&amp;quot;RabbitMQ&amp;quot;,&amp;quot;2.7.1&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{os_mon,&amp;quot;CPO &nbsp;CXC&nbsp;138&nbsp;46&amp;quot;,&amp;quot;2.2.4&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{sasl,&amp;quot;SASL &nbsp;CXC&nbsp;138&nbsp;11&amp;quot;,&amp;quot;2.1.8&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{rabbitmq_mochiweb,&amp;quot;RabbitMQ&nbsp;Mochiweb&nbsp;Embedding&amp;quot;,&amp;quot;2.7.1&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{webmachine,&amp;quot;webmachine&amp;quot;,&amp;quot;1.7.0-rmq2.7.1-hg&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{mochiweb,&amp;quot;MochiMedia&nbsp;Web&nbsp;Server&amp;quot;,&amp;quot;1.3-rmq2.7.1-git&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{inets,&amp;quot;INETS &nbsp;CXC&nbsp;138&nbsp;49&amp;quot;,&amp;quot;5.2&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{mnesia,&amp;quot;MNESIA &nbsp;CXC&nbsp;138&nbsp;12&amp;quot;,&amp;quot;4.4.12&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{stdlib,&amp;quot;ERTS &nbsp;CXC&nbsp;138&nbsp;10&amp;quot;,&amp;quot;1.16.4&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{kernel,&amp;quot;ERTS &nbsp;CXC&nbsp;138&nbsp;10&amp;quot;,&amp;quot;2.13.4&amp;quot;}]},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; {os,{unix,linux}},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; {erlang_version,&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;    &nbsp;&amp;quot;Erlang&nbsp;R13B03&nbsp;(erts-5.7.4)&nbsp;[source]&nbsp;[64-bit]&nbsp;[smp:2:2]&nbsp;[rq:2]&nbsp;[async-threads:0]&nbsp;[hipe]&nbsp;[kernel-poll:false]\n&amp;quot;},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; {memory,&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;    &nbsp;[{total,92565608},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{processes,4004968},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{processes_used,3996224},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{system,88560640},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{atom,1322033},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{atom_used,1291462},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{binary,32496},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{code,15264387},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;     &nbsp;{ets,1174192}]},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; {vm_memory_high_watermark,0.3999999999362281},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; {vm_memory_limit,&lt;a&nbsp;href=&quot;tel:2508940902&quot;&nbsp;value=&quot;+12508940902&quot;&nbsp;target=&quot;_blank&quot;&gt;2508940902&lt;/a&gt;}]&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;...done.&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;rabbitmqctl&nbsp;cluster_status&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;Cluster&nbsp;status&nbsp;of&nbsp;node&nbsp;&amp;#39;rabbit@i-00000007-asm&amp;#39;&nbsp;...&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;[{nodes,[{disc,[&amp;#39;rabbit@i-0000001a-zsm&amp;#39;,&amp;#39;rabbit@i-00000007-asm&amp;#39;]},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;        &nbsp;{ram,[&amp;#39;rabbit@i-00000009-asm&amp;#39;]}]},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; {running_nodes,[&amp;#39;rabbit@i-0000001a-zsm&amp;#39;,&amp;#39;rabbit@i-00000007-asm&amp;#39;]}]&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;...done.&lt;/span&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;&lt;br&gt;Java&nbsp;amqp-client&nbsp;2.7.1&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;-&nbsp;Producer.groovy&nbsp;(java&nbsp;amqp-client&nbsp;2.7.1)&lt;br&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;import&nbsp;com.rabbitmq.client.*&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;try{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;//&nbsp;Get&nbsp;rabbitmq&nbsp;config&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;def&nbsp;config&nbsp;=&nbsp;new&nbsp;ConfigSlurper().parse(new&nbsp;File(&amp;#39;../rabbitmq.properties&amp;#39;).toURL())&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;def&nbsp;rabbit&nbsp;=&nbsp;new&nbsp;RabbitHA(config)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;rabbit.init&nbsp;=&nbsp;{&nbsp;channel&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;channel.exchangeDeclare(&amp;#39;myExchange&amp;#39;,&nbsp;&amp;quot;direct&amp;quot;,&nbsp;true)&nbsp;//&nbsp;Durable&nbsp;exchange&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;channel.queueDeclare(&amp;#39;myQueue&amp;#39;,&nbsp;true,&nbsp;false,&nbsp;false,&nbsp;[&amp;quot;x-ha-policy&amp;quot;:&nbsp;&amp;quot;all&amp;quot;])&nbsp;//&nbsp;Durable&nbsp;exchange&nbsp;and&nbsp;HA&nbsp;policy&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;channel.queueBind(&amp;#39;myQueue&amp;#39;,&nbsp;&amp;#39;myExchange&amp;#39;,&nbsp;&amp;#39;&amp;#39;)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;channel.confirmSelect()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;10000.times&nbsp;{&nbsp;idx&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;rabbit.publish&nbsp;{&nbsp;channel&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;def&nbsp;properties&nbsp;=&nbsp;new&nbsp;AMQP.BasicProperties.Builder().deliveryMode(2).build()&nbsp;//&nbsp;Delivery&nbsp;mode&nbsp;2:&nbsp;persistent&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;def&nbsp;msg&nbsp;=&nbsp;&amp;quot;Message&nbsp;$idx&amp;quot;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;channel.basicPublish(&amp;#39;myExchange&amp;#39;,&nbsp;&amp;#39;&amp;#39;,&nbsp;properties,&nbsp;msg.getBytes())&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;println&nbsp;msg&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;rabbit.close()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;}&nbsp;catch(e){e.printStackTrace()}&lt;/span&gt;&lt;br&gt;<br>
<br>
<br>
<br>
&lt;br&gt;&lt;br&gt;-&nbsp;Consumer.groovy&lt;br&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;import&nbsp;com.rabbitmq.client.*&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;try{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;//&nbsp;Get&nbsp;rabbitmq&nbsp;config&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;def&nbsp;config&nbsp;=&nbsp;new&nbsp;ConfigSlurper().parse(new&nbsp;File(&amp;#39;../rabbitmq.properties&amp;#39;).toURL())&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;//&nbsp;Connect&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;def&nbsp;rabbit&nbsp;=&nbsp;new&nbsp;RabbitHA(config)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;rabbit.onDelivery(&amp;#39;myQueue&amp;#39;){&nbsp;delivery,&nbsp;channel&nbsp;-&amp;gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;def&nbsp;msg&nbsp;=&nbsp;new&nbsp;String(delivery.body)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;println&nbsp;msg&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;//&nbsp;Manual&nbsp;ack&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;channel.basicAck(delivery.envelope.deliveryTag,&nbsp;false)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;}&nbsp;catch(e){e.printStackTrace()}&lt;/span&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;-&nbsp;RabbitHA.groovy&lt;br&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;import&nbsp;com.rabbitmq.client.*&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;/**&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; *&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; *&nbsp;RabbitMQ&nbsp;highly&nbsp;available&nbsp;proxy.&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; *&nbsp;Basic&nbsp;implementation&nbsp;of&nbsp;a&nbsp;basic&nbsp;suscriber/publisher&nbsp;with&nbsp;reconnect&nbsp;logic.&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; *&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; */&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;class&nbsp;RabbitHA&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;ConnectionFactory&nbsp;connectionFactory&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;Address[]&nbsp;addresses&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;Closure&nbsp;init&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;Connection&nbsp;connection&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;Channel&nbsp;channel&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;QueueingConsumer&nbsp;consumer&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;public&nbsp;RabbitHA(Map&nbsp;config)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;this(config,&nbsp;null)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;public&nbsp;RabbitHA(Map&nbsp;config,&nbsp;Closure&nbsp;init){&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;this.connectionFactory&nbsp;=&nbsp;new&nbsp;ConnectionFactory([username:&nbsp;config.username,&nbsp;password:&nbsp;config.password,&nbsp;virtualHost:&nbsp;config.virtualHost])&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;this.addresses&nbsp;=&nbsp;Address.parseAddresses(config.addresses)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;this.init&nbsp;=&nbsp;init&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;connectChannel()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;void&nbsp;onDelivery(String&nbsp;queueName,&nbsp;Closure&nbsp;closure)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;basicConsume(queueName)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;int&nbsp;i&nbsp;=&nbsp;0&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;while(true)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;           &nbsp;try&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;QueueingConsumer.Delivery&nbsp;delivery&nbsp;=&nbsp;consumer.nextDelivery()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;closure(delivery,&nbsp;channel)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;i&nbsp;=&nbsp;0&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;           &nbsp;}&nbsp;catch(e)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;//&nbsp;Only&nbsp;handle&nbsp;exceptions&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;if(!(e&nbsp;in&nbsp;ShutdownSignalException&nbsp;||&nbsp;e&nbsp;in&nbsp;IOException&nbsp;||&nbsp;e&nbsp;in&nbsp;AlreadyClosedException))&nbsp;throw&nbsp;e&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;i++&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;e.printStackTrace()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;println&nbsp;&amp;quot;ShutdownSignalException&nbsp;recieved!&nbsp;Reconnection&nbsp;attempt&nbsp;#$i&amp;quot;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;connectChannel()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;basicConsume(queueName)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;           &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;void&nbsp;publish(Closure&nbsp;closure)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;int&nbsp;i&nbsp;=&nbsp;0&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;boolean&nbsp;retry&nbsp;=&nbsp;true&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;while(retry)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;           &nbsp;try&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;closure(channel)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;i&nbsp;=&nbsp;0&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;retry&nbsp;=&nbsp;false&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;           &nbsp;}&nbsp;catch(e)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;//&nbsp;Only&nbsp;handle&nbsp;exceptions&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;if(!(e&nbsp;in&nbsp;ShutdownSignalException&nbsp;||&nbsp;e&nbsp;in&nbsp;IOException&nbsp;||&nbsp;e&nbsp;in&nbsp;AlreadyClosedException))&nbsp;throw&nbsp;e&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;i++&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;retry&nbsp;=&nbsp;true&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;e.printStackTrace()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;println&nbsp;&amp;quot;ShutdownSignalException&nbsp;recieved!&nbsp;Reconnection&nbsp;attempt&nbsp;#$i&amp;quot;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;               &nbsp;connectChannel()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;           &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;void&nbsp;connectChannel()&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;connection&nbsp;=&nbsp;connectionFactory.newConnection(addresses)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;channel&nbsp;=&nbsp;connection.createChannel()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;println&nbsp;&amp;quot;Succesfully&nbsp;connected&nbsp;to&nbsp;$connection.address&amp;quot;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;if(init)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;           &nbsp;init(channel)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;void&nbsp;basicConsume(queueName)&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;consumer&nbsp;=&nbsp;new&nbsp;QueueingConsumer(channel)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;channel.basicConsume(queueName,&nbsp;false,&nbsp;consumer)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;void&nbsp;close()&nbsp;{&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;channel.waitForConfirmsOrDie()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;channel.close()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;       &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;connection.close()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;   &nbsp;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;<br>
<br>
<br>
Output:&lt;br&gt;<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;cat&nbsp;consumer-output.txt&nbsp;|grep&nbsp;Message&nbsp;|&nbsp;wc&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;  &nbsp;9957  &nbsp;19914 &nbsp;128330&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;<br>
<br>
<br>
<br>
&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;cat&nbsp;producer-output.txt&nbsp;|&nbsp;grep&nbsp;Message&nbsp;|&nbsp;wc&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt; &nbsp;10000  &nbsp;20000 &nbsp;128890&lt;/span&gt;&lt;br&gt;<br>
<br>
<br>
<br>
&lt;br&gt;&lt;b&gt;Note&nbsp;that&nbsp;consumer&nbsp;lost&nbsp;43&nbsp;messages&lt;/b&gt;&lt;br&gt;&lt;br&gt;Output&nbsp;from&nbsp;producer&nbsp;:&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&gt;Message&nbsp;1466&lt;/span&gt;&lt;br&gt;<br>
<br>
&lt;span&gt;Message&nbsp;1467&lt;/span&gt;&lt;br&gt;&lt;span&gt;Message&nbsp;1468&lt;/span&gt;&lt;br&gt;&lt;span&gt;Message&nbsp;1469&lt;/span&gt;&lt;br&gt;<br>
&lt;span&gt;Message&nbsp;1470&lt;/span&gt;&lt;br&gt;ShutdownSignalException&nbsp;recieved!&nbsp;Reconnection&nbsp;attempt&nbsp;#1&lt;br&gt;Succesfully&nbsp;connected&nbsp;to&nbsp;i-0000001a-zsm/&lt;a&nbsp;href=&quot;http://172.16.158.46&quot;&nbsp;target=&quot;_blank&quot;&gt;172.16.158.46&lt;/a&gt;&lt;br&gt;Message&nbsp;1471&lt;br&gt;<br>
<br>
Message&nbsp;1472&lt;br&gt;Message&nbsp;1473&lt;br&gt;Message&nbsp;1474&lt;br&gt;Message&nbsp;1475&lt;br&gt;Message&nbsp;1476&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:courier&nbsp;new,monospace&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;&lt;br&gt;Note&nbsp;messages&nbsp;[1471..1476]&nbsp;were&nbsp;consumed&nbsp;ok,&nbsp;but&nbsp;[1466..1470]&nbsp;are&nbsp;missing&nbsp;in&nbsp;consumer&nbsp;output.&lt;/b&gt;&lt;br&gt;<br>
<br>
<br>
<br>
&lt;br&gt;The&nbsp;complete&nbsp;outputs&nbsp;are&nbsp;in&nbsp;&lt;a&nbsp;href=&quot;https://github.com/pablomolnar/rabbitmq_samples/tree/master/out&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/pablomolnar/rabbitmq_samples/tree/master/out&lt;/a&gt;.&nbsp;There&nbsp;you&nbsp;can&nbsp;see&nbsp;reconnection&nbsp;log&nbsp;of&nbsp;both&nbsp;parts.&lt;br&gt;<br>
<br>
<br>
<br>
I&amp;#39;ve&nbsp;a&nbsp;strong&nbsp;feeling&nbsp;the&nbsp;publisher&nbsp;confirms&nbsp;is&nbsp;not&nbsp;well&nbsp;configured.&lt;br&gt;&lt;br&gt;Please&nbsp;anyone&nbsp;could&nbsp;shed&nbsp;some&nbsp;light&nbsp;on&nbsp;the&nbsp;issue?&lt;br&gt;&lt;br&gt;Cheers,&lt;br&gt;Pablo&nbsp;Molnar&lt;br&gt;&lt;br&gt;PD:&nbsp;Also&nbsp;I&nbsp;take&nbsp;the&nbsp;opportunity&nbsp;to&nbsp;share&nbsp;a&nbsp;lot&nbsp;of&nbsp;groovy&nbsp;examples&nbsp;I&amp;#39;ve&nbsp;been&nbsp;working&nbsp;in&nbsp;the&nbsp;last&nbsp;days:&nbsp;&lt;a&nbsp;href=&quot;https://github.com/pablomolnar/rabbitmq_samples&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/pablomolnar/rabbitmq_samples&lt;/a&gt;&lt;br&gt;<br>
<br>
<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;/div&gt;_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
