<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hey&nbsp;all&nbsp;(and&nbsp;in&nbsp;particular&nbsp;the&nbsp;RabbitMQ&nbsp;devs).&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Just&nbsp;wanted&nbsp;to&nbsp;call&nbsp;attention&nbsp;to&nbsp;my&nbsp;original&nbsp;question.&nbsp;I&nbsp;didn&#39;t&nbsp;get&nbsp;any&nbsp;responses,&nbsp;and&nbsp;given&nbsp;the&nbsp;excellent&nbsp;level&nbsp;of&nbsp;help&nbsp;I&#39;ve&nbsp;gotten&nbsp;in&nbsp;the&nbsp;past,&nbsp;I&nbsp;figure&nbsp;my&nbsp;question&nbsp;was&nbsp;just&nbsp;overlooked&nbsp;in&nbsp;the&nbsp;general&nbsp;deluge&nbsp;of&nbsp;messages.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;much,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Matt&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Dec&nbsp;9,&nbsp;2013&nbsp;at&nbsp;2:42&nbsp;PM,&nbsp;Matt&nbsp;Pietrek&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:mpietrek@skytap.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mpietrek@skytap.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;p&gt;Hey&nbsp;all&nbsp;RabbitMQ&nbsp;devs&nbsp;and&nbsp;experts,&lt;/p&gt;<br>
&lt;p&gt;I’m&nbsp;looking&nbsp;for&nbsp;a&nbsp;validation&nbsp;of&nbsp;an&nbsp;approach,&nbsp;or&nbsp;a&nbsp;better&nbsp;suggestion&nbsp;on&nbsp;how&nbsp;to&nbsp;accomplish.&lt;br&gt;&lt;/p&gt;<br>
&lt;p&gt;The&nbsp;big&nbsp;picture&nbsp;is&nbsp;that&nbsp;we&nbsp;want&nbsp;to&nbsp;improve&nbsp;how&nbsp;we&nbsp;upgrade&nbsp;our&nbsp;clusters&nbsp;without&nbsp;interruptions&nbsp;in&nbsp;service.&nbsp;I&nbsp;know&nbsp;RabbitMQ&nbsp;supports&nbsp;running&nbsp;mixed&nbsp;versions&nbsp;within&nbsp;a&nbsp;cluster,&nbsp;but&nbsp;for&nbsp;us,&nbsp;upgrade&nbsp;may&nbsp;also&nbsp;mean&nbsp;bringing&nbsp;down&nbsp;a&nbsp;node&nbsp;for&nbsp;reconfiguration,&nbsp;an&nbsp;Erlang&nbsp;upgrade,&nbsp;or&nbsp;any&nbsp;other&nbsp;number&nbsp;of&nbsp;scenarios.&lt;br&gt;<br>
<br>
&lt;/p&gt;<br>
&lt;p&gt;Today&nbsp;we&nbsp;do&nbsp;controlled&nbsp;switchover&nbsp;of&nbsp;load&nbsp;from&nbsp;one&nbsp;RabbitMQ&nbsp;cluster&nbsp;to&nbsp;another,&nbsp;and&nbsp;then&nbsp;switch&nbsp;it&nbsp;back.&nbsp;We&nbsp;use&nbsp;two&nbsp;clusters&nbsp;(a&nbsp;master&nbsp;and&nbsp;an&nbsp;alternate).&nbsp;Both&nbsp;clusters&nbsp;are&nbsp;identically&nbsp;configured&nbsp;with&nbsp;two&nbsp;RabbitMQ&nbsp;instances,&nbsp;i.e&nbsp;“master”&nbsp;is&nbsp;node1,node2,&nbsp;and&nbsp;“alternate”&nbsp;is&nbsp;node3,node4.&lt;br&gt;<br>
<br>
&lt;/p&gt;<br>
&lt;p&gt;All&nbsp;queues&nbsp;are&nbsp;mirrored.&nbsp;We&nbsp;direct&nbsp;traffic&nbsp;to&nbsp;the&nbsp;master&nbsp;or&nbsp;alternate&nbsp;via&nbsp;a&nbsp;VIP.&lt;br&gt;&lt;/p&gt;<br>
&lt;p&gt;Today&nbsp;our&nbsp;upgrade&nbsp;process&nbsp;looks&nbsp;like&nbsp;this:&lt;/p&gt;&lt;p&gt;--------&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;master&nbsp;is&nbsp;operation&nbsp;normally,&nbsp;and&nbsp;pointed&nbsp;to&nbsp;by&nbsp;the&nbsp;VIP.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Shut&nbsp;down&nbsp;both&nbsp;alternate&nbsp;nodes,&nbsp;upgrade&nbsp;them&nbsp;in&nbsp;whatever&nbsp;manner&nbsp;is&nbsp;necessary.&nbsp;Newer&nbsp;version,&nbsp;more&nbsp;ram,&nbsp;whatever.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Start&nbsp;up&nbsp;alternate&nbsp;cluster,&nbsp;then&nbsp;create&nbsp;the&nbsp;same&nbsp;set&nbsp;of&nbsp;queues&nbsp;on&nbsp;it&nbsp;as&nbsp;the&nbsp;master&nbsp;has.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Redirect&nbsp;the&nbsp;VIP&nbsp;to&nbsp;point&nbsp;to&nbsp;the&nbsp;alternate.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Clients&nbsp;see&nbsp;a&nbsp;connection&nbsp;drop&nbsp;because&nbsp;of&nbsp;the&nbsp;VIP&nbsp;change,&nbsp;but&nbsp;are&nbsp;tolerant&nbsp;and&nbsp;auto-reconnect.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Copy&nbsp;all&nbsp;queue&nbsp;contents&nbsp;from&nbsp;the&nbsp;master’s&nbsp;queues&nbsp;to&nbsp;the&nbsp;alternate’s&nbsp;same-named&nbsp;queues.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Shut&nbsp;down&nbsp;the&nbsp;master&nbsp;nodes&nbsp;and&nbsp;upgrade&nbsp;them.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Perform&nbsp;similar&nbsp;steps&nbsp;as&nbsp;above&nbsp;to&nbsp;move&nbsp;the&nbsp;VIP&nbsp;and&nbsp;messages&nbsp;back&nbsp;to&nbsp;the&nbsp;master.&lt;/p&gt;<br>
&lt;p&gt;--------&lt;/p&gt;<br>
&lt;p&gt;While&nbsp;this&nbsp;generally&nbsp;works,&nbsp;there&nbsp;are&nbsp;small&nbsp;but&nbsp;important&nbsp;problems&nbsp;with&nbsp;it.&nbsp;One&nbsp;problem&nbsp;is&nbsp;that&nbsp;some&nbsp;of&nbsp;our&nbsp;queues&nbsp;are&nbsp;created/deleted.&nbsp;I&nbsp;have&nbsp;seen&nbsp;scenarios&nbsp;where&nbsp;unfortunate&nbsp;timing&nbsp;can&nbsp;cause&nbsp;a&nbsp;queue&nbsp;to&nbsp;not&nbsp;be&nbsp;on&nbsp;the&nbsp;right&nbsp;cluster&nbsp;at&nbsp;the&nbsp;right&nbsp;moment.&lt;/p&gt;<br>
<br>
<br>
&lt;p&gt;Looking&nbsp;at&nbsp;newer&nbsp;RabbitMQ&nbsp;features,&nbsp;in&nbsp;particular&nbsp;policy&nbsp;based&nbsp;mirroring&nbsp;control,&nbsp;I’m&nbsp;thinking&nbsp;something&nbsp;like&nbsp;this&nbsp;would&nbsp;be&nbsp;better:&lt;br&gt;&lt;/p&gt;<br>
&lt;p&gt;-------&lt;/p&gt;&lt;p&gt;*&nbsp;Have&nbsp;node1/node2&nbsp;running&nbsp;along&nbsp;normally,&nbsp;with&nbsp;the&nbsp;VIP&nbsp;pointing&nbsp;at&nbsp;it.&lt;br&gt;&lt;/p&gt;&lt;p&gt;*&nbsp;Start&nbsp;up&nbsp;node3/node4&nbsp;in&nbsp;the&nbsp;same&nbsp;cluster&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Use&nbsp;policy&nbsp;to&nbsp;make&nbsp;all&nbsp;queues&nbsp;mirrored&nbsp;by&nbsp;all&nbsp;four&nbsp;nodes.&nbsp;Use&nbsp;synch_queue&nbsp;as&nbsp;necessary&nbsp;to&nbsp;force&nbsp;synchronization&nbsp;in&nbsp;a&nbsp;reasonable&nbsp;time&nbsp;frame.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;When&nbsp;all&nbsp;queues&nbsp;are&nbsp;synched,&nbsp;remove&nbsp;node1/node2&nbsp;from&nbsp;the&nbsp;cluster&nbsp;and&nbsp;upgrade&nbsp;them.&lt;/p&gt;<br>
&lt;p&gt;*&nbsp;Because&nbsp;our&nbsp;VIP&nbsp;is&nbsp;managed&nbsp;by&nbsp;keepalived,&nbsp;either&nbsp;node3&nbsp;or&nbsp;node4&nbsp;will&nbsp;obtain&nbsp;the&nbsp;VIP&nbsp;when&nbsp;node1/node2&nbsp;are&nbsp;removed.&lt;/p&gt;<br>
&lt;p&gt;--------&lt;/p&gt;&lt;p&gt;The&nbsp;advantage&nbsp;of&nbsp;this&nbsp;is&nbsp;that&nbsp;it&nbsp;eliminates&nbsp;queue&nbsp;location&nbsp;timing&nbsp;windows&nbsp;and&nbsp;we&nbsp;don’t&nbsp;have&nbsp;to&nbsp;manually&nbsp;copy&nbsp;messages&nbsp;around.&nbsp;The&nbsp;only&nbsp;downside&nbsp;I’m&nbsp;aware&nbsp;of&nbsp;is&nbsp;that&nbsp;it&nbsp;won’t&nbsp;work&nbsp;when&nbsp;upgrading&nbsp;major/minor&nbsp;versions.&nbsp;That&nbsp;is,&nbsp;it&nbsp;should&nbsp;be&nbsp;fine&nbsp;from&nbsp;3.4.3&nbsp;to&nbsp;3.4.7,&nbsp;but&nbsp;not&nbsp;3.4&nbsp;to&nbsp;3.5.&nbsp;In&nbsp;that&nbsp;case,&nbsp;we&#39;d&nbsp;use&nbsp;our&nbsp;original&nbsp;upgrade&nbsp;logic.&lt;/p&gt;<br>
<br>
<br>
&lt;p&gt;Thoughts?&nbsp;Suggestions?&nbsp;Better&nbsp;ideas?&lt;/p&gt;<br>
&lt;p&gt;Thanks,&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;&lt;/p&gt;<br>
&lt;p&gt;Matt&lt;/p&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
