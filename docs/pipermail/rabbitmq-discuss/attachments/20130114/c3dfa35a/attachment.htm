<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=ISO-8859-1&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;bgcolor=&quot;#FFFFFF&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Hi,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;01/14/2013&nbsp;08:34&nbsp;AM,&nbsp;Shadowalker&nbsp;wrote:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:762d6737-941d-44ed-b9b8-83d9e1c3781a@googlegroups.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;Hi&nbsp;again,&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Been&nbsp;doing&nbsp;a&nbsp;lot&nbsp;of&nbsp;googling&nbsp;on&nbsp;the&nbsp;queue/topic/listening&nbsp;for<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consumed&nbsp;messages&nbsp;count&nbsp;an&nbsp;found&nbsp;this&nbsp;on&nbsp;activemq&nbsp;:&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;moz-do-not-send=&quot;true&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://activemq.apache.org/cms/handling-advisory-messages.html&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target=&quot;_blank&quot;&gt;http://activemq.apache.org/&lt;wbr&gt;cms/handling-advisory-&lt;wbr&gt;messages.html&lt;/a&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;allows&nbsp;one&nbsp;to&nbsp;check&nbsp;the&nbsp;count&nbsp;of&nbsp;currently&nbsp;listening&nbsp;consumer&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue/topic.&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;would&nbsp;not&nbsp;recommend&nbsp;an&nbsp;architecture&nbsp;for&nbsp;distributed&nbsp;resource<br>
&nbsp;&nbsp;&nbsp;&nbsp;tracking&nbsp;based&nbsp;on&nbsp;that.&nbsp;What&nbsp;happens&nbsp;if&nbsp;a&nbsp;consumer&nbsp;is&nbsp;temporarily<br>
&nbsp;&nbsp;&nbsp;&nbsp;disconnected&nbsp;when&nbsp;you&nbsp;go&nbsp;into&nbsp;the&nbsp;check,&nbsp;but&nbsp;reconnects&nbsp;after&nbsp;(or<br>
&nbsp;&nbsp;&nbsp;&nbsp;whilst)&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;participants&nbsp;are&nbsp;being&nbsp;updated?&nbsp;You've<br>
&nbsp;&nbsp;&nbsp;&nbsp;introduced&nbsp;even&nbsp;more&nbsp;possibilities&nbsp;for&nbsp;race&nbsp;conditions&nbsp;than&nbsp;before.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;What&nbsp;I&nbsp;would&nbsp;suggest&nbsp;is&nbsp;that&nbsp;you&nbsp;carefully&nbsp;consider&nbsp;whether&nbsp;you<br>
&nbsp;&nbsp;&nbsp;&nbsp;actually&nbsp;need&nbsp;synchronous&nbsp;communications&nbsp;here,&nbsp;as&nbsp;messaging&nbsp;based<br>
&nbsp;&nbsp;&nbsp;&nbsp;architectures&nbsp;inherently&nbsp;de-couple&nbsp;producers&nbsp;from&nbsp;consumers,&nbsp;yet<br>
&nbsp;&nbsp;&nbsp;&nbsp;you've&nbsp;repeatedly&nbsp;attempted&nbsp;to&nbsp;force&nbsp;some&nbsp;'awareness'&nbsp;of&nbsp;consumers<br>
&nbsp;&nbsp;&nbsp;&nbsp;into&nbsp;the&nbsp;producer&nbsp;whilst&nbsp;discussing&nbsp;this&nbsp;design.&nbsp;I&nbsp;would&nbsp;like&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;posit&nbsp;that&nbsp;this&nbsp;reveals&nbsp;an&nbsp;'impedance&nbsp;mismatch'&nbsp;between&nbsp;your<br>
&nbsp;&nbsp;&nbsp;&nbsp;requirements&nbsp;and&nbsp;the&nbsp;inherently&nbsp;disconnected&nbsp;nature&nbsp;of&nbsp;a&nbsp;queue&nbsp;based<br>
&nbsp;&nbsp;&nbsp;&nbsp;solution.&nbsp;Of&nbsp;course&nbsp;distributed&nbsp;locking&nbsp;is&nbsp;often&nbsp;implemented&nbsp;using<br>
&nbsp;&nbsp;&nbsp;&nbsp;asynchronous&nbsp;communication&nbsp;protocols,&nbsp;but&nbsp;this&nbsp;is&nbsp;usually&nbsp;done&nbsp;at&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;*much&nbsp;lower&nbsp;protocol&nbsp;level*&nbsp;-&nbsp;I'd&nbsp;suggest&nbsp;researching&nbsp;Paxos&nbsp;or<br>
&nbsp;&nbsp;&nbsp;&nbsp;similar&nbsp;distributed&nbsp;consensus&nbsp;algorithms&nbsp;to&nbsp;get&nbsp;an&nbsp;idea&nbsp;of&nbsp;what's<br>
&nbsp;&nbsp;&nbsp;&nbsp;involved&nbsp;in&nbsp;designing&nbsp;a&nbsp;reliable&nbsp;solution&nbsp;to&nbsp;this&nbsp;kind&nbsp;of&nbsp;problem.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:762d6737-941d-44ed-b9b8-83d9e1c3781a@googlegroups.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;Is&nbsp;there&nbsp;anything&nbsp;like&nbsp;this&nbsp;in&nbsp;rabbit&nbsp;mq&nbsp;?&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Not&nbsp;that&nbsp;I&nbsp;know&nbsp;of,&nbsp;although&nbsp;it's&nbsp;possible&nbsp;to&nbsp;use&nbsp;the&nbsp;HTTP&nbsp;APIs&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;order&nbsp;to&nbsp;track&nbsp;consumers&nbsp;but&nbsp;that&nbsp;is,&nbsp;as&nbsp;I&nbsp;mentioned&nbsp;above,&nbsp;subject<br>
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;lots&nbsp;of&nbsp;*nasty*&nbsp;race&nbsp;conditions.&nbsp;You&nbsp;*could*&nbsp;look&nbsp;at&nbsp;using&nbsp;Tony<br>
&nbsp;&nbsp;&nbsp;&nbsp;G's&nbsp;presence&nbsp;exchange&nbsp;(&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;https://github.com/tonyg/presence-exchange&quot;&gt;https://github.com/tonyg/presence-exchange&lt;/a&gt;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;track&nbsp;bindings&nbsp;-&nbsp;although&nbsp;this&nbsp;would&nbsp;complicate&nbsp;your&nbsp;topology<br>
&nbsp;&nbsp;&nbsp;&nbsp;quite&nbsp;a&nbsp;lot,&nbsp;it&nbsp;might&nbsp;make&nbsp;tracking&nbsp;the&nbsp;various&nbsp;participants<br>
&nbsp;&nbsp;&nbsp;&nbsp;plausibly&nbsp;useful,&nbsp;providing&nbsp;you&nbsp;use&nbsp;a&nbsp;known&nbsp;set&nbsp;of&nbsp;binding&nbsp;keys.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:762d6737-941d-44ed-b9b8-83d9e1c3781a@googlegroups.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;This&nbsp;might&nbsp;allow&nbsp;me&nbsp;to&nbsp;create&nbsp;a&nbsp;listener&nbsp;that&nbsp;would<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;only&nbsp;send&nbsp;a&nbsp;message&nbsp;to&nbsp;notify&nbsp;the&nbsp;first&nbsp;manager&nbsp;that&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;references&nbsp;were&nbsp;removed.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I'm&nbsp;not&nbsp;clear&nbsp;on&nbsp;how&nbsp;that&nbsp;helps!?&nbsp;I&nbsp;did&nbsp;have&nbsp;a&nbsp;bit&nbsp;of&nbsp;an&nbsp;early&nbsp;start<br>
&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;morning&nbsp;though...&nbsp;;)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:762d6737-941d-44ed-b9b8-83d9e1c3781a@googlegroups.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Another&nbsp;could&nbsp;be&nbsp;to&nbsp;define&nbsp;the&nbsp;&quot;delete&nbsp;referenrences&quot;&nbsp;message&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;live&nbsp;for&nbsp;x&nbsp;consumptions&nbsp;(x&nbsp;being&nbsp;the&nbsp;number&nbsp;of&nbsp;listener&nbsp;on&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;delete&nbsp;references&quot;&nbsp;queue)&nbsp;and&nbsp;add&nbsp;an&nbsp;advisory&nbsp;listener&nbsp;on&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deletion&nbsp;of&nbsp;the&nbsp;message&nbsp;from&nbsp;the&nbsp;queue&nbsp;to&nbsp;process&nbsp;deletion&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initial&nbsp;data.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;That&nbsp;doesn't&nbsp;help&nbsp;at&nbsp;all&nbsp;unless&nbsp;you've&nbsp;actually&nbsp;tracked&nbsp;the&nbsp;number<br>
&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;acquired&nbsp;messages&nbsp;in&nbsp;the&nbsp;first&nbsp;place.&nbsp;Plus&nbsp;you&nbsp;*can*&nbsp;do&nbsp;that<br>
&nbsp;&nbsp;&nbsp;&nbsp;without&nbsp;'detecting'&nbsp;the&nbsp;number&nbsp;of&nbsp;consumers.&nbsp;You&nbsp;just&nbsp;insist&nbsp;on<br>
&nbsp;&nbsp;&nbsp;&nbsp;getting&nbsp;a&nbsp;'make-ref'&nbsp;message&nbsp;from&nbsp;the&nbsp;consumer&nbsp;(with&nbsp;some&nbsp;unique&nbsp;id)<br>
&nbsp;&nbsp;&nbsp;&nbsp;before&nbsp;incrementing&nbsp;the&nbsp;reference&nbsp;count.&nbsp;There's&nbsp;no&nbsp;real&nbsp;difference<br>
&nbsp;&nbsp;&nbsp;&nbsp;between&nbsp;*detecting*&nbsp;the&nbsp;consumer's&nbsp;connection/channel&nbsp;and&nbsp;providing<br>
&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;ref/lock&nbsp;acquisition&nbsp;queue,&nbsp;except&nbsp;that&nbsp;the&nbsp;latter&nbsp;is&nbsp;probably<br>
&nbsp;&nbsp;&nbsp;&nbsp;more&nbsp;structured,&nbsp;architecturally&nbsp;clearer&nbsp;and&nbsp;quite&nbsp;likely&nbsp;to&nbsp;be&nbsp;more<br>
&nbsp;&nbsp;&nbsp;&nbsp;reliable.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Even&nbsp;if&nbsp;you&nbsp;used&nbsp;ActiveMQ's&nbsp;detection&nbsp;functionality&nbsp;or&nbsp;RabbitMQ's<br>
&nbsp;&nbsp;&nbsp;&nbsp;management&nbsp;HTTP&nbsp;APIs,&nbsp;the&nbsp;fundamental&nbsp;problem&nbsp;of&nbsp;race&nbsp;conditions<br>
&nbsp;&nbsp;&nbsp;&nbsp;wouldn't&nbsp;go&nbsp;away.&nbsp;Before&nbsp;we&nbsp;go&nbsp;much&nbsp;further&nbsp;discussing&nbsp;various&nbsp;ways<br>
&nbsp;&nbsp;&nbsp;&nbsp;you&nbsp;can&nbsp;design&nbsp;a&nbsp;solution&nbsp;-&nbsp;and&nbsp;I&nbsp;*am*&nbsp;interested&nbsp;in&nbsp;this&nbsp;discussion<br>
&nbsp;&nbsp;&nbsp;&nbsp;BTW&nbsp;-&nbsp;please&nbsp;read<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://en.wikipedia.org/wiki/Byzantine_fault_tolerance#Byzantine_failures&quot;&gt;http://en.wikipedia.org/wiki/Byzantine_fault_tolerance#Byzantine_failures&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;make&nbsp;sure&nbsp;you've&nbsp;understood&nbsp;the&nbsp;consequences&nbsp;of&nbsp;nodes&nbsp;*just<br>
&nbsp;&nbsp;&nbsp;&nbsp;disappearing*&nbsp;and&nbsp;then&nbsp;*maybe*&nbsp;coming&nbsp;back&nbsp;later&nbsp;on.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;You've&nbsp;also&nbsp;still&nbsp;not&nbsp;explained&nbsp;what&nbsp;the&nbsp;consequences&nbsp;of&nbsp;loosing<br>
&nbsp;&nbsp;&nbsp;&nbsp;track&nbsp;of&nbsp;resources&nbsp;actually&nbsp;are.&nbsp;If&nbsp;one&nbsp;of&nbsp;your&nbsp;nodes&nbsp;dies,&nbsp;when&nbsp;it<br>
&nbsp;&nbsp;&nbsp;&nbsp;comes&nbsp;back&nbsp;to&nbsp;life&nbsp;has&nbsp;any&nbsp;state&nbsp;been&nbsp;persisted&nbsp;and&nbsp;will&nbsp;that&nbsp;state<br>
&nbsp;&nbsp;&nbsp;&nbsp;thus&nbsp;be&nbsp;used&nbsp;to&nbsp;try&nbsp;and&nbsp;re-acquire&nbsp;or&nbsp;release&nbsp;the&nbsp;'lock&nbsp;count'&nbsp;for<br>
&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;resource?&nbsp;What&nbsp;happens&nbsp;if&nbsp;your&nbsp;node&nbsp;sends&nbsp;an&nbsp;'acquire'&nbsp;request<br>
&nbsp;&nbsp;&nbsp;&nbsp;asynchronously,&nbsp;then&nbsp;starts&nbsp;to&nbsp;write&nbsp;the&nbsp;resource/lock&nbsp;state&nbsp;to&nbsp;its<br>
&nbsp;&nbsp;&nbsp;&nbsp;own&nbsp;local&nbsp;database&nbsp;and&nbsp;dies&nbsp;(e.g.,&nbsp;the&nbsp;machine&nbsp;crashes)&nbsp;before<br>
&nbsp;&nbsp;&nbsp;&nbsp;committing&nbsp;the&nbsp;transaction?&nbsp;Because&nbsp;the&nbsp;'acquire'&nbsp;request&nbsp;was&nbsp;not<br>
&nbsp;&nbsp;&nbsp;&nbsp;synchronous,&nbsp;the&nbsp;master&nbsp;now&nbsp;thinks&nbsp;that&nbsp;your&nbsp;node&nbsp;holds&nbsp;the&nbsp;lock,<br>
&nbsp;&nbsp;&nbsp;&nbsp;whilst&nbsp;the&nbsp;node&nbsp;does&nbsp;*not*&nbsp;think&nbsp;the&nbsp;same.&nbsp;If&nbsp;you&nbsp;bring&nbsp;the&nbsp;node<br>
&nbsp;&nbsp;&nbsp;&nbsp;back&nbsp;online&nbsp;and&nbsp;then&nbsp;start&nbsp;asking&nbsp;for&nbsp;the&nbsp;resource&nbsp;lock,&nbsp;you're<br>
&nbsp;&nbsp;&nbsp;&nbsp;breaking&nbsp;the&nbsp;contract&nbsp;for&nbsp;lock&nbsp;acquisition&nbsp;on&nbsp;that&nbsp;node&nbsp;unless<br>
&nbsp;&nbsp;&nbsp;&nbsp;you're&nbsp;willing&nbsp;to&nbsp;make&nbsp;'acquire'&nbsp;idempotent,&nbsp;which&nbsp;has&nbsp;its&nbsp;own<br>
&nbsp;&nbsp;&nbsp;&nbsp;pitfalls.&nbsp;If&nbsp;you&nbsp;don't&nbsp;make&nbsp;'acquire'&nbsp;idempotent,&nbsp;then&nbsp;acquisition<br>
&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;fail.&nbsp;If&nbsp;you&nbsp;try&nbsp;to&nbsp;handle&nbsp;this&nbsp;by&nbsp;making&nbsp;'acquire'&nbsp;re-entrant<br>
&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;then&nbsp;try&nbsp;to&nbsp;release&nbsp;the&nbsp;node's&nbsp;locl,&nbsp;the&nbsp;master&nbsp;will&nbsp;be&nbsp;confused<br>
&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;it&nbsp;thinks&nbsp;you&nbsp;hold&nbsp;the&nbsp;lock&nbsp;twice&nbsp;and&nbsp;the&nbsp;*lost&nbsp;lock&nbsp;acquisition*<br>
&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;never&nbsp;be&nbsp;released.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;tldr;&nbsp;this&nbsp;is&nbsp;not&nbsp;a&nbsp;simple&nbsp;problem.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Cheers,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Tim&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
