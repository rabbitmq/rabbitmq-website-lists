<tt>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jul&nbsp;3,&nbsp;2012&nbsp;at&nbsp;9:06&nbsp;AM,&nbsp;Steve&nbsp;Powell&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:steve@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;steve@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
&lt;div&nbsp;style=&quot;word-wrap:break-word&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;You&nbsp;are&nbsp;quite&nbsp;right.&nbsp;Your&nbsp;understanding&nbsp;of&nbsp;HA&nbsp;queues&nbsp;is&nbsp;better&nbsp;than&lt;br&gt;mine.&nbsp;However,&nbsp;AFAICS&nbsp;the&nbsp;STOMP&nbsp;adapter&nbsp;doesn&amp;#39;t&nbsp;present&lt;br&gt;the&nbsp;consumer_cancel_notify&nbsp;capability&nbsp;to&nbsp;the&nbsp;(Erlang)&nbsp;connection,&nbsp;so&lt;br&gt;<br>
<br>
will&nbsp;not&nbsp;receive&nbsp;a&nbsp;notification&nbsp;when&nbsp;the&nbsp;consumer&nbsp;is&nbsp;cancelled.&lt;br&gt;&lt;br&gt;The&nbsp;STOMP&nbsp;client&nbsp;will&nbsp;think&nbsp;that&nbsp;the&nbsp;subscription&nbsp;is&nbsp;sound&nbsp;even&nbsp;if&nbsp;the&lt;br&gt;underlying&nbsp;consumer&nbsp;was&nbsp;cancelled.&nbsp;We&nbsp;can&nbsp;probably&nbsp;do&nbsp;better&nbsp;than&nbsp;this.&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;therein&nbsp;lies&nbsp;the&nbsp;problem.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:break-word&quot;&gt;<br>
<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;Although&nbsp;the&nbsp;STOMP&nbsp;client&nbsp;will&nbsp;stop&nbsp;receiving&nbsp;messages,&nbsp;I&nbsp;would&nbsp;not&lt;br&gt;characterise&nbsp;this&nbsp;as&nbsp;&amp;#39;dangerous&amp;#39;,&nbsp;merely&nbsp;frustrating.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Maybe&nbsp;not&nbsp;dangerous,&nbsp;since&nbsp;there&nbsp;is&nbsp;no&nbsp;data&nbsp;loss,&nbsp;but&nbsp;certainly&nbsp;a&nbsp;lot&nbsp;worse&nbsp;than&nbsp;frustrating.&nbsp; If&nbsp;you&nbsp;have&nbsp;long&nbsp;lived&nbsp;STOMP&nbsp;connections&nbsp;with&nbsp;consumers&nbsp;which&nbsp;suddenly&nbsp;stop&nbsp;receiving&nbsp;messages&nbsp;without&nbsp;any&nbsp;warning,&nbsp;depending&nbsp;on&nbsp;the&nbsp;importance&nbsp;of&nbsp;those&nbsp;messages&nbsp;and&nbsp;the&nbsp;processes&nbsp;that&nbsp;consume&nbsp;them,&nbsp;the&nbsp;loss&nbsp;of&nbsp;the&nbsp;subscription&nbsp;can&nbsp;be&nbsp;quite&nbsp;important&nbsp;from&nbsp;a&nbsp;business&nbsp;perspective.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;E.g.&nbsp;if&nbsp;those&nbsp;messages&nbsp;are&nbsp;being&nbsp;used&nbsp;to&nbsp;monitor&nbsp;some&nbsp;business&nbsp;activity,&nbsp;you&nbsp;are&nbsp;now&nbsp;flying&nbsp;blind&nbsp;until&nbsp;the&nbsp;STOMP&nbsp;connection&nbsp;is&nbsp;torn&nbsp;down&nbsp;and&nbsp;reestablished.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
&lt;div&nbsp;style=&quot;word-wrap:break-word&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;Can&nbsp;you&nbsp;say&nbsp;what&nbsp;you&nbsp;think&nbsp;the&nbsp;correct&nbsp;STOMP&nbsp;behaviour&nbsp;ought&nbsp;to&nbsp;be&nbsp;if&nbsp;a&lt;br&gt;subscription&amp;#39;s&nbsp;consumer&nbsp;is&nbsp;unilaterally&nbsp;cancelled?&nbsp;I&amp;#39;m&nbsp;tempted&nbsp;to&nbsp;simply&lt;br&gt;send&nbsp;an&nbsp;ERROR&nbsp;frame&nbsp;and&nbsp;simulate&nbsp;an&nbsp;UNSUBSCRIBE,&lt;br&gt;<br>
<br>
leaving&nbsp;the&nbsp;STOMP&nbsp;client&nbsp;to&nbsp;recover&nbsp;however&nbsp;it&nbsp;thinks&nbsp;fit.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;resubscribe&nbsp;to&nbsp;the&nbsp;HA&nbsp;queues,&nbsp;obviously.&nbsp; The&nbsp;HA&nbsp;queue&nbsp;consumer&nbsp;cancelation&nbsp;is&nbsp;a&nbsp;rather&nbsp;ugly&nbsp;implementation&nbsp;detail.&nbsp; In&nbsp;an&nbsp;ideal&nbsp;world,&nbsp;a&nbsp;HA&nbsp;queue&nbsp;would&nbsp;behave&nbsp;just&nbsp;like&nbsp;a&nbsp;non-HA&nbsp;queue.&nbsp; From&nbsp;a&nbsp;consumer&nbsp;perspective&nbsp;whether&nbsp;a&nbsp;queue&nbsp;is&nbsp;HA&nbsp;or&nbsp;non-HA&nbsp;would&nbsp;be&nbsp;invisible.&nbsp; A&nbsp;HA&nbsp;queue&nbsp;would&nbsp;failover&nbsp;without&nbsp;consumers&nbsp;attached&nbsp;to&nbsp;the&nbsp;non-failing&nbsp;nodes&nbsp;noticing.&nbsp;Alas,&nbsp;this&nbsp;is&nbsp;not&nbsp;the&nbsp;case,&nbsp;and&nbsp;I&nbsp;understand&nbsp;why&nbsp;that&nbsp;is&nbsp;given&nbsp;the&nbsp;existing&nbsp;implementation.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;ideally&nbsp;the&nbsp;STOMP&nbsp;proxy&nbsp;would&nbsp;resubscribe&nbsp;when&nbsp;it&nbsp;receives&nbsp;a&nbsp;consumer&nbsp;cancelation.&nbsp; Any&nbsp;messages&nbsp;that&nbsp;consumers&nbsp;received&nbsp;that&nbsp;had&nbsp;not&nbsp;yet&nbsp;been&nbsp;acked&nbsp;or&nbsp;for&nbsp;which&nbsp;acks&nbsp;where&nbsp;lost&nbsp;in&nbsp;flight&nbsp;wil&nbsp;be&nbsp;requeued&nbsp;and&nbsp;retransmitted&nbsp;by&nbsp;the&nbsp;new&nbsp;queue&nbsp;master.&nbsp; I&nbsp;believe&nbsp;thats&nbsp;OK.&nbsp; RMQ&nbsp;and&nbsp;AMQP&nbsp;already&nbsp;have&nbsp;an&nbsp;expectation&nbsp;that&nbsp;some&nbsp;messages&nbsp;may&nbsp;be delivered more&nbsp;than&nbsp;once&nbsp;as&nbsp;it&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;two-phase&nbsp;commit&nbsp;for&nbsp;acknowledgements,&nbsp;so&nbsp;clients&nbsp;should&nbsp;already&nbsp;be&nbsp;ready&nbsp;for&nbsp;this&nbsp;eventuality.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;even&nbsp;sending&nbsp;an&nbsp;ERROR&nbsp;frame&nbsp;to&nbsp;the&nbsp;client&nbsp;to&nbsp;it&nbsp;knowns&nbsp;something&nbsp;went&nbsp;wrong&nbsp;and&nbsp;giving&nbsp;it&nbsp;an&nbsp;opportunity&nbsp;to&nbsp;recover&nbsp;is&nbsp;much&nbsp;better&nbsp;than&nbsp;the&nbsp;situation&nbsp;as&nbsp;it&nbsp;is&nbsp;right&nbsp;now.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Elias&nbsp;Levy&lt;/div&gt;<br>
<br>
&lt;/div&gt;<br>

</tt>
