<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;style&gt;&lt;!--<br>
.hmmessage&nbsp;P<br>
{<br>
margin:0px;<br>
padding:0px<br>
}<br>
body.hmmessage<br>
{<br>
font-size:&nbsp;10pt;<br>
font-family:Tahoma<br>
}<br>
--&gt;&lt;/style&gt;&lt;/head&gt;<br>
&lt;body&nbsp;class='hmmessage'&gt;&lt;div&nbsp;dir='ltr'&gt;<br>
thanks&nbsp;for&nbsp;your&nbsp;response.&lt;div&gt;&lt;br&gt;&lt;div&gt;After&nbsp;some&nbsp;deeper&nbsp;drilling&nbsp;I&nbsp;think&nbsp;I&nbsp;have&nbsp;found&nbsp;out&nbsp;the&nbsp;cause.&nbsp;I&nbsp;think&nbsp;that&nbsp;compared&nbsp;to&amp;nbsp;a&nbsp;single-node&nbsp;mode,&amp;nbsp;rabbitmq&nbsp;takes&nbsp;slightly&nbsp;longer&nbsp;time&nbsp;(probably&nbsp;a&nbsp;few&nbsp;mili&nbsp;sec&nbsp;longer)&nbsp;to&nbsp;create&nbsp;a&nbsp;new&nbsp;exchange&nbsp;or&nbsp;a&nbsp;queue&nbsp;in&nbsp;a&nbsp;clustered&nbsp;mode.&nbsp;I&nbsp;had,&nbsp;inadvertently,&nbsp;made&nbsp;some&nbsp;assumptions&nbsp;which&nbsp;started&nbsp;to&nbsp;go&nbsp;wrong&nbsp;in&nbsp;a&nbsp;clustered-setup&nbsp;because&nbsp;of&nbsp;this&nbsp;slight&nbsp;delay&nbsp;in&nbsp;clustered&nbsp;mode.&nbsp;I&nbsp;think&nbsp;that&nbsp;the&nbsp;message&nbsp;was&nbsp;getting&nbsp;published&nbsp;before&nbsp;a&nbsp;client&nbsp;could&nbsp;attach&nbsp;a&nbsp;queue&nbsp;to&nbsp;the&nbsp;exchange.&nbsp;My&nbsp;guess&nbsp;is&nbsp;that&nbsp;RabbitMQ&nbsp;was&nbsp;trashing&nbsp;the&nbsp;message&nbsp;published&nbsp;on&nbsp;that&nbsp;exchange&nbsp;as&nbsp;there&nbsp;was&nbsp;no&nbsp;queue&nbsp;to&nbsp;collect&nbsp;it;&nbsp;and&nbsp;later&nbsp;when&nbsp;the&nbsp;client&nbsp;did&nbsp;attach&nbsp;a&nbsp;queue&nbsp;to&nbsp;the&nbsp;exchange&nbsp;the&nbsp;message&nbsp;would&nbsp;already&nbsp;have&nbsp;been&nbsp;trashed&nbsp;and&nbsp;client&nbsp;would&nbsp;keep&nbsp;waiting&nbsp;for&nbsp;it&nbsp;until&nbsp;timeout.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;thanks,&lt;/div&gt;&lt;div&gt;-upendra&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;&lt;div&nbsp;id=&quot;SkyDrivePlaceholder&quot;&gt;&lt;/div&gt;&amp;gt;&nbsp;From:&nbsp;ask@rabbitmq.com&lt;br&gt;&amp;gt;&nbsp;Date:&nbsp;Mon,&nbsp;2&nbsp;Jul&nbsp;2012&nbsp;15:24:07&nbsp;+0100&lt;br&gt;&amp;gt;&nbsp;To:&nbsp;upendra.sharma@gmail.com&lt;br&gt;&amp;gt;&nbsp;CC:&nbsp;rabbitmq-discuss@lists.rabbitmq.com&lt;br&gt;&amp;gt;&nbsp;Subject:&nbsp;Re:&nbsp;[rabbitmq-discuss]&nbsp;Losing&nbsp;messages&nbsp;in&nbsp;a&nbsp;Cluster&nbsp;configuration&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspof&nbsp;RabbitMQ&lt;br&gt;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;On&nbsp;28&nbsp;Jun&nbsp;2012,&nbsp;at&nbsp;22:24,&nbsp;Upendra&nbsp;Sharma&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;Hi&nbsp;all,&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;I&nbsp;am&nbsp;facing&nbsp;a&nbsp;weird&nbsp;problem&nbsp;of&nbsp;losing&nbsp;messages,&nbsp;even&nbsp;though&nbsp;I&nbsp;am&nbsp;publishing&nbsp;them&nbsp;as&nbsp;persistent&nbsp;messages&nbsp;with&nbsp;pika.BasicProperties(delivery_mode=2)&nbsp;.&nbsp;Here&nbsp;is&nbsp;the&nbsp;scenario:&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;I&nbsp;have&nbsp;two&nbsp;RabbitMQ&nbsp;brokers,&nbsp;namely&nbsp;rabbit@vm11&nbsp;and&nbsp;rabbit@vm22;&nbsp;&nbsp;these&nbsp;two&nbsp;are&nbsp;have&nbsp;been&nbsp;setup&nbsp;in&nbsp;a&nbsp;cluster&nbsp;configuration&nbsp;as&nbsp;shown&nbsp;below:&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;[{nodes,[{disc,[rabbit@vm11,rabbit@vm22]}]},&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&nbsp;{running_nodes,[rabbit@vm22,rabbit@vm11]}]&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;I&nbsp;have&nbsp;two&nbsp;clients&nbsp;(written&nbsp;using&nbsp;pika.BlockingConnection()&nbsp;);&nbsp;lets&nbsp;call&nbsp;these&nbsp;clients&nbsp;C1&nbsp;and&nbsp;N1.&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;1.)&nbsp;C1&nbsp;creates&nbsp;an&nbsp;unique&nbsp;exchange&nbsp;(exchange&nbsp;name&nbsp;generated&nbsp;using&nbsp;UUID,&nbsp;say&nbsp;3fe546be8aa341b7b174b29a56e63797).&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;2.)&nbsp;C1&nbsp;then&nbsp;spawns&nbsp;a&nbsp;thread,&nbsp;say&nbsp;C1-T1,&nbsp;which&nbsp;connects&nbsp;to&nbsp;rabbitmq&nbsp;server&nbsp;and&nbsp;waits&nbsp;for&nbsp;a&nbsp;response&nbsp;on&nbsp;this&nbsp;exchange&nbsp;using&nbsp;channel.start_consuming().&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;3.)&nbsp;C1&nbsp;then&nbsp;sends&nbsp;a&nbsp;message&nbsp;to&nbsp;N1&nbsp;and&nbsp;in&nbsp;the&nbsp;message&nbsp;provides&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;exchange&nbsp;(3fe546be8aa341b7b174b29a56e63797)&nbsp;where&nbsp;N1&nbsp;should&nbsp;send&nbsp;the&nbsp;response.&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;4.)&nbsp;once&nbsp;C1-T1&nbsp;gets&nbsp;the&nbsp;response,&nbsp;it&nbsp;hands&nbsp;over&nbsp;the&nbsp;response&nbsp;to&nbsp;C1&nbsp;and&nbsp;dies.&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;In&nbsp;my&nbsp;current&nbsp;setup&nbsp;I&nbsp;have&nbsp;100&nbsp;clients&nbsp;process&nbsp;like&nbsp;C1,&nbsp;i.e.&nbsp;C1,&nbsp;C2&nbsp;...&nbsp;C100&nbsp;and&nbsp;one&nbsp;N1.&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;This&nbsp;setup&nbsp;works&nbsp;perfectly&nbsp;fine&nbsp;when&nbsp;RabbitMQ&nbsp;is&nbsp;in&nbsp;a&nbsp;single&nbsp;node&nbsp;setup&nbsp;but&nbsp;when&nbsp;I&nbsp;put&nbsp;it&nbsp;in&nbsp;a&nbsp;cluster&nbsp;setup,&nbsp;it&nbsp;starts&nbsp;to&nbsp;loose&nbsp;the&nbsp;messages.&nbsp;What&nbsp;I&nbsp;mean&nbsp;is&nbsp;that&nbsp;Thread&nbsp;C1-T1&nbsp;never&nbsp;gets&nbsp;a&nbsp;response&nbsp;and&nbsp;time-outs&nbsp;writing&nbsp;an&nbsp;ERROR&nbsp;in&nbsp;my&nbsp;log&nbsp;file.&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;The&nbsp;trouble&nbsp;is&nbsp;I&nbsp;am&nbsp;loosing&nbsp;as&nbsp;many&nbsp;as&nbsp;50%&nbsp;of&nbsp;the&nbsp;messages.&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;Rabbitmq&nbsp;delivers&nbsp;messages&nbsp;in&nbsp;round-robin,&nbsp;so&nbsp;when&nbsp;you&nbsp;say&nbsp;50%&nbsp;of&nbsp;the&nbsp;messages&lt;br&gt;&amp;gt;&nbsp;are&nbsp;lost&nbsp;it&nbsp;sounds&nbsp;like&nbsp;too&nbsp;much&nbsp;of&nbsp;a&nbsp;coincidence&nbsp;to&nbsp;me.&lt;br&gt;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;What&nbsp;can&nbsp;often&nbsp;happen&nbsp;is&nbsp;having&nbsp;a&nbsp;broken&nbsp;consumer&nbsp;process&nbsp;that&nbsp;just&nbsp;sits&lt;br&gt;&amp;gt;&nbsp;there&nbsp;stealing&nbsp;messages,&nbsp;you&nbsp;can&nbsp;verify&nbsp;that&nbsp;by&nbsp;looking&nbsp;at&nbsp;the&nbsp;`rabbitmqctl&nbsp;list_queues`&lt;br&gt;&amp;gt;&nbsp;output:&lt;br&gt;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$&nbsp;sudo&nbsp;rabbitmqct&nbsp;list_queues&nbsp;-p&nbsp;$your_vhost&nbsp;name&nbsp;messages_ready&nbsp;messages_unacknowledged&nbsp;consumers&lt;br&gt;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;If&nbsp;you&nbsp;have&nbsp;more&nbsp;consumers&nbsp;and&nbsp;unacknowledged&nbsp;messages&nbsp;than&nbsp;you&nbsp;expected&nbsp;then&lt;br&gt;&amp;gt;&nbsp;you&nbsp;probably&nbsp;have&nbsp;a&nbsp;stale&nbsp;consumer&nbsp;process&nbsp;that&nbsp;you&nbsp;have&nbsp;to&nbsp;kill.&lt;br&gt;&amp;gt;&nbsp;&lt;br&gt;&amp;gt;&nbsp;_______________________________________________&lt;br&gt;&amp;gt;&nbsp;rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;&amp;gt;&nbsp;rabbitmq-discuss@lists.rabbitmq.com&lt;br&gt;&amp;gt;&nbsp;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&lt;/div&gt;&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
