<tt>
Hi,&nbsp;Tim:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;ve&nbsp;got&nbsp;the&nbsp;following&nbsp;going&nbsp;on&nbsp;(version&nbsp;2.8.4):&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;My&nbsp;consumers&nbsp;all&nbsp;stop&nbsp;(e.g.&nbsp;imagine&nbsp;a&nbsp;failure&nbsp;scenario&nbsp;/&nbsp;upgrade),&nbsp;but&nbsp;producers&nbsp;keep&nbsp;on&nbsp;producing&lt;/div&gt;<br>
&lt;div&gt;-&nbsp;Queues&nbsp;start&nbsp;backing&nbsp;up &lt;/div&gt;&lt;div&gt;-&nbsp;Memory&nbsp;increases&nbsp;with&nbsp;queue&nbsp;size&lt;/div&gt;&lt;div&gt;-&nbsp;The&nbsp;high&nbsp;water&nbsp;mark&nbsp;gets&nbsp;hit&nbsp;and&nbsp;the&nbsp;node&nbsp;memory&nbsp;alarm&nbsp;goes&nbsp;off&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;far,&nbsp;that&amp;#39;s&nbsp;all&nbsp;what&amp;#39;s&nbsp;supposed&nbsp;to&nbsp;happen.&nbsp; The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;the&nbsp;broker&nbsp;has&nbsp;a&nbsp;lot&nbsp;of&nbsp;messages&nbsp;stacking&nbsp;up&nbsp;in&nbsp;memory&nbsp;then,&nbsp;regardless&nbsp;of&nbsp;whether&nbsp;you&nbsp;asked&nbsp;for&nbsp;them&nbsp;to&nbsp;be&nbsp;durable&nbsp;or&nbsp;not,&nbsp;it&nbsp;will&nbsp;move&nbsp;them&nbsp;to&nbsp;the&nbsp;disk&nbsp;to&nbsp;free&nbsp;up&nbsp;RAM&nbsp;and&nbsp;avoid&nbsp;Erlang&nbsp;VM&nbsp;GC&nbsp;or&nbsp;allocation&nbsp;failure&nbsp;disasters&nbsp;that&nbsp;might&nbsp;occur&nbsp;due&nbsp;to&nbsp;RAM&nbsp;exhaustion.&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;-&nbsp;with&nbsp;this&nbsp;being&nbsp;a&nbsp;durable&nbsp;queue,&nbsp;I&nbsp;anticipated&nbsp;RMQ&nbsp;would&nbsp;flush&nbsp;to&nbsp;disk&nbsp;and&nbsp;free&nbsp;memory.&lt;/div&gt;<br>
&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One&nbsp;thing&nbsp;to&nbsp;note:&nbsp; If&nbsp;the&nbsp;broker&nbsp;is&nbsp;under&nbsp;severe&nbsp;memory&nbsp;pressure,&nbsp;the&nbsp;pushing&nbsp;of&nbsp;messages&nbsp;to&nbsp;disk&nbsp;will&nbsp;happen&nbsp;regardless&nbsp;of&nbsp;the&nbsp;queue&amp;#39;s&nbsp;durability&nbsp;status&nbsp;(also,&nbsp;recall&nbsp;that&nbsp;the&nbsp;description&nbsp;*durable&nbsp;queue*&nbsp;just&nbsp;means&nbsp;that&nbsp;the&nbsp;queue&amp;#39;s&nbsp;definition&nbsp;will&nbsp;survive&nbsp;a&nbsp;broker&nbsp;restart,&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;by&nbsp;itself&nbsp;guarantee&nbsp;anything&nbsp;about&nbsp;the&nbsp;queue&amp;#39;s&nbsp;*contained&nbsp;messages*)&nbsp;or&nbsp;whether&nbsp;you&nbsp;published&nbsp;the&nbsp;messages&nbsp;with&nbsp;the&nbsp;persistent&nbsp;delivery&nbsp;mode&nbsp;set.&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&nbsp; Could&nbsp;someone&nbsp;please&nbsp;explain&nbsp;the&nbsp;memory&nbsp;overhead&nbsp;for&nbsp;messages&nbsp;sitting&nbsp;on&nbsp;a&nbsp;queue?&nbsp;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;itself,&nbsp;plus&nbsp;some&nbsp;bookkeeping&nbsp;overhead&nbsp;the&nbsp;broker&nbsp;uses&nbsp;to&nbsp;keep&nbsp;track&nbsp;of&nbsp;it.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt; I&nbsp;guess&nbsp;there&nbsp;is&nbsp;a&nbsp;something&nbsp;in&nbsp;memory&nbsp;for&nbsp;each&nbsp;message&nbsp;on&nbsp;a&nbsp;queue&nbsp;-&nbsp;is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;work&nbsp;around&nbsp;that?&nbsp;(we&nbsp;anticipate&nbsp;deliberately&nbsp;getting&nbsp;into&nbsp;this&nbsp;state&nbsp;from&nbsp;time&nbsp;to&nbsp;time,&nbsp;when&nbsp;we&nbsp;e.g.&nbsp;upgrade&nbsp;HBase)&lt;/div&gt;<br>
&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;the&nbsp;message&nbsp;itself&nbsp;will&nbsp;be&nbsp;in&nbsp;memory&nbsp;unless&nbsp;it&amp;#39;s&nbsp;swapped&nbsp;out.&nbsp; Indeed,&nbsp;even&nbsp;if&nbsp;the&nbsp;message&nbsp;is&nbsp;swapped&nbsp;out&nbsp;due&nbsp;to&nbsp;memory&nbsp;pressure&nbsp;there&amp;#39;s&nbsp;a&nbsp;tiny&nbsp;bit&nbsp;of&nbsp;overhead&nbsp;corresponding&nbsp;to&nbsp;it&nbsp;that&nbsp;lurks&nbsp;in&nbsp;the&nbsp;Erlang&nbsp;Term&nbsp;Service&nbsp;store&nbsp;that&nbsp;Rabbit&nbsp;uses...&nbsp; in&nbsp;rare&nbsp;cases&nbsp;this&nbsp;latter&nbsp;overhead&nbsp;can&nbsp;cause&nbsp;grief&nbsp;on&nbsp;its&nbsp;own,&nbsp;if&nbsp;things&nbsp;are&nbsp;allowed&nbsp;to&nbsp;stay&nbsp;out&nbsp;of&nbsp;balance&nbsp;too&nbsp;long.&nbsp; &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;As&nbsp;for&nbsp;something&nbsp;being&nbsp;in&nbsp;memory&nbsp;for&nbsp;each&nbsp;message&nbsp;on&nbsp;a&nbsp;queue,&nbsp;modulo&nbsp;the&nbsp;ETS&nbsp;bit&nbsp;that&nbsp;you&nbsp;can&amp;#39;t&nbsp;do&nbsp;anything&nbsp;about,&nbsp;the&nbsp;ways&nbsp;to&nbsp;work&nbsp;around&nbsp;this&nbsp;are&nbsp;to:&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;Let&nbsp;the&nbsp;broker&nbsp;swap&nbsp;messages&nbsp;out&nbsp;to&nbsp;disk&nbsp;in&nbsp;order&nbsp;to&nbsp;get&nbsp;below&nbsp;the&nbsp;configured&nbsp;memory&nbsp;watermark,&nbsp;at&nbsp;which&nbsp;point&nbsp;the&nbsp;TCP&nbsp;back&nbsp;pressure&nbsp;that&nbsp;will&nbsp;be&nbsp;stiff&nbsp;arming&nbsp;publishers&nbsp;will&nbsp;relent&nbsp;and&nbsp;they&amp;#39;ll&nbsp;start&nbsp;publishing&nbsp;again&lt;/li&gt;<br>
&lt;li&gt;Catch&nbsp;up&nbsp;on&nbsp;consuming&nbsp;your&nbsp;messages,&nbsp;perhaps&nbsp;by&nbsp;starting&nbsp;more&nbsp;consumers&nbsp;in&nbsp;response&nbsp;to&nbsp;the&nbsp;demand&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;<br>
<br>
&lt;div&gt;-&nbsp;I&amp;#39;m&nbsp;kind&nbsp;of&nbsp;in&nbsp;a&nbsp;deadlock&nbsp;I&nbsp;think&nbsp;now&nbsp;as&nbsp;when&nbsp;the&nbsp;consumers&nbsp;start,&nbsp;they&nbsp;won&amp;#39;t&nbsp;ack&nbsp;a&nbsp;message&nbsp;until&nbsp;they&nbsp;have&nbsp;successfully&nbsp;sent&nbsp;a&nbsp;message&nbsp;on&nbsp;(it&amp;#39;s&nbsp;a&nbsp;multihop&nbsp;process)&nbsp;but&nbsp;that&nbsp;is&nbsp;blocked.&nbsp; Should&nbsp;the&nbsp;per&nbsp;connection&nbsp;flow&nbsp;control&nbsp;not&nbsp;have&nbsp;kicked&nbsp;in&nbsp;and&nbsp;blocked&nbsp;the&nbsp;producers&nbsp;before&nbsp;the&nbsp;whole&nbsp;lot&nbsp;just&nbsp;blocked?&nbsp; (have&nbsp;I&nbsp;missed&nbsp;some&nbsp;setting&nbsp;to&nbsp;enable&nbsp;that,&nbsp;as&nbsp;the&nbsp;docs&nbsp;say&nbsp;it&nbsp;is&nbsp;on&nbsp;by&nbsp;default).&lt;/div&gt;<br>
&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Are&nbsp;these&nbsp;consumers&nbsp;doing&nbsp;something&nbsp;else&nbsp;with&nbsp;the&nbsp;message&nbsp;before&nbsp;republishing&nbsp;it,&nbsp;say&nbsp;taking&nbsp;some&nbsp;real&nbsp;world&nbsp;action&nbsp;or&nbsp;doing&nbsp;something&nbsp;to&nbsp;a&nbsp;database&nbsp;elsewhere?&nbsp; If&nbsp;your&nbsp;app&nbsp;design&nbsp;has&nbsp;a&nbsp;case&nbsp;where&nbsp;publishes&nbsp;could&nbsp;be&nbsp;blocked&nbsp;(say&nbsp;due&nbsp;to&nbsp;over&nbsp;eager&nbsp;producers,&nbsp;or&nbsp;failure&nbsp;or&nbsp;slowdown&nbsp;of&nbsp;consumers)&nbsp;you&nbsp;might&nbsp;consider&nbsp;doing&nbsp;something&nbsp;like&nbsp;making&nbsp;your&nbsp;routing&nbsp;fabric&nbsp;a&nbsp;bit&nbsp;richer&nbsp;so&nbsp;that&nbsp;virtual&nbsp;copies&nbsp;of&nbsp;the&nbsp;message&nbsp;might&nbsp;move&nbsp;around&nbsp;in&nbsp;the&nbsp;broker&nbsp;without&nbsp;an&nbsp;explicit&nbsp;consume/do-stuff/ack/re-publish&nbsp;cycle&nbsp;which,&nbsp;as&nbsp;you&nbsp;point&nbsp;out,&nbsp;can&nbsp;get&nbsp;jammed&nbsp;up&nbsp;if&nbsp;the&nbsp;re-publishes&nbsp;are&nbsp;being&nbsp;held.&nbsp; That&nbsp;said,&nbsp;modulo&nbsp;the&nbsp;rare&nbsp;ETS&nbsp;catastrophe,&nbsp;the&nbsp;broker&amp;#39;s&nbsp;default&nbsp;swapping&nbsp;mechanism&nbsp;should&nbsp;catch&nbsp;up&nbsp;and&nbsp;obviate&nbsp;some&nbsp;of&nbsp;the&nbsp;memory&nbsp;pressure&nbsp;that&amp;#39;s&nbsp;causing&nbsp;the&nbsp;trouble.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;that&nbsp;make&nbsp;sense?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;BTW,&nbsp;there&amp;#39;s&nbsp;a&nbsp;nice&nbsp;description&nbsp;of&nbsp;what&nbsp;various&nbsp;entities&nbsp;in&nbsp;Rabbit&nbsp;cost&nbsp;in&nbsp;the&nbsp;Manning&nbsp;book&nbsp;&amp;quot;RabbitMQ&nbsp;in&nbsp;Action,&amp;quot;&nbsp;in&nbsp;Chapter&nbsp;11,&nbsp;IIRC.&nbsp; Giving&nbsp;that&nbsp;a&nbsp;read&nbsp;will&nbsp;be&nbsp;very&nbsp;helpful&nbsp;for&nbsp;building&nbsp;intuition&nbsp;on&nbsp;what&nbsp;happens&nbsp;where,&nbsp;what&nbsp;it&nbsp;costs,&nbsp;etc...&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Best&nbsp;regards,&lt;/div&gt;&lt;div&gt;Jerry&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
