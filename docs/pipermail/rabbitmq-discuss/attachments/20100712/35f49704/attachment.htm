<tt>
Hello&nbsp;RabbitMQ&nbsp;users,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;While&nbsp;load&nbsp;testing&nbsp;my&nbsp;RabbitMQ-based&nbsp;RPC&nbsp;mechanism,&nbsp;I&nbsp;managed&nbsp;to&nbsp;get&nbsp;my&nbsp;RabbitMQ&nbsp;server&nbsp;into&nbsp;some&nbsp;very&nbsp;interesting&nbsp;states&nbsp;when&nbsp;it&nbsp;had&nbsp;a&nbsp;large&nbsp;number&nbsp;of&nbsp;connections.&nbsp;When&nbsp;the&nbsp;AMQP&nbsp;server&nbsp;exceeded&nbsp;~1020&nbsp;active&nbsp;connections,&nbsp;it&nbsp;would&nbsp;become&nbsp;unstable&nbsp;and&nbsp;eventually&nbsp;crash&nbsp;in&nbsp;a&nbsp;way&nbsp;that&nbsp;lost&nbsp;some&nbsp;data&nbsp;(including&nbsp;a&nbsp;few&nbsp;persistent&nbsp;messages&nbsp;that&nbsp;had&nbsp;been&nbsp;posted&nbsp;to&nbsp;durable&nbsp;queues).&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;cause&nbsp;for&nbsp;the&nbsp;crash&nbsp;wasn&amp;#39;t&nbsp;hard&nbsp;to&nbsp;discover:&nbsp;the&nbsp;parent&nbsp;process&nbsp;of&nbsp;RabbitMQ&nbsp;was&nbsp;restricted&nbsp;to&nbsp;1,024&nbsp;open&nbsp;file&nbsp;handles&nbsp;(this&nbsp;is&nbsp;apparently&nbsp;the&nbsp;default&nbsp;for&nbsp;the&nbsp;Linux&nbsp;distro&nbsp;I&nbsp;was&nbsp;running),&nbsp;and&nbsp;the&nbsp;resource&nbsp;limit&nbsp;is&nbsp;inherited&nbsp;by&nbsp;child&nbsp;processes.&nbsp;Simply&nbsp;adding&nbsp;a&nbsp;&amp;quot;ulimit&nbsp;-n&nbsp;65535&amp;quot;&nbsp;to&nbsp;the&nbsp;RabbitMQ&nbsp;init&nbsp;script&nbsp;and&nbsp;a&nbsp;&amp;quot;+P 131072&amp;quot;&nbsp;to&nbsp;the&nbsp;Erlang&nbsp;VM&nbsp;command-line&nbsp;gave&nbsp;the&nbsp;server&nbsp;enough&nbsp;file&nbsp;handles&nbsp;and&nbsp;Erlang&nbsp;processes&nbsp;to&nbsp;handle&nbsp;the&nbsp;load.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;piqued&nbsp;my&nbsp;interest,&nbsp;however,&nbsp;was&nbsp;the&nbsp;catastrophic&nbsp;and&nbsp;data-lossy&nbsp;way&nbsp;in&nbsp;which&nbsp;the&nbsp;server&nbsp;crashed&nbsp;when&nbsp;it&nbsp;reached&nbsp;its&nbsp;limit.&nbsp;Normally,&nbsp;RabbitMQ&nbsp;is&nbsp;very&nbsp;good&nbsp;about&nbsp;avoiding&nbsp;data&nbsp;loss&nbsp;even&nbsp;when&nbsp;it&nbsp;crashes!&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Some&nbsp;scrutiny&nbsp;of&nbsp;the&nbsp;logs&nbsp;yielded&nbsp;the&nbsp;following&nbsp;explanation:&nbsp;exhausting&nbsp;the&nbsp;file&nbsp;handles&nbsp;available&nbsp;to&nbsp;the&nbsp;process&nbsp;prevents&nbsp;various&nbsp;fault-tolerance&nbsp;and&nbsp;process&nbsp;control&nbsp;mechanisms&nbsp;from&nbsp;working,&nbsp;including:&lt;/div&gt;<br>
&lt;div&gt;--&nbsp;a&nbsp;&amp;quot;cpu-sup&amp;quot;&nbsp;process&nbsp;that&nbsp;the&nbsp;VM&nbsp;is&nbsp;trying&nbsp;to&nbsp;communicate&nbsp;with&nbsp;via&nbsp;a&nbsp;port&lt;/div&gt;&lt;div&gt;--&nbsp;writing&nbsp;the&nbsp;Mnesia&nbsp;tables&nbsp;that&nbsp;hold&nbsp;persisted&nbsp;queue&nbsp;contents&lt;/div&gt;&lt;div&gt;--&nbsp;the&nbsp;&amp;quot;rabbitmqctl&amp;quot;&nbsp;process&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;result&nbsp;of&nbsp;all&nbsp;these&nbsp;failures&nbsp;taken&nbsp;together&nbsp;is&nbsp;that&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;shutdown&nbsp;but&nbsp;can&amp;#39;t&nbsp;shutdown&nbsp;cleanly,&nbsp;leading&nbsp;to&nbsp;data&nbsp;loss.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;ultimate&nbsp;solution&nbsp;is&nbsp;rather&nbsp;crude,&nbsp;but&nbsp;workable:&nbsp;using&nbsp;the&nbsp;iptables&nbsp;conntrack&nbsp;module,&nbsp;I&nbsp;will&nbsp;limit&nbsp;the&nbsp;number&nbsp;of&nbsp;inbound&nbsp;TCP&nbsp;connections&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;ensure&nbsp;that&nbsp;the&nbsp;server&nbsp;has&nbsp;enough&nbsp;free&nbsp;file&nbsp;handles&nbsp;to&nbsp;take&nbsp;care&nbsp;of&nbsp;&amp;quot;housekeeping&amp;quot;&nbsp;operations.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;thought&nbsp;I&amp;#39;d&nbsp;share&nbsp;my&nbsp;results&nbsp;with&nbsp;the&nbsp;group&nbsp;in&nbsp;case&nbsp;anyone&nbsp;else&nbsp;has&nbsp;encountered&nbsp;this&nbsp;problem,&nbsp;and&nbsp;also&nbsp;query&nbsp;whether&nbsp;anyone&nbsp;else&nbsp;has&nbsp;come&nbsp;up&nbsp;with&nbsp;a&nbsp;different/better&nbsp;solution.&nbsp;Has&nbsp;anyone&nbsp;run&nbsp;into&nbsp;this&nbsp;yet?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers,&lt;/div&gt;&lt;div&gt;  &nbsp; Tony&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;P.S.&nbsp;Here&nbsp;are&nbsp;some&nbsp;log&nbsp;excerpts&nbsp;from&nbsp;a&nbsp;RabbitMQ&nbsp;server&nbsp;under&nbsp;heavy&nbsp;load&nbsp;that&nbsp;exemplify&nbsp;the&nbsp;problem:&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;border-collapse:&nbsp;collapse;&nbsp;&quot;&gt;&lt;div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace;&nbsp;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace;&nbsp;&quot;&gt;=ERROR&nbsp;REPORT====&nbsp;8-Jul-2010::19:23:13&nbsp;===&lt;/span&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;Error&nbsp;in&nbsp;process&nbsp;&amp;lt;0.121.0&amp;gt;&nbsp;on&nbsp;node&nbsp;&amp;#39;rabbit@TonyS&amp;#39;&nbsp;with&nbsp;exit&nbsp;value:&nbsp;{{badmatch,{error,emfile}},[{cpu_sup,get_uint32_measurement,2},{cpu_sup,measurement_server_loop,1}]}&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;=ERROR&nbsp;REPORT====&nbsp;8-Jul-2010::19:23:18&nbsp;===&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;Error&nbsp;in&nbsp;process&nbsp;&amp;lt;0.5307.0&amp;gt;&nbsp;on&nbsp;node&nbsp;&amp;#39;rabbit@TonyS&amp;#39;&nbsp;with&nbsp;exit&nbsp;value:&nbsp;{emfile,[{erlang,open_port,[{spawn,&amp;quot;/usr/lib/erlang/lib/os_mon-2.2.5/priv/bin/cpu_sup&amp;quot;},[stream]]},{cpu_sup,start_portprogram,0},{cpu_sup,port_server_init,1}]}&lt;/font&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace;&nbsp;&quot;&gt;=ERROR&nbsp;REPORT====&nbsp;8-Jul-2010::19:24:14&nbsp;===&lt;/span&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;Mnesia(rabbit@TonyS):&nbsp;**&nbsp;ERROR&nbsp;**&nbsp;(could&nbsp;not&nbsp;write&nbsp;core&nbsp;file:&nbsp;emfile)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt; **&nbsp;FATAL&nbsp;**&nbsp;Cannot&nbsp;open&nbsp;log&nbsp;file&nbsp;&amp;quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_queue.DCL&amp;quot;:&nbsp;{file_error,&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_queue.DCL&amp;quot;,&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;emfile}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;&lt;br&gt;<br>
&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;=INFO&nbsp;REPORT====&nbsp;8-Jul-2010::19:24:14&nbsp;===&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; application:&nbsp;mnesia&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; exited:&nbsp;shutdown&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; type:&nbsp;permanent&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#CC0000&quot;&gt;&lt;b&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;-------^&nbsp;someone&nbsp;decides&nbsp;to&nbsp;shutdown&nbsp;everything;&nbsp;tries&nbsp;to&nbsp;do&nbsp;a&nbsp;clean&nbsp;shutdown&nbsp;but&nbsp;can&amp;#39;t&nbsp;persist&nbsp;state&nbsp; ^-------&lt;/font&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;=ERROR&nbsp;REPORT====&nbsp;8-Jul-2010::19:24:14&nbsp;===&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;**&nbsp;gen_event&nbsp;handler&nbsp;rabbit_error_logger&nbsp;crashed.&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;**&nbsp;Was&nbsp;installed&nbsp;in&nbsp;error_logger&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;**&nbsp;Last&nbsp;event&nbsp;was:&nbsp;{error,&amp;lt;0.39.0&amp;gt;,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&amp;lt;0.42.0&amp;gt;,&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;quot;Mnesia(~p):&nbsp;**&nbsp;ERROR&nbsp;**&nbsp;(could&nbsp;not&nbsp;write&nbsp;core&nbsp;file:&nbsp;~p)~n&nbsp;**&nbsp;FATAL&nbsp;**&nbsp;Cannot&nbsp;open&nbsp;log&nbsp;file&nbsp;~p:&nbsp;~p~n&amp;quot;,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [rabbit@TonyS,emfile,&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_queue.DCL&amp;quot;,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{file_error,&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_queue.DCL&amp;quot;,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;emfile}]}}&lt;/font&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#CC0000&quot;&gt;&lt;b&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;-------^&nbsp;can&amp;#39;t&nbsp;even&nbsp;write&nbsp;a&nbsp;crash&nbsp;dump&nbsp;^-------&lt;/font&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#CC0000&quot;&gt;&lt;b&gt;&lt;font&nbsp;face=&quot;&amp;#39;courier&nbsp;new&amp;#39;,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;<br>

</tt>
