<tt>
Before&nbsp;you&nbsp;spend&nbsp;too&nbsp;much&nbsp;time&nbsp;on&nbsp;this,&nbsp;I&nbsp;think&nbsp;I&nbsp;found&nbsp;the&nbsp;problem. Posting&nbsp;it&nbsp;here&nbsp;for&nbsp;the&nbsp;benefit&nbsp;of&nbsp;future&nbsp;strugglers.&lt;div&gt;&lt;br&gt;&lt;div&gt;It&nbsp;looks&nbsp;like&nbsp;a&nbsp;TCP&nbsp;port exhaustion on&nbsp;the&nbsp;client&nbsp;side.&lt;/div&gt;&lt;div&gt;What&nbsp;happens&nbsp;is,&nbsp;unlike&nbsp;our&nbsp;main&nbsp;app,&nbsp;our&nbsp;healthcheck&nbsp;page&nbsp;opens&nbsp;(and&nbsp;closes)&nbsp;a&nbsp;new&nbsp;connection&nbsp;every&nbsp;time&nbsp;it&nbsp;is&nbsp;hit.&nbsp;The&nbsp;healthcheck&nbsp;page&nbsp;is&nbsp;hit&nbsp;every&nbsp;5&nbsp;seconds.&nbsp;By&nbsp;default&nbsp;on&nbsp;Windows&nbsp;the&nbsp;ephemeral&nbsp;TCP&nbsp;port&nbsp;can&amp;#39;t&nbsp;be&nbsp;reused&nbsp;until&nbsp;after&nbsp;240&nbsp;seconds&nbsp;after&nbsp;it&amp;#39;s&nbsp;closed.&nbsp;Hence&nbsp;the&nbsp;port&nbsp;exhaustion.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;Cheers.&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Nov&nbsp;29,&nbsp;2012&nbsp;at&nbsp;11:37&nbsp;AM,&nbsp;Andrei&nbsp;Volkov&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:zvolkov@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;zvolkov@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
Hi&nbsp;Emile! &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;do&nbsp;have&nbsp;the&nbsp;hearbeat&nbsp;enabled,&nbsp;and&nbsp;set&nbsp;to&nbsp;5&nbsp;seconds.&nbsp;According&nbsp;to&nbsp;traces&nbsp;it&nbsp;is actually happening&nbsp;every&nbsp;2&nbsp;to&nbsp;4&nbsp;seconds.&nbsp;Rackspace&nbsp;have&nbsp;confirmed&nbsp;the&nbsp;network&nbsp;hardware&nbsp;is&nbsp;configured&nbsp;to&nbsp;drop&nbsp;idle&nbsp;connections&nbsp;after&nbsp;one&nbsp;hour.&nbsp;This&nbsp;should&nbsp;not&nbsp;be&nbsp;an&nbsp;issue&nbsp;then.&lt;div&gt;<br>
<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;also&nbsp;see&nbsp;a&nbsp;large&nbsp;number&nbsp;of&nbsp;connections&nbsp;opened&nbsp;and&nbsp;closed&nbsp;immediately.&nbsp;According&nbsp;to&nbsp;Rackspace,&nbsp;the&nbsp;connections&nbsp;are&nbsp;closed&nbsp;with&nbsp;an&nbsp;RST&nbsp;instead&nbsp;of&nbsp;an&nbsp;FIN,&nbsp;however&nbsp;I&nbsp;don&amp;#39;t&nbsp;see&nbsp;the&nbsp;&amp;quot;abrupt&amp;quot;&nbsp;termination&nbsp;errors&nbsp;in&nbsp;RabbitMQ&nbsp;logs,&nbsp;all&nbsp;I&nbsp;see&nbsp;is&nbsp;a&nbsp;large&nbsp;number&nbsp;(about&nbsp;35,000&nbsp;per&nbsp;day)&nbsp;of&nbsp;messages&nbsp;like&nbsp;this:&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;=INFO&nbsp;REPORT====&nbsp;21-Nov-2012::10:57:26&nbsp;===&lt;/div&gt;&lt;div&gt;accepting&nbsp;AMQP&nbsp;connection&nbsp;&amp;lt;0.30152.855&amp;gt;&nbsp;(&lt;a&nbsp;href=&quot;http://192.168.221.206:58724&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.221.206:58724&lt;/a&gt;&nbsp;-&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;http://192.168.220.208:5672&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.220.208:5672&lt;/a&gt;)&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;=INFO&nbsp;REPORT====&nbsp;21-Nov-2012::10:57:26&nbsp;===&lt;/div&gt;&lt;div&gt;closing&nbsp;AMQP&nbsp;connection&nbsp;&amp;lt;0.30152.855&amp;gt;&nbsp;(&lt;a&nbsp;href=&quot;http://192.168.221.206:58724&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.221.206:58724&lt;/a&gt;&nbsp;-&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;http://192.168.220.208:5672&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.220.208:5672&lt;/a&gt;)&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;this&nbsp;normal?&nbsp;What&nbsp;could&nbsp;be&nbsp;causing&nbsp;this?&nbsp;How&nbsp;can&nbsp;I&nbsp;further&nbsp;troubleshoot&nbsp;this?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Many&nbsp;thanks!&lt;/div&gt;&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;~AV&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;div&gt;<br>
<br>
&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Nov&nbsp;28,&nbsp;2012&nbsp;at&nbsp;5:18&nbsp;AM,&nbsp;Emile&nbsp;Joubert&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:emile@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;emile@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hi&nbsp;Andrei,&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;27/11/12&nbsp;17:32,&nbsp;Andrei&nbsp;Volkov&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;think&nbsp;(but&nbsp;not&nbsp;sure)&nbsp;it&nbsp;seems&nbsp;to&nbsp;happen&nbsp;after&nbsp;a&nbsp;period&nbsp;of&nbsp;inactivity,&lt;br&gt;<br>
after&nbsp;the&nbsp;connection&nbsp;has&nbsp;been&nbsp;open&nbsp;but&nbsp;idle&nbsp;for&nbsp;a&nbsp;while.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
In&nbsp;that&nbsp;case&nbsp;a&nbsp;possible&nbsp;cause&nbsp;is&nbsp;that&nbsp;the&nbsp;connection&nbsp;dropped&nbsp;due&nbsp;to&nbsp;a&nbsp;time-out.&nbsp;You&nbsp;can&nbsp;work&nbsp;around&nbsp;this&nbsp;by&nbsp;enabling&nbsp;AMQP&nbsp;heartbeats.&nbsp;They&nbsp;will&nbsp;prevent&nbsp;inactivity&nbsp;and&nbsp;detect&nbsp;broken&nbsp;connections&nbsp;sooner.&nbsp;See&nbsp;the&nbsp;client&nbsp;library&nbsp;documentation&nbsp;for&nbsp;2.8.7:&lt;br&gt;<br>
<br>
<br>
<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/releases/rabbitmq-dotnet-client/v2.8.7/rabbitmq-dotnet-client-2.8.7-client-htmldoc/html/type-RabbitMQ.Client.ConnectionFactory.html#field-F:RabbitMQ.Client.ConnectionFactory.RequestedHeartbeat&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/&lt;u&gt;&lt;/u&gt;releases/rabbitmq-dotnet-&lt;u&gt;&lt;/u&gt;client/v2.8.7/rabbitmq-dotnet-&lt;u&gt;&lt;/u&gt;client-2.8.7-client-htmldoc/&lt;u&gt;&lt;/u&gt;html/type-RabbitMQ.Client.&lt;u&gt;&lt;/u&gt;ConnectionFactory.html#field-&lt;u&gt;&lt;/u&gt;F:RabbitMQ.Client.&lt;u&gt;&lt;/u&gt;ConnectionFactory.&lt;u&gt;&lt;/u&gt;RequestedHeartbeat&lt;/a&gt;&lt;br&gt;<br>
<br>
<br>
<br>
&lt;br&gt;<br>
You&nbsp;can&nbsp;also&nbsp;diagnose&nbsp;connectivity&nbsp;issues&nbsp;by&nbsp;issuing&nbsp;&amp;quot;rabbitmqctl&nbsp;list_connections&amp;quot;&nbsp;on&nbsp;the&nbsp;broker&nbsp;and&nbsp;by&nbsp;checking&nbsp;&amp;quot;netstat&amp;quot;&nbsp;on&nbsp;both&nbsp;the&nbsp;broker&nbsp;and&nbsp;the&nbsp;client.&lt;span&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
-Emile&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
