<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&nbsp;have&nbsp;been&nbsp;having&nbsp;some&nbsp;problems&nbsp;with&nbsp;the&nbsp;java-rabbitmq-client&nbsp;when&nbsp;stress&nbsp;testing&nbsp;it.&nbsp;I&nbsp;frequently&nbsp;get&nbsp;&amp;quot;COMMAND_INVALID&nbsp;-&nbsp;second&nbsp;&amp;#39;channel.open&amp;#39;&nbsp;seen&amp;quot;,&nbsp;which&nbsp;eventually&nbsp;closes&nbsp;the&nbsp;connection&nbsp;(not&nbsp;just&nbsp;the&nbsp;channel).&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;It&nbsp;seems&nbsp;that&nbsp;there&nbsp;is&nbsp;a&nbsp;race&nbsp;condition&nbsp;when&nbsp;channels&nbsp;are&nbsp;closed&nbsp;asynchronously&nbsp;(due&nbsp;to&nbsp;errors),&nbsp;and&nbsp;created&nbsp;in&nbsp;other&nbsp;threads.&nbsp;The&nbsp;channel&nbsp;that&nbsp;is&nbsp;closed&nbsp;(by&nbsp;the&nbsp;server)&nbsp;doesn&amp;#39;t&nbsp;seem&nbsp;to&nbsp;be&nbsp;fully&nbsp;closed&nbsp;before&nbsp;another&nbsp;thread&nbsp;can&nbsp;try&nbsp;to&nbsp;open&nbsp;a&nbsp;channel&nbsp;with&nbsp;the&nbsp;same&nbsp;number.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;The&nbsp;code&nbsp;to&nbsp;reproduce&nbsp;it&nbsp;is&nbsp;at &lt;a&nbsp;href=&quot;https://github.com/boivie/rmq-stress-test&quot;&gt;https://github.com/boivie/rmq-stress-test&lt;/a&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;A&nbsp;possible&nbsp;fix&nbsp;is&nbsp;below.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Thanks,&lt;/div&gt;&lt;div&nbsp;style&gt;Victor&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;div&gt;From&nbsp;213cf8ef15a759985bc9dd74496548236b5160f2&nbsp;Mon&nbsp;Sep&nbsp;17&nbsp;00:00:00&nbsp;2001&lt;/div&gt;&lt;div&gt;From:&nbsp;Victor&nbsp;Boivie&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:victor@boivie.com&quot;&gt;victor@boivie.com&lt;/a&gt;&amp;gt;&lt;/div&gt;<br>
&lt;div&gt;Date:&nbsp;Wed,&nbsp;27&nbsp;Mar&nbsp;2013&nbsp;07:22:04&nbsp;+0100&lt;/div&gt;&lt;div&gt;Subject:&nbsp;[PATCH]&nbsp;Fix&nbsp;race-condition&nbsp;of&nbsp;asynchronously&nbsp;closed&nbsp;channels&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;a&nbsp;channel&nbsp;is&nbsp;closed&nbsp;from&nbsp;the&nbsp;server&nbsp;side&nbsp;due&nbsp;to&nbsp;errors&nbsp;we&lt;/div&gt;&lt;div&gt;<br>
have&nbsp;to&nbsp;send&nbsp;CloseOk&nbsp;before&nbsp;we&nbsp;can&nbsp;make&nbsp;it&nbsp;available&nbsp;for&nbsp;allocation&lt;/div&gt;&lt;div&gt;again.&nbsp;If&nbsp;not,&nbsp;we&nbsp;risk&nbsp;handing&nbsp;it&nbsp;out&nbsp;to&nbsp;a&nbsp;client&nbsp;which&nbsp;will&nbsp;open&nbsp;it&lt;/div&gt;&lt;div&gt;when&nbsp;it&amp;#39;s&nbsp;not&nbsp;yet&nbsp;fully&nbsp;closed,&nbsp;which&nbsp;results&nbsp;in&nbsp;a&lt;/div&gt;&lt;div&gt;<br>
&amp;quot;COMMAND_INVALID&nbsp;-&nbsp;second&nbsp;&amp;#39;channel.open&amp;#39;&nbsp;seen&amp;quot;.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;diff&nbsp;--git&nbsp;a/src/com/rabbitmq/client/impl/ChannelN.java&nbsp;b/src/com/rabbitmq/client/impl/ChannelN.java&lt;/div&gt;&lt;div&gt;index&nbsp;18e4f6a..9fe11c3&nbsp;100644&lt;/div&gt;<br>
&lt;div&gt;---&nbsp;a/src/com/rabbitmq/client/impl/ChannelN.java&lt;/div&gt;&lt;div&gt;+++&nbsp;b/src/com/rabbitmq/client/impl/ChannelN.java&lt;/div&gt;&lt;div&gt;@@&nbsp;-471,7&nbsp;+471,6&nbsp;@@&nbsp;public&nbsp;class&nbsp;ChannelN&nbsp;extends&nbsp;AMQChannel&nbsp;implements&nbsp;com.rabbitmq.client.Channel&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; private&nbsp;void&nbsp;asyncShutdown(Command&nbsp;command)&nbsp;throws&nbsp;IOException&nbsp;{&lt;/div&gt;&lt;div&gt;-&nbsp; &nbsp; &nbsp; &nbsp; releaseChannel();&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; ShutdownSignalException&nbsp;signal&nbsp;=&nbsp;new&nbsp;ShutdownSignalException(false,&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;false,&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;command,&lt;/div&gt;&lt;div&gt;@@&nbsp;-484,6&nbsp;+483,7&nbsp;@@&nbsp;public&nbsp;class&nbsp;ChannelN&nbsp;extends&nbsp;AMQChannel&nbsp;implements&nbsp;com.rabbitmq.client.Channel&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; notifyOutstandingRpc(signal);&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt;+&nbsp; &nbsp; &nbsp; &nbsp; releaseChannel();&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; notifyListeners();&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
