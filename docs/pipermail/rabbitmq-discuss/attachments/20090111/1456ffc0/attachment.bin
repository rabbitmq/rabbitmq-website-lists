// Main.cs created with MonoDevelop
// User: mike at 1:25 pÂ 11/01/2009
//
// To change standard headers go to Edit->Preferences->Coding->Standard Headers
//
using System;
using System.Text;
using RabbitMQ.Client;
using RabbitMQ.Client.MessagePatterns;
using RabbitMQ.Client.Events;
using RabbitMQ.Util;

namespace testrabbitmq15
{
	class MainClass
	{
		public static void Main(string[] args)
		{
			while (true)
				Run(args);
		}
		
		public static void Run(string[] args)
		{
			string qName = "xyz02";
			string message = "Hello";
			ConnectionFactory cf = new ConnectionFactory ();
			
			using (IConnection cn = cf.CreateConnection ("localhost")) {
				using (IModel model = cn.CreateModel ()) {
					ushort ticket = model.AccessRequest("/data");
					
					string finalName = model.QueueDeclare (ticket, qName, true);
					model.BasicPublish (ticket, "", finalName, null,
					                    Encoding.UTF8.GetBytes (message));
				}
			}

			using (IConnection cn = cf.CreateConnection ("localhost")) {
				using (IModel model = cn.CreateModel ()) {
					ushort ticket = model.AccessRequest("/data");
					
					string finalName = model.QueueDeclare (ticket, qName, true);

					BasicGetResult result = model.BasicGet(ticket, finalName, false);
					string val = Encoding.UTF8.GetString (result.Body);
					Console.WriteLine(val);
				}
			}
		}
	}
}