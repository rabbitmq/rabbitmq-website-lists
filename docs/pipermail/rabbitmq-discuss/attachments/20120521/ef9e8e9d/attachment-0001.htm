<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;How's&nbsp;that&nbsp;for&nbsp;a&nbsp;useless&nbsp;mysterious&nbsp;title?&nbsp;&amp;nbsp;A&nbsp;bit&nbsp;more&nbsp;on&nbsp;what&nbsp;we're&nbsp;seeing:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I'm&nbsp;running&nbsp;2.8.1,&nbsp;and&nbsp;I&nbsp;have&nbsp;one&nbsp;queue&nbsp;in&nbsp;our&nbsp;setup&nbsp;with&nbsp;a&nbsp;long&nbsp;TTL&nbsp;(&quot;expiring-queue&quot;,&nbsp;we'll&nbsp;call&nbsp;it),&nbsp;which&nbsp;then&nbsp;uses&nbsp;dead-letter-exchange&nbsp;to&nbsp;reroute&nbsp;to&nbsp;another&nbsp;queue&nbsp;(&quot;action-queue&quot;).&nbsp;&amp;nbsp;The&nbsp;TTL&nbsp;for&nbsp;these&nbsp;expiring&nbsp;messages&nbsp;is&nbsp;7&nbsp;days.&nbsp;&amp;nbsp;So&nbsp;it&nbsp;looks&nbsp;like&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[ec2-user@web03&nbsp;current]$&nbsp;sudo&nbsp;rabbitmqctl&nbsp;list_queues&nbsp;name&nbsp;messages&nbsp;arguments&nbsp;durable&lt;/div&gt;&lt;div&gt;expiring-queue&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;311443&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;[{&quot;x-dead-letter-exchange&quot;,&quot;my-exchange&quot;},{&quot;x-message-ttl&quot;,604800000},{&quot;x-dead-letter-routing-key&quot;,&quot;action-queue&quot;}]&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;true&lt;/div&gt;&lt;div&gt;action-queue&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;0&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;[]&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;true&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;(BTW,&nbsp;What&nbsp;I'm&nbsp;doing&nbsp;is&nbsp;using&nbsp;the&nbsp;TTL&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;keep&nbsp;track&nbsp;of&nbsp;an&nbsp;event&nbsp;that&nbsp;expires&nbsp;after&nbsp;one&nbsp;week.&nbsp;&amp;nbsp;Namely,&nbsp;we&nbsp;keep&nbsp;a&nbsp;count&nbsp;of&nbsp;a&nbsp;particular&nbsp;event&nbsp;for&nbsp;the&nbsp;last&nbsp;7&nbsp;days.&nbsp;&amp;nbsp;So&nbsp;each&nbsp;time&nbsp;the&nbsp;event&nbsp;happens&nbsp;we&nbsp;write&nbsp;to&nbsp;the&nbsp;action-queue&nbsp;which&nbsp;increments&nbsp;the&nbsp;value,&nbsp;and&nbsp;to&nbsp;the&nbsp;expiring&nbsp;queue.&nbsp;7&nbsp;days&nbsp;later,&nbsp;that&nbsp;message&nbsp;gets&nbsp;expired&nbsp;into&nbsp;the&nbsp;action-queue&nbsp;again,&nbsp;and&nbsp;we&nbsp;decrement&nbsp;the&nbsp;counter.&nbsp;&amp;nbsp;So&nbsp;we&nbsp;have&nbsp;a&nbsp;real-time,&nbsp;running&nbsp;7&nbsp;day&nbsp;counter.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;for&nbsp;the&nbsp;most&nbsp;part&nbsp;is&nbsp;stable.&nbsp;&amp;nbsp;Except&nbsp;when&nbsp;it's&nbsp;not.&nbsp;&amp;nbsp;We've&nbsp;seen&nbsp;3&nbsp;or&nbsp;4&nbsp;crashes&nbsp;of&nbsp;this&nbsp;system&nbsp;since&nbsp;we&nbsp;set&nbsp;it&nbsp;up&nbsp;3&nbsp;weeks&nbsp;ago.&nbsp;&amp;nbsp;I&nbsp;can't&nbsp;find&nbsp;any&nbsp;information&nbsp;in&nbsp;the&nbsp;logs&nbsp;to&nbsp;tell&nbsp;me&nbsp;why&nbsp;Rabbit&nbsp;crashed,&nbsp;it&nbsp;just&nbsp;dies&nbsp;silently.&nbsp;&amp;nbsp;But&nbsp;more&nbsp;distributing&nbsp;is&nbsp;that&nbsp;when&nbsp;I&nbsp;bring&nbsp;it&nbsp;back&nbsp;up,&nbsp;all&nbsp;the&nbsp;messages&nbsp;(typically&nbsp;millions)&nbsp;in&nbsp;the&nbsp;expiring-queue&nbsp;are&nbsp;gone.&nbsp;&amp;nbsp;That's&nbsp;death&nbsp;for&nbsp;me,&nbsp;because&nbsp;that's&nbsp;the&nbsp;only&nbsp;record&nbsp;of&nbsp;when&nbsp;those&nbsp;things&nbsp;are&nbsp;supposed&nbsp;to&nbsp;expire.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;leads&nbsp;on&nbsp;where&nbsp;to&nbsp;look&nbsp;for&nbsp;more&nbsp;crash&nbsp;reports&nbsp;or&nbsp;evidence&nbsp;of&nbsp;what's&nbsp;happening&nbsp;here?&nbsp;&amp;nbsp;And&nbsp;importantly,&nbsp;in&nbsp;what&nbsp;case&nbsp;would&nbsp;these&nbsp;messages&nbsp;be&nbsp;lost&nbsp;(seems&nbsp;like&nbsp;that&nbsp;should&nbsp;never&nbsp;happen!)&nbsp;&amp;nbsp;The&nbsp;queue&nbsp;is&nbsp;durable,&nbsp;and&nbsp;I'm&nbsp;using&nbsp;deliveryMode=2&nbsp;for&nbsp;the&nbsp;messages.&nbsp;&amp;nbsp;I'm&nbsp;pretty&nbsp;sure&nbsp;that&nbsp;persistence&nbsp;works&nbsp;in&nbsp;general,&nbsp;because&nbsp;I&nbsp;can&nbsp;stop&nbsp;rabbit&nbsp;and&nbsp;restart&nbsp;it&nbsp;and&nbsp;all&nbsp;the&nbsp;messages&nbsp;are&nbsp;still&nbsp;there...they&nbsp;are&nbsp;only&nbsp;lost&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;this&nbsp;odd&nbsp;silent&nbsp;crash.&nbsp;&amp;nbsp;I've&nbsp;also&nbsp;tried&nbsp;doing&nbsp;evil&nbsp;things&nbsp;like&nbsp;kill&nbsp;-9&nbsp;various&nbsp;server&nbsp;processes,&nbsp;and&nbsp;haven't&nbsp;been&nbsp;able&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;message&nbsp;loss&nbsp;in&nbsp;any&nbsp;controlled&nbsp;environment.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I'm&nbsp;LOVING&nbsp;that&nbsp;this&nbsp;could&nbsp;work&nbsp;in&nbsp;Rabbit&nbsp;with&nbsp;the&nbsp;2.8&nbsp;updates,&nbsp;hoping&nbsp;to&nbsp;not&nbsp;have&nbsp;to&nbsp;move&nbsp;to&nbsp;another&nbsp;queueing&nbsp;system&nbsp;where&nbsp;I&nbsp;have&nbsp;to&nbsp;build&nbsp;all&nbsp;the&nbsp;dead-letter-routing&nbsp;stuff&nbsp;myself,&nbsp;when&nbsp;this&nbsp;is&nbsp;so&nbsp;close&nbsp;to&nbsp;a&nbsp;clean&nbsp;solution.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;any&nbsp;thoughts.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-Will&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;apple-content-edited=&quot;true&quot;&gt;<br>
&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-family:&nbsp;Helvetica;&nbsp;font-style:&nbsp;normal;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;normal;&nbsp;orphans:&nbsp;2;&nbsp;text-align:&nbsp;-webkit-auto;&nbsp;text-indent:&nbsp;0px;&nbsp;text-transform:&nbsp;none;&nbsp;white-space:&nbsp;normal;&nbsp;widows:&nbsp;2;&nbsp;word-spacing:&nbsp;0px;&nbsp;-webkit-border-horizontal-spacing:&nbsp;0px;&nbsp;-webkit-border-vertical-spacing:&nbsp;0px;&nbsp;-webkit-text-decorations-in-effect:&nbsp;none;&nbsp;-webkit-text-size-adjust:&nbsp;auto;&nbsp;-webkit-text-stroke-width:&nbsp;0px;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;________________&lt;/div&gt;&lt;div&gt;Will&nbsp;Koffel&lt;/div&gt;&lt;div&gt;CTO,&nbsp;Thumb™&lt;/div&gt;&lt;div&gt;51&nbsp;E&nbsp;12th&nbsp;St.,&nbsp;4th&nbsp;Floor&lt;/div&gt;&lt;div&gt;New&nbsp;York,&nbsp;NY&nbsp;10003&lt;/div&gt;&lt;div&gt;Office:&nbsp;(212)&nbsp;673-8650&lt;/div&gt;&lt;div&gt;Mobile:&nbsp;(617)&nbsp;575-WILL&lt;/div&gt;&lt;div&gt;@thumb&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;http://www.thumb.it/&quot;&gt;www.thumb.it&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
