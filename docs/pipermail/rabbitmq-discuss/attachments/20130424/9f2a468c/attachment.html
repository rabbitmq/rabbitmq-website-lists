<tt>
Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;improve&nbsp;the&nbsp;message&nbsp;throughput&nbsp;for&nbsp;a&nbsp;RabbitMQ&nbsp;queue&nbsp;in&nbsp;an&nbsp;Amazon&nbsp;cloud&nbsp;instance&nbsp;and&nbsp;am&nbsp;noticing&nbsp;a&nbsp;&lt;b&gt;significant&lt;/b&gt;&amp;nbsp;drop&nbsp;in&nbsp;performance&nbsp;when&nbsp;enabling&nbsp;acknowledgements&nbsp;for&nbsp;consumer&nbsp;of&nbsp;a&nbsp;durable&nbsp;queue&nbsp;(with&nbsp;persisted&nbsp;messages).&nbsp;&amp;nbsp;The&nbsp;real&nbsp;problem&nbsp;is&nbsp;that&nbsp;the&nbsp;bottleneck&nbsp;appears&nbsp;to&nbsp;be&nbsp;on&nbsp;the&nbsp;rabbit&nbsp;node&nbsp;and&nbsp;not&nbsp;with&nbsp;the&nbsp;consumers,&nbsp;so&nbsp;adding&nbsp;more&nbsp;consumers&nbsp;does&nbsp;not&nbsp;improve&nbsp;the&nbsp;throughput&nbsp;(or&nbsp;help&nbsp;drain&nbsp;the&nbsp;queue&nbsp;any&nbsp;quicker).&nbsp;&amp;nbsp;As&nbsp;a&nbsp;matter&nbsp;of&nbsp;fact,&nbsp;adding&nbsp;new&nbsp;consumers&nbsp;will&nbsp;just&nbsp;slow&nbsp;down&nbsp;existing&nbsp;consumers&nbsp;so&nbsp;everyone&nbsp;ends&nbsp;up&nbsp;consuming&nbsp;at&nbsp;a&nbsp;slower&nbsp;rate,&nbsp;preventing&nbsp;overall&nbsp;throughput&nbsp;from&nbsp;changing.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Trying&nbsp;to&nbsp;do&nbsp;batch&nbsp;acknowledgements&nbsp;using&nbsp;the&nbsp;Multiple&nbsp;flag&nbsp;helps&nbsp;a&nbsp;bit&nbsp;(8k&nbsp;msgs/s&nbsp;vs&nbsp;5.5k&nbsp;msgs/s)&nbsp;but&nbsp;not&nbsp;much&nbsp;compared&nbsp;to&nbsp;the&nbsp;initial&nbsp;drop.&nbsp;&amp;nbsp;It&nbsp;is&nbsp;only&nbsp;when&nbsp;I&nbsp;turn&nbsp;on&nbsp;&lt;b&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;auto_ack&lt;/font&gt;&lt;/b&gt;&nbsp;for&nbsp;the&nbsp;consumers&nbsp;that&nbsp;I&nbsp;see&nbsp;the&nbsp;performance&nbsp;shoot&nbsp;&lt;b&gt;way&amp;nbsp;&lt;/b&gt;back&nbsp;up&nbsp;and&nbsp;when&nbsp;I&nbsp;start&nbsp;seeing&nbsp;a&nbsp;linear&nbsp;increase&nbsp;in&nbsp;throughput&nbsp;as&nbsp;I&nbsp;add&nbsp;more&nbsp;consumers.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;this&nbsp;expected&nbsp;behavior?&nbsp;&amp;nbsp;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;configure&nbsp;the&nbsp;rabbit&nbsp;node&nbsp;so&nbsp;it&nbsp;doesn't&nbsp;hit&nbsp;this&nbsp;bottleneck&nbsp;with&nbsp;acknowledgements?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&nbsp;is&nbsp;the&nbsp;sample&nbsp;code&nbsp;I'm&nbsp;using&nbsp;to&nbsp;test&nbsp;the&nbsp;throughput:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Publisher:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;style=&quot;margin:&nbsp;0&nbsp;0&nbsp;0&nbsp;40px;&nbsp;border:&nbsp;none;&nbsp;padding:&nbsp;0px;&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;#!/usr/bin/python&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;import&nbsp;pika&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;creds&nbsp;=&nbsp;pika.PlainCredentials('guest','guest')&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;conn&nbsp;&amp;nbsp;=&nbsp;pika.BlockingConnection(pika.ConnectionParameters(host='10.10.1.123',&nbsp;credentials=creds))&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;chan&nbsp;&amp;nbsp;=&nbsp;conn.channel()&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;while&nbsp;True:&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&lt;/font&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;'courier&nbsp;new',&nbsp;monospace;&quot;&gt;chan.basic_publish(exchange='simple_exchange',&nbsp;routing_key='simple_queue',&nbsp;body='',&nbsp;properties=pika.BasicProperties(delivery_mode=2))&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Consumer:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;style=&quot;margin:&nbsp;0&nbsp;0&nbsp;0&nbsp;40px;&nbsp;border:&nbsp;none;&nbsp;padding:&nbsp;0px;&quot;&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;#!/usr/bin/python&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;import&nbsp;pika&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;def&nbsp;callback(chan,&nbsp;method,&nbsp;properties,&nbsp;body):&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;chan.basic_ack(delivery_tag=method.delivery_tag,&nbsp;multiple=False)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;creds&nbsp;=&nbsp;pika.PlainCredentials('guest','guest')&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;conn&nbsp;&amp;nbsp;=&nbsp;pika.BlockingConnection(pika.ConnectionParameters(host='10.10.1.123',&nbsp;credentials=creds))&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;chan&nbsp;&amp;nbsp;=&nbsp;conn.channel()&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;chan.basic_consume(callback,&nbsp;queue='simple_queue',&nbsp;no_ack=False)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;chan.basic_qos(prefetch_count=1000)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;chan.start_consuming()&lt;/font&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;spawn&nbsp;multiple&nbsp;processes&nbsp;for&nbsp;the&nbsp;producers&nbsp;and&nbsp;multiple&nbsp;for&nbsp;the&nbsp;consumer&nbsp;(so&nbsp;there&nbsp;is&nbsp;no&nbsp;python&nbsp;interpreter&nbsp;locking&nbsp;issues&nbsp;since&nbsp;each&nbsp;runs&nbsp;in&nbsp;its&nbsp;own&nbsp;interpreter&nbsp;instance).&nbsp;&amp;nbsp;I'm&nbsp;using&nbsp;an&nbsp;an&nbsp;Amazon&nbsp;&lt;b&gt;c1.xlarge&nbsp;&lt;/b&gt;(8&nbsp;virtual&nbsp;cores&nbsp;and&nbsp;&quot;high&quot;&nbsp;IO)&amp;nbsp;Ubuntu&nbsp;12.04&nbsp;LTS&nbsp;instance&nbsp;with&nbsp;RabbitMQ&nbsp;version&nbsp;3.0.4-1&nbsp;and&nbsp;an&nbsp;Amazon&nbsp;ephemeral&nbsp;disk&nbsp;(in&nbsp;production&nbsp;we&nbsp;would&nbsp;use&nbsp;an&nbsp;EBS&nbsp;volume&nbsp;instead).&nbsp;&amp;nbsp;The&nbsp;queue&nbsp;is&nbsp;marked&nbsp;&lt;b&gt;Durable&lt;/b&gt;&nbsp;and&nbsp;my&nbsp;messages&nbsp;all&nbsp;use&nbsp;&lt;b&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;delivery_mode&lt;/font&gt;&lt;/b&gt;&nbsp;2&nbsp;(persist).&nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Below&nbsp;are&nbsp;the&nbsp;performance&nbsp;numbers.&nbsp;&amp;nbsp;For&nbsp;each&nbsp;test&nbsp;I&nbsp;use&nbsp;2&nbsp;publishers&nbsp;processes&nbsp;and&nbsp;6&nbsp;consumer&nbsp;processes&nbsp;(where&nbsp;3&nbsp;different&nbsp;machines&nbsp;host&nbsp;2&nbsp;consumers&nbsp;each).&nbsp;&amp;nbsp;The&nbsp;producers&nbsp;and&nbsp;consumers&nbsp;are&nbsp;all&nbsp;on&nbsp;&lt;b&gt;separate&lt;/b&gt;&nbsp;machines&nbsp;from&nbsp;the&nbsp;rabbit&nbsp;node.&nbsp;&amp;nbsp;Throughput&nbsp;measurements&nbsp;were&nbsp;done&nbsp;using&nbsp;the&nbsp;RabbitMQ&nbsp;management&nbsp;UI&nbsp;and&nbsp;linux&nbsp;utility&nbsp;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;top&lt;/font&gt;.&nbsp;&amp;nbsp;Python&nbsp;was&nbsp;compiled&nbsp;to&nbsp;pyc&nbsp;files&nbsp;before&nbsp;running.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;b&gt;no_ack&nbsp;=&nbsp;True:&lt;/b&gt;&nbsp;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;rate&nbsp;=&nbsp;24,000/s&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;single&nbsp;consumer&nbsp;CPU&nbsp;&amp;nbsp;&nbsp;=&nbsp;&amp;nbsp;65%&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;single&nbsp;publisher&nbsp;CPU&nbsp;&amp;nbsp;=&nbsp;&amp;nbsp;80%&nbsp;(flow&nbsp;control&nbsp;enabled&nbsp;and&nbsp;being&nbsp;enforced)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;(beam.smp)&nbsp;rabbit&nbsp;CPU&nbsp;=&nbsp;400%&nbsp;(of&nbsp;800%,&nbsp;8&nbsp;cores)&nbsp;-&amp;gt;&nbsp;0.0%wa&nbsp;11.5%sy&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;no_ack&nbsp;=&nbsp;False&nbsp;(manual&nbsp;acks&nbsp;per&nbsp;message):&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;rate&nbsp;=&nbsp;&amp;nbsp;5,500/s&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;single&nbsp;consumer&nbsp;CPU&nbsp;&amp;nbsp;&nbsp;=&nbsp;&amp;nbsp;20%&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;single&nbsp;publisher&nbsp;CPU&nbsp;&amp;nbsp;=&nbsp;&amp;nbsp;20%&nbsp;(flow&nbsp;control&nbsp;enabled&nbsp;and&nbsp;being&nbsp;enforced)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;(beam.smp)&nbsp;rabbit&nbsp;CPU&nbsp;=&nbsp;300%&nbsp;(of&nbsp;800%,&nbsp;8&nbsp;cores)&nbsp;-&amp;gt;&nbsp;4.5%wa&nbsp;10.0%sy&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;The&nbsp;most&nbsp;notable&nbsp;difference&nbsp;besides&nbsp;the&nbsp;throughput&nbsp;are&nbsp;the&nbsp;I/O&nbsp;waits&nbsp;when&nbsp;ACKs&nbsp;are&nbsp;enabled&nbsp;(4.5%&nbsp;vs&nbsp;0.0%).&nbsp;&amp;nbsp;This&nbsp;leads&nbsp;me&nbsp;to&nbsp;believe&nbsp;that&nbsp;the&nbsp;rabbit&nbsp;node&nbsp;is&nbsp;being&nbsp;bottlenecked&nbsp;by&nbsp;performing&nbsp;I/O&nbsp;operations&nbsp;for&nbsp;ACK&nbsp;bookkeeping.&nbsp;&amp;nbsp;The&nbsp;I/O&nbsp;doesn't&nbsp;appear&nbsp;to&nbsp;be&nbsp;a&nbsp;problem&nbsp;for&nbsp;persisting&nbsp;the&nbsp;published&nbsp;messages&nbsp;since&nbsp;I'm&nbsp;&lt;b&gt;guessing&lt;/b&gt;&amp;nbsp;that&nbsp;rabbit&nbsp;is&nbsp;buffering&nbsp;those&nbsp;and&nbsp;syncing&nbsp;them&nbsp;to&nbsp;disk&nbsp;in&nbsp;batches.&nbsp;&amp;nbsp;Does&nbsp;this&nbsp;mean&nbsp;the&nbsp;acknowledgements&nbsp;are&nbsp;not&nbsp;also&nbsp;being&nbsp;buffered&nbsp;before&nbsp;synced&nbsp;with&nbsp;disk?&nbsp;&amp;nbsp;Can&nbsp;I&nbsp;configure&nbsp;the&nbsp;rabbit&nbsp;node&nbsp;to&nbsp;change&nbsp;this&nbsp;behavior&nbsp;to&nbsp;help&nbsp;speed&nbsp;up&nbsp;the&nbsp;acknowledgements?&nbsp;&amp;nbsp;&nbsp;I'm&nbsp;not&nbsp;using&nbsp;transactions&nbsp;in&nbsp;the&nbsp;example&nbsp;code&nbsp;above,&nbsp;so&nbsp;I&nbsp;don't&nbsp;need&nbsp;any&nbsp;strict&nbsp;guarantees&nbsp;that&nbsp;ACKs&nbsp;were&nbsp;written&nbsp;to&nbsp;disk&nbsp;before&nbsp;returning.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Karl&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;P.S.&nbsp;I&nbsp;wrote&nbsp;the&nbsp;same&nbsp;sample&nbsp;consumer&nbsp;code&nbsp;in&nbsp;Ruby&nbsp;to&nbsp;see&nbsp;if&nbsp;there&nbsp;was&nbsp;a&nbsp;difference&nbsp;(in&nbsp;case&nbsp;there&nbsp;was&nbsp;a&nbsp;Python&nbsp;issue),&nbsp;but&nbsp;the&nbsp;numbers&nbsp;were&nbsp;about&nbsp;the&nbsp;same.&lt;/div&gt;
</tt>
