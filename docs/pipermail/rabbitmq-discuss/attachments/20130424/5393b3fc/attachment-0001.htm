<tt>
&lt;p&gt;I&nbsp;developed&nbsp;an&nbsp;android&nbsp;app&nbsp;where&nbsp;it&nbsp;subscribes&nbsp;to&nbsp;a&nbsp;queue&nbsp;and&nbsp;also&nbsp;<br>
publishes&nbsp;to&nbsp;other&nbsp;queues.&nbsp;At&nbsp;a&nbsp;time&nbsp;it&nbsp;publishes&nbsp;the&nbsp;same&nbsp;message&nbsp;to&nbsp;<br>
two&nbsp;different&nbsp;queues,&nbsp;one&nbsp;of&nbsp;them&nbsp;is&nbsp;a&nbsp;queue&nbsp;named&nbsp;&quot;Queue&quot;&nbsp;and&nbsp;now&nbsp;from&nbsp;a<br>
&nbsp;appfog&nbsp;instance&nbsp;i&nbsp;need&nbsp;to&nbsp;subscribe&nbsp;to&nbsp;the&nbsp;&quot;Queue&quot;&nbsp;and&nbsp;consume&nbsp;messages<br>
&nbsp;and&nbsp;insert&nbsp;them&nbsp;in&nbsp;a&nbsp;mysql&nbsp;db.&lt;/p&gt;<br>
<br>
&lt;p&gt;I&nbsp;created&nbsp;a&nbsp;php&nbsp;standalone&nbsp;app&nbsp;for&nbsp;the&nbsp;above&nbsp;purpose&nbsp;with&nbsp;<br>
codeigniter.&nbsp;By&nbsp;some&nbsp;reason&nbsp;the&nbsp;worker&nbsp;app&nbsp;loses&nbsp;its&nbsp;connection&nbsp;to&nbsp;<br>
rabbitmq.&nbsp;i&nbsp;would&nbsp;like&nbsp;to&nbsp;know&nbsp;the&nbsp;best&nbsp;way&nbsp;to&nbsp;do&nbsp;this.&nbsp;How&nbsp;can&nbsp;a&nbsp;worker<br>
&nbsp;app&nbsp;on&nbsp;appfog&nbsp;can&nbsp;sustain&nbsp;the&nbsp;application&nbsp;restarts.&lt;/p&gt;<br>
<br>
&lt;p&gt;what&nbsp;of&nbsp;kind&nbsp;of&nbsp;thing&nbsp;i&nbsp;need&nbsp;to&nbsp;use&nbsp;to&nbsp;solve&nbsp;the&nbsp;above&nbsp;problem.&lt;/p&gt;<br>
<br>
&lt;p&gt;I&nbsp;figured&nbsp;that&nbsp;the&nbsp;problem&nbsp;is&nbsp;not&nbsp;with&nbsp;rabbitmq&nbsp;connection.&nbsp;it&nbsp;is&nbsp;<br>
with&nbsp;the&nbsp;code&nbsp;related&nbsp;to&nbsp;mysql&nbsp;inserts.&nbsp;i&nbsp;checked&nbsp;the&nbsp;crash&nbsp;logs&nbsp;of&nbsp;my&nbsp;<br>
app&nbsp;and&nbsp;the&nbsp;error&nbsp;is&nbsp;&quot;Mysql&nbsp;gone&nbsp;away&quot;.&nbsp;an&nbsp;example&nbsp;of&nbsp;php&nbsp;rabbitmq&nbsp;<br>
consumer&nbsp;has&nbsp;call&nbsp;backs&nbsp;for&nbsp;receive&nbsp;message&nbsp;and&nbsp;register_shutdown.&nbsp;in&nbsp;<br>
receive&nbsp;call&nbsp;back&nbsp;i&nbsp;can&nbsp;not&nbsp;use&nbsp;$this&nbsp;of&nbsp;code&nbsp;igniter&nbsp;because&nbsp;its&nbsp;out&nbsp;of<br>
&nbsp;scope&nbsp;and&nbsp;i&nbsp;was&nbsp;using&nbsp;get_instance().&nbsp;i&nbsp;am&nbsp;not&nbsp;sure&nbsp;how&nbsp;to&nbsp;call&nbsp;a&nbsp;<br>
method&nbsp;from&nbsp;rabbitmq&nbsp;client&nbsp;receive&nbsp;call&nbsp;back&nbsp;function&lt;/p&gt;<br>
<br>
&lt;p&gt;The&nbsp;controller&nbsp;is&nbsp;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;pre&nbsp;style=&quot;&quot;&nbsp;class=&quot;default&nbsp;prettyprint&nbsp;prettyprinted&quot;&gt;&lt;code&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;&amp;lt;?&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;php<br>
<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;if&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(!&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;defined&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'BASEPATH'&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;))&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;exit&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'No&nbsp;direct&nbsp;script&nbsp;access&nbsp;allowed'&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
include&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;__DIR__&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;.&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'/php-amqplib/config.php'&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;use&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;typ&quot;&gt;PhpAmqpLib&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;\Connection\A&lt;/span&gt;&lt;span&nbsp;class=&quot;typ&quot;&gt;MQPConnection&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;class&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;typ&quot;&gt;Welcome&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;extends&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;CI_Controller&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;public&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;function&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;__construct&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;()&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;parent&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;::&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;__construct&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;();&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;}&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;public&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;function&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;index&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;()&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;//connect&nbsp;to&nbsp;rabbitmq&nbsp;and&nbsp;consume&nbsp;messages&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;//insert&nbsp;messages&nbsp;to&nbsp;mysql&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;//$this-&amp;gt;messages&nbsp;=&nbsp;array();&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;$exchange&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;&quot;router&quot;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;$queue&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;&quot;abbiya&quot;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;new&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;typ&quot;&gt;AMQPConnection&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;HOST&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;PORT&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;USER&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;PASS&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;VHOST&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;$ch&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;$conn&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;channel&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;();&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;/*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;$queue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;passive:&nbsp;false<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;durable:&nbsp;true&nbsp;//&nbsp;the&nbsp;queue&nbsp;will&nbsp;survive&nbsp;server&nbsp;restarts<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exclusive:&nbsp;false&nbsp;//&nbsp;the&nbsp;queue&nbsp;can&nbsp;be&nbsp;accessed&nbsp;in&nbsp;other&nbsp;channels<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auto_delete:&nbsp;false&nbsp;//the&nbsp;queue&nbsp;won't&nbsp;be&nbsp;deleted&nbsp;once&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;$ch&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;queue_declare&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$queue&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;false&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;true&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;false&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;false&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;$ch&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;queue_bind&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$queue&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;$exchange&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;$queue&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;/*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue:&nbsp;Queue&nbsp;from&nbsp;where&nbsp;to&nbsp;get&nbsp;the&nbsp;messages<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consumer_tag:&nbsp;Consumer&nbsp;identifier<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_local:&nbsp;Don't&nbsp;receive&nbsp;messages&nbsp;published&nbsp;by&nbsp;this&nbsp;consumer.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_ack:&nbsp;Tells&nbsp;the&nbsp;server&nbsp;if&nbsp;the&nbsp;consumer&nbsp;will&nbsp;acknowledge&nbsp;the&nbsp;messages.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exclusive:&nbsp;Request&nbsp;exclusive&nbsp;consumer&nbsp;access,&nbsp;meaning&nbsp;only&nbsp;this&nbsp;consumer&nbsp;can&nbsp;access&nbsp;the&nbsp;queue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nowait:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback:&nbsp;A&nbsp;PHP&nbsp;Callback<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;$consumer_tag&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;&quot;abbiya&quot;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;$ch&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;basic_recover&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;true&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;$ch&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;basic_consume&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$queue&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;$consumer_tag&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;false&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;false&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;false&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;false&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;function&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$msg&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;)&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$message_body&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;json_decode&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$msg&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;body&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msg&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;delivery_info&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;[&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'channel'&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;]-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;basic_ack&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$msg&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;delivery_info&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;[&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'delivery_tag'&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;]);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;//&nbsp;Send&nbsp;a&nbsp;message&nbsp;with&nbsp;the&nbsp;string&nbsp;&quot;quit&quot;&nbsp;to&nbsp;cancel&nbsp;the&nbsp;consumer.&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;if&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$msg&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;body&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;===&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'quit'&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;)&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msg&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;delivery_info&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;[&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'channel'&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;]-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;basic_cancel&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$msg&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;delivery_info&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;[&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'consumer_tag'&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;]);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;}&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;array&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'sender_id'&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;$message_body&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;r&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'receiver_id'&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;$message_body&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;s&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'message_content'&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;$message_body&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;m&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;//&nbsp;'sent_time'&nbsp;=&amp;gt;&nbsp;$message_body-&amp;gt;t,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;str&quot;&gt;'status'&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;lit&quot;&gt;0&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ci&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;=&amp;amp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;get_instance&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;();&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ci&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;typ&quot;&gt;Message_model&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;newMessage&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$data&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;}&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;//&nbsp;Loop&nbsp;as&nbsp;long&nbsp;as&nbsp;the&nbsp;channel&nbsp;has&nbsp;callbacks&nbsp;registered&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;while&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;count&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$ch&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;callbacks&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;))&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ch&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;wait&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;();&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;}&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;register_shutdown_function&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;function&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;()&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;kwd&quot;&gt;use&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;$ch&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;,&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;$conn&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;)&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;{&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ch&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;close&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;();&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;close&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;();&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;index&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;();&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;}&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;);&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;}&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;pun&quot;&gt;}&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;/*&nbsp;End&nbsp;of&nbsp;file&nbsp;welcome.php&nbsp;*/&lt;/span&gt;&lt;span&nbsp;class=&quot;pln&quot;&gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;com&quot;&gt;/*&nbsp;Location:&nbsp;./application/controllers/welcome.php&nbsp;*/&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
</tt>
