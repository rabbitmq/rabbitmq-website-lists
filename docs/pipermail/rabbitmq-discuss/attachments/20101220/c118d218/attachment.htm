<tt>
Hi&nbsp;all,&lt;br&gt;&lt;br&gt;My&nbsp;broker&nbsp;is&nbsp;crashing&nbsp;in&nbsp;a&nbsp;reproducible&nbsp;way. &nbsp;I&amp;#39;m&nbsp;running&nbsp;RabbitMQ&nbsp;2.0&nbsp;on&nbsp;a&nbsp;32-bit&nbsp;version&nbsp;of&nbsp;Erlang&nbsp;on&nbsp;a&nbsp;64-bit&nbsp;Windows&nbsp;Server&nbsp;2008&nbsp;R2&nbsp;installation.&lt;br&gt;&lt;br&gt;The&nbsp;management&nbsp;and&nbsp;webhooks&nbsp;plugins&nbsp;are&nbsp;installed. &nbsp;I&nbsp;also&nbsp;have&nbsp;some&nbsp;code&nbsp;periodically&nbsp;checking&nbsp;the&nbsp;broker&nbsp;internals&nbsp;via&nbsp;OTP.&lt;br&gt;<br>
&lt;br&gt;The&nbsp;broker&nbsp;crashes&nbsp;if&nbsp;a&nbsp;queue&nbsp;builds&nbsp;up&nbsp;to&nbsp;the&nbsp;extent&nbsp;that&nbsp;messages&nbsp;have&nbsp;to&nbsp;be&nbsp;persisted&nbsp;to&nbsp;msg_store_transient,&nbsp;and&nbsp;then&nbsp;a&nbsp;consumer&nbsp;quickly&nbsp;starts&nbsp;consuming&nbsp;all&nbsp;the&nbsp;messages&nbsp;from&nbsp;that&nbsp;queue. &nbsp;It&amp;#39;s&nbsp;as&nbsp;if&nbsp;the&nbsp;broker&nbsp;is&nbsp;still&nbsp;near&nbsp;the&nbsp;limit&nbsp;of&nbsp;its&nbsp;available&nbsp;memory&nbsp;then&nbsp;tries&nbsp;to&nbsp;reload&nbsp;a&nbsp;large&nbsp;chunk&nbsp;of&nbsp;the&nbsp;cached&nbsp;messages&nbsp;from&nbsp;msg_store_transient. &nbsp;This&nbsp;pushes&nbsp;it&nbsp;over&nbsp;some&nbsp;hard&nbsp;limit&nbsp;and&nbsp;down&nbsp;it&nbsp;goes.&lt;br&gt;<br>
&lt;br&gt;I&amp;#39;ve&nbsp;turned&nbsp;on&nbsp;memory&nbsp;alarms&nbsp;and&nbsp;for&nbsp;the&nbsp;purposes&nbsp;of&nbsp;debugging&nbsp;reduced&nbsp;the&nbsp;memory&nbsp;high&nbsp;watermark&nbsp;to&nbsp;0.05&nbsp;(the&nbsp;system&nbsp;has&nbsp;2gb). &nbsp;With&nbsp;these&nbsp;settings&nbsp;a&nbsp;cache&nbsp;of&nbsp;~30,000&nbsp;relatively&nbsp;small&nbsp;messages&nbsp;is&nbsp;sufficient&nbsp;to&nbsp;cause&nbsp;the&nbsp;problem.&lt;br&gt;<br>
&lt;br&gt;The&nbsp;main&nbsp;log&nbsp;messages&nbsp;are&nbsp;as&nbsp;follows. &nbsp;I&nbsp;can&nbsp;send&nbsp;the&nbsp;dump&nbsp;log&nbsp;if&nbsp;necessary&nbsp;too.&lt;br&gt;&lt;br&gt;I&amp;#39;ve&nbsp;seen&nbsp;the&nbsp;release&nbsp;notes&nbsp;for&nbsp;2.2&nbsp;and&nbsp;wondered&nbsp;if&nbsp;the&nbsp;&amp;quot;fix&nbsp;queue&nbsp;memory&nbsp;leak&nbsp;when&nbsp;using&nbsp;the&nbsp;management&nbsp;plugin&nbsp;or&nbsp;other&nbsp;consumers&nbsp;of&nbsp;queue&nbsp;statistics&amp;quot;&nbsp;might&nbsp;be&nbsp;a&nbsp;related&nbsp;issue?&lt;br&gt;<br>
&lt;br&gt;&lt;a&nbsp;href=&quot;http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-November/010172.html&quot;&gt;http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/2010-November/010172.html&lt;/a&gt;&lt;br&gt;&lt;br&gt;Any&nbsp;help&nbsp;would&nbsp;be&nbsp;much&nbsp;appreciated!&lt;br&gt;<br>
&lt;br&gt;Thanks,&lt;br&gt;Scott&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;debug&nbsp;log:&lt;br&gt;&lt;br&gt;Crash&nbsp;dump&nbsp;was&nbsp;written&nbsp;to:&nbsp;c:/rabbit/erl_crash.dump&lt;br&gt;eheap_alloc:&nbsp;Cannot&nbsp;allocate&nbsp;583848200&nbsp;bytes&nbsp;of&nbsp;memory&nbsp;(of&nbsp;type&nbsp;&amp;quot;heap&amp;quot;).&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;node&nbsp;log&nbsp;(rabbit@whatever.log):&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:13&nbsp;===&lt;br&gt;vm_memory_high_watermark&nbsp;set.&nbsp;Memory&nbsp;used:108708800&nbsp;allowed:107350835&lt;br&gt;&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:13&nbsp;===&lt;br&gt;   &nbsp;alarm_handler:&nbsp;{set,{vm_memory_high_watermark,[]}}&lt;br&gt;<br>
&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:14&nbsp;===&lt;br&gt;vm_memory_high_watermark&nbsp;clear.&nbsp;Memory&nbsp;used:94399608&nbsp;allowed:107350835&lt;br&gt;&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:14&nbsp;===&lt;br&gt;   &nbsp;alarm_handler:&nbsp;{clear,vm_memory_high_watermark}&lt;br&gt;<br>
&lt;br&gt;=ERROR&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:20&nbsp;===&lt;br&gt;**&nbsp;Generic&nbsp;server&nbsp;msg_store_transient&nbsp;terminating&lt;br&gt;**&nbsp;Last&nbsp;message&nbsp;in&nbsp;was&nbsp;{&amp;#39;$gen_cast&amp;#39;,&lt;br&gt;                          &nbsp;{remove,&lt;br&gt;                              &nbsp;[&amp;lt;&amp;lt;207,102,51,195,33,4,26,173,150,95,132,22,&lt;br&gt;<br>
                                 &nbsp;186,26,230,252&amp;gt;&amp;gt;]}}&lt;br&gt;**&nbsp;When&nbsp;Server&nbsp;state&nbsp;==&nbsp;{msstate,&lt;br&gt;                           &nbsp;&amp;quot;c:/rabbit/db/RabbitMQ@VMRMQ1-mnesia/msg_store_transient&amp;quot;,&lt;br&gt;                           &nbsp;rabbit_msg_store_ets_index,&lt;br&gt;<br>
                           &nbsp;{state,151612,&lt;br&gt;                               &nbsp;&amp;quot;c:/rabbit/db/RabbitMQ@VMRMQ1-mnesia/msg_store_transient&amp;quot;},&lt;br&gt;                           &nbsp;6,#Ref&amp;lt;0.0.0.7537&amp;gt;,&lt;br&gt;                           &nbsp;{dict,0,16,16,8,80,48,&lt;br&gt;<br>
                               &nbsp;{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],&lt;br&gt;                                &nbsp;[]},&lt;br&gt;                               &nbsp;{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],&lt;br&gt;                                 &nbsp;[],[]}}},&lt;br&gt;<br>
                           &nbsp;[],undefined,85671623,103928228,[],false,&lt;br&gt;                           &nbsp;&amp;lt;0.237.0&amp;gt;,159806,147515,155709,163903,&lt;br&gt;                           &nbsp;{set,2,16,16,8,80,48,&lt;br&gt;                               &nbsp;{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],&lt;br&gt;<br>
                                &nbsp;[]},&lt;br&gt;                               &nbsp;{{[&amp;lt;&amp;lt;76,144,119,142,103,20,191,166,92,52,177,&lt;br&gt;                                    &nbsp;137,37,253,53,198&amp;gt;&amp;gt;],&lt;br&gt;                                 &nbsp;[],[],[],[],[],[],[],[],&lt;br&gt;<br>
                                 &nbsp;[&amp;lt;&amp;lt;97,19,25,60,105,158,160,68,116,178,239,&lt;br&gt;                                    &nbsp;127,59,191,208,161&amp;gt;&amp;gt;],&lt;br&gt;                                 &nbsp;[],[],[],[],[],[]}}},&lt;br&gt;                           &nbsp;false,16777216}&lt;br&gt;<br>
**&nbsp;Reason&nbsp;for&nbsp;termination&nbsp;==&lt;br&gt;**&nbsp;{{badmatch,{error,eacces}},&lt;br&gt;   &nbsp;[{rabbit_msg_store,delete_file_if_empty,2},&lt;br&gt;    &nbsp;{rabbit_msg_store,remove_message,2},&lt;br&gt;    &nbsp;{lists,foldl,3},&lt;br&gt;    &nbsp;{rabbit_msg_store,handle_cast,2},&lt;br&gt;<br>
    &nbsp;{gen_server2,handle_msg,7},&lt;br&gt;    &nbsp;{proc_lib,wake_up,3}]}&lt;br&gt;&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:26&nbsp;===&lt;br&gt;stopped&nbsp;TCP&nbsp;Listener&nbsp;on&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0:5672&quot;&gt;0.0.0.0:5672&lt;/a&gt;&lt;br&gt;&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:26&nbsp;===&lt;br&gt;<br>
closing&nbsp;TCP&nbsp;connection&nbsp;&amp;lt;0.6768.0&amp;gt;&nbsp;from&nbsp;&lt;a&nbsp;href=&quot;http://172.20.5.35:55230&quot;&gt;172.20.5.35:55230&lt;/a&gt;&lt;br&gt;&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:26&nbsp;===&lt;br&gt;closing&nbsp;TCP&nbsp;connection&nbsp;&amp;lt;0.521.0&amp;gt;&nbsp;from&nbsp;&lt;a&nbsp;href=&quot;http://172.20.5.35:55101&quot;&gt;172.20.5.35:55101&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:26&nbsp;===&lt;br&gt;closing&nbsp;TCP&nbsp;connection&nbsp;&amp;lt;0.309.0&amp;gt;&nbsp;from&nbsp;&lt;a&nbsp;href=&quot;http://172.22.1.5:56205&quot;&gt;172.22.1.5:56205&lt;/a&gt;&lt;br&gt;&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:26&nbsp;===&lt;br&gt;vm_memory_high_watermark&nbsp;set.&nbsp;Memory&nbsp;used:177922856&nbsp;allowed:107350835&lt;br&gt;<br>
&lt;br&gt;=INFO&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:26&nbsp;===&lt;br&gt;   &nbsp;alarm_handler:&nbsp;{set,{vm_memory_high_watermark,[]}}&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;sasl&nbsp;log:&lt;br&gt;&lt;br&gt;&lt;br&gt;=CRASH&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:23&nbsp;===&lt;br&gt; &nbsp;crasher:&lt;br&gt;   &nbsp;initial&nbsp;call:&nbsp;gen:init_it/7&lt;br&gt;<br>
   &nbsp;pid:&nbsp;&amp;lt;0.235.0&amp;gt;&lt;br&gt;   &nbsp;registered_name:&nbsp;msg_store_transient&lt;br&gt;   &nbsp;exception&nbsp;exit:&nbsp;{{badmatch,{error,eacces}},&lt;br&gt;                    &nbsp;[{rabbit_msg_store,delete_file_if_empty,2},&lt;br&gt;                     &nbsp;{rabbit_msg_store,remove_message,2},&lt;br&gt;<br>
                     &nbsp;{lists,foldl,3},&lt;br&gt;                     &nbsp;{rabbit_msg_store,handle_cast,2},&lt;br&gt;                     &nbsp;{gen_server2,handle_msg,7},&lt;br&gt;                     &nbsp;{proc_lib,wake_up,3}]}&lt;br&gt;     &nbsp;in&nbsp;function &nbsp;gen_server2:terminate/6&lt;br&gt;<br>
   &nbsp;ancestors:&nbsp;[rabbit_sup,&amp;lt;0.186.0&amp;gt;]&lt;br&gt;   &nbsp;messages:&nbsp;[{&amp;#39;$gen_cast&amp;#39;,&lt;br&gt;                     &nbsp;{remove,&lt;br&gt;                         &nbsp;[&amp;lt;&amp;lt;116,2,44,89,198,13,221,58,18,13,147,52,79,55,&lt;br&gt;                            &nbsp;101,76&amp;gt;&amp;gt;]}},&lt;br&gt;<br>
                 &nbsp;{&amp;#39;$gen_cast&amp;#39;,&lt;br&gt;                     &nbsp;{remove,&lt;br&gt;                         &nbsp;[&amp;lt;&amp;lt;93,225,245,186,89,105,207,141,190,8,167,133,&lt;br&gt;                            &nbsp;251,196,229,169&amp;gt;&amp;gt;]}},&lt;br&gt;                 &nbsp;{&amp;#39;$gen_cast&amp;#39;,&lt;br&gt;<br>
                     &nbsp;{remove,&lt;br&gt;                         &nbsp;[&amp;lt;&amp;lt;36,45,179,241,82,8,235,59,130,71,81,223,19,89,&lt;br&gt;                            &nbsp;23,159&amp;gt;&amp;gt;]}},&lt;br&gt;[...]&lt;br&gt;                 &nbsp;{&amp;#39;$gen_cast&amp;#39;,&lt;br&gt;<br>
                     &nbsp;{remove,&lt;br&gt;                         &nbsp;[&amp;lt;&amp;lt;93,226,119,14,115,208,16,0,35,241,8,153,128,173,&lt;br&gt;                            &nbsp;33,46&amp;gt;&amp;gt;,&lt;br&gt;                          &nbsp;&amp;lt;&amp;lt;102,18,229,215,103,192,214,80,241,21,240,138,35,&lt;br&gt;<br>
                            &nbsp;33,210,8&amp;gt;&amp;gt;,&lt;br&gt;                          &nbsp;&amp;lt;&amp;lt;144,39,170,218,61,5,23,24,234,156,43,154,63,104,&lt;br&gt;                            &nbsp;46,233&amp;gt;&amp;gt;,&lt;br&gt;                          &nbsp;&amp;lt;&amp;lt;201,4,128,74,48,234,192,77,11,64,58,124,146,64,&lt;br&gt;<br>
                            &nbsp;196,108&amp;gt;&amp;gt;,&lt;br&gt;                          &nbsp;&amp;lt;&amp;lt;103,56,91,19,0,9,57,136,201,83,73,171,214,48,76,&lt;br&gt;                            &nbsp;227&amp;gt;&amp;gt;,&lt;br&gt;[...]&lt;br&gt;                          &nbsp;&amp;lt;&amp;lt;28,5,2,76,231,115,160,56,192,101,127,47,74,105,&lt;br&gt;<br>
                            &nbsp;103,102&amp;gt;&amp;gt;,&lt;br&gt;                          &nbsp;&amp;lt;&amp;lt;49,236,73,20,167,156,137,55,109,184,47,56,116,237,&lt;br&gt;                            &nbsp;53,9&amp;gt;&amp;gt;,&lt;br&gt;                          &nbsp;&amp;lt;&amp;lt;&amp;quot;Í¿åú|¢Ü¶1á%\b4&nbsp;,%&amp;quot;&amp;gt;&amp;gt;]}}]&lt;br&gt;<br>
   &nbsp;links:&nbsp;[&amp;lt;0.187.0&amp;gt;]&lt;br&gt;   &nbsp;dictionary:&nbsp;[{fhc_age_tree,{0,nil}}]&lt;br&gt;   &nbsp;trap_exit:&nbsp;true&lt;br&gt;   &nbsp;status:&nbsp;running&lt;br&gt;   &nbsp;heap_size:&nbsp;121393&lt;br&gt;   &nbsp;stack_size:&nbsp;24&lt;br&gt;   &nbsp;reductions:&nbsp;19087946&lt;br&gt; &nbsp;neighbours:&lt;br&gt;&lt;br&gt;=SUPERVISOR&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:26&nbsp;===&lt;br&gt;<br>
    &nbsp;Supervisor:&nbsp;{local,rabbit_sup}&lt;br&gt;    &nbsp;Context:   &nbsp;child_terminated&lt;br&gt;    &nbsp;Reason:    &nbsp;{{badmatch,{error,eacces}},&lt;br&gt;                 &nbsp;[{rabbit_msg_store,delete_file_if_empty,2},&lt;br&gt;                  &nbsp;{rabbit_msg_store,remove_message,2},&lt;br&gt;<br>
                  &nbsp;{lists,foldl,3},&lt;br&gt;                  &nbsp;{rabbit_msg_store,handle_cast,2},&lt;br&gt;                  &nbsp;{gen_server2,handle_msg,7},&lt;br&gt;                  &nbsp;{proc_lib,wake_up,3}]}&lt;br&gt;    &nbsp;Offender:  &nbsp;[{pid,&amp;lt;0.235.0&amp;gt;},&lt;br&gt;<br>
                 &nbsp;{name,msg_store_transient},&lt;br&gt;                 &nbsp;{mfa,&lt;br&gt;                     &nbsp;{rabbit_msg_store,start_link,&lt;br&gt;                         &nbsp;[msg_store_transient,&lt;br&gt;                          &nbsp;&amp;quot;c:/rabbit/db/RabbitMQ@VMRMQ1-mnesia&amp;quot;,undefined,&lt;br&gt;<br>
                          &nbsp;{#Fun&amp;lt;rabbit_variable_queue.0.52678393&amp;gt;,ok}]}},&lt;br&gt;                 &nbsp;{restart_type,transient},&lt;br&gt;                 &nbsp;{shutdown,4294967295},&lt;br&gt;                 &nbsp;{child_type,worker}]&lt;br&gt;&lt;br&gt;<br>
&lt;br&gt;=SUPERVISOR&nbsp;REPORT====&nbsp;20-Dec-2010::12:52:26&nbsp;===&lt;br&gt;    &nbsp;Supervisor:&nbsp;{local,rabbit_sup}&lt;br&gt;    &nbsp;Context:   &nbsp;shutdown&lt;br&gt;    &nbsp;Reason:    &nbsp;reached_max_restart_intensity&lt;br&gt;    &nbsp;Offender:  &nbsp;[{pid,&amp;lt;0.235.0&amp;gt;},&lt;br&gt;                 &nbsp;{name,msg_store_transient},&lt;br&gt;<br>
                 &nbsp;{mfa,&lt;br&gt;                     &nbsp;{rabbit_msg_store,start_link,&lt;br&gt;                         &nbsp;[msg_store_transient,&lt;br&gt;                          &nbsp;&amp;quot;c:/rabbit/db/RabbitMQ@VMRMQ1-mnesia&amp;quot;,undefined,&lt;br&gt;<br>
                          &nbsp;{#Fun&amp;lt;rabbit_variable_queue.0.52678393&amp;gt;,ok}]}},&lt;br&gt;                 &nbsp;{restart_type,transient},&lt;br&gt;                 &nbsp;{shutdown,4294967295},&lt;br&gt;                 &nbsp;{child_type,worker}]&lt;br&gt;&lt;br&gt;
</tt>
