<tt>
Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;struggling&nbsp;with&nbsp;persistent&nbsp;message&nbsp;in&nbsp;perl.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;achieve&nbsp;is&nbsp;:&lt;/div&gt;&lt;div&gt;-&nbsp;publish&nbsp;message&nbsp;to&nbsp;a&nbsp;direct&nbsp;exchange&lt;/div&gt;&lt;div&gt;-&nbsp;the&nbsp;exchange&nbsp;stores&nbsp;the&nbsp;message&lt;/div&gt;<br>
&lt;div&gt;-&nbsp;a&nbsp;consumer&nbsp;creates&nbsp;a&nbsp;queue,&nbsp;binds&nbsp;it&nbsp;to&nbsp;the&nbsp;exchange,&nbsp;and&nbsp;get&nbsp;all&nbsp;the&nbsp;stored&nbsp;messages&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;a&nbsp;durable&nbsp;exchange,&nbsp;and&nbsp;apparently&nbsp;I&nbsp;would&nbsp;need&nbsp;to&nbsp;publish&nbsp;message&nbsp;using&nbsp;&amp;quot;delivery_mode&nbsp;=&nbsp;2&amp;quot;&nbsp;for&nbsp;the&nbsp;exchange&nbsp;to&nbsp;store&nbsp;the&nbsp;message&nbsp;until&nbsp;a&nbsp;queue&nbsp;is&nbsp;bound&nbsp;to&nbsp;it....is&nbsp;that&nbsp;right&nbsp;?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;I&nbsp;have&nbsp;is&nbsp;that&nbsp;when&nbsp;my&nbsp;consumer&nbsp;creates&nbsp;a&nbsp;queue&nbsp;and&nbsp;bind&nbsp;it&nbsp;to&nbsp;the&nbsp;exchange,&nbsp;it&nbsp;does&nbsp;not&nbsp;get&nbsp;all&nbsp;the&nbsp;message&nbsp;sent.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;publisher&nbsp;code&nbsp;:&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;div&gt;#!/usr/bin/perl&lt;/div&gt;&lt;div&gt;use&nbsp;Net::RabbitMQ;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;my&nbsp;$myexchange=$ARGV[0];&lt;/div&gt;&lt;div&gt;my&nbsp;$rkey=$ARGV[1];&lt;/div&gt;&lt;div&gt;my&nbsp;$text=$ARGV[2];&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;my&nbsp;$mq&nbsp;=&nbsp;Net::RabbitMQ-&amp;gt;new();&lt;/div&gt;<br>
&lt;div&gt;$mq-&amp;gt;connect(&amp;quot;rabbitmqserver&amp;quot;,&nbsp;{&nbsp;vhost=&amp;gt;&amp;quot;chat&amp;quot;,&nbsp;user&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;,&nbsp;password&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;&nbsp;});&lt;/div&gt;&lt;div&gt;$mq-&amp;gt;channel_open(1);&lt;/div&gt;&lt;div&gt;$mq-&amp;gt;publish(1,&nbsp;$rkey,&nbsp;$text,&nbsp;{exchange&nbsp;=&amp;gt;&nbsp;$myexchange},&nbsp;{&nbsp;content_type&nbsp;=&amp;gt;&nbsp;&amp;#39;text/plain&amp;#39;,&nbsp;delivery_mode&nbsp;=&amp;gt;&nbsp;2});&lt;/div&gt;<br>
&lt;div&gt;mqdisconnect;&lt;/div&gt;&lt;div&gt;exit&nbsp;0; &lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;execute&nbsp;it&nbsp;with&nbsp;for&nbsp;example&nbsp;:&lt;/div&gt;&lt;div&gt;./&lt;a&nbsp;href=&quot;http://publish.pl&quot;&gt;publish.pl&lt;/a&gt;&nbsp;&amp;quot;exchangechat&amp;quot;&nbsp;&amp;quot;toto&amp;quot;&nbsp;&amp;quot;hi&nbsp;toto1&amp;quot;&lt;/div&gt;<br>
&lt;div&gt;./&lt;a&nbsp;href=&quot;http://publish.pl&quot;&gt;publish.pl&lt;/a&gt;&nbsp;&amp;quot;exchangechat&amp;quot;&nbsp;&amp;quot;toto&amp;quot;&nbsp;&amp;quot;hi&nbsp;toto2&amp;quot;&lt;/div&gt;&lt;div&gt;./&lt;a&nbsp;href=&quot;http://publish.pl&quot;&gt;publish.pl&lt;/a&gt;&nbsp;&amp;quot;exchangechat&amp;quot;&nbsp;&amp;quot;toto&amp;quot;&nbsp;&amp;quot;hi&nbsp;toto3&amp;quot;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;consumer&nbsp;code&nbsp;is&nbsp;:&lt;/div&gt;&lt;div&gt;&lt;div&gt;#!/usr/bin/perl&lt;/div&gt;&lt;div&gt;use&nbsp;Net::RabbitMQ;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;my&nbsp;$exchange=$ARGV[0];&lt;/div&gt;&lt;div&gt;my&nbsp;$rkey=$ARGV[1];&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;my&nbsp;$mq&nbsp;=&nbsp;Net::RabbitMQ-&amp;gt;new();&lt;/div&gt;&lt;div&gt;$mq-&amp;gt;connect(&amp;quot;rabbitmqserver&amp;quot;,&nbsp;{&nbsp;vhost&nbsp;=&amp;gt;&nbsp;&amp;quot;chat&amp;quot;,&nbsp;user&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;,&nbsp;password&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;&nbsp;});&lt;/div&gt;&lt;div&gt;$mq-&amp;gt;channel_open(1);&lt;/div&gt;<br>
&lt;div&gt;my&nbsp;$queuename&nbsp;=&nbsp;$mq-&amp;gt;queue_declare(1,&nbsp;&amp;#39;&amp;#39;,&nbsp;{exclusive&nbsp;=&amp;gt;&nbsp;1,&nbsp;durable&nbsp;=&amp;gt;&nbsp;0,&nbsp;auto_delete&nbsp;=&amp;gt;&nbsp;1});&lt;/div&gt;&lt;div&gt;$mq-&amp;gt;queue_bind(1,&nbsp;&amp;quot;$queue&amp;quot;,&nbsp;&amp;quot;$exchange&amp;quot;,&nbsp;&amp;quot;$rkey&amp;quot;);&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;while(1)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; my&nbsp;$message&nbsp;=&nbsp;$mq-&amp;gt;get(1,&nbsp;$queuename);&lt;/div&gt;&lt;div&gt;  &nbsp; if&nbsp;(&nbsp;defined($message)&nbsp;)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; print&nbsp;$message-&amp;gt;{&amp;#39;routing_key&amp;#39;}&nbsp;.&nbsp;&amp;quot;\n&amp;quot;;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; print&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;.&nbsp;&amp;quot;\n&amp;quot;;&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; print&nbsp;&amp;quot;\n\n&amp;quot;;&lt;/div&gt;&lt;div&gt;  &nbsp; }&lt;/div&gt;&lt;div&gt;  &nbsp; sleep(1); &lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;exit&nbsp;0;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;I&nbsp;run&nbsp;it&nbsp;with&nbsp;:&lt;/div&gt;&lt;div&gt;./&lt;a&nbsp;href=&quot;http://consume.pl&quot;&gt;consume.pl&lt;/a&gt;&nbsp;exchangechat&nbsp;&amp;quot;toto&amp;quot;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;but&nbsp;I&nbsp;do&nbsp;not&nbsp;get&nbsp;the&nbsp;message&nbsp;&amp;quot;hi&nbsp;toto1&amp;quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;idea&nbsp;what&amp;#39;s&nbsp;wrong&nbsp;here&nbsp;?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Fab&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
