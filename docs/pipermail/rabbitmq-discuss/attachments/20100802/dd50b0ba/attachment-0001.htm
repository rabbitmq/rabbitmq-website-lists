<tt>
I&nbsp;wrote&nbsp;some&nbsp;test&nbsp;code&nbsp;to&nbsp;understand&nbsp;how&nbsp;amqplib&nbsp;and&nbsp;RabbitMQ&nbsp;work&nbsp;together&nbsp;and&nbsp;I&nbsp;ran&nbsp;into&nbsp;an&nbsp;issue&nbsp;I&amp;#39;m&nbsp;trying&nbsp;to&nbsp;figure&nbsp;out&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;bug&nbsp;or&nbsp;user&nbsp;error&nbsp;on&nbsp;my&nbsp;part.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Scenario&nbsp;is&nbsp;that&nbsp;I&nbsp;wanted&nbsp;to&nbsp;simulate&nbsp;an&nbsp;RPC&nbsp;client/Server&nbsp;the&nbsp;client&nbsp;sends&nbsp;a&nbsp;message&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the&nbsp;server&nbsp;will&nbsp;bounce&nbsp;back&nbsp;an&nbsp;answer&nbsp;in&nbsp;the&nbsp;reply&nbsp;to&nbsp;address.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;simulate&nbsp;the&nbsp;RPC&nbsp;I&nbsp;created&nbsp;a&nbsp;queue&nbsp;client&nbsp;side&nbsp;that&nbsp;I&nbsp;cache&nbsp;for&nbsp;all&nbsp;of&nbsp;my&nbsp;requests&nbsp;as&nbsp;I&nbsp;found&nbsp;making&nbsp;a&nbsp;new&nbsp;queue&nbsp;for&nbsp;each&nbsp;call&nbsp;makes&nbsp;things&nbsp;much&nbsp;slower.&nbsp; &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Everything&nbsp;works&nbsp;good&nbsp;for&nbsp;the&nbsp;first&nbsp;pass&nbsp;where&nbsp;I&nbsp;send&nbsp;100k&nbsp;request/response&nbsp;pairs&nbsp;and&nbsp;I&amp;#39;m&nbsp;getting&nbsp;on&nbsp;the&nbsp;order&nbsp;of&nbsp;4-5k&nbsp;rpc&nbsp;calls&nbsp;per&nbsp;second.&nbsp; To&nbsp;make&nbsp;amqplib&nbsp;have&nbsp;blocking&nbsp;semantics&nbsp;I&nbsp;registered&nbsp;a&nbsp;callback&nbsp;with&nbsp;basic_consume&nbsp;and&nbsp;have&nbsp;that&nbsp;deposit&nbsp;messages&nbsp;that&nbsp;are&nbsp;read&nbsp;into&nbsp;a&nbsp;blocking&nbsp;queue&nbsp;which&nbsp;the&nbsp;client&nbsp;thread&nbsp;reads&nbsp;from&nbsp;this;&nbsp;it&nbsp;seems&nbsp;to&nbsp;work&nbsp;ok&nbsp;as&nbsp;far&nbsp;as&nbsp;I&nbsp;can&nbsp;tell.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Problem&nbsp;I&amp;#39;m&nbsp;seeing&nbsp;is&nbsp;that&nbsp;on&nbsp;the&nbsp;second&nbsp;run&nbsp;of&nbsp;the&nbsp;program&nbsp;I&nbsp;get&nbsp;the&nbsp;following&nbsp;errors:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;==============client&nbsp;error=================&lt;/div&gt;&lt;div&gt;&lt;div&gt;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;/div&gt;<br>
&lt;div&gt;  File&nbsp;&amp;quot;amqp_auth_client.py&amp;quot;,&nbsp;line&nbsp;58,&nbsp;in&nbsp;&amp;lt;module&amp;gt;&lt;/div&gt;&lt;div&gt;  &nbsp; client.close()&lt;/div&gt;&lt;div&gt;  File&nbsp;&amp;quot;/andorian2/xsa/mgmt-plane/xsa/mgmt/configd/base_amqp_client.py&amp;quot;,&nbsp;line&nbsp;171,&nbsp;in&nbsp;close&lt;/div&gt;&lt;div&gt;<br>
  &nbsp; self.chan.basic_cancel(queue_name)&lt;/div&gt;&lt;div&gt;  File&nbsp;&amp;quot;build/bdist.linux-x86_64/egg/amqplib/client_0_8/channel.py&amp;quot;,&nbsp;line&nbsp;1704,&nbsp;in&nbsp;basic_cancel&lt;/div&gt;&lt;div&gt;  File&nbsp;&amp;quot;build/bdist.linux-x86_64/egg/amqplib/client_0_8/abstract_channel.py&amp;quot;,&nbsp;line&nbsp;105,&nbsp;in&nbsp;wait&lt;/div&gt;<br>
&lt;div&gt;  File&nbsp;&amp;quot;build/bdist.linux-x86_64/egg/amqplib/client_0_8/channel.py&amp;quot;,&nbsp;line&nbsp;273,&nbsp;in&nbsp;_close&lt;/div&gt;&lt;div&gt;amqplib.client_0_8.exceptions.AMQPChannelException:&nbsp;(406,&nbsp;u&amp;#39;PRECONDITION_FAILED&nbsp;-&nbsp;timeout&nbsp;waiting&nbsp;for&nbsp;channel.flow_ok{active=false}&amp;#39;,&nbsp;(0,&nbsp;0),&nbsp;&amp;#39;&amp;#39;)&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;=======================================&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;==============&nbsp;matching&nbsp;server&nbsp;error&nbsp;================&lt;/div&gt;&lt;div&gt;&lt;div&gt;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;/div&gt;&lt;div&gt;  File&nbsp;&amp;quot;amqp_auth_server.py&amp;quot;,&nbsp;line&nbsp;28,&nbsp;in&nbsp;&amp;lt;module&amp;gt;&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; client.waitOnCallback()&lt;/div&gt;&lt;div&gt;  File&nbsp;&amp;quot;/andorian2/xsa/mgmt-plane/xsa/mgmt/configd/base_amqp_client.py&amp;quot;,&nbsp;line&nbsp;144,&nbsp;in&nbsp;waitOnCallback&lt;/div&gt;&lt;div&gt;  &nbsp; self.chan.wait()&lt;/div&gt;&lt;div&gt;  File&nbsp;&amp;quot;build/bdist.linux-x86_64/egg/amqplib/client_0_8/abstract_channel.py&amp;quot;,&nbsp;line&nbsp;89,&nbsp;in&nbsp;wait&lt;/div&gt;<br>
&lt;div&gt;  File&nbsp;&amp;quot;build/bdist.linux-x86_64/egg/amqplib/client_0_8/connection.py&amp;quot;,&nbsp;line&nbsp;218,&nbsp;in&nbsp;_wait_method&lt;/div&gt;&lt;div&gt;  File&nbsp;&amp;quot;build/bdist.linux-x86_64/egg/amqplib/client_0_8/abstract_channel.py&amp;quot;,&nbsp;line&nbsp;105,&nbsp;in&nbsp;wait&lt;/div&gt;<br>
&lt;div&gt;  File&nbsp;&amp;quot;build/bdist.linux-x86_64/egg/amqplib/client_0_8/connection.py&amp;quot;,&nbsp;line&nbsp;367,&nbsp;in&nbsp;_close&lt;/div&gt;&lt;div&gt;amqplib.client_0_8.exceptions.AMQPConnectionException:&nbsp;(503,&nbsp;u&amp;#39;COMMAND_INVALID&nbsp;-&nbsp;basic.publish&nbsp;received&nbsp;after&nbsp;channel.flow_ok{active=false}&amp;#39;,&nbsp;(60,&nbsp;40),&nbsp;&amp;#39;Channel.basic_publish&amp;#39;)&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;==============================================&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;this&nbsp;is&nbsp;run&nbsp;I&nbsp;start&nbsp;RabbitMQ,&nbsp;start&nbsp;my&nbsp;server&nbsp;process&nbsp;and&nbsp;then&nbsp;I&nbsp;start&nbsp;the&nbsp;client&nbsp;process.&nbsp; The&nbsp;server&nbsp;stays&nbsp;running&nbsp;for&nbsp;both&nbsp;passes&nbsp;of&nbsp;the&nbsp;test&nbsp;and&nbsp;the&nbsp;client&nbsp;runs&nbsp;and&nbsp;then&nbsp;exits&nbsp;and&nbsp;then&nbsp;I&nbsp;run&nbsp;it&nbsp;a&nbsp;second&nbsp;time&nbsp;and&nbsp;it&nbsp;gets&nbsp;the&nbsp;above&nbsp;errors.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Hoping&nbsp;someone&nbsp;can&nbsp;point&nbsp;me&nbsp;to&nbsp;the&nbsp;probable&nbsp;cause&nbsp;here.&nbsp; Here&nbsp;are&nbsp;some&nbsp;details&nbsp;on&nbsp;the&nbsp;code&nbsp;that&nbsp;is&nbsp;run:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;queue&nbsp;to&nbsp;receive&nbsp;the&nbsp;response&nbsp;is&nbsp;declared&nbsp;as:&lt;/div&gt;&lt;div&gt;========CLIENT&nbsp;QUEUE&nbsp;FOR&nbsp;RPC&nbsp;RESPONSE=============&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;retval&nbsp;=&nbsp;self.chan.queue_declare(durable=False, &lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exclusive=True, &lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;auto_delete=True)&lt;/div&gt;&lt;div&gt;queue_name&nbsp;=&nbsp;retval[0]&lt;/div&gt;<br>
&lt;div&gt;self.chan.queue_bind(queue=queue_name, &lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exchange=BaseMessageClient.exchange_name, &lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;routing_key=queue_name)&lt;/div&gt;&lt;div&gt;=====================&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;queue&nbsp;on&nbsp;the&nbsp;server&nbsp;side&nbsp;is&nbsp;declared&nbsp;as&nbsp;follows:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;==================SERVER&nbsp;QUEUE&nbsp;======================&lt;/div&gt;&lt;div&gt;&lt;div&gt;retval&nbsp;=&nbsp;self.chan.queue_declare(&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; durable=True, &lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exclusive=False, &lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; auto_delete=False&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )&lt;/div&gt;&lt;div&gt;queue_name&nbsp;=&nbsp;retval[0]&lt;/div&gt;&lt;div&gt;self.subjectToQueue[subject]&nbsp;=&nbsp;queue_name&lt;/div&gt;&lt;div&gt;self.chan.queue_bind(queue=self.subjectToQueue[subject], &lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exchange=BaseMessageClient.exchange_name, &lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;routing_key=subject)&lt;/div&gt;&lt;/div&gt;&lt;div&gt;=====================================================&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Server&nbsp;method&nbsp;in&nbsp;the&nbsp;stack&nbsp;is&nbsp;pretty&nbsp;simple&nbsp;just&nbsp;doing&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;  &nbsp; def&nbsp;waitOnCallback(self):&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; #&nbsp;Waits&nbsp;on&nbsp;whatever&nbsp;callbacks&nbsp;are&nbsp;registered&nbsp;for&nbsp;this&nbsp;client&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; #&nbsp;allowed_methods=[callback]&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; while&nbsp;True:&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.chan.wait()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Client&nbsp;method&nbsp;is&nbsp;doing&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;div&gt;  &nbsp; def&nbsp;close(self):&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; with&nbsp;self._responseQueueLock:&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while&nbsp;not&nbsp;self._responseQueueCache.empty():&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (message_queue, &lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;queue_name)&nbsp;=&nbsp;self._responseQueueCache.get(True)&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #self.chan.queue_delete(queue=queue_name)&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.chan.basic_cancel(queue_name)&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; self.chan.close()&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; self.conn.close()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
Where&nbsp;_responseQueueCache&nbsp;is&nbsp;just&nbsp;a&nbsp;structure&nbsp;that&nbsp;holds&nbsp;the&nbsp;response&nbsp;queues&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;re-used.&nbsp; In&nbsp;normal&nbsp;condition&nbsp;there&nbsp;is&nbsp;just&nbsp;one&nbsp;of&nbsp;these&nbsp;used&nbsp;as&nbsp;I&nbsp;use&nbsp;a&nbsp;single&nbsp;thread&nbsp;to&nbsp;do&nbsp;the&nbsp;processing&nbsp;on&nbsp;the&nbsp;client.&nbsp; &nbsp;Since&nbsp;this&nbsp;works&nbsp;on&nbsp;the&nbsp;first&nbsp;pass&nbsp;not&nbsp;sure&nbsp;if&nbsp;I&nbsp;need&nbsp;to&nbsp;do&nbsp;additional&nbsp;clean&nbsp;up&nbsp;or&nbsp;if&nbsp;something&nbsp;is&nbsp;wrong&nbsp;in&nbsp;the&nbsp;close&nbsp;method?&nbsp; I&nbsp;did&nbsp;notice&nbsp;that&nbsp;it&nbsp;does&nbsp;seem&nbsp;to&nbsp;hang&nbsp;for&nbsp;what&nbsp;seems&nbsp;like&nbsp;a&nbsp;long&nbsp;time&nbsp;when&nbsp;it&nbsp;is&nbsp;shutting&nbsp;down&nbsp;maybe&nbsp;3-4&nbsp;seconds&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;first&nbsp;pass.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;any&nbsp;advice&nbsp;is&nbsp;appreciated,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jared&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
