<tt>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;have&nbsp;let&nbsp;only&nbsp;one&nbsp;node&nbsp;&nbsp;rabbitmq&nbsp;online&nbsp;in&nbsp;my&nbsp;company&nbsp;in&nbsp;order&nbsp;to&nbsp;decoupling&nbsp;messages.&lt;span&nbsp;style=&quot;color:&nbsp;rgb(51,&nbsp;51,&nbsp;51);&nbsp;font-family:&nbsp;arial;&nbsp;font-size:&nbsp;18px;&nbsp;line-height:&nbsp;22px;&quot;&gt;&lt;span&nbsp;id=&quot;_editor_bookmark_start_1&quot;&nbsp;style=&quot;display:&nbsp;none;&nbsp;line-height:&nbsp;0px;&quot;&gt;‍&lt;/span&gt;&lt;/span&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;node&nbsp;has&nbsp;not&nbsp;been&nbsp;down&nbsp;for&nbsp;almost&nbsp;one&nbsp;month&nbsp;fortunately？but&nbsp;some&nbsp;basic&nbsp;problem，such&nbsp;as&nbsp;the&nbsp;HA&nbsp;and&nbsp;Load&nbsp;balancing&nbsp;need&nbsp;to&nbsp;be&nbsp;considered，so&nbsp;that&nbsp;&nbsp;can&nbsp;keep&nbsp;all&nbsp;messages&nbsp;complete&nbsp;no&nbsp;matter&nbsp;when&nbsp;the&nbsp;related&nbsp;server&nbsp;or&nbsp;app&nbsp;is&nbsp;down.Such&nbsp;like，another&nbsp;node&nbsp;will&nbsp;&nbsp;work&nbsp;still&nbsp;and&nbsp;keep&nbsp;the&nbsp;produce、customer&nbsp;healthy&nbsp;when&nbsp;a&nbsp;node&nbsp;is&nbsp;down.&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;So，i&nbsp;have&nbsp;considered&nbsp;a&nbsp;solution&nbsp;to&nbsp;protect&nbsp;from&nbsp;losting&nbsp;messages,it‘s&nbsp;rabbitmq（mirrored&nbsp;queue）+Haproxy.&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;have&nbsp;tried&nbsp;two&nbsp;different&nbsp;code，php&nbsp;&nbsp;plays&nbsp;a&nbsp;role，both&nbsp;HA&nbsp;and&nbsp;load&nbsp;balancing.&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;But，java&nbsp;code&nbsp;is&nbsp;not&nbsp;enough&nbsp;fortunately，LOL...&nbsp;Testing&nbsp;for&nbsp;several&nbsp;times，and&nbsp;I&nbsp;get&nbsp;a&nbsp;result，that&nbsp;is&nbsp;java&nbsp;code&nbsp;doesn‘t&nbsp;work&nbsp;at&nbsp;all&nbsp;&lt;span&nbsp;style=&quot;line-height:&nbsp;1.5;&quot;&gt;in&nbsp;HA,but&nbsp;only&nbsp;load&nbsp;balancing....，during&nbsp;testing，when&nbsp;I&nbsp;down&nbsp;a&nbsp;random&nbsp;node，producer&nbsp;will&nbsp;throw&nbsp;out&nbsp;a&nbsp;related&nbsp;session&nbsp;error.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;Having&nbsp;troubled&nbsp;me&nbsp;for&nbsp;almost&nbsp;one&nbsp;week&nbsp;this&nbsp;problem，and&nbsp;looking&nbsp;&nbsp;sincerely&nbsp;forward&nbsp;to&nbsp;ur&nbsp;reply.&nbsp;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;environment&nbsp;will&nbsp;be&nbsp;shown&nbsp;below：&lt;/div&gt;&lt;div&gt;Haproxy：192.168.1.61:5670&lt;/div&gt;&lt;div&gt;rabbit@ubuntu&nbsp;：192.168.1.61:5672（3.1.5）&lt;/div&gt;&lt;div&gt;rabbit@ubuntu2：192.168.1.35:5672（3.1.5）&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;PHP&nbsp;code：&lt;/b&gt;&nbsp;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&nbsp;&lt;?php&lt;br&gt;&lt;br&gt;$n&nbsp;=&nbsp;100000;&lt;br&gt;for($i=0;$i&lt;$n;$i++){&lt;br&gt;echo&nbsp;'&lt;br/&gt;'.$i;&lt;br&gt;//连接RabbitMQ&lt;br&gt;$conn_args&nbsp;=&nbsp;array(&nbsp;'host'=&gt;'192.168.1.61'&nbsp;,&nbsp;'port'=&gt;&nbsp;'5670',&nbsp;'login'=&gt;'aaron'&nbsp;,&nbsp;'password'=&gt;&nbsp;'5555','vhost'&nbsp;=&gt;'/');&lt;br&gt;$conn&nbsp;=&nbsp;new&nbsp;AMQPConnection($conn_args);&lt;br&gt;$conn-&gt;connect();&lt;br&gt;&lt;br&gt;//创建exchange名称和类型&lt;br&gt;$channel&nbsp;=&nbsp;new&nbsp;AMQPChannel($conn);&lt;br&gt;$ex&nbsp;=&nbsp;new&nbsp;AMQPExchange($channel);&lt;br&gt;$ex-&gt;setName('direct_exchange_name');&lt;br&gt;$ex-&gt;setType(AMQP_EX_TYPE_DIRECT);&lt;br&gt;$ex-&gt;setFlags(AMQP_DURABLE&nbsp;|&nbsp;AMQP_AUTODELETE);&lt;br&gt;$ex-&gt;declare();&lt;br&gt;&lt;br&gt;//创建queue名称，使用exchange，绑定routingkey&lt;br&gt;$q&nbsp;=&nbsp;new&nbsp;AMQPQueue($channel);&lt;br&gt;$q-&gt;setName('queue_name');&lt;br&gt;$q-&gt;setFlags(AMQP_DURABLE&nbsp;|&nbsp;AMQP_AUTODELETE);&lt;br&gt;$q-&gt;declare();&lt;br&gt;&lt;br&gt;$q-&gt;bind('direct_exchange_name',&nbsp;'routingkey_name');&lt;br&gt;&lt;br&gt;//消息发布&lt;br&gt;$channel-&gt;startTransaction();&lt;br&gt;$message&nbsp;=&nbsp;json_encode(array('Hello&nbsp;World!','1','2','3','4','DIRECT'));&lt;br&gt;$ex-&gt;publish($message,&nbsp;'routingkey_name');&lt;br&gt;$channel-&gt;commitTransaction();&lt;br&gt;$conn-&gt;disconnect();&lt;br&gt;}&lt;br&gt;&lt;br&gt;?&gt;&lt;span&nbsp;id=&quot;_editor_bookmark_start_6&quot;&nbsp;style=&quot;display:&nbsp;none;&nbsp;line-height:&nbsp;0px;&quot;&gt;‍&lt;/span&gt;&nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;JAVA&nbsp;code：&lt;/b&gt;&lt;/div&gt;&lt;div&gt;ConnectionFactory&nbsp;factory&nbsp;=&nbsp;new&nbsp;ConnectionFactory();//&nbsp;创建链接工厂&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory.setHost(&quot;192.168.1.61&quot;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory.setUsername(&quot;aaron&quot;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory.setPassword(&quot;5555&quot;);&lt;/div&gt;&lt;div&gt;&lt;div&gt;factory.setPort(“5670”);&lt;/div&gt;&lt;div&gt;&lt;div&gt;factory.setAutomaticRecoveryEnabled(true);&lt;/div&gt;&lt;/div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Connection&nbsp;connection&nbsp;=&nbsp;factory.newConnection();//&nbsp;创建链接&lt;/div&gt;&lt;div&gt;factory.setNetworkRecoveryInterval(10000);&lt;span&nbsp;id=&quot;_editor_bookmark_start_4&quot;&nbsp;style=&quot;display:&nbsp;none;&nbsp;line-height:&nbsp;0px;&quot;&gt;‍&lt;/span&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;10000;&nbsp;i++)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Channel&nbsp;channel&nbsp;=&nbsp;connection.createChannel();//&nbsp;创建信息通道&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel.exchangeDeclare(EXCHANGE_NAME,&nbsp;&quot;fanout&quot;,&nbsp;durable);//&nbsp;创建交换机并生命持久化&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&quot;Hello&nbsp;Wrold&nbsp;&quot;&nbsp;+&nbsp;Math.random();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;消息的持久化&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel.basicPublish(EXCHANGE_NAME,&nbsp;&quot;&quot;,&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageProperties.PERSISTENT_TEXT_PLAIN,&nbsp;message.getBytes());&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;[x]&nbsp;Sent&nbsp;'&quot;&nbsp;+&nbsp;message&nbsp;+&nbsp;&quot;'&quot;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel.close();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connection.close();&lt;br&gt;&lt;br&gt;&nbsp;}&lt;span&nbsp;id=&quot;_editor_bookmark_start_2&quot;&nbsp;style=&quot;display:&nbsp;none;&nbsp;line-height:&nbsp;0px;&quot;&gt;‍&lt;/span&gt;&nbsp;&lt;/div&gt;&lt;/div&gt;
</tt>
