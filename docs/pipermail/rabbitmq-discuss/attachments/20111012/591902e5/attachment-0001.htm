<tt>
We&amp;#39;ve&nbsp;been&nbsp;having&nbsp;some&nbsp;latency&nbsp;problems&nbsp;with&nbsp;RabbitMQ&nbsp;that&nbsp;seem&nbsp;kinda&nbsp;out&nbsp;of&nbsp;the&nbsp;ordinary&nbsp;given&nbsp;what&nbsp;I&amp;#39;ve&nbsp;read&nbsp;on&nbsp;this&nbsp;list&nbsp;and&nbsp;in&nbsp;the&nbsp;documentation&nbsp;about&nbsp;it&amp;#39;s&nbsp;capabilities.&nbsp;In&nbsp;some&nbsp;cases,&nbsp;the&nbsp;message&nbsp;rate&nbsp;for&nbsp;multiple&nbsp;exchanges simultaneously drops&nbsp;for&nbsp;up&nbsp;to&nbsp;a&nbsp;minute.&nbsp;This&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;giant&nbsp;spike&nbsp;as&nbsp;the&nbsp;messages&nbsp;finally&nbsp;rush&nbsp;through.&nbsp;Although&nbsp;no&nbsp;messages&nbsp;appear&nbsp;to&nbsp;be&nbsp;lost,&nbsp;the&nbsp;latency&nbsp;is&nbsp;a&nbsp;problem&nbsp;for&nbsp;us,&nbsp;and&nbsp;any&nbsp;help&nbsp;would&nbsp;be&nbsp;much&nbsp;appreciated.&lt;div&gt;<br>
<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;==&nbsp;About&nbsp;the&nbsp;environment&nbsp;==&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;RabbitMQ&nbsp;2.5.1&nbsp;(Compiled&nbsp;from&nbsp;source&nbsp;tarball),&nbsp;web&nbsp;admin&nbsp;plugin&nbsp;installed,&nbsp;otherwise&nbsp;out&nbsp;of&nbsp;the&nbsp;box&nbsp;configuration&lt;/div&gt;&lt;div&gt;-&nbsp;erlang-otp&nbsp;R14B03&lt;/div&gt;&lt;div&gt;<br>
-&nbsp;Redhat&nbsp;Enterprise&nbsp;6.0&lt;/div&gt;<br>
&lt;div&gt;-&nbsp;IBM&nbsp;3550,&nbsp;12&nbsp;cores,&nbsp;192G&nbsp;memory&nbsp;(no,&nbsp;that&amp;#39;s&nbsp;not&nbsp;a&nbsp;typo)&lt;/div&gt;&lt;div&gt;-&nbsp;A&nbsp;single&nbsp;instance&nbsp;of&nbsp;RabbitMQ,&nbsp;receiving&nbsp;roughly&nbsp;1200&nbsp;messages&nbsp;per&nbsp;second&nbsp;across&nbsp;70&nbsp;(or&nbsp;so)&nbsp;fanout&nbsp;exchanges.&nbsp;Each&nbsp;exchange&nbsp;has&nbsp;2&nbsp;queues&nbsp;with&nbsp;one&nbsp;associated&nbsp;consumer&nbsp;per&nbsp;queue.&nbsp;The&nbsp;queues&nbsp;are&nbsp;non-persistant&nbsp;and&nbsp;non-ack. &lt;/div&gt;<br>
<br>
&lt;div&gt;-&nbsp;There&nbsp;is&nbsp;one&nbsp;publisher&nbsp;per&nbsp;exchange,&nbsp;a&nbsp;Ruby&nbsp;process&nbsp;using&nbsp;the&nbsp;AMQP&nbsp;gem.&nbsp;The&nbsp;consumers&nbsp;also&nbsp;use&nbsp;ruby&nbsp;with&nbsp;the&nbsp;AMQP&nbsp;gem&nbsp;(one&nbsp;is&nbsp;JRuby,&nbsp;the&nbsp;other&nbsp;MRI).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;==&nbsp;What&nbsp;we&amp;#39;re&nbsp;seeing&nbsp;==&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;ve&nbsp;been&nbsp;able&nbsp;to&nbsp;capture&nbsp;a&nbsp;lot&nbsp;of&nbsp;stats&nbsp;during&nbsp;once&nbsp;of&nbsp;these&nbsp;events,&nbsp;and&nbsp;I&amp;#39;ve&nbsp;attached&nbsp;some&nbsp;of&nbsp;the&nbsp;resulting&nbsp;data&nbsp;from&nbsp;one&nbsp;that&nbsp;lasted&nbsp;about&nbsp;12&nbsp;seconds.&nbsp;What&nbsp;happens (in&nbsp;roughly&nbsp;temporal&nbsp;order)&nbsp;is&nbsp;this:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)&nbsp;As&nbsp;reported&nbsp;by&nbsp;top,&nbsp;one&nbsp;of&nbsp;the&nbsp;RabbitMQ&nbsp;threads&nbsp;(shown&nbsp;individually&nbsp;in&nbsp;top&nbsp;using&nbsp;the&nbsp;&amp;#39;H&amp;#39;&nbsp;option)&nbsp;spikes&nbsp;to&nbsp;100%&nbsp;CPU.&nbsp;By&nbsp;comparing&nbsp;the&nbsp;last&nbsp;used&nbsp;CPU&nbsp;in&nbsp;top&nbsp;to&nbsp;the&nbsp;per-cpu&nbsp;user/system/wait&nbsp;breakdown,&nbsp;it&nbsp;appears&nbsp;the&nbsp;thread&nbsp;is&nbsp;spending&nbsp;all&nbsp;it&amp;#39;s&nbsp;time&nbsp;in&nbsp;system&nbsp;calls&nbsp;(see&nbsp;attached&nbsp;screenshot).&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;2)&nbsp;As&nbsp;reported&nbsp;by&nbsp;netstat,&nbsp;TCP&nbsp;receive&nbsp;queues&nbsp;build&nbsp;up&nbsp;on&nbsp;the&nbsp;incoming&nbsp;RabbitMQ&nbsp;socket&nbsp;connections.&nbsp;This&nbsp;happens&nbsp;in&nbsp;just&nbsp;a&nbsp;few&nbsp;seconds.&nbsp;See&nbsp;the&nbsp;attached&nbsp;netstat.txt&nbsp;file&nbsp;for&nbsp;detailed&nbsp;stats&nbsp;from&nbsp;a&nbsp;particular&nbsp;episode.&lt;/div&gt;<br>
&lt;div&gt;3)&nbsp;The&nbsp;web&nbsp;admin&nbsp;plugin&nbsp;stops&nbsp;responding&nbsp;to&nbsp;API&nbsp;requests.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;4)&nbsp;The&nbsp;incoming&nbsp;message&nbsp;rate&nbsp;across&nbsp;multiple&nbsp;exchanges&nbsp;drops&nbsp;dramatically.&nbsp;The&nbsp;system&nbsp;can&nbsp;stay&nbsp;in&nbsp;this&nbsp;state&nbsp;for&nbsp;10-30&nbsp;seconds&nbsp;or&nbsp;more.&lt;/div&gt;&lt;div&gt;<br>
5)&nbsp;The&nbsp;CPU&nbsp;levels&nbsp;return&nbsp;to&nbsp;normal&nbsp;(sometimes&nbsp;a&nbsp;bit&nbsp;above&nbsp;normal),&nbsp;and&nbsp;the&nbsp;message&nbsp;rate&nbsp;jumps.&nbsp;Some&nbsp;queuing&nbsp;on&nbsp;the&nbsp;consumers&nbsp;happens&nbsp;as&nbsp;they&nbsp;try&nbsp;to&nbsp;catch&nbsp;up&nbsp;with&nbsp;flood&nbsp;of&nbsp;messages.&lt;/div&gt;&lt;div&gt;6)&nbsp;The&nbsp;consumers&nbsp;work&nbsp;off&nbsp;the&nbsp;extra&nbsp;messages,&nbsp;and&nbsp;the&nbsp;system&nbsp;returns&nbsp;to&nbsp;normal&nbsp;(40%,&nbsp;or&nbsp;so, cpu&nbsp;for&nbsp;rabbit,&nbsp;&amp;lt;&nbsp;5%&nbsp;for&nbsp;the&nbsp;consumers).&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;These&nbsp;episodes&nbsp;last&nbsp;from&nbsp;just&nbsp;a&nbsp;couple&nbsp;of&nbsp;seconds&nbsp;up&nbsp;to&nbsp;a&nbsp;minute,&nbsp;and&nbsp;seem&nbsp;to&nbsp;happen&nbsp;randomly,&nbsp;sometimes&nbsp;coming&nbsp;one&nbsp;right&nbsp;after&nbsp;another,&nbsp;sometimes&nbsp;hours&nbsp;apart.&nbsp;We&amp;#39;ve&nbsp;never&nbsp;seen&nbsp;it&nbsp;less&nbsp;than&nbsp;once&nbsp;a&nbsp;day.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;==What&nbsp;we&amp;#39;ve&nbsp;already&nbsp;done==&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)&nbsp;Troubleshooting&nbsp;using&nbsp;strace&lt;/div&gt;&lt;div&gt;Since&nbsp;the&nbsp;thread&nbsp;seems&nbsp;to&nbsp;be&nbsp;pegged&nbsp;in&nbsp;system&nbsp;calls,&nbsp;we&amp;#39;ve&nbsp;been&nbsp;using&nbsp;strace&nbsp;to&nbsp;try&nbsp;and&nbsp;capture&nbsp;the&nbsp;system&nbsp;call&nbsp;made&nbsp;by&nbsp;the&nbsp;offending&nbsp;thread&nbsp;during&nbsp;the&nbsp;event.&nbsp;Unfortunately,&nbsp;the&nbsp;best&nbsp;we&amp;#39;ve&nbsp;been&nbsp;able&nbsp;to&nbsp;do&nbsp;is&nbsp;capture&nbsp;the&nbsp;system&nbsp;calls&nbsp;immediately&nbsp;following&nbsp;the&nbsp;event.&nbsp;For&nbsp;example,&nbsp;here&nbsp;are&nbsp;the&nbsp;first&nbsp;system&nbsp;calls&nbsp;captured&nbsp;for&nbsp;two&nbsp;threads,&nbsp;once&nbsp;of&nbsp;which&nbsp;can&nbsp;be&nbsp;seen&nbsp;with&nbsp;a&nbsp;pegged&nbsp;CPU&nbsp;in&nbsp;the&nbsp;attached&nbsp;screenshot&nbsp;(pid&nbsp;21860).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;$&nbsp;head rabbit-thread.21860&lt;/div&gt;&lt;div&gt;21:13:53.109706&nbsp;futex(0x1f2bc20,&nbsp;FUTEX_WAKE_PRIVATE,&nbsp;1)&nbsp;=&nbsp;1&nbsp;&amp;lt;0.000021&amp;gt;&lt;/div&gt;&lt;div&gt;21:13:53.109805&nbsp;futex(0x1f2bb60,&nbsp;FUTEX_WAKE_PRIVATE,&nbsp;1)&nbsp;=&nbsp;1&nbsp;&amp;lt;0.000018&amp;gt;&lt;/div&gt;<br>
&lt;div&gt;21:13:53.109853&nbsp;futex(0x899240,&nbsp;FUTEX_WAIT_PRIVATE,&nbsp;2,&nbsp;NULL)&nbsp;=&nbsp;0&nbsp;&amp;lt;0.006322&amp;gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;$&nbsp;head&nbsp;rabbit-thread.21862 &lt;/div&gt;&lt;div&gt;21:13:48.663530&nbsp;futex(0x1f2bce0,&nbsp;FUTEX_WAIT_PRIVATE,&nbsp;4294967295,&nbsp;NULL)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&nbsp;0&nbsp;&amp;lt;4.446544&amp;gt;&lt;/div&gt;<br>
&lt;div&gt;21:13:53.110118&nbsp;sched_yield()&nbsp;=&nbsp;0&nbsp;&amp;lt;0.000102&amp;gt;&lt;/div&gt;&lt;div&gt;21:13:53.110334&nbsp;futex(0x1f856e8,&nbsp;FUTEX_WAIT_PRIVATE,&nbsp;2,&nbsp;NULL)&nbsp;=&nbsp;0&nbsp;&amp;lt;0.006364&amp;gt;&lt;/div&gt;&lt;div&gt;21:13:53.116735&nbsp;futex(0x1f856e8,&nbsp;FUTEX_WAKE_PRIVATE,&nbsp;1)&nbsp;=&nbsp;1&nbsp;&amp;lt;0.000092&amp;gt;&lt;/div&gt;<br>
&lt;div&gt;21:13:53.117139&nbsp;recvfrom(204,&nbsp;&amp;quot;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;first&nbsp;system&nbsp;call&nbsp;logged&nbsp;for&nbsp;21860&nbsp;occurs&nbsp;at&nbsp;21:13:53.&nbsp;However,&nbsp;notice&nbsp;the&nbsp;timestamp&nbsp;and&nbsp;4.4&nbsp;second&nbsp;execution&nbsp;time&nbsp;for&nbsp;the&nbsp;futex&nbsp;call&nbsp;in&nbsp;the&nbsp;other&nbsp;thread&nbsp;(21862).&nbsp;All&nbsp;of&nbsp;the&nbsp;straces&nbsp;for&nbsp;the&nbsp;threads&nbsp;were&nbsp;started&nbsp;at&nbsp;the&nbsp;same&nbsp;time&nbsp;(using&nbsp;the&nbsp;-ff&nbsp;option)&nbsp;and&nbsp;a&nbsp;number&nbsp;of&nbsp;other&nbsp;threads&nbsp;have&nbsp;a&nbsp;similar&nbsp;call&nbsp;around&nbsp;21:13:48.6635&nbsp;as&nbsp;their&nbsp;first&nbsp;logged&nbsp;system&nbsp;call&nbsp;(within&nbsp;a&nbsp;few&nbsp;milliseconds). This&nbsp;leads&nbsp;me&nbsp;to&nbsp;believe&nbsp;that&nbsp;whatever&nbsp;21860&nbsp;is&nbsp;doing&nbsp;during&nbsp;this&nbsp;time,&nbsp;it&amp;#39;s&nbsp;working&nbsp;in&nbsp;a&nbsp;single&nbsp;system&nbsp;call&nbsp;rather&nbsp;than repeatedly calling&nbsp;in&nbsp;a&nbsp;loop. &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2)&nbsp;Reproducing&nbsp;the&nbsp;problem&nbsp;in&nbsp;a&nbsp;controlled&nbsp;environment&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;problem&nbsp;only&nbsp;seems&nbsp;to&nbsp;occur&nbsp;in&nbsp;our&nbsp;production&nbsp;environments,&nbsp;but&nbsp;not&nbsp;in&nbsp;any&nbsp;test&nbsp;environments.&nbsp;The&nbsp;software&nbsp;and&nbsp;hardware&nbsp;in&nbsp;the&nbsp;two&nbsp;environments&nbsp;are&nbsp;identical.&nbsp;We&amp;#39;ve&nbsp;used&nbsp;data&nbsp;recorded&nbsp;from&nbsp;our&nbsp;prod&nbsp;environment&nbsp;to&nbsp;try&nbsp;and&nbsp;reproduce&nbsp;the&nbsp;problem&nbsp;in&nbsp;test&nbsp;(with&nbsp;higher&nbsp;load,&nbsp;even),&nbsp;but&nbsp;no&nbsp;luck&nbsp;so&nbsp;far.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;3)&nbsp;Monitoring&nbsp;message&nbsp;rates&nbsp;through&nbsp;the&nbsp;web&nbsp;API&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;the&nbsp;second&nbsp;attached&nbsp;screenshot,&nbsp;you&nbsp;can&nbsp;see&nbsp;a&nbsp;graph&nbsp;generated&nbsp;from&nbsp;data&nbsp;pulled&nbsp;from&nbsp;the&nbsp;web&nbsp;API&nbsp;for&nbsp;this&nbsp;episode.&nbsp;Each&nbsp;trace&nbsp;in&nbsp;the&nbsp;graph&nbsp;represents&nbsp;the&nbsp;incoming&nbsp;message&nbsp;rate&nbsp;for&nbsp;an&nbsp;individual&nbsp;exchange&nbsp;as&nbsp;reported&nbsp;by&nbsp;the&nbsp;API.&nbsp;For&nbsp;example,&nbsp;the&nbsp;green&nbsp;line&nbsp;at&nbsp;the&nbsp;top&nbsp;shows&nbsp;the&nbsp;message&nbsp;rate&nbsp;dropping&nbsp;from&nbsp;223&nbsp;messages/sec&nbsp;to&nbsp;32&nbsp;messages&nbsp;per&nbsp;second.&nbsp;Not&nbsp;all&nbsp;the&nbsp;exchanges&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Note&nbsp;that&nbsp;the&nbsp;sample&nbsp;rate&nbsp;for&nbsp;this&nbsp;query&nbsp;is&nbsp;every&nbsp;5&nbsp;seconds,&nbsp;and&nbsp;the&nbsp;straight&nbsp;line&nbsp;between&nbsp;the&nbsp;points&nbsp;at&nbsp;21:13:40&nbsp;and&nbsp;21:13:53&nbsp;indicate&nbsp;that&nbsp;the&nbsp;script&nbsp;pulling&nbsp;the&nbsp;data&nbsp;was&nbsp;unable&nbsp;to&nbsp;get&nbsp;a&nbsp;response&nbsp;from&nbsp;rabbit&nbsp;during&nbsp;this&nbsp;time.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;4)&nbsp;Restarting&nbsp;Rabbit&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&amp;#39;s&nbsp;not&nbsp;clear&nbsp;that&nbsp;restarting&nbsp;rabbit&nbsp;has&nbsp;any&nbsp;effect&nbsp;on&nbsp;this&nbsp;problem.&nbsp;Because&nbsp;it&amp;#39;s&nbsp;so&nbsp;random,&nbsp;it&amp;#39;s&nbsp;hard&nbsp;to&nbsp;tell&nbsp;if&nbsp;a&nbsp;rabbit&nbsp;restart&nbsp;makes&nbsp;things&nbsp;better. &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;ve&nbsp;got&nbsp;more&nbsp;data&nbsp;on&nbsp;this&nbsp;if&nbsp;anyone&nbsp;wants&nbsp;to&nbsp;hear&nbsp;it.&nbsp;Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;your&nbsp;help.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ben&lt;/div&gt;<br>

</tt>
