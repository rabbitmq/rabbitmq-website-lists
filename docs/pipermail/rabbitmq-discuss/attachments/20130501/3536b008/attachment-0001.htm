<tt>
Hi&nbsp;guys,&nbsp;I'm&nbsp;having&nbsp;a&nbsp;serious&nbsp;problem&nbsp;with&nbsp;rabbit&nbsp;and&nbsp;the&nbsp;PHP&nbsp;AMQPLib&nbsp;client.&amp;nbsp;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Our&nbsp;system&nbsp;is&nbsp;in&nbsp;essence&nbsp;a&nbsp;state&nbsp;workflow&nbsp;-&amp;gt;&nbsp;events&nbsp;are&nbsp;triggered&nbsp;when&nbsp;we&nbsp;change&nbsp;state&nbsp;in&nbsp;any&nbsp;of&nbsp;our&nbsp;open&nbsp;sessions.&nbsp;We&nbsp;wanted&nbsp;to&nbsp;push&nbsp;processing&nbsp;of&nbsp;those&nbsp;events&nbsp;away&nbsp;from&nbsp;our&nbsp;fron-facing&nbsp;web&nbsp;server,&nbsp;so&nbsp;decided&nbsp;on&nbsp;trying&nbsp;our&nbsp;rabbit&nbsp;to&nbsp;create&nbsp;a&nbsp;pub-sub&nbsp;architecture&nbsp;for&nbsp;async&nbsp;processing&nbsp;of&nbsp;those&nbsp;events.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now,&nbsp;those&nbsp;events&nbsp;are&nbsp;not&nbsp;a&nbsp;..&nbsp;flood&nbsp;of&nbsp;events.&nbsp;We&nbsp;are&nbsp;getting&nbsp;around&nbsp;10&nbsp;-&nbsp;50&nbsp;per&nbsp;minute,&nbsp;and&nbsp;they&nbsp;are&nbsp;really&nbsp;small&nbsp;in&nbsp;size.&nbsp;We're&nbsp;using&nbsp;a&nbsp;fanout&nbsp;exchange&nbsp;to&nbsp;push&nbsp;them&nbsp;to&nbsp;rabbit,&nbsp;and&nbsp;multi-process&nbsp;them&nbsp;using&nbsp;workers&nbsp;running&nbsp;in&nbsp;another&nbsp;machine.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yesterday&nbsp;was&nbsp;our&nbsp;first&nbsp;production&nbsp;test.&nbsp;We&nbsp;left&nbsp;it&nbsp;running&nbsp;for&nbsp;the&nbsp;whole&nbsp;day,&nbsp;until&nbsp;at&nbsp;around&nbsp;21:00,&nbsp;after&nbsp;more&nbsp;or&nbsp;less&nbsp;12&nbsp;hours&nbsp;running&nbsp;ok,&nbsp;rabbit&nbsp;just&nbsp;stopped&nbsp;accepting&nbsp;messages.&nbsp;It&nbsp;was&nbsp;not&nbsp;dead,&nbsp;just&nbsp;not&nbsp;functional.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;As&nbsp;I&nbsp;said,&nbsp;we're&nbsp;using&nbsp;the&nbsp;PhpAmqpLib&nbsp;client.&nbsp;We've&nbsp;written&nbsp;a&nbsp;couple&nbsp;of&nbsp;helper&nbsp;classes,&nbsp;to&nbsp;create&nbsp;a&nbsp;Producer,&nbsp;a&nbsp;PubSubProducer&nbsp;(&nbsp;the&nbsp;former&nbsp;uses&nbsp;a&nbsp;topic&nbsp;exchange,&nbsp;the&nbsp;latter&nbsp;a&nbsp;fanout&nbsp;one&nbsp;)&nbsp;and&nbsp;the&nbsp;corresponding&nbsp;Consumers.&nbsp;Can&nbsp;anyone&nbsp;see&nbsp;something&nbsp;wrong&nbsp;in&nbsp;this&nbsp;?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;source&nbsp;of&nbsp;the&nbsp;pub-sub&nbsp;producer&nbsp;is&nbsp;more&nbsp;or&nbsp;less&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;public&nbsp;function&nbsp;&lt;/span&gt;__construct($exchange_name,&nbsp;$queue_name,&nbsp;$routing_key)&amp;nbsp;&lt;/b&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;{&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_exchange&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;=&nbsp;$exchange_name;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_queue&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;=&nbsp;$queue_name;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_routing_key&lt;/span&gt;&nbsp;=&nbsp;$routing_key;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;}&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;b&gt;public&nbsp;function&nbsp;&lt;span&nbsp;class=&quot;s1&quot;&gt;initialize()&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;{&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$config&nbsp;=&nbsp;QueueConfig::instance();&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_connection&lt;/span&gt;&nbsp;=&nbsp;&lt;span&nbsp;class=&quot;s3&quot;&gt;new&nbsp;&lt;/span&gt;AMQPConnection($config-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;host&lt;/span&gt;,&nbsp;$config-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;port&lt;/span&gt;,&nbsp;$config-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;user&lt;/span&gt;,&nbsp;$config-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;pwd&lt;/span&gt;,&nbsp;$config-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;vhost&lt;/span&gt;);&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_channel&lt;/span&gt;&nbsp;=&nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_connection&lt;/span&gt;-&amp;gt;channel();&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;s3&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;if&lt;/span&gt;(&lt;span&nbsp;class=&quot;s3&quot;&gt;null&lt;/span&gt;!=$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_exchange&lt;/span&gt;)&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;{&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p4&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;//echo&nbsp;&quot;Registering&nbsp;Exchange:&nbsp;&quot;&nbsp;.&nbsp;$this-&amp;gt;_exchange;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_channel&lt;/span&gt;-&amp;gt;exchange_declare($this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_exchange&lt;/span&gt;,&nbsp;&lt;span&nbsp;class=&quot;s2&quot;&gt;'fanout'&lt;/span&gt;);&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;}&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;}&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;/div&gt;&lt;div&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;b&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;public&nbsp;function&nbsp;&lt;/span&gt;publish($message,&nbsp;$routing_key&nbsp;=&nbsp;&lt;span&nbsp;class=&quot;s1&quot;&gt;null&lt;/span&gt;,&nbsp;$correlation_id&nbsp;=&nbsp;&lt;span&nbsp;class=&quot;s1&quot;&gt;null&lt;/span&gt;)&lt;/b&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;{&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$r_key&nbsp;=&nbsp;(&lt;span&nbsp;class=&quot;s1&quot;&gt;null&nbsp;&lt;/span&gt;!=&nbsp;$routing_key)?&nbsp;$routing_key&nbsp;:&nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_routing_key&lt;/span&gt;;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s3&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$properties&nbsp;=&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;array&lt;/span&gt;&lt;span&nbsp;class=&quot;s3&quot;&gt;(&lt;/span&gt;'content_type'&nbsp;&lt;span&nbsp;class=&quot;s3&quot;&gt;=&amp;gt;&nbsp;&lt;/span&gt;'text/plain'&lt;span&nbsp;class=&quot;s3&quot;&gt;,&nbsp;&lt;/span&gt;'delivery_mode'&nbsp;&lt;span&nbsp;class=&quot;s3&quot;&gt;=&amp;gt;&nbsp;2);&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;if&lt;/span&gt;(&lt;span&nbsp;class=&quot;s1&quot;&gt;null&nbsp;&lt;/span&gt;!=&nbsp;$correlation_id)&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$properties[&lt;span&nbsp;class=&quot;s2&quot;&gt;'correlation_id'&lt;/span&gt;]&nbsp;=&nbsp;$correlation_id;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$msg&nbsp;=&nbsp;&lt;span&nbsp;class=&quot;s1&quot;&gt;new&nbsp;&lt;/span&gt;AMQPMessage($message,&nbsp;$properties);&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&lt;/span&gt;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_channel&lt;/span&gt;-&amp;gt;basic_publish($msg,&nbsp;$this-&amp;gt;&lt;span&nbsp;class=&quot;s2&quot;&gt;_exchange&lt;/span&gt;,&nbsp;$r_key);&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;}&lt;/p&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;so&nbsp;much&nbsp;for&nbsp;any&nbsp;help&nbsp;guys,&nbsp;very&nbsp;very&nbsp;very&nbsp;much&nbsp;appreciated&nbsp;!&amp;nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Angel&lt;/div&gt;
</tt>
