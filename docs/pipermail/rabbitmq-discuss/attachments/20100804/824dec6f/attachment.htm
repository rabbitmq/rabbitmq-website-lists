<tt>
&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13.2px;&nbsp;border-collapse:&nbsp;collapse;&nbsp;&quot;&gt;Thanks&nbsp;for&nbsp;the&nbsp;pointer&nbsp;looking&nbsp;at&nbsp;the&nbsp;queues&nbsp;was&nbsp;very&nbsp;helpful&nbsp;figured&nbsp;out&nbsp;I&nbsp;was&nbsp;never&nbsp;cleaning&nbsp;out&nbsp;the&nbsp;server&nbsp;queues&nbsp;and&nbsp;I&nbsp;kept&nbsp;re-creating&nbsp;a&nbsp;new&nbsp;one&nbsp;each&nbsp;time&nbsp;it&nbsp;was&nbsp;restarted&nbsp;and&nbsp;they&nbsp;were&nbsp;all&nbsp;bound&nbsp;to&nbsp;the&nbsp;same&nbsp;topic.&nbsp; So&nbsp;the&nbsp;sending&nbsp;of&nbsp;100k&nbsp;messages&nbsp;from&nbsp;the&nbsp;client&nbsp;resulted&nbsp;in&nbsp;coping&nbsp;those&nbsp;100k&nbsp;messages&nbsp;into&nbsp;tens&nbsp;of&nbsp;queues&nbsp;making&nbsp;millions&nbsp;of&nbsp;copies&nbsp;of&nbsp;messages.&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;changed&nbsp;the&nbsp;server&nbsp;queue&nbsp;to&nbsp;be&nbsp;non-durable&nbsp;and&nbsp;it&nbsp;looked&nbsp;like&nbsp;I&nbsp;can&nbsp;do&nbsp;many&nbsp;passes&nbsp;with&nbsp;no&nbsp;crash&nbsp;now.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;Jared&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Aug&nbsp;2,&nbsp;2010&nbsp;at&nbsp;11:36&nbsp;AM,&nbsp;David&nbsp;Wragg&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:david@rabbitmq.com&quot;&gt;david@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
Hi&nbsp;Jared,&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
Jared&nbsp;Smith&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:jaredtsmith@gmail.com&quot;&gt;jaredtsmith@gmail.com&lt;/a&gt;&amp;gt;&nbsp;writes:&lt;br&gt;<br>
&amp;gt;&nbsp;Everything&nbsp;works&nbsp;good&nbsp;for&nbsp;the&nbsp;first&nbsp;pass&nbsp;where&nbsp;I&nbsp;send&nbsp;100k&lt;br&gt;<br>
&amp;gt;&nbsp;request/response&nbsp;pairs&nbsp;and&nbsp;I&amp;#39;m&nbsp;getting&nbsp;on&nbsp;the&nbsp;order&nbsp;of&nbsp;4-5k&nbsp;rpc&nbsp;calls&lt;br&gt;<br>
&amp;gt;&nbsp;per&nbsp;second.&nbsp; To&nbsp;make&nbsp;amqplib&nbsp;have&nbsp;blocking&nbsp;semantics&nbsp;I&nbsp;registered&nbsp;a&lt;br&gt;<br>
&amp;gt;&nbsp;callback&nbsp;with&nbsp;basic_consume&nbsp;and&nbsp;have&nbsp;that&nbsp;deposit&nbsp;messages&nbsp;that&nbsp;are&lt;br&gt;<br>
&amp;gt;&nbsp;read&nbsp;into&nbsp;a&nbsp;blocking&nbsp;queue&nbsp;which&nbsp;the&nbsp;client&nbsp;thread&nbsp;reads&nbsp;from&nbsp;this;&nbsp;it&lt;br&gt;<br>
&amp;gt;&nbsp;seems&nbsp;to&nbsp;work&nbsp;ok&nbsp;as&nbsp;far&nbsp;as&nbsp;I&nbsp;can&nbsp;tell.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Problem&nbsp;I&amp;#39;m&nbsp;seeing&nbsp;is&nbsp;that&nbsp;on&nbsp;the&nbsp;second&nbsp;run&nbsp;of&nbsp;the&nbsp;program&nbsp;I&nbsp;get&nbsp;the&lt;br&gt;<br>
&amp;gt;&nbsp;following&nbsp;errors:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;==============client&nbsp;error=================&lt;br&gt;<br>
&lt;/div&gt;[...]&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&amp;gt;&nbsp;u&amp;#39;PRECONDITION_FAILED&nbsp;-&nbsp;timeout&nbsp;waiting&nbsp;for&nbsp;channel.flow_ok{active=false}&amp;#39;,&lt;br&gt;<br>
&amp;gt;&nbsp;(0,&nbsp;0),&nbsp;&amp;#39;&amp;#39;)&lt;br&gt;<br>
&amp;gt;&nbsp;=======================================&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;==============&nbsp;matching&nbsp;server&nbsp;error&nbsp;================&lt;br&gt;<br>
&lt;/div&gt;[...]&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&amp;gt;&nbsp;amqplib.client_0_8.exceptions.AMQPConnectionException:&nbsp;(503,&lt;br&gt;<br>
&amp;gt;&nbsp;u&amp;#39;COMMAND_INVALID&nbsp;-&nbsp;basic.publish&nbsp;received&nbsp;after&lt;br&gt;<br>
&amp;gt;&nbsp;channel.flow_ok{active=false}&amp;#39;,&nbsp;(60,&nbsp;40),&nbsp;&amp;#39;Channel.basic_publish&amp;#39;)&lt;br&gt;<br>
&amp;gt;&nbsp;==============================================&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;It&amp;#39;s&nbsp;hard&nbsp;to&nbsp;be&nbsp;sure&nbsp;from&nbsp;the&nbsp;fragments&nbsp;of&nbsp;code&nbsp;you&nbsp;posted,&nbsp;but&nbsp;I&nbsp;wonder&lt;br&gt;<br>
if&nbsp;the&nbsp;issue&nbsp;is&nbsp;that&nbsp;you&nbsp;aren&amp;#39;t&nbsp;acknowledging&nbsp;the&nbsp;messages?&nbsp; To&nbsp;do&nbsp;this,&lt;br&gt;<br>
you&nbsp;either&nbsp;need&nbsp;to&nbsp;call&nbsp;basic_consume&nbsp;with&nbsp;no_ack=True&nbsp;(to&nbsp;tell&nbsp;rabbit&lt;br&gt;<br>
not&nbsp;to&nbsp;expect&nbsp;acknowledgements),&nbsp;or&nbsp;call&nbsp;basic_ack&nbsp;in&nbsp;your&nbsp;consuming&lt;br&gt;<br>
code&nbsp;to&nbsp;explicitly&nbsp;ack&nbsp;the&nbsp;messages.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;don&amp;#39;t&nbsp;acknowledge&nbsp;the&nbsp;messages,&nbsp;then&nbsp;they&nbsp;will&nbsp;stay&nbsp;in&nbsp;the&nbsp;queue,&lt;br&gt;<br>
and&nbsp;take&nbsp;up&nbsp;memory,&nbsp;eventually&nbsp;resulting&nbsp;in&nbsp;the&nbsp;channel.flow&nbsp;methods&lt;br&gt;<br>
indicated&nbsp;above.&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;could&nbsp;confirm&nbsp;that&nbsp;this&nbsp;is&nbsp;the&nbsp;issue&nbsp;by&nbsp;doing&nbsp;a&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; $&nbsp;sudo&nbsp;rabbitmqctl&nbsp;list_queues&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;will&nbsp;list&nbsp;the&nbsp;queues,&nbsp;along&nbsp;with&nbsp;the&nbsp;count&nbsp;of&nbsp;messages&nbsp;in&nbsp;each&lt;br&gt;<br>
queue.&nbsp; If&nbsp;you&nbsp;do&nbsp;this&nbsp;after&nbsp;your&nbsp;first&nbsp;run,&nbsp;and&nbsp;see&nbsp;that&nbsp;a&nbsp;lot&nbsp;of&lt;br&gt;<br>
messages&nbsp;are&nbsp;still&nbsp;present,&nbsp;then&nbsp;it&nbsp;is&nbsp;very&nbsp;likely&nbsp;to&nbsp;be&nbsp;the&nbsp;lack&nbsp;of&lt;br&gt;<br>
acks&nbsp;causing&nbsp;the&nbsp;problem.&lt;br&gt;<br>
&lt;br&gt;<br>
David&lt;br&gt;<br>
&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
--&lt;br&gt;<br>
David&nbsp;Wragg&lt;br&gt;<br>
Staff&nbsp;Engineer,&nbsp;RabbitMQ&lt;br&gt;<br>
SpringSource,&nbsp;a&nbsp;division&nbsp;of&nbsp;VMware&lt;br&gt;<br>
&lt;/font&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
