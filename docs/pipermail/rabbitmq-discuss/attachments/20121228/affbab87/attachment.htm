<tt>
Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;you&nbsp;finally&nbsp;recommend&nbsp;to&nbsp;set&nbsp;a&nbsp;policy&nbsp;ha-mode&nbsp;all&nbsp;on&nbsp;the &lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:13px;background-color:rgb(255,255,255)&quot;&gt;queue&nbsp;created&nbsp;in&nbsp;the&nbsp;upstream&nbsp;exchange&amp;#39;s&nbsp;broker,&nbsp;like&nbsp;I&nbsp;did&nbsp;?&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif&quot;&gt;The&nbsp;test&nbsp;is&nbsp;very&nbsp;simple.&nbsp;I&nbsp;send&nbsp;200&nbsp;000&nbsp;messages&nbsp;on&nbsp;the&nbsp;upstream&nbsp;exchange&nbsp;with&nbsp;a&nbsp;connection&nbsp;factory&nbsp;with&nbsp;both&nbsp;nodes&nbsp;and&nbsp;a&nbsp;retry&nbsp;timer&nbsp;(like&nbsp;in&nbsp;the&nbsp;Spring&nbsp;Rabbit&nbsp;AmqpAppender).&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif&quot;&gt;I&nbsp;receive&nbsp;all&nbsp;messages&nbsp;on&nbsp;the&nbsp;downstream&nbsp;queue&nbsp;and&nbsp;verify&nbsp;that&nbsp;each&nbsp;sent&nbsp;message&nbsp;has&nbsp;been&nbsp;received.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif&quot;&gt;During&nbsp;the&nbsp;test,&nbsp;I&nbsp;shutdown&nbsp;and&nbsp;restart&nbsp;upstream&nbsp;node.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif&quot;&gt;But&nbsp;you&nbsp;are&nbsp;right,&nbsp;I&nbsp;do&nbsp;not&nbsp;use&nbsp;publisher&nbsp;confirm.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;<br>
&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif&quot;&gt;I&nbsp;probably&nbsp;hit&nbsp;the&nbsp;&amp;quot;unsynchronized&nbsp;queue&amp;quot;&nbsp;problem.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:13px;background-color:rgb(255,255,255)&quot;&gt;Otherwise,&nbsp;do&nbsp;you&nbsp;think&nbsp;that&nbsp;my&nbsp;setup&nbsp;is&nbsp;correct&nbsp;to&nbsp;make&nbsp;sure&nbsp;that&nbsp;t&lt;/span&gt;&lt;span&nbsp;style=&quot;background-color:rgb(255,255,255);color:rgb(34,34,34);font-family:arial,sans-serif;font-size:13px&quot;&gt;he&nbsp;messages&nbsp;will&nbsp;arrive&nbsp;at&nbsp;the&nbsp;downstream&nbsp;exchange,&nbsp;not&nbsp;duplicated&nbsp;and&nbsp;without&nbsp;loss&lt;/span&gt;&lt;span&nbsp;style=&quot;background-color:rgb(255,255,255);color:rgb(34,34,34);font-family:arial,sans-serif;font-size:13px&quot;&gt; (&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif&quot;&gt;publisher&nbsp;confirm&nbsp;excepted)&nbsp;?&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#222222&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;Regards,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#222222&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;Vladislav&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2012/12/28&nbsp;Matthias&nbsp;Radestock&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthias@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;matthias@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Vladislav,&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;28/12/12&nbsp;09:32,&nbsp;Vladislav&nbsp;Pernin&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
{{shutdown,{server_initiated_&lt;u&gt;&lt;/u&gt;close,404,&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;lt;&amp;lt;&amp;quot;NOT_FOUND&nbsp;-&nbsp;home&nbsp;node&lt;br&gt;<br>
&amp;#39;rabbit@remote-server1&amp;#39;&nbsp;of&nbsp;durable&nbsp;queue&nbsp;&amp;#39;federation:&nbsp;upstream-exchange&lt;br&gt;<br>
-&amp;gt;&nbsp;federation-local:downstream-&lt;u&gt;&lt;/u&gt;exchange&amp;#39;&nbsp;in&nbsp;vhost&nbsp;&amp;#39;/&amp;#39;&nbsp;is&nbsp;down&nbsp;or&lt;br&gt;<br>
inaccessible&amp;quot;&amp;gt;&amp;gt;}},&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
That&nbsp;happens&nbsp;because&nbsp;the&nbsp;queue&nbsp;used&nbsp;by&nbsp;federation&nbsp;is&nbsp;durable&nbsp;but&nbsp;not&nbsp;mirrored,&nbsp;so&nbsp;when&nbsp;the&nbsp;node&nbsp;on&nbsp;which&nbsp;it&nbsp;was&nbsp;created&nbsp;goes&nbsp;down&nbsp;it&nbsp;is&nbsp;no&nbsp;longer&nbsp;accessible.&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;said&nbsp;you&nbsp;tried&nbsp;making&nbsp;that&nbsp;queue&nbsp;mirrored,&nbsp;but&nbsp;that&nbsp;resulted&nbsp;in&nbsp;message&nbsp;loss.&nbsp;How&nbsp;did&nbsp;you&nbsp;detect&nbsp;the&nbsp;message&nbsp;loss?&nbsp;Does&nbsp;the&nbsp;upstream&nbsp;publisher&nbsp;have&nbsp;confirms&nbsp;enabled?&nbsp;If&nbsp;it&nbsp;received&nbsp;a&nbsp;confirmation&nbsp;for&nbsp;a&nbsp;message&nbsp;then&nbsp;I&nbsp;certainly&nbsp;would&nbsp;expect&nbsp;the&nbsp;message&nbsp;to&nbsp;eventually&nbsp;make&nbsp;it&nbsp;to&nbsp;the&nbsp;downstream.&nbsp;In&nbsp;the&nbsp;absence&nbsp;of&nbsp;such&nbsp;confirmation&nbsp;all&nbsp;bets&nbsp;are&nbsp;off.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;<br>
&lt;br&gt;<br>
Matthias.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
