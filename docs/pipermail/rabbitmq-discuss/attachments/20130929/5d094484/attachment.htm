<tt>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;We&nbsp;are&nbsp;new&nbsp;to&nbsp;rabbitMQ.&nbsp;We&nbsp;use&nbsp;rabbitmq&nbsp;3.1.5&nbsp;in&nbsp;our&nbsp;test&nbsp;environment. This&nbsp;is&nbsp;installed&nbsp;on&nbsp;a&nbsp;red&nbsp;hat&nbsp;linux&nbsp;server&nbsp;(6.4),&nbsp;the&nbsp;same&nbsp;server&nbsp;where&nbsp;our&nbsp;application&nbsp;is&nbsp;also&nbsp;running.&nbsp;The&nbsp;database&nbsp;(postgresql)&nbsp;is&nbsp;on&nbsp;a&nbsp;separate&nbsp;server.&nbsp;&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
<br>
&lt;div&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;We&nbsp;are&nbsp;using&nbsp;rabbitMQ&nbsp;default&nbsp;configuration.&nbsp;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;I&nbsp;ran&nbsp;a&nbsp;test&nbsp;where&nbsp;concurrent&nbsp;users&nbsp;post&nbsp;to&nbsp;a&nbsp;rest&nbsp;service&nbsp;(say&nbsp;R).&nbsp;This&nbsp;service&nbsp;basically&nbsp;expects&nbsp;&lt;span&nbsp;style&gt; &lt;/span&gt;two&nbsp;UUIDs&nbsp;(UUID_A&nbsp;and&nbsp;UUID_B),&nbsp;that&nbsp;identify&nbsp;two&nbsp;database&nbsp;entities&nbsp;&lt;span&nbsp;style&gt; &lt;/span&gt;A&nbsp;and&nbsp;B.&nbsp;Once&nbsp;the&nbsp;service&nbsp;is&nbsp;called&nbsp;with&nbsp;these&nbsp;two&nbsp;values,&nbsp;it&nbsp;publishes&nbsp;to&nbsp;the&nbsp;default&nbsp;exchange.&nbsp;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;<br>
<br>
&lt;div&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;There&nbsp;are&nbsp;two&nbsp;durable&nbsp;queues&nbsp;bound&nbsp;to&nbsp;this&nbsp;exchange.&nbsp;QueueA&nbsp;and&nbsp;QueueB.&nbsp;Two&nbsp;services,&lt;span&nbsp;style&gt; &nbsp;&lt;/span&gt;Service&nbsp;A&nbsp;and&nbsp;Service&nbsp;B,&nbsp;each&nbsp;listen&nbsp;on&nbsp;QueueA&nbsp;and&nbsp;QueueB&nbsp;respectively.&lt;span&nbsp;style&gt; &nbsp;&lt;/span&gt;There&nbsp;are&nbsp;no&nbsp;other&nbsp;consumers&nbsp;to&nbsp;these&nbsp;queues.&nbsp;Service&nbsp;A&nbsp;picks&nbsp;up&nbsp;the&nbsp;message&nbsp;and&nbsp;validates&lt;span&nbsp;style&gt; &nbsp;&lt;/span&gt;UUID_A&nbsp;exists&nbsp;in&nbsp;the&nbsp;database.&nbsp;Service&nbsp;B&nbsp;validates&nbsp;UUID_B&nbsp;exists.&nbsp;If&nbsp;they&nbsp;are&nbsp;both&nbsp;valid,&nbsp;an&nbsp;entry&nbsp;is&nbsp;made&nbsp;to&nbsp;the&nbsp;db,&nbsp;mapping&nbsp;these&nbsp;two&nbsp;values.&nbsp;So&nbsp;each&nbsp;valid&nbsp;post&nbsp;results&nbsp;in&nbsp;an&nbsp;entry&nbsp;in&nbsp;a&nbsp;table&nbsp;in&nbsp;the&nbsp;db.&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;<br>
<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;I&nbsp;find&nbsp;as&nbsp;the&nbsp;test&nbsp;progresses,&nbsp;response&nbsp;&lt;span&nbsp;style&gt; &lt;/span&gt;time&nbsp;of&nbsp;this&nbsp;post&nbsp;increases.&lt;span&nbsp;style&gt; &nbsp;&lt;/span&gt;A&nbsp;lot&nbsp;of&nbsp;the&nbsp;time&nbsp;is&nbsp;being&nbsp;spent&nbsp;in&lt;span&nbsp;style&gt; &nbsp;&lt;/span&gt;Unsafe.park&nbsp;(boolean,long)&lt;span&nbsp;style&gt; &nbsp;&lt;/span&gt;in&nbsp;sun.misc&nbsp;package.&nbsp;&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;Here&nbsp;is&nbsp;the&nbsp;call&nbsp;stack&nbsp;that&nbsp;shows&nbsp;classes&nbsp;where&nbsp;this&nbsp;Unsafe.park()&nbsp;is&nbsp;being&nbsp;involved&nbsp;from.&nbsp;It&nbsp;appears&nbsp;to&nbsp;be&nbsp;called&nbsp;from&nbsp;spring&nbsp;framework’s&nbsp;RabbitTemplate&nbsp;class.&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;Unsafe.park&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt; &lt;/span&gt;LockSupportparkNanos(Object,Long)&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;  &lt;strong&gt;&nbsp;&lt;/strong&gt;&lt;/span&gt;&lt;strong&gt;AbstractQueuedSynchronizer$ConditionObject.awaitNanos(long)&lt;/strong&gt;&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;    &nbsp;&lt;/span&gt;ArrayBlockingQueue.poll(long,&nbsp;TimeUnit)&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;       &nbsp;&lt;/span&gt;RabbitTemplate$3.doInRabbit(Channel)&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;          &nbsp;&lt;/span&gt;RabbitTemplate$3.doInRabbit(Channel)&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;0pt&nbsp;0.5in&quot;&nbsp;class=&quot;MsoListParagraphCxSpFirst&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;RabbitTemplate.execute(ChannelCallback)&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;0pt&nbsp;0.5in&quot;&nbsp;class=&quot;MsoListParagraphCxSpMiddle&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;  &lt;strong&gt;&nbsp;&lt;/strong&gt;&lt;/span&gt;&lt;strong&gt;RabbitTemplate.doSendAndReceiveWithTemporary(String,String,Message)&lt;/strong&gt;&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;0pt&nbsp;0.5in&quot;&nbsp;class=&quot;MsoListParagraphCxSpMiddle&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;     &nbsp;&lt;/span&gt;RabbitTemplate.doSendAndReceive(String,String,Message)&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&nbsp;0.5in&quot;&nbsp;class=&quot;MsoListParagraphCxSpLast&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;        &nbsp;&lt;/span&gt;RabbitTemplate.convertSendAndReceive(String,String,Object,&nbsp;MessagePostProcessor)&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;                           &nbsp;&lt;/span&gt;RabbitTemplate.convertSendAndReceive(String,Object)&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;TEXT-INDENT:0.25in;MARGIN:0in&nbsp;0in&nbsp;10pt&nbsp;0.75in&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;…&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;TEXT-INDENT:0.5in;MARGIN:0in&nbsp;0in&nbsp;10pt&nbsp;0.25in&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;span&nbsp;style&gt;          &nbsp;&lt;/span&gt;…&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;div&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;As&nbsp;the&nbsp;test&nbsp;progresses&nbsp;where&nbsp;the&nbsp;load&nbsp;increases&nbsp;from&nbsp;50&nbsp;users&nbsp;to&nbsp;200&nbsp;users&nbsp;over&nbsp;a&nbsp;period&nbsp;of&nbsp;20&nbsp;mins,&nbsp;this&nbsp;response&nbsp;time&nbsp;increases&nbsp;from&nbsp;50&nbsp;ms&nbsp;to&nbsp;almost&nbsp;2&nbsp;seconds.&nbsp;99%&nbsp;of&nbsp;the&nbsp;response&nbsp;time&nbsp;is&nbsp;spent&nbsp;in&nbsp;Unsafe.park&nbsp;(waiting). &nbsp;At&nbsp;the&nbsp;end&nbsp;of&nbsp;20&nbsp;mins,&nbsp;roughly&nbsp;100,000&nbsp;entries&nbsp;are&nbsp;made&nbsp;into&nbsp;the&nbsp;db.That&nbsp;is&nbsp;roughly 83&nbsp;Posts&nbsp;(i.e&nbsp;messages)&nbsp;per&nbsp;second.&nbsp;Each&nbsp;message&nbsp;contains&nbsp;a&nbsp;couple&nbsp;of&nbsp;UUIDs&nbsp;and&nbsp;a&nbsp;couple&nbsp;of&nbsp;dates.&nbsp;There&nbsp;is&nbsp;no&nbsp;other&nbsp;activity&nbsp;on&nbsp;this&nbsp;server.&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;<br>
<br>
&lt;div&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;&lt;/font&gt;&lt;/font&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;Why&nbsp;is&nbsp;there&nbsp;so&nbsp;mcuh&nbsp;time&nbsp;being&nbsp;spent&nbsp;in&nbsp;Unsafe.park()&nbsp;?&nbsp;It&nbsp;looks&nbsp;like&nbsp;there&nbsp;is&nbsp;a&nbsp;wait&nbsp;for&nbsp;some&nbsp;resource&nbsp;lock.&nbsp;How&nbsp;can&nbsp;we&nbsp;reduce&nbsp;this&nbsp;wait&nbsp;? &nbsp;Overall&nbsp;CPU&nbsp;is&nbsp;about&nbsp;40-45%&nbsp;on&nbsp;this&nbsp;box&nbsp;(a&nbsp;12&nbsp;core&nbsp;server).&nbsp;2/3rds&nbsp;of&nbsp;this&nbsp;time&nbsp;is&nbsp;being&nbsp;spent&nbsp;in&nbsp;the&nbsp;rabbitMQ&nbsp;server.&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;<br>
<br>
&lt;div&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;Is&nbsp;there&nbsp;a plug-in&nbsp;to&nbsp;monitor&nbsp;cpu&nbsp;usage&nbsp;on&nbsp;the&nbsp;server?&nbsp;How&nbsp;can we&nbsp;determine&nbsp;where&nbsp;time&nbsp;is&nbsp;being&nbsp;spent&nbsp;within&nbsp;the broker&nbsp;?&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;<br>
<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;Thanks,&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&gt;&lt;font&nbsp;face=&quot;Calibri&quot;&gt;tgv&lt;/font&gt;&lt;/font&gt;&lt;/p&gt;<br>
&lt;p&nbsp;style=&quot;MARGIN:0in&nbsp;0in&nbsp;10pt&quot;&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;font&nbsp;size=&quot;3&quot;&nbsp;face=&quot;Calibri&quot;&gt; &lt;/font&gt;&lt;/p&gt;<br>

</tt>
