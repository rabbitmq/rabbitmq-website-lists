<tt>
What&nbsp;do&nbsp;you&nbsp;mean&nbsp;by&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;segfault&nbsp;with rabbitmq-c-fb6fca832fd2&nbsp;?&nbsp; Did&nbsp;you&nbsp;build&nbsp;Net::RabbitMQ&nbsp;with&nbsp;that&nbsp;version&nbsp;of&nbsp;rabbitmq-c&nbsp;and&nbsp;it&nbsp;ran&nbsp;the&nbsp;script&nbsp;below&nbsp;without&nbsp;crashing?&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-Alan&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Apr&nbsp;4,&nbsp;2012&nbsp;at&nbsp;3:12&nbsp;AM,&nbsp;Matti&nbsp;Linnanvuori&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matti.linnanvuori@portalify.com&quot;&gt;matti.linnanvuori@portalify.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Hi!&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;wonder&nbsp;how&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;have&nbsp;recv&nbsp;hang&nbsp;if&nbsp;RabbitMQ&nbsp;server&nbsp;has&nbsp;disconnected.&nbsp;Maybe&nbsp;RabbitMQ&nbsp;server&nbsp;has&nbsp;a&nbsp;bug&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;disconnect&nbsp;a&nbsp;socket.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;am&nbsp;afraid&nbsp;I&nbsp;don&amp;#39;t&nbsp;have&nbsp;a&nbsp;succinct&nbsp;example&nbsp;that&nbsp;can&nbsp;reproduce&nbsp;this&nbsp;segfault.&nbsp;It&nbsp;occurred&nbsp;with&nbsp;Net::RabbitMQ&nbsp;versions&nbsp;0.2.0&nbsp;and&nbsp;0.2.2,&nbsp;but&nbsp;not&nbsp;with&nbsp;rabbitmq-c-fb6fca832fd2.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;reported&nbsp;the&nbsp;segmentation&nbsp;fault&nbsp;in&nbsp;CPAN:&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://rt.cpan.org/Public/Bug/Display.html?id=76205&quot;&nbsp;target=&quot;_blank&quot;&gt;https://rt.cpan.org/Public/Bug/Display.html?id=76205&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;got&nbsp;the&nbsp;segmentation&nbsp;fault&nbsp;in&nbsp;subroutine&nbsp;get.&nbsp;I&nbsp;think&nbsp;it&nbsp;is&nbsp;because&nbsp;memory&nbsp;allocation&nbsp;failed.&lt;br&gt;<br>
I&nbsp;have&nbsp;Net::RabbitMQ&nbsp;version&nbsp;0.2.2.&nbsp;I&nbsp;got&nbsp;a&nbsp;similar&nbsp;bug&nbsp;in&nbsp;Net::RabbitMQ&nbsp;version&nbsp;0.2.0,&nbsp;too:&lt;a&nbsp;href=&quot;https://rt.cpan.org/Public/Bug/Display.html?id=76156&quot;&nbsp;target=&quot;_blank&quot;&gt;https://rt.cpan.org/Public/Bug/Display.html?id=76156&lt;/a&gt;&lt;br&gt;<br>
<br>
This&nbsp;is&nbsp;perl,&nbsp;v5.10.0&nbsp;built&nbsp;for&nbsp;x86_64-linux-thread-multi&lt;br&gt;<br>
Linux&nbsp;pmc-inst-test&nbsp;2.6.32.12-0.7-default&nbsp;#1&nbsp;SMP&nbsp;2010-05-20&nbsp;11:14:20&nbsp;+0200&nbsp;x86_64&nbsp;x86_64&nbsp;x86_64&nbsp;GNU/Linux&lt;br&gt;<br>
&lt;br&gt;<br>
Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.&lt;br&gt;<br>
0x00007ffff724fa41&nbsp;in&nbsp;memcpy&nbsp;()&nbsp;from&nbsp;/lib64/libc.so.6&lt;br&gt;<br>
(gdb)&nbsp;bt&lt;br&gt;<br>
#0&nbsp;0x00007ffff724fa41&nbsp;in&nbsp;memcpy&nbsp;()&nbsp;from&nbsp;/lib64/libc.so.6&lt;br&gt;<br>
#1&nbsp;0x00007ffff6db2c0d&nbsp;in&nbsp;amqp_handle_input&nbsp;(state=0x7bc8a0,&lt;br&gt;<br>
received_data=...,&nbsp;decoded_frame=0x7fffffffe2c0)&lt;br&gt;<br>
at&nbsp;/usr/include/bits/string3.h:52&lt;br&gt;<br>
#2&nbsp;0x00007ffff6dbbeec&nbsp;in&nbsp;wait_frame_inner&nbsp;(state=0x7bc8a0,&lt;br&gt;<br>
decoded_frame=0x7fffffffe2c0)&nbsp;at&nbsp;amqp_socket.c:167&lt;br&gt;<br>
#3&nbsp;0x00007ffff6dbc489&nbsp;in&nbsp;amqp_simple_rpc&nbsp;(state=0x7bc8a0,&nbsp;channel=3,&lt;br&gt;<br>
request_id=,&nbsp;expected_reply_ids=0x7fffffffe3a0,&lt;br&gt;<br>
decoded_request_method=)&nbsp;at&nbsp;amqp_socket.c:283&lt;br&gt;<br>
#4&nbsp;0x00007ffff6db156c&nbsp;in&nbsp;amqp_basic_get&nbsp;(state=0x7bc8a0,&nbsp;channel=7,&lt;br&gt;<br>
queue=...,&nbsp;no_ack=1)&nbsp;at&nbsp;amqp_api.c:258&lt;br&gt;<br>
#5&nbsp;0x00007ffff6da7432&nbsp;in&nbsp;XS_Net__RabbitMQ_get&nbsp;(my_perl=,&lt;br&gt;<br>
cv=)&nbsp;at&nbsp;RabbitMQ.xs:618&lt;br&gt;<br>
#6&nbsp;0x000000000047e115&nbsp;in&nbsp;Perl_pp_entersub&nbsp;()&lt;br&gt;<br>
#7&nbsp;0x0000000000455ad3&nbsp;in&nbsp;Perl_runops_debug&nbsp;()&lt;br&gt;<br>
#8&nbsp;0x000000000047a005&nbsp;in&nbsp;perl_run&nbsp;()&lt;br&gt;<br>
#9&nbsp;0x000000000042172c&nbsp;in&nbsp;main&nbsp;()&lt;br&gt;<br>
(gdb)&lt;br&gt;<br>
&lt;br&gt;<br>
#!/usr/bin/perl&nbsp;-w&lt;br&gt;<br>
&lt;br&gt;<br>
=pod&lt;br&gt;<br>
&lt;br&gt;<br>
=head1&nbsp;sds2sds_sf_fault.t&lt;br&gt;<br>
&lt;br&gt;<br>
 Test&nbsp;1:&nbsp;publish&nbsp;a&nbsp;Dispatch&nbsp;JSON&nbsp;message&nbsp;with&nbsp;ack_level&nbsp;and&nbsp;valid_until&lt;br&gt;<br>
 -&nbsp;from&nbsp;SDS&nbsp;to&nbsp;SDS&nbsp;in&nbsp;exchange.pmc.router-in.&lt;br&gt;<br>
 Try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;1&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;2:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;2&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;3:&nbsp;check&nbsp;that&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;in&nbsp;the&nbsp;sent&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;3&nbsp;expected&nbsp;result:&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;in&nbsp;the&nbsp;sent&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;4:&nbsp;check&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;and&nbsp;the&nbsp;sent&nbsp;one.&lt;br&gt;<br>
 Test&nbsp;4&nbsp;expected&nbsp;result:&nbsp;the&nbsp;body&nbsp;fields&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;5:&nbsp;check&nbsp;the&nbsp;timestamp&nbsp;field.&lt;br&gt;<br>
 Test&nbsp;5&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;field&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;in&nbsp;the&nbsp;published&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;6:&nbsp;try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.sf-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;6&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.sf-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;7:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;7&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;8:&nbsp;check&nbsp;that&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.router-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;8&nbsp;expected&nbsp;result:&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.router-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;9:&nbsp;check&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;and&nbsp;the&nbsp;sent&nbsp;one.&lt;br&gt;<br>
 Test&nbsp;9&nbsp;expected&nbsp;result:&nbsp;the&nbsp;body&nbsp;fields&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;10:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;10&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;11:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;11&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;12:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;12&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;13:&nbsp;try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;13&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;14:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;14&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;15:&nbsp;check&nbsp;that&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.sf-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;15&nbsp;expected&nbsp;result:&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.sf-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;16:&nbsp;check&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;and&nbsp;the&nbsp;sent&nbsp;one.&lt;br&gt;<br>
 Test&nbsp;16&nbsp;expected&nbsp;result:&nbsp;the&nbsp;body&nbsp;fields&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;17:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;17&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;18:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;18&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;19:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;19&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;20:&nbsp;try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;20&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;21:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;21&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;22:&nbsp;check&nbsp;that&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.sf-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;22&nbsp;expected&nbsp;result:&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.sf-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;23:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;23&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;24:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;24&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;25:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;25&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;26:&nbsp;check&nbsp;that&nbsp;the&nbsp;id&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;26&nbsp;expected&nbsp;result:&nbsp;the&nbsp;id&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;27:&nbsp;check&nbsp;that&nbsp;the&nbsp;ack_type&nbsp;field&nbsp;has&nbsp;value&nbsp;&amp;quot;processed&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;27&nbsp;expected&nbsp;result:&nbsp;the&nbsp;ack_type&nbsp;field&nbsp;has&nbsp;value&nbsp;&amp;quot;processed&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;28:&nbsp;check&nbsp;that&nbsp;the&nbsp;from&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;is&nbsp;the&nbsp;same&nbsp;as&lt;br&gt;<br>
 the&nbsp;to&nbsp;field&nbsp;of&nbsp;the&nbsp;published&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;28&nbsp;expected&nbsp;result:&nbsp;the&nbsp;from&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;is&nbsp;the&nbsp;same&nbsp;as&lt;br&gt;<br>
 the&nbsp;to&nbsp;field&nbsp;of&nbsp;the&nbsp;published&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;29:&nbsp;check&nbsp;that&nbsp;the&nbsp;type&nbsp;field&nbsp;has&nbsp;value&nbsp;&amp;quot;ack&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;29&nbsp;expected&nbsp;result:&nbsp;the&nbsp;type&nbsp;field&nbsp;has&nbsp;value&nbsp;&amp;quot;ack&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;30:&nbsp;check&nbsp;that&nbsp;the&nbsp;version&nbsp;field&nbsp;has&nbsp;value&nbsp;1.&lt;br&gt;<br>
 Test&nbsp;30&nbsp;expected&nbsp;result:&nbsp;the&nbsp;version&nbsp;field&nbsp;has&nbsp;value&nbsp;1.&lt;br&gt;<br>
 Test&nbsp;31:&nbsp;try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.cassidian-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;31&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.cassidian-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;32:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;32&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;33:&nbsp;check&nbsp;that&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.router-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;33&nbsp;expected&nbsp;result:&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.router-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;34:&nbsp;check&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;and&nbsp;the&nbsp;sent&nbsp;one.&lt;br&gt;<br>
 Test&nbsp;34&nbsp;expected&nbsp;result:&nbsp;the&nbsp;body&nbsp;fields&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;35:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;35&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;36:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;36&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;37:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;37&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;38:&nbsp;try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.cassidian-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;38&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.cassidian-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;39:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;39&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;40:&nbsp;check&nbsp;that&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.router-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;40&nbsp;expected&nbsp;result:&nbsp;the&nbsp;sender&nbsp;field&nbsp;is&nbsp;&amp;quot;exchange.pmc.router-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;41:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;41&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;42:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;42&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;43:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;43&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;44:&nbsp;check&nbsp;that&nbsp;the&nbsp;id&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;44&nbsp;expected&nbsp;result:&nbsp;the&nbsp;id&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;45:&nbsp;check&nbsp;that&nbsp;the&nbsp;ack_type&nbsp;field&nbsp;has&nbsp;value&nbsp;&amp;quot;processed&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;45&nbsp;expected&nbsp;result:&nbsp;the&nbsp;ack_type&nbsp;field&nbsp;has&nbsp;value&nbsp;&amp;quot;processed&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;46:&nbsp;check&nbsp;that&nbsp;the&nbsp;from&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;is&nbsp;the&nbsp;same&nbsp;as&lt;br&gt;<br>
 the&nbsp;to&nbsp;field&nbsp;of&nbsp;the&nbsp;published&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;46&nbsp;expected&nbsp;result:&nbsp;the&nbsp;from&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;is&nbsp;the&nbsp;same&nbsp;as&lt;br&gt;<br>
 the&nbsp;to&nbsp;field&nbsp;of&nbsp;the&nbsp;published&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;47:&nbsp;check&nbsp;that&nbsp;the&nbsp;type&nbsp;field&nbsp;has&nbsp;value&nbsp;&amp;quot;ack&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;47&nbsp;expected&nbsp;result:&nbsp;the&nbsp;type&nbsp;field&nbsp;has&nbsp;value&nbsp;&amp;quot;ack&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;48:&nbsp;check&nbsp;that&nbsp;the&nbsp;version&nbsp;field&nbsp;has&nbsp;value&nbsp;1.&lt;br&gt;<br>
 Test&nbsp;48&nbsp;expected&nbsp;result:&nbsp;the&nbsp;version&nbsp;field&nbsp;has&nbsp;value&nbsp;1.&lt;br&gt;<br>
 Test&nbsp;49:&nbsp;publish&nbsp;an&nbsp;Ack&nbsp;sent&nbsp;message&nbsp;from&nbsp;the&nbsp;SSI&nbsp;in&nbsp;exchange.pmc.router-in.&lt;br&gt;<br>
 try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;49&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;50:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;50&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;51:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;that&nbsp;of&nbsp;published&nbsp;one.&lt;br&gt;<br>
 Test&nbsp;51&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;timestamp&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;that&nbsp;of&nbsp;published&nbsp;one.&lt;br&gt;<br>
 Test&nbsp;52:&nbsp;check&nbsp;the&nbsp;sender&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;52&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;sender&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;has&nbsp;value&nbsp;&amp;quot;exchange.pmc.cassidian-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;53:&nbsp;check&nbsp;the&nbsp;body&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages.&lt;br&gt;<br>
 Test&nbsp;53&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;body&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;54:&nbsp;try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.sf-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;54&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.sf-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;55:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;55&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;56:&nbsp;check&nbsp;the&nbsp;sender&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;56&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;sender&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;has&nbsp;value&nbsp;&amp;quot;exchange.pmc.router-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;57:&nbsp;check&nbsp;the&nbsp;body&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages.&lt;br&gt;<br>
 Test&nbsp;57&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;body&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;58:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;58&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;59:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;59&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;60:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;60&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;61:&nbsp;try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;61&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.router-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;62:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;62&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;63:&nbsp;check&nbsp;the&nbsp;sender&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;63&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;sender&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;has&nbsp;value&nbsp;&amp;quot;exchange.pmc.sf-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;64:&nbsp;check&nbsp;the&nbsp;body&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages.&lt;br&gt;<br>
 Test&nbsp;64&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;body&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;65:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;65&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;66:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;66&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;67:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;67&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;68:&nbsp;try&nbsp;to&nbsp;receive&nbsp;a&nbsp;message&nbsp;from&nbsp;exchange.pmc.cassidian-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;68&nbsp;expected&nbsp;result:&nbsp;a&nbsp;message&nbsp;is&nbsp;received&nbsp;from&nbsp;exchange.pmc.cassidian-in&nbsp;in&nbsp;8&nbsp;seconds.&lt;br&gt;<br>
 Test&nbsp;69:&nbsp;decode&nbsp;the&nbsp;message&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;69&nbsp;expected&nbsp;result:&nbsp;the&nbsp;message&nbsp;is&nbsp;decoded&nbsp;as&nbsp;JSON.&lt;br&gt;<br>
 Test&nbsp;70:&nbsp;check&nbsp;the&nbsp;sender&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message.&lt;br&gt;<br>
 Test&nbsp;70&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;sender&nbsp;field&nbsp;of&nbsp;the&nbsp;received&nbsp;message&nbsp;has&nbsp;value&nbsp;&amp;quot;exchange.pmc.router-in&amp;quot;.&lt;br&gt;<br>
 Test&nbsp;71:&nbsp;check&nbsp;the&nbsp;body&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages.&lt;br&gt;<br>
 Test&nbsp;71&nbsp;expected&nbsp;result:&lt;br&gt;<br>
 the&nbsp;body&nbsp;fields&nbsp;of&nbsp;the&nbsp;received&nbsp;and&nbsp;the&nbsp;published&nbsp;messages&nbsp;are&nbsp;the&nbsp;same.&lt;br&gt;<br>
 Test&nbsp;72:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;72&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;in&nbsp;an&nbsp;integer.&lt;br&gt;<br>
 Test&nbsp;73:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;73&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing.&lt;br&gt;<br>
 Test&nbsp;74:&nbsp;check&nbsp;that&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
 Test&nbsp;74&nbsp;expected&nbsp;result:&nbsp;the&nbsp;timestamp&nbsp;is&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now.&lt;br&gt;<br>
&lt;br&gt;<br>
=cut&lt;br&gt;<br>
&lt;br&gt;<br>
use&nbsp;strict;&lt;br&gt;<br>
&lt;br&gt;<br>
use&nbsp;Net::RabbitMQ;&lt;br&gt;<br>
use&nbsp;Test::More&nbsp;tests&nbsp;=&amp;gt;&nbsp;74;&lt;br&gt;<br>
use&nbsp;JSON;&lt;br&gt;<br>
use&nbsp;Time::HiRes&nbsp;qw(gettimeofday);&lt;br&gt;<br>
&lt;br&gt;<br>
use&nbsp;constant&nbsp;ROUTER_EXCHANGE&nbsp; &nbsp; =&amp;gt;&nbsp;&amp;#39;exchange.pmc.router-in&amp;#39;;&lt;br&gt;<br>
use&nbsp;constant&nbsp;ROUTER_CHANNEL&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;1;&lt;br&gt;<br>
use&nbsp;constant&nbsp;ROUTER_QUEUE&nbsp; &nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;&amp;#39;queue.test.router-in&amp;#39;;&lt;br&gt;<br>
use&nbsp;constant&nbsp;SF_EXCHANGE&nbsp; &nbsp; &nbsp; &nbsp; =&amp;gt;&nbsp;&amp;#39;exchange.pmc.sf-in&amp;#39;;&lt;br&gt;<br>
use&nbsp;constant&nbsp;SF_CHANNEL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;2;&lt;br&gt;<br>
use&nbsp;constant&nbsp;SF_QUEUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;&amp;#39;queue.test.sf-in&amp;#39;;&lt;br&gt;<br>
use&nbsp;constant&nbsp;CASSIDIAN_EXCHANGE&nbsp;=&amp;gt;&nbsp;&amp;#39;exchange.pmc.cassidian-in&amp;#39;;&lt;br&gt;<br>
use&nbsp;constant&nbsp;CASSIDIAN_CHANNEL&nbsp; =&amp;gt;&nbsp;3;&lt;br&gt;<br>
use&nbsp;constant&nbsp;CASSIDIAN_QUEUE&nbsp; &nbsp; =&amp;gt;&nbsp;&amp;#39;queue.test.cassidian-in&amp;#39;;&lt;br&gt;<br>
&lt;br&gt;<br>
sub&nbsp;timestamp&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; return&nbsp;int(&nbsp;gettimeofday()&nbsp;*&nbsp;1000&nbsp;);&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
system(&lt;br&gt;<br>
&amp;#39;service&nbsp;pmc-smpp&nbsp;stop&nbsp;&amp;gt;&amp;amp;2;&nbsp;service&nbsp;pmc-cassidian&nbsp;stop&nbsp;&amp;gt;&amp;amp;2;&nbsp;service&nbsp;pmc-email&nbsp;stop&nbsp;&amp;gt;&amp;amp;2;&nbsp;service&nbsp;pmc-sf&nbsp;stop&nbsp;&amp;gt;&amp;amp;2;&nbsp;service&nbsp;pmc-routing&nbsp;stop&nbsp;&amp;gt;&amp;amp;2&amp;#39;&lt;br&gt;<br>
);&lt;br&gt;<br>
&lt;br&gt;<br>
sleep&nbsp;1;&nbsp; &nbsp; #&nbsp;Wait&nbsp;for&nbsp;the&nbsp;message-sending&nbsp;to&nbsp;stop.&lt;br&gt;<br>
&lt;br&gt;<br>
system(&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;rabbitmqctl&nbsp;stop_app;&nbsp;rabbitmqctl&nbsp;reset;&nbsp;rabbitmqctl&nbsp;start_app;&nbsp;mongo&nbsp;&amp;lt;&amp;lt;END&lt;br&gt;<br>
use&nbsp;database&lt;br&gt;<br>
db.dropDatabase();&lt;br&gt;<br>
END&amp;#39;&lt;br&gt;<br>
);&lt;br&gt;<br>
&lt;br&gt;<br>
system(&amp;#39;service&nbsp;pmc-sf&nbsp;start&nbsp;&amp;gt;&amp;amp;2;&nbsp;service&nbsp;pmc-routing&nbsp;start&nbsp;&amp;gt;&amp;amp;2&amp;#39;);&lt;br&gt;<br>
&lt;br&gt;<br>
sleep&nbsp;8;&nbsp; &nbsp; #&nbsp;Wait&nbsp;for&nbsp;Store&nbsp;&amp;amp;&nbsp;Forward&nbsp;and&nbsp;Routing&nbsp;to&nbsp;start.&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;$json_text&nbsp;=&nbsp;&amp;#39;{&lt;br&gt;<br>
&amp;quot;timestamp&amp;quot;&nbsp;:&nbsp;1330327514213,&lt;br&gt;<br>
&amp;quot;sender&amp;quot;&nbsp;:&nbsp;&amp;quot;&amp;#39;&nbsp;.&nbsp;CASSIDIAN_EXCHANGE&nbsp;.&nbsp;&amp;#39;&amp;quot;,&lt;br&gt;<br>
&amp;quot;body&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;type&amp;quot;&nbsp;:&nbsp;&amp;quot;dispatch&amp;quot;,&lt;br&gt;<br>
&amp;quot;version&amp;quot;&nbsp;:&nbsp;1,&lt;br&gt;<br>
&amp;quot;id&amp;quot;&nbsp;:&nbsp;&amp;quot;8f970b1b-f8a3-4c78-aa24-3b8e2205648788&amp;quot;,&lt;br&gt;<br>
&amp;quot;from&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;type&amp;quot;&nbsp;:&nbsp;&amp;quot;ssi&amp;quot;,&lt;br&gt;<br>
&amp;quot;address&amp;quot;&nbsp;:&nbsp;&amp;quot;16777215&amp;quot;&lt;br&gt;<br>
},&lt;br&gt;<br>
&amp;quot;to&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;type&amp;quot;&nbsp;:&nbsp;&amp;quot;ssi&amp;quot;,&lt;br&gt;<br>
&amp;quot;address&amp;quot;&nbsp;:&nbsp;&amp;quot;0&amp;quot;&lt;br&gt;<br>
},&lt;br&gt;<br>
&amp;quot;body&amp;quot;&nbsp;:&nbsp;&amp;quot;This&nbsp;is&nbsp;a&nbsp;test&nbsp;message.&amp;quot;,&lt;br&gt;<br>
&amp;quot;ack_level&amp;quot;&nbsp;:&nbsp;&amp;quot;sent&amp;quot;,&lt;br&gt;<br>
&amp;quot;valid_until&amp;quot;&nbsp;:&nbsp;9223372036854775807,&lt;br&gt;<br>
&amp;quot;auxiliary&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;timestamp&amp;quot;&nbsp;:&nbsp;1325376000000,&lt;br&gt;<br>
&amp;quot;sdstl&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;protocol_id&amp;quot;&nbsp;:&nbsp;130,&lt;br&gt;<br>
&amp;quot;message_reference&amp;quot;&nbsp;:&nbsp;42,&lt;br&gt;<br>
&amp;quot;short_report_allowed&amp;quot;&nbsp;:&nbsp;true,&lt;br&gt;<br>
&amp;quot;protocol_data&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;encoding&amp;quot;&nbsp;:&nbsp;0,&lt;br&gt;<br>
&amp;quot;timestamp&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;month&amp;quot;&nbsp;:&nbsp;1,&lt;br&gt;<br>
&amp;quot;day&amp;quot;&nbsp;:&nbsp;1,&lt;br&gt;<br>
&amp;quot;hour&amp;quot;&nbsp;:&nbsp;0,&lt;br&gt;<br>
&amp;quot;minute&amp;quot;&nbsp;:&nbsp;0&lt;br&gt;<br>
}&lt;br&gt;<br>
}&lt;br&gt;<br>
}&lt;br&gt;<br>
}&lt;br&gt;<br>
}&lt;br&gt;<br>
}&amp;#39;;&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;$mq_router&nbsp;=&nbsp;Net::RabbitMQ-&amp;gt;new();&lt;br&gt;<br>
$mq_router-&amp;gt;connect(&nbsp;&amp;quot;localhost&amp;quot;,&nbsp;{&nbsp;user&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;,&nbsp;password&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;&nbsp;}&nbsp;);&lt;br&gt;<br>
$mq_router-&amp;gt;channel_open(ROUTER_CHANNEL);&lt;br&gt;<br>
$mq_router-&amp;gt;queue_declare(&lt;br&gt;<br>
&nbsp; &nbsp; ROUTER_CHANNEL,&lt;br&gt;<br>
&nbsp; &nbsp; ROUTER_QUEUE,&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; passive&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;0,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; durable&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;1,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; exclusive&nbsp; &nbsp;=&amp;gt;&nbsp;0,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; auto_delete&nbsp;=&amp;gt;&nbsp;0&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
);&lt;br&gt;<br>
$mq_router-&amp;gt;queue_bind(&nbsp;ROUTER_CHANNEL,&nbsp;ROUTER_QUEUE,&nbsp;ROUTER_EXCHANGE,&nbsp;&amp;#39;&amp;#39;&nbsp;);&lt;br&gt;<br>
$mq_router-&amp;gt;purge(&nbsp;ROUTER_CHANNEL,&nbsp;ROUTER_QUEUE&nbsp;);&lt;br&gt;<br>
$mq_router-&amp;gt;consume(&nbsp;ROUTER_CHANNEL,&nbsp;ROUTER_QUEUE&nbsp;);&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;$mq_sf&nbsp;=&nbsp;Net::RabbitMQ-&amp;gt;new();&lt;br&gt;<br>
$mq_sf-&amp;gt;connect(&nbsp;&amp;quot;localhost&amp;quot;,&nbsp;{&nbsp;user&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;,&nbsp;password&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;&nbsp;}&nbsp;);&lt;br&gt;<br>
$mq_sf-&amp;gt;channel_open(SF_CHANNEL);&lt;br&gt;<br>
$mq_sf-&amp;gt;exchange_declare(&lt;br&gt;<br>
&nbsp; &nbsp; SF_CHANNEL,&lt;br&gt;<br>
&nbsp; &nbsp; SF_EXCHANGE,&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; exchange_type&nbsp;=&amp;gt;&nbsp;&amp;#39;direct&amp;#39;,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; passive&nbsp; &nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;0,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; durable&nbsp; &nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;1,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; auto_delete&nbsp; &nbsp;=&amp;gt;&nbsp;0&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
);&lt;br&gt;<br>
$mq_sf-&amp;gt;queue_declare(&lt;br&gt;<br>
&nbsp; &nbsp; SF_CHANNEL,&lt;br&gt;<br>
&nbsp; &nbsp; SF_QUEUE,&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; passive&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;0,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; durable&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;1,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; exclusive&nbsp; &nbsp;=&amp;gt;&nbsp;0,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; auto_delete&nbsp;=&amp;gt;&nbsp;0&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
);&lt;br&gt;<br>
$mq_sf-&amp;gt;queue_bind(&nbsp;SF_CHANNEL,&nbsp;SF_QUEUE,&nbsp;SF_EXCHANGE,&nbsp;&amp;#39;&amp;#39;&nbsp;);&lt;br&gt;<br>
$mq_sf-&amp;gt;purge(&nbsp;SF_CHANNEL,&nbsp;SF_QUEUE&nbsp;);&lt;br&gt;<br>
$mq_sf-&amp;gt;consume(&nbsp;SF_CHANNEL,&nbsp;SF_QUEUE&nbsp;);&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;$mq_cassidian&nbsp;=&nbsp;Net::RabbitMQ-&amp;gt;new();&lt;br&gt;<br>
$mq_cassidian-&amp;gt;connect(&nbsp;&amp;quot;localhost&amp;quot;,&nbsp;{&nbsp;user&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;,&nbsp;password&nbsp;=&amp;gt;&nbsp;&amp;quot;guest&amp;quot;&nbsp;}&nbsp;);&lt;br&gt;<br>
$mq_cassidian-&amp;gt;channel_open(CASSIDIAN_CHANNEL);&lt;br&gt;<br>
$mq_cassidian-&amp;gt;exchange_declare(&lt;br&gt;<br>
&nbsp; &nbsp; CASSIDIAN_CHANNEL,&lt;br&gt;<br>
&nbsp; &nbsp; CASSIDIAN_EXCHANGE,&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; exchange_type&nbsp;=&amp;gt;&nbsp;&amp;#39;direct&amp;#39;,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; passive&nbsp; &nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;0,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; durable&nbsp; &nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;1,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; auto_delete&nbsp; &nbsp;=&amp;gt;&nbsp;0&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
);&lt;br&gt;<br>
$mq_cassidian-&amp;gt;queue_declare(&lt;br&gt;<br>
&nbsp; &nbsp; CASSIDIAN_CHANNEL,&lt;br&gt;<br>
&nbsp; &nbsp; CASSIDIAN_QUEUE,&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; passive&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;0,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; durable&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;1,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; exclusive&nbsp; &nbsp;=&amp;gt;&nbsp;0,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; auto_delete&nbsp;=&amp;gt;&nbsp;0&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
);&lt;br&gt;<br>
$mq_cassidian-&amp;gt;queue_bind(&nbsp;CASSIDIAN_CHANNEL,&nbsp;CASSIDIAN_QUEUE,&lt;br&gt;<br>
&nbsp; &nbsp; CASSIDIAN_EXCHANGE,&nbsp;&amp;#39;&amp;#39;&nbsp;);&lt;br&gt;<br>
$mq_cassidian-&amp;gt;purge(&nbsp;CASSIDIAN_CHANNEL,&nbsp;CASSIDIAN_QUEUE&nbsp;);&lt;br&gt;<br>
$mq_cassidian-&amp;gt;consume(&nbsp;CASSIDIAN_CHANNEL,&nbsp;CASSIDIAN_QUEUE&nbsp;);&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;$before&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
&lt;br&gt;<br>
$mq_router-&amp;gt;publish(&lt;br&gt;<br>
&nbsp; &nbsp; ROUTER_CHANNEL,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;&amp;#39;,&lt;br&gt;<br>
&nbsp; &nbsp; $json_text,&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;Options&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; exchange&nbsp;=&amp;gt;&nbsp;ROUTER_EXCHANGE&lt;br&gt;<br>
&nbsp; &nbsp; },&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;Props&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; content_encoding&nbsp;=&amp;gt;&nbsp;&amp;quot;UTF-8&amp;quot;,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; content_type&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;&amp;quot;application/json&amp;quot;&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
);&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;$sent&nbsp;=&nbsp;decode_json($json_text);&lt;br&gt;<br>
my&nbsp;$message;&lt;br&gt;<br>
eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; local&nbsp;$SIG{ALRM}&nbsp;=&nbsp;sub&nbsp;{&nbsp;die&nbsp;&amp;quot;Timeout\n&amp;quot;&nbsp;};&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;8;&lt;br&gt;<br>
&nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_router-&amp;gt;recv();&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;0;&lt;br&gt;<br>
};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&nbsp;from&nbsp;queue&amp;#39;&nbsp;);&lt;br&gt;<br>
my&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;$sent-&amp;gt;{&amp;#39;sender&amp;#39;}&nbsp;);&lt;br&gt;<br>
is_deeply(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;&amp;#39;body&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;timestamp&amp;#39;},&lt;br&gt;<br>
&nbsp; &nbsp; &amp;quot;timestamp&nbsp;&amp;quot;&nbsp;.&nbsp;$sent-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;);&lt;br&gt;<br>
&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; local&nbsp;$SIG{ALRM}&nbsp;=&nbsp;sub&nbsp;{&nbsp;die&nbsp;&amp;quot;Timeout\n&amp;quot;&nbsp;};&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;8;&lt;br&gt;<br>
&nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_sf-&amp;gt;recv();&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;0;&lt;br&gt;<br>
};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;ROUTER_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;ROUTER_EXCHANGE&nbsp;);&lt;br&gt;<br>
is_deeply(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;&amp;#39;body&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
like(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;qr/^\d+$/,&nbsp;&amp;quot;timestamp&nbsp;an&nbsp;integer&amp;quot;&nbsp;);&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;=&nbsp;$before,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;&nbsp;$before&amp;quot;);&lt;br&gt;<br>
my&nbsp;$now&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;=&nbsp;$now,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;&nbsp;$now&amp;quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; local&nbsp;$SIG{ALRM}&nbsp;=&nbsp;sub&nbsp;{&nbsp;die&nbsp;&amp;quot;Timeout\n&amp;quot;&nbsp;};&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;8;&lt;br&gt;<br>
&nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_router-&amp;gt;recv();&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;0;&lt;br&gt;<br>
};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;#39;&amp;#39;,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;SF_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;SF_EXCHANGE&nbsp;);&lt;br&gt;<br>
is_deeply(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;&amp;#39;body&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
like(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;qr/^\d+$/,&nbsp;&amp;quot;timestamp&nbsp;an&nbsp;integer&amp;quot;&nbsp;);&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;=&nbsp;$before,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;&nbsp;$before&amp;quot;);&lt;br&gt;<br>
$now&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;=&nbsp;$now,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;&nbsp;$now&amp;quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; local&nbsp;$SIG{ALRM}&nbsp;=&nbsp;sub&nbsp;{&nbsp;die&nbsp;&amp;quot;Timeout\n&amp;quot;&nbsp;};&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;8;&lt;br&gt;<br>
&nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_router-&amp;gt;recv();&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;0;&lt;br&gt;<br>
};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;#39;&amp;#39;,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;SF_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;SF_EXCHANGE&nbsp;);&lt;br&gt;<br>
like(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;qr/^\d+$/,&nbsp;&amp;quot;timestamp&nbsp;an&nbsp;integer&amp;quot;&nbsp;);&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;=&nbsp;$before,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;&nbsp;$before&amp;quot;);&lt;br&gt;<br>
$now&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;=&nbsp;$now,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;&nbsp;$now&amp;quot;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;id&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;id&amp;#39;},&nbsp;&amp;#39;id&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;ack_type&amp;#39;},&nbsp;&amp;#39;processed&amp;#39;,&nbsp;&amp;#39;ack_type&nbsp;processed&amp;#39;&nbsp;);&lt;br&gt;<br>
is_deeply(&lt;br&gt;<br>
&nbsp; &nbsp; $json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;from&amp;#39;},&lt;br&gt;<br>
&nbsp; &nbsp; $sent-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;to&amp;#39;},&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;from&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;to&nbsp;of&nbsp;sent&amp;#39;&lt;br&gt;<br>
);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;type&amp;#39;},&nbsp; &nbsp; &amp;#39;ack&amp;#39;,&nbsp;&amp;#39;type&nbsp;is&nbsp;ack&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;version&amp;#39;},&nbsp;1,&nbsp; &nbsp; &nbsp;&amp;#39;version&nbsp;is&nbsp;1&amp;#39;&nbsp;);&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;$end&nbsp;=&nbsp;time()&nbsp;+&nbsp;8;&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
do&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_cassidian-&amp;gt;get(&nbsp;CASSIDIAN_CHANNEL,&nbsp;CASSIDIAN_QUEUE&nbsp;);&lt;br&gt;<br>
&nbsp; &nbsp; };&lt;br&gt;<br>
&nbsp; &nbsp; if&nbsp;($@)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; diag($@);&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
}&nbsp;until&nbsp;(&nbsp;defined&nbsp;$message&nbsp;or&nbsp;time()&nbsp;&amp;gt;&nbsp;$end&nbsp;or&nbsp;$@&nbsp;);&lt;br&gt;<br>
ok(&nbsp;defined&nbsp;$message,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;ROUTER_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;ROUTER_EXCHANGE&nbsp;);&lt;br&gt;<br>
is_deeply(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;&amp;#39;body&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
like(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;qr/^\d+$/,&nbsp;&amp;quot;timestamp&nbsp;an&nbsp;integer&amp;quot;&nbsp;);&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;=&nbsp;$before,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;&nbsp;$before&amp;quot;);&lt;br&gt;<br>
$now&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;=&nbsp;$now,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;&nbsp;$now&amp;quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
$end&nbsp;=&nbsp;time()&nbsp;+&nbsp;8;&lt;br&gt;<br>
note(&amp;quot;Trying&nbsp;to&nbsp;receive&nbsp;an&nbsp;Ack&nbsp;from&nbsp;Cassidian&nbsp;exchange&amp;quot;);&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
do&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_cassidian-&amp;gt;get(&nbsp;CASSIDIAN_CHANNEL,&nbsp;CASSIDIAN_QUEUE&nbsp;);&lt;br&gt;<br>
&nbsp; &nbsp; };&lt;br&gt;<br>
&nbsp; &nbsp; if&nbsp;($@)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; diag($@);&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
}&nbsp;until&nbsp;(&nbsp;defined&nbsp;$message&nbsp;or&nbsp;time()&nbsp;&amp;gt;&nbsp;$end&nbsp;or&nbsp;$@&nbsp;);&lt;br&gt;<br>
ok(&nbsp;defined&nbsp;$message,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;ROUTER_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;ROUTER_EXCHANGE&nbsp;);&lt;br&gt;<br>
like(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;qr/^\d+$/,&nbsp;&amp;quot;timestamp&nbsp;an&nbsp;integer&amp;quot;&nbsp;);&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;=&nbsp;$before,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;&nbsp;$before&amp;quot;);&lt;br&gt;<br>
$now&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;=&nbsp;$now,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;&nbsp;$now&amp;quot;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;id&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;id&amp;#39;},&nbsp;&amp;#39;id&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;ack_type&amp;#39;},&nbsp;&amp;#39;processed&amp;#39;,&nbsp;&amp;#39;ack_type&nbsp;processed&amp;#39;&nbsp;);&lt;br&gt;<br>
is_deeply(&lt;br&gt;<br>
&nbsp; &nbsp; $json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;from&amp;#39;},&lt;br&gt;<br>
&nbsp; &nbsp; $sent-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;to&amp;#39;},&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;from&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;to&nbsp;of&nbsp;sent&amp;#39;&lt;br&gt;<br>
);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;type&amp;#39;},&nbsp; &nbsp; &amp;#39;ack&amp;#39;,&nbsp;&amp;#39;type&nbsp;is&nbsp;ack&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;}-&amp;gt;{&amp;#39;version&amp;#39;},&nbsp;1,&nbsp; &nbsp; &nbsp;&amp;#39;version&nbsp;is&nbsp;1&amp;#39;&nbsp;);&lt;br&gt;<br>
&lt;br&gt;<br>
my&nbsp;$ack&nbsp;=&nbsp;&amp;#39;{&lt;br&gt;<br>
&amp;quot;timestamp&amp;quot;&nbsp;:&nbsp;1328020064358,&lt;br&gt;<br>
&amp;quot;sender&amp;quot;&nbsp;:&nbsp;&amp;quot;&amp;#39;&nbsp;.&nbsp;CASSIDIAN_EXCHANGE&nbsp;.&nbsp;&amp;#39;&amp;quot;,&lt;br&gt;<br>
&amp;quot;body&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;type&amp;quot;&nbsp;:&nbsp;&amp;quot;ack&amp;quot;,&lt;br&gt;<br>
&amp;quot;version&amp;quot;&nbsp;:&nbsp;1,&lt;br&gt;<br>
&amp;quot;id&amp;quot;&nbsp;:&nbsp;&amp;quot;8f970b1b-f8a3-4c78-aa24-3b8e2205648788&amp;quot;,&lt;br&gt;<br>
&amp;quot;from&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;type&amp;quot;&nbsp;:&nbsp;&amp;quot;ssi&amp;quot;,&lt;br&gt;<br>
&amp;quot;address&amp;quot;&nbsp;:&nbsp;&amp;quot;0&amp;quot;&lt;br&gt;<br>
},&lt;br&gt;<br>
&amp;quot;ack_type&amp;quot;&nbsp;:&nbsp;&amp;quot;sent&amp;quot;,&lt;br&gt;<br>
&amp;quot;auxiliary&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;timestamp&amp;quot;&nbsp;:&nbsp;1325376000000,&lt;br&gt;<br>
&amp;quot;original_message&amp;quot;&nbsp;:&nbsp;&amp;#39;&nbsp;.&nbsp;encode_json(&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;)&nbsp;.&nbsp;&amp;#39;,&lt;br&gt;<br>
&amp;quot;sdstl&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;protocol_id&amp;quot;&nbsp;:&nbsp;130,&lt;br&gt;<br>
&amp;quot;message_reference&amp;quot;&nbsp;:&nbsp;42,&lt;br&gt;<br>
&amp;quot;short_report_allowed&amp;quot;&nbsp;:&nbsp;true,&lt;br&gt;<br>
&amp;quot;protocol_data&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;encoding&amp;quot;&nbsp;:&nbsp;0,&lt;br&gt;<br>
&amp;quot;timestamp&amp;quot;&nbsp;:&nbsp;{&lt;br&gt;<br>
&amp;quot;month&amp;quot;&nbsp;:&nbsp;1,&lt;br&gt;<br>
&amp;quot;day&amp;quot;&nbsp;:&nbsp;1,&lt;br&gt;<br>
&amp;quot;hour&amp;quot;&nbsp;:&nbsp;0,&lt;br&gt;<br>
&amp;quot;minute&amp;quot;&nbsp;:&nbsp;0&lt;br&gt;<br>
}&lt;br&gt;<br>
}&lt;br&gt;<br>
}&lt;br&gt;<br>
}&lt;br&gt;<br>
}&lt;br&gt;<br>
}&amp;#39;;&lt;br&gt;<br>
$sent&nbsp; &nbsp;=&nbsp;decode_json($ack);&lt;br&gt;<br>
$before&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
&lt;br&gt;<br>
$mq_router-&amp;gt;publish(&lt;br&gt;<br>
&nbsp; &nbsp; ROUTER_CHANNEL,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;&amp;#39;,&nbsp;$ack,&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;Options&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; exchange&nbsp;=&amp;gt;&nbsp;ROUTER_EXCHANGE&lt;br&gt;<br>
&nbsp; &nbsp; },&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;Props&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; content_encoding&nbsp;=&amp;gt;&nbsp;&amp;quot;UTF-8&amp;quot;,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; content_type&nbsp; &nbsp; &nbsp;=&amp;gt;&nbsp;&amp;quot;application/json&amp;quot;&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
);&lt;br&gt;<br>
&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; local&nbsp;$SIG{ALRM}&nbsp;=&nbsp;sub&nbsp;{&nbsp;die&nbsp;&amp;quot;Timeout\n&amp;quot;&nbsp;};&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;8;&lt;br&gt;<br>
&nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_router-&amp;gt;recv();&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;0;&lt;br&gt;<br>
};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;timestamp&amp;#39;},&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;&amp;#39;&nbsp;.&nbsp;$sent-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;CASSIDIAN_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;CASSIDIAN_EXCHANGE&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&lt;br&gt;<br>
is_deeply(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;&amp;#39;body&nbsp;the&nbsp;same&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&lt;br&gt;<br>
&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; local&nbsp;$SIG{ALRM}&nbsp;=&nbsp;sub&nbsp;{&nbsp;die&nbsp;&amp;quot;Timeout\n&amp;quot;&nbsp;};&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;8;&lt;br&gt;<br>
&nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_sf-&amp;gt;recv();&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;0;&lt;br&gt;<br>
};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;ROUTER_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;ROUTER_EXCHANGE&nbsp;);&lt;br&gt;<br>
is_deeply(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;&amp;#39;body&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
like(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;qr/^\d+$/,&nbsp;&amp;quot;timestamp&nbsp;an&nbsp;integer&amp;quot;&nbsp;);&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;=&nbsp;$before,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;&nbsp;$before&amp;quot;);&lt;br&gt;<br>
$now&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;=&nbsp;$now,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;&nbsp;$now&amp;quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; local&nbsp;$SIG{ALRM}&nbsp;=&nbsp;sub&nbsp;{&nbsp;die&nbsp;&amp;quot;Timeout\n&amp;quot;&nbsp;};&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;8;&lt;br&gt;<br>
&nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_router-&amp;gt;recv();&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;0;&lt;br&gt;<br>
};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;#39;&amp;#39;,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;SF_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;SF_EXCHANGE&nbsp;);&lt;br&gt;<br>
is_deeply(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;&amp;#39;body&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
like(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;qr/^\d+$/,&nbsp;&amp;quot;timestamp&nbsp;an&nbsp;integer&amp;quot;&nbsp;);&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;=&nbsp;$before,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;&nbsp;$before&amp;quot;);&lt;br&gt;<br>
$now&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;=&nbsp;$now,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;&nbsp;$now&amp;quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
undef&nbsp;$message;&lt;br&gt;<br>
eval&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; local&nbsp;$SIG{ALRM}&nbsp;=&nbsp;sub&nbsp;{&nbsp;die&nbsp;&amp;quot;Timeout\n&amp;quot;&nbsp;};&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;8;&lt;br&gt;<br>
&nbsp; &nbsp; $message&nbsp;=&nbsp;$mq_cassidian-&amp;gt;recv();&lt;br&gt;<br>
&nbsp; &nbsp; alarm&nbsp;0;&lt;br&gt;<br>
};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;message&nbsp;was&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
undef&nbsp;$json;&lt;br&gt;<br>
eval&nbsp;{&nbsp;$json&nbsp;=&nbsp;decode_json(&nbsp;$message-&amp;gt;{&amp;#39;body&amp;#39;}&nbsp;);&nbsp;};&lt;br&gt;<br>
is(&nbsp;$@,&nbsp;&amp;#39;&amp;#39;,&nbsp;&amp;#39;A&nbsp;JSON&nbsp;message&nbsp;received&amp;#39;&nbsp;);&lt;br&gt;<br>
is(&nbsp;$json-&amp;gt;{&amp;#39;sender&amp;#39;},&nbsp;ROUTER_EXCHANGE,&nbsp;&amp;#39;sender&nbsp;&amp;#39;&nbsp;.&nbsp;ROUTER_EXCHANGE&nbsp;);&lt;br&gt;<br>
is_deeply(&nbsp;$json-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;$sent-&amp;gt;{&amp;#39;body&amp;#39;},&nbsp;&amp;#39;body&nbsp;the&nbsp;same&amp;#39;&nbsp;);&lt;br&gt;<br>
like(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;},&nbsp;qr/^\d+$/,&nbsp;&amp;quot;timestamp&nbsp;an&nbsp;integer&amp;quot;&nbsp;);&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;=&nbsp;$before,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;before&nbsp;publishing&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;&nbsp;$before&amp;quot;);&lt;br&gt;<br>
$now&nbsp;=&nbsp;timestamp();&lt;br&gt;<br>
ok(&nbsp;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;lt;=&nbsp;$now,&lt;br&gt;<br>
&nbsp; &nbsp; &amp;#39;timestamp&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;that&nbsp;of&nbsp;now&amp;#39;&nbsp;)&lt;br&gt;<br>
&nbsp; or&nbsp;diag(&amp;quot;$json-&amp;gt;{&amp;#39;timestamp&amp;#39;}&nbsp;&amp;gt;&nbsp;$now&amp;quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
END&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; $mq_sf-&amp;gt;queue_unbind(&nbsp;SF_CHANNEL,&nbsp;SF_QUEUE,&nbsp;SF_EXCHANGE,&nbsp;&amp;#39;&amp;#39;&nbsp;);&lt;br&gt;<br>
&nbsp; &nbsp; $mq_router-&amp;gt;queue_unbind(&nbsp;ROUTER_CHANNEL,&nbsp;ROUTER_QUEUE,&nbsp;ROUTER_EXCHANGE,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &amp;#39;&amp;#39;&nbsp;);&lt;br&gt;<br>
&nbsp; &nbsp; $mq_cassidian-&amp;gt;queue_unbind(&nbsp;CASSIDIAN_CHANNEL,&nbsp;CASSIDIAN_QUEUE,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; CASSIDIAN_EXCHANGE,&nbsp;&amp;#39;&amp;#39;&nbsp;);&lt;br&gt;<br>
&nbsp; &nbsp; system(&lt;br&gt;<br>
&amp;#39;service&nbsp;pmc-smpp&nbsp;start&nbsp;&amp;gt;&amp;amp;2;&nbsp;service&nbsp;pmc-cassidian&nbsp;start&nbsp;&amp;gt;&amp;amp;2;&nbsp;service&nbsp;pmc-email&nbsp;start&nbsp;&amp;gt;&amp;amp;2&amp;#39;&lt;br&gt;<br>
&nbsp; &nbsp; );&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
regards,&nbsp;Matti&nbsp;Linnanvuori&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
