<tt>
Last&nbsp;night&nbsp;we&nbsp;had&nbsp;our&nbsp;first&nbsp;major&nbsp;production&nbsp;RabbitMQ&nbsp;incident.&nbsp; We&nbsp;we&nbsp;standing&nbsp;up&nbsp;a&nbsp;new&nbsp;cluster&nbsp;that&nbsp;was&nbsp;going&nbsp;to&nbsp;receive&nbsp;messages&nbsp;from&nbsp;the&nbsp;first&nbsp;cluster&nbsp;through&nbsp;a&nbsp;shovel.&nbsp; Sysops&nbsp;had&nbsp;not&nbsp;shutdown&nbsp;the&nbsp;Erlang&nbsp;ports&nbsp;between&nbsp;the&nbsp;new&nbsp;and&nbsp;existing&nbsp;cluster,&nbsp;and&nbsp;the&nbsp;base&nbsp;image&nbsp;used&nbsp;the&nbsp;same&nbsp;Erlang&nbsp;cookie.&nbsp; Inadvertently&nbsp;one&nbsp;of&nbsp;the&nbsp;nodes&nbsp;of&nbsp;the&nbsp;new&nbsp;cluster&nbsp;appears&nbsp;to&nbsp;have&nbsp;had&nbsp;an&nbsp;old&nbsp;config&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;cluster.&nbsp; That&nbsp;node&nbsp;joined&nbsp;the&nbsp;existing&nbsp;cluster&nbsp;as&nbsp;a&nbsp;RAM&nbsp;node.&nbsp; The&nbsp;sysops&nbsp;tried&nbsp;a&nbsp;few&nbsp;things&nbsp;to&nbsp;remove&nbsp;the&nbsp;node&nbsp;from&nbsp;the&nbsp;existing&nbsp;cluster&nbsp;without&nbsp;success,&nbsp;then&nbsp;I&nbsp;was&nbsp;called&nbsp;in.&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;By&nbsp;the&nbsp;time&nbsp;I&nbsp;came&nbsp;in&nbsp;the&nbsp;new&nbsp;node&nbsp;had&nbsp;been&nbsp;reconfigured&nbsp;to&nbsp;join&nbsp;the&nbsp;new&nbsp;cluster,&nbsp;but&nbsp;the&nbsp;old&nbsp;cluster&nbsp;still&nbsp;believed&nbsp;it&nbsp;to&nbsp;be&nbsp;a&nbsp;member.&nbsp; Since&nbsp;RabbitMQ&nbsp;has&nbsp;no&nbsp;mechanism&nbsp;to&nbsp;remove&nbsp;a&nbsp;node&nbsp;from&nbsp;a&nbsp;cluster&nbsp;except&nbsp;from&nbsp;the&nbsp;node&nbsp;itself,&nbsp;I&nbsp;had&nbsp;them&nbsp;take&nbsp;the&nbsp;new&nbsp;node&nbsp;and&nbsp;join&nbsp;it&nbsp;once&nbsp;more&nbsp;to&nbsp;the&nbsp;existing&nbsp;cluster,&nbsp;then&nbsp;remove&nbsp;it&nbsp;using&nbsp;the&nbsp;reset&nbsp;command&nbsp;on&nbsp;the&nbsp;new&nbsp;node.&nbsp; That&nbsp;left&nbsp;the&nbsp;new&nbsp;node&nbsp;thinking&nbsp;it&nbsp;was&nbsp;not&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;cluster,&nbsp;but&nbsp;the&nbsp;existing&nbsp;cluster&nbsp;still&nbsp;thought&nbsp;it&nbsp;was&nbsp;a&nbsp;RAM&nbsp;node.&nbsp; We&nbsp;tried&nbsp;this&nbsp;a&nbsp;few&nbsp;times&nbsp;unsuccessfully.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;figured&nbsp;we&nbsp;could&nbsp;try&nbsp;taking&nbsp;down&nbsp;each&nbsp;node&nbsp;in&nbsp;the&nbsp;existing&nbsp;cluster&nbsp;one&nbsp;at&nbsp;a&nbsp;time,&nbsp;reseting&nbsp;it,&nbsp;and&nbsp;having&nbsp;it&nbsp;rejoin&nbsp;the&nbsp;cluster,&nbsp;hoping&nbsp;that&nbsp;it&nbsp;would&nbsp;clear&nbsp;whatever&nbsp;issue&nbsp;it&nbsp;had.&nbsp; So&nbsp;long&nbsp;as&nbsp;we&nbsp;kept&nbsp;at&nbsp;least&nbsp;one&nbsp;disk&nbsp;node&nbsp;in&nbsp;the&nbsp;existing&nbsp;cluster&nbsp;our&nbsp;state&nbsp;should&nbsp;be&nbsp;maintained&nbsp;(mines&nbsp;any&nbsp;non-HA&nbsp;queues&nbsp;and&nbsp;messages&nbsp;in&nbsp;them).&nbsp; Apparently&nbsp;we&nbsp;choose&nbsp;the&nbsp;wrong&nbsp;node.&nbsp; When&nbsp;we&nbsp;tried&nbsp;to&nbsp;have&nbsp;it&nbsp;rejoin&nbsp;the&nbsp;remaining&nbsp;node&nbsp;in&nbsp;the&nbsp;existing&nbsp;cluster&nbsp;it&nbsp;failed.&nbsp; It&nbsp;seems&nbsp;Mnesia&nbsp;on&nbsp;the&nbsp;remaining&nbsp;node&nbsp;was&nbsp;corrupted&nbsp;somehow.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;the&nbsp;end&nbsp;we&nbsp;had&nbsp;to&nbsp;remove&nbsp;the&nbsp;RabbitMQ&nbsp;lib&nbsp;directory&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;existing&nbsp;cluster&nbsp;from&nbsp;scratch.&nbsp; As&nbsp;you&nbsp;can&nbsp;imagine&nbsp;that&nbsp;was&nbsp;not&nbsp;much&nbsp;fun.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;time&nbsp;I&amp;#39;ve&nbsp;been&nbsp;Mnesia&nbsp;become&nbsp;confused&nbsp;somehow.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;few&nbsp;suggestions:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Can&nbsp;we&nbsp;please&nbsp;have&nbsp;a&nbsp;command&nbsp;that&nbsp;allows&nbsp;you&nbsp;to&nbsp;remove&nbsp;a&nbsp;node&nbsp;from&nbsp;a&nbsp;cluster&nbsp;from&nbsp;a&nbsp;node&nbsp;other&nbsp;than&nbsp;the&nbsp;node&nbsp;you&nbsp;a&nbsp;trying&nbsp;to&nbsp;remove?&nbsp;Bring&nbsp;back&nbsp;up&nbsp;a&nbsp;node&nbsp;just&nbsp;to&nbsp;remove&nbsp;it&nbsp;from&nbsp;the&nbsp;cluster&nbsp;is&nbsp;time&nbsp;consuming&nbsp;and&nbsp;potentially&nbsp;error&nbsp;prone.&nbsp; &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Can&nbsp;we&nbsp;please&nbsp;have&nbsp;some&nbsp;tools&nbsp;that&nbsp;will&nbsp;analyze&nbsp;Mnesia&nbsp;on&nbsp;each&nbsp;node&nbsp;and&nbsp;give&nbsp;us&nbsp;an&nbsp;idea&nbsp;of&nbsp;its&nbsp;health?&nbsp; Whether&nbsp;its&nbsp;corrupted&nbsp;or&nbsp;somehow&nbsp;out&nbsp;of&nbsp;sync&nbsp;with&nbsp;other&nbsp;nodes&nbsp;in&nbsp;the&nbsp;cluster.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Elias&nbsp;Levy&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
