<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;We&nbsp;implement&nbsp;our &lt;span&nbsp;class=&quot;&quot;&gt;nyt&lt;/span&gt;⨍aбrik&nbsp;system&nbsp;as&nbsp;a&nbsp;collection&nbsp;of&nbsp;vhost&nbsp;nodes.&nbsp;The&nbsp;vhosts&nbsp;are&nbsp;named&nbsp;according&nbsp;to&nbsp;a&nbsp;set&nbsp;of&nbsp;rules:&nbsp;role,&nbsp;region,&nbsp;product,&nbsp;organization,&nbsp;environment&nbsp;(dev,&nbsp;stage,&nbsp;production),&nbsp;etc.&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;vhosts&nbsp;are&nbsp;multiply&nbsp;connected&nbsp;via&nbsp;shovels&nbsp;and&nbsp;federation.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;mapping&nbsp;of&nbsp;vhosts&nbsp;to&nbsp;hosts&nbsp;varies.&nbsp;For&nbsp;example,&nbsp;in&nbsp;production&nbsp;we&nbsp;usually&nbsp;run&nbsp;1&nbsp;vhost&nbsp;per&nbsp;host&nbsp;spread&nbsp;across&nbsp;many&nbsp;regions/zones&nbsp;in&nbsp;the&nbsp;cloud.&nbsp;For&nbsp;dev,&nbsp;I&nbsp;can&nbsp;run&nbsp;the&nbsp;exact&nbsp;same&nbsp;configuration&nbsp;on&nbsp;my&nbsp;mac&nbsp;using&nbsp;a&nbsp;single&nbsp;cluster&nbsp;with&nbsp;vhosts&nbsp;representing&nbsp;all&nbsp;the&nbsp;roles,&nbsp;regions,&nbsp;etc.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;point&nbsp;with&nbsp;regard&nbsp;to&nbsp;the&nbsp;OP&nbsp;is&nbsp;that&nbsp;you&nbsp;can&nbsp;architect&nbsp;using&nbsp;multiple&nbsp;vhosts,&nbsp;and&nbsp;there&nbsp;can&nbsp;be&nbsp;benefits,&nbsp;as&nbsp;we&nbsp;realize.&nbsp;But&nbsp;you&nbsp;should&nbsp;consider&nbsp;the&nbsp;separation&nbsp;Simon&nbsp;referred&nbsp;to&nbsp;as&nbsp;a&nbsp;virtue,&nbsp;using&nbsp;it&nbsp;to&nbsp;maintain&nbsp;a&nbsp;flexible&nbsp;and&nbsp;reliable&nbsp;arrangement&nbsp;of&nbsp;loosely&nbsp;coupled&nbsp;strong&nbsp;components.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Best&nbsp;regards,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Michael&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Mar&nbsp;24,&nbsp;2014&nbsp;at&nbsp;6:53&nbsp;AM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;22/03/2014&nbsp;11:33PM,&nbsp;Adam&nbsp;Smith&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Hi,&lt;br&gt;<br>
 &nbsp; I&nbsp;want&nbsp;to&nbsp;write&nbsp;a&nbsp;custom&nbsp;exchange&nbsp;type&nbsp;plugin&nbsp;to&nbsp;accomplish&nbsp;the&lt;br&gt;<br>
following:&lt;br&gt;<br>
&lt;br&gt;<br>
1.&nbsp;My&nbsp;application&nbsp;publishes&nbsp;messages&nbsp;to&nbsp;a&nbsp;custom&nbsp;exchange&nbsp;CUST&nbsp;in&nbsp;vhost&lt;br&gt;<br>
MYAPP&lt;br&gt;<br>
2.&nbsp;The&nbsp;custom&nbsp;exchange&nbsp;plugin&nbsp;in&nbsp;turn&nbsp;publishes&nbsp;the&nbsp;same&nbsp;message&nbsp;to&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; a.&nbsp;exchange&nbsp;X&nbsp;in&nbsp;vhost&nbsp;CL1&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; b.&nbsp;exchange&nbsp;X&nbsp;in&nbsp;vhost&nbsp;CL2&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; .....&lt;br&gt;<br>
The&nbsp;number&nbsp;of&nbsp;CLx&nbsp;vhosts&nbsp;can&nbsp;vary&nbsp;at&nbsp;different&nbsp;points&nbsp;in&nbsp;the&lt;br&gt;<br>
application&#39;s&nbsp;lifetime.&nbsp;Any&nbsp;pointers&nbsp;on&nbsp;how/whether&nbsp;it&nbsp;can&nbsp;done&nbsp;would&nbsp;be&lt;br&gt;<br>
greatly&nbsp;appreciated.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
It&nbsp;can&nbsp;be&nbsp;done,&nbsp;since&nbsp;rabbit_exchange_type:route/2&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;#resource{}s&nbsp;for&nbsp;the&nbsp;queue&nbsp;names&nbsp;to&nbsp;route&nbsp;to&nbsp;-&nbsp;and&nbsp;each&nbsp;#resource{}&nbsp;contains&nbsp;a&nbsp;virtual&nbsp;host.&nbsp;So&nbsp;you&nbsp;could&nbsp;mess&nbsp;with&nbsp;virtual&nbsp;hosts&nbsp;according&nbsp;to&nbsp;whatever&nbsp;logic&nbsp;you&nbsp;want&nbsp;in&nbsp;that&nbsp;function.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
However&nbsp;(and&nbsp;it&#39;s&nbsp;quite&nbsp;a&nbsp;big&nbsp;however),&nbsp;RabbitMQ&nbsp;(and&nbsp;AMQP)&nbsp;are&nbsp;definitely&nbsp;not&nbsp;designed&nbsp;to&nbsp;work&nbsp;like&nbsp;that.&nbsp;Each&nbsp;virtual&nbsp;host&nbsp;is&nbsp;supposed&nbsp;to&nbsp;be&nbsp;a&nbsp;self-contained&nbsp;universe,&nbsp;so&nbsp;by&nbsp;routing&nbsp;across&nbsp;virtual&nbsp;hosts&nbsp;you&nbsp;are&nbsp;breaking&nbsp;the&nbsp;rules.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Some&nbsp;issues&nbsp;you&nbsp;will&nbsp;experience&nbsp;(I&nbsp;won&#39;t&nbsp;guarantee&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;complete&nbsp;list):&lt;br&gt;<br>
&lt;br&gt;<br>
1)&nbsp;You&nbsp;won&#39;t&nbsp;be&nbsp;allowed&nbsp;to&nbsp;establish&nbsp;a&nbsp;cross-vhost&nbsp;binding,&nbsp;so&nbsp;you&#39;ll&nbsp;have&nbsp;to&nbsp;determine&nbsp;how&nbsp;cross-vhost&nbsp;routing&nbsp;works&nbsp;in&nbsp;practice&nbsp;without&nbsp;reference&nbsp;to&nbsp;bindings.&lt;br&gt;<br>
&lt;br&gt;<br>
2)&nbsp;The&nbsp;permissions&nbsp;system&nbsp;won&#39;t&nbsp;take&nbsp;any&nbsp;account&nbsp;of&nbsp;any&nbsp;cross-vhost&nbsp;routing&nbsp;you&nbsp;do.&lt;br&gt;<br>
&lt;br&gt;<br>
3)&nbsp;Message&nbsp;rates&nbsp;in&nbsp;the&nbsp;management&nbsp;plugin&nbsp;might&nbsp;be&nbsp;garbled.&lt;br&gt;<br>
&lt;br&gt;<br>
4)&nbsp;Future&nbsp;changes&nbsp;to&nbsp;the&nbsp;broker&nbsp;might&nbsp;break&nbsp;this&nbsp;completely&nbsp;(for&nbsp;example,&nbsp;if&nbsp;we&nbsp;ever&nbsp;move&nbsp;to&nbsp;per-vhost&nbsp;message&nbsp;stores).&nbsp;No&nbsp;such&nbsp;changes&nbsp;are&nbsp;currently&nbsp;on&nbsp;our&nbsp;radar&nbsp;though.&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;this&nbsp;is&nbsp;very&nbsp;much&nbsp;&quot;at&nbsp;your&nbsp;own&nbsp;risk&quot;.&nbsp;Virtual&nbsp;hosts&nbsp;are&nbsp;*designed*&nbsp;to&nbsp;keep&nbsp;things&nbsp;completely&nbsp;separate,&nbsp;so&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;route&nbsp;messages&nbsp;between&nbsp;them&nbsp;then&nbsp;maybe&nbsp;your&nbsp;design&nbsp;should&nbsp;be&nbsp;rethought.&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&nbsp;Simon&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
--&nbsp;&lt;br&gt;<br>
Simon&nbsp;MacMullen&lt;br&gt;<br>
RabbitMQ,&nbsp;Pivotal&lt;br&gt;<br>
______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
