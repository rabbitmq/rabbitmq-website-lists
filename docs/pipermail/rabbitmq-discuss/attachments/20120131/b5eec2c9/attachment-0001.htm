<tt>
Hi&nbsp;Jerry,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;neglected&nbsp;to&nbsp;mentioned&nbsp;that&nbsp;I&nbsp;am&nbsp;not&nbsp;hitting&nbsp;the&nbsp;memory-based&nbsp;flow&nbsp;control&nbsp;according&nbsp;to&nbsp;my&nbsp;memory&nbsp;alarm&nbsp;stat&nbsp;from &lt;/div&gt;&lt;div&gt;rabbitmqadmin.py&nbsp;list&nbsp;nodes&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;threshold&nbsp;would&nbsp;the&nbsp;TCP&nbsp;back&nbsp;pressure&nbsp;logic&nbsp;hit?&nbsp;I&nbsp;assume&nbsp;when&nbsp;the&nbsp;memory&nbsp;limit&nbsp;is&nbsp;reached&nbsp;rabbit&nbsp;pushes&nbsp;back&nbsp;on&nbsp;the&nbsp;publishers?&nbsp;Rabbit&nbsp;did&nbsp;not&nbsp;use&nbsp;more&nbsp;then&nbsp;2G&nbsp;of&nbsp;RAM&nbsp;out&nbsp;of&nbsp;the&nbsp;5G&nbsp;allowed&nbsp;for&nbsp;it,&nbsp;if&nbsp;that&nbsp;is&nbsp;the&nbsp;case.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Also&nbsp;is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;tell&nbsp;rabbit&nbsp;drop&nbsp;the&nbsp;messages&nbsp;instead&nbsp;of&nbsp;block?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jan&nbsp;31,&nbsp;2012&nbsp;at&nbsp;12:56&nbsp;PM,&nbsp;Jerry&nbsp;Kuch&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:jerryk@vmware.com&quot;&gt;jerryk@vmware.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hi,&nbsp;Dathan...&lt;br&gt;<br>
&lt;br&gt;<br>
What&nbsp;are&nbsp;your&nbsp;consumers&nbsp;doing&nbsp;with&nbsp;the&nbsp;published&nbsp;messages?&nbsp; If&nbsp;you&nbsp;use&nbsp;rabbitmqctl&nbsp;or&lt;br&gt;<br>
the&nbsp;management&nbsp;plugin&nbsp;to&nbsp;look&nbsp;at&nbsp;what&amp;#39;s&nbsp;going&nbsp;on&nbsp;in&nbsp;your&nbsp;queues,&nbsp;do&nbsp;you&nbsp;see&nbsp;messages&lt;br&gt;<br>
accumulating&nbsp;but&nbsp;not&nbsp;being&nbsp;delivered?&nbsp; Or&nbsp;delivered&nbsp;but&nbsp;not&nbsp;ACKed?&nbsp; If&nbsp;messages&nbsp;are&lt;br&gt;<br>
building&nbsp;up&nbsp;(either&nbsp;undelivered&nbsp;or&nbsp;unACKed)&nbsp;faster&nbsp;than&nbsp;consumers&nbsp;are&nbsp;draining&nbsp;them,&lt;br&gt;<br>
you&nbsp;might&nbsp;be&nbsp;hitting&nbsp;memory-based&nbsp;flow&nbsp;control,&nbsp;which&nbsp;will&nbsp;use&nbsp;TCP&nbsp;back&nbsp;pressure&nbsp;to&lt;br&gt;<br>
stop&nbsp;the&nbsp;publishers.&lt;br&gt;<br>
&lt;br&gt;<br>
See&nbsp;here&nbsp;for&nbsp;more&nbsp;information:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/memory.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/memory.html&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
To&nbsp;get&nbsp;an&nbsp;idea&nbsp;whether&nbsp;this&nbsp;is&nbsp;happening&nbsp;to&nbsp;you,&nbsp;check&nbsp;out&nbsp;your&nbsp;queue&nbsp;contents&nbsp;as&lt;br&gt;<br>
suggested&nbsp;above,&nbsp;and&nbsp;see&nbsp;if&nbsp;memory&nbsp;alarms&nbsp;are&nbsp;being&nbsp;set&nbsp;in&nbsp;your&nbsp;rabbit&nbsp;logs.../&lt;br&gt;<br>
&lt;br&gt;<br>
Best&nbsp;regards,&lt;br&gt;<br>
Jerry&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
-----&nbsp;Original&nbsp;Message&nbsp;-----&lt;br&gt;<br>
From:&nbsp;&amp;quot;Dathan&nbsp;Pattishall&amp;quot;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:dathan@schoolfeed.com&quot;&gt;dathan@schoolfeed.com&lt;/a&gt;&amp;gt;&lt;br&gt;<br>
To:&nbsp;&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
Sent:&nbsp;Tuesday,&nbsp;January&nbsp;31,&nbsp;2012&nbsp;12:52:55&nbsp;PM&lt;br&gt;<br>
Subject:&nbsp;[rabbitmq-discuss]&nbsp;Problems&nbsp;with&nbsp;rabbit&nbsp;and&nbsp;hoping&nbsp;I&nbsp;can&nbsp;get&nbsp;some&nbsp; &nbsp; &nbsp; help&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Let&nbsp;me&nbsp;first&nbsp;describe&nbsp;my&nbsp;setup.&lt;br&gt;<br>
&lt;br&gt;<br>
root@webnode1]#&nbsp;rabbitmqadmin.py&nbsp;show&nbsp;overview&lt;br&gt;<br>
+--------------------+-----------------+--------------------+------------------+&lt;br&gt;<br>
|&nbsp;management_version&nbsp;|&nbsp;node&nbsp;|&nbsp;statistics_db_node&nbsp;|&nbsp;statistics_level&nbsp;|&lt;br&gt;<br>
+--------------------+-----------------+--------------------+------------------+&lt;br&gt;<br>
|&nbsp;2.7.1&nbsp;|&nbsp;rabbit@webnode1&nbsp;|&nbsp;rabbit@webnode1&nbsp;|&nbsp;fine&nbsp;|&lt;br&gt;<br>
+--------------------+-----------------+--------------------+------------------+&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Rabbit&nbsp;MQ&amp;#39;s&nbsp;producers&nbsp;comes&nbsp;from&nbsp;PHP&nbsp;5.3.8&nbsp;&lt;a&nbsp;href=&quot;http://www.php.net/manual/en/book.amqp.php&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.php.net/manual/en/book.amqp.php&lt;/a&gt;&nbsp;.&nbsp;Each&nbsp;apache&nbsp;process&nbsp;could&nbsp;produce&nbsp;a&nbsp;rabbit&nbsp;message,&nbsp;I&nbsp;am&nbsp;producing&nbsp;around&nbsp;1000&nbsp;messages&nbsp;a&nbsp;second&nbsp;on&nbsp;c1.xtralarge&nbsp;instance&nbsp;at&nbsp;ec2.&lt;br&gt;<br>
<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
My&nbsp;erlang&nbsp;version&nbsp;is&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
/usr/local/bin/erl&nbsp;-v&lt;br&gt;<br>
Erlang&nbsp;R15B&nbsp;(erts-5.9)&nbsp;[source]&nbsp;[64-bit]&nbsp;[smp:8:8]&nbsp;[async-threads:0]&nbsp;[hipe]&nbsp;[kernel-poll:false]&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;PROBLEM:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
After&nbsp;about&nbsp;40&nbsp;mins&nbsp;of&nbsp;rabbit&nbsp;accepting&nbsp;messages&nbsp;all&nbsp;connections&nbsp;block&nbsp;causing&nbsp;a&nbsp;rather&nbsp;bad&nbsp;error&nbsp;on&nbsp;the&nbsp;front&nbsp;ends&nbsp;killing&nbsp;traffic.&nbsp;Turning&nbsp;rabbit&nbsp;off&nbsp;and&nbsp;restarting&nbsp;the&nbsp;web&nbsp;servers&nbsp;forces&nbsp;a&nbsp;recovery.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Stats&nbsp;from&nbsp;Rabbit:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Roughly&nbsp;5000&nbsp;queues&nbsp;are&nbsp;made&lt;br&gt;<br>
Roughly&nbsp;3600&nbsp;exchanges&nbsp;are&nbsp;made&lt;br&gt;<br>
Each&nbsp;exchange&nbsp;can&nbsp;have&nbsp;at&nbsp;most&nbsp;1200&nbsp;queues&nbsp;bound&nbsp;to&nbsp;it.&lt;br&gt;<br>
Each&nbsp;Queue&nbsp;is&nbsp;setup&nbsp;for&nbsp;autodelete&nbsp;and&nbsp;so&nbsp;is&nbsp;the&nbsp;exchanges&nbsp;with&nbsp;delivery&nbsp;type&nbsp;1.&lt;br&gt;<br>
All&nbsp;data&nbsp;passed&nbsp;is&nbsp;JSON&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;consumer&nbsp;is&nbsp;NODE&nbsp;and&nbsp;its&nbsp;keeping&nbsp;up&nbsp;with&nbsp;the&nbsp;consumption&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
RabbitMQ&nbsp;memlimit&nbsp;is&nbsp;around&nbsp;5.3G&lt;br&gt;<br>
RabbitMQ&nbsp;mem&nbsp;used&nbsp;hits&nbsp;around&nbsp;1.9G&nbsp;when&nbsp;it&nbsp;freezes&nbsp;produces&lt;br&gt;<br>
RabbitMQ&nbsp;proc&nbsp;used&nbsp;hits&nbsp;around&nbsp;220K&lt;br&gt;<br>
RabbitMQ&nbsp;fd_total&nbsp;is&nbsp;50K&lt;br&gt;<br>
RabbitMQ&nbsp;socks_total&nbsp;is&nbsp;around&nbsp;45K&nbsp;and&nbsp;Socks&nbsp;used&nbsp;is&nbsp;4K&lt;br&gt;<br>
mem_ets&nbsp;hists&nbsp;100M&nbsp;//&nbsp;not&nbsp;sure&nbsp;what&nbsp;this&nbsp;is&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Any&nbsp;idea&nbsp;what&nbsp;is&nbsp;going&nbsp;on?&nbsp;What&nbsp;limit&nbsp;am&nbsp;I&nbsp;hitting?&nbsp;Why&nbsp;does&nbsp;RabbitMQ&nbsp;block?&nbsp;How&nbsp;can&nbsp;I&nbsp;detect&nbsp;that&nbsp;I&nbsp;am&nbsp;about&nbsp;to&nbsp;hit&nbsp;a&nbsp;block&nbsp;state?&nbsp;Any&nbsp;suggestions&nbsp;or&nbsp;request&nbsp;of&nbsp;additional&nbsp;data&nbsp;would&nbsp;be&nbsp;great.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
