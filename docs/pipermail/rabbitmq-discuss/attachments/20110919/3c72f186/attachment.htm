<tt>
Hello,&lt;br&gt;&lt;br&gt;I&amp;#39;ve&nbsp;recently&nbsp;been&nbsp;seeing&nbsp;some&nbsp;intermittent&nbsp;process&nbsp;crashes&nbsp;in&nbsp;the&nbsp;JSON-RPC&nbsp;channel&nbsp;plugin.&nbsp;Here&nbsp;is&nbsp;an&nbsp;example:&lt;br&gt;&lt;br&gt;=ERROR&nbsp;REPORT====&nbsp;9-Sep-2011::16:35:52&nbsp;===&lt;br&gt;**&nbsp;Generic&nbsp;server&nbsp;&amp;lt;0.13801.1107&amp;gt;&nbsp;terminating&lt;br&gt;<br>
<br>
**&nbsp;Last&nbsp;message&nbsp;in&nbsp;was&nbsp;{&amp;#39;EXIT&amp;#39;,&amp;lt;0.13799.1107&amp;gt;,&lt;br&gt;                          &nbsp;{badarg,&lt;br&gt;                              &nbsp;[{erlang,tuple_to_list,[none]},&lt;br&gt;                               &nbsp;{rabbit_jsonrpc_channel,do_send_async,3},&lt;br&gt;<br>
<br>
                               &nbsp;{rabbit_jsonrpc_channel,handle_info,2},&lt;br&gt;                               &nbsp;{gen_server,handle_msg,5},&lt;br&gt;                               &nbsp;{proc_lib,init_p_do_apply,3}]}}&lt;br&gt;**&nbsp;When&nbsp;Server&nbsp;state&nbsp;==&nbsp;{ch,running,rabbit_jsonrpc_channel,&amp;lt;0.13799.1107&amp;gt;,&lt;br&gt;<br>
<br>
                        &nbsp;&amp;lt;0.13799.1107&amp;gt;,undefined,&lt;br&gt;                        &nbsp;#Fun&amp;lt;rabbit_jsonrpc_channel.0.50269389&amp;gt;,none,&lt;br&gt;                        &nbsp;{set,0,16,16,8,80,48,&lt;br&gt;                         &nbsp;{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},&lt;br&gt;<br>
<br>
                         &nbsp;{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},&lt;br&gt;                        &nbsp;4,&lt;br&gt;                        &nbsp;{[],[]},&lt;br&gt;                        &nbsp;{[],[]},&lt;br&gt;                        &nbsp;&amp;lt;&amp;lt;&amp;quot;guest&amp;quot;&amp;gt;&amp;gt;,&amp;lt;&amp;lt;&amp;quot;/580627&amp;quot;&amp;gt;&amp;gt;,&lt;br&gt;<br>
<br>
                        &nbsp;&amp;lt;&amp;lt;&amp;quot;amq.gen-gHphjRfHaC0YWeflaEIezg==&amp;quot;&amp;gt;&amp;gt;,&lt;br&gt;                        &nbsp;{dict,1,16,16,8,80,48,&lt;br&gt;                         &nbsp;{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},&lt;br&gt;<br>
<br>
                         &nbsp;{{[],[],[],[],[],[],[],[],[],[],[],[],[],&lt;br&gt;                           &nbsp;[[&amp;lt;&amp;lt;&amp;quot;amq.ctag-5QgH+lAhBr93FnOG8Y4T6A==&amp;quot;&amp;gt;&amp;gt;|&lt;br&gt;                             &nbsp;{resource,&amp;lt;&amp;lt;&amp;quot;/580627&amp;quot;&amp;gt;&amp;gt;,queue,&lt;br&gt;<br>
<br>
                              &nbsp;&amp;lt;&amp;lt;&amp;quot;amq.gen-sV5mnds/lpCC6eza+CbMRQ==&amp;quot;&amp;gt;&amp;gt;}]],&lt;br&gt;                           &nbsp;[],[]}}},&lt;br&gt;                        &nbsp;{dict,0,16,16,8,80,48,&lt;br&gt;                         &nbsp;{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},&lt;br&gt;<br>
<br>
                         &nbsp;{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},&lt;br&gt;                        &nbsp;&amp;lt;0.13800.1107&amp;gt;,&lt;br&gt;                        &nbsp;{state,none,undefined}}&lt;br&gt;**&nbsp;Reason&nbsp;for&nbsp;termination&nbsp;==&nbsp;&lt;br&gt;**&nbsp;{badarg,[{erlang,tuple_to_list,[none]},&lt;br&gt;<br>
<br>
           &nbsp;{rabbit_jsonrpc_channel,do_send_async,3},&lt;br&gt;           &nbsp;{rabbit_jsonrpc_channel,handle_info,2},&lt;br&gt;           &nbsp;{gen_server,handle_msg,5},&lt;br&gt;           &nbsp;{proc_lib,init_p_do_apply,3}]}&lt;br&gt;&lt;br&gt;I&nbsp;looked&nbsp;through&nbsp;the&nbsp;RabbitMQ&nbsp;code,&nbsp;and&nbsp;I&nbsp;believe&nbsp;this&nbsp;is&nbsp;getting&nbsp;triggered&nbsp;when&nbsp;the&nbsp;system&nbsp;in&nbsp;question&nbsp;starts&nbsp;getting&nbsp;enough&nbsp;load&nbsp;that&nbsp;messages&nbsp;are&nbsp;queued&nbsp;up&nbsp;instead&nbsp;of&nbsp;published&nbsp;immediately&nbsp;as&nbsp;they&nbsp;come&nbsp;in.&nbsp;The&nbsp;decoded&nbsp;properties&nbsp;get&nbsp;cleared&nbsp;out&nbsp;in&nbsp;rabbit_variable_queue&nbsp;to&nbsp;avoid&nbsp;persisting&nbsp;extra&nbsp;data,&nbsp;and&nbsp;then&nbsp;later&nbsp;when&nbsp;the&nbsp;message&nbsp;is&nbsp;passed&nbsp;to&nbsp;the&nbsp;json&nbsp;plugin,&nbsp;it&nbsp;tries&nbsp;to&nbsp;call&nbsp;tuple_to_list&nbsp;on&nbsp;the&nbsp;properties&nbsp;which&nbsp;are&nbsp;now&nbsp;set&nbsp;to&nbsp;the&nbsp;atom&nbsp;&amp;#39;none&amp;#39;.&lt;br&gt;<br>
&lt;br&gt;(Incidentally,&nbsp;I&amp;#39;m&nbsp;seeing&nbsp;this&nbsp;problem&nbsp;in&nbsp;RabbitMQ&nbsp;2.1.0,&nbsp;but&nbsp;I&nbsp;checked&nbsp;out&nbsp;the&nbsp;latest&nbsp;code&nbsp;from&nbsp;hg&nbsp;and&nbsp;the&nbsp;plugin&nbsp;still&nbsp;calls&nbsp;tuple_to_list&nbsp;without&nbsp;calling&nbsp;ensure_content_decoded&nbsp;first.)&lt;br&gt;&lt;br&gt;The&nbsp;twist&nbsp;here&nbsp;is&nbsp;that&nbsp;I&amp;#39;m&nbsp;not&nbsp;sure&nbsp;if&nbsp;this&nbsp;is&nbsp;an&nbsp;error&nbsp;anyone&nbsp;would&nbsp;normally&nbsp;see,&nbsp;but&nbsp;we&nbsp;have&nbsp;written&nbsp;a&nbsp;custom&nbsp;exchange&nbsp;type&nbsp;plugin&nbsp;that&nbsp;creates&nbsp;messages,&nbsp;calls&nbsp;ensure_content_encoded&nbsp;on&nbsp;them,&nbsp;and&nbsp;then&nbsp;passes&nbsp;them&nbsp;to&nbsp;rabbit_amqqueue:deliver.&nbsp;The&nbsp;json&nbsp;plugin&nbsp;crash&nbsp;only&nbsp;seems&nbsp;to&nbsp;happen&nbsp;on&nbsp;these&nbsp;messages&nbsp;that&nbsp;are&nbsp;generated&nbsp;in&nbsp;this&nbsp;way&nbsp;(but&nbsp;like&nbsp;I&nbsp;said,&nbsp;only&nbsp;intermittently,&nbsp;and&nbsp;most&nbsp;of&nbsp;the&nbsp;time&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;seem&nbsp;to&nbsp;cause&nbsp;any&nbsp;issues).&nbsp;We&nbsp;also&nbsp;have&nbsp;other&nbsp;components&nbsp;of&nbsp;our&nbsp;system&nbsp;that&nbsp;connect&nbsp;to&nbsp;RabbitMQ&nbsp;directly&nbsp;(not&nbsp;through&nbsp;the&nbsp;json&nbsp;plugin),&nbsp;and&nbsp;there&nbsp;never&nbsp;seem&nbsp;to&nbsp;be&nbsp;any&nbsp;crashes&nbsp;associated&nbsp;with&nbsp;those&nbsp;connections,&nbsp;despite&nbsp;the&nbsp;fact&nbsp;that&nbsp;they&amp;#39;re&nbsp;dealing&nbsp;with&nbsp;the&nbsp;same&nbsp;kind&nbsp;of&nbsp;messages&nbsp;that&nbsp;do&nbsp;occasionally&nbsp;cause&nbsp;crashes&nbsp;in&nbsp;the&nbsp;json&nbsp;plugin.&lt;br&gt;<br>
&lt;br&gt;Based&nbsp;on&nbsp;my&nbsp;limited&nbsp;knowledge&nbsp;of&nbsp;the&nbsp;Rabbit&nbsp;code&nbsp;though,&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;seem&nbsp;like&nbsp;we&amp;#39;re&nbsp;doing&nbsp;anything&nbsp;wrong&nbsp;in&nbsp;our&nbsp;exchange&nbsp;type&nbsp;plugin,&nbsp;and&nbsp;it&nbsp;seems&nbsp;like&nbsp;it&nbsp;would&nbsp;make&nbsp;sense&nbsp;for&nbsp;the&nbsp;json&nbsp;plugin&nbsp;to&nbsp;call&nbsp;ensure_content_decoded&nbsp;before&nbsp;it&nbsp;assumes&nbsp;the&nbsp;content&nbsp;is&nbsp;actually&nbsp;decoded.&nbsp;Could&nbsp;this&nbsp;be&nbsp;considered&nbsp;a&nbsp;bug&nbsp;in&nbsp;the&nbsp;json&nbsp;plugin?&nbsp;If&nbsp;so,&nbsp;I&nbsp;would&nbsp;be&nbsp;happy&nbsp;to&nbsp;write&nbsp;up&nbsp;a&nbsp;patch&nbsp;and&nbsp;submit&nbsp;it&nbsp;to&nbsp;whatever&nbsp;the&nbsp;appropriate&nbsp;place&nbsp;might&nbsp;be.&lt;br&gt;<br>
&lt;br&gt;Thanks&nbsp;for&nbsp;your&nbsp;help!&lt;br&gt;Nick&nbsp;Marino&lt;br&gt;<br>

</tt>
