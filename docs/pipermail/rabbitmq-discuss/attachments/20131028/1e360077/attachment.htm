<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;More&nbsp;fun&nbsp;with&nbsp;RabbitMQ&nbsp;clustering!&lt;br&gt;&lt;br&gt;&lt;/div&gt;These&nbsp;next&nbsp;couple&nbsp;I&nbsp;wouldn&amp;#39;t&nbsp;believe&nbsp;if&nbsp;I&nbsp;couldn&amp;#39;t&nbsp;consistently&nbsp;reproduce&nbsp;them.&nbsp;Attached&nbsp;is&nbsp;a&nbsp;new&nbsp;script&nbsp;package&nbsp;which&nbsp;includes&nbsp;some&nbsp;updates&nbsp;to&nbsp;previous&nbsp;scripts,&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;go&nbsp;based&nbsp;queue&nbsp;populator.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;First,&nbsp;is&nbsp;an&nbsp;issue&nbsp;where&nbsp;if&nbsp;you&nbsp;apply&nbsp;a&nbsp;global&nbsp;policy,&nbsp;then&nbsp;populate&nbsp;a&nbsp;bunch&nbsp;of&nbsp;queues,&nbsp;after&nbsp;the&nbsp;queues&nbsp;are&nbsp;done&nbsp;populating&nbsp;rabbitmq&nbsp;removes&nbsp;about&nbsp;3/4s&nbsp;of&nbsp;them.&nbsp;It&nbsp;is&nbsp;baffling,&nbsp;I&amp;#39;ve&nbsp;attached&nbsp;screenshots,&nbsp;since&nbsp;I&nbsp;can&amp;#39;t&nbsp;really&nbsp;believe&nbsp;it&nbsp;myself.&nbsp;To&nbsp;reproduce:&lt;br&gt;<br>
&lt;br&gt;-&nbsp;./create_cluster.sh&nbsp;&amp;amp;&amp;amp;&nbsp;./setup_queues.sh&nbsp;&amp;amp;&amp;amp;&nbsp;RABBITMQ_NODENAME=&amp;quot;rabbit1@localhost&amp;quot;&nbsp;rabbitmqctl&nbsp;set_policy&nbsp;--priority&nbsp;0&nbsp;global_pol&nbsp;&amp;quot;.*&amp;quot;&nbsp;&amp;#39;{&amp;quot;ha-mode&amp;quot;:&nbsp;&amp;quot;exactly&amp;quot;,&nbsp;&amp;quot;ha-params&amp;quot;:&nbsp;3,&nbsp;&amp;quot;ha-sync-mode&amp;quot;:&nbsp;&amp;quot;automatic&amp;quot;}&amp;#39;&nbsp;&amp;amp;&amp;amp;&nbsp;sleep&nbsp;5&nbsp;&amp;amp;&amp;amp;&nbsp;./populate_queues.sh&lt;br&gt;<br>
&lt;/div&gt;-&nbsp;watch&nbsp;cluster&nbsp;admin&nbsp;queues&nbsp;page&nbsp;(&lt;a&nbsp;href=&quot;http://localhost:4441/#/queues&quot;&gt;http://localhost:4441/#/queues&lt;/a&gt;),&nbsp;see&nbsp;all&nbsp;the&nbsp;queues&nbsp;fill&nbsp;up&nbsp;with&nbsp;10000&nbsp;messages,&nbsp;and&nbsp;then&nbsp;see&nbsp;2/3rds&nbsp;of&nbsp;them&nbsp;disappear&nbsp;once&nbsp;most&nbsp;of&nbsp;the&nbsp;queues&nbsp;are&nbsp;full.&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;-&nbsp;This&nbsp;happens&nbsp;both&nbsp;in&nbsp;my&nbsp;test&nbsp;VM,&nbsp;and&nbsp;on&nbsp;a&nbsp;bare&nbsp;metal&nbsp;server&nbsp;with&nbsp;64GB&nbsp;of&nbsp;RAM&nbsp;and&nbsp;24&nbsp;cores.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;Next&nbsp;is&nbsp;an&nbsp;issue&nbsp;where&nbsp;removing&nbsp;and&nbsp;re-adding&nbsp;nodes&nbsp;breaks&nbsp;rabbitmq&nbsp;clustering.&nbsp;We&nbsp;keep&nbsp;running&nbsp;into&nbsp;this&nbsp;in&nbsp;prod&nbsp;where&nbsp;we&amp;#39;ll&nbsp;attempt&nbsp;to&nbsp;adjust&nbsp;our&nbsp;cluster&nbsp;topology,&nbsp;things&nbsp;will&nbsp;break,&nbsp;and&nbsp;we&amp;#39;ll&nbsp;have&nbsp;to&nbsp;take&nbsp;the&nbsp;whole&nbsp;cluster&nbsp;down&nbsp;and&nbsp;bring&nbsp;it&nbsp;back&nbsp;up&nbsp;again&nbsp;to&nbsp;fix&nbsp;it.&lt;br&gt;<br>
&lt;br&gt;-&nbsp;./create_cluster.sh&nbsp;&amp;amp;&amp;amp;&nbsp;./setup_queues.sh&nbsp;&amp;amp;&amp;amp;&nbsp;./populate_queues.sh&nbsp;&amp;amp;&amp;amp;&nbsp;RABBITMQ_NODENAME=&amp;quot;rabbit1@localhost&amp;quot;&nbsp;rabbitmqctl&nbsp;set_policy&nbsp;--priority&nbsp;0&nbsp;global_pol&nbsp;&amp;quot;.*&amp;quot;&nbsp;&amp;#39;{&amp;quot;ha-mode&amp;quot;:&nbsp;&amp;quot;exactly&amp;quot;,&nbsp;&amp;quot;ha-params&amp;quot;:&nbsp;3,&nbsp;&amp;quot;ha-sync-mode&amp;quot;:&nbsp;&amp;quot;automatic&amp;quot;}&amp;#39;&lt;br&gt;<br>
&lt;/div&gt;-&nbsp;watch&nbsp;cluster&nbsp;admin&nbsp;pages,&nbsp;wait&nbsp;until&nbsp;all&nbsp;messages&nbsp;are&nbsp;populated&nbsp;and&nbsp;queues&nbsp;are&nbsp;synced,&nbsp;noting&nbsp;that&nbsp;since&nbsp;we&nbsp;applied&nbsp;the&nbsp;policy&nbsp;after&nbsp;populating&nbsp;the&nbsp;queues,&nbsp;for&nbsp;some&nbsp;reason&nbsp;this&nbsp;doesn&amp;#39;t&nbsp;cause&nbsp;the&nbsp;queues&nbsp;to&nbsp;be&nbsp;removed&nbsp;like&nbsp;in&nbsp;the&nbsp;previous&nbsp;case.&lt;br&gt;<br>
&lt;/div&gt;-&nbsp;./toggle_nodes.sh&lt;br&gt;&lt;/div&gt;-&nbsp;watch&nbsp;nodes&nbsp;be&nbsp;removed&nbsp;and&nbsp;re-added,&nbsp;should&nbsp;only&nbsp;take&nbsp;~5&nbsp;of&nbsp;these&nbsp;full&nbsp;cycles&nbsp;before&nbsp;the&nbsp;script&nbsp;loop&nbsp;hangs,&nbsp;and&nbsp;doesn&amp;#39;t&nbsp;return&nbsp;from&nbsp;the&nbsp;cluster&nbsp;op&nbsp;it&amp;#39;s&nbsp;attempting&nbsp;to&nbsp;perform.&nbsp;If&nbsp;you&nbsp;ctl-C&nbsp;the&nbsp;script&nbsp;and&nbsp;run&nbsp;it&nbsp;again,&nbsp;it&nbsp;should&nbsp;just&nbsp;hang&nbsp;and&nbsp;refuse&nbsp;to&nbsp;perform&nbsp;any&nbsp;more&nbsp;cluster&nbsp;join/leave&nbsp;operations&nbsp;on&nbsp;any&nbsp;node.&lt;br&gt;<br>
&lt;/div&gt;-&nbsp;it&amp;#39;s&nbsp;also&nbsp;likely&nbsp;you&amp;#39;ll&nbsp;see&nbsp;queues&nbsp;where&nbsp;one&nbsp;of&nbsp;the&nbsp;mirrors&nbsp;isn&amp;#39;t&nbsp;correctly&nbsp;synced,&nbsp;or&nbsp;possibly&nbsp;is&nbsp;partially&nbsp;synced&nbsp;but&nbsp;stuck&nbsp;and&nbsp;not&nbsp;finishing&nbsp;syncing,&nbsp;likely&nbsp;related&nbsp;to&nbsp;previous&nbsp;policy&nbsp;bugs&nbsp;I&nbsp;reported.&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;-&nbsp;queues&nbsp;in&nbsp;these&nbsp;states&nbsp;often&nbsp;don&amp;#39;t&nbsp;accept&nbsp;new&nbsp;messages&nbsp;for&nbsp;delivery,&nbsp;stalling&nbsp;message&nbsp;processing.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;We&amp;#39;ve&nbsp;found&nbsp;that&nbsp;once&nbsp;the&nbsp;cluster&amp;#39;s&nbsp;in&nbsp;this&nbsp;state,&nbsp;it&nbsp;behaves&nbsp;really&nbsp;oddly&nbsp;and&nbsp;needs&nbsp;to&nbsp;be&nbsp;fully&nbsp;shut&nbsp;down&nbsp;(or&nbsp;&amp;quot;killall&nbsp;beam.smp&amp;quot;)&nbsp;and&nbsp;then&nbsp;brought&nbsp;back&nbsp;up&nbsp;before&nbsp;it&nbsp;behaves&nbsp;normally.&nbsp;We&nbsp;had&nbsp;an&nbsp;incident&nbsp;after&nbsp;adding&nbsp;a&nbsp;single&nbsp;node&nbsp;last&nbsp;friday&nbsp;where&nbsp;~4&nbsp;queues&nbsp;stopped&nbsp;accepting&nbsp;new&nbsp;messages&nbsp;and&nbsp;held&nbsp;up&nbsp;our&nbsp;entire&nbsp;workload&nbsp;until&nbsp;the&nbsp;entire&nbsp;cluster&nbsp;was&nbsp;shut&nbsp;down&nbsp;and&nbsp;brought&nbsp;back&nbsp;up.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;These&nbsp;errors&nbsp;are&nbsp;all&nbsp;really&nbsp;strange,&nbsp;and&nbsp;so&nbsp;I&amp;#39;m&nbsp;hoping&nbsp;you&nbsp;guys&nbsp;can&nbsp;reproduce&nbsp;them,&nbsp;and&nbsp;best&nbsp;case&nbsp;scenario,&nbsp;find&nbsp;something&nbsp;that&nbsp;accounts&nbsp;for&nbsp;these&nbsp;problems&nbsp;which&nbsp;we&nbsp;can&nbsp;then&nbsp;patch&nbsp;in&nbsp;our&nbsp;production&nbsp;environment.&lt;br&gt;<br>
&lt;/div&gt;&lt;br&gt;Thank!&lt;br&gt;Graeme&lt;br&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
