<tt>
Hi&nbsp;Matthew,&lt;br&gt;&lt;br&gt;Thanks&nbsp;for&nbsp;the&nbsp;speedy&nbsp;response. &nbsp;Answers&nbsp;below. &nbsp;And&nbsp;yes,&nbsp;this&nbsp;is&nbsp;all&nbsp;memory&nbsp;growth&nbsp;on&nbsp;the&nbsp;rabbitmq&nbsp;side,&nbsp;the&nbsp;clients&nbsp;are&nbsp;able&nbsp;to&nbsp;burn&nbsp;through&nbsp;their&nbsp;catchup&nbsp;logs&nbsp;pretty&nbsp;quickly,&nbsp;then&nbsp;coast&nbsp;along&nbsp;as&nbsp;regular&nbsp;rates,&nbsp;meanwhile&nbsp;the&nbsp;server&nbsp;is&nbsp;chewing&nbsp;on&nbsp;it&amp;#39;s&nbsp;work&nbsp;to&nbsp;catch&nbsp;up,&nbsp;sometimes&nbsp;for&nbsp;*hours*.&lt;br&gt;<br>
<br>
&lt;br&gt;1)&nbsp;How&nbsp;many&nbsp;msgs/second&nbsp;are&nbsp;being&nbsp;published&nbsp;for&nbsp;this&nbsp;issue&nbsp;to&nbsp;occur?&lt;br&gt;From&nbsp;a&nbsp;single&nbsp;producer,&nbsp;about&nbsp;900&nbsp;messages/sec&nbsp;during&nbsp;these&nbsp;burst&nbsp;catchup&nbsp;periods. &nbsp;Normal&nbsp;volumes&nbsp;then&nbsp;drop&nbsp;down&nbsp;to&nbsp;300-500&nbsp;mps&nbsp;throughout&nbsp;the&nbsp;day,&nbsp;which&nbsp;we&nbsp;can&nbsp;keep&nbsp;up&nbsp;with&nbsp;for&nbsp;the&nbsp;most&nbsp;part. &nbsp;Note&nbsp;that&nbsp;there&nbsp;are&nbsp;8-9&nbsp;such&nbsp;producers,&nbsp;distributed&nbsp;across&nbsp;2&nbsp;nodes.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
2)&nbsp;How&nbsp;big&nbsp;are&nbsp;those&nbsp;messages?&lt;br&gt;They&nbsp;vary&nbsp;in&nbsp;size,&nbsp;but&nbsp;in&nbsp;the&nbsp;neighborhood&nbsp;of&nbsp;500&nbsp;bytes&nbsp;each. &nbsp;Pretty&nbsp;small.&lt;br&gt;&lt;br&gt;<br>
3)&nbsp;Can&nbsp;you&nbsp;give&nbsp;an&nbsp;example&nbsp;of&nbsp;the&nbsp;routing&nbsp;key&nbsp;used?&lt;br&gt;We&nbsp;were&nbsp;originally&nbsp;looking&nbsp;to&nbsp;do&nbsp;&amp;lt;domain&amp;gt;.&amp;lt;eventname&amp;gt;,&nbsp;but&nbsp;really&nbsp;everything&nbsp;subscribes&nbsp;to&nbsp;&amp;quot;#.&amp;lt;eventname&amp;gt;&amp;quot;. &nbsp;It&amp;#39;s&nbsp;a&nbsp;little&nbsp;wasted&nbsp;and&nbsp;I&nbsp;think&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;at&nbsp;some&nbsp;point&nbsp;switch&nbsp;back&nbsp;to&nbsp;a&nbsp;direct&nbsp;exchange&nbsp;and&nbsp;partition&nbsp;our&nbsp;traffic&nbsp;by&nbsp;domain&nbsp;another&nbsp;way,&nbsp;since&nbsp;we&nbsp;don&amp;#39;t&nbsp;subscribe&nbsp;to&nbsp;things&nbsp;across&nbsp;all&nbsp;domains&nbsp;like&nbsp;I&nbsp;expected&nbsp;we&nbsp;might. &nbsp;There&nbsp;are&nbsp;on&nbsp;the&nbsp;order&nbsp;of&nbsp;about&nbsp;100&nbsp;eventnames&nbsp;at&nbsp;this&nbsp;point,&nbsp;of&nbsp;varying&nbsp;frequencies.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
4)&nbsp;How&nbsp;many&nbsp;queues&nbsp;do&nbsp;messages&nbsp;end&nbsp;up&nbsp;in,&nbsp;on&nbsp;average?&lt;br&gt;About&nbsp;the&nbsp;same&nbsp;number&nbsp;of&nbsp;bindings&nbsp;-&nbsp;75. &nbsp;We&nbsp;don&amp;#39;t&nbsp;do&nbsp;many&nbsp;multiple&nbsp;bindings&nbsp;per&nbsp;queue&nbsp;(if&nbsp;any).&lt;br&gt;&lt;br&gt;<br>
5)&nbsp;Are&nbsp;the&nbsp;consumers&nbsp;setting&nbsp;qos,&nbsp;and&nbsp;are&nbsp;they&nbsp;using&nbsp;subscriptions&nbsp;or&nbsp;just&nbsp;basic.get?&nbsp;What&nbsp;about&nbsp;acknowledgements?&lt;br&gt;Consumers&nbsp;are&nbsp;using&nbsp;the&nbsp;Java&nbsp;client,&nbsp;no&nbsp;qos&nbsp;settings,&nbsp;via&nbsp;subscriptions&nbsp;(via&nbsp;QueueingConsumer.nextDelivery()).&lt;br&gt;<br>
<br>
&lt;br&gt;Acknowledgements&nbsp;are&nbsp;sent&nbsp;after&nbsp;each&nbsp;message&nbsp;is&nbsp;retrieved&nbsp;via&nbsp;QueueingConsumer.getChannel().basicAck(envelope.getDeliveryTag(),&nbsp;false);&lt;br&gt;&lt;br&gt;Like&nbsp;I&nbsp;said,&nbsp;there&nbsp;is&nbsp;no&nbsp;queue&nbsp;backup,&nbsp;so&nbsp;I&nbsp;don&amp;#39;t&nbsp;think&nbsp;it&amp;#39;s&nbsp;on&nbsp;the&nbsp;consuming&nbsp;side. &nbsp;In&nbsp;fact,&nbsp;I&nbsp;can&nbsp;pull&nbsp;up&nbsp;a&nbsp;new&nbsp;client&nbsp;that&nbsp;just&nbsp;does&nbsp;a&nbsp;simple&nbsp;subscription&nbsp;and&nbsp;it&nbsp;will&nbsp;instantly&nbsp;start&nbsp;showing&nbsp;the&nbsp;current&nbsp;place&nbsp;in&nbsp;the&nbsp;routing,&nbsp;which&nbsp;could&nbsp;be&nbsp;that&nbsp;past&nbsp;hour&nbsp;of&nbsp;messages.&lt;br&gt;<br>
<br>
&lt;br&gt;Does&nbsp;that&nbsp;help? &nbsp;Thanks&nbsp;again&nbsp;for&nbsp;digging&nbsp;into&nbsp;this&nbsp;with&nbsp;me,&nbsp;this&nbsp;has&nbsp;been&nbsp;a&nbsp;growing&nbsp;problem&nbsp;for&nbsp;us&nbsp;that&nbsp;I&nbsp;need&nbsp;to&nbsp;understand&nbsp;better&nbsp;to&nbsp;help&nbsp;rearchitect&nbsp;our&nbsp;configuration.&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Brian&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
<br>
On&nbsp;Mon,&nbsp;Feb&nbsp;1,&nbsp;2010&nbsp;at&nbsp;6:42&nbsp;AM,&nbsp;Matthew&nbsp;Sackman&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthew@lshift.net&quot;&gt;matthew@lshift.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
<br>
Hi&nbsp;Brian,&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
On&nbsp;Sun,&nbsp;Jan&nbsp;31,&nbsp;2010&nbsp;at&nbsp;10:41:01PM&nbsp;-0800,&nbsp;Brian&nbsp;Sullivan&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&nbsp;I&nbsp;am&nbsp;curious&nbsp;if&nbsp;anyone&nbsp;on&nbsp;the&nbsp;rabbitmq&nbsp;team&nbsp;can&nbsp;confirm/clarify&nbsp;what&nbsp;we&nbsp;are&lt;br&gt;<br>
&amp;gt;&nbsp;seeing&nbsp;with&nbsp;respect&nbsp;to&nbsp;some&nbsp;throughput&nbsp;issues&nbsp;on&nbsp;our&nbsp;RMQ&nbsp;cluster.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;config:&lt;br&gt;<br>
&amp;gt;&nbsp;-&nbsp;2-node&nbsp;RMQ&nbsp;cluster,&nbsp;running&nbsp;a&nbsp;topic-based&nbsp;exchange&lt;br&gt;<br>
&amp;gt;&nbsp;-&nbsp;8&nbsp;publishers,&nbsp;running&nbsp;on&nbsp;different&nbsp;hosts&lt;br&gt;<br>
&amp;gt;&nbsp;-&nbsp;dozens&nbsp;of&nbsp;consumers,&nbsp;~75&nbsp;wildcard&nbsp;topic&nbsp;bindings,&nbsp;mostly&nbsp;running&nbsp;on&lt;br&gt;<br>
&amp;gt;&nbsp;different&nbsp;hosts&nbsp;(there&nbsp;are&nbsp;a&nbsp;couple&nbsp;running&nbsp;on&nbsp;the&nbsp;RMQ&nbsp;hosts&nbsp;for&nbsp;stats,&nbsp;etc)&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;issue:&lt;br&gt;<br>
&amp;gt;&nbsp;When&nbsp;we&nbsp;publish&nbsp;at&nbsp;a&nbsp;higher&nbsp;rate&nbsp;than&nbsp;normal,&nbsp;there&nbsp;appears&nbsp;to&nbsp;be&nbsp;a&lt;br&gt;<br>
&amp;gt;&nbsp;significant&nbsp;delay&nbsp;in&nbsp;the&nbsp;pipeline&nbsp;between&nbsp;when&nbsp;we&nbsp;publish&nbsp;the&nbsp;messages&nbsp;and&lt;br&gt;<br>
&amp;gt;&nbsp;when&nbsp;we&nbsp;receive&nbsp;them&nbsp;on&nbsp;the&nbsp;consuming&nbsp;side.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Although&nbsp;what&nbsp;you&nbsp;later&nbsp;say&nbsp;about&nbsp;memory&nbsp;growth&nbsp;suggests&nbsp;it&amp;#39;s&nbsp;not&nbsp;this,&lt;br&gt;<br>
it&nbsp;could&nbsp;be&nbsp;some&nbsp;sort&nbsp;of&nbsp;buffering&nbsp;or&nbsp;nagle&nbsp;algorithm&nbsp;which&nbsp;is&nbsp;causing&lt;br&gt;<br>
batching&nbsp;of&nbsp;more&nbsp;messages,&nbsp;up&nbsp;until&nbsp;some&nbsp;buffer&nbsp;is&nbsp;full,&nbsp;before&nbsp;passing&lt;br&gt;<br>
them&nbsp;onto&nbsp;the&nbsp;network.&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;you&amp;#39;re&nbsp;seeing&nbsp;memory&nbsp;growth&lt;br&gt;<br>
heavily&nbsp;in&nbsp;RabbitMQ-server&nbsp;itself,&nbsp;then&nbsp;that&nbsp;suggests&nbsp;it&amp;#39;s&nbsp;nowt&nbsp;to&nbsp;do&lt;br&gt;<br>
with&nbsp;buffering&nbsp;in&nbsp;the&nbsp;clients.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Since&nbsp;publishing&nbsp;is&lt;br&gt;<br>
&amp;gt;&nbsp;asynchronous,&nbsp;the&nbsp;publisher&nbsp;applications&nbsp;send&nbsp;as&nbsp;fast&nbsp;as&nbsp;they&nbsp;can,&nbsp;meanwhile&lt;br&gt;<br>
&amp;gt;&nbsp;we&nbsp;see&nbsp;an&nbsp;increasing&nbsp;delay&nbsp;in&nbsp;when&nbsp;we&nbsp;see&nbsp;those&nbsp;same&nbsp;messages&nbsp;come&nbsp;out&nbsp;on&lt;br&gt;<br>
&amp;gt;&nbsp;the&nbsp;other&nbsp;side.&nbsp; My&nbsp;guess&nbsp;(gathered&nbsp;from&lt;br&gt;<br>
&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/faq.html#node-per-CPU-core&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/faq.html#node-per-CPU-core&lt;/a&gt;)&nbsp;is&nbsp;that&nbsp;there&nbsp;is&nbsp;either&lt;br&gt;<br>
&amp;gt;&nbsp;a&nbsp;single&nbsp;routing&nbsp;thread&nbsp;per&nbsp;publisher&nbsp;(channel),&nbsp;or&nbsp;even&nbsp;worse&nbsp;a&nbsp;single&lt;br&gt;<br>
&amp;gt;&nbsp;routing&nbsp;bottleneck&nbsp;per&nbsp;node.&nbsp; Either&nbsp;way,&nbsp;this&nbsp;thread&nbsp;cannot&nbsp;route&nbsp;fast&lt;br&gt;<br>
&amp;gt;&nbsp;enough&nbsp;in&nbsp;a&nbsp;topic&nbsp;exchange&nbsp;(we&nbsp;have&nbsp;about&nbsp;75&nbsp;bindings,&nbsp;using&nbsp;wildcards)&nbsp;and&lt;br&gt;<br>
&amp;gt;&nbsp;there&nbsp;is&nbsp;a&nbsp;backup&nbsp;of&nbsp;messages&nbsp;to&nbsp;be&nbsp;routed.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Each&nbsp;channel&nbsp;can&nbsp;only&nbsp;route&nbsp;one&nbsp;message&nbsp;at&nbsp;a&nbsp;time.&nbsp;The&nbsp;topic&nbsp;exchanges,&lt;br&gt;<br>
with&nbsp;wildcards&nbsp;are&nbsp;inefficient,&nbsp;and&nbsp;are&nbsp;O(N)&nbsp;where&nbsp;N&nbsp;is&nbsp;the&nbsp;number&nbsp;of&lt;br&gt;<br>
bindings.&nbsp;This&nbsp;is&nbsp;sub&nbsp;optimal&nbsp;-&nbsp;there&nbsp;are&nbsp;ways&nbsp;in&nbsp;which&nbsp;we&nbsp;are&nbsp;planning&lt;br&gt;<br>
on&nbsp;fixing&nbsp;this,&nbsp;we&amp;#39;ve&nbsp;just&nbsp;not&nbsp;got&nbsp;around&nbsp;to&nbsp;implementing&nbsp;this&nbsp;yet.&lt;br&gt;<br>
However,&nbsp;if&nbsp;you&nbsp;really&nbsp;just&nbsp;have&nbsp;approx&nbsp;75&nbsp;bindings&nbsp;with&nbsp;wildcards&nbsp;in&lt;br&gt;<br>
total,&nbsp;I&amp;#39;m&nbsp;somewhat&nbsp;astonished&nbsp;this&nbsp;can&nbsp;be&nbsp;causing&nbsp;issues.&nbsp;What&nbsp;kind&nbsp;of&lt;br&gt;<br>
rates&nbsp;are&nbsp;you&nbsp;publishing&nbsp;at?&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;question:&lt;br&gt;<br>
&amp;gt;&nbsp;Can&nbsp;you&nbsp;please&nbsp;elaborate&nbsp;on&nbsp;where&nbsp;the&nbsp;routing&nbsp;backup&nbsp;could&nbsp;be&nbsp;occurring,&nbsp;and&lt;br&gt;<br>
&amp;gt;&nbsp;what&nbsp;steps&nbsp;might&nbsp;be&nbsp;best&nbsp;to&nbsp;prevent&nbsp;this&nbsp;from&nbsp;happening?&nbsp; It&nbsp;appears&nbsp;from&lt;br&gt;<br>
&amp;gt;&nbsp;the&nbsp;fact&nbsp;that&nbsp;I&nbsp;am&nbsp;waiting&nbsp;on&nbsp;the&nbsp;routing&nbsp;to&nbsp;happen&nbsp;that&nbsp;using&nbsp;flags&nbsp;like&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;quot;mandatory&amp;quot;&nbsp;on&nbsp;messages&nbsp;is&nbsp;not&nbsp;going&nbsp;to&nbsp;help&nbsp;me&nbsp;here&nbsp;(though&nbsp;I&nbsp;have&nbsp;not&lt;br&gt;<br>
&amp;gt;&nbsp;tested&nbsp;this).&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;I&nbsp;suspect&nbsp;it&amp;#39;s&nbsp;in&nbsp;the&nbsp;channel&nbsp;processes.&nbsp;I&amp;#39;m&nbsp;not&nbsp;really&nbsp;sure&nbsp;what&nbsp;you&lt;br&gt;<br>
could&nbsp;do&nbsp;to&nbsp;help,&nbsp;but&nbsp;could&nbsp;you&nbsp;provide&nbsp;some&nbsp;more&nbsp;information&nbsp;please?:&lt;br&gt;<br>
&lt;br&gt;<br>
1)&nbsp;How&nbsp;many&nbsp;msgs/second&nbsp;are&nbsp;being&nbsp;published&nbsp;for&nbsp;this&nbsp;issue&nbsp;to&nbsp;occur?&lt;br&gt;<br>
2)&nbsp;How&nbsp;big&nbsp;are&nbsp;those&nbsp;messages?&lt;br&gt;<br>
3)&nbsp;Can&nbsp;you&nbsp;give&nbsp;an&nbsp;example&nbsp;of&nbsp;the&nbsp;routing&nbsp;key&nbsp;used?&lt;br&gt;<br>
4)&nbsp;How&nbsp;many&nbsp;queues&nbsp;do&nbsp;messages&nbsp;end&nbsp;up&nbsp;in,&nbsp;on&nbsp;average?&lt;br&gt;<br>
5)&nbsp;Are&nbsp;the&nbsp;consumers&nbsp;setting&nbsp;qos,&nbsp;and&nbsp;are&nbsp;they&nbsp;using&nbsp;subscriptions&nbsp;or&lt;br&gt;<br>
just&nbsp;basic.get?&nbsp;What&nbsp;about&nbsp;acknowledgements?&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&amp;gt;&nbsp;One&nbsp;idea:&lt;br&gt;<br>
&amp;gt;&nbsp;If&nbsp;it&nbsp;is&nbsp;truly&nbsp;the&nbsp;case&nbsp;that&nbsp;a&nbsp;single&nbsp;thread&nbsp;per&nbsp;node&nbsp;might&nbsp;be&nbsp;causing&nbsp;this&lt;br&gt;<br>
&amp;gt;&nbsp;problem,&nbsp;then&nbsp;perhaps&nbsp;we&nbsp;can&nbsp;run&nbsp;a&nbsp;small&nbsp;rabbitmq&nbsp;node&nbsp;on&nbsp;each&nbsp;publisher&lt;br&gt;<br>
&amp;gt;&nbsp;(joined&nbsp;to&nbsp;the&nbsp;cluster),&nbsp;with&nbsp;the&nbsp;sole&nbsp;purpose&nbsp;of&nbsp;doing&nbsp;the&nbsp;routing&nbsp;load?&lt;br&gt;<br>
&amp;gt;&nbsp;If&nbsp;we&nbsp;publish&nbsp;locally,&nbsp;all&nbsp;it&nbsp;would&nbsp;need&nbsp;to&nbsp;do&nbsp;is&nbsp;keep&nbsp;up&nbsp;with&nbsp;it&amp;#39;s&nbsp;own&lt;br&gt;<br>
&amp;gt;&nbsp;routing&nbsp;load,&nbsp;not&nbsp;the&nbsp;combine&nbsp;routing&nbsp;load&nbsp;of&nbsp;3&nbsp;other&nbsp;publishers.&nbsp; It&lt;br&gt;<br>
&amp;gt;&nbsp;doesn&amp;#39;t&nbsp;really&nbsp;prevent&nbsp;the&nbsp;problem&nbsp;from&nbsp;happening&nbsp;though,&nbsp;if&nbsp;I&nbsp;can&nbsp;produce&lt;br&gt;<br>
&amp;gt;&nbsp;messages&nbsp;faster&nbsp;in&nbsp;a&nbsp;single&nbsp;thread&nbsp;than&nbsp;even&nbsp;a&nbsp;dedicated&nbsp;node&nbsp;can&nbsp;route.&lt;br&gt;<br>
&amp;gt;&nbsp;Would&nbsp;this&nbsp;even&nbsp;help?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Yeah,&nbsp;it&nbsp;may&nbsp;help,&nbsp;but&nbsp;without&nbsp;some&nbsp;more&nbsp;details,&nbsp;I&amp;#39;m&nbsp;not&nbsp;quite&nbsp;sure&lt;br&gt;<br>
just&nbsp;yet&nbsp;what&nbsp;to&nbsp;suggest.&lt;br&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
Matthew&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
