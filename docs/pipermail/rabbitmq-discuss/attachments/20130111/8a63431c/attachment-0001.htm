<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;<br>
&lt;div&gt;Hi&nbsp;--&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;am&nbsp;experiencing&nbsp;a&nbsp;behavior&nbsp;I&nbsp;didn't&nbsp;expect--and&nbsp;don't&nbsp;understand&nbsp;:(&nbsp;In&nbsp;the&nbsp;following&nbsp;simplified&nbsp;code:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;try:&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.out_channel.exchange_declare\&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;(&nbsp;exchange=exchange&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;,&nbsp;type=&amp;quot;topic&amp;quot;&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;,&nbsp;passive=False&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;,&nbsp;durable=True&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;,&nbsp;auto_delete=False&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;,&nbsp;nowait=True&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;)&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;msg_props&nbsp;=&nbsp;pika.BasicProperties(content_type=&amp;quot;application/json&amp;quot;,&nbsp;delivery_mode=2)&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.out_channel.basic_publish\&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;(&nbsp;body=message&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;,&nbsp;exchange=exchange&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;,&nbsp;properties=msg_props&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;,&nbsp;routing_key=routing_key&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;)&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;except&nbsp;pika.exceptions.AMQPError:&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;self.logger.exception(&amp;quot;Message&nbsp;not&nbsp;sent&amp;quot;)&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;The&amp;nbsp;exchange_declare&nbsp;above&amp;nbsp;seems&nbsp;to&nbsp;block&nbsp;indefinitely;&nbsp;out-channel&nbsp;is&nbsp;a&nbsp;channel&nbsp;obtained&nbsp;from&nbsp;a&nbsp;blocking&nbsp;connection.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;Here's&nbsp;the&nbsp;context:&amp;nbsp;node&nbsp;N1&nbsp;(which&nbsp;contains&nbsp;the&nbsp;above&nbsp;code)&nbsp;uses&amp;nbsp;&lt;/span&gt;pika.BlockingConnection&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;&amp;nbsp;to&nbsp;communicate&nbsp;with&nbsp;the&nbsp;broker,&nbsp;which&nbsp;is&nbsp;connected&nbsp;to&nbsp;two&nbsp;other&nbsp;nodes&nbsp;N2&nbsp;and&nbsp;N3.&nbsp;Upon&nbsp;receiving<br>
&nbsp;a&nbsp;message&nbsp;from&nbsp;N2&nbsp;via&nbsp;a&nbsp;fanout&nbsp;exchange,&nbsp;N1&nbsp;acknowledges&nbsp;it&nbsp;and&nbsp;then&nbsp;sends&nbsp;N2&nbsp;a&nbsp;message&nbsp;over&nbsp;a&nbsp;different,&nbsp;topic&nbsp;exchange.&nbsp;The&nbsp;interaction&nbsp;between&nbsp;N1&nbsp;and&nbsp;N3&nbsp;follows&nbsp;an&nbsp;identical&nbsp;pattern.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;I&nbsp;noticed&nbsp;that&nbsp;when&nbsp;both&nbsp;N2&nbsp;and&nbsp;N3&nbsp;send&nbsp;messages&nbsp;to&nbsp;N1,&nbsp;the&nbsp;above&nbsp;code&nbsp;works&nbsp;as&nbsp;I&nbsp;thought&nbsp;it&nbsp;would&nbsp;only&nbsp;for&nbsp;one&nbsp;of&nbsp;them&nbsp;(say&nbsp;N2),&nbsp;while&nbsp;the&nbsp;exchange_declare&nbsp;hangs&nbsp;for&nbsp;the&nbsp;other&nbsp;(N3).&nbsp;The&nbsp;code&nbsp;works&nbsp;fine&nbsp;if&nbsp;I&nbsp;comment&nbsp;out&nbsp;the<br>
&nbsp;exchange_declare&nbsp;call.&nbsp;N1&nbsp;uses&nbsp;2&nbsp;channels,&nbsp;one&nbsp;for&nbsp;incoming&nbsp;messages&nbsp;(fanout&nbsp;exchange)&nbsp;and&nbsp;one&nbsp;for&nbsp;outgoing&nbsp;messages&nbsp;(topic&nbsp;exchange).&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;I&nbsp;am&nbsp;using&nbsp;RabbitMQ&nbsp;3.0.0&nbsp;and&nbsp;pika&nbsp;0.9.8.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;Many&nbsp;(but&nbsp;not)&nbsp;all&nbsp;samples&nbsp;invoke&amp;nbsp;exchange_declare&nbsp;as&nbsp;I&nbsp;did&nbsp;above&nbsp;(as&nbsp;it&nbsp;is&nbsp;idempotent)&nbsp;so&nbsp;I&nbsp;assume&nbsp;that&nbsp;I'm&nbsp;missing&nbsp;something&nbsp;rather&nbsp;than&nbsp;making&nbsp;a&nbsp;call&nbsp;I&nbsp;should&nbsp;not&nbsp;make.&nbsp;FWIW&nbsp;the&amp;nbsp;exchange_declare&nbsp;for&nbsp;N1's&nbsp;other,&nbsp;fanout&nbsp;exchange&nbsp;never&nbsp;hangs.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Thanks,&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;-dm&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
