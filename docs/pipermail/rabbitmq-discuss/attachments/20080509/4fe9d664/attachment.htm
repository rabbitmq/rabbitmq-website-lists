<tt>
I&nbsp;wrote:&lt;br&gt;&lt;br&gt;&amp;quot;Please&nbsp;understand&nbsp;that&nbsp;all&nbsp;the&nbsp;code&nbsp;I&nbsp;have&nbsp;submitted&nbsp;(other&nbsp;than<br>
amqp_channel)&nbsp;is&nbsp;a&nbsp;pure&nbsp;hack&nbsp;to&nbsp;try&nbsp;to&nbsp;expose&nbsp;and&nbsp;duplicate&nbsp;the&nbsp;errors!&amp;quot;.&lt;br&gt;&lt;br&gt;That&nbsp;should&nbsp;have&nbsp;read,&nbsp;&amp;quot;other&nbsp;than&nbsp;rbmq_admin.erl&amp;quot;&nbsp;-&nbsp;the&nbsp;module&nbsp;that&nbsp;I&nbsp;wrote&nbsp;to&nbsp;do&nbsp;admin&nbsp;tasks,&nbsp;which&nbsp;is&nbsp;only&nbsp;a&nbsp;semi-hack&nbsp;;-)&lt;br&gt;<br>
<br>
&lt;br&gt;Ed&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;May&nbsp;9,&nbsp;2008&nbsp;at&nbsp;9:30&nbsp;AM,&nbsp;Edwin&nbsp;Fine&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss_efine@usa.net&quot;&gt;rabbitmq-discuss_efine@usa.net&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Ben,&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;In&nbsp;your&nbsp;patch,&nbsp;you&nbsp;also&nbsp;added&nbsp;an&nbsp;extra&nbsp;method&nbsp;to&nbsp;handle&nbsp;a&nbsp;spurious&nbsp;consume_ok&nbsp;message;&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;%%&nbsp;Edwin&nbsp;Fine&nbsp;bugfix:&nbsp;This&nbsp;is&nbsp;actually&nbsp;being&nbsp;called&nbsp;wrong&nbsp;from&nbsp;somewhere,&lt;/div&gt;&lt;div&gt;%%&nbsp;but&nbsp;this&nbsp;will&nbsp;fix&nbsp;it.&lt;/div&gt;&lt;div&gt;handle_method({&amp;#39;basic.consume_ok&amp;#39;,&nbsp;ConsumerTag},&nbsp;State)&nbsp;-&amp;gt;&lt;/div&gt;&lt;div&gt;<br>
<br>
<br>
&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;io:format(&amp;quot;[~p]&nbsp;Got&nbsp;bad&nbsp;handle_method&nbsp;call!~n&amp;quot;,&nbsp;[self()]),&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;handle_method(#&amp;#39;basic.consume_ok&amp;#39;{consumer_tag&nbsp;=&nbsp;ConsumerTag},&nbsp;State);&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;method&nbsp;is&nbsp;preceded&nbsp;in&nbsp;the&nbsp;code&nbsp;by&nbsp;the&nbsp;following&nbsp;function:&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;handle_method(BasicConsumeOk&nbsp;=&nbsp;#&amp;#39;basic.consume_ok&amp;#39;{consumer_tag&nbsp;=&nbsp;ConsumerTag},&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;State&nbsp;=&nbsp;#channel_state{pending_consumer&nbsp;=&nbsp;Consumer})&nbsp;-&amp;gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;Consumer&nbsp;!&nbsp;BasicConsumeOk,&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;NewState&nbsp;=&nbsp;register_consumer(ConsumerTag,&nbsp;Consumer,&nbsp;State),&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{noreply,&nbsp;NewState2}&nbsp;=&nbsp;rpc_bottom_half(BasicConsumeOk,&nbsp;NewState),&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{noreply,&nbsp;NewState2#channel_state{pending_consumer&nbsp;=&nbsp;&amp;lt;&amp;lt;&amp;gt;&amp;gt;}&nbsp;};&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;I&nbsp;not&nbsp;quite&nbsp;sure&nbsp;why&nbsp;that&nbsp;didn&amp;#39;t&nbsp;match&nbsp;first&nbsp;because&amp;nbsp;#&amp;#39;basic.consume_ok&amp;#39;{consumer_tag&nbsp;=&nbsp;ConsumerTag}&nbsp;should&nbsp;match&nbsp;against&amp;nbsp;{&amp;#39;basic.consume_ok&amp;#39;,&nbsp;ConsumerTag}&nbsp;and&amp;nbsp;#channel_state{pending_consumer&nbsp;=&nbsp;Consumer}&nbsp;should&nbsp;match&nbsp;even&nbsp;if&nbsp;the&nbsp;pending_consumer&nbsp;was&nbsp;not&nbsp;defined.&lt;/div&gt;<br>
<br>
<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;Actually,&nbsp;I&nbsp;was<br>
in&nbsp;the&nbsp;middle&nbsp;of&nbsp;trying&nbsp;to&nbsp;get&nbsp;that&nbsp;right,&nbsp;and&nbsp;it&nbsp;was&nbsp;late,&nbsp;so&nbsp;I&nbsp;would<br>
ignore&nbsp;that&nbsp;comment&nbsp;(and&nbsp;the&nbsp;code)&nbsp;completely.&nbsp;In&nbsp;fact&nbsp;I&nbsp;have&nbsp;removed<br>
it&nbsp;from&nbsp;the&nbsp;most&nbsp;recent&nbsp;code.&nbsp;I&nbsp;was&nbsp;trying&nbsp;to&nbsp;get&nbsp;rid&nbsp;of&nbsp;the&nbsp;error&nbsp;that<br>
I&nbsp;saw&nbsp;in&nbsp;the&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;amqp_channel,&nbsp;namely&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;**&nbsp;Reason&nbsp;for&nbsp;termination&nbsp;==&nbsp;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;**&nbsp;{badarg,[{amqp_channel,handle_method,2},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
<br>
<br>
<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{gen_server,handle_msg,5},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{proc_lib,init_p,5}]}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;Now&nbsp;that&nbsp;I&nbsp;am&nbsp;doing&nbsp;the&nbsp;basic.consume&nbsp;in&nbsp;the&nbsp;process&nbsp;that&nbsp;starts&nbsp;the&nbsp;consumers,&nbsp;the&nbsp;above&nbsp;issue&nbsp;does&nbsp;not&nbsp;occur.&lt;br&gt;Thanks<br>
for&nbsp;all&nbsp;your&nbsp;help.&nbsp;In&nbsp;the&nbsp;meantime,&nbsp;until&nbsp;you&nbsp;have&nbsp;a&nbsp;more&nbsp;elegant<br>
bugfix&nbsp;(to&nbsp;the&nbsp;rabbit_writer&nbsp;proliferation)&nbsp;than&nbsp;my&nbsp;hack,&nbsp;I&nbsp;will&nbsp;just<br>
continue&nbsp;to&nbsp;use&nbsp;my&nbsp;modified&nbsp;Erlang&nbsp;client.&lt;br&gt;<br>
&lt;br&gt;Ben,&nbsp;you&nbsp;also&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;&amp;gt;&amp;gt;&amp;gt;&nbsp;That&amp;#39;s&nbsp;a&nbsp;good&nbsp;point.<br>
I&nbsp;think&nbsp;the&nbsp;cleanup&nbsp;code&nbsp;should&nbsp;go&nbsp;into&nbsp;the&nbsp;gen_server&nbsp;terminate<br>
callback&nbsp;to&nbsp;keep&nbsp;it&nbsp;one&nbsp;place.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;Funny&nbsp;thing,&nbsp;that&nbsp;-&nbsp;I&nbsp;*did*&nbsp;put<br>
the&nbsp;cleanup&nbsp;code&nbsp;into&nbsp;the&nbsp;terminate,&nbsp;but&nbsp;it&nbsp;did&nbsp;not&nbsp;seem&nbsp;to&nbsp;be&nbsp;called.<br>
It&nbsp;was&nbsp;only&nbsp;when&nbsp;I&nbsp;put&nbsp;it&nbsp;directly&nbsp;before&nbsp;the&nbsp;{stop,&nbsp;xxx}&nbsp;returns&nbsp;that<br>
it&nbsp;finally&nbsp;got&nbsp;called.&nbsp;Again,&nbsp;this&nbsp;may&nbsp;have&nbsp;just&nbsp;been&nbsp;late&nbsp;night<br>
syndrome,&nbsp;but&nbsp;I&nbsp;had&nbsp;extensive&nbsp;print&nbsp;statements&nbsp;and&nbsp;could&nbsp;clearly&nbsp;see<br>
that&nbsp;it&nbsp;was&nbsp;not&nbsp;happening.&nbsp;At&nbsp;that&nbsp;time&nbsp;all&nbsp;I&nbsp;wanted&nbsp;was&nbsp;to&nbsp;get&nbsp;it&nbsp;to<br>
work.&nbsp;Please&nbsp;understand&nbsp;that&nbsp;all&nbsp;the&nbsp;code&nbsp;I&nbsp;have&nbsp;submitted&nbsp;(other&nbsp;than<br>
amqp_channel)&nbsp;is&nbsp;a&nbsp;pure&nbsp;hack&nbsp;to&nbsp;try&nbsp;to&nbsp;expose&nbsp;and&nbsp;duplicate&nbsp;the&nbsp;errors!&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;/div&gt;Thanks&nbsp;again.&lt;br&gt;Regards,&lt;br&gt;Ed&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
