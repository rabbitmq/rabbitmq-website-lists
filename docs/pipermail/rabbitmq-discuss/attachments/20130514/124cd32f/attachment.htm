<tt>
&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;Hi&nbsp;All,&lt;/font&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;Server&nbsp;version:&nbsp;3.0.4&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;.NET&nbsp;client&nbsp;version:&nbsp;3.0.4&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;&lt;font&nbsp;color=&quot;#000000&quot;&gt;I&nbsp;have&nbsp;had&nbsp;a&nbsp;problem&nbsp;on&nbsp;my&nbsp;Production&nbsp;servers&nbsp;this&nbsp;week&nbsp;where&nbsp;it&nbsp;looks&nbsp;like&nbsp;the&nbsp;call&nbsp;to&nbsp;CreateModel&nbsp;on&nbsp;IConnection&nbsp;is&nbsp;not&nbsp;thread&nbsp;safe,&nbsp;despite&nbsp;the&nbsp;documentation&nbsp;indicating&nbsp;that&nbsp;the&nbsp;entire&nbsp;IConnection&nbsp;should&nbsp;be&nbsp;thread&nbsp;safe.&nbsp;My&nbsp;application&nbsp;runs&nbsp;a&nbsp;single&nbsp;shared&nbsp;connection&nbsp;with&nbsp;somewhere&amp;nbsp;in&nbsp;the&nbsp;region&nbsp;of&nbsp;200-400&nbsp;threads&nbsp;which&nbsp;will&nbsp;be&nbsp;creating&nbsp;models&nbsp;for&nbsp;at&nbsp;least&nbsp;1&nbsp;consumer&nbsp;and&nbsp;many&nbsp;publishers&nbsp;per&nbsp;thread.&nbsp;It&nbsp;looks&nbsp;like&nbsp;we&nbsp;had&nbsp;a&nbsp;small&nbsp;network&amp;nbsp;hiccup&amp;nbsp;and&nbsp;the&nbsp;connection&nbsp;reset,&nbsp;prompting&nbsp;all&nbsp;of&nbsp;the&nbsp;publishers/consumers&nbsp;to&nbsp;request&nbsp;new&nbsp;models&nbsp;at&nbsp;the&nbsp;same&nbsp;time.&nbsp;There&nbsp;is&nbsp;a&nbsp;very&nbsp;high&nbsp;chance&nbsp;that&nbsp;there&nbsp;will&nbsp;be&nbsp;threading&nbsp;clashes&nbsp;in&nbsp;this&nbsp;circumstance.&nbsp;The&nbsp;symptom&nbsp;after&nbsp;a&nbsp;threading&nbsp;clash&nbsp;is&nbsp;that&nbsp;all&nbsp;current&nbsp;requests&nbsp;for&nbsp;Connection.CreateModel()&nbsp;will&nbsp;throw&nbsp;an&nbsp;exception&nbsp;with&nbsp;the&nbsp;following&nbsp;error:&lt;/font&gt;&lt;br&nbsp;style=&quot;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;&lt;br&nbsp;style=&quot;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;RabbitMQ.Client.Exceptions.OperationInterruptedException:&nbsp;The&nbsp;AMQP&nbsp;operation&nbsp;was&nbsp;interrupted:&nbsp;AMQP&nbsp;close-reason,&nbsp;initiated&nbsp;by&nbsp;Peer,&nbsp;code=503,&nbsp;text=&quot;COMMAND_INVALID&nbsp;-&nbsp;second&nbsp;'channel.open'&nbsp;seen&quot;,&nbsp;classId=20,&nbsp;methodId=10,&nbsp;cause=&lt;/span&gt;&lt;br&nbsp;style=&quot;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;&lt;br&nbsp;style=&quot;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;And&nbsp;any&nbsp;subsequent&nbsp;requests&nbsp;to&nbsp;IConnection.CreateModel()&nbsp;on&nbsp;that&nbsp;connection&nbsp;instance&nbsp;indefinitely&nbsp;hang.&amp;nbsp;&lt;/span&gt;&lt;font&nbsp;color=&quot;#000000&quot;&gt;I&nbsp;have&nbsp;managed&nbsp;to&nbsp;resolve&nbsp;this&nbsp;for&nbsp;now&nbsp;by&nbsp;adding&nbsp;locking&nbsp;around&nbsp;channel&nbsp;creation.&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#000000&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#000000&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;I&nbsp;have&nbsp;attached&nbsp;an&nbsp;NUnit&nbsp;test&nbsp;file&nbsp;which&nbsp;recreates&nbsp;this&nbsp;problem.&nbsp;The&nbsp;test&nbsp;case&nbsp;that&nbsp;uses&nbsp;locking&nbsp;will&nbsp;pass&nbsp;and&nbsp;the&nbsp;test&nbsp;without&nbsp;locking&nbsp;will&nbsp;indefinitely&nbsp;hang&nbsp;after&nbsp;it&nbsp;tries&nbsp;to&nbsp;create&nbsp;a&nbsp;channel&nbsp;on&nbsp;line&nbsp;62&nbsp;(at&nbsp;which&nbsp;point&nbsp;all&nbsp;of&nbsp;the&nbsp;threads&nbsp;are&nbsp;now&nbsp;hanging&nbsp;requesting&nbsp;a&nbsp;model).&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#000000&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#000000&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;Has&nbsp;anyone&nbsp;seen&nbsp;any&nbsp;problems&nbsp;like&nbsp;this&nbsp;before?&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#000000&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#000000&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;Cheers,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#000000&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&nbsp;size=&quot;2&quot;&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;Chris&lt;/font&gt;&lt;/div&gt;
</tt>
