<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;&lt;div&gt;Code&nbsp;below&nbsp;uses&nbsp;tmm1-amqp&nbsp;instead&nbsp;of&nbsp;Bunny.&nbsp;I&nbsp;get&nbsp;2000mps&nbsp;using&nbsp;this&nbsp;code,&nbsp;draining&nbsp;from&nbsp;the&nbsp;same&nbsp;queue.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;test_pop_async.rb&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;---&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;require&nbsp;&quot;rubygems&quot;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;require&nbsp;'mq'&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;Signal.trap('INT')&nbsp;{&nbsp;AMQP.stop{&nbsp;EM.stop&nbsp;}&nbsp;}&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;Signal.trap('TERM'){&nbsp;AMQP.stop{&nbsp;EM.stop&nbsp;}&nbsp;}&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;count&nbsp;||=&nbsp;0&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;prev_time&nbsp;||=&nbsp;Time.now&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;AMQP.start(:host&nbsp;=&amp;gt;&nbsp;'localhost')&nbsp;do&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-style:&nbsp;italic;&nbsp;&quot;&gt;&amp;nbsp;&amp;nbsp;MQ.queue('process_telemetry').subscribe(:ack&nbsp;=&amp;gt;&nbsp;false)&nbsp;do&nbsp;|headers,&nbsp;body|&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-style:&nbsp;italic;&nbsp;&quot;&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;count&nbsp;+=&nbsp;1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;if&nbsp;count&nbsp;&amp;gt;&nbsp;100&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;t&nbsp;=&nbsp;Time.now&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;puts(&quot;msgs&nbsp;pops&nbsp;per&nbsp;sec:&nbsp;#{count&nbsp;/&nbsp;(t&nbsp;-&nbsp;prev_time)}&quot;)&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;prev_time&nbsp;=&nbsp;t&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;count&nbsp;=&nbsp;0&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;end&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-style:&nbsp;italic;&nbsp;&quot;&gt;&amp;nbsp;&amp;nbsp;end&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-style:&nbsp;italic;&nbsp;&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;8/09/2009,&nbsp;at&nbsp;1:53&nbsp;PM,&nbsp;Chuck&nbsp;Remes&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;Progress!&nbsp;Please&nbsp;share&nbsp;the&nbsp;code&nbsp;you&nbsp;are&nbsp;using&nbsp;now&nbsp;so&nbsp;we&nbsp;can&nbsp;compare&nbsp;it&nbsp;to&nbsp;the&nbsp;bunny&nbsp;code.&nbsp;Perhaps&nbsp;something&nbsp;obvious&nbsp;will&nbsp;jump&nbsp;out&nbsp;at&nbsp;us&nbsp;(punny!).&lt;br&gt;&lt;br&gt;cr&lt;br&gt;&lt;br&gt;On&nbsp;Sep&nbsp;7,&nbsp;2009,&nbsp;at&nbsp;8:48&nbsp;PM,&nbsp;Aisha&nbsp;Fenton&nbsp;wrote:&lt;br&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Hi&nbsp;Paolo,&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;the&nbsp;code&nbsp;provided&nbsp;for&nbsp;the&nbsp;publisher&nbsp;actually&nbsp;does&nbsp;seem&nbsp;likely&nbsp;to&lt;br&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;produce&nbsp;the&nbsp;channel&nbsp;leak&lt;br&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I&nbsp;made&nbsp;the&nbsp;suggested&nbsp;change,&nbsp;and&nbsp;it&nbsp;made&nbsp;no&nbsp;difference.&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I&nbsp;have&nbsp;changed&nbsp;the&nbsp;test&nbsp;code&nbsp;to&nbsp;use&nbsp;tmm1-amqp&nbsp;(another&nbsp;Ruby&nbsp;AMQP&nbsp;library)&nbsp;and&nbsp;I'm&nbsp;now&nbsp;getting&nbsp;2000mps,&nbsp;and&nbsp;no&nbsp;degradation&nbsp;on&nbsp;deep&nbsp;queues.&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;So,&nbsp;for&nbsp;me&nbsp;at&nbsp;least,&nbsp;problem&nbsp;solved!&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Chris&nbsp;(author&nbsp;of&nbsp;Bunny&nbsp;I&nbsp;believe?),&nbsp;maybe&nbsp;you&nbsp;can&nbsp;shed&nbsp;some&nbsp;light&nbsp;on&nbsp;something&nbsp;I'm&nbsp;doing&nbsp;wrong&nbsp;with&nbsp;how&nbsp;I'm&nbsp;using&nbsp;Bunny?&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Ash&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
