<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;&lt;div&gt;Code&nbsp;below.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Chuck,&nbsp;I&nbsp;think&nbsp;you're&nbsp;onto&nbsp;something.&nbsp;Something&nbsp;that&nbsp;I&nbsp;noticed&nbsp;while&nbsp;putting&nbsp;together&nbsp;the&nbsp;test&nbsp;code&nbsp;is&nbsp;that&nbsp;it&nbsp;goes&nbsp;300mps&nbsp;the&nbsp;first&nbsp;time&nbsp;I&nbsp;run&nbsp;it.&nbsp;Any&nbsp;subsequent&nbsp;runs&nbsp;drop&nbsp;to&nbsp;80mps.&nbsp;Only&nbsp;a&nbsp;rabbitmq&nbsp;restart&nbsp;gets&nbsp;it&nbsp;back&nbsp;to&nbsp;300mps,&nbsp;and&nbsp;then&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;run.&nbsp;Hmmm&nbsp;sounds&nbsp;like&nbsp;a&nbsp;connection&nbsp;leak...&nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can't&nbsp;see&nbsp;anywhere&nbsp;in&nbsp;the&nbsp;code&nbsp;where&nbsp;I'm&nbsp;leaking&nbsp;connections&nbsp;(?)&nbsp;but&nbsp;maybe&nbsp;Bunny&nbsp;(the&nbsp;AMQP&nbsp;Ruby&nbsp;adapter&nbsp;I'm&nbsp;using)&nbsp;is?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;----&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-style:&nbsp;italic;&nbsp;&quot;&gt;require&nbsp;&quot;rubygems&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;require&nbsp;&quot;bunny&quot;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;@msg_server&nbsp;=&nbsp;Bunny.new(:spec&nbsp;=&amp;gt;&nbsp;'08')&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;@msg_server.start&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;def&nbsp;start&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;count&nbsp;||=&nbsp;0&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;prev_time&nbsp;||=&nbsp;Time.now&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;queue&nbsp;=&nbsp;@msg_server.queue(&quot;process_telemetry&quot;)&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;main&nbsp;loop&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;loop&nbsp;do&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;result&nbsp;=&nbsp;queue.pop&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;next&nbsp;if&nbsp;result&nbsp;==&nbsp;:queue_empty&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;count&nbsp;+=&nbsp;1&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;if&nbsp;count&nbsp;&amp;gt;&nbsp;100&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;t&nbsp;=&nbsp;Time.now&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;puts(&quot;msgs&nbsp;pops&nbsp;per&nbsp;sec:&nbsp;#{count&nbsp;/&nbsp;(t&nbsp;-&nbsp;prev_time)}&quot;)&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;prev_time&nbsp;=&nbsp;t&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;count&nbsp;=&nbsp;0&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;end&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;end&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;end&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;begin&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;start()&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;ensure&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;puts&nbsp;&quot;stopping&quot;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&amp;nbsp;&amp;nbsp;@msg_server.stop&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;end&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;8/09/2009,&nbsp;at&nbsp;3:23&nbsp;AM,&nbsp;Chuck&nbsp;Remes&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;&lt;br&gt;On&nbsp;Sep&nbsp;7,&nbsp;2009,&nbsp;at&nbsp;1:07&nbsp;AM,&nbsp;aisha&nbsp;fenton&nbsp;wrote:&lt;br&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Hi,&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I'm&nbsp;sure&nbsp;I'm&nbsp;doing&nbsp;something&nbsp;wrong&nbsp;since&nbsp;I&nbsp;can't&nbsp;find&nbsp;reference&nbsp;to&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;this&nbsp;anywhere&nbsp;else.&nbsp;What&nbsp;I'm&nbsp;seeing&nbsp;is&nbsp;that&nbsp;the&nbsp;performance&nbsp;of&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;draining&nbsp;a&nbsp;queue&nbsp;gets&nbsp;slower&nbsp;as&nbsp;the&nbsp;queue&nbsp;size&nbsp;increases.&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I'm&nbsp;aware&nbsp;of&nbsp;the&nbsp;issue&nbsp;in&nbsp;RabbitMQ&nbsp;1.6&nbsp;that&nbsp;means&nbsp;that&nbsp;when&nbsp;it&nbsp;runs&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;out&nbsp;of&nbsp;physical&nbsp;memory&nbsp;that&nbsp;it's&nbsp;performance&nbsp;degrades&nbsp;because&nbsp;it&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;starts&nbsp;swapping&nbsp;out.&nbsp;But&nbsp;I'm&nbsp;not&nbsp;anywhere&nbsp;close&nbsp;to&nbsp;running&nbsp;out&nbsp;of&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;memory&nbsp;yet,&nbsp;and&nbsp;the&nbsp;degradation&nbsp;starts&nbsp;almost&nbsp;immediately&nbsp;and&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;increases&nbsp;linearly&nbsp;as&nbsp;the&nbsp;queue&nbsp;depth&nbsp;grows.&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I&nbsp;am&nbsp;publishing&nbsp;500mps&nbsp;to&nbsp;an&nbsp;exchange.&nbsp;Each&nbsp;message&nbsp;is&nbsp;about&nbsp;1KB.&nbsp;I&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;have&nbsp;a&nbsp;single&nbsp;fanout&nbsp;queue&nbsp;bound&nbsp;to&nbsp;the&nbsp;exchange.&nbsp;A&nbsp;single&nbsp;consumer&nbsp;is&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;popping&nbsp;messages&nbsp;off&nbsp;the&nbsp;queue.&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;When&nbsp;the&nbsp;queue&nbsp;is&nbsp;less&nbsp;than&nbsp;20,000&nbsp;messages&nbsp;I&nbsp;can&nbsp;pop&nbsp;300mps&nbsp;off&nbsp;the&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;queue.&nbsp;When&nbsp;the&nbsp;queue&nbsp;is&nbsp;200,000&nbsp;messages&nbsp;the&nbsp;performance&nbsp;drop&nbsp;to&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;40-80mps.&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I'm&nbsp;running&nbsp;RabbitMQ&nbsp;1.6.0.&nbsp;And&nbsp;nether&nbsp;rabbitmq,&nbsp;the&nbsp;consumer,&nbsp;or&nbsp;the&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;publisher&nbsp;are&nbsp;using&nbsp;more&nbsp;than&nbsp;40%&nbsp;CPU.&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I&nbsp;assume&nbsp;I&nbsp;shouldn't&nbsp;be&nbsp;seeing&nbsp;this?&nbsp;Any&nbsp;help&nbsp;much&nbsp;appreciated.&lt;br&gt;&lt;/blockquote&gt;&lt;br&gt;You&nbsp;didn't&nbsp;include&nbsp;any&nbsp;code,&nbsp;but&nbsp;I'm&nbsp;going&nbsp;to&nbsp;take&nbsp;a&nbsp;stab&nbsp;in&nbsp;the&nbsp;dark&nbsp;anyway.&nbsp;If&nbsp;you&nbsp;are&nbsp;using&nbsp;the&nbsp;ruby&nbsp;amqp&nbsp;gem&nbsp;you&nbsp;might&nbsp;be&nbsp;doing&nbsp;something&nbsp;like&nbsp;this:&lt;br&gt;&lt;br&gt;def&nbsp;next_message&lt;br&gt;&nbsp;&amp;nbsp;exchange&nbsp;=&nbsp;MQ.fanout&nbsp;'foo'&lt;br&gt;&nbsp;&amp;nbsp;queue&nbsp;=&nbsp;MQ.queue&nbsp;'bar'&lt;br&gt;&lt;br&gt;&nbsp;&amp;nbsp;queue.bind&nbsp;exchange&lt;br&gt;&lt;br&gt;&nbsp;&amp;nbsp;newest_message&nbsp;=&nbsp;queue.pop&lt;br&gt;end&lt;br&gt;&lt;br&gt;In&nbsp;the&nbsp;code&nbsp;above&nbsp;the&nbsp;call&nbsp;to&nbsp;MQ.&amp;lt;whatever&amp;gt;&nbsp;is&nbsp;opening&nbsp;a&nbsp;new&nbsp;channel&nbsp;to&nbsp;rabbitmq&nbsp;each&nbsp;time&nbsp;the&nbsp;method&nbsp;is&nbsp;called.&nbsp;You&nbsp;are&nbsp;essentially&nbsp;leaking&nbsp;channels&nbsp;all&nbsp;over&nbsp;the&nbsp;place&nbsp;every&nbsp;time&nbsp;you&nbsp;try&nbsp;to&nbsp;pop&nbsp;a&nbsp;new&nbsp;message.&lt;br&gt;&lt;br&gt;If&nbsp;you&nbsp;aren't&nbsp;using&nbsp;the&nbsp;ruby&nbsp;amqp&nbsp;stuff,&nbsp;I&nbsp;still&nbsp;recommend&nbsp;checking&nbsp;your&nbsp;code&nbsp;for&nbsp;whatever&nbsp;library&nbsp;you&nbsp;chose.&nbsp;You&nbsp;only&nbsp;need&nbsp;to&nbsp;allocate&nbsp;a&nbsp;few&nbsp;channels&nbsp;and&nbsp;reuse&nbsp;them.&lt;br&gt;&lt;br&gt;cr&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
