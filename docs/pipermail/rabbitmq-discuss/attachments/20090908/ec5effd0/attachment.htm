<tt>
&lt;div&gt;Hi&nbsp;Aisha,&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;Hope&nbsp;you&nbsp;don&amp;#39;t&nbsp;mind&nbsp;me&nbsp;butting&nbsp;in&nbsp;here.&lt;br&gt;&lt;br&gt;2009/9/7&nbsp;Aisha&nbsp;Fenton&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:aisha.fenton@gmail.com&quot;&gt;aisha.fenton@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;PADDING-LEFT:&nbsp;1ex;&nbsp;MARGIN:&nbsp;0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;&nbsp;BORDER-LEFT:&nbsp;#ccc&nbsp;1px&nbsp;solid&quot;&gt;<br>
&lt;div&nbsp;style=&quot;WORD-WRAP:&nbsp;break-word&quot;&gt;<br>
&lt;div&gt;Hi&nbsp;Chunk.&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;don&amp;#39;t&nbsp;know&nbsp;Suhail.&nbsp;And&nbsp;his&nbsp;problem&nbsp;may&nbsp;be&nbsp;different&nbsp;from&nbsp;mine.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;To&nbsp;isolate&nbsp;the&nbsp;problem,&nbsp;I&amp;#39;ve&nbsp;reduce&nbsp;what&nbsp;I&amp;#39;m&nbsp;doing&nbsp;down&nbsp;to&nbsp;the&nbsp;attached&nbsp;code&nbsp;files.&nbsp;One&nbsp;pushes&nbsp;messages,&nbsp;the&nbsp;other&nbsp;pops&nbsp;them.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;see&nbsp;the&nbsp;problem&nbsp;even&nbsp;when&nbsp;only&nbsp;test_push.rb&nbsp;is&nbsp;running&nbsp;(as&nbsp;long&nbsp;as&nbsp;the&nbsp;queue&nbsp;is&nbsp;sufficiently&nbsp;pre-populated).&nbsp;Nothing&nbsp;else&nbsp;is&nbsp;using&nbsp;rabbitmq&nbsp;when&nbsp;I&amp;#39;m&nbsp;doing&nbsp;the&nbsp;test.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;I&amp;#39;m&nbsp;getting&nbsp;the&nbsp;same&nbsp;problem&nbsp;on&nbsp;several&nbsp;different&nbsp;machines&nbsp;here&nbsp;--&nbsp;my&nbsp;local&nbsp;MacOSX&nbsp;box&nbsp;and&nbsp;a&nbsp;server&nbsp;class&nbsp;Debian&nbsp;box. &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;div&nbsp;style=&quot;WORD-WRAP:&nbsp;break-word&quot;&gt;<br>
&lt;div&gt;exchange&nbsp;-&nbsp;durable&nbsp;or&nbsp;not?&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;<br>
&lt;div&gt;not&nbsp;durable&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;div&nbsp;style=&quot;WORD-WRAP:&nbsp;break-word&quot;&gt;<br>
&lt;div&gt;exchange&nbsp;-&nbsp;type?&nbsp;(Looks&nbsp;like&nbsp;&amp;quot;fanout&amp;quot;&nbsp;from&nbsp;the&nbsp;original&nbsp;post)&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;div&gt;fanout&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;div&nbsp;style=&quot;WORD-WRAP:&nbsp;break-word&quot;&gt;<br>
&lt;div&gt;number&nbsp;of&nbsp;bindings&nbsp;per&nbsp;exchange&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;div&gt;1&lt;/div&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;div&nbsp;style=&quot;WORD-WRAP:&nbsp;break-word&quot;&gt;<br>
&lt;div&gt;queue&nbsp; -&nbsp;durable?&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;<br>
&lt;div&gt;not&nbsp;durable&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;div&nbsp;style=&quot;WORD-WRAP:&nbsp;break-word&quot;&gt;<br>
&lt;div&gt;publishing&nbsp;settings&nbsp;-&nbsp;require&nbsp;ack?&nbsp;persistent?&nbsp;immediate?&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;div&gt;no&nbsp;ack,&nbsp;non&nbsp;persistent,&nbsp;and&nbsp;non&nbsp;immediate.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;div&nbsp;style=&quot;WORD-WRAP:&nbsp;break-word&quot;&gt;<br>
&lt;div&gt;message&nbsp;size?&nbsp;1K&nbsp;according&nbsp;to&nbsp;the&nbsp;original&nbsp;post&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;div&gt;&amp;lt;&nbsp;1K&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;b&gt;test_push.rb &lt;/b&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;b&gt;---&lt;/b&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;&lt;i&gt;require&nbsp;&amp;quot;rubygems&amp;quot;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;require&nbsp;&amp;quot;bunny&amp;quot;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;EXCHANGE&nbsp;=&nbsp;&amp;quot;raw_telemetry&amp;quot;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;QUEUE&nbsp;=&nbsp;&amp;quot;process_telemetry&amp;quot;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;count&nbsp;||=&nbsp;0&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;prev_time&nbsp;||=&nbsp;Time.now&lt;/i&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;div&gt;&lt;i&gt;msg_server&nbsp;=&nbsp;Bunny.new(:spec&nbsp;=&amp;gt;&nbsp;&amp;#39;08&amp;#39;)&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;msg_server.start&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;msg_server.exchange(EXCHANGE,&nbsp;:type&nbsp; =&amp;gt;&nbsp;:fanout)&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;msg_server.queue(QUEUE).bind(EXCHANGE)&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;loop&nbsp;do&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;  msg_server.exchange(EXCHANGE).publish(&amp;quot;This&nbsp;is&nbsp;my&nbsp;msg&amp;quot;)&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;div&gt;&lt;i&gt;  &lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;  count&nbsp;+=&nbsp;1&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;  if&nbsp;count&nbsp;&amp;gt;&nbsp;100&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;  &nbsp; t&nbsp;=&nbsp;Time.now&lt;/i&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;  &nbsp; puts(&amp;quot;msgs&nbsp;pushes&nbsp;per&nbsp;sec:&nbsp;#{count&nbsp;/&nbsp;(t&nbsp;-&nbsp;prev_time)}&amp;quot;)&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;div&gt;&lt;i&gt;  &nbsp; prev_time&nbsp;=&nbsp;t&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;  &nbsp; count&nbsp;=&nbsp;0&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;  end&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;  &nbsp; &lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;end&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;&lt;span&nbsp;style=&quot;FONT-STYLE:&nbsp;normal&quot;&gt;<br>
&lt;div&gt;&lt;b&gt;test_pop.rb &lt;/b&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;b&gt;---&lt;/b&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;&lt;span&nbsp;style=&quot;FONT-STYLE:&nbsp;normal&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/i&gt;&lt;/div&gt;&lt;/span&gt;&lt;/i&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;i&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;div&gt;require&nbsp;&amp;quot;rubygems&amp;quot;&lt;/div&gt;<br>
&lt;div&gt;require&nbsp;&amp;quot;bunny&amp;quot;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;@msg_server&nbsp;=&nbsp;Bunny.new(:spec&nbsp;=&amp;gt;&nbsp;&amp;#39;08&amp;#39;)&lt;/div&gt;<br>
&lt;div&gt;@msg_server.start&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;def&nbsp;start&lt;/div&gt;<br>
&lt;div&gt;  count&nbsp;||=&nbsp;0&lt;/div&gt;<br>
&lt;div&gt;  prev_time&nbsp;||=&nbsp;Time.now&lt;/div&gt;<br>
&lt;div&gt;  queue&nbsp;=&nbsp;@msg_server.queue(&amp;quot;process_telemetry&amp;quot;)&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;div&gt;  loop&nbsp;do&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; result&nbsp;=&nbsp;queue.pop&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; next&nbsp;if&nbsp;result&nbsp;==&nbsp;:queue_empty&lt;/div&gt;<br>
&lt;div&gt;  &lt;/div&gt;<br>
&lt;div&gt;  &nbsp; count&nbsp;+=&nbsp;1&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; if&nbsp;count&nbsp;&amp;gt;&nbsp;100&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; t&nbsp;=&nbsp;Time.now&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; puts(&amp;quot;msgs&nbsp;pops&nbsp;per&nbsp;sec:&nbsp;#{count&nbsp;/&nbsp;(t&nbsp;-&nbsp;prev_time)}&amp;quot;)&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; prev_time&nbsp;=&nbsp;t&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; count&nbsp;=&nbsp;0&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; end&nbsp; &nbsp; &lt;/div&gt;<br>
&lt;div&gt;  end&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;end&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;begin&lt;/div&gt;<br>
&lt;div&gt;  start()&lt;/div&gt;<br>
&lt;div&gt;ensure&lt;/div&gt;<br>
&lt;div&gt;  puts&nbsp;&amp;quot;stopping&amp;quot;&lt;/div&gt;<br>
&lt;div&gt;  @msg_server.stop&lt;/div&gt;<br>
&lt;div&gt;end&lt;/div&gt;<br>
&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/i&gt; &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;I&nbsp;have&nbsp;some&nbsp;observations&nbsp;-&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;1.&nbsp;In&nbsp;your&nbsp;test_push.rb&nbsp;you&nbsp;have&nbsp;the&nbsp;line&nbsp;-&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;msg_server.exchange(EXCHANGE).publish(&amp;quot;This&nbsp;is&nbsp;my&nbsp;msg&amp;quot;)&lt;/em&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;&lt;/em&gt; &lt;/div&gt;<br>
&lt;div&gt;The&nbsp;exchange&nbsp;method&nbsp;declares&nbsp;an&nbsp;exchange,&nbsp;so&nbsp;you&nbsp;are&nbsp;doing&nbsp;this&nbsp;every&nbsp;time&nbsp;you&nbsp;publish&nbsp;a&nbsp;message&nbsp;which&nbsp;will&nbsp;slow&nbsp;things&nbsp;down.&nbsp;Declare&nbsp;the&nbsp;exchange&nbsp;using&nbsp;a&nbsp;variable&nbsp;outside&nbsp;the&nbsp;loop&nbsp;like&nbsp;this&nbsp;-&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;my_exchange&nbsp;=&nbsp;msg_server.exchange(EXCHANGE,&nbsp;:type&nbsp; =&amp;gt;&nbsp;:fanout)&lt;/em&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;&lt;/em&gt; &lt;/div&gt;<br>
&lt;div&gt;Then&nbsp;use&nbsp;the&nbsp;variable&nbsp;inside&nbsp;the&nbsp;loop&nbsp;-&lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;&lt;/em&gt; &lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;my_exchange.publish(&amp;quot;This&nbsp;is&nbsp;my&nbsp;msg&amp;quot;)&lt;/em&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;&lt;/em&gt; &lt;/div&gt;<br>
&lt;div&gt;I&nbsp;think&nbsp;Paolo&nbsp;has&nbsp;highlighted&nbsp;the&nbsp;same&nbsp;thing.&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;2.&nbsp;In&nbsp;your&nbsp;test_pop.rb&nbsp;you&nbsp;don&amp;#39;t&nbsp;need&nbsp;to&nbsp;specify&nbsp;&lt;em&gt;:spec&nbsp;=&amp;gt;&nbsp;&amp;#39;08&amp;#39;.&lt;/em&gt;&nbsp;Bunny.new&nbsp;defaults&nbsp;to&nbsp;the&nbsp;AMQP&nbsp;0-8&nbsp;spec&nbsp;version.&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;Also,&nbsp;do&nbsp;you&nbsp;mean&nbsp;to&nbsp;have&nbsp;-&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;next&nbsp;if&nbsp;result&nbsp;==&nbsp;:queue_empty&lt;/em&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;em&gt;&lt;/em&gt; &lt;/div&gt;<br>
&lt;div&gt;How&nbsp;are&nbsp;you&nbsp;breaking&nbsp;out&nbsp;of&nbsp;the&nbsp;loop?&nbsp;Might&nbsp;you&nbsp;want&nbsp;to&nbsp;use&nbsp;&amp;#39;break&amp;#39;&nbsp;instead&nbsp;of&nbsp;&amp;#39;next&amp;#39;?&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;<br>
&lt;div&gt;3.&nbsp;A&nbsp;Bunny&nbsp;instance only&nbsp;ever&nbsp;uses&nbsp;2&nbsp;channels&nbsp;unless&nbsp;you&nbsp;explicitly&nbsp;create&nbsp;more.&nbsp;Since&nbsp;you&nbsp;don&amp;#39;t&nbsp;seem&nbsp;to&nbsp;be&nbsp;creating&nbsp;more&nbsp;channels&nbsp;I&nbsp;don&amp;#39;t&nbsp;think&nbsp;that&amp;#39;s&nbsp;where&nbsp;your&nbsp;issue&nbsp;lies. &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;--&nbsp;&lt;br&gt;Regards&lt;br&gt;&lt;br&gt;Chris&lt;br&gt;&lt;/div&gt;<br>

</tt>
