<tt>
Hi&nbsp;Iain,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Acks&nbsp;are&nbsp;indeed&nbsp;asynchronous.&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Jan&nbsp;19,&nbsp;2012&nbsp;at&nbsp;1:59&nbsp;AM,&nbsp;Iain&nbsp;Hull&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:iain.hull@workday.com&quot;&gt;iain.hull@workday.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;lang=&quot;EN-US&quot;&nbsp;link=&quot;blue&quot;&nbsp;vlink=&quot;purple&quot;&gt;&lt;div&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;Hi,&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;<br>
&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;We&nbsp;are&nbsp;using&nbsp;RabbitMQ&nbsp;2.5.1&nbsp;with&nbsp;the&nbsp;java&nbsp;client. &nbsp;Our&nbsp;application&nbsp;requires&nbsp;at&nbsp;quite&nbsp;reliable&nbsp;at&nbsp;most&nbsp;once&nbsp;delivery&nbsp;QoS&nbsp;Semantics.&nbsp;We&nbsp;achieve&nbsp;this&nbsp;by&nbsp;using&nbsp;persistent&nbsp;messages&nbsp;and&nbsp;calling&nbsp;basic_ack&nbsp;just&nbsp;before&nbsp;processing&nbsp;each&nbsp;message&nbsp;(using&nbsp;the&nbsp;channel&nbsp;that&nbsp;delivered&nbsp;the&nbsp;message). &nbsp;If&nbsp;the&nbsp;ack&nbsp;fails&nbsp;we&nbsp;discard&nbsp;the&nbsp;message&nbsp;and&nbsp;try&nbsp;the&nbsp;next&nbsp;message&nbsp;from&nbsp;the&nbsp;consumers&nbsp;internal&nbsp;in&nbsp;memory&nbsp;queue. &nbsp;If&nbsp;a&nbsp;channel&nbsp;or&nbsp;connection&nbsp;is&nbsp;closed,&nbsp;a&nbsp;management&nbsp;thread&nbsp;re-establishes&nbsp;the&nbsp;channel&nbsp;or&nbsp;connection&nbsp;and&nbsp;reconnects&nbsp;the&nbsp;consumer&nbsp;asynchronously,&nbsp;so&nbsp;all&nbsp;unacked&nbsp;messages&nbsp;get&nbsp;redelivered&nbsp;to&nbsp;the&nbsp;consumer.&nbsp; The&nbsp;original&nbsp;version&nbsp;of&nbsp;these&nbsp;messages&nbsp;might&nbsp;still&nbsp;be&nbsp;in&nbsp;the&nbsp;consumers&nbsp;internal&nbsp;queue,&nbsp;but&nbsp;since&nbsp;we&nbsp;try&nbsp;to&nbsp;ack&nbsp;them&nbsp;before&nbsp;processing&nbsp;they&nbsp;will&nbsp;be&nbsp;silently&nbsp;ignored.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;The&nbsp;problem&nbsp;is&nbsp;some&nbsp;messages&nbsp;are&nbsp;getting&nbsp;processed&nbsp;twice. &nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;message&nbsp;that&nbsp;is&nbsp;acked&nbsp;successfully&nbsp;by&nbsp;the&nbsp;client&nbsp;is&nbsp;getting&nbsp;redelivered&nbsp;when&nbsp;the&nbsp;connection&nbsp;drops&nbsp;at&nbsp;the&nbsp;same&nbsp;time&nbsp;as&nbsp;the&nbsp;ack. &nbsp;We&nbsp;currently&nbsp;have&nbsp;some&nbsp;network&nbsp;conditions&nbsp;that&nbsp;we&nbsp;haven’t&nbsp;figured&nbsp;out&nbsp;yet&nbsp;that&nbsp;cause&nbsp;the&nbsp;connection&nbsp;to&nbsp;drop&nbsp;every&nbsp;15&nbsp;minutes. &nbsp;When&nbsp;this&nbsp;happens&nbsp;the&nbsp;message&nbsp;sometimes&nbsp;gets&nbsp;redelivered&nbsp;to&nbsp;consumer&nbsp;on&nbsp;a&nbsp;different&nbsp;system.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;I&nbsp;have&nbsp;attached&nbsp;a&nbsp;network&nbsp;diagram&nbsp;to&nbsp;explain&nbsp;our&nbsp;topology. &nbsp;We&nbsp;have&nbsp;two&nbsp;rabbitmq&nbsp;boxed&nbsp;in&nbsp;a&nbsp;cluster,&nbsp;but&nbsp;they&nbsp;are&nbsp;not&nbsp;involved&nbsp;in&nbsp;any&nbsp;HA&nbsp;or&nbsp;automatic&nbsp;failover. &nbsp;Failover&nbsp;is&nbsp;handled&nbsp;by&nbsp;the&nbsp;clients&nbsp;on&nbsp;the&nbsp;producer&nbsp;and&nbsp;consumer&nbsp;systems. &nbsp;The&nbsp;queues&nbsp;and&nbsp;exchanges&nbsp;are&nbsp;duplicated&nbsp;across&nbsp;each&nbsp;server&nbsp;(with&nbsp;a&nbsp;server&nbsp;identifier&nbsp;added). &nbsp;We&nbsp;have&nbsp;multiple&nbsp;producer&nbsp;systems&nbsp;each&nbsp;connecting&nbsp;to&nbsp;one&nbsp;rabbitmq&nbsp;server&nbsp;(chosen&nbsp;at&nbsp;random). &nbsp;There&nbsp;are&nbsp;two&nbsp;ESB&nbsp;servers&nbsp;forming&nbsp;a&nbsp;cluster&nbsp;that&nbsp;consume&nbsp;the&nbsp;messages&nbsp;from&nbsp;the&nbsp;queues&nbsp;on&nbsp;both&nbsp;rabbitmq&nbsp;servers. &nbsp;The&nbsp;consumers&nbsp;on&nbsp;each&nbsp;ESB&nbsp;merge&nbsp;the&nbsp;queues&nbsp;from&nbsp;each&nbsp;rabbitmq&nbsp;server&nbsp;and&nbsp;present&nbsp;it&nbsp;as&nbsp;one&nbsp;queue&nbsp;to&nbsp;the&nbsp;application&nbsp;layer. &nbsp;The&nbsp;application&nbsp;layer&nbsp;does&nbsp;not&nbsp;get&nbsp;the&nbsp;message&nbsp;until&nbsp;after&nbsp;it&nbsp;is&nbsp;acked.&nbsp;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;Obviously&nbsp;we&nbsp;have&nbsp;to&nbsp;fix&nbsp;our&nbsp;network&nbsp;issues. &nbsp;However&nbsp;we&nbsp;would&nbsp;also&nbsp;like&nbsp;to&nbsp;understand&nbsp;how&nbsp;we&nbsp;can&nbsp;process&nbsp;messages&nbsp;twice&nbsp;when&nbsp;a&nbsp;connection&nbsp;drops.&nbsp; Is&nbsp;the&nbsp;ack&nbsp;asynchronous?&nbsp;Or&nbsp;is&nbsp;there&nbsp;a&nbsp;chance&nbsp;of&nbsp;a&nbsp;race&nbsp;condition&nbsp;when&nbsp;a&nbsp;connection&nbsp;is&nbsp;dropped&nbsp;during&nbsp;an&nbsp;ack&nbsp;where&nbsp;the&nbsp;client&nbsp;considers&nbsp;the&nbsp;message&nbsp;acked&nbsp;but&nbsp;the&nbsp;server&nbsp;does&nbsp;not? &nbsp;Or&nbsp;does&nbsp;this&nbsp;look&nbsp;like&nbsp;a&nbsp;bug?&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;I&nbsp;haven’t&nbsp;yet&nbsp;made&nbsp;a&nbsp;small&nbsp;application&nbsp;to&nbsp;reproduce&nbsp;this&nbsp;but&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;if&nbsp;required.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;Regards,&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-IE&quot;&gt;Iain.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;Eugene&nbsp;Kirpichov&lt;br&gt;Principal&nbsp;Engineer,&nbsp;Mirantis&nbsp;Inc.&nbsp;&lt;a&nbsp;href=&quot;http://www.mirantis.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.mirantis.com/&lt;/a&gt;&lt;br&gt;Editor,&nbsp;&lt;a&nbsp;href=&quot;http://fprog.ru/&quot;&nbsp;target=&quot;_blank&quot;&gt;http://fprog.ru/&lt;/a&gt;&lt;br&gt;<br>
<br>
&lt;/div&gt;<br>

</tt>
