<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi&nbsp;RMQ&nbsp;developers,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;following&nbsp;patch&nbsp;changes&nbsp;the&nbsp;behaviour&nbsp;of&nbsp;the&nbsp;RMQ&nbsp;Erlang&nbsp;Client&nbsp;when&nbsp;it&nbsp;shuts&nbsp;down.&nbsp;It&nbsp;avoids&nbsp;spamming&nbsp;the&nbsp;log&nbsp;with&nbsp;death&nbsp;messages&nbsp;in&nbsp;graceful&nbsp;closes.&nbsp;Background&nbsp;is&nbsp;below&nbsp;the&nbsp;patch.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Patch:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;a&nbsp;href=&quot;https://github.com/issuu/amqp_client/commit/2c582c983433027e007b4e80f2c6d9f25d7f854b&quot;&gt;https://github.com/issuu/amqp_client/commit/2c582c983433027e007b4e80f2c6d9f25d7f854b&lt;/a&gt;&lt;div&gt;<br>
<br>
&lt;a&nbsp;href=&quot;https://github.com/issuu/amqp_client/commit/2c582c983433027e007b4e80f2c6d9f25d7f854b.patch&quot;&gt;https://github.com/issuu/amqp_client/commit/2c582c983433027e007b4e80f2c6d9f25d7f854b.patch&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
<br>
Background:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;RMQ&nbsp;Erlang&nbsp;client&nbsp;holds&nbsp;a&nbsp;supervisor&nbsp;tree&nbsp;which&nbsp;contains&nbsp;processes&nbsp;running&nbsp;as&nbsp;amqp_gen_consumers&nbsp;where&nbsp;a&nbsp;direct_consumer&nbsp;module&nbsp;has&nbsp;been&nbsp;injected.&nbsp;A&nbsp;typical&nbsp;user&nbsp;of&nbsp;the&nbsp;client&nbsp;application&nbsp;will&nbsp;have&nbsp;its&nbsp;own&nbsp;separate&nbsp;supervisor&nbsp;tree.&nbsp;To&nbsp;handle&nbsp;the&nbsp;crash&nbsp;of&nbsp;the&nbsp;client&nbsp;application,&nbsp;the&nbsp;direct_consumer&nbsp;installs&nbsp;a&nbsp;*monitor*&nbsp;on&nbsp;the&nbsp;ConsumerPid.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;stop&nbsp;consumption&nbsp;if&nbsp;the&nbsp;consumer&nbsp;process&nbsp;goes&nbsp;away&nbsp;for&nbsp;some&nbsp;reason.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;OTP&nbsp;compliant&nbsp;processes&nbsp;will&nbsp;have&nbsp;two&nbsp;kinds&nbsp;of&nbsp;exit&nbsp;reasons&nbsp;which&nbsp;are&nbsp;graceful:&nbsp;&quot;normal&quot;&nbsp;and&nbsp;&quot;shutdown&quot;.&nbsp;The&nbsp;former&nbsp;happens&nbsp;when&nbsp;the&nbsp;ConsumerPid&nbsp;exits&nbsp;normally.&nbsp;Either&nbsp;by&nbsp;calling&nbsp;exit(normal)&nbsp;or&nbsp;by&nbsp;returning&nbsp;from&nbsp;the&nbsp;top-level&nbsp;function.&nbsp;The&nbsp;latter&nbsp;happens&nbsp;if&nbsp;the&nbsp;supervisor&nbsp;decides&nbsp;to&nbsp;close&nbsp;down&nbsp;the&nbsp;tree.&nbsp;It&nbsp;normally&nbsp;sends&nbsp;forth&nbsp;exit(Child,&nbsp;shutdown)&nbsp;in&nbsp;order&nbsp;to&nbsp;shut&nbsp;down&nbsp;its&nbsp;supervisor&nbsp;children&nbsp;processes.&nbsp;Any&nbsp;other&nbsp;exit&nbsp;reason&nbsp;is&nbsp;a&nbsp;grace&nbsp;error.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Implementation:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;patch&nbsp;detects&nbsp;the&nbsp;two&nbsp;cases&nbsp;of&nbsp;graceful&nbsp;shutdowns&nbsp;and&nbsp;then&nbsp;proceeds&nbsp;to&nbsp;silently&nbsp;close&nbsp;the&nbsp;supervision&nbsp;tree&nbsp;on&nbsp;the&nbsp;RabbitMQ&nbsp;side.&nbsp;This&nbsp;stops&nbsp;such&nbsp;errors&nbsp;from&nbsp;spamming&nbsp;in&nbsp;the&nbsp;logs&nbsp;when&nbsp;the&nbsp;supervisor&nbsp;tree&nbsp;closes&nbsp;down&nbsp;normally.&nbsp;If&nbsp;other&nbsp;errors&nbsp;occur,&nbsp;we&nbsp;close&nbsp;down&nbsp;the&nbsp;tree&nbsp;like&nbsp;we&nbsp;always&nbsp;have,&nbsp;yelling&nbsp;and&nbsp;screaming&nbsp;that&nbsp;something&nbsp;is&nbsp;going&nbsp;very&nbsp;wrong.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Review:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;patch&nbsp;has&nbsp;seen&nbsp;some&nbsp;internal&nbsp;testing&nbsp;and&nbsp;looks&nbsp;correct;&nbsp;but&nbsp;as&nbsp;I&nbsp;am&nbsp;not&nbsp;too&nbsp;well&nbsp;versed&nbsp;in&nbsp;the&nbsp;supervisor&nbsp;tree,&nbsp;and&nbsp;in&nbsp;particular&nbsp;the&nbsp;supervisor2&nbsp;structure,&nbsp;I&nbsp;might&nbsp;have&nbsp;introduced&nbsp;a&nbsp;leak.&nbsp;Please&nbsp;look&nbsp;closely&nbsp;at&nbsp;the&nbsp;code&nbsp;with&nbsp;respect&nbsp;to&nbsp;crashing&nbsp;and&nbsp;stopping&nbsp;behaviour&nbsp;in&nbsp;mind.&nbsp;If&nbsp;supervisor2&nbsp;works&nbsp;anything&nbsp;like&nbsp;supervisor&nbsp;here,&nbsp;it&nbsp;should&nbsp;work.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;+++&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;hope&nbsp;the&nbsp;RabbitMQ&nbsp;developers&nbsp;will&nbsp;consider&nbsp;this&nbsp;patch&nbsp;for&nbsp;inclusion&nbsp;as&nbsp;it&nbsp;might&nbsp;help&nbsp;others.&nbsp;It&nbsp;is&nbsp;yours&nbsp;to&nbsp;use&nbsp;and&nbsp;I&nbsp;hereby&nbsp;sign&nbsp;it&nbsp;off&nbsp;as&nbsp;a&nbsp;RabbitMQ&nbsp;contribution.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Merry&nbsp;Christmas&nbsp;:)&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
