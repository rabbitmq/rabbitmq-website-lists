<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Feb&nbsp;4,&nbsp;2011&nbsp;at&nbsp;5:10&nbsp;AM,&nbsp;Matthew&nbsp;Sackman&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthew@rabbitmq.com&quot;&gt;matthew@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;Mon,&nbsp;Jan&nbsp;31,&nbsp;2011&nbsp;at&nbsp;07:26:34AM&nbsp;-0800,&nbsp;Bill&nbsp;Moseley&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&nbsp;For&nbsp;those&nbsp;of&nbsp;you&nbsp;running&nbsp;multiple&nbsp;RabbitMQ&nbsp;servers&nbsp;in&nbsp;a&nbsp;cluster,&nbsp;what&nbsp;is&lt;br&gt;<br>
&amp;gt;&nbsp;your&nbsp;procedure&nbsp;when&nbsp;you&nbsp;want&nbsp;to&nbsp;shut&nbsp;one&nbsp;of&nbsp;the&nbsp;servers&nbsp;down&nbsp;(e.g.&nbsp;for&lt;br&gt;<br>
&amp;gt;&nbsp;maintenance)&nbsp;but&nbsp;not&nbsp;disrupt&nbsp;overall&nbsp;service?&nbsp; &nbsp;Queues&nbsp;only&nbsp;live&nbsp;on&nbsp;one&lt;br&gt;<br>
&amp;gt;&nbsp;server&nbsp;so&nbsp;I&amp;#39;m&nbsp;wondering&nbsp;how&nbsp;(or&nbsp;if)&nbsp;you&nbsp;do&nbsp;something&nbsp;to&nbsp;flush&nbsp;out&nbsp;the&nbsp;queue&lt;br&gt;<br>
&amp;gt;&nbsp;before&nbsp;stopping&nbsp;the&nbsp;machine.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Usual&nbsp;best&nbsp;practise&nbsp;is&nbsp;to&nbsp;force&nbsp;clients&nbsp;to&nbsp;reconnect&nbsp;elsewhere,&lt;br&gt;<br>
recreating&nbsp;the&nbsp;resources&nbsp;they&nbsp;need.&nbsp;This&nbsp;may&nbsp;need&nbsp;some&nbsp;careful&nbsp;thought&lt;br&gt;<br>
with&nbsp;ordering&nbsp;of&nbsp;events&nbsp;etc.&nbsp;Frequent&nbsp;best&nbsp;practise&nbsp;is&nbsp;that&nbsp;publishers&lt;br&gt;<br>
create&nbsp;exchanges,&nbsp;and&nbsp;consumers&nbsp;create&nbsp;the&nbsp;queues&nbsp;they&nbsp;need&nbsp;and&nbsp;bind&lt;br&gt;<br>
them&nbsp;as&nbsp;necessary.&nbsp;To&nbsp;avoid&nbsp;missing&nbsp;any&nbsp;messages&nbsp;you&amp;#39;ll&nbsp;need&nbsp;to&nbsp;start&nbsp;up&lt;br&gt;<br>
new&nbsp;consumers&nbsp;before&nbsp;taking&nbsp;down&nbsp;the&nbsp;old&nbsp;ones.&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;responding&nbsp;--&nbsp;I&nbsp;had&nbsp;just&nbsp;this&nbsp;morning&nbsp;thought&nbsp;about&nbsp;this&nbsp;question&nbsp;and&nbsp;here&nbsp;was&nbsp;your&nbsp;response! &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Configuration&nbsp;on&nbsp;the&nbsp;clients&nbsp;is&nbsp;something&nbsp;I&amp;#39;m&nbsp;trying&nbsp;to&nbsp;reduce&nbsp;--&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;need&nbsp;to&nbsp;trigger&nbsp;a&nbsp;reconnect&nbsp;on&nbsp;all&nbsp;clients&nbsp;manually.&nbsp; Maybe&nbsp;what&nbsp;I&nbsp;need&nbsp;is&nbsp;better&nbsp;configuration&nbsp;management.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One&nbsp;approach&nbsp;I&nbsp;was&nbsp;considering&nbsp;is&nbsp;having&nbsp;all&nbsp;clients&nbsp;(producers&nbsp;and&nbsp;consumers)&nbsp;connect&nbsp;to&nbsp;a&nbsp;load&nbsp;balancer&nbsp;in&nbsp;front&nbsp;of&nbsp;two&nbsp;independent&nbsp;RabbitMQ&nbsp;brokers.&nbsp; They&nbsp;would&nbsp;not&nbsp;be&nbsp;in&nbsp;a&nbsp;cluster&nbsp;(although&nbsp;each&nbsp;one&nbsp;could&nbsp;be&nbsp;its&nbsp;own&nbsp;cluster&nbsp;of&nbsp;machines&nbsp;for&nbsp;scaling).&nbsp; &nbsp;The&nbsp;balancer&nbsp;only&nbsp;uses&nbsp;one&nbsp;RabbitMQ&nbsp;broker&nbsp;and&nbsp;the&nbsp;second&nbsp;is&nbsp;hot-standby.&nbsp; The&nbsp;consumers&nbsp;connect&nbsp;to&nbsp;a&nbsp;different&nbsp;IP&nbsp;than&nbsp;the&nbsp;producers.&nbsp; &nbsp;Clients&nbsp;know&nbsp;to&nbsp;reconnect&nbsp;upon&nbsp;loss&nbsp;of&nbsp;a&nbsp;connection.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Then&nbsp;the&nbsp;trick&nbsp;is&nbsp;to&nbsp;use&nbsp;the&nbsp;load&nbsp;balancer&nbsp;to&nbsp;make&nbsp;the&nbsp;producers&nbsp;move&nbsp;to&nbsp;the&nbsp;new&nbsp;broker,&nbsp;move&nbsp;some&nbsp;consumers&nbsp;as&nbsp;well,&nbsp;and&nbsp;leave&nbsp;some&nbsp;other&nbsp;consumers&nbsp;to&nbsp;drain&nbsp;the&nbsp;queues&nbsp;on&nbsp;the&nbsp;old&nbsp;broker&nbsp;before&nbsp;pulling&nbsp;out&nbsp;of&nbsp;service.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;&nbsp;But&nbsp;they&nbsp;must&nbsp;create&nbsp;new&lt;br&gt;<br>
queues,&nbsp;not&nbsp;on&nbsp;the&nbsp;to-die&nbsp;node.&nbsp;So&nbsp;this&nbsp;requires&nbsp;the&nbsp;queue&nbsp;names&nbsp;must&nbsp;be&lt;br&gt;<br>
fresh,&nbsp;but&nbsp;then&nbsp;you&amp;#39;re&nbsp;going&nbsp;to&nbsp;have&nbsp;to&nbsp;deal&nbsp;with&nbsp;the&nbsp;possibilities&nbsp;of&lt;br&gt;<br>
duplicate&nbsp;messages&nbsp;during&nbsp;the&nbsp;period&nbsp;that&nbsp;multiple&nbsp;sets&nbsp;of&nbsp;consumers&nbsp;are&lt;br&gt;<br>
up&nbsp;etc.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Renaming&nbsp;the&nbsp;queues&nbsp;is&nbsp;only&nbsp;needed&nbsp;if&nbsp;pulling&nbsp;a&nbsp;machine&nbsp;out&nbsp;of&nbsp;cluster&nbsp;(for&nbsp;the&nbsp;queues&nbsp;that&nbsp;were&nbsp;created&nbsp;on&nbsp;that&nbsp;machine),&nbsp;correct?&nbsp; I&nbsp;would&nbsp;not&nbsp;need&nbsp;that&nbsp;with&nbsp;two&nbsp;separate&nbsp;brokers&nbsp;as&nbsp;I&nbsp;describe&nbsp;above,&nbsp;if&nbsp;I&nbsp;follow&nbsp;what&nbsp;you&nbsp;are&nbsp;saying.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;The&nbsp;&amp;quot;or-else&amp;quot;&nbsp;routing&nbsp;semantics&nbsp;of&nbsp;RabbitMQ&amp;#39;s&nbsp;&amp;quot;Alternate&nbsp;Exchanges&amp;quot;&nbsp;may&lt;br&gt;<br>
<br>
<br>
well&nbsp;be&nbsp;of&nbsp;use&nbsp;here.&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://www.rabbitmq.com/extensions.html#alternate-exchange&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.rabbitmq.com/extensions.html#alternate-exchange&lt;/a&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;I&amp;#39;ve&nbsp;been&nbsp;looking&nbsp;at&nbsp;those.&nbsp; Are&nbsp;you&nbsp;saying&nbsp;that&nbsp;if&nbsp;the&nbsp;queue&nbsp;is&nbsp;not&nbsp;durable&nbsp;then&nbsp;once&nbsp;all&nbsp;the&nbsp;consumers&nbsp;of&nbsp;that&nbsp;queue&nbsp;go&nbsp;away&nbsp;then&nbsp;could&nbsp;use&nbsp;the&nbsp;alternate-exchange&nbsp;as&nbsp;a&nbsp;type&nbsp;of&nbsp;fail-over?&lt;/div&gt;<br>
<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&amp;gt;&nbsp;Now,&nbsp;this&nbsp;is&nbsp;a&nbsp;bit&nbsp;tougher:&nbsp;How&nbsp;about&nbsp;catastrophic&nbsp;failures?&nbsp; I&amp;#39;m&nbsp;wondering&lt;br&gt;<br>
&amp;gt;&nbsp;about&nbsp;using&nbsp;the&nbsp;complexity&nbsp;of&nbsp;Pacemaker&nbsp;and&nbsp;DRBD&nbsp;vs.&nbsp;tracking&nbsp;incomplete&lt;br&gt;<br>
&amp;gt;&nbsp;jobs&nbsp;and&nbsp;resubmitting&nbsp;after&nbsp;some&nbsp;time.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Horses&nbsp;for&nbsp;courses&nbsp;really.&nbsp;We&nbsp;know&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;clients&nbsp;who&nbsp;are&nbsp;using&lt;br&gt;<br>
the&nbsp;pacemaker&nbsp;stuff,&nbsp;though&nbsp;frequently&nbsp;with&nbsp;NAS/SAN&nbsp;rather&nbsp;than&nbsp;DRBD.&nbsp;If&lt;br&gt;<br>
you&nbsp;can&nbsp;work&nbsp;out&nbsp;what&nbsp;failures&nbsp;you&nbsp;can&nbsp;withstand&nbsp;and&nbsp;what&nbsp;you&nbsp;can&amp;#39;t&nbsp;and&lt;br&gt;<br>
then&nbsp;pick&nbsp;the&nbsp;best&nbsp;approach&nbsp;to&nbsp;match.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;story&nbsp;from&nbsp;our&nbsp;IT&nbsp;department&nbsp;is&nbsp;we&nbsp;don&amp;#39;t&nbsp;like&nbsp;DRBD&nbsp;and&nbsp;NAS/SAN&nbsp;is&nbsp;too&nbsp;expensive.&nbsp;;)&nbsp; But,&nbsp;they&nbsp;want&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;yank&nbsp;the&nbsp;plug&nbsp;on&nbsp;a&nbsp;RabbitMQ&nbsp;box&nbsp;and&nbsp;have&nbsp;the&nbsp;application&nbsp;continue&nbsp;with&nbsp;no&nbsp;disruption.&nbsp; Basically,&nbsp;no&nbsp;message&nbsp;is&nbsp;ever&nbsp;lost.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;the&nbsp;key&nbsp;might&nbsp;be&nbsp;knowing&nbsp;what&nbsp;failures&nbsp;we&nbsp;can&nbsp;withstand.&nbsp; My&nbsp;current&nbsp;thinking&nbsp;has&nbsp;shifted&nbsp;a&nbsp;bit.&nbsp; I&nbsp;think&nbsp;that&nbsp;instead&nbsp;of&nbsp;trying&nbsp;to&nbsp;build&nbsp;something&nbsp;that&nbsp;never&nbsp;fails,&nbsp;just&nbsp;assume&nbsp;it&amp;#39;s&nbsp;not&nbsp;very&nbsp;likely&nbsp;to&nbsp;fail&nbsp;but&nbsp;design&nbsp;the&nbsp;application&nbsp;to&nbsp;handle&nbsp;a&nbsp;queue&nbsp;failure.&nbsp; What&nbsp;that&nbsp;means&nbsp;is&nbsp;that&nbsp;for&nbsp;messages&nbsp;(really&nbsp;&amp;quot;jobs&amp;quot;&nbsp;in&nbsp;this&nbsp;case)&nbsp;that&nbsp;must&nbsp;complete,&nbsp;the&nbsp;producer,&nbsp;or&nbsp;some&nbsp;agent&nbsp;of&nbsp;the&nbsp;producer&nbsp;(perhaps&nbsp;a&nbsp;cron&nbsp;job)&nbsp;will&nbsp;see&nbsp;the&nbsp;job&nbsp;was&nbsp;not&nbsp;completed&nbsp;in&nbsp;a&nbsp;timely&nbsp;way&nbsp;and&nbsp;send&nbsp;a&nbsp;new&nbsp;message.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Maybe&nbsp;that&amp;#39;s&nbsp;not&nbsp;so&nbsp;pretty&nbsp;if&nbsp;the&nbsp;queue&nbsp;has&nbsp;a&nbsp;million&nbsp;messages&nbsp;pending&nbsp;when&nbsp;it&nbsp;fails,&nbsp;but&nbsp;if&nbsp;that&amp;#39;s&nbsp;the&nbsp;case&nbsp;then&nbsp;there&amp;#39;s&nbsp;other&nbsp;more&nbsp;serious&nbsp;problems....&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;--&nbsp;&lt;br&gt;<br>
<br>
Bill&nbsp;Moseley&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:moseley@hank.org&quot;&nbsp;target=&quot;_blank&quot;&gt;moseley@hank.org&lt;/a&gt;&lt;br&gt;<br>

</tt>
