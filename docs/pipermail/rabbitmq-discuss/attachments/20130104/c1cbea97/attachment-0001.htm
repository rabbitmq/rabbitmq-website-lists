<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thanks&nbsp;for&nbsp;the&nbsp;pointers&nbsp;Matthias,&nbsp;I&nbsp;wasn&amp;#39;t&nbsp;able&nbsp;to&nbsp;do&nbsp;a&nbsp;lot&nbsp;of&nbsp;changes&nbsp;before&nbsp;the&nbsp;holidays,&nbsp;but&nbsp;I&amp;#39;ve&nbsp;done&nbsp;a&nbsp;few&nbsp;things&nbsp;since&nbsp;the&nbsp;last&nbsp;email.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;ve&nbsp;updated&nbsp;to&nbsp;RMQ&nbsp;3.0.1&nbsp;and&nbsp;R15B03&nbsp;of&nbsp;Erlang.&nbsp;I&nbsp;noticed&nbsp;a&nbsp;slight&nbsp;improvement&nbsp;in&nbsp;performance&nbsp;but&nbsp;not&nbsp;much.&nbsp;Increasing&nbsp;the&nbsp;number&nbsp;of&nbsp;queues&nbsp;also&nbsp;didn&amp;#39;t&nbsp;seem&nbsp;to&nbsp;make&nbsp;a&nbsp;large&nbsp;impact.&nbsp;One&nbsp;thing&nbsp;that&nbsp;I&amp;#39;m&nbsp;noticing&nbsp;while&nbsp;running&nbsp;in&nbsp;HIPE&nbsp;mode&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;system&nbsp;utilization&nbsp;on&nbsp;the&nbsp;server.&nbsp;System&nbsp;utilization&nbsp;is&nbsp;at&nbsp;85-90%&nbsp;while&nbsp;user&nbsp;processes&nbsp;are&nbsp;only&nbsp;at&nbsp;8%.&nbsp;I&nbsp;went&nbsp;to&nbsp;the&nbsp;stock&nbsp;Erlang&nbsp;configuration&nbsp;and&nbsp;just&nbsp;changed&nbsp;the&nbsp;+swt&nbsp;setting.&nbsp;I&nbsp;noticed&nbsp;that&nbsp;setting&nbsp;it&nbsp;to&nbsp;very_high&nbsp;caused&nbsp;a&nbsp;dip&nbsp;in&nbsp;performance&nbsp;while&nbsp;very_low&nbsp;was&nbsp;about&nbsp;the&nbsp;same&nbsp;as&nbsp;not&nbsp;modifying&nbsp;the&nbsp;setting.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;The&nbsp;server&nbsp;has&nbsp;4&nbsp;NUMA&nbsp;nodes&nbsp;configured&nbsp;(one&nbsp;for&nbsp;each&nbsp;10&nbsp;core&nbsp;CPU).&nbsp;Interestingly,&nbsp;running&nbsp;against&nbsp;a&nbsp;single&nbsp;NUMA&nbsp;node&nbsp;by&nbsp;wrapping&nbsp;the&nbsp;start&nbsp;of&nbsp;RMQ&nbsp;with&nbsp;numactl&nbsp;almost&nbsp;doubles&nbsp;performance.&nbsp;Kernel&nbsp;utilization&nbsp;drops&nbsp;to&nbsp;15%&nbsp;and&nbsp;user&nbsp;utilization&nbsp;is&nbsp;about&nbsp;the&nbsp;same.&nbsp;As&nbsp;soon&nbsp;as&nbsp;I&nbsp;run&nbsp;RMQ&nbsp;across&nbsp;more&nbsp;than&nbsp;one&nbsp;NUMA&nbsp;node&nbsp;performance&nbsp;suffers.&nbsp;Is&nbsp;there&nbsp;anything&nbsp;within&nbsp;the&nbsp;Erlang&nbsp;settings&nbsp;that&nbsp;would&nbsp;allow&nbsp;me&nbsp;to&nbsp;run&nbsp;RMQ&nbsp;across&nbsp;more&nbsp;cores&nbsp;but&nbsp;keep&nbsp;the&nbsp;kernel&nbsp;utilization&nbsp;down?&nbsp;I&amp;#39;m&nbsp;guessing&nbsp;that&nbsp;schedulers&nbsp;are&nbsp;spawning&nbsp;across&nbsp;NUMA&nbsp;nodes&nbsp;and&nbsp;passing&nbsp;data&nbsp;back&nbsp;and&nbsp;forth&nbsp;between&nbsp;them,&nbsp;causing&nbsp;the&nbsp;kernel&nbsp;time&nbsp;to&nbsp;increase.&nbsp;If&nbsp;there&nbsp;is&nbsp;some&nbsp;way&nbsp;to&nbsp;localize&nbsp;the&nbsp;schedulers&nbsp;that&nbsp;work&nbsp;together&nbsp;within&nbsp;the&nbsp;same&nbsp;node&nbsp;that&nbsp;will&nbsp;be&nbsp;ideal.&nbsp;I&nbsp;tried&nbsp;a&nbsp;few&nbsp;+sbt&nbsp;options&nbsp;again&nbsp;but&nbsp;that&nbsp;didn&amp;#39;t&nbsp;seem&nbsp;to&nbsp;make&nbsp;a&nbsp;difference.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Thanks,&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt; Chris&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Dec&nbsp;21,&nbsp;2012&nbsp;at&nbsp;10:46&nbsp;AM,&nbsp;Matthias&nbsp;Radestock&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:matthias@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;matthias@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Chris,&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;20/12/12&nbsp;17:27,&nbsp;Chris&nbsp;Schmidt&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
RHEL&nbsp;6.2&nbsp;doesn&amp;#39;t&nbsp;seem&nbsp;to&nbsp;have&nbsp;the&nbsp;latest&nbsp;version&nbsp;of&nbsp;Erlang&nbsp;available&lt;br&gt;<br>
in&nbsp;the&nbsp;repositories.&nbsp;Does&nbsp;anyone&nbsp;have&nbsp;experience&nbsp;with&nbsp;manually&lt;br&gt;<br>
building&nbsp;Erlang&nbsp;on&nbsp;that&nbsp;platform&nbsp;with&nbsp;success?&nbsp;We&amp;#39;re&nbsp;on&nbsp;R14B04&nbsp;right&lt;br&gt;<br>
now.&nbsp;There&nbsp;are&nbsp;a&nbsp;huge&nbsp;number&nbsp;of&nbsp;erlang&nbsp;related&nbsp;rpms&nbsp;that&nbsp;get&lt;br&gt;<br>
installed&nbsp;I&amp;#39;m&nbsp;not&nbsp;certain&nbsp;if&nbsp;a&nbsp;single&nbsp;Erlang&nbsp;version&nbsp;for&nbsp;CentOS&lt;br&gt;<br>
would&nbsp;work&nbsp;properly&nbsp;or&nbsp;not.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
You&nbsp;may&nbsp;want&nbsp;to&nbsp;give&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://my.vmware.com/web/vmware/details?downloadGroup=VFEL_15B02&amp;amp;productId=267&quot;&nbsp;target=&quot;_blank&quot;&gt;https://my.vmware.com/web/&lt;u&gt;&lt;/u&gt;vmware/details?downloadGroup=&lt;u&gt;&lt;/u&gt;VFEL_15B02&amp;amp;productId=267&lt;/a&gt;&lt;br&gt;<br>
a&nbsp;try&nbsp;-&nbsp;it&amp;#39;s&nbsp;R15B02&nbsp;(so&nbsp;not&nbsp;quite&nbsp;the&nbsp;latest&nbsp;but&nbsp;close&nbsp;enough)&nbsp;with&lt;br&gt;<br>
&amp;quot;batteries&nbsp;included&amp;quot;,&nbsp;i.e.&nbsp;no&nbsp;dependencies.&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;had&nbsp;+K&nbsp;true&nbsp;-smp&nbsp;enable&nbsp;+native&nbsp;+sbtps&nbsp;plus&nbsp;the&nbsp;other&nbsp;RMQ&nbsp;defaults&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
&amp;quot;+K&nbsp;true&amp;quot;&nbsp;is&nbsp;already&nbsp;part&nbsp;of&nbsp;the&nbsp;standard&nbsp;config.&nbsp;So&nbsp;is&nbsp;&amp;quot;-smp&nbsp;auto&amp;quot;,&lt;br&gt;<br>
which&nbsp;enables&nbsp;smp&nbsp;when&nbsp;there&nbsp;is&nbsp;more&nbsp;than&nbsp;one&nbsp;core.&nbsp;&amp;quot;+native&amp;quot;&nbsp;is&nbsp;a&lt;br&gt;<br>
compile-time&nbsp;option&nbsp;and&nbsp;I&nbsp;would&nbsp;not&nbsp;recommend&nbsp;using&nbsp;it.&nbsp;As&nbsp;for&nbsp;+sbtps,&nbsp;I&lt;br&gt;<br>
suggest&nbsp;you&nbsp;leave&nbsp;that&nbsp;out&nbsp;and&nbsp;stick&nbsp;with&nbsp;the&nbsp;default.&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;I&nbsp;said&nbsp;in&nbsp;my&nbsp;earlier&nbsp;email,&nbsp;playing&nbsp;with&nbsp;the&nbsp;+swt&nbsp;option&nbsp;may&nbsp;yield&lt;br&gt;<br>
some&nbsp;benefits.&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;also&nbsp;had&nbsp;15&nbsp;consumers&nbsp;running&nbsp;against&nbsp;the&nbsp;initial&nbsp;queue&nbsp;that&nbsp;was&lt;br&gt;<br>
having&nbsp;problems.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Increasing&nbsp;the&nbsp;number&nbsp;of&nbsp;consumers&nbsp;only&nbsp;helps&nbsp;when&nbsp;the&nbsp;consumers,&nbsp;rather&lt;br&gt;<br>
than&nbsp;the&nbsp;queue,&nbsp;are&nbsp;the&nbsp;bottleneck.&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;also&nbsp;tried&nbsp;sending&nbsp;the&nbsp;data&nbsp;into&nbsp;2&nbsp;-&nbsp;40&nbsp;exchanges&nbsp;(and&nbsp;updated&nbsp;the&lt;br&gt;<br>
queue&nbsp;to&nbsp;read&nbsp;from&nbsp;those&nbsp;exchanges)&nbsp;in&nbsp;order&nbsp;to&nbsp;see&nbsp;if&nbsp;I&nbsp;could&nbsp;spread&lt;br&gt;<br>
the&nbsp;load&nbsp;that&nbsp;way.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Exchanges&nbsp;are&nbsp;not&nbsp;represented&nbsp;by&nbsp;processes,&nbsp;so&nbsp;you&nbsp;don&amp;#39;t&nbsp;gain&nbsp;anything&lt;br&gt;<br>
by&nbsp;spreading&nbsp;the&nbsp;load&nbsp;over&nbsp;them.&nbsp;Increasing&nbsp;the&nbsp;number&nbsp;of&nbsp;producers&nbsp;can&nbsp;increase&nbsp;the&nbsp;message&nbsp;ingestion&nbsp;rate,&nbsp;but&nbsp;only&nbsp;if&nbsp;the&nbsp;messages&nbsp;get&nbsp;routed&nbsp;to&nbsp;different&nbsp;queues.&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Does&nbsp;a&nbsp;single&nbsp;process&nbsp;manage&nbsp;each&nbsp;queue?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
yes.&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
If&nbsp;so&nbsp;I&nbsp;can&nbsp;see&nbsp;that&nbsp;being&nbsp;a&nbsp;potential&nbsp;bottleneck&nbsp;due&nbsp;to&nbsp;the&nbsp;core&amp;#39;s&lt;br&gt;<br>
speed&nbsp;difference.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
Exactly.&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Is&nbsp;there&nbsp;an&nbsp;erlang&nbsp;or&nbsp;rabbitmqctl&nbsp;command&nbsp;that&nbsp;I&nbsp;can&nbsp;run&nbsp;against&nbsp;the&lt;br&gt;<br>
RMQ&nbsp;server&nbsp;to&nbsp;determine&nbsp;if&nbsp;the&nbsp;queues&nbsp;themselves&nbsp;are&nbsp;the&nbsp;bottleneck?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
If&nbsp;the&nbsp;queues&nbsp;are&nbsp;growing&nbsp;then&nbsp;the&nbsp;bottleneck&nbsp;is&nbsp;on&nbsp;the&nbsp;outbound&nbsp;side&nbsp;(rabbit&amp;#39;s&nbsp;AMQP&nbsp;encoding,&nbsp;network,&nbsp;consumers).&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;the&nbsp;queues&nbsp;stay&nbsp;short/empty&nbsp;then&nbsp;the&nbsp;bottleneck&nbsp;is&nbsp;on&nbsp;the&nbsp;inbound&nbsp;side&nbsp;(producer,&nbsp;network,&nbsp;rabbit&amp;#39;s&nbsp;AMQP&nbsp;decoding,&nbsp;routing,&nbsp;the&nbsp;queue).&nbsp;If&nbsp;connections&nbsp;get&nbsp;blocked&nbsp;due&nbsp;to&nbsp;flow&nbsp;control&nbsp;then&nbsp;the&nbsp;bottleneck&nbsp;is&nbsp;in&nbsp;the&nbsp;latter&nbsp;three.&nbsp;Narrowing&nbsp;it&nbsp;down&nbsp;any&nbsp;further&nbsp;is&nbsp;tricky.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;<br>
&lt;br&gt;<br>
Matthias.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
