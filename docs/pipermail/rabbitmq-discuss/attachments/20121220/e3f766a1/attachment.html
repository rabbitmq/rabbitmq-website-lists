<tt>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hey&nbsp;all,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;spent&nbsp;some&nbsp;quality&nbsp;time&nbsp;automating&nbsp;a&nbsp;cluster&nbsp;setup&nbsp;of&nbsp;3.0.1&nbsp;on&nbsp;EC2&nbsp;over&nbsp;the&nbsp;last&nbsp;couple&nbsp;of&nbsp;days,&nbsp;and&nbsp;came&nbsp;across&nbsp;some&nbsp;things&nbsp;that&nbsp;felt&nbsp;a&nbsp;bit&nbsp;odd&nbsp;to&nbsp;me.&nbsp;Maybe&nbsp;I&nbsp;did&nbsp;it&nbsp;all&nbsp;wrong,&nbsp;happy&nbsp;to&nbsp;be&nbsp;proven&nbsp;that&nbsp;I&nbsp;did.&nbsp;I&nbsp;apologize&nbsp;if&nbsp;this&nbsp;turns&nbsp;out&nbsp;a&nbsp;bit&nbsp;long,&nbsp;there&nbsp;are&nbsp;a&nbsp;couple&nbsp;of&nbsp;questions&nbsp;that&nbsp;boil&nbsp;down&nbsp;to&nbsp;a&nbsp;similar&nbsp;issue.&nbsp;Would&nbsp;be&nbsp;curious&nbsp;to&nbsp;hear&nbsp;how&nbsp;other&nbsp;folks&nbsp;have&nbsp;solved&nbsp;this&nbsp;issue,&nbsp;and&nbsp;mostly&nbsp;focussing&nbsp;on&nbsp;RabbitMQ&nbsp;3.0,&nbsp;as,&nbsp;from&nbsp;what&nbsp;I've&nbsp;read,&nbsp;clustering&nbsp;behaviour&nbsp;has&nbsp;changed&nbsp;with&nbsp;that&nbsp;release.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;First&nbsp;a&nbsp;whee&nbsp;bit&nbsp;about&nbsp;the&nbsp;setup,&nbsp;nothing&nbsp;special&nbsp;really,&nbsp;but&nbsp;required&nbsp;to&nbsp;clarify&nbsp;some&nbsp;of&nbsp;the&nbsp;questions&nbsp;below:&nbsp;every&nbsp;node&nbsp;has&nbsp;a&nbsp;custom&nbsp;CNAME&nbsp;record&nbsp;rabbitmq1.domain.com,&nbsp;rabbitmq2.domain.com,&nbsp;each&nbsp;pointing&nbsp;to&nbsp;the&nbsp;EC2&nbsp;host&nbsp;name.&nbsp;I&nbsp;do&nbsp;this&nbsp;because&nbsp;I&nbsp;prefer&nbsp;full&nbsp;hostnames&nbsp;over&nbsp;EC2&nbsp;hostnames&nbsp;because&nbsp;it&nbsp;adds&nbsp;clarity&nbsp;to&nbsp;the&nbsp;whole&nbsp;setup,&nbsp;at&nbsp;least&nbsp;for&nbsp;me&nbsp;:)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;first&nbsp;issue&nbsp;with&nbsp;this&nbsp;setup&nbsp;comes&nbsp;up&nbsp;when&nbsp;you&nbsp;want&nbsp;to&nbsp;change&nbsp;the&nbsp;hostname&nbsp;for&nbsp;the&nbsp;RabbitMQ&nbsp;node.&nbsp;Changing&nbsp;it&nbsp;post-installation&nbsp;is&nbsp;a&nbsp;bit&nbsp;of&nbsp;a&nbsp;hassle&nbsp;because&nbsp;the&nbsp;package&nbsp;already&nbsp;starts&nbsp;up&nbsp;the&nbsp;service.&nbsp;Changing&nbsp;the&nbsp;nodename&nbsp;to&nbsp;the&nbsp;FQDN&nbsp;and&nbsp;trying&nbsp;to&nbsp;restart&nbsp;the&nbsp;service&nbsp;after&nbsp;that&nbsp;leads&nbsp;to&nbsp;errors&nbsp;because&nbsp;the&nbsp;service&nbsp;can't&nbsp;be&nbsp;stopped&nbsp;anymore&nbsp;as&nbsp;the&nbsp;nodenames&nbsp;are&nbsp;now&nbsp;different.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;solved&nbsp;this&nbsp;on&nbsp;EC2&nbsp;by&nbsp;adding&nbsp;domain.com&nbsp;to&nbsp;the&nbsp;DHCP&nbsp;configuration&nbsp;and&nbsp;restarting&nbsp;the&nbsp;network&nbsp;before&nbsp;installing&nbsp;the&nbsp;RabbitMQ&nbsp;package.&nbsp;It's&nbsp;not&nbsp;a&nbsp;great&nbsp;solution,&nbsp;but&nbsp;acceptable.&nbsp;In&nbsp;the&nbsp;end&nbsp;it&nbsp;boils&nbsp;down&nbsp;to&nbsp;the&nbsp;package&nbsp;starting&nbsp;the&nbsp;service&nbsp;immediately&nbsp;on&nbsp;installation,&nbsp;more&nbsp;on&nbsp;that&nbsp;below.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;next&nbsp;issue&nbsp;is&nbsp;related&nbsp;to&nbsp;clustering.&nbsp;When&nbsp;RabbitMQ&nbsp;starts&nbsp;up,&nbsp;and&nbsp;there's&nbsp;a&nbsp;cluster_nodes&nbsp;section&nbsp;in&nbsp;the&nbsp;config,&nbsp;it&nbsp;seems&nbsp;to&nbsp;try&nbsp;and&nbsp;reach&nbsp;the&nbsp;nodes&nbsp;only&nbsp;once.&nbsp;This&nbsp;behaviour&nbsp;I'm&nbsp;not&nbsp;sure&nbsp;of,&nbsp;hence&nbsp;the&nbsp;question.&nbsp;I&nbsp;noticed&nbsp;that&nbsp;when&nbsp;a&nbsp;node&nbsp;can't&nbsp;look&nbsp;up&nbsp;any&nbsp;of&nbsp;the&nbsp;nodes&nbsp;in&nbsp;the&nbsp;cluster_nodes&nbsp;config,&nbsp;it&nbsp;won't&nbsp;try&nbsp;again&nbsp;at&nbsp;a&nbsp;later&nbsp;point&nbsp;in&nbsp;time,&nbsp;e.g.&nbsp;on&nbsp;restart.&nbsp;Therefore&nbsp;that&nbsp;node&nbsp;will&nbsp;never&nbsp;automatically&nbsp;join&nbsp;the&nbsp;cluster&nbsp;unless&nbsp;rabbitmqctl&nbsp;join_cluster&nbsp;is&nbsp;called.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;DHCP&nbsp;configuration&nbsp;helped&nbsp;solve&nbsp;this&nbsp;issue&nbsp;as&nbsp;well,&nbsp;but&nbsp;I'm&nbsp;still&nbsp;wondering&nbsp;if&nbsp;a)&nbsp;my&nbsp;observation&nbsp;is&nbsp;correct&nbsp;and&nbsp;b)&nbsp;if&nbsp;this&nbsp;is&nbsp;desired&nbsp;behaviour.&nbsp;Should&nbsp;a&nbsp;new&nbsp;node&nbsp;be&nbsp;partitioned&nbsp;from&nbsp;the&nbsp;others&nbsp;only&nbsp;temporarily,&nbsp;when&nbsp;it&nbsp;joins,&nbsp;it&nbsp;requires&nbsp;manual&nbsp;intervention&nbsp;to&nbsp;force&nbsp;it&nbsp;to&nbsp;join&nbsp;the&nbsp;cluster.&nbsp;This&nbsp;somewhat&nbsp;seems&nbsp;to&nbsp;conform&nbsp;to&nbsp;what&nbsp;the&nbsp;documentation&nbsp;says:&amp;nbsp;http://www.rabbitmq.com/clustering.html#auto-config,&nbsp;but&nbsp;I'm&nbsp;not&nbsp;entirely&nbsp;clear&nbsp;on&nbsp;whether&nbsp;a&nbsp;node&nbsp;just&nbsp;gives&nbsp;up&nbsp;trying&nbsp;to&nbsp;form&nbsp;a&nbsp;cluster&nbsp;once&nbsp;it&nbsp;couldn't&nbsp;reach&nbsp;any&nbsp;of&nbsp;the&nbsp;nodes&nbsp;in&nbsp;the&nbsp;cluster_nodes&nbsp;list.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;the&nbsp;question&nbsp;boils&nbsp;down&nbsp;to&nbsp;whether&nbsp;the&nbsp;automatic&nbsp;configuration&nbsp;is&nbsp;the&nbsp;way&nbsp;to&nbsp;go&nbsp;or&nbsp;if&nbsp;it&nbsp;makes&nbsp;more&nbsp;sense&nbsp;to&nbsp;automate&nbsp;commands&nbsp;(using&nbsp;Chef,&nbsp;btw)&nbsp;around&nbsp;the&nbsp;join_cluster&nbsp;and&nbsp;cluster_status&nbsp;commands.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;top&nbsp;of&nbsp;that,&nbsp;to&nbsp;have&nbsp;a&nbsp;fresh&nbsp;node&nbsp;join&nbsp;the&nbsp;cluster,&nbsp;it&nbsp;needs&nbsp;to&nbsp;be&nbsp;stopped&nbsp;again&nbsp;(stop_app)&nbsp;and&nbsp;reset,&nbsp;which&nbsp;somewhat&nbsp;boils&nbsp;down&nbsp;to&nbsp;the&nbsp;service&nbsp;being&nbsp;started&nbsp;on&nbsp;package&nbsp;installation&nbsp;again.&nbsp;This&nbsp;behaviour&nbsp;seems&nbsp;to&nbsp;also&nbsp;have&nbsp;changed&nbsp;from&nbsp;2.x&nbsp;where&nbsp;just&nbsp;updating&nbsp;the&nbsp;config&nbsp;and&nbsp;making&nbsp;sure&nbsp;all&nbsp;nodes&nbsp;have&nbsp;the&nbsp;same&nbsp;Erlang&nbsp;cookie&nbsp;is&nbsp;correct,&nbsp;right?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;the&nbsp;biggest&nbsp;question&nbsp;is:&nbsp;how&nbsp;do&nbsp;folks&nbsp;work&nbsp;around&nbsp;the&nbsp;fact&nbsp;that&nbsp;the&nbsp;RabbitMQ&nbsp;node&nbsp;is&nbsp;started&nbsp;up&nbsp;on&nbsp;package&nbsp;installation.&nbsp;There's&nbsp;the&nbsp;option&nbsp;to&nbsp;use&nbsp;policy-rc.d&nbsp;systems,&nbsp;but&nbsp;I'm&nbsp;not&nbsp;quite&nbsp;sure&nbsp;how&nbsp;feasible&nbsp;this&nbsp;is&nbsp;to&nbsp;automate.&nbsp;Given&nbsp;that&nbsp;Chef&nbsp;runs&nbsp;every&nbsp;30&nbsp;minutes&nbsp;or&nbsp;so,&nbsp;the&nbsp;consequence&nbsp;would&nbsp;be&nbsp;to&nbsp;install&nbsp;a&nbsp;policy&nbsp;on&nbsp;every&nbsp;run&nbsp;or&nbsp;to&nbsp;check&nbsp;on&nbsp;every&nbsp;run&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;desired&nbsp;package&nbsp;is&nbsp;already&nbsp;installed.&nbsp;Currently&nbsp;I'm&nbsp;stopping&nbsp;the&nbsp;service&nbsp;after&nbsp;stop_app&nbsp;and&nbsp;reset,&nbsp;before&nbsp;installing&nbsp;the&nbsp;new&nbsp;Erlang&nbsp;cookie.&nbsp;I'm&nbsp;just&nbsp;not&nbsp;sure,&nbsp;it&nbsp;feels&nbsp;a&nbsp;bit&nbsp;weird&nbsp;to&nbsp;automate&nbsp;to&nbsp;me.&nbsp;I'd&nbsp;love&nbsp;for&nbsp;some&nbsp;input&nbsp;or&nbsp;suggestions&nbsp;on&nbsp;this.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;current&nbsp;setup&nbsp;is&nbsp;working,&nbsp;and&nbsp;I&nbsp;can&nbsp;add&nbsp;nodes&nbsp;that&nbsp;automatically&nbsp;join&nbsp;the&nbsp;cluster,&nbsp;so&nbsp;it's&nbsp;okay.&nbsp;Just&nbsp;want&nbsp;to&nbsp;make&nbsp;sure&nbsp;it's&nbsp;the&nbsp;right&nbsp;approach,&nbsp;or&nbsp;if&nbsp;there&nbsp;are&nbsp;any&nbsp;other&nbsp;experiences&nbsp;on&nbsp;this.&nbsp;From&nbsp;what&nbsp;I&nbsp;understand&nbsp;there&nbsp;are&nbsp;differences&nbsp;to&nbsp;2.x&nbsp;cluster&nbsp;setup,&nbsp;where&nbsp;updating&nbsp;the&nbsp;config&nbsp;and&nbsp;changing&nbsp;the&nbsp;Erlang&nbsp;cookie&nbsp;apparently&nbsp;were&nbsp;all&nbsp;that's&nbsp;needed,&nbsp;but&nbsp;that's&nbsp;from&nbsp;my&nbsp;reading&nbsp;of&nbsp;the&nbsp;documentation&nbsp;and&nbsp;existing&nbsp;Chef&nbsp;cookbooks&nbsp;(https://github.com/opscode-cookbooks/rabbitmq).&nbsp;Overall&nbsp;I&nbsp;feel&nbsp;like&nbsp;there's&nbsp;a&nbsp;bit&nbsp;of&nbsp;a&nbsp;lack&nbsp;of&nbsp;documentation&nbsp;on&nbsp;how&nbsp;setting&nbsp;up&nbsp;a&nbsp;cluster&nbsp;can&nbsp;or&nbsp;should&nbsp;be&nbsp;automated.&nbsp;Happy&nbsp;to&nbsp;help&nbsp;improving&nbsp;that&nbsp;situation,&nbsp;but&nbsp;I'd&nbsp;like&nbsp;to&nbsp;sure&nbsp;that&nbsp;the&nbsp;choices&nbsp;described&nbsp;above&nbsp;are&nbsp;sane&nbsp;or&nbsp;completely&nbsp;bullocks.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Again,&nbsp;apologies&nbsp;for&nbsp;the&nbsp;long&nbsp;email.&nbsp;I&nbsp;hope&nbsp;the&nbsp;setup,&nbsp;issues&nbsp;and&nbsp;questions&nbsp;are&nbsp;somewhat&nbsp;clear.&nbsp;Please&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;more&nbsp;input&nbsp;is&nbsp;require,&nbsp;happy&nbsp;to&nbsp;dive&nbsp;into&nbsp;more&nbsp;detail.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;for&nbsp;your&nbsp;time,&nbsp;for&nbsp;RabbitMQ&nbsp;clustering,&nbsp;and&nbsp;for&nbsp;any&nbsp;feedback&nbsp;you&nbsp;might&nbsp;have&nbsp;:)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers,&nbsp;Mathias&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</tt>
