<tt>
&lt;font&nbsp;face=&quot;trebuchet&nbsp;ms,sans-serif&quot;&gt;Hi&nbsp;Simon,&nbsp;I&amp;#39;m&nbsp;confused&nbsp;as&nbsp;well.&nbsp;Please&nbsp;take&nbsp;my&nbsp;previous&nbsp;observation&nbsp;with&nbsp;a&nbsp;grain&nbsp;of&nbsp;salt&nbsp;as&nbsp;I&nbsp;was&nbsp;publishing&nbsp;somewhat&nbsp;big&nbsp;messages&nbsp;(100KB)&nbsp;at&nbsp;a&nbsp;rate&nbsp;that&nbsp;perhaps&nbsp;couldn&amp;#39;t&nbsp;be&nbsp;handled&nbsp;very&nbsp;well&nbsp;by&nbsp;the&nbsp;network.&nbsp;As&nbsp;soon&nbsp;as&nbsp;I&nbsp;reduced&nbsp;the&nbsp;size&nbsp;to&nbsp;one&nbsp;tenth&nbsp;everything&nbsp;started&nbsp;going&nbsp;more&nbsp;smoothly,&nbsp;for&nbsp;as&nbsp;long&nbsp;as&nbsp;something&nbsp;weird&nbsp;didn&amp;#39;t&nbsp;happen&nbsp;to&nbsp;the&nbsp;network.&nbsp;Here&amp;#39;s&nbsp;the&nbsp;test&nbsp;environment&nbsp;I&amp;#39;ve&nbsp;set&nbsp;up&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;issue:&nbsp;two&nbsp;physical&nbsp;machines&nbsp;connected&nbsp;each&nbsp;to&nbsp;a&nbsp;network&nbsp;switch&nbsp;(all&nbsp;devices&nbsp;are&nbsp;100Mb),&nbsp;with&nbsp;the&nbsp;two&nbsp;switches&nbsp;connected&nbsp;to&nbsp;each&nbsp;other.&nbsp;Of&nbsp;course&nbsp;B1&nbsp;and&nbsp;B2&nbsp;live&nbsp;on&nbsp;the&nbsp;two&nbsp;machines,&nbsp;respectively.&nbsp;A&nbsp;bunch&nbsp;of&nbsp;consumers&nbsp;on&nbsp;each&nbsp;side.&nbsp;I&amp;#39;m&nbsp;faking&nbsp;a&nbsp;network&nbsp;latency&nbsp;of&nbsp;a&nbsp;few&nbsp;hundreds&nbsp;of&nbsp;milliseconds &lt;/font&gt;&lt;span&nbsp;style=&quot;font-family:&amp;#39;trebuchet&nbsp;ms&amp;#39;,sans-serif&quot;&gt;via&nbsp;software,&nbsp;and&nbsp;publishing&nbsp;20&nbsp;msg/s&nbsp;of&nbsp;10&nbsp;kB&nbsp;each&nbsp;on&nbsp;one&nbsp;side&nbsp;of&nbsp;a&nbsp;bidirectional&nbsp;federation&nbsp;exchange&nbsp;seems&nbsp;to&nbsp;work&nbsp;fine. &lt;/span&gt;&lt;div&gt;<br>
<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&amp;#39;trebuchet&nbsp;ms&amp;#39;,sans-serif&quot;&gt;If&nbsp;I&nbsp;try&nbsp;disconnecting&nbsp;the&nbsp;network&nbsp;cable&nbsp;which&nbsp;connects&nbsp;the&nbsp;two&nbsp;switched&nbsp;and&nbsp;plug&nbsp;it&nbsp;back&nbsp;a&nbsp;few&nbsp;seconds&nbsp;later&nbsp;implies&nbsp;that&nbsp;the&nbsp;federated&nbsp;exchanges&nbsp;never&nbsp;catch&nbsp;up&nbsp;with&nbsp;the&nbsp;messages&nbsp;queued&nbsp;up&nbsp;so&nbsp;far,&nbsp;in&nbsp;particular&nbsp;the&nbsp;outgoing&nbsp;queue&nbsp;on&nbsp;the&nbsp;broker&nbsp;acting&nbsp;as&nbsp;the&nbsp;downstream&nbsp;in&nbsp;this&nbsp;scenario&nbsp;(the&nbsp;one&nbsp;whose&nbsp;messages&nbsp;would&nbsp;then&nbsp;be&nbsp;discarded&nbsp;by&nbsp;the&nbsp;plugin&nbsp;once&nbsp;back&nbsp;to&nbsp;the&nbsp;publisher&nbsp;side)&nbsp;seems&nbsp;to&nbsp;not&nbsp;be&nbsp;emptied&nbsp;by&nbsp;anyone&nbsp;anymore.&lt;/span&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&amp;#39;trebuchet&nbsp;ms&amp;#39;,sans-serif&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&amp;#39;trebuchet&nbsp;ms&amp;#39;,sans-serif&quot;&gt;One&nbsp;other&nbsp;thing&nbsp;I&nbsp;noticed&nbsp;during&nbsp;the&nbsp;failure&nbsp;in&nbsp;the&nbsp;production&nbsp;environment&nbsp;is&nbsp;that&nbsp;if&nbsp;I&nbsp;deleted&nbsp;this&nbsp;automatically&nbsp;created&nbsp;queue&nbsp;(i.e.&nbsp;the&nbsp;queue&nbsp;B2&nbsp;-&amp;gt;&nbsp;B1,&nbsp;with&nbsp;B1&nbsp;being&nbsp;the&nbsp;originator&nbsp;of&nbsp;the&nbsp;messages),&nbsp;affected&nbsp;the&nbsp;queue&nbsp;B1&nbsp;-&amp;gt;&nbsp;B2,&nbsp;which&nbsp;from&nbsp;a&nbsp;slow&nbsp;delivery&nbsp;rate&nbsp;stopped&nbsp;completely.&nbsp;Now,&nbsp;as&nbsp;far&nbsp;as&nbsp;my&nbsp;understanding&nbsp;goes&nbsp;each&nbsp;direction&nbsp;of&nbsp;an&nbsp;exchange&nbsp;federated&nbsp;between&nbsp;two&nbsp;brokers&nbsp;in&nbsp;both&nbsp;directions&nbsp;should&nbsp;be&nbsp;independent&nbsp;of&nbsp;the&nbsp;other,&nbsp;but&nbsp;I&nbsp;experienced&nbsp;exactly&nbsp;this,&nbsp;and&nbsp;given&nbsp;that&nbsp;a&nbsp;unidirectionally&nbsp;federated&nbsp;exchange&nbsp;under&nbsp;the&nbsp;same&nbsp;conditions&nbsp;described&nbsp;above&nbsp;works&nbsp;just&nbsp;fine&nbsp;I&nbsp;am&nbsp;wondering&nbsp;whether&nbsp;connecting&nbsp;two&nbsp;exchanges&nbsp;in&nbsp;this&nbsp;way&nbsp;implies&nbsp;some&nbsp;weird&nbsp;behavior&nbsp;in&nbsp;which&nbsp;each&nbsp;side&nbsp;influences&nbsp;the&nbsp;other&nbsp;in&nbsp;a&nbsp;sort&nbsp;of&nbsp;cascading&nbsp;behavior&nbsp;which&nbsp;leads&nbsp;to&nbsp;a&nbsp;deadlock. &lt;/span&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&amp;#39;trebuchet&nbsp;ms&amp;#39;,sans-serif&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&amp;#39;trebuchet&nbsp;ms&amp;#39;,sans-serif&quot;&gt;Although&nbsp;unlikely&nbsp;to&nbsp;be&nbsp;the&nbsp;cause&nbsp;of&nbsp;this,&nbsp;I&amp;#39;m&nbsp;wondering&nbsp;if&nbsp;using&nbsp;prefetch-count,&nbsp;which&nbsp;I&amp;#39;m&nbsp;using,&nbsp;could&nbsp;lead&nbsp;to&nbsp;this&nbsp;behavior.&nbsp;For&nbsp;example&nbsp;after&nbsp;the&nbsp;network&nbsp;bounce&nbsp;mentioned&nbsp;above&nbsp;the&nbsp;prefetch&nbsp;count&nbsp;was&nbsp;reached&nbsp;on&nbsp;both&nbsp;sides,&nbsp;so&nbsp;no&nbsp;more&nbsp;deliveries&nbsp;would&nbsp;be&nbsp;done&nbsp;until&nbsp;acks&nbsp;arrived&nbsp;from&nbsp;the&nbsp;other&nbsp;side.&nbsp;Might&nbsp;it&nbsp;happen&nbsp;that&nbsp;this&nbsp;could&nbsp;imply&nbsp;a&nbsp;deadlock&nbsp;in&nbsp;which&nbsp;each&nbsp;side&nbsp;is&nbsp;waiting&nbsp;for&nbsp;the&nbsp;other&nbsp;to&nbsp;send&nbsp;acknowledges&nbsp;before&nbsp;sending&nbsp;anymore&nbsp;messages?&lt;/span&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Mar&nbsp;20,&nbsp;2012&nbsp;at&nbsp;13:21,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;19/03/12&nbsp;14:00,&nbsp;Busoli,&nbsp;Simone&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Hi&nbsp;Simon,&nbsp;I&nbsp;think&nbsp;I&amp;#39;ve&nbsp;mostly&nbsp;tracked&nbsp;down&nbsp;the&nbsp;issue&nbsp;to&nbsp;the&nbsp;symmetric&lt;br&gt;<br>
setup&nbsp;of&nbsp;the&nbsp;federated&nbsp;exchanges&nbsp;between&nbsp;the&nbsp;two&nbsp;brokers.&nbsp;I&nbsp;noticed&lt;br&gt;<br>
that&nbsp;whenever&nbsp;I&nbsp;start&nbsp;publishing&nbsp;messages&nbsp;to&nbsp;an&nbsp;exchange&nbsp;configured&lt;br&gt;<br>
that&nbsp;way&nbsp;the&nbsp;network&nbsp;starts&nbsp;behaving&nbsp;in&nbsp;surprisingly&nbsp;ways.&nbsp;For&lt;br&gt;<br>
instance,&nbsp;I&nbsp;can&nbsp;no&nbsp;longer&nbsp;get&nbsp;two&nbsp;machines&nbsp;connected&nbsp;directly&nbsp;by&nbsp;two&lt;br&gt;<br>
network&nbsp;switches&nbsp;to&nbsp;ping&nbsp;each&nbsp;other.&nbsp;Stop&nbsp;publishing&nbsp;messages&nbsp;and&lt;br&gt;<br>
everything&nbsp;goes&nbsp;back&nbsp;to&nbsp;a&nbsp;normal&nbsp;state.&nbsp;A&nbsp;federated&nbsp;exchange&nbsp;which&lt;br&gt;<br>
goes&nbsp;in&nbsp;one&nbsp;direction&nbsp;only&nbsp;as&nbsp;well&nbsp;as&nbsp;a&nbsp;shovel&nbsp;instead&nbsp;behave&nbsp;just&lt;br&gt;<br>
fine.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
I&nbsp;am&nbsp;very&nbsp;confused&nbsp;by&nbsp;this.&lt;br&gt;<br>
&lt;br&gt;<br>
Really,&nbsp;nothing&nbsp;the&nbsp;federation&nbsp;plugin&nbsp;does&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;stop&nbsp;ICMP&nbsp;pings&nbsp;from&nbsp;working,&nbsp;it&amp;#39;s&nbsp;just&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;after&nbsp;all.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;only&nbsp;thing&nbsp;I&nbsp;can&nbsp;think&nbsp;of&nbsp;is&nbsp;that&nbsp;somehow&nbsp;federation&nbsp;is&nbsp;going&nbsp;mad&nbsp;and&nbsp;flooding&nbsp;the&nbsp;link&nbsp;with&nbsp;traffic&nbsp;-&nbsp;but&nbsp;I&amp;#39;m&nbsp;sure&nbsp;you&nbsp;would&nbsp;have&nbsp;noticed&nbsp;that.&nbsp;And&nbsp;pings&nbsp;should&nbsp;still&nbsp;get&nbsp;through&nbsp;anyway.&lt;br&gt;<br>
&lt;br&gt;<br>
Does&nbsp;wireshark&nbsp;/&nbsp;tcpdump&nbsp;/&nbsp;etc&nbsp;show&nbsp;anything&nbsp;unusual?&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&nbsp;Simon&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
--&nbsp;&lt;br&gt;<br>
Simon&nbsp;MacMullen&lt;br&gt;<br>
RabbitMQ,&nbsp;VMware&lt;br&gt;<br>
______________________________&lt;u&gt;&lt;/u&gt;_________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rabbitmq-discuss@lists.&lt;u&gt;&lt;/u&gt;rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/&lt;u&gt;&lt;/u&gt;cgi-bin/mailman/listinfo/&lt;u&gt;&lt;/u&gt;rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
