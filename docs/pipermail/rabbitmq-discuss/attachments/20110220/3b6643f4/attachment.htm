<tt>
&lt;div&gt;I&amp;#39;d&nbsp;do&nbsp;a&nbsp;few&nbsp;things:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Since&nbsp;you&amp;#39;re&nbsp;using&nbsp;0.5.2,&nbsp;I&amp;#39;d&nbsp;use&nbsp;the&nbsp;SimpleReconnectionStrategy&nbsp;handler&nbsp;and&nbsp;instead&nbsp;of&nbsp;extending&nbsp;the&nbsp;class&nbsp;like&nbsp;you&nbsp;are&nbsp;instead&nbsp;create&nbsp;a&nbsp;on_connected&nbsp;method&nbsp;in&nbsp;your&nbsp;app,&nbsp;utilizing&nbsp;the&nbsp;Connection.addStateChangeHandler()&nbsp;method&nbsp;to&nbsp;be&nbsp;notified&nbsp;when&nbsp;you&nbsp;are&nbsp;connected,&nbsp;and&nbsp;in&nbsp;this&nbsp;event&nbsp;handler&nbsp;do&nbsp;all&nbsp;of&nbsp;your&nbsp;setup.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;was&nbsp;a&nbsp;bug&nbsp;report&nbsp;on&nbsp;the&nbsp;0.5.2&nbsp;branch&nbsp;with&nbsp;the&nbsp;reconnection&nbsp;handler&nbsp;system.&nbsp;I&nbsp;did&nbsp;not&nbsp;trace&nbsp;that&nbsp;back,&nbsp;however.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;You&nbsp;might&nbsp;be&nbsp;better&nbsp;served&nbsp;to&nbsp;check&nbsp;out&nbsp;the&nbsp;current&nbsp;version,&nbsp;as&nbsp;I&nbsp;have&nbsp;tested&nbsp;the&nbsp;SRS&nbsp;pretty&nbsp;extensively,&nbsp;including&nbsp;cases&nbsp;where&nbsp;the&nbsp;server&nbsp;goes&nbsp;away&nbsp;and&nbsp;comes&nbsp;back.&nbsp; If&nbsp;you&nbsp;use&nbsp;0.9.3&nbsp;(or&nbsp;the&nbsp;soon&nbsp;to&nbsp;be&nbsp;released&nbsp;0.94)&nbsp;instead&nbsp;of&nbsp;the&nbsp;single&nbsp;callback&nbsp;function&nbsp;with&nbsp;a&nbsp;bool&nbsp;flag&nbsp;in&nbsp;0.5.2,&nbsp;it&nbsp;has&nbsp;a&nbsp;callback&nbsp;handler&nbsp;split&nbsp;out&nbsp;for&nbsp;each&nbsp;state:&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Connection.add_on_close_callback(callback)&lt;/div&gt;&lt;div&gt;Connection.add_on_open_callback(callback)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;either&nbsp;version,&nbsp;I&nbsp;would&nbsp;suggest&nbsp;that&nbsp;the&nbsp;reconnection&nbsp;strategy&nbsp;class&nbsp;is&nbsp;not&nbsp;the&nbsp;right&nbsp;place&nbsp;to&nbsp;handle&nbsp;your&nbsp;post-connection&nbsp;setup.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;Regards,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Gavin&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Feb&nbsp;20,&nbsp;2011&nbsp;at&nbsp;7:13&nbsp;PM,&nbsp;Jason&nbsp;J.&nbsp;W.&nbsp;Williams&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:jasonjwwilliams@gmail.com&quot;&gt;jasonjwwilliams@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;BTW&nbsp;this&nbsp;problem&nbsp;only&nbsp;seems&nbsp;to&nbsp;occur&nbsp;when&nbsp;rabbit@Phantome&nbsp;is&nbsp;restarted&lt;br&gt;<br>
while&nbsp;the&nbsp;consumer&nbsp;is&nbsp;connected&nbsp;to&nbsp;it.&nbsp;Reconnections&nbsp;occur&nbsp;properly&lt;br&gt;<br>
when&nbsp;restarting&nbsp;rabbit_1@Phantome&nbsp;and&nbsp;rabbit_2@Phantome&nbsp;while&nbsp;the&lt;br&gt;<br>
consumer&nbsp;is&nbsp;connected.&lt;br&gt;<br>
&lt;br&gt;<br>
Status&nbsp;of&nbsp;node&nbsp;rabbit_1@Phantome&nbsp;...&lt;br&gt;<br>
[{running_applications,[{rabbit,&amp;quot;RabbitMQ&amp;quot;,&amp;quot;2.3.0&amp;quot;},&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {mnesia,&amp;quot;MNESIA&nbsp; CXC&nbsp;138&nbsp;12&amp;quot;,&amp;quot;4.4.16&amp;quot;},&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {os_mon,&amp;quot;CPO&nbsp; CXC&nbsp;138&nbsp;46&amp;quot;,&amp;quot;2.2.5&amp;quot;},&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {sasl,&amp;quot;SASL&nbsp; CXC&nbsp;138&nbsp;11&amp;quot;,&amp;quot;2.1.9.2&amp;quot;},&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {stdlib,&amp;quot;ERTS&nbsp; CXC&nbsp;138&nbsp;10&amp;quot;,&amp;quot;1.17.2&amp;quot;},&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {kernel,&amp;quot;ERTS&nbsp; CXC&nbsp;138&nbsp;10&amp;quot;,&amp;quot;2.14.2&amp;quot;}]},&lt;br&gt;<br>
 {nodes,[{disc,[rabbit_1@Phantome,rabbit@Phantome]},&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ram,[rabbit_2@Phantome]}]},&lt;br&gt;<br>
 {running_nodes,[rabbit@Phantome,rabbit_2@Phantome,rabbit_1@Phantome]}]&lt;br&gt;<br>
...done.&lt;br&gt;<br>
&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
-J&lt;br&gt;<br>
&lt;/font&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
On&nbsp;Sun,&nbsp;Feb&nbsp;20,&nbsp;2011&nbsp;at&nbsp;5:04&nbsp;PM,&nbsp;Jason&nbsp;J.&nbsp;W.&nbsp;Williams&lt;br&gt;<br>
&amp;lt;&lt;a&nbsp;href=&quot;mailto:jasonjwwilliams@gmail.com&quot;&gt;jasonjwwilliams@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&nbsp;Hi&nbsp;Guys,&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Having&nbsp;some&nbsp;issues&nbsp;with&nbsp;a&nbsp;test&nbsp;cluster&nbsp;setup.&nbsp;It&amp;#39;s&nbsp;a&nbsp;3-node&nbsp;cluster&lt;br&gt;<br>
&amp;gt;&nbsp;with&nbsp;2-disk&nbsp;and&nbsp;1-RAM&nbsp;nodes.&nbsp;The&nbsp;RAM&nbsp;node&nbsp;is&nbsp;joined&nbsp;to&nbsp;both&nbsp;disk&lt;br&gt;<br>
&amp;gt;&nbsp;nodes.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;rabbit@Phantome&nbsp;-&nbsp;disk&lt;br&gt;<br>
&amp;gt;&nbsp;rabbit_1@Phantome&nbsp;-&nbsp;disk&lt;br&gt;<br>
&amp;gt;&nbsp;rabbit_2@Phantome&nbsp;-&nbsp;RAM&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;In&nbsp;front&nbsp;of&nbsp;the&nbsp;cluster&nbsp;is&nbsp;an&nbsp;HAProxy&nbsp;instance&nbsp;listening&nbsp;on&nbsp;port&nbsp;5670&lt;br&gt;<br>
&amp;gt;&nbsp;doing&nbsp;simple&nbsp;round-robin&nbsp;TCP&nbsp;load&nbsp;balancing&nbsp;between&nbsp;the&nbsp;cluster&lt;br&gt;<br>
&amp;gt;&nbsp;members.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;As&nbsp;long&nbsp;as&nbsp;all&nbsp;the&nbsp;nodes&nbsp;are&nbsp;running&nbsp;I&nbsp;can&nbsp;have&nbsp;my&nbsp;consumer&nbsp;connect&lt;br&gt;<br>
&amp;gt;&nbsp;through&nbsp;the&nbsp;load&nbsp;balancer&nbsp;to&nbsp;any&nbsp;node&nbsp;and&nbsp;successfully&nbsp;consume.&lt;br&gt;<br>
&amp;gt;&nbsp;Likewise&nbsp;with&nbsp;the&nbsp;producer.&nbsp;However,&nbsp;when&nbsp;I&nbsp;shutdown&nbsp;the&nbsp;node&nbsp;the&lt;br&gt;<br>
&amp;gt;&nbsp;consumer&nbsp;is&nbsp;currently&nbsp;connected&nbsp;to&nbsp;and&nbsp;allow&nbsp;Pika&nbsp;to&nbsp;do&nbsp;the&lt;br&gt;<br>
&amp;gt;&nbsp;reconnection,&nbsp;I&nbsp;get&nbsp;this&nbsp;error:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;error:&nbsp;uncaptured&nbsp;python&nbsp;exception,&nbsp;closing&nbsp;channel&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;lt;pika.asyncore_adapter.RabbitDispatcher&nbsp;connected&nbsp;at&nbsp;0x632350&amp;gt;&nbsp;(&amp;lt;class&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;pika.exceptions.ChannelClosed&amp;#39;&amp;gt;:Connection.Close(class_id&nbsp;=&nbsp;0,&lt;br&gt;<br>
&amp;gt;&nbsp;method_id&nbsp;=&nbsp;0,&nbsp;reply_code&nbsp;=&nbsp;541,&nbsp;reply_text&nbsp;=&nbsp;&amp;#39;INTERNAL_ERROR&amp;#39;)&lt;br&gt;<br>
&amp;gt;&nbsp;[/System/Library/Frameworks/Python.framework/Versions/2.6/lib/python2.6/asyncore.py|read|74]&lt;br&gt;<br>
&amp;gt;&nbsp;[/System/Library/Frameworks/Python.framework/Versions/2.6/lib/python2.6/asyncore.py|handle_read_event|413]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/asyncore_adapter.py|handle_read|86]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/connection.py|on_data_available|268]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/connection.py|_login2|375]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/connection.py|handle_connection_open|201]&lt;br&gt;<br>
&amp;gt;&nbsp;[cluster_test_consumer.py|on_connection_open|53]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/spec.py|queue_declare|3003]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/channel.py|_rpc|187]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/connection.py|_rpc|326]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/channel.py|wait_for_reply|125]&lt;br&gt;<br>
&amp;gt;&nbsp;[build/bdist.macosx-10.6-universal/egg/pika/channel.py|_ensure|84])&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Every&nbsp;few&nbsp;seconds&nbsp;Pika&nbsp;will&nbsp;attempt&nbsp;to&nbsp;reconnect&nbsp;the&nbsp;consumer&nbsp;and&nbsp;the&lt;br&gt;<br>
&amp;gt;&nbsp;error&nbsp;repeats.&nbsp;The&nbsp;only&nbsp;unusual&nbsp;error&nbsp;in&nbsp;the&nbsp;Rabbit&nbsp;logs&nbsp;occurs&nbsp;on&nbsp;the&lt;br&gt;<br>
&amp;gt;&nbsp;first&nbsp;reconnection:&nbsp;&lt;a&nbsp;href=&quot;https://gist.github.com/836441&quot;&nbsp;target=&quot;_blank&quot;&gt;https://gist.github.com/836441&lt;/a&gt;&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;time&nbsp;during&nbsp;these&nbsp;errors&nbsp;the&nbsp;logs&nbsp;look&nbsp;like&nbsp;this:&lt;br&gt;<br>
&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;https://gist.github.com/836442&quot;&nbsp;target=&quot;_blank&quot;&gt;https://gist.github.com/836442&lt;/a&gt;&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;consumer&nbsp;is&nbsp;disconnecting&nbsp;and&nbsp;reconnecting&nbsp;to&nbsp;HAProxy&nbsp;because&nbsp;the&lt;br&gt;<br>
&amp;gt;&nbsp;stats&nbsp;show&nbsp;the&nbsp;connection&nbsp;moving&nbsp;between&nbsp;backend&nbsp;nodes.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;producer&nbsp;continues&nbsp;to&nbsp;operate&nbsp;correctly&nbsp;through&nbsp;the&nbsp;load&nbsp;balancer.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Consumer&nbsp;code&nbsp;is&nbsp;here:&nbsp;&lt;a&nbsp;href=&quot;https://gist.github.com/836445&quot;&nbsp;target=&quot;_blank&quot;&gt;https://gist.github.com/836445&lt;/a&gt;&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Any&nbsp;help/ideas&nbsp;are&nbsp;greatly&nbsp;appreciated.&nbsp; Thank&nbsp;you&nbsp;in&nbsp;advance.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;-J&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
rabbitmq-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:rabbitmq-discuss@lists.rabbitmq.com&quot;&gt;rabbitmq-discuss@lists.rabbitmq.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
