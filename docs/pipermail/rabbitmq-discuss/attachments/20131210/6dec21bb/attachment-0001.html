<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;There&nbsp;ought&nbsp;to&nbsp;be&nbsp;further&nbsp;information&nbsp;in&nbsp;the&nbsp;log&nbsp;files&nbsp;from&nbsp;the&nbsp;brokers&nbsp;in&nbsp;question&nbsp;during&nbsp;the&nbsp;stop&nbsp;operation.&nbsp;Can&nbsp;you&nbsp;post&nbsp;that,&nbsp;or&nbsp;put&nbsp;it&nbsp;somewhere&nbsp;accessible&nbsp;please?&nbsp;Why&nbsp;do&nbsp;you&nbsp;have&nbsp;both&nbsp;`rabbitmq-server&nbsp;stop'&nbsp;and&nbsp;`rabbitmqctl&nbsp;stop'&nbsp;running&nbsp;at&nbsp;the&nbsp;same&nbsp;time?&nbsp;Are&nbsp;those&nbsp;pointing&nbsp;to&nbsp;different&nbsp;rabbits?&nbsp;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;10&nbsp;Dec&nbsp;2013,&nbsp;at&nbsp;01:32,&nbsp;Tyrrill,&nbsp;Ed&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-size:&nbsp;14px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;Hi&nbsp;All,&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;We&nbsp;are&nbsp;using&nbsp;rabbitmq-server&nbsp;rpms&nbsp;on&nbsp;linux.&nbsp;&nbsp;Recently&nbsp;we&nbsp;upgraded&nbsp;from&nbsp;3.1.1-1&nbsp;to&nbsp;3.2.0-1,&nbsp;and&nbsp;we&nbsp;are&nbsp;seeing&nbsp;intermittent&nbsp;hangs&nbsp;when&nbsp;stopping&nbsp;rabbitmq.&nbsp;&nbsp;Here&nbsp;is&nbsp;the&nbsp;ps&nbsp;output:&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Courier&quot;&gt;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;31052&nbsp;31051&nbsp;&nbsp;0&nbsp;Dec06&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00:00:00&nbsp;/bin/sh&nbsp;/sbin/service&nbsp;rabbitmq-server&nbsp;stop&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Courier&quot;&gt;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;31055&nbsp;31052&nbsp;&nbsp;0&nbsp;Dec06&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00:00:00&nbsp;/bin/sh&nbsp;/etc/init.d/rabbitmq-server&nbsp;stop&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Courier&quot;&gt;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;31100&nbsp;31055&nbsp;&nbsp;0&nbsp;Dec06&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00:00:00&nbsp;/bin/sh&nbsp;/usr/sbin/rabbitmqctl&nbsp;stop&nbsp;/var/run/rabbitmq/pid&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Courier&quot;&gt;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;31111&nbsp;31100&nbsp;&nbsp;0&nbsp;Dec06&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00:00:00&nbsp;su&nbsp;rabbitmq&nbsp;-s&nbsp;/bin/sh&nbsp;-c&nbsp;/usr/lib/rabbitmq/bin/rabbitmqctl&nbsp;&nbsp;&quot;stop&quot;&nbsp;&quot;/var/run/rabbitmq/pid&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Courier&quot;&gt;rabbitmq&nbsp;31112&nbsp;31111&nbsp;&nbsp;0&nbsp;Dec06&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00:24:10&nbsp;/usr/lib64/erlang/erts-5.10.3/bin/beam.smp&nbsp;--&nbsp;-root&nbsp;/usr/lib64/erlang&nbsp;-progname&nbsp;erl&nbsp;--&nbsp;-home&nbsp;/var/lib/rabbitmq&nbsp;--&nbsp;-pa&nbsp;/usr&lt;/font&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;Courier;&nbsp;&quot;&gt;/lib/rabbitmq/lib/rabbitmq_server-3.2.0/sbin/../ebin&nbsp;-noshell&nbsp;-noinput&nbsp;-hidden&nbsp;-sname&nbsp;rabbitmqctl31112&nbsp;-boot&nbsp;start_clean&nbsp;-s&nbsp;rabbit_control_main&nbsp;-nodename&nbsp;rabbit@vm-ave29&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;Courier;&nbsp;&quot;&gt;-extra&nbsp;stop&nbsp;/var/run/rabbitmq/pid&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;The&nbsp;CPU&nbsp;time&nbsp;column&nbsp;on&nbsp;the&nbsp;erlang&nbsp;process&nbsp;does&nbsp;slowly&nbsp;go&nbsp;up.&nbsp;&nbsp;I&nbsp;don't&nbsp;know&nbsp;if&nbsp;it&nbsp;plays&nbsp;a&nbsp;factor,&nbsp;but&nbsp;this&nbsp;broker&nbsp;has&nbsp;shovels&nbsp;defined&nbsp;to&nbsp;a&nbsp;remote&nbsp;broker,&nbsp;and&nbsp;the&nbsp;remote&nbsp;broker&nbsp;was&nbsp;down&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;this&nbsp;stop.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;How&nbsp;long&nbsp;do&nbsp;these&nbsp;hangs&nbsp;take?&nbsp;The&nbsp;shovel&nbsp;workers&nbsp;will&nbsp;wait&nbsp;10&nbsp;seconds&nbsp;for&nbsp;both&nbsp;their&nbsp;inbound&nbsp;and&nbsp;outbound&nbsp;connections&nbsp;to&nbsp;close&nbsp;cleanly.&nbsp;If&nbsp;you&nbsp;examine&nbsp;the&nbsp;log&nbsp;files&nbsp;for&nbsp;both&nbsp;the&nbsp;source&nbsp;and&nbsp;destination&nbsp;(i.e.,&nbsp;remote)&nbsp;brokers&nbsp;during&nbsp;the&nbsp;shutdown,&nbsp;there&nbsp;may&nbsp;be&nbsp;some&nbsp;useful&nbsp;indication&nbsp;of&nbsp;whether&nbsp;this&nbsp;is&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;problem&nbsp;or&nbsp;not.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-size:&nbsp;14px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;Is&nbsp;this&nbsp;a&nbsp;known&nbsp;issue?&nbsp;&nbsp;We've&nbsp;been&nbsp;seeing&nbsp;this&nbsp;a&nbsp;couple&nbsp;times&nbsp;a&nbsp;week&nbsp;(over&nbsp;&gt;&nbsp;100&nbsp;brokers),&nbsp;and&nbsp;I&nbsp;need&nbsp;to&nbsp;get&nbsp;a&nbsp;fix&nbsp;for&nbsp;this.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;sans-serif;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;fixed&nbsp;bugs&nbsp;with&nbsp;shutdown&nbsp;delays&nbsp;and&nbsp;deadlocks&nbsp;in&nbsp;the&nbsp;past,&nbsp;but&nbsp;they're&nbsp;mostly&nbsp;dusted&nbsp;and&nbsp;released&nbsp;now.&nbsp;We&nbsp;do&nbsp;have&nbsp;an&nbsp;open&nbsp;issue&nbsp;that&nbsp;can&nbsp;cause&nbsp;long&nbsp;delays&nbsp;during&nbsp;broker&nbsp;shutdown,&nbsp;which&nbsp;is&nbsp;mediated&nbsp;by&nbsp;having&nbsp;a&nbsp;lot&nbsp;of&nbsp;durable&nbsp;queues&nbsp;(regardless&nbsp;of&nbsp;whether&nbsp;they&nbsp;contain&nbsp;messages&nbsp;or&nbsp;not).&nbsp;Could&nbsp;that&nbsp;be&nbsp;what&nbsp;you're&nbsp;seeing?&nbsp;How&nbsp;many&nbsp;durable&nbsp;queues&nbsp;do&nbsp;these&nbsp;brokers&nbsp;have&nbsp;running&nbsp;on&nbsp;them?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Tim&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
