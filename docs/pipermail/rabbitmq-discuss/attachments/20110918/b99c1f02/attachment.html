<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;Massimo,&lt;div&gt;After&nbsp;quite&nbsp;a&nbsp;&amp;nbsp;time&nbsp;of&nbsp;trials&nbsp;and&nbsp;tribulations&nbsp;I&nbsp;have&nbsp;found&nbsp;a&nbsp;bug&amp;nbsp;&lt;/div&gt;&lt;div&gt;in&nbsp;the&nbsp;RabbitMQ&nbsp;STOMP&nbsp;adapter&nbsp;which&nbsp;appears&nbsp;to&nbsp;cause&amp;nbsp;&lt;/div&gt;&lt;div&gt;crashes&nbsp;under&nbsp;high&nbsp;message&nbsp;load.&lt;/div&gt;&lt;div&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;The&nbsp;bug&nbsp;is&nbsp;related&nbsp;to&nbsp;the&nbsp;(rather&nbsp;primitive)&nbsp;throttling&nbsp;which&amp;nbsp;&lt;/div&gt;&lt;div&gt;kicks&nbsp;in&nbsp;when&nbsp;reaching&nbsp;the&nbsp;memory&nbsp;limit.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;fixing&nbsp;this,&nbsp;I&nbsp;have&nbsp;successfully&nbsp;run&nbsp;your&nbsp;testcase,&nbsp;and&amp;nbsp;&lt;/div&gt;&lt;div&gt;RabbitMQ&nbsp;STOMP&nbsp;does&nbsp;manage&nbsp;to&nbsp;survive&nbsp;during&nbsp;the&nbsp;throwing&amp;nbsp;&lt;/div&gt;&lt;div&gt;away&nbsp;of&nbsp;large&nbsp;numbers&nbsp;of&nbsp;unsubscribed&nbsp;topic&nbsp;SENDs.&nbsp;I&nbsp;had&nbsp;to&amp;nbsp;&lt;/div&gt;&lt;div&gt;make&nbsp;one&nbsp;alteration&nbsp;to&nbsp;the&nbsp;configuration&nbsp;in&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;test&amp;nbsp;&lt;/div&gt;&lt;div&gt;to&nbsp;stay&nbsp;up.&nbsp;I&nbsp;set&nbsp;the&nbsp;vm_high_watermark&nbsp;to&nbsp;0.2&nbsp;(instead&nbsp;of&nbsp;the&amp;nbsp;&lt;/div&gt;&lt;div&gt;default&nbsp;of&nbsp;0.4).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;setting&nbsp;determines&nbsp;the&nbsp;proportion&nbsp;of&nbsp;available&nbsp;memory&amp;nbsp;&lt;/div&gt;&lt;div&gt;above&nbsp;which&nbsp;the&nbsp;'memory-alarm'&nbsp;is&nbsp;triggered.&nbsp;The&nbsp;reader&amp;nbsp;&lt;/div&gt;&lt;div&gt;process&nbsp;in&nbsp;RabbitMQ-STOMP&nbsp;will&nbsp;then&nbsp;block&nbsp;processing&amp;nbsp;&lt;/div&gt;&lt;div&gt;further&nbsp;bytes&nbsp;from&nbsp;clients,&nbsp;until&nbsp;the&nbsp;memory&nbsp;alarm&nbsp;is&nbsp;switched&amp;nbsp;&lt;/div&gt;&lt;div&gt;off.&nbsp;&amp;nbsp;Because&nbsp;message&nbsp;processing&nbsp;is&nbsp;proceeding&nbsp;at&nbsp;a&nbsp;very&amp;nbsp;&lt;/div&gt;&lt;div&gt;high&nbsp;rate&nbsp;(that&nbsp;is&nbsp;why&nbsp;memory&nbsp;is&nbsp;being&nbsp;used&nbsp;up),&nbsp;the&amp;nbsp;&lt;/div&gt;&lt;div&gt;input-queues&nbsp;for&nbsp;Erlang&nbsp;processes&nbsp;are&nbsp;likely&nbsp;to&nbsp;be&nbsp;large,&amp;nbsp;&lt;/div&gt;&lt;div&gt;and&nbsp;so&nbsp;even&nbsp;blocking&nbsp;input&nbsp;will&nbsp;not&nbsp;result&nbsp;in&nbsp;a&nbsp;lowering&nbsp;of&amp;nbsp;&lt;/div&gt;&lt;div&gt;memory&nbsp;consumption&nbsp;--&nbsp;memory&nbsp;requirements&nbsp;increase&nbsp;in&amp;nbsp;&lt;/div&gt;&lt;div&gt;the&nbsp;pipeline&nbsp;flow&nbsp;--&nbsp;and&nbsp;so&nbsp;the&nbsp;actual&nbsp;memory&nbsp;consumed&nbsp;is&amp;nbsp;&lt;/div&gt;&lt;div&gt;likely&nbsp;to&nbsp;reach&nbsp;0.6/0.7&nbsp;of&nbsp;available&nbsp;memory&nbsp;(found&nbsp;by&nbsp;observation).&nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;why&nbsp;setting&nbsp;it&nbsp;to&nbsp;0.4&nbsp;(the&nbsp;default)&nbsp;doesn't&nbsp;work.&nbsp;&amp;nbsp;Memory&amp;nbsp;&lt;/div&gt;&lt;div&gt;for&nbsp;Erlang&nbsp;can&nbsp;then&nbsp;be&nbsp;completely&nbsp;exhausted,&nbsp;resulting&nbsp;in&amp;nbsp;&lt;/div&gt;&lt;div&gt;crashes&nbsp;(which&nbsp;normally&nbsp;result&nbsp;in&nbsp;long&nbsp;pauses&nbsp;and&nbsp;large&amp;nbsp;&lt;/div&gt;&lt;div&gt;amounts&nbsp;of&nbsp;dump-data&nbsp;written&nbsp;to&nbsp;disk).&nbsp;Any&nbsp;recovery&nbsp;after&amp;nbsp;&lt;/div&gt;&lt;div&gt;that&nbsp;is&nbsp;likely&nbsp;not&nbsp;to&nbsp;succeed&nbsp;for&nbsp;very&nbsp;long,&nbsp;since&nbsp;the&nbsp;pause&amp;nbsp;&lt;/div&gt;&lt;div&gt;allows&nbsp;time&nbsp;for&nbsp;more&nbsp;requests&nbsp;to&nbsp;be&nbsp;put&nbsp;in.&nbsp;(The&nbsp;benchmark&amp;nbsp;&lt;/div&gt;&lt;div&gt;test&nbsp;runs&nbsp;with&nbsp;non-blocking&nbsp;io;&nbsp;I'm&nbsp;not&nbsp;sure&nbsp;what&nbsp;that&nbsp;means,&amp;nbsp;&lt;/div&gt;&lt;div&gt;but&nbsp;if&nbsp;it&nbsp;means&nbsp;that&nbsp;requests&nbsp;will&nbsp;be&nbsp;put&nbsp;in&nbsp;even&nbsp;if&nbsp;the&nbsp;socket&amp;nbsp;&lt;/div&gt;&lt;div&gt;blocks&nbsp;then&nbsp;this&nbsp;is&nbsp;going&nbsp;to&nbsp;increase&nbsp;the&nbsp;load&nbsp;during&nbsp;the&amp;nbsp;&lt;/div&gt;&lt;div&gt;pauses.)&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;webkit-block-placeholder&quot;&gt;&lt;/div&gt;&lt;div&gt;As&nbsp;I&nbsp;say,&nbsp;setting&nbsp;it&nbsp;to&nbsp;0.2&nbsp;worked,&nbsp;and&nbsp;I&nbsp;suspect&nbsp;that&nbsp;0.3&nbsp;would&amp;nbsp;&lt;/div&gt;&lt;div&gt;still&nbsp;work.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;However,...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;test&nbsp;doesn't&nbsp;really&nbsp;tell&nbsp;us&nbsp;much.&nbsp;&amp;nbsp;This&nbsp;is&nbsp;a&nbsp;poor&nbsp;benchmark,&amp;nbsp;&lt;/div&gt;&lt;div&gt;because&nbsp;it&nbsp;consists&nbsp;of&nbsp;a&nbsp;single&nbsp;producer&nbsp;sending&nbsp;a&nbsp;20-byte&amp;nbsp;&lt;/div&gt;&lt;div&gt;message&nbsp;to&nbsp;a&nbsp;topic&nbsp;to&nbsp;which&nbsp;no-one&nbsp;is&nbsp;currently&nbsp;subscribed.&nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;therefore&nbsp;a&nbsp;measure&nbsp;of&nbsp;how&nbsp;fast&nbsp;a&nbsp;broker&nbsp;can&nbsp;throw&amp;nbsp;&lt;/div&gt;&lt;div&gt;away&nbsp;messages.&nbsp;&amp;nbsp;RabbitMQ&nbsp;does&nbsp;reasonably&nbsp;well&nbsp;here,&nbsp;but&amp;nbsp;&lt;/div&gt;&lt;div&gt;cannot&nbsp;determine&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;subscribers&nbsp;until&nbsp;it&nbsp;reaches&amp;nbsp;&lt;/div&gt;&lt;div&gt;the&nbsp;actual&nbsp;rabbit&nbsp;exchange,&nbsp;so&nbsp;it&nbsp;goes&nbsp;through&nbsp;AMQP&amp;nbsp;&lt;/div&gt;&lt;div&gt;processing.&nbsp;&amp;nbsp;In&nbsp;general,&nbsp;especially&nbsp;in&nbsp;the&nbsp;presence&nbsp;of&nbsp;potential&amp;nbsp;&lt;/div&gt;&lt;div&gt;durable&nbsp;topic&nbsp;subscriptions,&nbsp;it&nbsp;is&nbsp;hard&nbsp;to&nbsp;see&nbsp;how&nbsp;to&nbsp;fix&nbsp;this&nbsp;--&amp;nbsp;&lt;/div&gt;&lt;div&gt;though&nbsp;if&nbsp;it&nbsp;were&nbsp;a&nbsp;common&nbsp;scenario&nbsp;perhaps&nbsp;some&nbsp;sort&nbsp;of&amp;nbsp;&lt;/div&gt;&lt;div&gt;status&nbsp;of&nbsp;the&nbsp;broker&nbsp;subscription&nbsp;space&nbsp;could&nbsp;be&nbsp;cached&nbsp;near&amp;nbsp;&lt;/div&gt;&lt;div&gt;to&nbsp;the&nbsp;client,&nbsp;allowing&nbsp;us&nbsp;to&nbsp;throw&nbsp;away&nbsp;messages&nbsp;close&nbsp;to&amp;nbsp;&lt;/div&gt;&lt;div&gt;the&nbsp;client:&nbsp;but&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;update&nbsp;the&nbsp;cache&nbsp;when&amp;nbsp;&lt;/div&gt;&lt;div&gt;(remote)&nbsp;subscribers&nbsp;come&nbsp;on&nbsp;line,&nbsp;or&nbsp;risk&nbsp;throwing&nbsp;away&amp;nbsp;&lt;/div&gt;&lt;div&gt;messages&nbsp;in&nbsp;error.&nbsp;&amp;nbsp;This&nbsp;is&nbsp;very&nbsp;complex,&nbsp;and&nbsp;only&nbsp;for&nbsp;a&nbsp;gain&amp;nbsp;&lt;/div&gt;&lt;div&gt;in&nbsp;a&nbsp;low&nbsp;probability&nbsp;use-case.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;notice&nbsp;that&nbsp;the&nbsp;benchmark&nbsp;test&nbsp;runs&nbsp;for&nbsp;a&nbsp;very&nbsp;long&nbsp;time&amp;nbsp;&lt;/div&gt;&lt;div&gt;(hours&nbsp;on&nbsp;my&nbsp;little&nbsp;2Gb&nbsp;2Core&nbsp;Linux&nbsp;VM)&nbsp;and&nbsp;produces&nbsp;a&nbsp;noisy&amp;nbsp;&lt;/div&gt;&lt;div&gt;graph&nbsp;as&nbsp;result&nbsp;(there&nbsp;are&nbsp;lots&nbsp;of&nbsp;zeros&nbsp;in&nbsp;it&nbsp;because&nbsp;RabbitMQ&amp;nbsp;&lt;/div&gt;&lt;div&gt;blocks&nbsp;reads&nbsp;quite&nbsp;often).&nbsp;The&nbsp;graph&nbsp;doesn't&nbsp;help&nbsp;us&nbsp;to&nbsp;guess&amp;nbsp;&lt;/div&gt;&lt;div&gt;at&nbsp;an&nbsp;average&nbsp;rate.&nbsp;&amp;nbsp;I&nbsp;attach&nbsp;the&nbsp;benchmark&nbsp;json&nbsp;output,&nbsp;so&amp;nbsp;&lt;/div&gt;&lt;div&gt;you&nbsp;can&nbsp;view&nbsp;it&nbsp;with&nbsp;generic_report,&nbsp;or&nbsp;something.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;bug&nbsp;fix&nbsp;is&nbsp;rabbit&nbsp;bugzilla&nbsp;24426,&nbsp;which&nbsp;after&nbsp;QA&nbsp;will&amp;nbsp;&lt;/div&gt;&lt;div&gt;probably&nbsp;go&nbsp;into&nbsp;the&nbsp;next&nbsp;release.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;spotting&nbsp;this,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-family:&nbsp;Helvetica;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;normal;&nbsp;orphans:&nbsp;2;&nbsp;text-indent:&nbsp;0px;&nbsp;text-transform:&nbsp;none;&nbsp;white-space:&nbsp;normal;&nbsp;widows:&nbsp;2;&nbsp;word-spacing:&nbsp;0px;&nbsp;-webkit-border-horizontal-spacing:&nbsp;0px;&nbsp;-webkit-border-vertical-spacing:&nbsp;0px;&nbsp;-webkit-text-decorations-in-effect:&nbsp;none;&nbsp;-webkit-text-size-adjust:&nbsp;auto;&nbsp;-webkit-text-stroke-width:&nbsp;0px;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;font-style:&nbsp;normal;&nbsp;&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Georgia&quot;&gt;Steve&nbsp;Powell&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-style:&nbsp;normal;&nbsp;&quot;&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Georgia&quot;&gt;&lt;a&nbsp;href=&quot;mailto:steve@rabbitmq.com&quot;&gt;steve@rabbitmq.com&lt;/a&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-style:&nbsp;normal;&nbsp;&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Georgia&quot;&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;10px;&nbsp;&quot;&gt;[&lt;/span&gt;&lt;i&gt;wrk&lt;/i&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;10px;&nbsp;&quot;&gt;:&nbsp;+44-2380-111-528]&nbsp;[&lt;/span&gt;&lt;i&gt;mob&lt;/i&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;10px;&nbsp;&quot;&gt;:&nbsp;+44-7815-838-558]&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;Georgia&quot;&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;10px;&nbsp;&quot;&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
