<tt>
&lt;div&gt;Hi&nbsp;all,&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;I've&nbsp;got&nbsp;a&nbsp;double&nbsp;pump&nbsp;scenario&nbsp;going&nbsp;on&nbsp;-&nbsp;that&nbsp;is,&nbsp;my&nbsp;application&nbsp;enqueues&nbsp;a&amp;nbsp;&lt;strong&gt;broadcast&lt;/strong&gt;&nbsp;message,&nbsp;that&nbsp;then&nbsp;gets&nbsp;picked&nbsp;up&nbsp;by&nbsp;&lt;strong&gt;consumer&lt;/strong&gt;&lt;strong&gt;&nbsp;type&nbsp;1&lt;/strong&gt;,&nbsp;and&nbsp;transformed&nbsp;into&nbsp;many&amp;nbsp;&lt;strong&gt;singlecast&lt;/strong&gt;&nbsp;messages&nbsp;on&nbsp;a&nbsp;separate&nbsp;queue&nbsp;that&nbsp;are&nbsp;picked&nbsp;up&nbsp;by&nbsp;&lt;strong&gt;consumer&lt;/strong&gt;&lt;strong&gt;&nbsp;type&nbsp;2.&nbsp;&lt;/strong&gt;Consumer&nbsp;type&nbsp;1&nbsp;also&nbsp;creates&nbsp;and&nbsp;publishes&nbsp;a&nbsp;confirmation&nbsp;message&nbsp;in&nbsp;yet&nbsp;another&nbsp;queue,&nbsp;containing&nbsp;the&nbsp;number&nbsp;of&nbsp;singlecast&nbsp;messages&nbsp;it&nbsp;enqueued.&lt;strong&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/strong&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;What's&nbsp;happening&nbsp;is&nbsp;that&nbsp;Consumer&nbsp;type&nbsp;1&nbsp;is&nbsp;operating&nbsp;fine&nbsp;up&nbsp;until&nbsp;it&nbsp;needs&nbsp;to&nbsp;enqueue&nbsp;the&nbsp;confirmation&nbsp;message.&nbsp;The&nbsp;first&nbsp;time&nbsp;any&nbsp;particular&nbsp;type&nbsp;1&nbsp;consumer&nbsp;publishes&nbsp;a&nbsp;confirm&nbsp;message,&nbsp;it&nbsp;never&nbsp;ends&nbsp;up&nbsp;in&nbsp;the&nbsp;confirmation&nbsp;queue.&nbsp;All&nbsp;singlecast&nbsp;messages&nbsp;end&nbsp;up&nbsp;correctly&nbsp;in&nbsp;their&nbsp;queues.&nbsp;If&nbsp;the&nbsp;same&nbsp;process&nbsp;is&nbsp;allowed&nbsp;to&nbsp;consume&nbsp;a&nbsp;second&nbsp;broadcast&nbsp;message,&nbsp;the&nbsp;confirmation&nbsp;it&nbsp;publishes&nbsp;&lt;strong&gt;does&nbsp;&lt;/strong&gt;end&nbsp;up&nbsp;in&nbsp;the&nbsp;confirmation&nbsp;queue&nbsp;(seemingly&nbsp;every&nbsp;time,&nbsp;but&nbsp;this&nbsp;could&nbsp;be&nbsp;a&nbsp;red&nbsp;herring).&nbsp;Firehose&nbsp;trace&nbsp;would&nbsp;indicate&nbsp;that&nbsp;the&nbsp;consumer&nbsp;is&nbsp;doing&nbsp;everything&nbsp;it&nbsp;should&nbsp;-&nbsp;it&nbsp;shows&nbsp;all&nbsp;confirm&nbsp;message&nbsp;publishes&nbsp;with&nbsp;correct&nbsp;exchange&nbsp;and&nbsp;routing&nbsp;key,&nbsp;yet&nbsp;confirm&nbsp;queue&nbsp;remains&nbsp;empty.&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;Consumer/publisher&nbsp;operates&nbsp;as&nbsp;follows:&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;ol&gt;&lt;li&gt;Initiate&nbsp;2&nbsp;connections&nbsp;(to&nbsp;same&nbsp;server,&nbsp;currently):&nbsp;&quot;in&quot;,&nbsp;and&nbsp;&quot;out&quot;&lt;/li&gt;&lt;li&gt;Create&nbsp;4&nbsp;channels:&lt;/li&gt;&lt;ol&gt;&lt;li&gt;bound&nbsp;to&nbsp;&lt;strong&gt;gn-broadcast&lt;/strong&gt;&lt;/li&gt;&lt;li&gt;bound&nbsp;to&nbsp;&lt;strong&gt;gn-smsout&lt;/strong&gt;&lt;/li&gt;&lt;li&gt;bound&nbsp;to&nbsp;&lt;strong&gt;gn-emailout&lt;/strong&gt;&lt;/li&gt;&lt;li&gt;bound&nbsp;to&nbsp;&lt;strong&gt;msg-broadcast-confirm&lt;/strong&gt;&lt;strong&gt;&lt;/strong&gt;&lt;/li&gt;&lt;/ol&gt;&lt;li&gt;Consume&nbsp;loop&nbsp;begins&nbsp;on&amp;nbsp;&lt;strong&gt;in&lt;/strong&gt;&nbsp;channel&nbsp;consuming&nbsp;from&amp;nbsp;&lt;strong&gt;broadcast&lt;/strong&gt;&nbsp;queue&lt;/li&gt;&lt;ol&gt;&lt;li&gt;Gather&nbsp;person&nbsp;list&nbsp;from&nbsp;broadcast&nbsp;message&nbsp;body&lt;/li&gt;&lt;li&gt;Start&nbsp;transactions&nbsp;on&nbsp;&lt;strong&gt;smsout&lt;/strong&gt;&nbsp;and&amp;nbsp;&lt;strong&gt;emailout&lt;/strong&gt;&nbsp;channels&lt;/li&gt;&lt;li&gt;Loop&nbsp;through&nbsp;person&nbsp;list.&nbsp;For&nbsp;each,&nbsp;create&nbsp;two&nbsp;AMQP&nbsp;Messages&nbsp;w/&nbsp;single&nbsp;person&nbsp;and&nbsp;publish&nbsp;to&nbsp;&lt;strong&gt;smsout&amp;nbsp;&lt;/strong&gt;and&nbsp;&lt;strong&gt;emailout&lt;/strong&gt;&nbsp;queues&nbsp;respectively&lt;/li&gt;&lt;li&gt;Once&nbsp;finished&nbsp;looping,&nbsp;commit&nbsp;transaction&nbsp;(assuming&nbsp;all&nbsp;OK)&lt;/li&gt;&lt;li&gt;Create&nbsp;new&nbsp;AMQPMessage&nbsp;with&nbsp;number&nbsp;of&nbsp;persons&nbsp;and&nbsp;publish&nbsp;to&nbsp;&lt;strong&gt;msg-broadcast-confirm&lt;/strong&gt;&nbsp;queue&lt;/li&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;div&gt;A&nbsp;copy&nbsp;of&nbsp;the&nbsp;script&nbsp;is&nbsp;here&nbsp;for&nbsp;reference:&nbsp;&lt;a&nbsp;href=&quot;http://pastebin.com/GH1hr1ph&quot;&gt;http://pastebin.com/GH1hr1ph&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;php-amqplib&nbsp;debug&nbsp;output&nbsp;clearly&nbsp;shows&nbsp;in&nbsp;all&nbsp;cases&nbsp;that&nbsp;the&nbsp;basic_publish&nbsp;message&lt;strong&gt;&nbsp;is&nbsp;being&nbsp;sent&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents&nbsp;of&nbsp;the&nbsp;confirmation&nbsp;message&lt;/strong&gt;.&nbsp;There&nbsp;are&nbsp;no&nbsp;breaks&nbsp;in&nbsp;the&nbsp;connection&nbsp;or&nbsp;exceptions&nbsp;occurring.&nbsp;Likewise,&nbsp;the&nbsp;firehose&nbsp;trace&nbsp;from&nbsp;rabbit&nbsp;publishes&nbsp;a&nbsp;message&nbsp;to&nbsp;trace&nbsp;queue&nbsp;showing&nbsp;the&nbsp;confirm&nbsp;message&nbsp;has&nbsp;been&nbsp;published,&nbsp;with&nbsp;the&nbsp;correct&nbsp;exchange&nbsp;and&nbsp;correct&nbsp;routing&nbsp;key.&amp;nbsp;&nbsp;However,&nbsp;my&nbsp;confirm&nbsp;queue&nbsp;is&nbsp;completely&nbsp;empty!&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Why&nbsp;would&nbsp;this&nbsp;occur?&nbsp;Do&nbsp;I&nbsp;need&nbsp;more&nbsp;than&nbsp;2&nbsp;connections?&nbsp;(I&nbsp;didn't&nbsp;think&nbsp;I&nbsp;would&nbsp;need&nbsp;more&nbsp;than&nbsp;1,&nbsp;but&nbsp;the&nbsp;sms&nbsp;and&nbsp;email&nbsp;messages&nbsp;don't&nbsp;seem&nbsp;to&nbsp;publish&nbsp;nicely&nbsp;without&nbsp;a&nbsp;second&nbsp;connection).&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;on&nbsp;earth&nbsp;is&nbsp;going&nbsp;on?&nbsp;It's&nbsp;doing&nbsp;my&nbsp;head&nbsp;in!&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Rabbitmq-server&nbsp;version&nbsp;2.8.2&nbsp;running&nbsp;in&nbsp;a&nbsp;Turnkey&nbsp;LAMP&nbsp;VM&nbsp;(Ubuntu&nbsp;10.04).&nbsp;Client&nbsp;is&nbsp;running&nbsp;on&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10.6.8&nbsp;with&nbsp;latest&nbsp;php-amqplib.&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Regards,&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Keith&lt;/div&gt;
</tt>
