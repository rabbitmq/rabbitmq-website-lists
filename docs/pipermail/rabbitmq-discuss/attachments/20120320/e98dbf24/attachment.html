<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Mar&nbsp;20,&nbsp;2012&nbsp;at&nbsp;12:17&nbsp;PM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;20/03/12&nbsp;06:43,&nbsp;Gerolf&nbsp;Seitz&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
When&nbsp;passively&nbsp;declaring&nbsp;a&nbsp;queue,&nbsp;the&nbsp;returned&nbsp;consumer&nbsp;count&nbsp;is&nbsp;not&nbsp;the&lt;br&gt;<br>
same&nbsp;as&nbsp;the&nbsp;consumer&nbsp;count&nbsp;via&nbsp;the&nbsp;management&nbsp;plugin&nbsp;/&nbsp;http&nbsp;API.&nbsp;Turns&lt;br&gt;<br>
out,&nbsp;rabbitmq&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;consumers&nbsp;that&nbsp;are&nbsp;ready&nbsp;to&nbsp;receive&lt;br&gt;<br>
a&nbsp;message.&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;an&nbsp;example:&nbsp;there&nbsp;are&nbsp;5&nbsp;(manually&nbsp;acknowledging)&nbsp;consumers,&nbsp;3&nbsp;of&lt;br&gt;<br>
which&nbsp;have&nbsp;consumed&nbsp;a&nbsp;message&nbsp;from&nbsp;the&nbsp;queue,&nbsp;but&nbsp;have&nbsp;not&nbsp;sent&nbsp;an&nbsp;ACK&lt;br&gt;<br>
for&nbsp;the&nbsp;respective&nbsp;messages&nbsp;to&nbsp;the&nbsp;broker.&nbsp;Declaring&nbsp;a&nbsp;queue&nbsp;now&nbsp;returns&lt;br&gt;<br>
a&nbsp;declare-ok&nbsp;with&nbsp;consumer-count&nbsp;==&nbsp;2,&nbsp;whereas&nbsp;I&nbsp;would&nbsp;have&nbsp;expected&nbsp;it&lt;br&gt;<br>
to&nbsp;be&nbsp;5.&lt;br&gt;<br>
&lt;br&gt;<br>
Looking&nbsp;at&nbsp;the&nbsp;rabbitmq-server&nbsp;code&nbsp;reveals&nbsp;that&nbsp;the&nbsp;&amp;quot;active&nbsp;consumer&amp;quot;&lt;br&gt;<br>
part&nbsp;of&nbsp;the&nbsp;state&nbsp;is&nbsp;used&nbsp;for&nbsp;getting&nbsp;the&nbsp;next&nbsp;consumer&nbsp;for&nbsp;round&nbsp;robin&lt;br&gt;<br>
delivery&nbsp;and&nbsp;returning&nbsp;the&nbsp;number&nbsp;of&nbsp;consumers&nbsp;as&nbsp;part&nbsp;of&nbsp;the&nbsp;declare-ok&lt;br&gt;<br>
message.&lt;br&gt;<br>
&lt;br&gt;<br>
Since&nbsp;I&nbsp;don&amp;#39;t&nbsp;suspect&nbsp;this&nbsp;to&nbsp;be&nbsp;an&nbsp;oversight&nbsp;but&nbsp;rather&nbsp;a&nbsp;conscious&lt;br&gt;<br>
decision,&nbsp;I&amp;#39;m&nbsp;interested&nbsp;in&nbsp;the&nbsp;rationale&nbsp;behind&nbsp;it.&nbsp;I&amp;#39;m&nbsp;aware&nbsp;that&lt;br&gt;<br>
changing&nbsp;the&nbsp;semantics&nbsp;at&nbsp;this&nbsp;point&nbsp;is&nbsp;probably&nbsp;not&nbsp;possible&nbsp;and&nbsp;I&nbsp;may&lt;br&gt;<br>
have&nbsp;to&nbsp;resort&nbsp;to&nbsp;fetching&nbsp;the&nbsp;consumer&nbsp;count&nbsp;via&nbsp;the&nbsp;http&nbsp;api&nbsp;(which&lt;br&gt;<br>
brings&nbsp;some&nbsp;organizational&nbsp;overhead).&lt;br&gt;<br>
&lt;br&gt;<br>
Can&nbsp;anybody&nbsp;shed&nbsp;some&nbsp;light&nbsp;on&nbsp;this?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
Hi&nbsp;Gerolf.&lt;br&gt;<br>
&lt;br&gt;<br>
Yes,&nbsp;this&nbsp;is&nbsp;deliberate.&nbsp;Code&nbsp;archaeology&nbsp;yielded&nbsp;this:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://hg.rabbitmq.com/rabbitmq-server/rev/32e357ad03d6&quot;&nbsp;target=&quot;_blank&quot;&gt;http://hg.rabbitmq.com/&lt;u&gt;&lt;/u&gt;rabbitmq-server/rev/&lt;u&gt;&lt;/u&gt;32e357ad03d6&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;quot;count&nbsp;queue&nbsp;consumers&nbsp;as&nbsp;required&nbsp;by&nbsp;the&nbsp;spec&amp;quot;.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;spec&nbsp;actually&nbsp;says:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; Reports&nbsp;the&nbsp;number&nbsp;of&nbsp;active&nbsp;consumers&nbsp;for&nbsp;the&nbsp;queue.&nbsp;Note&nbsp;that&lt;br&gt;<br>
&nbsp; &nbsp; consumers&nbsp;can&nbsp; suspend&nbsp;activity&nbsp;(Channel.Flow)&nbsp;in&nbsp;which&nbsp;case&nbsp;they&lt;br&gt;<br>
&nbsp; &nbsp; do&nbsp;not&nbsp;appear&nbsp;in&nbsp;this&nbsp;count.&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;that&nbsp;is&nbsp;slightly&nbsp;ambiguous&nbsp;-&nbsp;we&nbsp;are&nbsp;excluding&nbsp;consumers&nbsp;that&nbsp;have&nbsp;issued&nbsp;channel.flow,&nbsp;but&nbsp;also&nbsp;those&nbsp;which&nbsp;are&nbsp;blocked&nbsp;due&nbsp;to&nbsp;qos&nbsp;/&nbsp;ack&nbsp;interaction.&nbsp;But&nbsp;those&nbsp;could&nbsp;easily&nbsp;be&nbsp;defined&nbsp;as&nbsp;&amp;quot;inactive&amp;quot;...&lt;br&gt;<br>
&lt;br&gt;<br>
Hmm.&nbsp;I&amp;#39;ll&nbsp;have&nbsp;a&nbsp;think&nbsp;about&nbsp;this.&nbsp;What&nbsp;are&nbsp;you&nbsp;trying&nbsp;to&nbsp;do?&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&nbsp;Simon&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;<br>
--&nbsp;&lt;br&gt;<br>
Simon&nbsp;MacMullen&lt;br&gt;<br>
RabbitMQ,&nbsp;VMware&lt;br&gt;<br>
&lt;/font&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;reply-to-author&nbsp;setting&nbsp;of&nbsp;rabbitmq-discuss&nbsp;screwed&nbsp;me&nbsp;;)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:13px;background-color:rgb(255,255,255)&quot;&gt;Hi,&lt;/span&gt;&lt;div&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:13px;background-color:rgb(255,255,255)&quot;&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;color:rgb(34,34,34);font-family:arial,sans-serif;font-size:13px;background-color:rgb(255,255,255)&quot;&gt;The&nbsp;use&nbsp;case&nbsp;is&nbsp;this:&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;a&nbsp;pool&nbsp;of&nbsp;consumers&nbsp;(each&nbsp;running&nbsp;in&nbsp;a&nbsp;heavy&nbsp;weight&nbsp;process)&nbsp;that&nbsp;can&nbsp;only&nbsp;process&nbsp;a&nbsp;single&nbsp;unit&nbsp;of&nbsp;work&nbsp;at&nbsp;a&nbsp;time&nbsp;each.&lt;/div&gt;<br>
<br>
&lt;div&gt;The&nbsp;messages&nbsp;that&nbsp;are&nbsp;sent&nbsp;to&nbsp;these&nbsp;consumers&nbsp;contain&nbsp;data&nbsp;that&nbsp;can&nbsp;become&nbsp;&amp;quot;old&amp;quot;&nbsp;quite&nbsp;quickly&nbsp;(think&nbsp;stock&nbsp;ticks),&nbsp;so&nbsp;queuing&nbsp;hundreds&nbsp;of&nbsp;messages&nbsp;is&nbsp;not&nbsp;an&nbsp;option.&lt;/div&gt;&lt;div&gt;Also,&nbsp;these&nbsp;consumers&nbsp;need&nbsp;to&nbsp;be&nbsp;kept&nbsp;busy&nbsp;all&nbsp;the&nbsp;time:&nbsp;as&nbsp;soon&nbsp;as&nbsp;a&nbsp;unit&nbsp;of&nbsp;work&nbsp;is&nbsp;done,&nbsp;the&nbsp;next&nbsp;task&nbsp;will&nbsp;be&nbsp;submitted&nbsp;and&nbsp;picked&nbsp;up&nbsp;by&nbsp;the&nbsp;free&nbsp;consumer.&nbsp;(prefetch=1,&nbsp;autoack=false).&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Based&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;consumers,&nbsp;the&nbsp;system&nbsp;decides&nbsp;which&nbsp;unit&nbsp;of&nbsp;work&nbsp;is&nbsp;sent&nbsp;next,&nbsp;mostly&nbsp;based&nbsp;on&nbsp;the&nbsp;previous&nbsp;time&nbsp;the&nbsp;unit&nbsp;of&nbsp;work&nbsp;took&nbsp;to&nbsp;complete.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Example:&lt;/div&gt;&lt;div&gt;7&nbsp;consumers&nbsp;overall&lt;/div&gt;<br>
<br>
&lt;div&gt;Per&nbsp;configuration,&nbsp;only&nbsp;up&nbsp;to&nbsp;4&nbsp;consumers&nbsp;may&nbsp;be&nbsp;used&nbsp;to&nbsp;process&nbsp;really&nbsp;long&nbsp;running&nbsp;tasks&nbsp;(eg.&nbsp;&amp;gt;1&nbsp;minute&nbsp;task&nbsp;duration)&lt;/div&gt;&lt;div&gt;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;consumers&nbsp;is&nbsp;used&nbsp;for&nbsp;short&nbsp;running&nbsp;tasks.&nbsp;(eg.&nbsp;&amp;lt;1&nbsp;minute)&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;reason&nbsp;why&nbsp;we&nbsp;don&amp;#39;t&nbsp;have&nbsp;2&nbsp;different&nbsp;queues&nbsp;is&nbsp;twofold:&lt;/div&gt;&lt;div&gt;1)&nbsp;if&nbsp;there&nbsp;are&nbsp;no&nbsp;long&nbsp;running&nbsp;tasks&nbsp;to&nbsp;be&nbsp;executed,&nbsp;all&nbsp;consumers&nbsp;should&nbsp;be&nbsp;used&nbsp;for&nbsp;short&nbsp;running&nbsp;tasks&lt;/div&gt;&lt;div&gt;2)&nbsp;the&nbsp;decision&nbsp;whether&nbsp;a&nbsp;task&nbsp;is&nbsp;short&nbsp;or&nbsp;long&nbsp;running&nbsp;is&nbsp;made&nbsp;by&nbsp;the&nbsp;system&nbsp;that&nbsp;sends&nbsp;the&nbsp;messages&nbsp;to&nbsp;the&nbsp;broker&nbsp;and&nbsp;the&nbsp;decision&nbsp;process&nbsp;can&nbsp;be&nbsp;tweaked&nbsp;via&nbsp;configuration.&nbsp;This&nbsp;is&nbsp;easier&nbsp;to&nbsp;manipulate&nbsp;than&nbsp;reconfiguring&nbsp;and&nbsp;restarting&nbsp;the&nbsp;heavy&nbsp;weight&nbsp;consumer&nbsp;processes.&lt;br&nbsp;clear=&quot;all&quot;&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;hope&nbsp;this&nbsp;clears&nbsp;it&nbsp;up&nbsp;a&nbsp;bit&nbsp;;)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&gt;Gerolf&nbsp;Seitz&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;twitter:&nbsp;@gersei&lt;div&gt;code:&nbsp;&lt;a&nbsp;href=&quot;http://github.com/gseitz&quot;&nbsp;target=&quot;_blank&quot;&gt;github.com/gseitz&lt;/a&gt;&lt;/div&gt;<br>
<br>
&lt;/div&gt;&lt;div&gt;blog:&nbsp;&lt;a&nbsp;href=&quot;http://www.gerolfseitz.com&quot;&nbsp;target=&quot;_blank&quot;&gt;www.gerolfseitz.com&lt;/a&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
