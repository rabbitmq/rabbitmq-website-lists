<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;Hmmm...&nbsp;So,&nbsp;about&nbsp;1/4&nbsp;of&nbsp;the&nbsp;queues&nbsp;were&nbsp;approaching&nbsp;being&nbsp;balanced,&nbsp;and&nbsp;then&nbsp;all&nbsp;of&nbsp;the&nbsp;hosts&nbsp;dropped&nbsp;out&nbsp;of&nbsp;the&nbsp;test&nbsp;cluster.&lt;br&gt;&lt;br&gt;&lt;/div&gt;Looking&nbsp;at&nbsp;the&nbsp;system,&nbsp;only&nbsp;the&nbsp;second&nbsp;instance&nbsp;is&nbsp;even&nbsp;listening&nbsp;on&nbsp;any&nbsp;network&nbsp;ports,&nbsp;but&nbsp;the&nbsp;beam.smp&nbsp;processes&nbsp;for&nbsp;all&nbsp;instances&nbsp;are&nbsp;still&nbsp;running:&lt;br&gt;<br>
&lt;br&gt;#&nbsp;netstat&nbsp;-tlpn&nbsp;|&nbsp;grep&nbsp;beam&lt;br&gt;tcp       &nbsp;0     &nbsp;0&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0:44442&quot;&gt;0.0.0.0:44442&lt;/a&gt;              &nbsp;0.0.0.0:*                  &nbsp;LISTEN     &nbsp;20303/beam.smp     &nbsp;&lt;br&gt;tcp       &nbsp;0     &nbsp;0&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0:16639&quot;&gt;0.0.0.0:16639&lt;/a&gt;              &nbsp;0.0.0.0:*                  &nbsp;LISTEN     &nbsp;20303/beam.smp     &nbsp;&lt;br&gt;<br>
tcp       &nbsp;0     &nbsp;0&nbsp;:::5672                    &nbsp;:::*                       &nbsp;LISTEN     &nbsp;20303/beam.smp     &nbsp;&lt;br&gt;&lt;br&gt;&lt;/div&gt;#&nbsp;ps&nbsp;axf&lt;br&gt;&lt;div&gt;12449&nbsp;?       &nbsp;S     &nbsp;0:08&nbsp;/usr/lib64/erlang/erts-5.8.5/bin/epmd&nbsp;-daemon&lt;br&gt;20183&nbsp;?       &nbsp;Sl   &nbsp;13:50&nbsp;/usr/lib64/erlang/erts-5.8.5/bin/beam.smp&nbsp;-W&nbsp;w&nbsp;-K&nbsp;true&nbsp;-A30&nbsp;-P&nbsp;1048576&nbsp;--&nbsp;-root&nbsp;/usr/lib64/erlang&nbsp;-progname&nbsp;erl&nbsp;--&nbsp;-home&nbsp;/var/lib/rabbitmq&nbsp;--&nbsp;-p&lt;br&gt;<br>
20303&nbsp;?       &nbsp;Sl   &nbsp;21:31&nbsp;/usr/lib64/erlang/erts-5.8.5/bin/beam.smp&nbsp;-W&nbsp;w&nbsp;-K&nbsp;true&nbsp;-A30&nbsp;-P&nbsp;1048576&nbsp;--&nbsp;-root&nbsp;/usr/lib64/erlang&nbsp;-progname&nbsp;erl&nbsp;--&nbsp;-home&nbsp;/var/lib/rabbitmq&nbsp;--&nbsp;-p&lt;br&gt;20739&nbsp;?       &nbsp;Ss    &nbsp;0:04 &nbsp;\_&nbsp;inet_gethost&nbsp;4&lt;br&gt;<br>
20740&nbsp;?       &nbsp;S     &nbsp;0:04     &nbsp;\_&nbsp;inet_gethost&nbsp;4&lt;br&gt;20423&nbsp;?       &nbsp;Sl   &nbsp;11:24&nbsp;/usr/lib64/erlang/erts-5.8.5/bin/beam.smp&nbsp;-W&nbsp;w&nbsp;-K&nbsp;true&nbsp;-A30&nbsp;-P&nbsp;1048576&nbsp;--&nbsp;-root&nbsp;/usr/lib64/erlang&nbsp;-progname&nbsp;erl&nbsp;--&nbsp;-home&nbsp;/var/lib/rabbitmq&nbsp;--&nbsp;-p&lt;br&gt;<br>
20543&nbsp;?       &nbsp;Sl   &nbsp;11:41&nbsp;/usr/lib64/erlang/erts-5.8.5/bin/beam.smp&nbsp;-W&nbsp;w&nbsp;-K&nbsp;true&nbsp;-A30&nbsp;-P&nbsp;1048576&nbsp;--&nbsp;-root&nbsp;/usr/lib64/erlang&nbsp;-progname&nbsp;erl&nbsp;--&nbsp;-home&nbsp;/var/lib/rabbitmq&nbsp;--&nbsp;-p&lt;br&gt;20663&nbsp;?       &nbsp;Sl   &nbsp;10:18&nbsp;/usr/lib64/erlang/erts-5.8.5/bin/beam.smp&nbsp;-W&nbsp;w&nbsp;-K&nbsp;true&nbsp;-A30&nbsp;-P&nbsp;1048576&nbsp;--&nbsp;-root&nbsp;/usr/lib64/erlang&nbsp;-progname&nbsp;erl&nbsp;--&nbsp;-home&nbsp;/var/lib/rabbitmq&nbsp;--&nbsp;-p&lt;br&gt;<br>
&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;I&nbsp;killed&nbsp;them&nbsp;all&nbsp;and&nbsp;started&nbsp;them&nbsp;back&nbsp;up&nbsp;again,&nbsp;the&nbsp;spent&nbsp;a&nbsp;long&nbsp;time&nbsp;rescanning&nbsp;all&nbsp;their&nbsp;queues,&nbsp;and&nbsp;when&nbsp;the&nbsp;main&nbsp;node&nbsp;(which&nbsp;the&nbsp;queues&nbsp;were&nbsp;created&nbsp;on)&nbsp;re-entered&nbsp;the&nbsp;cluster,&nbsp;they&nbsp;all&nbsp;crashed&nbsp;again.&nbsp;I&nbsp;blew&nbsp;away&nbsp;the&nbsp;test&nbsp;cluster,&nbsp;and&nbsp;re-ran&nbsp;the&nbsp;following&nbsp;steps,&nbsp;and&nbsp;had&nbsp;the&nbsp;main&nbsp;node&nbsp;where&nbsp;all&nbsp;the&nbsp;queues&nbsp;were&nbsp;created&nbsp;and&nbsp;the&nbsp;data&nbsp;loaded&nbsp;stop&nbsp;listening&nbsp;on&nbsp;all&nbsp;its&nbsp;ports&nbsp;and&nbsp;disconnect&nbsp;from&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;cluster.&nbsp;Killing&nbsp;it&nbsp;and&nbsp;restarting&nbsp;it&nbsp;caused&nbsp;it&nbsp;to&nbsp;reread&nbsp;all&nbsp;its&nbsp;queues,&nbsp;and&nbsp;then&nbsp;drop&nbsp;all&nbsp;its&nbsp;network&nbsp;listeners&nbsp;and&nbsp;connections&nbsp;to&nbsp;the&nbsp;cluster&nbsp;again.&lt;br&gt;<br>
&lt;br&gt;./create_cluster.sh&nbsp;&amp;amp;&amp;amp;&nbsp;./setup_queues.sh&nbsp;&amp;amp;&amp;amp;&nbsp;./populate_queues.sh&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;./rebalance_cluster.sh&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Looking&nbsp;at&nbsp;the&nbsp;logs&nbsp;for&nbsp;instances&nbsp;which&nbsp;drop&nbsp;their&nbsp;network&nbsp;connections&nbsp;shows&nbsp;some&nbsp;pretty&nbsp;big&nbsp;erlang&nbsp;stack&nbsp;dumps,&nbsp;so&nbsp;I&amp;#39;ve&nbsp;compressed&nbsp;and&nbsp;uploaded&nbsp;a&nbsp;sample&nbsp;log&nbsp;file&nbsp;here&nbsp;for&nbsp;you:&nbsp;&lt;a&nbsp;href=&quot;https://mega.co.nz/#!31JCGSxa!LdxuhXeX_HN_px8lnQcp63RkFcRY_dW9Z_x9C7qv2aE&quot;&gt;https://mega.co.nz/#!31JCGSxa!LdxuhXeX_HN_px8lnQcp63RkFcRY_dW9Z_x9C7qv2aE&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Here&amp;#39;s&nbsp;my&nbsp;latest&nbsp;set&nbsp;of&nbsp;scripts&nbsp;for&nbsp;reproduction&nbsp;at&nbsp;your&nbsp;end:&nbsp;&lt;a&nbsp;href=&quot;https://mega.co.nz/#!Th5UCBZS!eQe9_SmOS5qdv0tP8nUZmnjj7h1QhtOG1i4GrtoYeMU&quot;&gt;https://mega.co.nz/#!Th5UCBZS!eQe9_SmOS5qdv0tP8nUZmnjj7h1QhtOG1i4GrtoYeMU&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;Graeme&lt;br&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Nov&nbsp;26,&nbsp;2013&nbsp;at&nbsp;1:28&nbsp;PM,&nbsp;Graeme&nbsp;N&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:graeme@sudo.ca&quot;&nbsp;target=&quot;_blank&quot;&gt;graeme@sudo.ca&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;On&nbsp;Tue,&nbsp;Nov&nbsp;26,&nbsp;2013&nbsp;at&nbsp;1:13&nbsp;PM,&nbsp;Graeme&nbsp;N&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:graeme@sudo.ca&quot;&nbsp;target=&quot;_blank&quot;&gt;graeme@sudo.ca&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;<br>
&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Nov&nbsp;25,&nbsp;2013&nbsp;at&nbsp;9:39&nbsp;AM,&nbsp;Simon&nbsp;MacMullen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:simon@rabbitmq.com&quot;&nbsp;target=&quot;_blank&quot;&gt;simon@rabbitmq.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;Graeme:&nbsp;we&nbsp;recently&nbsp;merged&nbsp;a&nbsp;few&nbsp;fixes&nbsp;to&nbsp;bugs&nbsp;that&nbsp;we&nbsp;found&nbsp;as&nbsp;a&nbsp;result&nbsp;of&nbsp;running&nbsp;your&nbsp;test&nbsp;scripts;&nbsp;these&nbsp;can&nbsp;be&nbsp;picked&nbsp;up&nbsp;in&nbsp;the&nbsp;latest&nbsp;nightlies.&nbsp;I&nbsp;am&nbsp;now&nbsp;able&nbsp;to&nbsp;run&nbsp;rebalance_cluster.sh&nbsp;and&nbsp;toggle_nodes.sh&nbsp;indefinitely&nbsp;without&nbsp;anything&nbsp;breaking.&lt;br&gt;<br>
<br>
<br>
<br>
&lt;/blockquote&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
Thanks&nbsp;for&nbsp;producing&nbsp;these&nbsp;scripts!&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
