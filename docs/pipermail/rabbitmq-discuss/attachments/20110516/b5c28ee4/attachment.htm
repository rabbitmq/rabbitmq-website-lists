<tt>
&lt;div&gt;&lt;div&gt;&lt;span&gt;&lt;div&gt;&lt;span&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;Hey&nbsp;Aaron,&nbsp;cool&nbsp;work.&nbsp;&amp;nbsp;Using&nbsp;libevent&nbsp;is&nbsp;a&nbsp;nice&nbsp;approach.&nbsp;&amp;nbsp;Given&nbsp;Pika's&nbsp;modular&nbsp;approach,&nbsp;I'll&nbsp;have&nbsp;to&nbsp;see&nbsp;what&nbsp;that&nbsp;looks&nbsp;like&nbsp;as&nbsp;an&nbsp;option&nbsp;in&nbsp;Pika&nbsp;v2.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Given&nbsp;Jason's&nbsp;questions,&nbsp;I&nbsp;decided&nbsp;to&nbsp;port&nbsp;your&nbsp;bench&nbsp;to&nbsp;Pika&nbsp;and&nbsp;threw&nbsp;in&nbsp;py-amqplib&nbsp;(single&nbsp;channel&nbsp;only)&nbsp;to&nbsp;boot.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;As&nbsp;I&nbsp;had&nbsp;expected,&amp;nbsp;Haigha&nbsp;benched&nbsp;faster&nbsp;than&nbsp;Pika,&nbsp;but&nbsp;surprisingly&nbsp;only&nbsp;by&nbsp;2.84%&nbsp;with&nbsp;500&nbsp;channels.&nbsp;&amp;nbsp;I&nbsp;does,&nbsp;however,&nbsp;start&nbsp;to&nbsp;show&nbsp;its&nbsp;performance&nbsp;benefits&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;with&nbsp;multiple&nbsp;channels&nbsp;when&nbsp;the&nbsp;single&nbsp;socket&nbsp;is&nbsp;not&nbsp;over-saturated.&nbsp;&amp;nbsp;It&nbsp;was&nbsp;13.29%&nbsp;faster&nbsp;than&nbsp;Pika&nbsp;with&nbsp;50&nbsp;channels&nbsp;and&nbsp;21.57%&nbsp;faster&nbsp;with&nbsp;10&nbsp;channels.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;was&nbsp;somewhat&nbsp;surprised&nbsp;to&nbsp;find&nbsp;that&nbsp;Pika&nbsp;benched&nbsp;13.08%&nbsp;faster&nbsp;with&nbsp;only&nbsp;1&nbsp;channel.&nbsp;So&nbsp;surprised&nbsp;that&nbsp;I&nbsp;had&nbsp;to&nbsp;triple&nbsp;check&nbsp;the&nbsp;numbers&nbsp;;-)&nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;used&nbsp;the&nbsp;500&nbsp;number&nbsp;as&nbsp;the&nbsp;initial&nbsp;baseline&nbsp;because&nbsp;it&nbsp;the&nbsp;default&nbsp;value&nbsp;in&nbsp;your&nbsp;test&nbsp;app.&amp;nbsp;I&nbsp;am&nbsp;curious&nbsp;what&nbsp;the&nbsp;use&nbsp;case&nbsp;for&nbsp;so&nbsp;many&nbsp;channels&nbsp;is&nbsp;in&nbsp;the&nbsp;test.&nbsp;&amp;nbsp;Is&nbsp;it&nbsp;to&nbsp;simulate&nbsp;concurrency&nbsp;in&nbsp;a&nbsp;client&nbsp;app?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Anyway&nbsp;here&nbsp;is&nbsp;the&nbsp;info&nbsp;on&nbsp;my&nbsp;tests:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;&lt;b&gt;Box:&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;Dual&nbsp;quad&nbsp;core&nbsp;AMD&nbsp;2.2Gz&nbsp;(Model&nbsp;2356)&lt;/li&gt;&lt;li&gt;8GB&nbsp;Ram&lt;/li&gt;&lt;li&gt;Max&nbsp;CPU&nbsp;utilization&nbsp;during&nbsp;all&nbsp;tests:&nbsp;19%&lt;/li&gt;&lt;li&gt;Max&nbsp;IOWait&nbsp;during&nbsp;all&nbsp;tests:&nbsp;0.2%&lt;/li&gt;&lt;li&gt;Gentoo&nbsp;Linux&nbsp;with&nbsp;a&nbsp;custom&nbsp;compiled&nbsp;2.6.28&nbsp;kernel&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;RabbitMQ:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;2.4.1&lt;/li&gt;&lt;li&gt;Erlang&nbsp;R14B02&lt;/li&gt;&lt;li&gt;Default&nbsp;settings&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Client&nbsp;libraries:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;Haigha&nbsp;0.2.1&lt;/li&gt;&lt;li&gt;Pika&nbsp;0.9.6p0&lt;/li&gt;&lt;li&gt;py-amqplib&nbsp;0.6.1&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Test&nbsp;Parameters:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;Duration:&nbsp;300&nbsp;seconds&lt;/li&gt;&lt;li&gt;Channel&nbsp;Count:&nbsp;1,&nbsp;10,&nbsp;50,&nbsp;500&lt;/li&gt;&lt;li&gt;No-Ack:&nbsp;True&lt;/li&gt;&lt;li&gt;Transactions:&nbsp;Off&lt;/li&gt;&lt;li&gt;Single&nbsp;threaded&lt;/li&gt;&lt;li&gt;Single&nbsp;Process&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;The&nbsp;1&nbsp;channel&nbsp;option&nbsp;was&nbsp;to&nbsp;accommodate&nbsp;py-admqplib&nbsp;and&nbsp;BlockingConnection.&nbsp;&amp;nbsp;BlockingConnection&nbsp;can&nbsp;handle&nbsp;multiple&nbsp;channels&nbsp;but&nbsp;the&nbsp;overhead&nbsp;for&nbsp;setting&nbsp;up&nbsp;500&nbsp;connections&nbsp;on&nbsp;BlockingAdapter&nbsp;in&nbsp;Pika&nbsp;was&nbsp;prohibitive.&nbsp;&amp;nbsp;The&nbsp;test&nbsp;ended&nbsp;prior&nbsp;to&nbsp;all&nbsp;queues&nbsp;being&nbsp;bound&nbsp;and&nbsp;a&nbsp;single&nbsp;full&nbsp;setup&nbsp;is&nbsp;roughly&nbsp;1.2&nbsp;seconds&nbsp;in&nbsp;my&nbsp;environment.&nbsp;For&nbsp;the&nbsp;Pika/TornadoConnection&nbsp;test,&nbsp;I&nbsp;used&nbsp;Tornado&nbsp;1.2.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;few&nbsp;important&nbsp;things&nbsp;were&nbsp;uncovered&nbsp;in&nbsp;Pika&nbsp;with&nbsp;this&nbsp;test:&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;There&nbsp;is&nbsp;an&nbsp;interesting&nbsp;recursion&nbsp;bug&nbsp;under&nbsp;heavy&nbsp;loads&nbsp;in&nbsp;all&nbsp;0.9.x&nbsp;versions.&nbsp;This&nbsp;bug&nbsp;would&nbsp;only&nbsp;present&nbsp;itself&nbsp;if&nbsp;there&nbsp;was&nbsp;always&nbsp;a&nbsp;frame&nbsp;to&nbsp;read&nbsp;or&nbsp;frame&nbsp;to&nbsp;publish&nbsp;in&nbsp;the&nbsp;buffer.&nbsp;If&nbsp;the&nbsp;IOLoop&nbsp;ever&nbsp;had&nbsp;a&nbsp;cycle&nbsp;without&nbsp;inbound&nbsp;or&nbsp;outbound&nbsp;data,&nbsp;the&nbsp;bug&nbsp;will&nbsp;not&nbsp;present.&nbsp;&amp;nbsp;But&nbsp;if&nbsp;there&nbsp;is&nbsp;always&nbsp;data&nbsp;to&nbsp;process,&nbsp;for&nbsp;up&nbsp;to&nbsp;1,000&nbsp;frames,&nbsp;there&nbsp;will&nbsp;be&nbsp;a&nbsp;RuntimeError.&nbsp;1,000&nbsp;is&nbsp;the&nbsp;default&nbsp;Python&nbsp;recursion&nbsp;limit.&nbsp;This&nbsp;bug&nbsp;has&nbsp;been&nbsp;fixed.&lt;/li&gt;&lt;li&gt;BlockingConnection&nbsp;is&nbsp;very&nbsp;slow!&nbsp;It&nbsp;is&nbsp;roughly&nbsp;1/8th&nbsp;the&nbsp;speed&nbsp;of&nbsp;py-amqplib.&nbsp;While&nbsp;Asyncore&nbsp;can&nbsp;do&nbsp;roughly&nbsp;1,800&nbsp;messages&nbsp;a&nbsp;second&nbsp;on&nbsp;a&nbsp;single&nbsp;channel,&nbsp;Blocking&nbsp;can&nbsp;only&nbsp;do&nbsp;roughly&nbsp;4!&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;I&nbsp;didn't&nbsp;make&nbsp;much&nbsp;of&nbsp;an&nbsp;effort&nbsp;to&nbsp;clean&nbsp;up&nbsp;the&nbsp;code&nbsp;or&nbsp;remove&nbsp;the&nbsp;parts&nbsp;I&nbsp;don't&nbsp;use,&nbsp;but&nbsp;the&nbsp;stress_test&nbsp;app&nbsp;hack&nbsp;for&nbsp;pika&nbsp;is&nbsp;at&amp;nbsp;&lt;a&nbsp;href=&quot;https://gist.github.com/974021&quot;&gt;https://gist.github.com/974021&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Haigha&nbsp;looks&nbsp;nice.&nbsp;You're&nbsp;doing&nbsp;some&nbsp;of&nbsp;the&nbsp;things&nbsp;I&nbsp;have&nbsp;been&nbsp;thinking&nbsp;about&nbsp;with&nbsp;future&nbsp;versions&nbsp;of&nbsp;Pika&nbsp;such&nbsp;as&nbsp;in&nbsp;your&nbsp;haigha/classes&nbsp;modules&nbsp;(More&nbsp;natural&nbsp;AMQP&nbsp;mapping&nbsp;of&nbsp;classes&nbsp;for&nbsp;use&nbsp;in&nbsp;the&nbsp;client).&amp;nbsp;I&nbsp;look&nbsp;forward&nbsp;to&nbsp;seeing&nbsp;where&nbsp;you&nbsp;take&nbsp;it.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;&lt;div&gt;Gavin&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&gt;&lt;/span&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--&nbsp;&lt;p&nbsp;style=&quot;color:&nbsp;#a0a0a0;&quot;&gt;On&nbsp;Saturday,&nbsp;May&nbsp;14,&nbsp;2011&nbsp;at&nbsp;9:40&nbsp;PM,&nbsp;Jason&nbsp;J.&nbsp;W.&nbsp;Williams&nbsp;wrote:&lt;/p&gt;&nbsp;--&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&nbsp;style=&quot;color:&nbsp;#a0a0a0;&quot;&gt;On&nbsp;Saturday,&nbsp;May&nbsp;14,&nbsp;2011&nbsp;at&nbsp;9:40&nbsp;PM,&nbsp;Jason&nbsp;J.&nbsp;W.&nbsp;Williams&nbsp;wrote:&lt;/p&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;How&nbsp;does&nbsp;this&nbsp;differ&nbsp;from&nbsp;Pika's&nbsp;asyncore&nbsp;or&nbsp;Tornado&nbsp;bindings&nbsp;in&nbsp;terms&nbsp;of&nbsp;performance?&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;
</tt>
