<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Priority queue doesn't seem to work as expected
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Priority%20queue%20doesn%27t%20seem%20to%20work%20as%20expected&In-Reply-To=%3CCA%2Bxr%2B8SPw9f%2Bb6sY3jDMODSi_y9AurbAbe7bXwqBNkVZjbdRgw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037160.html">
   <LINK REL="Next"  HREF="037162.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Priority queue doesn't seem to work as expected</H1>
    <B>Nikita Zubrilov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Priority%20queue%20doesn%27t%20seem%20to%20work%20as%20expected&In-Reply-To=%3CCA%2Bxr%2B8SPw9f%2Bb6sY3jDMODSi_y9AurbAbe7bXwqBNkVZjbdRgw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Priority queue doesn't seem to work as expected">nikita.zubrilov at gmail.com
       </A><BR>
    <I>Mon Jul 14 09:11:25 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="037160.html">[rabbitmq-discuss] rabbitmq connection stay in flow or blocked	state for a long time
</A></li>
        <LI>Next message: <A HREF="037162.html">[rabbitmq-discuss] Priority queue doesn't seem to work as expected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37161">[ date ]</a>
              <a href="thread.html#37161">[ thread ]</a>
              <a href="subject.html#37161">[ subject ]</a>
              <a href="author.html#37161">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I'm using Rabbitmq 3.3.3 on Windows 7.
I installed *rabbitmq-priority-queue plugin*, enable it, and finally restart
Rabbitmq server. When I list rabbitmq plugins I see =&gt; [E]
rabbitmq_priority_queue.

I tried the example from GitHub and it WORKS. Though, it is a very very
simple example.

But,    when I tried some a little bit complex example, the queue seems to
behave in a very strange way.

So, my setup is like this:

First, the common configuration of the queue, just like in the example:

private static final String QUEUE = &quot;my-priority-queue&quot;;

    public static void main(String[] argv) throws Exception {
        ConnectionFactory factory = new ConnectionFactory();
        Connection conn = factory.newConnection();
        Channel ch = conn.createChannel();

        Map&lt;String, Object&gt; args = new HashMap&lt;String, Object&gt;();
        args.put(&quot;x-max-priority&quot;, 10);
        ch.queueDeclare(QUEUE, true, false, false, args);
...


I have a Producer thread that sends messages in intervals of couple of
seconds. For each message I define priority from 0 to 10 just like in the
example. For example sends 10 messages each 2 seconds:

the run() method looks like this:

while(true){
   for(Message message : MESSAGES){

BasicProperties props =
MessageProperties.PERSISTENT_BASIC.builder().priority(message.priority)
.build();
        System.out.println(&quot;Sent &quot; + message.body);
        ch.basicPublish(&quot;&quot;, QUEUE, props, message.body.getBytes());
}
Thread.sleep(2000);

}

Also, there is a Consumer thread which waits for incoming messages and
prints them on the screen:

inside run() method:

QueueingConsumer consumer = new
QueueingConsumer(channel);channel.basicConsume(&quot;hello&quot;, true,
consumer);

while (true) {
    QueueingConsumer.Delivery delivery = consumer.nextDelivery();
    String message = new String(delivery.getBody());
    System.out.println(&quot; [x] Received '&quot; + message + &quot;'&quot;);       }

nothing special...


And the behavior I get is the following:
All the messages that was posted BEFORE the Consumer starts to run are
received in prioritized order, BUT all the messages that sent AFTER the
Consumer starts, are received in the same order they were sent without
concerning a priority. Tried to put some Thread.sleep() in different places
in code to give the queue some time to reorganize itself, but it didn't
work.
So, it seems like priority works only on some static queues without
constantly working Consumer and Producer.
Am I right?
Maybe I am doing something wrong?
Can you please give some complex example for using the priority-queue
plugin?
In my project, we'll have a number of Producers and a number of Consumers
asynchronously putting and taking items from the queue. Does the plugin
support the following scenario?

Thank you,
Nik
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140714/be35fba3/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140714/be35fba3/attachment.html</A>&gt;
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037160.html">[rabbitmq-discuss] rabbitmq connection stay in flow or blocked	state for a long time
</A></li>
	<LI>Next message: <A HREF="037162.html">[rabbitmq-discuss] Priority queue doesn't seem to work as expected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37161">[ date ]</a>
              <a href="thread.html#37161">[ thread ]</a>
              <a href="subject.html#37161">[ subject ]</a>
              <a href="author.html#37161">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
