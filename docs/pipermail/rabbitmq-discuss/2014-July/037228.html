<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Help&#65292;question about rabbitmq+Haproxy&#65292;client java
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%3D%3Futf-8%3Fq%3FHelp%3DEF%3DBC%3D8Cquestion_about_rabbitmq%3F%3D%0A%20%3D%3Futf-8%3Fq%3F%2BHaproxy%3DEF%3DBC%3D8Cclient_java%3F%3D&In-Reply-To=%3Ctencent_6A73B32F04B68D921C89F677%40qq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037230.html">
   <LINK REL="Next"  HREF="037229.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Help&#65292;question about rabbitmq+Haproxy&#65292;client java</H1>
    <B>Aaron</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%3D%3Futf-8%3Fq%3FHelp%3DEF%3DBC%3D8Cquestion_about_rabbitmq%3F%3D%0A%20%3D%3Futf-8%3Fq%3F%2BHaproxy%3DEF%3DBC%3D8Cclient_java%3F%3D&In-Reply-To=%3Ctencent_6A73B32F04B68D921C89F677%40qq.com%3E"
       TITLE="[rabbitmq-discuss] Help&#65292;question about rabbitmq+Haproxy&#65292;client java">584911644 at qq.com
       </A><BR>
    <I>Tue Jul 22 08:53:45 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="037230.html">[rabbitmq-discuss] How to create connection to multiple host using RabbitMQ .net Client
</A></li>
        <LI>Next message: <A HREF="037229.html">[rabbitmq-discuss] =?utf-8?Q?Help=EF=BC=8Cquestion_?=about =?utf-8?Q?rabbitmq+Haproxy=EF=BC=8Cclient_?=java
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37228">[ date ]</a>
              <a href="thread.html#37228">[ thread ]</a>
              <a href="subject.html#37228">[ subject ]</a>
              <a href="author.html#37228">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have let only one node  rabbitmq online in my company in order to decoupling messages.&#8205;    This node has not been down for almost one month fortunately&#65311;but some basic problem&#65292;such as the HA and Load balancing need to be considered&#65292;so that  can keep all messages complete no matter when the related server or app is down.Such like&#65292;another node will  work still and keep the produce&#12289;customer healthy when a node is down.
    So&#65292;i have considered a solution to protect from losting messages,it&#8216;s rabbitmq&#65288;mirrored queue&#65289;+Haproxy.
    I have tried two different code&#65292;php  plays a role&#65292;both HA and load balancing.
    But&#65292;java code is not enough fortunately&#65292;LOL... Testing for several times&#65292;and I get a result&#65292;that is java code doesn&#8216;t work at all in HA,but only load balancing....&#65292;during testing&#65292;when I down a random node&#65292;producer will throw out a related session error.
    Having troubled me for almost one week this problem&#65292;and looking  sincerely forward to ur reply. 
    The environment will be shown below&#65306;
Haproxy&#65306;192.168.1.61:5670
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ubuntu</A> &#65306;192.168.1.61:5672&#65288;3.1.5&#65289;
<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ubuntu2</A>&#65306;192.168.1.35:5672&#65288;3.1.5&#65289;


PHP code&#65306; 
 &lt;?php

$n = 100000;
for($i=0;$i&lt;$n;$i++){
echo '&lt;br/&gt;'.$i;
//&#36830;&#25509;RabbitMQ
$conn_args = array( 'host'=&gt;'192.168.1.61' , 'port'=&gt; '5670', 'login'=&gt;'aaron' , 'password'=&gt; '5555','vhost' =&gt;'/');
$conn = new AMQPConnection($conn_args);
$conn-&gt;connect();

//&#21019;&#24314;exchange&#21517;&#31216;&#21644;&#31867;&#22411;
$channel = new AMQPChannel($conn);
$ex = new AMQPExchange($channel);
$ex-&gt;setName('direct_exchange_name');
$ex-&gt;setType(AMQP_EX_TYPE_DIRECT);
$ex-&gt;setFlags(AMQP_DURABLE | AMQP_AUTODELETE);
$ex-&gt;declare();

//&#21019;&#24314;queue&#21517;&#31216;&#65292;&#20351;&#29992;exchange&#65292;&#32465;&#23450;routingkey
$q = new AMQPQueue($channel);
$q-&gt;setName('queue_name');
$q-&gt;setFlags(AMQP_DURABLE | AMQP_AUTODELETE);
$q-&gt;declare();

$q-&gt;bind('direct_exchange_name', 'routingkey_name');

//&#28040;&#24687;&#21457;&#24067;
$channel-&gt;startTransaction();
$message = json_encode(array('Hello World!','1','2','3','4','DIRECT'));
$ex-&gt;publish($message, 'routingkey_name');
$channel-&gt;commitTransaction();
$conn-&gt;disconnect();
}

?&gt;&#8205; 







JAVA code&#65306;
ConnectionFactory factory = new ConnectionFactory();// &#21019;&#24314;&#38142;&#25509;&#24037;&#21378;
		factory.setHost(&quot;192.168.1.61&quot;);
		factory.setUsername(&quot;aaron&quot;);
		factory.setPassword(&quot;5555&quot;);
factory.setPort(&#8220;5670&#8221;);
factory.setAutomaticRecoveryEnabled(true);

		Connection connection = factory.newConnection();// &#21019;&#24314;&#38142;&#25509;
factory.setNetworkRecoveryInterval(10000);&#8205;
		for(int i = 0; i &lt; 10000; i++) {
			Channel channel = connection.createChannel();// &#21019;&#24314;&#20449;&#24687;&#36890;&#36947;
			channel.exchangeDeclare(EXCHANGE_NAME, &quot;fanout&quot;, durable);// &#21019;&#24314;&#20132;&#25442;&#26426;&#24182;&#29983;&#21629;&#25345;&#20037;&#21270;
			String message = &quot;Hello Wrold &quot; + Math.random();
			// &#28040;&#24687;&#30340;&#25345;&#20037;&#21270;
			channel.basicPublish(EXCHANGE_NAME, &quot;&quot;,
					MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());
			System.out.println(&quot;[x] Sent '&quot; + message + &quot;'&quot;);
			channel.close();
		}
		connection.close();

	}&#8205;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140722/27fb9aae/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140722/27fb9aae/attachment.html</A>&gt;
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037230.html">[rabbitmq-discuss] How to create connection to multiple host using RabbitMQ .net Client
</A></li>
	<LI>Next message: <A HREF="037229.html">[rabbitmq-discuss] =?utf-8?Q?Help=EF=BC=8Cquestion_?=about =?utf-8?Q?rabbitmq+Haproxy=EF=BC=8Cclient_?=java
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37228">[ date ]</a>
              <a href="thread.html#37228">[ thread ]</a>
              <a href="subject.html#37228">[ subject ]</a>
              <a href="author.html#37228">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
