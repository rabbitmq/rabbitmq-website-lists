<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20start_app%20hangs%20when%20replacing%0A%20mirrored%20cluster%20instances%20in%20EC2&In-Reply-To=%3Cd651f7cc-1ff6-4451-87a6-e912d4aa0f2e%40googlegroups.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037086.html">
   <LINK REL="Next"  HREF="037136.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2</H1>
    <B>Mike Zraly</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20start_app%20hangs%20when%20replacing%0A%20mirrored%20cluster%20instances%20in%20EC2&In-Reply-To=%3Cd651f7cc-1ff6-4451-87a6-e912d4aa0f2e%40googlegroups.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2">mzraly at gmail.com
       </A><BR>
    <I>Mon Jul  7 12:30:40 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="037086.html">[rabbitmq-discuss] Changing file descriptor limit wihtout	restart?
</A></li>
        <LI>Next message: <A HREF="037136.html">[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37091">[ date ]</a>
              <a href="thread.html#37091">[ thread ]</a>
              <a href="subject.html#37091">[ subject ]</a>
              <a href="author.html#37091">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>[I tried posting this to the new group, rabbitmq-users, but got no 
response.  Google groups tells me rabbitmq-users only has 101 members now, 
compared to 1800 or so for rabbitmq-discuss, so I hope re-posting to the 
larger group will at least elicit some (non-meta) feedback.]

Hi all,

I am setting up a RabbitMQ cluster in an Amazon EC2 region.  Each host is 
in the same geographical region, so I do not expect network partitions in 
the sense that two members of the cluster are both running but cannot 
communicate with each other.  However it is reasonable to expect individual 
cluster hosts to be terminated and replaced with new hosts having the same 
hostname but a new IP address and a fresh install of RabbitMQ.  A typical 
use case for this is a rolling upgrade where we keep 2 of the 3 cluster 
nodes up at all times to continue providing service during the upgrade 
period.

What I hope is that the same post-install provisioning script that joins a 
newly created instance into the cluster will work for the new instance that 
is taking over for an older one.  What I am seeing is rabbitmqctl start_app 
hang.

The installation sequence is basically this:

install rabbitmq-server_3.3.1-1
enable management plugin
add health check user account with monitoring tag
add application user account
add HA policy '{&quot;ha-mode&quot;: &quot;all&quot;, &quot;ha-sync-mode&quot;: &quot;automatic&quot;} for all 
application queues
service rabbitmq-server stop
set /var/lib/rabbitmq/.erlang.cookie
reboot system (restarting rabbitmq server)
for each hostname 'target' that this host should join into a cluster with:
    if target is listening on port 5672
        rabbitmqctl stop_app
        if rabbitmqctl join_cluster target has non-zero exit status
            rabbitmqctl start_app

What I see if I start a cluster with hosts A, B, and C, then terminate 
instance C and replace it with a new instance that executes these same 
steps, is that rabbitmqctl join_cluster succeeds saying C is already part 
of the cluster, then rabbitmqctl start_app hangs.

What am I doing wrong?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140707/be95dce0/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140707/be95dce0/attachment.html</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037086.html">[rabbitmq-discuss] Changing file descriptor limit wihtout	restart?
</A></li>
	<LI>Next message: <A HREF="037136.html">[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37091">[ date ]</a>
              <a href="thread.html#37091">[ thread ]</a>
              <a href="subject.html#37091">[ subject ]</a>
              <a href="author.html#37091">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
