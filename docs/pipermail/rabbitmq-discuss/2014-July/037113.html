<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Possible bug in Priority Queue plugin
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Possible%20bug%20in%20Priority%20Queue%20plugin&In-Reply-To=%3CD7C993D2A9A4464F8C0E64FEFABA9E426BB385BC%40WAL-MBS02.global.avidww.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037112.html">
   <LINK REL="Next"  HREF="037117.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Possible bug in Priority Queue plugin</H1>
    <B>Steven Blanc</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Possible%20bug%20in%20Priority%20Queue%20plugin&In-Reply-To=%3CD7C993D2A9A4464F8C0E64FEFABA9E426BB385BC%40WAL-MBS02.global.avidww.com%3E"
       TITLE="[rabbitmq-discuss] Possible bug in Priority Queue plugin">steven.blanc at avid.com
       </A><BR>
    <I>Tue Jul  8 22:09:08 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="037112.html">[rabbitmq-discuss] default_user vs definitions
</A></li>
        <LI>Next message: <A HREF="037117.html">[rabbitmq-discuss] Possible bug in Priority Queue plugin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37113">[ date ]</a>
              <a href="thread.html#37113">[ thread ]</a>
              <a href="subject.html#37113">[ subject ]</a>
              <a href="author.html#37113">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have been experimenting with the priority queue plugin (3.3.x-72d20292) with RMQ Server 3.3.2.

I have a simple producer and a simple consumer written in C++ using SimplelAmqpClient.

The consumer app creates  a Channel (SimpleAmpqClient Channel), the exchange, the queue (as a priority queue with x-max-priority of 10) and a binding.
I see this all properly from the RMW Admin GUI.
After that it calls BasicConsume() and then goes into a loop calling BasicConsumeMessage() with a 1 second sleep between calls.

Meanwhile, the simple producer creates a broker connection, then goes into a loop creating messages with a priority value assigned to be either 0 or 10.

Where I think I see a bug is this:
If the consumer calls BasicConsume BEFORE the messages are in the queue, they are consumed in FIFO order, without consideration of the priority value.
If I sleep in the consumer before calling BasicConsume() until all messages are in the queue, they are consumed in priority order.

Am I doing something wrong?  Shouldn't the priority on each message place it in the queue according to priority over time and the already connected consumer(s) will get higher priority messages ahead of lower priority messages all the time?

I looked at the Java example provided here:
<A HREF="https://github.com/rabbitmq/rabbitmq-priority-queue/blob/master/examples/java/src/com/rabbitmq/examples/PriorityQueue.java">https://github.com/rabbitmq/rabbitmq-priority-queue/blob/master/examples/java/src/com/rabbitmq/examples/PriorityQueue.java</A>
I am not a Java programmer, but it appears that example also publishes messages to a priority queue before there is a consumer and then creates a consumer of the queue which retrieves messages in priority order.  Same results I see, but not the desired behavior I am looking for.

Should this work after a consumer is attached to a queue and consuming it for all subsequent messages?

Thanks,
Steve
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140708/a7027dfd/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140708/a7027dfd/attachment.html</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037112.html">[rabbitmq-discuss] default_user vs definitions
</A></li>
	<LI>Next message: <A HREF="037117.html">[rabbitmq-discuss] Possible bug in Priority Queue plugin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37113">[ date ]</a>
              <a href="thread.html#37113">[ thread ]</a>
              <a href="subject.html#37113">[ subject ]</a>
              <a href="author.html#37113">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
