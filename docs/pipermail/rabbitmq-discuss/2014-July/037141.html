<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Connection is always in &quot;flow&quot; State.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Connection%20is%20always%20in%20%22flow%22%20State.&In-Reply-To=%3CCAD6m6fGPAbgR2jjRGit8cYNXkO2iC7wCc0ArGz6ZLnu35JUDZg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037140.html">
   <LINK REL="Next"  HREF="037142.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Connection is always in &quot;flow&quot; State.</H1>
    <B>Jason McIntosh</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Connection%20is%20always%20in%20%22flow%22%20State.&In-Reply-To=%3CCAD6m6fGPAbgR2jjRGit8cYNXkO2iC7wCc0ArGz6ZLnu35JUDZg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Connection is always in &quot;flow&quot; State.">mcintoshj at gmail.com
       </A><BR>
    <I>Thu Jul 10 16:23:31 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="037140.html">[rabbitmq-discuss] Connection is always in &quot;flow&quot; State.
</A></li>
        <LI>Next message: <A HREF="037142.html">[rabbitmq-discuss] Connection is always in &quot;flow&quot; State.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37141">[ date ]</a>
              <a href="thread.html#37141">[ thread ]</a>
              <a href="subject.html#37141">[ subject ]</a>
              <a href="author.html#37141">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Interesting on the 3.3 change.  SO I gotta ask about this situation on that
(though it sounds off hand that'll fix the behavior I've seen on 3.2.4).
 If a consumer is consumer at 80 msgs/second, but incoming rates are able
to publish at 5k a second and the server CPU's/disks/etc. aren't being
touched, will rabbit then put back pressure on the publishing rate forcing
it down to 72 msgs/second (~10% less than consumes)?  I'd assume then
that'd propagate up to the publisher if there's a chain of rabbit servers
all running 3.3 - e.g. the code publish to rabbit which shovels to the
remote rabbit where the code consumer runs.  In this case the code
publisher would get back pressure that'd reduce it's publish rate to
~72msgs/second?

Jason


On Thu, Jul 10, 2014 at 10:01 AM, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;
wrote:

&gt;<i> On 10/07/2014 3:31PM, Jason McIntosh wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Just a quick confirmation on this.  The documentation states that flow
</I>&gt;&gt;<i> control is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   * A per-connection mechanism that prevents messages being published
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     faster than they can be routed to queues.
</I>&gt;&gt;<i>   * A global mechanism that prevents any messages from being published
</I>&gt;&gt;<i>     when the memory usage
</I>&gt;&gt;<i>     &lt;<A HREF="http://www.rabbitmq.com/memory-use.html">http://www.rabbitmq.com/memory-use.html</A>&gt; exceeds a configured
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     threshold or free disk space drops below a configured threshold.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That documentation desperately needs a rewrite :-( It doesn't make very
</I>&gt;<i> clear at all that the &quot;flow&quot; state applies to the first of those two cases
</I>&gt;<i> only; the second will show as &quot;blocking&quot; or &quot;blocked&quot;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  In my testing, I've actually seen this as well - where messages can
</I>&gt;&gt;<i> backlog (so far seems to the point of available resources), while a
</I>&gt;&gt;<i> consumer is chugging along at half the publish speed.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Was this with 3.3.x?
</I>&gt;<i>
</I>&gt;<i> 3.3.x ensures that if consumers and producers are both going as fast as
</I>&gt;<i> they can for an individual queue, then the consumers will consume ~10%
</I>&gt;<i> faster than the producers produce.
</I>&gt;<i>
</I>&gt;<i> For earlier releases there is no such guarantee; it's possible for the
</I>&gt;<i> queue to just naturally accept more messages than it delivers. See the blog
</I>&gt;<i> post on the subject:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/blog/2014/04/10/consumer-bias-in-rabbitmq-3-3/">http://www.rabbitmq.com/blog/2014/04/10/consumer-bias-in-rabbitmq-3-3/</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  SO is flow
</I>&gt;&gt;<i> control also triggered by consumer processing?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Not really; Michael was misinformed in the post you replied to. Flow
</I>&gt;<i> control is explained a bit more at <A HREF="http://www.rabbitmq.com/blog/">http://www.rabbitmq.com/blog/</A>
</I>&gt;<i> 2014/04/14/finding-bottlenecks-with-rabbitmq-3-3/ but in short flow
</I>&gt;<i> control just means that something in the chain (connection -&gt; channel -&gt;
</I>&gt;<i> queue -&gt; message store) is working as hard as it can, and that therefore a
</I>&gt;<i> publisher is not publishing as fast as it would otherwise like to.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  At what point does
</I>&gt;&gt;<i> consumer handling trigger flow control if so?  Just looking for a little
</I>&gt;&gt;<i> bit of clarification on this - I'm guessing there's some internal logic
</I>&gt;&gt;<i> someplace I'm missing on this,
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It doesn't, really. Well, it's possible that you could push the queue over
</I>&gt;<i> to being CPU-bound by adding another consumer and thus having it do
</I>&gt;<i> slightly more work, but you'd have to be teetering on the edge anyway.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>  Thanks!
</I>&gt;&gt;<i> Jason
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Tue, Jul 8, 2014 at 3:33 AM, Michael Klishin &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mklishin at gopivotal.com</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mklishin at gopivotal.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     On 8 July 2014 at 07:49:26, Lost (<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">w_pg at qq.com</A> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">w_pg at qq.com</A>&gt;)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     wrote:
</I>&gt;&gt;<i>      &gt; &gt; I have a client to publish message to rabbitmq(1 connection
</I>&gt;&gt;<i>      &gt; and 1 channel, in same machine with rabbitmq), no consumer.
</I>&gt;&gt;<i>      &gt; Message rates is 2000/s ~ 3000/s
</I>&gt;&gt;<i>      &gt; Traffic is 300Kb/s ~ 750kB/s
</I>&gt;&gt;<i>      &gt; The channel state is &quot;running&quot;, but the connection state is always
</I>&gt;&gt;<i>      &gt; &quot;flow&quot;.
</I>&gt;&gt;<i>      &gt; I found erl.exe cpu is only 5% ~ 10%, but why connection is in
</I>&gt;&gt;<i> &quot;flow&quot;
</I>&gt;&gt;<i>      &gt; state?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Flow control does not depend on CPU usage but rather whether consumers
</I>&gt;&gt;<i>     can keep up with producers. Try adding a consumer.
</I>&gt;&gt;<i>     --
</I>&gt;&gt;<i>     MK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Staff Software Engineer, Pivotal/RabbitMQ
</I>&gt;&gt;<i>     _______________________________________________
</I>&gt;&gt;<i>     rabbitmq-discuss mailing list has moved to
</I>&gt;&gt;<i>     <A HREF="https://groups.google.com/forum/#!forum/rabbitmq-users,">https://groups.google.com/forum/#!forum/rabbitmq-users,</A>
</I>&gt;&gt;<i>     please subscribe to the new list!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i>     &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Jason McIntosh
</I>&gt;&gt;<i> <A HREF="https://github.com/jasonmcintosh/">https://github.com/jasonmcintosh/</A>
</I>&gt;&gt;<i> 573-424-7612
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> rabbitmq-discuss mailing list has moved to <A HREF="https://groups.google.com/">https://groups.google.com/</A>
</I>&gt;&gt;<i> forum/#!forum/rabbitmq-users,
</I>&gt;&gt;<i> please subscribe to the new list!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, Pivotal
</I>&gt;<i>
</I>


-- 
Jason McIntosh
<A HREF="https://github.com/jasonmcintosh/">https://github.com/jasonmcintosh/</A>
573-424-7612
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140710/0c952bd4/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140710/0c952bd4/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037140.html">[rabbitmq-discuss] Connection is always in &quot;flow&quot; State.
</A></li>
	<LI>Next message: <A HREF="037142.html">[rabbitmq-discuss] Connection is always in &quot;flow&quot; State.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37141">[ date ]</a>
              <a href="thread.html#37141">[ thread ]</a>
              <a href="subject.html#37141">[ subject ]</a>
              <a href="author.html#37141">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
