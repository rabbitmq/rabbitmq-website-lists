<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ waits forever for PID file during	startup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20waits%20forever%20for%20PID%20file%20during%0A%09startup&In-Reply-To=%3CCAHuDZ5rWvAJa2q4gxFPa4-HUJkYcp8TwG-oxZr2angy_ZWsB2Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037154.html">
   <LINK REL="Next"  HREF="037138.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ waits forever for PID file during	startup</H1>
    <B>Cesar Munoz</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20waits%20forever%20for%20PID%20file%20during%0A%09startup&In-Reply-To=%3CCAHuDZ5rWvAJa2q4gxFPa4-HUJkYcp8TwG-oxZr2angy_ZWsB2Q%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ waits forever for PID file during	startup">cesar.munoz at ammeon.com
       </A><BR>
    <I>Fri Jul 11 15:39:09 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="037154.html">[rabbitmq-discuss] RabbitMQ waits forever for PID file during startup
</A></li>
        <LI>Next message: <A HREF="037138.html">[rabbitmq-discuss] rabbitmq cluster startup problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37156">[ date ]</a>
              <a href="thread.html#37156">[ thread ]</a>
              <a href="subject.html#37156">[ subject ]</a>
              <a href="author.html#37156">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simon,

the thing is, /var/run/rabbitmq/pid still contains the &quot;Cannot allocate
memory&quot; error, that's probably why the wait pid is still blocked. The
system logs are not saying anything new, but we run sos after reproducing
the issue and we're taking a look to see if there is anything interesting.
I'll let you know!

Thanks,
Cesar.


On 11 July 2014 11:37, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt; wrote:

&gt;<i> On 10/07/2014 3:02PM, Cesar Munoz wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Simon,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> so we have tried to find the problem with the initial installation, but
</I>&gt;&gt;<i> no luck yet. It is very difficult to track it, as it is totally
</I>&gt;&gt;<i> non-deterministic!
</I>&gt;&gt;<i> In the meantime, we installed the latest version of RabbitMQ, which
</I>&gt;&gt;<i> includes de set -e fix, but the same issue still happened. Given the
</I>&gt;&gt;<i> output of ps auxf
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://gist.github.com/anonymous/62239513b154179a8a4e">https://gist.github.com/anonymous/62239513b154179a8a4e</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> it looks like
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> /bin/sh /etc/init.d/rabbitmq-server start
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> /bin/sh /usr/sbin/rabbitmqctlwait  /var/run/rabbitmq/pid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> were running concurrently. Is there any chance that this fact created
</I>&gt;&gt;<i> some sort of race condition between these 2 processes that would make
</I>&gt;&gt;<i> the set -e fix not work?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The &quot;set -e&quot; should cause a failure in the case where the script was not
</I>&gt;<i> able to write the pid file for whatever reason. That's all. Looking at the
</I>&gt;<i> ps output posted in the latest case, the startup has got past that point as
</I>&gt;<i> it's started the beam process for the server.
</I>&gt;<i>
</I>&gt;<i> &quot;rabbitmqctl wait&quot; should wait indefinitely for the server to start up, as
</I>&gt;<i> long as the server has not actually died.
</I>&gt;<i>
</I>&gt;<i> But it looks like something is getting stuck? Is there anything in the
</I>&gt;<i> server logs at this point? Bearing in mind that the machine in question has
</I>&gt;<i> claimed to run out of memory writing a 5-byte file, so I don't necessarily
</I>&gt;<i> trust it.
</I>&gt;<i>
</I>&gt;<i> Cheers, Simon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Cheers,
</I>&gt;&gt;<i> Cesar.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 6 June 2014 11:55, Cesar Munoz &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cesar.munoz at ammeon.com</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">cesar.munoz at ammeon.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Hi Simon,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     the ulimits for rabbitmq user are pretty much the same, the only
</I>&gt;&gt;<i>     difference is that max user processes is set to 1024 instead of
</I>&gt;&gt;<i> 2066207.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     About the system itself, it is true that there has to be something
</I>&gt;&gt;<i>     strange going on if a shell redirection can fail, but I'm checking
</I>&gt;&gt;<i>     the configuration and I don't see anything specially awkward.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     We are using Red Hat 6.4, and these are the parameters that we set
</I>&gt;&gt;<i>     in the sysctl.conf:
</I>&gt;&gt;<i>     <A HREF="http://pastebin.com/SfJBwrna">http://pastebin.com/SfJBwrna</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     The rest of the parameters in the kickstart file are pretty much the
</I>&gt;&gt;<i>     standard ones.
</I>&gt;&gt;<i>     This is an intermittent issue (we are testing how often it happens,
</I>&gt;&gt;<i>     so far we got 3 failures in 13 installations), so it is harder to
</I>&gt;&gt;<i>     track it!
</I>&gt;&gt;<i>     Either way, restarting the service works, so it looks like whatever
</I>&gt;&gt;<i>     causes the problem disappears after a while. I've been trying to
</I>&gt;&gt;<i>     find what could make this non-deterministic, but so far I haven't
</I>&gt;&gt;<i>     noticed anything unusual.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Thanks again!
</I>&gt;&gt;<i>     Cesar.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     On 6 June 2014 11:27, Simon MacMullen &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>
</I>&gt;&gt;<i>     &lt;mailto:<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">simon at rabbitmq.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         On 06/06/2014 10:49AM, Cesar Munoz wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             Hi Simon,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             the set -e looks like a very good idea, at least the process
</I>&gt;&gt;<i>             will return
</I>&gt;&gt;<i>             the failure straight away!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Sure!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             These are the ulimits:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">root at ms1</A> ~]# ulimit -a
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         &lt;snip&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Those are the ulimits which apply to root - maybe they are
</I>&gt;&gt;<i>         different for the &quot;rabbitmq&quot; user?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         But more to the point: we're failing to do something very very
</I>&gt;&gt;<i>         simple here, there has to be something weird about this system
</I>&gt;&gt;<i>         if echo or shell redirection can fail with an error message
</I>&gt;&gt;<i>         about memory allocation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         So have you configured anything unusual about this system?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         Cheers, Simon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         --
</I>&gt;&gt;<i>         Simon MacMullen
</I>&gt;&gt;<i>         RabbitMQ, Pivotal
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This email and any files transmitted with it are confidential and
</I>&gt;&gt;<i> intended solely for the use of the individual or entity to whom they are
</I>&gt;&gt;<i> addressed. If you have received this email in error please notify the
</I>&gt;&gt;<i> system manager. This message contains confidential information and is
</I>&gt;&gt;<i> intended only for the individual named. If you are not the named
</I>&gt;&gt;<i> addressee you should not disseminate, distribute or copy this e-mail.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Simon MacMullen
</I>&gt;<i> RabbitMQ, Pivotal
</I>&gt;<i>
</I>
-- 
This email and any files transmitted with it are confidential and intended 
solely for the use of the individual or entity to whom they are addressed. 
If you have received this email in error please notify the system manager. 
This message contains confidential information and is intended only for the 
individual named. If you are not the named addressee you should not 
disseminate, distribute or copy this e-mail.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140711/ce9cac7c/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140711/ce9cac7c/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037154.html">[rabbitmq-discuss] RabbitMQ waits forever for PID file during startup
</A></li>
	<LI>Next message: <A HREF="037138.html">[rabbitmq-discuss] rabbitmq cluster startup problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37156">[ date ]</a>
              <a href="thread.html#37156">[ thread ]</a>
              <a href="subject.html#37156">[ subject ]</a>
              <a href="author.html#37156">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
