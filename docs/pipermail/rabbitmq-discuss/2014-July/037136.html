<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20start_app%20hangs%20when%20replacing%0A%20mirrored%20cluster%20instances%20in%20EC2&In-Reply-To=%3CCAD6m6fH_SpdjZKd2i4qKdmKkLm7JBnzVwbgZywQobi5yZ7i3Lg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037091.html">
   <LINK REL="Next"  HREF="037137.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2</H1>
    <B>Jason McIntosh</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20rabbitmqctl%20start_app%20hangs%20when%20replacing%0A%20mirrored%20cluster%20instances%20in%20EC2&In-Reply-To=%3CCAD6m6fH_SpdjZKd2i4qKdmKkLm7JBnzVwbgZywQobi5yZ7i3Lg%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2">mcintoshj at gmail.com
       </A><BR>
    <I>Thu Jul 10 15:39:55 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="037091.html">[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2
</A></li>
        <LI>Next message: <A HREF="037137.html">[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37136">[ date ]</a>
              <a href="thread.html#37136">[ thread ]</a>
              <a href="subject.html#37136">[ subject ]</a>
              <a href="author.html#37136">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>If this is what I've seen before the cluster thinks C is node XYZ.  But
you're trying to tell the cluster that C is really your new host YZX.  You
need to remove the old node from the cluster to add your new node as a
replacement for C.  Your new node tries to start up and thinks it should be
part of the cluster because you just tried to join it, but the cluster
refuses to accept the new node so it seems to hang.  I could be completely
wrong on this though.

As I recall, there was a rabbitmqctl command to completely remove a node
from the cluster, though I don't recall what it is off hand.  You could try
doing that first and then adding your node?

Jason


On Mon, Jul 7, 2014 at 6:30 AM, Mike Zraly &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mzraly at gmail.com</A>&gt; wrote:

&gt;<i> [I tried posting this to the new group, rabbitmq-users, but got no
</I>&gt;<i> response.  Google groups tells me rabbitmq-users only has 101 members now,
</I>&gt;<i> compared to 1800 or so for rabbitmq-discuss, so I hope re-posting to the
</I>&gt;<i> larger group will at least elicit some (non-meta) feedback.]
</I>&gt;<i>
</I>&gt;<i> Hi all,
</I>&gt;<i>
</I>&gt;<i> I am setting up a RabbitMQ cluster in an Amazon EC2 region.  Each host is
</I>&gt;<i> in the same geographical region, so I do not expect network partitions in
</I>&gt;<i> the sense that two members of the cluster are both running but cannot
</I>&gt;<i> communicate with each other.  However it is reasonable to expect individual
</I>&gt;<i> cluster hosts to be terminated and replaced with new hosts having the same
</I>&gt;<i> hostname but a new IP address and a fresh install of RabbitMQ.  A typical
</I>&gt;<i> use case for this is a rolling upgrade where we keep 2 of the 3 cluster
</I>&gt;<i> nodes up at all times to continue providing service during the upgrade
</I>&gt;<i> period.
</I>&gt;<i>
</I>&gt;<i> What I hope is that the same post-install provisioning script that joins a
</I>&gt;<i> newly created instance into the cluster will work for the new instance that
</I>&gt;<i> is taking over for an older one.  What I am seeing is rabbitmqctl start_app
</I>&gt;<i> hang.
</I>&gt;<i>
</I>&gt;<i> The installation sequence is basically this:
</I>&gt;<i>
</I>&gt;<i> install rabbitmq-server_3.3.1-1
</I>&gt;<i> enable management plugin
</I>&gt;<i> add health check user account with monitoring tag
</I>&gt;<i> add application user account
</I>&gt;<i> add HA policy '{&quot;ha-mode&quot;: &quot;all&quot;, &quot;ha-sync-mode&quot;: &quot;automatic&quot;} for all
</I>&gt;<i> application queues
</I>&gt;<i> service rabbitmq-server stop
</I>&gt;<i> set /var/lib/rabbitmq/.erlang.cookie
</I>&gt;<i> reboot system (restarting rabbitmq server)
</I>&gt;<i> for each hostname 'target' that this host should join into a cluster with:
</I>&gt;<i>     if target is listening on port 5672
</I>&gt;<i>         rabbitmqctl stop_app
</I>&gt;<i>         if rabbitmqctl join_cluster target has non-zero exit status
</I>&gt;<i>             rabbitmqctl start_app
</I>&gt;<i>
</I>&gt;<i> What I see if I start a cluster with hosts A, B, and C, then terminate
</I>&gt;<i> instance C and replace it with a new instance that executes these same
</I>&gt;<i> steps, is that rabbitmqctl join_cluster succeeds saying C is already part
</I>&gt;<i> of the cluster, then rabbitmqctl start_app hangs.
</I>&gt;<i>
</I>&gt;<i> What am I doing wrong?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list has moved to
</I>&gt;<i> <A HREF="https://groups.google.com/forum/#!forum/rabbitmq-users,">https://groups.google.com/forum/#!forum/rabbitmq-users,</A>
</I>&gt;<i> please subscribe to the new list!
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Jason McIntosh
<A HREF="https://github.com/jasonmcintosh/">https://github.com/jasonmcintosh/</A>
573-424-7612
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140710/580803d4/attachment.html">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20140710/580803d4/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037091.html">[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2
</A></li>
	<LI>Next message: <A HREF="037137.html">[rabbitmq-discuss] rabbitmqctl start_app hangs when replacing mirrored cluster instances in EC2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37136">[ date ]</a>
              <a href="thread.html#37136">[ thread ]</a>
              <a href="subject.html#37136">[ subject ]</a>
              <a href="author.html#37136">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
