<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RES:  RES: [Rabbit + SSL connection] AMQP &#9786;closed ?? Is it normal?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%3D%3Futf-8%3Fq%3FRES%3D3A__RES%3D3A_%3D5BRabbit_%2B_SSL_conne%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fction%3D5D_AMQP_%3DE2%3D98%3DBAclosed_%3D3F%3D3F_Is_it_normal%3D3F%3F%3D&In-Reply-To=%3CCD6B5DD5E1D03B4DA1AB7655BEDC4E8A3E745827A6%40socrates.local.inatel.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037047.html">
   <LINK REL="Next"  HREF="037052.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RES:  RES: [Rabbit + SSL connection] AMQP &#9786;closed ?? Is it normal?</H1>
    <B>Rodrigo Pimenta Carvalho</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20%3D%3Futf-8%3Fq%3FRES%3D3A__RES%3D3A_%3D5BRabbit_%2B_SSL_conne%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fction%3D5D_AMQP_%3DE2%3D98%3DBAclosed_%3D3F%3D3F_Is_it_normal%3D3F%3F%3D&In-Reply-To=%3CCD6B5DD5E1D03B4DA1AB7655BEDC4E8A3E745827A6%40socrates.local.inatel.br%3E"
       TITLE="[rabbitmq-discuss] RES:  RES: [Rabbit + SSL connection] AMQP &#9786;closed ?? Is it normal?">pimenta at inatel.br
       </A><BR>
    <I>Tue Jul  1 22:22:03 BST 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="037047.html">[rabbitmq-discuss] RES: [Rabbit + SSL connection] AMQP =?utf-8?Q?=E2=98=BAclosed_?=?? Is it normal?
</A></li>
        <LI>Next message: <A HREF="037052.html">[rabbitmq-discuss] Rabbitmq File descriptor ,	socket descritor and memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37048">[ date ]</a>
              <a href="thread.html#37048">[ thread ]</a>
              <a href="subject.html#37048">[ subject ]</a>
              <a href="author.html#37048">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Michael.

The exact command I have used is:
--------------------------------------------
openssl s_client -connect localhost:5671 -cert client/cert.pem -key client/key.pem -CAfile testca/cacert.pem



The exact result is:
----------------------
Loading 'screen' into random state - done
CONNECTED(000001BC)
depth=1 CN = MyTestCA
verify return:1
depth=0 CN = ICCSW-109, O = server
verify return:1
---
Certificate chain
 0 s:/CN=ICCSW-109/O=server
   i:/CN=MyTestCA
 1 s:/CN=MyTestCA
   i:/CN=MyTestCA
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIC4jCCAcqgAwIBAgIBATANBgkqhkiG9w0BAQUFADATMREwDwYDVQQDDAhNeVRl
c3RDQTAeFw0xNDA2MjcxMzAyMDBaFw0xNTA2MjcxMzAyMDBaMCUxEjAQBgNVBAMM
CUlDQ1NXLTEwOTEPMA0GA1UECgwGc2VydmVyMIIBIjANBgkqhkiG9w0BAQEFAAOC
AQ8AMIIBCgKCAQEAqyosJfGAjRgCbU3OP2VDAcE8vj8gNjHTFXlEkZnVeP1qyRr9
k67lG54YGttPsR/jislJgPd0sckrOoCfZikptU6ZGfYOO0b0/1rtkbuFqhdhZLle
z3XLC3RDE2hXMueDbY4vEuDKSZ2GRawCaMC4a7q5nRluI+VO8CJmHgr1uROsWQQ4
nAPJ/R3LPxbU4xmqGeOpRMl+Hw9UB3adAtIT+/zYg8JNu+1UBgHuXdL94yPG/lFm
c2WAJYflb+9yWMv5U/jHOEI2F3KWno4qiuquLCrpEX6uDNEnDhRwlu4A3oNiQXJQ
9+IO3f6icnoZxvhsq6hgnyrcrpyF7Ntvo1FlVQIDAQABoy8wLTAJBgNVHRMEAjAA
MAsGA1UdDwQEAwIFIDATBgNVHSUEDDAKBggrBgEFBQcDATANBgkqhkiG9w0BAQUF
AAOCAQEAHzIDuherNlWYlJye6v4a10xnsG3gV8c/TgGLtnK+oMwx9Jj376hUH4Ga
lwZ/7c6cFFUUUVsenjFbK6VrHCQrQFIaQbs62bGj8gbQPVbixhNCcDeu/0oK7iVL
wked5VoKcfHQ6msdJ+gZmaG3pU+8iHCfDEpYab5YOr2HORld6E2TdIpRRw+zj2/U
K4DVh2oFiD/C8H8qwBi4dFa8qBAbE7L/Xxi44FSRUAg/5RZ+FbPqd0fzThLh646T
knhbA8nh3nrFVPfrHp/Bkog4fx8gnUjFPYPVyh/AuBpG+cb0i68f+baoKtg5yKtQ
eKyyaJxv7lL55Q3+mlJ/LflFhLSjLw==
-----END CERTIFICATE-----
subject=/CN=ICCSW-109/O=server
issuer=/CN=MyTestCA
---
Acceptable client certificate CA names
/CN=MyTestCA
---
SSL handshake has read 1728 bytes and written 2420 bytes
---
New, TLSv1/SSLv3, Cipher is AES256-SHA256
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : AES256-SHA256
    Session-ID: 75DAF625DC4A8458E7B539A5430C13F8602304D1B841476ED04214ECDFB48CCC
    Session-ID-ctx:
    Master-Key: 01909073E5427FB2D81F0438F26A8EF64857BF08713DCE004C6E556D39FA565995716817C3A4EDA7D7FC861B0CFDFA2E
    Key-Arg   : None
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    Start Time: 1404247934
    Timeout   : 300 (sec)
    Verify return code: 0 (ok)
---
closed                                                                                                                    // closed after 10 seconds. And according to you, in an earlie email, it is ok.


Two terminals mean two prompts for commands, where I had tested keys and certificates with OpenSSL, exactly how it is explained in the RabbitMQ SSL Troubleshooting web page. All is ok here too. I&#180;m using Windows 7.

My RabbitMQ java client is:
----------------------------------

public class Send_Hello {
	
	private final static String QUEUE_NAME = &quot;task_queue_r&quot;;

	/**
	 * @param args
	 * @throws IOException 
	 */
	public static void main(String[] args) throws IOException {
		

		try {
	        char[] keyPassphrase = &quot;XXXclp&quot;.toCharArray();
	        KeyStore ks = KeyStore.getInstance(&quot;PKCS12&quot;);
	        ks.load(new FileInputStream(&quot;E:\\path\\certificadosB\\server\\keycert.p12&quot;), keyPassphrase);

	        KeyManagerFactory kmf = KeyManagerFactory.getInstance(&quot;SunX509&quot;);
	        kmf.init(ks, keyPassphrase); 

	        char[] trustPassphrase = &quot;XXXVVclp&quot;.toCharArray();
	        KeyStore tks = KeyStore.getInstance(&quot;JKS&quot;);
	        tks.load(new FileInputStream(&quot;E:\\path\\certificadosB\\server\\rabbitstore&quot;), trustPassphrase);


	        TrustManagerFactory tmf = TrustManagerFactory.getInstance(&quot;SunX509&quot;);
	        tmf.init(tks);

	        SSLContext c = SSLContext.getInstance(&quot;SSLv3&quot;);
	        c.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);	
	        
	        
		    ConnectionFactory factory = new ConnectionFactory();                                                                      // the exception rises here.

		    factory.setHost(&quot;localhost&quot;); 

		    factory.setUsername(&quot;pimenta&quot;);                                                                                                           //pimenta is an administrator.
		    factory.setPassword(&quot;pimenta&quot;);

	           factory.setPort(5671);

		   factory.useSslProtocol(c);

		    Connection connection = factory.newConnection();

		    Channel channel = connection.createChannel();


		    boolean durable = true;
		    channel.queueDeclare(QUEUE_NAME, durable, false, false, null); 

		    
		    String message = &quot;Hello World.&quot;;
		    channel.basicPublish(&quot;&quot;, QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());

		    System.out.println(&quot; [x] Sent '&quot; + message + &quot;'&quot;);
		    

		     channel.close();
		     connection.close();
	        
		} catch (KeyStoreException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (NoSuchAlgorithmException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (CertificateException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (UnrecoverableKeyException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (KeyManagementException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

	}
}

The output of this code is:
-------------------------------------
Exception in thread &quot;main&quot; java.net.SocketException: Software caused connection abort: recv failed
	at java.net.SocketInputStream.socketRead0(Native Method)
	at java.net.SocketInputStream.read(Unknown Source)
	at java.net.SocketInputStream.read(Unknown Source)
	at sun.security.ssl.InputRecord.readFully(Unknown Source)
	at sun.security.ssl.InputRecord.read(Unknown Source)
	at sun.security.ssl.SSLSocketImpl.readRecord(Unknown Source)
	at sun.security.ssl.SSLSocketImpl.performInitialHandshake(Unknown Source)
	at sun.security.ssl.SSLSocketImpl.writeRecord(Unknown Source)
	at sun.security.ssl.AppOutputStream.write(Unknown Source)
	at java.io.BufferedOutputStream.flushBuffer(Unknown Source)
	at java.io.BufferedOutputStream.flush(Unknown Source)
	at java.io.DataOutputStream.flush(Unknown Source)
	at com.rabbitmq.client.impl.SocketFrameHandler.sendHeader(SocketFrameHandler.java:129)
	at com.rabbitmq.client.impl.SocketFrameHandler.sendHeader(SocketFrameHandler.java:134)
	at com.rabbitmq.client.impl.AMQConnection.start(AMQConnection.java:276)
	at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:590)
	at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:612)
	at br.inatel.icc.prototypeRabbitMQ.Send_Hello.main(Send_Hello.java:81)


In the log I have:
-----------------------------------------------------------------------------
=INFO REPORT==== 1-Jul-2014::18:14:02 ===
accepting AMQP connection &lt;0.361.0&gt; (127.0.0.1:56445 -&gt; 127.0.0.1:5671)

=ERROR REPORT==== 1-Jul-2014::18:14:02 ===
SSL: certify: ssl_handshake.erl:1358:Fatal error: handshake failure

=ERROR REPORT==== 1-Jul-2014::18:14:07 ===
error on AMQP connection &lt;0.361.0&gt;:
{ssl_upgrade_error,{tls_alert,&quot;handshake failure&quot;}}


In the config file I have
-----------------------------------

    {ssl_listeners, [5671]},
    {ssl_options, [{cacertfile,           &quot;E:/path/certificadosB/testca/cacert.pem&quot;},
                   {certfile,             &quot;E:/path/certificadosB/server/cert.pem&quot;},
                   {keyfile,              &quot;E:/path/certificadosB/server/key.pem&quot;},
                   {verify,               verify_peer},   
                   {fail_if_no_peer_cert, false}]}


Would you like to see my key, certificates and CA certificate file? Could I send it attached in a next message?

Thank very much you for your effort in help !!

BR,
 
RODRIGO PIMENTA CARVALHO
Inatel Competence Center
Software
Ph: +55 35 3471 9979     (Brasil)
________________________________________
De: Michael Klishin [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">mklishin at gopivotal.com</A>]
Enviado: ter&#231;a-feira, 1 de julho de 2014 17:31
Para: Rodrigo Pimenta Carvalho; Legacy list about RabbitMQ
Assunto: Re: [rabbitmq-discuss] RES: [Rabbit + SSL connection] AMQP &#9786;closed ?? Is it normal?

On 2 July 2014 at 00:23:05, Rodrigo Pimenta Carvalho (<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pimenta at inatel.br</A>) wrote:
&gt;<i> &gt; So, now my unique problem is what happen when I use a RabbitMQ
</I>&gt;<i> client. It is:
</I>&gt;<i>
</I>&gt;<i> 4. =ERROR REPORT==== 27-Jun-2014(<A HREF="http://airmail.calendar/2014-06-27%2012:00:00%20GMT+4">http://airmail.calendar/2014-06-27%2012:00:00%20GMT+4</A>)::13:44:56
</I>&gt;<i> ===
</I>&gt;<i> 5. SSL: certify: ssl_handshake.erl:1358:Fatal error: handshake
</I>&gt;<i> failure
</I>&gt;<i> 6.
</I>&gt;<i> 7. =ERROR REPORT==== 27-Jun-2014()::13:45:01
</I>&gt;<i> ===
</I>&gt;<i> 8. error on AMQP connection &lt;0.301.0&gt;:
</I>&gt;<i> 9. {ssl_upgrade_error,{tls_alert,&quot;handshake failure&quot;}}
</I>
This is a very generic error. Please post the code you use and s_client output
(and the exact command you run).

In an earlier email you say

&quot;- Keys and certificates with OpenSSL is OK! The certificates and keys can be used to establish a secure link by connecting two terminals. &quot;

I'm not sure what &quot;two terminals&quot; means. You need to use s_client with RabbitMQ server,
not openssl s_server, for example.
--
MK

Staff Software Engineer, Pivotal/RabbitMQ
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037047.html">[rabbitmq-discuss] RES: [Rabbit + SSL connection] AMQP =?utf-8?Q?=E2=98=BAclosed_?=?? Is it normal?
</A></li>
	<LI>Next message: <A HREF="037052.html">[rabbitmq-discuss] Rabbitmq File descriptor ,	socket descritor and memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37048">[ date ]</a>
              <a href="thread.html#37048">[ thread ]</a>
              <a href="subject.html#37048">[ subject ]</a>
              <a href="author.html#37048">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
