<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%3F%20about%20rabbitmq%201.7.1%20and%207-byte%20frame%0A%09headers&In-Reply-To=34AB5F29-3543-4709-8FF8-4604CDE392BA%40setf.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006359.html">
   <LINK REL="Next"  HREF="006352.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers</H1>
    <B>Alexis Richardson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%3F%20about%20rabbitmq%201.7.1%20and%207-byte%20frame%0A%09headers&In-Reply-To=34AB5F29-3543-4709-8FF8-4604CDE392BA%40setf.de"
       TITLE="[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers">alexis.richardson at gmail.com
       </A><BR>
    <I>Tue Feb 16 18:24:38 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006359.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers
</A></li>
        <LI>Next message: <A HREF="006352.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers (2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6360">[ date ]</a>
              <a href="thread.html#6360">[ thread ]</a>
              <a href="subject.html#6360">[ subject ]</a>
              <a href="author.html#6360">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>James

Just to address your first question, our aim is convergence to 0-91
and this is mutual in that Qpid 0.6 (Java) and OpenAMQ pass enough
0-91 tests to be able to call themselves 0-91 brokers.  Each one has
some unimplemented parts eg OpenAMQ don't do persistence IIRC.  I have
cc'd the relevant folks.  I'm sorry it's taken us so long - there are
some reasons for this but nothing surprising.  Do also note that Qpid
C++ is on 0-10 and will stay there.  In the future there will be an
AMQP 1-0 which will enable even greater convergence, and a wider set
of implementations.

I hope someone else will pick up on your other questions.

Let me know if this helps.

alexis




On Tue, Feb 16, 2010 at 6:13 PM, james anderson &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">james.anderson at setf.de</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On 2010-02-16, at 13:38 , Michael Bridgen wrote:
</I>&gt;<i>
</I>&gt;<i> James,
</I>&gt;<i> As a preface, let me note that 0-9-1 is in part a rationalisation of the
</I>&gt;<i> specification, and in part an encoding of what brokers actually implement.
</I>&gt;<i> 0-8 had ambiguities and inconsistencies quite aside from the more obvious
</I>&gt;<i> mistakes (like the grammar for the protocol header), but what the brokers
</I>&gt;<i> ended up implementing was by and large consistent.
</I>&gt;<i> If you're planning to implement an AMQP peer, personally speaking I would go
</I>&gt;<i> for 0-9-1 and forget about 0-8.
</I>&gt;<i>
</I>&gt;<i> your note, below, refers to rabbitmq's imminent plans. how does this reflect
</I>&gt;<i> the state and intentions of other brokers?
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;Not only has it fewer mistakes, but it is also (or will be soon, see
</I>&gt;<i> below) a stable point of interoperability.
</I>&gt;<i>
</I>&gt;<i> james anderson wrote:
</I>&gt;<i>
</I>&gt;<i> a recently built rabbitmq server server indicates - even to the level&#160; of
</I>&gt;<i> the response server properties, that it implements &quot;amqp 8-0&quot;, but
</I>&gt;<i> a. if one connects with a 9-1 version token, it does not disconnect.&#160; it
</I>&gt;<i> proceeds to negotiate the connection.
</I>&gt;<i>
</I>&gt;<i> That is expected behaviour for a 0-8 broker, at the least by some
</I>&gt;<i> interpretations of the spec - if the client specifies a higher version
</I>&gt;<i> number than supported by the server then negotiation proceeds with the
</I>&gt;<i> server sending the version it supports.
</I>&gt;<i>
</I>&gt;<i> The protocol negotiation is a bit odd.&#160; In the technical spec (PDF) it says
</I>&gt;<i> what you have said above; in the XML it adds the rule &quot;The server MUST
</I>&gt;<i> provide a protocol version that is lower than or equal to that requested by
</I>&gt;<i> the client in the protocol header.&quot;
</I>&gt;<i>
</I>&gt;<i> i must admit, page-8/lines-3-5 of amqp-xml-doc0-8.pdf resisted
</I>&gt;<i> comprehension. in the end, however, the second sentence, can be interpreted
</I>&gt;<i> to restrict the meaning of a lower protocol number to indicate only how far
</I>&gt;<i> down the broker can go, as that sentence precludes the broker from sending
</I>&gt;<i> the start command if it can not support the requested - higher - version.
</I>&gt;<i> anyway, i take from your remarks, that other implementors reached different
</I>&gt;<i> conclusions.
</I>&gt;<i>
</I>&gt;<i> Hence you can have a negotiation which goes:
</I>&gt;<i> Client: Hi, I would like to use protocol 0-9-1
</I>&gt;<i> Server: Sure!&#160; I support that.&#160; OK, let's use version 0-8
</I>&gt;<i> Client: WTF?
</I>&gt;<i> So yeah, a bit nuts.
</I>&gt;<i>
</I>&gt;<i> that is to say, page-52/line-38 and the diagrams at page-52/line32 and
</I>&gt;<i> page-53/line-11 of amqp8-0.pdf are no more a misrepresentation of
</I>&gt;<i> &quot;accordingly&quot; for a purported r8.0 broker than the indication in
</I>&gt;<i> `amqp-xml-doc0-8.pdf` that it applies to &quot;AMQ Protocol (major=10, minor=3)&quot;?
</I>&gt;<i>
</I>&gt;<i> NB: the correct protocol header for 0-9-1 is in fact AMQP 0-0-9-1, whereas
</I>&gt;<i> for 0-8 it is AMQP 1-1-8-0, and for 0-9 it is AMQP 1-1-0-9. Yes, that is
</I>&gt;<i> crazy.
</I>&gt;<i>
</I>&gt;<i> cool.
</I>&gt;<i> hmmm... what does the ampq 1-1-9-1 protocol header from the r8.0 and the
</I>&gt;<i> r9.1 specs actually mean?
</I>&gt;<i> is that what you intended, above, with &quot;AMQP 0-0-9-1&quot;?
</I>&gt;<i>
</I>&gt;<i> In 0-9-1 the protocol header is 'AMQP0091'.&#160; The last four digits are the
</I>&gt;<i> constant 0 (protocol-id, whatever that is), then the major, minor and
</I>&gt;<i> revision numbers.&#160; The 0-8 and 0-9 specs gave these digits a different
</I>&gt;<i> meaning (and the first two were effectively constants).
</I>&gt;<i> I just tried connecting to a RabbitMQ from default branch and giving a 0-9-1
</I>&gt;<i> header, and it wrote AMQP1180 and closed the connection, as specified.&#160; From
</I>&gt;<i> which branch did you build?
</I>&gt;<i>
</I>&gt;<i> from the 1.7.1 release.
</I>&gt;<i> i had misunderstood the version-to-header mapping and had, in fact, sent it
</I>&gt;<i> a 0.9r0 protocol header, not a 0.9r1 header. to wit:
</I>&gt;<i> ? (defparameter *c* (make-instance 'amqp:connection :uri
</I>&gt;<i> &quot;<A HREF="amqp://guest:guest@localhost/&quot;">amqp://guest:guest@localhost/&quot;</A>))
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: open-connection:
</I>&gt;<i> requesting version: #(65 77 81 80 1 1 0 9)/:AMQP-1-1-0-9-1.
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: open-connection:
</I>&gt;<i> byte-zero: 1, updated class to AMQP-1-1-0-9-1:CONNECTION.
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CHANNEL [<A HREF="amqp://localhost/].0">amqp://localhost/].0</A> #xF757B2E&gt;:
</I>&gt;<i> process-command: #&lt;CONNECTION #xF753016&gt; #&lt;CONNECTION.START #xF759DEE&gt; .
</I>&gt;<i> (:VERSION-MAJOR 8 :VERSION-MINOR 0 :SERVER-PROPERTIES (:|product| &quot;RabbitMQ&quot;
</I>&gt;<i> :|version| &quot;1.7.1&quot; :|platform| &quot;Erlang/OTP&quot; :|copyright| &quot;Copyright (C)
</I>&gt;<i> 2007-2009 LShift Ltd., Cohesive Financial Technologies LLC., and Rabbit
</I>&gt;<i> Technologies Ltd.&quot; :|information| &quot;Licensed under the MPL.&#160; See
</I>&gt;<i> <A HREF="http://www.rabbitmq.com/&quot;">http://www.rabbitmq.com/&quot;</A>) :MECHANISMS &quot;PLAIN AMQPLAIN&quot; :LOCALES &quot;en_US&quot;)
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method: START-OK .
</I>&gt;<i> (:CLIENT-PROPERTIES NIL :MECHANISM &quot;PLAIN&quot; :RESPONSE &quot;guestguest&quot; :LOCALE
</I>&gt;<i> &quot;en_US&quot;)
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: encoding:
</I>&gt;<i> CONNECTION.START-OK . (:CLIENT-PROPERTIES NIL :MECHANISM &quot;PLAIN&quot;
</I>&gt;<i> :RESPONSE&#160;&quot;guestguest&quot; :LOCALE &quot;en_US&quot;)
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method:
</I>&gt;<i> #&lt;CONNECTION.START-OK #xF75A34E&gt;&#160; #&lt;OUTPUT-FRAME
</I>&gt;<i> [(+)METHOD|0|c.0|t.0].{CONNECTION.START-OK}[36/4088: 0 10 0 11 0 0 0 0 ...
</I>&gt;<i> 115 116 5 101 110 95 85 83] #xF75A446&gt;
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CHANNEL [<A HREF="amqp://localhost/].0">amqp://localhost/].0</A> #xF757B2E&gt;:
</I>&gt;<i> process-command: #&lt;CONNECTION #xF753016&gt; #&lt;CONNECTION.TUNE #xF75B67E&gt; .
</I>&gt;<i> (:CHANNEL-MAX 0 :FRAME-MAX 131072 :HEARTBEAT 0)
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method: TUNE-OK .
</I>&gt;<i> (:CHANNEL-MAX 0 :FRAME-MAX 131072 :HEARTBEAT 0)
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: encoding:
</I>&gt;<i> CONNECTION.TUNE-OK . (:CHANNEL-MAX 0 :FRAME-MAX 131072 :HEARTBEAT 0)
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method:
</I>&gt;<i> #&lt;CONNECTION.TUNE-OK #xF75B886&gt;&#160; #&lt;OUTPUT-FRAME
</I>&gt;<i> [(+)METHOD|0|c.0|t.0].{CONNECTION.TUNE-OK}[12/4088: 0 10 0 31 0 0 0 2 0 0 0
</I>&gt;<i> 0] #xF75A446&gt;
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method: OPEN .
</I>&gt;<i> (:VIRTUAL-HOST &quot;/&quot;)
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: encoding:
</I>&gt;<i> CONNECTION.OPEN . (:VIRTUAL-HOST &quot;/&quot;)
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method:
</I>&gt;<i> #&lt;CONNECTION.OPEN #xF75BBEE&gt;&#160; #&lt;OUTPUT-FRAME
</I>&gt;<i> [(+)METHOD|0|c.0|t.0].{CONNECTION.OPEN}[8/4088: 0 10 0 40 1 47 0 0]
</I>&gt;<i> #xF75A446&gt;
</I>&gt;<i> [20100216T123124Z00] DEBUG #&lt;CHANNEL [<A HREF="amqp://localhost/].0">amqp://localhost/].0</A> #xF757B2E&gt;:
</I>&gt;<i> process-command: #&lt;CONNECTION #xF753016&gt; #&lt;CONNECTION.OPEN-OK #xF75BE5E&gt; .
</I>&gt;<i> NIL
</I>&gt;<i> *C*
</I>&gt;<i> ? (type-of *c*)
</I>&gt;<i> AMQP-1-1-0-9-1:CONNECTION
</I>&gt;<i> to which it responded with a Connection.Start with a version 8 in the
</I>&gt;<i> properties.
</I>&gt;<i> having now rewired it to follow the suggested version-&gt;header mapping i
</I>&gt;<i> observe the expected response to a 'standard' 0.9r1 header:
</I>&gt;<i> ? (defparameter *c* (make-instance 'amqp:connection :uri
</I>&gt;<i> &quot;<A HREF="amqp://guest:guest@localhost/&quot;">amqp://guest:guest@localhost/&quot;</A>))
</I>&gt;<i> [20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:
</I>&gt;<i> requesting version: #(65 77 81 80 0 0 9 1)/:AMQP-1-1-0-9-1.
</I>&gt;<i> [20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection: parsed
</I>&gt;<i> version: #(65 77 81 80 1 1 8 0) / :AMQP-1-1-0-8-0.
</I>&gt;<i> [20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:
</I>&gt;<i> updated class to AMQP-1-1-0-8-0:CONNECTION.
</I>&gt;<i> [20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:
</I>&gt;<i> requesting version: #(65 77 81 80 1 1 8 0)/:AMQP-1-1-0-8-0.
</I>&gt;<i> [20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:
</I>&gt;<i> byte-zero: 1, connection class AMQP-1-1-0-8-0:CONNECTION.
</I>&gt;&gt;<i> Error: Frame length exceeds buffer size: 73728, #&lt;VECTOR 4087 type
</I>&gt;&gt;<i> (UNSIGNED-BYTE 8), simple&gt;
</I>&gt;&gt;<i> While executing: CCL::%ASSERTION-FAILURE
</I>&gt;&gt;<i> Type Command-/ to continue, Command-. to abort.
</I>&gt;&gt;<i> If continued: test the assertion again.
</I>&gt;<i> See the Restarts&#8230; menu item for further choices.
</I>&gt;<i> 1 &gt;
</I>&gt;<i> the frame size error being the same as that which had led yesterday to the
</I>&gt;<i> realization that it was using 7-byte headers.
</I>&gt;<i>
</I>&gt;<i> b. it does not use the 8-byte frame headers which appear in every&#160; instance
</I>&gt;<i> of the amqp0-8 specification the net had yielded, but rather&#160; 7-byte headers
</I>&gt;<i> that are specified for 9-1.
</I>&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> All implementations of 0-8 actually use a 7-byte header. Hence the
</I>&gt;<i> correction in 0-9-1.
</I>&gt;<i>
</I>&gt;<i> do these two sentences boggle any other minds?
</I>&gt;<i> a naive reader of the r8.0 specification might misconstrue it to require,
</I>&gt;<i> that such a correction would apply to a broker which purports to follow the
</I>&gt;<i> r9.1 spec, but not to broker which purports to follow the r8.0 spec. in this
</I>&gt;<i> light, i have rescanned the r8.0 spec, but did not observe any formulations
</I>&gt;<i> of the order &quot;or any later protocol version.&quot; ok. anyway, i gather that
</I>&gt;<i> page-35/line-26 and page-53/line-29 of amqp8-0.pdf are history. is there
</I>&gt;<i> anything else of which a naive implementor should be aware?
</I>&gt;<i>
</I>&gt;<i> Many things, I should think, sadly.&#160; The things corrected, or cleared up, in
</I>&gt;<i> 0-9-1 give some indication.
</I>&gt;<i>
</I>&gt;<i> what does this imply for the way the broker handles realms and tickets?
</I>&gt;<i> is is that
</I>&gt;<i> 1. every 0.8r0 and 0.9r* broker follows 0.9r1 framing specifications.
</I>&gt;<i> 2. the respective 0.8 and 0.9 brokers each otherwise implement the
</I>&gt;<i> classes/methods/arguments/rules in the respective .xml version of the
</I>&gt;<i> specification.
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;&gt;<i> [...]
</I>&gt;<i>
</I>&gt;<i> ? are there actually any r9.0 brokers in the wild?
</I>&gt;<i>
</I>&gt;<i> Qpid's Java broker implements 0-9 and 0-9-1, inter alia.&#160; RabbitMQ has a
</I>&gt;<i> branch implementing 0-9-1 (amqp_0_9_1 in the broker and most of the client
</I>&gt;<i> repos), which should make its way into releases once work on the new
</I>&gt;<i> persister is done.
</I>&gt;<i>
</I>&gt;<i> on a meta level: how does this community achieve interoperability, other by
</I>&gt;<i> knowing each other's code?
</I>&gt;<i>
</I>&gt;<i> Also by using each other's code; e.g., we use Qpid's (Python) test suites,
</I>&gt;<i> in part, and they have been using our 0-9-1 (Java) test suite.
</I>&gt;<i>
</I>&gt;<i> mikeb.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006359.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers
</A></li>
	<LI>Next message: <A HREF="006352.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers (2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6360">[ date ]</a>
              <a href="thread.html#6360">[ thread ]</a>
              <a href="subject.html#6360">[ subject ]</a>
              <a href="author.html#6360">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
