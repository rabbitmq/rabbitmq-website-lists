<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] routing threads on a rabbitmq node
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20routing%20threads%20on%20a%20rabbitmq%20node&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006125.html">
   <LINK REL="Next"  HREF="006122.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] routing threads on a rabbitmq node</H1>
    <B>Brian Sullivan</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20routing%20threads%20on%20a%20rabbitmq%20node&In-Reply-To="
       TITLE="[rabbitmq-discuss] routing threads on a rabbitmq node">bsullivan at lindenlab.com
       </A><BR>
    <I>Mon Feb  1 06:41:01 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006125.html">[rabbitmq-discuss] PubSub - all bindings have to be in memory?
</A></li>
        <LI>Next message: <A HREF="006122.html">[rabbitmq-discuss] routing threads on a rabbitmq node
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6110">[ date ]</a>
              <a href="thread.html#6110">[ thread ]</a>
              <a href="subject.html#6110">[ subject ]</a>
              <a href="author.html#6110">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I am curious if anyone on the rabbitmq team can confirm/clarify what we are
seeing with respect to some throughput issues on our RMQ cluster.

The config:
- 2-node RMQ cluster, running a topic-based exchange
- 8 publishers, running on different hosts
- dozens of consumers, ~75 wildcard topic bindings, mostly running on
different hosts (there are a couple running on the RMQ hosts for stats, etc)

The issue:
When we publish at a higher rate than normal, there appears to be a
significant delay in the pipeline between when we publish the messages and
when we receive them on the consuming side.  Since publishing is
asynchronous, the publisher applications send as fast as they can, meanwhile
we see an increasing delay in when we see those same messages come out on
the other side.  My guess (gathered from
<A HREF="http://www.rabbitmq.com/faq.html#node-per-CPU-core">http://www.rabbitmq.com/faq.html#node-per-CPU-core</A>) is that there is either
a single routing thread per publisher (channel), or even worse a single
routing bottleneck per node.  Either way, this thread cannot route fast
enough in a topic exchange (we have about 75 bindings, using wildcards) and
there is a backup of messages to be routed.

This is dangerous and hard to control, since we have seen memory grow in
such a way that we have a hard time stopping it.  In certain failure modes,
when the publisher disconnects, all of the messages pending to be routed are
discarded - possibly hours of data in our environment.  It also limits the
scaling we've been able to do, since if we fire up all 8 publishers at high
volume, this backup problem spreads across all streams.

The question:
Can you please elaborate on where the routing backup could be occurring, and
what steps might be best to prevent this from happening?  It appears from
the fact that I am waiting on the routing to happen that using flags like
&quot;mandatory&quot; on messages is not going to help me here (though I have not
tested this).

One idea:
If it is truly the case that a single thread per node might be causing this
problem, then perhaps we can run a small rabbitmq node on each publisher
(joined to the cluster), with the sole purpose of doing the routing load?
If we publish locally, all it would need to do is keep up with it's own
routing load, not the combine routing load of 3 other publishers.  It
doesn't really prevent the problem from happening though, if I can produce
messages faster in a single thread than even a dedicated node can route.
Would this even help?

Thanks,
Brian
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100131/1f783db0/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100131/1f783db0/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006125.html">[rabbitmq-discuss] PubSub - all bindings have to be in memory?
</A></li>
	<LI>Next message: <A HREF="006122.html">[rabbitmq-discuss] routing threads on a rabbitmq node
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6110">[ date ]</a>
              <a href="thread.html#6110">[ thread ]</a>
              <a href="subject.html#6110">[ subject ]</a>
              <a href="author.html#6110">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
