<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] beam process using 100% cpu and lots of memory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20beam%20process%20using%20100%25%20cpu%20and%20lots%20of%0A%20memory&In-Reply-To=4f89225b1002151551p1cccdf63uccb1a44fb902d320%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006348.html">
   <LINK REL="Next"  HREF="006466.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] beam process using 100% cpu and lots of memory</H1>
    <B>Matthew Sackman</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20beam%20process%20using%20100%25%20cpu%20and%20lots%20of%0A%20memory&In-Reply-To=4f89225b1002151551p1cccdf63uccb1a44fb902d320%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] beam process using 100% cpu and lots of memory">matthew at lshift.net
       </A><BR>
    <I>Sat Feb 20 21:00:21 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006348.html">[rabbitmq-discuss] beam process using 100% cpu and lots of	memory
</A></li>
        <LI>Next message: <A HREF="006466.html">[rabbitmq-discuss] Taking error_logger out of the &quot;fast path&quot; (was Re: beam process using 100% cpu and lots of memory)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6420">[ date ]</a>
              <a href="thread.html#6420">[ thread ]</a>
              <a href="subject.html#6420">[ subject ]</a>
              <a href="author.html#6420">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Joel,

On Tue, Feb 16, 2010 at 10:51:31AM +1100, Joel Heenan wrote:
&gt;<i> We are having a situation where when we put lots of data through a
</I>&gt;<i> RabbitMQ queue we sometimes we see a beam process running using 100%
</I>&gt;<i> cpu and up to 1.5GB (RSS) of memory. The only way to resolve this
</I>&gt;<i> situation is to restart RabbitMQ.
</I>
Nah, if you leave it alone for a while, it'll probably recover. ;)

You may be just seeing a badly overwhelmed queue, which probably would
recover eventually. Or it could be that you're running out of RAM and
it's starting to thrash swap. You may wish to test using the new
persister branch as that is much better at dealing with memory pressure.
However, before you even try that, how long are the queues getting, what
is the average size of the messages being published, and at what rate
are the messages being published?

&gt;<i> We are talking a very large number of connections here, 1807334
</I>&gt;<i> connections in 17 hours, or 29/second.
</I>
That's potentially a problem. We've recently discovered that the error
logger, as it logs a couple of messages for every connection, isn't very
fast, and its mailbox can rapidly grow. We only noticed this because of,
what looked like, a DDoS against a public installation - that was 1000s
of connections a second, and the error logger was effectively becoming a
memory leak.

Could you not do any sort of connection pooling? Making a connection +
channel just to publish a couple of messages is spectacularly
inefficient.

&gt;<i> We started using RabbitMQ Stomp Server 1.6.0-5 then moved to version
</I>&gt;<i> latest public umbrella (as of 24 hours ago). OS is Centos 5.4 x86_64
</I>&gt;<i> Xen domU with 4GB of RAM and 1VCPU.
</I>&gt;<i> 
</I>&gt;<i> We are using persistent mode on the queues, currently testing with
</I>&gt;<i> non-persistent.
</I>
If you're not using the new persister (branch bug21673), that likely
won't make too much difference as all messages are always held in RAM.

If you could provide a few more details then we may have a better idea
of what to suggest.

Matthew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006348.html">[rabbitmq-discuss] beam process using 100% cpu and lots of	memory
</A></li>
	<LI>Next message: <A HREF="006466.html">[rabbitmq-discuss] Taking error_logger out of the &quot;fast path&quot; (was Re: beam process using 100% cpu and lots of memory)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6420">[ date ]</a>
              <a href="thread.html#6420">[ thread ]</a>
              <a href="subject.html#6420">[ subject ]</a>
              <a href="author.html#6420">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
