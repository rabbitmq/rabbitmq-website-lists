<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%3F%20about%20rabbitmq%201.7.1%20and%207-byte%0A%09frame%09headers&In-Reply-To=39A3F001-E073-452F-8E81-9A751E2C9A92%40setf.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006351.html">
   <LINK REL="Next"  HREF="006359.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers</H1>
    <B>Michael Bridgen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%3F%20about%20rabbitmq%201.7.1%20and%207-byte%0A%09frame%09headers&In-Reply-To=39A3F001-E073-452F-8E81-9A751E2C9A92%40setf.de"
       TITLE="[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers">mikeb at lshift.net
       </A><BR>
    <I>Tue Feb 16 12:38:56 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006351.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers
</A></li>
        <LI>Next message: <A HREF="006359.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6354">[ date ]</a>
              <a href="thread.html#6354">[ thread ]</a>
              <a href="subject.html#6354">[ subject ]</a>
              <a href="author.html#6354">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>James,

As a preface, let me note that 0-9-1 is in part a rationalisation of the 
specification, and in part an encoding of what brokers actually 
implement.  0-8 had ambiguities and inconsistencies quite aside from the 
more obvious mistakes (like the grammar for the protocol header), but 
what the brokers ended up implementing was by and large consistent.

If you're planning to implement an AMQP peer, personally speaking I 
would go for 0-9-1 and forget about 0-8.  Not only has it fewer 
mistakes, but it is also (or will be soon, see below) a stable point of 
interoperability.

&gt;&gt;<i> james anderson wrote:
</I>&gt;&gt;&gt;<i> a recently built rabbitmq server server indicates - even to the 
</I>&gt;&gt;&gt;<i> level  of the response server properties, that it implements &quot;amqp 
</I>&gt;&gt;&gt;<i> 8-0&quot;, but
</I>&gt;&gt;&gt;<i> a. if one connects with a 9-1 version token, it does not disconnect.  
</I>&gt;&gt;&gt;<i> it proceeds to negotiate the connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is expected behaviour for a 0-8 broker, at the least by some 
</I>&gt;&gt;<i> interpretations of the spec - if the client specifies a higher version 
</I>&gt;&gt;<i> number than supported by the server then negotiation proceeds with the 
</I>&gt;&gt;<i> server sending the version it supports.
</I>
The protocol negotiation is a bit odd.  In the technical spec (PDF) it 
says what you have said above; in the XML it adds the rule &quot;The server 
MUST provide a protocol version that is lower than or equal to that 
requested by the client in the protocol header.&quot;

Hence you can have a negotiation which goes:
Client: Hi, I would like to use protocol 0-9-1
Server: Sure!  I support that.  OK, let's use version 0-8
Client: WTF?

So yeah, a bit nuts.

&gt;<i> that is to say, page-52/line-38 and the diagrams at page-52/line32 and 
</I>&gt;<i> page-53/line-11 of amqp8-0.pdf are no more a misrepresentation of 
</I>&gt;<i> &quot;accordingly&quot; for a purported r8.0 broker than the indication in 
</I>&gt;<i> `amqp-xml-doc0-8.pdf` that it applies to &quot;AMQ Protocol (major=10, minor=3)&quot;?
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NB: the correct protocol header for 0-9-1 is in fact AMQP 0-0-9-1, 
</I>&gt;&gt;<i> whereas for 0-8 it is AMQP 1-1-8-0, and for 0-9 it is AMQP 1-1-0-9. 
</I>&gt;&gt;<i> Yes, that is crazy.
</I>&gt;<i> 
</I>&gt;<i> cool.
</I>&gt;<i> hmmm... what does the ampq 1-1-9-1 protocol header from the r8.0 and the 
</I>&gt;<i> r9.1 specs actually mean?
</I>&gt;<i> is that what you intended, above, with &quot;AMQP 0-0-9-1&quot;?
</I>
In 0-9-1 the protocol header is 'AMQP0091'.  The last four digits are 
the constant 0 (protocol-id, whatever that is), then the major, minor 
and revision numbers.  The 0-8 and 0-9 specs gave these digits a 
different meaning (and the first two were effectively constants).

I just tried connecting to a RabbitMQ from default branch and giving a 
0-9-1 header, and it wrote AMQP1180 and closed the connection, as 
specified.  From which branch did you build?

&gt;&gt;&gt;<i> b. it does not use the 8-byte frame headers which appear in every  
</I>&gt;&gt;&gt;<i> instance of the amqp0-8 specification the net had yielded, but 
</I>&gt;&gt;&gt;<i> rather  7-byte headers that are specified for 9-1.
</I> &gt;&gt;
&gt;&gt;<i> All implementations of 0-8 actually use a 7-byte header. Hence the 
</I>&gt;&gt;<i> correction in 0-9-1.
</I>&gt;<i> 
</I>&gt;<i> do these two sentences boggle any other minds?
</I>&gt;<i> a naive reader of the r8.0 specification might misconstrue it to 
</I>&gt;<i> require, that such a correction would apply to a broker which purports 
</I>&gt;<i> to follow the r9.1 spec, but not to broker which purports to follow the 
</I>&gt;<i> r8.0 spec. in this light, i have rescanned the r8.0 spec, but did not 
</I>&gt;<i> observe any formulations of the order &quot;or any later protocol version.&quot; 
</I>&gt;<i> ok. anyway, i gather that page-35/line-26 and page-53/line-29 of 
</I>&gt;<i> amqp8-0.pdf are history. is there anything else of which a naive 
</I>&gt;<i> implementor should be aware?
</I>
Many things, I should think, sadly.  The things corrected, or cleared 
up, in 0-9-1 give some indication.

 &gt; [...]

&gt;<i> ? are there actually any r9.0 brokers in the wild?
</I>
Qpid's Java broker implements 0-9 and 0-9-1, inter alia.  RabbitMQ has a 
branch implementing 0-9-1 (amqp_0_9_1 in the broker and most of the 
client repos), which should make its way into releases once work on the 
new persister is done.

&gt;<i> on a meta level: how does this community achieve interoperability, other 
</I>&gt;<i> by knowing each other's code?
</I>
Also by using each other's code; e.g., we use Qpid's (Python) test 
suites, in part, and they have been using our 0-9-1 (Java) test suite.


mikeb.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006351.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers
</A></li>
	<LI>Next message: <A HREF="006359.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6354">[ date ]</a>
              <a href="thread.html#6354">[ thread ]</a>
              <a href="subject.html#6354">[ subject ]</a>
              <a href="author.html#6354">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
