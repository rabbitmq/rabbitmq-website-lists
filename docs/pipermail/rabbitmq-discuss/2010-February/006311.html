<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] amqp_channel_open issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20amqp_channel_open%20issue&In-Reply-To=20100211160733.GB2942%40mrnibble.lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006303.html">
   <LINK REL="Next"  HREF="006394.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] amqp_channel_open issue</H1>
    <B>raghu a</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20amqp_channel_open%20issue&In-Reply-To=20100211160733.GB2942%40mrnibble.lshift.net"
       TITLE="[rabbitmq-discuss] amqp_channel_open issue">a.raghu001 at gmail.com
       </A><BR>
    <I>Fri Feb 12 13:48:40 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006303.html">[rabbitmq-discuss] amqp_channel_open issue
</A></li>
        <LI>Next message: <A HREF="006394.html">[rabbitmq-discuss] amqp_channel_open issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6311">[ date ]</a>
              <a href="thread.html#6311">[ thread ]</a>
              <a href="subject.html#6311">[ subject ]</a>
              <a href="author.html#6311">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for your response.
As per my code each thread is using different channel.
May I get any  multi threaded C client samples?
Could you please let me know the constraints also?

thanks,
Ragavendra.


On Thu, Feb 11, 2010 at 9:37 PM, Matthew Sackman &lt;<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthew at lshift.net</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm afraid the RabbitMQ-C client is highly experimental and not really
</I>&gt;<i> receiving much development attention at the moment. We would not
</I>&gt;<i> recommend it for production use - it has not been through our QA
</I>&gt;<i> processes. I'm fairly sure that you need to make sure that you don't use
</I>&gt;<i> a channel from more than one thread, but I have a feeling there are even
</I>&gt;<i> more constraints than that. I'm afraid, if in doubt, don't use the C
</I>&gt;<i> client, at the moment.
</I>&gt;<i>
</I>&gt;<i> Matthew
</I>&gt;<i>
</I>&gt;<i> On Wed, Feb 10, 2010 at 05:41:49PM +0000, raghu a wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am very new to RabbitMQ. we are using Rabbit MQ C API to talk with the
</I>&gt;<i> &gt; broker.
</I>&gt;<i> &gt; We are playing with the examples(with few modifications) given by
</I>&gt;<i> RabbitMQ.
</I>&gt;<i> &gt; We created one producer and one consumer with the same connection but
</I>&gt;<i> &gt; difference channels.
</I>&gt;<i> &gt; In the following code amqp_channel_open(conn, 2) statement is causing the
</I>&gt;<i> my
</I>&gt;<i> &gt; main thread to block
</I>&gt;<i> &gt; but if i move this statement before creating of consumer thread then
</I>&gt;<i> every
</I>&gt;<i> &gt; thing seems to be working.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My code is as follows.
</I>&gt;<i> &gt; static void send_batch(amqp_connection_
</I>&gt;<i> &gt; state_t conn,
</I>&gt;<i> &gt;                        char const *queue_name,
</I>&gt;<i> &gt;                        int rate_limit,
</I>&gt;<i> &gt;                        int message_count)
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;   char message[256] = &quot;test&quot;;
</I>&gt;<i> &gt;   die_on_error(amqp_basic_publish(conn,
</I>&gt;<i> &gt;                                     2,
</I>&gt;<i> &gt;                                     amqp_cstring_bytes(&quot;amq.direct&quot;),
</I>&gt;<i> &gt;                                     amqp_cstring_bytes(queue_name),
</I>&gt;<i> &gt;                                     0,
</I>&gt;<i> &gt;                                     0,
</I>&gt;<i> &gt;                                     NULL,
</I>&gt;<i> &gt;                                     (amqp_bytes_t) {.len =
</I>&gt;<i> sizeof(message),
</I>&gt;<i> &gt; .bytes = message}),
</I>&gt;<i> &gt;                  &quot;Publishing&quot;);
</I>&gt;<i> &gt;     printf(&quot;Message sent by producer\n&quot;);
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; static void run(amqp_connection_state_t conn)
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;   amqp_frame_t frame;
</I>&gt;<i> &gt;   int result;
</I>&gt;<i> &gt;   size_t body_received;
</I>&gt;<i> &gt;   size_t body_target;
</I>&gt;<i> &gt;   int  received = 0;
</I>&gt;<i> &gt;   while (1) {
</I>&gt;<i> &gt;     amqp_maybe_release_buffers(conn);
</I>&gt;<i> &gt;     result = amqp_simple_wait_frame(conn, &amp;frame);
</I>&gt;<i> &gt;     if (result &lt;= 0) return;
</I>&gt;<i> &gt;     if (frame.frame_type != AMQP_FRAME_METHOD)
</I>&gt;<i> &gt;       continue;
</I>&gt;<i> &gt;     if (frame.payload.method.id != AMQP_BASIC_DELIVER_METHOD)
</I>&gt;<i> &gt;       continue;
</I>&gt;<i> &gt;     result = amqp_simple_wait_frame(conn, &amp;frame);
</I>&gt;<i> &gt;     if (result &lt;= 0) return;
</I>&gt;<i> &gt;     if (frame.frame_type != AMQP_FRAME_HEADER) {
</I>&gt;<i> &gt;       abort();
</I>&gt;<i> &gt;     }
</I>&gt;<i> &gt;     body_target = frame.payload.properties.body_size;
</I>&gt;<i> &gt;     body_received = 0;
</I>&gt;<i> &gt;     while (body_received &lt; body_target) {
</I>&gt;<i> &gt;       result = amqp_simple_wait_frame(conn, &amp;frame);
</I>&gt;<i> &gt;       if (result &lt;= 0) return;
</I>&gt;<i> &gt;       if (frame.frame_type != AMQP_FRAME_BODY) {
</I>&gt;<i> &gt;     abort();
</I>&gt;<i> &gt;       }
</I>&gt;<i> &gt;       body_received += frame.payload.body_fragment.len;
</I>&gt;<i> &gt;       assert(body_received &lt;= body_target);
</I>&gt;<i> &gt;     }
</I>&gt;<i> &gt;     received++;
</I>&gt;<i> &gt;     printf(&quot;received=%d\n&quot;,received);
</I>&gt;<i> &gt;   }
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt; void*  consume(void* conn){
</I>&gt;<i> &gt;   run(*((amqp_connection_state_t*)conn));
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt; int main(int argc, char const * const *argv) {
</I>&gt;<i> &gt;   char const *hostname=&quot;127.0.0.1&quot;;
</I>&gt;<i> &gt;   int port=&quot;5672&quot;;
</I>&gt;<i> &gt;   char const *exchange;
</I>&gt;<i> &gt;   char const *bindingkey;
</I>&gt;<i> &gt;   int sockfd;
</I>&gt;<i> &gt;   amqp_connection_state_t conn;
</I>&gt;<i> &gt;   amqp_bytes_t queuename;
</I>&gt;<i> &gt;   exchange = &quot;amq.direct&quot;; //argv[3];
</I>&gt;<i> &gt;   bindingkey = &quot;test queue&quot;; //argv[4];
</I>&gt;<i> &gt;   int rate_limit = 100;
</I>&gt;<i> &gt;   int message_count = 10000;
</I>&gt;<i> &gt;   conn = amqp_new_connection();
</I>&gt;<i> &gt;   die_on_error(sockfd = amqp_open_socket(hostname, port), &quot;Opening
</I>&gt;<i> socket&quot;);
</I>&gt;<i> &gt;   amqp_set_sockfd(conn, sockfd);
</I>&gt;<i> &gt;   die_on_amqp_error(amqp_login(conn, &quot;/&quot;, 0, 131072, 0,
</I>&gt;<i> &gt; AMQP_SASL_METHOD_PLAIN, &quot;guest&quot;, &quot;guest&quot;),
</I>&gt;<i> &gt;             &quot;Logging in&quot;);
</I>&gt;<i> &gt;   amqp_channel_open(conn, 1);
</I>&gt;<i> &gt;   die_on_amqp_error(amqp_rpc_reply, &quot;Opening channel&quot;);
</I>&gt;<i> &gt;   {
</I>&gt;<i> &gt;     amqp_queue_declare_ok_t *r = amqp_queue_declare(conn, 1,
</I>&gt;<i> &gt; AMQP_EMPTY_BYTES, 0, 0, 0, 1,
</I>&gt;<i> &gt;                             AMQP_EMPTY_TABLE);
</I>&gt;<i> &gt;     die_on_amqp_error(amqp_rpc_reply, &quot;Declaring queue&quot;);
</I>&gt;<i> &gt;     queuename = amqp_bytes_malloc_dup(r-&gt;queue);
</I>&gt;<i> &gt;     if (queuename.bytes == NULL) {
</I>&gt;<i> &gt;       die_on_error(-ENOMEM, &quot;Copying queue name&quot;);
</I>&gt;<i> &gt;     }
</I>&gt;<i> &gt;   }
</I>&gt;<i> &gt;   amqp_queue_bind(conn, 1, queuename, amqp_cstring_bytes(exchange),
</I>&gt;<i> &gt; amqp_cstring_bytes(bindingkey),
</I>&gt;<i> &gt;           AMQP_EMPTY_TABLE);
</I>&gt;<i> &gt;   die_on_amqp_error(amqp_rpc_reply, &quot;Binding queue&quot;);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   amqp_basic_consume(conn, 1, queuename, AMQP_EMPTY_BYTES, 0, 1, 0);
</I>&gt;<i> &gt;   die_on_amqp_error(amqp_rpc_reply, &quot;Consuming&quot;);
</I>&gt;<i> &gt;   pthread_t threadId;
</I>&gt;<i> &gt;   pthread_create(&amp;threadId,NULL,consume,(void*)&amp;conn);
</I>&gt;<i> &gt;   sleep(1);
</I>&gt;<i> &gt;   amqp_channel_open(conn, 2);
</I>&gt;<i> &gt;   send_batch(conn, &quot;test queue&quot;, rate_limit, message_count);
</I>&gt;<i> &gt;   die_on_amqp_error(amqp_channel_close(conn, 1, AMQP_REPLY_SUCCESS),
</I>&gt;<i> &gt; &quot;Closing channel&quot;);
</I>&gt;<i> &gt;   die_on_amqp_error(amqp_connection_close(conn, AMQP_REPLY_SUCCESS),
</I>&gt;<i> &gt; &quot;Closing connection&quot;);
</I>&gt;<i> &gt;   amqp_destroy_connection(conn);
</I>&gt;<i> &gt;   die_on_error(close(sockfd), &quot;Closing socket&quot;);
</I>&gt;<i> &gt;   return 0;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Please provide me the reasons for blocking.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt; Ragavendra.
</I>&gt;<i>
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; rabbitmq-discuss mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100212/220ff64a/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100212/220ff64a/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006303.html">[rabbitmq-discuss] amqp_channel_open issue
</A></li>
	<LI>Next message: <A HREF="006394.html">[rabbitmq-discuss] amqp_channel_open issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6311">[ date ]</a>
              <a href="thread.html#6311">[ thread ]</a>
              <a href="subject.html#6311">[ subject ]</a>
              <a href="author.html#6311">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
