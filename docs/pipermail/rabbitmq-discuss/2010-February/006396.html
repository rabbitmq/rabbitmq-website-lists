<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ (branch bug21673) running out of file	descriptors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20%28branch%20bug21673%29%20running%20out%20of%20file%0A%09descriptors&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006470.html">
   <LINK REL="Next"  HREF="006397.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ (branch bug21673) running out of file	descriptors</H1>
    <B>Andrey Smirnov</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20RabbitMQ%20%28branch%20bug21673%29%20running%20out%20of%20file%0A%09descriptors&In-Reply-To="
       TITLE="[rabbitmq-discuss] RabbitMQ (branch bug21673) running out of file	descriptors">smirnov.andrey at gmail.com
       </A><BR>
    <I>Thu Feb 18 07:58:34 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006470.html">[rabbitmq-discuss] How to compile rabbitmq-c with visual c++ 2005?
</A></li>
        <LI>Next message: <A HREF="006397.html">[rabbitmq-discuss] RabbitMQ (branch bug21673) running out of	file descriptors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6396">[ date ]</a>
              <a href="thread.html#6396">[ thread ]</a>
              <a href="subject.html#6396">[ subject ]</a>
              <a href="author.html#6396">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello!

We're running RabbitMQ from branch bug21673 (built yesterday). We have
a lot of non-persisten queues (2k - 10k+) that are created/destroyed
all the time. Some queues have unconsumed messaged and they will get
destroyed with unconsumed messages.

When file descriptor limit for RabbitMQ was left to default 1024 files
it was dying in 2 hours. I've raised the limit to 10240 files and it
worked for 16 hours and crashed.

Crash for clients looks like &quot;INTERNAL_ERROR&quot; error on connections.
RabbitMQ is still running and eating 100% of CPU. Restarting RabbitMQ
helps to revive it.

Adding log file excerpt (log is huge, it contains dump of all internal
state, I have it if someone will be interested):

=INFO REPORT==== 16-Feb-2010::04:42:05 ===
Limiting to approx 10190 file handles

=INFO REPORT==== 16-Feb-2010::04:42:05 ===
Memory limit set to 3196MB.

=INFO REPORT==== 16-Feb-2010::04:42:05 ===
Using rabbit_msg_store_ets_index to provide index for message store

=INFO REPORT==== 16-Feb-2010::04:42:05 ===
started TCP Listener on 0.0.0.0:5672

=INFO REPORT==== 16-Feb-2010::04:42:26 ===
accepted TCP connection on 0.0.0.0:5672 from &lt;redacted&gt;:35525

.....

ERROR REPORT==== 17-Feb-2010::17:32:16 ===
** Generic server &lt;0.7466.264&gt; terminating
** Last message in was {'$gen_cast',
                           {method,
                               {'queue.declare',0,

&lt;&lt;&quot;qik.item.session.83c5e30a-180e-4f2a-b59d-c6bd7938faac&quot;&gt;&gt;,
                                   false,false,false,false,false,[]},
                               none}}
** When Server state == {ch,running,3,&lt;0.1622.0&gt;,&lt;0.7464.264&gt;,undefined,none,
                            {set,0,16,16,8,80,48,
                                 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                  [],[]},
                                 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                   [],[]}}},
                            1,
                            {[],[]},
                            {[],[]},
                            &lt;&lt;&quot;guest&quot;&gt;&gt;,&lt;&lt;&quot;localhost&quot;&gt;&gt;,

&lt;&lt;&quot;qik.item.session.6c6a3c8e-38d7-4c69-bb1c-26ae3cc00d67&quot;&gt;&gt;,
                            {dict,0,16,16,8,80,48,
                                  {[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                   [],[]},
                                  {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
                                    [],[]}}}}
** Reason for termination ==
** {{badmatch,{error,{{badmatch,{error,emfile}},
                      [{rabbit_queue_index,get_journal_handle,1},
                       {rabbit_queue_index,load_journal,1},
                       {rabbit_queue_index,init,1},
                       {rabbit_variable_queue,init,1},
                       {rabbit_amqqueue_process,init,1},
                       {gen_server2,init_it,6},
                       {proc_lib,init_p_do_apply,3}]}}},
    [{rabbit_amqqueue,start_queue_process,1},
     {rabbit_amqqueue,declare,4},
     {rabbit_channel,handle_method,3},
     {rabbit_channel,handle_cast,2},
     {gen_server2,handle_msg,7},
     {proc_lib,wake_up,3}]}

=ERROR REPORT==== 17-Feb-2010::17:32:16 ===
connection &lt;0.1622.0&gt; (running), channel 3 - error:
{{badmatch,{error,{{badmatch,{error,emfile}},
                   [{rabbit_queue_index,get_journal_handle,1},
                    {rabbit_queue_index,load_journal,1},
                    {rabbit_queue_index,init,1},
                    {rabbit_variable_queue,init,1},
                    {rabbit_amqqueue_process,init,1},
                    {gen_server2,init_it,6},

....

=ERROR REPORT==== 17-Feb-2010::17:33:08 ===
Mnesia(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at SM2</A>): ** ERROR ** (core dumped to file:
&quot;/usr/local/sbin/<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">MnesiaCore.rabbit at SM2_1266_456788_594733</A>&quot;)
 ** FATAL ** Cannot open log file
&quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.DCL&quot;:
{file_error,


&quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.DCL&quot;,

                        emfile}

=ERROR REPORT==== 17-Feb-2010::17:33:08 ===
** gen_event handler rabbit_error_logger crashed.
** Was installed in error_logger
** Last event was: {error,&lt;0.58.0&gt;,
                       {&lt;0.61.0&gt;,
                        &quot;Mnesia(~p): ** ERROR ** (core dumped to file:
~p)~n ** FATAL ** Cannot open log file ~p: ~p~n&quot;,
                        [<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at SM2</A>,

&quot;/usr/local/sbin/<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">MnesiaCore.rabbit at SM2_1266_456788_594733</A>&quot;,

&quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.DCL&quot;,
                         {file_error,

&quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.DCL&quot;,
                             emfile}]}}
** When handler state == {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;amq.rabbitmq.log&quot;&gt;&gt;}
** Reason == {{function_clause,
               [{gen,call,
                 [{rex,{error,{<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node_not_running,rabbit at SM2</A>}}},
                  '$gen_call',
                  {call,mnesia_lib,db_select_cont,
                   [ram_copies,
                    {rabbit_route,
                     {binding,
                      {resource,&lt;&lt;&quot;localhost&quot;&gt;&gt;,exchange,
                       &lt;&lt;&quot;qik.exc.session&quot;&gt;&gt;},

&lt;&lt;&quot;qik.item.session.22ff9df4-c115-4cdf-a721-27f99eba9aaa&quot;&gt;&gt;,
                      {resource,&lt;&lt;&quot;localhost&quot;&gt;&gt;,queue,

&lt;&lt;&quot;qik.item.session.22ff9df4-c115-4cdf-a721-27f99eba9aaa&quot;&gt;&gt;},
                      []},
                     [],100,&lt;&lt;&gt;&gt;,[],0,0},
                    [{'$1',[],['$1']}]],
                   &lt;0.0.0&gt;},
                  infinity]},
                {gen_server,call,3},
                {rpc,do_call,3},
                {mnesia,do_dirty_rpc,5},
                {mnesia,select_cont,3},
                {mnesia,'-qlc_select/1-fun-0-',1},
                {rabbit_exchange,'-match_bindings/2-fun-1-',10},
    {rabbit_variable_queue,flush_journal,1},
     {rabbit_amqqueue_process,handle_pre_hibernate,1}]}

=ERROR REPORT==== 17-Feb-2010::17:33:08 ===
Mnesia(<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at SM2</A>): ** ERROR ** (core dumped to file:
&quot;/usr/local/sbin/<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">MnesiaCore.rabbit at SM2_1266_456788_594733</A>&quot;)
 ** FATAL ** Cannot open log file
&quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.DCL&quot;:
{file_error,


&quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.DCL&quot;,

                        emfile}

=ERROR REPORT==== 17-Feb-2010::17:33:08 ===
** gen_event handler rabbit_error_logger crashed.
** Was installed in error_logger
** Last event was: {error,&lt;0.58.0&gt;,
                       {&lt;0.61.0&gt;,
                        &quot;Mnesia(~p): ** ERROR ** (core dumped to file:
~p)~n ** FATAL ** Cannot open log file ~p: ~p~n&quot;,
                        [<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at SM2</A>,

&quot;/usr/local/sbin/<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">MnesiaCore.rabbit at SM2_1266_456788_594733</A>&quot;,

&quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.DCL&quot;,
                         {file_error,

&quot;/var/lib/rabbitmq/mnesia/rabbit/rabbit_durable_route.DCL&quot;,
                             emfile}]}}

** When handler state == {resource,&lt;&lt;&quot;/&quot;&gt;&gt;,exchange,&lt;&lt;&quot;amq.rabbitmq.log&quot;&gt;&gt;}
** Reason == {{function_clause,
               [{gen,call,
                 [{rex,{error,{<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node_not_running,rabbit at SM2</A>}}},
                  '$gen_call',
                  {call,mnesia_lib,db_select_cont,
                   [ram_copies,
                    {rabbit_route,
                     {binding,
                      {resource,&lt;&lt;&quot;localhost&quot;&gt;&gt;,exchange,
                       &lt;&lt;&quot;qik.exc.session&quot;&gt;&gt;},

&lt;&lt;&quot;qik.item.session.22ff9df4-c115-4cdf-a721-27f99eba9aaa&quot;&gt;&gt;,
                      {resource,&lt;&lt;&quot;localhost&quot;&gt;&gt;,queue,

&lt;&lt;&quot;qik.item.session.22ff9df4-c115-4cdf-a721-27f99eba9aaa&quot;&gt;&gt;},
                      []},
                     [],100,&lt;&lt;&gt;&gt;,[],0,0},
                    [{'$1',[],['$1']}]],
                   &lt;0.0.0&gt;},
                  infinity]},
                {gen_server,call,3},
                {rpc,do_call,3},
                {mnesia,do_dirty_rpc,5},
                {mnesia,select_cont,3},
                {mnesia,'-qlc_select/1-fun-0-',1},
                {rabbit_exchange,'-match_bindings/2-fun-1-',10},
                {qlc,collect,1}]},
              {gen_server,call,
               [{rex,{error,{<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">node_not_running,rabbit at SM2</A>}}},
                {call,mnesia_lib,db_select_cont,
                 [ram_copies,
                  {rabbit_route,

.....


** Reason for termination ==
** {{badmatch,{error,emfile}},
    [{rabbit_queue_index,get_segment_handle,1},
     {rabbit_queue_index,append_journal_to_segment,2},
     {rabbit_queue_index,'-flush_journal/1-fun-0-',3},
     {lists,foldl,3},
     {rabbit_queue_index,segment_fold,3},
     {rabbit_queue_index,flush_journal,1},
     {rabbit_variable_queue,flush_journal,1},
     {rabbit_amqqueue_process,handle_pre_hibernate,1}]}



-- 
Andrey Smirnov


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006470.html">[rabbitmq-discuss] How to compile rabbitmq-c with visual c++ 2005?
</A></li>
	<LI>Next message: <A HREF="006397.html">[rabbitmq-discuss] RabbitMQ (branch bug21673) running out of	file descriptors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6396">[ date ]</a>
              <a href="thread.html#6396">[ thread ]</a>
              <a href="subject.html#6396">[ subject ]</a>
              <a href="author.html#6396">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
