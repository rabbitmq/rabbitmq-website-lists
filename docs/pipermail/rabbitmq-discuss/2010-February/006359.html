<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%3F%20about%20rabbitmq%201.7.1%20and%207-byte%0A%09frame%09headers&In-Reply-To=4B7A91E0.10409%40lshift.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006354.html">
   <LINK REL="Next"  HREF="006360.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers</H1>
    <B>james anderson</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20%3F%20about%20rabbitmq%201.7.1%20and%207-byte%0A%09frame%09headers&In-Reply-To=4B7A91E0.10409%40lshift.net"
       TITLE="[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers">james.anderson at setf.de
       </A><BR>
    <I>Tue Feb 16 18:13:03 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006354.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers
</A></li>
        <LI>Next message: <A HREF="006360.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6359">[ date ]</a>
              <a href="thread.html#6359">[ thread ]</a>
              <a href="subject.html#6359">[ subject ]</a>
              <a href="author.html#6359">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 2010-02-16, at 13:38 , Michael Bridgen wrote:

&gt;<i> James,
</I>&gt;<i>
</I>&gt;<i> As a preface, let me note that 0-9-1 is in part a rationalisation  
</I>&gt;<i> of the specification, and in part an encoding of what brokers  
</I>&gt;<i> actually implement.  0-8 had ambiguities and inconsistencies quite  
</I>&gt;<i> aside from the more obvious mistakes (like the grammar for the  
</I>&gt;<i> protocol header), but what the brokers ended up implementing was by  
</I>&gt;<i> and large consistent.
</I>&gt;<i>
</I>&gt;<i> If you're planning to implement an AMQP peer, personally speaking I  
</I>&gt;<i> would go for 0-9-1 and forget about 0-8.
</I>
your note, below, refers to rabbitmq's imminent plans. how does this  
reflect the state and intentions of other brokers?

&gt;<i>   Not only has it fewer mistakes, but it is also (or will be soon,  
</I>&gt;<i> see below) a stable point of interoperability.
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> james anderson wrote:
</I>&gt;&gt;&gt;&gt;<i> a recently built rabbitmq server server indicates - even to the  
</I>&gt;&gt;&gt;&gt;<i> level  of the response server properties, that it implements  
</I>&gt;&gt;&gt;&gt;<i> &quot;amqp 8-0&quot;, but
</I>&gt;&gt;&gt;&gt;<i> a. if one connects with a 9-1 version token, it does not  
</I>&gt;&gt;&gt;&gt;<i> disconnect.  it proceeds to negotiate the connection.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> That is expected behaviour for a 0-8 broker, at the least by some  
</I>&gt;&gt;&gt;<i> interpretations of the spec - if the client specifies a higher  
</I>&gt;&gt;&gt;<i> version number than supported by the server then negotiation  
</I>&gt;&gt;&gt;<i> proceeds with the server sending the version it supports.
</I>&gt;<i>
</I>&gt;<i> The protocol negotiation is a bit odd.  In the technical spec (PDF)  
</I>&gt;<i> it says what you have said above; in the XML it adds the rule &quot;The  
</I>&gt;<i> server MUST provide a protocol version that is lower than or equal  
</I>&gt;<i> to that requested by the client in the protocol header.&quot;
</I>
i must admit, page-8/lines-3-5 of amqp-xml-doc0-8.pdf resisted  
comprehension. in the end, however, the second sentence, can be  
interpreted to restrict the meaning of a lower protocol number to  
indicate only how far down the broker can go, as that sentence  
precludes the broker from sending the start command if it can not  
support the requested - higher - version.
anyway, i take from your remarks, that other implementors reached  
different conclusions.

&gt;<i>
</I>&gt;<i> Hence you can have a negotiation which goes:
</I>&gt;<i> Client: Hi, I would like to use protocol 0-9-1
</I>&gt;<i> Server: Sure!  I support that.  OK, let's use version 0-8
</I>&gt;<i> Client: WTF?
</I>&gt;<i>
</I>&gt;<i> So yeah, a bit nuts.
</I>&gt;<i>
</I>&gt;&gt;<i> that is to say, page-52/line-38 and the diagrams at page-52/line32  
</I>&gt;&gt;<i> and page-53/line-11 of amqp8-0.pdf are no more a misrepresentation  
</I>&gt;&gt;<i> of &quot;accordingly&quot; for a purported r8.0 broker than the indication  
</I>&gt;&gt;<i> in `amqp-xml-doc0-8.pdf` that it applies to &quot;AMQ Protocol  
</I>&gt;&gt;<i> (major=10, minor=3)&quot;?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> NB: the correct protocol header for 0-9-1 is in fact AMQP  
</I>&gt;&gt;&gt;<i> 0-0-9-1, whereas for 0-8 it is AMQP 1-1-8-0, and for 0-9 it is  
</I>&gt;&gt;&gt;<i> AMQP 1-1-0-9. Yes, that is crazy.
</I>&gt;&gt;<i> cool.
</I>&gt;&gt;<i> hmmm... what does the ampq 1-1-9-1 protocol header from the r8.0  
</I>&gt;&gt;<i> and the r9.1 specs actually mean?
</I>&gt;&gt;<i> is that what you intended, above, with &quot;AMQP 0-0-9-1&quot;?
</I>&gt;<i>
</I>&gt;<i> In 0-9-1 the protocol header is 'AMQP0091'.  The last four digits  
</I>&gt;<i> are the constant 0 (protocol-id, whatever that is), then the major,  
</I>&gt;<i> minor and revision numbers.  The 0-8 and 0-9 specs gave these  
</I>&gt;<i> digits a different meaning (and the first two were effectively  
</I>&gt;<i> constants).
</I>&gt;<i>
</I>&gt;<i> I just tried connecting to a RabbitMQ from default branch and  
</I>&gt;<i> giving a 0-9-1 header, and it wrote AMQP1180 and closed the  
</I>&gt;<i> connection, as specified.  From which branch did you build?
</I>
from the 1.7.1 release.
i had misunderstood the version-to-header mapping and had, in fact,  
sent it a 0.9r0 protocol header, not a 0.9r1 header. to wit:

? (defparameter *c* (make-instance 'amqp:connection :uri &quot;amqp:// 
guest:<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">guest at localhost</A>/&quot;))
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: open-connection:  
requesting version: #(65 77 81 80 1 1 0 9)/:AMQP-1-1-0-9-1.
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: open-connection:  
byte-zero: 1, updated class to AMQP-1-1-0-9-1:CONNECTION.
[20100216T123124Z00] DEBUG #&lt;CHANNEL [<A HREF="amqp://localhost/].0">amqp://localhost/].0</A>  
#xF757B2E&gt;: process-command: #&lt;CONNECTION #xF753016&gt;  
#&lt;CONNECTION.START #xF759DEE&gt; . (:VERSION-MAJOR 8 :VERSION-MINOR  
0 :SERVER-PROPERTIES (:|product| &quot;RabbitMQ&quot; :|version| &quot;1.7.1&quot; :| 
platform| &quot;Erlang/OTP&quot; :|copyright| &quot;Copyright (C) 2007-2009 LShift  
Ltd., Cohesive Financial Technologies LLC., and Rabbit Technologies  
Ltd.&quot; :|information| &quot;Licensed under the MPL.  See http:// 
www.rabbitmq.com/&quot;) :MECHANISMS &quot;PLAIN AMQPLAIN&quot; :LOCALES &quot;en_US&quot;)
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method:  
START-OK . (:CLIENT-PROPERTIES NIL :MECHANISM &quot;PLAIN&quot; :RESPONSE  
&quot;guestguest&quot; :LOCALE &quot;en_US&quot;)
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: encoding:  
CONNECTION.START-OK . (:CLIENT-PROPERTIES NIL :MECHANISM  
&quot;PLAIN&quot; :RESPONSE &quot;guestguest&quot; :LOCALE &quot;en_US&quot;)
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method:  
#&lt;CONNECTION.START-OK #xF75A34E&gt;  #&lt;OUTPUT-FRAME [(+)METHOD|0|c.0|t. 
0].{CONNECTION.START-OK}[36/4088: 0 10 0 11 0 0 0 0 ... 115 116 5 101  
110 95 85 83] #xF75A446&gt;
[20100216T123124Z00] DEBUG #&lt;CHANNEL [<A HREF="amqp://localhost/].0">amqp://localhost/].0</A>  
#xF757B2E&gt;: process-command: #&lt;CONNECTION #xF753016&gt;  
#&lt;CONNECTION.TUNE #xF75B67E&gt; . (:CHANNEL-MAX 0 :FRAME-MAX  
131072 :HEARTBEAT 0)
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method: TUNE- 
OK . (:CHANNEL-MAX 0 :FRAME-MAX 131072 :HEARTBEAT 0)
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: encoding:  
CONNECTION.TUNE-OK . (:CHANNEL-MAX 0 :FRAME-MAX 131072 :HEARTBEAT 0)
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method:  
#&lt;CONNECTION.TUNE-OK #xF75B886&gt;  #&lt;OUTPUT-FRAME [(+)METHOD|0|c.0|t.0]. 
{CONNECTION.TUNE-OK}[12/4088: 0 10 0 31 0 0 0 2 0 0 0 0] #xF75A446&gt;
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method:  
OPEN . (:VIRTUAL-HOST &quot;/&quot;)
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: encoding:  
CONNECTION.OPEN . (:VIRTUAL-HOST &quot;/&quot;)
[20100216T123124Z00] DEBUG #&lt;CONNECTION #xF753016&gt;: send-method:  
#&lt;CONNECTION.OPEN #xF75BBEE&gt;  #&lt;OUTPUT-FRAME [(+)METHOD|0|c.0|t.0]. 
{CONNECTION.OPEN}[8/4088: 0 10 0 40 1 47 0 0] #xF75A446&gt;
[20100216T123124Z00] DEBUG #&lt;CHANNEL [<A HREF="amqp://localhost/].0">amqp://localhost/].0</A>  
#xF757B2E&gt;: process-command: #&lt;CONNECTION #xF753016&gt;  
#&lt;CONNECTION.OPEN-OK #xF75BE5E&gt; . NIL
*C*
? (type-of *c*)
AMQP-1-1-0-9-1:CONNECTION

to which it responded with a Connection.Start with a version 8 in the  
properties.
having now rewired it to follow the suggested version-&gt;header mapping  
i observe the expected response to a 'standard' 0.9r1 header:

? (defparameter *c* (make-instance 'amqp:connection :uri &quot;amqp:// 
guest:<A HREF="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">guest at localhost</A>/&quot;))
[20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:  
requesting version: #(65 77 81 80 0 0 9 1)/:AMQP-1-1-0-9-1.
[20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:  
parsed version: #(65 77 81 80 1 1 8 0) / :AMQP-1-1-0-8-0.
[20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:  
updated class to AMQP-1-1-0-8-0:CONNECTION.
[20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:  
requesting version: #(65 77 81 80 1 1 8 0)/:AMQP-1-1-0-8-0.
[20100216T180229Z00] DEBUG #&lt;CONNECTION #x102F73F6&gt;: open-connection:  
byte-zero: 1, connection class AMQP-1-1-0-8-0:CONNECTION.
 &gt; Error: Frame length exceeds buffer size: 73728, #&lt;VECTOR 4087 type  
(UNSIGNED-BYTE 8), simple&gt;
 &gt; While executing: CCL::%ASSERTION-FAILURE
 &gt; Type Command-/ to continue, Command-. to abort.
 &gt; If continued: test the assertion again.
See the Restarts&#8230; menu item for further choices.
1 &gt;

the frame size error being the same as that which had led yesterday  
to the realization that it was using 7-byte headers.

&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> b. it does not use the 8-byte frame headers which appear in  
</I>&gt;&gt;&gt;&gt;<i> every  instance of the amqp0-8 specification the net had  
</I>&gt;&gt;&gt;&gt;<i> yielded, but rather  7-byte headers that are specified for 9-1.
</I>&gt;<i> &gt;&gt;
</I>&gt;&gt;&gt;<i> All implementations of 0-8 actually use a 7-byte header. Hence  
</I>&gt;&gt;&gt;<i> the correction in 0-9-1.
</I>&gt;&gt;<i> do these two sentences boggle any other minds?
</I>&gt;&gt;<i> a naive reader of the r8.0 specification might misconstrue it to  
</I>&gt;&gt;<i> require, that such a correction would apply to a broker which  
</I>&gt;&gt;<i> purports to follow the r9.1 spec, but not to broker which purports  
</I>&gt;&gt;<i> to follow the r8.0 spec. in this light, i have rescanned the r8.0  
</I>&gt;&gt;<i> spec, but did not observe any formulations of the order &quot;or any  
</I>&gt;&gt;<i> later protocol version.&quot; ok. anyway, i gather that page-35/line-26  
</I>&gt;&gt;<i> and page-53/line-29 of amqp8-0.pdf are history. is there anything  
</I>&gt;&gt;<i> else of which a naive implementor should be aware?
</I>&gt;<i>
</I>&gt;<i> Many things, I should think, sadly.  The things corrected, or  
</I>&gt;<i> cleared up, in 0-9-1 give some indication.
</I>
what does this imply for the way the broker handles realms and tickets?

is is that
1. every 0.8r0 and 0.9r* broker follows 0.9r1 framing specifications.
2. the respective 0.8 and 0.9 brokers each otherwise implement the  
classes/methods/arguments/rules in the respective .xml version of the  
specification.

?

&gt;<i>
</I>&gt;<i> &gt; [...]
</I>&gt;<i>
</I>&gt;&gt;<i> ? are there actually any r9.0 brokers in the wild?
</I>&gt;<i>
</I>&gt;<i> Qpid's Java broker implements 0-9 and 0-9-1, inter alia.  RabbitMQ  
</I>&gt;<i> has a branch implementing 0-9-1 (amqp_0_9_1 in the broker and most  
</I>&gt;<i> of the client repos), which should make its way into releases once  
</I>&gt;<i> work on the new persister is done.
</I>&gt;<i>
</I>&gt;&gt;<i> on a meta level: how does this community achieve interoperability,  
</I>&gt;&gt;<i> other by knowing each other's code?
</I>&gt;<i>
</I>&gt;<i> Also by using each other's code; e.g., we use Qpid's (Python) test  
</I>&gt;<i> suites, in part, and they have been using our 0-9-1 (Java) test suite.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> mikeb.
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100216/238581fb/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20100216/238581fb/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006354.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte	frame	headers
</A></li>
	<LI>Next message: <A HREF="006360.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame	headers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6359">[ date ]</a>
              <a href="thread.html#6359">[ thread ]</a>
              <a href="subject.html#6359">[ subject ]</a>
              <a href="author.html#6359">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
