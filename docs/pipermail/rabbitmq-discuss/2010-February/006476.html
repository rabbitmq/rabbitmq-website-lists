<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Taking error_logger out of the &quot;fast path&quot; (was Re: beam process using 100% cpu and lots of memory)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Taking%20error_logger%20out%20of%20the%20%22fast%20path%22%0A%20%28was%20Re%3A%20beam%20process%20using%20100%25%20cpu%20and%20lots%20of%20memory%29&In-Reply-To=3bb0d9711002250849p6795f634i2778083c83ce6994%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006474.html">
   <LINK REL="Next"  HREF="006349.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Taking error_logger out of the &quot;fast path&quot; (was Re: beam process using 100% cpu and lots of memory)</H1>
    <B>Tony Garnock-Jones</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=%5Brabbitmq-discuss%5D%20Taking%20error_logger%20out%20of%20the%20%22fast%20path%22%0A%20%28was%20Re%3A%20beam%20process%20using%20100%25%20cpu%20and%20lots%20of%20memory%29&In-Reply-To=3bb0d9711002250849p6795f634i2778083c83ce6994%40mail.gmail.com"
       TITLE="[rabbitmq-discuss] Taking error_logger out of the &quot;fast path&quot; (was Re: beam process using 100% cpu and lots of memory)">tonyg at lshift.net
       </A><BR>
    <I>Thu Feb 25 20:54:48 GMT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006474.html">[rabbitmq-discuss] Taking error_logger out of the &quot;fast path&quot;	(was Re: beam process using 100% cpu and lots of memory)
</A></li>
        <LI>Next message: <A HREF="006349.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame headers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6476">[ date ]</a>
              <a href="thread.html#6476">[ thread ]</a>
              <a href="subject.html#6476">[ subject ]</a>
              <a href="author.html#6476">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>majek04 wrote:
&gt;<i> I think we can take several approaches:
</I>&gt;<i>  - use syslog and/or rewrite the logging infrastructure
</I>
I've been interested in syslog for a while; did you know there's a
syslog *protocol*? It'd be cool to have a syslog plugin, for in- and
outbound traffic, that spoke that protocol...

&gt;<i>  - invent filter on top of the logger, which would stop sending
</I>&gt;<i>    new errors if there are too many of them. Something similar
</I>&gt;<i>    to &quot;last message repeated XX time(s)&quot; from syslog.
</I>
Perhaps, but in the case of a high rate of connections/disconnections
such as the OP is experiencing, that's tantamount to throwing away most
of the information (namely, the IP address and port), which we could do
just as well by not logging it at all. Unless you really do have
something adaptive in mind. Sounds tricky to get right ;-)

&gt;<i>  - move logger away from the critical path, by doing logging
</I>&gt;<i>    asynchronously. This can lead to out-of-memory crash.
</I>
Yep. So if, as Matthew says, the problem is a long error_logger message
queue, if we avoided *that* we might be OK even with the error_logger as
it stands: you know, the normal problems of O(n^2) for selective
receives. Perhaps dusting off the old buffering intermediary process?

Actually, since I think we're using rabbit_log *almost* everywhere we
need to (but, frustratingly, not in tcp_acceptor! perhaps because it is
for generic, non-rabbit use as well?), we might be able to bypass the
problem well enough by switching rabbit_log to being an instance of
gen_server2.

Tony


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006474.html">[rabbitmq-discuss] Taking error_logger out of the &quot;fast path&quot;	(was Re: beam process using 100% cpu and lots of memory)
</A></li>
	<LI>Next message: <A HREF="006349.html">[rabbitmq-discuss] ? about rabbitmq 1.7.1 and 7-byte frame headers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6476">[ date ]</a>
              <a href="thread.html#6476">[ thread ]</a>
              <a href="subject.html#6476">[ subject ]</a>
              <a href="author.html#6476">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
