<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] RabbitMQ blocking issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20blocking%20issue&In-Reply-To=%3C0C5C3C8F51B90E4596BB1263843DEB15013E06A51C%40hq-ex-mb03.ad.navteq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025677.html">
   <LINK REL="Next"  HREF="025608.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] RabbitMQ blocking issue</H1>
    <B>Konar Peter (Nokia-LC/Chicago)</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20RabbitMQ%20blocking%20issue&In-Reply-To=%3C0C5C3C8F51B90E4596BB1263843DEB15013E06A51C%40hq-ex-mb03.ad.navteq.com%3E"
       TITLE="[rabbitmq-discuss] RabbitMQ blocking issue">peter.konar at nokia.com
       </A><BR>
    <I>Thu Feb 21 17:24:03 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025677.html">[rabbitmq-discuss] RabbitMQ blocking issue
</A></li>
        <LI>Next message: <A HREF="025608.html">[rabbitmq-discuss] ANN amqp gem 0.9.9 is released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25610">[ date ]</a>
              <a href="thread.html#25610">[ thread ]</a>
              <a href="subject.html#25610">[ subject ]</a>
              <a href="author.html#25610">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In talking with Daniel, he wants to inform you that the nature of the traffic is burst of 78K messages across 4 nodes on the minute mark to a single rabbit.

One more trace:
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pkonar at ajtrafp063</A> rabbitmq]$ sudo rabbitmqctl -q list_connections pid peer_port | grep 52126
&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ajtrafp063.1.422.0</A>&gt;     52126
[<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">pkonar at ajtrafp063</A> rabbitmq]$ sudo rabbitmqctl eval '{backtrace, B} =process_info(rabbit_misc:string_to_pid(&quot;&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ajtrafp063.1.422.0</A>&gt;&quot;),backtrace), io:format(&quot;~s&quot;, [binary_to_list(B)]).'
Program counter: 0x00007f92ba5036d8 (rabbit_net:recv/2 + 136)
CP: 0x0000000000000000 (invalid)
arity = 0

0x00007f92c2040608 Return addr 0x00007f92ba37e6d0 (rabbit_reader:mainloop/2 + 248)
y(0)     #Port&lt;0.15075&gt;
y(1)     tcp_error
y(2)     tcp_closed
y(3)     tcp

0x00007f92c2040630 Return addr 0x00007f92ba37dca8 (rabbit_reader:start_connection/7 + 1216)
y(0)     {v1,&lt;0.419.0&gt;,#Port&lt;0.15075&gt;,&lt;&lt;40 bytes&gt;&gt;,{connection,rabbit_framing_amqp_0_9_1,{user,&lt;&lt;5 bytes&gt;&gt;,[administrator],rabbit_auth_backend_internal,{internal_user,&lt;&lt;5 bytes&gt;&gt;,&lt;&lt;20 bytes&gt;&gt;,[administrator]}},600,131072,&lt;&lt;1 byte&gt;&gt;,[{&lt;&lt;7 bytes&gt;&gt;,longstr,&lt;&lt;8 bytes&gt;&gt;},{&lt;&lt;11 bytes&gt;&gt;,longstr,&lt;&lt;52 bytes&gt;&gt;},{&lt;&lt;8 bytes&gt;&gt;,longstr,&lt;&lt;4 bytes&gt;&gt;},{&lt;&lt;12 bytes&gt;&gt;,table,[{&lt;&lt;26 bytes&gt;&gt;,bool,true},{&lt;&lt;22 bytes&gt;&gt;,bool,true},{&lt;&lt;10 bytes&gt;&gt;,bool,true},{&lt;&lt;18 bytes&gt;&gt;,bool,true}]},{&lt;&lt;9 bytes&gt;&gt;,longstr,&lt;&lt;36 bytes&gt;&gt;},{&lt;&lt;7 bytes&gt;&gt;,longstr,&lt;&lt;5 bytes&gt;&gt;}],[{&lt;&lt;26 bytes&gt;&gt;,bool,true},{&lt;&lt;22 bytes&gt;&gt;,bool,true},{&lt;&lt;10 bytes&gt;&gt;,bool,true},{&lt;&lt;18 bytes&gt;&gt;,bool,true}]},frame_header,7,false,running,&lt;0.420.0&gt;,{&lt;0.433.0&gt;,&lt;0.434.0&gt;},{state,fine,5000,undefined},&lt;0.421.0&gt;,#Fun&lt;rabbit_heartbeat.2.69784259&gt;,[&lt;&lt;4458 bytes&gt;&gt;],4458,rabbit_auth_mechanism_plain,[],false,flow,{1361,466181,586431},{0,0,0,0,0,65535,2756,10773},{0,0,0,0,0,65535,2756,10934},5672,52126}
y(1)     []
y(2)     4458
y(3)     [&lt;&lt;4458 bytes&gt;&gt;]

0x00007f92c2040658 Return addr 0x00007f92c0a7da80 (proc_lib:init_p_do_apply/3 + 56)
y(0)     []
y(1)     []
y(2)     []
y(3)     &quot;10.196.42.182:52126 -&gt; 10.196.42.21:5672&quot;
y(4)     #Port&lt;0.15075&gt;
y(5)     []
y(6)     []
y(7)     []
y(8)     []
y(9)     Catch 0x00007f92ba37dd28 (rabbit_reader:start_connection/7 + 1344)
y(10)    Catch 0x00007f92ba37df10 (rabbit_reader:start_connection/7 + 1832)

0x00007f92c20406b8 Return addr 0x00000000008827d8 (&lt;terminate process normally&gt;)
y(0)     Catch 0x00007f92c0a7daa0 (proc_lib:init_p_do_apply/3 + 88)
ok
...done.


Thanks
Peter Konar

________________________________________
From: ext Matthias Radestock [<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">matthias at rabbitmq.com</A>]
Sent: Thursday, February 21, 2013 9:21 AM
To: Konar Peter (Nokia-LC/Chicago)
Cc: Carroll James (Nokia-LC/Malvern); Hancock Craig (Nokia-LC/Chicago); Venus Justin (Nokia-LC/Chicago); Yu Jerry.3 (Nokia-LC/Alpharetta); Lieber Dick (Nokia-LC/Chicago); Johnson Anthony (Nokia-LC/Alpharetta); Mccuiston Mitchell (Nokia-LC/Chicago); <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
Subject: Re: [rabbitmq-discuss] RabbitMQ blocking issue

(re-sending since the m/l had dropped off the 'cc')

Peter,

On 21/02/13 14:55, Konar Peter (Nokia-LC/Chicago) wrote:
&gt;<i> from the log:
</I>&gt;<i>
</I>&gt;<i> =ERROR REPORT==== 21-Feb-2013::14:01:02 ===
</I>&gt;<i> closing AMQP connection &lt;0.23035.17&gt; (10.196.42.128:59179 -&gt; 10.196.42.21:5672):
</I>&gt;<i> {heartbeat_timeout,running}
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Feb-2013::14:01:02 ===
</I>&gt;<i> accepting AMQP connection &lt;0.23611.34&gt; (10.196.42.128:41413 -&gt; 10.196.42.21:5672)
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Feb-2013::14:06:28 ===
</I>&gt;<i> Memory limit set to 1MB of 15949MB total.
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Feb-2013::14:06:28 ===
</I>&gt;<i> vm_memory_high_watermark set. Memory used:141211416 allowed:1672474
</I>&gt;<i>
</I>&gt;<i> =WARNING REPORT==== 21-Feb-2013::14:06:28 ===
</I>&gt;<i> memory resource limit alarm set on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ajtrafp063</A>
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Feb-2013::14:06:38 ===
</I>&gt;<i> Memory limit set to 6379MB of 15949MB total.
</I>&gt;<i>
</I>&gt;<i> =INFO REPORT==== 21-Feb-2013::14:06:38 ===
</I>&gt;<i> vm_memory_high_watermark clear. Memory used:129010184 allowed:6689898496
</I>&gt;<i>
</I>&gt;<i> =WARNING REPORT==== 21-Feb-2013::14:06:38 ===
</I>&gt;<i> memory resource limit alarm cleared on node <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at ajtrafp063</A>
</I>
Looks like you got there too late - the connection timed out before the
'rabbitmqctl set_vm_memory_high_watermark ...' commands.

Hopefully you'll catch it early enough next time.

Also, before you run the pair of 'rabbitmqctl
set_vm_memory_high_watermark ...' commands, do the following:

1) determine the pid of the connection that is blocked by running
   rabbitmqctl -q list_connections pid peer_port | grep &lt;port&gt;
where &lt;port&gt; is the peer port shown in the netstat output, e.g. 59179 in
the case we've just looked at.

2) plug the pid, which looks something like &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at host.1.289.0</A>&gt;, into
   rabbitmqctl eval '{backtrace, B} =
process_info(rabbit_misc:string_to_pid(&quot;&lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbit at host.1.289.0</A>&gt;&quot;),
backtrace), io:format(&quot;~s&quot;, [binary_to_list(B)]).'
(all on one line) and post the output. NB: If you are in a cluster, you
need to run this on the rabbit server identified by the host portion of
the pid.


Regards,

Matthias.

The information contained in this communication may be CONFIDENTIAL and is intended only for the use of the recipient(s) named above.  If you are not the intended recipient, you are hereby notified that any dissemination, distribution, or copying of this communication, or any of its contents, is strictly prohibited.  If you have received this communication in error, please notify the sender and delete/destroy the original message and any copy of it from your computer or paper files.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: report.pt.11:10
Type: application/octet-stream
Size: 42955 bytes
Desc: report.pt.11:10
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130221/1ab9a2e1/attachment.obj">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130221/1ab9a2e1/attachment.obj</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025677.html">[rabbitmq-discuss] RabbitMQ blocking issue
</A></li>
	<LI>Next message: <A HREF="025608.html">[rabbitmq-discuss] ANN amqp gem 0.9.9 is released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25610">[ date ]</a>
              <a href="thread.html#25610">[ thread ]</a>
              <a href="subject.html#25610">[ subject ]</a>
              <a href="author.html#25610">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
