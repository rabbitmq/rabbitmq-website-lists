<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Very%20slow%20get%20%28dequeue%29%20on%20node%20B%20if%20shovel%20on%0A%20node%20A%20is%20configured%20with%20%7Back_mode%2C%20on_confirm%7D&In-Reply-To=%3CCAHA3fyVQjorpxtqyMY-kNow83hCYHKkuGstRmq5d8Rg7FJATXw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025503.html">
   <LINK REL="Next"  HREF="025488.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}</H1>
    <B>bratner bratner</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Very%20slow%20get%20%28dequeue%29%20on%20node%20B%20if%20shovel%20on%0A%20node%20A%20is%20configured%20with%20%7Back_mode%2C%20on_confirm%7D&In-Reply-To=%3CCAHA3fyVQjorpxtqyMY-kNow83hCYHKkuGstRmq5d8Rg7FJATXw%40mail.gmail.com%3E"
       TITLE="[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}">ratner2 at gmail.com
       </A><BR>
    <I>Wed Feb 13 14:33:55 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025503.html">[rabbitmq-discuss] creating connections to RMQ
</A></li>
        <LI>Next message: <A HREF="025488.html">[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25485">[ date ]</a>
              <a href="thread.html#25485">[ thread ]</a>
              <a href="subject.html#25485">[ subject ]</a>
              <a href="author.html#25485">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

My setup includes a rabbitmq-c application that publishes messages on node
A.
The publishing rate is about 200mps, each message can be up to 10Kb.

Shovel (node A) is configured to move them to node B.
On node B i'm dequeuing the messages with a PHP test script with
$queue-&gt;get(AMQP_AUTOACK).
If i keep the publishing rate at 200mps then i can see that the queue on
node A is empty and the Q on node B is
filling up. The read-rate of my test script is really low.

If i stop the publishing, 3-5 seconds later, my test script starts reading
like crazy until the queue on node B is empty.

Even If I slow down the publishing rate to 5mps , same is happening ,
messages are piling up on node B until i dial down the pressure.

This problem disappears if I set ack_mode to on_publish or no_ack. In this
case the reader script reads with the publishing speed.

My configuration :



[
{rabbit, [
{log_levels, [{connection, error}]}
]},
{rabbitmq_shovel,
[ {shovels, [ {messagemover, [
{sources, [
{broker, &quot;<A HREF="amqp://usera:pass@localhost/vhosta&lt;amqp://cdrposter:4VkI6MKH@localhost/sipout">amqp://usera:pass@localhost/vhosta&lt;amqp://cdrposter:4VkI6MKH@localhost/sipout</A>&gt;
&quot;},
{declarations, [
{'exchange.declare',[{exchange, &lt;&lt;&quot;my-fanout&quot;&gt;&gt;},{type,
&lt;&lt;&quot;fanout&quot;&gt;&gt;},durable]},
{'queue.declare',[{queue,&lt;&lt;&quot;messages&quot;&gt;&gt;},durable]},
{'queue.bind',[{exchange, &lt;&lt;&quot;my-fanout&quot;&gt;&gt;},{queue, &lt;&lt;&quot;messages&quot;&gt;&gt;}]}
]}
]},
{destinations, [
{brokers, [ &quot;<A HREF="amqp://userb:pass@nodeB/vhostb&lt;amqp://cdr_manager:Ci2XOb3b@10.200.10.218/cdrs">amqp://userb:pass@nodeB/vhostb&lt;amqp://cdr_manager:Ci2XOb3b@10.200.10.218/cdrs</A>&gt;&quot;
]},
{declarations, [
{'exchange.declare',[{exchange, &lt;&lt;&quot;my-fanout&quot;&gt;&gt;},{type,
&lt;&lt;&quot;fanout&quot;&gt;&gt;},durable]},
{'queue.declare',[{queue,&lt;&lt;&quot;messages&quot;&gt;&gt;},durable]},
{'queue.bind',[{exchange, &lt;&lt;&quot;my-fanout&quot;&gt;&gt;},{queue, &lt;&lt;&quot;messages&quot;&gt;&gt;}]}
]}
]},
{queue, &lt;&lt;&quot;messages&quot;&gt;&gt;},
{prefetch_count, 200},
{ack_mode, on_confirm},
{publish_properties, [{delivery_mode, 2}]},
{reconnect_delay, 5}
]}
]}
]}
].


Thank you,
Boris.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130213/d4467be0/attachment.htm">http://lists.rabbitmq.com/pipermail/rabbitmq-discuss/attachments/20130213/d4467be0/attachment.htm</A>&gt;
</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025503.html">[rabbitmq-discuss] creating connections to RMQ
</A></li>
	<LI>Next message: <A HREF="025488.html">[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25485">[ date ]</a>
              <a href="thread.html#25485">[ thread ]</a>
              <a href="subject.html#25485">[ subject ]</a>
              <a href="author.html#25485">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
