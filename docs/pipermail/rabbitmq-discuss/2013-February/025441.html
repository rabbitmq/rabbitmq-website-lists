<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Consumer Clients as Tomcat Web Applications	and Work Queue Configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20Clients%20as%20Tomcat%20Web%20Applications%0A%09and%20Work%20Queue%20Configuration&In-Reply-To=%3CAA959E8B-19A8-4628-A700-B98C15580135%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025439.html">
   <LINK REL="Next"  HREF="025471.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Consumer Clients as Tomcat Web Applications	and Work Queue Configuration</H1>
    <B>Steve Powell</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Consumer%20Clients%20as%20Tomcat%20Web%20Applications%0A%09and%20Work%20Queue%20Configuration&In-Reply-To=%3CAA959E8B-19A8-4628-A700-B98C15580135%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Consumer Clients as Tomcat Web Applications	and Work Queue Configuration">steve at rabbitmq.com
       </A><BR>
    <I>Mon Feb 11 11:33:40 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025439.html">[rabbitmq-discuss] Node failure for a mirrored queue
</A></li>
        <LI>Next message: <A HREF="025471.html">[rabbitmq-discuss] Consumer Clients as Tomcat Web Applications and Work Queue Configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25441">[ date ]</a>
              <a href="thread.html#25441">[ thread ]</a>
              <a href="subject.html#25441">[ subject ]</a>
              <a href="author.html#25441">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Kevin,

Sorry for the delayed response.

First, an observation about your original set-up:

&gt;<i> while (true) {
</I>&gt;<i> 	QueueingConsumer.Delivery delivery = consumer.nextDelivery();
</I>&gt;<i> 	String message = new String(delivery.getBody());
</I>&gt;<i> 	System.out.println(&quot; [x] Received '&quot; + message + &quot;'&quot;);
</I>&gt;<i> }
</I>

I assume that there are no Qos (prefetch) limits imposed on the channels
these consumers use, and also I note that you are using the
QueueingConsumer. I think this means that all of the consumers are able
to receive the messages all the time, and so all messages will get
distributed in round-robin fashion, until there are no messages left to
deliver.

In your 'workaround' solution, you are indeed pulling, not being pushed,
and here all of the consumers will get a look-in: there is likely to be
balancing, but not round-robin. This is based instead upon consumer
request, so if one of them gets bogged down in work (initiated by the
previous message, for example) then the other consumers can poll and
take the next message, and, crucially, other messages won't be taken by
this consumer while it is busy. Although this isn't 'round-robin'
servicing, it is arguably better: the messages are not 'blindly' sent to
consumers that are busy.

The drawbacks are, as you note, an overhead of polling in the consumers,
and a larger latency on the network -- each get involves a round-trip to
the server, even when there is nothing to get.

Now to your questions:

&gt;<i>  &#8226; Is it a bad idea to deploy consumers as Tomcat web applications? Are
</I>&gt;<i> there any advantages or disadvantages as compared to the alternative of
</I>&gt;<i> running system level Java clients?
</I>
I see no reason why, apart from the overhead implied by running a full
web application, there should be any particular disadvantages of running
a Tomcat web application that does messaging as its main work. In fact,
I suspect it is easier to control (start/stop) than using a
free-standing Java client: you can potentially build a sophisticated
web-based control mechanism. However, I'm not best placed to answer
this.

&gt;<i>  &#8226; In the case of work queues, am I better off retrieving messages that
</I>&gt;<i> are pushed down to my clients, and setting a prefetchCount
</I>&gt;<i> (channel.basicQos(1)) to ensure that I only receive one message at a
</I>&gt;<i> time?
</I>
This is the crux of the matter, as I see it. If you impose a prefetch
limit of 1 for each client you run, then the rabbit server will dispatch
messages to clients that have no unacknowledged messages (by the way,
you should explicitly acknowledge messages when using non-zero
basicQos()). Under these circumstances, you can achieve similar
balancing as in the polling case, but without the polling. It will *not*
be strictly round-robin after the first 'round' because the first
consumer need not have acknowledged the previous message yet, and
messages will be delivered to whatever consumers are ready for them --
albeit in round-robin priority.

The tutorial pages describe this pretty well (see [1]).

There are two points to note:

If you are using QueueingConsumer, then each message will be placed in a
client Java queue, and nextDelivery() then unblocks with the message
when it arrives. With explicit acknowledgements this means that one
message at a time is transferred to the Java queue. You could increase
the prefetchCount to 2, say, and then up to two messages would be placed
in the queue but you would still process them serially through the
nextDelivery() call. When one consumer gets two messages, then no other
consumer will get these -- so if a message can take a long time before
it is acknowledged, the message behind it can get delayed, even though
there may be other consumers which are idle. Other messages can
'overtake' and get processed before it.

If you want to avoid the QueueingConsumer internal Java queue, you could
write your own Consumer implementation (base it on DefaultConsumer) but
you should be aware that the handleDelivery() methods are driven
asynchronously, but serially. You shouldn't perform long pieces of work
on these threads. It would be wise to pass the message to some
serialised worker thread, especially if you have a prefetchCount larger
than one. This will probably then require a queue of your own anyway, so
the advantages to you are slim.

I hope this helps. Please let us know how you get on.

Steve Powell

[1] <A HREF="http://www.rabbitmq.com/tutorials/tutorial-two-java.html">http://www.rabbitmq.com/tutorials/tutorial-two-java.html</A>

[M: +44-7815-838-558; H:+44-1962-775-598]
SpringSource (a division of VMware), Virgo, RabbitMQ.
-----------------------------------------------------------------------
Good design:
   is innovative, useful, aesthetic;
   is understandable, unobtrusive, honest;
   is long-lasting, thorough, environmentally friendly;
   and is as little design as possible.
Copyright Dieter Rams, amended March 2003; October 2009; and August 2012

On 31 Jan 2013, at 01:33, Kevin Behr &lt;<A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">behrk2 at gmail.com</A>&gt; wrote:
&gt;<i> Hello everyone,
</I>&gt;<i> 
</I>&gt;<i> I have five RabbitMQ consumer clients that are written and deployed as Tomcat web applications.  My original intention was to consume messages in the typical fashion:
</I>&#8230;(elided)
&gt;<i> I would appreciate any advice or suggestions.
</I>&gt;<i> 
</I>&gt;<i> Thanks!
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I></PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025439.html">[rabbitmq-discuss] Node failure for a mirrored queue
</A></li>
	<LI>Next message: <A HREF="025471.html">[rabbitmq-discuss] Consumer Clients as Tomcat Web Applications and Work Queue Configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25441">[ date ]</a>
              <a href="thread.html#25441">[ thread ]</a>
              <a href="subject.html#25441">[ subject ]</a>
              <a href="author.html#25441">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
