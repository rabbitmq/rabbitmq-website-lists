<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Very%20slow%20get%20%28dequeue%29%20on%20node%20B%20if%20shovel%0A%20on%20node%20A%20is%20configured%20with%20%7Back_mode%2C%20on_confirm%7D&In-Reply-To=%3C511BB6D3.9080205%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025485.html">
   <LINK REL="Next"  HREF="025605.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}</H1>
    <B>Simon MacMullen</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Very%20slow%20get%20%28dequeue%29%20on%20node%20B%20if%20shovel%0A%20on%20node%20A%20is%20configured%20with%20%7Back_mode%2C%20on_confirm%7D&In-Reply-To=%3C511BB6D3.9080205%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}">simon at rabbitmq.com
       </A><BR>
    <I>Wed Feb 13 15:52:51 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025485.html">[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}
</A></li>
        <LI>Next message: <A HREF="025605.html">[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25488">[ date ]</a>
              <a href="thread.html#25488">[ thread ]</a>
              <a href="subject.html#25488">[ subject ]</a>
              <a href="author.html#25488">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>That sounds very wrong.

Which version of RabbitMQ are you using? Can you post (a cut down 
version of) your PHP script somewhere? (I have no familiarity with the 
PHP client but I'd like to see what it's doing...)

Cheers, Simon

On 13/02/13 14:33, bratner bratner wrote:
&gt;<i> Hi!
</I>&gt;<i>
</I>&gt;<i> My setup includes a rabbitmq-c application that publishes messages on
</I>&gt;<i> node A.
</I>&gt;<i> The publishing rate is about 200mps, each message can be up to 10Kb.
</I>&gt;<i>
</I>&gt;<i> Shovel (node A) is configured to move them to node B.
</I>&gt;<i> On node B i'm dequeuing the messages with a PHP test script with
</I>&gt;<i> $queue-&gt;get(AMQP_AUTOACK).
</I>&gt;<i> If i keep the publishing rate at 200mps then i can see that the queue on
</I>&gt;<i> node A is empty and the Q on node B is
</I>&gt;<i> filling up. The read-rate of my test script is really low.
</I>&gt;<i>
</I>&gt;<i> If i stop the publishing, 3-5 seconds later, my test script starts
</I>&gt;<i> reading like crazy until the queue on node B is empty.
</I>&gt;<i>
</I>&gt;<i> Even If I slow down the publishing rate to 5mps , same is happening ,
</I>&gt;<i> messages are piling up on node B until i dial down the pressure.
</I>&gt;<i>
</I>&gt;<i> This problem disappears if I set ack_mode to on_publish or no_ack. In
</I>&gt;<i> this case the reader script reads with the publishing speed.
</I>&gt;<i>
</I>&gt;<i> My configuration :
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> [
</I>&gt;<i> {rabbit, [
</I>&gt;<i> {log_levels, [{connection, error}]}
</I>&gt;<i> ]},
</I>&gt;<i> {rabbitmq_shovel,
</I>&gt;<i> [ {shovels, [ {messagemover, [
</I>&gt;<i> {sources, [
</I>&gt;<i> {broker, &quot;<A HREF="amqp://usera:pass@localhost/vhosta">amqp://usera:pass@localhost/vhosta</A>
</I>&gt;<i> &lt;<A HREF="amqp://cdrposter:4VkI6MKH@localhost/sipout">amqp://cdrposter:4VkI6MKH@localhost/sipout</A>&gt;&quot;},
</I>&gt;<i> {declarations, [
</I>&gt;<i> {'exchange.declare',[{exchange, &lt;&lt;&quot;my-fanout&quot;&gt;&gt;},{type,
</I>&gt;<i> &lt;&lt;&quot;fanout&quot;&gt;&gt;},durable]},
</I>&gt;<i> {'queue.declare',[{queue,&lt;&lt;&quot;messages&quot;&gt;&gt;},durable]},
</I>&gt;<i> {'queue.bind',[{exchange, &lt;&lt;&quot;my-fanout&quot;&gt;&gt;},{queue, &lt;&lt;&quot;messages&quot;&gt;&gt;}]}
</I>&gt;<i> ]}
</I>&gt;<i> ]},
</I>&gt;<i> {destinations, [
</I>&gt;<i> {brokers, [ &quot;<A HREF="amqp://userb:pass@nodeB/vhostb">amqp://userb:pass@nodeB/vhostb</A>
</I>&gt;<i> &lt;<A HREF="amqp://cdr_manager:Ci2XOb3b@10.200.10.218/cdrs">amqp://cdr_manager:Ci2XOb3b@10.200.10.218/cdrs</A>&gt;&quot; ]},
</I>&gt;<i> {declarations, [
</I>&gt;<i> {'exchange.declare',[{exchange, &lt;&lt;&quot;my-fanout&quot;&gt;&gt;},{type,
</I>&gt;<i> &lt;&lt;&quot;fanout&quot;&gt;&gt;},durable]},
</I>&gt;<i> {'queue.declare',[{queue,&lt;&lt;&quot;messages&quot;&gt;&gt;},durable]},
</I>&gt;<i> {'queue.bind',[{exchange, &lt;&lt;&quot;my-fanout&quot;&gt;&gt;},{queue, &lt;&lt;&quot;messages&quot;&gt;&gt;}]}
</I>&gt;<i> ]}
</I>&gt;<i> ]},
</I>&gt;<i> {queue, &lt;&lt;&quot;messages&quot;&gt;&gt;},
</I>&gt;<i> {prefetch_count, 200},
</I>&gt;<i> {ack_mode, on_confirm},
</I>&gt;<i> {publish_properties, [{delivery_mode, 2}]},
</I>&gt;<i> {reconnect_delay, 5}
</I>&gt;<i> ]}
</I>&gt;<i> ]}
</I>&gt;<i> ]}
</I>&gt;<i> ].
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i> Boris.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> rabbitmq-discuss mailing list
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">rabbitmq-discuss at lists.rabbitmq.com</A>
</I>&gt;<i> <A HREF="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss</A>
</I>&gt;<i>
</I>

-- 
Simon MacMullen
RabbitMQ, VMware
</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025485.html">[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}
</A></li>
	<LI>Next message: <A HREF="025605.html">[rabbitmq-discuss] Very slow get (dequeue) on node B if shovel on node A is configured with {ack_mode, on_confirm}
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25488">[ date ]</a>
              <a href="thread.html#25488">[ thread ]</a>
              <a href="subject.html#25488">[ subject ]</a>
              <a href="author.html#25488">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
