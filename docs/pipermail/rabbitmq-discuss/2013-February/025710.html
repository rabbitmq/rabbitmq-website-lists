<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [rabbitmq-discuss] Producer confirms as a heuristic for rate limiting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Producer%20confirms%20as%20a%20heuristic%20for%20rate%0A%20limiting&In-Reply-To=%3C512F23B6.306%40rabbitmq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025707.html">
   <LINK REL="Next"  HREF="025703.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[rabbitmq-discuss] Producer confirms as a heuristic for rate limiting</H1>
    <B>Matthias Radestock</B> 
    <A HREF="mailto:rabbitmq-discuss%40lists.rabbitmq.com?Subject=Re%3A%20%5Brabbitmq-discuss%5D%20Producer%20confirms%20as%20a%20heuristic%20for%20rate%0A%20limiting&In-Reply-To=%3C512F23B6.306%40rabbitmq.com%3E"
       TITLE="[rabbitmq-discuss] Producer confirms as a heuristic for rate limiting">matthias at rabbitmq.com
       </A><BR>
    <I>Thu Feb 28 09:30:30 GMT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="025707.html">[rabbitmq-discuss] Producer confirms as a heuristic for rate limiting
</A></li>
        <LI>Next message: <A HREF="025703.html">[rabbitmq-discuss] Rabbitmq custom plugin authorization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25710">[ date ]</a>
              <a href="thread.html#25710">[ thread ]</a>
              <a href="subject.html#25710">[ subject ]</a>
              <a href="author.html#25710">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ben,

On 28/02/13 08:49, Ben Hood wrote:
&gt;<i> On Wednesday, 27 February 2013 at 18:52, Matthias Radestock wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Using confirms to exert back pressure on a producing application is
</I>&gt;&gt;<i> fine. But I wouldn't expect that to result in particularly stable
</I>&gt;&gt;<i> latencies. For a few reasons:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1) one way that the internal confirm logic gets triggered is by &quot;absence
</I>&gt;&gt;<i> of other stuff happening&quot;, so when throttling producers, confirms may
</I>&gt;&gt;<i> well happen a lot quicker.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If I understand you correctly, then this is precisely the feedback loop
</I>&gt;<i> that I'm trying to achieve - when the sender is throttled, this gives
</I>&gt;<i> the internals of Rabbit more head room to do whatever it is a Rabbit
</I>&gt;<i> does. In Rabbit becoming more free, the rate of confirms increases, and
</I>&gt;<i> hence the more credit the sender will receive. When the sender ramps up
</I>&gt;<i> again, the reverse should happen, and so the feedback cycle continues.
</I>
My point is that the feedback signal is highly unstable, and the 
correlation between message send rate and confirm roundtrip time is 
highly non-linear. So you'd probably have to do a fair amount of 
processing on the signal in order to make the feedback smooth.

&gt;&gt;<i> 2) more generally, much of the internal confirm logic will try to batch
</I>&gt;&gt;<i> things if it can, which reduces the overall cost but makes the timing of
</I>&gt;&gt;<i> confirms more variable.
</I>&gt;<i>
</I>&gt;<i> That's understandable - fine grained ingress credits would come at a
</I>&gt;<i> premium in any case.
</I>&gt;<i>
</I>&gt;<i> In my scenario I'm setting a timestamp into the message header and the
</I>&gt;<i> receiver is decoding this in order to compare it with its current
</I>&gt;<i> timestamp. With the measurement being end to end, would the asynchronous
</I>&gt;<i> nature of the confirms not be obviated by the fact that you are
</I>&gt;<i> measuring the speed of the uplink plus the routing overhead plus the
</I>&gt;<i> speed of a separate delivery (he says had waving)?
</I>
My point here is the same as the previous one, i.e. the flow of confirms 
is anything but smooth, which makes it tricky to construct feedback 
loops based on that which result in stable end-to-end latencies.

&gt;&gt;<i> 3) confirms do come at a noticeable penalty on throughput and latency.
</I>&gt;&gt;<i> So a benchmark employing confirms would not be a very good proxy for a
</I>&gt;&gt;<i> real system running w/o confirms.
</I>&gt;<i>
</I>&gt;<i> What constitutes the performance penalty in this case? Do confirms
</I>&gt;<i> increase the latency because they add to the measurable round trip as
</I>&gt;<i> seen by the sender, or does the fact that they are turned on add extra
</I>&gt;<i> processing effort which is CPU time that has to be spread over each
</I>&gt;<i> message and hence on average adding latency to each message? If the
</I>&gt;<i> answer is the latter, does the same apply to throughput - since confirms
</I>&gt;<i> have a non-zero accounting cost, having them turned on diminishes the
</I>&gt;<i> ability to process as many items in the same amount of time?
</I>
All the latter. i.e. confirms take some CPU time. which due to the 
batching and various other optimisations is not spread evenly across 
messages.

&gt;&gt;<i> Having said all that, go and try it :)
</I>&gt;<i>
</I>&gt;<i> I'm very tempted, but the reason why I'm asking first is to avoid going
</I>&gt;<i> down any rabbit holes that a more experienced person could potentially
</I>&gt;<i> advise me to avoid :-)
</I>
Well, MulticastMain can already throttle producers based on a &quot;max 
number of outstanding confirms&quot;. So playing with that would be a 
starting point.

Matthias.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025707.html">[rabbitmq-discuss] Producer confirms as a heuristic for rate limiting
</A></li>
	<LI>Next message: <A HREF="025703.html">[rabbitmq-discuss] Rabbitmq custom plugin authorization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25710">[ date ]</a>
              <a href="thread.html#25710">[ thread ]</a>
              <a href="subject.html#25710">[ subject ]</a>
              <a href="author.html#25710">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.rabbitmq.com/cgi-bin/mailman/listinfo/rabbitmq-discuss">More information about the rabbitmq-discuss
mailing list</a><br>
</body></html>
